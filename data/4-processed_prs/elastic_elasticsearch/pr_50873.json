{"pr_number": 50873, "pr_title": "Begin moving date_histogram to offset rounding", "pr_createdAt": "2020-01-10T20:12:25Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50873", "timeline": [{"oid": "c25c08c4f10267284795a5b53ccbcfd6db33a5b7", "url": "https://github.com/elastic/elasticsearch/commit/c25c08c4f10267284795a5b53ccbcfd6db33a5b7", "message": "Begin moving date_histogram to offset rounding\n\nWe added a new rounding in #50609 that handles offsets to the start and\nend of the rounding so that we could support `offset` in the `composite`\naggregation. This starts moving `date_histogram` to that new offset.", "committedDate": "2020-01-10T20:06:38Z", "type": "commit"}, {"oid": "567b444268264f2fe1490969efda6990c8903419", "url": "https://github.com/elastic/elasticsearch/commit/567b444268264f2fe1490969efda6990c8903419", "message": "Merge branch 'master' into offset_rounding_date_histogram_1", "committedDate": "2020-01-10T21:04:37Z", "type": "commit"}, {"oid": "748c0905e1cb95c4529030295fea7dedc1e6a4cf", "url": "https://github.com/elastic/elasticsearch/commit/748c0905e1cb95c4529030295fea7dedc1e6a4cf", "message": "wihout offset", "committedDate": "2020-01-10T21:28:18Z", "type": "commit"}, {"oid": "64955e722b4dacca22294293447c414c5f3f0efd", "url": "https://github.com/elastic/elasticsearch/commit/64955e722b4dacca22294293447c414c5f3f0efd", "message": "Extra test", "committedDate": "2020-01-10T21:36:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkzNzQxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r365937411", "bodyText": "Excellent formatting choice, much more readable.", "author": "not-napoleon", "createdAt": "2020-01-13T17:43:43Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/ExtendedBounds.java", "diffHunk": "@@ -166,7 +166,11 @@ ExtendedBounds parseAndValidate(String aggName, QueryShardContext queryShardCont\n     }\n \n     ExtendedBounds round(Rounding rounding) {\n-        return new ExtendedBounds(min != null ? rounding.round(min) : null, max != null ? rounding.round(max) : null);\n+        // Extended bounds shouldn't be effected by the offset\n+        Rounding effectiveRounding = rounding.withoutOffset();\n+        return new ExtendedBounds(\n+                min != null ? effectiveRounding.round(min) : null,\n+                max != null ? effectiveRounding.round(max) : null);", "originalCommit": "64955e722b4dacca22294293447c414c5f3f0efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkzNzc0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r365937747", "bodyText": "Glad to see this getting moved into the rounding itself.  Makes much more sense.", "author": "not-napoleon", "createdAt": "2020-01-13T17:44:21Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateRangeHistogramAggregator.java", "diffHunk": "@@ -153,10 +151,6 @@ public void collect(int doc, long bucket) throws IOException {\n         };\n     }\n \n-    private long offsetAwareRounding(Rounding rounding, long value, long offset) {", "originalCommit": "64955e722b4dacca22294293447c414c5f3f0efd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk0MjgyNA==", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r365942824", "bodyText": "What's the plan to migrate away from this? I'm not sure I understand the benefit to adding a deprecated method now that we intend to remove in the next PR, as opposed to just removing the need for it in this PR.", "author": "not-napoleon", "createdAt": "2020-01-13T17:54:43Z", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -164,6 +164,19 @@ public void writeTo(StreamOutput out) throws IOException {\n      */\n     public abstract long nextRoundingValue(long value);\n \n+    /**\n+     * How \"offset\" this rounding is from the traditional \"start\" of the period.\n+     * @deprecated We're in the process of abstracting offset *into* Rounding\n+     *             so keep any usage to migratory shims\n+     */\n+    @Deprecated\n+    public abstract long offset();", "originalCommit": "64955e722b4dacca22294293447c414c5f3f0efd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk4NTk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r365985955", "bodyText": "I added this to cut the PR in half, basically. I'll remove it in a followup. I believe that follow up with have serialization changes so it'll feel pretty different than this PR.", "author": "nik9000", "createdAt": "2020-01-13T19:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk0MjgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM1NzAwMA==", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r366357000", "bodyText": "Seems reasonable, thanks for explaining!", "author": "not-napoleon", "createdAt": "2020-01-14T14:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk0MjgyNA=="}], "type": "inlineReview"}]}