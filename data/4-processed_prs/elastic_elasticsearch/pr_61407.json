{"pr_number": 61407, "pr_title": "Rework test cluster distribution handling", "pr_createdAt": "2020-08-21T08:43:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61407", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0MzEwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r474843109", "bodyText": "The duplication of this fake archive (src/integTest/... vs. src/testkit...) will disappear once the distribution resolution via artifact transforms is back on the branch", "author": "breskeby", "createdAt": "2020-08-21T17:52:50Z", "path": "buildSrc/src/integTest/groovy/org/elasticsearch/gradle/fixtures/DistributionDownloadFixture.groovy", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.fixtures\n+\n+import org.elasticsearch.gradle.ElasticsearchDistribution\n+import org.elasticsearch.gradle.VersionProperties\n+import org.gradle.testkit.runner.BuildResult\n+import org.gradle.testkit.runner.GradleRunner\n+\n+class DistributionDownloadFixture {\n+\n+    public static final String INIT_SCRIPT = \"repositories-init.gradle\"\n+\n+    static BuildResult withMockedDistributionDownload(GradleRunner gradleRunner, Closure<BuildResult> buildRunClosure) {\n+        String urlPath = urlPath();\n+        return WiremockFixture.withWireMock(urlPath, filebytes(urlPath)) { server ->\n+            File initFile = new File(gradleRunner.getProjectDir(), INIT_SCRIPT)\n+            initFile.text = \"\"\"allprojects { p ->\n+                p.repositories.all { repo ->\n+                    repo.allowInsecureProtocol = true\n+                    repo.setUrl('${server.baseUrl()}')\n+                }\n+            }\"\"\"\n+            List<String> givenArguments = gradleRunner.getArguments()\n+            GradleRunner effectiveRunner = gradleRunner.withArguments(givenArguments + ['-I', initFile.getAbsolutePath()])\n+            return buildRunClosure.call(effectiveRunner)\n+        }\n+    }\n+\n+    private static String urlPath() {\n+        String version = VersionProperties.getElasticsearch()\n+        ElasticsearchDistribution.Platform platform = ElasticsearchDistribution.CURRENT_PLATFORM\n+        String fileType = ((ElasticsearchDistribution.CURRENT_PLATFORM == ElasticsearchDistribution.Platform.LINUX ||\n+                ElasticsearchDistribution.CURRENT_PLATFORM == ElasticsearchDistribution.Platform.DARWIN)) ? \"tar.gz\" : \"zip\"\n+        \"/downloads/elasticsearch/elasticsearch-${version}-${platform}-x86_64.$fileType\"\n+    }\n+\n+    private static byte[] filebytes(String urlPath) throws IOException {\n+        String suffix = urlPath.endsWith(\"zip\") ? \"zip\" : \"tar.gz\";\n+        return DistributionDownloadFixture.getResourceAsStream(\"/org/elasticsearch/gradle/fake_elasticsearch.\" + suffix).getBytes()", "originalCommit": "baa6a609a8a1d24e0a551af13257e060640d4168", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0NDY0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475844643", "bodyText": "Is there a reason we can't just change the implementation of getDistroDir() to return this value? In what scenario would we use both?", "author": "mark-vieira", "createdAt": "2020-08-24T19:29:18Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -782,6 +787,10 @@ private void startElasticsearchProcess() {\n         reaper.registerPid(toString(), esProcess.pid());\n     }\n \n+    private Path getEffectiveDistroDir() {\n+        return canUseSharedDistribution() ? getExtractedDistributionDir().toFile().listFiles()[0].toPath() : getDistroDir();", "originalCommit": "baa6a609a8a1d24e0a551af13257e060640d4168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY4NDMwMA==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r476684300", "bodyText": "fixed", "author": "breskeby", "createdAt": "2020-08-25T19:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0NDY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODMzNg==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475848336", "bodyText": "Unlike creating a symlink, this is a costly operation so how do we handle scenarios in tests where we do things like restart nodes. Since this is called in the start() method do we do this copy every time?", "author": "mark-vieira", "createdAt": "2020-08-24T19:36:25Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -1011,6 +1031,27 @@ private void createWorkingDir(Path distroExtractDir) throws IOException {\n      * @param destinationRoot destination to link to\n      */\n     private void syncWithLinks(Path sourceRoot, Path destinationRoot) {\n+        sync(sourceRoot, destinationRoot, (Path d, Path s) -> {\n+            try {\n+                Files.createLink(d, s);\n+            } catch (IOException e) {\n+                // Note does not work for network drives, e.g. Vagrant\n+                throw new LinkCreationException(\"Failed to create hard link \" + d + \" pointing to \" + s, e);\n+            }\n+        });\n+    }\n+\n+    private void syncWithCopy(Path sourceRoot, Path destinationRoot) {\n+        sync(sourceRoot, destinationRoot, (Path d, Path s) -> {\n+            try {\n+                Files.copy(s, d);", "originalCommit": "baa6a609a8a1d24e0a551af13257e060640d4168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg3ODc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475878766", "bodyText": "I have to check if we can avoid that. There seems some Test expect an explicit clean working dir.", "author": "breskeby", "createdAt": "2020-08-24T20:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4MDQ2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475880461", "bodyText": "I think we can potentially manage the state in the node itself. Basically if the backing distribution extracted dir hasn't changed, and we've already performed a copy, then skip it. I can't see why any tests would need the working directory \"cleaned\" as those files should never actually be modified, if they did, then shared hard links wouldn't work. We do have to check if the configured distribution changed tho, as that is mutable in the case of BWC tests the bump the distribution version.", "author": "mark-vieira", "createdAt": "2020-08-24T20:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY4MzcwOA==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r476683708", "bodyText": "Files have only been copied (hard linked) if the expected directory already existed. This expected directory contains the version number so a change in the requested distribution version will trigger a redo of the linking/copying. To be clear: that has been the case before that change already and the behaviour hasn't changed with this PR", "author": "breskeby", "createdAt": "2020-08-25T19:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODY4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475848683", "bodyText": "Is this additional config required for some reason?", "author": "mark-vieira", "createdAt": "2020-08-24T19:37:07Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -1127,9 +1165,38 @@ private void createConfiguration() {\n         } catch (IOException e) {\n             throw new UncheckedIOException(\"Could not write config file: \" + configFile, e);\n         }\n+\n+        tweakJvmOptions(configFileRoot);\n         LOGGER.info(\"Written config file:{} for {}\", configFile, this);\n     }\n \n+    private void tweakJvmOptions(Path configFileRoot) {", "originalCommit": "baa6a609a8a1d24e0a551af13257e060640d4168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg3OTc5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475879799", "bodyText": "By default the jvm options write into the specific distro folder. If we say we don't rely on shared distro directories and keep using hard links and copy as a fallback we can remove it again. Otherwise we need this to keep the distro folders clean.", "author": "breskeby", "createdAt": "2020-08-24T20:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475848866", "bodyText": "nit: canUseSharedDistribtuion() == false", "author": "mark-vieira", "createdAt": "2020-08-24T19:37:32Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -990,8 +999,19 @@ private void waitForProcessToExit(ProcessHandle processHandle) {\n     }\n \n     private void createWorkingDir(Path distroExtractDir) throws IOException {\n-        if (Files.exists(getDistroDir()) == false) {\n-            syncWithLinks(distroExtractDir, getDistroDir());\n+        if (!canUseSharedDistribution()) {", "originalCommit": "baa6a609a8a1d24e0a551af13257e060640d4168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY4NDEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r476684122", "bodyText": "fixed", "author": "breskeby", "createdAt": "2020-08-25T19:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODg2Ng=="}], "type": "inlineReview"}, {"oid": "2838d0ae6630f04b19d30df81e6aef6d1b0ef249", "url": "https://github.com/elastic/elasticsearch/commit/2838d0ae6630f04b19d30df81e6aef6d1b0ef249", "message": "Rework test cluster distribution handling\n\nDriven by this issue https://github.com/elastic/elasticsearch/pull/60969#issuecomment-674962158\nwe apply some rework on how we handle distributions in our test cluster setups:\n\n- If no custom modules, plugins or extra jar files are declared we do not create a cluster\nspecific distro folder and use the origin distribution folder instead.\n- If a custom distribution folder is required, we fallback to file copy when hard linking\nis not supported", "committedDate": "2020-08-25T17:48:13Z", "type": "commit"}, {"oid": "6851abeec51ae2f8b35ee22adef2bfe063a7e033", "url": "https://github.com/elastic/elasticsearch/commit/6851abeec51ae2f8b35ee22adef2bfe063a7e033", "message": "Fix compile", "committedDate": "2020-08-25T17:48:14Z", "type": "commit"}, {"oid": "d6648cbceb36131a816b6a212a3880183edf77c9", "url": "https://github.com/elastic/elasticsearch/commit/d6648cbceb36131a816b6a212a3880183edf77c9", "message": "Fix plugin func tests", "committedDate": "2020-08-25T17:48:14Z", "type": "commit"}, {"oid": "089ffbe986ce3e805ecf6050c953db5446517139", "url": "https://github.com/elastic/elasticsearch/commit/089ffbe986ce3e805ecf6050c953db5446517139", "message": "Add more coverage for custom distros", "committedDate": "2020-08-25T17:48:14Z", "type": "commit"}, {"oid": "215173f389803a647e9ba43644c3971f25c79c48", "url": "https://github.com/elastic/elasticsearch/commit/215173f389803a647e9ba43644c3971f25c79c48", "message": "TestClustersPlugin func tests do not work on windows yet", "committedDate": "2020-08-25T17:48:14Z", "type": "commit"}, {"oid": "5ff22f8f0e4a8d9839cdafcd8cfe08109296f76e", "url": "https://github.com/elastic/elasticsearch/commit/5ff22f8f0e4a8d9839cdafcd8cfe08109296f76e", "message": "Apply review feedback (just keep distroDir)", "committedDate": "2020-08-25T17:48:14Z", "type": "commit"}, {"oid": "9737345c699340d28ebbca0d2a74b7992669ee86", "url": "https://github.com/elastic/elasticsearch/commit/9737345c699340d28ebbca0d2a74b7992669ee86", "message": "Only copy distro once if node is restarted", "committedDate": "2020-08-25T17:48:15Z", "type": "commit"}, {"oid": "a74d72f810f7c1e05fed063816ebb9fd9bc05893", "url": "https://github.com/elastic/elasticsearch/commit/a74d72f810f7c1e05fed063816ebb9fd9bc05893", "message": "Fix typo in distro setup", "committedDate": "2020-08-25T17:48:15Z", "type": "commit"}, {"oid": "a74d72f810f7c1e05fed063816ebb9fd9bc05893", "url": "https://github.com/elastic/elasticsearch/commit/a74d72f810f7c1e05fed063816ebb9fd9bc05893", "message": "Fix typo in distro setup", "committedDate": "2020-08-25T17:48:15Z", "type": "forcePushed"}, {"oid": "4c86e16c39930af855189103383cfb8b5939d505", "url": "https://github.com/elastic/elasticsearch/commit/4c86e16c39930af855189103383cfb8b5939d505", "message": "Always check if distro needs to be recreated\n\n- necessary for changing distribution versions", "committedDate": "2020-08-25T18:23:27Z", "type": "commit"}]}