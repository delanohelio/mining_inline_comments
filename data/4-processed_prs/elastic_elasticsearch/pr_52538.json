{"pr_number": 52538, "pr_title": "[ML] rewrite deprecated datafeed configs to use new date_histogram interval fields", "pr_createdAt": "2020-02-19T21:07:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52538", "timeline": [{"oid": "4f176032264dcecb85d39eb447e1b928a145a211", "url": "https://github.com/elastic/elasticsearch/commit/4f176032264dcecb85d39eb447e1b928a145a211", "message": "[ML] rewrite deprecated datafeed aggs to use new [fixed|calendar]interval", "committedDate": "2020-02-19T21:01:56Z", "type": "commit"}, {"oid": "612b900397cf45aa762be8d230a671d148e254ba", "url": "https://github.com/elastic/elasticsearch/commit/612b900397cf45aa762be8d230a671d148e254ba", "message": "fixing bwc test", "committedDate": "2020-02-20T12:46:10Z", "type": "commit"}, {"oid": "00367ea646351e3576532098b64e6483d3895d63", "url": "https://github.com/elastic/elasticsearch/commit/00367ea646351e3576532098b64e6483d3895d63", "message": "Update 40_ml_datafeed_crud.yml", "committedDate": "2020-02-20T13:02:49Z", "type": "commit"}, {"oid": "c60f8c5f706dbd3cefc55e36d17cff67c2cc1eae", "url": "https://github.com/elastic/elasticsearch/commit/c60f8c5f706dbd3cefc55e36d17cff67c2cc1eae", "message": "adjusting bwc tests for rolling upgrade from 8.0.0", "committedDate": "2020-02-20T13:57:07Z", "type": "commit"}, {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "url": "https://github.com/elastic/elasticsearch/commit/efe0664294a7a14cf7e8231abbcc951fd49bc285", "message": "Merge branch 'feature/ml-datafeed-date_histo-migration' of github.com:benwtrent/elasticsearch into feature/ml-datafeed-date_histo-migration", "committedDate": "2020-02-20T13:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2MjU2MA==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383262560", "bodyText": "Could it be version: \"8.0.0 - \" for 8.0.0 and above?", "author": "droberts195", "createdAt": "2020-02-24T13:26:02Z", "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/old_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -121,10 +124,85 @@ setup:\n   - is_false: datafeeds.0.node\n \n ---\n-\"Put job and datafeed with aggs in old cluster - deprecated interval with warning\":\n+\"Put job and datafeed with aggs in old cluster - deprecated interval with warning before 8.0.0\":\n+  - skip:\n+      version: \"7.99.99 - \"", "originalCommit": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4NjE4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383286182", "bodyText": "for sure.", "author": "benwtrent", "createdAt": "2020-02-24T14:12:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2MjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NjU4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383366583", "bodyText": "#fixed", "author": "benwtrent", "createdAt": "2020-02-24T16:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2MjU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NjMyMw==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383266323", "bodyText": "At the moment this test is unconditionally skipped, so I wondered about deleting it completely.  But I guess the reason for keeping it is that eventually it can be reenabled.  You could add a comment #\u00a0TODO: remove skip section from master when version is bumped to 9.0.0 here to prompt us to do that.", "author": "droberts195", "createdAt": "2020-02-24T13:33:35Z", "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/mixed_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -23,7 +26,9 @@ setup:\n ---\n \"Test old cluster datafeed with aggs\":\n   - skip:\n-      features: \"warnings\"\n+      features: warnings\n+      version: \"all\"", "originalCommit": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NjQ5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383366496", "bodyText": "Sounds good!", "author": "benwtrent", "createdAt": "2020-02-24T16:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NjMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NDA5OA==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383274098", "bodyText": "I think this should still be a valid test.  It's testing the code in \n  \n    \n      elasticsearch/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/extractor/ExtractorUtils.java\n    \n    \n        Lines 179 to 189\n      in\n      290c8b8\n    \n    \n    \n    \n\n        \n          \n               if (interval.days() > 7) { \n        \n\n        \n          \n                   throw ExceptionsHelper.badRequestException(invalidDateHistogramCalendarIntervalMessage(calendarInterval)); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               return interval.millis(); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           private static String invalidDateHistogramCalendarIntervalMessage(String interval) { \n        \n\n        \n          \n               throw ExceptionsHelper.badRequestException(\"When specifying a date_histogram calendar interval [\" \n        \n\n        \n          \n                       + interval + \"], ML does not accept intervals longer than a week because of \" + \n        \n\n        \n          \n                       \"variable lengths of periods greater than a week\"); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nDid this test fail after the other changes in this PR?  If so that might be a sign of a problem.\nEven though histograms in general can plot variable length time buckets (e.g. months), it's still reasonable for ML to prohibit such bucket spans as they would make the modelling much more complex.", "author": "droberts195", "createdAt": "2020-02-24T13:49:11Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfigTests.java", "diffHunk": "@@ -566,13 +584,6 @@ public void testBuild_GivenValidDateHistogram() {\n                 equalTo(7 * millisInDay + 1));\n     }\n \n-    public void testBuild_GivenDateHistogramWithMoreThanCalendarWeek() {\n-        ElasticsearchException e = expectThrows(ElasticsearchException.class,\n-                () -> createDatafeedWithDateHistogram(\"8d\"));\n-\n-        assertThat(e.getMessage(), containsString(\"When specifying a date_histogram calendar interval [8d]\"));", "originalCommit": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NjM4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383366382", "bodyText": "added the test back and fixed it", "author": "benwtrent", "createdAt": "2020-02-24T16:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NDA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4MDYyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383280625", "bodyText": "I think we will run into a problem with this in the future, because at some point before 8.0.0-beta1 is released the master branch will start to treat interval as a syntax error.  This test seems to be designed for the day when there is a version beyond 8.0.0 and the old cluster is 8.0.0.  But when this combination of versions is being tested this test will be forced to use \"fixed_interval\" : \"30s\" instead of \"interval\" : \"30s\", so will not test the rewrite functionality.  Since it's also testing other things it's worth keeping the test, but you might as well change it to say \"fixed_interval\" : \"30s\" now.", "author": "droberts195", "createdAt": "2020-02-24T14:01:47Z", "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/old_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -121,10 +124,85 @@ setup:\n   - is_false: datafeeds.0.node\n \n ---\n-\"Put job and datafeed with aggs in old cluster - deprecated interval with warning\":\n+\"Put job and datafeed with aggs in old cluster - deprecated interval with warning before 8.0.0\":\n+  - skip:\n+      version: \"7.99.99 - \"\n+      reason:  at version 8.0.0, deprecation warnings don't occur on get_stats\n+      features: warnings\n+\n+  - do:\n+      ml.put_job:\n+        job_id: old-cluster-datafeed-job-with-aggs\n+        body:  >\n+          {\n+            \"description\":\"Cluster upgrade\",\n+            \"analysis_config\" : {\n+                \"bucket_span\": \"60s\",\n+                \"summary_count_field_name\": \"doc_count\",\n+                \"detectors\" :[{\"function\":\"count\"}]\n+            },\n+            \"analysis_limits\" : {\n+                \"model_memory_limit\": \"50mb\"\n+            },\n+            \"data_description\" : {\n+                \"format\":\"xcontent\",\n+                \"time_field\":\"time\"\n+            }\n+          }\n+  - match: { job_id: old-cluster-datafeed-job-with-aggs }\n+\n+  - do:\n+      warnings:\n+        - '[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.'\n+      ml.put_datafeed:\n+        datafeed_id: old-cluster-datafeed-with-aggs\n+        body:  >\n+          {\n+            \"job_id\":\"old-cluster-datafeed-job-with-aggs\",\n+            \"indices\":[\"airline-data\"],\n+            \"scroll_size\": 2000,\n+            \"aggregations\": {\n+              \"buckets\": {\n+                \"date_histogram\": {\n+                  \"field\": \"time\",\n+                  \"interval\": \"30s\",\n+                  \"time_zone\": \"UTC\"\n+                },\n+                \"aggregations\": {\n+                  \"time\": {\n+                    \"max\": {\"field\": \"time\"}\n+                  },\n+                  \"airline\": {\n+                    \"terms\": {\n+                      \"field\": \"airline\",\n+                      \"size\": 100\n+                    },\n+                    \"aggregations\": {\n+                      \"responsetime\": {\n+                        \"avg\": {\n+                          \"field\": \"responsetime\"\n+                        }\n+                      }\n+                    }\n+                  }\n+                }\n+              }\n+            }\n+          }\n+\n+  - do:\n+      warnings:\n+        - '[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.'\n+      ml.get_datafeed_stats:\n+        datafeed_id: old-cluster-datafeed-with-aggs\n+  - match: { datafeeds.0.state: stopped}\n+  - is_false: datafeeds.0.node\n+\n+---\n+\"Put job and datafeed with aggs in old cluster - deprecated interval with warning after 8.0.0\":", "originalCommit": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MzE4MA==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383293180", "bodyText": "This test seems to be designed for the day when there is a version beyond 8.0.0 and the old cluster is 8.0.0.\n\nNot exactly, the rolling upgrade tests use an \"old cluster\" of 8.0.0, even if the \"new cluster\" version is 8.0.0", "author": "benwtrent", "createdAt": "2020-02-24T14:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4MDYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5OTQ1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383299453", "bodyText": "This test is effectively testing the rewrite all in the same cluster version. This is actually covered when we \"GET\" the old datafeed in the new cluster tests.\nI will adjust the PUT to be a fixed_interval and not check for warnings at all.", "author": "benwtrent", "createdAt": "2020-02-24T14:35:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4MDYyNQ=="}], "type": "inlineReview"}, {"oid": "5b2d978a07261ec1fe88d4f18227eb710c38681c", "url": "https://github.com/elastic/elasticsearch/commit/5b2d978a07261ec1fe88d4f18227eb710c38681c", "message": "fixing bwc tests + adding back large calendar interval test", "committedDate": "2020-02-24T14:40:30Z", "type": "commit"}, {"oid": "252297fe0f41de1dc75ed19f9022a19df1471181", "url": "https://github.com/elastic/elasticsearch/commit/252297fe0f41de1dc75ed19f9022a19df1471181", "message": "Merge branch 'master' into feature/ml-datafeed-date_histo-migration", "committedDate": "2020-02-24T14:40:41Z", "type": "commit"}]}