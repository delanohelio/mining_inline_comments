{"pr_number": 56872, "pr_title": "SQL: [Tests] Move JDBC integration tests to new module", "pr_createdAt": "2020-05-17T15:31:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56872", "timeline": [{"oid": "22d4c3ee2a4b9c88ec85d9bb637c0156181fd208", "url": "https://github.com/elastic/elasticsearch/commit/22d4c3ee2a4b9c88ec85d9bb637c0156181fd208", "message": "SQL: [Tests] Move JDBC integration tests to new module\n\nMove the JDBC functionality integration tests to a separate module.", "committedDate": "2020-05-17T15:31:12Z", "type": "commit"}, {"oid": "afa711ad4d582afc0c3d379595c47dcce1e163b7", "url": "https://github.com/elastic/elasticsearch/commit/afa711ad4d582afc0c3d379595c47dcce1e163b7", "message": "remove duplicate tests from sql:qa module", "committedDate": "2020-05-17T16:13:49Z", "type": "commit"}, {"oid": "9023176044b68632a31484df9742083a6bac7302", "url": "https://github.com/elastic/elasticsearch/commit/9023176044b68632a31484df9742083a6bac7302", "message": "fix imports", "committedDate": "2020-05-17T16:21:21Z", "type": "commit"}, {"oid": "c61c608de974ee6d586b314af2cbd863a24e1591", "url": "https://github.com/elastic/elasticsearch/commit/c61c608de974ee6d586b314af2cbd863a24e1591", "message": "fix doc references", "committedDate": "2020-05-17T16:35:19Z", "type": "commit"}, {"oid": "35d1f3c1460c579def31fe199f4845146c0a7dcc", "url": "https://github.com/elastic/elasticsearch/commit/35d1f3c1460c579def31fe199f4845146c0a7dcc", "message": "attempt to fix java path for doc tests", "committedDate": "2020-05-17T17:04:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjEyMw==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r426916123", "bodyText": "Let's use elasticsearch.java here instead. This applies all our compile/test conventions, but doesn't add all these precommit check tasks which are not applicable to this project.", "author": "mark-vieira", "createdAt": "2020-05-18T22:00:26Z", "path": "x-pack/plugin/sql/jdbc/qa/build.gradle", "diffHunk": "@@ -0,0 +1,66 @@\n+description = 'Integration tests for SQL JDBC'\n+apply plugin: 'elasticsearch.build'", "originalCommit": "35d1f3c1460c579def31fe199f4845146c0a7dcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjQzNA==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r426916434", "bodyText": "Not, we should probably do this for the sql qa project as well. Would simplify that build script a bit since the same applies there.", "author": "mark-vieira", "createdAt": "2020-05-18T22:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyOTcwNA==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r427129704", "bodyText": "If I make this change I get:\n* Where:\nBuild file '/home/matriv/elastic/elasticsearch/x-pack/plugin/sql/jdbc/qa/build.gradle' line: 17\n\n* What went wrong:\nA problem occurred evaluating project ':x-pack:plugin:sql:jdbc:qa'.\n> Could not get unknown property 'dependencyLicenses' for project ':x-pack:plugin:sql:jdbc:qa' of type org.gradle.api.Project.", "author": "matriv", "createdAt": "2020-05-19T08:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM1ODY2OA==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r427358668", "bodyText": "Exactly. The java plugin doesn't create a dependenciesLicenses task, therefor we no longer need to explicitly disable it. Remove dependencyLicenses.enabled = false as well as all the others. We shouldn't need to disable any tasks.", "author": "mark-vieira", "createdAt": "2020-05-19T14:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjMyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r426916321", "bodyText": "We shouldn't need to override group or archivesBaseName since we aren't going to publish this module.", "author": "mark-vieira", "createdAt": "2020-05-18T22:00:56Z", "path": "x-pack/plugin/sql/jdbc/qa/build.gradle", "diffHunk": "@@ -0,0 +1,66 @@\n+description = 'Integration tests for SQL JDBC'\n+apply plugin: 'elasticsearch.build'\n+archivesBaseName = 'qa-sql-jdbc'\n+group = \"org.elasticsearch.x-pack.qa.sql.jdbc\"", "originalCommit": "35d1f3c1460c579def31fe199f4845146c0a7dcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNzQzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r426917435", "bodyText": "Who uses this task?", "author": "mark-vieira", "createdAt": "2020-05-18T22:04:00Z", "path": "x-pack/plugin/sql/jdbc/qa/build.gradle", "diffHunk": "@@ -0,0 +1,66 @@\n+description = 'Integration tests for SQL JDBC'\n+apply plugin: 'elasticsearch.build'\n+archivesBaseName = 'qa-sql-jdbc'\n+group = \"org.elasticsearch.x-pack.qa.sql.jdbc\"\n+\n+dependencies {\n+    compile project(\":test:framework\")\n+\n+    // JDBC testing dependencies\n+    compile project(path: xpackModule('sql:jdbc'))\n+}\n+\n+/* disable unit tests because these are all integration tests used\n+ * other qa projects. */\n+test.enabled = false\n+\n+dependencyLicenses.enabled = false\n+dependenciesInfo.enabled = false\n+\n+// the main files are actually test files, so use the appropriate forbidden api sigs\n+tasks.named('forbiddenApisMain').configure {\n+    replaceSignatureFiles 'es-all-signatures', 'es-test-signatures'\n+}\n+\n+// just a test fixture: we aren't using this jars in releases and H2GIS requires disabling a lot of checks\n+thirdPartyAudit.enabled = false\n+\n+subprojects {\n+    if (subprojects.isEmpty()) {\n+        // leaf project\n+        apply plugin: 'elasticsearch.standalone-rest-test'\n+    } else {\n+        apply plugin: 'elasticsearch.build'\n+    }\n+\n+    dependencies {\n+        /* Since we're a standalone rest test we actually get transitive\n+         * dependencies but we don't really want them because they cause\n+         * all kinds of trouble with the jar hell checks. So we suppress\n+         * them explicitly for non-es projects. */\n+        testCompile(xpackProject('plugin:sql:jdbc:qa')) {\n+            transitive = false\n+        }\n+        testCompile project(\":test:framework\")\n+\n+        testRuntime project(path: xpackModule('sql:jdbc'))\n+    }\n+\n+    if (project.name != 'security') {\n+        // The security project just configures its subprojects\n+        apply plugin: 'elasticsearch.testclusters'\n+        apply plugin: 'elasticsearch.rest-test'\n+\n+        testClusters.integTest {\n+            testDistribution = 'DEFAULT'\n+            setting 'xpack.ml.enabled', 'false'\n+            setting 'xpack.watcher.enabled', 'false'\n+        }\n+\n+        task runqa {", "originalCommit": "35d1f3c1460c579def31fe199f4845146c0a7dcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyOTQwMA==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r427129400", "bodyText": "Noone, removing.", "author": "matriv", "createdAt": "2020-05-19T08:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNzQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNzY1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r426917659", "bodyText": "We should use elasticsearch.java plugin again here. The nested qa projects don't need all that additional precommit stuff.", "author": "mark-vieira", "createdAt": "2020-05-18T22:04:38Z", "path": "x-pack/plugin/sql/jdbc/qa/build.gradle", "diffHunk": "@@ -0,0 +1,66 @@\n+description = 'Integration tests for SQL JDBC'\n+apply plugin: 'elasticsearch.build'\n+archivesBaseName = 'qa-sql-jdbc'\n+group = \"org.elasticsearch.x-pack.qa.sql.jdbc\"\n+\n+dependencies {\n+    compile project(\":test:framework\")\n+\n+    // JDBC testing dependencies\n+    compile project(path: xpackModule('sql:jdbc'))\n+}\n+\n+/* disable unit tests because these are all integration tests used\n+ * other qa projects. */\n+test.enabled = false\n+\n+dependencyLicenses.enabled = false\n+dependenciesInfo.enabled = false\n+\n+// the main files are actually test files, so use the appropriate forbidden api sigs\n+tasks.named('forbiddenApisMain').configure {\n+    replaceSignatureFiles 'es-all-signatures', 'es-test-signatures'\n+}\n+\n+// just a test fixture: we aren't using this jars in releases and H2GIS requires disabling a lot of checks\n+thirdPartyAudit.enabled = false\n+\n+subprojects {\n+    if (subprojects.isEmpty()) {\n+        // leaf project\n+        apply plugin: 'elasticsearch.standalone-rest-test'\n+    } else {\n+        apply plugin: 'elasticsearch.build'", "originalCommit": "35d1f3c1460c579def31fe199f4845146c0a7dcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxODY1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r426918659", "bodyText": "Let's please not do this anymore. Instead of creating subprojects here, let's just define two separate test clusters. This mess of sharing test artifacts just to run tests two different ways is completely unnecessary. We should refactor the SQL project to ditch this but at least for this PR, let's not copy a bad pattern. Let me know if you need help refactoring this.", "author": "mark-vieira", "createdAt": "2020-05-18T22:07:14Z", "path": "x-pack/plugin/sql/jdbc/qa/security/build.gradle", "diffHunk": "@@ -0,0 +1,63 @@\n+dependencies {\n+    testCompile project(':x-pack:plugin:core')\n+}\n+\n+Project mainProject = project\n+\n+group = \"${group}.x-pack.qa.sql.security\"\n+\n+configurations.create('testArtifacts')\n+\n+TaskProvider testJar = tasks.register(\"testJar\", Jar) {\n+    appendix 'test'\n+    from sourceSets.test.output\n+}\n+\n+artifacts {\n+    testArtifacts testJar\n+}\n+\n+// Tests are pushed down to subprojects and will be checked there.\n+testingConventions.enabled = false\n+\n+subprojects {", "originalCommit": "35d1f3c1460c579def31fe199f4845146c0a7dcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ2MDk5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r427460996", "bodyText": "As discussed we'd rather keep it like that to have the parallel execution of the single-node/mutli-node etc. cases", "author": "matriv", "createdAt": "2020-05-19T17:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxODY1OQ=="}], "type": "inlineReview"}, {"oid": "584f367c742936ad8b304fb99f8eb50e0ed00541", "url": "https://github.com/elastic/elasticsearch/commit/584f367c742936ad8b304fb99f8eb50e0ed00541", "message": "clean up build.gradle", "committedDate": "2020-05-19T16:58:11Z", "type": "commit"}, {"oid": "462ff434cb66e85ef82ff667b4ed7d2e72708564", "url": "https://github.com/elastic/elasticsearch/commit/462ff434cb66e85ef82ff667b4ed7d2e72708564", "message": "rename packages", "committedDate": "2020-05-20T07:48:21Z", "type": "commit"}, {"oid": "ba5137e5529401e20169631928cfc1150f9d7d39", "url": "https://github.com/elastic/elasticsearch/commit/ba5137e5529401e20169631928cfc1150f9d7d39", "message": "Move jdbc qa inside sql/qa project\n\nMove the existing tests inside a new sql/qa/server project", "committedDate": "2020-05-21T10:13:12Z", "type": "commit"}, {"oid": "f12bceb6c5b3d293963f053ed3838245bb7e940e", "url": "https://github.com/elastic/elasticsearch/commit/f12bceb6c5b3d293963f053ed3838245bb7e940e", "message": "Merge remote-tracking branch 'upstream/master' into split-jdbc-qa-tests", "committedDate": "2020-05-21T10:13:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU2ODk0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r428568949", "bodyText": "@mark-vieira I've been struggling to understand why we end up with circular dependency without this. Any idea?\nDo you have a better suggestion? (I tried renaming the module to jdbc-qa instead of just jdbc which also works).", "author": "matriv", "createdAt": "2020-05-21T10:22:16Z", "path": "x-pack/plugin/sql/qa/jdbc/build.gradle", "diffHunk": "@@ -0,0 +1,61 @@\n+description = 'Integration tests for SQL JDBC driver'\n+apply plugin: 'elasticsearch.build'\n+\n+// Avoid circular dependency", "originalCommit": "f12bceb6c5b3d293963f053ed3838245bb7e940e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0NDk4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56872#discussion_r428944986", "bodyText": "I'm not completely certain (this is before my time), but I suspect Gradle get's confused if it finds multiple subprojects with identical GAV coordinates, so we make them unique to avoid any dependency resolution conflicts. Again, since this is a QA project that doesn't get published, this value is competely arbitrary.", "author": "mark-vieira", "createdAt": "2020-05-21T22:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU2ODk0OQ=="}], "type": "inlineReview"}, {"oid": "7919350d83b15f40877c8d019b46cc458dc275dd", "url": "https://github.com/elastic/elasticsearch/commit/7919350d83b15f40877c8d019b46cc458dc275dd", "message": "fix doc example paths", "committedDate": "2020-05-21T10:25:17Z", "type": "commit"}, {"oid": "e4562e7bbf2611f3025344b7eee96165f4a20240", "url": "https://github.com/elastic/elasticsearch/commit/e4562e7bbf2611f3025344b7eee96165f4a20240", "message": "fixup! fix doc example paths", "committedDate": "2020-05-21T10:32:38Z", "type": "commit"}, {"oid": "9b0f9155d013e61fae1b07ead971bf533495f79a", "url": "https://github.com/elastic/elasticsearch/commit/9b0f9155d013e61fae1b07ead971bf533495f79a", "message": "fixup! fixup! fix doc example paths", "committedDate": "2020-05-21T10:42:49Z", "type": "commit"}]}