{"pr_number": 54309, "pr_title": "Remove guava from transitive compile classpath", "pr_createdAt": "2020-03-26T23:12:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54309", "timeline": [{"oid": "a23ce98a3924f59628d51f2d3f9b9e331e2bd185", "url": "https://github.com/elastic/elasticsearch/commit/a23ce98a3924f59628d51f2d3f9b9e331e2bd185", "message": "Remove guava from transitive compile classpath\n\nGuava was removed from Elasticsearch many years ago, but remnants of it\nremain due to transitive dependencies. When a dependency pulls guava\ninto the compile classpath, devs can inadvertently begin using methods\nfrom guava without realizing it. This commit moves guava to a runtime\ndependency in the modules that it is needed.\n\nNote that one special case is the html sanitizer in watcher. The third\nparty dep uses guava in the PolicyFactory class signature. However, only\ncalling a method on the PolicyFactory actually causes the class to be\nloaded, a reference alone does not trigger compilation to look at the\nclass implementation. There we utilize a MethodHandle for invoking the\nrelevant method at runtime, where guava will continue to exist.", "committedDate": "2020-03-26T23:11:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0ODQ0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54309#discussion_r398948447", "bodyText": "We might want to include the full path to the configuration here as just saying \"compileClasspath\" isn't going to be particularly helpful.", "author": "mark-vieira", "createdAt": "2020-03-26T23:19:26Z", "path": "gradle/forbidden-dependencies.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+\n+// we do not want any of these dependencies on the compilation classpath\n+// because they could then be used within Elasticsearch\n+List<String> FORBIDDEN_DEPENDENCIES = [\n+  'guava'\n+]\n+\n+Closure checkDeps = { Configuration configuration -> \n+  configuration.resolutionStrategy.eachDependency {\n+    String artifactName = it.target.name\n+    if (FORBIDDEN_DEPENDENCIES.contains(artifactName)) {\n+      throw new GradleException(\"Dependency '${artifactName}' on configuration '${configuration.name}' is not allowed. \" +", "originalCommit": "a23ce98a3924f59628d51f2d3f9b9e331e2bd185", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxOTE2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54309#discussion_r399019161", "bodyText": "This is the current failure output. It has the full path in the first part of the error.\n> Could not resolve all files for configuration ':x-pack:plugin:identity-provider:compileClasspath'.\n   > Could not resolve com.google.guava:guava:19.0.\n     Required by:\n         project :x-pack:plugin:identity-provider\n      > Dependency 'guava' on configuration 'compileClasspath' is not allowed. If it is needed as a transitive depenency, try adding it to the runtime classpath", "author": "rjernst", "createdAt": "2020-03-27T03:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0ODQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0ODY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54309#discussion_r398948697", "bodyText": "It's worth nothing that standalone QA projects do no apply the java plugin but only java-base.", "author": "mark-vieira", "createdAt": "2020-03-26T23:20:13Z", "path": "gradle/forbidden-dependencies.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+\n+// we do not want any of these dependencies on the compilation classpath\n+// because they could then be used within Elasticsearch\n+List<String> FORBIDDEN_DEPENDENCIES = [\n+  'guava'\n+]\n+\n+Closure checkDeps = { Configuration configuration -> \n+  configuration.resolutionStrategy.eachDependency {\n+    String artifactName = it.target.name\n+    if (FORBIDDEN_DEPENDENCIES.contains(artifactName)) {\n+      throw new GradleException(\"Dependency '${artifactName}' on configuration '${configuration.name}' is not allowed. \" +\n+        \"If it is needed as a transitive depenency, try adding it to the runtime classpath\")\n+    }\n+  }\n+}\n+\n+subprojects {\n+  pluginManager.withPlugin('java') {", "originalCommit": "a23ce98a3924f59628d51f2d3f9b9e331e2bd185", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxOTE4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54309#discussion_r399019186", "bodyText": "I appreciate that, but still think this is a good start.", "author": "rjernst", "createdAt": "2020-03-27T03:44:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0ODY5Nw=="}], "type": "inlineReview"}, {"oid": "8cc49bbd92079c4dc99f8e0917efd2a5214cbb2e", "url": "https://github.com/elastic/elasticsearch/commit/8cc49bbd92079c4dc99f8e0917efd2a5214cbb2e", "message": "don't check fixtures", "committedDate": "2020-03-27T03:47:12Z", "type": "commit"}, {"oid": "b656248dda743937f50222ab31f98222cdb1de3b", "url": "https://github.com/elastic/elasticsearch/commit/b656248dda743937f50222ab31f98222cdb1de3b", "message": "Merge branch 'master' into guava_runtime", "committedDate": "2020-03-27T21:37:23Z", "type": "commit"}, {"oid": "9c80ca8cf0268ba9a16428cdb1381464d8e9ff5c", "url": "https://github.com/elastic/elasticsearch/commit/9c80ca8cf0268ba9a16428cdb1381464d8e9ff5c", "message": "apply no-transitive rules to runtimeOnly", "committedDate": "2020-03-27T21:49:12Z", "type": "commit"}, {"oid": "e538db2ec241d4b449e14b1f7b75a17149db35b2", "url": "https://github.com/elastic/elasticsearch/commit/e538db2ec241d4b449e14b1f7b75a17149db35b2", "message": "use correct runtime classpath for third party audit", "committedDate": "2020-03-27T21:58:26Z", "type": "commit"}, {"oid": "04ded15cc75c0d27a8516788be6093edcc4b0f58", "url": "https://github.com/elastic/elasticsearch/commit/04ded15cc75c0d27a8516788be6093edcc4b0f58", "message": "ignore build tools", "committedDate": "2020-03-27T22:19:06Z", "type": "commit"}, {"oid": "eab13256e99f75f67a92f58c0c396cc590539e63", "url": "https://github.com/elastic/elasticsearch/commit/eab13256e99f75f67a92f58c0c396cc590539e63", "message": "use runtimeClasspath in plugin building", "committedDate": "2020-03-27T22:33:11Z", "type": "commit"}, {"oid": "42341444c96f5e75fb84aacad7e165002ed683ec", "url": "https://github.com/elastic/elasticsearch/commit/42341444c96f5e75fb84aacad7e165002ed683ec", "message": "fixes", "committedDate": "2020-03-30T20:29:47Z", "type": "commit"}, {"oid": "2c5bdc264b402903df5a90f0b5a5ed8671d58318", "url": "https://github.com/elastic/elasticsearch/commit/2c5bdc264b402903df5a90f0b5a5ed8671d58318", "message": "use sourcesets instead of configurations directly", "committedDate": "2020-04-01T19:36:08Z", "type": "commit"}, {"oid": "2323d6f2e0f4cdd1cb65a0d22301fb4c5905fb34", "url": "https://github.com/elastic/elasticsearch/commit/2323d6f2e0f4cdd1cb65a0d22301fb4c5905fb34", "message": "add back filtering of compileOnly in plugin zips", "committedDate": "2020-04-01T19:55:47Z", "type": "commit"}, {"oid": "3eb71523f82681f0984aa30d60f9a68f22bb92a4", "url": "https://github.com/elastic/elasticsearch/commit/3eb71523f82681f0984aa30d60f9a68f22bb92a4", "message": "Merge branch 'master' into guava_runtime", "committedDate": "2020-04-01T19:58:47Z", "type": "commit"}, {"oid": "cf1fe363e2389344172dffee97e45769dc76da85", "url": "https://github.com/elastic/elasticsearch/commit/cf1fe363e2389344172dffee97e45769dc76da85", "message": "don't use guava Sets", "committedDate": "2020-04-01T21:01:17Z", "type": "commit"}, {"oid": "24b2c2ce68f199cb3dc67c0b7fb28b746bd40d9b", "url": "https://github.com/elastic/elasticsearch/commit/24b2c2ce68f199cb3dc67c0b7fb28b746bd40d9b", "message": "dont use guava charsets", "committedDate": "2020-04-01T22:14:33Z", "type": "commit"}, {"oid": "8a3007e92cd0fce3a2a0ef2a3cb388b9c2e5b8cf", "url": "https://github.com/elastic/elasticsearch/commit/8a3007e92cd0fce3a2a0ef2a3cb388b9c2e5b8cf", "message": "more eradication from tests", "committedDate": "2020-04-02T01:06:44Z", "type": "commit"}, {"oid": "9ab3abe408abd65673bfae9b74bb5578212656fb", "url": "https://github.com/elastic/elasticsearch/commit/9ab3abe408abd65673bfae9b74bb5578212656fb", "message": "add guava explicitly to test runtime", "committedDate": "2020-04-02T18:07:44Z", "type": "commit"}, {"oid": "c10d013617ab194a674a63618c7a3feba6c4e0ad", "url": "https://github.com/elastic/elasticsearch/commit/c10d013617ab194a674a63618c7a3feba6c4e0ad", "message": "Merge branch 'master' into guava_runtime", "committedDate": "2020-04-02T18:46:38Z", "type": "commit"}]}