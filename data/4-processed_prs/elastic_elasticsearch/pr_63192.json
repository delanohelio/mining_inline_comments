{"pr_number": 63192, "pr_title": "EQL: Change default indices options", "pr_createdAt": "2020-10-02T14:27:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63192", "timeline": [{"oid": "2e4de89d048d36c7a4a709da80bdd8fcf056fb49", "url": "https://github.com/elastic/elasticsearch/commit/2e4de89d048d36c7a4a709da80bdd8fcf056fb49", "message": "EQL: Change default indices options\n\nIgnore by default unavailable indices (same as ES) and verify that\nallowNoIndices is set to false since at least one index is required\nfor validating the query.\n\nFix #62986", "committedDate": "2020-10-02T14:22:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1NzI1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r498857256", "bodyText": "@imotov not sure why this fails now... Essentially by changing the index option ignoreUnavailable from false to true the 403/unauthorized became a 404...", "author": "costin", "createdAt": "2020-10-02T14:29:08Z", "path": "x-pack/plugin/eql/qa/security/src/javaRestTest/java/org/elasticsearch/xpack/eql/AsyncEqlSecurityIT.java", "diffHunk": "@@ -89,8 +89,8 @@ private void testCase(String user, String other) throws Exception {\n         }\n         ResponseException exc = expectThrows(ResponseException.class,\n             () -> submitAsyncEqlSearch(\"index-\" + other, \"*\", TimeValue.timeValueSeconds(10), user));\n-        assertThat(exc.getResponse().getStatusLine().getStatusCode(), equalTo(403));\n-        assertThat(exc.getMessage(), containsString(\"unauthorized\"));\n+        assertThat(exc.getResponse().getStatusLine().getStatusCode(), equalTo(404));\n+        //assertThat(exc.getMessage(), containsString(\"unauthorized\"));", "originalCommit": "2e4de89d048d36c7a4a709da80bdd8fcf056fb49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg5Mjc3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r498892771", "bodyText": "I think it is because we ignore unavailable indices and ended up with no indices at all, which leads to 404.", "author": "imotov", "createdAt": "2020-10-02T15:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1NzI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkzMTUwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r498931505", "bodyText": "And previously we did not ignore them but because we couldn't get access to them to verify their existence we got the 403...Make sense.", "author": "costin", "createdAt": "2020-10-02T16:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1NzI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg5NDE4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r498894185", "bodyText": "missing : at the end", "author": "imotov", "createdAt": "2020-10-02T15:30:16Z", "path": "x-pack/plugin/eql/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/eql/10_basic.yml", "diffHunk": "@@ -83,6 +83,20 @@ setup:\n   - match: {hits.sequences.1.events.0._id: \"2\"}\n   - match: {hits.sequences.1.events.1._id: \"3\"}\n \n+---\n+\"Execute EQL sequence by default ignores unavailable indices\"", "originalCommit": "2e4de89d048d36c7a4a709da80bdd8fcf056fb49", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "280a4bf98d0563a2f7c50adfa2123e24b5e91731", "url": "https://github.com/elastic/elasticsearch/commit/280a4bf98d0563a2f7c50adfa2123e24b5e91731", "message": "Update yml file", "committedDate": "2020-10-02T18:25:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4MzczMw==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r498983733", "bodyText": "@astefan the change inside EQL high-level rest client.", "author": "costin", "createdAt": "2020-10-02T18:27:09Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/eql/EqlSearchRequest.java", "diffHunk": "@@ -34,7 +34,7 @@\n public class EqlSearchRequest implements Validatable, ToXContentObject {\n \n     private String[] indices;\n-    private IndicesOptions indicesOptions = IndicesOptions.fromOptions(false, false, true, false);\n+    private IndicesOptions indicesOptions = IndicesOptions.fromOptions(true, false, true, false);", "originalCommit": "2e4de89d048d36c7a4a709da80bdd8fcf056fb49", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NjIzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r498986235", "bodyText": "@matriv the integration test against non-existing indices", "author": "costin", "createdAt": "2020-10-02T18:32:07Z", "path": "x-pack/plugin/eql/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/eql/10_basic.yml", "diffHunk": "@@ -83,6 +83,20 @@ setup:\n   - match: {hits.sequences.1.events.0._id: \"2\"}\n   - match: {hits.sequences.1.events.1._id: \"3\"}\n \n+---\n+\"Execute EQL sequence by default ignores unavailable indices\"\n+  - do:\n+      eql.search:\n+        index: eql_test,non_existing", "originalCommit": "2e4de89d048d36c7a4a709da80bdd8fcf056fb49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2MzI0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r499363242", "bodyText": "I meant to query against only unavailable indices, just for completeness.", "author": "matriv", "createdAt": "2020-10-05T06:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NjIzNQ=="}], "type": "inlineReview"}, {"oid": "3e843d6a16121b254a317f759c275b7c9a4e0e93", "url": "https://github.com/elastic/elasticsearch/commit/3e843d6a16121b254a317f759c275b7c9a4e0e93", "message": "Add integration test for non-existing index pattern", "committedDate": "2020-10-03T09:17:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2MjkyNA==", "url": "https://github.com/elastic/elasticsearch/pull/63192#discussion_r499362924", "bodyText": "Should we remove it then?", "author": "matriv", "createdAt": "2020-10-05T06:11:01Z", "path": "x-pack/plugin/eql/qa/security/src/javaRestTest/java/org/elasticsearch/xpack/eql/AsyncEqlSecurityIT.java", "diffHunk": "@@ -89,8 +89,8 @@ private void testCase(String user, String other) throws Exception {\n         }\n         ResponseException exc = expectThrows(ResponseException.class,\n             () -> submitAsyncEqlSearch(\"index-\" + other, \"*\", TimeValue.timeValueSeconds(10), user));\n-        assertThat(exc.getResponse().getStatusLine().getStatusCode(), equalTo(403));\n-        assertThat(exc.getMessage(), containsString(\"unauthorized\"));\n+        assertThat(exc.getResponse().getStatusLine().getStatusCode(), equalTo(404));\n+        //assertThat(exc.getMessage(), containsString(\"unauthorized\"));", "originalCommit": "3e843d6a16121b254a317f759c275b7c9a4e0e93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b1b352a5c047b17e4107bb6c8638900ac42850b1", "url": "https://github.com/elastic/elasticsearch/commit/b1b352a5c047b17e4107bb6c8638900ac42850b1", "message": "Remove commented code", "committedDate": "2020-10-05T11:18:17Z", "type": "commit"}]}