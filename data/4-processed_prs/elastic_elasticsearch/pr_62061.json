{"pr_number": 62061, "pr_title": "Shard Search Scroll failures consistency", "pr_createdAt": "2020-09-07T13:51:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62061", "timeline": [{"oid": "5a02677754fd170d7ba8744e5733dde0d7f84681", "url": "https://github.com/elastic/elasticsearch/commit/5a02677754fd170d7ba8744e5733dde0d7f84681", "message": "Shard Search Scroll failures consistency\n\nToday some uncaught shard failures such as RejectedExecutionException skips the release of shard context\nand let subsequent scroll requests access the same shard context again. Depending on how the other shards advanced,\nthis behavior can lead to missing data since scrolls always move forward.\nIn order to avoid hidden data loss, this commit ensures that we always release the context of shard search scroll requests whenever a failure\noccurs locally. The shard search context will no longer exist in subsequent scroll requests which will lead to consistent shard failures\nin the responses.\nThis change also modifies the retry tests of the reindex feature. Reindex retries scroll search request that contains a shard failure and\nmove on whenever the failure disappears. That is not compatible with how scrolls work and can lead to missing data as explained above.\nThat means that reindex will now report scroll failures when search rejection happen during the operation instead of skipping document\nsilently.\nFinally this change removes an old TODO that was fulfilled with #61062.", "committedDate": "2020-09-07T23:09:44Z", "type": "commit"}, {"oid": "1f12505eac0e18d8077101a807a8d0c751d0700f", "url": "https://github.com/elastic/elasticsearch/commit/1f12505eac0e18d8077101a807a8d0c751d0700f", "message": "Make the searcher for legacy reader context final\n\nThis commit ensures that the searcher that we create for scrolls is initialized only once.t", "committedDate": "2020-09-07T23:09:44Z", "type": "commit"}, {"oid": "1f12505eac0e18d8077101a807a8d0c751d0700f", "url": "https://github.com/elastic/elasticsearch/commit/1f12505eac0e18d8077101a807a8d0c751d0700f", "message": "Make the searcher for legacy reader context final\n\nThis commit ensures that the searcher that we create for scrolls is initialized only once.t", "committedDate": "2020-09-07T23:09:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3NzY3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/62061#discussion_r485077673", "bodyText": "I think we can move this method to ReaderContext? (i.e., ReaderContext.markAsUsed(long keepAliveInMillis)?", "author": "dnhatn", "createdAt": "2020-09-08T17:18:07Z", "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -643,13 +611,18 @@ private ReaderContext findReaderContext(ShardSearchContextId id, TransportReques\n         return reader;\n     }\n \n+    private Releasable updateKeepAliveAndMarkAsUsed(ReaderContext reader, long keepAlive) {", "originalCommit": "1f12505eac0e18d8077101a807a8d0c751d0700f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0OTU2NA==", "url": "https://github.com/elastic/elasticsearch/pull/62061#discussion_r485249564", "bodyText": "++, I pushed 7d92769", "author": "jimczi", "createdAt": "2020-09-08T23:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3NzY3Mw=="}], "type": "inlineReview"}, {"oid": "7d927699905a354353f242505aedf805019bade8", "url": "https://github.com/elastic/elasticsearch/commit/7d927699905a354353f242505aedf805019bade8", "message": "add keepAlive in markAsUsed", "committedDate": "2020-09-08T23:27:22Z", "type": "commit"}, {"oid": "6a569c338f743a2d6e3da261eb9b27009d057f68", "url": "https://github.com/elastic/elasticsearch/commit/6a569c338f743a2d6e3da261eb9b27009d057f68", "message": "Merge branch 'master' into scroll_failures", "committedDate": "2020-09-09T06:17:40Z", "type": "commit"}]}