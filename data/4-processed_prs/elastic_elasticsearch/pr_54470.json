{"pr_number": 54470, "pr_title": "EQL: Add string function", "pr_createdAt": "2020-03-30T22:38:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54470", "timeline": [{"oid": "0b310e3410c751647c1a732f8f774c76d4d63389", "url": "https://github.com/elastic/elasticsearch/commit/0b310e3410c751647c1a732f8f774c76d4d63389", "message": "EQL: Add string() function", "committedDate": "2020-03-30T22:37:41Z", "type": "commit"}, {"oid": "17dd8d387124c7c112b73c41f0634f9f917ace51", "url": "https://github.com/elastic/elasticsearch/commit/17dd8d387124c7c112b73c41f0634f9f917ace51", "message": "EQL: Reorder queryfolder_tests", "committedDate": "2020-03-30T22:51:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY5OTU5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r400699597", "bodyText": "Why not null the instance instead of \"null\" the string?", "author": "astefan", "createdAt": "2020-03-31T07:32:22Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/expression/function/scalar/string/ToStringFunctionProcessor.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.eql.expression.function.scalar.string;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.xpack.ql.expression.gen.processor.Processor;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class ToStringFunctionProcessor implements Processor {\n+\n+    public static final String NAME = \"sstr\";\n+\n+    private final Processor source;\n+\n+    public ToStringFunctionProcessor(Processor source) {\n+        this.source = source;\n+    }\n+\n+    public ToStringFunctionProcessor(StreamInput in) throws IOException {\n+        source = in.readNamedWriteable(Processor.class);\n+    }\n+\n+    @Override\n+    public final void writeTo(StreamOutput out) throws IOException {\n+        out.writeNamedWriteable(source);\n+    }\n+\n+    @Override\n+    public Object process(Object input) {\n+        return doProcess(source.process(input));\n+    }\n+\n+    public static Object doProcess(Object source) {\n+        return source == null ? \"null\" : source.toString();", "originalCommit": "17dd8d387124c7c112b73c41f0634f9f917ace51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTAwMDYzOA==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r401000638", "bodyText": "per #54465 and https://github.com/endgameinc/eql/blob/master/eql/functions.py#L626 I was following a contract (we can change it, of course) that this function always returns a string. So I catch null directly, since I can't call a method on it. Here's the current behavior for how it folds string(null):\n>>> import eql\n>>> eql.parse_expression(\"string(null)\")\nString(value='None')", "author": "rw-access", "createdAt": "2020-03-31T15:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY5OTU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzODY5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r403038696", "bodyText": "Since we're not using some concept of Optional, returning null instead of a string \"null\" is better since otherwise there's no way to differentiate between a string with \"null\" chars vs actual null since they would both be equivalent which is not what we want.", "author": "costin", "createdAt": "2020-04-03T14:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY5OTU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcwMDA0OA==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r400700048", "bodyText": "Wrong copy-paste? I wonder why this hasn't broken the tests though.", "author": "astefan", "createdAt": "2020-03-31T07:33:12Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/expression/function/scalar/whitelist/InternalEqlScriptUtils.java", "diffHunk": "@@ -18,6 +19,10 @@\n \n     InternalEqlScriptUtils() {}\n \n+    public static String string(String s, Number start, Number end) {", "originalCommit": "17dd8d387124c7c112b73c41f0634f9f917ace51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee2ab21395743a314a2bb11d5493f0b26555be8b", "url": "https://github.com/elastic/elasticsearch/commit/ee2ab21395743a314a2bb11d5493f0b26555be8b", "message": "EQL: Add test queries", "committedDate": "2020-03-31T15:28:25Z", "type": "commit"}, {"oid": "169dc2a35b7c1699ba15464dda62f57961b4238f", "url": "https://github.com/elastic/elasticsearch/commit/169dc2a35b7c1699ba15464dda62f57961b4238f", "message": "Merge remote-tracking branch 'origin/master' into eql/string-function", "committedDate": "2020-03-31T15:57:39Z", "type": "commit"}, {"oid": "169dc2a35b7c1699ba15464dda62f57961b4238f", "url": "https://github.com/elastic/elasticsearch/commit/169dc2a35b7c1699ba15464dda62f57961b4238f", "message": "Merge remote-tracking branch 'origin/master' into eql/string-function", "committedDate": "2020-03-31T15:57:39Z", "type": "forcePushed"}, {"oid": "de21d443bd2b28a382bd6328aafc1cd56b62b638", "url": "https://github.com/elastic/elasticsearch/commit/de21d443bd2b28a382bd6328aafc1cd56b62b638", "message": "EQL: Fix InternalEqlScriptUtils.string and test case", "committedDate": "2020-04-01T04:44:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTUyMTQzMA==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r401521430", "bodyText": "I think you can more easy write these as return Objects.equals(source, ((ToStringFunctionPipe) obj).source);", "author": "astefan", "createdAt": "2020-04-01T10:42:13Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/expression/function/scalar/string/ToStringFunctionPipe.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.eql.expression.function.scalar.string;\n+\n+import org.elasticsearch.xpack.ql.execution.search.QlSourceBuilder;\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class ToStringFunctionPipe extends Pipe {\n+\n+    private final Pipe source;\n+\n+    public ToStringFunctionPipe(Source source, Expression expression, Pipe src) {\n+        super(source, expression, Collections.singletonList(src));\n+        this.source = src;\n+    }\n+\n+    @Override\n+    public final Pipe replaceChildren(List<Pipe> newChildren) {\n+        if (newChildren.size() != 1) {\n+            throw new IllegalArgumentException(\"expected [1] children but received [\" + newChildren.size() + \"]\");\n+        }\n+        return new ToStringFunctionPipe(source(), expression(), newChildren.get(0));\n+    }\n+\n+    @Override\n+    public final Pipe resolveAttributes(AttributeResolver resolver) {\n+        Pipe newSource = source.resolveAttributes(resolver);\n+        if (newSource == source) {\n+            return this;\n+        }\n+        return replaceChildren(Collections.singletonList(newSource));\n+    }\n+\n+    @Override\n+    public boolean supportedByAggsOnlyQuery() {\n+        return source.supportedByAggsOnlyQuery();\n+    }\n+\n+    @Override\n+    public boolean resolved() {\n+        return source.resolved();\n+    }\n+\n+    @Override\n+    public final void collectFields(QlSourceBuilder sourceBuilder) {\n+        source.collectFields(sourceBuilder);\n+    }\n+\n+    @Override\n+    protected NodeInfo<ToStringFunctionPipe> info() {\n+        return NodeInfo.create(this, ToStringFunctionPipe::new, expression(), source);\n+    }\n+\n+    @Override\n+    public ToStringFunctionProcessor asProcessor() {\n+        return new ToStringFunctionProcessor(source.asProcessor());\n+    }\n+\n+    public Pipe src() {\n+        return source;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(source);\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj) {\n+            return true;\n+        }\n+\n+        if (obj == null || getClass() != obj.getClass()) {\n+            return false;\n+        }\n+\n+        ToStringFunctionPipe other = (ToStringFunctionPipe) obj;\n+        return Objects.equals(source, other.source);", "originalCommit": "de21d443bd2b28a382bd6328aafc1cd56b62b638", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTUyODIwNw==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r401528207", "bodyText": "Move this one before substring, please.", "author": "astefan", "createdAt": "2020-04-01T10:55:07Z", "path": "x-pack/plugin/eql/src/main/resources/org/elasticsearch/xpack/eql/plugin/eql_whitelist.txt", "diffHunk": "@@ -54,9 +54,10 @@ class org.elasticsearch.xpack.eql.expression.function.scalar.whitelist.InternalE\n \n #\n # ASCII Functions\n-# \n+#\n   Boolean endsWith(String, String)\n   Integer length(String)\n   Boolean startsWith(String, String)\n   String  substring(String, Number, Number)\n+  String  string(Object)", "originalCommit": "de21d443bd2b28a382bd6328aafc1cd56b62b638", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c66c87311c75a768613b2a1acd32b6857eba2bf", "url": "https://github.com/elastic/elasticsearch/commit/4c66c87311c75a768613b2a1acd32b6857eba2bf", "message": "EQL: Fix testStringFunctionWithText error message", "committedDate": "2020-04-01T22:29:27Z", "type": "commit"}, {"oid": "8b5fac06578a3172f42fecf865801a994a371907", "url": "https://github.com/elastic/elasticsearch/commit/8b5fac06578a3172f42fecf865801a994a371907", "message": "EQL: Flatten ToStringFunctionPipe.equals", "committedDate": "2020-04-01T22:30:58Z", "type": "commit"}, {"oid": "a037dda2fffdd80e52fdcda04262bf5e32d8c4e1", "url": "https://github.com/elastic/elasticsearch/commit/a037dda2fffdd80e52fdcda04262bf5e32d8c4e1", "message": "EQL: Reorder painless whitelist", "committedDate": "2020-04-01T22:31:42Z", "type": "commit"}, {"oid": "509ffd97eae134e829b39dc190a790aa0eb64319", "url": "https://github.com/elastic/elasticsearch/commit/509ffd97eae134e829b39dc190a790aa0eb64319", "message": "Merge remote-tracking branch 'origin/master' into eql/string-function", "committedDate": "2020-04-02T14:33:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA0Mjc0MA==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r403042740", "bodyText": "Please rename source to something else (delegate, target, value?) since it conflicts with Source source convention. While source was used in a couple of Processors, it was mainly to follow the function delegation and their official param names.\nThis applies to the whole PR.", "author": "costin", "createdAt": "2020-04-03T14:24:58Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/expression/function/scalar/string/ToString.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.expression.function.scalar.string;\n+\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.expression.Expressions.ParamOrdinal;\n+import org.elasticsearch.xpack.ql.expression.FieldAttribute;\n+import org.elasticsearch.xpack.ql.expression.function.scalar.ScalarFunction;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.expression.gen.script.ScriptTemplate;\n+import org.elasticsearch.xpack.ql.expression.gen.script.Scripts;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+import org.elasticsearch.xpack.ql.type.DataType;\n+import org.elasticsearch.xpack.ql.type.DataTypes;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Locale;\n+\n+import static java.lang.String.format;\n+import static org.elasticsearch.xpack.eql.expression.function.scalar.string.ToStringFunctionProcessor.doProcess;\n+import static org.elasticsearch.xpack.ql.expression.TypeResolutions.isExact;\n+import static org.elasticsearch.xpack.ql.expression.gen.script.ParamsBuilder.paramsBuilder;\n+\n+/**\n+ * EQL specific string function that wraps object.toString.\n+ */\n+public class ToString extends ScalarFunction {\n+\n+    private final Expression source;", "originalCommit": "509ffd97eae134e829b39dc190a790aa0eb64319", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNTc2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54470#discussion_r403335763", "bodyText": "The original idea was to keep this file unchanged from the original eql implementation\nhttps://github.com/endgameinc/eql/blob/master/eql/etc/test_queries.toml\nso we can sync up easier with the reference repo/impl\nand add more queries into separate file(s), could be just one, could be individual files for specific extensions\nstarted doing something like this in my other PR\nhttps://github.com/elastic/elasticsearch/pull/54277/files/be0b67cdf5022f38ec3610a68bbb91af8b10b8b3#diff-00cfec987b028a9cc67295e57c02cf68R1", "author": "aleksmaus", "createdAt": "2020-04-03T21:06:18Z", "path": "x-pack/plugin/eql/qa/common/src/main/resources/test_queries.toml", "diffHunk": "@@ -2,6 +2,15 @@\n query = 'process where serial_event_id = 1'\n expected_event_ids  = [1]\n \n+[[queries]]\n+query = 'process where string(serial_event_id) = \"1\"'\n+expected_event_ids  = [1]\n+\n+[[queries]]\n+note = \"check that string(null) returns 'null'\"\n+expected_event_ids  = [1, 2]\n+query = 'process where opcode == 3 and string(ppid) == \"null\"'\n+", "originalCommit": "509ffd97eae134e829b39dc190a790aa0eb64319", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9ca95a692bb79b7a781b3afd0dfb54cdc2c52a47", "url": "https://github.com/elastic/elasticsearch/commit/9ca95a692bb79b7a781b3afd0dfb54cdc2c52a47", "message": "Merge branch 'master' into eql/string-function", "committedDate": "2020-04-07T22:42:46Z", "type": "commit"}, {"oid": "25f9e6b2bd756624572628846cdf93d921570221", "url": "https://github.com/elastic/elasticsearch/commit/25f9e6b2bd756624572628846cdf93d921570221", "message": "EQL: Address feedback and remove string(null) handling", "committedDate": "2020-04-07T22:50:31Z", "type": "commit"}, {"oid": "dedf571d86251292617d87560199f1fa63822558", "url": "https://github.com/elastic/elasticsearch/commit/dedf571d86251292617d87560199f1fa63822558", "message": "EQL: Move string(pid) test over", "committedDate": "2020-04-07T22:52:14Z", "type": "commit"}, {"oid": "2f08b0c06a6dc15010dc6188a6987eefbbc4a931", "url": "https://github.com/elastic/elasticsearch/commit/2f08b0c06a6dc15010dc6188a6987eefbbc4a931", "message": "EQL: Rename source -> value", "committedDate": "2020-04-07T22:55:07Z", "type": "commit"}, {"oid": "bd9ecce5a924c6980b19f78f02ad60b6b85beee5", "url": "https://github.com/elastic/elasticsearch/commit/bd9ecce5a924c6980b19f78f02ad60b6b85beee5", "message": "Merge branch 'master' into eql/string-function", "committedDate": "2020-04-08T22:33:13Z", "type": "commit"}]}