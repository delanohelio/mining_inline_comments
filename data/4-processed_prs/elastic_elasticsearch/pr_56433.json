{"pr_number": 56433, "pr_title": "Fix bug in faster interval rounding", "pr_createdAt": "2020-05-08T14:53:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56433", "timeline": [{"oid": "1bf39c7fc32d34ae05fe84080ed6fa3d9e535766", "url": "https://github.com/elastic/elasticsearch/commit/1bf39c7fc32d34ae05fe84080ed6fa3d9e535766", "message": "Fix bug in faster interval rounding\n\nThis fixes a bug in the interval rounding and two test bugs that showed\nup when I ran 1000s of iterations of the tests. The bug was that we\ncould end up with duplicate transitions if we only needed the last\ntransition from the list of fully defined transitions and the\ntransitions overlapped with the rules. This happens. Its ok. We had\ndefence against that if we needed more than one transition but forgot it\nin this case. Now we have it and assertions to make sure we catch any\nsimilar mistakes.\n\nOne test bug had to do with the randomized test calling\n`round(round(min))` because sometimes the first `round` call will return\na time less than min. Specifically if `min` is near daylight savings\ntime. Anyway, this change fixes it by building an extra-wide prepared\nrounding just in case.\n\nThe other test bug came up when adding a test for the real bug, namely\nthat `assertRoundingAtOffset` made an assertion that wasn't true if the\ntime to round ended up being in an overlap. This just drops that\nassertion. We have similar assertions in cases where we *know* what kind\nof offsets we're working with in other tests.\n\nCloses #56400", "committedDate": "2020-05-08T14:37:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5MDA3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56433#discussion_r422190075", "bodyText": "This is the actual bug fix.", "author": "nik9000", "createdAt": "2020-05-08T14:54:11Z", "path": "server/src/main/java/org/elasticsearch/common/LocalTimeOffset.java", "diffHunk": "@@ -560,6 +563,11 @@ private static LocalTimeOffset checkForFixedZone(ZoneId zone, ZoneRules rules) {\n         if (false == itr.hasNext()) {\n             if (minSecond < t.toEpochSecond() && t.toEpochSecond() < maxSecond) {\n                 transitions.add(t);\n+                /*\n+                 * Sometimes the rules duplicate the transitions. And\n+                 * duplicates confuse us. So we have to skip past them.\n+                 */\n+                minSecond = t.toEpochSecond() + 1;", "originalCommit": "1bf39c7fc32d34ae05fe84080ed6fa3d9e535766", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a894a8fd45877a7519fbb8a8c1970bf9bb9bfbea", "url": "https://github.com/elastic/elasticsearch/commit/a894a8fd45877a7519fbb8a8c1970bf9bb9bfbea", "message": "checkstyle", "committedDate": "2020-05-08T15:07:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIwNzU1NA==", "url": "https://github.com/elastic/elasticsearch/pull/56433#discussion_r422207554", "bodyText": "I don't understand the phrase \"transitions overlap its rules\"", "author": "not-napoleon", "createdAt": "2020-05-08T15:25:26Z", "path": "server/src/test/java/org/elasticsearch/common/LocalTimeOffsetTests.java", "diffHunk": "@@ -155,6 +154,22 @@ public void testLastTransitionWithoutRules() {\n         assertRoundingAtOffset(lookup.lookup(time), time, TimeUnit.MINUTES.toMillis(345));\n     }\n \n+    public void testLastTransitionOverlapsRules() {\n+        /*\n+         * America/Tijuana's transitions overlap its rules and we have to make", "originalCommit": "a894a8fd45877a7519fbb8a8c1970bf9bb9bfbea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "52bde8e4e180cbc820df45c622bd42f7a2d807e4", "url": "https://github.com/elastic/elasticsearch/commit/52bde8e4e180cbc820df45c622bd42f7a2d807e4", "message": "Rewrite docs", "committedDate": "2020-05-08T15:40:06Z", "type": "commit"}, {"oid": "c0589ab236c89bd69fc55459966031c19bcec768", "url": "https://github.com/elastic/elasticsearch/commit/c0589ab236c89bd69fc55459966031c19bcec768", "message": "Link to definition", "committedDate": "2020-05-08T15:42:29Z", "type": "commit"}]}