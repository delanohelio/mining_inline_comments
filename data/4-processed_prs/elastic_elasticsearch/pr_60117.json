{"pr_number": 60117, "pr_title": "Remove Mostly Redundant Deleting in FsBlobContainer", "pr_createdAt": "2020-07-23T13:11:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60117", "timeline": [{"oid": "ae02b59403d1f790878c3495efe00920e12ca978", "url": "https://github.com/elastic/elasticsearch/commit/ae02b59403d1f790878c3495efe00920e12ca978", "message": "Remove Redundant Deleting in FsBlobContainer\n\nIn almost all cases we write uuid named files via this method.\nPreemptively deleting just wastes IO ops, we can delete after a write failed\nand retry the write to cover the few cases where we actually do an overwrite.", "committedDate": "2020-07-23T13:07:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc5MDI3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60117#discussion_r460790276", "bodyText": "Not sure why you put this in an else block, but the next call to writeToPath outside of it. I would either put both in else (preferred) or none of them", "author": "ywelsch", "createdAt": "2020-07-27T10:17:28Z", "path": "server/src/main/java/org/elasticsearch/common/blobstore/fs/FsBlobContainer.java", "diffHunk": "@@ -176,11 +176,17 @@ public long readBlobPreferredLength() {\n \n     @Override\n     public void writeBlob(String blobName, InputStream inputStream, long blobSize, boolean failIfAlreadyExists) throws IOException {\n-        if (failIfAlreadyExists == false) {\n-            deleteBlobsIgnoringIfNotExists(Collections.singletonList(blobName));\n-        }\n         final Path file = path.resolve(blobName);\n-        writeToPath(inputStream, file, blobSize);\n+        try {\n+            writeToPath(inputStream, file, blobSize);\n+        } catch (FileAlreadyExistsException faee) {\n+            if (failIfAlreadyExists) {\n+                throw faee;\n+            } else {\n+                deleteBlobsIgnoringIfNotExists(Collections.singletonList(blobName));", "originalCommit": "ae02b59403d1f790878c3495efe00920e12ca978", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f21276a9742e7676e9ee2d3e8983d7e0e515d538", "url": "https://github.com/elastic/elasticsearch/commit/f21276a9742e7676e9ee2d3e8983d7e0e515d538", "message": "Merge remote-tracking branch 'elastic/master' into faster-fs-repo-write", "committedDate": "2020-07-27T10:21:28Z", "type": "commit"}, {"oid": "3d1c7453f338dac3555eaebf2c157069d190c79d", "url": "https://github.com/elastic/elasticsearch/commit/3d1c7453f338dac3555eaebf2c157069d190c79d", "message": "CR: unwrap redundant else", "committedDate": "2020-07-27T10:23:23Z", "type": "commit"}]}