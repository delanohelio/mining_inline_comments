{"pr_number": 63603, "pr_title": "Remove some more usages of QueryShardContext#getMapperService", "pr_createdAt": "2020-10-13T11:27:24Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63603", "timeline": [{"oid": "64154908546aae1f6b7ecfc3f243097be7e03d64", "url": "https://github.com/elastic/elasticsearch/commit/64154908546aae1f6b7ecfc3f243097be7e03d64", "message": "Remove some more usages of QueryShardContext#getMapperService\n\nThe 7.x branch has usages of QueryShardContext#getMapperService that revolve around types, which can be replaced by adding a couple of specific methods to QueryShardContext.\n\nThis commit takes care of those as well as a couple of other usages that can be removed.", "committedDate": "2020-10-13T11:24:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503874165", "bodyText": "the supplier feels weird, yet I believe we need to distinguish between a null document mapper and a null type, hence simply providing the type as an argument did not feel right to me. Happy to be proven wrong.", "author": "javanna", "createdAt": "2020-10-13T11:28:34Z", "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -85,13 +85,13 @@ public Status needsField(FieldInfo fieldInfo) {\n         // All these fields are single-valued so we can stop when the set is\n         // empty\n         return requiredFields.isEmpty()\n-                ? Status.STOP\n-                : Status.NO;\n+            ? Status.STOP\n+            : Status.NO;\n     }\n \n-    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable DocumentMapper mapper) {\n-        if (mapper != null) {\n-            type = mapper.type();\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable Supplier<String> typeSupplier) {\n+        if (typeSupplier != null) {\n+            type = typeSupplier.get();", "originalCommit": "64154908546aae1f6b7ecfc3f243097be7e03d64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3ODc0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503878746", "bodyText": "The only time you would have a null type is if no mappings were configured; in which case there would be no documents in the index, and FieldsVisitor would not be able to load any data.  So I think you can just replace this with a straight String - it might even be worth adding an assertion that the type is not null here?", "author": "romseygeek", "createdAt": "2020-10-13T11:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3OTcwMA==", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503879700", "bodyText": "ok will do thanks for the feedback", "author": "javanna", "createdAt": "2020-10-13T11:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE2NQ=="}], "type": "inlineReview"}, {"oid": "ee1d444052718a5febc83aff39f35f1f89bae042", "url": "https://github.com/elastic/elasticsearch/commit/ee1d444052718a5febc83aff39f35f1f89bae042", "message": "spotless", "committedDate": "2020-10-13T11:36:58Z", "type": "commit"}, {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5", "url": "https://github.com/elastic/elasticsearch/commit/7c79179f7c6cd0587ee7fac2fb160a9d6beffef5", "message": "iter", "committedDate": "2020-10-13T13:23:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0ODczNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503948735", "bodyText": "I took a shortcut here, to avoid having to expose typeText from MapperService. Is it reasonable?", "author": "javanna", "createdAt": "2020-10-13T13:25:06Z", "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/EnrichShardMultiSearchAction.java", "diffHunk": "@@ -237,7 +237,8 @@ protected MultiSearchResponse shardOperation(Request request, ShardId shardId) t\n                     () -> { throw new UnsupportedOperationException(); },\n                     null\n                 );\n-                final Text typeText = context.getMapperService().documentMapper().typeText();\n+                final String type = context.getType();\n+                final Text typeText = new Text(type);", "originalCommit": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1MzgyNg==", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503953826", "bodyText": "++", "author": "romseygeek", "createdAt": "2020-10-13T13:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0ODczNQ=="}], "type": "inlineReview"}]}