{"pr_number": 52210, "pr_title": "SQL: [Docs] Add limitation for sorting on aggs", "pr_createdAt": "2020-02-11T14:52:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52210", "timeline": [{"oid": "a1cc30b572faa8f6c2cd2dfce040431ac2c02409", "url": "https://github.com/elastic/elasticsearch/commit/a1cc30b572faa8f6c2cd2dfce040431ac2c02409", "message": "SQL: [Docs] Add limitation for sorting on aggs\n\nAdd a sections to point out that when ordering by an aggregate\ncertain restrictions are applied to the columns used in the `ORDER BY`\nclause. Only the exact same aggregate function(s) as in the `SELECT`\nclause and/or the exact same grouping keys must be used.\n\nFixes: #52204", "committedDate": "2020-02-11T14:49:10Z", "type": "commit"}, {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8", "url": "https://github.com/elastic/elasticsearch/commit/0509c6675e6e323b7798c681cf6396cca46905a8", "message": "Merge remote-tracking branch 'upstream/master' into fix-52204", "committedDate": "2020-02-11T16:05:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1MzMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r377753315", "bodyText": "\"they must be the exact the same exact aggregation\"", "author": "bpintea", "createdAt": "2020-02-11T16:36:21Z", "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,22 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, if there are aggregation(s) in the `ORDER BY`, they must be the exact the same exact aggregation", "originalCommit": "0509c6675e6e323b7798c681cf6396cca46905a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1MzkxMA==", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r377753910", "bodyText": "\"that are defined in the GROUP BY\"", "author": "bpintea", "createdAt": "2020-02-11T16:37:16Z", "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,22 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, if there are aggregation(s) in the `ORDER BY`, they must be the exact the same exact aggregation\n+expressions(s), as used in the `SELECT` clause. The same applies for the fields that are defined the `GROUP BY` clause:", "originalCommit": "0509c6675e6e323b7798c681cf6396cca46905a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1NjI2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r377756265", "bodyText": "Might be useful to add one-two examples on how to change the statement, so that it works. Up to you.", "author": "bpintea", "createdAt": "2020-02-11T16:40:51Z", "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,22 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, if there are aggregation(s) in the `ORDER BY`, they must be the exact the same exact aggregation\n+expressions(s), as used in the `SELECT` clause. The same applies for the fields that are defined the `GROUP BY` clause:\n+they must be the exact same expressions in the `ORDER BY` as in the `GROUP BY`. No operators or scalar functions can be\n+used on top or removed from those expressions. Here are some examples of queries that are not allowed:\n+\n+[source, sql]\n+--------------------------------------------------\n+SELECT age, MAX(salary) FROM test GROUP BY gender ORDER BY age % 10, MAX(salary);\n+\n+SELECT age, MAX(salary) FROM test GROUP BY gender ORDER BY age, CAST(MAX(salary) AS FLOAT);\n+\n+SELECT age % 10, MAX(salary) FROM test GROUP BY gender ORDER BY age, MAX(salary);\n+\n+SELECT age, MAX(salary) / 12 AS max_salary FROM test GROUP BY ORDER BY age, MAX(salary);\n+--------------------------------------------------", "originalCommit": "0509c6675e6e323b7798c681cf6396cca46905a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5191624cf139adc65beb7d537849b62926a5cd51", "url": "https://github.com/elastic/elasticsearch/commit/5191624cf139adc65beb7d537849b62926a5cd51", "message": "fix limitation", "committedDate": "2020-02-11T19:46:59Z", "type": "commit"}, {"oid": "94b28283844b020101f073c72c9775ec811ce06c", "url": "https://github.com/elastic/elasticsearch/commit/94b28283844b020101f073c72c9775ec811ce06c", "message": "gender -> age", "committedDate": "2020-02-11T19:52:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3NjM1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r378176355", "bodyText": "\"must be only plain aggregate functions\" could be rephrased to \"can only be ...\"", "author": "bpintea", "createdAt": "2020-02-12T10:53:03Z", "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,17 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, the aggregation(s) used in the `ORDER BY`, must be only plain aggregate functions. No scalar", "originalCommit": "94b28283844b020101f073c72c9775ec811ce06c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "969b929f455b6fa607272057f58888e7bd896a29", "url": "https://github.com/elastic/elasticsearch/commit/969b929f455b6fa607272057f58888e7bd896a29", "message": "address comments", "committedDate": "2020-02-12T11:40:27Z", "type": "commit"}]}