{"pr_number": 56495, "pr_title": "SQL/EQL: Add support for scalars within LIKE/RLIKE", "pr_createdAt": "2020-05-10T17:57:12Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56495", "timeline": [{"oid": "6046bbc50111563ae7cfe44614ef054c596d1138", "url": "https://github.com/elastic/elasticsearch/commit/6046bbc50111563ae7cfe44614ef054c596d1138", "message": "SQL/EQL: Add support for scalars within LIKE/RLIKE\n\n- Add support for scalar functions on the field of SQL's LIKE/RLIKE\n- Add support for scalar functions on the field of EQL's match\n- Allow EQL's match to have the field argument as the last one\n\nCloses: #55058", "committedDate": "2020-05-10T17:53:01Z", "type": "commit"}, {"oid": "b4866b486587f39aff1cee72131ba6c334d28ba2", "url": "https://github.com/elastic/elasticsearch/commit/b4866b486587f39aff1cee72131ba6c334d28ba2", "message": "fix imports", "committedDate": "2020-05-11T08:13:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0ODA2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r423148065", "bodyText": "This should be an optimization rule not analysis (since the literal might not be folded).\nIt also seems incomplete - what if there are multiple non-literals? Is there any validation happening (verifier rule) in the chain?", "author": "costin", "createdAt": "2020-05-11T16:02:54Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/analysis/Analyzer.java", "diffHunk": "@@ -120,4 +124,24 @@ protected LogicalPlan rule(LogicalPlan plan) {\n             });\n         }\n     }\n-}\n\\ No newline at end of file\n+\n+    private class MatchLiteralsOnTheRight extends AnalyzerRule<LogicalPlan> {\n+\n+        @Override\n+        protected LogicalPlan rule(LogicalPlan plan) {\n+            return plan.transformExpressionsUp(e -> {\n+                if (e instanceof Match) {\n+                    Match m = (Match) e;\n+                    int size = m.children().size();\n+                    if ((m.children().get(size - 1) instanceof Literal) == false) {\n+                        List<Expression> newChildren = new ArrayList<>(m.children().size());\n+                        newChildren.add(m.children().get(size - 1));\n+                        newChildren.addAll(m.children().subList(0, size - 1));\n+                        return m.replaceChildren(newChildren);\n+                    }\n+                }\n+                return e;\n+            });\n+        }\n+    }\n+}", "originalCommit": "b4866b486587f39aff1cee72131ba6c334d28ba2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE1NjI0MA==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r423156240", "bodyText": "I didn't like that either to take place in the analysis, but this way the Verifier will call the resolveType() on the Match which will indeed check that the patterns are constants (foldable).\nIf we apply the rule in the Optimizer that's after the verifier so it will \"blow up\".  Any suggestion?", "author": "matriv", "createdAt": "2020-05-11T16:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0ODA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIzODExOA==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r423238118", "bodyText": "It sounds to me like the resolveType method needs improving;\nthis rule moves the last items to the front of the list so instead of doing that outside Match, the class itself should have the proper behavior in place.", "author": "costin", "createdAt": "2020-05-11T18:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE0ODA2NQ=="}], "type": "inlineReview"}, {"oid": "d8371d2d17082eac080f35c1076303c26af114d3", "url": "https://github.com/elastic/elasticsearch/commit/d8371d2d17082eac080f35c1076303c26af114d3", "message": "Handle field as last argument in the ctor", "committedDate": "2020-05-12T08:58:00Z", "type": "commit"}, {"oid": "68e55444d12ceb141ce100a9e54b089734ee85d4", "url": "https://github.com/elastic/elasticsearch/commit/68e55444d12ceb141ce100a9e54b089734ee85d4", "message": "Merge remote-tracking branch 'upstream/master' into impl-55058", "committedDate": "2020-05-12T08:58:10Z", "type": "commit"}, {"oid": "ea5d529346bf9d5ce2801746880610832fbc1ec2", "url": "https://github.com/elastic/elasticsearch/commit/ea5d529346bf9d5ce2801746880610832fbc1ec2", "message": "different approach for the match args re-arrangement", "committedDate": "2020-05-12T13:57:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5OTk3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r423799979", "bodyText": "I would emphasize the two \"versions\" of match function, rather than mentioning that one argument needs to be a field.\nSomething more aligned with the (to be updated) documentation.\nFor example \"either first or last argument of match must be a non-constant\" (or around the same idea).", "author": "astefan", "createdAt": "2020-05-12T14:54:32Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/expression/function/scalar/string/Match.java", "diffHunk": "@@ -65,29 +72,39 @@ protected TypeResolution resolveType() {\n             return new TypeResolution(\"Unresolved children\");\n         }\n \n-        TypeResolution resolution = isStringAndExact(field, sourceText(), ParamOrdinal.FIRST);\n-        if (resolution.unresolved()) {\n-            return resolution;\n-        }\n-\n-        int index = 1;\n-        for (Expression regex : patterns) {\n+        TypeResolution resolution;\n+        int index = 0;\n+        List<Integer> nonFoldables = new ArrayList<>(2);\n+        for (Expression e : children()) {\n             // Currently we have limited enum for ordinal numbers\n             // So just using default here for error messaging\n-            resolution = isStringAndExact(regex, sourceText(), ParamOrdinal.fromIndex(index));\n+            ParamOrdinal paramOrd = ParamOrdinal.fromIndex(index);\n+            resolution = isStringAndExact(e, sourceText(), paramOrd);\n             if (resolution.unresolved()) {\n                 return resolution;\n             }\n-\n-            resolution = isFoldable(regex, sourceText(), ParamOrdinal.fromIndex(index));\n+            resolution = isFoldable(e, sourceText(), paramOrd);\n             if (resolution.unresolved()) {\n-                break;\n+                nonFoldables.add(index);\n             }\n-\n             index++;\n         }\n \n-        return resolution;\n+        if (nonFoldables.size() == 2) {\n+            StringBuilder sb = new StringBuilder(format(null, \"only one argument of [{}] must be non-constant but multiple found: \",", "originalCommit": "ea5d529346bf9d5ce2801746880610832fbc1ec2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgzOTIyNA==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r423839224", "bodyText": "But now we allow the field to be anywhere, should we change and be stricter and allow only first and last?", "author": "matriv", "createdAt": "2020-05-12T15:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5OTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMDQwOA==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r424010408", "bodyText": "Based on the docs my understand is the field (source) would have to be first and the rest would be patterns.\nThere's no mention of them being literals but the code does seem to indicate that.\n@aleksmaus @rw-access can you please advise?", "author": "costin", "createdAt": "2020-05-12T20:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5OTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMjY1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r424012653", "bodyText": "Yes, the rest must be literal strings. I believe we currently accept expressions that fold to strings as well.\nI can update the documentation in a few places to reflect that. The rationale is that building regular expressions on the fly generally lead to poor performance or malformed expressions. For some of the existing EQL implementations, we need to know at compile time, so that the state machine can be built only once.", "author": "rw-access", "createdAt": "2020-05-12T20:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5OTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxNTI3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r424015276", "bodyText": "The same restrictions apply to match, cidrMatch and wildcard.\nAt one point in the past, the function signature used to look like this: match(<regex>, <expr>), but that's been abandoned and now it's a variadic function of the form match(<expr>, <regex1>, <regex2>, ...). There may have been some tests that were of the old form that didn't get changed because they were being supported for backwards compatibility.  But I think it's okay to drop the ambiguous representation and stick with match(<expr>, <regex1>, <regex2>, ...)", "author": "rw-access", "createdAt": "2020-05-12T20:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5OTk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMjI5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r424012296", "bodyText": "Why isn't this done inside the main Match constructor or even better inside makeSubstitute?", "author": "costin", "createdAt": "2020-05-12T20:26:20Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/optimizer/Optimizer.java", "diffHunk": "@@ -122,4 +126,31 @@ protected LogicalPlan rule(Filter filter) {\n             });\n         }\n     }\n+\n+    private static class MatchLiteralsOnTheRight extends OptimizerRule<Filter> {\n+\n+        @Override\n+        protected LogicalPlan rule(Filter filter) {\n+            return filter.transformExpressionsUp(e -> {\n+                if (e instanceof Match) {\n+                    Match m = (Match) e;\n+                    if (m.children().get(0).foldable()) {\n+                        int size = m.children().size();\n+                        List<Expression> newChildren = new ArrayList<>(size);\n+                        Expression field = null;\n+                        for (Expression c : m.children()) {\n+                            if (c.foldable() == false) {\n+                                field = c;\n+                            } else {\n+                                newChildren.add(c);\n+                            }\n+                        }\n+                        newChildren.add(0, field);\n+                        return m.replaceChildren(newChildren);", "originalCommit": "ea5d529346bf9d5ce2801746880610832fbc1ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMzgwOA==", "url": "https://github.com/elastic/elasticsearch/pull/56495#discussion_r424013808", "bodyText": "I don't exactly know the issue that motivated some of these changes, and am not sure why loosening up the signature of match is a good thing.\nFor this example, I'm confused how it's supposed to be evaluated. Which argument is the source string and which are the patterns to be matched against?", "author": "rw-access", "createdAt": "2020-05-12T20:29:12Z", "path": "x-pack/plugin/eql/qa/common/src/main/resources/test_queries_supported.toml", "diffHunk": "@@ -82,6 +82,24 @@ query = '''\n process where match(command_line, '.*?net[1]?  localgroup.*?', '.*? myappserver.py .*?')\n '''\n \n+[[queries]]\n+expected_event_ids  = [50, 97, 98]\n+query = '''\n+process where match('.*?net[1]?  localgroup.*?', command_line,'.*? myappserver.py .*?')", "originalCommit": "ea5d529346bf9d5ce2801746880610832fbc1ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6337d16dd200fd8e0a47078b85c6baa8b432e35", "url": "https://github.com/elastic/elasticsearch/commit/e6337d16dd200fd8e0a47078b85c6baa8b432e35", "message": "revert optimization for field accepted as any argument", "committedDate": "2020-05-13T07:34:27Z", "type": "commit"}, {"oid": "d61208a8149d3efebe4bb047e6a054d1e0ec0874", "url": "https://github.com/elastic/elasticsearch/commit/d61208a8149d3efebe4bb047e6a054d1e0ec0874", "message": "Merge remote-tracking branch 'upstream/master' into impl-55058", "committedDate": "2020-05-13T07:43:24Z", "type": "commit"}]}