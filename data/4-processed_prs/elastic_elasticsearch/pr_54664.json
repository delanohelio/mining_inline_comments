{"pr_number": 54664, "pr_title": "Rest spec and documentation", "pr_createdAt": "2020-04-02T16:28:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54664", "timeline": [{"oid": "16d4334c8a652d4d4e396cf3acfa29ca120abae0", "url": "https://github.com/elastic/elasticsearch/commit/16d4334c8a652d4d4e396cf3acfa29ca120abae0", "message": "Rest spec and documentation\n\nThis change adds the spec for the new REST APIs that we\nintroduce for the IDP and documentation for each of the APIs. The\ndocumentation pages are intentionally not included in the API\nreference so as to minimize unnecessary exposure.\n\nsupersedes: #53858", "committedDate": "2020-04-02T16:26:47Z", "type": "commit"}, {"oid": "fa717bde656ebb0405846c4173a22c00a39d5ce4", "url": "https://github.com/elastic/elasticsearch/commit/fa717bde656ebb0405846c4173a22c00a39d5ce4", "message": "Merge remote-tracking branch 'origin/master' into rest-spec-idp-master", "committedDate": "2020-04-07T06:53:43Z", "type": "commit"}, {"oid": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "url": "https://github.com/elastic/elasticsearch/commit/8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "message": "Adjust metadata API docs", "committedDate": "2020-04-07T07:59:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2ODE4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405268186", "bodyText": "FYI, @lcawl is working on some generic docs for secondary authentication, which we can link to when they're ready.", "author": "tvernum", "createdAt": "2020-04-08T05:36:17Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-init.asciidoc", "diffHunk": "@@ -0,0 +1,122 @@\n+[role=\"xpack\"]\n+[[idp-saml-init]]\n+=== Generate a SAML authentication response message\n+++++\n+<titleabbrev>Generate SAML response</titleabbrev>\n+++++\n+Generates a SAML Response message to be sent to a Service Provider\n+\n+[[idp-saml-init-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/init`\n+\n+[[idp-saml-init-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/init` privilege.\n+\n+[[idp-saml-init-desc]]\n+==== {api-description-title}\n+\n+This API generates a SAML Response message that should be sent to a Service Provider as part of an\n+IDP initiated or SP initiated SAML Single Sign On. This API expects the caller to present\n+credentials for the user that the SAML Response will be created for as \"Secondary Authentication\"\n+using the `es-secondary-authorization` HTTP Request header.", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2ODQ2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405268467", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The SAML response is returned as an XML String and the caller of the API is responsible to instruct\n          \n          \n            \n            The SAML response is returned as a String that contains an XML document. The caller of the API is responsible to instruct", "author": "tvernum", "createdAt": "2020-04-08T05:37:17Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-init.asciidoc", "diffHunk": "@@ -0,0 +1,122 @@\n+[role=\"xpack\"]\n+[[idp-saml-init]]\n+=== Generate a SAML authentication response message\n+++++\n+<titleabbrev>Generate SAML response</titleabbrev>\n+++++\n+Generates a SAML Response message to be sent to a Service Provider\n+\n+[[idp-saml-init-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/init`\n+\n+[[idp-saml-init-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/init` privilege.\n+\n+[[idp-saml-init-desc]]\n+==== {api-description-title}\n+\n+This API generates a SAML Response message that should be sent to a Service Provider as part of an\n+IDP initiated or SP initiated SAML Single Sign On. This API expects the caller to present\n+credentials for the user that the SAML Response will be created for as \"Secondary Authentication\"\n+using the `es-secondary-authorization` HTTP Request header.\n+\n+The SAML response is returned as an XML String and the caller of the API is responsible to instruct", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2ODkyNw==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405268927", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            curl -u idp_admin:idp_admin_pwd <1> -H 'Content-Type: application/json' \\\n          \n          \n            \n            curl -u idp_admin:idp_admin_pwd <1> \\\n          \n          \n            \n              -H 'Content-Type: application/json' \\\n          \n      \n    \n    \n  \n\nI think this will be neater if the footnotes are always at the end of line (but that's a personal view)", "author": "tvernum", "createdAt": "2020-04-08T05:38:32Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-init.asciidoc", "diffHunk": "@@ -0,0 +1,122 @@\n+[role=\"xpack\"]\n+[[idp-saml-init]]\n+=== Generate a SAML authentication response message\n+++++\n+<titleabbrev>Generate SAML response</titleabbrev>\n+++++\n+Generates a SAML Response message to be sent to a Service Provider\n+\n+[[idp-saml-init-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/init`\n+\n+[[idp-saml-init-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/init` privilege.\n+\n+[[idp-saml-init-desc]]\n+==== {api-description-title}\n+\n+This API generates a SAML Response message that should be sent to a Service Provider as part of an\n+IDP initiated or SP initiated SAML Single Sign On. This API expects the caller to present\n+credentials for the user that the SAML Response will be created for as \"Secondary Authentication\"\n+using the `es-secondary-authorization` HTTP Request header.\n+\n+The SAML response is returned as an XML String and the caller of the API is responsible to instruct\n+the end user's browser to make an HTTP Post request to the Service Provider with the SAML response\n+Base64 encoded.\n+\n+[[idp-saml-init-body]]\n+==== {api-request-body-title}\n+\n+The following parameters can be specified in the body of a POST request:\n+\n+`entity_id`::\n+(Required, string) The SAML entity Id of the service provider that will be the recipient of the SAML Response.\n+\n+`acs`::\n+(Required, string) The assertion consumer service URL of the service provider that will be the recipient of the SAML Response.\n+\n+`authn_state`::\n+(Optional, object) The JSON structure that <<idp-saml-validate>> returns. This should only be\n+provided when calling this API as part of an SP initiated Single Sign On.\n+\n+\n+[[idp-saml-init-example]]\n+==== {api-examples-title}\n+\n+The following example generates a SAML Response for an IDP initiated SAML Single Sign On to the Service Provider with entity Id\n+`https://sp1.kibana.org` and an assertion consumer service URL that is `https://sp1.kibana.org/saml/acs`\n+\n+[source, sh]\n+--------------------------------------------------------------------\n+curl -u idp_admin:idp_admin_pwd <1> -H 'Content-Type: application/json' \\", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2OTE1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405269156", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            header, an elasticsearch access token, or an API key.\n          \n          \n            \n            header, an {es} access token, or an API key.", "author": "tvernum", "createdAt": "2020-04-08T05:39:10Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-init.asciidoc", "diffHunk": "@@ -0,0 +1,122 @@\n+[role=\"xpack\"]\n+[[idp-saml-init]]\n+=== Generate a SAML authentication response message\n+++++\n+<titleabbrev>Generate SAML response</titleabbrev>\n+++++\n+Generates a SAML Response message to be sent to a Service Provider\n+\n+[[idp-saml-init-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/init`\n+\n+[[idp-saml-init-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/init` privilege.\n+\n+[[idp-saml-init-desc]]\n+==== {api-description-title}\n+\n+This API generates a SAML Response message that should be sent to a Service Provider as part of an\n+IDP initiated or SP initiated SAML Single Sign On. This API expects the caller to present\n+credentials for the user that the SAML Response will be created for as \"Secondary Authentication\"\n+using the `es-secondary-authorization` HTTP Request header.\n+\n+The SAML response is returned as an XML String and the caller of the API is responsible to instruct\n+the end user's browser to make an HTTP Post request to the Service Provider with the SAML response\n+Base64 encoded.\n+\n+[[idp-saml-init-body]]\n+==== {api-request-body-title}\n+\n+The following parameters can be specified in the body of a POST request:\n+\n+`entity_id`::\n+(Required, string) The SAML entity Id of the service provider that will be the recipient of the SAML Response.\n+\n+`acs`::\n+(Required, string) The assertion consumer service URL of the service provider that will be the recipient of the SAML Response.\n+\n+`authn_state`::\n+(Optional, object) The JSON structure that <<idp-saml-validate>> returns. This should only be\n+provided when calling this API as part of an SP initiated Single Sign On.\n+\n+\n+[[idp-saml-init-example]]\n+==== {api-examples-title}\n+\n+The following example generates a SAML Response for an IDP initiated SAML Single Sign On to the Service Provider with entity Id\n+`https://sp1.kibana.org` and an assertion consumer service URL that is `https://sp1.kibana.org/saml/acs`\n+\n+[source, sh]\n+--------------------------------------------------------------------\n+curl -u idp_admin:idp_admin_pwd <1> -H 'Content-Type: application/json' \\\n+-H 'es-secondary-authorization: ApiKey dVhmUDBuQUJERWhZWEZaQVg5S0k6WUJubmZwNEtRZ1d4cGRxdXBzZmFDUQ==' <2> \\\n+localhost:9200/_idp/saml/init -d '{\"entity_id\":\"https://sp1.kibana.org\",\"acs\":\"https://sp1.kibana.org/saml/acs\"}'\n+--------------------------------------------------------------------\n+// NOTCONSOLE\n+<1> The credentials of the user that has the necessary privileges to call this API\n+<2> The credentials of the end user for which the SAML Response will be generated. These can be in the form of a Basic authentication\n+header, an elasticsearch access token, or an API key.", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3MTc5NA==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405271794", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            (string) The SAML Assertion Consumer Service URL of the service provider that will consume this SAML\n          \n          \n            \n            (Optional, string) The SAML Assertion Consumer Service URL of the service provider that will consume this SAML.\n          \n          \n            \n            If this is not set, then this API will ignore any wildcard services and will fail if `sp_entity_id` is not a directly registered Service Provider.", "author": "tvernum", "createdAt": "2020-04-08T05:48:01Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-metadata.asciidoc", "diffHunk": "@@ -0,0 +1,55 @@\n+[role=\"xpack\"]\n+[[idp-saml-metadata]]\n+=== Generate SAML metadata for the IDP\n+++++\n+<titleabbrev>Generate SAML metadata for the IDP</titleabbrev>\n+++++\n+Generates a SAML metadata document for the Identity Provider, describing its configuration and capabilities.\n+\n+[[idp-saml-metadata-request]]\n+==== {api-request-title}\n+\n+`GET /_idp/saml/metadata/{sp_entity_id}`\n+\n+[[idp-saml-metadata-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/metadata` privilege.\n+\n+[[idp-saml-metadata-desc]]\n+==== {api-description-title}\n+\n+This API generates a SAML metadata XML Document that can be consumed by a service provider in order\n+to be configured to work with this identity provider\n+\n+[[idp-saml-metadata-path-params]]\n+==== {api-path-parms-title}\n+\n+`sp_entity_id::\n+(string) The SAML entity Id of the service provider that will consume this SAML metadata document.\n+\n+`acs`::\n+(string) The SAML Assertion Consumer Service URL of the service provider that will consume this SAML", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3MjI0MA==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405272240", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `POST /_idp/saml/sp/{sp_entity_id} +\n          \n          \n            \n             PUT  /_idp/saml/sp/{sp_entity_id}`\n          \n          \n            \n            `POST /_idp/saml/sp/{sp_entity_id}` +\n          \n          \n            \n            `PUT  /_idp/saml/sp/{sp_entity_id}`", "author": "tvernum", "createdAt": "2020-04-08T05:49:10Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-register-sp.asciidoc", "diffHunk": "@@ -0,0 +1,101 @@\n+[role=\"xpack\"]\n+[[idp-saml-register-sp]]\n+=== Register or update a SAML service provider\n+++++\n+<titleabbrev>Register or update a SAML service provider</titleabbrev>\n+++++\n+Registers a SAML service provider for use with this Identity Provider or updates the configuration of an existing one.\n+\n+[[idp-saml-register-sp-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/sp/{sp_entity_id} +\n+ PUT  /_idp/saml/sp/{sp_entity_id}`", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3MzE4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405273189", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `sp_entity_id::\n          \n          \n            \n            `sp_entity_id`::", "author": "tvernum", "createdAt": "2020-04-08T05:52:13Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-register-sp.asciidoc", "diffHunk": "@@ -0,0 +1,101 @@\n+[role=\"xpack\"]\n+[[idp-saml-register-sp]]\n+=== Register or update a SAML service provider\n+++++\n+<titleabbrev>Register or update a SAML service provider</titleabbrev>\n+++++\n+Registers a SAML service provider for use with this Identity Provider or updates the configuration of an existing one.\n+\n+[[idp-saml-register-sp-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/sp/{sp_entity_id} +\n+ PUT  /_idp/saml/sp/{sp_entity_id}`\n+\n+[[idp-saml-register-sp-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/sp` privilege.\n+\n+[[idp-saml-register-desc]]\n+==== {api-description-title}\n+\n+This API registers a Service Provider with the Identity Provider and sets the necessary configuration options for that SP.\n+\n+\n+[[idp-saml-register-sp-path-params]]\n+==== {api-path-parms-title}\n+\n+`sp_entity_id::", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3MzI2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405273266", "bodyText": "This isn't required.\nIf it is not set, it will be populated from the URL parameter.\nIf it is set, it must match the URL parameter.\n\n  \n    \n      elasticsearch/x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/PutSamlServiceProviderRequest.java\n    \n    \n        Lines 36 to 43\n      in\n      8552c5e\n    \n    \n    \n    \n\n        \n          \n           if (document.entityId == null) { \n        \n\n        \n          \n               document.setEntityId(entityId); \n        \n\n        \n          \n           } else if (entityId != null) { \n        \n\n        \n          \n               if (entityId.equals(document.entityId) == false) { \n        \n\n        \n          \n                   throw new ElasticsearchParseException( \n        \n\n        \n          \n                       \"Entity id [{}] inside request body and entity id [{}] from parameter do not match\", document.entityId, entityId); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }", "author": "tvernum", "createdAt": "2020-04-08T05:52:31Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-register-sp.asciidoc", "diffHunk": "@@ -0,0 +1,101 @@\n+[role=\"xpack\"]\n+[[idp-saml-register-sp]]\n+=== Register or update a SAML service provider\n+++++\n+<titleabbrev>Register or update a SAML service provider</titleabbrev>\n+++++\n+Registers a SAML service provider for use with this Identity Provider or updates the configuration of an existing one.\n+\n+[[idp-saml-register-sp-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/sp/{sp_entity_id} +\n+ PUT  /_idp/saml/sp/{sp_entity_id}`\n+\n+[[idp-saml-register-sp-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/sp` privilege.\n+\n+[[idp-saml-register-desc]]\n+==== {api-description-title}\n+\n+This API registers a Service Provider with the Identity Provider and sets the necessary configuration options for that SP.\n+\n+\n+[[idp-saml-register-sp-path-params]]\n+==== {api-path-parms-title}\n+\n+`sp_entity_id::\n+(string) The SAML entity Id of the service provider to be registered or updated. In case the entity Id is a URL, it should be urlencoded.\n+\n+[[idp-saml-register-sp-params]]\n+==== {api-query-parms-title}\n+\n+`refresh`::\n+(Optional, string) One of `true`, `false`, or `wait_for`.\n+These values have the same meaning as in the <<docs-refresh, Index API>>,\n+but the default value for this API is `false`.\n+\n+[[idp-saml-register-sp-body]]\n+==== {api-request-body-title}\n+\n+The following parameters can be specified in the body of a POST or PUT request:\n+\n+`name`::\n+(Required, string) A name to identify this service provider. Used only for informational purposes\n+\n+`entity_id`::\n+(Required, string) The SAML entity Id of the service provider.", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3NDUzNA==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r405274534", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                }\n          \n          \n            \n                },\n          \n          \n            \n                \"params\": {\n          \n          \n            \n                  \"acs\": { ... }\n          \n          \n            \n                }", "author": "tvernum", "createdAt": "2020-04-08T05:56:11Z", "path": "x-pack/plugin/identity-provider/src/test/resources/rest-api-spec/api/idp.saml_get_metadata.json", "diffHunk": "@@ -0,0 +1,24 @@\n+{\n+  \"idp.saml_get_metadata\": {\n+    \"documentation\": {\n+      \"url\": \"https://www.elastic.co/guide/en/elasticsearch/reference/current/idp-saml-metadata.html\"\n+    },\n+    \"stability\": \"stable\",\n+    \"url\": {\n+      \"paths\": [\n+        {\n+          \"path\": \"/_idp/saml/metadata/{sp_entity_id}\",\n+          \"methods\": [\n+            \"GET\"\n+          ],\n+          \"parts\": {\n+            \"sp_entity_id\": {\n+              \"type\": \"string\",\n+              \"description\": \"The SAML entity ID of the Service Provider that will consume the metadata\"\n+            }\n+          }\n+        }\n+      ]\n+    }", "originalCommit": "8ae0bfb6b6c2f50a4f16f317ee703d7ea4f75d9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ff35089bef5e87dcc48a8f3b3c6228cd7439e13c", "url": "https://github.com/elastic/elasticsearch/commit/ff35089bef5e87dcc48a8f3b3c6228cd7439e13c", "message": "Apply suggestions from code review\n\nCo-Authored-By: Tim Vernum <tim@adjective.org>", "committedDate": "2020-04-08T13:00:32Z", "type": "commit"}, {"oid": "1103e58a3e850168fc43739e6d82310950961651", "url": "https://github.com/elastic/elasticsearch/commit/1103e58a3e850168fc43739e6d82310950961651", "message": "address feedback", "committedDate": "2020-04-08T13:04:08Z", "type": "commit"}, {"oid": "850658243bc5c3a5488029a34dbaaba2550955f6", "url": "https://github.com/elastic/elasticsearch/commit/850658243bc5c3a5488029a34dbaaba2550955f6", "message": "Merge remote-tracking branch 'origin/master' into rest-spec-idp-master", "committedDate": "2020-04-08T13:04:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0OTYwNA==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r406049604", "bodyText": "From my experimentations, I got 403s when I tried to hit this endpoint with a user that doesn't have access to the resource, and 401s when the es-secondary-authorization is wrong.\nEDIT: and I also wasn't able to to get the 403 to show up when using basic auth..", "author": "lloydmeta", "createdAt": "2020-04-09T08:43:24Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-init.asciidoc", "diffHunk": "@@ -0,0 +1,123 @@\n+[role=\"xpack\"]\n+[[idp-saml-init]]\n+=== Generate a SAML authentication response message\n+++++\n+<titleabbrev>Generate SAML response</titleabbrev>\n+++++\n+Generates a SAML Response message to be sent to a Service Provider\n+\n+[[idp-saml-init-request]]\n+==== {api-request-title}\n+\n+`POST /_idp/saml/init`\n+\n+[[idp-saml-init-prereqs]]\n+==== {api-prereq-title}\n+\n+* To use this API, you must have a role that grants the `cluster:admin/idp/saml/init` privilege.\n+\n+[[idp-saml-init-desc]]\n+==== {api-description-title}\n+\n+This API generates a SAML Response message that should be sent to a Service Provider as part of an\n+IDP initiated or SP initiated SAML Single Sign On. This API expects the caller to present\n+credentials for the user that the SAML Response will be created for as \"Secondary Authentication\"\n+using the `es-secondary-authorization` HTTP Request header.\n+\n+The SAML response is returned as a String that contains an XML document. The caller of the API is responsible to instruct\n+the end user's browser to make an HTTP Post request to the Service Provider with the SAML response\n+Base64 encoded.\n+\n+[[idp-saml-init-body]]\n+==== {api-request-body-title}\n+\n+The following parameters can be specified in the body of a POST request:\n+\n+`entity_id`::\n+(Required, string) The SAML entity Id of the service provider that will be the recipient of the SAML Response.\n+\n+`acs`::\n+(Required, string) The assertion consumer service URL of the service provider that will be the recipient of the SAML Response.\n+\n+`authn_state`::\n+(Optional, object) The JSON structure that <<idp-saml-validate>> returns. This should only be\n+provided when calling this API as part of an SP initiated Single Sign On.\n+\n+\n+[[idp-saml-init-example]]\n+==== {api-examples-title}\n+\n+The following example generates a SAML Response for an IDP initiated SAML Single Sign On to the Service Provider with entity Id\n+`https://sp1.kibana.org` and an assertion consumer service URL that is `https://sp1.kibana.org/saml/acs`\n+\n+[source, sh]\n+--------------------------------------------------------------------\n+curl -u idp_admin:idp_admin_pwd <1> \\\n+  -H 'Content-Type: application/json' \\\n+-H 'es-secondary-authorization: ApiKey dVhmUDBuQUJERWhZWEZaQVg5S0k6WUJubmZwNEtRZ1d4cGRxdXBzZmFDUQ==' <2> \\\n+localhost:9200/_idp/saml/init -d '{\"entity_id\":\"https://sp1.kibana.org\",\"acs\":\"https://sp1.kibana.org/saml/acs\"}'\n+--------------------------------------------------------------------\n+// NOTCONSOLE\n+<1> The credentials of the user that has the necessary privileges to call this API\n+<2> The credentials of the end user for which the SAML Response will be generated. These can be in the form of a Basic authentication\n+header, an {es} access token, or an API key.\n+\n+\n+The following example generates a SAML Response for an SP initiated SAML Single Sign On to the Service Provider with entity Id\n+`https://sp1.kibana.org` that would have originally sent an authentication request and which has been validated with the\n+use of <<idp-saml-validate>>\n+\n+[source, sh]\n+--------------------------------------------------------------------\n+curl -u idp_admin:idp_admin_pwd <1> -H 'Content-Type: application/json' \\\n+-H 'es-secondary-authorization: ApiKey dVhmUDBuQUJERWhZWEZaQVg5S0k6WUJubmZwNEtRZ1d4cGRxdXBzZmFDUQ==' <2>\\\n+localhost:9200/_idp/saml/init -d '{\"entity_id\":\"https://sp1.kibana.org\",\"acs\":\"https://sp1.kibana.org/saml/acs\",\n+\"authn_state\":{\"authn_request_id\":\"_3243243243fdwfsd34r2f32f23\",\"nameid_format\":\"urn:oasis:names:tc:SAML:2.0:nameid-format:transient\"}<3>}'\n+--------------------------------------------------------------------\n+// NOTCONSOLE\n+<1> The credentials of the user that has the necessary privileges to call this API\n+<2> The credentials of the end user for which the SAML Response will be generated. These can be in the form of a Basic authentication\n+header, an elasticsearch access token, or an API key.\n+<3> The `authn_state` JSON structure as it was returned by <<idp-saml-validate>>\n+\n+\n+A successful call returns the SAML Response as an XML String, the URL to post this SAML Response to, and information about the Service\n+Provider that should receive this SAML Response.\n+\n+[source, console-result]\n+--------------------------------------------------------------------\n+{\n+  \"post_url\" : \"https://sp1.kibana.org/saml/acs\",\n+  \"saml_response\" : \"<?xml version=\"1.0\" encoding=\"UTF-8\"?><saml2p:Response xmlns:saml2p=\"urn:oasis:names:tc:SAML:2.0:protocol\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" Destination=\"https://sp.some.org/api/security/v1/saml\" ID=\"_845fbfc9f3254162ce1e161c91b07d85311d65cd\" IssueInstant=\"2020-03-19T15:45:00.158Z\" ...removed for brevity ... </saml2p:Response>\",\n+  \"saml_status\" : \"urn:oasis:names:tc:SAML:2.0:status:Success\",\n+  \"error\" : null,\n+  \"service_provider\" : {\n+    \"entity_id\" : \"https://sp1.kibana.org\"\n+  }\n+}\n+--------------------------------------------------------------------\n+// TESTRESPONSE[skip:Do not enable identity provider for the docs cluster, at least not yet]\n+\n+A failed call, in the case of an SP initiated SSO returns a SAML Response as an XML String with its status set to the appropriate error\n+code indicating that the authentication request failed and the reason for that failure. A `saml_status` of\n+`urn:oasis:names:tc:SAML:2.0:status:Requester` indicates that the error is on the side of the SP or the user, while a `saml_status` of\n+`urn:oasis:names:tc:SAML:2.0:status:Responder` indicates that something went wrong in the IDP side. The `error` field contains a short\n+human friendly interpretation of the error that is outside the SAML standard and is meant to be communicated to the user, especially\n+if the user is not  redirected back the SP with the `saml_response`\n+\n+[source, console-result]\n+--------------------------------------------------------------------\n+{\n+  \"post_url\" : \"https://sp1.kibana.org/saml/acs\",\n+  \"saml_response\" : \"?xml version=\"1.0\" encoding=\"UTF-8\"?><saml2p:Response xmlns:saml2p=\"urn:oasis:names:tc:SAML:2.0:protocol\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" Destination=\"https://sp1.kibana.org/api/saml/acs\" ID=\"_845fbfc9f3254162ce1e161c91b07d85311d65cd\" IssueInstant=\"2020-03-19T15:45:00.158Z\" Version=\"2.0\"><saml2:Issuer xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\">https://idp.cloud.elastic.co</saml2:Issuer><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">...removed for brevity...</ds:Signature><saml2p:Status><saml2p:StatusCode Value=\"urn:oasis:names:tc:SAML:2.0:status:Requester\"><samlp:StatusCode xmlns:saml2p=\"urn:oasis:names:tc:SAML:2.0:protocol\" Value=\"urn:oasis:names:tc:SAML:2.0:status:InvalidNameIDPolicy\"/></saml2p:StatusCode></saml2p:Status></saml2p:Response>\",\n+  \"saml_status\" : \"urn:oasis:names:tc:SAML:2.0:status:Requester\",\n+  \"error\" : \"User [user1] is not permitted to access service [https://sp1.kibana.org]\",\n+  \"service_provider\" : {\n+    \"entity_id\" : \"https://sp1.kibana.org\"\n+  }\n+}\n+--------------------------------------------------------------------\n+// TESTRESPONSE[skip:Do not enable identity provider for the docs cluster, at least not yet]\n+\n+A failed call, in the case of an IDP initiated SSO returns an error with the appropriate HTTP Status code. i.e. if the value of the\n+`es-secondary-authorization` is wrong, the IDP will respond with `403`", "originalCommit": "850658243bc5c3a5488029a34dbaaba2550955f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA2MDIyNg==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r406060226", "bodyText": "I got 403s when I tried to hit this endpoint with a user that doesn't have access to the resource, and 401s when the es-secondary-authorization is wrong.\n\nYes, 403 is a typo in the original description, it should be 401. 403 is normal/expected when hitting any ES endpoint with a user that is not authorized to do so , thus not sure we will explicitly call this out in this API docs.\n\nEDIT: and I also wasn't able to to get the 403 to show up when using basic auth..\n\nNot sure what you mean here. Basic auth for Authorization header or for es-secondary-authorization ? And you were trying to get this for a reason, or because the description was wrong and you expected to get a 403 ?", "author": "jkakavas", "createdAt": "2020-04-09T09:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0OTYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA2MjQ2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r406062466", "bodyText": "Ah, if 403 is not supposed to be called out in this API, then we can leave it.\nIn any case, my issue was regarding discrepancy I saw: which is that when I was using basic es-secondary-authorization, I didn't get a 403 when using this endpoint to access a resource the user didn't have access to, but I did when I used ApiKey es-secondary-authorization auth.\nEDIT: I should mention that this is no big deal for the Cloud integration since we don't support basic auth anyways.", "author": "lloydmeta", "createdAt": "2020-04-09T09:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0OTYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI3NTM2OA==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r407275368", "bodyText": "Just following up: this was expected behaviour and had nothing to do with ApiKey vs Basic Auth. It was a per-design difference between Sp-initiated vs IdP initiated flow.", "author": "lloydmeta", "createdAt": "2020-04-13T00:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0OTYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI5MjQ3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r409292475", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If set, it musth match the value that is passed in the URL parameter.\n          \n          \n            \n            If set, it must match the value that is passed in the URL parameter.", "author": "tvernum", "createdAt": "2020-04-16T05:34:54Z", "path": "x-pack/plugin/identity-provider/docs/en/rest-api/idp-saml-register-sp.asciidoc", "diffHunk": "@@ -46,7 +46,8 @@ The following parameters can be specified in the body of a POST or PUT request:\n (Required, string) A name to identify this service provider. Used only for informational purposes\n \n `entity_id`::\n-(Required, string) The SAML entity Id of the service provider.\n+(Optional, string) The SAML entity Id of the service provider. If not set, it will be populated with the value from the URL parameter.\n+If set, it musth match the value that is passed in the URL parameter.", "originalCommit": "850658243bc5c3a5488029a34dbaaba2550955f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI5Mjg3NA==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r409292874", "bodyText": "My use of ... was just a placeholder - I think this should be populated with something meaningful.", "author": "tvernum", "createdAt": "2020-04-16T05:36:06Z", "path": "x-pack/plugin/identity-provider/src/test/resources/rest-api-spec/api/idp.saml_get_metadata.json", "diffHunk": "@@ -19,6 +19,9 @@\n           }\n         }\n       ]\n+    },\n+    \"params\": {\n+      \"acs\": { ... }", "originalCommit": "850658243bc5c3a5488029a34dbaaba2550955f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwMTAyNA==", "url": "https://github.com/elastic/elasticsearch/pull/54664#discussion_r409301024", "bodyText": "Meh , I did a two step process of 1) all the suggestions make sense and later 2) lets merge these and forgot to take care of this . Will adjust", "author": "jkakavas", "createdAt": "2020-04-16T06:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI5Mjg3NA=="}], "type": "inlineReview"}, {"oid": "3216f316c362fd54b22b979a333c3644deac7c85", "url": "https://github.com/elastic/elasticsearch/commit/3216f316c362fd54b22b979a333c3644deac7c85", "message": "Address feedback", "committedDate": "2020-04-16T08:53:38Z", "type": "commit"}, {"oid": "465ef8f67fc4316059da301649db52896cde07ad", "url": "https://github.com/elastic/elasticsearch/commit/465ef8f67fc4316059da301649db52896cde07ad", "message": "Merge branch 'master' into rest-spec-idp-master", "committedDate": "2020-04-16T09:10:45Z", "type": "commit"}]}