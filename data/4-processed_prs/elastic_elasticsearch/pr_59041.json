{"pr_number": 59041, "pr_title": "Ensure authz role for API key is named after owner role", "pr_createdAt": "2020-07-05T16:27:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59041", "timeline": [{"oid": "2d5bb1e176e1cc14805ee4231963dcff386b0071", "url": "https://github.com/elastic/elasticsearch/commit/2d5bb1e176e1cc14805ee4231963dcff386b0071", "message": "WIP", "committedDate": "2020-07-05T15:24:07Z", "type": "commit"}, {"oid": "a2b3655eb323619a2d942d7979840c54e0731e8e", "url": "https://github.com/elastic/elasticsearch/commit/a2b3655eb323619a2d942d7979840c54e0731e8e", "message": "WIP", "committedDate": "2020-07-05T15:39:49Z", "type": "commit"}, {"oid": "a867338ef7caeea6584fae070e5d6c0a7395851e", "url": "https://github.com/elastic/elasticsearch/commit/a867338ef7caeea6584fae070e5d6c0a7395851e", "message": "WIP", "committedDate": "2020-07-05T15:52:42Z", "type": "commit"}, {"oid": "6f3df69f6a5f0e8fdfbfe8bfee6304f9b9ebf1ba", "url": "https://github.com/elastic/elasticsearch/commit/6f3df69f6a5f0e8fdfbfe8bfee6304f9b9ebf1ba", "message": "Done", "committedDate": "2020-07-05T16:13:44Z", "type": "commit"}, {"oid": "1435148b5281173032e054f4cb9817f189a7a7e1", "url": "https://github.com/elastic/elasticsearch/commit/1435148b5281173032e054f4cb9817f189a7a7e1", "message": "Checkstyle", "committedDate": "2020-07-05T16:42:10Z", "type": "commit"}, {"oid": "58e325d8dd9dc1eddeed57a85785301dfb15883d", "url": "https://github.com/elastic/elasticsearch/commit/58e325d8dd9dc1eddeed57a85785301dfb15883d", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn", "committedDate": "2020-07-05T17:04:52Z", "type": "commit"}, {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae", "url": "https://github.com/elastic/elasticsearch/commit/b21a79778ec9484c02e882c67e46bcb732721bae", "message": "Bug", "committedDate": "2020-07-05T18:39:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3ODY0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r449978647", "bodyText": "Gosh! Is this a bug!?", "author": "ywangd", "createdAt": "2020-07-06T04:33:08Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/permission/LimitedRole.java", "diffHunk": "@@ -86,7 +81,7 @@ public IndicesAccessControl authorize(String action, Set<String> requestedIndice\n     @Override\n     public Automaton allowedActionsMatcher(String index) {\n         final Automaton allowedMatcher = super.allowedActionsMatcher(index);\n-        final Automaton limitedByMatcher = super.allowedActionsMatcher(index);\n+        final Automaton limitedByMatcher = limitedBy.allowedActionsMatcher(index);", "originalCommit": "b21a79778ec9484c02e882c67e46bcb732721bae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5NDE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r449994169", "bodyText": "Yes. At first sight testing for it was not trivial. The bug doesn't seem important though. I'll see what I can do.", "author": "albertzaharovits", "createdAt": "2020-07-06T05:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3ODY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE3MDMyOA==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r450170328", "bodyText": "I've pushed a simple unit test 9738963, it is trivial after all.\nThe bug is not consequential. It could manifest when resizing and when adding aliases, when using keys with role descriptors, where it fails to allow the operation, although it should.", "author": "albertzaharovits", "createdAt": "2020-07-06T11:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3ODY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3OTY3OA==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r449979678", "bodyText": "I understand fromRole.names() is close to non-sense. But I wonder whether it is marginally justifiable to still keep them around just in case? I can be easily persuaded. :)", "author": "ywangd", "createdAt": "2020-07-06T04:37:44Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/permission/LimitedRole.java", "diffHunk": "@@ -187,7 +182,6 @@ public boolean checkRunAs(String runAs) {\n      */\n     public static LimitedRole createLimitedRole(Role fromRole, Role limitedByRole) {\n         Objects.requireNonNull(limitedByRole, \"limited by role is required to create limited role\");\n-        return new LimitedRole(fromRole.names(), fromRole.cluster(), fromRole.indices(), fromRole.application(), fromRole.runAs(),\n-                limitedByRole);\n+        return new LimitedRole(fromRole.cluster(), fromRole.indices(), fromRole.application(), fromRole.runAs(), limitedByRole);", "originalCommit": "b21a79778ec9484c02e882c67e46bcb732721bae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5NDQ1NA==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r449994454", "bodyText": "I wouldn't clutter the code in any way for it. When/if we need that we can make the change.", "author": "albertzaharovits", "createdAt": "2020-07-06T05:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3OTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxODM5MA==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r450018390", "bodyText": "Ok sounds good as long as you do have an argument for it. Thanks!", "author": "ywangd", "createdAt": "2020-07-06T06:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3OTY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMDIyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r450020221", "bodyText": "Something doesn't feel quite right about this.\nLet's chat, but I'd prefer a public static method on the ApiKeyService (like createKeyForTesting) rather than making existing methods public.", "author": "tvernum", "createdAt": "2020-07-06T07:00:10Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/test/SecurityTestsUtils.java", "diffHunk": "@@ -65,6 +83,17 @@ public static void assertThrowsAuthorizationException(LuceneTestCase.ThrowingRun\n         assertAuthorizationException(securityException, messageMatcher);\n     }\n \n+    public static Authentication createApiKeyAuthentication(ApiKeyService apiKeyService, Authentication authentication,", "originalCommit": "b21a79778ec9484c02e882c67e46bcb732721bae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEyNjIyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r450126229", "bodyText": "Yeah, I've been ignorant to break the ApiKeyService abstraction for test purposes.\nI've created a public static inner class ApiKeyServiceTests.Utils that translates an authentication for a user to an authentication with an API Key.", "author": "albertzaharovits", "createdAt": "2020-07-06T10:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMDIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMDUzMA==", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r450020530", "bodyText": "++", "author": "tvernum", "createdAt": "2020-07-06T07:00:54Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -346,10 +346,9 @@ private void authenticateAsync() {\n         private void checkForApiKey() {\n             apiKeyService.authenticateWithApiKeyIfPresent(threadContext, ActionListener.wrap(authResult -> {\n                     if (authResult.isAuthenticated()) {\n-                        final User user = authResult.getUser();\n-                        authenticatedBy = new RealmRef(ApiKeyService.API_KEY_REALM_NAME, ApiKeyService.API_KEY_REALM_TYPE, nodeName);\n-                        writeAuthToContext(new Authentication(user, authenticatedBy, null, Version.CURRENT,\n-                            Authentication.AuthenticationType.API_KEY, authResult.getMetadata()));\n+                        final Authentication authentication = apiKeyService.createApiKeyAuthentication(authResult, nodeName);", "originalCommit": "b21a79778ec9484c02e882c67e46bcb732721bae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "103609e65edfdf8fc48830bfdccc96addf4350e8", "url": "https://github.com/elastic/elasticsearch/commit/103609e65edfdf8fc48830bfdccc96addf4350e8", "message": "Review", "committedDate": "2020-07-06T09:58:15Z", "type": "commit"}, {"oid": "7fb790f230fe32017b0e5cb9e9c43404b5bad354", "url": "https://github.com/elastic/elasticsearch/commit/7fb790f230fe32017b0e5cb9e9c43404b5bad354", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn", "committedDate": "2020-07-06T10:07:45Z", "type": "commit"}, {"oid": "ff712c93fe875bda345470c4f6d0fedbf52dc544", "url": "https://github.com/elastic/elasticsearch/commit/ff712c93fe875bda345470c4f6d0fedbf52dc544", "message": "Checkstyle", "committedDate": "2020-07-06T10:52:26Z", "type": "commit"}, {"oid": "973896352f00623f0383ea15977970ff1494692b", "url": "https://github.com/elastic/elasticsearch/commit/973896352f00623f0383ea15977970ff1494692b", "message": "Allowed actions matcher test", "committedDate": "2020-07-06T11:50:54Z", "type": "commit"}, {"oid": "0f2c6bfaeb4a34554bffb5336f851d2f976a46a4", "url": "https://github.com/elastic/elasticsearch/commit/0f2c6bfaeb4a34554bffb5336f851d2f976a46a4", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn", "committedDate": "2020-07-06T12:26:58Z", "type": "commit"}, {"oid": "5f44deca973749212fde9ad8f587820fcf5fce50", "url": "https://github.com/elastic/elasticsearch/commit/5f44deca973749212fde9ad8f587820fcf5fce50", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn", "committedDate": "2020-07-07T09:26:57Z", "type": "commit"}]}