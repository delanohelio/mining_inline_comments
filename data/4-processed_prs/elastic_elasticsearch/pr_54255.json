{"pr_number": 54255, "pr_title": "Do not fail Evaluate API when the actual and predicted fields' types differ", "pr_createdAt": "2020-03-26T09:29:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54255", "timeline": [{"oid": "a853e829b29bce3dabc25e4673b5d9f477bb348a", "url": "https://github.com/elastic/elasticsearch/commit/a853e829b29bce3dabc25e4673b5d9f477bb348a", "message": "Do not fail Evaluate API when the actual and predicted fields' types differ", "committedDate": "2020-03-26T09:37:23Z", "type": "commit"}, {"oid": "a853e829b29bce3dabc25e4673b5d9f477bb348a", "url": "https://github.com/elastic/elasticsearch/commit/a853e829b29bce3dabc25e4673b5d9f477bb348a", "message": "Do not fail Evaluate API when the actual and predicted fields' types differ", "committedDate": "2020-03-26T09:37:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTA5NA==", "url": "https://github.com/elastic/elasticsearch/pull/54255#discussion_r398501094", "bodyText": "This will analyze the input string. Which might be ok, but it will mean if we have classNames Foo and foo we will treat them as the same.\nWhich, having two classes only differ by case is pathological and probably SHOULD result in error :)", "author": "benwtrent", "createdAt": "2020-03-26T11:30:14Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/evaluation/classification/MulticlassConfusionMatrix.java", "diffHunk": "@@ -142,7 +142,7 @@ public int getSize() {\n         if (result.get() == null) {  // These are steps 2, 3, 4 etc.\n             KeyedFilter[] keyedFiltersPredicted =\n                 topActualClassNames.get().stream()\n-                    .map(className -> new KeyedFilter(className, QueryBuilders.termQuery(predictedField, className)))\n+                    .map(className -> new KeyedFilter(className, QueryBuilders.matchQuery(predictedField, className).lenient(true)))", "originalCommit": "a853e829b29bce3dabc25e4673b5d9f477bb348a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzQxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/54255#discussion_r398633415", "bodyText": "This will analyze the input string. Which might be ok, but it will mean if we have classNames Foo and foo we will treat them as the same.\n\nI added a test testEvaluate_AllMetrics_KeywordField_CaseSensitivity to verify that and it turns out casing is sensitive, i.e. \"crocodile\" does not match \"cRoCoDiLe\". This is because dependent variable can be of type keyword but not of type text.\nI think comparing class labels in a case-sensitive manner is ok as long as we document it clearly. LMK if you think otherwise.\n\nWhich, having two classes only differ by case is pathological and probably SHOULD result in error :)\n\nMaybe or maybe not. E.g.: I could think of some scientific experiment results in which there would be class names named \"a\", \"b\", \"c\", \"A\", \"B\", \"C\" where \"a\" and \"A\" mean different things. I'm open to suggestions here as I don't have a strong opinion on that.", "author": "przemekwitek", "createdAt": "2020-03-26T14:50:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2OTIwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54255#discussion_r398669200", "bodyText": "WOOT! Ok, I did not think of the keyword mapping. Indeed, those are not analyzed. Scratch my previous concern.", "author": "benwtrent", "createdAt": "2020-03-26T15:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTA5NA=="}], "type": "inlineReview"}, {"oid": "e5fa51e75a119b8b265319088343bd72a9a04d80", "url": "https://github.com/elastic/elasticsearch/commit/e5fa51e75a119b8b265319088343bd72a9a04d80", "message": "Add a test for case sensivity in case of keyword fields", "committedDate": "2020-03-26T14:44:22Z", "type": "commit"}]}