{"pr_number": 65243, "pr_title": "Move security manager codebases files to plugin-metadata", "pr_createdAt": "2020-11-18T23:44:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65243", "timeline": [{"oid": "027a8ee37fe3d317b2c4aa0555f2cdd7f16cc981", "url": "https://github.com/elastic/elasticsearch/commit/027a8ee37fe3d317b2c4aa0555f2cdd7f16cc981", "message": "Move security manager codebases files to plugin-metadata\n\nThe codebases files are hints that allow the test framework to map\ncodebase names required by plugin security policy files to urls that may\nexist as classes directories on disk. These files end up in the same\ntest resources directory in gradle, but in eclipse they exist in\ndifferent directories. This commit reorganizes the files so they exist\nwithin the same plugin-metadata source, thereby existing in the same\noutput directory used by tests. Finally, the codebases files are\nfiltered out of the final jar within the plugin build.", "committedDate": "2020-11-18T23:43:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxNTU0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65243#discussion_r526515548", "bodyText": "Is this intellij policy actaully specific to intellij or should we rename to \"ide\" or similar?", "author": "mark-vieira", "createdAt": "2020-11-19T00:38:20Z", "path": "test/framework/src/main/java/org/elasticsearch/bootstrap/BootstrapForTesting.java", "diffHunk": "@@ -146,10 +146,8 @@\n                 final Policy runnerPolicy;\n                 if (System.getProperty(\"tests.gradle\") != null) {\n                     runnerPolicy = PolicyUtil.readPolicy(Bootstrap.class.getResource(\"gradle.policy\"), codebases);\n-                } else if (codebases.containsKey(\"junit-rt.jar\")) {\n-                    runnerPolicy = PolicyUtil.readPolicy(Bootstrap.class.getResource(\"intellij.policy\"), codebases);\n                 } else {\n-                    runnerPolicy = PolicyUtil.readPolicy(Bootstrap.class.getResource(\"eclipse.policy\"), codebases);\n+                    runnerPolicy = PolicyUtil.readPolicy(Bootstrap.class.getResource(\"intellij.policy\"), codebases);", "originalCommit": "027a8ee37fe3d317b2c4aa0555f2cdd7f16cc981", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxNzk1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65243#discussion_r526517953", "bodyText": "Oops, this was completely unintentional.", "author": "rjernst", "createdAt": "2020-11-19T00:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxNTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxNzAzOA==", "url": "https://github.com/elastic/elasticsearch/pull/65243#discussion_r526517038", "bodyText": "Rather than do this why don't we just define pluginMetadata up top as the individual file isntead of the entire `plugin-metadata?\nAlso, is there any use case for throwing other stuff in that location? Could external plugin authors being doing this, therefore this be a breaking change? Would it be better to explicitly exclude the codebases file?", "author": "mark-vieira", "createdAt": "2020-11-19T00:42:39Z", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -204,7 +204,11 @@ class PluginBuildPlugin implements Plugin<Project> {\n         // create the actual bundle task, which zips up all the files for the plugin\n         TaskProvider<Zip> bundle = project.tasks.register('bundlePlugin', Zip) {\n             from buildProperties\n-            from pluginMetadata // metadata (eg custom security policy)\n+            from(pluginMetadata) {", "originalCommit": "027a8ee37fe3d317b2c4aa0555f2cdd7f16cc981", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxOTk2NA==", "url": "https://github.com/elastic/elasticsearch/pull/65243#discussion_r526519964", "bodyText": "We need the pluginMetadata above to still contain everything, which is the policy file and the codebases file, because that is what goes into the test resources dir. We really just want to remove the file when building the jar, which is what we do here.\nIn theory external plugin authors could add other stuff to the plugin metadata. I could flip this so that it is an exclude of the codebases file. However, there are other ways plugin authors could add files to the root of their plugin zip, so I think it's ok this convention is our own, and not general purpose.", "author": "rjernst", "createdAt": "2020-11-19T00:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxNzAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMzA2NA==", "url": "https://github.com/elastic/elasticsearch/pull/65243#discussion_r526523064", "bodyText": "Right, I think you misread the first part of my comment though. If indeed we just want to add only the plugin-security.policy file to the jar, why not simplify it to File pluginMetadata = project.file('src/main/plugin-metadata/plugin-security.policy') and call it a day rather than say \"copy this directory, but filter everything but this one file\".", "author": "mark-vieira", "createdAt": "2020-11-19T01:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxNzAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyNzIyMg==", "url": "https://github.com/elastic/elasticsearch/pull/65243#discussion_r526527222", "bodyText": "That is fair. I'd rather make that decision whether we should only copy the policy file separately, so for now I've flipped the logic to exclude the codebases file.", "author": "rjernst", "createdAt": "2020-11-19T01:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxNzAzOA=="}], "type": "inlineReview"}, {"oid": "550ce05f801a42bd33170f053a80937682c3b9bb", "url": "https://github.com/elastic/elasticsearch/commit/550ce05f801a42bd33170f053a80937682c3b9bb", "message": "restore", "committedDate": "2020-11-19T00:47:24Z", "type": "commit"}, {"oid": "7d648cd0ab9e4540e3a4cff12609d7ccf80574c5", "url": "https://github.com/elastic/elasticsearch/commit/7d648cd0ab9e4540e3a4cff12609d7ccf80574c5", "message": "Flip to exclusion of the codebases file", "committedDate": "2020-11-19T01:09:57Z", "type": "commit"}]}