{"pr_number": 56745, "pr_title": "Implement aggregations on aggregate metric fields", "pr_createdAt": "2020-05-14T08:49:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56745", "timeline": [{"oid": "7b64d83b440484aedf9d755c365dd1c3f7138477", "url": "https://github.com/elastic/elasticsearch/commit/7b64d83b440484aedf9d755c365dd1c3f7138477", "message": "Implement aggregate_metric field mapper (#49830)\n\nImplemented aggregate_metric field type for storing pre-computed aggregates", "committedDate": "2020-03-31T10:16:25Z", "type": "commit"}, {"oid": "098cf0f06bcb4fdefe35113a61fe4678a134db87", "url": "https://github.com/elastic/elasticsearch/commit/098cf0f06bcb4fdefe35113a61fe4678a134db87", "message": "Merge branch 'feature/aggregate-metrics' of github.com:elastic/elasticsearch into feature/aggregate-metrics", "committedDate": "2020-03-31T10:17:10Z", "type": "commit"}, {"oid": "3e273404f140aa20fcf7dfe226eddaef85e329a4", "url": "https://github.com/elastic/elasticsearch/commit/3e273404f140aa20fcf7dfe226eddaef85e329a4", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-04-07T14:49:46Z", "type": "commit"}, {"oid": "b37972564effc9972e27f2e1f599f4b55f8c2e22", "url": "https://github.com/elastic/elasticsearch/commit/b37972564effc9972e27f2e1f599f4b55f8c2e22", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-04-14T06:44:08Z", "type": "commit"}, {"oid": "7e277798dc51246a8a775920628d5b8738e1c8c5", "url": "https://github.com/elastic/elasticsearch/commit/7e277798dc51246a8a775920628d5b8738e1c8c5", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-04-21T12:04:57Z", "type": "commit"}, {"oid": "e0d355d4088f3336940b6b7558d9c75d9228c050", "url": "https://github.com/elastic/elasticsearch/commit/e0d355d4088f3336940b6b7558d9c75d9228c050", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-04-27T12:02:44Z", "type": "commit"}, {"oid": "f684601147d7bc9c00e9f5f6ca6991f5a0d5ada1", "url": "https://github.com/elastic/elasticsearch/commit/f684601147d7bc9c00e9f5f6ca6991f5a0d5ada1", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-04-28T08:46:23Z", "type": "commit"}, {"oid": "5e0c2cc11189ce4730439ce244f709a70c52198c", "url": "https://github.com/elastic/elasticsearch/commit/5e0c2cc11189ce4730439ce244f709a70c52198c", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-05-12T12:12:51Z", "type": "commit"}, {"oid": "1bc3f7585142cee7734d8b3e1d89a9aa84c21852", "url": "https://github.com/elastic/elasticsearch/commit/1bc3f7585142cee7734d8b3e1d89a9aa84c21852", "message": "Merge with master - fixes", "committedDate": "2020-05-12T12:41:34Z", "type": "commit"}, {"oid": "9b77f773c019a0c3408b41d375f41d57070a0241", "url": "https://github.com/elastic/elasticsearch/commit/9b77f773c019a0c3408b41d375f41d57070a0241", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-05-13T15:16:31Z", "type": "commit"}, {"oid": "046118cbe35bd5e3d14647d162075d12af30e350", "url": "https://github.com/elastic/elasticsearch/commit/046118cbe35bd5e3d14647d162075d12af30e350", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-05-14T06:46:54Z", "type": "commit"}, {"oid": "d89f9f32f0aa45ed48255853eaa8196bed97e562", "url": "https://github.com/elastic/elasticsearch/commit/d89f9f32f0aa45ed48255853eaa8196bed97e562", "message": "Implement aggregations on aggregate metrics (#53986)\n\nFollowing the implementation of the aggregate_metric_double field mapper(#49830) we are implementing the Min, Max, ValueCount, Sum and Average aggregations on aggregate metrics.\r\n\r\nThe code builds on the excellent work done for #42949 and uses the extensible ValuesSources infrastructure to wire up common metric aggregation on the aggregate_metric_double field type.\r\n\r\nThis PR is part of the rollups v2 refactoring as described in meta issue #42720", "committedDate": "2020-05-14T08:44:40Z", "type": "commit"}, {"oid": "344f0133e16b064a301d6a4beab97d771d69a412", "url": "https://github.com/elastic/elasticsearch/commit/344f0133e16b064a301d6a4beab97d771d69a412", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-05-14T14:13:53Z", "type": "commit"}, {"oid": "772112537115716c8daba3c4663f7b678b9cfcda", "url": "https://github.com/elastic/elasticsearch/commit/772112537115716c8daba3c4663f7b678b9cfcda", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-06-18T16:27:40Z", "type": "commit"}, {"oid": "da07deb90734d12dec9c7a0e0d50579af77acd5f", "url": "https://github.com/elastic/elasticsearch/commit/da07deb90734d12dec9c7a0e0d50579af77acd5f", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-06-23T10:59:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5MzEwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56745#discussion_r444293105", "bodyText": "Just a heads up - I changed MetricAggregatorSupplier to take a ValuesSourceConfig here instead of separate ValuesSource and DocValuesFormat args.  I've cleaned up VSConfig so it can be used as an actual config object rather than having to pick it apart in the factories.", "author": "not-napoleon", "createdAt": "2020-06-23T15:00:29Z", "path": "x-pack/plugin/mapper-aggregate-metric/src/main/java/org/elasticsearch/xpack/aggregatemetric/aggregations/metrics/AggregateMetricsAggregatorsRegistrar.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.aggregatemetric.aggregations.metrics;\n+\n+import org.elasticsearch.search.aggregations.metrics.AvgAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.MaxAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.MetricAggregatorSupplier;\n+import org.elasticsearch.search.aggregations.metrics.MinAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.MinMaxAggregatorSupplier;\n+import org.elasticsearch.search.aggregations.metrics.SumAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.ValueCountAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.ValueCountAggregatorSupplier;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceRegistry;\n+import org.elasticsearch.xpack.aggregatemetric.aggregations.support.AggregateMetricsValuesSource;\n+import org.elasticsearch.xpack.aggregatemetric.aggregations.support.AggregateMetricsValuesSourceType;\n+\n+/**\n+ * Utility class providing static methods to register aggregators for the aggregate_metric values source\n+ */\n+public class AggregateMetricsAggregatorsRegistrar {\n+\n+    public static void registerSumAggregator(ValuesSourceRegistry.Builder builder) {\n+        builder.register(\n+            SumAggregationBuilder.NAME,\n+            AggregateMetricsValuesSourceType.AGGREGATE_METRIC,\n+            (MetricAggregatorSupplier) (name, valuesSource, formatter, context, parent, metadata) -> new AggregateMetricBackedSumAggregator(\n+                name,\n+                (AggregateMetricsValuesSource.AggregateDoubleMetric) valuesSource,\n+                formatter,", "originalCommit": "da07deb90734d12dec9c7a0e0d50579af77acd5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyNDM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56745#discussion_r444324341", "bodyText": "Thanks @not-napoleon. I will fix that", "author": "csoulios", "createdAt": "2020-06-23T15:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5MzEwNQ=="}], "type": "inlineReview"}, {"oid": "f0036bd659242a02e28911e4ab115eaf7444883b", "url": "https://github.com/elastic/elasticsearch/commit/f0036bd659242a02e28911e4ab115eaf7444883b", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-06-24T13:22:57Z", "type": "commit"}, {"oid": "a28665ebc40db54071aaf5bd6b87648893636769", "url": "https://github.com/elastic/elasticsearch/commit/a28665ebc40db54071aaf5bd6b87648893636769", "message": "Resolve conflicts from master", "committedDate": "2020-06-30T10:27:37Z", "type": "commit"}, {"oid": "4e14b1597b1c2e2262e3e35f85abd42d25385283", "url": "https://github.com/elastic/elasticsearch/commit/4e14b1597b1c2e2262e3e35f85abd42d25385283", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-06-30T10:29:14Z", "type": "commit"}, {"oid": "a99c84be9498b1c99a4393f5a7d58fe28c7ef799", "url": "https://github.com/elastic/elasticsearch/commit/a99c84be9498b1c99a4393f5a7d58fe28c7ef799", "message": "Fix integration tests", "committedDate": "2020-06-30T13:31:38Z", "type": "commit"}, {"oid": "750d3a6484dfda02edcdcb2d1860ea9b99ec04fd", "url": "https://github.com/elastic/elasticsearch/commit/750d3a6484dfda02edcdcb2d1860ea9b99ec04fd", "message": "Merge remote-tracking branch 'elastic/master' into feature/aggregate-metrics", "committedDate": "2020-07-07T19:48:36Z", "type": "commit"}, {"oid": "8aed7074ee34b68352e478f07e20c8fe6474606f", "url": "https://github.com/elastic/elasticsearch/commit/8aed7074ee34b68352e478f07e20c8fe6474606f", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-07-17T07:01:19Z", "type": "commit"}, {"oid": "f0c5105981ec02ab5aca9d7023a818e99a088ad7", "url": "https://github.com/elastic/elasticsearch/commit/f0c5105981ec02ab5aca9d7023a818e99a088ad7", "message": "Updated branch to fix build after merge", "committedDate": "2020-07-17T08:24:57Z", "type": "commit"}, {"oid": "cff3edf04f7861611e57db711d2412ca190dabad", "url": "https://github.com/elastic/elasticsearch/commit/cff3edf04f7861611e57db711d2412ca190dabad", "message": "Merge remote-tracking branch 'elastic/master' into feature/aggregate-metrics", "committedDate": "2020-08-05T23:21:11Z", "type": "commit"}, {"oid": "d8b2606db9c4e64ac42068c9df46b3b6fb7af313", "url": "https://github.com/elastic/elasticsearch/commit/d8b2606db9c4e64ac42068c9df46b3b6fb7af313", "message": "update code in latest merge", "committedDate": "2020-08-06T00:34:23Z", "type": "commit"}, {"oid": "1062fb505e9e074fc3992fa38030fff728f26bcd", "url": "https://github.com/elastic/elasticsearch/commit/1062fb505e9e074fc3992fa38030fff728f26bcd", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-08-20T12:42:19Z", "type": "commit"}, {"oid": "f740c038d5fde7f16b425668629248611395aede", "url": "https://github.com/elastic/elasticsearch/commit/f740c038d5fde7f16b425668629248611395aede", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-08-25T12:20:09Z", "type": "commit"}, {"oid": "b638d4699f76a8be60adf939de0cf2b3626e0c36", "url": "https://github.com/elastic/elasticsearch/commit/b638d4699f76a8be60adf939de0cf2b3626e0c36", "message": "Fix errors after merge", "committedDate": "2020-08-25T14:26:17Z", "type": "commit"}, {"oid": "c6834ce6f31533e4b9a8bbd68220edb5a752a8d2", "url": "https://github.com/elastic/elasticsearch/commit/c6834ce6f31533e4b9a8bbd68220edb5a752a8d2", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-09-21T09:37:59Z", "type": "commit"}, {"oid": "151d6080683721ade57ed9f83b3849c203af5f16", "url": "https://github.com/elastic/elasticsearch/commit/151d6080683721ade57ed9f83b3849c203af5f16", "message": "Fix errors after merge", "committedDate": "2020-09-21T09:51:22Z", "type": "commit"}, {"oid": "4e23148eb5c44a8df0dc2fde2047f609500c2300", "url": "https://github.com/elastic/elasticsearch/commit/4e23148eb5c44a8df0dc2fde2047f609500c2300", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-09-23T11:59:16Z", "type": "commit"}, {"oid": "3a4927875df5817aba6d031caedaed1b30cf8ca2", "url": "https://github.com/elastic/elasticsearch/commit/3a4927875df5817aba6d031caedaed1b30cf8ca2", "message": "Fix errors after merge", "committedDate": "2020-09-23T12:48:34Z", "type": "commit"}, {"oid": "06e9b0b3d2f80fa3960fcba15fb3ae9e3295a3da", "url": "https://github.com/elastic/elasticsearch/commit/06e9b0b3d2f80fa3960fcba15fb3ae9e3295a3da", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-10-19T13:16:11Z", "type": "commit"}, {"oid": "9eb135f9c886c05f7c6e6326a37d3474ae876521", "url": "https://github.com/elastic/elasticsearch/commit/9eb135f9c886c05f7c6e6326a37d3474ae876521", "message": "Fix errors after merge", "committedDate": "2020-10-20T09:27:51Z", "type": "commit"}, {"oid": "f0d14130143d06ce46ddbc745fcb776ce47c48c0", "url": "https://github.com/elastic/elasticsearch/commit/f0d14130143d06ce46ddbc745fcb776ce47c48c0", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-10-20T09:28:27Z", "type": "commit"}, {"oid": "f743b4c79310a8f31e075448dfda57a365994b41", "url": "https://github.com/elastic/elasticsearch/commit/f743b4c79310a8f31e075448dfda57a365994b41", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-10-21T06:50:18Z", "type": "commit"}, {"oid": "b95f8496d636713f22f23f950a438b99ccfe252a", "url": "https://github.com/elastic/elasticsearch/commit/b95f8496d636713f22f23f950a438b99ccfe252a", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-10-26T15:20:06Z", "type": "commit"}, {"oid": "26e650c8c600b8af0a1e6383b24d8cd04c1b1d7b", "url": "https://github.com/elastic/elasticsearch/commit/26e650c8c600b8af0a1e6383b24d8cd04c1b1d7b", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-10-27T10:12:32Z", "type": "commit"}, {"oid": "6b4dcabbf27678ba94157cfb48d3372492db7a62", "url": "https://github.com/elastic/elasticsearch/commit/6b4dcabbf27678ba94157cfb48d3372492db7a62", "message": "Converted aggregate_metric_double field mapper to parameterized mapper (#64172)\n\nAggregateDoubleMetricFieldMapper was originally not written as a parametrized field mapper.\r\n\r\nThis PR refactors AggregateDoubleMetricFieldMapper to extend ParametrizedFieldMapper.\r\n\r\nAlso, refactored AggregateDoubleMetricFieldMapperTests to extend MapperTestCase instead of ESSingleNodeTestCase", "committedDate": "2020-10-27T11:23:01Z", "type": "commit"}, {"oid": "dd0c42720eb8ee24590107887b5e382370532878", "url": "https://github.com/elastic/elasticsearch/commit/dd0c42720eb8ee24590107887b5e382370532878", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-10-27T17:40:11Z", "type": "commit"}, {"oid": "41aa699f1386553184813586f472670963c08a33", "url": "https://github.com/elastic/elasticsearch/commit/41aa699f1386553184813586f472670963c08a33", "message": "Fix errors after merge", "committedDate": "2020-10-27T17:47:19Z", "type": "commit"}, {"oid": "0458002f4cabb4efa2fb55ffcf86be9de9e8d650", "url": "https://github.com/elastic/elasticsearch/commit/0458002f4cabb4efa2fb55ffcf86be9de9e8d650", "message": "Merge remote-tracking branch 'elastic/master' into feature/aggregate-metrics", "committedDate": "2020-10-28T19:09:51Z", "type": "commit"}, {"oid": "745e9998b4372056dcb843f99a3f71f2964b4c9a", "url": "https://github.com/elastic/elasticsearch/commit/745e9998b4372056dcb843f99a3f71f2964b4c9a", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-11-02T16:04:57Z", "type": "commit"}, {"oid": "af15450ac2b4bc4c7efa6bfa0ebc97d469f53daa", "url": "https://github.com/elastic/elasticsearch/commit/af15450ac2b4bc4c7efa6bfa0ebc97d469f53daa", "message": "Fix errors after merge", "committedDate": "2020-11-02T16:34:54Z", "type": "commit"}, {"oid": "443856a68d53434e71d8423900cc3ea1155204c8", "url": "https://github.com/elastic/elasticsearch/commit/443856a68d53434e71d8423900cc3ea1155204c8", "message": "Merge remote-tracking branch 'elastic/master' into feature/aggregate-metrics", "committedDate": "2020-11-05T18:42:22Z", "type": "commit"}, {"oid": "2442f47a07465410c6919686adb06371abba8504", "url": "https://github.com/elastic/elasticsearch/commit/2442f47a07465410c6919686adb06371abba8504", "message": "Merge remote-tracking branch 'elastic/master' into feature/aggregate-metrics", "committedDate": "2020-11-05T23:04:41Z", "type": "commit"}, {"oid": "e0f0a36214e408a25471dc83d95bdfbe6c0c2b11", "url": "https://github.com/elastic/elasticsearch/commit/e0f0a36214e408a25471dc83d95bdfbe6c0c2b11", "message": "Hide metric sub-fields from aggregate_metric searches and add support for scripting (#64323)\n\nThis commit only adds one searchable field to the aggregate_metric\r\nfield mapper. It makes the defaultMetric value searchable under the\r\nsame field name as the aggregate_metric.\r\n\r\nThis should make aggregate_metric behave more like a numeric in\r\nmost use-cases.\r\n\r\n```\r\n{\r\n    ...\r\n    \"fields\": {\r\n        \"temperature\": {\r\n            \"aggregate_metric_double\": {\r\n                \"type\": \"aggregate_metric_double\",\r\n                \"searchable\": true,\r\n                \"aggregatable\": true\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nOther things in this PR\r\n\r\n- `default_metric` is now required and does not default to `max`\r\n- the fields API's valueFetcher for `aggregate_metric_double` now returns the default-metric value\r\n- support for scripting, where the doc-value returned is that of the `default_metric`", "committedDate": "2020-11-09T17:21:29Z", "type": "commit"}, {"oid": "8123f2e210e474abc600356f349308f1359d0bf7", "url": "https://github.com/elastic/elasticsearch/commit/8123f2e210e474abc600356f349308f1359d0bf7", "message": "Merge remote-tracking branch 'elastic/master' into feature/aggregate-metrics", "committedDate": "2020-11-09T18:58:39Z", "type": "commit"}, {"oid": "7b624072b9a4ff2bad053177bcb266a40fc447d2", "url": "https://github.com/elastic/elasticsearch/commit/7b624072b9a4ff2bad053177bcb266a40fc447d2", "message": "Merge branch 'master' into feature/aggregate-metrics", "committedDate": "2020-11-10T14:42:49Z", "type": "commit"}]}