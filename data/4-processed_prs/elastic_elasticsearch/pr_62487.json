{"pr_number": 62487, "pr_title": "Allow empty null values for date and IP field mappers", "pr_createdAt": "2020-09-16T16:25:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62487", "timeline": [{"oid": "998736b83908585b1c6cf276b90ce0dc695737de", "url": "https://github.com/elastic/elasticsearch/commit/998736b83908585b1c6cf276b90ce0dc695737de", "message": "Allow empty null values for date and ip field mappers", "committedDate": "2020-09-16T16:17:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5MTI4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490091286", "bodyText": "This also converts IpFieldMapperTests to MapperTestCase because it just makes testing so much easier...", "author": "romseygeek", "createdAt": "2020-09-17T09:09:33Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/IpFieldMapperTests.java", "diffHunk": "@@ -28,61 +28,28 @@\n import org.apache.lucene.util.BytesRef;", "originalCommit": "998736b83908585b1c6cf276b90ce0dc695737de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5MTY2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490091669", "bodyText": "This is the part that is testing the new functionality", "author": "romseygeek", "createdAt": "2020-09-17T09:10:05Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/IpFieldMapperTests.java", "diffHunk": "@@ -265,33 +169,29 @@ public void testNullValue() throws IOException {\n         assertEquals(DocValuesType.SORTED_SET, dvField.fieldType().docValuesType());\n         assertEquals(new BytesRef(InetAddressPoint.encode(InetAddresses.forString(\"::1\"))), dvField.binaryValue());\n         assertFalse(dvField.fieldType().stored());\n-    }\n \n-    public void testSerializeDefaults() throws Exception {\n-        String mapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\")\n-            .startObject(\"properties\").startObject(\"field\").field(\"type\", \"ip\").endObject().endObject()\n-            .endObject().endObject());\n+        mapper = createDocumentMapper(fieldMapping(b -> {", "originalCommit": "998736b83908585b1c6cf276b90ce0dc695737de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5MjMzMw==", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490092333", "bodyText": "testEmptyName and testSerializeDefaults are done as part of the parent class tests.  testMeta in the parent class discovered that IpFieldMapper wasn't correctly serializing its meta param, so the test cutover is definitely worth it!", "author": "romseygeek", "createdAt": "2020-09-17T09:11:06Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/IpFieldMapperTests.java", "diffHunk": "@@ -265,33 +169,29 @@ public void testNullValue() throws IOException {\n         assertEquals(DocValuesType.SORTED_SET, dvField.fieldType().docValuesType());\n         assertEquals(new BytesRef(InetAddressPoint.encode(InetAddresses.forString(\"::1\"))), dvField.binaryValue());\n         assertFalse(dvField.fieldType().stored());\n-    }\n \n-    public void testSerializeDefaults() throws Exception {\n-        String mapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\")\n-            .startObject(\"properties\").startObject(\"field\").field(\"type\", \"ip\").endObject().endObject()\n-            .endObject().endObject());\n+        mapper = createDocumentMapper(fieldMapping(b -> {\n+            b.field(\"type\", \"ip\");\n+            b.nullField(\"null_value\");\n+        }));\n \n-        DocumentMapper docMapper = parser.parse(\"type\", new CompressedXContent(mapping));\n-        IpFieldMapper mapper = (IpFieldMapper)docMapper.root().getMapper(\"field\");\n-        XContentBuilder builder = XContentFactory.jsonBuilder().startObject();\n-        mapper.doXContentBody(builder, true, ToXContent.EMPTY_PARAMS);\n-        String got = Strings.toString(builder.endObject());\n+        doc = mapper.parse(source(b -> b.nullField(\"field\")));\n+        assertArrayEquals(new IndexableField[0], doc.rootDoc().getFields(\"field\"));\n \n-        // it would be nice to check the entire serialized default mapper, but there are\n-        // a whole lot of bogus settings right now it picks up from calling super.doXContentBody...\n-        assertTrue(got, got.contains(\"\\\"ignore_malformed\\\":false\"));\n-    }\n+        mapper = createDocumentMapper(fieldMapping(b -> {\n+            b.field(\"type\", \"ip\");\n+            b.field(\"null_value\", \"\");\n+        }));\n \n-    public void testEmptyName() throws IOException {", "originalCommit": "998736b83908585b1c6cf276b90ce0dc695737de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDExNDY4NA==", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490114684", "bodyText": "nit: formatting", "author": "cbuescher", "createdAt": "2020-09-17T09:47:21Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/IpFieldMapper.java", "diffHunk": "@@ -90,14 +82,27 @@ public Builder(String name, boolean ignoreMalformedByDefault) {\n                 = Parameter.boolParam(\"ignore_malformed\", true, m -> toType(m).ignoreMalformed, ignoreMalformedByDefault);\n         }\n \n-        Builder nullValue(InetAddress nullValue) {\n+        Builder nullValue(String nullValue) {\n             this.nullValue.setValue(nullValue);\n             return this;\n         }\n \n+        private InetAddress parseNullValue() {\n+            String nullValueAsString = nullValue.getValue();\n+            if (nullValueAsString == null || Strings.isEmpty(nullValueAsString)) {\n+                return null;\n+            }\n+            try {\n+                return InetAddresses.forString(nullValueAsString);\n+            }\n+            catch (Exception e) {", "originalCommit": "998736b83908585b1c6cf276b90ce0dc695737de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cdf283cfd93a9cb04a73e609161a2ebbce2a276c", "url": "https://github.com/elastic/elasticsearch/commit/cdf283cfd93a9cb04a73e609161a2ebbce2a276c", "message": "Only fail null_value parsing for pre-8x indexes", "committedDate": "2020-09-17T12:39:15Z", "type": "commit"}, {"oid": "cc6b8e57dc82c532a5a163790a79c6d273f9a75c", "url": "https://github.com/elastic/elasticsearch/commit/cc6b8e57dc82c532a5a163790a79c6d273f9a75c", "message": "formatting", "committedDate": "2020-09-17T12:41:54Z", "type": "commit"}, {"oid": "6d995ee5cb64f0e89779c2cbb62cde65826b516a", "url": "https://github.com/elastic/elasticsearch/commit/6d995ee5cb64f0e89779c2cbb62cde65826b516a", "message": "fix settings for base testcase", "committedDate": "2020-09-17T13:37:14Z", "type": "commit"}, {"oid": "ed939be9c0b89816bc1a1e2317db362af5644653", "url": "https://github.com/elastic/elasticsearch/commit/ed939be9c0b89816bc1a1e2317db362af5644653", "message": "Merge remote-tracking branch 'origin/master' into mapper/date-empty-null-value", "committedDate": "2020-09-17T13:37:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5NTU2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490295561", "bodyText": "I guess the missing \"meta\" was discovered by the test change?", "author": "cbuescher", "createdAt": "2020-09-17T14:32:49Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/IpFieldMapper.java", "diffHunk": "@@ -68,36 +71,48 @@ private static IpFieldMapper toType(FieldMapper in) {\n         private final Parameter<Boolean> stored = Parameter.storeParam(m -> toType(m).stored, false);\n \n         private final Parameter<Boolean> ignoreMalformed;\n-        private final Parameter<InetAddress> nullValue = new Parameter<>(\"null_value\", false, () -> null,\n-            (n, c, o) -> o == null ? null : InetAddresses.forString(o.toString()), m -> toType(m).nullValue)\n-            .setSerializer((b, f, v) -> {\n-                if (v == null) {\n-                    b.nullField(f);\n-                } else {\n-                    b.field(f, InetAddresses.toAddrString(v));\n-                }\n-            }, NetworkAddress::format)\n-            .acceptsNull();\n+        private final Parameter<String> nullValue\n+            = Parameter.stringParam(\"null_value\", false, m -> toType(m).nullValueAsString, null).acceptsNull();\n \n         private final Parameter<Map<String, String>> meta = Parameter.metaParam();\n \n         private final boolean ignoreMalformedByDefault;\n+        private final Version indexCreatedVersion;\n \n-        public Builder(String name, boolean ignoreMalformedByDefault) {\n+        public Builder(String name, boolean ignoreMalformedByDefault, Version indexCreatedVersion) {\n             super(name);\n             this.ignoreMalformedByDefault = ignoreMalformedByDefault;\n+            this.indexCreatedVersion = indexCreatedVersion;\n             this.ignoreMalformed\n                 = Parameter.boolParam(\"ignore_malformed\", true, m -> toType(m).ignoreMalformed, ignoreMalformedByDefault);\n         }\n \n-        Builder nullValue(InetAddress nullValue) {\n+        Builder nullValue(String nullValue) {\n             this.nullValue.setValue(nullValue);\n             return this;\n         }\n \n+        private InetAddress parseNullValue() {\n+            String nullValueAsString = nullValue.getValue();\n+            if (nullValueAsString == null) {\n+                return null;\n+            }\n+            try {\n+                return InetAddresses.forString(nullValueAsString);\n+            } catch (Exception e) {\n+                if (indexCreatedVersion.onOrAfter(Version.V_8_0_0)) {\n+                    throw new MapperParsingException(\"Error parsing [null_value] on field [\" + name() + \"]: \" + e.getMessage(), e);\n+                } else {\n+                    DEPRECATION_LOGGER.deprecate(\"ip_mapper_null_field\", \"Error parsing [\" + nullValue.getValue()\n+                        + \"] as IP in [null_value] on field [\" + name() + \"]); [null_value] will be ignored\");\n+                    return null;\n+                }\n+            }\n+        }\n+\n         @Override\n         protected List<Parameter<?>> getParameters() {\n-            return List.of(indexed, hasDocValues, stored, ignoreMalformed, nullValue);\n+            return List.of(indexed, hasDocValues, stored, ignoreMalformed, nullValue, meta);", "originalCommit": "ed939be9c0b89816bc1a1e2317db362af5644653", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzNjI3OA==", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490336278", "bodyText": "Yes!", "author": "romseygeek", "createdAt": "2020-09-17T15:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5NTU2MQ=="}], "type": "inlineReview"}]}