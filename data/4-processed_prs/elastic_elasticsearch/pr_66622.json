{"pr_number": 66622, "pr_title": "QL: handle IP type fields extraction with ignore_malformed property", "pr_createdAt": "2020-12-18T18:07:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66622", "timeline": [{"oid": "ea41d953cc6f89d82fbb7fc21c95d91bd69b3806", "url": "https://github.com/elastic/elasticsearch/commit/ea41d953cc6f89d82fbb7fc21c95d91bd69b3806", "message": "Handle ignore_malformed mapping property for IP field types as well.", "committedDate": "2020-12-18T18:03:17Z", "type": "commit"}, {"oid": "aeb3dbce49b5a50b755206393ec71333f16d2015", "url": "https://github.com/elastic/elasticsearch/commit/aeb3dbce49b5a50b755206393ec71333f16d2015", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into ip_field_hit_extractor", "committedDate": "2020-12-18T18:03:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0NDg3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/66622#discussion_r546044879", "bodyText": "Are there any cases where the type is relevant for ignore malformed is set and the return value should not be null?\nIt is currently available for numeric, date , geo-points and IP (https://www.elastic.co/guide/en/elasticsearch/reference/current/ignore-malformed.html).\nI would argue that if it is set, null should be returned regardless of the data type.", "author": "costin", "createdAt": "2020-12-18T19:23:17Z", "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/execution/search/extractor/AbstractFieldHitExtractor.java", "diffHunk": "@@ -129,10 +129,10 @@ public Object extract(SearchHit hit) {\n             if (fullFieldName != null\n                     && hit.getFields().containsKey(IgnoredFieldMapper.NAME)\n                     && isFromDocValuesOnly(dataType) == false\n-                    && dataType.isNumeric()) {\n+                    && (dataType.isNumeric() || dataType == DataTypes.IP)) {", "originalCommit": "aeb3dbce49b5a50b755206393ec71333f16d2015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyNTg2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/66622#discussion_r546125865", "bodyText": "@costin Not 100% sure if null is always the answer. A null_value parameter, for example, doesn't apply in this case. If the parsing fails and ignore_malformed is true setting the null_value parameter will not return that value in this case. That field will still not be indexed.", "author": "astefan", "createdAt": "2020-12-18T22:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0NDg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEzMzY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/66622#discussion_r546133648", "bodyText": "Right, we don't know if the null value was set and thus return null. However my comment is regarding the data type, why does it matter?\nIf ignore malformed is set and the type is geo for example (which is not part of the if) the source data which is malformed is returned.\nThat is just like now for IP which this ticket addresses.\nI think returning null is a safer choice the returning potentially invalid data", "author": "costin", "createdAt": "2020-12-18T23:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0NDg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyOTA4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/66622#discussion_r546629083", "bodyText": "geo_point is taken from docvalues, not from _source. shape doesn't seem to support docvalues and thus can only be extracted from _source. The same goes for keyword, date, datetime, scaled_float.\nAnd in this case we already have the null value from docvalues and we don't need the _source to extract data.\nBut, I see your point about checking the type itself. I think there is no need for this check, the presence of the ignored section in the response is enough", "author": "astefan", "createdAt": "2020-12-21T10:31:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0NDg3OQ=="}], "type": "inlineReview"}, {"oid": "75f90b4050b9c165239f9b5fc3d5b2d9c9825dbb", "url": "https://github.com/elastic/elasticsearch/commit/75f90b4050b9c165239f9b5fc3d5b2d9c9825dbb", "message": "Return null for any field that is present in the _ignored section of the\nresponse, not only numerics and IPs.\nAdd more tests", "committedDate": "2020-12-21T10:27:31Z", "type": "commit"}, {"oid": "cc334d045168a424a9121e200b9e874c9093a2e1", "url": "https://github.com/elastic/elasticsearch/commit/cc334d045168a424a9121e200b9e874c9093a2e1", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into ip_field_hit_extractor", "committedDate": "2020-12-21T10:31:02Z", "type": "commit"}]}