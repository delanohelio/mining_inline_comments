{"pr_number": 53422, "pr_title": "EQL: Add more rest client tests", "pr_createdAt": "2020-03-11T17:05:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53422", "timeline": [{"oid": "0851c03614c2977c5a1ad253470c899a8fcb4349", "url": "https://github.com/elastic/elasticsearch/commit/0851c03614c2977c5a1ad253470c899a8fcb4349", "message": "EQL: Add more rest client tests", "committedDate": "2020-03-11T17:06:51Z", "type": "commit"}, {"oid": "0851c03614c2977c5a1ad253470c899a8fcb4349", "url": "https://github.com/elastic/elasticsearch/commit/0851c03614c2977c5a1ad253470c899a8fcb4349", "message": "EQL: Add more rest client tests", "committedDate": "2020-03-11T17:06:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI4MTc1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53422#discussion_r391281756", "bodyText": "Can you use a different value for category and event_type, please?", "author": "astefan", "createdAt": "2020-03-11T21:35:15Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/EqlIT.java", "diffHunk": "@@ -21,58 +21,145 @@\n \n import org.apache.http.client.methods.HttpPost;\n import org.apache.http.client.methods.HttpPut;\n+import org.elasticsearch.action.admin.indices.refresh.RefreshRequest;\n+import org.elasticsearch.action.admin.indices.refresh.RefreshResponse;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n import org.elasticsearch.client.eql.EqlSearchRequest;\n import org.elasticsearch.client.eql.EqlSearchResponse;\n import org.elasticsearch.client.eql.EqlStatsRequest;\n import org.elasticsearch.client.eql.EqlStatsResponse;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.common.time.DateUtils;\n import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.search.SearchHit;\n import org.junit.Before;\n \n+import java.io.IOException;\n import java.time.format.DateTimeFormatter;\n+import java.util.Locale;\n+import java.util.Map;\n \n+import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n+import static org.hamcrest.Matchers.anyOf;\n import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.greaterThan;\n \n public class EqlIT extends ESRestHighLevelClientTestCase {\n \n+    private static final String INDEX_NAME = \"index\";\n+    private static final int RECORD_COUNT = 40;\n+    private static final int DIVIDER = 4;\n+\n     @Before\n-    public void setupRemoteClusterConfig() throws Exception {\n+    public void setup() throws Exception {\n         setupRemoteClusterConfig(\"local_cluster\");\n+        setupData();\n     }\n \n-    public void testBasicSearch() throws Exception {\n-        Request doc1 = new Request(HttpPut.METHOD_NAME, \"/index/_doc/1\");\n-        doc1.setJsonEntity(\"{\\\"event_subtype_full\\\": \\\"already_running\\\", \" +\n-                \"\\\"event\\\": {\" +\n-                    \"\\\"category\\\": \\\"process\\\"\" +\n-                \"},\" +\n-                \"\\\"event_type_full\\\": \\\"process_event\\\", \" +\n-                \"\\\"opcode\\\": 3,\" +\n-                \"\\\"pid\\\": 0,\" +\n-                \"\\\"process_name\\\": \\\"System Idle Process\\\",\" +\n-                \"\\\"serial_event_id\\\": 1,\" +\n-                \"\\\"subtype\\\": \\\"create\\\",\" +\n-                \"\\\"@timestamp\\\": 116444736000000000,\" +\n-                \"\\\"unique_pid\\\": 1}\");\n-        client().performRequest(doc1);\n-        client().performRequest(new Request(HttpPost.METHOD_NAME, \"/_refresh\"));\n+    private void setupData() throws IOException {\n+        final BulkRequest bulkRequest = new BulkRequest();\n+        bulkRequest.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE);\n+        for (int i = 0; i < RECORD_COUNT; i++) {\n+            final IndexRequest indexRequest = new IndexRequest(INDEX_NAME);\n+            indexRequest.source(jsonBuilder()\n+                    .startObject()\n+                    .field(\"event_subtype_full\", \"already_running\")\n+                    .startObject(\"event\")\n+                    .field(\"category\", \"process\")\n+                    .endObject()\n+                    .field(\"event_type\", \"process\")", "originalCommit": "0851c03614c2977c5a1ad253470c899a8fcb4349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM3MjYxNw==", "url": "https://github.com/elastic/elasticsearch/pull/53422#discussion_r391372617", "bodyText": "did it the same cause using default event.category in one test and overwriting with event_type event category field in another test, while keeping the query beginning \"process where\" the same. surely can use whatever for the sake of testing. will update.", "author": "aleksmaus", "createdAt": "2020-03-12T02:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI4MTc1Ng=="}], "type": "inlineReview"}, {"oid": "b6b6359d65f5d85f53a904d4da423fc435b4fd69", "url": "https://github.com/elastic/elasticsearch/commit/b6b6359d65f5d85f53a904d4da423fc435b4fd69", "message": "Address Andrei's code review feedback", "committedDate": "2020-03-12T03:03:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyNjcwNg==", "url": "https://github.com/elastic/elasticsearch/pull/53422#discussion_r391526706", "bodyText": "You could use the randomXXX() methods instead for arbitrary values or randomBoolean() to select which one should be used. This has the advantage of trying different combinations for all documents.", "author": "costin", "createdAt": "2020-03-12T10:26:58Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/EqlIT.java", "diffHunk": "@@ -21,58 +21,145 @@\n \n import org.apache.http.client.methods.HttpPost;\n import org.apache.http.client.methods.HttpPut;\n+import org.elasticsearch.action.admin.indices.refresh.RefreshRequest;\n+import org.elasticsearch.action.admin.indices.refresh.RefreshResponse;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n import org.elasticsearch.client.eql.EqlSearchRequest;\n import org.elasticsearch.client.eql.EqlSearchResponse;\n import org.elasticsearch.client.eql.EqlStatsRequest;\n import org.elasticsearch.client.eql.EqlStatsResponse;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.common.time.DateUtils;\n import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.search.SearchHit;\n import org.junit.Before;\n \n+import java.io.IOException;\n import java.time.format.DateTimeFormatter;\n+import java.util.Locale;\n+import java.util.Map;\n \n+import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n+import static org.hamcrest.Matchers.anyOf;\n import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.greaterThan;\n \n public class EqlIT extends ESRestHighLevelClientTestCase {\n \n+    private static final String INDEX_NAME = \"index\";\n+    private static final int RECORD_COUNT = 40;\n+    private static final int DIVIDER = 4;\n+\n     @Before\n-    public void setupRemoteClusterConfig() throws Exception {\n+    public void setup() throws Exception {\n         setupRemoteClusterConfig(\"local_cluster\");\n+        setupData();\n     }\n \n-    public void testBasicSearch() throws Exception {\n-        Request doc1 = new Request(HttpPut.METHOD_NAME, \"/index/_doc/1\");\n-        doc1.setJsonEntity(\"{\\\"event_subtype_full\\\": \\\"already_running\\\", \" +\n-                \"\\\"event\\\": {\" +\n-                    \"\\\"category\\\": \\\"process\\\"\" +\n-                \"},\" +\n-                \"\\\"event_type_full\\\": \\\"process_event\\\", \" +\n-                \"\\\"opcode\\\": 3,\" +\n-                \"\\\"pid\\\": 0,\" +\n-                \"\\\"process_name\\\": \\\"System Idle Process\\\",\" +\n-                \"\\\"serial_event_id\\\": 1,\" +\n-                \"\\\"subtype\\\": \\\"create\\\",\" +\n-                \"\\\"@timestamp\\\": 116444736000000000,\" +\n-                \"\\\"unique_pid\\\": 1}\");\n-        client().performRequest(doc1);\n-        client().performRequest(new Request(HttpPost.METHOD_NAME, \"/_refresh\"));\n+    private void setupData() throws IOException {\n+        final BulkRequest bulkRequest = new BulkRequest();\n+        bulkRequest.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE);\n+        for (int i = 0; i < RECORD_COUNT; i++) {\n+            final IndexRequest indexRequest = new IndexRequest(INDEX_NAME);\n+            indexRequest.source(jsonBuilder()\n+                    .startObject()\n+                    .field(\"event_subtype_full\", \"already_running\")\n+                    .startObject(\"event\")\n+                    .field(\"category\", \"process\")\n+                    .endObject()\n+                    .field(\"event_type\", \"foo\")\n+                    .field(\"event_type_full\", \"process_event\")\n+                    .field(\"opcode\", ((i % DIVIDER) == 0) ? 1 : 0)", "originalCommit": "b6b6359d65f5d85f53a904d4da423fc435b4fd69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}