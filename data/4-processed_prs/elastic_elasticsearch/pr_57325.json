{"pr_number": 57325, "pr_title": "Include hidden indices in snapshots by default", "pr_createdAt": "2020-05-29T00:01:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57325", "timeline": [{"oid": "193e2518b1da319914dd274f27ccbdb974a6a748", "url": "https://github.com/elastic/elasticsearch/commit/193e2518b1da319914dd274f27ccbdb974a6a748", "message": "Include hidden indices in snapshots by default\n\nPreviously, hidden indices were not included in snapshots by default, unless\nspecified using one of the usual methods for doing so: naming indices directly,\nusing index patterns starting with a `.`, or specifying `expand_wildcards` to\na value that includes hidden (e.g. `all` or `hidden,open`).\n\nThis commit changes the default `expand_wildcards` value to include hidden\nindices.", "committedDate": "2020-05-28T23:59:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4ODA5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r432188091", "bodyText": "This line is the only functionality change, the rest of this PR is tests.", "author": "gwbrown", "createdAt": "2020-05-29T00:03:18Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/create/CreateSnapshotRequest.java", "diffHunk": "@@ -72,7 +72,7 @@\n \n     private String[] indices = EMPTY_ARRAY;\n \n-    private IndicesOptions indicesOptions = IndicesOptions.strictExpand();\n+    private IndicesOptions indicesOptions = IndicesOptions.strictExpandHidden();", "originalCommit": "193e2518b1da319914dd274f27ccbdb974a6a748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkyNjQwNg==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r432926406", "bodyText": "This test failed because the .security index could not be restored (either because it was never deleted as part of the test or auto re-created).", "author": "original-brownbear", "createdAt": "2020-05-31T09:11:42Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/SnapshotIT.java", "diffHunk": "@@ -285,6 +286,49 @@ public void testRestoreSnapshot() throws IOException {\n         assertThat(restoreInfo.failedShards(), equalTo(0));\n     }\n \n+    public void testSnapshotHidden() throws IOException {", "originalCommit": "193e2518b1da319914dd274f27ccbdb974a6a748", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU4ODIzMA==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r433588230", "bodyText": "Thanks, I believe I've fixed this test - there were a few issues with it.", "author": "gwbrown", "createdAt": "2020-06-02T02:33:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkyNjQwNg=="}], "type": "inlineReview"}, {"oid": "112ae0746328ea06b89d70ca5ee8ed6548b20257", "url": "https://github.com/elastic/elasticsearch/commit/112ae0746328ea06b89d70ca5ee8ed6548b20257", "message": "Fix SnapshotIT test", "committedDate": "2020-06-02T00:49:41Z", "type": "commit"}, {"oid": "ab3f1e4f0db9815a5dfea809ba8c2bdc78d97d50", "url": "https://github.com/elastic/elasticsearch/commit/ab3f1e4f0db9815a5dfea809ba8c2bdc78d97d50", "message": "Implement deprecation warning", "committedDate": "2020-06-02T00:49:42Z", "type": "commit"}, {"oid": "c62eea3fdd3e7f3e28553346131da13a2977e260", "url": "https://github.com/elastic/elasticsearch/commit/c62eea3fdd3e7f3e28553346131da13a2977e260", "message": "Minor wording fix", "committedDate": "2020-06-02T02:27:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcwNDc1NA==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r433704754", "bodyText": "This seems kind of wrong to me. We're adding something to the request here only so that we can log the deprecation warning accordingly?", "author": "original-brownbear", "createdAt": "2020-06-02T08:24:15Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/create/CreateSnapshotRequest.java", "diffHunk": "@@ -72,7 +73,9 @@\n \n     private String[] indices = EMPTY_ARRAY;\n \n-    private IndicesOptions indicesOptions = IndicesOptions.strictExpand();\n+    private IndicesOptions indicesOptions = IndicesOptions.strictExpandHidden();\n+\n+    private boolean defaultExpandWildcards = true;", "originalCommit": "c62eea3fdd3e7f3e28553346131da13a2977e260", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5MjAyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r434192021", "bodyText": "Yeah, that felt wrong when I was writing it, and after sleeping on it I'm not sure what I was thinking. I've reverted the commit that adds the deprecation warning (and this field in service of it) and will do some more work on that part and break it out into another PR so we can get this into patch releases as appropriate quickly.", "author": "gwbrown", "createdAt": "2020-06-02T21:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcwNDc1NA=="}], "type": "inlineReview"}, {"oid": "d5701974bdf5083afdda1156cdf5f68f7eeb7a64", "url": "https://github.com/elastic/elasticsearch/commit/d5701974bdf5083afdda1156cdf5f68f7eeb7a64", "message": "Revert \"Implement deprecation warning\"\n\nThis reverts commit ab3f1e4f0db9815a5dfea809ba8c2bdc78d97d50.", "committedDate": "2020-06-02T21:40:16Z", "type": "commit"}, {"oid": "1d7b29cfa8819db62f3e8ddf52fdddd960edc5ea", "url": "https://github.com/elastic/elasticsearch/commit/1d7b29cfa8819db62f3e8ddf52fdddd960edc5ea", "message": "Merge branch 'master' into change-snapshot-wildcards-default", "committedDate": "2020-06-02T21:40:37Z", "type": "commit"}, {"oid": "17e7ad3b6753b5b8d5af8008e14ff8594b5cde88", "url": "https://github.com/elastic/elasticsearch/commit/17e7ad3b6753b5b8d5af8008e14ff8594b5cde88", "message": "Merge branch 'master' into change-snapshot-wildcards-default", "committedDate": "2020-06-02T22:28:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI5NjE3OA==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r434296178", "bodyText": "NIT: extra empty line", "author": "original-brownbear", "createdAt": "2020-06-03T04:07:10Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -3826,6 +3827,136 @@ public void testBulkDeleteWithOverlappingPatterns() {\n         assertThat(getSnapshotsResponse.getSnapshots(\"test-repo\"), empty());\n     }\n \n+    public void testHiddenIndicesIncludedInSnapshot() {\n+        Client client = client();\n+        final String normalIndex = \"normal-index\";\n+        final String hiddenIndex = \"hidden-index\";\n+        final String dottedHiddenIndex = \".index-hidden\";\n+        final String repoName = \"test-repo\";\n+\n+        logger.info(\"-->  creating repository\");\n+        assertAcked(client.admin().cluster().preparePutRepository(repoName).setType(\"fs\").setSettings(randomRepoSettings()));\n+\n+        logger.info(\"--> creating indices\");\n+        createIndex(normalIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .build());\n+        createIndex(hiddenIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .put(IndexMetadata.SETTING_INDEX_HIDDEN, true)\n+            .build());\n+        createIndex(dottedHiddenIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .put(IndexMetadata.SETTING_INDEX_HIDDEN, true)\n+            .build());\n+        ensureGreen();\n+\n+        logger.info(\"--> indexing some data\");\n+        for (int i = 0; i < 100; i++) {\n+            indexDoc(normalIndex, Integer.toString(i), \"foo\", \"bar\" + i);\n+            indexDoc(hiddenIndex, Integer.toString(i), \"foo\", \"baz\" + i);\n+            indexDoc(dottedHiddenIndex, Integer.toString(i), \"foo\", \"baz\" + i);\n+        }\n+        refresh();\n+        assertHitCount(client.prepareSearch(normalIndex).setSize(0).get(), 100L);\n+        assertHitCount(client.prepareSearch(hiddenIndex).setSize(0).get(), 100L);\n+        assertHitCount(client.prepareSearch(dottedHiddenIndex).setSize(0).get(), 100L);\n+\n+        logger.info(\"--> taking a snapshot\");\n+        final String snapName = \"test-snap\";\n+        CreateSnapshotResponse createSnapshotResponse = client.admin().cluster().prepareCreateSnapshot(repoName, snapName)\n+            .setWaitForCompletion(true).setIndices(randomFrom(\"*\", \"_all\")).get();\n+        assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(), greaterThan(0));\n+        assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),\n+            equalTo(createSnapshotResponse.getSnapshotInfo().totalShards()));\n+\n+        List<SnapshotInfo> snapshotInfos = client.admin().cluster().prepareGetSnapshots(repoName)\n+            .setSnapshots(randomFrom(snapName, \"_all\", \"*\", \"*-snap\", \"test*\")).get().getSnapshots(repoName);\n+        assertThat(snapshotInfos.size(), equalTo(1));\n+        SnapshotInfo snapshotInfo = snapshotInfos.get(0);\n+        assertThat(snapshotInfo.state(), equalTo(SnapshotState.SUCCESS));\n+        assertThat(snapshotInfo.version(), equalTo(Version.CURRENT));\n+\n+        logger.info(\"--> deleting indices\");\n+        cluster().wipeIndices(normalIndex, hiddenIndex, dottedHiddenIndex);\n+\n+        // Verify that hidden indices get restored with a wildcard restore\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(normalIndex, hiddenIndex, dottedHiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(true));\n+            cluster().wipeIndices(normalIndex, hiddenIndex, dottedHiddenIndex);\n+        }\n+\n+        // Verify that exclusions work on hidden indices\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"*\", \"-.*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(normalIndex, hiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(false));\n+            cluster().wipeIndices(normalIndex, hiddenIndex);\n+        }\n+\n+        // Verify that hidden indices can be restored with a non-star pattern\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"hid*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(hiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(false));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(false));\n+            cluster().wipeIndices(hiddenIndex);\n+        }\n+\n+        // Verify that hidden indices can be restored by fully specified name\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(dottedHiddenIndex)\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(dottedHiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(false));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(false));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(true));\n+            cluster().wipeIndices(dottedHiddenIndex);\n+        }\n+    }\n+\n+", "originalCommit": "17e7ad3b6753b5b8d5af8008e14ff8594b5cde88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI5NjM0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r434296343", "bodyText": "No need  to manually wipe these in the last step of the test as the tear-down logic will take care of it?", "author": "original-brownbear", "createdAt": "2020-06-03T04:07:58Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -3826,6 +3827,136 @@ public void testBulkDeleteWithOverlappingPatterns() {\n         assertThat(getSnapshotsResponse.getSnapshots(\"test-repo\"), empty());\n     }\n \n+    public void testHiddenIndicesIncludedInSnapshot() {\n+        Client client = client();\n+        final String normalIndex = \"normal-index\";\n+        final String hiddenIndex = \"hidden-index\";\n+        final String dottedHiddenIndex = \".index-hidden\";\n+        final String repoName = \"test-repo\";\n+\n+        logger.info(\"-->  creating repository\");\n+        assertAcked(client.admin().cluster().preparePutRepository(repoName).setType(\"fs\").setSettings(randomRepoSettings()));\n+\n+        logger.info(\"--> creating indices\");\n+        createIndex(normalIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .build());\n+        createIndex(hiddenIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .put(IndexMetadata.SETTING_INDEX_HIDDEN, true)\n+            .build());\n+        createIndex(dottedHiddenIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .put(IndexMetadata.SETTING_INDEX_HIDDEN, true)\n+            .build());\n+        ensureGreen();\n+\n+        logger.info(\"--> indexing some data\");\n+        for (int i = 0; i < 100; i++) {\n+            indexDoc(normalIndex, Integer.toString(i), \"foo\", \"bar\" + i);\n+            indexDoc(hiddenIndex, Integer.toString(i), \"foo\", \"baz\" + i);\n+            indexDoc(dottedHiddenIndex, Integer.toString(i), \"foo\", \"baz\" + i);\n+        }\n+        refresh();\n+        assertHitCount(client.prepareSearch(normalIndex).setSize(0).get(), 100L);\n+        assertHitCount(client.prepareSearch(hiddenIndex).setSize(0).get(), 100L);\n+        assertHitCount(client.prepareSearch(dottedHiddenIndex).setSize(0).get(), 100L);\n+\n+        logger.info(\"--> taking a snapshot\");\n+        final String snapName = \"test-snap\";\n+        CreateSnapshotResponse createSnapshotResponse = client.admin().cluster().prepareCreateSnapshot(repoName, snapName)\n+            .setWaitForCompletion(true).setIndices(randomFrom(\"*\", \"_all\")).get();\n+        assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(), greaterThan(0));\n+        assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),\n+            equalTo(createSnapshotResponse.getSnapshotInfo().totalShards()));\n+\n+        List<SnapshotInfo> snapshotInfos = client.admin().cluster().prepareGetSnapshots(repoName)\n+            .setSnapshots(randomFrom(snapName, \"_all\", \"*\", \"*-snap\", \"test*\")).get().getSnapshots(repoName);\n+        assertThat(snapshotInfos.size(), equalTo(1));\n+        SnapshotInfo snapshotInfo = snapshotInfos.get(0);\n+        assertThat(snapshotInfo.state(), equalTo(SnapshotState.SUCCESS));\n+        assertThat(snapshotInfo.version(), equalTo(Version.CURRENT));\n+\n+        logger.info(\"--> deleting indices\");\n+        cluster().wipeIndices(normalIndex, hiddenIndex, dottedHiddenIndex);\n+\n+        // Verify that hidden indices get restored with a wildcard restore\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(normalIndex, hiddenIndex, dottedHiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(true));\n+            cluster().wipeIndices(normalIndex, hiddenIndex, dottedHiddenIndex);\n+        }\n+\n+        // Verify that exclusions work on hidden indices\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"*\", \"-.*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(normalIndex, hiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(false));\n+            cluster().wipeIndices(normalIndex, hiddenIndex);\n+        }\n+\n+        // Verify that hidden indices can be restored with a non-star pattern\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"hid*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(hiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(false));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(false));\n+            cluster().wipeIndices(hiddenIndex);\n+        }\n+\n+        // Verify that hidden indices can be restored by fully specified name\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(dottedHiddenIndex)\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(dottedHiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(false));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(false));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(true));\n+            cluster().wipeIndices(dottedHiddenIndex);", "originalCommit": "17e7ad3b6753b5b8d5af8008e14ff8594b5cde88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI5NjQ5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57325#discussion_r434296491", "bodyText": "Can we use get instead of actionGet here and in other places in the new test to get full stack traces on failures?", "author": "original-brownbear", "createdAt": "2020-06-03T04:08:42Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -3826,6 +3827,136 @@ public void testBulkDeleteWithOverlappingPatterns() {\n         assertThat(getSnapshotsResponse.getSnapshots(\"test-repo\"), empty());\n     }\n \n+    public void testHiddenIndicesIncludedInSnapshot() {\n+        Client client = client();\n+        final String normalIndex = \"normal-index\";\n+        final String hiddenIndex = \"hidden-index\";\n+        final String dottedHiddenIndex = \".index-hidden\";\n+        final String repoName = \"test-repo\";\n+\n+        logger.info(\"-->  creating repository\");\n+        assertAcked(client.admin().cluster().preparePutRepository(repoName).setType(\"fs\").setSettings(randomRepoSettings()));\n+\n+        logger.info(\"--> creating indices\");\n+        createIndex(normalIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .build());\n+        createIndex(hiddenIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .put(IndexMetadata.SETTING_INDEX_HIDDEN, true)\n+            .build());\n+        createIndex(dottedHiddenIndex, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, randomIntBetween(1,3))\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .put(IndexMetadata.SETTING_INDEX_HIDDEN, true)\n+            .build());\n+        ensureGreen();\n+\n+        logger.info(\"--> indexing some data\");\n+        for (int i = 0; i < 100; i++) {\n+            indexDoc(normalIndex, Integer.toString(i), \"foo\", \"bar\" + i);\n+            indexDoc(hiddenIndex, Integer.toString(i), \"foo\", \"baz\" + i);\n+            indexDoc(dottedHiddenIndex, Integer.toString(i), \"foo\", \"baz\" + i);\n+        }\n+        refresh();\n+        assertHitCount(client.prepareSearch(normalIndex).setSize(0).get(), 100L);\n+        assertHitCount(client.prepareSearch(hiddenIndex).setSize(0).get(), 100L);\n+        assertHitCount(client.prepareSearch(dottedHiddenIndex).setSize(0).get(), 100L);\n+\n+        logger.info(\"--> taking a snapshot\");\n+        final String snapName = \"test-snap\";\n+        CreateSnapshotResponse createSnapshotResponse = client.admin().cluster().prepareCreateSnapshot(repoName, snapName)\n+            .setWaitForCompletion(true).setIndices(randomFrom(\"*\", \"_all\")).get();\n+        assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(), greaterThan(0));\n+        assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),\n+            equalTo(createSnapshotResponse.getSnapshotInfo().totalShards()));\n+\n+        List<SnapshotInfo> snapshotInfos = client.admin().cluster().prepareGetSnapshots(repoName)\n+            .setSnapshots(randomFrom(snapName, \"_all\", \"*\", \"*-snap\", \"test*\")).get().getSnapshots(repoName);\n+        assertThat(snapshotInfos.size(), equalTo(1));\n+        SnapshotInfo snapshotInfo = snapshotInfos.get(0);\n+        assertThat(snapshotInfo.state(), equalTo(SnapshotState.SUCCESS));\n+        assertThat(snapshotInfo.version(), equalTo(Version.CURRENT));\n+\n+        logger.info(\"--> deleting indices\");\n+        cluster().wipeIndices(normalIndex, hiddenIndex, dottedHiddenIndex);\n+\n+        // Verify that hidden indices get restored with a wildcard restore\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(normalIndex, hiddenIndex, dottedHiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(true));\n+            cluster().wipeIndices(normalIndex, hiddenIndex, dottedHiddenIndex);\n+        }\n+\n+        // Verify that exclusions work on hidden indices\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"*\", \"-.*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(normalIndex, hiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(false));\n+            cluster().wipeIndices(normalIndex, hiddenIndex);\n+        }\n+\n+        // Verify that hidden indices can be restored with a non-star pattern\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(\"hid*\")\n+                .execute().actionGet();\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(), greaterThan(0));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().successfulShards(),\n+                equalTo(restoreSnapshotResponse.getRestoreInfo().totalShards()));\n+            assertThat(restoreSnapshotResponse.getRestoreInfo().indices(), containsInAnyOrder(hiddenIndex));\n+            ClusterState clusterState = client.admin().cluster().prepareState().get().getState();\n+            assertThat(clusterState.getMetadata().hasIndex(normalIndex), equalTo(false));\n+            assertThat(clusterState.getMetadata().hasIndex(hiddenIndex), equalTo(true));\n+            assertThat(clusterState.getMetadata().hasIndex(dottedHiddenIndex), equalTo(false));\n+            cluster().wipeIndices(hiddenIndex);\n+        }\n+\n+        // Verify that hidden indices can be restored by fully specified name\n+        {\n+            RestoreSnapshotResponse restoreSnapshotResponse = client().admin().cluster()\n+                .prepareRestoreSnapshot(repoName, snapName)\n+                .setWaitForCompletion(true)\n+                .setIndices(dottedHiddenIndex)\n+                .execute().actionGet();", "originalCommit": "17e7ad3b6753b5b8d5af8008e14ff8594b5cde88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9b7956dd4cd2c4d504badb794d42d33f50d8a16e", "url": "https://github.com/elastic/elasticsearch/commit/9b7956dd4cd2c4d504badb794d42d33f50d8a16e", "message": "Cleanup per review", "committedDate": "2020-06-03T20:51:29Z", "type": "commit"}, {"oid": "1ded21ca570cdde09586c40490131efca3f4000a", "url": "https://github.com/elastic/elasticsearch/commit/1ded21ca570cdde09586c40490131efca3f4000a", "message": "Merge branch 'master' into change-snapshot-wildcards-default", "committedDate": "2020-06-03T20:51:35Z", "type": "commit"}]}