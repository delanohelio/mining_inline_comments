{"pr_number": 62728, "pr_title": "Check glibc version", "pr_createdAt": "2020-09-21T19:33:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62728", "timeline": [{"oid": "98402d4c69092e39f6ec4f07a2d669c3da0c9466", "url": "https://github.com/elastic/elasticsearch/commit/98402d4c69092e39f6ec4f07a2d669c3da0c9466", "message": "First stab at checking glibc version", "committedDate": "2020-09-21T14:01:29Z", "type": "commit"}, {"oid": "de80305f724e874477a5099a400eb30fec1083ea", "url": "https://github.com/elastic/elasticsearch/commit/de80305f724e874477a5099a400eb30fec1083ea", "message": "More work", "committedDate": "2020-09-21T19:23:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5OTMyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492299321", "bodyText": "debug?", "author": "rjernst", "createdAt": "2020-09-21T19:34:49Z", "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version", "originalCommit": "de80305f724e874477a5099a400eb30fec1083ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMDMwOA==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492300308", "bodyText": "this isn't portable. i think can avoid it altogether and only use getconf?", "author": "rjernst", "createdAt": "2020-09-21T19:36:38Z", "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version\n+  if [[ -e /lib64/libc.so.6 ]]; then", "originalCommit": "de80305f724e874477a5099a400eb30fec1083ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMDU2MA==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492300560", "bodyText": "i think can can avoid all the fallbacks? just use getconf", "author": "rjernst", "createdAt": "2020-09-21T19:37:07Z", "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version\n+  if [[ -e /lib64/libc.so.6 ]]; then\n+    # We need to check the version of glibc, because JDK >=15 requires\n+    # glibc 2.14\n+    LIBC_VERSION=\"$( getconf GNU_LIBC_VERSION | awk '{ if ($2 ~ /^[0-9.]*$/) { print $2; exit 0 } else { exit 1 } }' )\"\n+    if [[ $? -ne 0 ]]; then\n+      LIBC_VERSION=\"$( ldd --version | head -1 | awk '{ if ($4 ~ /^[0-9.]*$/) { print $4; exit 0 } else { exit 1 } }' )\"", "originalCommit": "de80305f724e874477a5099a400eb30fec1083ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "87367da508dced150d7875d2777f366716b1c185", "url": "https://github.com/elastic/elasticsearch/commit/87367da508dced150d7875d2777f366716b1c185", "message": "Simplify", "committedDate": "2020-09-21T19:54:40Z", "type": "commit"}, {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a", "url": "https://github.com/elastic/elasticsearch/commit/243a2066943392054cee0eb7ab4ba255d02f705a", "message": "Tweaks", "committedDate": "2020-09-21T20:03:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNTUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492315503", "bodyText": "Does this work? I thought the $? would be the result of the assignment, not the inner command?", "author": "rjernst", "createdAt": "2020-09-21T20:06:01Z", "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then", "originalCommit": "243a2066943392054cee0eb7ab4ba255d02f705a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMDUwNw==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492420507", "bodyText": "$? is the status of the most recent pipeline, and variable assignment is not a pipeline.\nSo, with respect to the assignment it works. e.g.\nbash -c 'False=$( false ) ; echo $? ; True=$(true) ; echo $?'\n1\n0\n\nHowever, it only works because the script sets pipefail, otherwise the status of getconf would be lost and we would be testing the status of cut (which would succeed).\nBack to lurk mode.\nSorry I spent years maintaining a system that had in excess of 10k lines of ksh code, some of this stuff is burned into my brain.", "author": "tvernum", "createdAt": "2020-09-22T00:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNTUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3ODI4NA==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492578284", "bodyText": "Thanks Tim! I've reworked the script to be more cautious, and also to stop performing floating point comparisons.", "author": "pugnascotia", "createdAt": "2020-09-22T08:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNTUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNjgwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492316805", "bodyText": "Is this doing a numeric comparison? Is it casting $1 to a float? Are there any floating point precision issues possible?", "author": "rjernst", "createdAt": "2020-09-21T20:08:39Z", "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then\n+    # Must be on a POSIX system that isn't using glibc.\n+    return 0\n+  fi\n+\n+  if echo \"$GLIBC_VERSION\" | awk '{ if ($1 >= 2.14) { exit 1 } else { exit 0 } }'; then", "originalCommit": "243a2066943392054cee0eb7ab4ba255d02f705a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91307273d54df8dbc61f18352b749fee208dd77d", "url": "https://github.com/elastic/elasticsearch/commit/91307273d54df8dbc61f18352b749fee208dd77d", "message": "Improvements", "committedDate": "2020-09-22T08:57:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMDkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492820914", "bodyText": "Would this say 3.1 was unacceptable?", "author": "droberts195", "createdAt": "2020-09-22T15:16:35Z", "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,35 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+# On systems that are built upon glibc, We need to check the version of\n+# glibc because Elasticsearch bundles JDK 15, which requires glibc >= 2.14\n+check_glibc_version() {\n+  local GETCONF=\"$( getconf GNU_LIBC_VERSION 2>/dev/null )\"\n+  if [[ $? -ne 0 ]]; then\n+    # Must be on a POSIX system that isn't using glibc.\n+    return 0\n+  fi\n+\n+  local GLIBC_VERSION=\"$( echo \"$GETCONF\" | cut -d' ' -f2 )\"\n+  local MAJOR=\"$( echo $GLIBC_VERSION | cut -d. -f1 )\"\n+  local MINOR=\"$( echo $GLIBC_VERSION | cut -d. -f2 )\"\n+\n+  if [[ \"$MAJOR\" -lt 2 || \"$MINOR\" -lt 14 ]]; then", "originalCommit": "91307273d54df8dbc61f18352b749fee208dd77d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwNjk5NA==", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492906994", "bodyText": "It would - I've reworked this logic.", "author": "pugnascotia", "createdAt": "2020-09-22T17:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMDkxNA=="}], "type": "inlineReview"}, {"oid": "631f22b4e4f6155d95d393fcc6d908cbb608713d", "url": "https://github.com/elastic/elasticsearch/commit/631f22b4e4f6155d95d393fcc6d908cbb608713d", "message": "Fix perms", "committedDate": "2020-09-22T17:14:32Z", "type": "commit"}, {"oid": "df4b1cd3169eae1854e7e7596e8f5dcf7adaefd5", "url": "https://github.com/elastic/elasticsearch/commit/df4b1cd3169eae1854e7e7596e8f5dcf7adaefd5", "message": "Tighten up version check", "committedDate": "2020-09-22T17:20:40Z", "type": "commit"}]}