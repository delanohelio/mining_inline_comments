{"pr_number": 60074, "pr_title": "Add aggregation list to node info", "pr_createdAt": "2020-07-22T17:58:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60074", "timeline": [{"oid": "65b93b30b38cfb6939be936baace8f0ac1d5cbaa", "url": "https://github.com/elastic/elasticsearch/commit/65b93b30b38cfb6939be936baace8f0ac1d5cbaa", "message": "Add aggregation list to node info\n\nThere are at least two use cases (transform tests and telemetry mapping\nupdated) in which we need to have an access to full list of supported\naggregations. This PR adds this list to the node info API.\n\nFixes #59774", "committedDate": "2020-07-22T17:30:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2MDkzMA==", "url": "https://github.com/elastic/elasticsearch/pull/60074#discussion_r459560930", "bodyText": "getProcessors() ? I assume the name is off, but is this even needed ?", "author": "jakelandis", "createdAt": "2020-07-23T16:03:47Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationInfo.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.aggregations;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.node.ReportingService;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.TreeMap;\n+import java.util.TreeSet;\n+\n+public class AggregationInfo implements ReportingService.Info {\n+\n+    private final Map<String, Set<String>> aggs;\n+\n+    public AggregationInfo(Map<String, Set<String>> aggs) {\n+        this.aggs = aggs;\n+    }\n+\n+    /**\n+     * Read from a stream.\n+     */\n+    public AggregationInfo(StreamInput in) throws IOException {\n+        aggs = new TreeMap<>();\n+        final int size = in.readVInt();\n+        for (int i = 0; i < size; i++) {\n+            String key = in.readString();\n+            final int keys = in.readVInt();\n+            final Set<String> types = new TreeSet<>();\n+            for (int j = 0; j < keys; j ++) {\n+                types.add(in.readString());\n+            }\n+            aggs.put(key, types);\n+        }\n+    }\n+\n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeVInt(aggs.size());\n+        for (Map.Entry<String, Set<String>> e : aggs.entrySet()) {\n+            out.writeString(e.getKey());\n+            out.writeVInt(e.getValue().size());\n+            for (String type : e.getValue()) {\n+                out.writeString(type);\n+            }\n+        }\n+    }\n+\n+    public Map<String, Set<String>> getProcessors() {", "originalCommit": "65b93b30b38cfb6939be936baace8f0ac1d5cbaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NzI1OA==", "url": "https://github.com/elastic/elasticsearch/pull/60074#discussion_r459587258", "bodyText": "Copy and paste error. Will fix.", "author": "imotov", "createdAt": "2020-07-23T16:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2MDkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2NzI5MA==", "url": "https://github.com/elastic/elasticsearch/pull/60074#discussion_r459567290", "bodyText": "this comment seems abit out of place, and probably shouldn't reference a private repo.\nalso, I guess I don't understand the output.  is it aggregrations.??.types = ?? . Is there anything that prevents checking for known types", "author": "jakelandis", "createdAt": "2020-07-23T16:14:02Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/nodes.info/40_aggs.yml", "diffHunk": "@@ -0,0 +1,20 @@\n+---\n+\"node_info test aggregations\":\n+  - skip:\n+      version: \" - 7.99.99\"\n+      reason: \"aggregation info only supported in 8.0.0+\"\n+      features: [arbitrary_key]\n+\n+\n+  - do:\n+      nodes.info: {}\n+  - set:\n+      nodes._arbitrary_key_: node_id\n+\n+  - do:\n+      nodes.info:\n+        metric: [ aggregations ]\n+\n+  # if this test failed because a new aggregation was added, please open an issues in the elastic/telemetry repository\n+  # so they can update the mapping accordingly", "originalCommit": "65b93b30b38cfb6939be936baace8f0ac1d5cbaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NzAyMA==", "url": "https://github.com/elastic/elasticsearch/pull/60074#discussion_r459587020", "bodyText": "I was sure I removed it. This comment is out of place. Good catch.", "author": "imotov", "createdAt": "2020-07-23T16:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2NzI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MzcyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60074#discussion_r459593729", "bodyText": "The output looks like this:\n      \"aggregations\" : {\n        \"adjacency_matrix\" : {\n          \"types\" : [\n            \"other\"\n          ]\n        },\n        \"auto_date_histogram\" : {\n          \"types\" : [\n            \"boolean\",\n            \"date\",\n            \"numeric\"\n          ]\n        },\n        \"avg\" : {\n          \"types\" : [\n            \"boolean\",\n            \"date\",\n            \"histogram\",\n            \"numeric\"\n          ]\n        },\n        \"boxplot\" : {\n          \"types\" : [\n            \"histogram\",\n            \"numeric\"\n          ]\n        },\n        \"cardinality\" : {\n          \"types\" : [\n            \"boolean\",\n            \"bytes\",\n            \"date\",\n            \"geopoint\",\n            \"geoshape\",\n            \"ip\",\n            \"numeric\",\n            \"range\"\n          ]\n        },\n        ....\n\nand both types and aggs change depending on license that this is ran under.", "author": "imotov", "createdAt": "2020-07-23T16:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2NzI5MA=="}], "type": "inlineReview"}, {"oid": "e371445c9f8f381257d5aab16dc0d3fb693ef192", "url": "https://github.com/elastic/elasticsearch/commit/e371445c9f8f381257d5aab16dc0d3fb693ef192", "message": "Address review comments", "committedDate": "2020-07-23T17:04:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcyMjY3NA==", "url": "https://github.com/elastic/elasticsearch/pull/60074#discussion_r459722674", "bodyText": "We're leaking a mutable reference here.  It doesn't look like we mutate it anywhere, might be worth wrapping it to be immutable, if the object creation cost for the wrapper isn't too much.", "author": "not-napoleon", "createdAt": "2020-07-23T20:55:30Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationInfo.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.aggregations;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.node.ReportingService;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.TreeMap;\n+import java.util.TreeSet;\n+\n+public class AggregationInfo implements ReportingService.Info {\n+\n+    private final Map<String, Set<String>> aggs;\n+\n+    public AggregationInfo(Map<String, Set<String>> aggs) {\n+        this.aggs = aggs;\n+    }\n+\n+    /**\n+     * Read from a stream.\n+     */\n+    public AggregationInfo(StreamInput in) throws IOException {\n+        aggs = new TreeMap<>();\n+        final int size = in.readVInt();\n+        for (int i = 0; i < size; i++) {\n+            String key = in.readString();\n+            final int keys = in.readVInt();\n+            final Set<String> types = new TreeSet<>();\n+            for (int j = 0; j < keys; j ++) {\n+                types.add(in.readString());\n+            }\n+            aggs.put(key, types);\n+        }\n+    }\n+\n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeVInt(aggs.size());\n+        for (Map.Entry<String, Set<String>> e : aggs.entrySet()) {\n+            out.writeString(e.getKey());\n+            out.writeVInt(e.getValue().size());\n+            for (String type : e.getValue()) {\n+                out.writeString(type);\n+            }\n+        }\n+    }\n+\n+    public Map<String, Set<String>> getAggregations() {\n+        return aggs;", "originalCommit": "e371445c9f8f381257d5aab16dc0d3fb693ef192", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c144955cecefc4521fff890f611fc6a55a2de25c", "url": "https://github.com/elastic/elasticsearch/commit/c144955cecefc4521fff890f611fc6a55a2de25c", "message": "Make AggregationInfo immutable", "committedDate": "2020-07-27T17:42:33Z", "type": "commit"}]}