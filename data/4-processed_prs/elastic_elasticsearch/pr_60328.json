{"pr_number": 60328, "pr_title": "Allows nanosecond resolution in search_after", "pr_createdAt": "2020-07-28T18:07:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60328", "timeline": [{"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13", "url": "https://github.com/elastic/elasticsearch/commit/69025d75003edb2b3ae77c1d928005bff56b5c13", "message": "Allows nanosecond resolution in search_after\n\nThis fixes `search_after` to properly parse string formatted dates that\nhave nanosecond resolution.\n\nCloses #52424", "committedDate": "2020-07-28T17:10:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461795056", "bodyText": "I wonder if we should use the formatted version in the sort output ? We don't allow this format (nanoseconds since epoch) when ingesting or querying a date_nanos field so that's an exception here.", "author": "jimczi", "createdAt": "2020-07-28T18:44:16Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/90_search_after.yml", "diffHunk": "@@ -94,3 +91,126 @@ setup:\n \n   - match: {hits.total: 3}\n   - length: {hits.hits: 0 }\n+\n+---\n+\"date\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+                format: yyyy-MM-dd HH:mm:ss.SSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571646604828] }\n+\n+  # search_after with the sort\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [1571646604828]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+  # search_after with the formatted date\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [\"2019-10-21 08:30:04.828\"]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+---\n+\"date_nanos\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date_nanos\n+                format: yyyy-MM-dd HH:mm:ss.SSSSSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828740\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828733\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828733\" }\n+  - match: {hits.hits.0.sort: [1571646604828733000] }", "originalCommit": "69025d75003edb2b3ae77c1d928005bff56b5c13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwOTU3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461809572", "bodyText": "I'm honestly not sure! I kind of figured the contact of search_after was \"take the last sort value and stick it into search_after\" but I see that we support formatted.\nI also wonder what counts as breaking here. If we were to change the result to be formatted I imagine we'll break someone.", "author": "nik9000", "createdAt": "2020-07-28T19:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyMDgwNg==", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461820806", "bodyText": "We do support formatted output so my point was that the sort section should return the formatted version in  order to avoid returning long that represents nanoseconds since epoch. I agree that this is not in the scope of this change so let's merge this one and we can discuss the formatting of sort values in a follow up (I can open the issue) ?", "author": "jimczi", "createdAt": "2020-07-28T19:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzMDk5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461830991", "bodyText": "I agree that this is not in the scope of this change so let's merge this one and we can discuss the formatting of sort values in a follow up (I can open the issue) ?\n\n\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-07-28T19:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTU1OA==", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461795558", "bodyText": "nit: because lots of ...", "author": "jimczi", "createdAt": "2020-07-28T18:45:08Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -440,6 +440,7 @@ public DocValueFormat docValueFormat(@Nullable String format, ZoneId timeZone) {\n             }\n             // the resolution here is always set to milliseconds, as aggregations use this formatter mainly and those are always in\n             // milliseconds. The only special case here is docvalue fields, which are handled somewhere else\n+            // TODO maybe aggs should force millis because lot so of other places want nanos?", "originalCommit": "69025d75003edb2b3ae77c1d928005bff56b5c13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a8fcba8a187c6ea27b24d852467b990101208a32", "url": "https://github.com/elastic/elasticsearch/commit/a8fcba8a187c6ea27b24d852467b990101208a32", "message": "Merge branch 'master' into allow_nano_resolution_in_search_after", "committedDate": "2020-07-28T20:14:40Z", "type": "commit"}, {"oid": "81beee7b367e4e9e85313f25cde9d5982a4e98c8", "url": "https://github.com/elastic/elasticsearch/commit/81beee7b367e4e9e85313f25cde9d5982a4e98c8", "message": "Iter", "committedDate": "2020-07-28T20:15:21Z", "type": "commit"}, {"oid": "b2988366e79e7e185981b237b30855d6f9859170", "url": "https://github.com/elastic/elasticsearch/commit/b2988366e79e7e185981b237b30855d6f9859170", "message": "Skip", "committedDate": "2020-07-28T21:43:41Z", "type": "commit"}]}