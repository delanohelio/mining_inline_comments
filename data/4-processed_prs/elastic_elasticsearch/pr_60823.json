{"pr_number": 60823, "pr_title": "Fix AOOBE when setting min_doc_count to 0 in significant_terms", "pr_createdAt": "2020-08-06T12:57:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60823", "timeline": [{"oid": "a7fa509f39d70e00aabbb4509f902b46b8c84b48", "url": "https://github.com/elastic/elasticsearch/commit/a7fa509f39d70e00aabbb4509f902b46b8c84b48", "message": "Fix AOOBE when setting min_doc_count to 0 in significant_terms\n\nThis commit fixes the computation of the subset size on empty buckets (doc count of 0).\nThe aggregator test refactoring in #60683 revealed this bug.", "committedDate": "2020-08-06T12:56:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxMDgzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60823#discussion_r466410831", "bodyText": "Maybe if the owningBucketOrd is not in the array that means the bucket is empty so the size has to be 0?", "author": "nik9000", "createdAt": "2020-08-06T13:27:11Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -833,13 +834,15 @@ void buildSubAggs(SignificantStringTerms.Bucket[][] topBucketsPreOrd) throws IOE\n \n         @Override\n         SignificantStringTerms buildResult(long owningBucketOrd, long otherDocCount, SignificantStringTerms.Bucket[] topBuckets) {\n+            // the subset size is missing for empty buckets (doc count of 0)\n+            long subsetSize = owningBucketOrd < subsetSizes.size() ? subsetSizes.get(owningBucketOrd) : 0;", "originalCommit": "a7fa509f39d70e00aabbb4509f902b46b8c84b48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMDkwMA==", "url": "https://github.com/elastic/elasticsearch/pull/60823#discussion_r466420900", "bodyText": "3ddfda3, thanks", "author": "jimczi", "createdAt": "2020-08-06T13:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxMDgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMTU3OA==", "url": "https://github.com/elastic/elasticsearch/pull/60823#discussion_r466421578", "bodyText": "Thank you!", "author": "nik9000", "createdAt": "2020-08-06T13:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxMDgzMQ=="}], "type": "inlineReview"}, {"oid": "3ddfda379e81e9fb655cd872c0cf577fe87f89f8", "url": "https://github.com/elastic/elasticsearch/commit/3ddfda379e81e9fb655cd872c0cf577fe87f89f8", "message": "address feedback", "committedDate": "2020-08-06T13:40:46Z", "type": "commit"}]}