{"pr_number": 65707, "pr_title": "Fix sneaky date_histogram bug", "pr_createdAt": "2020-12-01T21:50:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65707", "timeline": [{"oid": "bb00c91b134232fdad722a81fb8a4825b3a4d6be", "url": "https://github.com/elastic/elasticsearch/commit/bb00c91b134232fdad722a81fb8a4825b3a4d6be", "message": "Fix sneaky date_histogram bug\n\n`date_histogram` has a bug with `offset` and `extended_bounds` when it\nneeds to create an \"empty\" aggregation result: it includes the bounds\ntwice! Wooops!\n\nI broke this a while back when I started trying to merge `offset` into\n`Rounding`. I never finished that merge, sadly. Interestingly, we've\ndiscovered that the merge is required to properly handle daylight\nsavings time (#56305) but it isn't really something we're looking to\nsolve today. For now, this just stops counting the offset twice.\n\nCloses #65624", "committedDate": "2020-12-01T21:44:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1MTQ0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65707#discussion_r535251445", "bodyText": "This test needs a comment; it's a subtle bug, and it's not super clear how this test catches it.", "author": "not-napoleon", "createdAt": "2020-12-03T14:03:07Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorTests.java", "diffHunk": "@@ -1235,6 +1235,19 @@ public void testIllegalInterval() throws IOException {\n         assertWarnings(\"[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.\");\n     }\n \n+    public void testBuildEmpty() throws IOException {", "originalCommit": "bb00c91b134232fdad722a81fb8a4825b3a4d6be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7efcad9a5940f0018fc78509193ae0f802d69b9b", "url": "https://github.com/elastic/elasticsearch/commit/7efcad9a5940f0018fc78509193ae0f802d69b9b", "message": "Merge branch 'master' into empty_date_histo", "committedDate": "2020-12-07T17:38:14Z", "type": "commit"}, {"oid": "6cee4a16374b3bffb2539bcb4e011d9a3e65464c", "url": "https://github.com/elastic/elasticsearch/commit/6cee4a16374b3bffb2539bcb4e011d9a3e65464c", "message": "Test fixup", "committedDate": "2020-12-07T17:39:59Z", "type": "commit"}]}