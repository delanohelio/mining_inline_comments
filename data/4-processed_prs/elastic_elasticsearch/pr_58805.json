{"pr_number": 58805, "pr_title": "[6.8] Week based parsing for ingest date processor (#58597)", "pr_createdAt": "2020-07-01T08:23:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58805", "timeline": [{"oid": "8c482ad4a8357a285da8efdef38fcd10065c0fc9", "url": "https://github.com/elastic/elasticsearch/commit/8c482ad4a8357a285da8efdef38fcd10065c0fc9", "message": "Week based parsing for ingest date processor (#58597)\n\nDate processor was incorrectly parsing week based dates because when a\nweekbased year was provided ingest module was thinking year was not\non a date and was trying to applying the logic for dd/MM type of\ndates.\nDate Processor is also allowing users to specify locale parameter. It\nshould be taken into account when parsing dates - currently only used\nfor formatting. If someone specifies 'en-us' locale, then calendar data\nrules for that locale should be used.\nThe exception is iso8601 format. If someone is using that format,\nthen locale should not override calendar data rules.\ncloses #58479\n# Conflicts:\n#\tmodules/ingest-common/src/main/java/org/elasticsearch/ingest/common/DateFormat.java\n#\tmodules/ingest-common/src/test/resources/rest-api-spec/test/ingest/30_date_processor.yml\n#\tserver/src/main/java/org/elasticsearch/common/time/DateFormatters.java\n#\tserver/src/main/java/org/elasticsearch/common/time/IsoCalendarDataProvider.java\n#\tserver/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java\n#\tserver/src/main/java/org/elasticsearch/script/JodaCompatibleZonedDateTime.java", "committedDate": "2020-07-01T08:23:35Z", "type": "commit"}, {"oid": "5018a55783eff26fb2190b939464e7b3e8787b3b", "url": "https://github.com/elastic/elasticsearch/commit/5018a55783eff26fb2190b939464e7b3e8787b3b", "message": "compile and test", "committedDate": "2020-07-01T12:17:14Z", "type": "commit"}, {"oid": "9d4669eef12bdc179a73dbe08a5e3a957ee65869", "url": "https://github.com/elastic/elasticsearch/commit/9d4669eef12bdc179a73dbe08a5e3a957ee65869", "message": "do not change year vs year of era logic", "committedDate": "2020-07-01T12:45:58Z", "type": "commit"}, {"oid": "a772122acdf52f6a3101618552570c1e77625bb4", "url": "https://github.com/elastic/elasticsearch/commit/a772122acdf52f6a3101618552570c1e77625bb4", "message": "revert back white space changes", "committedDate": "2020-07-01T12:50:56Z", "type": "commit"}, {"oid": "79bdd576ca194b4affb4d867371e105beb7e001d", "url": "https://github.com/elastic/elasticsearch/commit/79bdd576ca194b4affb4d867371e105beb7e001d", "message": "known issue", "committedDate": "2020-07-01T14:17:47Z", "type": "commit"}, {"oid": "da8fc370756382e4f63737b937f3eddc7b2dc7a3", "url": "https://github.com/elastic/elasticsearch/commit/da8fc370756382e4f63737b937f3eddc7b2dc7a3", "message": "uk based test", "committedDate": "2020-07-01T15:12:55Z", "type": "commit"}, {"oid": "f3aa0c5647536dad0c30fffaa62a8d496c800b1b", "url": "https://github.com/elastic/elasticsearch/commit/f3aa0c5647536dad0c30fffaa62a8d496c800b1b", "message": "date format tests", "committedDate": "2020-07-01T15:22:47Z", "type": "commit"}, {"oid": "e4c02c47f6afc410cbf316b95e8533ab4f2857b0", "url": "https://github.com/elastic/elasticsearch/commit/e4c02c47f6afc410cbf316b95e8533ab4f2857b0", "message": "checkstyle", "committedDate": "2020-07-01T16:29:46Z", "type": "commit"}, {"oid": "957f294270344424995fc416e15ca12a04851532", "url": "https://github.com/elastic/elasticsearch/commit/957f294270344424995fc416e15ca12a04851532", "message": "remove joda pattern from test", "committedDate": "2020-07-02T06:38:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MDEzNg==", "url": "https://github.com/elastic/elasticsearch/pull/58805#discussion_r448650136", "bodyText": "This description is confusing. Is the bug fixed here or in 7.7.0?", "author": "rjernst", "createdAt": "2020-07-01T22:33:43Z", "path": "docs/reference/release-notes/6.8.asciidoc", "diffHunk": "@@ -34,6 +34,11 @@ This issue is fixed in Elasticsearch 6.8.10 and 7.7.1.\n \n Also see <<breaking-changes-6.8,Breaking changes in 6.8>>.\n \n+* Java based - formats with '8' prefix - week based parsing and calculations are using JDK default calendar data provider which is Sunday,1.\n+Sunday is considered first day of a week and it requires only 1 day in a week to for the first week of the year.\n+It can be worked around by using locale which is based on ISO8601 rule (Monday,4) - for instance en-GB\n+This issue is fixed in Elasticsearch 7.7 https://github.com/elastic/elasticsearch/pull/48209", "originalCommit": "e4c02c47f6afc410cbf316b95e8533ab4f2857b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI0NzAzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58805#discussion_r449247039", "bodyText": "fair point, I will try to rephrase this in another doc PR.\nPreviously the parsing would fail with exception.\nThis PR fixes the bug so that parsing does not fail, but is uses Sunday,1 rule. So results are slightly different around when the year or week starts.\nThe 'ultimate' fixes are in 7.7 when IsoCalendarDataProvider is used and -Djava.locale.providers=SPI,COMPAT is set in jvm options", "author": "pgomulka", "createdAt": "2020-07-02T20:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MDEzNg=="}], "type": "inlineReview"}]}