{"pr_number": 65400, "pr_title": "Add option to preserve data in test clusters", "pr_createdAt": "2020-11-23T23:58:55Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65400", "timeline": [{"oid": "1a4a6777de4a959e6538e7db9def6648c73c1967", "url": "https://github.com/elastic/elasticsearch/commit/1a4a6777de4a959e6538e7db9def6648c73c1967", "message": "Add option to preserve data in test clusters", "committedDate": "2020-11-23T23:57:23Z", "type": "commit"}, {"oid": "e83c9189fcf6e3e00ef79468fd47791153266768", "url": "https://github.com/elastic/elasticsearch/commit/e83c9189fcf6e3e00ef79468fd47791153266768", "message": "Checkstyle fixes", "committedDate": "2020-11-24T00:14:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQzNDA0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65400#discussion_r529434048", "bodyText": "Why do we need the special eql variable and not use --preserve-data ?", "author": "matriv", "createdAt": "2020-11-24T10:40:49Z", "path": "x-pack/plugin/eql/qa/correctness/README.md", "diffHunk": "@@ -85,3 +85,10 @@ Once the data is loaded, a specific query can be run against the running ES node\n ```\n \n **Set the `eql_test_credentials_file` environmental variable correctly in the shell before running the command above,**\n+\n+#### Preserve data across node restarts\n+If you'd like to preserve the restored index and avoid the network download and delay of restoring them on every run of the node,\n+you can set the `eql.test.preserve.data` system property, e.g.:\n+```shell script\n+./gradlew :x-pack:plugin:eql:qa:correctness:javaRestTest -Deql.test.preserve.data=true", "originalCommit": "e83c9189fcf6e3e00ef79468fd47791153266768", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYxNjE0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65400#discussion_r529616142", "bodyText": "I also tried it with -Deql.test.preserve.data=true and doesn't work, where with --preserve-data works.\nI think the issue is:\nif (Boolean.parseBoolean(System.getProperty('eql.test.preserve.data', 'false'))) {\n->  preserveDataDir = true\n}\n\nthis doesn't seem to set the variable correctly, but again I think we can just use --preserve-date and not add a custom variable for this project.", "author": "matriv", "createdAt": "2020-11-24T15:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQzNDA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2NDQ0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65400#discussion_r529764449", "bodyText": "Using --preserve-data is only when using the run task. So that's when running the runEqlCorrectnessNode, if running javaRestTest you need to use the system property. The difference is because they are two different implementations.", "author": "mark-vieira", "createdAt": "2020-11-24T17:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQzNDA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc3MzQ5MA==", "url": "https://github.com/elastic/elasticsearch/pull/65400#discussion_r529773490", "bodyText": "Ah, I see, I mixed it, let me just double check, thx!", "author": "matriv", "createdAt": "2020-11-24T18:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQzNDA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwOTM5MA==", "url": "https://github.com/elastic/elasticsearch/pull/65400#discussion_r529809390", "bodyText": "I think it's better to move this paragraph before ### Run an ES node manually and run the tests against it\nand add a new paragraph here at the end to mention the --preserve-data for the ./gradlew :x-pack:plugin:eql:qa:correctness:runEqlCorrectnessNode:\n#### Preserve data across node restarts\nIf you'd like to preserve the restored index and avoid the network download and delay of restoring them on every run of the node, you can start the node with:\n\n```shell script\n./gradlew :x-pack:plugin:eql:qa:correctness:runEqlCorrectnessNode --debug-jvm --preserve-data\n```\n\nI could do it myself in a followup PR though.", "author": "matriv", "createdAt": "2020-11-24T18:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQzNDA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcxNzU2MA==", "url": "https://github.com/elastic/elasticsearch/pull/65400#discussion_r529717560", "bodyText": "Can we use provider.systemProperty(...) here to slowly move towards gradle configuration cache compliant builds? System.getProperty isn't", "author": "breskeby", "createdAt": "2020-11-24T16:38:00Z", "path": "x-pack/plugin/eql/qa/correctness/build.gradle", "diffHunk": "@@ -28,6 +28,9 @@ testClusters {\n     if (serviceAccountFile) {\n       keystore 'gcs.client.eql_test.credentials_file', serviceAccountFile\n     }\n+    if (Boolean.parseBoolean(System.getProperty('eql.test.preserve.data', 'false'))) {", "originalCommit": "e83c9189fcf6e3e00ef79468fd47791153266768", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc3Mzg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/65400#discussion_r529773888", "bodyText": "Good call. I've updated the logic for finding the service account file as well.", "author": "mark-vieira", "createdAt": "2020-11-24T18:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcxNzU2MA=="}], "type": "inlineReview"}, {"oid": "07b0ff3081b1a3652180ee3147f8146c9477c7e0", "url": "https://github.com/elastic/elasticsearch/commit/07b0ff3081b1a3652180ee3147f8146c9477c7e0", "message": "Use providers for configuration time system property access", "committedDate": "2020-11-24T18:00:59Z", "type": "commit"}, {"oid": "2c72d0791a22d7d172936465a8bb6d1b290eef67", "url": "https://github.com/elastic/elasticsearch/commit/2c72d0791a22d7d172936465a8bb6d1b290eef67", "message": "Merge branch 'master' into preserve-test-cluster-data", "committedDate": "2020-11-24T18:19:43Z", "type": "commit"}]}