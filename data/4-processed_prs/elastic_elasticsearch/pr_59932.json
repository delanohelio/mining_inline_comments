{"pr_number": 59932, "pr_title": "Thread safe clean up of LocalNodeModeListeners", "pr_createdAt": "2020-07-20T20:24:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59932", "timeline": [{"oid": "f9d3af4f1b927a4c5eccf71e7c9b714d4c7f8e04", "url": "https://github.com/elastic/elasticsearch/commit/f9d3af4f1b927a4c5eccf71e7c9b714d4c7f8e04", "message": "Thread safe clean up of LocalNodeModeListeners\n\nThis commit continues on the work in #59801 and makes other\nimplementors of the `LocalNodeMasterListener` interface thread safe in\nthat they will no longer allow the callbacks to run on different\nthreads and possibly race each other. This also helps address other\nissues where these events could be queued to wait for execution while\nthe service keeps moving forward thinking it is the master even when\nthat is not the case.\n\nIn order to accomplish this, the `LocalNodeMasterListener` now provides\na default implementation of the `executorName()` and the javadocs have\nbeen updated to indicate the dangers of using an executor that could\nexecute the listeners concurrently.\n\nEach use was inspected and if the class was also a\n`ClusterStateListener`, the implementation of `LocalNodeMasterListener`\nwas removed in favor of a single listener that combined the logic. A\nsingle listener is used and there is currently no guarantee on execution\norder between `ClusterStateListener`s and `LocalNodeMasterListener`s,\nso a future change there could cause undesired consequences. For other\nclasses, the implementations of the callbacks were inspected and if the\noperations were lightweight, the overriden `executorName` method was\nremoved to use the default, which runs on the same thread.", "committedDate": "2020-07-20T20:06:17Z", "type": "commit"}, {"oid": "3c9142bbcdf64264e8483dc4b736f38e9bdeffbd", "url": "https://github.com/elastic/elasticsearch/commit/3c9142bbcdf64264e8483dc4b736f38e9bdeffbd", "message": "Merge branch 'master' into cleanup_localnode_listeners", "committedDate": "2020-07-21T16:06:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNzE2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458217166", "bodyText": "Sorry for the conflicts with #59880, but I think we need this line still.", "author": "DaveCTurner", "createdAt": "2020-07-21T16:09:25Z", "path": "server/src/main/java/org/elasticsearch/cluster/InternalClusterInfoService.java", "diffHunk": "@@ -111,9 +111,6 @@ public InternalClusterInfoService(Settings settings, ClusterService clusterServi\n         clusterSettings.addSettingsUpdateConsumer(INTERNAL_CLUSTER_INFO_UPDATE_INTERVAL_SETTING, this::setUpdateFrequency);\n         clusterSettings.addSettingsUpdateConsumer(DiskThresholdSettings.CLUSTER_ROUTING_ALLOCATION_DISK_THRESHOLD_ENABLED_SETTING,\n                                                   this::setEnabled);\n-\n-        // listen for state changes (this node starts/stops being the elected master, or new nodes are added)\n-        clusterService.addListener(this);", "originalCommit": "3c9142bbcdf64264e8483dc4b736f38e9bdeffbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxOTc1NA==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458219754", "bodyText": "Oh wait, no I see this got moved to Node. That's nicer indeed but I expect InternalClusterInfoServiceSchedulingTests need adjusting too.", "author": "DaveCTurner", "createdAt": "2020-07-21T16:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNzE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3NzQ4NA==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458277484", "bodyText": "No need to apologize. Addressed in 59a7fee", "author": "jaymode", "createdAt": "2020-07-21T17:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNzE2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyMjc5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458222796", "bodyText": "This looks never to be overridden, can we inline it (and simplify threadPool.executor(SAME).execute(r) to r.run() in the ClusterApplierService?", "author": "DaveCTurner", "createdAt": "2020-07-21T16:17:41Z", "path": "server/src/main/java/org/elasticsearch/cluster/LocalNodeMasterListener.java", "diffHunk": "@@ -37,16 +39,20 @@\n     /**\n      * The name of the executor that the implementation of the callbacks of this lister should be executed on. The thread\n      * that is responsible for managing instances of this lister is the same thread handling the cluster state events. If\n-     * the work done is the callbacks above is inexpensive, this value may be\n+     * the work done is the callbacks above is inexpensive, this value should be\n      * {@link org.elasticsearch.threadpool.ThreadPool.Names#SAME SAME} (indicating that the callbacks will run on the same thread\n      * as the cluster state events are fired with). On the other hand, if the logic in the callbacks are heavier and take\n      * longer to process (or perhaps involve blocking due to IO operations), prefer to execute them on a separate more appropriate\n-     * executor (eg. {@link org.elasticsearch.threadpool.ThreadPool.Names#GENERIC GENERIC}\n-     * or {@link org.elasticsearch.threadpool.ThreadPool.Names#MANAGEMENT MANAGEMENT}).\n+     * executor; for example management operations would use {@link org.elasticsearch.threadpool.ThreadPool.Names#MANAGEMENT MANAGEMENT}).\n+     *\n+     * <em>Note</em>: when using an executor with more than one thread the callbacks <i>could</i> run concurrently, so care\n+     * should be taken to ensure proper locking is used for correctness.\n      *\n      * @return The name of the executor that will run the callbacks of this listener.\n      */\n-    String executorName();\n+    default String executorName() {", "originalCommit": "3c9142bbcdf64264e8483dc4b736f38e9bdeffbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3NzcxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458277715", "bodyText": "Addressed in 63be6ab", "author": "jaymode", "createdAt": "2020-07-21T17:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyMjc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyNDY1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458224656", "bodyText": "We use this executor to run MlMemoryTracker#refresh and MlMemoryTracker #iterateAnomalyDetectorJobTasks, are you sure it's ok to run them on the SAME thread now?", "author": "DaveCTurner", "createdAt": "2020-07-21T16:20:31Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/process/MlMemoryTracker.java", "diffHunk": "@@ -131,11 +130,6 @@ public void stop() {\n         logger.debug(\"ML memory tracker stopped\");\n     }\n \n-    @Override\n-    public String executorName() {", "originalCommit": "3c9142bbcdf64264e8483dc4b736f38e9bdeffbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3ODA4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458278087", "bodyText": "Great catch! Addressed in d308721", "author": "jaymode", "createdAt": "2020-07-21T17:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyNDY1Ng=="}], "type": "inlineReview"}, {"oid": "59a7feee7cc2ec9ce13f353a3af798e6eaa06116", "url": "https://github.com/elastic/elasticsearch/commit/59a7feee7cc2ec9ce13f353a3af798e6eaa06116", "message": "update after changes from #59880", "committedDate": "2020-07-21T17:00:21Z", "type": "commit"}, {"oid": "d30872145f375f109ed20e2d26db6946436c3b4e", "url": "https://github.com/elastic/elasticsearch/commit/d30872145f375f109ed20e2d26db6946436c3b4e", "message": "MlMemoryTracker executes on utility thread pool still", "committedDate": "2020-07-21T17:03:29Z", "type": "commit"}, {"oid": "63be6ab56326f0a496a33588730130aa227bb45f", "url": "https://github.com/elastic/elasticsearch/commit/63be6ab56326f0a496a33588730130aa227bb45f", "message": "no more executorName!!!!!", "committedDate": "2020-07-21T17:42:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI3Nzg2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59932#discussion_r458277869", "bodyText": "Hurrah \ud83c\udf89", "author": "DaveCTurner", "createdAt": "2020-07-21T17:45:12Z", "path": "server/src/main/java/org/elasticsearch/cluster/LocalNodeMasterListener.java", "diffHunk": "@@ -33,20 +33,5 @@\n      * Called when the local node used to be the master, a new master was elected and it's no longer the local node.\n      */\n     void offMaster();\n-\n-    /**\n-     * The name of the executor that the implementation of the callbacks of this lister should be executed on. The thread\n-     * that is responsible for managing instances of this lister is the same thread handling the cluster state events. If\n-     * the work done is the callbacks above is inexpensive, this value may be\n-     * {@link org.elasticsearch.threadpool.ThreadPool.Names#SAME SAME} (indicating that the callbacks will run on the same thread\n-     * as the cluster state events are fired with). On the other hand, if the logic in the callbacks are heavier and take\n-     * longer to process (or perhaps involve blocking due to IO operations), prefer to execute them on a separate more appropriate\n-     * executor (eg. {@link org.elasticsearch.threadpool.ThreadPool.Names#GENERIC GENERIC}\n-     * or {@link org.elasticsearch.threadpool.ThreadPool.Names#MANAGEMENT MANAGEMENT}).\n-     *\n-     * @return The name of the executor that will run the callbacks of this listener.\n-     */\n-    String executorName();", "originalCommit": "63be6ab56326f0a496a33588730130aa227bb45f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}