{"pr_number": 63399, "pr_title": "Rename QueryShardContext#fieldMapper to getFieldType", "pr_createdAt": "2020-10-07T12:27:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63399", "timeline": [{"oid": "a3e9d240b908dee7f9b898f8389dc76eaf9c29bf", "url": "https://github.com/elastic/elasticsearch/commit/a3e9d240b908dee7f9b898f8389dc76eaf9c29bf", "message": "Rename QueryShardContext#fieldMapper to getFieldType\n\nGiven that we have a class called `FieldMapper` and that the `fieldMapper` method exposed by `QueryShardContext` actually allows to get a `MappedFieldType` given its name, this commit renames such method to `getFieldType`", "committedDate": "2020-10-07T12:23:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3Mjk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63399#discussion_r500972993", "bodyText": "I find some of these usages suspicious: do they really mean to check if the returned field type is null after the unmapped fields handling (unmapped fields may get mapped as text), or would they rather need to call isFieldMapped ?", "author": "javanna", "createdAt": "2020-10-07T12:31:39Z", "path": "server/src/main/java/org/elasticsearch/index/query/DistanceFeatureQueryBuilder.java", "diffHunk": "@@ -108,7 +108,7 @@ public String getWriteableName() {\n \n     @Override\n     protected Query doToQuery(QueryShardContext context) throws IOException {\n-        MappedFieldType fieldType = context.fieldMapper(field);\n+        MappedFieldType fieldType = context.getFieldType(field);", "originalCommit": "a3e9d240b908dee7f9b898f8389dc76eaf9c29bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NTg1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63399#discussion_r500975859", "bodyText": "I'm pretty sure these should be calling isFieldMapped.  We should maybe think about moving the unmapped field handling out of QueryShardContext and have it at the callsites that really need it? It's a bit too magic otherwise.", "author": "romseygeek", "createdAt": "2020-10-07T12:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3Mjk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NjI3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63399#discussion_r500976273", "bodyText": "Basically everywhere that does this null check should be calling isMapped instead.", "author": "romseygeek", "createdAt": "2020-10-07T12:36:46Z", "path": "server/src/main/java/org/elasticsearch/index/query/FieldMaskingSpanQueryBuilder.java", "diffHunk": "@@ -152,7 +152,7 @@ public static FieldMaskingSpanQueryBuilder fromXContent(XContentParser parser) t\n     @Override\n     protected SpanQuery doToQuery(QueryShardContext context) throws IOException {\n         String fieldInQuery = fieldName;\n-        MappedFieldType fieldType = context.fieldMapper(fieldName);\n+        MappedFieldType fieldType = context.getFieldType(fieldName);\n         if (fieldType != null) {\n             fieldInQuery = fieldType.name();\n         }", "originalCommit": "a3e9d240b908dee7f9b898f8389dc76eaf9c29bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3ODg5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63399#discussion_r500978895", "bodyText": "These assertions look dodgy (I think I put them in in the first place, so I'm allowed to say that).  It should be throwing an error if passed a field that doesn't exist or doesn't support text searches.", "author": "romseygeek", "createdAt": "2020-10-07T12:41:03Z", "path": "server/src/main/java/org/elasticsearch/index/query/IntervalsSourceProvider.java", "diffHunk": "@@ -147,7 +147,7 @@ public IntervalsSource getSource(QueryShardContext context, MappedFieldType fiel\n             }\n             IntervalsSource source;\n             if (useField != null) {\n-                fieldType = context.fieldMapper(useField);\n+                fieldType = context.getFieldType(useField);\n                 assert fieldType != null;", "originalCommit": "a3e9d240b908dee7f9b898f8389dc76eaf9c29bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}