{"pr_number": 54933, "pr_title": "Prevent putting V2 index template when overlapping with existing template", "pr_createdAt": "2020-04-07T23:14:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54933", "timeline": [{"oid": "3e8d3d3711758e0edef0a7a765e791fc99dadefd", "url": "https://github.com/elastic/elasticsearch/commit/3e8d3d3711758e0edef0a7a765e791fc99dadefd", "message": "Prevent putting V2 index template when overlapping with existing template\n\nThis change prevents putting V2 index template when it would overlap with existing V2 template\nof the same priority\n\nRelates to #53101", "committedDate": "2020-04-07T23:08:16Z", "type": "commit"}, {"oid": "d56ec4bd41efe2bdfdd452a86e4f2af7fb7a8796", "url": "https://github.com/elastic/elasticsearch/commit/d56ec4bd41efe2bdfdd452a86e4f2af7fb7a8796", "message": "removed unneeded change", "committedDate": "2020-04-07T23:13:55Z", "type": "commit"}, {"oid": "30d2dbdb19d3a8e8a3d4c656ec52db152bd6eb43", "url": "https://github.com/elastic/elasticsearch/commit/30d2dbdb19d3a8e8a3d4c656ec52db152bd6eb43", "message": "long line fixeD", "committedDate": "2020-04-07T23:28:57Z", "type": "commit"}, {"oid": "f4fcdc8d4712a83eab42a5b31c48dc6256d97977", "url": "https://github.com/elastic/elasticsearch/commit/f4fcdc8d4712a83eab42a5b31c48dc6256d97977", "message": "long line fixed", "committedDate": "2020-04-08T09:54:42Z", "type": "commit"}, {"oid": "9f3732abcf3c9ba05d3a899d8423f935dc3d312c", "url": "https://github.com/elastic/elasticsearch/commit/9f3732abcf3c9ba05d3a899d8423f935dc3d312c", "message": "fix npe during sort", "committedDate": "2020-04-08T10:10:20Z", "type": "commit"}, {"oid": "644a3878d573c08cc4909addf8fe8b9836971dfc", "url": "https://github.com/elastic/elasticsearch/commit/644a3878d573c08cc4909addf8fe8b9836971dfc", "message": "Revert \"fix npe during sort\"\n\nThis reverts commit 9f3732abcf3c9ba05d3a899d8423f935dc3d312c.", "committedDate": "2020-04-08T10:19:55Z", "type": "commit"}, {"oid": "5a89cb2f6416a288e221474ea6478d3f25890d0a", "url": "https://github.com/elastic/elasticsearch/commit/5a89cb2f6416a288e221474ea6478d3f25890d0a", "message": "Merge branch 'master' into prevent-overlapping-v2-templates", "committedDate": "2020-04-08T10:43:47Z", "type": "commit"}, {"oid": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875", "url": "https://github.com/elastic/elasticsearch/commit/ae9dcc7428c969ef8c5346e5a4cb552ca007a875", "message": "Merge branch 'master' into prevent-overlapping-v2-templates", "committedDate": "2020-04-08T11:47:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1OTIwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r405659209", "bodyText": "Super minor nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(checkPriority == false || Objects.equals(priority, template.priority())) {\n          \n          \n            \n                            if (checkPriority == false || Objects.equals(priority, template.priority())) {", "author": "dakrone", "createdAt": "2020-04-08T16:35:22Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -385,16 +400,27 @@ ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean c\n      */\n     static Map<String, List<String>> findConflictingV2Templates(final ClusterState state, final String candidateName,\n                                                                 final List<String> indexPatterns) {\n+        return findConflictingV2Templates(state, candidateName, indexPatterns, false, null);\n+    }\n+\n+    /**\n+     * Return a map of v2 template names to their index patterns for v2 templates that would overlap\n+     * with the given template's index patterns.\n+     */\n+    static Map<String, List<String>> findConflictingV2Templates(final ClusterState state, final String candidateName,\n+                                                                final List<String> indexPatterns, boolean checkPriority, Long priority) {\n         Automaton v1automaton = Regex.simpleMatchToAutomaton(indexPatterns.toArray(Strings.EMPTY_ARRAY));\n         Map<String, List<String>> overlappingTemplates = new HashMap<>();\n         for (Map.Entry<String, IndexTemplateV2> entry : state.metadata().templatesV2().entrySet()) {\n             String name = entry.getKey();\n             IndexTemplateV2 template = entry.getValue();\n             Automaton v2automaton = Regex.simpleMatchToAutomaton(template.indexPatterns().toArray(Strings.EMPTY_ARRAY));\n             if (Operations.isEmpty(Operations.intersection(v1automaton, v2automaton)) == false) {\n-                logger.debug(\"old template {} and index template {} would overlap: {} <=> {}\",\n-                    candidateName, name, indexPatterns, template.indexPatterns());\n-                overlappingTemplates.put(name, template.indexPatterns());\n+                if(checkPriority == false || Objects.equals(priority, template.priority())) {", "originalCommit": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r405660645", "bodyText": "I think we can be a little more explicit with what the user needs to do, maybe something like:\nindex template [foo] has index patterns [bar*] matching patterns from existing templates [baz] with patterns (bar*) that have the same priority [5], multiple index templates may not match during index creation, please use a different priority\n\nWhat do you think?", "author": "dakrone", "createdAt": "2020-04-08T16:37:40Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -305,7 +305,22 @@ ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean c\n             throw new IllegalArgumentException(\"index template [\" + name + \"] already exists\");\n         }\n \n-        Map<String, List<String>> overlaps = findConflictingV1Templates(currentState, name, template.indexPatterns());\n+        Map<String, List<String>> overlaps = findConflictingV2Templates(currentState, name, template.indexPatterns(), true,\n+            template.priority());\n+        if (overlaps.size() > 0) {\n+            String error = String.format(Locale.ROOT, \"index template [%s] has index patterns %s matching patterns from \" +\n+                    \"existing templates [%s] with patterns (%s) that have the same priority [%d]\",", "originalCommit": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NjkwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r406456900", "bodyText": "Good idea, I'll use that", "author": "probakowski", "createdAt": "2020-04-09T20:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MjU3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r405662571", "bodyText": "It's suuuuper unlikely, but this might be better as:\nIndexTemplateV2 newTemplate = randomValueOtherThanMany(t -> Objects.equals(template.priority(), t.priority(), () -> IndexTemplateV2Tests.randomInstance());\nTo prevent generating a new template that accidentally has the same index patterns and priority (highly unlikely but not impossible)", "author": "dakrone", "createdAt": "2020-04-08T16:40:43Z", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateServiceTests.java", "diffHunk": "@@ -301,12 +301,14 @@ public void testAddIndexTemplateV2() throws Exception {\n         assertNotNull(state.metadata().templatesV2().get(\"foo\"));\n         assertTemplatesEqual(state.metadata().templatesV2().get(\"foo\"), template);\n \n+        IndexTemplateV2 newTemplate = IndexTemplateV2Tests.randomInstance();", "originalCommit": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NjgwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r406456801", "bodyText": "Good idea, changed", "author": "probakowski", "createdAt": "2020-04-09T20:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MjU3MQ=="}], "type": "inlineReview"}, {"oid": "d750d3b7b627c8509f896d5cebb1c2f8ccd5086f", "url": "https://github.com/elastic/elasticsearch/commit/d750d3b7b627c8509f896d5cebb1c2f8ccd5086f", "message": "Merge branch 'master' into prevent-overlapping-v2-templates", "committedDate": "2020-04-08T22:52:29Z", "type": "commit"}, {"oid": "eb0ba5f74577cdf8a0cf3c9e419a070d1005db29", "url": "https://github.com/elastic/elasticsearch/commit/eb0ba5f74577cdf8a0cf3c9e419a070d1005db29", "message": "Update server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n\nCo-Authored-By: Lee Hinman <dakrone@users.noreply.github.com>", "committedDate": "2020-04-09T07:53:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExODM3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r406118377", "bodyText": "do we still need this? would we ever want to find the conflicting templates without checking the priority?", "author": "andreidan", "createdAt": "2020-04-09T10:45:34Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -385,16 +400,27 @@ ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean c\n      */\n     static Map<String, List<String>> findConflictingV2Templates(final ClusterState state, final String candidateName,", "originalCommit": "eb0ba5f74577cdf8a0cf3c9e419a070d1005db29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIxMDE5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r406210199", "bodyText": "This is used when adding V1 templates, when any overlapping V2 template raises warning, despite its priority", "author": "probakowski", "createdAt": "2020-04-09T13:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExODM3Nw=="}], "type": "inlineReview"}, {"oid": "c9c7b6515377c559b1486c2aa3fedb67dea505e2", "url": "https://github.com/elastic/elasticsearch/commit/c9c7b6515377c559b1486c2aa3fedb67dea505e2", "message": "review comments", "committedDate": "2020-04-09T20:24:33Z", "type": "commit"}, {"oid": "5452c2f0db0a990341122681571358f548f9bb03", "url": "https://github.com/elastic/elasticsearch/commit/5452c2f0db0a990341122681571358f548f9bb03", "message": "Merge branch 'master' into prevent-overlapping-v2-templates", "committedDate": "2020-04-09T22:04:45Z", "type": "commit"}, {"oid": "0e1bb62b08d9196c6def338d5e3e80cdde5673fe", "url": "https://github.com/elastic/elasticsearch/commit/0e1bb62b08d9196c6def338d5e3e80cdde5673fe", "message": "unused import", "committedDate": "2020-04-09T22:51:34Z", "type": "commit"}]}