{"pr_number": 60315, "pr_title": "[ML] require alias when indexing to an alias that should be created", "pr_createdAt": "2020-07-28T16:30:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60315", "timeline": [{"oid": "2e9183da683ab6cbe59743a2cb0dbbc225962c19", "url": "https://github.com/elastic/elasticsearch/commit/2e9183da683ab6cbe59743a2cb0dbbc225962c19", "message": "[ML] require alias when indexing to an alias that should be created", "committedDate": "2020-07-28T16:24:55Z", "type": "commit"}, {"oid": "3d586a15181ac8446f1b244f3dd7f1f49ab1815f", "url": "https://github.com/elastic/elasticsearch/commit/3d586a15181ac8446f1b244f3dd7f1f49ab1815f", "message": "Merge branch 'master' into feature/ml-prevent-index-auto-creation", "committedDate": "2020-07-28T19:59:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMDY5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462100693", "bodyText": "Just to make sure: would you also like to add the requireAlias(true) to the index requests in integration tests (like RevertModelSnapshotIT.java in line 217)? Or do you find it unnecessary?", "author": "przemekwitek", "createdAt": "2020-07-29T07:39:48Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/annotations/AnnotationPersister.java", "diffHunk": "@@ -74,7 +74,7 @@ public Builder bulkPersisterBuilder(String jobId) {\n     public class Builder {\n \n         private final String jobId;\n-        private BulkRequest bulkRequest = new BulkRequest(AnnotationIndex.WRITE_ALIAS_NAME);\n+        private BulkRequest bulkRequest = new BulkRequest(AnnotationIndex.WRITE_ALIAS_NAME).requireAlias(true);", "originalCommit": "3d586a15181ac8446f1b244f3dd7f1f49ab1815f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzNTM1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462235352", "bodyText": "I did not really think about adding it to integration tests. I can look in there and see whats up.", "author": "benwtrent", "createdAt": "2020-07-29T11:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMDY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MDQ5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462240497", "bodyText": "@przemekwitek added the value to our integration tests as well.", "author": "benwtrent", "createdAt": "2020-07-29T11:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMDY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMjI2NA==", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462102264", "bodyText": "One concern I have about this pattern of figuring out the value of requireAlias is that we need to be very careful to provide it with the right value as there is nothing (other than reading the code ;)) that could help us here.\nIdeally, I would like to see AnomalyDetectorsIndex.jobStateIndexWriteAlias() (and other methods of this kind) return a tuple (AliasOrIndex) with two fields: name and isAlias. This way the two pieces of information would be bundled together.\nHowever, this may be a big code change and the benefits are not easy to measure.\nAlternatively, you could have a local variable boolean requireAlias initialized to true in line 296 and set to false in line 298. This way, the decisions whether to use alias or index and whether to require alias would be logically grouped.", "author": "przemekwitek", "createdAt": "2020-07-29T07:42:37Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsTask.java", "diffHunk": "@@ -299,6 +299,7 @@ static void persistProgress(Client client, String jobId, Runnable runnable) {\n                 }\n                 IndexRequest indexRequest = new IndexRequest(indexOrAlias)\n                     .id(progressDocId)\n+                    .setRequireAlias(AnomalyDetectorsIndex.jobStateIndexWriteAlias().equals(indexOrAlias))", "originalCommit": "3d586a15181ac8446f1b244f3dd7f1f49ab1815f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxMTc3MA==", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462211770", "bodyText": "Note that AnomalyDetectorsIndex.jobStateIndexWriteAlias() always returns the alias. The issue here is that if we detect existing docs we want to overwrite them in the same index they exist rather than where the alias currently points at.", "author": "dimitris-athanasiou", "createdAt": "2020-07-29T10:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMjI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzNTE5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462235192", "bodyText": "I think the core issue here is the \"index or alias\" check, not what our original methods return. Callers of the method know they are getting an alias and should handle it accordingly.\nHere, we don't know because we searched for the concrete index name as well.", "author": "benwtrent", "createdAt": "2020-07-29T11:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMjI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0OTUwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462249509", "bodyText": "Sure, the jobStateIndexWriteAlias method cannot know that.\nI was just thinking out loud whether some additional encapsulation would make the code cleaner but I don't see an easy way to fix it.", "author": "przemekwitek", "createdAt": "2020-07-29T12:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMjI2NA=="}], "type": "inlineReview"}, {"oid": "d873de76f19de271f79781958869db01f2e57c26", "url": "https://github.com/elastic/elasticsearch/commit/d873de76f19de271f79781958869db01f2e57c26", "message": "adding require alias to integration tests as well", "committedDate": "2020-07-29T11:51:50Z", "type": "commit"}]}