{"pr_number": 61302, "pr_title": "Add data.path fast path for FilePermission", "pr_createdAt": "2020-08-18T22:21:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61302", "timeline": [{"oid": "70689c3fa1dc83f289a5e005593dad73f50b3824", "url": "https://github.com/elastic/elasticsearch/commit/70689c3fa1dc83f289a5e005593dad73f50b3824", "message": "Changes", "committedDate": "2020-08-12T22:00:02Z", "type": "commit"}, {"oid": "3ad36848f17809f6a008d434aaa6d2e545e24c45", "url": "https://github.com/elastic/elasticsearch/commit/3ad36848f17809f6a008d434aaa6d2e545e24c45", "message": "WIP", "committedDate": "2020-08-13T16:43:11Z", "type": "commit"}, {"oid": "4568abc6441cbe88c2aa888a97df90df5b40fb6a", "url": "https://github.com/elastic/elasticsearch/commit/4568abc6441cbe88c2aa888a97df90df5b40fb6a", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path", "committedDate": "2020-08-18T17:44:19Z", "type": "commit"}, {"oid": "7db7a45f1d16d32689c8597472cdc6bc6514df33", "url": "https://github.com/elastic/elasticsearch/commit/7db7a45f1d16d32689c8597472cdc6bc6514df33", "message": "Changes", "committedDate": "2020-08-18T21:04:42Z", "type": "commit"}, {"oid": "87bcaa852ea72bf10ba6dbaa148275c7613f257e", "url": "https://github.com/elastic/elasticsearch/commit/87bcaa852ea72bf10ba6dbaa148275c7613f257e", "message": "Change", "committedDate": "2020-08-18T22:16:53Z", "type": "commit"}, {"oid": "b9b751a75a845687e7b1f3040f5d3b3efedc2bef", "url": "https://github.com/elastic/elasticsearch/commit/b9b751a75a845687e7b1f3040f5d3b3efedc2bef", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path", "committedDate": "2020-08-18T22:57:51Z", "type": "commit"}, {"oid": "a07a6ce0b9a418ed52bd1e00e53c81baf32cf054", "url": "https://github.com/elastic/elasticsearch/commit/a07a6ce0b9a418ed52bd1e00e53c81baf32cf054", "message": "Fix", "committedDate": "2020-08-19T13:12:40Z", "type": "commit"}, {"oid": "3f7aebd4915abe880dc28f09551fc01e9f8215e8", "url": "https://github.com/elastic/elasticsearch/commit/3f7aebd4915abe880dc28f09551fc01e9f8215e8", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path", "committedDate": "2020-08-19T13:13:03Z", "type": "commit"}, {"oid": "3ce84c096292f9a371cd6dc3206426d9828a6844", "url": "https://github.com/elastic/elasticsearch/commit/3ce84c096292f9a371cd6dc3206426d9828a6844", "message": "Changes", "committedDate": "2020-08-19T15:22:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NDQyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/61302#discussion_r473184429", "bodyText": "There are only a handful of usages of this ctor, so can we please convert the existing usages so we don't now have 2?", "author": "rjernst", "createdAt": "2020-08-19T16:59:31Z", "path": "server/src/main/java/org/elasticsearch/bootstrap/ESPolicy.java", "diffHunk": "@@ -47,10 +47,17 @@\n     final Policy untrusted;\n     final Policy system;\n     final PermissionCollection dynamic;\n+    final PermissionCollection dataPathPermission;\n     final Map<String,Policy> plugins;\n \n     ESPolicy(Map<String, URL> codebases, PermissionCollection dynamic, Map<String,Policy> plugins, boolean filterBadDefaults) {\n+        this(codebases, dynamic, plugins, filterBadDefaults, new Permissions());\n+    }\n+\n+    ESPolicy(Map<String, URL> codebases, PermissionCollection dynamic, Map<String,Policy> plugins, boolean filterBadDefaults,", "originalCommit": "3ce84c096292f9a371cd6dc3206426d9828a6844", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NjcwNA==", "url": "https://github.com/elastic/elasticsearch/pull/61302#discussion_r473186704", "bodyText": "similar comment: can we please modify the few places calling the existing method instead of adding another variant?", "author": "rjernst", "createdAt": "2020-08-19T17:01:44Z", "path": "server/src/main/java/org/elasticsearch/bootstrap/FilePermissionUtils.java", "diffHunk": "@@ -63,25 +63,45 @@ public static void addSingleFilePath(Permissions policy, Path path, String permi\n      */\n     @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n     public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions) throws IOException {\n+        addDirectoryPath(policy, configurationName, path, permissions, false);\n+    }\n+\n+    /**\n+     * Add access to path with direct and/or recursive access. This also creates the directory if it does not exist.\n+     *\n+     * @param policy            current policy to add permissions to\n+     * @param configurationName the configuration name associated with the path (for error messages only)\n+     * @param path              the path itself\n+     * @param permissions       set of file permissions to grant to the path\n+     * @param recursiveAccessOnly   indicates if the permission should provide recursive access to files underneath\n+     */\n+    @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n+    public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions,", "originalCommit": "3ce84c096292f9a371cd6dc3206426d9828a6844", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4OTk4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61302#discussion_r473189983", "bodyText": "Why are we no longer adding the path itself?", "author": "rjernst", "createdAt": "2020-08-19T17:05:00Z", "path": "server/src/main/java/org/elasticsearch/bootstrap/FilePermissionUtils.java", "diffHunk": "@@ -63,25 +63,45 @@ public static void addSingleFilePath(Permissions policy, Path path, String permi\n      */\n     @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n     public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions) throws IOException {\n+        addDirectoryPath(policy, configurationName, path, permissions, false);\n+    }\n+\n+    /**\n+     * Add access to path with direct and/or recursive access. This also creates the directory if it does not exist.\n+     *\n+     * @param policy            current policy to add permissions to\n+     * @param configurationName the configuration name associated with the path (for error messages only)\n+     * @param path              the path itself\n+     * @param permissions       set of file permissions to grant to the path\n+     * @param recursiveAccessOnly   indicates if the permission should provide recursive access to files underneath\n+     */\n+    @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n+    public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions,\n+                                        boolean recursiveAccessOnly) throws IOException {\n         // paths may not exist yet, this also checks accessibility\n         try {\n             Security.ensureDirectoryExists(path);\n         } catch (IOException e) {\n             throw new IllegalStateException(\"Unable to access '\" + configurationName + \"' (\" + path + \")\", e);\n         }\n \n-        // add each path twice: once for itself, again for files underneath it\n-        policy.add(new FilePermission(path.toString(), permissions));\n+        if (recursiveAccessOnly == false) {", "originalCommit": "3ce84c096292f9a371cd6dc3206426d9828a6844", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk2NTczOQ==", "url": "https://github.com/elastic/elasticsearch/pull/61302#discussion_r474965739", "bodyText": "Can you please add a comment about how we only need to check concrete paths, and so the dir itself just adds an additional check that is overhead?", "author": "rjernst", "createdAt": "2020-08-21T20:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4OTk4Mw=="}], "type": "inlineReview"}, {"oid": "d7c44b309974cfb6121af1169b9ba95cfd46e97c", "url": "https://github.com/elastic/elasticsearch/commit/d7c44b309974cfb6121af1169b9ba95cfd46e97c", "message": "Review", "committedDate": "2020-08-19T17:51:20Z", "type": "commit"}, {"oid": "03cd7560b5757e0c0ed2456b187f83c0f7007698", "url": "https://github.com/elastic/elasticsearch/commit/03cd7560b5757e0c0ed2456b187f83c0f7007698", "message": "Add comment", "committedDate": "2020-08-21T22:27:12Z", "type": "commit"}, {"oid": "1387588c128f9534eff91c1f9bf3c8039288a098", "url": "https://github.com/elastic/elasticsearch/commit/1387588c128f9534eff91c1f9bf3c8039288a098", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path", "committedDate": "2020-08-21T22:31:37Z", "type": "commit"}]}