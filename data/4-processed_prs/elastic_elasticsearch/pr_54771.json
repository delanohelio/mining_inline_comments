{"pr_number": 54771, "pr_title": "Fix ReloadSecureSettings API to consume password", "pr_createdAt": "2020-04-05T13:42:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54771", "timeline": [{"oid": "4969378df9f0e322208fb778975a09fa89f05bc9", "url": "https://github.com/elastic/elasticsearch/commit/4969378df9f0e322208fb778975a09fa89f05bc9", "message": "Fix ReloadSecureSettings API to consume password\n\nThe secure_settings_password was never taken into consideration in\nthe ReloadSecureSettings API. This commit fixes that and adds\nnecessary REST layer testing. Doing so, it also\n\n- Allows TestClusters to have a password protected keystore\nso that it can be set for tests.\n- Adds a parameter to the run task so that elastisearch can\nbe run with a password protected keystore.\n-", "committedDate": "2020-04-05T13:21:53Z", "type": "commit"}, {"oid": "3beb92c3477f5c5efb6b0babeaceb3c2df574357", "url": "https://github.com/elastic/elasticsearch/commit/3beb92c3477f5c5efb6b0babeaceb3c2df574357", "message": "Fix spotless", "committedDate": "2020-04-05T13:35:22Z", "type": "commit"}, {"oid": "d44163d2c28f625a599d9e7b7f3bfdd784f850e6", "url": "https://github.com/elastic/elasticsearch/commit/d44163d2c28f625a599d9e7b7f3bfdd784f850e6", "message": "remove extra logging", "committedDate": "2020-04-05T13:40:14Z", "type": "commit"}, {"oid": "92c6cfb067bea10d196c3c3322e19f46daeb3b2b", "url": "https://github.com/elastic/elasticsearch/commit/92c6cfb067bea10d196c3c3322e19f46daeb3b2b", "message": "Create the keystore even if no password is set", "committedDate": "2020-04-05T14:00:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcwNjQ5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403706492", "bodyText": "This is the result of a master merge gone wrong in the feature branch : 4780880#diff-0187f4b109fbd7256c987cceae7691caL76\nThis is the actual fix and the only change necessary. If the buildSrc changes need further discussion, we could just merge the fix and the rest of the test changes when ready.", "author": "jkakavas", "createdAt": "2020-04-05T14:04:50Z", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/cluster/RestReloadSecureSettingsAction.java", "diffHunk": "@@ -73,7 +73,7 @@ public RestChannelConsumer prepareRequest(RestRequest request, NodeClient client\n             .setNodesIds(nodesIds);\n         request.withContentOrSourceParamParserOrNull(parser -> {\n             if (parser != null) {\n-                final NodesReloadSecureSettingsRequest nodesRequest = nodesRequestBuilder.request();\n+                final NodesReloadSecureSettingsRequest nodesRequest = PARSER.parse(parser, null);", "originalCommit": "92c6cfb067bea10d196c3c3322e19f46daeb3b2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6ad7dfba25ef369592a22aeb4b562d8db7ac9e8e", "url": "https://github.com/elastic/elasticsearch/commit/6ad7dfba25ef369592a22aeb4b562d8db7ac9e8e", "message": "set the keystore password where needed", "committedDate": "2020-04-05T14:22:10Z", "type": "commit"}, {"oid": "ed1cc00798a320f8cece058103a07e6dee834015", "url": "https://github.com/elastic/elasticsearch/commit/ed1cc00798a320f8cece058103a07e6dee834015", "message": "set password for all tests", "committedDate": "2020-04-05T14:33:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDM5OA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403784398", "bodyText": "nits: the redirectInput call can be placed outside of the try block.", "author": "ywangd", "createdAt": "2020-04-06T00:59:35Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -720,6 +738,14 @@ private void startElasticsearchProcess() {\n         processBuilder.redirectError(ProcessBuilder.Redirect.appendTo(esStderrFile.toFile()));\n         processBuilder.redirectOutput(ProcessBuilder.Redirect.appendTo(esStdoutFile.toFile()));\n \n+        if (keystorePassword != null && keystorePassword.length() > 0) {\n+            try {\n+                Files.write(esStdinFile, (keystorePassword + \"\\n\").getBytes(StandardCharsets.UTF_8), StandardOpenOption.CREATE);\n+                processBuilder.redirectInput(esStdinFile.toFile());", "originalCommit": "ed1cc00798a320f8cece058103a07e6dee834015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg1OTU3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403859571", "bodyText": "what do we gain by doing so? If Files#write throws, we would still fail with aTestClustersException before we reach redirectInput`", "author": "jkakavas", "createdAt": "2020-04-06T06:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg2NDQ0NA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403864444", "bodyText": "It makes no difference in actual execution outcome for this particular scenario. It's a choice of style, keep error handling specific and accurate to what is targeting for. It's akin to formatting and method extraction, but a bit more: if future changes make the extra method calls throw the same exception, it will not be handled automatically and potentially unwanted by the broader-than-necessary try-catch block. It does not apply to this particular case, that's why I called it \"nits\". But woud anyhow prefer keeping any context as small as possible.", "author": "ywangd", "createdAt": "2020-04-06T06:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg2NTA0OA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403865048", "bodyText": "ok, gotcha", "author": "jkakavas", "createdAt": "2020-04-06T06:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NDM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4MTAyMA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403781020", "bodyText": "Why are these NOTCONSOLE? They look console to me.\nI realise it's existing, but it seems like this docs issue is due in part to these not being treated as testable snippets.", "author": "tvernum", "createdAt": "2020-04-06T00:34:28Z", "path": "docs/reference/cluster/nodes-reload-secure-settings.asciidoc", "diffHunk": "@@ -89,7 +89,7 @@ node of the cluster:\n --------------------------------------------------\n POST _nodes/reload_secure_settings\n {\n-  \"reload_secure_settings\": \"s3cr3t\"\n+  \"secure_settings_password\": \"s3cr3t\"\n }\n --------------------------------------------------\n // NOTCONSOLE", "originalCommit": "ed1cc00798a320f8cece058103a07e6dee834015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg2MTQ0OA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403861448", "bodyText": "Because I forgot to enable them :) When this was first introduced, I think NOTCONSOLE was there to cater for the fact that we couldn't set the keystore password in a proper way in the docs cluster", "author": "jkakavas", "createdAt": "2020-04-06T06:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4MTAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NzMzNA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403787334", "bodyText": "This implies that the body should be the raw password, I think we want something more like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"description\": \"The password for the elasticsearch keystore\",\n          \n          \n            \n                  \"description\": \"An object containing password for the elasticsearch keystore\",", "author": "tvernum", "createdAt": "2020-04-06T01:18:42Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/api/nodes.reload_secure_settings.json", "diffHunk": "@@ -27,11 +27,15 @@\n         }\n       ]\n     },\n-    \"params\":{\n-      \"timeout\":{\n-        \"type\":\"time\",\n-        \"description\":\"Explicit operation timeout\"\n+    \"params\": {\n+      \"timeout\": {\n+        \"type\": \"time\",\n+        \"description\": \"Explicit operation timeout\"\n       }\n+    },\n+    \"body\": {\n+      \"description\": \"The password for the elasticsearch keystore\",", "originalCommit": "ed1cc00798a320f8cece058103a07e6dee834015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4NzY1NA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r403787654", "bodyText": "Can we have a version with no password as well?\nThat should fail with the same error, but I think it's worth a test that it's not failing on \"password is required\" or a NPE, etc.", "author": "tvernum", "createdAt": "2020-04-06T01:20:47Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/nodes.reload_secure_settings/10_basic.yml", "diffHunk": "@@ -1,8 +1,29 @@\n ---\n-\"node_reload_secure_settings test\":\n+\"node_reload_secure_settings test wrong password\":\n \n   - do:\n-      nodes.reload_secure_settings: {}\n+      nodes.reload_secure_settings:\n+        body:\n+          secure_settings_password: awrongpasswordhere\n+  - set:\n+    nodes._arbitrary_key_: node_id\n \n   - is_true: nodes\n   - is_true: cluster_name\n+  - match: { nodes.$node_id.reload_exception.type: \"security_exception\" }\n+  - match: { nodes.$node_id.reload_exception.reason: \"Provided keystore password was incorrect\" }\n+", "originalCommit": "ed1cc00798a320f8cece058103a07e6dee834015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e27bddf0116b235ca60a61d9a18fab97afa73908", "url": "https://github.com/elastic/elasticsearch/commit/e27bddf0116b235ca60a61d9a18fab97afa73908", "message": "address feedback", "committedDate": "2020-04-06T14:18:38Z", "type": "commit"}, {"oid": "aa5358f182c7c89e974d637ebdef252634aee6d3", "url": "https://github.com/elastic/elasticsearch/commit/aa5358f182c7c89e974d637ebdef252634aee6d3", "message": "Call the API locally in tests as there might be the case we're in a cluster that doesn't have transport TLS setup", "committedDate": "2020-04-06T15:41:14Z", "type": "commit"}, {"oid": "84273177cae33e9ffd631fa54dae0b682088cc01", "url": "https://github.com/elastic/elasticsearch/commit/84273177cae33e9ffd631fa54dae0b682088cc01", "message": "correctly set the keystore password for integ-test-zip", "committedDate": "2020-04-06T15:41:48Z", "type": "commit"}, {"oid": "146eefd96068998c415c147356851195707fc28b", "url": "https://github.com/elastic/elasticsearch/commit/146eefd96068998c415c147356851195707fc28b", "message": "Merge remote-tracking branch 'origin/master' into reload-secure-settings-fix", "committedDate": "2020-04-06T15:53:31Z", "type": "commit"}, {"oid": "ee31279187c9762ea8e7b6550cc892843267a7bd", "url": "https://github.com/elastic/elasticsearch/commit/ee31279187c9762ea8e7b6550cc892843267a7bd", "message": "add QA project", "committedDate": "2020-04-07T13:08:21Z", "type": "commit"}, {"oid": "78c7b39c525f315fd70fdb920be0a8b7e9936ab8", "url": "https://github.com/elastic/elasticsearch/commit/78c7b39c525f315fd70fdb920be0a8b7e9936ab8", "message": "revert changes to existing core rest tests", "committedDate": "2020-04-07T13:14:20Z", "type": "commit"}, {"oid": "5947a16e5c92c33cd7589ae89e8ae7be11853bdb", "url": "https://github.com/elastic/elasticsearch/commit/5947a16e5c92c33cd7589ae89e8ae7be11853bdb", "message": "fix license", "committedDate": "2020-04-07T13:24:22Z", "type": "commit"}, {"oid": "2b6323159487c078dc069ebcb17a52d6795eaca4", "url": "https://github.com/elastic/elasticsearch/commit/2b6323159487c078dc069ebcb17a52d6795eaca4", "message": "fix spec wording", "committedDate": "2020-04-07T13:30:05Z", "type": "commit"}, {"oid": "9bb75830ef981ba1513fedd19c4cd594333ce3d1", "url": "https://github.com/elastic/elasticsearch/commit/9bb75830ef981ba1513fedd19c4cd594333ce3d1", "message": "remove unecessary settings", "committedDate": "2020-04-07T13:31:27Z", "type": "commit"}, {"oid": "5233d909140d5bf73d4b06915a6cd4a71810c533", "url": "https://github.com/elastic/elasticsearch/commit/5233d909140d5bf73d4b06915a6cd4a71810c533", "message": "Merge remote-tracking branch 'origin/master' into reload-secure-settings-fix", "committedDate": "2020-04-07T13:33:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r404815169", "bodyText": "The reason this is created in x-pack is that calling the reload settings api with a password require transport SSL to be configured. We could move this to qa and run with OSS too,  if we limit this to an 1 node cluster", "author": "jkakavas", "createdAt": "2020-04-07T13:37:56Z", "path": "x-pack/qa/password-protected-keystore/build.gradle", "diffHunk": "@@ -0,0 +1,52 @@\n+/*", "originalCommit": "5233d909140d5bf73d4b06915a6cd4a71810c533", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf6315aa61b442a6e07857cd0c62ca085455cd4c", "url": "https://github.com/elastic/elasticsearch/commit/cf6315aa61b442a6e07857cd0c62ca085455cd4c", "message": "fix yaml test", "committedDate": "2020-04-07T13:50:43Z", "type": "commit"}, {"oid": "f07b5049152e5654d3c4a014005c97c932a0ed22", "url": "https://github.com/elastic/elasticsearch/commit/f07b5049152e5654d3c4a014005c97c932a0ed22", "message": "remove redundant leftover from applying stash", "committedDate": "2020-04-07T14:35:59Z", "type": "commit"}, {"oid": "c4a8496b3ec3abde6543b2b58d1203690337dd36", "url": "https://github.com/elastic/elasticsearch/commit/c4a8496b3ec3abde6543b2b58d1203690337dd36", "message": "Merge branch 'master' into reload-secure-settings-fix", "committedDate": "2020-04-07T15:11:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MDQyOA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r404980428", "bodyText": "While I'm not opposed to this, I wonder how useful it is in practice since we have no ability to set values in the keystore via the run task?", "author": "rjernst", "createdAt": "2020-04-07T17:19:32Z", "path": "build.gradle", "diffHunk": "@@ -405,6 +405,14 @@ class Run extends DefaultTask {\n   public void setDataDir(String dataDirStr) {\n     project.project(':distribution').run.dataDir = dataDirStr\n   }\n+\n+  @Option(\n+    option = \"keystore-password\",", "originalCommit": "c4a8496b3ec3abde6543b2b58d1203690337dd36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2MDAyNA==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r405360024", "bodyText": "Yes, I'm not sold on it either. And given that we currently don't have a way to set keystore properties in the run task, maybe it's not worth adding ? I don't know , it seemed like a good idea when I added it but I'm not so sure now", "author": "jkakavas", "createdAt": "2020-04-08T08:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MDQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1NDg1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r406854857", "bodyText": "I assume this is only relevant when compiled with the --data-dir option to point at an existing directory which might have a manually setup keystore?", "author": "mark-vieira", "createdAt": "2020-04-10T17:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MDQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NDQ5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r404984493", "bodyText": "Could this just be a yaml test?", "author": "rjernst", "createdAt": "2020-04-07T17:26:04Z", "path": "x-pack/qa/password-protected-keystore/src/test/java/org/elasticsearch/password_protected_keystore/ReloadSecureSettingsWithPasswordProtectedKeystoreRestIT.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.password_protected_keystore;\n+\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.common.settings.SecureString;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.common.xcontent.ObjectPath;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n+\n+import static org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken.basicAuthHeaderValue;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.nullValue;\n+\n+import java.util.Map;\n+\n+public class ReloadSecureSettingsWithPasswordProtectedKeystoreRestIT extends ESRestTestCase {", "originalCommit": "c4a8496b3ec3abde6543b2b58d1203690337dd36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1OTExMw==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r405359113", "bodyText": "I find these easier to write, debug and argue about so if you don't have a strong view on why we should make them a yaml test, I'd prefer to keep this", "author": "jkakavas", "createdAt": "2020-04-08T08:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NDQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NjI5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r404986293", "bodyText": "I'm just curious: we used to generate these types of materials within build.gradle in other qa tests: why are we now committing them instead of generating on the fly?", "author": "rjernst", "createdAt": "2020-04-07T17:28:41Z", "path": "x-pack/qa/password-protected-keystore/src/test/resources/ssl/ca.crt", "diffHunk": "@@ -0,0 +1,20 @@\n+-----BEGIN CERTIFICATE-----", "originalCommit": "c4a8496b3ec3abde6543b2b58d1203690337dd36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1ODU1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54771#discussion_r405358553", "bodyText": "We used to depend on BouncyCastle to generate keys and certificates as JDK doesn't expose the necessary APIs for the certificate generation (https://bugs.openjdk.java.net/browse/JDK-8058778) and we removed BouncyCastle dependency as part of the FIPS 140 effort", "author": "jkakavas", "createdAt": "2020-04-08T08:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NjI5Mw=="}], "type": "inlineReview"}, {"oid": "f740fd915a3a81361feb672b84d99add9c2ed7f3", "url": "https://github.com/elastic/elasticsearch/commit/f740fd915a3a81361feb672b84d99add9c2ed7f3", "message": "Merge branch 'master' into reload-secure-settings-fix", "committedDate": "2020-04-08T11:27:20Z", "type": "commit"}]}