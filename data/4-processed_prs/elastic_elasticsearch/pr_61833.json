{"pr_number": 61833, "pr_title": "Expand max chain depth testing", "pr_createdAt": "2020-09-02T08:04:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61833", "timeline": [{"oid": "4ec181ac2db182507bb3914fcd52fcd987ed89f2", "url": "https://github.com/elastic/elasticsearch/commit/4ec181ac2db182507bb3914fcd52fcd987ed89f2", "message": "Expand max chain depth testing\n\nThis commit extends the coverage around max chain depth in runtime fields. We test that direct references are not counted, that 5 references are allowed while 6 are not, and we test that the same error is returned no matter where the runtime field is used.", "committedDate": "2020-09-02T07:56:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MjQ1MA==", "url": "https://github.com/elastic/elasticsearch/pull/61833#discussion_r481862450", "bodyText": "I am aware that splitting tests like this will cause more setup / tear down, yet I think it makes the tests less descriptive and targeted each one at their own specific goal.", "author": "javanna", "createdAt": "2020-09-02T08:05:28Z", "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/90_loops.yml", "diffHunk": "@@ -77,6 +116,16 @@ setup:\n              terms:\n                field: loose_loop\n \n+---\n+\"loose loop - sort\":\n+  - do:\n+      catch: '/Cyclic dependency detected while resolving runtime fields: loose_loop -> lla -> llb -> llc -> loose_loop/'\n+      search:\n+        index: sensor\n+        body:\n+          sort: loose_loop\n+---\n+\"loose loop - docvalue_fields\":", "originalCommit": "4ec181ac2db182507bb3914fcd52fcd987ed89f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA0NTkzMg==", "url": "https://github.com/elastic/elasticsearch/pull/61833#discussion_r482045932", "bodyText": "Makes sense to me. \ud83d\udc4d", "author": "nik9000", "createdAt": "2020-09-02T12:55:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MjQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MjkyMg==", "url": "https://github.com/elastic/elasticsearch/pull/61833#discussion_r481862922", "bodyText": "Note that there are no tests for queries, on purpose. They need to be fixed :)", "author": "javanna", "createdAt": "2020-09-02T08:06:00Z", "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/90_loops.yml", "diffHunk": "@@ -96,10 +147,56 @@ setup:\n              terms:\n                field: lla\n \n+---\n+\"Max chain depth - 5 is allowed\":\n+  - do:\n+      search:\n+        index: sensor\n+        body:\n+          sort: timestamp\n+          docvalue_fields: [over_max_depth_1]\n+\n+  - match: {hits.total.value: 1}\n+  - match: {hits.hits.0.fields.over_max_depth_1.0: test}\n+\n+---\n+\"Max chain depth - direct references are not counted\":\n   - do:\n-      catch: '/Cyclic dependency detected while resolving runtime fields: lla -> llb -> llc -> loose_loop -> lla/'\n       search:\n         index: sensor\n         body:\n           sort: timestamp\n-          docvalue_fields: [lla]\n+          docvalue_fields: [refs]\n+\n+  - match: {hits.total.value: 1}\n+  - match: {hits.hits.0.fields.refs.0: testtesttesttesta}\n+\n+---\n+\"Max chain depth - aggs\":\n+  - do:\n+      catch: '/Field requires resolving too many dependent fields: over_max_depth -> over_max_depth_1 -> over_max_depth_2 -> over_max_depth_3 -> over_max_depth_4 -> over_max_depth_5/'\n+      search:\n+        index: sensor\n+        body:\n+          sort: timestamp\n+          aggs:\n+            loop:\n+             terms:\n+               field: over_max_depth\n+---\n+\"Max chain depth - sort\":\n+  - do:\n+      catch: '/Field requires resolving too many dependent fields: over_max_depth -> over_max_depth_1 -> over_max_depth_2 -> over_max_depth_3 -> over_max_depth_4 -> over_max_depth_5/'\n+      search:\n+        index: sensor\n+        body:\n+          sort: over_max_depth\n+---\n+\"Max chain depth - docvalue_fields\":\n+  - do:\n+      catch: '/Field requires resolving too many dependent fields: over_max_depth -> over_max_depth_1 -> over_max_depth_2 -> over_max_depth_3 -> over_max_depth_4 -> over_max_depth_5/'\n+      search:\n+        index: sensor\n+        body:\n+          sort: timestamp\n+          docvalue_fields: [over_max_depth]", "originalCommit": "4ec181ac2db182507bb3914fcd52fcd987ed89f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA0NjExOQ==", "url": "https://github.com/elastic/elasticsearch/pull/61833#discussion_r482046119", "bodyText": "Yeah, I have this on my list but I keep getting distracted by shiny objects.", "author": "nik9000", "createdAt": "2020-09-02T12:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MjkyMg=="}], "type": "inlineReview"}]}