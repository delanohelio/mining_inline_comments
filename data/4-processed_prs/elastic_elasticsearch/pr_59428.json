{"pr_number": 59428, "pr_title": "Fix Snapshot not Starting in Partial Snapshot Corner Case", "pr_createdAt": "2020-07-13T15:05:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59428", "timeline": [{"oid": "f7f64ab1460f7ee4b9742251375f13f3a0f1a5c8", "url": "https://github.com/elastic/elasticsearch/commit/f7f64ab1460f7ee4b9742251375f13f3a0f1a5c8", "message": "Fix Snapshot not Starting in Partial Snapshot Corner Case\n\nWe were not handling the case where during a partial snaphshot all\nshards would enter a failed state right off the bat.\n\nCloses #59384", "committedDate": "2020-07-13T15:03:54Z", "type": "commit"}, {"oid": "48acf9694d7d238030e92f3f12f4975c0e550adf", "url": "https://github.com/elastic/elasticsearch/commit/48acf9694d7d238030e92f3f12f4975c0e550adf", "message": "cleaner fix", "committedDate": "2020-07-13T15:12:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyNDI3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59428#discussion_r453724279", "bodyText": "Also fixes yet another spot where we'd produce a snapshot with all shards in a final state but not a final state for the overall snapshot. I'll try to track down any remaining cases (I think this should've been the last one) if there are any and add an assertion to prevent this kind of bug going forward.", "author": "original-brownbear", "createdAt": "2020-07-13T15:14:34Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -294,8 +294,8 @@ public ClusterState execute(ClusterState currentState) {\n                 }\n                 newEntry = new SnapshotsInProgress.Entry(\n                         new Snapshot(repositoryName, snapshotId), request.includeGlobalState(), request.partial(),\n-                        State.STARTED, indexIds, dataStreams, threadPool.absoluteTimeInMillis(), repositoryData.getGenId(), shards,\n-                        null, userMeta, version);\n+                        completed(shards.values()) ? State.SUCCESS : State.STARTED, indexIds, dataStreams,", "originalCommit": "48acf9694d7d238030e92f3f12f4975c0e550adf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}