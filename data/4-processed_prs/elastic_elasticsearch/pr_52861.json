{"pr_number": 52861, "pr_title": "add explicit tests for geo_shape with doc values on old indices", "pr_createdAt": "2020-02-27T01:26:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52861", "timeline": [{"oid": "4061cf1b4751c89ed1dd0f0faa663057e964cc27", "url": "https://github.com/elastic/elasticsearch/commit/4061cf1b4751c89ed1dd0f0faa663057e964cc27", "message": "add explicit tests for geo_shape with doc values on old indices", "committedDate": "2020-02-27T01:24:52Z", "type": "commit"}, {"oid": "21d2431d450667063089c45ed0057cd45d32b64a", "url": "https://github.com/elastic/elasticsearch/commit/21d2431d450667063089c45ed0057cd45d32b64a", "message": "fix test", "committedDate": "2020-02-27T18:36:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwODE0NA==", "url": "https://github.com/elastic/elasticsearch/pull/52861#discussion_r385608144", "bodyText": "Not sure if am reading this correctly. If you mix index with different versions then we do not fail? Is this the expected behavior?", "author": "iverase", "createdAt": "2020-02-28T10:06:02Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/GeoCentroidIT.java", "diffHunk": "@@ -45,6 +48,31 @@\n public class GeoCentroidIT extends AbstractGeoTestCase {\n     private static final String aggName = \"geoCentroid\";\n \n+    public void test7xIndexOnly() {\n+        SearchPhaseExecutionException exception = expectThrows(SearchPhaseExecutionException.class,\n+            () -> client().prepareSearch(IDX_NAME_7x) .addAggregation(geoCentroid(aggName).field(SINGLE_VALUED_GEOSHAPE_FIELD_NAME))\n+            .get());\n+        assertNotNull(exception.getRootCause());\n+        assertThat(exception.getRootCause().getMessage(),\n+            equalTo(\"Can't load fielddata on [geoshape_value] because fielddata is unsupported on fields of type [geo_shape].\" +\n+                \" Use doc values instead.\"));\n+    }\n+\n+    public void test7xIndexWith8Index() {\n+        SearchResponse response = client().prepareSearch(IDX_NAME_7x, IDX_NAME)", "originalCommit": "21d2431d450667063089c45ed0057cd45d32b64a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4NTAwMA==", "url": "https://github.com/elastic/elasticsearch/pull/52861#discussion_r385885000", "bodyText": "I think this is intentional? We fail shards that do not have doc-values, but since the other index is valid, the aggregation result is consistent.\nIt errors out if queried against an index with no geo_shape field at all.\nI will double check other aggregations to see what is the most consistent behavior. I assume it is the same as is shown here", "author": "talevy", "createdAt": "2020-02-28T19:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwODE0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI3MTc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/52861#discussion_r386271744", "bodyText": "I see, and this assertion checks that some shards were not successful:\n  assertThat(response.getSuccessfulShards(), lessThan(response.getTotalShards()));", "author": "iverase", "createdAt": "2020-03-02T09:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwODE0NA=="}], "type": "inlineReview"}]}