{"pr_number": 52093, "pr_title": "Add support for secondary authentication", "pr_createdAt": "2020-02-08T06:03:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52093", "timeline": [{"oid": "de24408ed5eafae5cf2cce360262ab0f7f91884f", "url": "https://github.com/elastic/elasticsearch/commit/de24408ed5eafae5cf2cce360262ab0f7f91884f", "message": "Add support for secondary authentication\n\nThis change makes it possible to send secondary authentication\ncredentials to select endpoints that need to perform a single action\nin the context of two users.\n\nTypically this need arises when a server process needs to call an\nendpoint that users should not (or might not) have direct access to,\nbut some part of that action must be performed using the logged-in\nuser's identity.", "committedDate": "2020-02-11T04:18:51Z", "type": "forcePushed"}, {"oid": "6fd9b62606b6e9f005bb76a679967541ae476bef", "url": "https://github.com/elastic/elasticsearch/commit/6fd9b62606b6e9f005bb76a679967541ae476bef", "message": "Add support for secondary authentication\n\nThis change makes it possible to send secondary authentication\ncredentials to select endpoints that need to perform a single action\nin the context of two users.\n\nTypically this need arises when a server process needs to call an\nendpoint that users should not (or might not) have direct access to,\nbut some part of that action must be performed using the logged-in\nuser's identity.", "committedDate": "2020-02-13T11:05:29Z", "type": "commit"}, {"oid": "6fd9b62606b6e9f005bb76a679967541ae476bef", "url": "https://github.com/elastic/elasticsearch/commit/6fd9b62606b6e9f005bb76a679967541ae476bef", "message": "Add support for secondary authentication\n\nThis change makes it possible to send secondary authentication\ncredentials to select endpoints that need to perform a single action\nin the context of two users.\n\nTypically this need arises when a server process needs to call an\nendpoint that users should not (or might not) have direct access to,\nbut some part of that action must be performed using the logged-in\nuser's identity.", "committedDate": "2020-02-13T11:05:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5NTMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381095338", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String THREAD_CTX_KEY = \"_xpack_security_2nd_authc\";\n          \n          \n            \n                private static final String THREAD_CTX_KEY = \"_xpack_security_secondary_authc\";\n          \n      \n    \n    \n  \n\npurely personal preference, that 2nd doesn't read well", "author": "jkakavas", "createdAt": "2020-02-19T06:16:42Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/SecondaryAuthentication.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.security.authc.support;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.transport.TransportRequest;\n+import org.elasticsearch.xpack.core.security.SecurityContext;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+import java.util.function.Function;\n+\n+/**\n+ * Some Elasticsearch APIs need to be provided with 2 sets of credentials.\n+ * Typically this happens when a system user needs to perform an action while accessing data on behalf of, or user information regarding\n+ * a logged in user.\n+ * This class is a representation of that secondary user that can be activated in the security context while processing specific blocks\n+ * of code or within a listener.\n+ */\n+public class SecondaryAuthentication {\n+\n+    private static final String THREAD_CTX_KEY = \"_xpack_security_2nd_authc\";", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwMjA0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381202049", "bodyText": "Should we name this readFromContext in order to not imply that it does anything more?", "author": "jkakavas", "createdAt": "2020-02-19T10:24:09Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/SecondaryAuthentication.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.security.authc.support;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.transport.TransportRequest;\n+import org.elasticsearch.xpack.core.security.SecurityContext;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+import java.util.function.Function;\n+\n+/**\n+ * Some Elasticsearch APIs need to be provided with 2 sets of credentials.\n+ * Typically this happens when a system user needs to perform an action while accessing data on behalf of, or user information regarding\n+ * a logged in user.\n+ * This class is a representation of that secondary user that can be activated in the security context while processing specific blocks\n+ * of code or within a listener.\n+ */\n+public class SecondaryAuthentication {\n+\n+    private static final String THREAD_CTX_KEY = \"_xpack_security_2nd_authc\";\n+\n+    public interface Authenticator {\n+\n+        void authenticate(String action, TransportRequest request, ActionListener<SecondaryAuthentication> listener);\n+\n+        void authenticateAndAttachToContext(RestRequest request, ActionListener<SecondaryAuthentication> listener);\n+\n+        boolean hasSecondaryAuthenticationHeader();\n+    }\n+\n+    private final SecurityContext securityContext;\n+    private final Authentication authentication;\n+\n+    public SecondaryAuthentication(SecurityContext securityContext, Authentication authentication) {\n+        this.securityContext = Objects.requireNonNull(securityContext);\n+        this.authentication = Objects.requireNonNull(authentication);\n+    }\n+\n+    @Nullable\n+    public static SecondaryAuthentication restoreFromContext(SecurityContext securityContext) throws IOException {", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIxNDYxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381214619", "bodyText": "More of a legitimate question than feedback, what value does this interface add?", "author": "jkakavas", "createdAt": "2020-02-19T10:47:29Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/SecondaryAuthentication.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.security.authc.support;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.transport.TransportRequest;\n+import org.elasticsearch.xpack.core.security.SecurityContext;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+import java.util.function.Function;\n+\n+/**\n+ * Some Elasticsearch APIs need to be provided with 2 sets of credentials.\n+ * Typically this happens when a system user needs to perform an action while accessing data on behalf of, or user information regarding\n+ * a logged in user.\n+ * This class is a representation of that secondary user that can be activated in the security context while processing specific blocks\n+ * of code or within a listener.\n+ */\n+public class SecondaryAuthentication {\n+\n+    private static final String THREAD_CTX_KEY = \"_xpack_security_2nd_authc\";\n+\n+    public interface Authenticator {", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM4NDc0MA==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r382384740", "bodyText": "It existed so that x-pack-core had something usable even though the implementation was in security.\nBut actually that doesn't matter anymore because the only use the authentication from within security.", "author": "tvernum", "createdAt": "2020-02-21T03:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIxNDYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIxNTc5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381215796", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /**\n          \n          \n            \n                /**", "author": "jkakavas", "createdAt": "2020-02-19T10:49:45Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/support/SecondaryAuthenticator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.support;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ContextPreservingActionListener;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.transport.TransportRequest;\n+import org.elasticsearch.xpack.core.security.SecurityContext;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+import org.elasticsearch.xpack.core.security.authc.support.SecondaryAuthentication;\n+import org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken;\n+import org.elasticsearch.xpack.security.authc.AuthenticationService;\n+\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Performs \"secondary user authentication\" (that is, a second user, _not_ second factor authentication).\n+ */\n+public class SecondaryAuthenticator implements SecondaryAuthentication.Authenticator {\n+\n+    /**\n+     * The term \"Authorization\" in the header value is to mimic the standard HTTP \"Authorization\" header\n+     */\n+    public static final String SECONDARY_AUTH_HEADER_NAME = \"es-secondary-authorization\";\n+\n+    private final Logger logger = LogManager.getLogger();\n+    private final SecurityContext securityContext;\n+    private final AuthenticationService authenticationService;\n+\n+    public SecondaryAuthenticator(Settings settings, ThreadContext threadContext, AuthenticationService authenticationService) {\n+        this(new SecurityContext(settings, threadContext), authenticationService);\n+    }\n+\n+    public SecondaryAuthenticator(SecurityContext securityContext, AuthenticationService authenticationService) {\n+        this.securityContext = securityContext;\n+        this.authenticationService = authenticationService;\n+    }\n+\n+    /**\n+     * @param listener Handler for the {@link SecondaryAuthentication} object.\n+     *                 If the secondary authentication credentials do not exist the thread context, the\n+     *                 {@link ActionListener#onResponse(Object)} method is called with a {@code null} authentication value.\n+     *                 If the secondary authentication credentials are found in the thread context, but fail to be authenticated, then\n+     *                 the failure is returned through {@link ActionListener#onFailure(Exception)}.\n+     */\n+    @Override\n+    public void authenticate(String action, TransportRequest request, ActionListener<SecondaryAuthentication> listener) {\n+        authenticate(authListener -> authenticationService.authenticate(action, request, false, authListener), listener);\n+    }\n+\n+  /**", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzMTYwMg==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381231602", "bodyText": "Unrelated to this change but we should move BASIC_AUTH_HEADER away from UsernamePasswordToken , it confused me for more time than I'd like to admit :/", "author": "jkakavas", "createdAt": "2020-02-19T11:22:34Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/support/SecondaryAuthenticator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.support;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ContextPreservingActionListener;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.transport.TransportRequest;\n+import org.elasticsearch.xpack.core.security.SecurityContext;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+import org.elasticsearch.xpack.core.security.authc.support.SecondaryAuthentication;\n+import org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken;\n+import org.elasticsearch.xpack.security.authc.AuthenticationService;\n+\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Performs \"secondary user authentication\" (that is, a second user, _not_ second factor authentication).\n+ */\n+public class SecondaryAuthenticator implements SecondaryAuthentication.Authenticator {\n+\n+    /**\n+     * The term \"Authorization\" in the header value is to mimic the standard HTTP \"Authorization\" header\n+     */\n+    public static final String SECONDARY_AUTH_HEADER_NAME = \"es-secondary-authorization\";\n+\n+    private final Logger logger = LogManager.getLogger();\n+    private final SecurityContext securityContext;\n+    private final AuthenticationService authenticationService;\n+\n+    public SecondaryAuthenticator(Settings settings, ThreadContext threadContext, AuthenticationService authenticationService) {\n+        this(new SecurityContext(settings, threadContext), authenticationService);\n+    }\n+\n+    public SecondaryAuthenticator(SecurityContext securityContext, AuthenticationService authenticationService) {\n+        this.securityContext = securityContext;\n+        this.authenticationService = authenticationService;\n+    }\n+\n+    /**\n+     * @param listener Handler for the {@link SecondaryAuthentication} object.\n+     *                 If the secondary authentication credentials do not exist the thread context, the\n+     *                 {@link ActionListener#onResponse(Object)} method is called with a {@code null} authentication value.\n+     *                 If the secondary authentication credentials are found in the thread context, but fail to be authenticated, then\n+     *                 the failure is returned through {@link ActionListener#onFailure(Exception)}.\n+     */\n+    @Override\n+    public void authenticate(String action, TransportRequest request, ActionListener<SecondaryAuthentication> listener) {\n+        authenticate(authListener -> authenticationService.authenticate(action, request, false, authListener), listener);\n+    }\n+\n+  /**\n+     * @param listener Handler for the {@link SecondaryAuthentication} object.\n+     *                 If the secondary authentication credentials do not exist the thread context, the\n+     *                 {@link ActionListener#onResponse(Object)} method is called with a {@code null} authentication value.\n+     *                 If the secondary authentication credentials are found in the thread context, but fail to be authenticated, then\n+     *                 the failure is returned through {@link ActionListener#onFailure(Exception)}.\n+     */\n+  @Override\n+  public void authenticateAndAttachToContext(RestRequest request, ActionListener<SecondaryAuthentication> listener) {\n+      final ThreadContext threadContext = securityContext.getThreadContext();\n+      authenticate(authListener -> authenticationService.authenticate(request, false, authListener),\n+          ActionListener.wrap(secondaryAuthentication -> {\n+                  if (secondaryAuthentication != null) {\n+                      secondaryAuthentication.writeToContext(threadContext);\n+                  }\n+                  listener.onResponse(secondaryAuthentication);\n+              },\n+              listener::onFailure));\n+  }\n+\n+    private void authenticate(Consumer<ActionListener<Authentication>> authenticate, ActionListener<SecondaryAuthentication> listener) {\n+        final ThreadContext threadContext = securityContext.getThreadContext();\n+        final String header = threadContext.getHeader(SECONDARY_AUTH_HEADER_NAME);\n+        if (Strings.isNullOrEmpty(header)) {\n+            logger.trace(\"no secondary authentication credentials found (the [{}] header is [{}])\", SECONDARY_AUTH_HEADER_NAME, header);\n+            listener.onResponse(null);\n+            return;\n+        }\n+\n+        final Supplier<ThreadContext.StoredContext> originalContext = threadContext.newRestorableContext(false);\n+        final ActionListener<Authentication> authenticationListener = new ContextPreservingActionListener<>(originalContext,\n+            ActionListener.wrap(\n+                authentication -> {\n+                    if (authentication == null) {\n+                        logger.debug(\"secondary authentication failed - authentication service returned a null authentication object\");\n+                        listener.onFailure(new ElasticsearchSecurityException(\"Failed to authenticate secondary user\"));\n+                    } else {\n+                        logger.debug(\"secondary authentication succeeded [{}]\", authentication);\n+                        listener.onResponse(new SecondaryAuthentication(securityContext, authentication));\n+                    }\n+                },\n+                e -> {\n+                    logger.debug(\"secondary authentication failed - authentication service responded with failure\", e);\n+                    listener.onFailure(new ElasticsearchSecurityException(\"Failed to authenticate secondary user\", e));\n+                }\n+            ));\n+        try (ThreadContext.StoredContext ignore = threadContext.stashContext()) {\n+            logger.trace(\"found secondary authentication credentials, placing them in the internal [{}] header for authentication\",\n+                UsernamePasswordToken.BASIC_AUTH_HEADER);", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNTk1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381235952", "bodyText": "This comment found its way back here : #52094 (comment)", "author": "jkakavas", "createdAt": "2020-02-19T11:32:41Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -150,6 +150,7 @@ the system itself (e.g. pings, update mappings, share relocation, etc...) and we\n          it to the action without an associated user (not via REST or transport - this is taken care of by\n          the {@link Rest} filter and the {@link ServerTransport} filter respectively), it's safe to assume a system user\n          here if a request is not associated with any other user.\n+         Because we want to fallback to the SystemUser, we don't allow anonymous (AnonymousUser) requests.", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM4NTIxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r382385211", "bodyText": "Splitting this branch up ended up being hard work.\nIt was worth it because each of the changes was substantial, but there was a lot of rebasing and merging.", "author": "tvernum", "createdAt": "2020-02-21T03:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNTk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNzE0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381237147", "bodyText": "Would it be worth adding a comment or jdoc to mention that allowAnonymous is set to false for a reason?", "author": "jkakavas", "createdAt": "2020-02-19T11:35:24Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/support/SecondaryAuthenticator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.support;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ContextPreservingActionListener;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.transport.TransportRequest;\n+import org.elasticsearch.xpack.core.security.SecurityContext;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+import org.elasticsearch.xpack.core.security.authc.support.SecondaryAuthentication;\n+import org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken;\n+import org.elasticsearch.xpack.security.authc.AuthenticationService;\n+\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Performs \"secondary user authentication\" (that is, a second user, _not_ second factor authentication).\n+ */\n+public class SecondaryAuthenticator implements SecondaryAuthentication.Authenticator {\n+\n+    /**\n+     * The term \"Authorization\" in the header value is to mimic the standard HTTP \"Authorization\" header\n+     */\n+    public static final String SECONDARY_AUTH_HEADER_NAME = \"es-secondary-authorization\";\n+\n+    private final Logger logger = LogManager.getLogger();\n+    private final SecurityContext securityContext;\n+    private final AuthenticationService authenticationService;\n+\n+    public SecondaryAuthenticator(Settings settings, ThreadContext threadContext, AuthenticationService authenticationService) {\n+        this(new SecurityContext(settings, threadContext), authenticationService);\n+    }\n+\n+    public SecondaryAuthenticator(SecurityContext securityContext, AuthenticationService authenticationService) {\n+        this.securityContext = securityContext;\n+        this.authenticationService = authenticationService;\n+    }\n+\n+    /**\n+     * @param listener Handler for the {@link SecondaryAuthentication} object.\n+     *                 If the secondary authentication credentials do not exist the thread context, the\n+     *                 {@link ActionListener#onResponse(Object)} method is called with a {@code null} authentication value.\n+     *                 If the secondary authentication credentials are found in the thread context, but fail to be authenticated, then\n+     *                 the failure is returned through {@link ActionListener#onFailure(Exception)}.\n+     */\n+    @Override\n+    public void authenticate(String action, TransportRequest request, ActionListener<SecondaryAuthentication> listener) {\n+        authenticate(authListener -> authenticationService.authenticate(action, request, false, authListener), listener);", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MTIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381241233", "bodyText": "We don't actually use ApiKeyService here so we could just mock it below and return false on isEnabled() ?", "author": "jkakavas", "createdAt": "2020-02-19T11:45:05Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/support/SecondaryAuthenticatorTests.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.support;\n+\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.settings.SecureString;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.env.TestEnvironment;\n+import org.elasticsearch.license.License;\n+import org.elasticsearch.license.TestUtils;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.test.TestMatchers;\n+import org.elasticsearch.test.rest.FakeRestRequest;\n+import org.elasticsearch.threadpool.TestThreadPool;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportRequest;\n+import org.elasticsearch.xpack.core.security.SecurityContext;\n+import org.elasticsearch.xpack.core.security.action.user.AuthenticateAction;\n+import org.elasticsearch.xpack.core.security.action.user.AuthenticateRequest;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+import org.elasticsearch.xpack.core.security.authc.Authentication.AuthenticationType;\n+import org.elasticsearch.xpack.core.security.authc.Authentication.RealmRef;\n+import org.elasticsearch.xpack.core.security.authc.AuthenticationFailureHandler;\n+import org.elasticsearch.xpack.core.security.authc.DefaultAuthenticationFailureHandler;\n+import org.elasticsearch.xpack.core.security.authc.RealmConfig;\n+import org.elasticsearch.xpack.core.security.authc.RealmConfig.RealmIdentifier;\n+import org.elasticsearch.xpack.core.security.authc.support.SecondaryAuthentication;\n+import org.elasticsearch.xpack.core.security.index.RestrictedIndicesNames;\n+import org.elasticsearch.xpack.core.security.user.AnonymousUser;\n+import org.elasticsearch.xpack.core.security.user.User;\n+import org.elasticsearch.xpack.security.audit.AuditTrailService;\n+import org.elasticsearch.xpack.security.authc.ApiKeyService;\n+import org.elasticsearch.xpack.security.authc.AuthenticationService;\n+import org.elasticsearch.xpack.security.authc.Realms;\n+import org.elasticsearch.xpack.security.authc.TokenService;\n+import org.elasticsearch.xpack.security.support.SecurityIndexManager;\n+import org.elasticsearch.xpack.security.test.SecurityMocks;\n+import org.hamcrest.Matchers;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.mockito.Mockito;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.time.Clock;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.Consumer;\n+\n+import static org.elasticsearch.xpack.security.authc.support.SecondaryAuthenticator.SECONDARY_AUTH_HEADER_NAME;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class SecondaryAuthenticatorTests extends ESTestCase {\n+\n+    private AuthenticationService authenticationService;\n+    private SecondaryAuthenticator authenticator;\n+    private DummyUsernamePasswordRealm realm;\n+    private ThreadPool threadPool;\n+    private SecurityContext securityContext;\n+    private TokenService tokenService;\n+    private Client client;\n+\n+    @Before\n+    public void setupMocks() throws Exception {\n+        threadPool = new TestThreadPool(getTestName());\n+        final ThreadContext threadContext = threadPool.getThreadContext();\n+\n+        final Realms realms = mock(Realms.class);\n+        final Settings settings = Settings.builder()\n+            .put(buildEnvSettings(Settings.EMPTY))\n+            .put(\"xpack.security.authc.realms.dummy.test_realm.order\", 1)\n+            .put(\"xpack.security.authc.token.enabled\", true)\n+            .put(\"xpack.security.authc.api_key.enabled\", true)", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM4NjAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r382386023", "bodyText": "Yes. I originally expected to include a test for ApiKey authentication, but Bearer Token is sufficient to verify that we're not restricted to the realm chain.", "author": "tvernum", "createdAt": "2020-02-21T03:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MTIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM4NjY1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r382386651", "bodyText": "Actually, this is not as easy as it sounds.\nauthenticateWithApiKeyIfPresent is package protected, so it's really hard to mock.", "author": "tvernum", "createdAt": "2020-02-21T04:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MTIzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0MjY4OA==", "url": "https://github.com/elastic/elasticsearch/pull/52093#discussion_r381242688", "bodyText": "Should we add a test here to verify we process secondary authentication failures correctly?", "author": "jkakavas", "createdAt": "2020-02-19T11:48:30Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/rest/SecurityRestFilterTests.java", "diffHunk": "@@ -48,7 +49,9 @@\n \n public class SecurityRestFilterTests extends ESTestCase {", "originalCommit": "6fd9b62606b6e9f005bb76a679967541ae476bef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac77b0956f89d33828b63bd87b7f1cf906aa687c", "url": "https://github.com/elastic/elasticsearch/commit/ac77b0956f89d33828b63bd87b7f1cf906aa687c", "message": "Merge branch 'master' into multiple-auth-headers", "committedDate": "2020-02-21T03:21:29Z", "type": "commit"}, {"oid": "3dbfbd1847b8eca7a26c499b93a50829765844ef", "url": "https://github.com/elastic/elasticsearch/commit/3dbfbd1847b8eca7a26c499b93a50829765844ef", "message": "Address feedback", "committedDate": "2020-02-21T06:08:19Z", "type": "commit"}]}