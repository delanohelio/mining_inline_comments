{"pr_number": 59532, "pr_title": "Cleanup some Serialization Code around Snapshots", "pr_createdAt": "2020-07-14T12:54:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59532", "timeline": [{"oid": "c402d43cc290b9e446bedae1d0a68ee9578ac446", "url": "https://github.com/elastic/elasticsearch/commit/c402d43cc290b9e446bedae1d0a68ee9578ac446", "message": "Cleanup some Serialization Code around Snapshots\n\nA number of obvious possible simplifications that also improve efficiency\nin some cases (better empty collection handling and size hint use).\nAlso, added a shortcut for writing and reading immutable open maps that\ncan be used to dry up additional spots.", "committedDate": "2020-07-14T12:51:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NDIxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59532#discussion_r454344211", "bodyText": "We can remove this in master because we're checking against version 7.6 in that method.", "author": "original-brownbear", "createdAt": "2020-07-14T13:10:44Z", "path": "server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java", "diffHunk": "@@ -365,11 +401,7 @@ private boolean assertConsistent() {\n         public ShardSnapshotStatus(StreamInput in) throws IOException {\n             nodeId = in.readOptionalString();\n             state = ShardState.fromValue(in.readByte());\n-            if (SnapshotsService.useShardGenerations(in.getVersion())) {\n-                generation = in.readOptionalString();\n-            } else {\n-                generation = null;\n-            }\n+            generation = in.readOptionalString();", "originalCommit": "c402d43cc290b9e446bedae1d0a68ee9578ac446", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NzAxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59532#discussion_r454857019", "bodyText": "Can we add unit tests for this?", "author": "tlrx", "createdAt": "2020-07-15T07:45:24Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java", "diffHunk": "@@ -678,6 +679,25 @@ public final Boolean readOptionalBoolean() throws IOException {\n         return (Map<String, Object>) readGenericValue();\n     }\n \n+    /**\n+     * Read {@link ImmutableOpenMap} using given key and value readers.\n+     *\n+     * @param keyReader   key reader\n+     * @param valueReader value reader\n+     */\n+    public <K, V> ImmutableOpenMap<K, V> readImmutableMap(Writeable.Reader<K> keyReader, Writeable.Reader<V> valueReader)", "originalCommit": "c402d43cc290b9e446bedae1d0a68ee9578ac446", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NzA3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59532#discussion_r454857077", "bodyText": "Can we add unit tests for this?", "author": "tlrx", "createdAt": "2020-07-15T07:45:30Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java", "diffHunk": "@@ -600,6 +602,28 @@ public void writeMapWithConsistentOrder(@Nullable Map<String, ? extends Object>\n         }\n     }\n \n+    /**\n+     * Write a {@link ImmutableOpenMap} of {@code K}-type keys to {@code V}-type.\n+     *\n+     * @param keyWriter The key writer\n+     * @param valueWriter The value writer\n+     */\n+    public final <K, V> void writeMap(final ImmutableOpenMap<K, V> map, final Writer<K> keyWriter, final Writer<V> valueWriter)", "originalCommit": "c402d43cc290b9e446bedae1d0a68ee9578ac446", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4a15f8e302737dda4dcf4b4f4ecc8b7db542eb11", "url": "https://github.com/elastic/elasticsearch/commit/4a15f8e302737dda4dcf4b4f4ecc8b7db542eb11", "message": "Merge remote-tracking branch 'elastic/master' into cleanup-some-serialization", "committedDate": "2020-07-15T10:20:39Z", "type": "commit"}, {"oid": "2a098da58893d0de2402efdc104d942fd81843a7", "url": "https://github.com/elastic/elasticsearch/commit/2a098da58893d0de2402efdc104d942fd81843a7", "message": "CR: add tests", "committedDate": "2020-07-15T10:37:46Z", "type": "commit"}]}