{"pr_number": 50916, "pr_title": "Add SPI jvm option to SystemJvmOptions", "pr_createdAt": "2020-01-13T13:09:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50916", "timeline": [{"oid": "39379e4bbffea401eca5a649808904c2a6c823c8", "url": "https://github.com/elastic/elasticsearch/commit/39379e4bbffea401eca5a649808904c2a6c823c8", "message": "Add SPI jvm option to SystemJvmOptions\n\nAdding back accidently removed jvm options that is required to enfoce\nstart of the week = Monday in IsoCalendarDataProvider.", "committedDate": "2020-01-13T12:48:46Z", "type": "commit"}, {"oid": "53acc74c61c668697ff27bbf53ebedbf116e520a", "url": "https://github.com/elastic/elasticsearch/commit/53acc74c61c668697ff27bbf53ebedbf116e520a", "message": "change the way locale providers flag is set", "committedDate": "2020-01-13T15:38:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg3NzgwOA==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r365877808", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \"Date aggregartion per day of week\":\n          \n          \n            \n            \"Date aggregation per day of week\":", "author": "pugnascotia", "createdAt": "2020-01-13T15:50:58Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/310_date_agg_per_day_of_week.yml", "diffHunk": "@@ -0,0 +1,44 @@\n+\n+setup:\n+  - skip:\n+      version: \" - 7.5.99\" #todo this test failing on jdk8. has to be removed from 7.x\n+      reason:  \"Start of the week Monday was backported to 7.5\"\n+\n+\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              date:\n+                type: date\n+  - do:\n+      index:\n+        index: test\n+        id:    1\n+        body:  { \"date\": \"2009-11-15T14:12:12\" }\n+  - do:\n+      indices.refresh:\n+        index: [test]\n+---\n+# The inserted document has a field date=2009-11-15T14:12:12 which is Sunday.\n+# When aggregating per day of the week this should be considered as last day of the week (7)\n+# and this value should be used in 'key_as_string'\n+\"Date aggregartion per day of week\":", "originalCommit": "53acc74c61c668697ff27bbf53ebedbf116e520a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg5MzI2OA==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r365893268", "bodyText": "yes - as per todo this test is expected to fail in 1.8 https://github.com/elastic/elasticsearch/pull/50916/files#diff-a1dab819a2bedbcb781ecd85580cfbb5R4\nI am actually not sure how to work around this, the code for using IsoCalendarDataProvider is in 7.x but because we support JDK1.8 I won't be able to always pass the build.\nAny suggestions how to fix this?\nI am thinking of just removing the test for now..", "author": "pgomulka", "createdAt": "2020-01-13T16:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg3NzgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc0NzEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r366747131", "bodyText": "@pugnascotia @rjernst what is your view on this? Maybe we should extend the testing framework to allow checking runtime jvm and skip basing on this?\nhow about we work around this with features ? see the latest changes", "author": "pgomulka", "createdAt": "2020-01-15T08:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg3NzgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTc5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r367441795", "bodyText": "My feeling is that these changes are fine, but what I'm missing is some Javadoc to explain why they're necessary. Unless I have all the context around dates and JDK versions, I can't understand what the checks are for. The new feature name doesn't help here either. Can we add some more explanation into the code, to help other developers understand what is going on and why?", "author": "pugnascotia", "createdAt": "2020-01-16T14:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg3NzgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzgxMDI0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r367810243", "bodyText": "@pugnascotia good idea. will add some more javadocs as they are clearly missing", "author": "pgomulka", "createdAt": "2020-01-17T08:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg3NzgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ5NjY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r366496667", "bodyText": "Shouldn't this just be 8, not 8-?", "author": "rjernst", "createdAt": "2020-01-14T18:19:14Z", "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -75,3 +75,8 @@ ${error.file}\n \n # JDK 9+ GC logging\n 9-:-Xlog:gc*,gc+age=trace,safepoint:file=${loggc}:utctime,pid,tags:filecount=32,filesize=64m\n+\n+# due to internationalization enhancements in JDK 9 Elasticsearch need to set the provider to COMPAT otherwise\n+# time/date parsing will break in an incompatible way for some date patterns and locals\n+8-:-Djava.locale.providers=SPI,JRE", "originalCommit": "53acc74c61c668697ff27bbf53ebedbf116e520a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc0NTg2NA==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r366745864", "bodyText": "true, this should just be 8 - removed in favour of conditional check in SystemJvmOptions", "author": "pgomulka", "createdAt": "2020-01-15T08:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ5NjY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ5NzAyNA==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r366497024", "bodyText": "Why can't we keep this in system jvm options? Shouldn't this be something a user doesn't need to think about?", "author": "rjernst", "createdAt": "2020-01-14T18:19:59Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/SystemJvmOptions.java", "diffHunk": "@@ -59,12 +59,7 @@\n             \"-Dio.netty.allocator.numDirectArenas=0\",\n             // log4j 2\n             \"-Dlog4j.shutdownHookEnabled=false\",\n-            \"-Dlog4j2.disable.jmx=true\",\n-            /*\n-             * Due to internationalization enhancements in JDK 9 Elasticsearch need to set the provider to COMPAT otherwise time/date\n-             * parsing will break in an incompatible way for some date patterns and locales.\n-             */\n-            \"-Djava.locale.providers=COMPAT\"));", "originalCommit": "53acc74c61c668697ff27bbf53ebedbf116e520a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc0NTcxMg==", "url": "https://github.com/elastic/elasticsearch/pull/50916#discussion_r366745712", "bodyText": "you are right, it is better to stay in SystemJvmOptions. We can always check the version running with JavaVersion.majorVersion(JavaVersion.CURRENT) == 8 to choose the right settings", "author": "pgomulka", "createdAt": "2020-01-15T08:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ5NzAyNA=="}], "type": "inlineReview"}, {"oid": "77b0b7a109ad9554c6f4652b16ee251419072fd2", "url": "https://github.com/elastic/elasticsearch/commit/77b0b7a109ad9554c6f4652b16ee251419072fd2", "message": "make verion based chocie in system jvm options", "committedDate": "2020-01-15T08:29:19Z", "type": "commit"}, {"oid": "154c8abd13f255a450ba95c35bd00c02fb914058", "url": "https://github.com/elastic/elasticsearch/commit/154c8abd13f255a450ba95c35bd00c02fb914058", "message": "use features to skip a test on jdk8", "committedDate": "2020-01-15T10:30:11Z", "type": "commit"}, {"oid": "b3d3f9b15df130a89a8350fa52479d9a4a616131", "url": "https://github.com/elastic/elasticsearch/commit/b3d3f9b15df130a89a8350fa52479d9a4a616131", "message": "cleanup", "committedDate": "2020-01-15T10:34:46Z", "type": "commit"}, {"oid": "305c215f177abf0313ad76df44e2596df9258513", "url": "https://github.com/elastic/elasticsearch/commit/305c215f177abf0313ad76df44e2596df9258513", "message": "Merge branch '7.x' into fix/spi_provider_jvm_option", "committedDate": "2020-01-15T11:05:47Z", "type": "commit"}, {"oid": "76877bac174c22794406b960a5e7cc5f94143d69", "url": "https://github.com/elastic/elasticsearch/commit/76877bac174c22794406b960a5e7cc5f94143d69", "message": "change assertion on locale.provider setting as it will be different in jdk8 and newer", "committedDate": "2020-01-15T11:14:26Z", "type": "commit"}, {"oid": "c606038b6d1ed127b91d0922f9b95695f3f84f9d", "url": "https://github.com/elastic/elasticsearch/commit/c606038b6d1ed127b91d0922f9b95695f3f84f9d", "message": "Merge branch 'fix/spi_provider_jvm_option' of github.com:pgomulka/elasticsearch into fix/spi_provider_jvm_option", "committedDate": "2020-01-15T11:14:57Z", "type": "commit"}, {"oid": "8423ee07fc186da62aa5f5e47f4b0cbf49ad4555", "url": "https://github.com/elastic/elasticsearch/commit/8423ee07fc186da62aa5f5e47f4b0cbf49ad4555", "message": "Update rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/310_date_agg_per_day_of_week.yml\n\nCo-Authored-By: Rory Hunter <pugnascotia@users.noreply.github.com>", "committedDate": "2020-01-15T12:57:06Z", "type": "commit"}, {"oid": "5f872ae695bfaab3c9370f6483bf12a99f7d1f96", "url": "https://github.com/elastic/elasticsearch/commit/5f872ae695bfaab3c9370f6483bf12a99f7d1f96", "message": "rename", "committedDate": "2020-01-15T12:58:46Z", "type": "commit"}, {"oid": "5afbafaf07674165ed8561d14d16a00f1fbac6e1", "url": "https://github.com/elastic/elasticsearch/commit/5afbafaf07674165ed8561d14d16a00f1fbac6e1", "message": "add more javadoc", "committedDate": "2020-01-18T15:39:46Z", "type": "commit"}, {"oid": "a43d97a524fe1ba09d9e0da3b0af1f2f6b56d377", "url": "https://github.com/elastic/elasticsearch/commit/a43d97a524fe1ba09d9e0da3b0af1f2f6b56d377", "message": "cross ref", "committedDate": "2020-01-18T15:41:30Z", "type": "commit"}, {"oid": "724302bc8d323567335a7555ad2684cfde1b3d75", "url": "https://github.com/elastic/elasticsearch/commit/724302bc8d323567335a7555ad2684cfde1b3d75", "message": "link fix", "committedDate": "2020-01-20T10:25:50Z", "type": "commit"}, {"oid": "457c5cc2c1182ae385d50e1a6ac857c8193d28be", "url": "https://github.com/elastic/elasticsearch/commit/457c5cc2c1182ae385d50e1a6ac857c8193d28be", "message": "Merge branch '7.x' into fix/spi_provider_jvm_option", "committedDate": "2020-01-20T11:29:40Z", "type": "commit"}, {"oid": "f4cf3d8e54c27dc6dbe2840a62541273c2bfd6e3", "url": "https://github.com/elastic/elasticsearch/commit/f4cf3d8e54c27dc6dbe2840a62541273c2bfd6e3", "message": "remove empty lines", "committedDate": "2020-01-20T11:58:20Z", "type": "commit"}]}