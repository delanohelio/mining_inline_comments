{"pr_number": 57813, "pr_title": "Fix Broken Numeric Shard Generations in RepositoryData", "pr_createdAt": "2020-06-08T12:40:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57813", "timeline": [{"oid": "61b60867517b54cc892ebc1b230cced965ab2e2b", "url": "https://github.com/elastic/elasticsearch/commit/61b60867517b54cc892ebc1b230cced965ab2e2b", "message": "Fix Broken Numeric Shard Generations in RepositoryData\n\nFix broken numeric shard generations when reading them from the wire\nor physically from the physical repository.\nThis should be the cheapest way to clean up broken shard generations\nin a BwC and safe-to-backport manner for now. We can potentially\nfurther optimize this by also not doing the checks on the generations\nbased on the versions we see in the `RepositoryData` but I don't think\nit matters much since we will read `RepositoryData` from cache in almost\nall cases.\n\nCloses #57798", "committedDate": "2020-06-08T12:33:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNTQ3NA==", "url": "https://github.com/elastic/elasticsearch/pull/57813#discussion_r436705474", "bodyText": "I think we should avoid putting null values into the map (in particular as ShardGenerations.Builder.put does not seem to define @Nullable String generation, and the semantics of putting null into map can be problematic, as the Map interface says the behavior is underspecified whether a NPE is thrown). I would prefer a boolean method here with conditional logic", "author": "ywelsch", "createdAt": "2020-06-08T13:35:26Z", "path": "server/src/main/java/org/elasticsearch/repositories/RepositoryData.java", "diffHunk": "@@ -615,7 +619,9 @@ public static RepositoryData snapshotsFromXContent(final XContentParser parser,\n                         assert indexId != null;\n                         indexSnapshots.put(indexId, Collections.unmodifiableList(snapshotIds));\n                         for (int i = 0; i < gens.size(); i++) {\n-                            shardGenerations.put(indexId, i, gens.get(i));\n+                            final String parsedGen = gens.get(i);\n+                            shardGenerations.put(\n+                                    indexId, i, fixBrokenShardGens ? ShardGenerations.fixShardGeneration(parsedGen) : parsedGen);", "originalCommit": "61b60867517b54cc892ebc1b230cced965ab2e2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcyNDU4OA==", "url": "https://github.com/elastic/elasticsearch/pull/57813#discussion_r436724588", "bodyText": "++ done", "author": "original-brownbear", "createdAt": "2020-06-08T13:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNTQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcxMTkxNw==", "url": "https://github.com/elastic/elasticsearch/pull/57813#discussion_r436711917", "bodyText": "why true here?", "author": "ywelsch", "createdAt": "2020-06-08T13:43:55Z", "path": "test/framework/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreTestUtil.java", "diffHunk": "@@ -129,7 +129,7 @@ public static void assertConsistency(BlobStoreRepository repository, Executor ex\n                 try (InputStream blob = blobContainer.readBlob(\"index-\" + latestGen);\n                      XContentParser parser = XContentType.JSON.xContent().createParser(NamedXContentRegistry.EMPTY,\n                          LoggingDeprecationHandler.INSTANCE, blob)) {\n-                    repositoryData = RepositoryData.snapshotsFromXContent(parser, latestGen);\n+                    repositoryData = RepositoryData.snapshotsFromXContent(parser, latestGen, true);", "originalCommit": "61b60867517b54cc892ebc1b230cced965ab2e2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcyMjc0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57813#discussion_r436722746", "bodyText": "Right my bad no reason to be lenient here ... moved to false.", "author": "original-brownbear", "createdAt": "2020-06-08T13:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcxMTkxNw=="}], "type": "inlineReview"}, {"oid": "655c7f3d9f3753a68f2c98718d51ea812fd0f0fd", "url": "https://github.com/elastic/elasticsearch/commit/655c7f3d9f3753a68f2c98718d51ea812fd0f0fd", "message": "CR: comments", "committedDate": "2020-06-08T13:52:10Z", "type": "commit"}, {"oid": "ae840808741e96465c49ceac4e4471f56801e651", "url": "https://github.com/elastic/elasticsearch/commit/ae840808741e96465c49ceac4e4471f56801e651", "message": "Merge remote-tracking branch 'elastic/master' into broken-repo-data-auto-repair", "committedDate": "2020-06-08T13:53:26Z", "type": "commit"}]}