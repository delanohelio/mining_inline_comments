{"pr_number": 64068, "pr_title": "Limit blast redius of SearchContext in aggs", "pr_createdAt": "2020-10-22T14:20:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64068", "timeline": [{"oid": "f3484fdffc803d3699f2e620c3be83b3a080c2d8", "url": "https://github.com/elastic/elasticsearch/commit/f3484fdffc803d3699f2e620c3be83b3a080c2d8", "message": "Limit blast redius of SearchContext in aggs\n\nThis takes away access to the `SearchContext` from all subclasses of\n`Aggregator`. Now they have access to three things:\n* BigArrays\n* The top level Query\n* The IndexSearcher\n\nThese are used by a whole bunch of aggs.\n\nThis is a useful change because `SearchContext` is very large and\ndifficult to mock in tests and difficult to reason about in general.\nLimiting what aggs can use when they are being collected helps with\nthis.\n\nWe still pass `SearchContext` to `AggregatorBase`'s ctor so the thing is\nstill around. But we can remove that access in a follow up.", "committedDate": "2020-10-22T13:06:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIwMzc5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64068#discussion_r510203792", "bodyText": "I expect this method call to get inlined. It is a chain of a few method calls, one of which is bimorphic, but the bimorphic call is on a final field so I think the compiler can inline that too. My guess is that this is going to end up compiled to a field access so running it once and putting it in a local isn't going to help.", "author": "nik9000", "createdAt": "2020-10-22T14:23:11Z", "path": "modules/aggs-matrix-stats/src/main/java/org/elasticsearch/search/aggregations/matrix/stats/MatrixStatsAggregator.java", "diffHunk": "@@ -83,7 +81,7 @@ public LeafBucketCollector getLeafCollector(LeafReaderContext ctx,\n             public void collect(int doc, long bucket) throws IOException {\n                 // get fields\n                 if (includeDocument(doc)) {\n-                    stats = bigArrays.grow(stats, bucket + 1);\n+                    stats = bigArrays().grow(stats, bucket + 1);", "originalCommit": "f3484fdffc803d3699f2e620c3be83b3a080c2d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}