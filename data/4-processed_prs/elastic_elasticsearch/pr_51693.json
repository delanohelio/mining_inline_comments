{"pr_number": 51693, "pr_title": "Wire PercentileRanks aggregator into new VS framework ", "pr_createdAt": "2020-01-30T17:57:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51693", "timeline": [{"oid": "a954b150059d8c4090c5ef5064a60d81246ed71c", "url": "https://github.com/elastic/elasticsearch/commit/a954b150059d8c4090c5ef5064a60d81246ed71c", "message": "Wire Percentiles aggregator into new VS framework\n\nThis required a bit of a refactor to percentiles itself.  Before,\nthe Builder would switch on the chosen algo to generate an\nalgo-specific factory.  This doesn't work (or at least, would be\ndifficult) in the new VS framework.\n\nThis refactor consolidates both factories together and introduces\na PercentilesConfig object to act as a standardized way to pass\nalgo-specific parameters through the factory.  This object\nis then used when deciding which kind of aggregator to create\n\nNote: CoreValuesSourceType.HISTOGRAM still lives in core, and will\nbe moved in a subsequent PR.", "committedDate": "2020-01-29T17:18:05Z", "type": "commit"}, {"oid": "ad19003291f41b9c9218058bddda9d6e2f1983ac", "url": "https://github.com/elastic/elasticsearch/commit/ad19003291f41b9c9218058bddda9d6e2f1983ac", "message": "Wire PercentileRanks aggregator into new VS framework\n\nLike Percentiles, this refactors consolidates both factories\ntogether, using PercentilesConfig object to act as a standardized\nway to pass algo-specific parameters through the factory.", "committedDate": "2020-01-30T17:52:23Z", "type": "commit"}, {"oid": "d89f70f3f40c9187fec3687227b217c6764d19ee", "url": "https://github.com/elastic/elasticsearch/commit/d89f70f3f40c9187fec3687227b217c6764d19ee", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor", "committedDate": "2020-01-31T18:15:35Z", "type": "commit"}, {"oid": "d70449879ac2b5beb66e855562ef312760fe374f", "url": "https://github.com/elastic/elasticsearch/commit/d70449879ac2b5beb66e855562ef312760fe374f", "message": "Throw IllegalStateException for bad methods", "committedDate": "2020-01-31T18:17:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5MTIxOA==", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r374191218", "bodyText": "In conjunction with my comment below, I think it makes sense for the config object to live with the PercentilesMethod enum, rather than one of the builders.  Kind of arbitrary which builder it lands on.", "author": "not-napoleon", "createdAt": "2020-02-03T16:07:24Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentileRanksAggregationBuilder.java", "diffHunk": "@@ -30,19 +30,22 @@\n import org.elasticsearch.search.aggregations.AggregationBuilder;\n import org.elasticsearch.search.aggregations.AggregatorFactories.Builder;\n import org.elasticsearch.search.aggregations.AggregatorFactory;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesAggregationBuilder.PercentilesConfig;", "originalCommit": "d70449879ac2b5beb66e855562ef312760fe374f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5MzkyMg==", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r374193922", "bodyText": "We've got this same cascading if in two places now, and cascading if or switch blocks on enums are kind of dodgy to begin with.  I propose a method on PercentilesMethod that takes two args, compression and number of significant digits, ignores whichever doesn't apply to that method, and returns the config.  This has the added benefit that we don't need the unreachable throw block here (unreachable since it would have already thrown trying to parse the bad method name)", "author": "not-napoleon", "createdAt": "2020-02-03T16:11:57Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentileRanksAggregationBuilder.java", "diffHunk": "@@ -246,16 +256,17 @@ public PercentilesMethod method() {\n     @Override\n     protected ValuesSourceAggregatorFactory innerBuild(QueryShardContext queryShardContext, ValuesSourceConfig config,\n                                                        AggregatorFactory parent, Builder subFactoriesBuilder) throws IOException {\n-        switch (method) {\n-        case TDIGEST:\n-            return new TDigestPercentileRanksAggregatorFactory(name, config, values, compression, keyed, queryShardContext, parent,\n-                    subFactoriesBuilder, metaData);\n-        case HDR:\n-            return new HDRPercentileRanksAggregatorFactory(name, config, values, numberOfSignificantValueDigits, keyed, queryShardContext,\n-                    parent, subFactoriesBuilder, metaData);\n-        default:\n+        PercentilesConfig percentilesConfig;\n+        if (method.equals(PercentilesMethod.TDIGEST)) {\n+            percentilesConfig = new PercentilesConfig.TDigestConfig(compression);\n+        } else if (method.equals(PercentilesMethod.HDR)) {\n+            percentilesConfig = new PercentilesConfig.HdrHistoConfig(numberOfSignificantValueDigits);\n+        } else {", "originalCommit": "d70449879ac2b5beb66e855562ef312760fe374f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a536eda62b3ff742d05062e8ca861b1d44a3b16", "url": "https://github.com/elastic/elasticsearch/commit/8a536eda62b3ff742d05062e8ca861b1d44a3b16", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor", "committedDate": "2020-02-12T19:01:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1MjE3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r380752177", "bodyText": "Nit: Inconsistent indentation", "author": "not-napoleon", "createdAt": "2020-02-18T15:38:28Z", "path": "server/src/main/java/org/elasticsearch/search/SearchModule.java", "diffHunk": "@@ -360,7 +360,8 @@ private void registerAggregations(List<SearchPlugin> plugins) {\n         registerAggregation(new AggregationSpec(PercentileRanksAggregationBuilder.NAME, PercentileRanksAggregationBuilder::new,\n                 PercentileRanksAggregationBuilder::parse)\n                         .addResultReader(InternalTDigestPercentileRanks.NAME, InternalTDigestPercentileRanks::new)\n-                        .addResultReader(InternalHDRPercentileRanks.NAME, InternalHDRPercentileRanks::new));\n+                        .addResultReader(InternalHDRPercentileRanks.NAME, InternalHDRPercentileRanks::new)\n+                .setAggregatorRegistrar(PercentileRanksAggregationBuilder::registerAggregators));", "originalCommit": "8a536eda62b3ff742d05062e8ca861b1d44a3b16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1NDAwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r380754005", "bodyText": "Are we intentionally not supporting dates here? Do we allow percentile ranks over date fields now?  I'm actually not sure, but we should probably make sure we're not losing functionality by accident.", "author": "not-napoleon", "createdAt": "2020-02-18T15:41:06Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentileRanksAggregatorFactory.java", "diffHunk": "@@ -39,6 +44,22 @@\n     private final PercentilesConfig percentilesConfig;\n     private final boolean keyed;\n \n+    static void registerAggregators(ValuesSourceRegistry valuesSourceRegistry) {\n+        valuesSourceRegistry.register(PercentileRanksAggregationBuilder.NAME,\n+            List.of(CoreValuesSourceType.NUMERIC, CoreValuesSourceType.HISTOGRAM),", "originalCommit": "8a536eda62b3ff742d05062e8ca861b1d44a3b16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY2NTE4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r386665181", "bodyText": "Closing the loop on this: after implementing the \"supported type\" test in master, and adding percentiles/ranks to the testing, we need to support CoreValuesSourceType.NUMERIC, CoreValuesSourceType.HISTOGRAM, CoreValuesSourceType.DATE, CoreValuesSourceType.BOOLEAN\nPhew!", "author": "polyfractal", "createdAt": "2020-03-02T21:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1NDAwNQ=="}], "type": "inlineReview"}, {"oid": "e032424911e5229e72cca5d8e2fc0e53552ef73a", "url": "https://github.com/elastic/elasticsearch/commit/e032424911e5229e72cca5d8e2fc0e53552ef73a", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor", "committedDate": "2020-03-02T20:42:04Z", "type": "commit"}, {"oid": "cc6693e2e0d96d54e8554146a4f1c8c655a5d902", "url": "https://github.com/elastic/elasticsearch/commit/cc6693e2e0d96d54e8554146a4f1c8c655a5d902", "message": "Adjust supported types", "committedDate": "2020-03-02T21:27:51Z", "type": "commit"}, {"oid": "1f607c3a4e2c992e1c97c12249fd91ac8e530ed7", "url": "https://github.com/elastic/elasticsearch/commit/1f607c3a4e2c992e1c97c12249fd91ac8e530ed7", "message": "Fix formatting", "committedDate": "2020-03-02T21:37:31Z", "type": "commit"}, {"oid": "dcf014bae47c6dfa38e5a5a5f52c03248854e493", "url": "https://github.com/elastic/elasticsearch/commit/dcf014bae47c6dfa38e5a5a5f52c03248854e493", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor", "committedDate": "2020-03-03T16:45:52Z", "type": "commit"}]}