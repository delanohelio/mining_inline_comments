{"pr_number": 65884, "pr_title": "Remove usage of .watches system index in full cluster restart.", "pr_createdAt": "2020-12-04T13:51:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65884", "timeline": [{"oid": "e3c185aa650a4698d8b92bf5f1bd09118544c60e", "url": "https://github.com/elastic/elasticsearch/commit/e3c185aa650a4698d8b92bf5f1bd09118544c60e", "message": "Remove usage of .watches system index in full cluster restart.\n\nMake use for the cluster state api to check the index.format setting\nof the .watches index instead of querying the index settings api.\n\nThis removes the last direct usage of .watches index mentioned in #62501.", "committedDate": "2020-12-04T13:49:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0MDQ0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65884#discussion_r536340448", "bodyText": "nit: GET /_cluster/state/metadata/.watches would be tiny bit more efficient.", "author": "jakelandis", "createdAt": "2020-12-04T19:47:30Z", "path": "x-pack/qa/full-cluster-restart/src/test/java/org/elasticsearch/xpack/restart/FullClusterRestartIT.java", "diffHunk": "@@ -179,25 +179,12 @@ public void testWatcher() throws Exception {\n \n             logger.info(\"checking that the Watches index is the correct version\");\n \n-            final Request getSettingsRequest = new Request(\"GET\", \"/.watches/_settings/index.format\");\n-            getSettingsRequest.setOptions(expectWarnings(\"this request accesses system indices: [.watches], but in a future major \" +\n-                \"version, direct access to system indices will be prevented by default\"));\n-            Response settingsResponse = client().performRequest(getSettingsRequest);\n-            Map<String, Object> settingsResponseMap = entityAsMap(settingsResponse);\n-            logger.info(\"settings response map {}\", settingsResponseMap);\n-            final String concreteWatchesIndex;\n-            if (settingsResponseMap.isEmpty()) {\n-                fail(\"The security index does not have the expected setting [index.format]\");\n-            } else {\n-                concreteWatchesIndex = settingsResponseMap.keySet().iterator().next();\n-                Map<?, ?> indexSettingsMap = (Map<?, ?>) settingsResponseMap.get(concreteWatchesIndex);\n-                Map<?, ?> settingsMap = (Map<?, ?>) indexSettingsMap.get(\"settings\");\n-                logger.info(\"settings map {}\", settingsMap);\n-                if (settingsMap.containsKey(\"index\")) {\n-                    int format = Integer.parseInt(String.valueOf(((Map<?, ?>)settingsMap.get(\"index\")).get(\"format\")));\n-                    assertEquals(\"The watches index needs to be upgraded\", UPGRADE_FIELD_EXPECTED_INDEX_FORMAT_VERSION, format);\n-                }\n-            }\n+            // Verify .watches index format:\n+            var getClusterStateResponse = entityAsMap(client().performRequest(new Request(\"GET\", \"/_cluster/state\")));", "originalCommit": "e3c185aa650a4698d8b92bf5f1bd09118544c60e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccdc6edcc6f1651943d7a71d35039cc1fd38f867", "url": "https://github.com/elastic/elasticsearch/commit/ccdc6edcc6f1651943d7a71d35039cc1fd38f867", "message": "Merge remote-tracking branch 'es/master' into remove_last_direct_.watch_access", "committedDate": "2020-12-07T10:32:52Z", "type": "commit"}, {"oid": "2b83cf667097ea52c81a34d837d1915ce9501f6d", "url": "https://github.com/elastic/elasticsearch/commit/2b83cf667097ea52c81a34d837d1915ce9501f6d", "message": "iter", "committedDate": "2020-12-07T10:58:08Z", "type": "commit"}]}