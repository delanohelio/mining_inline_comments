{"pr_number": 56926, "pr_title": "Add individual precommit task plugins", "pr_createdAt": "2020-05-18T22:04:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56926", "timeline": [{"oid": "9aeca878a3c8302617f0215a950fef45e9e12003", "url": "https://github.com/elastic/elasticsearch/commit/9aeca878a3c8302617f0215a950fef45e9e12003", "message": "Add individual precommit task plugins\n\nEach precommit task is currently registered inside the shared\nPrecommitTasks class. Having a single class with all precommit tasks\nmakes individualizing which precommit tasks are needed based on type of\nproject difficult, where we often just disable somet tasks eg for all qa\nprojects. This commit creates plugins for each precommit task, and moves\nthe configuration of the task into each plugin. PrecommitTasks remains\nfor now, and just delegates to each plugin, but will be removed in a\nfuture change.", "committedDate": "2020-05-18T22:01:51Z", "type": "commit"}, {"oid": "1b4afbfcddcc2dc44c974e07a7ca28a4a7cdef09", "url": "https://github.com/elastic/elasticsearch/commit/1b4afbfcddcc2dc44c974e07a7ca28a4a7cdef09", "message": "iter", "committedDate": "2020-05-18T22:30:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427199127", "bodyText": "I think it would be better to not extend this Plugin in other PrecommitPlugins but use composition here. So we would have a PreCommit plugin that is applied by all other specific PreCommitPlugins (e.g. the CheckstylePreCommitPlugin). The PreCommitPlugin would only create a 'precommit' task that depends on all tasks of a certain marker type like tasks.withType(PreCommitTask.class). The other specific precommit plugins would only need to ensure that the tasks they create are of type PreCommitTask which can be just common interface.\nAlso this maybeRegister method is relative expensive.", "author": "breskeby", "createdAt": "2020-05-19T10:32:35Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitPlugin.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.precommit;\n+\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.Task;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.plugins.JavaPlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.language.base.plugins.LifecycleBasePlugin;\n+\n+/**\n+ * Base plugin for adding a precommit task.\n+ */\n+public abstract class PrecommitPlugin implements Plugin<Project> {", "originalCommit": "9aeca878a3c8302617f0215a950fef45e9e12003", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIwNTA0NA==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427205044", "bodyText": "Thinking more about it an alternative would be if the specific PreCommit plugins are just responsible to wire things against the precommit task. That way you could skip the specific common task type. so these plugins would look always like\n...\napply(PreCommitPlugin)\n// register tasks I want to wire\ntasks.named(\"precommit\").configure { dependsOn 'specificTask; }\n...", "author": "breskeby", "createdAt": "2020-05-19T10:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI4OTQ1MA==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427289450", "bodyText": "I think it would be better to not extend this Plugin in other PrecommitPlugins but use composition here\n\nUsing inheritance allows us ensure the correct wirings happen. With composition, we can forget to hook up the new task to precommit, but with inheritance we enforce this because the class and createTask methods are abstract. Additionally, it wouldn't make sense to have precommit alone, it only makes sense in the context of having a concrete task like forbiddenapis.\n\nThe other specific precommit plugins would only need to ensure that the tasks they create are of type PreCommitTask\n\nWe can't guarantee this since some tasks are external, like forbidden apis or checkstyle.", "author": "rjernst", "createdAt": "2020-05-19T13:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMzNTMxMg==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427335312", "bodyText": "I see. I would still split out the generation of the precommit task to a small (internal) plugin (e.g. PrecommitBase Plugin. By internal I mean we would not need to provide a public id for the plugin or even make it package protected. And here we would just apply this base plugin. This way we\na) ensure this task registration is done in a gradle idiomatic way\nb) ensure its only applied by the specific PreCommit Plugins.\nthis is a common pattern in gradle where a plugin just provides a lifecycle task and other plugins hook into this lifecycle.", "author": "breskeby", "createdAt": "2020-05-19T14:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM1NjEzMw==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427356133", "bodyText": "I think a separate plugin that creates the precommit task might be the way to go as well. Primary reason being that maybeRegister does exception-based flow control, which is incredibly expensive and basically negates all benefits of lazy tasks. In fact, I'd recommend we completely remove that method so folks don't use it. We are throwing hundreds of exceptions here during configuration time. Filling all those stack frames has a big penalty.", "author": "mark-vieira", "createdAt": "2020-05-19T14:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM1OTE3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427359177", "bodyText": "I don't know enough yet to understand how much this method is used. But for sure we could deprecate it.", "author": "breskeby", "createdAt": "2020-05-19T14:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM2MzI0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427363243", "bodyText": "I believe this is the only usage. Since that is the case we should remove it and find another way here. The findByName method has the same problem. When investigating doing some more lazy task stuff I found that switching creation to registration leveraging findByName was slower due to all the additional exceptions. We should try and get this added to Gradle core in a proper API instead.", "author": "mark-vieira", "createdAt": "2020-05-19T14:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM2NzUxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427367511", "bodyText": "\ud83d\udc4d small general thought on findByName. findByName often is an indicator of weak modelling that can be improved. I think in the build there's a lot of logic that is based on tasks that are around which should be more about what type of project (which plugins are applied) are we dealing with.", "author": "breskeby", "createdAt": "2020-05-19T14:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM3NTMwNg==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427375306", "bodyText": "findByName often is an indicator of weak modelling that can be improved\nThat's definitely true. If you have to check if a task exists that indicates a code smell.", "author": "mark-vieira", "createdAt": "2020-05-19T15:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM3NjI4MA==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427376280", "bodyText": "After chatting with Ryan I think I'm fine with plugin class extension. I'm less concerned about extending plugins when the superclass is abstract, that at least indicates this is purposeful. Extending non-abstract plugins is a no-no, and composition should be used instead as you say.\nWe can then have the abstract plugin apply a plugin which creates the precommit task that way Gradle handles idempotency for us rather than using maybeRegister.", "author": "mark-vieira", "createdAt": "2020-05-19T15:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM4NTEzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427385135", "bodyText": "We can then have the abstract plugin apply a plugin which creates the precommit task that way Gradle handles idempotency for us rather than using maybeRegister.\n\n\ud83d\udc4d", "author": "breskeby", "createdAt": "2020-05-19T15:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM5MzA4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427393081", "bodyText": "I pushed b5dff57 which no longer uses maybeCreate. Instead we have an inner plugin that creates the task, but we still use inheritance to ensure we don't forget to add a task to it.", "author": "rjernst", "createdAt": "2020-05-19T15:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5OTEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMzNjc5OA==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427336798", "bodyText": "In my opinion we should extract that into a JavaPreCommit plugin. this also ensure this code is not executed more than once per project.", "author": "breskeby", "createdAt": "2020-05-19T14:16:52Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitPlugin.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.precommit;\n+\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.Task;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.plugins.JavaPlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.language.base.plugins.LifecycleBasePlugin;\n+\n+/**\n+ * Base plugin for adding a precommit task.\n+ */\n+public abstract class PrecommitPlugin implements Plugin<Project> {\n+    @Override\n+    public final void apply(Project project) {\n+        TaskProvider<? extends Task> task = createTask(project);\n+        TaskProvider<DefaultTask> precommit = GradleUtils.maybeRegister(project.getTasks(), \"precommit\", DefaultTask.class, t -> {\n+            t.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n+            t.setDescription(\"Runs all non-test checks\");\n+        });\n+        precommit.configure(t -> t.dependsOn(task));\n+\n+        project.getPluginManager().withPlugin(\"java\", p -> {", "originalCommit": "9aeca878a3c8302617f0215a950fef45e9e12003", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM5NDk3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56926#discussion_r427394972", "bodyText": "It's not doing anything extra, there is no java precommit task. This is only ensuring when we have java projects with precommit, we wire up the precommit task in the desired order. I can move it so it is only applied once.", "author": "rjernst", "createdAt": "2020-05-19T15:29:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMzNjc5OA=="}], "type": "inlineReview"}, {"oid": "097877dae034ac42b9d431dcb4426cd9c4a5c646", "url": "https://github.com/elastic/elasticsearch/commit/097877dae034ac42b9d431dcb4426cd9c4a5c646", "message": "use actual Closure", "committedDate": "2020-05-19T14:47:11Z", "type": "commit"}, {"oid": "778d71a5b0076e9ed90a642c301670b43515b098", "url": "https://github.com/elastic/elasticsearch/commit/778d71a5b0076e9ed90a642c301670b43515b098", "message": "Merge branch 'master' into buildsplit7", "committedDate": "2020-05-19T14:47:40Z", "type": "commit"}, {"oid": "b5dff5714484b9779d506e0e70a0f4826750da42", "url": "https://github.com/elastic/elasticsearch/commit/b5dff5714484b9779d506e0e70a0f4826750da42", "message": "only create precommit once", "committedDate": "2020-05-19T15:25:36Z", "type": "commit"}, {"oid": "ff9c4625c4f264fa4e8950b57d98ee7e2dcbdade", "url": "https://github.com/elastic/elasticsearch/commit/ff9c4625c4f264fa4e8950b57d98ee7e2dcbdade", "message": "split java specific to not be repeated", "committedDate": "2020-05-19T15:30:58Z", "type": "commit"}, {"oid": "cd68d7361795f8cf7416b5e3aabac0f266a3fed1", "url": "https://github.com/elastic/elasticsearch/commit/cd68d7361795f8cf7416b5e3aabac0f266a3fed1", "message": "fix eql licenses", "committedDate": "2020-05-19T16:08:42Z", "type": "commit"}, {"oid": "89c170dd99b48ed64418d05c3b9034b72347c409", "url": "https://github.com/elastic/elasticsearch/commit/89c170dd99b48ed64418d05c3b9034b72347c409", "message": "package protected internal plugin", "committedDate": "2020-05-19T16:26:24Z", "type": "commit"}, {"oid": "aa5fb8a9d700ec6b04632a19cb6e49320ddbaf38", "url": "https://github.com/elastic/elasticsearch/commit/aa5fb8a9d700ec6b04632a19cb6e49320ddbaf38", "message": "remove debug", "committedDate": "2020-05-19T16:27:46Z", "type": "commit"}, {"oid": "68c93e93227dcec844685c18db73a1fcfd6dc80c", "url": "https://github.com/elastic/elasticsearch/commit/68c93e93227dcec844685c18db73a1fcfd6dc80c", "message": "actually add license files", "committedDate": "2020-05-19T16:28:02Z", "type": "commit"}, {"oid": "8cc4c284aa9e0e4ea5788e4556b86ece28c6a26c", "url": "https://github.com/elastic/elasticsearch/commit/8cc4c284aa9e0e4ea5788e4556b86ece28c6a26c", "message": "overwrite existing checkstyle config", "committedDate": "2020-05-19T16:36:19Z", "type": "commit"}, {"oid": "e825db5e8c487f5a55d7d611f0c719b88a902e12", "url": "https://github.com/elastic/elasticsearch/commit/e825db5e8c487f5a55d7d611f0c719b88a902e12", "message": "Merge branch 'master' into buildsplit7", "committedDate": "2020-05-20T02:43:33Z", "type": "commit"}, {"oid": "32ef97117c2b79f0f03ffb59eabfe77eaa478a99", "url": "https://github.com/elastic/elasticsearch/commit/32ef97117c2b79f0f03ffb59eabfe77eaa478a99", "message": "spotless", "committedDate": "2020-05-20T02:50:58Z", "type": "commit"}, {"oid": "661d52785abfe33b7cd5296e2d0984d58a250377", "url": "https://github.com/elastic/elasticsearch/commit/661d52785abfe33b7cd5296e2d0984d58a250377", "message": "add back substractions of compileOnly", "committedDate": "2020-05-20T16:17:48Z", "type": "commit"}, {"oid": "a59ee84673c32e85236d6377a6b86562cb426492", "url": "https://github.com/elastic/elasticsearch/commit/a59ee84673c32e85236d6377a6b86562cb426492", "message": "revert eql change", "committedDate": "2020-05-20T18:25:16Z", "type": "commit"}, {"oid": "f7919c8ef4aff283c8b87a7f1e455b514c358cff", "url": "https://github.com/elastic/elasticsearch/commit/f7919c8ef4aff283c8b87a7f1e455b514c358cff", "message": "remove licenses dir", "committedDate": "2020-05-20T18:30:14Z", "type": "commit"}, {"oid": "6d1110715073ebb5a8e207617c512e15b4b2ac34", "url": "https://github.com/elastic/elasticsearch/commit/6d1110715073ebb5a8e207617c512e15b4b2ac34", "message": "Merge branch 'master' into buildsplit7", "committedDate": "2020-05-20T18:31:43Z", "type": "commit"}]}