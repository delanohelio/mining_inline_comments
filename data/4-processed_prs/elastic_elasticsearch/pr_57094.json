{"pr_number": 57094, "pr_title": "Release HTTP Request Body Earlier", "pr_createdAt": "2020-05-24T20:03:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57094", "timeline": [{"oid": "bdd773a6770bc932ae849c99aeb653e1eb53108d", "url": "https://github.com/elastic/elasticsearch/commit/bdd773a6770bc932ae849c99aeb653e1eb53108d", "message": "Release HTTP Request Body Earlier\n\nWe don't need to hold on to the request body past the beginning of sending\nthe response. There is no need to keep a reference to it until after the response\nhas been sent fully and we can eagerly release it here.\nNote, this can be optimized further to release the contents even earlier but for now\nthis is an easy increment to saving some memory on the IO pool.", "committedDate": "2020-05-24T20:00:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4MDI4NA==", "url": "https://github.com/elastic/elasticsearch/pull/57094#discussion_r429680284", "bodyText": "sorry maybe a naive comment, is it better to name public api getRequestHeaders ?", "author": "keypointt", "createdAt": "2020-05-24T22:14:46Z", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/http/netty4/Netty4HttpResponse.java", "diffHunk": "@@ -45,8 +47,8 @@ public boolean containsHeader(String name) {\n         return headers().contains(name);\n     }\n \n-    public Netty4HttpRequest getRequest() {\n-        return request;\n+    public HttpHeaders requestHeaders() {\n+        return requestHeaders;\n     }", "originalCommit": "bdd773a6770bc932ae849c99aeb653e1eb53108d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2NDU2OA==", "url": "https://github.com/elastic/elasticsearch/pull/57094#discussion_r429764568", "bodyText": "I figured if we release the request before using these parts (version and headers) it's a little nicer not to pass the full request around. Also, for non-pooled allocation (this includes all requests that aren't search or bulk) this makes the GC's life a little easier)", "author": "original-brownbear", "createdAt": "2020-05-25T07:04:38Z", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/http/netty4/Netty4HttpResponse.java", "diffHunk": "@@ -20,19 +20,21 @@\n package org.elasticsearch.http.netty4;\n \n import io.netty.handler.codec.http.DefaultFullHttpResponse;\n+import io.netty.handler.codec.http.HttpHeaders;\n import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.netty.handler.codec.http.HttpVersion;\n import org.elasticsearch.common.bytes.BytesReference;\n import org.elasticsearch.http.HttpResponse;\n import org.elasticsearch.rest.RestStatus;\n import org.elasticsearch.transport.netty4.Netty4Utils;\n \n public class Netty4HttpResponse extends DefaultFullHttpResponse implements HttpResponse {\n \n-    private final Netty4HttpRequest request;\n+    private final HttpHeaders requestHeaders;\n \n-    Netty4HttpResponse(Netty4HttpRequest request, RestStatus status, BytesReference content) {\n-        super(request.nettyRequest().protocolVersion(), HttpResponseStatus.valueOf(status.getStatus()), Netty4Utils.toByteBuf(content));\n-        this.request = request;\n+    Netty4HttpResponse(HttpHeaders requestHeaders, HttpVersion version, RestStatus status, BytesReference content) {", "originalCommit": "bdd773a6770bc932ae849c99aeb653e1eb53108d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgyMDgxNA==", "url": "https://github.com/elastic/elasticsearch/pull/57094#discussion_r429820814", "bodyText": "Do the same for NioCorsHandler here?", "author": "ywelsch", "createdAt": "2020-05-25T09:02:54Z", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/http/netty4/cors/Netty4CorsHandler.java", "diffHunk": "@@ -93,20 +93,20 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception\n     public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n         assert msg instanceof Netty4HttpResponse : \"Invalid message type: \" + msg.getClass();\n         Netty4HttpResponse response = (Netty4HttpResponse) msg;\n-        setCorsResponseHeaders(response.getRequest().nettyRequest(), response, config);\n+        setCorsResponseHeaders(response.requestHeaders(), response, config);\n         ctx.write(response, promise);\n     }\n \n-    public static void setCorsResponseHeaders(HttpRequest request, HttpResponse resp, CorsHandler.Config config) {\n+    public static void setCorsResponseHeaders(HttpHeaders headers, HttpResponse resp, CorsHandler.Config config) {", "originalCommit": "bdd773a6770bc932ae849c99aeb653e1eb53108d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "53d6af5f50cf46c0ead7dd96828f8b946f40d795", "url": "https://github.com/elastic/elasticsearch/commit/53d6af5f50cf46c0ead7dd96828f8b946f40d795", "message": "Merge remote-tracking branch 'elastic/master' into simplify-rest-req-handling", "committedDate": "2020-05-25T09:06:44Z", "type": "commit"}, {"oid": "3b7ebcf2e93301178833a1ee61470b23cefafb01", "url": "https://github.com/elastic/elasticsearch/commit/3b7ebcf2e93301178833a1ee61470b23cefafb01", "message": "CR: align NIO", "committedDate": "2020-05-25T09:18:05Z", "type": "commit"}]}