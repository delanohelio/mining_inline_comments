{"pr_number": 64922, "pr_title": "[Transform] make state handling more robust when stop is called while indexer shuts down", "pr_createdAt": "2020-11-11T13:20:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64922", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzODYzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521438631", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n          \n          \n            \n                                            onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));\n          \n          \n            \n                                            onFinishResponse -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\n          \n          \n            \n                                            onFinishFailure -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));", "author": "benwtrent", "createdAt": "2020-11-11T15:29:52Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -222,8 +222,8 @@ public synchronized boolean maybeTriggerAsyncJob(long now) {\n                             nextSearch();\n                         } else {\n                             onFinish(ActionListener.wrap(\n-                                onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {}),\n-                                onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {})));\n+                                onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n+                                onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzODkyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521438923", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);", "author": "benwtrent", "createdAt": "2020-11-11T15:30:15Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -396,18 +402,19 @@ protected void onStop() {\n     private void finishWithSearchFailure(Exception exc) {\n         stats.incrementSearchFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439132", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);", "author": "benwtrent", "createdAt": "2020-11-11T15:30:34Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -396,18 +402,19 @@ protected void onStop() {\n     private void finishWithSearchFailure(Exception exc) {\n         stats.incrementSearchFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n     }\n \n     private void finishWithIndexingFailure(Exception exc) {\n         stats.incrementIndexingFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439689", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    r -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n          \n          \n            \n                                    e -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));\n          \n          \n            \n                                    r -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\n          \n          \n            \n                                    e -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));", "author": "benwtrent", "createdAt": "2020-11-11T15:31:21Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -478,8 +485,8 @@ private void onSearchResponse(SearchResponse searchResponse) {\n                 stats.markEndProcessing();\n                 // execute finishing tasks\n                 onFinish(ActionListener.wrap(\n-                        r -> doSaveState(finishAndSetState(), position.get(), () -> {}),\n-                        e -> doSaveState(finishAndSetState(), position.get(), () -> {})));\n+                        r -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n+                        e -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTk5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439991", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        doSaveState(finishAndSetState(), getPosition(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                        doSaveState(finishAndSetState(), getPosition(), this::afterFinishOrFailure);", "author": "benwtrent", "createdAt": "2020-11-11T15:31:44Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -610,7 +617,7 @@ private boolean checkState(IndexerState currentState) {\n \n         case STOPPING:\n             logger.info(\"Indexer job encountered [\" + IndexerState.STOPPING + \"] state, halting indexer.\");\n-            doSaveState(finishAndSetState(), getPosition(), () -> {});\n+            doSaveState(finishAndSetState(), getPosition(), () -> {afterFinishOrFailure();});", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ade15afaa9c4393cacfcfc59ba6663e6ed58604f", "url": "https://github.com/elastic/elasticsearch/commit/ade15afaa9c4393cacfcfc59ba6663e6ed58604f", "message": "fix a version conflict exception if stop is called while indexer is\nshutting down. Report the overall transform stats STOPPED iff there is no\ntask (and therefore no indexer)\n\nrelates #62204", "committedDate": "2020-11-12T07:54:46Z", "type": "commit"}, {"oid": "674a4d397ed17537d8cdb8dac9f74510aa926c81", "url": "https://github.com/elastic/elasticsearch/commit/674a4d397ed17537d8cdb8dac9f74510aa926c81", "message": "apply review suggestions", "committedDate": "2020-11-12T07:54:47Z", "type": "commit"}, {"oid": "674a4d397ed17537d8cdb8dac9f74510aa926c81", "url": "https://github.com/elastic/elasticsearch/commit/674a4d397ed17537d8cdb8dac9f74510aa926c81", "message": "apply review suggestions", "committedDate": "2020-11-12T07:54:47Z", "type": "forcePushed"}]}