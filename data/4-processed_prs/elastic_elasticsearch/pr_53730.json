{"pr_number": 53730, "pr_title": "Save a little space in agg tree", "pr_createdAt": "2020-03-18T14:09:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53730", "timeline": [{"oid": "8552939d6971b2db945e81e21e81d8e6d7dad813", "url": "https://github.com/elastic/elasticsearch/commit/8552939d6971b2db945e81e21e81d8e6d7dad813", "message": "Save a little space in agg tree\n\nThis drop the \"top level\" pipeline aggregators from the aggregation\nresult tree which should save a little memory and a few serialization\nbytes. Perhaps more imporantly, this provides a mechanism by which we\ncan remove *all* pipelines from the aggregation result tree. This will\nsave quite a bit of space when pipelines are deep in the tree.\n\nSadly, doing this isn't simple because of backwards compatibility. Nodes\nbefore 7.7.0 *need* those pipelines. We provide them by setting passing\na `Supplier<PipelineTree>` into the root of the aggregation tree that we\nonly call if we need to serialize to a version before 7.7.0.\n\nThis solution works for cross cluster search because we always reduce\nthe aggregations in each remote cluster and then forward them back to\nthe coordinating node. Its quite possible that the coordinating node\nneeds the pipeline (say it is version 7.1.0) and the gateway node in the\nremote cluster doesn't (version 7.7.0). In that case the data nodes\nwon't send the pipeline aggregations back to the gateway node.\nCritically, the gateway node *will* send the pipeline aggregations back\nto the coordinating node. This is all managed with that\n`Supplier<PipelineTree>`, but *how* it is managed is a bit tricky.", "committedDate": "2020-03-18T14:06:31Z", "type": "commit"}, {"oid": "4c9db0249736d4395093dacbcf2623b963653672", "url": "https://github.com/elastic/elasticsearch/commit/4c9db0249736d4395093dacbcf2623b963653672", "message": "replace nocommit", "committedDate": "2020-03-18T14:10:26Z", "type": "commit"}, {"oid": "5b36280eee679d9ebb2e0a99276cabd0ed8c0bda", "url": "https://github.com/elastic/elasticsearch/commit/5b36280eee679d9ebb2e0a99276cabd0ed8c0bda", "message": "Test CCS", "committedDate": "2020-03-18T18:44:52Z", "type": "commit"}, {"oid": "bd890bc5e6037be0164fd5dccf8ca30e98959dac", "url": "https://github.com/elastic/elasticsearch/commit/bd890bc5e6037be0164fd5dccf8ca30e98959dac", "message": "Merge branch 'master' into pipeline_drop_serialization", "committedDate": "2020-03-18T20:01:41Z", "type": "commit"}, {"oid": "aa33bbe71707264a450e987826e99cd76a672dd8", "url": "https://github.com/elastic/elasticsearch/commit/aa33bbe71707264a450e987826e99cd76a672dd8", "message": "Merge branch 'master' into pipeline_drop_serialization", "committedDate": "2020-03-19T11:56:37Z", "type": "commit"}, {"oid": "b9f4cda693655193d7b60e4bf176902ec7ebb161", "url": "https://github.com/elastic/elasticsearch/commit/b9f4cda693655193d7b60e4bf176902ec7ebb161", "message": "Merge branch 'master' into pipeline_drop_serialization", "committedDate": "2020-03-19T13:16:14Z", "type": "commit"}, {"oid": "1562e76cda04565e8b8caedc585d54205c4d762f", "url": "https://github.com/elastic/elasticsearch/commit/1562e76cda04565e8b8caedc585d54205c4d762f", "message": "Merge branch 'master' into pipeline_drop_serialization", "committedDate": "2020-03-23T20:06:22Z", "type": "commit"}, {"oid": "cff7a673c19fd9f723d87896d844b58604b1452f", "url": "https://github.com/elastic/elasticsearch/commit/cff7a673c19fd9f723d87896d844b58604b1452f", "message": "Boo", "committedDate": "2020-03-23T21:20:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMjQxMA==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r396712410", "bodyText": "Hmm, should we maybe split this out into it's own test?  Just thinking that long multi-step yaml tests can be tricky to debug sometimes.\nHaven't looked at the rest of the tests in this yaml though, so it might not be easy to move the indexing (or whatever else) steps up to the setup though.", "author": "polyfractal", "createdAt": "2020-03-23T19:43:46Z", "path": "qa/multi-cluster-search/src/test/resources/rest-api-spec/test/multi_cluster/10_basic.yml", "diffHunk": "@@ -115,6 +115,39 @@\n   - match: { aggregations.cluster.buckets.0.key: \"local_cluster\" }\n   - match: { aggregations.cluster.buckets.0.doc_count: 5 }\n \n+  # once more, this time with a pipeline agg", "originalCommit": "b9f4cda693655193d7b60e4bf176902ec7ebb161", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NzEyMw==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397347123", "bodyText": "I'll move it, sure! They can get hard to debug.", "author": "nik9000", "createdAt": "2020-03-24T17:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NDkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397354915", "bodyText": "Ok - this is a test that doesn't clear indices after it runs. So moving things around is a bit more complex than we'd like to be honest. I can do it, but I think it should wait for a followup.", "author": "nik9000", "createdAt": "2020-03-24T17:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NjI5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397366297", "bodyText": "Ah ok, no worries then.  not worth re-arranging everything for \ud83d\udc4d", "author": "polyfractal", "createdAt": "2020-03-24T18:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMjQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyMDUzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r396720535", "bodyText": "Looks like the comment trails off without finishing it's thought :)", "author": "polyfractal", "createdAt": "2020-03-23T19:57:36Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java", "diffHunk": "@@ -54,35 +59,56 @@\n         }\n     };\n \n-    private final List<SiblingPipelineAggregator> topLevelPipelineAggregators;\n+    /**\n+     * The way to build a tree of pipeline aggregators. Used only for\n+     * serialization backwards compatibility.\n+     */\n+    private final Supplier<PipelineAggregator.PipelineTree> pipelineTreeForBwcSerialization;\n \n     /**\n      * Constructs a new aggregation.\n      */\n     public InternalAggregations(List<InternalAggregation> aggregations) {\n         super(aggregations);\n-        this.topLevelPipelineAggregators = Collections.emptyList();\n+        this.pipelineTreeForBwcSerialization = null;\n     }\n \n     /**\n-     * Constructs a new aggregation providing its {@link InternalAggregation}s and {@link SiblingPipelineAggregator}s\n+     * Constructs a node in the aggregation tree.\n+     * @param pipelineTreeSource must be null inside the tree or after final reduction. Should reference the\n+     *                           search request otherwise so we can properly serialize the response to\n+     *                           versions of Elasticsearch that require the pipelines to be serialized.\n      */\n-    public InternalAggregations(List<InternalAggregation> aggregations, List<SiblingPipelineAggregator> topLevelPipelineAggregators) {\n+    public InternalAggregations(List<InternalAggregation> aggregations, Supplier<PipelineAggregator.PipelineTree> pipelineTreeSource) {\n         super(aggregations);\n-        this.topLevelPipelineAggregators = Objects.requireNonNull(topLevelPipelineAggregators);\n+        this.pipelineTreeForBwcSerialization = pipelineTreeSource;\n     }\n \n     public InternalAggregations(StreamInput in) throws IOException {\n         super(in.readList(stream -> in.readNamedWriteable(InternalAggregation.class)));\n-        this.topLevelPipelineAggregators = in.readList(\n-            stream -> (SiblingPipelineAggregator)in.readNamedWriteable(PipelineAggregator.class));\n+        if (in.getVersion().before(Version.V_8_0_0)) { // TODO switch to 7.7.0 before merging\n+            in.readNamedWriteableList(PipelineAggregator.class); \n+        }\n+        /*\n+         * Setting the pipeline tree source to null is here is correct but\n+         * only because we don't immediately pass the InternalAggregations\n+         * off to another node. Instead, we always reduce together with\n+         * many aggregations and that always adds the ", "originalCommit": "b9f4cda693655193d7b60e4bf176902ec7ebb161", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0NzMzNA==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397347334", "bodyText": "Thanks! I do that somet", "author": "nik9000", "createdAt": "2020-03-24T17:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyMDUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MjI2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397342267", "bodyText": "Should we have a similar test for the rolling-upgrade module?  Theoretically it should be the same as CCS, but it might also smoke out different issues due to heterogeneous serialization inside the same cluster (instead of funneling through a gateway).", "author": "polyfractal", "createdAt": "2020-03-24T17:40:24Z", "path": "qa/multi-cluster-search/src/test/resources/rest-api-spec/test/multi_cluster/10_basic.yml", "diffHunk": "@@ -115,6 +115,39 @@\n   - match: { aggregations.cluster.buckets.0.key: \"local_cluster\" }\n   - match: { aggregations.cluster.buckets.0.doc_count: 5 }\n \n+  # once more, this time with a pipeline agg\n+  - do:", "originalCommit": "cff7a673c19fd9f723d87896d844b58604b1452f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0ODE3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397348176", "bodyText": "It'd be great to have a \"mixed cluster CCS\" test. I talked that one through with @javanna and we don't have one now and probably don't want to build one just for this.", "author": "nik9000", "createdAt": "2020-03-24T17:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MjI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MzA3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397343075", "bodyText": "Should we add a non-top-level pipeline agg just to confirm they aren't affected?", "author": "polyfractal", "createdAt": "2020-03-24T17:41:35Z", "path": "qa/multi-cluster-search/src/test/resources/rest-api-spec/test/multi_cluster/10_basic.yml", "diffHunk": "@@ -115,6 +115,39 @@\n   - match: { aggregations.cluster.buckets.0.key: \"local_cluster\" }\n   - match: { aggregations.cluster.buckets.0.doc_count: 5 }\n \n+  # once more, this time with a pipeline agg\n+  - do:\n+      search:\n+        rest_total_hits_as_int: true\n+        index: test_index,my_remote_cluster:test_index\n+        body:\n+          seq_no_primary_term: true\n+          aggs:\n+            cluster:\n+              terms:\n+                field: f1.keyword\n+              aggs:\n+                s:", "originalCommit": "cff7a673c19fd9f723d87896d844b58604b1452f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0ODU2NA==", "url": "https://github.com/elastic/elasticsearch/pull/53730#discussion_r397348564", "bodyText": "I figured I'd get it in my next PR about non-top-level pipeline aggs, but I'm happy to do it now!", "author": "nik9000", "createdAt": "2020-03-24T17:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM0MzA3NQ=="}], "type": "inlineReview"}, {"oid": "f335863fd32cad3a8b1a5554d0167dd8cb212481", "url": "https://github.com/elastic/elasticsearch/commit/f335863fd32cad3a8b1a5554d0167dd8cb212481", "message": "Merge branch 'master' into pipeline_drop_serialization", "committedDate": "2020-03-24T17:46:17Z", "type": "commit"}, {"oid": "feb194c96af2d736de2fbbec6450304661114e95", "url": "https://github.com/elastic/elasticsearch/commit/feb194c96af2d736de2fbbec6450304661114e95", "message": "Update", "committedDate": "2020-03-24T18:56:20Z", "type": "commit"}, {"oid": "12dae79a6dbddcfb4cf587c3979e84bc7f2f970b", "url": "https://github.com/elastic/elasticsearch/commit/12dae79a6dbddcfb4cf587c3979e84bc7f2f970b", "message": "Switch version", "committedDate": "2020-03-25T10:43:23Z", "type": "commit"}]}