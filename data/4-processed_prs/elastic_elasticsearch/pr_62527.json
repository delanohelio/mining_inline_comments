{"pr_number": 62527, "pr_title": "Prohibit the usage of create index api in namespaces managed by data stream templates", "pr_createdAt": "2020-09-17T09:20:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62527", "timeline": [{"oid": "2fc92dd6d52fcfc530ba137b7c8afdc2d0769379", "url": "https://github.com/elastic/elasticsearch/commit/2fc92dd6d52fcfc530ba137b7c8afdc2d0769379", "message": "Prohibit the usage of create index api in namespaces managed by data stream templates.\n\nThis commit adds validation that prohibits the creation of regular indices\nin the namespace of templates with data streams enabled.\n\nIt shouldn't be possible to create ordinary indices when the name of the index\nmatches with a composable index template that enables data streams. Auto creation\nhas logic that creates data streams instead of regular indices. However validation\nlogic for the create index api was missing.", "committedDate": "2020-09-17T09:18:33Z", "type": "commit"}, {"oid": "68c99c7be91c84d50362b4327200d9eba304bd53", "url": "https://github.com/elastic/elasticsearch/commit/68c99c7be91c84d50362b4327200d9eba304bd53", "message": "Merge remote-tracking branch 'es/master' into prohibit_create_index_api_data_stream", "committedDate": "2020-09-17T10:56:42Z", "type": "commit"}, {"oid": "ce9ab5a339b82c3ea7fb27becc663e7be81a0f1c", "url": "https://github.com/elastic/elasticsearch/commit/ce9ab5a339b82c3ea7fb27becc663e7be81a0f1c", "message": "adjust test", "committedDate": "2020-09-17T11:55:52Z", "type": "commit"}, {"oid": "9c6f23d708eb3edf6696226cdb02ae04d21eac4e", "url": "https://github.com/elastic/elasticsearch/commit/9c6f23d708eb3edf6696226cdb02ae04d21eac4e", "message": "adjust test to not match with default stack template", "committedDate": "2020-09-17T13:02:29Z", "type": "commit"}, {"oid": "86ae3cd9a0194fb95c9d04b40e795b9e90b21def", "url": "https://github.com/elastic/elasticsearch/commit/86ae3cd9a0194fb95c9d04b40e795b9e90b21def", "message": "adjust skip version", "committedDate": "2020-09-17T14:30:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxMjIzNw==", "url": "https://github.com/elastic/elasticsearch/pull/62527#discussion_r490312237", "bodyText": "I think we should try to steer the user in the right direction, can we suggest they try the create data stream API in the error message?", "author": "dakrone", "createdAt": "2020-09-17T14:49:44Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -502,6 +502,12 @@ private ClusterState applyCreateIndexRequestWithV2Template(final ClusterState cu\n                                                                                     throws Exception {\n         logger.debug(\"applying create index request using composable template [{}]\", templateName);\n \n+        ComposableIndexTemplate template = currentState.getMetadata().templatesV2().get(templateName);\n+        if (request.dataStreamName() == null && template.getDataStreamTemplate() != null) {\n+           throw new IllegalArgumentException(\"cannot create index with name [\" + request.index() +\n+               \"], because it matches with template [\" + templateName + \"] that creates data streams only\");", "originalCommit": "86ae3cd9a0194fb95c9d04b40e795b9e90b21def", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e0fae7a1857c353a2870e9b7af373a52a8e75402", "url": "https://github.com/elastic/elasticsearch/commit/e0fae7a1857c353a2870e9b7af373a52a8e75402", "message": "iter", "committedDate": "2020-09-17T15:29:24Z", "type": "commit"}]}