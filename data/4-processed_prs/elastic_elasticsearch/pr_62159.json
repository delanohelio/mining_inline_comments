{"pr_number": 62159, "pr_title": "Log bulk errors when indexing deprecation logs", "pr_createdAt": "2020-09-09T11:40:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62159", "timeline": [{"oid": "0e25421695b27cae2ffe69f3f3f3e7f786ebb4d3", "url": "https://github.com/elastic/elasticsearch/commit/0e25421695b27cae2ffe69f3f3f3e7f786ebb4d3", "message": "Log bulk errors when indexing deprecation logs\n\nThe bulk processor used to index deprecation logs was doing nothing to\noutput any errors encountered when writing documents to ES. These are\nnow detected.\n\nAlso expand the deprecation REST tests to check the shape of the indexed\ndocuments.", "committedDate": "2020-09-09T11:37:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0OTkwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62159#discussion_r485549901", "bodyText": "nit: we could use\nlogger.trace(\n                    \"indexed [{}] deprecation documents into [{}]\",\n                    request::numberOfActions,\n()->                 Arrays.stream(response.getItems()).map(BulkItemResponse::getIndex).distinct().collect(Collectors.joining(\",\"))\n\npassing parameters suppliers instead of guarding with logger.isTraceEnabled()\nI understand that this pattern is common though - we probably don't have a elasticsearch wide convention for this", "author": "pgomulka", "createdAt": "2020-09-09T11:51:45Z", "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java", "diffHunk": "@@ -131,11 +136,27 @@ private BulkProcessor getBulkProcessor(Client client, Settings settings) {\n         public void beforeBulk(long executionId, BulkRequest request) {}\n \n         @Override\n-        public void afterBulk(long executionId, BulkRequest request, BulkResponse response) {}\n+        public void afterBulk(long executionId, BulkRequest request, BulkResponse response) {\n+            long numberOfActions = request.numberOfActions();\n+            if (logger.isTraceEnabled()) {\n+                logger.trace(\n+                    \"indexed [{}] deprecation documents into [{}]\",\n+                    numberOfActions,\n+                    Arrays.stream(response.getItems()).map(BulkItemResponse::getIndex).distinct().collect(Collectors.joining(\",\"))", "originalCommit": "0e25421695b27cae2ffe69f3f3f3e7f786ebb4d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}