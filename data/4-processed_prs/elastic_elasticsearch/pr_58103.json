{"pr_number": 58103, "pr_title": "Allow follower indices to override leader settings", "pr_createdAt": "2020-06-15T12:20:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58103", "timeline": [{"oid": "fbd5e2354dc651a791f92c6d93573a3f9bac131a", "url": "https://github.com/elastic/elasticsearch/commit/fbd5e2354dc651a791f92c6d93573a3f9bac131a", "message": "Allow follower indices to override leader settings\n\nToday when creating a follower index via the put follow API, or via an\nauto-follow pattern, it is not possible to specify settings overrides\nfor the follower index. Instead, we copy all of the leader index\nsettings to the follower. Yet, there are cases where a user would want\nsome different settings on the follower index such as the number of\nreplicas, or allocation settings. This commit addresses this by allowing\nthe user to specify settings overrides when creating follower index via\nmanual put follower calls, or via auto-follow patterns. Note that not\nall settings can be overrode (e.g., index.number_of_shards) so we also\nhave detection that prevents attempting to override settings that must\nbe equal between the leader and follow index. Note that we do not even\nallow specifying such settings in the overrides, even if they are\nspecified to be equal between the leader and the follower\nindex. Instead, the must be implicitly copied from the leader index, not\nexplicitly set by the user.", "committedDate": "2020-06-13T13:10:43Z", "type": "commit"}, {"oid": "1ec56ef8a06618372bf563508a4fee92d55925df", "url": "https://github.com/elastic/elasticsearch/commit/1ec56ef8a06618372bf563508a4fee92d55925df", "message": "Fix docs", "committedDate": "2020-06-15T12:22:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNzYwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/58103#discussion_r440137605", "bodyText": "This is the crux of the change, where the request settings are propagated to the follower index. The rest of this change is just ceremony around this, parsing the settings from the request, validating that they are not including any settings that must be propagated from the leader index, and tests around this.", "author": "jasontedor", "createdAt": "2020-06-15T12:24:19Z", "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPutFollowAction.java", "diffHunk": "@@ -124,14 +125,28 @@ private void createFollowerIndex(\n             return;\n         }\n \n-        final Settings.Builder settingsBuilder = Settings.builder()\n+        final Settings replicatedRequestSettings = TransportResumeFollowAction.filter(request.getSettings());\n+        if (replicatedRequestSettings.isEmpty() == false) {\n+            final String message = String.format(\n+                Locale.ROOT,\n+                \"can not put follower index that could override leader settings %s\",\n+                replicatedRequestSettings\n+            );\n+            listener.onFailure(new IllegalArgumentException(message));\n+            return;\n+        }\n+\n+        final Settings overrideSettings = Settings.builder()\n             .put(IndexMetadata.SETTING_INDEX_PROVIDED_NAME, request.getFollowerIndex())\n-            .put(CcrSettings.CCR_FOLLOWING_INDEX_SETTING.getKey(), true);\n+            .put(CcrSettings.CCR_FOLLOWING_INDEX_SETTING.getKey(), true)\n+            .put(request.getSettings())", "originalCommit": "fbd5e2354dc651a791f92c6d93573a3f9bac131a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec1cb7cb71fae120c6a90d61aeb9ae1b6e5e48c4", "url": "https://github.com/elastic/elasticsearch/commit/ec1cb7cb71fae120c6a90d61aeb9ae1b6e5e48c4", "message": "Remove accidental line insertions", "committedDate": "2020-06-15T12:25:15Z", "type": "commit"}, {"oid": "9ce822a82c31a7defc6f7a4cf943d43d146fe23b", "url": "https://github.com/elastic/elasticsearch/commit/9ce822a82c31a7defc6f7a4cf943d43d146fe23b", "message": "Fix some checkstyle violations", "committedDate": "2020-06-15T12:30:52Z", "type": "commit"}, {"oid": "f0295304fbf4e87cec0d304c4ce662f9820924ba", "url": "https://github.com/elastic/elasticsearch/commit/f0295304fbf4e87cec0d304c4ce662f9820924ba", "message": "Fix checkstyle", "committedDate": "2020-06-15T12:37:10Z", "type": "commit"}, {"oid": "37ae0f17a41766bcff99523467d33441069ae14b", "url": "https://github.com/elastic/elasticsearch/commit/37ae0f17a41766bcff99523467d33441069ae14b", "message": "Do not write empty settings", "committedDate": "2020-06-15T12:58:08Z", "type": "commit"}, {"oid": "85ac9c16ea25435ccc3c33875e4b70a8b96428a6", "url": "https://github.com/elastic/elasticsearch/commit/85ac9c16ea25435ccc3c33875e4b70a8b96428a6", "message": "Fix serialization", "committedDate": "2020-06-15T13:35:35Z", "type": "commit"}, {"oid": "adc2424634970d5ab101d5cac31b761020ce3dc0", "url": "https://github.com/elastic/elasticsearch/commit/adc2424634970d5ab101d5cac31b761020ce3dc0", "message": "Fix serialization", "committedDate": "2020-06-16T01:22:27Z", "type": "commit"}, {"oid": "c6077d11caef49ad2dafc592eae0c636e446d066", "url": "https://github.com/elastic/elasticsearch/commit/c6077d11caef49ad2dafc592eae0c636e446d066", "message": "Fix tests", "committedDate": "2020-06-17T21:29:05Z", "type": "commit"}, {"oid": "20ec09c98f07fa0665f555f94ea59756fa1f44e8", "url": "https://github.com/elastic/elasticsearch/commit/20ec09c98f07fa0665f555f94ea59756fa1f44e8", "message": "Merge remote-tracking branch 'elastic/master' into follower-index-settings", "committedDate": "2020-06-17T21:29:31Z", "type": "commit"}, {"oid": "c2e2f07df5372b1f1da10dad6ac1245c7f821b38", "url": "https://github.com/elastic/elasticsearch/commit/c2e2f07df5372b1f1da10dad6ac1245c7f821b38", "message": "Fix checkstyle", "committedDate": "2020-06-17T21:37:46Z", "type": "commit"}, {"oid": "5dd60ca8c32e06793ad6e3bedee88ba4953a22ae", "url": "https://github.com/elastic/elasticsearch/commit/5dd60ca8c32e06793ad6e3bedee88ba4953a22ae", "message": "Merge branch 'master' into follower-index-settings", "committedDate": "2020-06-17T22:01:03Z", "type": "commit"}]}