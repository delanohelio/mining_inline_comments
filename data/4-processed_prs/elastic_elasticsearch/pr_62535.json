{"pr_number": 62535, "pr_title": "[ML] Add datafeed run time fields integration test", "pr_createdAt": "2020-09-17T10:34:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62535", "timeline": [{"oid": "87408aa7f302edce7302d1b13af06943c7db0bc2", "url": "https://github.com/elastic/elasticsearch/commit/87408aa7f302edce7302d1b13af06943c7db0bc2", "message": "Add datafeed run time fields test", "committedDate": "2020-09-17T10:32:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490258752", "bodyText": "thanks for writing this test. One point is, there is no need to go to _source to get this field as it's indexed as keyword and has doc_values. The most appropriate way to do this would then be emit(doc['airline'].toLowerCase())\nI care about it because _source is available for runtime fields, yet it is still not the recommended way to retrieve values, which we plan to address over time.", "author": "javanna", "createdAt": "2020-09-17T13:46:15Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "diffHunk": "@@ -128,6 +127,11 @@ private void addAirlineData() throws IOException {\n                 + \"          \\\"keyword\\\":{\\\"type\\\":\\\"keyword\\\"}\"\n                 + \"         }\"\n                 + \"       },\"\n+                + \"      \\\"airline_lowercase_rt\\\": { \"\n+                + \"        \\\"type\\\":\\\"runtime\\\",\"\n+                + \"        \\\"runtime_type\\\": \\\"keyword\\\",\"\n+                + \"        \\\"script\\\" : { \\\"source\\\": \\\"emit(params._source.airline.toLowerCase())\\\" }\"", "originalCommit": "87408aa7f302edce7302d1b13af06943c7db0bc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM1NzYwMw==", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490357603", "bodyText": "What you can't see in the diff is that airline is actually a text multi field with a keyword sub field\n      \"airline\" : { \n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\" : { \n            \"type\": \"keyword\"\n          }\n        }\n      },\n\nBut I do see the sense in what you're suggesting so I changed the script to:\nemit(doc['airline.keyword'].toLowerCase())\nUnfortunately that failed with the error\n          \"caused_by\" : {\n            \"type\" : \"illegal_argument_exception\",\n            \"reason\" : \"dynamic method [org.elasticsearch.index.fielddata.ScriptDocValues.Strings, toLowerCase/0] not found\"\n          }\n\nI had to put a toString() in to get it to work.\nemit(doc['airline.keyword'].toString().toLowerCase())\nIs this a regression as that example worked previously?\nUPDATE - No I am mistaken, I was trying something different previously\nBTW I'm testing this simply by asking for the docvalue_field in the search\nGET farequote/_search\n{\n  \"docvalue_fields\": [\"airline_lowercase\"]\n}", "author": "davidkyle", "createdAt": "2020-09-17T15:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ1ODc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490458757", "bodyText": "nice, I thought I checked out the test data and that field was keyword, but close enough. Ping me if you notice anything when playing with runtime fields ;)", "author": "javanna", "createdAt": "2020-09-17T18:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ1OTM5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490459391", "bodyText": "I think I forgot a .value possibly? From your message I did not get if you managed to make it work after all, if not ping me and let's make sure that it works on doc_values", "author": "javanna", "createdAt": "2020-09-17T18:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2NTIyNw==", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490465227", "bodyText": "\ud83d\udc4d it works with .value thanks", "author": "davidkyle", "createdAt": "2020-09-17T18:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}], "type": "inlineReview"}]}