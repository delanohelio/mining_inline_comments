{"pr_number": 64031, "pr_title": "Fixing a problem with potential dirty read of a token document on token refresh", "pr_createdAt": "2020-10-22T06:51:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64031", "timeline": [{"oid": "2c3e3c1f8ad006234713b29c0f27201668f83d2d", "url": "https://github.com/elastic/elasticsearch/commit/2c3e3c1f8ad006234713b29c0f27201668f83d2d", "message": "Fixing a problem with potential dirty read of a token document.\nRelated to #59685", "committedDate": "2020-10-21T21:37:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyODU3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r509928575", "bodyText": "Having Tuples of Tuples usually is a good sign that we need a new object for this", "author": "jkakavas", "createdAt": "2020-10-22T07:11:08Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/TokenService.java", "diffHunk": "@@ -254,7 +254,7 @@ public TokenService(Settings settings, Clock clock, Client client, XPackLicenseS\n      * {@link #VERSION_TOKENS_INDEX_INTRODUCED} and to a specific security tokens index for later versions.\n      */\n     public void createOAuth2Tokens(Authentication authentication, Authentication originatingClientAuth, Map<String, Object> metadata,\n-                                   boolean includeRefreshToken, ActionListener<Tuple<String, String>> listener) {\n+                                   boolean includeRefreshToken, ActionListener<Tuple<Tuple<String, String>, Authentication>> listener) {", "originalCommit": "2c3e3c1f8ad006234713b29c0f27201668f83d2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1NjAyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r509956025", "bodyText": "How about Triple?", "author": "BigPandaToo", "createdAt": "2020-10-22T07:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyODU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk2NjE2NA==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r509966164", "bodyText": "I'd go with something like a\npublic final class CreateTokenResult {\n    private final String accessToken;\n    private final String refreshToken;\n    private final Authentication authentication;\n\n    // ctor, getters etc...\n}", "author": "jkakavas", "createdAt": "2020-10-22T08:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyODU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM1ODYyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r510358621", "bodyText": "Updated the PR", "author": "BigPandaToo", "createdAt": "2020-10-22T18:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyODU3NQ=="}], "type": "inlineReview"}, {"oid": "a1061a048b7b505b1c292502c136348f13a9d8f2", "url": "https://github.com/elastic/elasticsearch/commit/a1061a048b7b505b1c292502c136348f13a9d8f2", "message": "Fixing a problem with potential dirty read of a token document.\nAdding CreateTokenResult to hold authentication object", "committedDate": "2020-10-22T16:20:34Z", "type": "commit"}, {"oid": "d4f378b6375bfdb6829cd97795580617a18166e9", "url": "https://github.com/elastic/elasticsearch/commit/d4f378b6375bfdb6829cd97795580617a18166e9", "message": "Merge branch 'master' into FixRefreshTokenResponse", "committedDate": "2020-10-22T17:16:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNDEyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511734123", "bodyText": "This class can be static since it does not need need access any instance variables.", "author": "ywangd", "createdAt": "2020-10-26T06:02:49Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/TokenService.java", "diffHunk": "@@ -1910,6 +1919,30 @@ boolean isExpirationInProgress() {\n         return expiredTokenRemover.isExpirationInProgress();\n     }\n \n+    public final class CreateTokenResult {", "originalCommit": "d4f378b6375bfdb6829cd97795580617a18166e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1ODY0MA==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r512058640", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-10-26T15:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNDEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0MDY5NA==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511740694", "bodyText": "There are 3 authentication objects here:\n\nThe originating authentication\nThe authentication for which the token is created\nThe token's own authentication\n\nWe had brief discussion during the team meeting and agreed that above item 2 should be returned. However, we are returning item 3 here. The tokenResult.getAuthentication() is the authentication object of the newly created token, while No.2 is technically the old access token's authentication object.\nI don't think it could cause any practical problem, in fact, No. 2 and 3 should be identical here. But it is strictly speaking an inconsistency. I am raising it here in case it's worth any discussion.", "author": "ywangd", "createdAt": "2020-10-26T06:28:23Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/token/TransportRefreshTokenAction.java", "diffHunk": "@@ -31,13 +30,12 @@ public TransportRefreshTokenAction(TransportService transportService, ActionFilt\n \n     @Override\n     protected void doExecute(Task task, CreateTokenRequest request, ActionListener<CreateTokenResponse> listener) {\n-        tokenService.refreshToken(request.getRefreshToken(), ActionListener.wrap(tuple -> {\n+        tokenService.refreshToken(request.getRefreshToken(), ActionListener.wrap(tokenResult -> {\n             final String scope = getResponseScopeValue(request.getScope());\n-            tokenService.authenticateToken(new SecureString(tuple.v1()), ActionListener.wrap(authentication -> {\n-                listener.onResponse(new CreateTokenResponse(tuple.v1(), tokenService.getExpirationDelay(), scope, tuple.v2(), null,\n-                    authentication));\n-            },\n-                listener::onFailure));\n+            final CreateTokenResponse response =\n+                new CreateTokenResponse(tokenResult.getAccessToken(), tokenService.getExpirationDelay(), scope,\n+                    tokenResult.getRefreshToken(), null, tokenResult.getAuthentication());", "originalCommit": "d4f378b6375bfdb6829cd97795580617a18166e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNTU1MA==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511815550", "bodyText": "The authentication type would be different, right? I also think we should pass authentication and not tokenAuth in the CreateTokenResult object", "author": "jkakavas", "createdAt": "2020-10-26T09:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0MDY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg2NzAzOA==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511867038", "bodyText": "I may have been unclear in my previous comment. Please let me clarify:\nFor other places, authencation 2 and 3 are indeed different, but not here. Also this is the only place where authentication 3 (CreateTokenResult#getAuthentication) is used. For all other places, authentication 2 is used, e.g. TransportDelegatePkiAuthenticationAction, because authentication 2 is available without having to rely on TokenService.\nIn here, neither authentication 2 nor 3 is avilable, because we only have a refresh token. It needs to rely on TokenService to get both of them. CreateTokenResult only returns 3 and that is what gets used here. Luckily, 2 and 3 are no different in this case, so it is not an issue for now. But I wonder whether this equality would hold in future.", "author": "ywangd", "createdAt": "2020-10-26T10:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0MDY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4OTg3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511889871", "bodyText": "I also think we should pass authentication and not tokenAuth in the CreateTokenResult object\n\nMy comment was out of place too, I was reading createOAuth2Tokens when commenting.\n\nLuckily, 2 and 3 are no different in this case\n\nAs commented above too, The authentication type would be different, right? innerRefresh will call createOAuth2Tokens which will get the Authentication from the token document and replace the authentication type with TOKEN ?", "author": "jkakavas", "createdAt": "2020-10-26T11:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0MDY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwMTYyMg==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511901622", "bodyText": "As commented above too, The authentication type would be different, right? innerRefresh will call createOAuth2Tokens which will get the Authentication from the token document and replace the authentication type with TOKEN ?\n\nThe Authentication object parsed from a token document always has TOKEN as its authentication type. If I read the code correctly:\n\ninnerRefresh parses the token document to get its current Authentication object, which already has a TOKEN auth type.\nThe above Authentication object is passed into createOAuth2Tokens and a new Authentication object is created from it by hardcoding a TOKEN auth type (as you linked above). But this is essentially a no-op because the original value is also TOKEN.\n\nA token document is always created with TokenService#createTokenDocument, which takes a UserToken and in turn its Authentication object. This Authentication object is guaranteed to have TOKEN auth type as you linked above.", "author": "ywangd", "createdAt": "2020-10-26T11:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0MDY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1NzM2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r512057363", "bodyText": "Thanks @ywangd for noticing! I do think having authentication for which the token's created is more logical, I missed it here (also, shouldn't make much difference for the perpose of this change). I have changed it use the authentication object representing the user for which the token was created", "author": "BigPandaToo", "createdAt": "2020-10-26T15:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0MDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNDI3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511814279", "bodyText": "Please also update the javadoc", "author": "jkakavas", "createdAt": "2020-10-26T09:16:49Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/TokenService.java", "diffHunk": "@@ -311,7 +311,7 @@ public void createOAuth2Tokens(String accessToken, String refreshToken, Authenti\n      */\n     private void createOAuth2Tokens(String accessToken, String refreshToken, Version tokenVersion, SecurityIndexManager tokensIndex,", "originalCommit": "d4f378b6375bfdb6829cd97795580617a18166e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1ODM1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r512058359", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-10-26T15:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNDI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNTkyNg==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511815926", "bodyText": "update javadoc", "author": "jkakavas", "createdAt": "2020-10-26T09:19:35Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/TokenService.java", "diffHunk": "@@ -862,7 +862,7 @@ private void indexInvalidation(Collection<String> tokenIds, SecurityIndexManager\n      * @param listener The listener to call upon completion with a {@link Tuple} containing the\n      *                 serialized access token and serialized refresh token as these will be returned to the client\n      */\n-    public void refreshToken(String refreshToken, ActionListener<Tuple<String, String>> listener) {\n+    public void refreshToken(String refreshToken, ActionListener<CreateTokenResult> listener) {", "originalCommit": "d4f378b6375bfdb6829cd97795580617a18166e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1ODEyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r512058125", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-10-26T15:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNTkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNjIwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511816209", "bodyText": "update javadoc", "author": "jkakavas", "createdAt": "2020-10-26T09:20:02Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/TokenService.java", "diffHunk": "@@ -1126,11 +1128,13 @@ public void onFailure(Exception e) {\n      * @param refreshTokenStatus The {@link RefreshTokenStatus} containing information about the superseding tokens as retrieved from the\n      *                           index\n      * @param tokensIndex        the manager for the index where the tokens are stored\n-     * @param listener           The listener to call upon completion with a {@link Tuple} containing the\n-     *                           serialized access token and serialized refresh token as these will be returned to the client\n+     * @param authentication     The authentication object representing the user for which the tokens are created\n+     * @param listener           The listener to call upon completion with a {@link Tuple} containing the Tuple of\n+     *                           serialized access token and serialized refresh token and Authentication object as these will be returned\n+     *                           to the client\n      */\n     void decryptAndReturnSupersedingTokens(String refreshToken, RefreshTokenStatus refreshTokenStatus, SecurityIndexManager tokensIndex,\n-                                           ActionListener<Tuple<String, String>> listener) {\n+                                           Authentication authentication, ActionListener<CreateTokenResult> listener) {", "originalCommit": "d4f378b6375bfdb6829cd97795580617a18166e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1Nzk5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r512057990", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-10-26T15:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNjIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNzkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r511817914", "bodyText": "nit: I think we can update those methods in here to return a  CreateTokenResult and we could also test that the authentication object is what we expect", "author": "jkakavas", "createdAt": "2020-10-26T09:22:56Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/action/saml/TransportSamlInvalidateSessionActionTests.java", "diffHunk": "@@ -376,9 +376,9 @@ public void testInvalidateCorrectTokensFromLogoutRequest() throws Exception {\n         Authentication authentication = new Authentication(new User(\"bob\"),\n                 new RealmRef(\"native\", NativeRealmSettings.TYPE, \"node01\"), null);\n         final Map<String, Object> metadata = samlRealm.createTokenMetadata(nameId, session);\n-        final PlainActionFuture<Tuple<String, String>> future = new PlainActionFuture<>();\n+        final PlainActionFuture<TokenService.CreateTokenResult> future = new PlainActionFuture<>();\n         tokenService.createOAuth2Tokens(userTokenId, refreshToken, authentication, authentication, metadata, future);\n-        return future.actionGet();\n+        return new Tuple<>(future.actionGet().getAccessToken(), future.actionGet().getRefreshToken());", "originalCommit": "d4f378b6375bfdb6829cd97795580617a18166e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1Nzg1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64031#discussion_r512057852", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-10-26T15:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxNzkxNA=="}], "type": "inlineReview"}, {"oid": "e2bd246f60ebbcad08183983f6402c79a28ff3b8", "url": "https://github.com/elastic/elasticsearch/commit/e2bd246f60ebbcad08183983f6402c79a28ff3b8", "message": "Merge branch 'master' into FixRefreshTokenResponse", "committedDate": "2020-10-26T14:14:05Z", "type": "commit"}, {"oid": "da4fe7298f6c1df94fb1054cba0e66af644f6819", "url": "https://github.com/elastic/elasticsearch/commit/da4fe7298f6c1df94fb1054cba0e66af644f6819", "message": "Fixing a problem with potential dirty read of a token document.\nAdding CreateTokenResult to hold authentication object", "committedDate": "2020-10-26T15:24:35Z", "type": "commit"}]}