{"pr_number": 64336, "pr_title": "Support building Iron Bank Docker context", "pr_createdAt": "2020-10-29T12:18:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64336", "timeline": [{"oid": "e703b1756d1e5487d07b93b2befbb013c37d7fc1", "url": "https://github.com/elastic/elasticsearch/commit/e703b1756d1e5487d07b93b2befbb013c37d7fc1", "message": "Reinstate UBI builds", "committedDate": "2020-07-29T15:14:58Z", "type": "commit"}, {"oid": "20e8e5976e21b9fa67f50bfd27047ecf7f0954a0", "url": "https://github.com/elastic/elasticsearch/commit/20e8e5976e21b9fa67f50bfd27047ecf7f0954a0", "message": "Only provide a task to build a UBI context", "committedDate": "2020-07-30T11:37:21Z", "type": "commit"}, {"oid": "8a3f3bc47471c59fd6dfb49f324a839a0273c109", "url": "https://github.com/elastic/elasticsearch/commit/8a3f3bc47471c59fd6dfb49f324a839a0273c109", "message": "Generate UBI downloads.json during context build (badly)", "committedDate": "2020-07-30T13:56:39Z", "type": "commit"}, {"oid": "ff2ecd7534173e56f0003541d6bb1a55d8e8786c", "url": "https://github.com/elastic/elasticsearch/commit/ff2ecd7534173e56f0003541d6bb1a55d8e8786c", "message": "Revert unnecessary changes", "committedDate": "2020-07-30T14:15:13Z", "type": "commit"}, {"oid": "ad9140f8021fcef9944a8fd194cf14648bd9f98e", "url": "https://github.com/elastic/elasticsearch/commit/ad9140f8021fcef9944a8fd194cf14648bd9f98e", "message": "Fix UBI version in archive name", "committedDate": "2020-07-30T14:22:26Z", "type": "commit"}, {"oid": "2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0", "url": "https://github.com/elastic/elasticsearch/commit/2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0", "message": "Hack around gradle issues with configurations and project context", "committedDate": "2020-07-30T15:19:34Z", "type": "commit"}, {"oid": "10247102e6cf11b0d9462d57e8720bff28cadaf9", "url": "https://github.com/elastic/elasticsearch/commit/10247102e6cf11b0d9462d57e8720bff28cadaf9", "message": "Revert \"Hack around gradle issues with configurations and project context\"\n\nThis reverts commit 2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0.", "committedDate": "2020-07-30T15:41:51Z", "type": "commit"}, {"oid": "4a87d279010d91135f468b90bd1fc271066bde19", "url": "https://github.com/elastic/elasticsearch/commit/4a87d279010d91135f468b90bd1fc271066bde19", "message": "Support ubi and ubi-minimal", "committedDate": "2020-07-31T10:28:05Z", "type": "commit"}, {"oid": "e8c07b58419aae2795d30140b242c6b0fd598c78", "url": "https://github.com/elastic/elasticsearch/commit/e8c07b58419aae2795d30140b242c6b0fd598c78", "message": "Merge remote-tracking branch 'upstream/master' into support-ubi-iron-bank", "committedDate": "2020-08-11T09:21:10Z", "type": "commit"}, {"oid": "051daff7831db9e2c21458553ab25d37cffef36c", "url": "https://github.com/elastic/elasticsearch/commit/051daff7831db9e2c21458553ab25d37cffef36c", "message": "Tweaks", "committedDate": "2020-08-11T09:39:20Z", "type": "commit"}, {"oid": "d544309b5c38e9f128d5c994d10e676515436031", "url": "https://github.com/elastic/elasticsearch/commit/d544309b5c38e9f128d5c994d10e676515436031", "message": "Fixes", "committedDate": "2020-08-14T19:13:11Z", "type": "commit"}, {"oid": "f275e30fd1d0fa7f9e72f40520782299efb47e0c", "url": "https://github.com/elastic/elasticsearch/commit/f275e30fd1d0fa7f9e72f40520782299efb47e0c", "message": "Merge remote-tracking branch 'upstream/master' into support-ubi-iron-bank", "committedDate": "2020-10-26T15:40:45Z", "type": "commit"}, {"oid": "82f8bdaebcf45fc8ab45ff10cfa1820991a25f9f", "url": "https://github.com/elastic/elasticsearch/commit/82f8bdaebcf45fc8ab45ff10cfa1820991a25f9f", "message": "More changes port-merge", "committedDate": "2020-10-26T18:32:50Z", "type": "commit"}, {"oid": "cd9accfeea73836d27f05e3029feb0d116680c72", "url": "https://github.com/elastic/elasticsearch/commit/cd9accfeea73836d27f05e3029feb0d116680c72", "message": "Lots of fixes, plus Dockerfile newline squashing", "committedDate": "2020-10-26T21:00:34Z", "type": "commit"}, {"oid": "01cf6cc784c6a6cb8fe8a882b1b7c3b6195d16fe", "url": "https://github.com/elastic/elasticsearch/commit/01cf6cc784c6a6cb8fe8a882b1b7c3b6195d16fe", "message": "More fixes", "committedDate": "2020-10-27T11:17:03Z", "type": "commit"}, {"oid": "295e0f173e6c7daeb6fc888d1e651c931a9b6aff", "url": "https://github.com/elastic/elasticsearch/commit/295e0f173e6c7daeb6fc888d1e651c931a9b6aff", "message": "Fix", "committedDate": "2020-10-27T11:17:39Z", "type": "commit"}, {"oid": "9363ecc56cfa2b5e55d09d8e192ef4c279f64748", "url": "https://github.com/elastic/elasticsearch/commit/9363ecc56cfa2b5e55d09d8e192ef4c279f64748", "message": "Fix filter name", "committedDate": "2020-10-27T11:32:18Z", "type": "commit"}, {"oid": "bbe471d92d9496c44247778685ad7f9b9fe1ed6e", "url": "https://github.com/elastic/elasticsearch/commit/bbe471d92d9496c44247778685ad7f9b9fe1ed6e", "message": "Merge remote-tracking branch 'upstream/master' into support-ubi-iron-bank", "committedDate": "2020-10-29T12:09:16Z", "type": "commit"}, {"oid": "597108016bd94f57e5a3772cc7687916c7234d26", "url": "https://github.com/elastic/elasticsearch/commit/597108016bd94f57e5a3772cc7687916c7234d26", "message": "Tweaks", "committedDate": "2020-10-29T12:17:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzMDg3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r515330876", "bodyText": "Should we be wiring this up to the assemble task if we generally don't want to be building this image as part of a \"normal\" build? Since building this for now is going to be a manual process perhaps we should leave this bit out and just run the explicit task when needed.", "author": "mark-vieira", "createdAt": "2020-10-30T19:34:52Z", "path": "distribution/docker/ironbank-docker-build-context/build.gradle", "diffHunk": "@@ -0,0 +1,14 @@\n+import org.elasticsearch.gradle.Architecture\n+import org.elasticsearch.gradle.DockerBase\n+\n+apply plugin: 'base'\n+\n+tasks.register(\"buildIronBankDockerBuildContext\", Tar) {\n+  archiveExtension = 'tar.gz'\n+  compression = Compression.GZIP\n+  archiveClassifier = \"docker-build-context\"\n+  archiveBaseName = \"elasticsearch-ironbank\"\n+  with dockerBuildContext(Architecture.X64, false, DockerBase.IRON_BANK, false)\n+}\n+\n+tasks.named(\"assemble\").configure {dependsOn \"buildIronBankDockerBuildContext\"}", "originalCommit": "597108016bd94f57e5a3772cc7687916c7234d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwODAzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r517908032", "bodyText": "That's a fair point. I removed the wiring-up.", "author": "pugnascotia", "createdAt": "2020-11-05T09:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzMDg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzMjU0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r515332549", "bodyText": "Isn't the iron bank image technically \"local\". Could we not just pass local = true for that build context instead of having this additional condition or does specifying local have other undesired behavior?", "author": "mark-vieira", "createdAt": "2020-10-30T19:37:18Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -29,7 +32,7 @@ dependencies {\n \n ext.expansions = { Architecture architecture, boolean oss, DockerBase base, boolean local ->\n   String classifier\n-  if (local) {\n+  if (local || base == DockerBase.IRON_BANK) {", "originalCommit": "597108016bd94f57e5a3772cc7687916c7234d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwODMwMg==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r517908302", "bodyText": "Ah...that's so obvious now you've pointed it out \ud83e\udd26", "author": "pugnascotia", "createdAt": "2020-11-05T09:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzMjU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzNjE0MA==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r515336140", "bodyText": "Do we want this trailing comma here?", "author": "mark-vieira", "createdAt": "2020-10-30T19:41:24Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -63,56 +75,82 @@ RUN curl --retry 8 -S -L \\\\\n \n   return [\n     'base_image'          : base.getImage(),\n+    'bin_dir'             : base == DockerBase.IRON_BANK ? 'scripts' : 'bin',\n+    'build_args'          : buildArgs,\n     'build_date'          : BuildParams.buildDate,\n+    'config_dir'          : base == DockerBase.IRON_BANK ? 'scripts' : 'config',\n     'git_revision'        : BuildParams.gitRevision,\n     'license'             : oss ? 'Apache-2.0' : 'Elastic-License',\n     'package_manager'     : base == DockerBase.UBI ? 'microdnf' : 'yum',\n     'source_elasticsearch': sourceElasticsearch,\n     'docker_base'         : base.name().toLowerCase(),\n-    'version'             : VersionProperties.elasticsearch\n+    'version'             : VersionProperties.elasticsearch,", "originalCommit": "597108016bd94f57e5a3772cc7687916c7234d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwODc5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r517908790", "bodyText": "I think that crept in because I added then removed some extra variables. Arguably you're more diff-proofed with the comma, but I'm not bothered either way, so I'm removed it again.", "author": "pugnascotia", "createdAt": "2020-11-05T09:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzNjE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzNzIyMA==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r515337220", "bodyText": "nit: My preference is to wrap nested ternary statements in parens. It just makes it easy to grok IMO.", "author": "mark-vieira", "createdAt": "2020-10-30T19:42:43Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -63,56 +75,82 @@ RUN curl --retry 8 -S -L \\\\\n \n   return [\n     'base_image'          : base.getImage(),\n+    'bin_dir'             : base == DockerBase.IRON_BANK ? 'scripts' : 'bin',\n+    'build_args'          : buildArgs,\n     'build_date'          : BuildParams.buildDate,\n+    'config_dir'          : base == DockerBase.IRON_BANK ? 'scripts' : 'config',\n     'git_revision'        : BuildParams.gitRevision,\n     'license'             : oss ? 'Apache-2.0' : 'Elastic-License',\n     'package_manager'     : base == DockerBase.UBI ? 'microdnf' : 'yum',\n     'source_elasticsearch': sourceElasticsearch,\n     'docker_base'         : base.name().toLowerCase(),\n-    'version'             : VersionProperties.elasticsearch\n+    'version'             : VersionProperties.elasticsearch,\n   ]\n }\n \n+/**\n+ * This filter squashes long runs of newlines so that the output\n+ * is a little more aesthetically pleasing.\n+ */\n+class SquashNewlinesFilter extends FilterReader {\n+  SquashNewlinesFilter(Reader input) {\n+    super(new StringReader(input.text.replaceAll(\"\\n{2,}\", \"\\n\\n\")))\n+  }\n+}\n+\n private static String buildPath(Architecture architecture, boolean oss, DockerBase base) {\n   return 'build/' +\n     (architecture == Architecture.AARCH64 ? 'aarch64-' : '') +\n     (oss ? 'oss-' : '') +\n     (base == DockerBase.UBI ? 'ubi-' : '') +\n+    (base == DockerBase.UBI ? 'ubi-' : base == DockerBase.IRON_BANK ? 'ironbank-' : '') +", "originalCommit": "597108016bd94f57e5a3772cc7687916c7234d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwODkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r517908905", "bodyText": "Parens added \ud83d\udc4d", "author": "pugnascotia", "createdAt": "2020-11-05T09:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzNzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzOTk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r515339955", "bodyText": "Just so I understand, we are effectively not building the iron bank image here becuase we have not added a corresponding \"export' project for it, yes?", "author": "mark-vieira", "createdAt": "2020-10-30T19:45:54Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -324,6 +362,8 @@ subprojects { Project subProject ->\n \n     final Architecture architecture = subProject.name.contains('aarch64-') ? Architecture.AARCH64 : Architecture.X64\n     final boolean oss = subProject.name.contains('oss-')\n+    // We can ignore Iron Bank at the moment as we don't", "originalCommit": "597108016bd94f57e5a3772cc7687916c7234d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwOTYzOA==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r517909638", "bodyText": "Yes, there's no export task, and there won't be without a way to automatically build the image. That would require simulating the Iron Bank image build process.", "author": "pugnascotia", "createdAt": "2020-11-05T09:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzOTk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0MDMwNA==", "url": "https://github.com/elastic/elasticsearch/pull/64336#discussion_r515340304", "bodyText": "\ud83d\udc4d", "author": "mark-vieira", "createdAt": "2020-10-30T19:46:15Z", "path": "distribution/docker/ubi-docker-build-context/build.gradle", "diffHunk": "@@ -10,4 +10,4 @@ task buildUbiDockerBuildContext(type: Tar) {\n   with dockerBuildContext(null, false, DockerBase.UBI, false)\n }\n \n-assemble.dependsOn buildUbiDockerBuildContext\n+tasks.named(\"assemble\").configure {dependsOn \"buildUbiDockerBuildContext\"}", "originalCommit": "597108016bd94f57e5a3772cc7687916c7234d26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c905fc592be3b6c3a5c9f8e7d757e470b7be6bea", "url": "https://github.com/elastic/elasticsearch/commit/c905fc592be3b6c3a5c9f8e7d757e470b7be6bea", "message": "Merge remote-tracking branch 'upstream/master' into support-ubi-iron-bank", "committedDate": "2020-11-05T09:19:28Z", "type": "commit"}, {"oid": "b3f02117d06a086900915f95d3cc017676116257", "url": "https://github.com/elastic/elasticsearch/commit/b3f02117d06a086900915f95d3cc017676116257", "message": "Address review feedback", "committedDate": "2020-11-05T09:29:38Z", "type": "commit"}, {"oid": "480c833db3b0a1b5c114807b515a5be283404bb5", "url": "https://github.com/elastic/elasticsearch/commit/480c833db3b0a1b5c114807b515a5be283404bb5", "message": "Merge remote-tracking branch 'upstream/master' into support-ubi-iron-bank", "committedDate": "2020-11-06T09:36:16Z", "type": "commit"}, {"oid": "b1b074d06e99f25d4271eee70463706ec682692c", "url": "https://github.com/elastic/elasticsearch/commit/b1b074d06e99f25d4271eee70463706ec682692c", "message": "Add debugging line", "committedDate": "2020-11-06T12:15:01Z", "type": "commit"}, {"oid": "d446dce76739494c05857b79d77fa5102b655c22", "url": "https://github.com/elastic/elasticsearch/commit/d446dce76739494c05857b79d77fa5102b655c22", "message": "More debugging", "committedDate": "2020-11-06T13:39:00Z", "type": "commit"}, {"oid": "40fd5965ce9cd884fc676ef5290d7cf803c41917", "url": "https://github.com/elastic/elasticsearch/commit/40fd5965ce9cd884fc676ef5290d7cf803c41917", "message": "More debugging", "committedDate": "2020-11-06T15:12:30Z", "type": "commit"}, {"oid": "aa44b5d79f628f10117f458a9b3b05d442e70a11", "url": "https://github.com/elastic/elasticsearch/commit/aa44b5d79f628f10117f458a9b3b05d442e70a11", "message": "Formatting", "committedDate": "2020-11-06T15:26:37Z", "type": "commit"}, {"oid": "3f7034be2a9e0962529f5e97c90470fb5fa28e6f", "url": "https://github.com/elastic/elasticsearch/commit/3f7034be2a9e0962529f5e97c90470fb5fa28e6f", "message": "More debugging", "committedDate": "2020-11-06T15:58:16Z", "type": "commit"}, {"oid": "b3b7028955dcaf0d70a4183dab0cdbd305b03dd3", "url": "https://github.com/elastic/elasticsearch/commit/b3b7028955dcaf0d70a4183dab0cdbd305b03dd3", "message": "More debugging", "committedDate": "2020-11-09T12:37:51Z", "type": "commit"}, {"oid": "b1a3644d1f3f8389555ebed95fc3b7ac6221643b", "url": "https://github.com/elastic/elasticsearch/commit/b1a3644d1f3f8389555ebed95fc3b7ac6221643b", "message": "Debugging", "committedDate": "2020-11-09T19:37:36Z", "type": "commit"}, {"oid": "eda4eed18f6d686458d8f8afe061fa845cf2df3b", "url": "https://github.com/elastic/elasticsearch/commit/eda4eed18f6d686458d8f8afe061fa845cf2df3b", "message": "Debugging", "committedDate": "2020-11-10T10:30:12Z", "type": "commit"}, {"oid": "7a8b2f3131e2f30707bc936d9cfc963268893c7b", "url": "https://github.com/elastic/elasticsearch/commit/7a8b2f3131e2f30707bc936d9cfc963268893c7b", "message": "Debugging", "committedDate": "2020-11-10T10:33:19Z", "type": "commit"}, {"oid": "2f297e404e182f4302eb1704e4d25013f4a91263", "url": "https://github.com/elastic/elasticsearch/commit/2f297e404e182f4302eb1704e4d25013f4a91263", "message": "Debugging", "committedDate": "2020-11-10T10:33:45Z", "type": "commit"}, {"oid": "b36f021254b2814356fbeffd4feae107004e824d", "url": "https://github.com/elastic/elasticsearch/commit/b36f021254b2814356fbeffd4feae107004e824d", "message": "Debugging", "committedDate": "2020-11-10T10:45:18Z", "type": "commit"}, {"oid": "fbde6b1238f1c95d36ca36ee58cb50f7211b6092", "url": "https://github.com/elastic/elasticsearch/commit/fbde6b1238f1c95d36ca36ee58cb50f7211b6092", "message": "Run elasticsearch-node as the archive user", "committedDate": "2020-11-10T10:53:48Z", "type": "commit"}, {"oid": "ea8948edda5c032b617fd4428a9ea5d390e8cfe7", "url": "https://github.com/elastic/elasticsearch/commit/ea8948edda5c032b617fd4428a9ea5d390e8cfe7", "message": "Windows fix", "committedDate": "2020-11-10T11:29:04Z", "type": "commit"}, {"oid": "fa557770ca6abebd08c6ac7f748e8ad3fe2c7d09", "url": "https://github.com/elastic/elasticsearch/commit/fa557770ca6abebd08c6ac7f748e8ad3fe2c7d09", "message": "Merge remote-tracking branch 'upstream/master' into support-ubi-iron-bank", "committedDate": "2020-11-11T16:18:00Z", "type": "commit"}, {"oid": "dd5ee8c441080f257d0ed81556bc67e1f6b497b1", "url": "https://github.com/elastic/elasticsearch/commit/dd5ee8c441080f257d0ed81556bc67e1f6b497b1", "message": "Revert debugging changes", "committedDate": "2020-11-11T16:18:45Z", "type": "commit"}, {"oid": "cfe7b4cba1de2230227e8ed34191f65d6bb467d5", "url": "https://github.com/elastic/elasticsearch/commit/cfe7b4cba1de2230227e8ed34191f65d6bb467d5", "message": "Fixes", "committedDate": "2020-11-11T16:36:08Z", "type": "commit"}, {"oid": "cfe941c2c7332efd0be908390cef7e683325a698", "url": "https://github.com/elastic/elasticsearch/commit/cfe941c2c7332efd0be908390cef7e683325a698", "message": "Merge remote-tracking branch 'upstream/master' into support-ubi-iron-bank", "committedDate": "2020-11-12T12:40:57Z", "type": "commit"}]}