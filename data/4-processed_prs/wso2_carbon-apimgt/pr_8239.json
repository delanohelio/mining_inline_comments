{"pr_number": 8239, "pr_title": "Fixing issues #7319 and #7244", "pr_createdAt": "2020-02-24T04:35:38Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8239", "timeline": [{"oid": "212a324b8611897a6fab5ec459a6358d820cf7d5", "url": "https://github.com/wso2/carbon-apimgt/commit/212a324b8611897a6fab5ec459a6358d820cf7d5", "message": "Fixing issues #7319 and #7244", "committedDate": "2020-02-24T04:30:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5OTY3Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8239#discussion_r383099672", "bodyText": "You can use APIConstants.FIELD_CONSUMER_KEY", "author": "isharac", "createdAt": "2020-02-24T06:26:03Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -5069,6 +5069,40 @@ public void deleteApplication(Application application) throws APIManagementExcep\n                 subscriptions.add(rs.getInt(\"SUBSCRIPTION_ID\"));\n             }\n \n+            prepStmtGetConsumerKey = connection.prepareStatement(getConsumerKeyQuery);\n+            prepStmtGetConsumerKey.setInt(1, application.getId());\n+            rs = prepStmtGetConsumerKey.executeQuery();\n+            List<String> consumerKeys = new ArrayList<>();\n+\n+            deleteDomainApp = connection.prepareStatement(deleteDomainAppQuery);\n+            while (rs.next()) {\n+                String consumerKey = rs.getString(\"CONSUMER_KEY\");", "originalCommit": "212a324b8611897a6fab5ec459a6358d820cf7d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEzNzE4OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8239#discussion_r383137188", "bodyText": "Fixed", "author": "kavishkafernando", "createdAt": "2020-02-24T08:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5OTY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5OTY4NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8239#discussion_r383099684", "bodyText": "extra line", "author": "isharac", "createdAt": "2020-02-24T06:26:07Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -5069,6 +5069,40 @@ public void deleteApplication(Application application) throws APIManagementExcep\n                 subscriptions.add(rs.getInt(\"SUBSCRIPTION_ID\"));\n             }\n \n+            prepStmtGetConsumerKey = connection.prepareStatement(getConsumerKeyQuery);\n+            prepStmtGetConsumerKey.setInt(1, application.getId());\n+            rs = prepStmtGetConsumerKey.executeQuery();\n+            List<String> consumerKeys = new ArrayList<>();\n+\n+            deleteDomainApp = connection.prepareStatement(deleteDomainAppQuery);\n+            while (rs.next()) {\n+                String consumerKey = rs.getString(\"CONSUMER_KEY\");\n+\n+                // This is true when OAuth app has been created by pasting consumer key/secret in the screen.\n+                String mode = rs.getString(\"CREATE_MODE\");\n+                if (consumerKey != null) {\n+                    deleteDomainApp.setString(1, consumerKey);\n+                    deleteDomainApp.addBatch();\n+\n+                    KeyManagerHolder.getKeyManagerInstance().deleteMappedApplication(consumerKey);\n+                    // OAuth app is deleted if only it has been created from API Store. For mapped clients we don't\n+                    // call delete.\n+                    if (!\"MAPPED\".equals(mode)) {\n+                        // Adding clients to be deleted.\n+                        consumerKeys.add(consumerKey);\n+                    }\n+", "originalCommit": "212a324b8611897a6fab5ec459a6358d820cf7d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEzNzE1OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8239#discussion_r383137158", "bodyText": "Fixed", "author": "kavishkafernando", "createdAt": "2020-02-24T08:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5OTY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5OTg5NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8239#discussion_r383099894", "bodyText": "use OAuthAppMode.MAPPED", "author": "isharac", "createdAt": "2020-02-24T06:27:10Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -5069,6 +5069,40 @@ public void deleteApplication(Application application) throws APIManagementExcep\n                 subscriptions.add(rs.getInt(\"SUBSCRIPTION_ID\"));\n             }\n \n+            prepStmtGetConsumerKey = connection.prepareStatement(getConsumerKeyQuery);\n+            prepStmtGetConsumerKey.setInt(1, application.getId());\n+            rs = prepStmtGetConsumerKey.executeQuery();\n+            List<String> consumerKeys = new ArrayList<>();\n+\n+            deleteDomainApp = connection.prepareStatement(deleteDomainAppQuery);\n+            while (rs.next()) {\n+                String consumerKey = rs.getString(\"CONSUMER_KEY\");\n+\n+                // This is true when OAuth app has been created by pasting consumer key/secret in the screen.\n+                String mode = rs.getString(\"CREATE_MODE\");\n+                if (consumerKey != null) {\n+                    deleteDomainApp.setString(1, consumerKey);\n+                    deleteDomainApp.addBatch();\n+\n+                    KeyManagerHolder.getKeyManagerInstance().deleteMappedApplication(consumerKey);\n+                    // OAuth app is deleted if only it has been created from API Store. For mapped clients we don't\n+                    // call delete.\n+                    if (!\"MAPPED\".equals(mode)) {", "originalCommit": "212a324b8611897a6fab5ec459a6358d820cf7d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEzNzExOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8239#discussion_r383137119", "bodyText": "Fixed", "author": "kavishkafernando", "createdAt": "2020-02-24T08:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5OTg5NA=="}], "type": "inlineReview"}, {"oid": "b2c2bd064e961a3efd2feeb76c1801ea559681e7", "url": "https://github.com/wso2/carbon-apimgt/commit/b2c2bd064e961a3efd2feeb76c1801ea559681e7", "message": "Use constants", "committedDate": "2020-02-24T08:49:20Z", "type": "commit"}]}