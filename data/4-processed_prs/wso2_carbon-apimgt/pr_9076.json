{"pr_number": 9076, "pr_title": "Add support for getting isDefaultVersion details for an API in Internal data service", "pr_createdAt": "2020-07-29T06:01:01Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9076", "timeline": [{"oid": "dc425986b9c5b34450eff1b7d37e5381ab0f0c84", "url": "https://github.com/wso2/carbon-apimgt/commit/dc425986b9c5b34450eff1b7d37e5381ab0f0c84", "message": "Add isDefaultVersion mapping to API object for Subscription Validation", "committedDate": "2020-07-29T05:37:16Z", "type": "commit"}, {"oid": "eb394f0096592b0500225b0f15476373d5a60d3f", "url": "https://github.com/wso2/carbon-apimgt/commit/eb394f0096592b0500225b0f15476373d5a60d3f", "message": "Add functionality to get isDefaultVersion data for an API", "committedDate": "2020-07-29T05:37:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzOTIwMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9076#discussion_r462239201", "bodyText": "@tharikaGitHub don't we hv to get the PUBLISHED_DEFAULT_API_VERSION? shall we check this", "author": "chamilaadhi", "createdAt": "2020-07-29T11:49:52Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SubscriptionValidationSQLConstants.java", "diffHunk": "@@ -348,161 +366,256 @@\n \n     public static final String GET_TENANT_APIS_SQL =\n             \"SELECT\" +\n-                    \"        API.API_ID,\" +\n-                    \"        API.API_PROVIDER,\" +\n-                    \"        API.API_NAME,\" +\n-                    \"        API.API_TIER,\" +\n-                    \"        API.API_VERSION,\" +\n-                    \"        API.CONTEXT,\" +\n-                    \"        API.API_TYPE,\" +\n-                    \"        URL.URL_MAPPING_ID,\" +\n-                    \"        URL.HTTP_METHOD,\" +\n-                    \"        URL.AUTH_SCHEME,\" +\n-                    \"        URL.URL_PATTERN,\" +\n-                    \"        URL.THROTTLING_TIER AS RES_TIER,\" +\n-                    \"        SCOPE.SCOPE_NAME \" +\n-                    \"    FROM\" +\n-                    \"        AM_API API,\" +\n-                    \"        AM_API_URL_MAPPING URL \" +\n-                    \"    LEFT JOIN\" +\n-                    \"        AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n+                    \"   APIS.API_ID,\" +\n+                    \"   APIS.API_PROVIDER,\" +\n+                    \"   APIS.API_NAME,\" +\n+                    \"   APIS.API_TIER,\" +\n+                    \"   APIS.API_VERSION,\" +\n+                    \"   APIS.CONTEXT,\" +\n+                    \"   APIS.API_TYPE,\" +\n+                    \"   APIS.URL_MAPPING_ID,\" +\n+                    \"   APIS.HTTP_METHOD,\" +\n+                    \"   APIS.AUTH_SCHEME,\" +\n+                    \"   APIS.URL_PATTERN,\" +\n+                    \"   APIS.RES_TIER,\" +\n+                    \"   APIS.SCOPE_NAME,\" +\n+                    \"   DEF.DEFAULT_API_VERSION \" +\n+                    \"FROM\" +\n+                    \"   (\" +\n+                    \"      SELECT\" +\n+                    \"         API.API_ID,\" +\n+                    \"         API.API_PROVIDER,\" +\n+                    \"         API.API_NAME,\" +\n+                    \"         API.API_TIER,\" +\n+                    \"         API.API_VERSION,\" +\n+                    \"         API.CONTEXT,\" +\n+                    \"         API.API_TYPE,\" +\n+                    \"         URL.URL_MAPPING_ID,\" +\n+                    \"         URL.HTTP_METHOD,\" +\n+                    \"         URL.AUTH_SCHEME,\" +\n+                    \"         URL.URL_PATTERN,\" +\n+                    \"         URL.THROTTLING_TIER AS RES_TIER,\" +\n+                    \"         SCOPE.SCOPE_NAME \" +\n+                    \"      FROM\" +\n+                    \"         AM_API API,\" +\n+                    \"         AM_API_URL_MAPPING URL \" +\n+                    \"         LEFT JOIN\" +\n+                    \"            AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n                     \"            ON URL.URL_MAPPING_ID = SCOPE.URL_MAPPING_ID \" +\n-                    \"    WHERE\" +\n-                    \"        API.API_ID = URL.API_ID\" +\n-                    \"        AND CONTEXT LIKE ?  \" +\n-                    \"    UNION ALL\" +\n-                    \"    SELECT\" +\n-                    \"        API.API_ID,\" +\n-                    \"        API.API_PROVIDER,\" +\n-                    \"        API.API_NAME,\" +\n-                    \"        API.API_TIER,\" +\n-                    \"        API.API_VERSION,\" +\n-                    \"        API.CONTEXT,\" +\n-                    \"        API.API_TYPE,\" +\n-                    \"        URL.URL_MAPPING_ID,\" +\n-                    \"        URL.HTTP_METHOD,\" +\n-                    \"        URL.AUTH_SCHEME,\" +\n-                    \"        URL.URL_PATTERN,\" +\n-                    \"        URL.THROTTLING_TIER AS RES_TIER,\" +\n-                    \"        SCOPE.SCOPE_NAME \" +\n-                    \"    FROM\" +\n-                    \"        AM_API API,\" +\n-                    \"        AM_API_PRODUCT_MAPPING PROD,\" +\n-                    \"        AM_API_URL_MAPPING URL \" +\n-                    \"    LEFT JOIN\" +\n-                    \"        AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n+                    \"      WHERE\" +\n+                    \"         API.API_ID = URL.API_ID \" +\n+                    \"         AND CONTEXT LIKE ? \" +\n+                    \"      UNION ALL\" +\n+                    \"      SELECT\" +\n+                    \"         API.API_ID,\" +\n+                    \"         API.API_PROVIDER,\" +\n+                    \"         API.API_NAME,\" +\n+                    \"         API.API_TIER,\" +\n+                    \"         API.API_VERSION,\" +\n+                    \"         API.CONTEXT,\" +\n+                    \"         API.API_TYPE,\" +\n+                    \"         URL.URL_MAPPING_ID,\" +\n+                    \"         URL.HTTP_METHOD,\" +\n+                    \"         URL.AUTH_SCHEME,\" +\n+                    \"         URL.URL_PATTERN,\" +\n+                    \"         URL.THROTTLING_TIER AS RES_TIER,\" +\n+                    \"         SCOPE.SCOPE_NAME \" +\n+                    \"      FROM\" +\n+                    \"         AM_API API,\" +\n+                    \"         AM_API_PRODUCT_MAPPING PROD,\" +\n+                    \"         AM_API_URL_MAPPING URL \" +\n+                    \"         LEFT JOIN\" +\n+                    \"            AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n                     \"            ON URL.URL_MAPPING_ID = SCOPE.URL_MAPPING_ID \" +\n-                    \"    WHERE\" +\n-                    \"        URL.URL_MAPPING_ID = PROD.URL_MAPPING_ID \" +\n-                    \"        AND API.API_ID = PROD.API_ID\" +\n-                    \"        AND CONTEXT LIKE ?\";\n+                    \"      WHERE\" +\n+                    \"         URL.URL_MAPPING_ID = PROD.URL_MAPPING_ID \" +\n+                    \"         AND API.API_ID = PROD.API_ID \" +\n+                    \"         AND CONTEXT LIKE ? \" +\n+                    \"   )\" +\n+                    \"   AS APIS \" +\n+                    \"   LEFT JOIN\" +\n+                    \"      AM_API_DEFAULT_VERSION AS DEF \" +\n+                    \"      ON APIS.API_NAME = DEF.API_NAME \" +\n+                    \"      AND APIS.API_PROVIDER = DEF.API_PROVIDER \" +\n+                    \"      AND APIS.API_VERSION = DEF.DEFAULT_API_VERSION\";\n \n     public static final String GET_ST_APIS_SQL =\n             \"SELECT\" +\n-                    \"        API.API_ID,\" +\n-                    \"        API.API_PROVIDER,\" +\n-                    \"        API.API_NAME,\" +\n-                    \"        API.API_TIER,\" +\n-                    \"        API.API_VERSION,\" +\n-                    \"        API.CONTEXT,\" +\n-                    \"        API.API_TYPE,\" +\n-                    \"        URL.URL_MAPPING_ID,\" +\n-                    \"        URL.HTTP_METHOD,\" +\n-                    \"        URL.AUTH_SCHEME,\" +\n-                    \"        URL.URL_PATTERN,\" +\n-                    \"        URL.THROTTLING_TIER AS RES_TIER,\" +\n-                    \"        SCOPE.SCOPE_NAME \" +\n-                    \"    FROM\" +\n-                    \"        AM_API API,\" +\n-                    \"        AM_API_URL_MAPPING URL \" +\n-                    \"    LEFT JOIN\" +\n-                    \"        AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n+                    \"   APIS.API_ID,\" +\n+                    \"   APIS.API_PROVIDER,\" +\n+                    \"   APIS.API_NAME,\" +\n+                    \"   APIS.API_TIER,\" +\n+                    \"   APIS.API_VERSION,\" +\n+                    \"   APIS.CONTEXT,\" +\n+                    \"   APIS.API_TYPE,\" +\n+                    \"   APIS.URL_MAPPING_ID,\" +\n+                    \"   APIS.HTTP_METHOD,\" +\n+                    \"   APIS.AUTH_SCHEME,\" +\n+                    \"   APIS.URL_PATTERN,\" +\n+                    \"   APIS.RES_TIER,\" +\n+                    \"   APIS.SCOPE_NAME,\" +\n+                    \"   DEF.DEFAULT_API_VERSION \" +\n+                    \"FROM\" +\n+                    \"   (\" +\n+                    \"      SELECT\" +\n+                    \"         API.API_ID,\" +\n+                    \"         API.API_PROVIDER,\" +\n+                    \"         API.API_NAME,\" +\n+                    \"         API.API_TIER,\" +\n+                    \"         API.API_VERSION,\" +\n+                    \"         API.CONTEXT,\" +\n+                    \"         API.API_TYPE,\" +\n+                    \"         URL.URL_MAPPING_ID,\" +\n+                    \"         URL.HTTP_METHOD,\" +\n+                    \"         URL.AUTH_SCHEME,\" +\n+                    \"         URL.URL_PATTERN,\" +\n+                    \"         URL.THROTTLING_TIER AS RES_TIER,\" +\n+                    \"         SCOPE.SCOPE_NAME \" +\n+                    \"      FROM\" +\n+                    \"         AM_API API,\" +\n+                    \"         AM_API_URL_MAPPING URL \" +\n+                    \"         LEFT JOIN\" +\n+                    \"            AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n                     \"            ON URL.URL_MAPPING_ID = SCOPE.URL_MAPPING_ID \" +\n-                    \"    WHERE\" +\n-                    \"        API.API_ID = URL.API_ID\" +\n-                    \"        AND CONTEXT NOT LIKE ?  \" +\n-                    \"    UNION\" +\n-                    \"    SELECT\" +\n-                    \"        API.API_ID,\" +\n-                    \"        API.API_PROVIDER,\" +\n-                    \"        API.API_NAME,\" +\n-                    \"        API.API_TIER,\" +\n-                    \"        API.API_VERSION,\" +\n-                    \"        API.CONTEXT,\" +\n-                    \"        API.API_TYPE,\" +\n-                    \"        URL.URL_MAPPING_ID,\" +\n-                    \"        URL.HTTP_METHOD,\" +\n-                    \"        URL.AUTH_SCHEME,\" +\n-                    \"        URL.URL_PATTERN,\" +\n-                    \"        URL.THROTTLING_TIER AS RES_TIER,\" +\n-                    \"        SCOPE.SCOPE_NAME \" +\n-                    \"    FROM\" +\n-                    \"        AM_API API,\" +\n-                    \"        AM_API_PRODUCT_MAPPING PROD,\" +\n-                    \"        AM_API_URL_MAPPING URL \" +\n-                    \"    LEFT JOIN\" +\n-                    \"        AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n+                    \"      WHERE\" +\n+                    \"         API.API_ID = URL.API_ID \" +\n+                    \"         AND CONTEXT NOT LIKE ? \" +\n+                    \"      UNION\" +\n+                    \"      SELECT\" +\n+                    \"         API.API_ID,\" +\n+                    \"         API.API_PROVIDER,\" +\n+                    \"         API.API_NAME,\" +\n+                    \"         API.API_TIER,\" +\n+                    \"         API.API_VERSION,\" +\n+                    \"         API.CONTEXT,\" +\n+                    \"         API.API_TYPE,\" +\n+                    \"         URL.URL_MAPPING_ID,\" +\n+                    \"         URL.HTTP_METHOD,\" +\n+                    \"         URL.AUTH_SCHEME,\" +\n+                    \"         URL.URL_PATTERN,\" +\n+                    \"         URL.THROTTLING_TIER AS RES_TIER,\" +\n+                    \"         SCOPE.SCOPE_NAME \" +\n+                    \"      FROM\" +\n+                    \"         AM_API API,\" +\n+                    \"         AM_API_PRODUCT_MAPPING PROD,\" +\n+                    \"         AM_API_URL_MAPPING URL \" +\n+                    \"         LEFT JOIN\" +\n+                    \"            AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n                     \"            ON URL.URL_MAPPING_ID = SCOPE.URL_MAPPING_ID \" +\n-                    \"    WHERE\" +\n-                    \"        URL.URL_MAPPING_ID = PROD.URL_MAPPING_ID \" +\n-                    \"        AND API.API_ID = PROD.API_ID\" +\n-                    \"        AND CONTEXT NOT LIKE ?\";\n+                    \"      WHERE\" +\n+                    \"         URL.URL_MAPPING_ID = PROD.URL_MAPPING_ID \" +\n+                    \"         AND API.API_ID = PROD.API_ID \" +\n+                    \"         AND CONTEXT NOT LIKE ? \" +\n+                    \"   )\" +\n+                    \"   AS APIS \" +\n+                    \"   LEFT JOIN\" +\n+                    \"      AM_API_DEFAULT_VERSION AS DEF \" +\n+                    \"      ON APIS.API_NAME = DEF.API_NAME \" +\n+                    \"      AND APIS.API_PROVIDER = DEF.API_PROVIDER \" +\n+                    \"      AND APIS.API_VERSION = DEF.DEFAULT_API_VERSION\";\n \n     public static final String GET_API_SQL =\n             \"SELECT \" +\n-                    \"  API.API_ID,\" +\n-                    \"  API.API_PROVIDER,\" +\n-                    \"  API.API_NAME,\" +\n-                    \"  API.API_TIER,\" +\n-                    \"  API.API_VERSION,\" +\n-                    \"  API.CONTEXT, \" +\n-                    \"  API.API_TYPE, \" +\n-                    \"  URL.URL_MAPPING_ID,\" +\n-                    \"  URL.HTTP_METHOD,\" +\n-                    \"  URL.AUTH_SCHEME,\" +\n-                    \"  URL.URL_PATTERN,\" +\n-                    \"  URL.THROTTLING_TIER AS RES_TIER,\" +\n-                    \"  SCOPE.SCOPE_NAME \" +\n-                    \" FROM \" +\n-                    \"   AM_API API,\" +\n-                    \"   AM_API_URL_MAPPING URL\" +\n-                    \" LEFT JOIN \" +\n-                    \"  AM_API_RESOURCE_SCOPE_MAPPING SCOPE \" +\n-                    \" ON \" +\n-                    \"  URL.URL_MAPPING_ID = SCOPE.URL_MAPPING_ID \" +\n-                    \" WHERE \" +\n-                    \"   API.API_ID = URL.API_ID AND \" +\n-                    \"   API.API_VERSION = ? AND \" +\n-                    \"   API.CONTEXT = ?\";\n+                    \"   APIS.API_ID,\" +\n+                    \"   APIS.API_PROVIDER,\" +\n+                    \"   APIS.API_NAME,\" +\n+                    \"   APIS.API_TIER,\" +\n+                    \"   APIS.API_VERSION,\" +\n+                    \"   APIS.CONTEXT,\" +\n+                    \"   APIS.API_TYPE,\" +\n+                    \"   APIS.URL_MAPPING_ID,\" +\n+                    \"   APIS.HTTP_METHOD,\" +\n+                    \"   APIS.AUTH_SCHEME,\" +\n+                    \"   APIS.URL_PATTERN,\" +\n+                    \"   APIS.RES_TIER,\" +\n+                    \"   APIS.SCOPE_NAME,\" +\n+                    \"   DEF.DEFAULT_API_VERSION \" +\n+                    \"FROM \" +\n+                    \"   (\" +\n+                    \"      SELECT \" +\n+                    \"         API.API_ID,\" +\n+                    \"         API.API_PROVIDER,\" +\n+                    \"         API.API_NAME,\" +\n+                    \"         API.API_TIER,\" +\n+                    \"         API.API_VERSION,\" +\n+                    \"         API.CONTEXT,\" +\n+                    \"         API.API_TYPE,\" +\n+                    \"         URL.URL_MAPPING_ID,\" +\n+                    \"         URL.HTTP_METHOD,\" +\n+                    \"         URL.AUTH_SCHEME,\" +\n+                    \"         URL.URL_PATTERN,\" +\n+                    \"         URL.THROTTLING_TIER AS RES_TIER,\" +\n+                    \"         SCOPE.SCOPE_NAME\" +\n+                    \"      FROM \" +\n+                    \"         AM_API API,\" +\n+                    \"         AM_API_URL_MAPPING URL\" +\n+                    \"         LEFT JOIN\" +\n+                    \"            AM_API_RESOURCE_SCOPE_MAPPING SCOPE\" +\n+                    \"            ON URL.URL_MAPPING_ID = SCOPE.URL_MAPPING_ID\" +\n+                    \"      WHERE\" +\n+                    \"         API.API_ID = URL.API_ID\" +\n+                    \"         AND API.API_VERSION = ?\" +\n+                    \"         AND API.CONTEXT = ?\" +\n+                    \"   )\" +\n+                    \"   AS APIS \" +\n+                    \"   LEFT JOIN \" +\n+                    \"      AM_API_DEFAULT_VERSION AS DEF\" +\n+                    \"      ON APIS.API_NAME = DEF.API_NAME\" +\n+                    \"      AND APIS.API_PROVIDER = DEF.API_PROVIDER\" +\n+                    \"      AND APIS.API_VERSION = DEF.DEFAULT_API_VERSION\";", "originalCommit": "1fd1523be812d93a03ced52015a7c9dfbb9d9620", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM5MTExNw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9076#discussion_r462391117", "bodyText": "Fixed with f19e30f", "author": "tharikaGitHub", "createdAt": "2020-07-29T15:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzOTIwMQ=="}], "type": "inlineReview"}, {"oid": "f19e30fc575d02246c5ba429b9de8aabf8551162", "url": "https://github.com/wso2/carbon-apimgt/commit/f19e30fc575d02246c5ba429b9de8aabf8551162", "message": "Add review fixes", "committedDate": "2020-07-29T15:28:59Z", "type": "commit"}, {"oid": "f19e30fc575d02246c5ba429b9de8aabf8551162", "url": "https://github.com/wso2/carbon-apimgt/commit/f19e30fc575d02246c5ba429b9de8aabf8551162", "message": "Add review fixes", "committedDate": "2020-07-29T15:28:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTAyMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9076#discussion_r462709022", "bodyText": "This logic is not right. \"PUBLISHED_DEFAULT_API_VERSION\" colum gives you the default version. What you could do is check \"PUBLISHED_DEFAULT_API_VERSION\" is equal to \"API_VERSION\" and set the boolean as true if equals", "author": "chamilaadhi", "createdAt": "2020-07-30T03:13:37Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/SubscriptionValidationDAO.java", "diffHunk": "@@ -329,6 +329,7 @@ public API getApi(String version, String context) {\n                     api.setPolicy(resultSet.getString(\"API_TIER\"));\n                     api.setVersion(resultSet.getString(\"API_VERSION\"));\n                     api.setContext(resultSet.getString(\"CONTEXT\"));\n+                    api.setIsDefaultVersion(resultSet.getBoolean(\"PUBLISHED_DEFAULT_API_VERSION\"));", "originalCommit": "f19e30fc575d02246c5ba429b9de8aabf8551162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4ODQzMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9076#discussion_r462888432", "bodyText": "Fixed with 9c76d41", "author": "tharikaGitHub", "createdAt": "2020-07-30T10:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTA0OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9076#discussion_r462709048", "bodyText": "same here", "author": "chamilaadhi", "createdAt": "2020-07-30T03:13:46Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/SubscriptionValidationDAO.java", "diffHunk": "@@ -371,6 +372,7 @@ private void populateAPIList(ResultSet resultSet, List<API> apiList) throws SQLE\n                 api.setPolicy(resultSet.getString(\"API_TIER\"));\n                 api.setVersion(resultSet.getString(\"API_VERSION\"));\n                 api.setContext(resultSet.getString(\"CONTEXT\"));\n+                api.setIsDefaultVersion(resultSet.getBoolean(\"PUBLISHED_DEFAULT_API_VERSION\"));", "originalCommit": "f19e30fc575d02246c5ba429b9de8aabf8551162", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4ODQ2NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9076#discussion_r462888465", "bodyText": "Fixed with 9c76d41", "author": "tharikaGitHub", "createdAt": "2020-07-30T10:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTA0OA=="}], "type": "inlineReview"}, {"oid": "9c76d41950a114213dcd434e71f496deec16f689", "url": "https://github.com/wso2/carbon-apimgt/commit/9c76d41950a114213dcd434e71f496deec16f689", "message": "Change default version retrieval for internal service", "committedDate": "2020-07-30T09:58:50Z", "type": "commit"}]}