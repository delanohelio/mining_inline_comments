{"pr_number": 8302, "pr_title": "Adding passive mode for DevPortal", "pr_createdAt": "2020-03-03T12:29:40Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8302", "timeline": [{"oid": "736453d24ac53ef22a95c6dd14179c5ec7b37d7e", "url": "https://github.com/wso2/carbon-apimgt/commit/736453d24ac53ef22a95c6dd14179c5ec7b37d7e", "message": "Adding passive mode for DevPortal", "committedDate": "2020-03-03T12:29:57Z", "type": "commit"}, {"oid": "81aa3ebe434ec10d8013f8534b623a3fa6947c06", "url": "https://github.com/wso2/carbon-apimgt/commit/81aa3ebe434ec10d8013f8534b623a3fa6947c06", "message": "Resolving conflicts", "committedDate": "2020-03-03T12:33:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NjM4Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r387556382", "bodyText": "Formatting issue.", "author": "menakaj", "createdAt": "2020-03-04T09:53:05Z", "path": "features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/services/login/login_callback.jag", "diffHunk": "@@ -25,15 +25,21 @@\n     app.context = appUtils.getTenantBaseStoreContext();\n     var utils = Packages.org.wso2.carbon.apimgt.impl.utils.APIUtil;\n     var serverUrl = \"\";\n+    var isPassive = require(\"/site/public/theme/settings.js\").Settings.app.isPassive;\n     var forwarded_for = request.getHeader(app.customUrl.forwardedHeader);\n     if (app.customUrl.enabled && forwarded_for) {\n         serverUrl = MGT_TRANSPORT + forwarded_for;\n     } else {\n         serverUrl = utils.getServerURL();\n     }\n-    if(request.getParameter(\"error\") === \"login_required\"){\n-       response.sendRedirect(serverUrl + app.context + \"/services/configs\");\n-    } else if(request.getParameter(\"code\") != null){\n+    if(request.getParameter(\"error\")===\"login_required\" && isPassive){\n+        if(utils.getIdentityProviderConfig()!=null){\n+        response.sendRedirect(serverUrl + app.context);\n+        }\n+        else{\n+        response.content={error:\"Loginerror\"};", "originalCommit": "81aa3ebe434ec10d8013f8534b623a3fa6947c06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NjQ5OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r387556498", "bodyText": "Formatting issue.", "author": "menakaj", "createdAt": "2020-03-04T09:53:18Z", "path": "features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/services/login/login_callback.jag", "diffHunk": "@@ -25,15 +25,21 @@\n     app.context = appUtils.getTenantBaseStoreContext();\n     var utils = Packages.org.wso2.carbon.apimgt.impl.utils.APIUtil;\n     var serverUrl = \"\";\n+    var isPassive = require(\"/site/public/theme/settings.js\").Settings.app.isPassive;\n     var forwarded_for = request.getHeader(app.customUrl.forwardedHeader);\n     if (app.customUrl.enabled && forwarded_for) {\n         serverUrl = MGT_TRANSPORT + forwarded_for;\n     } else {\n         serverUrl = utils.getServerURL();\n     }\n-    if(request.getParameter(\"error\") === \"login_required\"){\n-       response.sendRedirect(serverUrl + app.context + \"/services/configs\");\n-    } else if(request.getParameter(\"code\") != null){\n+    if(request.getParameter(\"error\")===\"login_required\" && isPassive){\n+        if(utils.getIdentityProviderConfig()!=null){\n+        response.sendRedirect(serverUrl + app.context);", "originalCommit": "81aa3ebe434ec10d8013f8534b623a3fa6947c06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1Njg2OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r387556869", "bodyText": "Fix formatting. Exceeds 120 character limit.", "author": "menakaj", "createdAt": "2020-03-04T09:53:58Z", "path": "features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/source/src/DevPortal.jsx", "diffHunk": "@@ -84,6 +89,14 @@ class DevPortal extends React.Component {\n         promisedSettings\n             .then((response) => {\n                 this.setSettings(response.body);\n+            })\n+            .then((response) => {\n+                if(!this.state.settings.IsAnonymousModeEnabled){\n+                    this.setState({isNonAnonymous:true})\n+                }\n+                if (Settings.app.isPassive && !AuthManager.getUser() && !sessionStorage.getItem('notEnoughPermission') && !this.state.isNonAnonymous) {", "originalCommit": "81aa3ebe434ec10d8013f8534b623a3fa6947c06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1Njk5Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r387556992", "bodyText": "Add method comments.", "author": "menakaj", "createdAt": "2020-03-04T09:54:12Z", "path": "features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/source/src/DevPortal.jsx", "diffHunk": "@@ -244,14 +255,45 @@ class DevPortal extends React.Component {\n         return (prefix + sufix);\n     }\n \n+    checkLoginUser(isExternalIDP) {", "originalCommit": "81aa3ebe434ec10d8013f8534b623a3fa6947c06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0fe8c55b336f5cbab2f9db0498ae6c3ef0002746", "url": "https://github.com/wso2/carbon-apimgt/commit/0fe8c55b336f5cbab2f9db0498ae6c3ef0002746", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt", "committedDate": "2020-03-06T13:02:03Z", "type": "commit"}, {"oid": "1daac5ed6a777f09499a8918036869eec24f1ea9", "url": "https://github.com/wso2/carbon-apimgt/commit/1daac5ed6a777f09499a8918036869eec24f1ea9", "message": "Add Non-anonymous mode for Dev Portal", "committedDate": "2020-03-10T13:23:41Z", "type": "commit"}, {"oid": "65602cd1db9246555b952a906773417f9dec7d0a", "url": "https://github.com/wso2/carbon-apimgt/commit/65602cd1db9246555b952a906773417f9dec7d0a", "message": "Resolving Conflicts", "committedDate": "2020-03-12T08:46:46Z", "type": "commit"}, {"oid": "cd1f09fa698994d4c146b591f13dc6e116ec48c1", "url": "https://github.com/wso2/carbon-apimgt/commit/cd1f09fa698994d4c146b591f13dc6e116ec48c1", "message": "Resolving the Formatting issue", "committedDate": "2020-03-12T14:38:45Z", "type": "commit"}, {"oid": "ecc1f37e71dd7b3ce004c965bbd278aec57a0a3e", "url": "https://github.com/wso2/carbon-apimgt/commit/ecc1f37e71dd7b3ce004c965bbd278aec57a0a3e", "message": "Removing the Fetch Call", "committedDate": "2020-03-13T12:07:41Z", "type": "commit"}, {"oid": "61689673e452e9aefadae019a1fb5c24cbdde5bf", "url": "https://github.com/wso2/carbon-apimgt/commit/61689673e452e9aefadae019a1fb5c24cbdde5bf", "message": "Fixing the indentation in login_callback.jag", "committedDate": "2020-03-13T12:11:34Z", "type": "commit"}, {"oid": "25b02277ecf988b4cc10275f91729098ed8448e4", "url": "https://github.com/wso2/carbon-apimgt/commit/25b02277ecf988b4cc10275f91729098ed8448e4", "message": "Resolving conflicts", "committedDate": "2020-03-25T09:21:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczMjUyMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r397732521", "bodyText": "Why use debug logs?", "author": "menakaj", "createdAt": "2020-03-25T10:00:20Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -5780,6 +5780,29 @@ public String getRequestedTenant() {\n         return requestedTenant;\n     }\n \n+    /**\n+     * To check whether the DevPortal Anonymous Mode is enabled. It can be either enabled globally or tenant vice.\n+     *\n+     * @param tenantDomain Tenant domain\n+     * @return whether devportal anonymous mode is enabled or not\n+     */\n+\n+    public boolean isDevPortalAnonymousEnabled(String tenantDomain) {\n+\n+        try {\n+            org.json.simple.JSONObject tenantConfig = APIUtil.getTenantConfig(tenantDomain);\n+            Object value = tenantConfig.get(APIConstants.API_TENANT_CONF_ENABLE_ANONYMOUS_MODE);\n+            if (value != null) {\n+                return Boolean.parseBoolean(value.toString());\n+            } else {\n+                return APIUtil.isDevPortalAnonymous();\n+            }\n+        } catch (APIManagementException e) {\n+            log.debug(\"Error while retrieving Recommendation config from registry\", e);", "originalCommit": "25b02277ecf988b4cc10275f91729098ed8448e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczMjc3Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r397732777", "bodyText": "Add space before and after '+'", "author": "menakaj", "createdAt": "2020-03-25T10:00:44Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConstants.java", "diffHunk": "@@ -688,6 +689,7 @@ private Permissions() {\n     public static final String API_STORE_MAP_EXISTING_AUTH_APPS = API_STORE + \"MapExistingAuthApps\";\n     public static final String API_STORE_API_KEY_ALIAS = API_STORE + \"ApiKeyAlias\";\n     public static final String WSO2_ANONYMOUS_USER = \"wso2.anonymous.user\";\n+    public static final String API_DEVPORTAL_ANONYMOUS_MODE = API_STORE+\"EnableAnonymousMode\";", "originalCommit": "25b02277ecf988b4cc10275f91729098ed8448e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczMzE2NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r397733165", "bodyText": "Remove additional line", "author": "menakaj", "createdAt": "2020-03-25T10:01:21Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -10321,6 +10321,17 @@ public static boolean isCertificateExistsInTrustStore(X509Certificate certificat\n         return false;\n     }\n \n+    public static boolean isDevPortalAnonymous() {\n+        APIManagerConfiguration config = ServiceReferenceHolder.getInstance().\n+                getAPIManagerConfigurationService().getAPIManagerConfiguration();\n+        String anonymousMode = config.getFirstProperty(APIConstants.API_DEVPORTAL_ANONYMOUS_MODE);\n+        if (anonymousMode == null) {\n+            return true;\n+        }\n+        return Boolean.parseBoolean(anonymousMode);\n+    }\n+\n+", "originalCommit": "25b02277ecf988b4cc10275f91729098ed8448e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczNTM3Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r397735376", "bodyText": "Please fix the following eslint issues.\n/home/travis/build/wso2/carbon-apimgt/features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/source/src/app/ProtectedApp.jsx\n71:77  error  A space is required before '}'       object-curly-spacing\n180:1   error  More than 2 blank lines not allowed  no-multiple-empty-lines\n222:42  error  Operator '+' must be spaced          space-infix-ops", "author": "menakaj", "createdAt": "2020-03-25T10:04:48Z", "path": "features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/source/src/app/ProtectedApp.jsx", "diffHunk": "@@ -21,9 +21,10 @@ import qs from 'qs';\n import { withTheme } from '@material-ui/core/styles';", "originalCommit": "25b02277ecf988b4cc10275f91729098ed8448e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgzMDE5Mg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r397830192", "bodyText": "Please add spaces after \":\"\nISLOGINPERMITTED: 'isLoginPermitted',\nLOGINSTATUS: 'loginStatus',", "author": "malinthaprasan", "createdAt": "2020-03-25T12:54:33Z", "path": "features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/source/src/app/data/Constants.jsx", "diffHunk": "@@ -20,6 +20,8 @@ const CONSTS = {\n         INSUFFICIENT_PREVILEGES: '900403: Insufficient privileges to login',\n         INVALID_TOKEN: '900401: Invalid token',\n     },\n+    ISLOGINPERMITTED:'isLoginPermitted',\n+    LOGINSTATUS:'loginStatus',", "originalCommit": "25b02277ecf988b4cc10275f91729098ed8448e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67a3c04847994000708dc1bcc84f3c7b4ff6104f", "url": "https://github.com/wso2/carbon-apimgt/commit/67a3c04847994000708dc1bcc84f3c7b4ff6104f", "message": "Fix the Changes Requested", "committedDate": "2020-03-25T13:08:37Z", "type": "commit"}, {"oid": "fbd065d92fcc36e2e4369a854f86eb5599d44a82", "url": "https://github.com/wso2/carbon-apimgt/commit/fbd065d92fcc36e2e4369a854f86eb5599d44a82", "message": "Fix the Changes Requested", "committedDate": "2020-03-25T13:10:51Z", "type": "commit"}, {"oid": "21e925ba4dc604f75ea7607bab76404e4fec097f", "url": "https://github.com/wso2/carbon-apimgt/commit/21e925ba4dc604f75ea7607bab76404e4fec097f", "message": "Fix the Changes Requested", "committedDate": "2020-03-25T13:34:27Z", "type": "commit"}, {"oid": "dda5ede3c17de5e9c9cbc1b018885194a87d3485", "url": "https://github.com/wso2/carbon-apimgt/commit/dda5ede3c17de5e9c9cbc1b018885194a87d3485", "message": "Resolving conflicts", "committedDate": "2020-05-05T10:25:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxNDg3OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8302#discussion_r420014878", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        + clientId + '&redirect_uri='+ window.location.origin\n          \n          \n            \n                        + clientId + '&redirect_uri=' + window.location.origin", "author": "malinthaprasan", "createdAt": "2020-05-05T10:39:12Z", "path": "features/apimgt/org.wso2.carbon.apimgt.store.feature/src/main/resources/devportal/source/src/app/ProtectedApp.jsx", "diffHunk": "@@ -217,12 +215,12 @@ class ProtectedApp extends Component {\n      */\n     render() {\n         const {\n-            userResolved, tenantList, notEnoughPermission, tenantResolved, clientId\n+            userResolved, tenantList, notEnoughPermission, tenantResolved, clientId,\n         } = this.state;\n         const checkSessionURL = Settings.idp.checkSessionEndpoint + '?client_id='\n             + clientId + '&redirect_uri='+ window.location.origin", "originalCommit": "dda5ede3c17de5e9c9cbc1b018885194a87d3485", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "56329eedbd60b67cd85fbacf3c28de50195d2898", "url": "https://github.com/wso2/carbon-apimgt/commit/56329eedbd60b67cd85fbacf3c28de50195d2898", "message": "Fixing the npm build issue", "committedDate": "2020-05-05T11:01:27Z", "type": "commit"}, {"oid": "1a886f0943f1a60145ae3746e1e4af3e9d1a1fd6", "url": "https://github.com/wso2/carbon-apimgt/commit/1a886f0943f1a60145ae3746e1e4af3e9d1a1fd6", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt", "committedDate": "2020-05-05T11:10:29Z", "type": "commit"}, {"oid": "1a886f0943f1a60145ae3746e1e4af3e9d1a1fd6", "url": "https://github.com/wso2/carbon-apimgt/commit/1a886f0943f1a60145ae3746e1e4af3e9d1a1fd6", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt", "committedDate": "2020-05-05T11:10:29Z", "type": "forcePushed"}]}