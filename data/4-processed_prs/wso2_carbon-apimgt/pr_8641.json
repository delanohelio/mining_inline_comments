{"pr_number": 8641, "pr_title": "Adding shared scope usage REST API", "pr_createdAt": "2020-06-03T07:19:07Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8641", "timeline": [{"oid": "ecfe7debc6c80092e9e02bff7dd29d93c2a40837", "url": "https://github.com/wso2/carbon-apimgt/commit/ecfe7debc6c80092e9e02bff7dd29d93c2a40837", "message": "Adding shared scope usage REST API", "committedDate": "2020-06-03T07:16:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk1ODE1NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8641#discussion_r434958154", "bodyText": "is it possible to use try with resources", "author": "malinthaprasan", "createdAt": "2020-06-04T02:32:54Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -14704,6 +14706,80 @@ public String getSharedScopeKeyByUUID(String uuid) throws APIManagementException\n         return scopeKey;\n     }\n \n+    /***\n+     * Get the API and URI usages of the given shared scope\n+     *\n+     * @param uuid Id of the shared scope\n+     * @param tenantId tenant Id\n+     * @return usgaes ofr the shaerd scope\n+     * @throws APIManagementException If an error occurs while getting the usage details\n+     */\n+    public SharedScopeUsage getSharedScopeUsage(String uuid, int tenantId) throws APIManagementException {\n+        Connection conn = null;\n+        ResultSet apiUsageResultSet = null;\n+        ResultSet uriUsageResultSet = null;\n+        PreparedStatement psForApiUsage = null;\n+        PreparedStatement psForUriUsage = null;\n+        SharedScopeUsage sharedScopeUsage = null;\n+        List<API> usedApiList = new ArrayList<>();\n+        String sharedScopeName = getSharedScopeKeyByUUID(uuid);\n+\n+        if (sharedScopeName != null) {\n+            sharedScopeUsage = new SharedScopeUsage();\n+            sharedScopeUsage.setId(uuid);\n+            sharedScopeUsage.setName(sharedScopeName);\n+        } else {\n+            throw new APIMgtResourceNotFoundException(\"Shared Scope not found for scope ID: \" + uuid,\n+                    ExceptionCodes.from(ExceptionCodes.SHARED_SCOPE_NOT_FOUND, uuid));\n+        }\n+\n+        try {\n+            conn = APIMgtDBUtil.getConnection();\n+            String sqlQueryForApiUsage = SQLConstants.GET_SHARED_SCOPE_API_USAGE_BY_TENANT;\n+            psForApiUsage = conn.prepareStatement(sqlQueryForApiUsage);\n+            psForApiUsage.setString(1, uuid);\n+            psForApiUsage.setInt(2, tenantId);\n+            apiUsageResultSet = psForApiUsage.executeQuery();\n+            while (apiUsageResultSet.next()) {", "originalCommit": "ecfe7debc6c80092e9e02bff7dd29d93c2a40837", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjI5Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8641#discussion_r435032297", "bodyText": "Fixed with 3550c6a", "author": "mushthaq33", "createdAt": "2020-06-04T06:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk1ODE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk1ODk1OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8641#discussion_r434958958", "bodyText": "shall we add examples here too?", "author": "malinthaprasan", "createdAt": "2020-06-04T02:35:39Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.publisher.v1/src/main/resources/publisher-api.yaml", "diffHunk": "@@ -8825,6 +8861,74 @@ definitions:\n           usage count of Scope\n         example: 3\n \n+#-----------------------------------------------------\n+# The Shared Scope Usage resource\n+#-----------------------------------------------------\n+  SharedScopeUsage:\n+    title: SharedScopeUsage\n+    required:\n+      - id\n+      - name\n+    properties:\n+      id:\n+        type: string\n+        description: |\n+          UUID of the Scope. Valid only for shared scopes.\n+        example: 01234567-0123-0123-0123-012345678901\n+      name:\n+        type: string\n+        description: |\n+          name of Scope\n+        example: apim:api_view\n+      usedApiList:\n+        description: |\n+          API list which have used the shared scope\n+        type: array\n+        items:\n+          $ref: '#/definitions/SharedScopeUsedAPIInfo'\n+\n+#-----------------------------------------------------\n+# The API object where the shared scope is used\n+#-----------------------------------------------------\n+  SharedScopeUsedAPIInfo:\n+    title: API object using shared scope\n+    required:\n+      - name\n+      - context\n+      - version\n+    properties:\n+      name:\n+        type: string\n+        example: CalculatorAPI\n+      context:\n+        type: string\n+        example: CalculatorAPI\n+      version:\n+        type: string\n+        example: 1.0.0\n+      provider:\n+        description: |\n+          If the provider value is not given user invoking the api will be used as the provider.\n+        type: string\n+        example: admin\n+      usedResourceList:\n+        description: |\n+          Resource list which have used the shared scope within this API\n+        type: array\n+        items:\n+          $ref: '#/definitions/SharedScopeUsedAPIResourceInfo'\n+\n+  #-----------------------------------------------------\n+  # The API resource object where the shared scope is used\n+  #-----------------------------------------------------\n+  SharedScopeUsedAPIResourceInfo:\n+    title: API resource object using shared scope\n+    properties:\n+      target:\n+        type: string\n+      verb:\n+        type: string", "originalCommit": "ecfe7debc6c80092e9e02bff7dd29d93c2a40837", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjQwMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8641#discussion_r435032402", "bodyText": "Fixed with 3550c6a", "author": "mushthaq33", "createdAt": "2020-06-04T06:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk1ODk1OA=="}], "type": "inlineReview"}, {"oid": "3550c6ac829d5e756dab682eab507f16e5616d0b", "url": "https://github.com/wso2/carbon-apimgt/commit/3550c6ac829d5e756dab682eab507f16e5616d0b", "message": "Adding changes", "committedDate": "2020-06-04T06:57:12Z", "type": "commit"}, {"oid": "ced0371bde8abe362a22f5b7de80d1afca230307", "url": "https://github.com/wso2/carbon-apimgt/commit/ced0371bde8abe362a22f5b7de80d1afca230307", "message": "Adding changes", "committedDate": "2020-06-04T07:02:37Z", "type": "commit"}]}