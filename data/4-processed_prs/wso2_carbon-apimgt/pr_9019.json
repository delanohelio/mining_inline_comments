{"pr_number": 9019, "pr_title": " Refine Error handling for gateway Rest API", "pr_createdAt": "2020-07-22T04:09:56Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9019", "timeline": [{"oid": "dad34d0a5c690fbbcdaf4446a005cf92e0a86393", "url": "https://github.com/wso2/carbon-apimgt/commit/dad34d0a5c690fbbcdaf4446a005cf92e0a86393", "message": "handle error in gatewayRESTAPI", "committedDate": "2020-07-22T04:07:46Z", "type": "commit"}, {"oid": "361080aec243f1942053ea5db9b5b82219c376b3", "url": "https://github.com/wso2/carbon-apimgt/commit/361080aec243f1942053ea5db9b5b82219c376b3", "message": "Adding error handling in gateway startup", "committedDate": "2020-07-22T04:18:16Z", "type": "commit"}, {"oid": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "url": "https://github.com/wso2/carbon-apimgt/commit/e9ae44f6923017fe021caa8f14a9e08034111fd5", "message": "Add debug logs", "committedDate": "2020-07-22T05:53:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0ODMzMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458748330", "bodyText": "Do we need these escapes?", "author": "1akshitha", "createdAt": "2020-07-22T12:17:38Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/InMemoryAPIDeployer.java", "diffHunk": "@@ -72,15 +73,24 @@ public boolean deployAPI(String apiId, String gatewayLabel) {\n                     if (gatewayRuntimeArtifact != null) {\n                         GatewayAPIDTO gatewayAPIDTO = new Gson().fromJson(gatewayRuntimeArtifact, GatewayAPIDTO.class);\n                         apiGatewayAdmin.deployAPI(gatewayAPIDTO);\n+                        if (debugEnabled) {\n+                            log.debug(\"API with \" + apiId + \" is deployed in gateway with the label of \" + gatewayLabel);\n+                        }\n                         return true;\n                     } else {\n-                        log.error(\"Error retrieving artifacts for API \" + apiId + \". Storage returned null\");\n+                        String msg = \"Error retrieving artifacts for API \" + apiId + \". Storage returned null\";\n+                        log.error(msg);\n+                        throw new ArtifactSynchronizerException(msg);\n                     }\n                 } catch (IOException | ArtifactSynchronizerException e) {\n-                    log.error(\"Error deploying \" + apiId + \" in Gateway\", e);\n+                    String msg = \"\\\"Error deploying \\\" + apiId + \\\" in Gateway\\\"\";", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MDgwMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458750800", "bodyText": "Fixed ae94c47", "author": "Sarangan0219", "createdAt": "2020-07-22T12:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0ODMzMA=="}], "type": "inlineReview"}, {"oid": "ae94c47533b0f41ccd7818f935d646fa9926bb0d", "url": "https://github.com/wso2/carbon-apimgt/commit/ae94c47533b0f41ccd7818f935d646fa9926bb0d", "message": "refractor code", "committedDate": "2020-07-22T12:21:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MTgwOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458751808", "bodyText": "Since this is a lable, shall we change the debug message to the label. Also can we just print the environment? This is the environment object?", "author": "1akshitha", "createdAt": "2020-07-22T12:24:16Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIGatewayManager.java", "diffHunk": "@@ -679,6 +695,9 @@ private void addEndpoints(API api, APITemplateBuilder builder, GatewayAPIDTO gat\n         if (api.getGatewayLabels() != null) {\n             for (Label label : api.getGatewayLabels()) {\n                 Environment environment = getEnvironmentFromLabel(label);\n+                if (debugEnabled) {\n+                    log.debug(api.getId() + \"removing from the environment of \" + environment);", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NjIyMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458756223", "bodyText": "Also, you might need to add a space between apiID and debug message.", "author": "1akshitha", "createdAt": "2020-07-22T12:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MTgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDYyNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458764624", "bodyText": "29a2e4b", "author": "Sarangan0219", "createdAt": "2020-07-22T12:46:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MTgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MjI0Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458752247", "bodyText": "you can't print the environment object. Print the environment name from the for loop.", "author": "1akshitha", "createdAt": "2020-07-22T12:25:03Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIGatewayManager.java", "diffHunk": "@@ -671,6 +684,9 @@ private void addEndpoints(API api, APITemplateBuilder builder, GatewayAPIDTO gat\n                 if (environment == null) {\n                     continue;\n                 }\n+                if (debugEnabled) {\n+                    log.debug(api.getId() + \"removing from the environment of \" + environment);", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDU2OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458764569", "bodyText": "29a2e4b", "author": "Sarangan0219", "createdAt": "2020-07-22T12:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MjI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1Mzc0NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458753745", "bodyText": "We can't print the environment object. Print the environment name", "author": "1akshitha", "createdAt": "2020-07-22T12:27:41Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIGatewayManager.java", "diffHunk": "@@ -137,6 +137,9 @@ public synchronized static APIGatewayManager getInstance() {\n                 if (environment == null) {\n                     continue;\n                 }\n+                if (debugEnabled) {\n+                    log.debug(api.getId() + \"publishing to the environment of \" + environment);", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDU0Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458764543", "bodyText": "29a2e4b", "author": "Sarangan0219", "createdAt": "2020-07-22T12:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1Mzc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NDA5Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458754097", "bodyText": "Since this is a label, change the debug message to label. Change the environment object to environment name", "author": "1akshitha", "createdAt": "2020-07-22T12:28:21Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIGatewayManager.java", "diffHunk": "@@ -145,6 +148,9 @@ public synchronized static APIGatewayManager getInstance() {\n         if (api.getGatewayLabels() != null) {\n             for (Label label : api.getGatewayLabels()) {\n                 Environment environment = getEnvironmentFromLabel(label);\n+                if (debugEnabled) {\n+                    log.debug(api.getId() + \" publishing to the environment of \" + environment);", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDUxMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458764513", "bodyText": "29a2e4b", "author": "Sarangan0219", "createdAt": "2020-07-22T12:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NDA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NTIxNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458755216", "bodyText": "Shall we handle this before?  in handleNotificationMessage method?", "author": "1akshitha", "createdAt": "2020-07-22T12:30:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayJMSMessageListener.java", "diffHunk": "@@ -93,12 +98,13 @@ public void onMessage(Message message) {\n             } else {\n                 log.warn(\"Dropping the empty/null event received through jms receiver\");\n             }\n-        } catch (JMSException e) {\n+        } catch (JMSException | ArtifactSynchronizerException e) {", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2MjA5OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458762098", "bodyText": "Yes we are handling https://github.com/wso2/carbon-apimgt/pull/9019/files#diff-838be8956ccd306ac34942d1c83642fcR106", "author": "Sarangan0219", "createdAt": "2020-07-22T12:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwMzk0OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458803948", "bodyText": "Since this method is shared by lot of other features, better to capture the ArtifactSynchronizerException in previous method.", "author": "1akshitha", "createdAt": "2020-07-22T13:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NTIxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NjM2Nw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458756367", "bodyText": "add a space after api id", "author": "1akshitha", "createdAt": "2020-07-22T12:32:14Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIGatewayManager.java", "diffHunk": "@@ -730,6 +749,9 @@ private void addEndpoints(API api, APITemplateBuilder builder, GatewayAPIDTO gat\n                 artifactSaver.saveArtifact(new Gson().toJson(gatewayAPIDTO), environment.getName(),\n                         APIConstants.GatewayArtifactSynchronizer.GATEWAY_INSTRUCTION_REMOVE);\n                 removedGateways.add(environment.getName());\n+                if (debugEnabled) {\n+                    log.debug(\"Status of \" + api.getId() + \"has been updated to DB\");", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDM4NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458764385", "bodyText": "0c06b11", "author": "Sarangan0219", "createdAt": "2020-07-22T12:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NjM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1Njc0MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458756740", "bodyText": "Typo and add a space", "author": "1akshitha", "createdAt": "2020-07-22T12:32:54Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -589,7 +590,16 @@ public static CloseableHttpResponse executeHTTPRequest(HttpRequestBase method, H\n                 }\n             }\n         } while (retry);\n-        return httpResponse;\n+\n+        if (httpResponse.getStatusLine().getStatusCode() == 200) {\n+            return httpResponse;\n+        } else {\n+            httpResponse.close();\n+            String errorMessage = EntityUtils.toString(httpResponse.getEntity(),\n+                    APIConstants.DigestAuthConstants.CHARSET);\n+            throw new ArtifactSynchronizerException(errorMessage + \"Eevnthub status code is:\"", "originalCommit": "e9ae44f6923017fe021caa8f14a9e08034111fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2MzM1OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458763358", "bodyText": "29a2e4b", "author": "Sarangan0219", "createdAt": "2020-07-22T12:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1Njc0MA=="}], "type": "inlineReview"}, {"oid": "29a2e4bba591e33476f9fcce64bd8668945123c4", "url": "https://github.com/wso2/carbon-apimgt/commit/29a2e4bba591e33476f9fcce64bd8668945123c4", "message": "Refractor code", "committedDate": "2020-07-22T12:42:59Z", "type": "commit"}, {"oid": "0c06b11bd310c530687fc3d64bf68b9097a1201d", "url": "https://github.com/wso2/carbon-apimgt/commit/0c06b11bd310c530687fc3d64bf68b9097a1201d", "message": "Refractor code", "committedDate": "2020-07-22T12:45:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwMzIzNA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458803234", "bodyText": "Without throwing this exception from here, shall we add a try catch block and capture the exception inside this method", "author": "1akshitha", "createdAt": "2020-07-22T13:45:33Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayJMSMessageListener.java", "diffHunk": "@@ -93,12 +98,13 @@ public void onMessage(Message message) {\n             } else {\n                 log.warn(\"Dropping the empty/null event received through jms receiver\");\n             }\n-        } catch (JMSException e) {\n+        } catch (JMSException | ArtifactSynchronizerException e) {\n             log.error(\"JMSException occurred when processing the received message \", e);\n         }\n     }\n \n-    private void handleNotificationMessage(String eventType, long timestamp, String encodedEvent) {\n+    private void handleNotificationMessage(String eventType, long timestamp, String encodedEvent)\n+            throws ArtifactSynchronizerException {", "originalCommit": "0c06b11bd310c530687fc3d64bf68b9097a1201d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNDM4MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458834380", "bodyText": "6b56e3e", "author": "Sarangan0219", "createdAt": "2020-07-22T14:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwMzIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwNDkzMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458804932", "bodyText": "Change the debug message to API with api ID is publishing to gateway with label", "author": "1akshitha", "createdAt": "2020-07-22T13:47:57Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIGatewayManager.java", "diffHunk": "@@ -145,6 +149,10 @@ public synchronized static APIGatewayManager getInstance() {\n         if (api.getGatewayLabels() != null) {\n             for (Label label : api.getGatewayLabels()) {\n                 Environment environment = getEnvironmentFromLabel(label);\n+                if (debugEnabled) {\n+                    log.debug(\"API with \" + api.getId() + \" and label \" + label + \" is publishing to the \"", "originalCommit": "0c06b11bd310c530687fc3d64bf68b9097a1201d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNDM0MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458834341", "bodyText": "6b56e3e", "author": "Sarangan0219", "createdAt": "2020-07-22T14:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwNDkzMg=="}], "type": "inlineReview"}, {"oid": "6b56e3e82804d8002c3efac4f6c5e1de4286823d", "url": "https://github.com/wso2/carbon-apimgt/commit/6b56e3e82804d8002c3efac4f6c5e1de4286823d", "message": "Refractor code", "committedDate": "2020-07-22T14:26:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNzU0NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458837545", "bodyText": "removing?", "author": "1akshitha", "createdAt": "2020-07-22T14:31:48Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIGatewayManager.java", "diffHunk": "@@ -137,6 +137,10 @@ public synchronized static APIGatewayManager getInstance() {\n                 if (environment == null) {\n                     continue;\n                 }\n+                if (debugEnabled) {\n+                    log.debug(\"API with \" + api.getId() + \" is removing from the environment of \"", "originalCommit": "6b56e3e82804d8002c3efac4f6c5e1de4286823d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0MDc0Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r458840743", "bodyText": "33db9c9", "author": "Sarangan0219", "createdAt": "2020-07-22T14:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNzU0NQ=="}], "type": "inlineReview"}, {"oid": "33db9c95aae321571063de252285271a8381ca02", "url": "https://github.com/wso2/carbon-apimgt/commit/33db9c95aae321571063de252285271a8381ca02", "message": "Refractor code", "committedDate": "2020-07-22T14:35:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg5OTQzOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r495899439", "bodyText": "Better if we can check whether debug is enabled before logging this.", "author": "isuruh15", "createdAt": "2020-09-28T12:27:15Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/InMemoryAPIDeployer.java", "diffHunk": "@@ -200,16 +236,22 @@ public GatewayAPIDTO getAPIArtifact(String apiId, String gatewayLabel) {\n      *@param tenantDomain - Tenant Domain of the API\n      * @return Map that contains the UUID and label of the API\n      */\n-    public Map <String, String> getGatewayAPIAttributes(String apiName, String version, String tenantDomain) {\n+    public Map <String, String> getGatewayAPIAttributes(String apiName, String version, String tenantDomain)\n+            throws  ArtifactSynchronizerException {\n         Map<String, String> apiAttributes = null;\n         if (artifactRetriever != null) {\n             try {\n                 apiAttributes = artifactRetriever.retrieveAttributes(apiName, version, tenantDomain);\n+                log.debug(\"API Attributes retrieved for \" + apiName + \"  from storage\");", "originalCommit": "33db9c95aae321571063de252285271a8381ca02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEzNTgwMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9019#discussion_r552135802", "bodyText": "Fixed #9546", "author": "Sarangan0219", "createdAt": "2021-01-05T19:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg5OTQzOQ=="}], "type": "inlineReview"}]}