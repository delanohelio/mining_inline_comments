{"pr_number": 8824, "pr_title": "GraphQL Query Complexity Analysis & Fix Generate API Key UI issue", "pr_createdAt": "2020-06-24T12:36:59Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8824", "timeline": [{"oid": "ac3c45cd46455eba64077015c31fa48d8f5f1d3a", "url": "https://github.com/wso2/carbon-apimgt/commit/ac3c45cd46455eba64077015c31fa48d8f5f1d3a", "message": "modify GraphQLQueryAnalysisHandler", "committedDate": "2020-06-14T08:20:53Z", "type": "commit"}, {"oid": "1bd7f23711da267e7b9535d7bfb49b3ca893aa25", "url": "https://github.com/wso2/carbon-apimgt/commit/1bd7f23711da267e7b9535d7bfb49b3ca893aa25", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt into test1", "committedDate": "2020-06-14T08:26:44Z", "type": "commit"}, {"oid": "32b524cb19a5934d20921b03ca58d3fb3bfb5c86", "url": "https://github.com/wso2/carbon-apimgt/commit/32b524cb19a5934d20921b03ca58d3fb3bfb5c86", "message": "modify addSubscriptionPolicy method", "committedDate": "2020-06-15T06:13:56Z", "type": "commit"}, {"oid": "52cee1f846d8fcd6fa16f1f00e6a6dac16857084", "url": "https://github.com/wso2/carbon-apimgt/commit/52cee1f846d8fcd6fa16f1f00e6a6dac16857084", "message": "modify add custom complexity method", "committedDate": "2020-06-16T06:38:56Z", "type": "commit"}, {"oid": "edbc0d837772f4578e3661a9679c443b27bc8e55", "url": "https://github.com/wso2/carbon-apimgt/commit/edbc0d837772f4578e3661a9679c443b27bc8e55", "message": "Change of CRUD functionality of subscription policy", "committedDate": "2020-06-22T16:05:47Z", "type": "commit"}, {"oid": "37e2b7b533d73c3a7bdc68f3a15c4a45e31a7ffc", "url": "https://github.com/wso2/carbon-apimgt/commit/37e2b7b533d73c3a7bdc68f3a15c4a45e31a7ffc", "message": "Change the Query Analysis UI", "committedDate": "2020-06-24T07:02:06Z", "type": "commit"}, {"oid": "0ec065bb452ea23970c7613985d934e5e491f548", "url": "https://github.com/wso2/carbon-apimgt/commit/0ec065bb452ea23970c7613985d934e5e491f548", "message": "modify query analysis handler", "committedDate": "2020-06-24T09:50:10Z", "type": "commit"}, {"oid": "e0813dc6c78936ec5c3f1ee2b80a8fc65fe94f4d", "url": "https://github.com/wso2/carbon-apimgt/commit/e0813dc6c78936ec5c3f1ee2b80a8fc65fe94f4d", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt into test1", "committedDate": "2020-06-24T09:51:34Z", "type": "commit"}, {"oid": "5486fe337c512a521e2e2d45208921d6e4cbcdc6", "url": "https://github.com/wso2/carbon-apimgt/commit/5486fe337c512a521e2e2d45208921d6e4cbcdc6", "message": "modify AM_POLICY_SUBSCRIPTION table", "committedDate": "2020-06-24T10:41:12Z", "type": "commit"}, {"oid": "f78bf8d1f15b24a93497afbe6e5af3de7558ae2f", "url": "https://github.com/wso2/carbon-apimgt/commit/f78bf8d1f15b24a93497afbe6e5af3de7558ae2f", "message": "modify UpdateComplexity", "committedDate": "2020-06-24T11:41:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg4NjU5OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8824#discussion_r444886599", "bodyText": "same dependency added twice. Remove one.", "author": "fazlan-nazeem", "createdAt": "2020-06-24T13:19:11Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/pom.xml", "diffHunk": "@@ -299,6 +299,14 @@\n             <groupId>org.wso2.orbit.com.amazonaws</groupId>\n             <artifactId>awslambda</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>org.wso2.carbon.apimgt</groupId>\n+            <artifactId>org.wso2.carbon.apimgt.rest.api.util</artifactId>\n+        </dependency>\n+        <dependency>", "originalCommit": "f78bf8d1f15b24a93497afbe6e5af3de7558ae2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg4ODAzMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8824#discussion_r444888033", "bodyText": "don't print stacktrace.", "author": "fazlan-nazeem", "createdAt": "2020-06-24T13:21:23Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/graphQL/GraphQLQueryAnalysisHandler.java", "diffHunk": "@@ -201,17 +199,13 @@ private boolean analyseQueryComplexity(MessageContext messageContext, String pay\n                         errorList.clear();\n                         errorList.add(\"maximum query complexity exceeded\");\n                     }\n-\n                     handleFailure(APISecurityConstants.GRAPHQL_QUERY_TOO_COMPLEX, messageContext,\n                             APISecurityConstants.GRAPHQL_QUERY_TOO_COMPLEX_MESSAGE, errorList.toString());\n                     return false;\n                 }\n-                if (log.isDebugEnabled()) {\n-                    log.debug(\"Maximum query complexity was not exceeded\");\n-                }\n                 return true;\n             } catch (Exception e) {\n-                log.error(e.getMessage(), e);\n+                e.printStackTrace();", "originalCommit": "f78bf8d1f15b24a93497afbe6e5af3de7558ae2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5NDI0MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8824#discussion_r444894241", "bodyText": "remove newline", "author": "fazlan-nazeem", "createdAt": "2020-06-24T13:30:24Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -14490,6 +14423,34 @@ public void updateComplexityDetails(APIIdentifier apiIdentifier, GraphqlComplexi\n     }\n \n \n+    /**\n+     * Add or Update complexity details\n+     *\n+     * @param apiIdentifier         APIIdentifier object to retrieve API ID\n+     * @param graphqlComplexityInfo GraphqlComplexityDetails object\n+     * @throws APIManagementException\n+     */\n+    public void addOrUpdateComplexityDetails(APIIdentifier apiIdentifier, GraphqlComplexityInfo graphqlComplexityInfo)\n+            throws APIManagementException {\n+        String getCustomComplexityDetailsQuery = SQLConstants.GET_CUSTOM_COMPLEXITY_DETAILS_SQL;\n+        try (Connection conn = APIMgtDBUtil.getConnection();\n+             PreparedStatement getCustomComplexityDetails = conn.prepareStatement(getCustomComplexityDetailsQuery)) {\n+            int apiId = getAPIID(apiIdentifier, conn);\n+            getCustomComplexityDetails.setInt(1, apiId);\n+            try (ResultSet rs1 = getCustomComplexityDetails.executeQuery()) {\n+                if (rs1.next()) {\n+                    updateComplexityDetails(apiIdentifier, graphqlComplexityInfo);\n+                } else {\n+                    addComplexityDetails(apiIdentifier, graphqlComplexityInfo);\n+                }\n+", "originalCommit": "f78bf8d1f15b24a93497afbe6e5af3de7558ae2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5NDkzMw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8824#discussion_r444894933", "bodyText": "formatting issue", "author": "fazlan-nazeem", "createdAt": "2020-06-24T13:31:25Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/test/resources/dbscripts/h2.sql", "diffHunk": "@@ -1559,19 +1559,13 @@ CREATE TABLE IF NOT EXISTS AM_POLICY_SUBSCRIPTION (\n             BILLING_CYCLE VARCHAR(15),\n             PRICE_PER_REQUEST VARCHAR(15),\n             CURRENCY VARCHAR(15),\n+\t    MAX_COMPLEXITY INT(11),", "originalCommit": "f78bf8d1f15b24a93497afbe6e5af3de7558ae2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5NTMwMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8824#discussion_r444895300", "bodyText": "formatting issue", "author": "fazlan-nazeem", "createdAt": "2020-06-24T13:31:55Z", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/throttling/SubscriptionThrottlePolicyMappingUtil.java", "diffHunk": "@@ -123,8 +123,12 @@ public static SubscriptionPolicy fromSubscriptionThrottlePolicyDTOToModel(Subscr\n         subscriptionPolicy.setRateLimitTimeUnit(dto.getRateLimitTimeUnit());\n         subscriptionPolicy.setRateLimitCount(dto.getRateLimitCount());\n         subscriptionPolicy.setStopOnQuotaReach(dto.isStopOnQuotaReach());\n-        subscriptionPolicy.setGraphQLMaxComplexity(dto.getGraphQLMaxComplexity());\n-        subscriptionPolicy.setGraphQLMaxDepth(dto.getGraphQLMaxDepth());\n+        if(dto.getGraphQLMaxComplexity() != null){", "originalCommit": "f78bf8d1f15b24a93497afbe6e5af3de7558ae2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d5ee84cfc9f51af5e494932fc5b2fbc5efc00502", "url": "https://github.com/wso2/carbon-apimgt/commit/d5ee84cfc9f51af5e494932fc5b2fbc5efc00502", "message": "fixed comments", "committedDate": "2020-06-24T14:06:20Z", "type": "commit"}]}