{"pr_number": 9511, "pr_title": "Adding revision-deploy and revision-deployment mapping implementation", "pr_createdAt": "2020-12-15T10:38:17Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9511", "timeline": [{"oid": "551e8005cf73bc23547da10360e07c23ca635342", "url": "https://github.com/wso2/carbon-apimgt/commit/551e8005cf73bc23547da10360e07c23ca635342", "message": "adding revision-deploy and revision-deployment mapping implementation", "committedDate": "2020-12-15T10:28:38Z", "type": "commit"}, {"oid": "a9ed9f2065b948c187b1d854505ef37d2d21090b", "url": "https://github.com/wso2/carbon-apimgt/commit/a9ed9f2065b948c187b1d854505ef37d2d21090b", "message": "adding undeploy-revision and removing deploy from api save/publish path", "committedDate": "2020-12-17T02:51:51Z", "type": "commit"}, {"oid": "5bbffed5bbad4f92929957983063633875daaee7", "url": "https://github.com/wso2/carbon-apimgt/commit/5bbffed5bbad4f92929957983063633875daaee7", "message": "adding revision id to API get response", "committedDate": "2020-12-17T04:04:02Z", "type": "commit"}, {"oid": "5bbffed5bbad4f92929957983063633875daaee7", "url": "https://github.com/wso2/carbon-apimgt/commit/5bbffed5bbad4f92929957983063633875daaee7", "message": "adding revision id to API get response", "committedDate": "2020-12-17T04:04:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMDY0Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545530646", "bodyText": "Is this line formatted?", "author": "chamilaadhi", "createdAt": "2020-12-18T02:22:57Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -9090,4 +8976,86 @@ protected String createAPIRevisionRegistryArtifacts(String apiUUID, int revision\n     public List<APIRevision> getAPIRevisions(String apiUUID) throws APIManagementException {\n         return apiMgtDAO.getRevisionsListByAPIUUID(apiUUID);\n     }\n+\n+    /**\n+     * Adds a new APIRevisionDeployment to an existing API\n+     *\n+     * @param apiId API UUID\n+     * @param apiRevisionId API Revision UUID\n+     * @param apiRevisionDeployments List of APIRevisionDeployment objects\n+     * @throws APIManagementException if failed to add APIRevision\n+     */\n+    @Override\n+    public void addAPIRevisionDeployment(String apiId, String apiRevisionId, List<APIRevisionDeployment> apiRevisionDeployments) throws APIManagementException {", "originalCommit": "5bbffed5bbad4f92929957983063633875daaee7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU3MDQ4MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545570481", "bodyText": "resolved", "author": "CrowleyRajapakse", "createdAt": "2020-12-18T04:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMDY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMTIyNQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545531225", "bodyText": "lets put a if check here to check for swagger def in the returned api obj. if definition is there, no need to get the def again.", "author": "chamilaadhi", "createdAt": "2020-12-18T02:24:52Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -9090,4 +8976,86 @@ protected String createAPIRevisionRegistryArtifacts(String apiUUID, int revision\n     public List<APIRevision> getAPIRevisions(String apiUUID) throws APIManagementException {\n         return apiMgtDAO.getRevisionsListByAPIUUID(apiUUID);\n     }\n+\n+    /**\n+     * Adds a new APIRevisionDeployment to an existing API\n+     *\n+     * @param apiId API UUID\n+     * @param apiRevisionId API Revision UUID\n+     * @param apiRevisionDeployments List of APIRevisionDeployment objects\n+     * @throws APIManagementException if failed to add APIRevision\n+     */\n+    @Override\n+    public void addAPIRevisionDeployment(String apiId, String apiRevisionId, List<APIRevisionDeployment> apiRevisionDeployments) throws APIManagementException {\n+        APIIdentifier apiIdentifier = APIUtil.getAPIIdentifierFromUUID(apiId);\n+        if (apiIdentifier == null) {\n+            throw new APIMgtResourceNotFoundException(\"Couldn't retrieve existing API with API UUID: \"\n+                    + apiId, ExceptionCodes.from(ExceptionCodes.API_NOT_FOUND, apiId));\n+        }\n+        APIRevision apiRevision = apiMgtDAO.getRevisionByRevisionUUID(apiRevisionId);\n+        if (apiRevision == null) {\n+            throw new APIMgtResourceNotFoundException(\"Couldn't retrieve existing API Revision with Revision UUID: \"\n+                    + apiRevisionId, ExceptionCodes.from(ExceptionCodes.API_NOT_FOUND, apiRevisionId));\n+        }\n+        APITemplateBuilder builder = null;\n+        APIGatewayManager gatewayManager = APIGatewayManager.getInstance();\n+        APIIdentifier revisionApiIdentifier = getLightweightAPIByUUID(apiRevisionId, tenantDomain).getId();\n+        API api = getRevisionAPI(revisionApiIdentifier, apiRevision);\n+        api.setSwaggerDefinition(getOpenAPIDefinition(revisionApiIdentifier));", "originalCommit": "5bbffed5bbad4f92929957983063633875daaee7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU3MDYwNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545570606", "bodyText": "resolved, moved to getRevisionAPI", "author": "CrowleyRajapakse", "createdAt": "2020-12-18T04:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMTIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMTM1Ng==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545531356", "bodyText": "same here", "author": "chamilaadhi", "createdAt": "2020-12-18T02:25:12Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -9090,4 +8976,86 @@ protected String createAPIRevisionRegistryArtifacts(String apiUUID, int revision\n     public List<APIRevision> getAPIRevisions(String apiUUID) throws APIManagementException {\n         return apiMgtDAO.getRevisionsListByAPIUUID(apiUUID);\n     }\n+\n+    /**\n+     * Adds a new APIRevisionDeployment to an existing API\n+     *\n+     * @param apiId API UUID\n+     * @param apiRevisionId API Revision UUID\n+     * @param apiRevisionDeployments List of APIRevisionDeployment objects\n+     * @throws APIManagementException if failed to add APIRevision\n+     */\n+    @Override\n+    public void addAPIRevisionDeployment(String apiId, String apiRevisionId, List<APIRevisionDeployment> apiRevisionDeployments) throws APIManagementException {\n+        APIIdentifier apiIdentifier = APIUtil.getAPIIdentifierFromUUID(apiId);\n+        if (apiIdentifier == null) {\n+            throw new APIMgtResourceNotFoundException(\"Couldn't retrieve existing API with API UUID: \"\n+                    + apiId, ExceptionCodes.from(ExceptionCodes.API_NOT_FOUND, apiId));\n+        }\n+        APIRevision apiRevision = apiMgtDAO.getRevisionByRevisionUUID(apiRevisionId);\n+        if (apiRevision == null) {\n+            throw new APIMgtResourceNotFoundException(\"Couldn't retrieve existing API Revision with Revision UUID: \"\n+                    + apiRevisionId, ExceptionCodes.from(ExceptionCodes.API_NOT_FOUND, apiRevisionId));\n+        }\n+        APITemplateBuilder builder = null;\n+        APIGatewayManager gatewayManager = APIGatewayManager.getInstance();\n+        APIIdentifier revisionApiIdentifier = getLightweightAPIByUUID(apiRevisionId, tenantDomain).getId();\n+        API api = getRevisionAPI(revisionApiIdentifier, apiRevision);\n+        api.setSwaggerDefinition(getOpenAPIDefinition(revisionApiIdentifier));\n+        Set<String> environments = new HashSet<>();\n+        for (APIRevisionDeployment apiRevisionDeployment : apiRevisionDeployments) {\n+            environments.add(apiRevisionDeployment.getDeployment());\n+        }\n+        api.setEnvironments(environments);\n+        try {\n+            builder = getAPITemplateBuilder(api);\n+        } catch (Exception e) {\n+            handleException(\"Error while publishing to Gateway \", e);\n+        }\n+        Map<String, String> failedEnvironment = gatewayManager.deployAPIRevisionToGateway(api, builder, tenantDomain);\n+        apiMgtDAO.addAPIRevisionDeployment(apiRevisionId, apiRevisionDeployments);\n+    }\n+\n+    @Override\n+    public APIRevisionDeployment getAPIRevisionDeployment(String name, String type) throws APIManagementException {\n+         return apiMgtDAO.getAPIRevisionDeploymentByNameAndType(name,type);\n+    }\n+\n+    @Override\n+    public List<APIRevisionDeployment> getAPIRevisionDeploymentList(String revisionUUID) throws APIManagementException {\n+         return apiMgtDAO.getAPIRevisionDeploymentByRevisionUUID(revisionUUID);\n+    }\n+\n+    /**\n+     * Adds a new APIRevisionDeployment to an existing API\n+     *\n+     * @param apiId API UUID\n+     * @param apiRevisionId API Revision UUID\n+     * @param apiRevisionDeployments List of APIRevisionDeployment objects\n+     * @throws APIManagementException if failed to add APIRevision\n+     */\n+    @Override\n+    public void undeployAPIRevisionDeployment(String apiId, String apiRevisionId, List<APIRevisionDeployment> apiRevisionDeployments) throws APIManagementException {\n+        APIIdentifier apiIdentifier = APIUtil.getAPIIdentifierFromUUID(apiId);\n+        if (apiIdentifier == null) {\n+            throw new APIMgtResourceNotFoundException(\"Couldn't retrieve existing API with API UUID: \"\n+                    + apiId, ExceptionCodes.from(ExceptionCodes.API_NOT_FOUND, apiId));\n+        }\n+        APIRevision apiRevision = apiMgtDAO.getRevisionByRevisionUUID(apiRevisionId);\n+        if (apiRevision == null) {\n+            throw new APIMgtResourceNotFoundException(\"Couldn't retrieve existing API Revision with Revision UUID: \"\n+                    + apiRevisionId, ExceptionCodes.from(ExceptionCodes.API_NOT_FOUND, apiRevisionId));\n+        }\n+        APIGatewayManager gatewayManager = APIGatewayManager.getInstance();\n+        APIIdentifier revisionApiIdentifier = getLightweightAPIByUUID(apiRevisionId, tenantDomain).getId();\n+        API api = getRevisionAPI(revisionApiIdentifier, apiRevision);\n+        api.setSwaggerDefinition(getOpenAPIDefinition(revisionApiIdentifier));", "originalCommit": "5bbffed5bbad4f92929957983063633875daaee7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU3MDYyOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545570629", "bodyText": "resolved, moved to getRevisionAPI", "author": "CrowleyRajapakse", "createdAt": "2020-12-18T04:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMTM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMTY4OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545531688", "bodyText": "lets populate the swagger def from here . this would prevent unnecessary calls", "author": "chamilaadhi", "createdAt": "2020-12-18T02:26:06Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/AbstractAPIManager.java", "diffHunk": "@@ -462,6 +462,55 @@ public API getAPI(APIIdentifier identifier) throws APIManagementException {\n         }\n     }\n \n+    public API getRevisionAPI(APIIdentifier identifier, APIRevision apiRevision) throws APIManagementException {\n+        String apiPath = APIUtil.getRevisionPath(apiRevision.getApiUUID(),apiRevision.getId()) + APIConstants.API_KEY;\n+        Registry registry;\n+        try {\n+            String apiTenantDomain = getTenantDomain(identifier);\n+            int apiTenantId = getTenantManager()\n+                    .getTenantId(apiTenantDomain);\n+            if (!MultitenantConstants.SUPER_TENANT_DOMAIN_NAME.equals(apiTenantDomain)) {\n+                APIUtil.loadTenantRegistry(apiTenantId);\n+            }\n+\n+            if (this.tenantDomain == null || !this.tenantDomain.equals(apiTenantDomain)) { //cross tenant scenario\n+                registry = getRegistryService().getGovernanceUserRegistry(\n+                        getTenantAwareUsername(APIUtil.replaceEmailDomainBack(identifier.getProviderName())), apiTenantId);\n+            } else {\n+                registry = this.registry;\n+            }\n+            GenericArtifactManager artifactManager = getAPIGenericArtifactManagerFromUtil(registry,\n+                    APIConstants.API_KEY);\n+            Resource apiResource = registry.get(apiPath);\n+            String artifactId = apiResource.getUUID();\n+            if (artifactId == null) {\n+                throw new APIManagementException(\"artifact id is null for : \" + apiPath);\n+            }\n+            GenericArtifact apiArtifact = artifactManager.getGenericArtifact(artifactId);\n+\n+            API api = APIUtil.getAPIForPublishing(apiArtifact, registry);\n+            APIUtil.updateAPIProductDependencies(api, registry);\n+\n+            //check for API visibility\n+            if (APIConstants.API_GLOBAL_VISIBILITY.equals(api.getVisibility())) { //global api\n+                return api;\n+            }\n+            if (this.tenantDomain == null || !this.tenantDomain.equals(apiTenantDomain)) {\n+                throw new APIManagementException(\"User \" + username + \" does not have permission to view API : \"\n+                        + api.getId().getApiName());\n+            }\n+", "originalCommit": "5bbffed5bbad4f92929957983063633875daaee7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU3MDY5NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9511#discussion_r545570695", "bodyText": "resolved", "author": "CrowleyRajapakse", "createdAt": "2020-12-18T04:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUzMTY4OA=="}], "type": "inlineReview"}, {"oid": "6322b22be4e8263b6f664f25f0179a1dea59755a", "url": "https://github.com/wso2/carbon-apimgt/commit/6322b22be4e8263b6f664f25f0179a1dea59755a", "message": "adding requested changes", "committedDate": "2020-12-18T04:46:10Z", "type": "commit"}, {"oid": "6322b22be4e8263b6f664f25f0179a1dea59755a", "url": "https://github.com/wso2/carbon-apimgt/commit/6322b22be4e8263b6f664f25f0179a1dea59755a", "message": "adding requested changes", "committedDate": "2020-12-18T04:46:10Z", "type": "forcePushed"}]}