{"pr_number": 9391, "pr_title": "Add ISKM Reverse Proxy Support", "pr_createdAt": "2020-11-16T03:49:47Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9391", "timeline": [{"oid": "b868167f42c7eb1c5d25aa8ce7402087d27bb7f9", "url": "https://github.com/wso2/carbon-apimgt/commit/b868167f42c7eb1c5d25aa8ce7402087d27bb7f9", "message": "Introduce ISKMReverseProxyEnabled property to api-manager.xml.j2", "committedDate": "2020-11-12T15:47:48Z", "type": "commit"}, {"oid": "e76e35daa37c4844a1203e09afef8b7eda58e061", "url": "https://github.com/wso2/carbon-apimgt/commit/e76e35daa37c4844a1203e09afef8b7eda58e061", "message": "Add iskm reverse proxy support", "committedDate": "2020-11-12T15:47:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY2NDA0MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r554664041", "bodyText": "Shall we use StringUtils.isNotEmpty() here, instead of checking null and empty separately?", "author": "vithu30", "createdAt": "2021-01-11T02:33:29Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/SynapsePropertiesHandler.java", "diffHunk": "@@ -46,6 +55,13 @@ public boolean handleRequest(MessageContext messageContext) {\n         boolean isContentTypeNotSet = false;\n         if (headers != null) {\n             isContentTypeNotSet = headers.get(\"Content-Type\") == null || headers.get(\"Content-Type\").equals(\"\");\n+            if (headers.get(APIMgtGatewayConstants.HOST) != null || !(\"\")", "originalCommit": "e76e35daa37c4844a1203e09afef8b7eda58e061", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjcwODgyOA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r572708828", "bodyText": "Fixed by 65d2992", "author": "hisanhunais", "createdAt": "2021-02-09T09:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY2NDA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY2NDM4Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r554664383", "bodyText": "Shall we change it as constant.equals(variable) instead of variable.equals(constant)?", "author": "vithu30", "createdAt": "2021-01-11T02:35:21Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/SynapsePropertiesHandler.java", "diffHunk": "@@ -61,6 +77,62 @@ public boolean handleRequest(MessageContext messageContext) {\n     }\n \n     public boolean handleResponse(MessageContext messageContext) {\n+        if (config == null) {\n+            // Retrieve the ISKMReverseProxyEnabled property value from api manager configurations.\n+            // This value indicates whether the IS Authentication endpoint has been reverse proxied through\n+            // the Gateway.\n+            config = ServiceReferenceHolder.getInstance().getApiManagerConfigurationService()\n+                    .getAPIManagerConfiguration();\n+            iskmReverseProxyEnabled = Boolean.parseBoolean(\n+                    config.getFirstProperty(APIConstants.AUTH_MANAGER + APIConstants.IS_KM_REVERSE_PROXY_ENABLED));\n+        }\n+        // Modify location header only if ISKMReverseProxyEnabled property is set to true\n+        if (iskmReverseProxyEnabled) {\n+            // The logic is related if the API context is \"/authorize\", \"/commonauth\" or \"/oidc\" while status code is 302\n+            if (messageContext.getProperty(RESTConstants.REST_API_CONTEXT)", "originalCommit": "e76e35daa37c4844a1203e09afef8b7eda58e061", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjcwOTMyMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r572709320", "bodyText": "Fixed by 6861d44", "author": "hisanhunais", "createdAt": "2021-02-09T09:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY2NDM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTgyMDI2MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r571820260", "bodyText": "same here.swap the condition check. Eg: APIMgtGatewayConstants.COMMON_AUTH_CONTEXT.equals(messageContext\n.getProperty(RESTConstants.REST_API_CONTEXT))", "author": "HiranyaKavishani", "createdAt": "2021-02-08T07:09:58Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/SynapsePropertiesHandler.java", "diffHunk": "@@ -61,6 +77,62 @@ public boolean handleRequest(MessageContext messageContext) {\n     }\n \n     public boolean handleResponse(MessageContext messageContext) {\n+        if (config == null) {\n+            // Retrieve the ISKMReverseProxyEnabled property value from api manager configurations.\n+            // This value indicates whether the IS Authentication endpoint has been reverse proxied through\n+            // the Gateway.\n+            config = ServiceReferenceHolder.getInstance().getApiManagerConfigurationService()\n+                    .getAPIManagerConfiguration();\n+            iskmReverseProxyEnabled = Boolean.parseBoolean(\n+                    config.getFirstProperty(APIConstants.AUTH_MANAGER + APIConstants.IS_KM_REVERSE_PROXY_ENABLED));\n+        }\n+        // Modify location header only if ISKMReverseProxyEnabled property is set to true\n+        if (iskmReverseProxyEnabled) {\n+            // The logic is related if the API context is \"/authorize\", \"/commonauth\" or \"/oidc\" while status code is 302\n+            if (messageContext.getProperty(RESTConstants.REST_API_CONTEXT)\n+                    .equals(APIMgtGatewayConstants.AUTHORIZE_CONTEXT) || messageContext\n+                    .getProperty(RESTConstants.REST_API_CONTEXT).equals(APIMgtGatewayConstants.COMMON_AUTH_CONTEXT)", "originalCommit": "e76e35daa37c4844a1203e09afef8b7eda58e061", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjcwOTQzNg==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r572709436", "bodyText": "Fixed by 6861d44", "author": "hisanhunais", "createdAt": "2021-02-09T09:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTgyMDI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTgyMDYwMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r571820600", "bodyText": "same here", "author": "HiranyaKavishani", "createdAt": "2021-02-08T07:10:55Z", "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/common/SynapsePropertiesHandler.java", "diffHunk": "@@ -61,6 +77,62 @@ public boolean handleRequest(MessageContext messageContext) {\n     }\n \n     public boolean handleResponse(MessageContext messageContext) {\n+        if (config == null) {\n+            // Retrieve the ISKMReverseProxyEnabled property value from api manager configurations.\n+            // This value indicates whether the IS Authentication endpoint has been reverse proxied through\n+            // the Gateway.\n+            config = ServiceReferenceHolder.getInstance().getApiManagerConfigurationService()\n+                    .getAPIManagerConfiguration();\n+            iskmReverseProxyEnabled = Boolean.parseBoolean(\n+                    config.getFirstProperty(APIConstants.AUTH_MANAGER + APIConstants.IS_KM_REVERSE_PROXY_ENABLED));\n+        }\n+        // Modify location header only if ISKMReverseProxyEnabled property is set to true\n+        if (iskmReverseProxyEnabled) {\n+            // The logic is related if the API context is \"/authorize\", \"/commonauth\" or \"/oidc\" while status code is 302\n+            if (messageContext.getProperty(RESTConstants.REST_API_CONTEXT)\n+                    .equals(APIMgtGatewayConstants.AUTHORIZE_CONTEXT) || messageContext\n+                    .getProperty(RESTConstants.REST_API_CONTEXT).equals(APIMgtGatewayConstants.COMMON_AUTH_CONTEXT)\n+                    || messageContext.getProperty(RESTConstants.REST_API_CONTEXT)\n+                    .equals(APIMgtGatewayConstants.OIDC_CONTEXT)) {\n+                if (302 == (Integer) ((Axis2MessageContext) messageContext).getAxis2MessageContext()\n+                        .getProperty(SynapseConstants.HTTP_SC)) {\n+                    // Retrieve the transport headers in the response and identify the location header\n+                    TreeMap<String, String> headers = (TreeMap) ((Axis2MessageContext) messageContext)\n+                            .getAxis2MessageContext().getProperty(APIMgtGatewayConstants.TRANSPORT_HEADERS);\n+                    String locationURI = headers.get(APIMgtGatewayConstants.LOCATION);\n+                    // KM host and port which is included in the location header value\n+                    String kmHost = messageContext.getProperty(\"keyManager.hostname\") + \":\" + messageContext\n+                            .getProperty(\"keyManager.port\");\n+                    String hostHeader = (String) messageContext.getProperty(APIMgtGatewayConstants.HOST_HEADER);\n+\n+                    // This check to change the location header is done to make sure that only location headers of the\n+                    // appropriate endpoints which have been proxied are changed. Without this check condition to change\n+                    // the location header, any endpoint which is having KM host as part of the URL will be redirected\n+                    // which could lead to wrong endpoints.\n+                    if (locationURI.contains(APIMgtGatewayConstants.AUTHENTICATION_ENDPOINT_CONTEXT) || locationURI\n+                            .contains(APIMgtGatewayConstants.OAUTH2_CONTEXT + APIMgtGatewayConstants.AUTHORIZE_CONTEXT)\n+                            || locationURI.contains(APIMgtGatewayConstants.COMMON_AUTH_CONTEXT) || locationURI\n+                            .contains(APIMgtGatewayConstants.LOGIN_CONTEXT) || locationURI\n+                            .contains(APIMgtGatewayConstants.OIDC_CONTEXT)) {\n+                        // Replacing KM host with Gateway host\n+                        locationURI = locationURI.replaceFirst(kmHost, hostHeader);\n+                    }\n+\n+                    ((Axis2MessageContext) messageContext).getAxis2MessageContext()\n+                            .setProperty(\"PRE_LOCATION_HEADER\", locationURI);\n+                    if (messageContext.getProperty(RESTConstants.REST_API_CONTEXT)", "originalCommit": "e76e35daa37c4844a1203e09afef8b7eda58e061", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjcwOTU5MQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9391#discussion_r572709591", "bodyText": "Fixed by 6861d44", "author": "hisanhunais", "createdAt": "2021-02-09T09:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTgyMDYwMA=="}], "type": "inlineReview"}]}