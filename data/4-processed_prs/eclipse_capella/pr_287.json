{"pr_number": 287, "pr_title": "[558032] Add Title Block content sanitization", "pr_createdAt": "2020-06-29T11:43:31Z", "pr_url": "https://github.com/eclipse/capella/pull/287", "timeline": [{"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a", "url": "https://github.com/eclipse/capella/commit/c0615934c7dedc142547b511c8e00e083ab29b2a", "message": "[558032] Add Title Block content sanitization\n\n- Sanitize title block content in order to avoid adding invalid semantic\nreferences to external resources in the .aird\n\n- Fix Title Block Cell content display for Collections of primitive data\n-- Only the last element in the collection was displayed\n\nBug: 558032\nChange-Id: Ifb5e9efa69479ebe8b58a2b34ed6fccf65387ea0\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>", "committedDate": "2020-06-29T11:38:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzOTQ0Mw==", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447039443", "bodyText": "Could you extract this code into a separate method (e.g. isViewpointElement)?", "author": "minhtutonthat", "createdAt": "2020-06-29T15:01:58Z", "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();", "originalCommit": "c0615934c7dedc142547b511c8e00e083ab29b2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1OTM3NQ==", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447059375", "bodyText": "Done", "author": "sandupostaru", "createdAt": "2020-06-29T15:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzOTQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MDE3OA==", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447040178", "bodyText": "Could you move this to a separated helper class?", "author": "minhtutonthat", "createdAt": "2020-06-29T15:03:00Z", "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();\n+      return getViewpointPackages().contains(ePackage);\n+    }\n+\n+    return true;\n+  }\n+\n+  private static Object sanitizeResultItem(Object resultItem) {\n+    if (isValidResultItem(resultItem)) {\n+      return resultItem;\n+    }\n+\n+    String sanitizedText = EObjectLabelProviderHelper.getText(resultItem);\n+\n+    if (sanitizedText != null && !sanitizedText.isEmpty()) {\n+      return sanitizedText;\n+    }\n+\n+    return resultItem != null ? resultItem.toString() : \"\";\n+  }\n+\n+  private static Object sanitizeResultItems(Collection<?> originalResult) {\n+    return originalResult.stream().map(TitleBlockHelper::sanitizeResultItem).collect(Collectors.toList());\n+  }\n+\n+  private static Set<EPackage> getViewpointPackages() {", "originalCommit": "c0615934c7dedc142547b511c8e00e083ab29b2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1OTUzNA==", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447059534", "bodyText": "Done", "author": "sandupostaru", "createdAt": "2020-06-29T15:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MDE3OA=="}], "type": "inlineReview"}, {"oid": "adea727822c4796b2c7eaf2c71a7988011258031", "url": "https://github.com/eclipse/capella/commit/adea727822c4796b2c7eaf2c71a7988011258031", "message": "Review comments\n\nChange-Id: I31179669ceccfd0c4aeb3c79c722d8f3b4bbcd74", "committedDate": "2020-06-29T15:28:08Z", "type": "commit"}]}