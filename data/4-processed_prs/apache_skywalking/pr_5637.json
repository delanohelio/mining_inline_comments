{"pr_number": 5637, "pr_title": "Health check for InfluxDB", "pr_createdAt": "2020-10-09T09:58:42Z", "pr_url": "https://github.com/apache/skywalking/pull/5637", "timeline": [{"oid": "a24fe8c17d19e0236c5ddfdc5e92f3c4d918be45", "url": "https://github.com/apache/skywalking/commit/a24fe8c17d19e0236c5ddfdc5e92f3c4d918be45", "message": "Add InfluxDB health check", "committedDate": "2020-10-09T09:48:05Z", "type": "commit"}, {"oid": "6e55b75c472169938663c16055f8f93af2635476", "url": "https://github.com/apache/skywalking/commit/6e55b75c472169938663c16055f8f93af2635476", "message": "remove unusable code", "committedDate": "2020-10-09T09:56:02Z", "type": "commit"}, {"oid": "7dfce9d3a4e3c4bbfc0a6583fcf209805806553f", "url": "https://github.com/apache/skywalking/commit/7dfce9d3a4e3c4bbfc0a6583fcf209805806553f", "message": "Fix checkstyle issue", "committedDate": "2020-10-09T10:15:52Z", "type": "commit"}, {"oid": "29502c550077ee33def24ecfaf2ad38471a1cd20", "url": "https://github.com/apache/skywalking/commit/29502c550077ee33def24ecfaf2ad38471a1cd20", "message": "Merge branch 'master' into health-check-influxdb", "committedDate": "2020-10-09T10:27:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5OTMyOA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502499328", "bodyText": "Grammar related exceptions seem unhealth to me. @hanahmily What do you think?", "author": "wu-sheng", "createdAt": "2020-10-09T15:12:46Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception\n+     */\n+    private void checkHealth(Throwable e) {\n+        if (e instanceof InfluxDBIOException) {\n+            healthChecker.unHealth(e);\n+        } else if (!(e instanceof InfluxDBException)) {\n+            healthChecker.unHealth(e);\n+        }", "originalCommit": "29502c550077ee33def24ecfaf2ad38471a1cd20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0NDA0NA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502744044", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-10T04:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5OTMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502506536", "bodyText": "The test of result.hasError is dropped. Maybe some errors are ignored. Pls double check whether it leaves out them.", "author": "hanahmily", "createdAt": "2020-10-09T15:24:15Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -101,11 +113,10 @@ private InfluxDB getInflux() {\n \n         try {\n             QueryResult result = getInflux().query(new Query(query.getCommand()));\n-            if (result.hasError()) {\n-                throw new IOException(result.getError());\n-            }\n+            healthChecker.health();", "originalCommit": "29502c550077ee33def24ecfaf2ad38471a1cd20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0Mzc4Ng==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502743786", "bodyText": "I have checked the source code of influx client,\nwhen some errors happens it will throw an exception, no need to check the hasError method", "author": "xbkaishui", "createdAt": "2020-10-10T04:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg4ODg1MQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502888851", "bodyText": "@dmsolr Could you confirm the status? Is there some case there could be some errors w/o exception?", "author": "wu-sheng", "createdAt": "2020-10-11T09:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5ODU0MQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503198541", "bodyText": "hi @xbkaishui\nI had test some cases. The result show following\n\nsyntax error/parse error, connection, etc will throw an exception.\naggregate function error maybe doesn't throw.\n\nFor example:\n\ncase 1\n\nQuery: SELECT mean(\"square\"),\"round\" FROM \"peg\"\nResponse: QueryResult [results=[Result [series=null, error=mixing aggregate and non-aggregate queries is not supported]], error=null]\n\n\ncase 2\n\nQuery: SELECT sum(\"square\", 2),\"round\" FROM \"peg\"\n\nResponse: [results=[Result [series=null, error=invalid number of arguments for mean, expected 1, got 2]], error=null]\n\nThese two examples put error messages in clauses only. :(", "author": "dmsolr", "createdAt": "2020-10-12T10:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIwMTU4NQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503201585", "bodyText": "I am not sure that is wrong what I did before. But we need to consider this scenario, right?", "author": "dmsolr", "createdAt": "2020-10-12T10:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3MjUxMQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503272511", "bodyText": "Nop, for below sql , in the java client it will throws an exception.  did you use the java client to test ?", "author": "xbkaishui", "createdAt": "2020-10-12T12:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjA4NA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503276084", "bodyText": "please check me test code gist", "author": "xbkaishui", "createdAt": "2020-10-12T12:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NjY3NA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503276674", "bodyText": "@xbkaishui I am curious if all things go through exception, why InfluxDB Java client designs that API? In case the exception has been caught?", "author": "wu-sheng", "createdAt": "2020-10-12T12:55:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4MDgxOA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503280818", "bodyText": "from what I test, the error msg is wrapper as an exception in java client", "author": "xbkaishui", "createdAt": "2020-10-12T13:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4MTAxMw==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503281013", "bodyText": "Maybe other client has different implement.", "author": "xbkaishui", "createdAt": "2020-10-12T13:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI4MjA4MQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503282081", "bodyText": "from what I test, the error msg is wrapper as an exception in java client\n\nOK, if so, that we may be able to remove the codes. But in another hand, to do the check seems harmless :)", "author": "wu-sheng", "createdAt": "2020-10-12T13:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQxNzI0MQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503417241", "bodyText": "I've read your code. I think have some issue.\npublic static void main(String[] args) {\n    final InfluxDB influxDB = InfluxDBFactory.connect(\"http://127.0.0.1:8086\");\n    String databaseName = \"NOAA_water_database\";\n    try {\n        QueryResult result = influxDB.query(new Query(\"SELECT sum(\\\"square\\\", 2),\\\"round\\\" FROM \\\"peg\\\"\\n\" +\n                                                          \";\" + databaseName)); // There is syntax issue, so InfluxDB Client throws an exception. You don't need to append `+ \";\" + databaseName`.\n        String error = result.getError();\n        System.out.println(error);\n        influxDB.setDatabase(databaseName);\n    } catch (Throwable e) {\n        e.printStackTrace();\n    }\n}\nYou could try the following code.\ntry {\n    influxDB.setDatabase(databaseName);\n    QueryResult result = influxDB.query(new Query(\"SELECT sum(\\\"square\\\", 2),\\\"round\\\" FROM \\\"peg\\\"\\n\"));\n    result.hasError(); // it is false.\n    result.getError(); // null\n\n    result.getResults().forEach(series -> {\n        series.hasError(); // it is true\n        series.getError(); // error message\n    });\n} catch (Throwable e) {\n    e.printStackTrace();\n}", "author": "dmsolr", "createdAt": "2020-10-12T16:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMTkyMg==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503421922", "bodyText": "Syntax errors can be detected by the client, so the exception is thrown directly.\nSome errors, like aggregate function wrong, do not throw the exception.", "author": "dmsolr", "createdAt": "2020-10-12T16:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5ODQ0NQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503598445", "bodyText": "Syntax errors can be detected by the client, so the exception is thrown directly.\nSome errors, like aggregate function wrong, do not throw the exception.\n\nbut for the aggregate function, the hasError return false, it will not throws an exception using the orginal code, so the check error logic is take no effect  right ?", "author": "xbkaishui", "createdAt": "2020-10-13T00:12:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5OTI1MQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503599251", "bodyText": "I will revert my changes. thanks", "author": "xbkaishui", "createdAt": "2020-10-13T00:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwMTEyOA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503601128", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-10-13T00:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYyNDE0Mw==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503624143", "bodyText": "but for the aggregate function, the hasError return false, it will not throws an exception using the orginal code, so the check error logic is take no effect right ?\n\nIt is basically right. Would you like to fix it in this PR?", "author": "dmsolr", "createdAt": "2020-10-13T02:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYzMzAzOA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503633038", "bodyText": "Do you mean also check the child resuts error ?", "author": "xbkaishui", "createdAt": "2020-10-13T02:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjg0OA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502506848", "bodyText": "Ditto", "author": "hanahmily", "createdAt": "2020-10-09T15:24:47Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -161,11 +172,7 @@ public int getCounter(Query query) throws IOException {\n      */\n     public void dropSeries(String measurement, long timeBucket) throws IOException {\n         Query query = new Query(\"DROP SERIES FROM \" + measurement + \" WHERE time_bucket='\" + timeBucket + \"'\");\n-        QueryResult result = getInflux().query(query);\n-\n-        if (result.hasError()) {\n-            throw new IOException(\"Statement: \" + query.getCommand() + \", ErrorMsg: \" + result.getError());\n-        }\n+        this.query(query);", "originalCommit": "29502c550077ee33def24ecfaf2ad38471a1cd20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0NDA2OQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502744069", "bodyText": "Same comment as above", "author": "xbkaishui", "createdAt": "2020-10-10T04:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwMTMxOQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r503601319", "bodyText": "Done, this.query already checked the hasError logic, no need to check again", "author": "xbkaishui", "createdAt": "2020-10-13T00:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwNjg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwODgzNQ==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502508835", "bodyText": "Why do you ignore grammar relevant errors? They would indicate the version mismatches between OAP and influxdb server.", "author": "hanahmily", "createdAt": "2020-10-09T15:27:45Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/InfluxClient.java", "diffHunk": "@@ -205,4 +230,20 @@ public static TimeInterval timeIntervalTS(long timestamp) {\n     public static TimeInterval timeIntervalTB(long timeBucket) {\n         return ti(TimeBucket.getTimestamp(timeBucket), \"ms\");\n     }\n+\n+    @Override\n+    public void registerChecker(HealthChecker healthChecker) {\n+        this.healthChecker.register(healthChecker);\n+    }\n+\n+    /**\n+     * Check influx health, Ignore grammar related exception", "originalCommit": "29502c550077ee33def24ecfaf2ad38471a1cd20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MzgyMA==", "url": "https://github.com/apache/skywalking/pull/5637#discussion_r502743820", "bodyText": "ok will change", "author": "xbkaishui", "createdAt": "2020-10-10T04:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUwODgzNQ=="}], "type": "inlineReview"}, {"oid": "b41cac5800d61e0f369a03c769ec49aa9bf50483", "url": "https://github.com/apache/skywalking/commit/b41cac5800d61e0f369a03c769ec49aa9bf50483", "message": "Remove check grammar of client exception", "committedDate": "2020-10-10T04:22:08Z", "type": "commit"}, {"oid": "ece3f3e414c393145583cb7abb6d36348bb84a2a", "url": "https://github.com/apache/skywalking/commit/ece3f3e414c393145583cb7abb6d36348bb84a2a", "message": "Merge branch 'master' into health-check-influxdb", "committedDate": "2020-10-10T08:49:06Z", "type": "commit"}, {"oid": "b9a0c7326703ed262492d8ea0d14beec344d777b", "url": "https://github.com/apache/skywalking/commit/b9a0c7326703ed262492d8ea0d14beec344d777b", "message": "Merge branch 'master' into health-check-influxdb", "committedDate": "2020-10-11T09:47:11Z", "type": "commit"}, {"oid": "964a1718acf4308683f34f8c391e5d4ad24e3708", "url": "https://github.com/apache/skywalking/commit/964a1718acf4308683f34f8c391e5d4ad24e3708", "message": "Revert change, add error check for query result", "committedDate": "2020-10-13T00:22:00Z", "type": "commit"}, {"oid": "35e35780733a6d1fe7cec26a292952151bdebcbd", "url": "https://github.com/apache/skywalking/commit/35e35780733a6d1fe7cec26a292952151bdebcbd", "message": "Merge branch 'master' into health-check-influxdb", "committedDate": "2020-10-13T04:03:49Z", "type": "commit"}]}