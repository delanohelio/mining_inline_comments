{"pr_number": 4758, "pr_title": "Format index name with namespace", "pr_createdAt": "2020-05-08T08:12:22Z", "pr_url": "https://github.com/apache/skywalking/pull/4758", "timeline": [{"oid": "0a03794486e9117f39292c5718a1f9aff0895649", "url": "https://github.com/apache/skywalking/commit/0a03794486e9117f39292c5718a1f9aff0895649", "message": "Format index name with namespace\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-05-08T08:04:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxOTg0Ng==", "url": "https://github.com/apache/skywalking/pull/4758#discussion_r422019846", "bodyText": "client.createIndex already calls formatIndexName internally, I think you may need to formatIndexName before checking if (!leftIndices.contains(latestIndex)) and use the original one in client.createIndex, am I right?", "author": "kezhenxu94", "createdAt": "2020-05-08T08:35:54Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/base/HistoryDeleteEsDAO.java", "diffHunk": "@@ -66,7 +66,7 @@ public void deleteHistory(Model model, String timeBucketColumnName, int ttl) thr\n         for (String prepareDeleteIndex : prepareDeleteIndexes) {\n             client.deleteByIndexName(prepareDeleteIndex);\n         }\n-        String latestIndex = TimeSeriesUtils.latestWriteIndexName(model);\n+        String latestIndex = client.formatIndexName(TimeSeriesUtils.latestWriteIndexName(model));\n         if (!leftIndices.contains(latestIndex)) {\n             client.createIndex(latestIndex);\n         }", "originalCommit": "0a03794486e9117f39292c5718a1f9aff0895649", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMDE0OQ==", "url": "https://github.com/apache/skywalking/pull/4758#discussion_r422020149", "bodyText": "client.createIndex already calls formatIndexName internally, I think you may need to formatIndexName before checking if (!leftIndices.contains(latestIndex)) and use the original one in client.createIndex, am I right?\n\nOtherwise, the namespace with be prepended twice, perhaps", "author": "kezhenxu94", "createdAt": "2020-05-08T08:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxOTg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1MjMwMQ==", "url": "https://github.com/apache/skywalking/pull/4758#discussion_r422052301", "bodyText": "latestIndex variable should be used in contains check only, createIndex should use the unformatted name like the old codes.", "author": "wu-sheng", "createdAt": "2020-05-08T09:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxOTg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1NTY4Mg==", "url": "https://github.com/apache/skywalking/pull/4758#discussion_r422055682", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-05-08T09:56:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxOTg0Ng=="}], "type": "inlineReview"}, {"oid": "5bc7db7d5388699cfa9aa01e0bd9900fe9dc5ed9", "url": "https://github.com/apache/skywalking/commit/5bc7db7d5388699cfa9aa01e0bd9900fe9dc5ed9", "message": "Use another variable to compare index name\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-05-08T09:55:37Z", "type": "commit"}, {"oid": "e7d0e51692e0585710d3a5c4c8ed0d1c8caf8ac4", "url": "https://github.com/apache/skywalking/commit/e7d0e51692e0585710d3a5c4c8ed0d1c8caf8ac4", "message": "Merge branch 'master' into bug-ttl-es", "committedDate": "2020-05-08T10:45:41Z", "type": "commit"}]}