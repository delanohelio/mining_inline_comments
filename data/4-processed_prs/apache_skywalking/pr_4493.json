{"pr_number": 4493, "pr_title": "Support Secrets Management File in the ElasticSearch 6/7 storage", "pr_createdAt": "2020-03-11T08:47:34Z", "pr_url": "https://github.com/apache/skywalking/pull/4493", "timeline": [{"oid": "157149317871a73e876ea50445f77cb4b7c37a56", "url": "https://github.com/apache/skywalking/commit/157149317871a73e876ea50445f77cb4b7c37a56", "message": "Temp commit", "committedDate": "2020-03-11T05:47:17Z", "type": "commit"}, {"oid": "b8127f8c8748d977e4a9714b537a43850190f47b", "url": "https://github.com/apache/skywalking/commit/b8127f8c8748d977e4a9714b537a43850190f47b", "message": "Support secretsManagementFile file.", "committedDate": "2020-03-11T08:43:20Z", "type": "commit"}, {"oid": "e5ba4a6a313751ea6a3858eb2a33334e2e365709", "url": "https://github.com/apache/skywalking/commit/e5ba4a6a313751ea6a3858eb2a33334e2e365709", "message": "Update doc.", "committedDate": "2020-03-11T08:49:45Z", "type": "commit"}, {"oid": "2806553017a8a3607a4e35a15c75ba9b3a547596", "url": "https://github.com/apache/skywalking/commit/2806553017a8a3607a4e35a15c75ba9b3a547596", "message": "Merge branch 'master' into vault-support", "committedDate": "2020-03-11T09:35:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3NzcyNw==", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390877727", "bodyText": "Make elasticSearchClient volatile?", "author": "kezhenxu94", "createdAt": "2020-03-11T10:33:17Z", "path": "oap-server/server-storage-plugin/storage-elasticsearch-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/elasticsearch/StorageModuleElasticsearchProvider.java", "diffHunk": "@@ -117,6 +120,31 @@ public void prepare() throws ServiceNotProvidedException {\n         if (config.getDayStep() > 1) {\n             TimeSeriesUtils.setDAY_STEP(config.getDayStep());\n         }\n+\n+        if (!StringUtil.isEmpty(config.getSecretsManagementFile())) {\n+            MultipleFilesChangeMonitor monitor = new MultipleFilesChangeMonitor(\n+                10, readableContents -> {\n+                    final byte[] secretsFileContent = readableContents.get(0);\n+                    if (secretsFileContent == null) {\n+                        return;\n+                    }\n+                    Properties userAndPass = new Properties();\n+                    userAndPass.load(new ByteArrayInputStream(secretsFileContent));\n+                    config.setUser(userAndPass.getProperty(\"user\"));\n+                    config.setPassword(userAndPass.getProperty(\"password\"));\n+\n+                    if (elasticSearchClient == null) {\n+                        //In the startup process, we just need to change the username/password", "originalCommit": "2806553017a8a3607a4e35a15c75ba9b3a547596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg4MDQyOQ==", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390880429", "bodyText": "Was thinking about this. But not sure. Does across Thread cache will keep forever? Because we are not sensitive this changed immediately, several seconds later is fine.\nWhat do you think about this?", "author": "wu-sheng", "createdAt": "2020-03-11T10:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3NzcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk3NzgyNw==", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390977827", "bodyText": "Added.", "author": "wu-sheng", "createdAt": "2020-03-11T13:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3NzcyNw=="}], "type": "inlineReview"}, {"oid": "d840b3384923907bfd145ee316e4a0e7c9191beb", "url": "https://github.com/apache/skywalking/commit/d840b3384923907bfd145ee316e4a0e7c9191beb", "message": "Merge branch 'master' into vault-support", "committedDate": "2020-03-11T11:25:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1OTEzMA==", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390959130", "bodyText": "Same thread visibility problem for client, if the monitor thread failed to detect the client is initialized below(in line 129), the client is not closed and left open forever", "author": "kezhenxu94", "createdAt": "2020-03-11T13:13:00Z", "path": "oap-server/server-library/library-client/src/main/java/org/apache/skywalking/oap/server/library/client/elasticsearch/ElasticSearchClient.java", "diffHunk": "@@ -119,6 +119,13 @@ public ElasticSearchClient(String clusterNodes,\n     @Override\n     public void connect() throws IOException, KeyStoreException, NoSuchAlgorithmException, KeyManagementException, CertificateException {\n         List<HttpHost> hosts = parseClusterNodes(protocol, clusterNodes);\n+        if (client != null) {\n+            try {\n+                client.close();\n+            } catch (Throwable t) {\n+                log.error(\"ElasticSearch client reconnection fails based on new config\", t);\n+            }\n+        }", "originalCommit": "d840b3384923907bfd145ee316e4a0e7c9191beb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2NDg2NQ==", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r390964865", "bodyText": "Good point.", "author": "wu-sheng", "createdAt": "2020-03-11T13:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk1OTEzMA=="}], "type": "inlineReview"}, {"oid": "160d845cc26c9625f6639c9616e8ed005d13495d", "url": "https://github.com/apache/skywalking/commit/160d845cc26c9625f6639c9616e8ed005d13495d", "message": "1. Support JKS/pass runtime change too.\n2. Follow review.", "committedDate": "2020-03-11T13:41:33Z", "type": "commit"}, {"oid": "20f756bd01ce36ef5035c98323c57d20b424eb58", "url": "https://github.com/apache/skywalking/commit/20f756bd01ce36ef5035c98323c57d20b424eb58", "message": "Fix format.", "committedDate": "2020-03-11T13:47:16Z", "type": "commit"}, {"oid": "66a69eadb8f9b1ebfc7913404471c304dcbd0a56", "url": "https://github.com/apache/skywalking/commit/66a69eadb8f9b1ebfc7913404471c304dcbd0a56", "message": "Fix username/password/trustPass haven't been updated in the es client.", "committedDate": "2020-03-12T00:49:18Z", "type": "commit"}, {"oid": "b08bf83e6002b16e6008d87b6b76ec07e0653d2e", "url": "https://github.com/apache/skywalking/commit/b08bf83e6002b16e6008d87b6b76ec07e0653d2e", "message": "Merge branch 'master' into vault-support", "committedDate": "2020-03-12T02:33:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4NzEwMg==", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r392087102", "bodyText": "typo duplicated with this file is?", "author": "JaredTan95", "createdAt": "2020-03-13T08:26:29Z", "path": "docs/en/setup/backend/backend-storage.md", "diffHunk": "@@ -124,6 +126,20 @@ Such as, if dayStep == 11,\n \n NOTICE, TTL deletion would be affected by these. You should set an extra more dayStep in your TTL. Such as you want to TTL == 30 days and dayStep == 10, you actually need to set TTL = 40;\n \n+### Secrets Management File Of ElasticSearch Authentication\n+The value of `secretsManagementFile` should point to the secrets management file absolute path. \n+The file includes username, password and JKS password of ElasticSearch server in the properties format.\n+```properties\n+user=xxx\n+password=yyy\n+trustStorePass=zzz\n+```\n+\n+The major difference between using `user, password, trustStorePass` configs in the `application.yaml` and this file is, this file is being watched by the OAP server. ", "originalCommit": "b08bf83e6002b16e6008d87b6b76ec07e0653d2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwMTE0Nw==", "url": "https://github.com/apache/skywalking/pull/4493#discussion_r392101147", "bodyText": "Yes. And fixed.", "author": "wu-sheng", "createdAt": "2020-03-13T08:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4NzEwMg=="}], "type": "inlineReview"}, {"oid": "1e5b173af83d341dd72201fcff32167faf8036a1", "url": "https://github.com/apache/skywalking/commit/1e5b173af83d341dd72201fcff32167faf8036a1", "message": "Merge branch 'master' into vault-support", "committedDate": "2020-03-13T08:28:21Z", "type": "commit"}, {"oid": "5cac4e51f7f122965c622777ffc5275b3f04ac2d", "url": "https://github.com/apache/skywalking/commit/5cac4e51f7f122965c622777ffc5275b3f04ac2d", "message": "Fix doc issue.", "committedDate": "2020-03-13T08:57:57Z", "type": "commit"}, {"oid": "f7b500a7a9caea2f7bc82503117db3714f622b97", "url": "https://github.com/apache/skywalking/commit/f7b500a7a9caea2f7bc82503117db3714f622b97", "message": "Merge branch 'master' into vault-support", "committedDate": "2020-03-13T12:04:41Z", "type": "commit"}]}