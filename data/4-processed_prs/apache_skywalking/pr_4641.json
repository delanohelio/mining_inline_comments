{"pr_number": 4641, "pr_title": "Upgrade the InfluxDB storage-plugin to protocol V3", "pr_createdAt": "2020-04-12T18:10:12Z", "pr_url": "https://github.com/apache/skywalking/pull/4641", "timeline": [{"oid": "0811091359e621924e2b7133a2e07579ab472e55", "url": "https://github.com/apache/skywalking/commit/0811091359e621924e2b7133a2e07579ab472e55", "message": "revert @Column", "committedDate": "2020-04-14T08:49:34Z", "type": "commit"}, {"oid": "0811091359e621924e2b7133a2e07579ab472e55", "url": "https://github.com/apache/skywalking/commit/0811091359e621924e2b7133a2e07579ab472e55", "message": "revert @Column", "committedDate": "2020-04-14T08:49:34Z", "type": "forcePushed"}, {"oid": "edc80a11139d6febfcea3a57feee8a14c57b0737", "url": "https://github.com/apache/skywalking/commit/edc80a11139d6febfcea3a57feee8a14c57b0737", "message": "Merge branch 'master' into v8/influxdb", "committedDate": "2020-04-14T08:55:53Z", "type": "commit"}, {"oid": "160ab950fc420dd63a57efb11356b97b5bb341b4", "url": "https://github.com/apache/skywalking/commit/160ab950fc420dd63a57efb11356b97b5bb341b4", "message": "fix checkstyle", "committedDate": "2020-04-14T09:08:44Z", "type": "commit"}, {"oid": "2f8a2318000957b797186cdb0e5bde156e01b626", "url": "https://github.com/apache/skywalking/commit/2f8a2318000957b797186cdb0e5bde156e01b626", "message": "add influxdb to e2e test", "committedDate": "2020-04-15T07:41:51Z", "type": "commit"}, {"oid": "799c83c7c1b49666390fad076c2c6313a9e7fd56", "url": "https://github.com/apache/skywalking/commit/799c83c7c1b49666390fad076c2c6313a9e7fd56", "message": "Merge branch 'master' into v8/influxdb", "committedDate": "2020-04-15T08:23:22Z", "type": "commit"}, {"oid": "dde4f2dc9be8f3ac9f8fcb2d67300cd5dcf22026", "url": "https://github.com/apache/skywalking/commit/dde4f2dc9be8f3ac9f8fcb2d67300cd5dcf22026", "message": "fix traffic", "committedDate": "2020-04-15T17:34:33Z", "type": "commit"}, {"oid": "807183185c87ba109d015d19df563380912aab59", "url": "https://github.com/apache/skywalking/commit/807183185c87ba109d015d19df563380912aab59", "message": "Merge branch 'v8/influxdb' of https://github.com/dmsolr/skywalking into v8/influxdb", "committedDate": "2020-04-15T17:55:57Z", "type": "commit"}, {"oid": "50ba299e19cccc3682085aa038404869baf37595", "url": "https://github.com/apache/skywalking/commit/50ba299e19cccc3682085aa038404869baf37595", "message": "checkstyle", "committedDate": "2020-04-16T03:49:18Z", "type": "commit"}, {"oid": "85edf0013942d2756be0bac34e532f401e7a3c95", "url": "https://github.com/apache/skywalking/commit/85edf0013942d2756be0bac34e532f401e7a3c95", "message": "fix e2e configuration", "committedDate": "2020-04-16T04:15:44Z", "type": "commit"}, {"oid": "d582213a48089105e49b8a8c57ec294778228de8", "url": "https://github.com/apache/skywalking/commit/d582213a48089105e49b8a8c57ec294778228de8", "message": "Merge branch 'master' into v8/influxdb", "committedDate": "2020-04-16T05:19:20Z", "type": "commit"}, {"oid": "b7f2f2d9f4a490c7536ad241326551dbd67da0d7", "url": "https://github.com/apache/skywalking/commit/b7f2f2d9f4a490c7536ad241326551dbd67da0d7", "message": "fix e2e configuration", "committedDate": "2020-04-16T07:46:14Z", "type": "commit"}, {"oid": "61f813f81b193641cf31e96c8022120067b17cfe", "url": "https://github.com/apache/skywalking/commit/61f813f81b193641cf31e96c8022120067b17cfe", "message": "fix query issue", "committedDate": "2020-04-17T07:52:20Z", "type": "commit"}, {"oid": "f4b3b5185b20aabeeef9bacaa405a370aafcf3a9", "url": "https://github.com/apache/skywalking/commit/f4b3b5185b20aabeeef9bacaa405a370aafcf3a9", "message": "update", "committedDate": "2020-04-17T08:28:58Z", "type": "commit"}, {"oid": "ef1ce7d737a69dce5fce102202aa658add5dbd7a", "url": "https://github.com/apache/skywalking/commit/ef1ce7d737a69dce5fce102202aa658add5dbd7a", "message": "checkstyleg", "committedDate": "2020-04-17T08:47:12Z", "type": "commit"}, {"oid": "580327243345785bc28c82c505f06a7b79f0d431", "url": "https://github.com/apache/skywalking/commit/580327243345785bc28c82c505f06a7b79f0d431", "message": "polish", "committedDate": "2020-04-17T10:33:23Z", "type": "commit"}, {"oid": "8765d92bfe151ec3b45f60a55635ee5bc159b467", "url": "https://github.com/apache/skywalking/commit/8765d92bfe151ec3b45f60a55635ee5bc159b467", "message": "checkstyle", "committedDate": "2020-04-17T11:16:11Z", "type": "commit"}, {"oid": "5b9976979f9b8e915b34eb7237de8a397bb16026", "url": "https://github.com/apache/skywalking/commit/5b9976979f9b8e915b34eb7237de8a397bb16026", "message": "remove TAG_SERVER_ID", "committedDate": "2020-04-17T15:29:34Z", "type": "commit"}, {"oid": "f3f50b1699c86698343520262747011a754d4be4", "url": "https://github.com/apache/skywalking/commit/f3f50b1699c86698343520262747011a754d4be4", "message": "remove TAG_SERVER_ID", "committedDate": "2020-04-17T15:54:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMTYzMA==", "url": "https://github.com/apache/skywalking/pull/4641#discussion_r410331630", "bodyText": "I think we need to use InstanceTraffic#INDEX_NAME and EndpointTraffic#INDEX_NAME in there.", "author": "mrproliu", "createdAt": "2020-04-17T16:23:08Z", "path": "oap-server/server-storage-plugin/storage-influxdb-plugin/src/main/java/org/apache/skywalking/oap/server/storage/plugin/influxdb/TableMetaInfo.java", "diffHunk": "@@ -18,18 +18,80 @@\n \n package org.apache.skywalking.oap.server.storage.plugin.influxdb;\n \n+import com.google.common.collect.Maps;\n import java.util.HashMap;\n+import java.util.List;\n import java.util.Map;\n+import lombok.AllArgsConstructor;\n+import lombok.Builder;\n+import lombok.Getter;\n+import org.apache.skywalking.oap.server.core.analysis.manual.endpoint.EndpointTraffic;\n+import org.apache.skywalking.oap.server.core.analysis.manual.instance.InstanceTraffic;\n+import org.apache.skywalking.oap.server.core.analysis.manual.segment.SegmentRecord;\n+import org.apache.skywalking.oap.server.core.analysis.manual.service.ServiceTraffic;\n+import org.apache.skywalking.oap.server.core.analysis.metrics.Metrics;\n+import org.apache.skywalking.oap.server.core.analysis.record.Record;\n+import org.apache.skywalking.oap.server.core.storage.model.ColumnName;\n import org.apache.skywalking.oap.server.core.storage.model.Model;\n+import org.apache.skywalking.oap.server.core.storage.model.ModelColumn;\n \n+@Getter\n+@Builder\n+@AllArgsConstructor\n public class TableMetaInfo {\n-    private static Map<String, Model> TABLES = new HashMap<>();\n+    private static final Map<String, TableMetaInfo> TABLES = new HashMap<>();\n+\n+    private Map<String, String> storageAndColumnMap;\n+    private Map<String, String> storageAndTagMap;\n+    private Model model;\n \n     public static void addModel(Model model) {\n-        TABLES.put(model.getName(), model);\n+        final List<ModelColumn> columns = model.getColumns();\n+        final Map<String, String> storageAndTagMap = Maps.newHashMap();\n+        final Map<String, String> storageAndColumnMap = Maps.newHashMap();\n+        columns.forEach(column -> {\n+            ColumnName columnName = column.getColumnName();\n+            storageAndColumnMap.put(columnName.getStorageName(), columnName.getName());\n+        });\n+\n+        if (model.getName().endsWith(\"_traffic\")) {\n+            // instance_traffic name, service_id\n+            // endpoint_traffic name, service_id\n+            storageAndTagMap.put(InstanceTraffic.NAME, InfluxConstants.TagName.NAME);\n+            if (\"instance_traffic\".equals(model.getName())\n+                || \"endpoint_traffic\".equals(model.getName())) {", "originalCommit": "f3f50b1699c86698343520262747011a754d4be4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "17dff41463f2efb3e7625ab534331a9b16262dfc", "url": "https://github.com/apache/skywalking/commit/17dff41463f2efb3e7625ab534331a9b16262dfc", "message": "Revert unnecessary changes", "committedDate": "2020-04-18T04:29:16Z", "type": "commit"}, {"oid": "060ab3de09bb5e732608c14b49f0ee4eb58422eb", "url": "https://github.com/apache/skywalking/commit/060ab3de09bb5e732608c14b49f0ee4eb58422eb", "message": "remove image on Test finished", "committedDate": "2020-04-18T10:34:58Z", "type": "commit"}, {"oid": "316fcbcfb9faf94da99f8fbc50dcbdc1cf195e44", "url": "https://github.com/apache/skywalking/commit/316fcbcfb9faf94da99f8fbc50dcbdc1cf195e44", "message": "polish", "committedDate": "2020-04-18T10:36:20Z", "type": "commit"}, {"oid": "c77f8e52e6e4e03dfa10f3a401935718ff04ee7c", "url": "https://github.com/apache/skywalking/commit/c77f8e52e6e4e03dfa10f3a401935718ff04ee7c", "message": "remove workspace of testscase", "committedDate": "2020-04-18T13:46:19Z", "type": "commit"}, {"oid": "813cfde137772235bc20ea78ed6a49948458ff38", "url": "https://github.com/apache/skywalking/commit/813cfde137772235bc20ea78ed6a49948458ff38", "message": "update logs when failed", "committedDate": "2020-04-18T15:45:12Z", "type": "commit"}, {"oid": "0e85466fafc6f03cceb410c38ded042fd7a7cef3", "url": "https://github.com/apache/skywalking/commit/0e85466fafc6f03cceb410c38ded042fd7a7cef3", "message": "move mysql to test.3.yaml", "committedDate": "2020-04-18T17:02:19Z", "type": "commit"}, {"oid": "6ee0f4c28ec05bb2a5d060549f108840229f80b1", "url": "https://github.com/apache/skywalking/commit/6ee0f4c28ec05bb2a5d060549f108840229f80b1", "message": "test mysql-scenario", "committedDate": "2020-04-18T17:52:45Z", "type": "commit"}, {"oid": "88e245bf35f917c3d3e2732eebae9c3b18b00978", "url": "https://github.com/apache/skywalking/commit/88e245bf35f917c3d3e2732eebae9c3b18b00978", "message": "revert", "committedDate": "2020-04-18T18:05:39Z", "type": "commit"}, {"oid": "a2ea5245ec924401e6b0f57ad43006c06265771e", "url": "https://github.com/apache/skywalking/commit/a2ea5245ec924401e6b0f57ad43006c06265771e", "message": "delete some versions of mysql temporarily", "committedDate": "2020-04-18T18:44:54Z", "type": "commit"}, {"oid": "4b2342f8f5d22bea721670c0ee1a479743c43b3e", "url": "https://github.com/apache/skywalking/commit/4b2342f8f5d22bea721670c0ee1a479743c43b3e", "message": "Merge branch 'master' into v8/influxdb", "committedDate": "2020-04-19T08:54:40Z", "type": "commit"}, {"oid": "365b7bb401afd21cb184f95fc371ed619e573e7b", "url": "https://github.com/apache/skywalking/commit/365b7bb401afd21cb184f95fc371ed619e573e7b", "message": "fix encode", "committedDate": "2020-04-19T11:15:02Z", "type": "commit"}]}