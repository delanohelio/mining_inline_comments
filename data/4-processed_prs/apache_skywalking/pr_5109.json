{"pr_number": 5109, "pr_title": "Fix issue 4965", "pr_createdAt": "2020-07-16T12:39:13Z", "pr_url": "https://github.com/apache/skywalking/pull/5109", "timeline": [{"oid": "4fd03b431469a61af2dc647c8f782cd81265efbf", "url": "https://github.com/apache/skywalking/commit/4fd03b431469a61af2dc647c8f782cd81265efbf", "message": "fix issue 4986", "committedDate": "2020-07-16T12:26:59Z", "type": "commit"}, {"oid": "c8647a013e2efc9e083c817bc1efa36024de9b05", "url": "https://github.com/apache/skywalking/commit/c8647a013e2efc9e083c817bc1efa36024de9b05", "message": "modify mysql test", "committedDate": "2020-07-16T12:49:33Z", "type": "commit"}, {"oid": "e7e72d937b769f40e50ec644a210bc497f2204f9", "url": "https://github.com/apache/skywalking/commit/e7e72d937b769f40e50ec644a210bc497f2204f9", "message": "Merge branch 'master' into fix-issue-4986", "committedDate": "2020-07-16T13:39:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzMzc4OA==", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456133788", "bodyText": "Don't add the issue link, unless it is a very special thing.", "author": "wu-sheng", "createdAt": "2020-07-16T23:29:40Z", "path": "apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java", "diffHunk": "@@ -40,15 +40,14 @@\n     public final void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n                                    Class<?>[] argumentsTypes, MethodInterceptResult result) {\n         StatementEnhanceInfos cacheObject = (StatementEnhanceInfos) objInst.getSkyWalkingDynamicField();\n-        ConnectionInfo connectInfo = cacheObject.getConnectionInfo();\n         /**\n          * For avoid NPE. In this particular case, Execute sql inside the {@link com.mysql.jdbc.ConnectionImpl} constructor,\n          * before the interceptor sets the connectionInfo.\n-         *\n+         * Fixed https://github.com/apache/skywalking/issues/4965. When invoking prepareCall, cacheObject is null. Because it will determine procedures's parameter types by querying the table of proc in mysql.", "originalCommit": "e7e72d937b769f40e50ec644a210bc497f2204f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzNDUxNA==", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456134514", "bodyText": "About #prepareCall, why cacheObject should be null? I prefer you should fix this NPE by having the correct ConnectionInfo rather than skipping it.", "author": "wu-sheng", "createdAt": "2020-07-16T23:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzMzc4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzNTAzNg==", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456135036", "bodyText": "You should forward the ConnectionInfo from Connection when #prepareCall called.", "author": "wu-sheng", "createdAt": "2020-07-16T23:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzMzc4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3OTYxNA==", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456179614", "bodyText": "When invoking prepareCall, it will determine procedures's parameter types by execute sql. StatementEnhanceInfos is set after prepareCall, so cacheObject is null in PreparedStatementExecuteMethodsInterceptor.beforeMethod.\nIf we don't need to record the sql which determine procedures's parameter types when invoking prepareCall, we can skip it.", "author": "Patrick0308", "createdAt": "2020-07-17T02:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEzMzc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4MTE1Mw==", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456181153", "bodyText": "According to the codes here, if cacheObject.getConnectionInfo() == null), no span will be generated. My previous question is about this, why?\nAlso, on the existing codes, the check condition is different, \n  \n    \n      skywalking/apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java\n    \n    \n         Line 75\n      in\n      e7e72d9\n    \n    \n    \n    \n\n        \n          \n           if (cacheObject.getConnectionInfo() != null) { \n        \n    \n  \n\n.\nI want to make sure what is the issue of that. Because all changes in the expectedData.yml seems not related to some parts of the change.", "author": "wu-sheng", "createdAt": "2020-07-17T02:19:27Z", "path": "apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java", "diffHunk": "@@ -40,15 +40,14 @@\n     public final void beforeMethod(EnhancedInstance objInst, Method method, Object[] allArguments,\n                                    Class<?>[] argumentsTypes, MethodInterceptResult result) {\n         StatementEnhanceInfos cacheObject = (StatementEnhanceInfos) objInst.getSkyWalkingDynamicField();\n-        ConnectionInfo connectInfo = cacheObject.getConnectionInfo();\n         /**\n          * For avoid NPE. In this particular case, Execute sql inside the {@link com.mysql.jdbc.ConnectionImpl} constructor,\n          * before the interceptor sets the connectionInfo.\n-         *\n+         * Fixed https://github.com/apache/skywalking/issues/4965. When invoking prepareCall, cacheObject is null. Because it will determine procedures's parameter types by querying the table of proc in mysql.\n          * @see JDBCDriverInterceptor#afterMethod(EnhancedInstance, Method, Object[], Class[], Object)\n          */\n-        if (connectInfo != null) {\n-\n+        if (cacheObject != null && cacheObject.getConnectionInfo() != null) {", "originalCommit": "e7e72d937b769f40e50ec644a210bc497f2204f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxMDM2Nw==", "url": "https://github.com/apache/skywalking/pull/5109#discussion_r456210367", "bodyText": "Intercepter set connectionInfo after Driver.connect. So, in the constructor of ConnectionImpl, executing built-in SQL will don't have connectionInfo.\n\n  \n    \n      skywalking/apm-sniffer/apm-sdk-plugin/mysql-common/src/main/java/org/apache/skywalking/apm/plugin/jdbc/mysql/PreparedStatementExecuteMethodsInterceptor.java\n    \n    \n         Line 44\n      in\n      e7e72d9\n    \n    \n    \n    \n\n        \n          \n                    * For avoid NPE. In this particular case, Execute sql inside the {@link com.mysql.jdbc.ConnectionImpl} constructor, \n        \n    \n  \n\n\nBoth the condition cacheObject.getConnectionInfo() != null and the condition cacheObject != null are for not log error message and skip the jdbc's built-in SQL.\nThe NPE not affect recording user's SQL.", "author": "Patrick0308", "createdAt": "2020-07-17T04:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4MTE1Mw=="}], "type": "inlineReview"}, {"oid": "a169c5dfa4192fd3910fbba3eefc736f9be68b84", "url": "https://github.com/apache/skywalking/commit/a169c5dfa4192fd3910fbba3eefc736f9be68b84", "message": "fix", "committedDate": "2020-07-17T03:53:28Z", "type": "commit"}, {"oid": "7c4e51930f69b7b7a433ee7959d2bc91e9cf4397", "url": "https://github.com/apache/skywalking/commit/7c4e51930f69b7b7a433ee7959d2bc91e9cf4397", "message": "Merge remote-tracking branch 'origin/fix-issue-4986' into fix-issue-4986", "committedDate": "2020-07-17T03:53:41Z", "type": "commit"}, {"oid": "9dd23140ab227c3ff40e8ae626e9022f0c9ae47d", "url": "https://github.com/apache/skywalking/commit/9dd23140ab227c3ff40e8ae626e9022f0c9ae47d", "message": "modify document", "committedDate": "2020-07-17T04:32:54Z", "type": "commit"}, {"oid": "ca235c738d6587dbf186a6ae12f2e57fa2fd6b31", "url": "https://github.com/apache/skywalking/commit/ca235c738d6587dbf186a6ae12f2e57fa2fd6b31", "message": "Merge branch 'master' into fix-issue-4986", "committedDate": "2020-07-17T05:02:57Z", "type": "commit"}]}