{"pr_number": 6060, "pr_title": "Support building gRPC TLS channel but CA file is not required", "pr_createdAt": "2020-12-23T01:51:23Z", "pr_url": "https://github.com/apache/skywalking/pull/6060", "timeline": [{"oid": "7aabf4b6a1ede6c62425fb25fea2646aba091fe8", "url": "https://github.com/apache/skywalking/commit/7aabf4b6a1ede6c62425fb25fea2646aba091fe8", "message": "Support building TLS grpc channel and CA file is optional", "committedDate": "2020-12-22T15:50:00Z", "type": "commit"}, {"oid": "7cfb75128d71705f27fcd1ddfe713aecc6ed00ed", "url": "https://github.com/apache/skywalking/commit/7cfb75128d71705f27fcd1ddfe713aecc6ed00ed", "message": "Support building TLS grpc channel and CA file is optional\n\nSupport building TLS grpc channel and CA file is optional", "committedDate": "2020-12-23T01:33:43Z", "type": "commit"}, {"oid": "bc2f28cb6550ade537b1a1d8757c5f4ea2602eec", "url": "https://github.com/apache/skywalking/commit/bc2f28cb6550ade537b1a1d8757c5f4ea2602eec", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T01:34:08Z", "type": "commit"}, {"oid": "440239c51ce5c20f7a7c9e9e2887c293e8a3ed34", "url": "https://github.com/apache/skywalking/commit/440239c51ce5c20f7a7c9e9e2887c293e8a3ed34", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T01:47:25Z", "type": "commit"}, {"oid": "a99dffc28b20b36cecd83c4c26886deb717322fb", "url": "https://github.com/apache/skywalking/commit/a99dffc28b20b36cecd83c4c26886deb717322fb", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T01:48:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTgxOA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547599818", "bodyText": "Change this name to FORCE_TLS. There is only gRPC transport.", "author": "wu-sheng", "createdAt": "2020-12-23T02:07:02Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java", "diffHunk": "@@ -124,6 +124,11 @@\n          * Keep tracing even the backend is not available.\n          */\n         public static boolean KEEP_TRACING = false;\n+\n+        /**\n+         * Should TLS enabled for gRPC channels\n+         */\n+        public static boolean IS_GRPC_CHANNEL_TLS_FORCED = true;", "originalCommit": "a99dffc28b20b36cecd83c4c26886deb717322fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNzgwOQ==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547607809", "bodyText": "This can't be open in default, because in many mode, the OAP is not open TLS.", "author": "wu-sheng", "createdAt": "2020-12-23T02:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYxNjExMw==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547616113", "bodyText": "Yes, I agree.", "author": "buxingzhe", "createdAt": "2020-12-23T03:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTk2Mw==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547599963", "bodyText": "Also, there is a config table in the agent setup doc, please update it too.", "author": "wu-sheng", "createdAt": "2020-12-23T02:07:50Z", "path": "docs/en/setup/service-agent/java-agent/TLS.md", "diffHunk": "@@ -19,6 +19,10 @@ Only support **no mutual auth**.\n ### Agent config\n - Place `ca.crt` into `/ca` folder in agent package. Notice, `/ca` is not created in distribution, please create it by yourself.\n \n-Agent open TLS automatically after the `/ca/ca.crt` file detected.\n+Agent will open TLS upon the following config value. If it's true, TLS will be forced to use, and TLS works by default.\n+At the same time, a trust manager will be constructed for TLS authentication once the `/ca/ca.crt` file detected.\n+```\n+agent.is_grpc_channel_tls_forced=${SW_AGENT_IS_GRPC_CHANNEL_TLS_FORCED:true}\n+```", "originalCommit": "a99dffc28b20b36cecd83c4c26886deb717322fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwOTc5Ng==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547609796", "bodyText": "What's the exact file name ?", "author": "buxingzhe", "createdAt": "2020-12-23T02:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYxMTcxNQ==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547611715", "bodyText": "This one, https://github.com/apache/skywalking/blob/master/docs/en/setup/service-agent/java-agent/README.md#table-of-agent-configuration-properties", "author": "wu-sheng", "createdAt": "2020-12-23T02:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU5OTk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwMDkxMg==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547600912", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Agent will open TLS upon the following config value. If it's true, TLS will be forced to use, and TLS works by default.\n          \n          \n            \n            At the same time, a trust manager will be constructed for TLS authentication once the `/ca/ca.crt` file detected.\n          \n          \n            \n            - Agent open TLS automatically after the `/ca/ca.crt` file detected.\n          \n          \n            \n            - TLS with no CA mode could be activated by this setting.", "author": "wu-sheng", "createdAt": "2020-12-23T02:11:45Z", "path": "docs/en/setup/service-agent/java-agent/TLS.md", "diffHunk": "@@ -19,6 +19,10 @@ Only support **no mutual auth**.\n ### Agent config\n - Place `ca.crt` into `/ca` folder in agent package. Notice, `/ca` is not created in distribution, please create it by yourself.\n \n-Agent open TLS automatically after the `/ca/ca.crt` file detected.\n+Agent will open TLS upon the following config value. If it's true, TLS will be forced to use, and TLS works by default.\n+At the same time, a trust manager will be constructed for TLS authentication once the `/ca/ca.crt` file detected.", "originalCommit": "a99dffc28b20b36cecd83c4c26886deb717322fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "60ca9818b7b5e747fb1317d04a7154cc16e2c75d", "url": "https://github.com/apache/skywalking/commit/60ca9818b7b5e747fb1317d04a7154cc16e2c75d", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:01:45Z", "type": "commit"}, {"oid": "92a87b982c45d5e3d2380d4f56a6d09ab1d058ce", "url": "https://github.com/apache/skywalking/commit/92a87b982c45d5e3d2380d4f56a6d09ab1d058ce", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:01:57Z", "type": "commit"}, {"oid": "fb21d791520bb4e47e550d16f7992d255665ab89", "url": "https://github.com/apache/skywalking/commit/fb21d791520bb4e47e550d16f7992d255665ab89", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:15:02Z", "type": "commit"}, {"oid": "c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "url": "https://github.com/apache/skywalking/commit/c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T03:15:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NTkxNg==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547785916", "bodyText": "I think if CA file exists, there is no need to change the FORCE_TLS=true manually.", "author": "wu-sheng", "createdAt": "2020-12-23T08:10:44Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/remote/TLSChannelBuilder.java", "diffHunk": "@@ -37,10 +38,12 @@\n     @Override\n     public NettyChannelBuilder build(\n         NettyChannelBuilder managedChannelBuilder) throws AgentPackageNotFoundException, SSLException {\n-        File caFile = new File(AgentPackagePath.getPath(), CA_FILE_NAME);\n-        if (caFile.exists() && caFile.isFile()) {\n+        if (Config.Agent.FORCE_TLS) {\n             SslContextBuilder builder = GrpcSslContexts.forClient();\n-            builder.trustManager(caFile);\n+            File caFile = new File(AgentPackagePath.getPath(), CA_FILE_NAME);", "originalCommit": "c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxODgwNA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547918804", "bodyText": "So either CA file exists or FORCE_TLS=true, TLS should be used?", "author": "buxingzhe", "createdAt": "2020-12-23T11:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NTkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyMzIyMA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547923220", "bodyText": "Yes, we don't have to set both 2 settings.", "author": "wu-sheng", "createdAt": "2020-12-23T11:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NTkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4OTEzNw==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547789137", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # If true, SkyWalking agent will force to build a TLS gRPC channel, and construct trust manager when file `/ca/ca.crt` exists,\n          \n          \n            \n            # otherwise a plain text gRPC channel to be built.\n          \n          \n            \n            # The agent use gRPC plain text in default.\n          \n          \n            \n            # If true, SkyWalking agent uses TLS even no CA file detect.", "author": "wu-sheng", "createdAt": "2020-12-23T08:14:28Z", "path": "apm-sniffer/config/agent.config", "diffHunk": "@@ -51,6 +51,10 @@ agent.service_name=${SW_AGENT_NAME:Your_ApplicationName}\n # Notice, in the current practice, we don't recommend the length over 190.\n # agent.operation_name_threshold=${SW_AGENT_OPERATION_NAME_THRESHOLD:150}\n \n+# If true, SkyWalking agent will force to build a TLS gRPC channel, and construct trust manager when file `/ca/ca.crt` exists,\n+# otherwise a plain text gRPC channel to be built.", "originalCommit": "c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc5MjEwMQ==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547792101", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            o make sure can't access other ports out of region (VPC), such as firewall, proxy.\n          \n      \n    \n    \n  \n\nThis seems meaningless?", "author": "wu-sheng", "createdAt": "2020-12-23T08:18:08Z", "path": "docs/en/setup/service-agent/java-agent/TLS.md", "diffHunk": "@@ -19,6 +19,10 @@ Only support **no mutual auth**.\n ### Agent config\n - Place `ca.crt` into `/ca` folder in agent package. Notice, `/ca` is not created in distribution, please create it by yourself.\n \n-Agent open TLS automatically after the `/ca/ca.crt` file detected.\n+- Agent open TLS automatically after the `/ca/ca.crt` file detected.\n+- TLS with no CA mode could be activated by this setting.\n+```\n+agent.force_tls=${SW_AGENT_FORCE_TLS:false}\n+```\n \n-o make sure can't access other ports out of region (VPC), such as firewall, proxy.\n\\ No newline at end of file\n+o make sure can't access other ports out of region (VPC), such as firewall, proxy.", "originalCommit": "c53cdb5e55d4fc7032e5d796726d0c6dec4314f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA3MA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547919070", "bodyText": "I'm OK to remove it.", "author": "buxingzhe", "createdAt": "2020-12-23T11:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc5MjEwMQ=="}], "type": "inlineReview"}, {"oid": "dcb5547ffad2ec95eafd1d081c54faea3f1ff55c", "url": "https://github.com/apache/skywalking/commit/dcb5547ffad2ec95eafd1d081c54faea3f1ff55c", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:10:25Z", "type": "commit"}, {"oid": "c1e165041a87db8d66e3cfb50707388902a3239a", "url": "https://github.com/apache/skywalking/commit/c1e165041a87db8d66e3cfb50707388902a3239a", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:10:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkzMzA2OA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547933068", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * Should TLS enabled for gRPC channels\n          \n          \n            \n                     * Force open TLS for gRPC channel if true.", "author": "wu-sheng", "createdAt": "2020-12-23T12:23:16Z", "path": "apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java", "diffHunk": "@@ -124,6 +124,11 @@\n          * Keep tracing even the backend is not available.\n          */\n         public static boolean KEEP_TRACING = false;\n+\n+        /**\n+         * Should TLS enabled for gRPC channels", "originalCommit": "c1e165041a87db8d66e3cfb50707388902a3239a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1da9270537d5856aaa4be9039e6e5dd7f3478344", "url": "https://github.com/apache/skywalking/commit/1da9270537d5856aaa4be9039e6e5dd7f3478344", "message": "Update apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/Config.java", "committedDate": "2020-12-23T12:23:21Z", "type": "commit"}, {"oid": "dd1ebb4c9910ff6232d49437ac5c28985d760d46", "url": "https://github.com/apache/skywalking/commit/dd1ebb4c9910ff6232d49437ac5c28985d760d46", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:34:27Z", "type": "commit"}, {"oid": "82362040e6c671c8520e803b1d4ed0435ce79992", "url": "https://github.com/apache/skywalking/commit/82362040e6c671c8520e803b1d4ed0435ce79992", "message": "Merge branch 'feature/tls_without_trust_manager' of https://github.com/buxingzhe/skywalking into feature/tls_without_trust_manager", "committedDate": "2020-12-23T12:34:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk0MTI2MA==", "url": "https://github.com/apache/skywalking/pull/6060#discussion_r547941260", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # If true, SkyWalking agent uses TLS even no CA file detect.\n          \n          \n            \n            # If true, SkyWalking agent uses TLS even no CA file detected.", "author": "wu-sheng", "createdAt": "2020-12-23T12:44:18Z", "path": "apm-sniffer/config/agent.config", "diffHunk": "@@ -51,6 +51,10 @@ agent.service_name=${SW_AGENT_NAME:Your_ApplicationName}\n # Notice, in the current practice, we don't recommend the length over 190.\n # agent.operation_name_threshold=${SW_AGENT_OPERATION_NAME_THRESHOLD:150}\n \n+# The agent use gRPC plain text in default.\n+# If true, SkyWalking agent uses TLS even no CA file detect.", "originalCommit": "82362040e6c671c8520e803b1d4ed0435ce79992", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1662ac433c3488fde7d747c0dbe94bb62d871847", "url": "https://github.com/apache/skywalking/commit/1662ac433c3488fde7d747c0dbe94bb62d871847", "message": "Update apm-sniffer/config/agent.config", "committedDate": "2020-12-23T12:44:22Z", "type": "commit"}]}