{"pr_number": 4268, "pr_title": "merge e2e profile test project", "pr_createdAt": "2020-01-19T04:33:35Z", "pr_url": "https://github.com/apache/skywalking/pull/4268", "timeline": [{"oid": "1d16cb2f3bc3845652aeb8dbb5216f6d60ff0a9c", "url": "https://github.com/apache/skywalking/commit/1d16cb2f3bc3845652aeb8dbb5216f6d60ff0a9c", "message": "merge e2e profile test project, Use `env` to distinguish different storage types", "committedDate": "2020-01-19T04:28:28Z", "type": "commit"}, {"oid": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "url": "https://github.com/apache/skywalking/commit/47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "message": "remove maven child module", "committedDate": "2020-01-19T04:45:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NTY3NQ==", "url": "https://github.com/apache/skywalking/pull/4268#discussion_r368265675", "bodyText": "change the name env to storage please, we may have other env in the future", "author": "kezhenxu94", "createdAt": "2020-01-19T04:51:15Z", "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -111,10 +111,10 @@ jobs:\n           ./mvnw -Dcheckstyle.skip -Drat.skip -T2 -Dmaven.compile.fork -Dmaven.compiler.maxmem=3072 -DskipTests clean install\n           ./mvnw -f test/e2e/pom.xml -pl e2e-base clean install\n       - name: Profile Tests H2(JDK8)\n-        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-profile/e2e-profile-h2-test-runner\n+        run: export E2E_VERSION=jdk8-1.3 && bash -x test/e2e/run.sh e2e-profile/e2e-profile-test-runner --env=h2", "originalCommit": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NTcwOA==", "url": "https://github.com/apache/skywalking/pull/4268#discussion_r368265708", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <!--mysql environment -->\n          \n          \n            \n                    <!--mysql storage -->", "author": "kezhenxu94", "createdAt": "2020-01-19T04:51:49Z", "path": "test/e2e/e2e-profile/e2e-profile-test-runner/pom.xml", "diffHunk": "@@ -46,5 +46,254 @@\n \n     </dependencies>\n \n+    <properties>\n+        <provider.name>e2e-profile-service</provider.name>\n+        <e2e.container.version>1.1</e2e.container.version>\n+        <e2e.container.name.prefix>skywalking-e2e-container-${build.id}-profile</e2e.container.name.prefix>\n+    </properties>\n+\n+    <profiles>\n+        <!--mysql environment -->", "originalCommit": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NTcxNg==", "url": "https://github.com/apache/skywalking/pull/4268#discussion_r368265716", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <!--h2 environment -->\n          \n          \n            \n                    <!--h2 storage -->", "author": "kezhenxu94", "createdAt": "2020-01-19T04:52:17Z", "path": "test/e2e/e2e-profile/e2e-profile-test-runner/pom.xml", "diffHunk": "@@ -46,5 +46,254 @@\n \n     </dependencies>\n \n+    <properties>\n+        <provider.name>e2e-profile-service</provider.name>\n+        <e2e.container.version>1.1</e2e.container.version>\n+        <e2e.container.name.prefix>skywalking-e2e-container-${build.id}-profile</e2e.container.name.prefix>\n+    </properties>\n+\n+    <profiles>\n+        <!--mysql environment -->\n+        <profile>\n+            <id>mysql</id>\n+            <build>\n+                <plugins>\n+                    <plugin>\n+                        <groupId>io.fabric8</groupId>\n+                        <artifactId>docker-maven-plugin</artifactId>\n+                        <configuration>\n+                            <containerNamePattern>%a-%t-%i</containerNamePattern>\n+                            <images>\n+                                <image>\n+                                    <name>mysql/mysql-server:${mysql.version}</name>\n+                                    <alias>${e2e.container.name.prefix}-datasource</alias>\n+                                    <run>\n+                                        <wait>\n+                                            <log>Socket: '/var/run/mysqld/mysqlx.sock' bind-address: '::' port: 3306</log>\n+                                            <time>120000</time>\n+                                        </wait>\n+                                        <env>\n+                                            <MYSQL_ROOT_PASSWORD>root@1234</MYSQL_ROOT_PASSWORD>\n+                                            <MYSQL_DATABASE>swtest</MYSQL_DATABASE>\n+                                            <MYSQL_ROOT_HOST>%</MYSQL_ROOT_HOST>\n+                                        </env>\n+                                        <ports>\n+                                            <port>mysql.port:3306</port>\n+                                        </ports>\n+                                    </run>\n+                                </image>\n+                                <image>\n+                                    <name>skyapm/e2e-container:${e2e.container.version}</name>\n+                                    <alias>${e2e.container.name.prefix}-runner</alias>\n+                                    <run>\n+                                        <env>\n+                                            <STORAGE>mysql</STORAGE>\n+                                            <SW_JDBC_URL>jdbc:mysql://${e2e.container.name.prefix}-datasource:3306/swtest</SW_JDBC_URL>\n+                                            <INSTRUMENTED_SERVICE_1>\n+                                                ${provider.name}-${project.version}.jar\n+                                            </INSTRUMENTED_SERVICE_1>\n+                                            <INSTRUMENTED_SERVICE_1_OPTS>\n+                                                -DSW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800\n+                                                -DSW_AGENT_PROFILE_ACTIVE=true\n+                                                -DSW_AGENT_NAME=${provider.name}\n+                                                -Dserver.port=9090\n+                                            </INSTRUMENTED_SERVICE_1_OPTS>\n+                                        </env>\n+                                        <dependsOn>\n+                                            <container>${e2e.container.name.prefix}-datasource</container>\n+                                        </dependsOn>\n+                                        <links>\n+                                            <link>${e2e.container.name.prefix}-datasource</link>\n+                                        </links>\n+                                        <ports>\n+                                            <port>+webapp.host:webapp.port:8081</port>\n+                                            <port>+service.host:service.port:9090</port>\n+                                        </ports>\n+                                        <volumes>\n+                                            <bind>\n+                                                <volume>${sw.home}:/sw</volume>\n+                                                <volume>${project.build.directory}:/home</volume>\n+                                                <volume>../${provider.name}/target/${provider.name}-${project.version}.jar:/home/${provider.name}-${project.version}.jar</volume>\n+                                                <volume>${project.basedir}/src/docker/rc.d:/rc.d:ro</volume>\n+                                                <volume>${project.basedir}/src/docker/clusterize.awk:/clusterize.awk</volume>\n+                                            </bind>\n+                                        </volumes>\n+                                        <wait>\n+                                            <log>SkyWalking e2e container is ready for tests</log>\n+                                            <time>3000000</time>\n+                                        </wait>\n+                                    </run>\n+                                </image>\n+                            </images>\n+                        </configuration>\n+                    </plugin>\n+                </plugins>\n+            </build>\n+        </profile>\n+\n+        <!--h2 environment -->", "originalCommit": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NTczMQ==", "url": "https://github.com/apache/skywalking/pull/4268#discussion_r368265731", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <!--elasticsearch environment -->\n          \n          \n            \n                    <!--elasticsearch storage -->", "author": "kezhenxu94", "createdAt": "2020-01-19T04:52:30Z", "path": "test/e2e/e2e-profile/e2e-profile-test-runner/pom.xml", "diffHunk": "@@ -46,5 +46,254 @@\n \n     </dependencies>\n \n+    <properties>\n+        <provider.name>e2e-profile-service</provider.name>\n+        <e2e.container.version>1.1</e2e.container.version>\n+        <e2e.container.name.prefix>skywalking-e2e-container-${build.id}-profile</e2e.container.name.prefix>\n+    </properties>\n+\n+    <profiles>\n+        <!--mysql environment -->\n+        <profile>\n+            <id>mysql</id>\n+            <build>\n+                <plugins>\n+                    <plugin>\n+                        <groupId>io.fabric8</groupId>\n+                        <artifactId>docker-maven-plugin</artifactId>\n+                        <configuration>\n+                            <containerNamePattern>%a-%t-%i</containerNamePattern>\n+                            <images>\n+                                <image>\n+                                    <name>mysql/mysql-server:${mysql.version}</name>\n+                                    <alias>${e2e.container.name.prefix}-datasource</alias>\n+                                    <run>\n+                                        <wait>\n+                                            <log>Socket: '/var/run/mysqld/mysqlx.sock' bind-address: '::' port: 3306</log>\n+                                            <time>120000</time>\n+                                        </wait>\n+                                        <env>\n+                                            <MYSQL_ROOT_PASSWORD>root@1234</MYSQL_ROOT_PASSWORD>\n+                                            <MYSQL_DATABASE>swtest</MYSQL_DATABASE>\n+                                            <MYSQL_ROOT_HOST>%</MYSQL_ROOT_HOST>\n+                                        </env>\n+                                        <ports>\n+                                            <port>mysql.port:3306</port>\n+                                        </ports>\n+                                    </run>\n+                                </image>\n+                                <image>\n+                                    <name>skyapm/e2e-container:${e2e.container.version}</name>\n+                                    <alias>${e2e.container.name.prefix}-runner</alias>\n+                                    <run>\n+                                        <env>\n+                                            <STORAGE>mysql</STORAGE>\n+                                            <SW_JDBC_URL>jdbc:mysql://${e2e.container.name.prefix}-datasource:3306/swtest</SW_JDBC_URL>\n+                                            <INSTRUMENTED_SERVICE_1>\n+                                                ${provider.name}-${project.version}.jar\n+                                            </INSTRUMENTED_SERVICE_1>\n+                                            <INSTRUMENTED_SERVICE_1_OPTS>\n+                                                -DSW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800\n+                                                -DSW_AGENT_PROFILE_ACTIVE=true\n+                                                -DSW_AGENT_NAME=${provider.name}\n+                                                -Dserver.port=9090\n+                                            </INSTRUMENTED_SERVICE_1_OPTS>\n+                                        </env>\n+                                        <dependsOn>\n+                                            <container>${e2e.container.name.prefix}-datasource</container>\n+                                        </dependsOn>\n+                                        <links>\n+                                            <link>${e2e.container.name.prefix}-datasource</link>\n+                                        </links>\n+                                        <ports>\n+                                            <port>+webapp.host:webapp.port:8081</port>\n+                                            <port>+service.host:service.port:9090</port>\n+                                        </ports>\n+                                        <volumes>\n+                                            <bind>\n+                                                <volume>${sw.home}:/sw</volume>\n+                                                <volume>${project.build.directory}:/home</volume>\n+                                                <volume>../${provider.name}/target/${provider.name}-${project.version}.jar:/home/${provider.name}-${project.version}.jar</volume>\n+                                                <volume>${project.basedir}/src/docker/rc.d:/rc.d:ro</volume>\n+                                                <volume>${project.basedir}/src/docker/clusterize.awk:/clusterize.awk</volume>\n+                                            </bind>\n+                                        </volumes>\n+                                        <wait>\n+                                            <log>SkyWalking e2e container is ready for tests</log>\n+                                            <time>3000000</time>\n+                                        </wait>\n+                                    </run>\n+                                </image>\n+                            </images>\n+                        </configuration>\n+                    </plugin>\n+                </plugins>\n+            </build>\n+        </profile>\n+\n+        <!--h2 environment -->\n+        <profile>\n+            <id>h2</id>\n+            <build>\n+                <plugins>\n+                    <plugin>\n+                        <groupId>io.fabric8</groupId>\n+                        <artifactId>docker-maven-plugin</artifactId>\n+                        <configuration>\n+                            <containerNamePattern>%a-%t-%i</containerNamePattern>\n+                            <imagePullPolicy>Always</imagePullPolicy>\n+                            <images>\n+                                <image>\n+                                    <name>skyapm/e2e-container:${e2e.container.version}</name>\n+                                    <alias>${e2e.container.name.prefix}</alias>\n+                                    <run>\n+                                        <env>\n+                                            <STORAGE>h2</STORAGE>\n+                                            <INSTRUMENTED_SERVICE_1>\n+                                                ${provider.name}-${project.version}.jar\n+                                            </INSTRUMENTED_SERVICE_1>\n+                                            <INSTRUMENTED_SERVICE_1_OPTS>\n+                                                -DSW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800\n+                                                -DSW_AGENT_PROFILE_ACTIVE=true\n+                                                -DSW_AGENT_NAME=${provider.name}\n+                                                -Dserver.port=9090\n+                                            </INSTRUMENTED_SERVICE_1_OPTS>\n+                                        </env>\n+                                        <ports>\n+                                            <port>+webapp.host:webapp.port:8081</port>\n+                                            <port>+service.host:service.port:9090</port>\n+                                        </ports>\n+                                        <volumes>\n+                                            <bind>\n+                                                <volume>${sw.home}:/sw</volume>\n+                                                <volume>../${provider.name}/target/${provider.name}-${project.version}.jar:/home/${provider.name}-${project.version}.jar</volume>\n+                                                <volume>${project.basedir}/src/docker/rc.d:/rc.d:ro</volume>\n+                                                <volume>${project.basedir}/src/docker/clusterize.awk:/clusterize.awk</volume>\n+                                            </bind>\n+                                        </volumes>\n+                                        <wait>\n+                                            <log>SkyWalking e2e container is ready for tests</log>\n+                                            <time>3000000</time>\n+                                        </wait>\n+                                    </run>\n+                                </image>\n+                            </images>\n+                        </configuration>\n+                    </plugin>\n+                </plugins>\n+            </build>\n+        </profile>\n+\n+        <!--elasticsearch environment -->", "originalCommit": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NTc1Mg==", "url": "https://github.com/apache/skywalking/pull/4268#discussion_r368265752", "bodyText": "env -> storage please", "author": "kezhenxu94", "createdAt": "2020-01-19T04:53:10Z", "path": "test/e2e/run.sh", "diffHunk": "@@ -36,6 +36,9 @@ while [[ $# -gt 0 ]]; do\n     --profiles=*)\n       profiles=${1#*=}\n       ;;\n+    --env=*)", "originalCommit": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NTc2MA==", "url": "https://github.com/apache/skywalking/pull/4268#discussion_r368265760", "bodyText": "same here", "author": "kezhenxu94", "createdAt": "2020-01-19T04:53:22Z", "path": "test/e2e/run.sh", "diffHunk": "@@ -70,6 +73,7 @@ do\n          -De2e.container.version=\"${E2E_VERSION}\" \\\n          -Delasticsearch.version=\"${ES_VERSION}\" \\\n          -Dsw.home=\"${base_dir}/$test_case/${DIST_PACKAGE//.tar.gz/}\" \\\n+         `if [ ! -z \"${env}\" ] ; then echo -P\"${env}\"; fi` \\", "originalCommit": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2NjIxNw==", "url": "https://github.com/apache/skywalking/pull/4268#discussion_r368266217", "bodyText": "The file name clusterize.awk should be changed (after copying), clusterize.awk is originally used to modify the application.yml to make it run in cluster mode (to test coordinators), here should be named with something like adapt_storage or other storage related names, if you like", "author": "kezhenxu94", "createdAt": "2020-01-19T05:05:53Z", "path": "test/e2e/e2e-profile/e2e-profile-test-runner/src/docker/clusterize.awk", "diffHunk": "@@ -0,0 +1,64 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+#!/usr/bin/awk -f\n+\n+BEGIN {", "originalCommit": "47c9211bd389fdc514ec2e7808d6cec303bdfd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9860e87fcd0c31b1c0475d191594bb4baaa38da", "url": "https://github.com/apache/skywalking/commit/e9860e87fcd0c31b1c0475d191594bb4baaa38da", "message": "change `env` -> `storage`", "committedDate": "2020-01-19T05:31:25Z", "type": "commit"}, {"oid": "4c1d60487cb1e4809858f844e1b75d6fa3d482d7", "url": "https://github.com/apache/skywalking/commit/4c1d60487cb1e4809858f844e1b75d6fa3d482d7", "message": "Merge branch 'master' into profiling_e2e_combine", "committedDate": "2020-01-19T10:10:55Z", "type": "commit"}, {"oid": "8e0c40375528ab75e70be467565a3d16d344bd85", "url": "https://github.com/apache/skywalking/commit/8e0c40375528ab75e70be467565a3d16d344bd85", "message": "Merge branch 'master' into profiling_e2e_combine", "committedDate": "2020-01-20T01:57:51Z", "type": "commit"}, {"oid": "194f50ad2e50b92f4efc70d89abdab20f0bf8447", "url": "https://github.com/apache/skywalking/commit/194f50ad2e50b92f4efc70d89abdab20f0bf8447", "message": "Merge branch 'master' into profiling_e2e_combine", "committedDate": "2020-01-20T07:08:04Z", "type": "commit"}]}