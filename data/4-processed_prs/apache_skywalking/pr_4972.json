{"pr_number": 4972, "pr_title": "Provide server-side meter", "pr_createdAt": "2020-06-25T15:26:52Z", "pr_url": "https://github.com/apache/skywalking/pull/4972", "timeline": [{"oid": "91b388bcd95cfa2e9e923e19bc801c3535cc440f", "url": "https://github.com/apache/skywalking/commit/91b388bcd95cfa2e9e923e19bc801c3535cc440f", "message": "Provide meter receiver", "committedDate": "2020-06-25T15:09:43Z", "type": "commit"}, {"oid": "e0fad4103524b4e4390d11d89f264adf6e867350", "url": "https://github.com/apache/skywalking/commit/e0fad4103524b4e4390d11d89f264adf6e867350", "message": "Change the groovy plugin declare path", "committedDate": "2020-06-25T15:15:54Z", "type": "commit"}, {"oid": "4b0d7a9db798aeae7b9daefff1b671bfbd268fc9", "url": "https://github.com/apache/skywalking/commit/4b0d7a9db798aeae7b9daefff1b671bfbd268fc9", "message": "Adding exception catch, encase throw exception to break the gRPC process.", "committedDate": "2020-06-25T15:20:22Z", "type": "commit"}, {"oid": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "url": "https://github.com/apache/skywalking/commit/273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "message": "Resolve e2e test", "committedDate": "2020-06-26T04:39:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjAxOA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476018", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n          \n          \n            \n            Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).", "author": "wu-sheng", "createdAt": "2020-06-27T02:59:28Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjI4Nw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476287", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  # Appoint percentiles if using avgHistogramPercentile operation.\n          \n          \n            \n                  # <Optional> Appoint percentiles if using avgHistogramPercentile operation.", "author": "wu-sheng", "createdAt": "2020-06-27T03:02:24Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjQ1Mw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476453", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.\n          \n          \n            \n            Use `meter[\"\"]` to refer the metrics raw data, and multiple build-in methods to help filter or operate the value.", "author": "wu-sheng", "createdAt": "2020-06-27T03:04:50Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjU4NA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476584", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            It will combine the values and collect into the Meter System.", "author": "wu-sheng", "createdAt": "2020-06-27T03:05:39Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.\n+It will combine the values and collect into the Meter System.", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjYwMw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476603", "bodyText": "Don't use future tense if possible.", "author": "wu-sheng", "createdAt": "2020-06-27T03:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3Njc3Ng==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476776", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The `add`, `reduce`, `multiply`, `mean` with Meter only support operate from single Meter value, you could using `tagFilter` to filter, Because we could not operation between two multiple values.\n          \n          \n            \n            The `add`, `reduce`, `multiply`, and `mean` support single Meter value. Use `tagFilter` to filter.\n          \n      \n    \n    \n  \n\nWhat do you mean Because we could not operation between two multiple values.?", "author": "wu-sheng", "createdAt": "2020-06-27T03:08:02Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.\n+It will combine the values and collect into the Meter System.\n+\n+|Function|Support meter type|Description|\n+|------|-------|------|\n+|tagFilter(String, String)|Counter,Gauge,Histogram|Filter tag key/value from meter|\n+|add(double)|Counter,Gauge|Add value into meter|\n+|add(Meter)|Counter,Gauge|Add value from a meter value|\n+|reduce(double)|Counter,Gauge|Reduce value into meter|\n+|reduce(Meter)|Counter,Gauge|Reduce value from a meter value|\n+|multiply(double)|Counter,Gauge|Multiply value into meter|\n+|multiply(Meter)|Counter,Gauge|Multiply value form a meter value|\n+|mean(double)|Counter,Gauge|Mean value into meter|\n+|mean(Meter)|Counter,Gauge|Mean value from a meter value|\n+|scale(int)|Counter,Gauge|Scale the meter value|\n+|rate(string)|Counter,Gauge,Histogram|Rate value from the time range|\n+|irate(string)|Counter,Gauge,Histogram|IRate value from the time range|\n+|increase(string)|Counter,Gauge,Histogram|Increase value from the time range|\n+\n+The `add`, `reduce`, `multiply`, `mean` with Meter only support operate from single Meter value, you could using `tagFilter` to filter, Because we could not operation between two multiple values.", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjgwMQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476801", "bodyText": "What do you mean mean? A little confused about this term", "author": "wu-sheng", "createdAt": "2020-06-27T03:08:36Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.\n+It will combine the values and collect into the Meter System.\n+\n+|Function|Support meter type|Description|\n+|------|-------|------|\n+|tagFilter(String, String)|Counter,Gauge,Histogram|Filter tag key/value from meter|\n+|add(double)|Counter,Gauge|Add value into meter|\n+|add(Meter)|Counter,Gauge|Add value from a meter value|\n+|reduce(double)|Counter,Gauge|Reduce value into meter|\n+|reduce(Meter)|Counter,Gauge|Reduce value from a meter value|\n+|multiply(double)|Counter,Gauge|Multiply value into meter|\n+|multiply(Meter)|Counter,Gauge|Multiply value form a meter value|\n+|mean(double)|Counter,Gauge|Mean value into meter|\n+|mean(Meter)|Counter,Gauge|Mean value from a meter value|", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjkxMQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476911", "bodyText": "Do we have counter and guage type? In the protocol, we define https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto#L49. There is no such thing. You must keep the nouns consistent, otherwise, people are going to be very confused. Even I am hard to follow.", "author": "wu-sheng", "createdAt": "2020-06-27T03:10:02Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.\n+It will combine the values and collect into the Meter System.\n+\n+|Function|Support meter type|Description|\n+|------|-------|------|\n+|tagFilter(String, String)|Counter,Gauge,Histogram|Filter tag key/value from meter|\n+|add(double)|Counter,Gauge|Add value into meter|", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE4NzY1MA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r453187650", "bodyText": "Have changed to the SingleValue or Histogram", "author": "mrproliu", "createdAt": "2020-07-11T11:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NjkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3Njk2Mw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446476963", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If you want to using `rate`, `irate`, `increase` function, I suggest to let it rate counter at the agent side. \n          \n          \n            \n            If you want to use `rate`, `irate`, `increase` function, use client-side API.", "author": "wu-sheng", "createdAt": "2020-06-27T03:10:31Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.\n+It will combine the values and collect into the Meter System.\n+\n+|Function|Support meter type|Description|\n+|------|-------|------|\n+|tagFilter(String, String)|Counter,Gauge,Histogram|Filter tag key/value from meter|\n+|add(double)|Counter,Gauge|Add value into meter|\n+|add(Meter)|Counter,Gauge|Add value from a meter value|\n+|reduce(double)|Counter,Gauge|Reduce value into meter|\n+|reduce(Meter)|Counter,Gauge|Reduce value from a meter value|\n+|multiply(double)|Counter,Gauge|Multiply value into meter|\n+|multiply(Meter)|Counter,Gauge|Multiply value form a meter value|\n+|mean(double)|Counter,Gauge|Mean value into meter|\n+|mean(Meter)|Counter,Gauge|Mean value from a meter value|\n+|scale(int)|Counter,Gauge|Scale the meter value|\n+|rate(string)|Counter,Gauge,Histogram|Rate value from the time range|\n+|irate(string)|Counter,Gauge,Histogram|IRate value from the time range|\n+|increase(string)|Counter,Gauge,Histogram|Increase value from the time range|\n+\n+The `add`, `reduce`, `multiply`, `mean` with Meter only support operate from single Meter value, you could using `tagFilter` to filter, Because we could not operation between two multiple values.\n+\n+If you want to using `rate`, `irate`, `increase` function, I suggest to let it rate counter at the agent side. ", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NzIzNw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477237", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Because if the connection between agent and backend has reconnected, the time windows will be break, so we cannot find previous value from the window.\n          \n          \n            \n            \n          \n          \n            \n            - FAQ, why no `rate`, `irate`, `increase` at the backend.\n          \n          \n            \n            Once the agent reconnected to another OAP instance, the time windows of rate calculation will break. Then, the result would not be accurate.", "author": "wu-sheng", "createdAt": "2020-06-27T03:14:13Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Using `meter[\"\"]` to get one meter from all of the meter witch received at ***per agent***, also there have multiple build-in method to help filter or operate the value.\n+It will combine the values and collect into the Meter System.\n+\n+|Function|Support meter type|Description|\n+|------|-------|------|\n+|tagFilter(String, String)|Counter,Gauge,Histogram|Filter tag key/value from meter|\n+|add(double)|Counter,Gauge|Add value into meter|\n+|add(Meter)|Counter,Gauge|Add value from a meter value|\n+|reduce(double)|Counter,Gauge|Reduce value into meter|\n+|reduce(Meter)|Counter,Gauge|Reduce value from a meter value|\n+|multiply(double)|Counter,Gauge|Multiply value into meter|\n+|multiply(Meter)|Counter,Gauge|Multiply value form a meter value|\n+|mean(double)|Counter,Gauge|Mean value into meter|\n+|mean(Meter)|Counter,Gauge|Mean value from a meter value|\n+|scale(int)|Counter,Gauge|Scale the meter value|\n+|rate(string)|Counter,Gauge,Histogram|Rate value from the time range|\n+|irate(string)|Counter,Gauge,Histogram|IRate value from the time range|\n+|increase(string)|Counter,Gauge,Histogram|Increase value from the time range|\n+\n+The `add`, `reduce`, `multiply`, `mean` with Meter only support operate from single Meter value, you could using `tagFilter` to filter, Because we could not operation between two multiple values.\n+\n+If you want to using `rate`, `irate`, `increase` function, I suggest to let it rate counter at the agent side. \n+Because if the connection between agent and backend has reconnected, the time windows will be break, so we cannot find previous value from the window.", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NzM5Nw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477397", "bodyText": "Check check-LICENSE.sh and known-oap-backend-dependencies.txt/known-oap-backend-dependencies-es7.txt. You need to update LICENSE/NOTICE and license check process. You are bringing a new like, maybe including many jars into OAP.", "author": "wu-sheng", "createdAt": "2020-06-27T03:15:50Z", "path": "oap-server/pom.xml", "diffHunk": "@@ -89,6 +89,7 @@\n         <freemarker.version>2.3.28</freemarker.version>\n         <javaassist.version>3.25.0-GA</javaassist.version>\n         <vavr.version>0.10.3</vavr.version>\n+        <groovy.version>3.0.3</groovy.version>", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NzQ2Nw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477467", "bodyText": "I think this should be - by default.", "author": "wu-sheng", "createdAt": "2020-06-27T03:16:44Z", "path": "oap-server/server-bootstrap/src/main/resources/application.yml", "diffHunk": "@@ -196,6 +196,10 @@ prometheus-fetcher:\n   default:\n     active: ${SW_PROMETHEUS_FETCHER_ACTIVE:false}\n \n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NzU4OQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477589", "bodyText": "I think you should provide Sleuth config in the folder, the example of agent setup, UI template, and full documentation to explain the document.\nThere is nothing than an example to show how to use this feature.", "author": "wu-sheng", "createdAt": "2020-06-27T03:18:24Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accept meter from [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) into the [Meter System](./../../concepts-and-designs/meter.md).o\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NzczNw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477737", "bodyText": "This file is being packeged into the boostrap jar, please recheck the pom.xml", "author": "wu-sheng", "createdAt": "2020-06-27T03:20:06Z", "path": "oap-server/server-bootstrap/src/main/resources/meter-receive-config/config.yaml", "diffHunk": "@@ -0,0 +1,33 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+meters:", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NzgyNQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477825", "bodyText": "What are these metrics for? Who are sending this? Please check my suggestion about your default meter YAML.", "author": "wu-sheng", "createdAt": "2020-06-27T03:20:46Z", "path": "oap-server/server-bootstrap/src/main/resources/meter-receive-config/config.yaml", "diffHunk": "@@ -0,0 +1,33 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+meters:\n+  - name: jvm_heap_usage_avg", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3Nzg3Mw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477873", "bodyText": "Code style is not right.", "author": "wu-sheng", "createdAt": "2020-06-27T03:21:15Z", "path": "oap-server/server-receiver-plugin/skywalking-meter-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/meter/provider/config/MeterConfigs.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.meter.provider.config;\n+\n+import lombok.Data;\n+import org.apache.skywalking.oap.server.library.module.ModuleStartException;\n+import org.apache.skywalking.oap.server.library.util.ResourceUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.yaml.snakeyaml.Yaml;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class MeterConfigs {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(MeterConfigs.class);", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3Nzg4Mg==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r446477882", "bodyText": "Comments?", "author": "wu-sheng", "createdAt": "2020-06-27T03:21:26Z", "path": "oap-server/server-receiver-plugin/skywalking-meter-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/meter/provider/config/MeterConfigs.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.meter.provider.config;\n+\n+import lombok.Data;\n+import org.apache.skywalking.oap.server.library.module.ModuleStartException;\n+import org.apache.skywalking.oap.server.library.util.ResourceUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.yaml.snakeyaml.Yaml;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class MeterConfigs {", "originalCommit": "273bc3cc221b16d50ccc3adbf9415ffae3ac7fae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e019cec0d148e436f13d3380ceb16daf0ed6ecee", "url": "https://github.com/apache/skywalking/commit/e019cec0d148e436f13d3380ceb16daf0ed6ecee", "message": "Change issues\nSupport e2e meter test", "committedDate": "2020-07-11T11:46:45Z", "type": "commit"}, {"oid": "fbdcf3319e1465a308b9b9fac8713d75fac3684d", "url": "https://github.com/apache/skywalking/commit/fbdcf3319e1465a308b9b9fac8713d75fac3684d", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-11T11:53:07Z", "type": "commit"}, {"oid": "28e00d7e21c08b7d2c7c2a8d2f88a66ef4849569", "url": "https://github.com/apache/skywalking/commit/28e00d7e21c08b7d2c7c2a8d2f88a66ef4849569", "message": "Change the logger format", "committedDate": "2020-07-11T11:57:10Z", "type": "commit"}, {"oid": "1f7be4530e0d31243c1aba4a165b3dd43d5f3476", "url": "https://github.com/apache/skywalking/commit/1f7be4530e0d31243c1aba4a165b3dd43d5f3476", "message": "Adding apache snapshot repository declare", "committedDate": "2020-07-11T12:18:10Z", "type": "commit"}, {"oid": "c4db9aae1a4602889d89b98896f7a4b0f4069e3d", "url": "https://github.com/apache/skywalking/commit/c4db9aae1a4602889d89b98896f7a4b0f4069e3d", "message": "Fix UT", "committedDate": "2020-07-11T13:33:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5ODg1NA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r453198854", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Material Icons 3.0.1 https://github.com/google/material-design-icons Apache-2.0\n          \n          \n            \n            groovy 3.0.3 https://github.com/apache/groovy Apache-2.0\n          \n          \n            \n            Material Icons 3.0.1 https://github.com/google/material-design-icons Apache-2.0\n          \n          \n            \n            groovy             3.0.3 https://github.com/apache/groovy Apache-2.0", "author": "wu-sheng", "createdAt": "2020-07-11T14:10:02Z", "path": "dist-material/release-docs/LICENSE", "diffHunk": "@@ -444,6 +444,7 @@ Apache 2.0 licenses\n ========================================\n echarts\t4.1.0:\thttps://github.com/apache/incubator-echarts\tApache-2.0\n Material Icons 3.0.1 https://github.com/google/material-design-icons Apache-2.0\n+groovy 3.0.3 https://github.com/apache/groovy Apache-2.0", "originalCommit": "c4db9aae1a4602889d89b98896f7a4b0f4069e3d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5OTE2NQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r453199165", "bodyText": "This file is not available. Also at the same time, what is this file for?", "author": "wu-sheng", "createdAt": "2020-07-11T14:13:48Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)", "originalCommit": "c4db9aae1a4602889d89b98896f7a4b0f4069e3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5OTMzNQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r453199335", "bodyText": "Do you plan to have a config for Spring app?", "author": "wu-sheng", "createdAt": "2020-07-11T14:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5OTE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NzY4NA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456847684", "bodyText": "Rename to the spring.yaml, support moniting on the spring application.", "author": "mrproliu", "createdAt": "2020-07-19T01:55:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5OTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5OTYxMQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r453199611", "bodyText": "We need grammar expressions. Take a look on SkyWalking's OAL doc and grammar expressions.", "author": "wu-sheng", "createdAt": "2020-07-11T14:19:17Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,77 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/meter-receive-config.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # <Optional> Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # <Optional> Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+Use `meter[\"\"]` to refer the metrics raw data, and multiple build-in methods to help filter or operate the value.", "originalCommit": "c4db9aae1a4602889d89b98896f7a4b0f4069e3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NzYxMg==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456847612", "bodyText": "Has changed the doc, add the grammar expressions explain.", "author": "mrproliu", "createdAt": "2020-07-19T01:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE5OTYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIwMDA3OA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r453200078", "bodyText": "This file is in the official release, what is this for? hikaricp and many things are not in every app.\nThis should a test config file, or example only.", "author": "wu-sheng", "createdAt": "2020-07-11T14:24:37Z", "path": "oap-server/server-bootstrap/src/main/resources/meter-receive-config/config.yaml", "diffHunk": "@@ -0,0 +1,358 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+meters:", "originalCommit": "c4db9aae1a4602889d89b98896f7a4b0f4069e3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg0NzU1OA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456847558", "bodyText": "Has removed hikaricp meters.", "author": "mrproliu", "createdAt": "2020-07-19T01:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIwMDA3OA=="}], "type": "inlineReview"}, {"oid": "6e9eb2e41c8a77c5fbb58f0d9727b0ac4d49e440", "url": "https://github.com/apache/skywalking/commit/6e9eb2e41c8a77c5fbb58f0d9727b0ac4d49e440", "message": "Fix UT", "committedDate": "2020-07-11T15:23:36Z", "type": "commit"}, {"oid": "03738d693e517049db002ab0b78bd18252b36324", "url": "https://github.com/apache/skywalking/commit/03738d693e517049db002ab0b78bd18252b36324", "message": "1. Resolve issue\n2. Add UI init templates", "committedDate": "2020-07-19T01:52:20Z", "type": "commit"}, {"oid": "9a62e8481da376e7ab42921f6f0f92f2fe4c1d16", "url": "https://github.com/apache/skywalking/commit/9a62e8481da376e7ab42921f6f0f92f2fe4c1d16", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-19T01:55:36Z", "type": "commit"}, {"oid": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "url": "https://github.com/apache/skywalking/commit/96a18f2bf694c5104a1785a03dc3ac16de99eab4", "message": "Fix E2E validate meter names", "committedDate": "2020-07-19T03:40:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2Mzk2MA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456863960", "bodyText": "You missed the receiver set up doc in this page.", "author": "wu-sheng", "createdAt": "2020-07-19T05:48:57Z", "path": "docs/en/setup/backend/backend-receivers.md", "diffHunk": "@@ -14,6 +14,7 @@ We have following receivers, and `default` implementors are provided in our Apac\n 1. **receiver_zipkin**. See [details](#zipkin-receiver).\n 1. **receiver_jaeger**. See [details](#jaeger-receiver).\n 1. **receiver-oc**. See [details](#oc-receiver).\n+1. **receiver-meter**. See [details](backend-meter.md).", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3ODc1OA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r457378758", "bodyText": "Has added a simple description in the document.", "author": "mrproliu", "createdAt": "2020-07-20T13:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2Mzk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDA2Ng==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864066", "bodyText": "This file is still in server-bootstrap/src/main/resources/, so, once this file exists, does it mean the index will be created after the OAP starts up? I think all meter system config should be OFF in default.", "author": "wu-sheng", "createdAt": "2020-07-19T05:50:08Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,125 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/spring.yaml)", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDg4OQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864889", "bodyText": "This example should be listed separately about Spring Sleuth Setup Doc. Both agent doc(Application-toolkit-meter.md) and here should provide a link to that separated documentation.", "author": "wu-sheng", "createdAt": "2020-07-19T05:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NTAwNA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456865004", "bodyText": "And backend-setup.md should add a link of Spring Sleuth Metrics Analysis section in Advanced feature document link list", "author": "wu-sheng", "createdAt": "2020-07-19T06:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NTEwNg==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456865106", "bodyText": "Spring Sleuth Metrics Analysis provides a fully detailed documents including\n\nSet up agent\nSet up backend receiver\nAdd UI dashboard\n\nAnd the screenshot could be hosted in skywalking-website repo, there are a lot of screenshots hosted there.", "author": "wu-sheng", "createdAt": "2020-07-19T06:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDEyNw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864127", "bodyText": "What is scale N? Do you have some public doc to explain this name?", "author": "wu-sheng", "createdAt": "2020-07-19T05:50:33Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,125 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/spring.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # <Optional> Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # <Optional> Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+##### Meter value grammar\n+```\n+// Declare the meter value.\n+meter[METER_NAME]\n+[.tagFilter(TAG_KEY, TAG_VALUE)]\n+.FUNCTION(VALUE | METER)\n+```\n+##### Meter Name\n+\n+Use name to refer the metrics raw data from agent side.\n+\n+##### Tag Filter\n+\n+Use the meter tag to filter the meter value.\n+> meter[\"test_meter\"].tagFilter(\"k1\", \"v1\")\n+\n+In this case, filter the tag key equals `k1` and tag value equals `v1` value from `test_meter`.\n+\n+##### Aggregation Function\n+\n+Use multiple build-in methods to help operate the value.\n+\n+Provided functions\n+- `add`. Add value into meter. Support single value.\n+> meter[\"test_meter\"].add(2)\n+\n+In this case, all of the meter values will add `2`.\n+> meter[\"test_meter1\"].add(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will add value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `subtract`. Subtract value into meter. Support single value.\n+> meter[\"test_meter\"].subtract(2)\n+\n+In this case, all of the meter values will subtract `2`.\n+> meter[\"test_meter1\"].subtract(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will subtract value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `multiply`. Multiply value into meter. Support single value.\n+> meter[\"test_meter\"].multiply(2)\n+\n+In this case, all of the meter values will multiply `2`.\n+> meter[\"test_meter1\"].multiply(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will multiply value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `divide`. Divide value into meter. Support single value.\n+> meter[\"test_meter\"].divide(2)\n+\n+In this case, all of the meter values will divide `2`.\n+> meter[\"test_meter1\"].divide(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will divide value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `scale`. Scale value into meter. Support single value.", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3NjY2NA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r457376664", "bodyText": "Has add a example.", "author": "mrproliu", "createdAt": "2020-07-20T13:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDMwNg==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864306", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If you want to use `rate`, `irate`, `increase` function, use client-side API.\n          \n          \n            \n            - FAQ, why no `rate`, `irate`, `increase` at the backend.\n          \n          \n            \n            Once the agent reconnected to another OAP instance, the time windows of rate calculation will break. Then, the result would not be accurate.\n          \n          \n            \n            Even we supported `rate`, `irate`, `increase` function in the backend, but we still recommend user to consider using client-side APIs to do these. Because\n          \n          \n            \n            1. The OAP has to set up caches to calculate the value.\n          \n          \n            \n            1. Once the agent reconnected to another OAP instance, the time windows of rate calculation will break. Then, the result would not be accurate.", "author": "wu-sheng", "createdAt": "2020-07-19T05:52:31Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,125 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/spring.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # <Optional> Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # <Optional> Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+##### Meter value grammar\n+```\n+// Declare the meter value.\n+meter[METER_NAME]\n+[.tagFilter(TAG_KEY, TAG_VALUE)]\n+.FUNCTION(VALUE | METER)\n+```\n+##### Meter Name\n+\n+Use name to refer the metrics raw data from agent side.\n+\n+##### Tag Filter\n+\n+Use the meter tag to filter the meter value.\n+> meter[\"test_meter\"].tagFilter(\"k1\", \"v1\")\n+\n+In this case, filter the tag key equals `k1` and tag value equals `v1` value from `test_meter`.\n+\n+##### Aggregation Function\n+\n+Use multiple build-in methods to help operate the value.\n+\n+Provided functions\n+- `add`. Add value into meter. Support single value.\n+> meter[\"test_meter\"].add(2)\n+\n+In this case, all of the meter values will add `2`.\n+> meter[\"test_meter1\"].add(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will add value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `subtract`. Subtract value into meter. Support single value.\n+> meter[\"test_meter\"].subtract(2)\n+\n+In this case, all of the meter values will subtract `2`.\n+> meter[\"test_meter1\"].subtract(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will subtract value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `multiply`. Multiply value into meter. Support single value.\n+> meter[\"test_meter\"].multiply(2)\n+\n+In this case, all of the meter values will multiply `2`.\n+> meter[\"test_meter1\"].multiply(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will multiply value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `divide`. Divide value into meter. Support single value.\n+> meter[\"test_meter\"].divide(2)\n+\n+In this case, all of the meter values will divide `2`.\n+> meter[\"test_meter1\"].divide(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will divide value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `scale`. Scale value into meter. Support single value.\n+> meter[\"test_meter\"].scale(2)\n+\n+In this case, all of the meter values will scale `2`.\n+- `rate`. Rate value from the time range. Support single value and Histogram.\n+> meter[\"test_meter\"].rate(\"P15S\")\n+\n+In this case, all of the meter values will rate from `15s` before.\n+- `irate`. IRate value from the time range. Support single value and Histogram.\n+> meter[\"test_meter\"].irate(\"P15S\")\n+\n+In this case, all of the meter values will irate from `15s` before.\n+- `increase`. increase value from the time range. Support single value and Histogram.\n+> meter[\"test_meter\"].increase(\"P15S\")\n+\n+In this case, all of the meter values will increase from `15s` before.\n+\n+If you want to use `rate`, `irate`, `increase` function, use client-side API.\n+- FAQ, why no `rate`, `irate`, `increase` at the backend.\n+Once the agent reconnected to another OAP instance, the time windows of rate calculation will break. Then, the result would not be accurate.", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDM1OA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864358", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - `rate`. Rate value from the time range. Support single value and Histogram.\n          \n          \n            \n            - `rate`.(Not Recommended) Rate value from the time range. Support single value and Histogram.", "author": "wu-sheng", "createdAt": "2020-07-19T05:53:05Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,125 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/spring.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # <Optional> Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # <Optional> Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+##### Meter value grammar\n+```\n+// Declare the meter value.\n+meter[METER_NAME]\n+[.tagFilter(TAG_KEY, TAG_VALUE)]\n+.FUNCTION(VALUE | METER)\n+```\n+##### Meter Name\n+\n+Use name to refer the metrics raw data from agent side.\n+\n+##### Tag Filter\n+\n+Use the meter tag to filter the meter value.\n+> meter[\"test_meter\"].tagFilter(\"k1\", \"v1\")\n+\n+In this case, filter the tag key equals `k1` and tag value equals `v1` value from `test_meter`.\n+\n+##### Aggregation Function\n+\n+Use multiple build-in methods to help operate the value.\n+\n+Provided functions\n+- `add`. Add value into meter. Support single value.\n+> meter[\"test_meter\"].add(2)\n+\n+In this case, all of the meter values will add `2`.\n+> meter[\"test_meter1\"].add(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will add value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `subtract`. Subtract value into meter. Support single value.\n+> meter[\"test_meter\"].subtract(2)\n+\n+In this case, all of the meter values will subtract `2`.\n+> meter[\"test_meter1\"].subtract(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will subtract value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `multiply`. Multiply value into meter. Support single value.\n+> meter[\"test_meter\"].multiply(2)\n+\n+In this case, all of the meter values will multiply `2`.\n+> meter[\"test_meter1\"].multiply(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will multiply value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `divide`. Divide value into meter. Support single value.\n+> meter[\"test_meter\"].divide(2)\n+\n+In this case, all of the meter values will divide `2`.\n+> meter[\"test_meter1\"].divide(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will divide value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `scale`. Scale value into meter. Support single value.\n+> meter[\"test_meter\"].scale(2)\n+\n+In this case, all of the meter values will scale `2`.\n+- `rate`. Rate value from the time range. Support single value and Histogram.", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDM2NQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864365", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - `irate`. IRate value from the time range. Support single value and Histogram.\n          \n          \n            \n            - `irate`.(Not Recommended) IRate value from the time range. Support single value and Histogram.", "author": "wu-sheng", "createdAt": "2020-07-19T05:53:14Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,125 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/spring.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # <Optional> Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # <Optional> Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+##### Meter value grammar\n+```\n+// Declare the meter value.\n+meter[METER_NAME]\n+[.tagFilter(TAG_KEY, TAG_VALUE)]\n+.FUNCTION(VALUE | METER)\n+```\n+##### Meter Name\n+\n+Use name to refer the metrics raw data from agent side.\n+\n+##### Tag Filter\n+\n+Use the meter tag to filter the meter value.\n+> meter[\"test_meter\"].tagFilter(\"k1\", \"v1\")\n+\n+In this case, filter the tag key equals `k1` and tag value equals `v1` value from `test_meter`.\n+\n+##### Aggregation Function\n+\n+Use multiple build-in methods to help operate the value.\n+\n+Provided functions\n+- `add`. Add value into meter. Support single value.\n+> meter[\"test_meter\"].add(2)\n+\n+In this case, all of the meter values will add `2`.\n+> meter[\"test_meter1\"].add(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will add value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `subtract`. Subtract value into meter. Support single value.\n+> meter[\"test_meter\"].subtract(2)\n+\n+In this case, all of the meter values will subtract `2`.\n+> meter[\"test_meter1\"].subtract(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will subtract value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `multiply`. Multiply value into meter. Support single value.\n+> meter[\"test_meter\"].multiply(2)\n+\n+In this case, all of the meter values will multiply `2`.\n+> meter[\"test_meter1\"].multiply(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will multiply value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `divide`. Divide value into meter. Support single value.\n+> meter[\"test_meter\"].divide(2)\n+\n+In this case, all of the meter values will divide `2`.\n+> meter[\"test_meter1\"].divide(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will divide value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `scale`. Scale value into meter. Support single value.\n+> meter[\"test_meter\"].scale(2)\n+\n+In this case, all of the meter values will scale `2`.\n+- `rate`. Rate value from the time range. Support single value and Histogram.\n+> meter[\"test_meter\"].rate(\"P15S\")\n+\n+In this case, all of the meter values will rate from `15s` before.\n+- `irate`. IRate value from the time range. Support single value and Histogram.", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDQyNQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864425", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - `increase`. increase value from the time range. Support single value and Histogram.\n          \n          \n            \n            - `increase`.(Not Recommended) increase value from the time range. Support single value and Histogram.", "author": "wu-sheng", "createdAt": "2020-07-19T05:54:08Z", "path": "docs/en/setup/backend/backend-meter.md", "diffHunk": "@@ -0,0 +1,125 @@\n+# Meter Receiver\n+Meter receiver is accepting the metrics of [meter protocol](https://github.com/apache/skywalking-data-collect-protocol/blob/master/language-agent/Meter.proto) format into the [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Module define\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+\n+## Configuration file\n+Meter receiver is configured via a configuration file. The configuration file defines everything related to receiving \n+ from agents, as well as which rule files to load.\n+ \n+OAP can load the configuration at bootstrap. If the new configuration is not well-formed, OAP fails to start up. The files\n+are located at `$CLASSPATH/meter-receive-config`.\n+\n+The file is written in YAML format, defined by the scheme described below. Brackets indicate that a parameter is optional.\n+\n+A example can be found [here](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/spring.yaml)\n+\n+### Meters configure\n+\n+```yaml\n+# Meter config allow your to recompute\n+meters:\n+  # Meter name which combines with a prefix 'meter_' as the index/table name in storage.\n+  - name: <string>\n+    # The meter scope\n+    scope:\n+      # Scope type should be one of SERVICE, SERVICE_INSTANCE, ENDPOINT\n+      type: <string>\n+      # <Optional> Appoint the endpoint name if using ENDPOINT scope\n+      endpoint: <string>\n+    # The agent source of the transformation operation.\n+    meter:\n+      # The transformation operation from prometheus metrics to Skywalking ones. \n+      operation: <string>\n+      # Meter value parse groovy script.\n+      value: <string>\n+      # <Optional> Appoint percentiles if using avgHistogramPercentile operation.\n+      percentile:\n+        - <rank>\n+```\n+\n+#### Meter transform operation\n+\n+The available operations are `avg`, `avgHistogram` and `avgHistogramPercentile`. The `avg` and `avgXXX` mean to average\n+the raw received metrics. \n+\n+When you specify `avgHistogram` and `avgHistogramPercentile`, the source should be the type of `histogram`.\n+\n+#### Meter value script\n+\n+The script is provide a easy way to custom build a complex value, and it also support combine multiple meter into one.\n+\n+##### Meter value grammar\n+```\n+// Declare the meter value.\n+meter[METER_NAME]\n+[.tagFilter(TAG_KEY, TAG_VALUE)]\n+.FUNCTION(VALUE | METER)\n+```\n+##### Meter Name\n+\n+Use name to refer the metrics raw data from agent side.\n+\n+##### Tag Filter\n+\n+Use the meter tag to filter the meter value.\n+> meter[\"test_meter\"].tagFilter(\"k1\", \"v1\")\n+\n+In this case, filter the tag key equals `k1` and tag value equals `v1` value from `test_meter`.\n+\n+##### Aggregation Function\n+\n+Use multiple build-in methods to help operate the value.\n+\n+Provided functions\n+- `add`. Add value into meter. Support single value.\n+> meter[\"test_meter\"].add(2)\n+\n+In this case, all of the meter values will add `2`.\n+> meter[\"test_meter1\"].add(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will add value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `subtract`. Subtract value into meter. Support single value.\n+> meter[\"test_meter\"].subtract(2)\n+\n+In this case, all of the meter values will subtract `2`.\n+> meter[\"test_meter1\"].subtract(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will subtract value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `multiply`. Multiply value into meter. Support single value.\n+> meter[\"test_meter\"].multiply(2)\n+\n+In this case, all of the meter values will multiply `2`.\n+> meter[\"test_meter1\"].multiply(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will multiply value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `divide`. Divide value into meter. Support single value.\n+> meter[\"test_meter\"].divide(2)\n+\n+In this case, all of the meter values will divide `2`.\n+> meter[\"test_meter1\"].divide(meter[\"test_meter2\"])\n+\n+In this case, all of the `test_meter1` values will divide value from `test_meter2`, ensure `test_meter2` only has single value to operate, could use `tagFilter`.\n+- `scale`. Scale value into meter. Support single value.\n+> meter[\"test_meter\"].scale(2)\n+\n+In this case, all of the meter values will scale `2`.\n+- `rate`. Rate value from the time range. Support single value and Histogram.\n+> meter[\"test_meter\"].rate(\"P15S\")\n+\n+In this case, all of the meter values will rate from `15s` before.\n+- `irate`. IRate value from the time range. Support single value and Histogram.\n+> meter[\"test_meter\"].irate(\"P15S\")\n+\n+In this case, all of the meter values will irate from `15s` before.\n+- `increase`. increase value from the time range. Support single value and Histogram.", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDYxMQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864611", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              - name: Spring\n          \n          \n            \n              - name: Spring-Sleuth", "author": "wu-sheng", "createdAt": "2020-07-19T05:55:47Z", "path": "oap-server/server-bootstrap/src/main/resources/ui-initialized-templates.yml", "diffHunk": "@@ -1067,4 +1067,124 @@ templates:\n     # False means providing a basic template, user needs to add it manually.\n     activated: true\n     # True means wouldn't show up on the dashboard. Only keeps the definition in the storage.\n+    disabled: false\n+  - name: Spring", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDYyNg==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864626", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"name\":\"Spring\",\n          \n          \n            \n                      \"name\":\"Spring \",", "author": "wu-sheng", "createdAt": "2020-07-19T05:55:56Z", "path": "oap-server/server-bootstrap/src/main/resources/ui-initialized-templates.yml", "diffHunk": "@@ -1067,4 +1067,124 @@ templates:\n     # False means providing a basic template, user needs to add it manually.\n     activated: true\n     # True means wouldn't show up on the dashboard. Only keeps the definition in the storage.\n+    disabled: false\n+  - name: Spring\n+    type: \"DASHBOARD\"\n+    configuration: |-\n+      [\n+        {\n+          \"name\":\"Spring\",", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NDY0Nw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456864647", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          \"name\":\"micro-meter\",\n          \n          \n            \n                          \"name\":\"Sleuth\",", "author": "wu-sheng", "createdAt": "2020-07-19T05:56:15Z", "path": "oap-server/server-bootstrap/src/main/resources/ui-initialized-templates.yml", "diffHunk": "@@ -1067,4 +1067,124 @@ templates:\n     # False means providing a basic template, user needs to add it manually.\n     activated: true\n     # True means wouldn't show up on the dashboard. Only keeps the definition in the storage.\n+    disabled: false\n+  - name: Spring\n+    type: \"DASHBOARD\"\n+    configuration: |-\n+      [\n+        {\n+          \"name\":\"Spring\",\n+          \"type\":\"service\",\n+          \"children\":[\n+            {\n+              \"name\":\"micro-meter\",", "originalCommit": "96a18f2bf694c5104a1785a03dc3ac16de99eab4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d548d5a02b79e13df77e7d142a6d461a24288d11", "url": "https://github.com/apache/skywalking/commit/d548d5a02b79e13df77e7d142a6d461a24288d11", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-20T00:10:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3MzcwNQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456973705", "bodyText": "Wrong name.", "author": "wu-sheng", "createdAt": "2020-07-20T00:11:03Z", "path": ".github/workflows/e2e.yaml", "diffHunk": "@@ -100,3 +100,25 @@ jobs:\n         with:\n           name: logs\n           path: logs\n+\n+  FeatureGroup04:\n+    name: Meter\n+    runs-on: ubuntu-latest\n+    timeout-minutes: 90\n+    steps:\n+      - uses: actions/checkout@v2\n+        with:\n+          submodules: true\n+      - name: Compile and Build\n+        run: make docker\n+      - name: Copy dist package\n+        run: cp -R dist test/e2e/\n+      - name: Uninstrumnented gateway", "originalCommit": "d548d5a02b79e13df77e7d142a6d461a24288d11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDI0Nw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456974247", "bodyText": "All loggers, please use @Slf4j", "author": "wu-sheng", "createdAt": "2020-07-20T00:15:47Z", "path": "oap-server/server-receiver-plugin/skywalking-meter-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/meter/provider/process/MeterBuilder.java", "diffHunk": "@@ -0,0 +1,158 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.meter.provider.process;\n+\n+import groovy.lang.GroovyShell;\n+import org.apache.skywalking.oap.server.core.analysis.TimeBucket;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterEntity;\n+import org.apache.skywalking.oap.server.core.analysis.meter.MeterSystem;\n+import org.apache.skywalking.oap.server.core.analysis.meter.function.AcceptableValue;\n+import org.apache.skywalking.oap.server.core.analysis.meter.function.AvgHistogramPercentileFunction;\n+import org.apache.skywalking.oap.server.core.analysis.meter.function.BucketedValues;\n+import org.apache.skywalking.oap.server.receiver.meter.provider.config.MeterConfig;\n+import org.apache.skywalking.oap.server.receiver.meter.provider.config.Scope;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Map;\n+import java.util.StringJoiner;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Help to build meter into Meter System.\n+ */\n+public class MeterBuilder {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(MeterBuilder.class);", "originalCommit": "d548d5a02b79e13df77e7d142a6d461a24288d11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDUzNg==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r456974536", "bodyText": "I found this in the parent pom(apache.pom), are you sure you need this again?\n  <repositories>\n    <repository>\n      <id>apache.snapshots</id>\n      <name>Apache Snapshot Repository</name>\n      <url>https://repository.apache.org/snapshots</url>\n      <releases>\n        <enabled>false</enabled>\n      </releases>\n    </repository>\n  </repositories>", "author": "wu-sheng", "createdAt": "2020-07-20T00:18:06Z", "path": "test/e2e/e2e-service-provider/pom.xml", "diffHunk": "@@ -68,4 +77,11 @@\n         </plugins>\n     </build>\n \n+    <repositories>\n+        <repository>\n+            <id>apache-snapshot</id>\n+            <name>Apache Snapshot</name>\n+            <url>https://repository.apache.org/content/repositories/snapshots</url>\n+        </repository>\n+    </repositories>", "originalCommit": "d548d5a02b79e13df77e7d142a6d461a24288d11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33eae03a63ce659c91b1592798204e7ce52358ee", "url": "https://github.com/apache/skywalking/commit/33eae03a63ce659c91b1592798204e7ce52358ee", "message": "1. Fix document\n2. Remove e2e must using mysql", "committedDate": "2020-07-20T12:57:52Z", "type": "commit"}, {"oid": "7d862a973fb4c52aa1308a43a1ccfe73fac421fe", "url": "https://github.com/apache/skywalking/commit/7d862a973fb4c52aa1308a43a1ccfe73fac421fe", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-20T13:09:33Z", "type": "commit"}, {"oid": "ef524894bd36ca7e84df2a7e5a38a0be9b580490", "url": "https://github.com/apache/skywalking/commit/ef524894bd36ca7e84df2a7e5a38a0be9b580490", "message": "Fix issues", "committedDate": "2020-07-20T13:20:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzODg0MA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r457838840", "bodyText": "Why expose these endpoints? The info endpoint conflict with the example service, if they're really needed, please expose them to another base-path", "author": "kezhenxu94", "createdAt": "2020-07-21T05:06:56Z", "path": "test/e2e/e2e-service-provider/src/main/resources/application.yml", "diffHunk": "@@ -32,3 +32,17 @@ spring:\n     properties:\n       hibernate.format_sql: true\n     show-sql: true\n+\n+management:\n+  metrics:\n+    use-global-registry: true\n+    web:\n+      server:\n+        request:\n+          autotime:\n+            enabled: true\n+  endpoints:\n+    web:\n+      exposure:\n+        include: info,health\n+      base-path: /", "originalCommit": "ef524894bd36ca7e84df2a7e5a38a0be9b580490", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0NjEwOA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r457846108", "bodyText": "Thanks a lot. Has fixed.", "author": "mrproliu", "createdAt": "2020-07-21T05:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzODg0MA=="}], "type": "inlineReview"}, {"oid": "7b023be1fe8bb79fcad9d04c9f33a58268c04d27", "url": "https://github.com/apache/skywalking/commit/7b023be1fe8bb79fcad9d04c9f33a58268c04d27", "message": "Fix e2e expose", "committedDate": "2020-07-21T05:31:05Z", "type": "commit"}, {"oid": "ccbb79402ee7a92bc2440edbd5f4a5323c3d6836", "url": "https://github.com/apache/skywalking/commit/ccbb79402ee7a92bc2440edbd5f4a5323c3d6836", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-21T06:35:44Z", "type": "commit"}, {"oid": "c6efd480e9ee978986adf1b99e935efd97af4ce4", "url": "https://github.com/apache/skywalking/commit/c6efd480e9ee978986adf1b99e935efd97af4ce4", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-21T12:56:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4MzQwMw==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r458083403", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"name\":\"Spring \",\n          \n          \n            \n                      \"name\":\"Spring Sleuth\",\n          \n      \n    \n    \n  \n\nThis seems much easier than meter-receive-config/spring.yaml provided, could you share why? I expect they are matched and used by the end-user directly.", "author": "wu-sheng", "createdAt": "2020-07-21T13:10:59Z", "path": "oap-server/server-bootstrap/src/main/resources/ui-initialized-templates.yml", "diffHunk": "@@ -1067,4 +1067,124 @@ templates:\n     # False means providing a basic template, user needs to add it manually.\n     activated: true\n     # True means wouldn't show up on the dashboard. Only keeps the definition in the storage.\n+    disabled: false\n+  - name: Spring-Sleuth\n+    type: \"DASHBOARD\"\n+    configuration: |-\n+      [\n+        {\n+          \"name\":\"Spring \",", "originalCommit": "c6efd480e9ee978986adf1b99e935efd97af4ce4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4NDEzOQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r458084139", "bodyText": "And notice, this change effects your screenshot, please consider the name. Because you have whitespace after Spring, I assume you are missing something.", "author": "wu-sheng", "createdAt": "2020-07-21T13:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4MzQwMw=="}], "type": "inlineReview"}, {"oid": "c28e50d44c651e9e2ee4642fcff8ec1ff00fcb5a", "url": "https://github.com/apache/skywalking/commit/c28e50d44c651e9e2ee4642fcff8ec1ff00fcb5a", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-22T14:15:23Z", "type": "commit"}, {"oid": "3bda9027c3334f19555e7815867bcaeff2776f11", "url": "https://github.com/apache/skywalking/commit/3bda9027c3334f19555e7815867bcaeff2776f11", "message": "Add sleuth setup document", "committedDate": "2020-07-23T12:56:03Z", "type": "commit"}, {"oid": "33f40f3e838bb2726c341dacb4356e9eb2d15289", "url": "https://github.com/apache/skywalking/commit/33f40f3e838bb2726c341dacb4356e9eb2d15289", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-23T12:56:31Z", "type": "commit"}, {"oid": "9784374f05f93cf3baf4804e1b283052c36465e0", "url": "https://github.com/apache/skywalking/commit/9784374f05f93cf3baf4804e1b283052c36465e0", "message": "Update screenshot", "committedDate": "2020-07-23T13:35:48Z", "type": "commit"}, {"oid": "5eb22c92b8b5647d0df165f7ff32a09fb9860d56", "url": "https://github.com/apache/skywalking/commit/5eb22c92b8b5647d0df165f7ff32a09fb9860d56", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-23T13:52:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUyODM3OA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r459528378", "bodyText": "Please separate the cpm and latency on the dashboard. They use different units.", "author": "wu-sheng", "createdAt": "2020-07-23T15:16:54Z", "path": "docs/en/setup/backend/spring-sleuth-setup.md", "diffHunk": "@@ -0,0 +1,63 @@\n+# Spring sleuth setup\n+Spring Sleuth provides Spring Boot auto-configuration for distributed tracing. Skywalking integrates it's micrometer part, \n+and it can send metrics to the Skywalking [Meter System](./../../concepts-and-designs/meter.md).\n+\n+## Set up agent\n+\n+1. Add the Micrometer and Skywalking meter registry dependency into project `pom.xml` file. Also you could found more detail at [Toolkit micrometer](./../service-agent/java-agent/Application-toolkit-micrometer.md).\n+```xml\n+<dependency>\n+    <groupId>org.springframework.boot</groupId>\n+    <artifactId>spring-boot-starter-actuator</artifactId>\n+</dependency>\n+<dependency>\n+    <groupId>org.apache.skywalking</groupId>\n+    <artifactId>apm-toolkit-micrometer-registry</artifactId>\n+    <version>${skywalking.version}</version>\n+</dependency>\n+```\n+\n+2. Create the Skywalking meter resgitry into spring bean management.\n+```java\n+@Bean\n+SkywalkingMeterRegistry skywalkingMeterRegistry() {\n+    // Add rate configs If you need, otherwise using none args construct\n+    SkywalkingConfig config = new SkywalkingConfig(Arrays.asList(\"\"));\n+    return new SkywalkingMeterRegistry(config);\n+}\n+```\n+\n+## Set up backend receiver\n+\n+1. Enable meter receiver in the `applicaiton.yml`.\n+```yaml\n+receiver-meter:\n+  selector: ${SW_RECEIVER_METER:default}\n+  default:\n+```\n+\n+2. Configure the meter config file, It already has the [spring sleuth meter config](../../../../oap-server/server-bootstrap/src/main/resources/meter-receive-config/spring-sleuth.yaml).\n+If you also has some customized meter at the agent side, please read [meter document](backend-meter.md#meters-configure) to configure meter.\n+\n+## Add UI dashboard\n+\n+1. Open the dashboard view, click `edit` button to edit the templates.\n+\n+    ![Click edit button](http://skywalking.apache.org/screenshots/8.0.0/spring-sleuth-setup-ui-20200723-01.png)\n+\n+1. Create a new template. Template type: `Standard` -> Template Configuration: `Spring` -> Input the Template Name.\n+\n+    ![Create template](http://skywalking.apache.org/screenshots/8.0.0/spring-sleuth-setup-ui-20200723-02.png)\n+\n+1. Click `view` button, Finally get the spring sleuth dashboard.\n+\n+    ![Save template](http://skywalking.apache.org/screenshots/8.0.0/spring-sleuth-setup-ui-20200723-03.png)\n+    ![Spring Sleuth Dashboard](http://skywalking.apache.org/screenshots/8.0.0/spring-sleuth-setup-ui-20200723-04.png)\n+\n+## Supported meter\n+\n+Supported 3 types information: Application, System, JVM.\n+\n+1. Application: HTTP request count and duration, JDBC max/idle/active connection count.", "originalCommit": "5eb22c92b8b5647d0df165f7ff32a09fb9860d56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM5Mzc3OQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r460393779", "bodyText": "Has changed the dashboard.", "author": "mrproliu", "createdAt": "2020-07-25T11:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUyODM3OA=="}], "type": "inlineReview"}, {"oid": "04889ca489987648af81eb1ed167e0fafc8ec2b1", "url": "https://github.com/apache/skywalking/commit/04889ca489987648af81eb1ed167e0fafc8ec2b1", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-25T08:25:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM3OTU4OQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r460379589", "bodyText": "Suggestion: make all the methods in this interface default and throws new UnsupportedOperationException(), so that the subclasses can only override the methods they need, and don't need to override all the methods that they don't need.", "author": "kezhenxu94", "createdAt": "2020-07-25T08:03:26Z", "path": "oap-server/server-receiver-plugin/skywalking-meter-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/meter/provider/process/MeterEvalOperation.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.meter.provider.process;\n+\n+/**\n+ * Meter support calculate operation\n+ */\n+public interface MeterEvalOperation<FROM extends EvalData> {", "originalCommit": "5eb22c92b8b5647d0df165f7ff32a09fb9860d56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM5Mzc3MA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r460393770", "bodyText": "Thanks for simply the code.", "author": "mrproliu", "createdAt": "2020-07-25T11:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM3OTU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM3OTk5OQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r460379999", "bodyText": "From the exception message Only support multiply from single value, the condition should be if (!(data instanceof EvalSingleData)) so that it also applies when data instanceof EvalMultipleData or data instanceof other future subclass of EvalData", "author": "kezhenxu94", "createdAt": "2020-07-25T08:08:32Z", "path": "oap-server/server-receiver-plugin/skywalking-meter-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/meter/provider/process/EvalSingleData.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.meter.provider.process;\n+\n+import lombok.Data;\n+import org.apache.skywalking.apm.network.language.agent.v3.Label;\n+import org.apache.skywalking.apm.network.language.agent.v3.MeterSingleValue;\n+\n+import java.math.BigDecimal;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Support counter, gauge\n+ */\n+@Data\n+public class EvalSingleData extends EvalData<EvalData> {\n+\n+    private double value;\n+\n+    public static EvalSingleData build(MeterSingleValue value, MeterProcessor processor) {\n+        final EvalSingleData singleEvalData = new EvalSingleData();\n+        singleEvalData.name = value.getName();\n+        singleEvalData.labels = value.getLabelsList().stream()\n+            .collect(Collectors.toMap(Label::getName, Label::getValue));\n+        singleEvalData.processor = processor;\n+        singleEvalData.value = value.getValue();\n+        return singleEvalData;\n+    }\n+\n+    @Override\n+    public EvalData multiply(double value) {\n+        return copyTo(EvalSingleData.class, instance -> instance.value = this.value * value);\n+    }\n+\n+    @Override\n+    public EvalData multiply(EvalData data) {\n+        if (data instanceof EvalHistogramData) {\n+            throw new IllegalArgumentException(\"Only support multiply from single value\");\n+        }", "originalCommit": "5eb22c92b8b5647d0df165f7ff32a09fb9860d56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM5MzcwNQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r460393705", "bodyText": "Thanks, that's a good suggest.", "author": "mrproliu", "createdAt": "2020-07-25T11:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM3OTk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM4MDU4MQ==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r460380581", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            double rateVal = (sum - i._2) / ((now - i._1) / 1000);\n          \n          \n            \n                            double rateVal = (sum - i._2) / ((now - i._1) / 1000.0);", "author": "kezhenxu94", "createdAt": "2020-07-25T08:15:40Z", "path": "oap-server/server-receiver-plugin/skywalking-meter-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/meter/provider/process/Window.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.meter.provider.process;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import io.vavr.Function2;\n+import io.vavr.Tuple;\n+import io.vavr.Tuple2;\n+import lombok.EqualsAndHashCode;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+import java.time.Duration;\n+import java.util.LinkedList;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Agent base window. Using on counter function, such as rate, irate, increase.\n+ */\n+public class Window {\n+\n+    private static Map<String, Window> INSTANCE_WINDOW = new ConcurrentHashMap<>();\n+    private final Map<ID, Queue<Tuple2<Long, Double>>> windows = Maps.newHashMap();\n+\n+    private Window() {\n+    }\n+\n+    public static Window getWindow(String service, String serviceInstance) {\n+        return INSTANCE_WINDOW.computeIfAbsent(service + \"_\" + serviceInstance, k -> new Window());\n+    }\n+\n+    public Function2<CalculateType, String, Double> get(EvalSingleData data) {\n+        ID id = new ID(data.getName(), ImmutableMap.copyOf(data.getLabels()));\n+        return (calculateType, range) -> operateCounter(id, data.getValue(), calculateType, range);\n+    }\n+\n+    public Function2<CalculateType, String, Double> get(EvalHistogramData data, double bucket) {\n+        ID id = new ID(data.getName(), ImmutableMap.<String, String>builder()\n+            .putAll(data.getLabels()).put(\"_bucket\", String.valueOf(bucket)).build());\n+        return (calculateType, range) -> operateCounter(id, (double) data.getBuckets().get(bucket), calculateType, range);\n+    }\n+\n+    private Double operateCounter(ID id, Double sum, CalculateType calculateType, String range) {\n+        long now = System.currentTimeMillis();\n+        switch (calculateType) {\n+            case INCREASE:\n+                Tuple2<Long, Double> i = increase(sum, id, Duration.parse(range).toMillis());\n+                return sum - i._2;\n+            case RATE:\n+                i = increase(sum, id, Duration.parse(range).toMillis());\n+                double rateVal = (sum - i._2) / ((now - i._1) / 1000);", "originalCommit": "5eb22c92b8b5647d0df165f7ff32a09fb9860d56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM4MDU5MA==", "url": "https://github.com/apache/skywalking/pull/4972#discussion_r460380590", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            double iRateVal = (sum - i._2) / ((now - i._1) / 1000);\n          \n          \n            \n                            double iRateVal = (sum - i._2) / ((now - i._1) / 1000.0);", "author": "kezhenxu94", "createdAt": "2020-07-25T08:15:54Z", "path": "oap-server/server-receiver-plugin/skywalking-meter-receiver-plugin/src/main/java/org/apache/skywalking/oap/server/receiver/meter/provider/process/Window.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.receiver.meter.provider.process;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import io.vavr.Function2;\n+import io.vavr.Tuple;\n+import io.vavr.Tuple2;\n+import lombok.EqualsAndHashCode;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+import java.time.Duration;\n+import java.util.LinkedList;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Agent base window. Using on counter function, such as rate, irate, increase.\n+ */\n+public class Window {\n+\n+    private static Map<String, Window> INSTANCE_WINDOW = new ConcurrentHashMap<>();\n+    private final Map<ID, Queue<Tuple2<Long, Double>>> windows = Maps.newHashMap();\n+\n+    private Window() {\n+    }\n+\n+    public static Window getWindow(String service, String serviceInstance) {\n+        return INSTANCE_WINDOW.computeIfAbsent(service + \"_\" + serviceInstance, k -> new Window());\n+    }\n+\n+    public Function2<CalculateType, String, Double> get(EvalSingleData data) {\n+        ID id = new ID(data.getName(), ImmutableMap.copyOf(data.getLabels()));\n+        return (calculateType, range) -> operateCounter(id, data.getValue(), calculateType, range);\n+    }\n+\n+    public Function2<CalculateType, String, Double> get(EvalHistogramData data, double bucket) {\n+        ID id = new ID(data.getName(), ImmutableMap.<String, String>builder()\n+            .putAll(data.getLabels()).put(\"_bucket\", String.valueOf(bucket)).build());\n+        return (calculateType, range) -> operateCounter(id, (double) data.getBuckets().get(bucket), calculateType, range);\n+    }\n+\n+    private Double operateCounter(ID id, Double sum, CalculateType calculateType, String range) {\n+        long now = System.currentTimeMillis();\n+        switch (calculateType) {\n+            case INCREASE:\n+                Tuple2<Long, Double> i = increase(sum, id, Duration.parse(range).toMillis());\n+                return sum - i._2;\n+            case RATE:\n+                i = increase(sum, id, Duration.parse(range).toMillis());\n+                double rateVal = (sum - i._2) / ((now - i._1) / 1000);\n+                return Objects.equals(rateVal, Double.NaN) ? 0d : rateVal;\n+            case IRATE:\n+                i = increase(sum, id, 0);\n+                double iRateVal = (sum - i._2) / ((now - i._1) / 1000);", "originalCommit": "5eb22c92b8b5647d0df165f7ff32a09fb9860d56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a50bdc19da9bce3ac9441c68ddcaa0f5c95f5e76", "url": "https://github.com/apache/skywalking/commit/a50bdc19da9bce3ac9441c68ddcaa0f5c95f5e76", "message": "1. Fix e2e, e2e\n2. Change Spring Sleuth dashboard UI config", "committedDate": "2020-07-25T11:01:51Z", "type": "commit"}, {"oid": "22d10e01ad38728c1171a57aa698d7a494724047", "url": "https://github.com/apache/skywalking/commit/22d10e01ad38728c1171a57aa698d7a494724047", "message": "Merge branch 'master' into server-side-meter", "committedDate": "2020-07-25T11:04:15Z", "type": "commit"}, {"oid": "883c4c2dc2e449600f78a6d19ae9c50779221d8d", "url": "https://github.com/apache/skywalking/commit/883c4c2dc2e449600f78a6d19ae9c50779221d8d", "message": "Add unimplemented subclass of MeterEvalOperation UT", "committedDate": "2020-07-25T12:16:00Z", "type": "commit"}, {"oid": "a36b28c1ab70c249c9d533bc11d0dfd0b5ebe106", "url": "https://github.com/apache/skywalking/commit/a36b28c1ab70c249c9d533bc11d0dfd0b5ebe106", "message": "Fix missing Licence", "committedDate": "2020-07-25T12:16:36Z", "type": "commit"}]}