{"pr_number": 4416, "pr_title": "Provide profile exporter tool", "pr_createdAt": "2020-02-25T09:43:19Z", "pr_url": "https://github.com/apache/skywalking/pull/4416", "timeline": [{"oid": "d2330550ae73d767203e83f79737b5b4f6fffff3", "url": "https://github.com/apache/skywalking/commit/d2330550ae73d767203e83f79737b5b4f6fffff3", "message": "provide profile export tools", "committedDate": "2020-02-24T13:25:05Z", "type": "commit"}, {"oid": "7b0f0fa9c4a3392df00d637a8c9a3163e9043d2e", "url": "https://github.com/apache/skywalking/commit/7b0f0fa9c4a3392df00d637a8c9a3163e9043d2e", "message": "Merge remote-tracking branch 'remotes/upstream/master' into profile_exporter", "committedDate": "2020-02-25T03:58:31Z", "type": "commit"}, {"oid": "95cf9c2f570cc725aa329ffa4d30b2f6334b78c4", "url": "https://github.com/apache/skywalking/commit/95cf9c2f570cc725aa329ffa4d30b2f6334b78c4", "message": "add rand word on create h2 db file", "committedDate": "2020-02-25T05:32:42Z", "type": "commit"}, {"oid": "c001a9fd115db8050183d3014b03cd2afcf625b5", "url": "https://github.com/apache/skywalking/commit/c001a9fd115db8050183d3014b03cd2afcf625b5", "message": "add parsing code", "committedDate": "2020-02-25T08:24:11Z", "type": "commit"}, {"oid": "7a7850b2b35705788bfe2cfd90337eb6799d39eb", "url": "https://github.com/apache/skywalking/commit/7a7850b2b35705788bfe2cfd90337eb6799d39eb", "message": "rename docker file mapping base path", "committedDate": "2020-02-25T09:38:33Z", "type": "commit"}, {"oid": "4660678dfaa5c7df691add9868a938df1b891b52", "url": "https://github.com/apache/skywalking/commit/4660678dfaa5c7df691add9868a938df1b891b52", "message": "add none file block param on h2 storage", "committedDate": "2020-02-25T11:17:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzMjcwMQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384332701", "bodyText": "what's \"replace recheck\"?", "author": "kezhenxu94", "createdAt": "2020-02-26T08:22:11Z", "path": "oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.tool.profile.exporter;\n+\n+import lombok.Data;\n+\n+import java.io.File;\n+\n+@Data\n+public class ExporterConfig {\n+\n+    // profile task id\n+    private String taskId;\n+\n+    // profiled trace id\n+    private String traceId;\n+\n+    // export to file path\n+    private String analyzeResultDist;\n+\n+    /**\n+     * parse config from command line\n+     */\n+    public static ExporterConfig parse(String[] args) {\n+        if (args == null || args.length != 3) {\n+            throw new IllegalArgumentException(\"missing config, replace recheck\");", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0NzU4NQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r385047585", "bodyText": "I mean \"please recheck\", has fixed.", "author": "mrproliu", "createdAt": "2020-02-27T10:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzMjcwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzMjg5MA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384332890", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(analyzeResultDist + \" must a directory\");\n          \n          \n            \n                        throw new IllegalArgumentException(analyzeResultDist + \" must be a directory\");", "author": "kezhenxu94", "createdAt": "2020-02-26T08:22:42Z", "path": "oap-server/server-tools/tool-profile-snapshot-bootstrap/src/main/java/org/apache/skywalking/oap/server/tool/profile/exporter/ExporterConfig.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.tool.profile.exporter;\n+\n+import lombok.Data;\n+\n+import java.io.File;\n+\n+@Data\n+public class ExporterConfig {\n+\n+    // profile task id\n+    private String taskId;\n+\n+    // profiled trace id\n+    private String traceId;\n+\n+    // export to file path\n+    private String analyzeResultDist;\n+\n+    /**\n+     * parse config from command line\n+     */\n+    public static ExporterConfig parse(String[] args) {\n+        if (args == null || args.length != 3) {\n+            throw new IllegalArgumentException(\"missing config, replace recheck\");\n+        }\n+\n+        // build config\n+        ExporterConfig config = new ExporterConfig();\n+        config.setTaskId(args[0]);\n+        config.setTraceId(args[1]);\n+        config.setAnalyzeResultDist(args[2]);\n+\n+        return config;\n+    }\n+\n+    /**\n+     * initialize config, such as check dist path\n+     */\n+    public void init() {\n+        File dist = new File(analyzeResultDist);\n+        if (!dist.exists()) {\n+            dist.mkdirs();\n+            return;\n+        }\n+\n+        if (dist.isFile()) {\n+            throw new IllegalArgumentException(analyzeResultDist + \" must a directory\");", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzNDY0NQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384334645", "bodyText": "better to name it \"exporter\"? It's essentially an exporter, not a \"profile\"", "author": "kezhenxu94", "createdAt": "2020-02-26T08:26:43Z", "path": "apm-dist/src/main/assembly/binary.xml", "diffHunk": "@@ -75,6 +75,12 @@\n             <outputDirectory>/agent</outputDirectory>\r\n         </fileSet>\r\n \r\n+        <!-- Profile exporter tools -->\r\n+        <fileSet>\r\n+            <directory>${project.basedir}/../tools/profile</directory>\r\n+            <outputDirectory>/tools/profile</outputDirectory>\r", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0OTA5OA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r385049098", "bodyText": "Sure, should I need to add a subdirectory on the \"exporter\" named \"profile\"? Because there have multiple files.", "author": "mrproliu", "createdAt": "2020-02-27T10:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzNDY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4MTI0NA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r385481244", "bodyText": "Good to me", "author": "kezhenxu94", "createdAt": "2020-02-28T02:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzNDY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5NjM4Nw==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r385496387", "bodyText": "I think renaming makes more sense then going into a deeper path. profile-exporter is a tool already.", "author": "wu-sheng", "createdAt": "2020-02-28T03:55:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzNDY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384350395", "bodyText": "Is this a test? if not, seems not suitable to put it here", "author": "kezhenxu94", "createdAt": "2020-02-26T08:58:47Z", "path": "oap-server/server-tools/tool-profile-snapshot-bootstrap/src/test/java/org/apache/skywalking/oap/server/tool/profile/exporter/ProfileExportedAnalyze.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.skywalking.oap.server.tool.profile.exporter;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.skywalking.apm.network.language.profile.ThreadSnapshot;\n+import org.apache.skywalking.oap.server.core.query.entity.Span;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+public class ProfileExportedAnalyze {\n+\n+    public static void main(String[] args) throws IOException {", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0MzcxNA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384443714", "bodyText": "I will be working on analyze exported data files when getting some profile future feedback. If it not necessary, I will delete this file.", "author": "mrproliu", "createdAt": "2020-02-26T11:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1MTUyMA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384451520", "bodyText": "I will be working on analyze exported data files when getting some profile future feedback. If it not necessary, I will delete this file.\n\nWell, if this PR is still under construction, please use Draft a Pull Request, or add [WIP] in the title", "author": "kezhenxu94", "createdAt": "2020-02-26T12:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1ODU2MA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384458560", "bodyText": "I will be working on analyze exported data files when getting some profile future feedback. If it not necessary, I will delete this file.\n\nWell, if this PR is still under construction, please use Draft a Pull Request, or add [WIP] in the title\n\nSure. But this file is not in \"WIP\", maybe I need to delete it later.", "author": "mrproliu", "createdAt": "2020-02-26T12:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1MDM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1OTM1Mg==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384359352", "bodyText": "Seems the exporter doesn't depend on ES? Do you need two individual module?", "author": "kezhenxu94", "createdAt": "2020-02-26T09:11:26Z", "path": "oap-server/server-tools/pom.xml", "diffHunk": "@@ -0,0 +1,40 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Licensed to the Apache Software Foundation (ASF) under one or more\n+  ~ contributor license agreements.  See the NOTICE file distributed with\n+  ~ this work for additional information regarding copyright ownership.\n+  ~ The ASF licenses this file to You under the Apache License, Version 2.0\n+  ~ (the \"License\"); you may not use this file except in compliance with\n+  ~ the License.  You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  ~\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>oap-server</artifactId>\n+        <groupId>org.apache.skywalking</groupId>\n+        <version>7.0.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>server-tools</artifactId>\n+    <packaging>pom</packaging>\n+    <modules>\n+        <module>tool-profile-snapshot-server-mock</module>\n+        <module>tool-profile-snapshot-bootstrap</module>\n+        <module>tool-profile-snapshot-exporter</module>\n+        <module>tool-profile-snapshot-exporter-es7</module>", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTAzMQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384445031", "bodyText": "It will use ES storage to dump trace and thread snapshots data, need to use ES7 to re-compile it.", "author": "mrproliu", "createdAt": "2020-02-26T11:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1OTM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2MDc5Mw==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384360793", "bodyText": "Are these comments copied-and-pasted? Do them make sense in this file?", "author": "kezhenxu94", "createdAt": "2020-02-26T09:14:04Z", "path": "tools/profile/profile_exporter.sh", "diffHunk": "@@ -0,0 +1,107 @@\n+#!/usr/bin/env bash\n+\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# This script relies on few environment variables to determine source code package\n+# behavior, those variables are:\n+#   RELEASE_VERSION -- The version of this source package.\n+# For example: RELEASE_VERSION=5.0.0-alpha", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0Njg3NQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r385046875", "bodyText": "Deleted.", "author": "mrproliu", "createdAt": "2020-02-27T10:43:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2MDc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2MjQyMA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384362420", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              && echo \"Cannot found oap application.yml\" \\\n          \n          \n            \n              && echo \"Cannot find oap application.yml\" \\", "author": "kezhenxu94", "createdAt": "2020-02-26T09:16:59Z", "path": "tools/profile/profile_exporter.sh", "diffHunk": "@@ -0,0 +1,107 @@\n+#!/usr/bin/env bash\n+\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# This script relies on few environment variables to determine source code package\n+# behavior, those variables are:\n+#   RELEASE_VERSION -- The version of this source package.\n+# For example: RELEASE_VERSION=5.0.0-alpha\n+\n+bin_path=$0\n+exporter_dir=$(cd $(dirname $0); pwd)\n+\n+while [[ $# -gt 0 ]]; do\n+  case \"$1\" in\n+    --taskid=*)\n+      task_id=${1#*=}\n+      ;;\n+    --traceid=*)\n+      trace_id=${1#*=}\n+      ;;\n+    *)\n+      dist=$1\n+  esac\n+  shift\n+done\n+\n+echo \"${task_id}, ${trace_id}, ${dist}, ${workdir}, ${bin_path}\"\n+\n+[[ ! ${task_id} || ! ${trace_id} || ! ${dist} ]] \\\n+  && echo 'Usage: sh tools/profile_exporter.sh [--taskid] [--traceid] export_path' \\\n+  && exit 1\n+\n+[[ ! -d ${dist} ]] \\\n+  && echo \"Cannot found export dist path: ${dist}\" \\\n+  && exit 1\n+\n+# prepare paths\n+config_file=\"${exporter_dir}/../../config/application.yml\"\n+oap_libs_dir=\"${exporter_dir}/../../oap-libs\"\n+exporter_log_file=\"${exporter_dir}/profile_exporter_log4j2.xml\"\n+awk_change_file=\"${exporter_dir}/persist_core_and_storage.awk\"\n+[[ ! -f ${config_file} ]] \\\n+  && echo \"Cannot found oap application.yml\" \\", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2MjUwNQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384362505", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              && echo \"Cannot found oap libs path\" \\\n          \n          \n            \n              && echo \"Cannot find oap libs path\" \\", "author": "kezhenxu94", "createdAt": "2020-02-26T09:17:08Z", "path": "tools/profile/profile_exporter.sh", "diffHunk": "@@ -0,0 +1,107 @@\n+#!/usr/bin/env bash\n+\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# This script relies on few environment variables to determine source code package\n+# behavior, those variables are:\n+#   RELEASE_VERSION -- The version of this source package.\n+# For example: RELEASE_VERSION=5.0.0-alpha\n+\n+bin_path=$0\n+exporter_dir=$(cd $(dirname $0); pwd)\n+\n+while [[ $# -gt 0 ]]; do\n+  case \"$1\" in\n+    --taskid=*)\n+      task_id=${1#*=}\n+      ;;\n+    --traceid=*)\n+      trace_id=${1#*=}\n+      ;;\n+    *)\n+      dist=$1\n+  esac\n+  shift\n+done\n+\n+echo \"${task_id}, ${trace_id}, ${dist}, ${workdir}, ${bin_path}\"\n+\n+[[ ! ${task_id} || ! ${trace_id} || ! ${dist} ]] \\\n+  && echo 'Usage: sh tools/profile_exporter.sh [--taskid] [--traceid] export_path' \\\n+  && exit 1\n+\n+[[ ! -d ${dist} ]] \\\n+  && echo \"Cannot found export dist path: ${dist}\" \\\n+  && exit 1\n+\n+# prepare paths\n+config_file=\"${exporter_dir}/../../config/application.yml\"\n+oap_libs_dir=\"${exporter_dir}/../../oap-libs\"\n+exporter_log_file=\"${exporter_dir}/profile_exporter_log4j2.xml\"\n+awk_change_file=\"${exporter_dir}/persist_core_and_storage.awk\"\n+[[ ! -f ${config_file} ]] \\\n+  && echo \"Cannot found oap application.yml\" \\\n+  && exit 1\n+[[ ! -d ${oap_libs_dir} ]] \\\n+  && echo \"Cannot found oap libs path\" \\", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2MzkyMw==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384363923", "bodyText": "dist seems not to be a good name, we use dist in other tests to represent the distribution package", "author": "kezhenxu94", "createdAt": "2020-02-26T09:19:54Z", "path": "tools/profile/profile_exporter.sh", "diffHunk": "@@ -0,0 +1,107 @@\n+#!/usr/bin/env bash\n+\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# This script relies on few environment variables to determine source code package\n+# behavior, those variables are:\n+#   RELEASE_VERSION -- The version of this source package.\n+# For example: RELEASE_VERSION=5.0.0-alpha\n+\n+bin_path=$0\n+exporter_dir=$(cd $(dirname $0); pwd)\n+\n+while [[ $# -gt 0 ]]; do\n+  case \"$1\" in\n+    --taskid=*)\n+      task_id=${1#*=}\n+      ;;\n+    --traceid=*)\n+      trace_id=${1#*=}\n+      ;;\n+    *)\n+      dist=$1", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM3ODM2NA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384378364", "bodyText": "export_path is better.", "author": "wu-sheng", "createdAt": "2020-02-26T09:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2MzkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM2NDIxNQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r384364215", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # create current trace tempory path\n          \n          \n            \n            # create current trace temporary path", "author": "kezhenxu94", "createdAt": "2020-02-26T09:20:29Z", "path": "tools/profile/profile_exporter.sh", "diffHunk": "@@ -0,0 +1,107 @@\n+#!/usr/bin/env bash\n+\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# This script relies on few environment variables to determine source code package\n+# behavior, those variables are:\n+#   RELEASE_VERSION -- The version of this source package.\n+# For example: RELEASE_VERSION=5.0.0-alpha\n+\n+bin_path=$0\n+exporter_dir=$(cd $(dirname $0); pwd)\n+\n+while [[ $# -gt 0 ]]; do\n+  case \"$1\" in\n+    --taskid=*)\n+      task_id=${1#*=}\n+      ;;\n+    --traceid=*)\n+      trace_id=${1#*=}\n+      ;;\n+    *)\n+      dist=$1\n+  esac\n+  shift\n+done\n+\n+echo \"${task_id}, ${trace_id}, ${dist}, ${workdir}, ${bin_path}\"\n+\n+[[ ! ${task_id} || ! ${trace_id} || ! ${dist} ]] \\\n+  && echo 'Usage: sh tools/profile_exporter.sh [--taskid] [--traceid] export_path' \\\n+  && exit 1\n+\n+[[ ! -d ${dist} ]] \\\n+  && echo \"Cannot found export dist path: ${dist}\" \\\n+  && exit 1\n+\n+# prepare paths\n+config_file=\"${exporter_dir}/../../config/application.yml\"\n+oap_libs_dir=\"${exporter_dir}/../../oap-libs\"\n+exporter_log_file=\"${exporter_dir}/profile_exporter_log4j2.xml\"\n+awk_change_file=\"${exporter_dir}/persist_core_and_storage.awk\"\n+[[ ! -f ${config_file} ]] \\\n+  && echo \"Cannot found oap application.yml\" \\\n+  && exit 1\n+[[ ! -d ${oap_libs_dir} ]] \\\n+  && echo \"Cannot found oap libs path\" \\\n+  && exit 1\n+\n+# create current trace tempory path", "originalCommit": "4660678dfaa5c7df691add9868a938df1b891b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a0d418afd2a46cbd964fad56ee6454840e4b760", "url": "https://github.com/apache/skywalking/commit/0a0d418afd2a46cbd964fad56ee6454840e4b760", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-02-27T10:35:26Z", "type": "commit"}, {"oid": "3ebdc4b6b44856e818cad412e51a39fc768586eb", "url": "https://github.com/apache/skywalking/commit/3ebdc4b6b44856e818cad412e51a39fc768586eb", "message": "fix naming issues", "committedDate": "2020-02-27T10:42:36Z", "type": "commit"}, {"oid": "c3c23391dcaa70f135e0c149fec54b33294dfc07", "url": "https://github.com/apache/skywalking/commit/c3c23391dcaa70f135e0c149fec54b33294dfc07", "message": "fix profile exporter e2e test failure issue", "committedDate": "2020-02-28T02:40:50Z", "type": "commit"}, {"oid": "17ef6d8b29dbb7e73885b67f33d3dd944fe6a9e7", "url": "https://github.com/apache/skywalking/commit/17ef6d8b29dbb7e73885b67f33d3dd944fe6a9e7", "message": "add document, local debug main method", "committedDate": "2020-02-28T13:51:01Z", "type": "commit"}, {"oid": "3c4aea5a452a3e92c7346ec06f07b9922eada234", "url": "https://github.com/apache/skywalking/commit/3c4aea5a452a3e92c7346ec06f07b9922eada234", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-02-28T13:53:41Z", "type": "commit"}, {"oid": "d36d2c81cbab427fd6087aef8081061cedfb9b2f", "url": "https://github.com/apache/skywalking/commit/d36d2c81cbab427fd6087aef8081061cedfb9b2f", "message": "using h2 dokcer to fix e2e test", "committedDate": "2020-02-29T02:56:32Z", "type": "commit"}, {"oid": "f9bc9b22dd9201fc1a4f97195a1914ca1b0099e1", "url": "https://github.com/apache/skywalking/commit/f9bc9b22dd9201fc1a4f97195a1914ca1b0099e1", "message": "fix code structure issue", "committedDate": "2020-02-29T03:46:28Z", "type": "commit"}, {"oid": "3426cc302a4c832e9c65737cd193a34e6e0723ad", "url": "https://github.com/apache/skywalking/commit/3426cc302a4c832e9c65737cd193a34e6e0723ad", "message": "fix maven child module declare", "committedDate": "2020-02-29T03:52:34Z", "type": "commit"}, {"oid": "01a12fb29028f81fd8e574c64a8b63c296acb5ee", "url": "https://github.com/apache/skywalking/commit/01a12fb29028f81fd8e574c64a8b63c296acb5ee", "message": "fix missing module package type declare", "committedDate": "2020-02-29T05:14:07Z", "type": "commit"}, {"oid": "defda8e793f46c54429e26e9343ee48fbbc1fe3b", "url": "https://github.com/apache/skywalking/commit/defda8e793f46c54429e26e9343ee48fbbc1fe3b", "message": "fix missing shell path commit", "committedDate": "2020-02-29T06:07:36Z", "type": "commit"}, {"oid": "4c5621ab831ba707f112c34427a9b1f3833acb50", "url": "https://github.com/apache/skywalking/commit/4c5621ab831ba707f112c34427a9b1f3833acb50", "message": "adding exporter unit test", "committedDate": "2020-02-29T08:54:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNzYyNA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r386027624", "bodyText": "Is it suitable to put this kind of tool in the test scope?\n\n\nUsers have to clone the entire codebase, and set up the development environment, just to run this class?\n\n\nPutting a standalone tool class in the test scope is just weird, IMHO, only auto-tests should locate in the test scope;\n\n\nProfileExportedAnalyze is not a \"test\" essentially\n\n\nWhy not make it another tool?\nWDYT @wu-sheng", "author": "kezhenxu94", "createdAt": "2020-02-29T13:13:58Z", "path": "docs/en/guides/backend-profile.md", "diffHunk": "@@ -47,3 +47,6 @@ The reason for generating multiple top-level trees is that original data can be\n     1. Use the same traversal node logic as in the `Combine stack trees` step. Convert to a GraphQL data structure, and put all nodes into a list for subsequent duration calculations.\n     2. Calculate each node's duration in parallel. For each node, sort the sequences, if there are two continuous sequences, the duration should add the duration of these two seq's timestamp.\n     3. Calculate each node execution in parallel. For each node, the duration of the current node should minus the time consumed by all children.\n+\n+## Profile data debug\n+Please follow the [exporter tool](backend-profile-export.md#export-command-line-usage) to package profile data. Unzip the profile data and using [analyzer main function](../../../oap-server/server-tools/tool-profile-snapshot-bootstrap/src/test/java/org/apache/skywalking/oap/server/tool/profile/exporter/ProfileExportedAnalyze.java) to run it.", "originalCommit": "4c5621ab831ba707f112c34427a9b1f3833acb50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNzk3NQ==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r386027975", "bodyText": "Because it isn't a tool. You need the IDE to run and debug the codes. This is for developer only. The only case we use this, is user reported an unexpected analysis result, and we are trying to find out why.", "author": "wu-sheng", "createdAt": "2020-02-29T13:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNzYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA4MDAxMw==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r386080013", "bodyText": "well make sense then", "author": "kezhenxu94", "createdAt": "2020-03-01T06:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyNzYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyOTIyMg==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r386029222", "bodyText": "\ufffdShould not have a question mark.", "author": "wu-sheng", "createdAt": "2020-02-29T13:43:32Z", "path": "docs/en/FAQ/README.md", "diffHunk": "@@ -21,3 +21,4 @@ These are known and common FAQs. We welcome you to contribute yours.\n * [\"FORBIDDEN/12/index read-only / allow delete (api)\" appears in the log](https://discuss.elastic.co/t/forbidden-12-index-read-only-allow-delete-api/110282)\n * [No data shown and backend replies with \"Variable 'serviceId' has coerced Null value for NonNull type 'ID!'\"](time-and-timezone.md)\n * [**Unexpected endpoint register** warning after 6.6.0](Unexpected-endpoint-register.md)\n+* [Use the profile exporter tool if the profile analysis is not right?](../guides/backend-profile-export.md)", "originalCommit": "4c5621ab831ba707f112c34427a9b1f3833acb50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAyOTI2Nw==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r386029267", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - [Exporter tool of profile raw data](backend-profile-export.md) introduces when the visualization doesn't work well through the official UI, how to package the original profile data, which helps the users submit the issue to report.\n          \n          \n            \n            - [Exporter tool of profile raw data](backend-profile-export.md) introduces when the visualization doesn't work well through the official UI, how to package the original profile data, which helps the users report the issue.", "author": "wu-sheng", "createdAt": "2020-02-29T13:44:26Z", "path": "docs/en/guides/README.md", "diffHunk": "@@ -146,6 +146,7 @@ miss any newly-added dependency:\n The performance profile is an enhancement feature in the APM system. We are using the thread dump to estimate the method execution time, rather than adding many local spans. In this way, the resource cost would be much less than using distributed tracing to locate slow method. This feature is suitable in the production environment. The following documents are important for developers to understand the key parts of this feature\n - [Profile data report procotol](https://github.com/apache/skywalking-data-collect-protocol/tree/master/profile) is provided like other trace, JVM data through gRPC.\n - [Thread dump merging mechanism](backend-profile.md) introduces the merging mechanism, which helps the end users to understand the profile report.\n+- [Exporter tool of profile raw data](backend-profile-export.md) introduces when the visualization doesn't work well through the official UI, how to package the original profile data, which helps the users submit the issue to report.", "originalCommit": "4c5621ab831ba707f112c34427a9b1f3833acb50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccb0bca6716d9bad1710c4a810238826a883f8b5", "url": "https://github.com/apache/skywalking/commit/ccb0bca6716d9bad1710c4a810238826a883f8b5", "message": "change document", "committedDate": "2020-02-29T13:52:01Z", "type": "commit"}, {"oid": "263e5fcdd281ab8c7acdcc203d12a3940933ddc5", "url": "https://github.com/apache/skywalking/commit/263e5fcdd281ab8c7acdcc203d12a3940933ddc5", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-02-29T14:39:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjExNzEzOA==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r386117138", "bodyText": "Why use awk? Using the user changed application.yml is very dangerous. We should not count on that.\nPlease use the separated YAML file including the minimal content, only necessary modules and providers. Then, document should be updated by following this change request.", "author": "wu-sheng", "createdAt": "2020-03-01T15:29:38Z", "path": "tools/profile-exporter/profile_exporter.sh", "diffHunk": "@@ -0,0 +1,100 @@\n+#!/usr/bin/env bash\n+\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+bin_path=$0\n+exporter_dir=$(cd $(dirname $0); pwd)\n+\n+while [[ $# -gt 0 ]]; do\n+  case \"$1\" in\n+    --taskid=*)\n+      task_id=${1#*=}\n+      ;;\n+    --traceid=*)\n+      trace_id=${1#*=}\n+      ;;\n+    *)\n+      export_path=$1\n+  esac\n+  shift\n+done\n+\n+[[ ! ${task_id} || ! ${trace_id} || ! ${export_path} ]] \\\n+  && echo 'Usage: sh tools/profile-exporter/profile_exporter.sh [--taskid] [--traceid] export_path' \\\n+  && exit 1\n+\n+[[ ! -d ${export_path} ]] \\\n+  && echo \"Cannot find export export_path path: ${export_path}\" \\\n+  && exit 1\n+\n+# prepare paths\n+config_file=\"${exporter_dir}/../../config/application.yml\"\n+oap_libs_dir=\"${exporter_dir}/../../oap-libs\"\n+exporter_log_file=\"${exporter_dir}/profile_exporter_log4j2.xml\"\n+awk_change_file=\"${exporter_dir}/persist_core_and_storage.awk\"", "originalCommit": "263e5fcdd281ab8c7acdcc203d12a3940933ddc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2be505549b0fc7cd0c47c79e25ebe4358b8c8430", "url": "https://github.com/apache/skywalking/commit/2be505549b0fc7cd0c47c79e25ebe4358b8c8430", "message": "remove auto generate tool config file", "committedDate": "2020-03-03T15:53:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwNzU3Mg==", "url": "https://github.com/apache/skywalking/pull/4416#discussion_r387407572", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            1. Copy `storage` config from `config/application.yml` into `tools/profile-exporter/application.yml`, make sure they are using the same storage config.\n          \n          \n            \n            1. Set the storage in `tools/profile-exporter/application.yml` file by following your use case.", "author": "wu-sheng", "createdAt": "2020-03-04T01:55:30Z", "path": "docs/en/guides/backend-profile-export.md", "diffHunk": "@@ -2,22 +2,23 @@\n When the visualization doesn't work well through the official UI, users could submit the issue to report. This tool helps the users to package the original profile data for helping the community to locate the issue in the user case. NOTICE, this report includes the class name, method name, line number, etc. Before submit this, please make sure this wouldn't become your system vulnerability.\n \n ## Export command line Usage\n+1. Copy `storage` config from `config/application.yml` into `tools/profile-exporter/application.yml`, make sure they are using the same storage config.", "originalCommit": "2be505549b0fc7cd0c47c79e25ebe4358b8c8430", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ca6f1146783d7a6ecf9d2d1d64a0f10655a3db0", "url": "https://github.com/apache/skywalking/commit/8ca6f1146783d7a6ecf9d2d1d64a0f10655a3db0", "message": "change document description", "committedDate": "2020-03-04T03:30:39Z", "type": "commit"}, {"oid": "0b2ee57f03b4a3df909496eb046f754cfec4b6d9", "url": "https://github.com/apache/skywalking/commit/0b2ee57f03b4a3df909496eb046f754cfec4b6d9", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-03-04T03:31:02Z", "type": "commit"}, {"oid": "ad6bcdc82fdf1d9d61ab16c72763f983a6cf3ab3", "url": "https://github.com/apache/skywalking/commit/ad6bcdc82fdf1d9d61ab16c72763f983a6cf3ab3", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-03-04T06:47:51Z", "type": "commit"}, {"oid": "e9a02436b2398ec67bcd16a12a5ecebdcdeb4248", "url": "https://github.com/apache/skywalking/commit/e9a02436b2398ec67bcd16a12a5ecebdcdeb4248", "message": "make CoreModuleConfig has public construct", "committedDate": "2020-03-04T07:05:02Z", "type": "commit"}, {"oid": "7a5cb6c8c0e4ce47432d6afa0cc9a56d27dd49e5", "url": "https://github.com/apache/skywalking/commit/7a5cb6c8c0e4ce47432d6afa0cc9a56d27dd49e5", "message": "Merge branch 'master' into profile_exporter", "committedDate": "2020-03-04T09:31:12Z", "type": "commit"}]}