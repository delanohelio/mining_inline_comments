{"pr_number": 5084, "pr_title": "#4907 - Duplicate Spring MVC endpoint fix", "pr_createdAt": "2020-07-11T14:03:36Z", "pr_url": "https://github.com/apache/skywalking/pull/5084", "timeline": [{"oid": "8fdc8762682b48eb93173449bd0b7bc6250c5fe5", "url": "https://github.com/apache/skywalking/commit/8fdc8762682b48eb93173449bd0b7bc6250c5fe5", "message": "fixes #4907", "committedDate": "2020-07-11T14:03:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1NTY5Ng==", "url": "https://github.com/apache/skywalking/pull/5084#discussion_r453255696", "bodyText": "The requestURL is updated after addPathMapping. This means it will use {POST}/url the first time the endpoint is hit and then fall back to /url every time it's hit afterward.\n\nI think you just need move original L86 after L87. The way you changing right now, will make the cache invalid. RIght?", "author": "wu-sheng", "createdAt": "2020-07-12T01:59:44Z", "path": "apm-sniffer/apm-sdk-plugin/spring-plugins/mvc-annotation-commons/src/main/java/org/apache/skywalking/apm/plugin/spring/mvc/commons/interceptor/AbstractMethodInterceptor.java", "diffHunk": "@@ -82,11 +82,9 @@ public void beforeMethod(EnhancedInstance objInst, Method method, Object[] allAr\n             EnhanceRequireObjectCache pathMappingCache = (EnhanceRequireObjectCache) objInst.getSkyWalkingDynamicField();\n             String requestURL = pathMappingCache.findPathMapping(method);\n             if (requestURL == null) {\n-                requestURL = getRequestURL(method);\n-                pathMappingCache.addPathMapping(method, requestURL);\n-                requestURL = getAcceptedMethodTypes(method) + pathMappingCache.findPathMapping(method);\n+                pathMappingCache.addPathMapping(method, getRequestURL(method));\n             }\n-            operationName = requestURL;\n+            operationName = getAcceptedMethodTypes(method) + pathMappingCache.findPathMapping(method);", "originalCommit": "8fdc8762682b48eb93173449bd0b7bc6250c5fe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI5Njc4NA==", "url": "https://github.com/apache/skywalking/pull/5084#discussion_r454296784", "bodyText": "I've taken a look at this and moving L87 to L86 is not ideal because of this line:\n\n  \n    \n      skywalking/apm-sniffer/apm-sdk-plugin/spring-plugins/mvc-annotation-commons/src/main/java/org/apache/skywalking/apm/plugin/spring/mvc/commons/PathMappingCache.java\n    \n    \n         Line 52\n      in\n      c5972c2\n    \n    \n    \n    \n\n        \n          \n           methodPathMapping.put(method, (classPath + methodPath).replace(\"//\", \"/\")); \n        \n    \n  \n\n\nThis appends whatever URL is to be cached to a method with classPath. Meaning a method annotated with @RequestMapping(\"/test\", method = RequestMethod.GET) which falls under a class annotated with @RequestMapping(\"/case\") will result in the URL /case/{GET}/test being cached to the method.", "author": "BFergerson", "createdAt": "2020-07-14T11:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1NTY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzMzY1OA==", "url": "https://github.com/apache/skywalking/pull/5084#discussion_r454433658", "bodyText": "My point is, there is a logic error above. execute pathMappingCache.findPathMapping(method) twice if cache found.", "author": "wu-sheng", "createdAt": "2020-07-14T15:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI1NTY5Ng=="}], "type": "inlineReview"}, {"oid": "00b0d6eecff37ad01c1c188d5d94093ba951ffdc", "url": "https://github.com/apache/skywalking/commit/00b0d6eecff37ad01c1c188d5d94093ba951ffdc", "message": "alternate fix", "committedDate": "2020-07-13T06:45:58Z", "type": "commit"}, {"oid": "48be3d23810aad586cbf2096d076f0d5f08377c7", "url": "https://github.com/apache/skywalking/commit/48be3d23810aad586cbf2096d076f0d5f08377c7", "message": "Merge pull request #1 from apache/master\n\nmerge up", "committedDate": "2020-07-13T08:27:26Z", "type": "commit"}, {"oid": "157fef8668a7223ff0fd0bfd917720c51a69a951", "url": "https://github.com/apache/skywalking/commit/157fef8668a7223ff0fd0bfd917720c51a69a951", "message": "Merge pull request #2 from BFergerson/master\n\nmerge up", "committedDate": "2020-07-13T08:28:07Z", "type": "commit"}, {"oid": "ac4c9c541a70831911aa16876f436b4084f7db3b", "url": "https://github.com/apache/skywalking/commit/ac4c9c541a70831911aa16876f436b4084f7db3b", "message": "Revert \"alternate fix\"\nThis reverts commit 00b0d6ee", "committedDate": "2020-07-14T11:25:30Z", "type": "commit"}, {"oid": "5455ea5859c9d6973e38700c8c0ff944a1a91951", "url": "https://github.com/apache/skywalking/commit/5455ea5859c9d6973e38700c8c0ff944a1a91951", "message": "Merge remote-tracking branch 'origin/bf-work' into bf-work", "committedDate": "2020-07-14T11:36:32Z", "type": "commit"}, {"oid": "1ecbace56ef67ed659b24b3fa99a5acdb1180ddd", "url": "https://github.com/apache/skywalking/commit/1ecbace56ef67ed659b24b3fa99a5acdb1180ddd", "message": "Update AbstractMethodInterceptor.java", "committedDate": "2020-07-14T15:32:37Z", "type": "commit"}, {"oid": "9305a07b0cf9b1961fbf223c271be776d77662d8", "url": "https://github.com/apache/skywalking/commit/9305a07b0cf9b1961fbf223c271be776d77662d8", "message": "Merge branch 'master' into bf-work", "committedDate": "2020-07-14T15:33:34Z", "type": "commit"}]}