{"pr_number": 5835, "pr_title": "Observing Istio control plane ", "pr_createdAt": "2020-11-12T12:30:52Z", "pr_url": "https://github.com/apache/skywalking/pull/5835", "timeline": [{"oid": "798385aca1f500d486bc516c803489211050ef47", "url": "https://github.com/apache/skywalking/commit/798385aca1f500d486bc516c803489211050ef47", "message": "Add Istio control plane otel MAL expressions and UI template\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-12T09:32:57Z", "type": "commit"}, {"oid": "876a9e5f194fb34e329abd319bcc8d4cea61f293", "url": "https://github.com/apache/skywalking/commit/876a9e5f194fb34e329abd319bcc8d4cea61f293", "message": "Remove OpenCensus receiver, add OpenTelemetry receiver\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-12T12:23:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5MDExMA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r522090110", "bodyText": "I have noted this before. As a gRPC server, actually, you could re-use sharing-server or core-server, rather than open new port.", "author": "wu-sheng", "createdAt": "2020-11-12T13:04:21Z", "path": "docs/en/setup/backend/backend-receivers.md", "diffHunk": "@@ -157,19 +157,19 @@ receiver_jaeger:\n \n NOTICE, Jaeger receiver is only provided in `apache-skywalking-apm-x.y.z.tar.gz` tar.\n \n-## Opencensus receiver\n+## OpenTelemetry receiver\n \n-Opencensus receiver supports to ingest agent metrics by meter-system. OAP can load the configuration at bootstrap. \n-If the new configuration is not well-formed, OAP fails to start up. The files are located at `$CLASSPATH/oc-rules`.\n+OpenTelemetry receiver supports to ingest agent metrics by meter-system. OAP can load the configuration at bootstrap. \n+If the new configuration is not well-formed, OAP fails to start up. The files are located at `$CLASSPATH/otel-rules`.\n \n The file is written in YAML format, defined by the scheme described in [prometheus-fetcher](./backend-fetcher.md).\n-Notice, `receiver-oc` only support `metricsRules` node of scheme due to the push mode it opts to.\n+Notice, `receiver-otel` only support `metricsRules` node of scheme due to the push mode it opts to.\n \n-To active the `default` implementation:\n+To active the `oc` implementation which receives metrics the [OpenCensus exporter](https://github.com/open-telemetry/opentelemetry-collector/blob/master/exporter/opencensusexporter/README.md) pushes:\n ```yaml\n-receiver-oc:\n-  selector: ${SW_OC_RECEIVER:-}\n-  default:\n+receiver-otel:\n+  selector: ${SW_OC_RECEIVER:oc}\n+  oc:\n     gRPCHost: ${SW_OC_RECEIVER_GRPC_HOST:0.0.0.0}\n     gRPCPort: ${SW_OC_RECEIVER_GRPC_PORT:55678}", "originalCommit": "876a9e5f194fb34e329abd319bcc8d4cea61f293", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ2MzE4Mw==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528463183", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-11-23T04:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5MDExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5MDUwNg==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r522090506", "bodyText": "Could we consider to make oc as an attribute? I have a feeling, we need oc and otel up and running at the same time, in the future.", "author": "wu-sheng", "createdAt": "2020-11-12T13:05:02Z", "path": "docs/en/setup/backend/backend-receivers.md", "diffHunk": "@@ -157,19 +157,19 @@ receiver_jaeger:\n \n NOTICE, Jaeger receiver is only provided in `apache-skywalking-apm-x.y.z.tar.gz` tar.\n \n-## Opencensus receiver\n+## OpenTelemetry receiver\n \n-Opencensus receiver supports to ingest agent metrics by meter-system. OAP can load the configuration at bootstrap. \n-If the new configuration is not well-formed, OAP fails to start up. The files are located at `$CLASSPATH/oc-rules`.\n+OpenTelemetry receiver supports to ingest agent metrics by meter-system. OAP can load the configuration at bootstrap. \n+If the new configuration is not well-formed, OAP fails to start up. The files are located at `$CLASSPATH/otel-rules`.\n \n The file is written in YAML format, defined by the scheme described in [prometheus-fetcher](./backend-fetcher.md).\n-Notice, `receiver-oc` only support `metricsRules` node of scheme due to the push mode it opts to.\n+Notice, `receiver-otel` only support `metricsRules` node of scheme due to the push mode it opts to.\n \n-To active the `default` implementation:\n+To active the `oc` implementation which receives metrics the [OpenCensus exporter](https://github.com/open-telemetry/opentelemetry-collector/blob/master/exporter/opencensusexporter/README.md) pushes:\n ```yaml\n-receiver-oc:\n-  selector: ${SW_OC_RECEIVER:-}\n-  default:\n+receiver-otel:\n+  selector: ${SW_OC_RECEIVER:oc}\n+  oc:", "originalCommit": "876a9e5f194fb34e329abd319bcc8d4cea61f293", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ2MzIwMA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528463200", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-11-23T04:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5MDUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEwNDA0Mw==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r522104043", "bodyText": "I think following this #5035 is better, due to be friendly for use image.", "author": "wu-sheng", "createdAt": "2020-11-12T13:27:36Z", "path": "oap-server/server-bootstrap/src/main/resources/oc-rules/istio-controlplane.yaml", "diffHunk": "@@ -0,0 +1,117 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+enabled: true", "originalCommit": "876a9e5f194fb34e329abd319bcc8d4cea61f293", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ2MzMyMg==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528463322", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-11-23T04:07:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEwNDA0Mw=="}], "type": "inlineReview"}, {"oid": "e4b875d7ca2c5cb545de5060bb6a817b98ecc132", "url": "https://github.com/apache/skywalking/commit/e4b875d7ca2c5cb545de5060bb6a817b98ecc132", "message": "Sum trace count metrics\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-14T05:48:17Z", "type": "commit"}, {"oid": "043d9670c829acfa377a8c17c17a6a7a188ef2e0", "url": "https://github.com/apache/skywalking/commit/043d9670c829acfa377a8c17c17a6a7a188ef2e0", "message": "Merge branch 'master' into otel-istio", "committedDate": "2020-11-18T00:22:38Z", "type": "commit"}, {"oid": "260453dfb909e3b92ba9bdd7c91afb83d2df6b69", "url": "https://github.com/apache/skywalking/commit/260453dfb909e3b92ba9bdd7c91afb83d2df6b69", "message": "Transfer oc receiver to ot receiver\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-18T02:45:32Z", "type": "commit"}, {"oid": "853339cea4e56d4f4800ff35a30ed1f005dd12f6", "url": "https://github.com/apache/skywalking/commit/853339cea4e56d4f4800ff35a30ed1f005dd12f6", "message": "Merge remote-tracking branch 'origin/master' into otel-istio", "committedDate": "2020-11-18T02:45:50Z", "type": "commit"}, {"oid": "51251d5a7fba0ba56863eb8abb78c64cc2ed93d9", "url": "https://github.com/apache/skywalking/commit/51251d5a7fba0ba56863eb8abb78c64cc2ed93d9", "message": "Merge branch 'otel-istio' of github.com:apache/skywalking into otel-istio", "committedDate": "2020-11-18T02:49:01Z", "type": "commit"}, {"oid": "00b23cf5372224823ea51c46f173260fc40d2d4a", "url": "https://github.com/apache/skywalking/commit/00b23cf5372224823ea51c46f173260fc40d2d4a", "message": "Create indices on boot\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-18T13:47:33Z", "type": "commit"}, {"oid": "b3a6ba62e6b398e71c81de111f3504af5ee06f29", "url": "https://github.com/apache/skywalking/commit/b3a6ba62e6b398e71c81de111f3504af5ee06f29", "message": "Merge remote-tracking branch 'origin/master' into otel-istio", "committedDate": "2020-11-18T13:48:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEzOTYxMQ==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r526139611", "bodyText": "NULL_DEREFERENCE:  object ctx last assigned on line 46 could be null and is dereferenced at line 47.", "author": "sonatype-lift", "createdAt": "2020-11-18T14:41:22Z", "path": "oap-server/analyzer/meter-analyzer/src/main/java/org/apache/skywalking/oap/meter/analyzer/dsl/Expression.java", "diffHunk": "@@ -23,18 +23,35 @@\n import groovy.lang.GroovyObjectSupport;\n import groovy.util.DelegatingScript;\n import java.time.Instant;\n+import lombok.RequiredArgsConstructor;\n import lombok.extern.slf4j.Slf4j;\n \n /**\n  * Expression is a reusable monadic container type which represents a DSL expression.\n  */\n @Slf4j\n+@RequiredArgsConstructor\n public class Expression {\n \n+    private final String literal;\n+\n     private final DelegatingScript expression;\n \n-    Expression(DelegatingScript expression) {\n-        this.expression = expression;\n+    /**\n+     * Parse the expression statically.\n+     *\n+     * @return Parsed context of the expression.\n+     */\n+    public ExpressionParsingContext parse() {\n+        try (ExpressionParsingContext ctx = ExpressionParsingContext.create()) {\n+            ctx.downsampling = DownsamplingType.AVG;", "originalCommit": "b3a6ba62e6b398e71c81de111f3504af5ee06f29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ2MzI5Nw==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528463297", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-11-23T04:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEzOTYxMQ=="}], "type": "inlineReview"}, {"oid": "9c336559fe1cff0a519a4f4288f1db2c121a8f02", "url": "https://github.com/apache/skywalking/commit/9c336559fe1cff0a519a4f4288f1db2c121a8f02", "message": "Merge branch 'master' into otel-istio", "committedDate": "2020-11-23T02:20:57Z", "type": "commit"}, {"oid": "6a7512419ac18560762c79c728d0fbfc77b91570", "url": "https://github.com/apache/skywalking/commit/6a7512419ac18560762c79c728d0fbfc77b91570", "message": "Document istio metrics and otel receiver\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-23T03:53:26Z", "type": "commit"}, {"oid": "3f3a8b6623523ba84db7f0bea9d114149e61673e", "url": "https://github.com/apache/skywalking/commit/3f3a8b6623523ba84db7f0bea9d114149e61673e", "message": "Update CHANGES.md\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-23T03:59:59Z", "type": "commit"}, {"oid": "75ed9e65ef671a5ce39606fcd0469578acb6e387", "url": "https://github.com/apache/skywalking/commit/75ed9e65ef671a5ce39606fcd0469578acb6e387", "message": "Fix potential NPE\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-23T04:05:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5NDI5Mw==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528494293", "bodyText": "This doc should relate to Istio control panel right? This statement makes me feel a little strange. I think you mean,\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            NOTICE, if you want metrics of endpoint level, we recommend you to consider our [ALS solution](../envoy/als_setting.md)\n          \n          \n            \n            NOTICE, if you want metrics of Istio managed service, including topology among them, we recommend you to consider our [ALS solution](../envoy/als_setting.md)", "author": "wu-sheng", "createdAt": "2020-11-23T06:42:15Z", "path": "docs/en/setup/istio/README.md", "diffHunk": "@@ -1,28 +1,55 @@\n # Work with Istio\n \n-Instructions for transport Istio's metrics to SkyWalking OAP server.\n+Instructions for transport Istio's metrics to the SkyWalking OAP server.\n \n ## Prerequisites\n \n-Istio should be installed in kubernetes cluster. Follow [Istio getting start](https://istio.io/docs/setup/getting-started/)\n+Istio should be installed in the kubernetes cluster. Follow [Istio getting start](https://istio.io/docs/setup/getting-started/)\n to finish it.\n \n ## Deploy Skywalking backend\n \n-Follow the [deploying backend in kubernetes](../backend/backend-k8s.md) to install oap server in kubernetes cluster.\n+Follow the [deploying backend in kubernetes](../backend/backend-k8s.md) to install the OAP server in the kubernetes cluster.\n+Referring to [OpenTelemetry receiver](../backend/backend-receivers.md#OpenTelemetry-receiver) to ingest metrics.\n \n-## Setup Istio to send metrics to oap\n \n-Our scripts are wrote based on Istio 1.3.3.\n+## Deploy OpenTelemetry collector\n+OpenTelemetry collector is the location Istio telemetry sends metrics, then processing and sending them to SkyWalking\n+backend.\n \n-1. Install Istio metric template\n+Following the [Getting Started](https://opentelemetry.io/docs/collector/getting-started/) to deploy this collector. There \n+are several components available in the collector, and they could be combined for different scenarios.\n+ For the sake of brevity, we use the Prometheus receiver to retrieve metrics from Istio control and data plane, \n+ then send them to SkyWalking by OpenCensus exporter.\n \n-`kubectl apply -f https://raw.githubusercontent.com/istio/istio/1.3.3/mixer/template/metric/template.yaml`\n+#### Prometheus receiver\n+Refer to [Prometheus Receiver](https://github.com/open-telemetry/opentelemetry-collector/blob/master/receiver/prometheusreceiver/README.md)\n+ to set up this receiver. you could find more configuration details in [Prometheus Integration of Istio](https://istio.io/latest/docs/ops/integrations/prometheus/#configuration)\n+ to figure out how to direct Prometheus receiver to query Istio metrics.\n+ \n+SkyWalking supports receiving multi-cluster metrics in a single OAP cluster. A `cluster` label should be appended to every metric\n+fetched by this receiver even there's only a single cluster needed to be collected.\n+You could leverage `relabel` to add it like below:\n \n-2. Install SkyWalking adapter\n+```\n+relabel_configs:\n+- source_labels: []\n+  target_label: cluster\n+  replacement: <cluster name>\n+```\n \n-`kubectl apply -f skywalkingadapter.yml`\n+Notice, if you try the sample of istio Prometheus Kubernetes configuration, \n+the issues described [here](https://github.com/open-telemetry/opentelemetry-collector/issues/2163) might block you. \n+Try to use the solution indicated in this issue if it's not fixed.\n \n-Find the `skywalkingadapter.yml` at [here](yaml/skywalkingadapter.yml).\n+#### OpenCensus exporter\n+Follow [OpenCensus exporter configuration](https://github.com/open-telemetry/opentelemetry-collector/blob/master/exporter/opencensusexporter/README.md)\n+to set up a connection between OpenTelemetry collector and OAP cluster. `endpoint` is the address of OAP gRPC service.\n \n-NOTICE, due to Istio Mixer is default OFF, we recommend you to consider our [ALS solution](../envoy/als_setting.md)\n\\ No newline at end of file\n+## Observe Istio\n+\n+Open Istio Dashboard in SkyWaling UI by clicking `Dashboard` -> `Istio`, then you're able to view charts and diagrams\n+generated by Istio metrics. You also could view them by `swctl` and set up alarm rules based on them.\n+\n+\n+NOTICE, if you want metrics of endpoint level, we recommend you to consider our [ALS solution](../envoy/als_setting.md)", "originalCommit": "75ed9e65ef671a5ce39606fcd0469578acb6e387", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5NTIxMg==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528495212", "bodyText": "If you are removing this, I think you should remove other Istio related things. Isn't it?", "author": "wu-sheng", "createdAt": "2020-11-23T06:45:56Z", "path": "docs/en/setup/istio/yaml/skywalkingadapter.yml", "diffHunk": "@@ -1,77 +0,0 @@\n-# Licensed to the Apache Software Foundation (ASF) under one\n-# or more contributor license agreements.  See the NOTICE file\n-# distributed with this work for additional information\n-# regarding copyright ownership.  The ASF licenses this file\n-# to you under the Apache License, Version 2.0 (the\n-# \"License\"); you may not use this file except in compliance\n-# with the License.  You may obtain a copy of the License at\n-#\n-#     http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \"AS IS\" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-\n-apiVersion: \"config.istio.io/v1alpha2\"\n-kind: adapter", "originalCommit": "75ed9e65ef671a5ce39606fcd0469578acb6e387", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5ODUyOQ==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528498529", "bodyText": "it's good to me to remove all istio mixer relevant kinds of stuff: modules, document and etc.", "author": "hanahmily", "createdAt": "2020-11-23T06:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5NTIxMg=="}], "type": "inlineReview"}, {"oid": "42fc31fbaa92638ceb55c0e851c08137dfb7783c", "url": "https://github.com/apache/skywalking/commit/42fc31fbaa92638ceb55c0e851c08137dfb7783c", "message": "Update docs/en/setup/istio/README.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-11-23T06:50:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Njk1NA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528496954", "bodyText": "As you mentioned in other docs, these metrics with storage entities would be auto generated, as you activate all otel-oc rules in default. Is this a good idea? My concerns are\n\nName conflicting could happen easily, with we have incoming dolphinscheduler and shardingsphere dashboard with metrics system.\nUnit of values could be different due to different language tradition.\n\nCould you name these metrics starting with istio_ for now? And consider activating the rule explicitly? What do you think?", "author": "wu-sheng", "createdAt": "2020-11-23T06:52:32Z", "path": "oap-server/server-bootstrap/src/main/resources/otel-oc-rules/istio-controlplane.yaml", "diffHunk": "@@ -0,0 +1,113 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# This will parse a textual representation of a duration. The formats\n+# accepted are based on the ISO-8601 duration format {@code PnDTnHnMn.nS}\n+# with days considered to be exactly 24 hours.\n+# <p>\n+# Examples:\n+# <pre>\n+#    \"PT20.345S\" -- parses as \"20.345 seconds\"\n+#    \"PT15M\"     -- parses as \"15 minutes\" (where a minute is 60 seconds)\n+#    \"PT10H\"     -- parses as \"10 hours\" (where an hour is 3600 seconds)\n+#    \"P2D\"       -- parses as \"2 days\" (where a day is 24 hours or 86400 seconds)\n+#    \"P2DT3H4M\"  -- parses as \"2 days, 3 hours and 4 minutes\"\n+#    \"P-6H3M\"    -- parses as \"-6 hours and +3 minutes\"\n+#    \"-P6H3M\"    -- parses as \"-6 hours and -3 minutes\"\n+#    \"-P-6H+3M\"  -- parses as \"+6 hours and -3 minutes\"\n+# </pre>\n+defaultMetricLevel: service(['cluster', 'app'])\n+metricsRules:", "originalCommit": "75ed9e65ef671a5ce39606fcd0469578acb6e387", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0NzM5NA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528547394", "bodyText": "as you activate all otel-oc rules in default.\nNo, otel-oc defaults to be disabled. As I mentioned in istio metrics doc, users have to enable this receiver by hand.\n\nBut the potential conflict is a critical point that should be fixed. My preference is to fix it in \u201cgroup\u201d PR that will append the group name to metrics in a single rule file. As you mentioned, incoming dolphinscheduler and ss don't only need it, but existing agent metrics, prom, and otel also.", "author": "hanahmily", "createdAt": "2020-11-23T08:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Njk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0OTYyMA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528549620", "bodyText": "What do you mean group PR? Are you going to add a new concept?", "author": "wu-sheng", "createdAt": "2020-11-23T08:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Njk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU1MDA2Mg==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r528550062", "bodyText": "I was thinking that PR is service names related, this is metrics name thing.", "author": "wu-sheng", "createdAt": "2020-11-23T09:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Njk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3NzQxMw==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529077413", "bodyText": "Added namespace to meter metrics. now, the prefix naming rule is meter_<namespace>_<rule_name>", "author": "hanahmily", "createdAt": "2020-11-24T00:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Njk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5NzA3MQ==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529097071", "bodyText": "Adding namespace would make the index name uncertain, why add this? How do we UI configuration?", "author": "wu-sheng", "createdAt": "2020-11-24T01:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Njk1NA=="}], "type": "inlineReview"}, {"oid": "ccd07bc915b76c4b9daf99d5c990da74337c9558", "url": "https://github.com/apache/skywalking/commit/ccd07bc915b76c4b9daf99d5c990da74337c9558", "message": "Add namespace to meter and cleanup istio mixer\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-23T23:58:49Z", "type": "commit"}, {"oid": "4129d4a601c46ac30e4e7be352e0122fc329db5b", "url": "https://github.com/apache/skywalking/commit/4129d4a601c46ac30e4e7be352e0122fc329db5b", "message": "Update CHANGES.md\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T00:12:19Z", "type": "commit"}, {"oid": "edf490e9ee3409fc8f05b5ba3b750db879bf27c5", "url": "https://github.com/apache/skywalking/commit/edf490e9ee3409fc8f05b5ba3b750db879bf27c5", "message": "Update e2e case due to the change of meter metric name\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T00:36:52Z", "type": "commit"}, {"oid": "1718f38250894ef5a45e5a168f5b5a2878b450d3", "url": "https://github.com/apache/skywalking/commit/1718f38250894ef5a45e5a168f5b5a2878b450d3", "message": "Tweat names and docs\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T01:41:10Z", "type": "commit"}, {"oid": "daeb03cd5ccf9244cf8aa856c523259c52434187", "url": "https://github.com/apache/skywalking/commit/daeb03cd5ccf9244cf8aa856c523259c52434187", "message": "Update prometheus fetcher config, fix sql builder issue of h2\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T02:07:19Z", "type": "commit"}, {"oid": "68cc1ddea0eaa110ab4275cbf4f0f81040c3f8fe", "url": "https://github.com/apache/skywalking/commit/68cc1ddea0eaa110ab4275cbf4f0f81040c3f8fe", "message": "Update test case\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T03:37:18Z", "type": "commit"}, {"oid": "68cc1ddea0eaa110ab4275cbf4f0f81040c3f8fe", "url": "https://github.com/apache/skywalking/commit/68cc1ddea0eaa110ab4275cbf4f0f81040c3f8fe", "message": "Update test case\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T03:37:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMDc2Mw==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529200763", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            NOTICE, if you want metrics of Istio managed service, including topology among them, we recommend you to consider our [ALS solution](../envoy/als_setting.md)\n          \n          \n            \n            NOTICE, if you want metrics of Istio managed services, including topology among them, we recommend you to consider our [ALS solution](../envoy/als_setting.md)", "author": "wu-sheng", "createdAt": "2020-11-24T04:49:37Z", "path": "docs/en/setup/istio/README.md", "diffHunk": "@@ -1,28 +1,66 @@\n # Work with Istio\n \n-Instructions for transport Istio's metrics to SkyWalking OAP server.\n+Instructions for transport Istio's metrics to the SkyWalking OAP server.\n \n ## Prerequisites\n \n-Istio should be installed in kubernetes cluster. Follow [Istio getting start](https://istio.io/docs/setup/getting-started/)\n+Istio should be installed in the kubernetes cluster. Follow [Istio getting start](https://istio.io/docs/setup/getting-started/)\n to finish it.\n \n ## Deploy Skywalking backend\n \n-Follow the [deploying backend in kubernetes](../backend/backend-k8s.md) to install oap server in kubernetes cluster.\n+Follow the [deploying backend in kubernetes](../backend/backend-k8s.md) to install the OAP server in the kubernetes cluster.\n+Referring to [OpenTelemetry receiver](../backend/backend-receivers.md#OpenTelemetry-receiver) to ingest metrics.\n \n-## Setup Istio to send metrics to oap\n \n-Our scripts are wrote based on Istio 1.3.3.\n+## Deploy OpenTelemetry collector\n+OpenTelemetry collector is the location Istio telemetry sends metrics, then processing and sending them to SkyWalking\n+backend.\n \n-1. Install Istio metric template\n+Following the [Getting Started](https://opentelemetry.io/docs/collector/getting-started/) to deploy this collector. There \n+are several components available in the collector, and they could be combined for different scenarios.\n+ For the sake of brevity, we use the Prometheus receiver to retrieve metrics from Istio control and data plane, \n+ then send them to SkyWalking by OpenCensus exporter.\n \n-`kubectl apply -f https://raw.githubusercontent.com/istio/istio/1.3.3/mixer/template/metric/template.yaml`\n+#### Prometheus receiver\n+Refer to [Prometheus Receiver](https://github.com/open-telemetry/opentelemetry-collector/blob/master/receiver/prometheusreceiver/README.md)\n+ to set up this receiver. you could find more configuration details in [Prometheus Integration of Istio](https://istio.io/latest/docs/ops/integrations/prometheus/#configuration)\n+ to figure out how to direct Prometheus receiver to query Istio metrics.\n+ \n+SkyWalking supports receiving multi-cluster metrics in a single OAP cluster. A `cluster` label should be appended to every metric\n+fetched by this receiver even there's only a single cluster needed to be collected.\n+You could leverage `relabel` to add it like below:\n \n-2. Install SkyWalking adapter\n+```\n+relabel_configs:\n+- source_labels: []\n+  target_label: cluster\n+  replacement: <cluster name>\n+```\n \n-`kubectl apply -f skywalkingadapter.yml`\n+or opt to [Resource Processor](https://github.com/open-telemetry/opentelemetry-collector/blob/master/processor/resourceprocessor/README.md):\n \n-Find the `skywalkingadapter.yml` at [here](yaml/skywalkingadapter.yml).\n+```\n+processors:\n+  resource:\n+    attributes:\n+    - key: cluster\n+      value: \"<cluster name>\"\n+      action: upsert\n+```\n \n-NOTICE, due to Istio Mixer is default OFF, we recommend you to consider our [ALS solution](../envoy/als_setting.md)\n\\ No newline at end of file\n+Notice, if you try the sample of istio Prometheus Kubernetes configuration, \n+the issues described [here](https://github.com/open-telemetry/opentelemetry-collector/issues/2163) might block you. \n+Try to use the solution indicated in this issue if it's not fixed.\n+\n+#### OpenCensus exporter\n+Follow [OpenCensus exporter configuration](https://github.com/open-telemetry/opentelemetry-collector/blob/master/exporter/opencensusexporter/README.md)\n+to set up a connection between OpenTelemetry collector and OAP cluster. `endpoint` is the address of OAP gRPC service.\n+\n+## Observe Istio\n+\n+Open Istio Dashboard in SkyWaling UI by clicking `Dashboard` -> `Istio`, then you're able to view charts and diagrams\n+generated by Istio metrics. You also could view them by `swctl` and set up alarm rules based on them.\n+\n+\n+NOTICE, if you want metrics of Istio managed service, including topology among them, we recommend you to consider our [ALS solution](../envoy/als_setting.md)", "originalCommit": "68cc1ddea0eaa110ab4275cbf4f0f81040c3f8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMTA2MA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529201060", "bodyText": "This doc has been changed, https://github.com/apache/skywalking/tree/68cc1ddea0eaa110ab4275cbf4f0f81040c3f8fe/docs/en/setup", "author": "wu-sheng", "createdAt": "2020-11-24T04:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMDc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMTU4NA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529201584", "bodyText": "Root readme,", "author": "wu-sheng", "createdAt": "2020-11-24T04:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMDc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMjAwOQ==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529202009", "bodyText": "This doc, https://github.com/apache/skywalking/blob/master/docs/en/concepts-and-designs/service-mesh-probe.md, includes Mixer too.\nI think you need to run a text search about istio and mixer to replace the mixer things.", "author": "wu-sheng", "createdAt": "2020-11-24T04:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMDc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI1NDI5Ng==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529254296", "bodyText": "done", "author": "hanahmily", "createdAt": "2020-11-24T07:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMDc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwNDkwOA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529204908", "bodyText": "I didn't find the doc about this group. Please recheck.", "author": "wu-sheng", "createdAt": "2020-11-24T05:04:09Z", "path": "oap-server/server-bootstrap/src/main/resources/fetcher-prom-rules/self.yaml", "diffHunk": "@@ -39,42 +39,43 @@ staticConfig:\n   labels:\n     service: oap-server\n defaultMetricLevel: instance(['service'], ['instance'])\n+group: oap", "originalCommit": "68cc1ddea0eaa110ab4275cbf4f0f81040c3f8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNjM0NA==", "url": "https://github.com/apache/skywalking/pull/5835#discussion_r529216344", "bodyText": "https://github.com/apache/skywalking/pull/5835/files#diff-c6d2ef62107b5e27314760750c667480bcd8b224e16106e32f6bb6b6f3e90144R49-R50", "author": "hanahmily", "createdAt": "2020-11-24T05:44:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwNDkwOA=="}], "type": "inlineReview"}, {"oid": "c0b2f9e447621eb4a4822fec6e26a7a45d3a08c0", "url": "https://github.com/apache/skywalking/commit/c0b2f9e447621eb4a4822fec6e26a7a45d3a08c0", "message": "Update docs/en/setup/istio/README.md\n\nCo-authored-by: \u5434\u665f Wu Sheng <wu.sheng@foxmail.com>", "committedDate": "2020-11-24T07:19:58Z", "type": "commit"}, {"oid": "4f2e0671ab13efb8c4005425d76a8ddb27ea822d", "url": "https://github.com/apache/skywalking/commit/4f2e0671ab13efb8c4005425d76a8ddb27ea822d", "message": "More docs and dist configuration\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T07:27:41Z", "type": "commit"}, {"oid": "5bac7dc355468b7b8b272eb4e8cad132631c8ac0", "url": "https://github.com/apache/skywalking/commit/5bac7dc355468b7b8b272eb4e8cad132631c8ac0", "message": "Exclude otel-oc-rules\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-24T10:13:01Z", "type": "commit"}, {"oid": "ebcb35aa64051ca10430551652da69441b094e5c", "url": "https://github.com/apache/skywalking/commit/ebcb35aa64051ca10430551652da69441b094e5c", "message": "Merge branch 'master' into otel-istio", "committedDate": "2020-11-24T12:01:38Z", "type": "commit"}, {"oid": "ead7cd89ae77a9194e35019736b8f8ecfb0f0c74", "url": "https://github.com/apache/skywalking/commit/ead7cd89ae77a9194e35019736b8f8ecfb0f0c74", "message": "Merge branch 'master' into otel-istio", "committedDate": "2020-11-25T00:40:24Z", "type": "commit"}, {"oid": "80f150ebdd7a975cf14262bdfdeb1b8c46698923", "url": "https://github.com/apache/skywalking/commit/80f150ebdd7a975cf14262bdfdeb1b8c46698923", "message": "Disable istio and so11y metrics by default.\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-25T02:14:16Z", "type": "commit"}, {"oid": "70ad9ec51ea0010a9447ff9311152caa3c07f2bc", "url": "https://github.com/apache/skywalking/commit/70ad9ec51ea0010a9447ff9311152caa3c07f2bc", "message": "Fix micrometer testcase\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-25T06:41:03Z", "type": "commit"}, {"oid": "1c1144b7857d138667937e9f2b345e2984149b7b", "url": "https://github.com/apache/skywalking/commit/1c1144b7857d138667937e9f2b345e2984149b7b", "message": "Update more cases\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-25T10:07:08Z", "type": "commit"}, {"oid": "1c1144b7857d138667937e9f2b345e2984149b7b", "url": "https://github.com/apache/skywalking/commit/1c1144b7857d138667937e9f2b345e2984149b7b", "message": "Update more cases\n\nSigned-off-by: Gao Hongtao <hanahmily@gmail.com>", "committedDate": "2020-11-25T10:07:08Z", "type": "forcePushed"}]}