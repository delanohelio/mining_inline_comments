{"pr_number": 1520, "pr_title": "Implement job context garbage collection", "pr_createdAt": "2020-11-09T19:24:39Z", "pr_url": "https://github.com/apache/helix/pull/1520", "timeline": [{"oid": "f74ba24d19a7e85c5fcd69e0bb4053327c7d2675", "url": "https://github.com/apache/helix/commit/f74ba24d19a7e85c5fcd69e0bb4053327c7d2675", "message": "Add garbage collection for the job context\n\nPreviously, workflow context garbage collection has been added.\nIn this commit, new methods have been added to remove the job\nconetxts that does not have corresponding job config.", "committedDate": "2020-11-08T22:33:41Z", "type": "commit"}, {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "url": "https://github.com/apache/helix/commit/3f7ce747e97a1a05eb40e820d1972805fc6855bf", "message": "Fix rest related tests", "committedDate": "2020-11-09T18:36:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0MzAyMA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520143020", "bodyText": "This is necessary to have due to #1391. Previously we were relying on the ideal state. Now once the config is added, the controller will process the job. If the job config does not have an ID field, TaskData cache does not see the config and the job will not get processed.", "author": "alirezazamani", "createdAt": "2020-11-09T21:50:50Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/AbstractTestClass.java", "diffHunk": "@@ -451,7 +451,7 @@ protected ClusterControllerManager startController(String cluster) {\n     for (int i = 0; i < numJobs; i++) {\n       JobConfig.Builder job =\n           new JobConfig.Builder().setCommand(\"DummyCommand\").setTargetResource(\"RESOURCE\")\n-              .setWorkflow(workflowName);\n+              .setWorkflow(workflowName).setJobId(workflowName + \"_\" + JOB_PREFIX + i);", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0MzQxOA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520143418", "bodyText": "This change is necessary. This was not correct from the beginning of the change.", "author": "alirezazamani", "createdAt": "2020-11-09T21:51:35Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/AbstractTestClass.java", "diffHunk": "@@ -105,7 +105,7 @@\n   // For a single-ZK/Helix environment\n   protected static final String ZK_ADDR = \"localhost:2123\";\n   protected static final String WORKFLOW_PREFIX = \"Workflow_\";\n-  protected static final String JOB_PREFIX = \"Job_\";\n+  protected static final String JOB_PREFIX = \"JOB\";", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDIxMw==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144213", "bodyText": "Since the test we are checking the accessor, this has been changed to FAILED. In this case, the status of the workflow will be unchanged and the controller does not change it. Hence, the job accessor test would work correctly.", "author": "alirezazamani", "createdAt": "2020-11-09T21:53:10Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/AbstractTestClass.java", "diffHunk": "@@ -426,9 +426,9 @@ protected ClusterControllerManager startController(String cluster) {\n       }\n       workflows.put(WORKFLOW_PREFIX + i, workflow.build());\n       WorkflowContext workflowContext = TaskTestUtil\n-          .buildWorkflowContext(WORKFLOW_PREFIX + i, TaskState.IN_PROGRESS,\n+          .buildWorkflowContext(WORKFLOW_PREFIX + i, TaskState.FAILED,", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDQ3Mg==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144472", "bodyText": "See the comments above for an explanation of this change.", "author": "alirezazamani", "createdAt": "2020-11-09T21:53:44Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestWorkflowAccessor.java", "diffHunk": "@@ -112,7 +112,7 @@ public void testGetWorkflowContext() throws IOException {\n         Response.Status.OK.getStatusCode(), true);\n     JsonNode node = OBJECT_MAPPER.readTree(body);\n     Assert.assertEquals(node.get(\"STATE\").textValue(),\n-        TaskState.IN_PROGRESS.name());\n+        TaskState.FAILED.name());", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDU2NQ==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144565", "bodyText": "See the comments above for an explanation of this change.", "author": "alirezazamani", "createdAt": "2020-11-09T21:53:57Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestJobAccessor.java", "diffHunk": "@@ -178,8 +178,8 @@ public void testGetAddJobContent() throws IOException {\n   @Test(dependsOnMethods = \"testGetAddJobContent\")\n   public void testInvalidGetAndUpdateJobContentStore() {\n     System.out.println(\"Start test :\" + TestHelper.getTestMethodName());\n-    String validURI = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/Job_0/userContent\";\n-    String invalidURI1 = \"clusters/\" + CLUSTER_NAME + \"/workflows/xxx/jobs/Job_0/userContent\"; // workflow not exist\n+    String validURI = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/JOB0/userContent\";\n+    String invalidURI1 = \"clusters/\" + CLUSTER_NAME + \"/workflows/xxx/jobs/JOB0/userContent\"; // workflow not exist", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDYwMA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144600", "bodyText": "See the comments above for an explanation of this change.", "author": "alirezazamani", "createdAt": "2020-11-09T21:54:01Z", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestTaskAccessor.java", "diffHunk": "@@ -38,8 +38,8 @@\n   @Test\n   public void testGetAddTaskUserContent() throws IOException {\n     System.out.println(\"Start test :\" + TestHelper.getTestMethodName());\n-    String uri = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/Job_0/tasks/0/userContent\";\n-    String uriTaskDoesNotExist = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/Job_0/tasks/xxx/userContent\";\n+    String uri = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/JOB0/tasks/0/userContent\";\n+    String uriTaskDoesNotExist = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/JOB0/tasks/xxx/userContent\";", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMjY1MA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520802650", "bodyText": "We may differentiate the names. Otherwise, it could be confusing.", "author": "junkaixue", "createdAt": "2020-11-10T18:59:43Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/AttributeName.java", "diffHunk": "@@ -48,5 +48,7 @@\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n   TO_BE_PURGED_WORKFLOWS,\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n+  TO_BE_PURGED_JOBS,\n+  // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n   TO_BE_PURGED_JOBS_MAP", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNjg4MQ==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520936881", "bodyText": "I will change the name. Thanks for the suggestion.", "author": "alirezazamani", "createdAt": "2020-11-10T23:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMjY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NzAwNA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520947004", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-11-10T23:48:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMjY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwNTYzMA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520805630", "bodyText": "Could this job still exist in WF context? Do we need to scan WF context and clean them up?", "author": "junkaixue", "createdAt": "2020-11-10T19:02:58Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/TaskGarbageCollectionStage.java", "diffHunk": "@@ -93,12 +97,18 @@ public void process(ClusterEvent event) throws Exception {\n           .equals(TaskUtil.WORKFLOW_CONTEXT_KW)) {\n         // Find workflows that need to be purged\n         workflowsToBePurged.add(entry.getKey());\n+      } else if (jobConfig == null && entry.getValue() != null && entry.getValue().getId()", "originalCommit": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNjc1MQ==", "url": "https://github.com/apache/helix/pull/1520#discussion_r520936751", "bodyText": "This follows what we do for expired jobs. Note that in expired jobs we do not do that as well because main pipeline is responsible to update workflow context. The reason has been also explained in the comments:\n      // Update workflow context will be in main pipeline not here. Otherwise, it will cause\n      // concurrent write issue. It is possible that jobs got purged but there is no event to\n      // trigger the pipeline to clean context.", "author": "alirezazamani", "createdAt": "2020-11-10T23:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwNTYzMA=="}], "type": "inlineReview"}, {"oid": "85ddf61bc33780d40fb593b3399397f5fd7b611e", "url": "https://github.com/apache/helix/commit/85ddf61bc33780d40fb593b3399397f5fd7b611e", "message": "Address commments", "committedDate": "2020-11-10T23:48:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MjM2OA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r522352368", "bodyText": "One minor question, why not call it TO_BE_PURGED_JOB directly?", "author": "jiajunwang", "createdAt": "2020-11-12T19:12:59Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/AttributeName.java", "diffHunk": "@@ -48,5 +48,7 @@\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n   TO_BE_PURGED_WORKFLOWS,\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n+  JOBS_WITHOUT_CONFIG,", "originalCommit": "85ddf61bc33780d40fb593b3399397f5fd7b611e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwNjg5NQ==", "url": "https://github.com/apache/helix/pull/1520#discussion_r522406895", "bodyText": "I used the name you suggested at the beginning. Junkai asked for the change and I think it makes sense to have a new name. TO_BE_PURGED_JOB causes confusion between jobs without config and the expired job that have passed their expiry time.", "author": "alirezazamani", "createdAt": "2020-11-12T20:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MjM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTQ3Mg==", "url": "https://github.com/apache/helix/pull/1520#discussion_r522355472", "bodyText": "This section is almost identical as removeJob(), could you please merge?", "author": "jiajunwang", "createdAt": "2020-11-12T19:18:40Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1142,6 +1142,35 @@ public static void workflowGarbageCollection(final Set<String> toBePurgedWorkflo\n     }\n   }\n \n+  /**\n+   * The function that removes IdealStates and job contexts of the jobs that need to be\n+   * deleted.\n+   * @param toBePurgedJobs\n+   * @param manager\n+   */\n+  public static void jobGarbageCollection(final Set<String> toBePurgedJobs,\n+      final HelixManager manager) {\n+    HelixDataAccessor accessor = manager.getHelixDataAccessor();\n+    HelixPropertyStore<ZNRecord> propertyStore = manager.getHelixPropertyStore();\n+\n+    for (String jobName : toBePurgedJobs) {\n+      LOG.warn(\n+          \"JobContext exists for job {}. However, job Config is missing! Deleting the JobContext and IdealState!!\",\n+          jobName);\n+\n+      // TODO: We dont need this in the future when TF is not relying on IS/EV anymore.\n+      if (!cleanupJobIdealStateExtView(accessor, jobName)) {\n+        LOG.warn(\"Error occurred while trying to remove job idealstate/externalview for {}.\",\n+            jobName);\n+        continue;\n+      }\n+\n+      if (!removeJobContext(propertyStore, jobName)) {\n+        LOG.warn(\"Error occurred while trying to remove job context for {}.\", jobName);", "originalCommit": "85ddf61bc33780d40fb593b3399397f5fd7b611e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxMzA2Nw==", "url": "https://github.com/apache/helix/pull/1520#discussion_r522413067", "bodyText": "leveraged removeJob method.", "author": "alirezazamani", "createdAt": "2020-11-12T20:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NjY1OQ==", "url": "https://github.com/apache/helix/pull/1520#discussion_r522356659", "bodyText": "I feel purgeExpiredJobs has a more complete logic to process if the removal fails. Why not using it directly. In this case, you won't need 2 lists in the event object. You can merge the job with no config to the expired job for purging.\nOr is there any conflict logic there?", "author": "jiajunwang", "createdAt": "2020-11-12T19:20:47Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1142,6 +1142,35 @@ public static void workflowGarbageCollection(final Set<String> toBePurgedWorkflo\n     }\n   }\n \n+  /**\n+   * The function that removes IdealStates and job contexts of the jobs that need to be\n+   * deleted.\n+   * @param toBePurgedJobs\n+   * @param manager\n+   */\n+  public static void jobGarbageCollection(final Set<String> toBePurgedJobs,", "originalCommit": "85ddf61bc33780d40fb593b3399397f5fd7b611e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxNTU5OA==", "url": "https://github.com/apache/helix/pull/1520#discussion_r522415598", "bodyText": "They are different. Purged expiredJobs are for the jobs that exist in the queue and they have workflow config. However, this is a general method to delete the expired jobs whether they have workflow config or not, and also whether the jobs are associated with a queue or regular workflow. Also, expired jobs are for the queue that is currently running. If the queue has been deleted and the job didn't get deleted for some reason, then this part will cover it and does garbage collection.", "author": "alirezazamani", "createdAt": "2020-11-12T20:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NjY1OQ=="}], "type": "inlineReview"}, {"oid": "9b9f8123b286fae072c98326b4f147958911bc4c", "url": "https://github.com/apache/helix/commit/9b9f8123b286fae072c98326b4f147958911bc4c", "message": "Address comments", "committedDate": "2020-11-13T02:51:42Z", "type": "commit"}, {"oid": "9b9f8123b286fae072c98326b4f147958911bc4c", "url": "https://github.com/apache/helix/commit/9b9f8123b286fae072c98326b4f147958911bc4c", "message": "Address comments", "committedDate": "2020-11-13T02:51:42Z", "type": "forcePushed"}]}