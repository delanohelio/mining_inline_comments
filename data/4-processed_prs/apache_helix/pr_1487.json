{"pr_number": 1487, "pr_title": "Add a configuration option to allow enable/disable writing error log to ZK", "pr_createdAt": "2020-10-27T22:36:49Z", "pr_url": "https://github.com/apache/helix/pull/1487", "timeline": [{"oid": "10a9e9a098eccb5239fae75417e8ca7847b6b3f7", "url": "https://github.com/apache/helix/commit/10a9e9a098eccb5239fae75417e8ca7847b6b3f7", "message": "fix #1486\nImprove statusUpdateUtil log error to ZK by adding an option to enabled\nit. By default, it would not log error to ZK. This is to avoid some\nerror code path that keep flooding ZK sever which cause DoS to Zk.\nSuch as HelixTaskExecutor onMessage creation messageHandler exception.", "committedDate": "2020-10-27T03:29:26Z", "type": "commit"}, {"oid": "cfa04ecefa590bb77ab16ece0ac13061bfa85e46", "url": "https://github.com/apache/helix/commit/cfa04ecefa590bb77ab16ece0ac13061bfa85e46", "message": "add a test.", "committedDate": "2020-10-27T22:31:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5OTQxNg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513799416", "bodyText": "minor: \"helix.StateUpdateUtil.errorLogToZK.enabled\"?  We still log error to local logfile, right?", "author": "lei-xia", "createdAt": "2020-10-28T22:28:07Z", "path": "helix-common/src/main/java/org/apache/helix/SystemPropertyKeys.java", "diffHunk": "@@ -82,4 +82,6 @@\n   // System Property Metadata Store Directory Server endpoint key\n   public static final String MSDS_SERVER_ENDPOINT_KEY =\n       MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY;\n+\n+  public static final String STATEUPDATEUTIL_ERROR_LOG_ENABLED = \"helix.StateUpdateUtil.errorLog.enabled\";", "originalCommit": "cfa04ecefa590bb77ab16ece0ac13061bfa85e46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0Mjc0NQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513842745", "bodyText": "This is not minor, this is a MAJOR, a very good point. Let me make sure we have error level log out to logfile.", "author": "kaisun2000", "createdAt": "2020-10-29T00:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5OTQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyMTM2NA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513821364", "bodyText": "Please use HelixUtil.getSystemPropertyAsBoolean(), it allows you to specify the default value there in the method.", "author": "lei-xia", "createdAt": "2020-10-28T23:28:54Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -55,6 +56,12 @@\n public class StatusUpdateUtil {\n   static Logger _logger = LoggerFactory.getLogger(StatusUpdateUtil.class);\n \n+  public static final boolean ERROR_LOG_TO_ZK_ENABLED;\n+  static {\n+    String valueString = System.getProperty(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_LOG_ENABLED, \"\");\n+    ERROR_LOG_TO_ZK_ENABLED = valueString.equals(\"enabled\") ? true : false;", "originalCommit": "cfa04ecefa590bb77ab16ece0ac13061bfa85e46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NTYyMg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513845622", "bodyText": "There is only HelixUtil.getSystemPropertyAsInt/Long, no asBoolean(). Let me add as Boolean then, make the changes a little bit wider.", "author": "kaisun2000", "createdAt": "2020-10-29T00:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyMTM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNzA0Mg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513827042", "bodyText": "Same here, use HelixUtil.", "author": "lei-xia", "createdAt": "2020-10-28T23:46:09Z", "path": "helix-core/src/test/java/org/apache/helix/integration/manager/TestParticipantManager.java", "diffHunk": "@@ -66,6 +66,9 @@\n public class TestParticipantManager extends ZkTestBase {\n   private MBeanServer _server = ManagementFactory.getPlatformMBeanServer();\n   private String clusterName = TestHelper.getTestClassName();\n+  static {\n+    System.setProperty(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_LOG_ENABLED, \"enabled\");", "originalCommit": "cfa04ecefa590bb77ab16ece0ac13061bfa85e46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NTI4NA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513845284", "bodyText": "In this test, here we are setting this property so that later test which asserting existence of error record in Zk won't fail. HelixUtil does not apply here as it is used to retrieve record.", "author": "kaisun2000", "createdAt": "2020-10-29T00:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNzA0Mg=="}], "type": "inlineReview"}, {"oid": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "url": "https://github.com/apache/helix/commit/c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "message": "update based lei's feedback.", "committedDate": "2020-10-29T01:38:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3ODAyMg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513878022", "bodyText": "Can you test enable it by the new config?", "author": "lei-xia", "createdAt": "2020-10-29T02:07:30Z", "path": "helix-core/src/test/java/org/apache/helix/util/TestStatusUpdateUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.helix.util;\n+\n+import org.apache.helix.HelixConstants;\n+import org.apache.helix.PropertyPathBuilder;\n+import org.apache.helix.SystemPropertyKeys;\n+import org.apache.helix.TestHelper;\n+import org.apache.helix.common.ZkTestBase;\n+import org.apache.helix.integration.manager.MockParticipantManager;\n+import org.apache.helix.messaging.handling.HelixStateTransitionHandler;\n+import org.apache.helix.model.Message;\n+import org.apache.helix.zookeeper.datamodel.ZNRecord;\n+import org.apache.helix.zookeeper.zkclient.exception.ZkException;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+public class TestStatusUpdateUtil extends ZkTestBase {\n+  private String clusterName = TestHelper.getTestClassName();\n+  static {\n+    System.clearProperty(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_LOG_ENABLED);\n+  }\n+\n+  @Test\n+  public void testDisableErrorLogByDefault() throws Exception {", "originalCommit": "cfa04ecefa590bb77ab16ece0ac13061bfa85e46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg4MDU2MA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513880560", "bodyText": "It is already tested in TestParticipantManager. testSessionExpiryInTransition assert the error log znode is not null. Do we need to add another explicit one here?", "author": "kaisun2000", "createdAt": "2020-10-29T02:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3ODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyNzQ4Mw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r514327483", "bodyText": "It is better to add both positive and negative tests in here. The main purpose of the other test is not testing error log though.", "author": "lei-xia", "createdAt": "2020-10-29T15:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3ODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MzUxOA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516243518", "bodyText": "both added now.", "author": "kaisun2000", "createdAt": "2020-11-02T20:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg3ODAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5MjE1Ng==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513892156", "bodyText": "This import is not used.", "author": "huizhilu", "createdAt": "2020-10-29T02:38:01Z", "path": "helix-core/src/main/java/org/apache/helix/util/HelixUtil.java", "diffHunk": "@@ -62,6 +62,7 @@\n import org.apache.helix.model.ResourceAssignment;\n import org.apache.helix.model.ResourceConfig;\n import org.apache.helix.model.StateModelDefinition;\n+import org.apache.helix.tools.ClusterVerifiers.StrictMatchExternalViewVerifier;", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwMjc2Mg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516202762", "bodyText": "removed.", "author": "kaisun2000", "createdAt": "2020-11-02T19:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5MjE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NDA2Nw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513894067", "bodyText": "We don't have to create this method to be redundant.\nSimply, Boolean.getBoolean(propertyKey, propertyDefaultValue) is already what is needed, right?", "author": "huizhilu", "createdAt": "2020-10-29T02:41:23Z", "path": "helix-core/src/main/java/org/apache/helix/util/HelixUtil.java", "diffHunk": "@@ -470,11 +471,26 @@ public static int getSystemPropertyAsInt(String propertyKey, int propertyDefault\n   }\n \n   /**\n-   * Get the value of system property\n+   * Get the boolean value of system property\n    * @param propertyKey\n    * @param propertyDefaultValue\n    * @return\n    */\n+  public static boolean getSystemPropertyAsBoolean(String propertyKey, String propertyDefaultValue) {", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5ODIyNQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r514598225", "bodyText": "+1. Unless you need some error handling in the function.", "author": "junkaixue", "createdAt": "2020-10-29T22:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwMzI4NQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516203285", "bodyText": "removed.", "author": "kaisun2000", "createdAt": "2020-11-02T19:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NDA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NDM0Mw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513894343", "bodyText": "Boolean.getBoolean(propertyKey, propertyDefaultValue) is simple and good enough?", "author": "huizhilu", "createdAt": "2020-10-29T02:41:57Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -55,6 +56,10 @@\n public class StatusUpdateUtil {\n   static Logger _logger = LoggerFactory.getLogger(StatusUpdateUtil.class);\n \n+  public static final boolean ERROR_LOG_TO_ZK_ENABLED =\n+      HelixUtil.getSystemPropertyAsBoolean(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_LOG_ENABLED, \"false\");", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NDc2NA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513894764", "bodyText": "Nit, record.toString() is redundant, record is enough as toString() would be auto called.", "author": "huizhilu", "createdAt": "2020-10-29T02:42:48Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -560,6 +565,10 @@ void publishStatusUpdateRecord(ZNRecord record, Message message, Level level,\n    */\n   void publishErrorRecord(ZNRecord record, String instanceName, String updateSubPath,\n       String updateKey, String sessionId, HelixDataAccessor accessor, boolean isController) {\n+    _logger.error(\"StatusUpdate Error record: {}\", record.toString());", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwNDY0Ng==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516204646", "bodyText": "changed.", "author": "kaisun2000", "createdAt": "2020-11-02T19:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NDc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NjExMg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513896112", "bodyText": "Can you help me understand why you set the property here, but clear it in TestStatusUpdateUtil? Why do we not put both in the test method? Otherwise, the system config would affect other tests, right?", "author": "huizhilu", "createdAt": "2020-10-29T02:45:11Z", "path": "helix-core/src/test/java/org/apache/helix/integration/manager/TestParticipantManager.java", "diffHunk": "@@ -66,6 +66,9 @@\n public class TestParticipantManager extends ZkTestBase {\n   private MBeanServer _server = ManagementFactory.getPlatformMBeanServer();\n   private String clusterName = TestHelper.getTestClassName();\n+  static {\n+    System.setProperty(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_LOG_ENABLED, \"true\");", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzODY3MA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516238670", "bodyText": "public void testSessionExpiryInTransition() throws Exception {\n\n    String errPath = PropertyPathBuilder.instanceError(clusterName, \"localhost_12918\", oldSessionId,\n        \"TestDB0\", \"TestDB0_0\");\n    ZNRecord error = _gZkClient.readData(errPath);\n    Assert.assertNotNull(error,\n        \"InterruptedException should happen in old session since task is being cancelled during handleNewSession\");\n\n\nTo make sure the following test would work.", "author": "kaisun2000", "createdAt": "2020-11-02T20:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NjExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzOTg3Mg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516239872", "bodyText": "ERROR_LOG_TO_ZK_ENABLED in StatusUpdateUtil is static. I changed to use reflection to control the value now. So there is no need to set or clear it in TestStatusUpdateUtil anymore.", "author": "kaisun2000", "createdAt": "2020-11-02T20:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NjExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NjQzMw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513896433", "bodyText": "Missing apache license. Maybe you could setup apache license in your intellij?", "author": "huizhilu", "createdAt": "2020-10-29T02:45:52Z", "path": "helix-core/src/test/java/org/apache/helix/util/TestStatusUpdateUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.helix.util;\n+", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwNTI3NQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516205275", "bodyText": "added.", "author": "kaisun2000", "createdAt": "2020-11-02T19:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5NjQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg5Nzc1Nw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r513897757", "bodyText": "Why assertTrue(True); which is always true? Just put a comment it is expected. Or to be more accurate, we can assert the exception message to ensure the exception is the expected one not others(same exception type but different message thrown from other places).", "author": "huizhilu", "createdAt": "2020-10-29T02:48:41Z", "path": "helix-core/src/test/java/org/apache/helix/util/TestStatusUpdateUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.helix.util;\n+\n+import org.apache.helix.HelixConstants;\n+import org.apache.helix.PropertyPathBuilder;\n+import org.apache.helix.SystemPropertyKeys;\n+import org.apache.helix.TestHelper;\n+import org.apache.helix.common.ZkTestBase;\n+import org.apache.helix.integration.manager.MockParticipantManager;\n+import org.apache.helix.messaging.handling.HelixStateTransitionHandler;\n+import org.apache.helix.model.Message;\n+import org.apache.helix.zookeeper.datamodel.ZNRecord;\n+import org.apache.helix.zookeeper.zkclient.exception.ZkException;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+public class TestStatusUpdateUtil extends ZkTestBase {\n+  private String clusterName = TestHelper.getTestClassName();\n+  static {\n+    System.clearProperty(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_LOG_ENABLED);\n+  }\n+\n+  @Test\n+  public void testDisableErrorLogByDefault() throws Exception {\n+    StatusUpdateUtil _statusUpdateUtil = new StatusUpdateUtil();\n+    int n = 1;\n+\n+    Exception e = new RuntimeException(\"test exception\");\n+\n+    TestHelper.setupCluster(clusterName, ZK_ADDR, 12918, // participant port\n+        \"localhost\", // participant name prefix\n+        \"TestDB\", // resource name prefix\n+        1, // resources\n+        1, // partitions per resource\n+        n, // number of nodes\n+        1, // replicas\n+        \"MasterSlave\", true);\n+\n+    MockParticipantManager[] participants = new MockParticipantManager[n];\n+\n+    for (int i = 0; i < n; i++) {\n+      String instanceName = \"localhost_\" + (12918 + i);\n+      participants[i] = new MockParticipantManager(ZK_ADDR, clusterName, instanceName);\n+      participants[i].syncStart();\n+    }\n+\n+    Message message = new Message(Message.MessageType.STATE_TRANSITION, \"Some unique id\");\n+    message.setSrcName(\"cm-instance-0\");\n+    message.setTgtSessionId(participants[0].getSessionId());\n+    message.setFromState(\"Offline\");\n+    message.setToState(\"Slave\");\n+    message.setPartitionName(\"TestDB_0\");\n+    message.setMsgId(\"Some unique message id\");\n+    message.setResourceName(\"TestDB\");\n+    message.setTgtName(\"localhost_12918\");\n+    message.setStateModelDef(\"MasterSlave\");\n+    message.setStateModelFactoryName(HelixConstants.DEFAULT_STATE_MODEL_FACTORY);\n+    _statusUpdateUtil.logError(message, HelixStateTransitionHandler.class, e,\n+        \"test status update\", participants[0]);\n+\n+    // assert by default, not logged to Zookeeper\n+    String errPath = PropertyPathBuilder.instanceError(clusterName, \"localhost_12918\",\n+        participants[0].getSessionId(),\n+        \"TestDB\", \"TestDB_0\");\n+    try {\n+      ZNRecord error = _gZkClient.readData(errPath);\n+      Assert.fail(\"not expecting being able to send error logs to ZK by default.\");\n+    } catch (ZkException zke) {\n+      Assert.assertTrue(true);", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNDE2Nw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r514024167", "bodyText": "IMHO,\nif (!ERROR_LOG_TO_ZK_ENABLED) {\n_logger.error(\"StatusUpdate Error record: {}\", record.toString());\nreturn;\n}\n...", "author": "jiajunwang", "createdAt": "2020-10-29T06:39:33Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -560,6 +565,10 @@ void publishStatusUpdateRecord(ZNRecord record, Message message, Level level,\n    */\n   void publishErrorRecord(ZNRecord record, String instanceName, String updateSubPath,\n       String updateKey, String sessionId, HelixDataAccessor accessor, boolean isController) {\n+    _logger.error(\"StatusUpdate Error record: {}\", record.toString());\n+    if (!ERROR_LOG_TO_ZK_ENABLED) {", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMTY4Ng==", "url": "https://github.com/apache/helix/pull/1487#discussion_r514321686", "bodyText": "Not actually, even we disable writting to ZK, we still need to log into local log file, right?", "author": "lei-xia", "createdAt": "2020-10-29T14:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNDE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjg5OQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r515432899", "bodyText": "I don't have a strong preference here.\nBut I think it depends on how we treat this util, is it a more powerful logger? Or it is a status updater like the name suggested.\nThe current implementation is treating this class as a pure status updater. There is no extra log done unless the update process fails. And I think it is clean. If a log is needed, then the caller shall call logger method in parallel with the publishErrorRecord() method.\nOn the other hand, if we want to twist this class to be a more powerful logger, then we will have mixed usage. Only part of the code is using it. And whether to use it or not is not clear.\nOverall, I treat the log here as a fallback logic when ERROR_LOG_TO_ZK_ENABLED == false. So it shall not log when the util still writes to ZK.", "author": "jiajunwang", "createdAt": "2020-10-31T00:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNDE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwMDEwMw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516200103", "bodyText": "So let us keep it this way. The reasoning is that source of truth logging is in log file.", "author": "kaisun2000", "createdAt": "2020-11-02T19:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNDE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzOTAxMA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516239010", "bodyText": "I'm fine with both designs. But as I mentioned, this change is half-way. Please either ensure that the source of truth is with the log for ALL the status util call (including log error, log status, etc.) or please don't log here otherwise the util is mixed up with some methods with log and the others don't.", "author": "jiajunwang", "createdAt": "2020-11-02T20:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNDE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0NDYyNQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516244625", "bodyText": "Good point. The log are in publishStatusUpdateRecord and publishErrorRecord.\nHere publishStatusUpdateRecord would never log to Zk anymore. The participant side, it has trace level log to log4j, but not controller side. Let me revise it to the way that both controller and participant side has log to log4j then.", "author": "kaisun2000", "createdAt": "2020-11-02T20:47:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNDE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNTM0Mw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r514025343", "bodyText": "This is a potential thread leak if test failure.", "author": "jiajunwang", "createdAt": "2020-10-29T06:41:03Z", "path": "helix-core/src/test/java/org/apache/helix/util/TestStatusUpdateUtil.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.helix.util;\n+\n+import org.apache.helix.HelixConstants;\n+import org.apache.helix.PropertyPathBuilder;\n+import org.apache.helix.SystemPropertyKeys;\n+import org.apache.helix.TestHelper;\n+import org.apache.helix.common.ZkTestBase;\n+import org.apache.helix.integration.manager.MockParticipantManager;\n+import org.apache.helix.messaging.handling.HelixStateTransitionHandler;\n+import org.apache.helix.model.Message;\n+import org.apache.helix.zookeeper.datamodel.ZNRecord;\n+import org.apache.helix.zookeeper.zkclient.exception.ZkException;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+public class TestStatusUpdateUtil extends ZkTestBase {\n+  private String clusterName = TestHelper.getTestClassName();\n+  static {\n+    System.clearProperty(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_LOG_ENABLED);\n+  }\n+\n+  @Test\n+  public void testDisableErrorLogByDefault() throws Exception {\n+    StatusUpdateUtil _statusUpdateUtil = new StatusUpdateUtil();\n+    int n = 1;\n+\n+    Exception e = new RuntimeException(\"test exception\");\n+\n+    TestHelper.setupCluster(clusterName, ZK_ADDR, 12918, // participant port\n+        \"localhost\", // participant name prefix\n+        \"TestDB\", // resource name prefix\n+        1, // resources\n+        1, // partitions per resource\n+        n, // number of nodes\n+        1, // replicas\n+        \"MasterSlave\", true);\n+\n+    MockParticipantManager[] participants = new MockParticipantManager[n];\n+\n+    for (int i = 0; i < n; i++) {\n+      String instanceName = \"localhost_\" + (12918 + i);\n+      participants[i] = new MockParticipantManager(ZK_ADDR, clusterName, instanceName);\n+      participants[i].syncStart();\n+    }\n+\n+    Message message = new Message(Message.MessageType.STATE_TRANSITION, \"Some unique id\");\n+    message.setSrcName(\"cm-instance-0\");\n+    message.setTgtSessionId(participants[0].getSessionId());\n+    message.setFromState(\"Offline\");\n+    message.setToState(\"Slave\");\n+    message.setPartitionName(\"TestDB_0\");\n+    message.setMsgId(\"Some unique message id\");\n+    message.setResourceName(\"TestDB\");\n+    message.setTgtName(\"localhost_12918\");\n+    message.setStateModelDef(\"MasterSlave\");\n+    message.setStateModelFactoryName(HelixConstants.DEFAULT_STATE_MODEL_FACTORY);\n+    _statusUpdateUtil.logError(message, HelixStateTransitionHandler.class, e,\n+        \"test status update\", participants[0]);\n+\n+    // assert by default, not logged to Zookeeper\n+    String errPath = PropertyPathBuilder.instanceError(clusterName, \"localhost_12918\",\n+        participants[0].getSessionId(),\n+        \"TestDB\", \"TestDB_0\");\n+    try {\n+      ZNRecord error = _gZkClient.readData(errPath);\n+      Assert.fail(\"not expecting being able to send error logs to ZK by default.\");\n+    } catch (ZkException zke) {\n+      Assert.assertTrue(true);\n+    }\n+\n+    for (int i = 0; i < n; i++) {\n+      participants[i].syncStop();", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzNzUzOA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516237538", "bodyText": "fixed in tearing down in afterClass()", "author": "kaisun2000", "createdAt": "2020-11-02T20:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNTM0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMjI1Nw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r514322257", "bodyText": "Again, we are disabling log to ZK, not disabling error log (to log file) at all, right?", "author": "lei-xia", "createdAt": "2020-10-29T14:53:57Z", "path": "helix-common/src/main/java/org/apache/helix/SystemPropertyKeys.java", "diffHunk": "@@ -82,4 +82,6 @@\n   // System Property Metadata Store Directory Server endpoint key\n   public static final String MSDS_SERVER_ENDPOINT_KEY =\n       MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY;\n+\n+  public static final String STATEUPDATEUTIL_ERROR_LOG_ENABLED = \"helix.StateUpdateUtil.errorLog.enabled\";", "originalCommit": "c0b3b1463548b8d9716db34780cb3c1dac1b52a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5ODAyNA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r514598024", "bodyText": "We have a class ZkSystemPropertyKeys to hold this kind of system property. Please put this there.", "author": "junkaixue", "createdAt": "2020-10-29T22:13:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMjI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwMDgxMg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516200812", "bodyText": "@lei-xia, so let us change the name to \" STATEUPDATEUTIL_ERROR_LOG2ZK_ENABLED?", "author": "kaisun2000", "createdAt": "2020-11-02T19:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMjI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwMjAzOQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r516202039", "bodyText": "@dasahcc, ZkSystemPropertyKeys is for Zookeeper related. This is more to me like logging related.", "author": "kaisun2000", "createdAt": "2020-11-02T19:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMyMjI1Nw=="}], "type": "inlineReview"}, {"oid": "d6d0e988286fb67a21785f5a442a06ae2e92e19e", "url": "https://github.com/apache/helix/commit/d6d0e988286fb67a21785f5a442a06ae2e92e19e", "message": "revised based on feedback.", "committedDate": "2020-11-02T20:43:45Z", "type": "commit"}, {"oid": "80071711323c418b78f288194e34e8bb9eecd825", "url": "https://github.com/apache/helix/commit/80071711323c418b78f288194e34e8bb9eecd825", "message": "refactor logging in statusUpdateUtil.", "committedDate": "2020-11-02T21:33:38Z", "type": "commit"}, {"oid": "df89ed7c80801cbeaa978e8c31f0739fe079f675", "url": "https://github.com/apache/helix/commit/df89ed7c80801cbeaa978e8c31f0739fe079f675", "message": "revert change to helix-core/src/main/java/org/apache/helix/util/HelixUtil.java", "committedDate": "2020-11-02T21:36:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NzgyNg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520257826", "bodyText": "I thought more about this configuration. Can we directly make it an enum now instead of changing it later? Otherwise, we will need to deprecate this item and go through the painful backward compatibility checklist in the future.\nI suggest making it STATEUPDATE_ERROR_REPORTING_CHANNEL.", "author": "jiajunwang", "createdAt": "2020-11-10T03:08:49Z", "path": "helix-common/src/main/java/org/apache/helix/SystemPropertyKeys.java", "diffHunk": "@@ -82,4 +82,6 @@\n   // System Property Metadata Store Directory Server endpoint key\n   public static final String MSDS_SERVER_ENDPOINT_KEY =\n       MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY;\n+\n+  public static final String STATEUPDATEUTIL_ERROR_LOG2ZK_ENABLED = \"helix.StateUpdateUtil.errorLog.enabled\";", "originalCommit": "df89ed7c80801cbeaa978e8c31f0739fe079f675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc0NzY2OQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520747669", "bodyText": "Can you illustrate the idea how to make it enum? Something like\nenum STATEUPDATE_ERROR_REPORTING_CHANNEL {\n    LOG4J,\n    LOG2ZK\n};\n\n\nand in the system property,\npublic static final String STATEUPDATEUTIL_ERROR_LOG2ZK_ENABLED = <enum value>;\nthen we will convert the system property to enum value?", "author": "kaisun2000", "createdAt": "2020-11-10T17:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NzgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0NTQ1NQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520845455", "bodyText": "STATEUPDATEUTIL_ERROR_PERSISTANCY_ENABLED", "author": "kaisun2000", "createdAt": "2020-11-10T20:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NzgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4OTI0OA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520889248", "bodyText": "changed.", "author": "kaisun2000", "createdAt": "2020-11-10T21:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NzgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2MTQzMw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520261433", "bodyText": "nit, we can move this line out of the if-else block too.", "author": "jiajunwang", "createdAt": "2020-11-10T03:21:28Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -492,47 +496,39 @@ void publishStatusUpdateRecord(ZNRecord record, Message message, Level level,\n \n     Builder keyBuilder = accessor.keyBuilder();\n     if (!_recordedMessages.containsKey(message.getMsgId())) {\n-      if (isController) {\n-        accessor\n-            .updateProperty(keyBuilder.controllerTaskStatus(statusUpdateSubPath, statusUpdateKey),\n-                new StatusUpdate(createMessageLogRecord(message)));\n+      ZNRecord statusUpdateRecord = createMessageLogRecord(message);\n+      PropertyKey propertyKey;\n \n+      if (isController) {\n+        propertyKey = keyBuilder.controllerTaskStatus(statusUpdateSubPath, statusUpdateKey);\n+        accessor.updateProperty(propertyKey, new StatusUpdate(statusUpdateRecord));", "originalCommit": "df89ed7c80801cbeaa978e8c31f0739fe079f675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4OTA5Ng==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520889096", "bodyText": "fixed.", "author": "kaisun2000", "createdAt": "2020-11-10T21:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2MTQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2MTgwNw==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520261807", "bodyText": "same here.", "author": "jiajunwang", "createdAt": "2020-11-10T03:22:53Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -492,47 +496,39 @@ void publishStatusUpdateRecord(ZNRecord record, Message message, Level level,\n \n     Builder keyBuilder = accessor.keyBuilder();\n     if (!_recordedMessages.containsKey(message.getMsgId())) {\n-      if (isController) {\n-        accessor\n-            .updateProperty(keyBuilder.controllerTaskStatus(statusUpdateSubPath, statusUpdateKey),\n-                new StatusUpdate(createMessageLogRecord(message)));\n+      ZNRecord statusUpdateRecord = createMessageLogRecord(message);\n+      PropertyKey propertyKey;\n \n+      if (isController) {\n+        propertyKey = keyBuilder.controllerTaskStatus(statusUpdateSubPath, statusUpdateKey);\n+        accessor.updateProperty(propertyKey, new StatusUpdate(statusUpdateRecord));\n       } else {\n-\n-        PropertyKey propertyKey =\n+        propertyKey =\n             keyBuilder.stateTransitionStatus(instanceName, sessionId, statusUpdateSubPath,\n                 statusUpdateKey);\n-\n-        ZNRecord statusUpdateRecord = createMessageLogRecord(message);\n-\n-        // For now write participant StatusUpdates to log4j.\n-        // we are using restlet as another data channel to report to controller.\n-        if (_logger.isTraceEnabled()) {\n-          _logger.trace(\"StatusUpdate path:\" + propertyKey.getPath() + \", updates:\"\n-              + statusUpdateRecord);\n-        }\n         accessor.updateProperty(propertyKey, new StatusUpdate(statusUpdateRecord));\n+      }\n \n+      if (_logger.isTraceEnabled()) {\n+        _logger.trace(\"StatusUpdate path:\" + propertyKey.getPath() + \", updates:\"\n+            + statusUpdateRecord);\n       }\n       _recordedMessages.put(message.getMsgId(), message.getMsgId());\n     }\n \n+    PropertyKey propertyKey;\n     if (isController) {\n-      accessor.updateProperty(\n-          keyBuilder.controllerTaskStatus(statusUpdateSubPath, statusUpdateKey), new StatusUpdate(\n-              record));\n+      propertyKey = keyBuilder.controllerTaskStatus(statusUpdateSubPath, statusUpdateKey);\n+      accessor.updateProperty(propertyKey, new StatusUpdate(record));", "originalCommit": "df89ed7c80801cbeaa978e8c31f0739fe079f675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4OTE0OQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520889149", "bodyText": "fixed.", "author": "kaisun2000", "createdAt": "2020-11-10T21:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2MTgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MDQyOA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520850428", "bodyText": "Do we really need this error log for the whole record? It may eat up the disk, imagine if znrecord is close to 1 MB. I am not sure if we really need the record for troubleshooting. Maybe logging the instanceName, updateSubPath, sessionId, etc. is good enough?", "author": "huizhilu", "createdAt": "2020-11-10T20:21:42Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -560,6 +556,10 @@ void publishStatusUpdateRecord(ZNRecord record, Message message, Level level,\n    */\n   void publishErrorRecord(ZNRecord record, String instanceName, String updateSubPath,\n       String updateKey, String sessionId, HelixDataAccessor accessor, boolean isController) {\n+    _logger.error(\"StatusUpdate Error record: {}\", record);", "originalCommit": "df89ed7c80801cbeaa978e8c31f0739fe079f675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NjkwMg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r520886902", "bodyText": "This is not a concern. Previously the issue is that N participant would write the log to one Zk quorum at the same time repeatedly. Here, we are writing to N participant at the same time. If this is a concern, we need to revisit all the participant side logging then.", "author": "kaisun2000", "createdAt": "2020-11-10T21:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MDQyOA=="}], "type": "inlineReview"}, {"oid": "ad369bf2706797c79e382192fe900775d5650f21", "url": "https://github.com/apache/helix/commit/ad369bf2706797c79e382192fe900775d5650f21", "message": "fix some nits and nameing issue based on feedback.", "committedDate": "2020-11-10T21:45:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzMzA5Mg==", "url": "https://github.com/apache/helix/pull/1487#discussion_r521033092", "bodyText": "nit, private?\nSince we already doing reflection, I think making it private won't block the test, right?", "author": "jiajunwang", "createdAt": "2020-11-11T02:24:13Z", "path": "helix-core/src/main/java/org/apache/helix/util/StatusUpdateUtil.java", "diffHunk": "@@ -55,6 +56,9 @@\n public class StatusUpdateUtil {\n   static Logger _logger = LoggerFactory.getLogger(StatusUpdateUtil.class);\n \n+  public static final boolean ERROR_LOG_TO_ZK_ENABLED =", "originalCommit": "ad369bf2706797c79e382192fe900775d5650f21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEwOTcyNQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r521109725", "bodyText": "Actually it is not the case. Making it private won't work as I just tested. I am not an expert in this area. If you know other trick, let me know.", "author": "kaisun2000", "createdAt": "2020-11-11T04:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzMzA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTExMTUyNA==", "url": "https://github.com/apache/helix/pull/1487#discussion_r521111524", "bodyText": "This is not the case. Just tested, it does not work. I am not an expert in this area. Feel free to let me know if you know the trick here.", "author": "kaisun2000", "createdAt": "2020-11-11T04:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzMzA5Mg=="}], "type": "inlineReview"}, {"oid": "a064886a21175187108be41d8ed20cba1a0be581", "url": "https://github.com/apache/helix/commit/a064886a21175187108be41d8ed20cba1a0be581", "message": "unset system property after the test", "committedDate": "2020-11-11T04:40:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTExOTc0NQ==", "url": "https://github.com/apache/helix/pull/1487#discussion_r521119745", "bodyText": "The system property is JVM level. If we don't unset the config, later tests will be using this config. Maybe there are no tests using the config yet. But I suggest, as a good practice, we also unset the config to make unit tests isolated, ensuring other tests won't be impacted by this test's configs.", "author": "huizhilu", "createdAt": "2020-11-11T05:22:20Z", "path": "helix-core/src/test/java/org/apache/helix/integration/manager/TestParticipantManager.java", "diffHunk": "@@ -66,6 +66,9 @@\n public class TestParticipantManager extends ZkTestBase {\n   private MBeanServer _server = ManagementFactory.getPlatformMBeanServer();\n   private String clusterName = TestHelper.getTestClassName();\n+  static {\n+    System.setProperty(SystemPropertyKeys.STATEUPDATEUTIL_ERROR_PERSISTENCY_ENABLED, \"true\");", "originalCommit": "ad369bf2706797c79e382192fe900775d5650f21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}