{"pr_number": 1438, "pr_title": "Fix TaskGarbageCollectionStage rebalance trigger when job purge interval is negative", "pr_createdAt": "2020-10-05T22:56:30Z", "pr_url": "https://github.com/apache/helix/pull/1438", "timeline": [{"oid": "e6be1faec80cf057dec64e44cdc49a4797041322", "url": "https://github.com/apache/helix/commit/e6be1faec80cf057dec64e44cdc49a4797041322", "message": "Bug fix", "committedDate": "2020-10-05T22:50:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwNzk4MQ==", "url": "https://github.com/apache/helix/pull/1438#discussion_r500507981", "bodyText": "why the previous way has a bug?", "author": "kaisun2000", "createdAt": "2020-10-06T18:25:20Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/TaskGarbageCollectionStage.java", "diffHunk": "@@ -73,9 +73,12 @@ public void process(ClusterEvent event) throws Exception {\n           continue;\n         }\n         long purgeInterval = workflowConfig.getJobPurgeInterval();\n+        if (purgeInterval <= 0) {\n+          continue;\n+        }\n         long currentTime = System.currentTimeMillis();\n         long nextPurgeTime = workflowContext.getLastJobPurgeTime() + purgeInterval;\n-        if (purgeInterval > 0 && nextPurgeTime <= currentTime) {", "originalCommit": "e6be1faec80cf057dec64e44cdc49a4797041322", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxMzQzNQ==", "url": "https://github.com/apache/helix/pull/1438#discussion_r500513435", "bodyText": "Since we allow negative delay in scheduleRebalance, which leads to immediate rebalance (on-demand), the current logic is incorrect. When job purge interval is non-positive, a rebalance is always triggered immediately.\nSee after this if statement for the rebalance scheduling line. That line is always triggered in the previous version.", "author": "NealSun96", "createdAt": "2020-10-06T18:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwNzk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwMTgxNQ==", "url": "https://github.com/apache/helix/pull/1438#discussion_r500601815", "bodyText": "I see due to this line:\n        scheduleNextJobPurge(workflowConfig.getWorkflowId(), nextPurgeTime, _rebalanceScheduler,\n            manager);\n\npreviously it always schedule the purge.\nHelp me to understand the impact of this a little bit more. With this change, event this is not always scheduled. From the perspective of flaky test, it does not matter, right? I mean with this pull change, we will still see the flaky test to be flaky.", "author": "kaisun2000", "createdAt": "2020-10-06T21:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwNzk4MQ=="}], "type": "inlineReview"}]}