{"pr_number": 1464, "pr_title": "Fix MaxCapacityUsageGauge value not updated", "pr_createdAt": "2020-10-13T06:58:28Z", "pr_url": "https://github.com/apache/helix/pull/1464", "timeline": [{"oid": "696b75f068689fa8b2f68295b801d2ef7b5f5720", "url": "https://github.com/apache/helix/commit/696b75f068689fa8b2f68295b801d2ef7b5f5720", "message": "Fix MaxCapacityUsageGauge value not updated", "committedDate": "2020-10-13T06:51:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwNzQzMw==", "url": "https://github.com/apache/helix/pull/1464#discussion_r504107433", "bodyText": "This could be used in BestPossibleStateCalcStage.computeResourceBestPossibleStateWithWagedRebalancer as well. Could you check for other similar usages? Replacing those logic with this function is a step up for cleanness.", "author": "NealSun96", "createdAt": "2020-10-13T16:45:36Z", "path": "helix-core/src/main/java/org/apache/helix/controller/rebalancer/util/WagedValidationUtil.java", "diffHunk": "@@ -88,4 +90,16 @@\n     }\n     return partitionCapacity;\n   }\n+\n+  /**\n+   * Checks whether or not a resource has enabled WAGED rebalancer.\n+   *\n+   * @param idealState {@code IdealState} of the resource being checked.\n+   * @return {@code true} if WAGED is enabled; otherwise, {@code false}.\n+   */\n+  public static boolean isWagedEnabled(IdealState idealState) {", "originalCommit": "696b75f068689fa8b2f68295b801d2ef7b5f5720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzODg5Ng==", "url": "https://github.com/apache/helix/pull/1464#discussion_r504138896", "bodyText": "Ideally, replacing those places with this API should be done in another PR. Since you've pointed out that place, I just made the change. If there are more places, let's make the change in another PR.", "author": "huizhilu", "createdAt": "2020-10-13T17:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwNzQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwNzg4OQ==", "url": "https://github.com/apache/helix/pull/1464#discussion_r504107889", "bodyText": "Is this a behavior change (all resources -> waged only)?", "author": "NealSun96", "createdAt": "2020-10-13T16:46:20Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/CurrentStateComputationStage.java", "diffHunk": "@@ -283,10 +284,10 @@ private void reportInstanceCapacityMetrics(ClusterStatusMonitor clusterStatusMon\n     asyncExecute(dataProvider.getAsyncTasksThreadPool(), () -> {\n       try {\n         // ResourceToRebalance map also has resources from current states.\n-        // Only use the resources in ideal states to parse all replicas.\n+        // Only use the resources in ideal states that enable WAGED to parse all replicas.\n         Map<String, IdealState> idealStateMap = dataProvider.getIdealStates();\n         Map<String, Resource> resourceToMonitorMap = resourceMap.entrySet().stream()\n-            .filter(idealStateMap::containsKey)\n+            .filter(entry -> WagedValidationUtil.isWagedEnabled(idealStateMap.get(entry.getKey())))", "originalCommit": "696b75f068689fa8b2f68295b801d2ef7b5f5720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzOTg2NQ==", "url": "https://github.com/apache/helix/pull/1464#discussion_r504139865", "bodyText": "Ideally, we would report every resource. But currently for those non WAGED resources, validation won't pass and HelixException would be thrown. So we'll skip non WAGED resources here.\nFYI, did a quick search, no other places are found. We should be good now.", "author": "huizhilu", "createdAt": "2020-10-13T17:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwNzg4OQ=="}], "type": "inlineReview"}, {"oid": "2e92d5ed551e72fe6916de02ecfaeee6d47cf341", "url": "https://github.com/apache/helix/commit/2e92d5ed551e72fe6916de02ecfaeee6d47cf341", "message": "Use isWagedEnabled", "committedDate": "2020-10-13T17:43:02Z", "type": "commit"}, {"oid": "2e92d5ed551e72fe6916de02ecfaeee6d47cf341", "url": "https://github.com/apache/helix/commit/2e92d5ed551e72fe6916de02ecfaeee6d47cf341", "message": "Use isWagedEnabled", "committedDate": "2020-10-13T17:43:02Z", "type": "forcePushed"}]}