{"pr_number": 1492, "pr_title": "fix TestCleanupExternalView.test ", "pr_createdAt": "2020-10-28T01:28:25Z", "pr_url": "https://github.com/apache/helix/pull/1492", "timeline": [{"oid": "de5d2639d1a4af0f91b33844bc02888da2dcc901", "url": "https://github.com/apache/helix/commit/de5d2639d1a4af0f91b33844bc02888da2dcc901", "message": "fix TestCleanupExternalView.test #1458\n\nFlaky test with 10 * 100ms. This may not be enough when there is\nlogging or Zk is slow in github.", "committedDate": "2020-10-28T01:24:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNjY4Mw==", "url": "https://github.com/apache/helix/pull/1492#discussion_r514026683", "bodyText": "Why get it once more?", "author": "jiajunwang", "createdAt": "2020-10-29T06:42:48Z", "path": "helix-core/src/test/java/org/apache/helix/integration/TestCleanupExternalView.java", "diffHunk": "@@ -109,18 +109,14 @@ public void test() throws Exception {\n     // System.out.println(\"re-enabling controller\");\n     admin.enableCluster(clusterName, true);\n \n-    ExternalView externalView = null;\n-    for (int i = 0; i < 10; i++) {\n-      Thread.sleep(100);\n-      externalView = accessor.getProperty(keyBuilder.externalView(\"TestDB0\"));\n-      // System.out.println(\"externalView: \" + externalView);\n-      if (externalView == null) {\n-        break;\n-      }\n-    }\n \n-    Assert.assertNull(externalView, \"external-view for TestDB0 should be removed, but was: \"\n-        + externalView);\n+    result = TestHelper.verify(() -> {\n+      ExternalView externalView = accessor.getProperty(keyBuilder.externalView(\"TestDB0\"));\n+      return externalView == null;\n+    }, TestHelper.WAIT_DURATION);\n+\n+    ExternalView ev = accessor.getProperty(keyBuilder.externalView(\"TestDB0\"));", "originalCommit": "de5d2639d1a4af0f91b33844bc02888da2dcc901", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNzg5Ng==", "url": "https://github.com/apache/helix/pull/1492#discussion_r514027896", "bodyText": "If it is just for the assert log, then you can do this,\nExternalView externalView = null;\nresult = TestHelper.verify(() -> {\nexternalView = accessor.getProperty(keyBuilder.externalView(\"TestDB0\"));\nreturn externalView == null;\n}, TestHelper.WAIT_DURATION);\nAssert.assertTrue(result, \"external-view for TestDB0 should be removed, but was: \" + externalView);", "author": "jiajunwang", "createdAt": "2020-10-29T06:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNjY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NzcwNQ==", "url": "https://github.com/apache/helix/pull/1492#discussion_r516197705", "bodyText": "This way does not work. Lambda varable captured (externalView here) needs to be final. Changed it to use instance variable then.", "author": "kaisun2000", "createdAt": "2020-11-02T19:13:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNjY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MTA3MA==", "url": "https://github.com/apache/helix/pull/1492#discussion_r516241070", "bodyText": "It certainly works. But it would be better to have a wrapper class (AtomicReference for example), to contain the result. The wrapper class can be final. Anyway, the goal is to ensure all test cases are independent of each other as far as we can.\nJust a suggestion, the current logic is also fine : )", "author": "jiajunwang", "createdAt": "2020-11-02T20:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyNjY4Mw=="}], "type": "inlineReview"}, {"oid": "3bf007e492b2d42dc7a4fe4be23deddfe319d085", "url": "https://github.com/apache/helix/commit/3bf007e492b2d42dc7a4fe4be23deddfe319d085", "message": "revised.", "committedDate": "2020-11-02T19:12:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwOTI1Nw==", "url": "https://github.com/apache/helix/pull/1492#discussion_r516209257", "bodyText": "nit: = null is not needed.", "author": "zhangmeng916", "createdAt": "2020-11-02T19:36:22Z", "path": "helix-core/src/test/java/org/apache/helix/integration/TestCleanupExternalView.java", "diffHunk": "@@ -42,6 +42,7 @@\n  * orphan external-view\n  */\n public class TestCleanupExternalView extends ZkUnitTestBase {\n+  private ExternalView _externalView = null;", "originalCommit": "3bf007e492b2d42dc7a4fe4be23deddfe319d085", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI4MzczNQ==", "url": "https://github.com/apache/helix/pull/1492#discussion_r516283735", "bodyText": "right.\njust to make sure this is explicit, namely in normal path this is expected to be null all the time.", "author": "kaisun2000", "createdAt": "2020-11-02T22:09:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIwOTI1Nw=="}], "type": "inlineReview"}]}