{"pr_number": 1109, "pr_title": "ZkClient should not keep retrying getChildren() due to large number of children", "pr_createdAt": "2020-06-22T07:44:34Z", "pr_url": "https://github.com/apache/helix/pull/1109", "timeline": [{"oid": "ef6c44bf124840296e0b602a0fe5f3121c90a0b3", "url": "https://github.com/apache/helix/commit/ef6c44bf124840296e0b602a0fe5f3121c90a0b3", "message": "Stat check for listing children", "committedDate": "2020-06-22T07:46:10Z", "type": "forcePushed"}, {"oid": "50672b93dc92d978bae3775b31a09134abb51316", "url": "https://github.com/apache/helix/commit/50672b93dc92d978bae3775b31a09134abb51316", "message": "Stat check for listing children", "committedDate": "2020-06-22T08:14:15Z", "type": "forcePushed"}, {"oid": "fa8b75f1127685fc5dfa1addbc097f289143783e", "url": "https://github.com/apache/helix/commit/fa8b75f1127685fc5dfa1addbc097f289143783e", "message": "Stat check for listing children", "committedDate": "2020-06-22T08:17:50Z", "type": "forcePushed"}, {"oid": "088d8cffca6f373ed4f7a7070454288523fd8471", "url": "https://github.com/apache/helix/commit/088d8cffca6f373ed4f7a7070454288523fd8471", "message": "Stat check for listing children", "committedDate": "2020-06-22T08:28:18Z", "type": "commit"}, {"oid": "088d8cffca6f373ed4f7a7070454288523fd8471", "url": "https://github.com/apache/helix/commit/088d8cffca6f373ed4f7a7070454288523fd8471", "message": "Stat check for listing children", "committedDate": "2020-06-22T08:28:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MjU1Ng==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443652556", "bodyText": "Please add a TODO item here to state this is just a workaround fix because zookeeper does not return the failure reason if it fails to read a large children list.", "author": "lei-xia", "createdAt": "2020-06-22T15:41:39Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -103,6 +108,17 @@\n   // ZkEventThread. Otherwise the retry request might block the normal event processing.\n   protected final ZkAsyncRetryThread _asyncCallRetryThread;\n \n+  static {", "originalCommit": "088d8cffca6f373ed4f7a7070454288523fd8471", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNTE3Mg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443715172", "bodyText": "I added a TODO at getChildren() so when we remove that code part at getChildren(), we will also remove this private LIMIT. To make it clear, I also add a TODO for NUM_CHILDREN_LIMIT.", "author": "huizhilu", "createdAt": "2020-06-22T17:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MjU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDMwNQ==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443654305", "bodyText": "If we say there is no existing exception that can reflect the real failure here, why not extend a new ZookeeperException here?", "author": "lei-xia", "createdAt": "2020-06-22T15:44:08Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -984,11 +1000,43 @@ private void fireAllEvents() {\n \n   protected List<String> getChildren(final String path, final boolean watch) {\n     long startT = System.currentTimeMillis();\n+    // Need one element array to change value of this final variable.\n+    final int[] connectionLossRetryCount = {0};\n     try {\n       List<String> children = retryUntilConnected(new Callable<List<String>>() {\n         @Override\n         public List<String> call() throws Exception {\n-          return getConnection().getChildren(path, watch);\n+          try {\n+            return getConnection().getChildren(path, watch);\n+          } catch (ConnectionLossException e) {\n+            ++connectionLossRetryCount[0];\n+            // Allow retrying 3 times before checking stat checking number of children,\n+            // because there is a higher possibility that connection loss is caused by other\n+            // factors such as network connectivity, connected ZK node could not serve\n+            // the request, session expired, etc.\n+            if (connectionLossRetryCount[0] >= 3) {\n+              // Issue: https://github.com/apache/helix/issues/962\n+              // Connection loss might be caused by an excessive number of children.\n+              // Infinitely retrying connecting may cause high GC in ZK server and kill ZK server.\n+              // This is a workaround to check numChildren to have a chance to exit retry loop.\n+              // TODO: remove this check once we have a better way to exit infinite retry\n+              Stat stat = getStat(path);\n+              if (stat != null && stat.getNumChildren() > NUM_CHILDREN_LIMIT) {\n+                LOG.error(\"Failed to get children for path {} because number of children {} \"\n+                        + \"exceeds limit {}, aborting retry.\", path, stat.getNumChildren(),\n+                    NUM_CHILDREN_LIMIT);\n+                // There is not an accurate KeeperException for the purpose.\n+                // MarshallingErrorException could represent transport error,\n+                // so use it to exit retry loop and tell that zk is not able to\n+                // transport the data because packet length is too large.\n+                throw new KeeperException.MarshallingErrorException();", "originalCommit": "088d8cffca6f373ed4f7a7070454288523fd8471", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgxNjQxNA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443816414", "bodyText": "@lei-xia KeeperException is an abstract class and it is not flexible for us to extend to have a new exception code. Say if we create a new exception type\nPacketOutOfLenException extends KeeperException {\n   PacketOutOfLenException(code) {\n      super(code);\n   }\n}\n\nIf we use a different code other than existing defined code, KeeperException won't be able to recognize it and will throw IllegalArgumentException(Invalid exception code). I don't think this is what we need.\nComparing all the exception types in KeeperException, I think MarshallingErrorException is the closest one that represents the failure reason: failed at transport layer.\nWhen ZkClient throws MarshallingErrorException, we'll have error log \"Failed to get children for path {} because number of children {} exceeds limit {}, aborting retry.\" and know the error is because of large children listing.\nWhat do you think?", "author": "huizhilu", "createdAt": "2020-06-22T20:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDYwNw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443654607", "bodyText": "? this pattern looks very confusing, why not use a regular integer, what do you try to achieve here?", "author": "lei-xia", "createdAt": "2020-06-22T15:44:37Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -984,11 +1000,43 @@ private void fireAllEvents() {\n \n   protected List<String> getChildren(final String path, final boolean watch) {\n     long startT = System.currentTimeMillis();\n+    // Need one element array to change value of this final variable.\n+    final int[] connectionLossRetryCount = {0};", "originalCommit": "088d8cffca6f373ed4f7a7070454288523fd8471", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNjQ0Mw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443716443", "bodyText": "This variable needs to be accessed in inner class Callable so it needs to be final.\nAnd since it is final, we could not increment the value if we make a an integer. So we need this one element array to change value of this final variable. I understand it looks a bit ugly, but since we are removing the code part in a few months once we have a better way in zk server, I wanted to make it simple without creating a wrapper class.", "author": "huizhilu", "createdAt": "2020-06-22T17:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2Mjk1OA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443762958", "bodyText": "Can we use these wrapped integer types?", "author": "lei-xia", "createdAt": "2020-06-22T18:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2NTc3Mw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443765773", "bodyText": "Also, connectionLossRetryCount seems only used within callable, why not define within the callable function?", "author": "lei-xia", "createdAt": "2020-06-22T19:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwMzIyOA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443803228", "bodyText": "Considering clean code, I think we could implement a GetChildrenCallable class that has the counter internally, so we could get rid of the one element array. It will look better", "author": "huizhilu", "createdAt": "2020-06-22T20:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwOTcxMQ==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443809711", "bodyText": "Resolved. I was thinking in the lambda way that we could not define the private member in callable class but actually we could when we new a callable class.. Kind of missing the old stuff.", "author": "huizhilu", "createdAt": "2020-06-22T20:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NDYwNw=="}], "type": "inlineReview"}, {"oid": "c716568af44563c1e920d043f32c35531c18c7fc", "url": "https://github.com/apache/helix/commit/c716568af44563c1e920d043f32c35531c18c7fc", "message": "Reset connection loss count if num children is less than limit.", "committedDate": "2020-06-22T17:19:28Z", "type": "commit"}, {"oid": "e1fb62b0a6d8cf61f62e8fc8223d22d942874413", "url": "https://github.com/apache/helix/commit/e1fb62b0a6d8cf61f62e8fc8223d22d942874413", "message": "Simplify comments.", "committedDate": "2020-06-22T17:50:57Z", "type": "commit"}, {"oid": "a4c674d96f3989f84af620d208de905a15e80901", "url": "https://github.com/apache/helix/commit/a4c674d96f3989f84af620d208de905a15e80901", "message": "Move connection loss count to callable.", "committedDate": "2020-06-22T20:30:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5OTUzNQ==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443899535", "bodyText": "What's the reason we choose to use static block for initing NUM_CHILDREN_LIMIT but leaving MAX_RECONNECT_INTERVAL_MS as a static final var?", "author": "jiajunwang", "createdAt": "2020-06-23T00:44:25Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -103,6 +109,13 @@\n   // ZkEventThread. Otherwise the retry request might block the normal event processing.\n   protected final ZkAsyncRetryThread _asyncCallRetryThread;\n \n+  static {", "originalCommit": "a4c674d96f3989f84af620d208de905a15e80901", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNjE0Nw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443906147", "bodyText": "I don't want to change the original init way for MAX_RECONNECT_INTERVAL_MS.\nLike I comment, in terms of NUM_CHILDREN_LIMIT, the purpose is for unit test. I explain it in comment: Set it here for unit test to use reflection to change value because compilers optimize constants by replacing them inline. If we don't do it like this, we would not be able to unit test getChildren() unless we create > 100K children.", "author": "huizhilu", "createdAt": "2020-06-23T01:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5OTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk2MDI0Mg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443960242", "bodyText": "That is a new way of testing for me. But I saw you modified packetLen in the ClientCnxn, which is initialized like this,\npublic static final int packetLen = Integer.getInteger(\"jute.maxbuffer\", 4096 * 1024);\nDoes it mean even we do\nprivate static final int NUM_CHILDREN_LIMIT = 100 * 1000;\nthe test will still work?", "author": "jiajunwang", "createdAt": "2020-06-23T04:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5OTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMxNzMxNg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r445317316", "bodyText": "@jiajunwang No, the test will not work, because compilers optimize it inline:\ngetChildren() {\n  if (stat.getNumChildren() > 100 * 1000) { }\n}\n\nWe would like to avoid that and keep the variable. So the static block is used.\nIn the version 3.4.13 of zk we use, the packetLen also declares in this way.\npublic static final int packetLen;\n\n  static {\n    if (LOG.isDebugEnabled()) {\n      LOG.debug(\"zookeeper.disableAutoWatchReset is \" + disableAutoWatchReset);\n    }\n\n    packetLen = Integer.getInteger(\"jute.maxbuffer\", 4194304);\n  }\n\nFYI, packetLen is removed in newer version of ZK.", "author": "huizhilu", "createdAt": "2020-06-25T05:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5OTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNjExNQ==", "url": "https://github.com/apache/helix/pull/1109#discussion_r447316115", "bodyText": "Thanks for the explanation.", "author": "jiajunwang", "createdAt": "2020-06-29T23:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5OTUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443904314", "bodyText": "BadArgumentsException looks better than this one.", "author": "jiajunwang", "createdAt": "2020-06-23T01:02:51Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -984,11 +997,51 @@ private void fireAllEvents() {\n \n   protected List<String> getChildren(final String path, final boolean watch) {\n     long startT = System.currentTimeMillis();\n+\n     try {\n       List<String> children = retryUntilConnected(new Callable<List<String>>() {\n+        private int connectionLossRetryCount = 0;\n+\n         @Override\n         public List<String> call() throws Exception {\n-          return getConnection().getChildren(path, watch);\n+          try {\n+            return getConnection().getChildren(path, watch);\n+          } catch (ConnectionLossException e) {\n+            ++connectionLossRetryCount;\n+            // Allow retrying 3 times before checking stat checking number of children,\n+            // because there is a higher possibility that connection loss is caused by other\n+            // factors such as network connectivity, connected ZK node could not serve\n+            // the request, session expired, etc.\n+            if (connectionLossRetryCount >= 3) {\n+              // Issue: https://github.com/apache/helix/issues/962\n+              // Connection loss might be caused by an excessive number of children.\n+              // Infinitely retrying connecting may cause high GC in ZK server and kill ZK server.\n+              // This is a workaround to check numChildren to have a chance to exit retry loop.\n+              // TODO: remove this check once we have a better way to exit infinite retry\n+              Stat stat = getStat(path);\n+              if (stat != null) {\n+                if (stat.getNumChildren() > NUM_CHILDREN_LIMIT) {\n+                  LOG.error(\"Failed to get children for path {} because number of children {} \"\n+                          + \"exceeds limit {}, aborting retry.\", path, stat.getNumChildren(),\n+                      NUM_CHILDREN_LIMIT);\n+                  // There is not an accurate KeeperException for the purpose.\n+                  // MarshallingErrorException could represent transport error,\n+                  // so use it to exit retry loop and tell that zk is not able to\n+                  // transport the data because packet length is too large.\n+                  throw new KeeperException.MarshallingErrorException();", "originalCommit": "a4c674d96f3989f84af620d208de905a15e80901", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwODIzNg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443908236", "bodyText": "I considered both. BadArgumentsException was the one I tried to use, but realized that MarshallingErrorException could represent a transport error and mostly mean data exceeds jute.maxbuffer. Here is an example: https://tgockel.github.io/zookeeper-cpp/classzk_1_1marshalling__error.html#details\nAn error occurred while marshalling data. The most common cause of this is exceeding the Jute buffer size \u2013 meaning the transaction was too large\nSo I decided to choose MarshallingError.  BadArgumentsException for me sounds more like the API is misused, eg, invalid path that has extra slash \"/path/\".", "author": "huizhilu", "createdAt": "2020-06-23T01:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk1ODQ1Mg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443958452", "bodyText": "Sounds good. So just mention this point instead of saying there is no accurate exception? It seems to be accurate.\nAnother option is to throw an HelixException, or some new zkclient exception that we invent. Either way works, I think.", "author": "jiajunwang", "createdAt": "2020-06-23T04:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk3NDE5Mg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r443974192", "bodyText": "OK. Let me just remove that line of comment to avoid confusion :)\nConsidering backward compatibility, if a KeeperException is thrown for the operation, it will be converted to ZkException. If user catches ZkException and handles it, there is no impact, their app still runs.\nIf we throw a ZkException (we don't throw HelixException since we've separate zk module from helix), it will be converted to a RuntimeException, which may cause ZkClient users terminated if they don't catch RuntimeException.\nOr an option is: we change retryUntilConnected to also catch ZkException. With this change, we could throw ZkException with a message indicating \"Large children error\" and so don't have to log and throw exception. I am not sure if we would like to change retryUntilConnected considering this is a workaround and later we remove the logic. What do you think about this option? @jiajunwang", "author": "huizhilu", "createdAt": "2020-06-23T05:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNTA3Mg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r445205072", "bodyText": "If user catches ZkException and handles it, there is extra impact, their app still runs.\nDo you mean there is no extra impact?\nOverall, I am a little bit confused. I think ZkException is what we (IOItech) convert from KeeperException to. Upper layer sees ZkException, they don't deal with KeeperException (which is from Zookeeper client).\nIn this case, as long as ZkClient event thread can catch this ZkException and don't terminate, that is what we want, right?\nAm I missing something?", "author": "kaisun2000", "createdAt": "2020-06-24T22:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIxNTM3OA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r445215378", "bodyText": "@kaisun2000 Yeah you caught it. I meant there is no extra impact. Sorry for the confusion.\nYes, as I mentioned, there are two options:\n\nthrow KeeperException.MarshallingErrorException. This will be converted by retryUntilConnected to ZkException. Benefit is we don't change retryUntilConnected.\nthrow ZkException. Benefit is we could add message in the exception. But we have to change retryUntilConnected to catch ZkException and rethrow it. Considering this is a workaround and later we remove the logic, I use KeeperException.MarshallingErrorException here. What do you think? @kaisun2000", "author": "huizhilu", "createdAt": "2020-06-24T22:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNjEwMw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r445226103", "bodyText": "As discussed offline. Here is the basic principle inherited from IOITech\nthis layer, we see KeeperException,\nuser see ZkException,\nretryUntilConnected, throw convert KeeperException to ZkException and throw ZkException.\nAnd user of ZkClient sees and handles various subtype of ZkException\nHere is an idea:\nSo maybe we can just add another type of ZkException say TooManyChildrenZkException and convert this from retryUntilConnect to this new ZkException. User of ZkClient can handle this TooManyChidrenZkException with whatever logic they want.", "author": "kaisun2000", "createdAt": "2020-06-24T23:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMxOTAxMA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r445319010", "bodyText": "Adding @jiajunwang for extra opinions.\nI understand that and I also thought about it. My take is since this is only a workaround not for long term, I would like to just make it simple.\nIf later we would like to make it nicer because ZK gives a different error code, we could have a sub ZkException like ZkMarshallingError (we already have this exception defined).", "author": "huizhilu", "createdAt": "2020-06-25T05:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwNDMxNA=="}], "type": "inlineReview"}, {"oid": "54b2e0af1f526415f81ed68933ba409348eb1a86", "url": "https://github.com/apache/helix/commit/54b2e0af1f526415f81ed68933ba409348eb1a86", "message": "Clear comments", "committedDate": "2020-06-23T05:47:40Z", "type": "commit"}, {"oid": "54b2e0af1f526415f81ed68933ba409348eb1a86", "url": "https://github.com/apache/helix/commit/54b2e0af1f526415f81ed68933ba409348eb1a86", "message": "Clear comments", "committedDate": "2020-06-23T05:47:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyMjUzOA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r444522538", "bodyText": "Do we need this? If it is connection loss, @jiajunwang 's improvement for retry at zk event thread layer can handle that, right?", "author": "junkaixue", "createdAt": "2020-06-23T21:36:02Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -984,11 +997,50 @@ private void fireAllEvents() {\n \n   protected List<String> getChildren(final String path, final boolean watch) {\n     long startT = System.currentTimeMillis();\n+\n     try {\n       List<String> children = retryUntilConnected(new Callable<List<String>>() {\n+        private int connectionLossRetryCount = 0;\n+\n         @Override\n         public List<String> call() throws Exception {\n-          return getConnection().getChildren(path, watch);\n+          try {\n+            return getConnection().getChildren(path, watch);\n+          } catch (ConnectionLossException e) {\n+            ++connectionLossRetryCount;", "originalCommit": "54b2e0af1f526415f81ed68933ba409348eb1a86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0ODY2MA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r444548660", "bodyText": "@dasahcc My purpose is to avoid stat check for each connection loss, because large children is just a very tiny possibility. And high possibility for network issue/session expiry. Then we could avoid the extra stat call in most of time.\n// Allow retrying 3 times before checking stat checking number of\n//  because there is a higher possibility that connection loss is caused by other\n// factors such as network connectivity, connected ZK node could not serve\n// the request, session expired, etc.", "author": "huizhilu", "createdAt": "2020-06-23T22:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyMjUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNjc5Nw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r445206797", "bodyText": "This test relies on implementation detail of ZKClient. Can we just simulate the real scenario by creating say 10K children with name 100 bytes? Something would stand for longer time.", "author": "kaisun2000", "createdAt": "2020-06-24T22:28:54Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -799,4 +802,66 @@ public void testAsyncWriteOperations() {\n       zkClient.delete(\"/tmp/asyncOversize\");\n     }\n   }\n+\n+  /*\n+   * Tests getChildren() when there are an excessive number of children and connection loss happens,\n+   * the operation should terminate and exit retry loop.\n+   */\n+  @Test\n+  public void testGetChildrenOnLargeNumChildren() throws Exception {\n+    // Default packetLen is 4M. It is static final and initialized", "originalCommit": "54b2e0af1f526415f81ed68933ba409348eb1a86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMyMDc0Mg==", "url": "https://github.com/apache/helix/pull/1109#discussion_r445320742", "bodyText": "I don't think it is necessary, because anyway it checks jute.maxbuffer. What you mean 10K children nodes are for 4 MB, it is still defined by jute.maxbuffer. We adjust this value to smaller one for testing so only 5 children are needed. Either 100K or 5, it is behaving the same, why would we bother to create 10K children, right? :)", "author": "huizhilu", "createdAt": "2020-06-25T05:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNjc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNzY5NA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r447317694", "bodyText": "I think we removed this because many clients complaining that this retry log floods their log file. Please make it debug or don't add it.", "author": "jiajunwang", "createdAt": "2020-06-29T23:33:29Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -1503,12 +1555,14 @@ private void acquireEventLock() {\n         } catch (Exception e) {\n           throw ExceptionUtil.convertToRuntimeException(e);\n         }\n+\n         // before attempting a retry, check whether retry timeout has elapsed\n         if (System.currentTimeMillis() - operationStartTime > _operationRetryTimeoutInMillis) {\n           throw new ZkTimeoutException(\"Operation cannot be retried because of retry timeout (\"\n               + _operationRetryTimeoutInMillis + \" milli seconds). Retry was caused by \"\n               + retryCauseCode);\n         }\n+        LOG.warn(\"Retrying operation, caused by {}\", retryCauseCode);", "originalCommit": "54b2e0af1f526415f81ed68933ba409348eb1a86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM4NjM3OA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r449386378", "bodyText": "From the debugging experience, it seems this is helpful log indicating retryable error like connection loss or session expired. Otherwise, it keeps retrying silently. Considering flooded logs, maybe we could have a backoff strategy or very N retry times to log it? Just a thought.\nI will not add it for now.", "author": "huizhilu", "createdAt": "2020-07-03T05:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNzY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwNzAxMA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r454107010", "bodyText": "If you change it to debug, we shall be able to see it during the debug practice (by changing the log4j attribute). So Let's do debug for now.", "author": "jiajunwang", "createdAt": "2020-07-14T05:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxNzY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxODQwMw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r447318403", "bodyText": "Let's make the comment clear.\n\"Failed to get children for path {} because of connection loss. Stop retrying because the number of children exceeds......\"", "author": "jiajunwang", "createdAt": "2020-06-29T23:35:27Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -984,11 +997,50 @@ private void fireAllEvents() {\n \n   protected List<String> getChildren(final String path, final boolean watch) {\n     long startT = System.currentTimeMillis();\n+\n     try {\n       List<String> children = retryUntilConnected(new Callable<List<String>>() {\n+        private int connectionLossRetryCount = 0;\n+\n         @Override\n         public List<String> call() throws Exception {\n-          return getConnection().getChildren(path, watch);\n+          try {\n+            return getConnection().getChildren(path, watch);\n+          } catch (ConnectionLossException e) {\n+            ++connectionLossRetryCount;\n+            // Allow retrying 3 times before checking stat checking number of children,\n+            // because there is a higher possibility that connection loss is caused by other\n+            // factors such as network connectivity, connected ZK node could not serve\n+            // the request, session expired, etc.\n+            if (connectionLossRetryCount >= 3) {\n+              // Issue: https://github.com/apache/helix/issues/962\n+              // Connection loss might be caused by an excessive number of children.\n+              // Infinitely retrying connecting may cause high GC in ZK server and kill ZK server.\n+              // This is a workaround to check numChildren to have a chance to exit retry loop.\n+              // TODO: remove this check once we have a better way to exit infinite retry\n+              Stat stat = getStat(path);\n+              if (stat != null) {\n+                if (stat.getNumChildren() > NUM_CHILDREN_LIMIT) {\n+                  LOG.error(\"Failed to get children for path {} because number of children {} \"", "originalCommit": "54b2e0af1f526415f81ed68933ba409348eb1a86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5MTMwOQ==", "url": "https://github.com/apache/helix/pull/1109#discussion_r449391309", "bodyText": "Done.", "author": "huizhilu", "createdAt": "2020-07-03T06:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxODQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxOTU1MQ==", "url": "https://github.com/apache/helix/pull/1109#discussion_r447319551", "bodyText": "I think you might want to keep checking the children's number on any retries after the first 3. Or, what if the children are increased during the retry, right?\nSo just make the logic like,\nif (count < 3 || getChildrenCount() < limit) {\ncount++;\nretry;\n} else {\nexist;\n}", "author": "jiajunwang", "createdAt": "2020-06-29T23:39:03Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -984,11 +997,50 @@ private void fireAllEvents() {\n \n   protected List<String> getChildren(final String path, final boolean watch) {\n     long startT = System.currentTimeMillis();\n+\n     try {\n       List<String> children = retryUntilConnected(new Callable<List<String>>() {\n+        private int connectionLossRetryCount = 0;\n+\n         @Override\n         public List<String> call() throws Exception {\n-          return getConnection().getChildren(path, watch);\n+          try {\n+            return getConnection().getChildren(path, watch);\n+          } catch (ConnectionLossException e) {\n+            ++connectionLossRetryCount;\n+            // Allow retrying 3 times before checking stat checking number of children,\n+            // because there is a higher possibility that connection loss is caused by other\n+            // factors such as network connectivity, connected ZK node could not serve\n+            // the request, session expired, etc.\n+            if (connectionLossRetryCount >= 3) {\n+              // Issue: https://github.com/apache/helix/issues/962\n+              // Connection loss might be caused by an excessive number of children.\n+              // Infinitely retrying connecting may cause high GC in ZK server and kill ZK server.\n+              // This is a workaround to check numChildren to have a chance to exit retry loop.\n+              // TODO: remove this check once we have a better way to exit infinite retry\n+              Stat stat = getStat(path);\n+              if (stat != null) {\n+                if (stat.getNumChildren() > NUM_CHILDREN_LIMIT) {\n+                  LOG.error(\"Failed to get children for path {} because number of children {} \"\n+                          + \"exceeds limit {}, aborting retry.\", path, stat.getNumChildren(),\n+                      NUM_CHILDREN_LIMIT);\n+                  // MarshallingErrorException could represent transport error: exceeding the\n+                  // Jute buffer size. So use it to exit retry loop and tell that zk is not able to\n+                  // transport the data because packet length is too large.\n+                  throw new KeeperException.MarshallingErrorException();\n+                } else {\n+                  // No need to do stat again for next connection loss.\n+                  connectionLossRetryCount = 0;", "originalCommit": "54b2e0af1f526415f81ed68933ba409348eb1a86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM4OTk0OQ==", "url": "https://github.com/apache/helix/pull/1109#discussion_r449389949", "bodyText": "@jiajunwang I would like to check numChildren every 3 connection loss, because:\nallow trying 3 times before checking numChildren, because there is higher possibility connection loss is caused by session expired, etc. I don't want it to check numChildren for each connection loss which will downgrade the performance.\nYour logic here is only allow retrying 3 times, after 3 retries, exit retry loop. This is not what I want. I would still keep the original logic to retry on retry-able connection loss.", "author": "huizhilu", "createdAt": "2020-07-03T05:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxOTU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwODE5Ng==", "url": "https://github.com/apache/helix/pull/1109#discussion_r454108196", "bodyText": "Your logic here is only allow retrying 3 times, after 3 retries, exit retry loop.\n\nCould you please check my logic carefully. It will keep retrying if the ChildrenCount is good. It is \"||\", not \"&&\". It is doing almost the same as your logic. getChildrenCount() won't be called if the count is smaller than 3.\nThis is helping you to simplify the code.", "author": "jiajunwang", "createdAt": "2020-07-14T05:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxOTU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg3ODE5Mw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r454878193", "bodyText": "I think you might want to keep checking the children's number on any retries after the first 3. Or, what if the children are increased during the retry, right?\n\nYes, it will still check numChildren after the first 3 retries. The strategy is check numChildren every other 3 retries.\nYour code checks numChildren every time after the first 3 retries, right? But actually I don't think it is necessary to check every time after 3 retries. I would like to just check numChildren every other 3 retries. So maybe your code could not really simplify the logic. I'll sync up with you.", "author": "huizhilu", "createdAt": "2020-07-15T08:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxOTU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMzMxNw==", "url": "https://github.com/apache/helix/pull/1109#discussion_r447323317", "bodyText": "This is a recursive retryUntilConnect call inside. I think it shall work. But it would be better if we can avoid this recursive call. Basically what you need to do is,\n\nwait until connected.\ncall the native exits() call for the state.\n\nThe benefit is mainly avoiding potential issues if we have retryuntilconnect inside another retry.", "author": "jiajunwang", "createdAt": "2020-06-29T23:50:30Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -984,11 +997,50 @@ private void fireAllEvents() {\n \n   protected List<String> getChildren(final String path, final boolean watch) {\n     long startT = System.currentTimeMillis();\n+\n     try {\n       List<String> children = retryUntilConnected(new Callable<List<String>>() {\n+        private int connectionLossRetryCount = 0;\n+\n         @Override\n         public List<String> call() throws Exception {\n-          return getConnection().getChildren(path, watch);\n+          try {\n+            return getConnection().getChildren(path, watch);\n+          } catch (ConnectionLossException e) {\n+            ++connectionLossRetryCount;\n+            // Allow retrying 3 times before checking stat checking number of children,\n+            // because there is a higher possibility that connection loss is caused by other\n+            // factors such as network connectivity, connected ZK node could not serve\n+            // the request, session expired, etc.\n+            if (connectionLossRetryCount >= 3) {\n+              // Issue: https://github.com/apache/helix/issues/962\n+              // Connection loss might be caused by an excessive number of children.\n+              // Infinitely retrying connecting may cause high GC in ZK server and kill ZK server.\n+              // This is a workaround to check numChildren to have a chance to exit retry loop.\n+              // TODO: remove this check once we have a better way to exit infinite retry\n+              Stat stat = getStat(path);", "originalCommit": "54b2e0af1f526415f81ed68933ba409348eb1a86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5NDM0NA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r449394344", "bodyText": "I also thought about it. It would have nested retryUntilConnected. The benefit is it would retry to get the stat if there is connection loss for getStat(). If we use native exists() and there is connection loss, it would not retry and instead go back to getChildren() again.\nThe potential issue could be the retry timeout, because new retryUntilConnected() has a new start time. So getState() would potentially retry longer than the configured retry timeout for getChildren().\nI don't have a strong preference. Seems you prefer native exits(), I'll change it.", "author": "huizhilu", "createdAt": "2020-07-03T06:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMzMxNw=="}], "type": "inlineReview"}, {"oid": "cb3bcdce4c781b98fcdec5c0fbc2038900b610e1", "url": "https://github.com/apache/helix/commit/cb3bcdce4c781b98fcdec5c0fbc2038900b610e1", "message": "Remove retry warn log", "committedDate": "2020-07-03T06:14:55Z", "type": "commit"}, {"oid": "cb3bcdce4c781b98fcdec5c0fbc2038900b610e1", "url": "https://github.com/apache/helix/commit/cb3bcdce4c781b98fcdec5c0fbc2038900b610e1", "message": "Remove retry warn log", "committedDate": "2020-07-03T06:14:55Z", "type": "forcePushed"}, {"oid": "1921623b97f103b4965af5d3c1d7d98a926a5c88", "url": "https://github.com/apache/helix/commit/1921623b97f103b4965af5d3c1d7d98a926a5c88", "message": "Simplify comments.", "committedDate": "2020-07-22T20:52:30Z", "type": "commit"}, {"oid": "90e5aee6c0192dfd370bb87921da64e793aeffa4", "url": "https://github.com/apache/helix/commit/90e5aee6c0192dfd370bb87921da64e793aeffa4", "message": "Wrap private method checkNumChildren", "committedDate": "2020-07-22T21:24:53Z", "type": "commit"}, {"oid": "90e5aee6c0192dfd370bb87921da64e793aeffa4", "url": "https://github.com/apache/helix/commit/90e5aee6c0192dfd370bb87921da64e793aeffa4", "message": "Wrap private method checkNumChildren", "committedDate": "2020-07-22T21:24:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5MzY4OA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r459093688", "bodyText": "I just noticed this issue. So you only check on connection loss exception. What if when you call this exists, the connection has not been recovered yet? This is very possible since there is no other operation or waits between the error and this exists() call.\nIn this case, the check will throw an exception, and the retry until connect call will also return unexpectedly.\nI think we need to wait until connected here.", "author": "jiajunwang", "createdAt": "2020-07-22T21:27:19Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -2216,4 +2253,25 @@ private void validateCurrentThread() {\n       throw new IllegalArgumentException(\"Must not be done in the zookeeper event thread.\");\n     }\n   }\n+\n+  private void checkNumChildren(String path) throws KeeperException, InterruptedException {\n+    Stat stat = ((ZkConnection) getConnection()).getZookeeper().exists(path, false);", "originalCommit": "90e5aee6c0192dfd370bb87921da64e793aeffa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwNDU2OA==", "url": "https://github.com/apache/helix/pull/1109#discussion_r459104568", "bodyText": "@jiajunwang Good catch! I used to call getStat() considering reconnect. By somehow I changed it to exists() which is not supposed to. I believe getStat() is what we need: wait until connected and monitoring. Regarding nested retry until connected, it is fine because if getStat keeps getting connection loss and retrying, even we don't use getStat(), it'll be retrying as well in getChildren.\nReverted to getStat()", "author": "huizhilu", "createdAt": "2020-07-22T21:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5MzY4OA=="}], "type": "inlineReview"}, {"oid": "0e01d4d4e765860a9b77531e26023001129db256", "url": "https://github.com/apache/helix/commit/0e01d4d4e765860a9b77531e26023001129db256", "message": "getStat()", "committedDate": "2020-07-22T21:47:21Z", "type": "commit"}]}