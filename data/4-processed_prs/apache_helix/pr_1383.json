{"pr_number": 1383, "pr_title": "Add Metrics for External Custom Health Check Requests", "pr_createdAt": "2020-09-20T20:24:56Z", "pr_url": "https://github.com/apache/helix/pull/1383", "timeline": [{"oid": "46d54e3d2edaea77bf0e47d70dacfe774b73b737", "url": "https://github.com/apache/helix/commit/46d54e3d2edaea77bf0e47d70dacfe774b73b737", "message": "Add custom metrics", "committedDate": "2020-09-20T20:26:52Z", "type": "forcePushed"}, {"oid": "5a07b173e7247ca4ec10a628499451bfc03e077d", "url": "https://github.com/apache/helix/commit/5a07b173e7247ca4ec10a628499451bfc03e077d", "message": "Add custom metrics", "committedDate": "2020-09-21T03:49:34Z", "type": "forcePushed"}, {"oid": "d9404665ac53876e1b977310684e528e1238c236", "url": "https://github.com/apache/helix/commit/d9404665ac53876e1b977310684e528e1238c236", "message": "Add metrics for custom rest client requests", "committedDate": "2020-09-22T02:13:41Z", "type": "commit"}, {"oid": "d9404665ac53876e1b977310684e528e1238c236", "url": "https://github.com/apache/helix/commit/d9404665ac53876e1b977310684e528e1238c236", "message": "Add metrics for custom rest client requests", "committedDate": "2020-09-22T02:13:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NDQxNg==", "url": "https://github.com/apache/helix/pull/1383#discussion_r492454416", "bodyText": "In case of an exception, the time will be also counted in the request duration, right? Is this what in the design? I think this will make the duration statistic less accurate.", "author": "zhangmeng916", "createdAt": "2020-09-22T03:20:46Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HelixDataAccessorWrapper.java", "diffHunk": "@@ -166,12 +187,18 @@ public HelixDataAccessorWrapper(ZKHelixDataAccessor dataAccessor, CustomRestClie\n \n   private Map<String, Boolean> getHealthStatusFromRest(String instance, List<String> partitions,\n       RESTConfig restConfig, Map<String, String> customPayLoads) {\n-    try {\n+    MetricRegistry metrics = SharedMetricRegistries.getOrCreate(_namespace);\n+    Counter requestsTotal = metrics.counter(CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_TOTAL);\n+    Counter errorRequestsTotal = metrics.counter(CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_ERROR_TOTAL);\n+    try (final Timer.Context timer = metrics.timer(CUSTOM_PARTITION_CHECK_HTTP_REQUEST_DURATION)", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxODUyNg==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496318526", "bodyText": "It won't make the duration statistic too bad, compared with network IO. CPU is really fast to process the exception. Actually we still need to use a try... finally block - same as this try.. with..resource.", "author": "huizhilu", "createdAt": "2020-09-29T01:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NDQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NDg0Nw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r492454847", "bodyText": "nit: variable name to be consistent with metric name to avoid misuse.", "author": "zhangmeng916", "createdAt": "2020-09-22T03:22:47Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java", "diffHunk": "@@ -231,14 +252,22 @@ private StoppableCheck performHelixOwnInstanceCheck(String clusterId, String ins\n   private StoppableCheck performCustomInstanceCheck(String clusterId, String instanceName,\n       String baseUrl, Map<String, String> customPayLoads) {\n     LOG.info(\"Perform instance level client side health checks for {}/{}\", clusterId, instanceName);\n-    try {\n-      return new StoppableCheck(\n-          _customRestClient.getInstanceStoppableCheck(baseUrl, customPayLoads),\n+    MetricRegistry metrics = SharedMetricRegistries.getOrCreate(_namespace);\n+    Counter requestsTotal = metrics.counter(CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_TOTAL);\n+    Counter errorRequestsTotal = metrics.counter(CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_ERROR_TOTAL);", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE5MDQ1MQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495190451", "bodyText": "It is lazily initialized, let's don't call it without a real error.\nI would prefer just coding like the following, so you don't need the extra local fields def.\nmetrics.counter(CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_TOTAL).inc();", "author": "jiajunwang", "createdAt": "2020-09-25T19:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMzNDg5MQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496334891", "bodyText": "Resolved.", "author": "huizhilu", "createdAt": "2020-09-29T02:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NDg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTM4MQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r492455381", "bodyText": "More specifically, this is \"health\" check. Maybe you can make it more accurate in case you have other types of instance check metrics later and need to distinguish between them.\nSame for partition health check.", "author": "zhangmeng916", "createdAt": "2020-09-22T03:25:30Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java", "diffHunk": "@@ -58,9 +63,18 @@\n   private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();\n   private static final ExecutorService POOL = Executors.newCachedThreadPool();\n \n+  // Metric names for custom instance check\n+  private static final String CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_TOTAL =", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNDc5MQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496324791", "bodyText": "This naming is based on the method/function. It is a generic interface api getInstanceStoppableCheck, so no matter it is a health check or else, as long as it calls this api, we record it. What do you think?", "author": "huizhilu", "createdAt": "2020-09-29T01:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTkwMw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r492455903", "bodyText": "Shall we mark this as deprecated?", "author": "zhangmeng916", "createdAt": "2020-09-22T03:28:07Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HelixDataAccessorWrapper.java", "diffHunk": "@@ -54,15 +60,30 @@\n   public static final String IS_HEALTHY_KEY = \"IS_HEALTHY\";\n   public static final String EXPIRY_KEY = \"EXPIRE\";\n \n+  // Metric names for custom partition check\n+  private static final String CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_TOTAL =\n+      MetricRegistry.name(InstanceService.class, \"custom_partition_check_http_requests_total\");\n+  private static final String CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_ERROR_TOTAL = MetricRegistry\n+      .name(InstanceService.class, \"custom_partition_check_http_requests_error_total\");\n+  private static final String CUSTOM_PARTITION_CHECK_HTTP_REQUEST_DURATION =\n+      MetricRegistry.name(InstanceService.class, \"custom_partition_check_http_request_duration\");\n+\n   private final Map<PropertyKey, HelixProperty> _propertyCache = new HashMap<>();\n   private final Map<PropertyKey, List<String>> _batchNameCache = new HashMap<>();\n+  private String _namespace;\n   protected CustomRestClient _restClient;\n \n   public HelixDataAccessorWrapper(ZKHelixDataAccessor dataAccessor) {", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxODA0Mg==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496318042", "bodyText": "I was thinking other callers may use it. Within helix, only a mock class calls it. So I just changed it and deprecate this, assuming this constructor is supposed to be used within helix rest.", "author": "huizhilu", "createdAt": "2020-09-29T01:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NjE5Nw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495186197", "bodyText": "How do we determine the metric type (gauge or counter) later when we want to expose the MBean attribute to the monitoring system?", "author": "jiajunwang", "createdAt": "2020-09-25T19:20:50Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HelixDataAccessorWrapper.java", "diffHunk": "@@ -54,15 +60,30 @@\n   public static final String IS_HEALTHY_KEY = \"IS_HEALTHY\";\n   public static final String EXPIRY_KEY = \"EXPIRE\";\n \n+  // Metric names for custom partition check\n+  private static final String CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_TOTAL =\n+      MetricRegistry.name(InstanceService.class, \"custom_partition_check_http_requests_total\");", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxNDc3NQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496314775", "bodyText": "In the object name, there is a type property for us to know that: type=counters or type=gauges. Then we'll use the type property.", "author": "huizhilu", "createdAt": "2020-09-29T00:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NjE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQyMDQxMw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496420413", "bodyText": "This is a good design actually. But it conflicts with our current assumption that the metric name contains GUAGE or COUNTER keyword. Please suggest how you think we shall let them work together? Or shall we modify our current metrics to include this type field too?", "author": "jiajunwang", "createdAt": "2020-09-29T05:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NjE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU5Mjg0OQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496592849", "bodyText": "Helix-core is using keyword Counter/Gauge to represent the metric type. Either works. I'd like more inserting the type into object name, if we expect users to parse object names in mbean server. And it gives more flexibility/space to name a metric without Counter/Gauge. It can also be \"time\", \"latency\", \"total\", \"requests_queued\", etc..\nMore easily and concisely, I would suggest we can have a centralized metrics exposed to users so users can use the metrics class to get helix metrics.\nHelixRestMetrics { // or HelixCoreMetrics\n  public final Counter custom_call_request;\n  public final Gauge request_latency;\n}", "author": "huizhilu", "createdAt": "2020-09-29T09:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NjE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NzA2MQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495187061", "bodyText": "Why not clear?", "author": "jiajunwang", "createdAt": "2020-09-25T19:22:53Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/HelixRestServer.java", "diffHunk": "@@ -222,7 +222,6 @@ public void shutdown() {\n       }\n     }\n     _jmxReporterList.forEach(JmxReporter::stop);\n-    _jmxReporterList.clear();", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNTY1Ng==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496325656", "bodyText": "Somehow happened when rebasing/merging code from another local branch. Not intended.", "author": "huizhilu", "createdAt": "2020-09-29T01:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NzA2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE5MDg5OQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495190899", "bodyText": "metrics.timer(CUSTOM_INSTANCE_CHECK_HTTP_REQUEST_DURATION).time() is enough? You are not using the timer object in the try code block anyway, right?", "author": "jiajunwang", "createdAt": "2020-09-25T19:31:22Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java", "diffHunk": "@@ -231,14 +252,22 @@ private StoppableCheck performHelixOwnInstanceCheck(String clusterId, String ins\n   private StoppableCheck performCustomInstanceCheck(String clusterId, String instanceName,\n       String baseUrl, Map<String, String> customPayLoads) {\n     LOG.info(\"Perform instance level client side health checks for {}/{}\", clusterId, instanceName);\n-    try {\n-      return new StoppableCheck(\n-          _customRestClient.getInstanceStoppableCheck(baseUrl, customPayLoads),\n+    MetricRegistry metrics = SharedMetricRegistries.getOrCreate(_namespace);\n+    Counter requestsTotal = metrics.counter(CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_TOTAL);\n+    Counter errorRequestsTotal = metrics.counter(CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_ERROR_TOTAL);\n+\n+    try (final Timer.Context timer = metrics.timer(CUSTOM_INSTANCE_CHECK_HTTP_REQUEST_DURATION)", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxOTY1Mw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496319653", "bodyText": "Java 8 try..with..resource needs this variable, though we won't use it in the block :). Maybe a newer java supports it.", "author": "huizhilu", "createdAt": "2020-09-29T01:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE5MDg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQyNDI1MA==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496424250", "bodyText": "I see. It needs a local variable to do the trick. It looks strange but as long as it works, I'm good.", "author": "jiajunwang", "createdAt": "2020-09-29T05:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE5MDg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNzU5MQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495207591", "bodyText": "_namespace is not a must logic for the class, so I suggest adding a set method for it instead of adding a constructor.\nIf the namespace is not set, then just skip the metrics logic.", "author": "jiajunwang", "createdAt": "2020-09-25T20:09:12Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HelixDataAccessorWrapper.java", "diffHunk": "@@ -54,15 +60,30 @@\n   public static final String IS_HEALTHY_KEY = \"IS_HEALTHY\";\n   public static final String EXPIRY_KEY = \"EXPIRE\";\n \n+  // Metric names for custom partition check\n+  private static final String CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_TOTAL =\n+      MetricRegistry.name(InstanceService.class, \"custom_partition_check_http_requests_total\");\n+  private static final String CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_ERROR_TOTAL = MetricRegistry\n+      .name(InstanceService.class, \"custom_partition_check_http_requests_error_total\");\n+  private static final String CUSTOM_PARTITION_CHECK_HTTP_REQUEST_DURATION =\n+      MetricRegistry.name(InstanceService.class, \"custom_partition_check_http_request_duration\");\n+\n   private final Map<PropertyKey, HelixProperty> _propertyCache = new HashMap<>();\n   private final Map<PropertyKey, List<String>> _batchNameCache = new HashMap<>();\n+  private String _namespace;", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNjI0MA==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496326240", "bodyText": "In helix rest logic, I think we need to pass the namespace to this wrapper so partition check metrics could be namespaced, otherwise, we won't be able to record namespaced metrics for this partition check.", "author": "huizhilu", "createdAt": "2020-09-29T01:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNzU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzNzEzNg==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496437136", "bodyText": "High-levelly, I think we shall try our best to ensure that the metrics logic does not impact business logic. But the current implementation has 2 impacts at least.\n\nMore constructors, harder to use.\nWe enforce the business logic to have separate accessor wrapper for different namespaces. This does not make much sense if you consider the resource usage, object management, etc.\nOn the other hand, if we do not let the data accessor wrapper record the namespace, then the metrics can be recorded in the callers. This is a trade-off.\n\nWith the current implementation, I actually agree with put it inside the wrapper class. But we shall try to pass the namespace in a more direct way. For example, since we are enforcing the wrapper object serve for one namespace only, we can construct the wrapper object inside the InstanceServiceImpl. In this way, you are passing the namespace only once. And there is no way for the other devs to introduce inconsistent namespace parameters.", "author": "jiajunwang", "createdAt": "2020-09-29T06:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNzU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3Mjk5MQ==", "url": "https://github.com/apache/helix/pull/1383#discussion_r497072991", "bodyText": "This is a good suggestion. Previously I was not intended to change the constructor of InstanceServiceImpl. As you mentioned, helix rest is expected to be internal, so I think it is fine to change the signature. I have constructed the wrapper object inside the InstanceServiceImpl.", "author": "huizhilu", "createdAt": "2020-09-29T21:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNzU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwODEzNA==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495208134", "bodyText": "Please check my comments for the instance accessor, the same here. Please lazily get and simplify the code whenever possible.", "author": "jiajunwang", "createdAt": "2020-09-25T20:10:28Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HelixDataAccessorWrapper.java", "diffHunk": "@@ -166,12 +187,18 @@ public HelixDataAccessorWrapper(ZKHelixDataAccessor dataAccessor, CustomRestClie\n \n   private Map<String, Boolean> getHealthStatusFromRest(String instance, List<String> partitions,\n       RESTConfig restConfig, Map<String, String> customPayLoads) {\n-    try {\n+    MetricRegistry metrics = SharedMetricRegistries.getOrCreate(_namespace);\n+    Counter requestsTotal = metrics.counter(CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_TOTAL);\n+    Counter errorRequestsTotal = metrics.counter(CUSTOM_PARTITION_CHECK_HTTP_REQUESTS_ERROR_TOTAL);", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTEwNw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495209107", "bodyText": "You can get namespace from dataAccessor? Please try to ensure there is only one source of truth.", "author": "jiajunwang", "createdAt": "2020-09-25T20:12:42Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java", "diffHunk": "@@ -58,9 +63,18 @@\n   private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();\n   private static final ExecutorService POOL = Executors.newCachedThreadPool();\n \n+  // Metric names for custom instance check\n+  private static final String CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_TOTAL =\n+      MetricRegistry.name(InstanceService.class, \"custom_instance_check_http_requests_total\");\n+  private static final String CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_ERROR_TOTAL =\n+      MetricRegistry.name(InstanceService.class, \"custom_instance_check_http_requests_error_total\");\n+  private static final String CUSTOM_INSTANCE_CHECK_HTTP_REQUEST_DURATION =\n+      MetricRegistry.name(InstanceService.class, \"custom_instance_check_http_request_duration\");\n+\n   private final HelixDataAccessorWrapper _dataAccessor;", "originalCommit": "d9404665ac53876e1b977310684e528e1238c236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMDExNw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r495210117", "bodyText": "Or do we share the same accessor across multiple service implementation? If that's the case, we need to reconsider the design.", "author": "jiajunwang", "createdAt": "2020-09-25T20:15:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxODk4OA==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496318988", "bodyText": "No :) You got it. The first PR was a draft. A constructor with namespace is passed in, I didn't push the change yet when you saw this. Updated.", "author": "huizhilu", "createdAt": "2020-09-29T01:14:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzNzc0MA==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496437740", "bodyText": "As commented above, passing the namespace twice in one line of code is not a good design. If you are convinced that the wrapper object should be limited so serve only one service impl, then let's move it inside.", "author": "jiajunwang", "createdAt": "2020-09-29T06:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3MDE4MA==", "url": "https://github.com/apache/helix/pull/1383#discussion_r497070180", "bodyText": "Moved. Thx.", "author": "huizhilu", "createdAt": "2020-09-29T21:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTEwNw=="}], "type": "inlineReview"}, {"oid": "6d9050c7e1a7dfab79acd0142665a3c6375c6d41", "url": "https://github.com/apache/helix/commit/6d9050c7e1a7dfab79acd0142665a3c6375c6d41", "message": "Fix tests", "committedDate": "2020-09-29T01:09:16Z", "type": "forcePushed"}, {"oid": "13c107972c01aeafabb2b48a607fc080a135a0f4", "url": "https://github.com/apache/helix/commit/13c107972c01aeafabb2b48a607fc080a135a0f4", "message": "Fix tests", "committedDate": "2020-09-29T01:27:20Z", "type": "forcePushed"}, {"oid": "f497030839029f05cbd12fcba1d489c3a209183e", "url": "https://github.com/apache/helix/commit/f497030839029f05cbd12fcba1d489c3a209183e", "message": "Fix tests", "committedDate": "2020-09-29T01:32:38Z", "type": "forcePushed"}, {"oid": "858a9474c01a5a1e03e3f767081b64337a6b7c1c", "url": "https://github.com/apache/helix/commit/858a9474c01a5a1e03e3f767081b64337a6b7c1c", "message": "Fix tests", "committedDate": "2020-09-29T01:55:23Z", "type": "commit"}, {"oid": "858a9474c01a5a1e03e3f767081b64337a6b7c1c", "url": "https://github.com/apache/helix/commit/858a9474c01a5a1e03e3f767081b64337a6b7c1c", "message": "Fix tests", "committedDate": "2020-09-29T01:55:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzODQwMw==", "url": "https://github.com/apache/helix/pull/1383#discussion_r496438403", "bodyText": "I might be wrong, but helix-rest is not a module that we expect anyone to extend, so we shall be able to remove unnecessary methods directly.", "author": "jiajunwang", "createdAt": "2020-09-29T06:07:48Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java", "diffHunk": "@@ -58,29 +62,44 @@\n   private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();\n   private static final ExecutorService POOL = Executors.newCachedThreadPool();\n \n+  // Metric names for custom instance check\n+  private static final String CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_TOTAL =\n+      MetricRegistry.name(InstanceService.class, \"custom_instance_check_http_requests_total\");\n+  private static final String CUSTOM_INSTANCE_CHECK_HTTP_REQUESTS_ERROR_TOTAL =\n+      MetricRegistry.name(InstanceService.class, \"custom_instance_check_http_requests_error_total\");\n+  private static final String CUSTOM_INSTANCE_CHECK_HTTP_REQUEST_DURATION =\n+      MetricRegistry.name(InstanceService.class, \"custom_instance_check_http_request_duration\");\n+\n   private final HelixDataAccessorWrapper _dataAccessor;\n   private final ConfigAccessor _configAccessor;\n   private final CustomRestClient _customRestClient;\n+  private String _namespace;\n   private boolean _skipZKRead;\n \n+  @Deprecated\n   public InstanceServiceImpl(HelixDataAccessorWrapper dataAccessor, ConfigAccessor configAccessor) {\n-    _dataAccessor = dataAccessor;\n-    _configAccessor = configAccessor;\n-    _customRestClient = CustomRestClientFactory.get();\n+    this(dataAccessor, configAccessor, false);\n   }\n \n-  public InstanceServiceImpl(HelixDataAccessorWrapper dataAccessor, ConfigAccessor configAccessor, boolean skipZKRead) {\n-    this(dataAccessor,configAccessor);\n-    this._skipZKRead = skipZKRead;\n+  @Deprecated\n+  public InstanceServiceImpl(HelixDataAccessorWrapper dataAccessor, ConfigAccessor configAccessor,\n+      boolean skipZKRead) {\n+    this(dataAccessor, configAccessor, skipZKRead, HelixRestNamespace.DEFAULT_NAMESPACE_NAME);\n+  }", "originalCommit": "858a9474c01a5a1e03e3f767081b64337a6b7c1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3MDYzOA==", "url": "https://github.com/apache/helix/pull/1383#discussion_r497070638", "bodyText": "Since helix is open source, I prefer to follow a standard process: deprecate first and then remove it.", "author": "huizhilu", "createdAt": "2020-09-29T21:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzODQwMw=="}], "type": "inlineReview"}, {"oid": "575c0dd7c60c74d493d5e0ccd9a3f83b20bfeea6", "url": "https://github.com/apache/helix/commit/575c0dd7c60c74d493d5e0ccd9a3f83b20bfeea6", "message": "Move HelixDataAccessorWrapper contruction to InstanceServiceImpl", "committedDate": "2020-09-30T03:37:43Z", "type": "forcePushed"}, {"oid": "591b2adf3957d6a5cf13822eed3f4fae7e074880", "url": "https://github.com/apache/helix/commit/591b2adf3957d6a5cf13822eed3f4fae7e074880", "message": "Move HelixDataAccessorWrapper contruction to InstanceServiceImpl", "committedDate": "2020-09-30T03:49:23Z", "type": "commit"}, {"oid": "591b2adf3957d6a5cf13822eed3f4fae7e074880", "url": "https://github.com/apache/helix/commit/591b2adf3957d6a5cf13822eed3f4fae7e074880", "message": "Move HelixDataAccessorWrapper contruction to InstanceServiceImpl", "committedDate": "2020-09-30T03:49:23Z", "type": "forcePushed"}]}