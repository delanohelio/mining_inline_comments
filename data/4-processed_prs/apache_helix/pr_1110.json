{"pr_number": 1110, "pr_title": "Use dedicated ZkClient in HelixPropertyFactory", "pr_createdAt": "2020-06-22T18:08:33Z", "pr_url": "https://github.com/apache/helix/pull/1110", "timeline": [{"oid": "51f36a345c34d946db2a5245688ec2497a2d6a19", "url": "https://github.com/apache/helix/commit/51f36a345c34d946db2a5245688ec2497a2d6a19", "message": "Use dedicated ZkClient in HelixPropertyFactory\n\nIt's been observed that sometimes using a shared Zk connection could cause issues when we write in-memory tests that shut down ZK server and restart it. This is because with a shared Zkconnection, we may see the client's zxid be higher than that of the server, which is an invalid state in ZooKeeper. Since HelixManager is a single-realm dedicated concept, it is okay to use a dedicated zk connection to pull CloudConfig in getHelixManagerProperty() method. This will solve issues caused by zxid mismatches.", "committedDate": "2020-06-22T19:30:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzNzk0MA==", "url": "https://github.com/apache/helix/pull/1110#discussion_r443837940", "bodyText": "Let's move this to the block, since it will be closed in finally block anyway.", "author": "junkaixue", "createdAt": "2020-06-22T21:31:23Z", "path": "helix-core/src/main/java/org/apache/helix/HelixPropertyFactory.java", "diffHunk": "@@ -47,17 +49,30 @@ public static HelixPropertyFactory getInstance() {\n    * Clients may override these values.\n    */\n   public HelixManagerProperty getHelixManagerProperty(String zkAddress, String clusterName) {\n-    ConfigAccessor configAccessor = new ConfigAccessor(zkAddress);\n     CloudConfig cloudConfig;\n-    // The try-catch logic is for backward compatibility reason only. Even if the cluster is not set\n-    // up yet, constructing a new ZKHelixManager should not throw an exception\n+    HelixZkClient zkClient = null;", "originalCommit": "131ccd24b28155bb9ef0d802767c7c53ed9693cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5ODA3Mw==", "url": "https://github.com/apache/helix/pull/1110#discussion_r443898073", "bodyText": "Let's mention another reason we want a dedicated client instead of shared client here is for the isolation level that we need.", "author": "jiajunwang", "createdAt": "2020-06-23T00:38:31Z", "path": "helix-core/src/main/java/org/apache/helix/HelixPropertyFactory.java", "diffHunk": "@@ -47,17 +49,30 @@ public static HelixPropertyFactory getInstance() {\n    * Clients may override these values.\n    */\n   public HelixManagerProperty getHelixManagerProperty(String zkAddress, String clusterName) {\n-    ConfigAccessor configAccessor = new ConfigAccessor(zkAddress);\n     CloudConfig cloudConfig;\n-    // The try-catch logic is for backward compatibility reason only. Even if the cluster is not set\n-    // up yet, constructing a new ZKHelixManager should not throw an exception\n+    HelixZkClient zkClient = null;\n     try {\n-      cloudConfig =\n-          configAccessor.getCloudConfig(clusterName) == null ? buildEmptyCloudConfig(clusterName)\n-              : configAccessor.getCloudConfig(clusterName);\n-    } catch (HelixException e) {\n-      cloudConfig = buildEmptyCloudConfig(clusterName);\n+      // This configAccessor is a dedicated zkclient because HelixManager is single realm", "originalCommit": "131ccd24b28155bb9ef0d802767c7c53ed9693cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "35da5431238591f063f54bcb88c48abdea07d6e7", "url": "https://github.com/apache/helix/commit/35da5431238591f063f54bcb88c48abdea07d6e7", "message": "Update", "committedDate": "2020-06-23T04:10:41Z", "type": "commit"}, {"oid": "35da5431238591f063f54bcb88c48abdea07d6e7", "url": "https://github.com/apache/helix/commit/35da5431238591f063f54bcb88c48abdea07d6e7", "message": "Update", "committedDate": "2020-06-23T04:10:41Z", "type": "forcePushed"}, {"oid": "813118d6187eb19aaa4a8959601ba3418ead7068", "url": "https://github.com/apache/helix/commit/813118d6187eb19aaa4a8959601ba3418ead7068", "message": "asdf", "committedDate": "2020-06-23T06:08:43Z", "type": "commit"}, {"oid": "0a055e7b48be9bd9a01ca6af1c7a63b8b99930c7", "url": "https://github.com/apache/helix/commit/0a055e7b48be9bd9a01ca6af1c7a63b8b99930c7", "message": "sadf", "committedDate": "2020-06-23T06:11:59Z", "type": "commit"}, {"oid": "92937c364d5ac2dc173b768d4266be29612280ed", "url": "https://github.com/apache/helix/commit/92937c364d5ac2dc173b768d4266be29612280ed", "message": "asdf", "committedDate": "2020-06-23T06:40:31Z", "type": "commit"}, {"oid": "772c654ec65a66e17eaabf80816d75d72829e495", "url": "https://github.com/apache/helix/commit/772c654ec65a66e17eaabf80816d75d72829e495", "message": "sadf", "committedDate": "2020-06-23T06:42:24Z", "type": "commit"}]}