{"pr_number": 872, "pr_title": "Change the cluster creation logic", "pr_createdAt": "2020-03-06T04:36:37Z", "pr_url": "https://github.com/apache/helix/pull/872", "timeline": [{"oid": "cc1bb9224c0c017eae1e7f640437c88982f73834", "url": "https://github.com/apache/helix/commit/cc1bb9224c0c017eae1e7f640437c88982f73834", "message": "Change the cluster creation logic\n\nIn this commit, a minor modification has been added which:\n1- Populated the Topology information in the Cluster Config\nif cloud is enabled.\n2- Tests have been change accordingly.\n3- The depricated APIs have been changed in the test to\nfollow new APIs.", "committedDate": "2020-03-06T01:57:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyMjY0Ng==", "url": "https://github.com/apache/helix/pull/872#discussion_r388722646", "bodyText": "Can we update the cloudconfig first then add it to the cluster? So that we have only one ZK access.\nIf the following config is required for AZURE, shall we add it to a more fundamental method instead of the tool? What if the user call the other API or admin method to create a cluster that is not compatible?", "author": "jiajunwang", "createdAt": "2020-03-06T05:43:48Z", "path": "helix-core/src/main/java/org/apache/helix/tools/ClusterSetup.java", "diffHunk": "@@ -189,6 +189,16 @@ public void addCluster(String clusterName, boolean overwritePrevious, CloudConfi\n \n     if (cloudConfig != null) {\n       _admin.addCloudConfig(clusterName, cloudConfig);\n+      // If cloud is enabled and Cloud Provider is Azure, populated the Topology information in cluster config\n+      if (cloudConfig.isCloudEnabled()", "originalCommit": "cc1bb9224c0c017eae1e7f640437c88982f73834", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0Nzc0NA==", "url": "https://github.com/apache/helix/pull/872#discussion_r389047744", "bodyText": "Please note that we are updating two different paths. The new information will be added to cluster config. So eventually we need two accesses. one for the cloud config and one for the cluster config.\nOur plan is to populate these information while creating the cluster and all of the paths (REST and java) to create cluster should pass through this part of the code.", "author": "alirezazamani", "createdAt": "2020-03-06T17:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyMjY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyMjgyMQ==", "url": "https://github.com/apache/helix/pull/872#discussion_r388722821", "bodyText": "Question, is this because of the new ZK change? Or other reasons?", "author": "jiajunwang", "createdAt": "2020-03-06T05:44:51Z", "path": "helix-core/src/test/java/org/apache/helix/tools/TestClusterSetup.java", "diffHunk": "@@ -355,7 +356,7 @@ public void testDropInstance() throws Exception {\n \n     // add fake liveInstance\n     ZKHelixDataAccessor accessor =\n-        new ZKHelixDataAccessor(clusterName, new ZkBaseDataAccessor<ZNRecord>(_gZkClient));\n+        new ZKHelixDataAccessor(clusterName, new ZkBaseDataAccessor<ZNRecord>(ZK_ADDR));", "originalCommit": "cc1bb9224c0c017eae1e7f640437c88982f73834", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0NTA5Ng==", "url": "https://github.com/apache/helix/pull/872#discussion_r389045096", "bodyText": "The method has been deprecated in November 2019. So I think it is almost recent.", "author": "alirezazamani", "createdAt": "2020-03-06T17:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyMjgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0OTUwNg==", "url": "https://github.com/apache/helix/pull/872#discussion_r389049506", "bodyText": "Are we agree use this? I thought i was \"/faultDomain/hostname\"? Anyway, we should put it into AzureConstant.", "author": "junkaixue", "createdAt": "2020-03-06T17:46:09Z", "path": "helix-core/src/main/java/org/apache/helix/tools/ClusterSetup.java", "diffHunk": "@@ -189,6 +189,16 @@ public void addCluster(String clusterName, boolean overwritePrevious, CloudConfi\n \n     if (cloudConfig != null) {\n       _admin.addCloudConfig(clusterName, cloudConfig);\n+      // If cloud is enabled and Cloud Provider is Azure, populated the Topology information in cluster config\n+      if (cloudConfig.isCloudEnabled()\n+          && cloudConfig.getCloudProvider().equals(CloudProvider.AZURE.name())) {\n+        ConfigAccessor configAccessor = new ConfigAccessor(_zkServerAddress);\n+        ClusterConfig clusterConfig = new ClusterConfig(clusterName);\n+        clusterConfig.setTopology(\"/helixZoneId/host\");", "originalCommit": "cc1bb9224c0c017eae1e7f640437c88982f73834", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA5NjA4OA==", "url": "https://github.com/apache/helix/pull/872#discussion_r389096088", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-03-06T19:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0OTUwNg=="}], "type": "inlineReview"}, {"oid": "c310b39594247a706326af08b2165ee31b19273e", "url": "https://github.com/apache/helix/commit/c310b39594247a706326af08b2165ee31b19273e", "message": "address comments", "committedDate": "2020-03-06T19:11:24Z", "type": "commit"}]}