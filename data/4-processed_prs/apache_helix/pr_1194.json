{"pr_number": 1194, "pr_title": "Fix flaky test testGetChildrenOnLargeNumChildren", "pr_createdAt": "2020-07-31T00:00:41Z", "pr_url": "https://github.com/apache/helix/pull/1194", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463342175", "bodyText": "can we delete parent path here without child node deleted?", "author": "kaisun2000", "createdAt": "2020-07-31T00:26:16Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -868,59 +864,38 @@ public void testAsyncWriteOperations() {\n    * Tests getChildren() when there are an excessive number of children and connection loss happens,\n    * the operation should terminate and exit retry loop.\n    */\n-  @Test\n+  @Test(timeOut = 30L)\n   public void testGetChildrenOnLargeNumChildren() throws Exception {\n-    // Default packetLen is 4M. It is static final and initialized\n-    // when first zkClient is created.\n-    // So we could not just set \"jute.maxbuffer\" to change the value.\n-    // Reflection is needed to change the value.\n-    // Remove \"final\" modifier\n-    Field modifiersField = Field.class.getDeclaredField(\"modifiers\");\n-    boolean isModifierAccessible = modifiersField.isAccessible();\n-    modifiersField.setAccessible(true);\n-\n-    Field packetLenField = ClientCnxn.class.getDeclaredField(\"packetLen\");\n-    Field childrenLimitField =\n-        org.apache.helix.zookeeper.zkclient.ZkClient.class.getDeclaredField(\"NUM_CHILDREN_LIMIT\");\n-    modifiersField.setInt(packetLenField, packetLenField.getModifiers() & ~Modifier.FINAL);\n-    modifiersField.setInt(childrenLimitField, childrenLimitField.getModifiers() & ~Modifier.FINAL);\n-\n-    boolean isPacketLenAccessible = packetLenField.isAccessible();\n-    packetLenField.setAccessible(true);\n-    int originPacketLen = packetLenField.getInt(null);\n-    // Keep 150 bytes for successfully creating each child node.\n-    packetLenField.set(null, 150);\n-\n-    boolean isChildrenLimitAccessible = childrenLimitField.isAccessible();\n-    childrenLimitField.setAccessible(true);\n-    int originChildrenLimit = childrenLimitField.getInt(null);\n-    childrenLimitField.set(null, 2);\n-\n-    String path = \"/\" + TestHelper.getTestMethodName();\n-    // Create 5 children to make packet length of children exceed 150 bytes\n+    // Create 110K children to make packet length of children exceed 4 MB\n     // and cause connection loss for getChildren() operation\n-    for (int i = 0; i < 5; i++) {\n-      _zkClient.createPersistent(path + \"/\" + UUID.randomUUID().toString(), true);\n+    String path = \"/\" + TestHelper.getTestMethodName();\n+    int toCreateChildrenCount = 110;\n+\n+    _zkClient.createPersistent(path);\n+\n+    for (int i = 0; i < toCreateChildrenCount; i++) {\n+      List<Op> ops = new ArrayList<>(1000);\n+      for (int j = 0; j < 1000; j++) {\n+        String child = path + \"/\" + UUID.randomUUID().toString();\n+        ops.add(Op.create(child, new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL));\n+      }\n+      // Reduce total creation time by batch creating znodes\n+      _zkClient.multi(ops);\n     }\n \n     try {\n       _zkClient.getChildren(path);\n-      Assert.fail(\"Should not successfully get children.\");\n+      Assert.fail(\"Should not successfully get children because of connection loss.\");\n     } catch (ZkException expected) {\n       Assert.assertEquals(expected.getMessage(),\n           \"org.apache.zookeeper.KeeperException$MarshallingErrorException: \"\n               + \"KeeperErrorCode = MarshallingError\");\n     } finally {\n-      packetLenField.set(null, originPacketLen);\n-      packetLenField.setAccessible(isPacketLenAccessible);\n-\n-      childrenLimitField.set(null, originChildrenLimit);\n-      childrenLimitField.setAccessible(isChildrenLimitAccessible);\n-\n-      modifiersField.setAccessible(isModifierAccessible);\n+      _zkClient.close();\n+      _zkClient = new ZkClient(ZkTestBase.ZK_ADDR);\n \n       Assert.assertTrue(TestHelper.verify(() -> {\n-        _zkClient.deleteRecursively(path);\n+        _zkClient.delete(path);", "originalCommit": "c98fb3659f7d58d3f136e70766279d864b3c8828", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTEwMA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463345100", "bodyText": "No, we cannot because there would be node not empty exception.", "author": "huizhilu", "createdAt": "2020-07-31T00:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0ODUxNw==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463348517", "bodyText": "My concern is this:\nif using deleteRecursively(), it won't work because list all the children znode name would cause \"marshalling\" error as what happened in GCN, right?\nif using delete as you do here, I think it would throw another exception as not empty. So this does not work here. Or am I missing something?", "author": "kaisun2000", "createdAt": "2020-07-31T00:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MzY2Nw==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463353667", "bodyText": "delete() returns boolean. Should handle ZkException here as I've removed deleteRecursively().", "author": "huizhilu", "createdAt": "2020-07-31T01:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1NTgwOQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463355809", "bodyText": "So in this case, it would always throw exception, right?\nThen why bother. Just leave the znode there anyway.", "author": "kaisun2000", "createdAt": "2020-07-31T01:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1ODM1Mg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463358352", "bodyText": "As a good practice, a unit test should cleanup itself and avoid other tests.\nIt won't always throw exception. If you carefully understand the code, you'll find the tips of using ephemeral nodes and closing the zkClient to delete the ephemeral nodes for cleanup. The exception handling here is just in case zk server doesn't remove ephemeral nodes yet.", "author": "huizhilu", "createdAt": "2020-07-31T01:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM2NDYxNg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463364616", "bodyText": "My question is that is this exception always thrown? I believe it would always be thrown. Can you verify?", "author": "kaisun2000", "createdAt": "2020-07-31T01:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM3MDQzNA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463370434", "bodyText": "Can we also re-open this comment thread?", "author": "kaisun2000", "createdAt": "2020-07-31T02:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MDA0OQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463390049", "bodyText": "What do you mean by always thrown?", "author": "huizhilu", "createdAt": "2020-07-31T03:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQxMzA2OQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463413069", "bodyText": "String path = \"/\" + TestHelper.getTestMethodName() is path value.\nNow at the time this line of code _zkClient.delete(path); , there are a lot of znodes underlying this path. So the delete should always fail, with exception such as NoEmpty right?  Or am I understanding this wrong?", "author": "kaisun2000", "createdAt": "2020-07-31T05:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkzNDk5MQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463934991", "bodyText": "@kaisun2000 I've replied you: they are ephemeral znodes.\n\nIt won't always throw exception. If you carefully understand the code, you'll find the tips of using ephemeral nodes and closing the zkClient to delete the ephemeral nodes for cleanup. The exception handling here is just in case zk server doesn't remove ephemeral nodes yet.", "author": "huizhilu", "createdAt": "2020-08-01T07:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwNDU2Mg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464604562", "bodyText": "I see. Did not notice this ephemeral node. So closing the _zkClient delete the nodes. The second delete is just to delete the parent path. This looks good.", "author": "kaisun2000", "createdAt": "2020-08-03T19:00:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463342435", "bodyText": "why do we need this? is it 30sec?", "author": "kaisun2000", "createdAt": "2020-07-31T00:27:21Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -868,59 +864,38 @@ public void testAsyncWriteOperations() {\n    * Tests getChildren() when there are an excessive number of children and connection loss happens,\n    * the operation should terminate and exit retry loop.\n    */\n-  @Test\n+  @Test(timeOut = 30L)", "originalCommit": "c98fb3659f7d58d3f136e70766279d864b3c8828", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTg0Nw==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463345847", "bodyText": "30 * 1000L ms.\nA good practice would be: if the test relies on an external system(zk here), it'd be good to have a timeout. Otherwise, if the connection hangs, the test also hangs. Eg., if the operation multi() hangs since it is sync, it hangs there forever?\nTimeout makes the test process continue for other tests.", "author": "huizhilu", "createdAt": "2020-07-31T00:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NzU1MQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463347551", "bodyText": "Another thing is that in these 4 secs, is it possible another test would time out the session of _zkClient. Shall we use a dedicated ZkClient by creating one and later close it.", "author": "kaisun2000", "createdAt": "2020-07-31T00:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NzYzOA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463347638", "bodyText": "also for safety, make it 60secs?", "author": "kaisun2000", "createdAt": "2020-07-31T00:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MTA0NA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463351044", "bodyText": "This _zkClient is created within this class. While this test is running, there is no other thread referencing this _zkClient to close it.\nI considered using another zkClient. But it just adds one more connection to so for this case there will be two connections at the same time. I believe reuse this one is good enough.\nI ran it in my laptop as well, 30s is good enough. If it's more than 30s, something is wrong and it should timeout to fail.", "author": "huizhilu", "createdAt": "2020-07-31T00:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1NTMzNQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463355335", "bodyText": "You laptop runs on SSD. Desktop or TMC machines can be slower. Leave some room for error is safe here IMO.", "author": "kaisun2000", "createdAt": "2020-07-31T01:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1OTQxMg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463359412", "bodyText": "30s has already good room for this test. In my tests, it completes in ~5s. If it really exceeds 30s, maybe 60s don't even help.", "author": "huizhilu", "createdAt": "2020-07-31T01:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM2NDc4MA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463364780", "bodyText": "Can you the whole test under helix in desktop to make sure this 30s is safe?", "author": "kaisun2000", "createdAt": "2020-07-31T01:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM2ODA4Mg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463368082", "bodyText": "I did zookeeper-api in both desktop and laptop. Is this what you meant?", "author": "huizhilu", "createdAt": "2020-07-31T02:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM2OTY0Mw==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463369643", "bodyText": "No, run all test from helix. That is what TMC is doing I guess. This is to simulate that test environment. We don't want that your fix working here but later it turned out this test still not working TMC. Note the cost over there is way higher than changing it here.\nIn fact, I noticed in our test, there are failed test due to Timed out from time to time. Those failure are likely before the machine may not be able to schedule the thread to run while the timer is ticking. I don't think it is a good idea to add a time out here.\nBy the way, can you re-open this comment thread.", "author": "kaisun2000", "createdAt": "2020-07-31T02:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4Nzg5Mg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463387892", "bodyText": "I actually didn't resolve this thread... I intended to keep it open for discussion.\nRunning all helix tests is not necessary. This is a separate module. Even running in the test machine, tests in different modules are independent.\nTimeout is good practice. Just an example. https://github.com/apache/zookeeper/blob/fe940cdd8fb23ba09684cefb73233d570f4a20fa/zookeeper-server/src/test/java/org/apache/zookeeper/server/ZooKeeperServerMainTest.java#L165\nHow could you ensure 60s would not timeout then? Then how about 10 minutes, 1 hour?", "author": "huizhilu", "createdAt": "2020-07-31T03:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQxNDAwOA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463414008", "bodyText": "Yes, then remove this timeout. The test has a default timeout 300sec. In my opinion, relying on 300sec default is much safer. Testing under your own laptop may not fit a lot other environment.\nSee this:\n[ERROR] testLostZkConnection(org.apache.helix.integration.TestZkConnectionLost) Time elapsed: 300.015 s <<< FAILURE!\norg.testng.internal.thread.ThreadTimeoutException: Method org.testng.internal.TestNGMethod.testLostZkConnection() didn't finish within the time-out 300000", "author": "kaisun2000", "createdAt": "2020-07-31T05:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkzNDg3Mg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463934872", "bodyText": "Please let me remind you that the default timeout 300sec is set only for helix-core's tests, not in zookeeper-api.", "author": "huizhilu", "createdAt": "2020-08-01T07:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwOTUzMw==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464609533", "bodyText": "where is the place to config the 300secs. Shall we just configure the same in zooscalability-api?", "author": "kaisun2000", "createdAt": "2020-08-03T19:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxNzY2OQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464617669", "bodyText": "It is in test config file: testng.xml\nConfiguring the timeout for test suit for zookeeper-api is out of scope of this PR. If we want to do that, I would prefer to do it in another PR.", "author": "huizhilu", "createdAt": "2020-08-03T19:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0MjQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0Mjc3Mg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463342772", "bodyText": "what is the difference of using this static block vs initalization at declaration?", "author": "kaisun2000", "createdAt": "2020-07-31T00:28:46Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -119,19 +115,6 @@\n   // ZkEventThread. Otherwise the retry request might block the normal event processing.\n   protected final ZkAsyncRetryThread _asyncCallRetryThread;\n \n-  static {", "originalCommit": "c98fb3659f7d58d3f136e70766279d864b3c8828", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NjAwMA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463346000", "bodyText": "If you read the comment you'll know :)\n// Set it here for unit test to use reflection to change value\n// because compilers optimize constants by replacing them inline.\nSince we don't need reflection, we change it.", "author": "huizhilu", "createdAt": "2020-07-31T00:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0Mjc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NzAzOQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463347039", "bodyText": "I see.", "author": "kaisun2000", "createdAt": "2020-07-31T00:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0Mjc3Mg=="}], "type": "inlineReview"}, {"oid": "167c7667c5ad7b900ac1d7e42dd5d1a007fdc7a8", "url": "https://github.com/apache/helix/commit/167c7667c5ad7b900ac1d7e42dd5d1a007fdc7a8", "message": "Fix flaky test testGetChildrenOnLargeNumChildren", "committedDate": "2020-07-31T00:36:18Z", "type": "commit"}, {"oid": "167c7667c5ad7b900ac1d7e42dd5d1a007fdc7a8", "url": "https://github.com/apache/helix/commit/167c7667c5ad7b900ac1d7e42dd5d1a007fdc7a8", "message": "Fix flaky test testGetChildrenOnLargeNumChildren", "committedDate": "2020-07-31T00:36:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTEzMQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463349131", "bodyText": "How about let us construct a new zkclient here. Is it possible _zkClient would be session timeout by another test or thread?", "author": "kaisun2000", "createdAt": "2020-07-31T00:52:00Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -868,59 +864,38 @@ public void testAsyncWriteOperations() {\n    * Tests getChildren() when there are an excessive number of children and connection loss happens,\n    * the operation should terminate and exit retry loop.\n    */\n-  @Test\n+  @Test(timeOut = 30 * 1000L)\n   public void testGetChildrenOnLargeNumChildren() throws Exception {\n-    // Default packetLen is 4M. It is static final and initialized\n-    // when first zkClient is created.\n-    // So we could not just set \"jute.maxbuffer\" to change the value.\n-    // Reflection is needed to change the value.\n-    // Remove \"final\" modifier\n-    Field modifiersField = Field.class.getDeclaredField(\"modifiers\");\n-    boolean isModifierAccessible = modifiersField.isAccessible();\n-    modifiersField.setAccessible(true);\n-\n-    Field packetLenField = ClientCnxn.class.getDeclaredField(\"packetLen\");\n-    Field childrenLimitField =\n-        org.apache.helix.zookeeper.zkclient.ZkClient.class.getDeclaredField(\"NUM_CHILDREN_LIMIT\");\n-    modifiersField.setInt(packetLenField, packetLenField.getModifiers() & ~Modifier.FINAL);\n-    modifiersField.setInt(childrenLimitField, childrenLimitField.getModifiers() & ~Modifier.FINAL);\n-\n-    boolean isPacketLenAccessible = packetLenField.isAccessible();\n-    packetLenField.setAccessible(true);\n-    int originPacketLen = packetLenField.getInt(null);\n-    // Keep 150 bytes for successfully creating each child node.\n-    packetLenField.set(null, 150);\n-\n-    boolean isChildrenLimitAccessible = childrenLimitField.isAccessible();\n-    childrenLimitField.setAccessible(true);\n-    int originChildrenLimit = childrenLimitField.getInt(null);\n-    childrenLimitField.set(null, 2);\n-\n-    String path = \"/\" + TestHelper.getTestMethodName();\n-    // Create 5 children to make packet length of children exceed 150 bytes\n+    // Create 110K children to make packet length of children exceed 4 MB\n     // and cause connection loss for getChildren() operation\n-    for (int i = 0; i < 5; i++) {\n-      _zkClient.createPersistent(path + \"/\" + UUID.randomUUID().toString(), true);\n+    String path = \"/\" + TestHelper.getTestMethodName();\n+    int toCreateChildrenCount = 110;\n+\n+    _zkClient.createPersistent(path);", "originalCommit": "167c7667c5ad7b900ac1d7e42dd5d1a007fdc7a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MTI4OA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463351288", "bodyText": "Replied above. Won't be closed by another thread. It is created in this class, not from a base class.", "author": "huizhilu", "createdAt": "2020-07-31T01:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTI0NQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r463349245", "bodyText": "60 secs?", "author": "kaisun2000", "createdAt": "2020-07-31T00:52:20Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -868,59 +864,38 @@ public void testAsyncWriteOperations() {\n    * Tests getChildren() when there are an excessive number of children and connection loss happens,\n    * the operation should terminate and exit retry loop.\n    */\n-  @Test\n+  @Test(timeOut = 30 * 1000L)", "originalCommit": "167c7667c5ad7b900ac1d7e42dd5d1a007fdc7a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "86c62b489ff7e8304f8591a1d3147351389e0721", "url": "https://github.com/apache/helix/commit/86c62b489ff7e8304f8591a1d3147351389e0721", "message": "Cleanup", "committedDate": "2020-07-31T03:47:53Z", "type": "commit"}, {"oid": "86c62b489ff7e8304f8591a1d3147351389e0721", "url": "https://github.com/apache/helix/commit/86c62b489ff7e8304f8591a1d3147351389e0721", "message": "Cleanup", "committedDate": "2020-07-31T03:47:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNDI1Mg==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464214252", "bodyText": "Nit: childPath", "author": "narendly", "createdAt": "2020-08-03T06:19:49Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -868,60 +864,41 @@ public void testAsyncWriteOperations() {\n    * Tests getChildren() when there are an excessive number of children and connection loss happens,\n    * the operation should terminate and exit retry loop.\n    */\n-  @Test\n+  @Test(timeOut = 30 * 1000L)\n   public void testGetChildrenOnLargeNumChildren() throws Exception {\n-    // Default packetLen is 4M. It is static final and initialized\n-    // when first zkClient is created.\n-    // So we could not just set \"jute.maxbuffer\" to change the value.\n-    // Reflection is needed to change the value.\n-    // Remove \"final\" modifier\n-    Field modifiersField = Field.class.getDeclaredField(\"modifiers\");\n-    boolean isModifierAccessible = modifiersField.isAccessible();\n-    modifiersField.setAccessible(true);\n-\n-    Field packetLenField = ClientCnxn.class.getDeclaredField(\"packetLen\");\n-    Field childrenLimitField =\n-        org.apache.helix.zookeeper.zkclient.ZkClient.class.getDeclaredField(\"NUM_CHILDREN_LIMIT\");\n-    modifiersField.setInt(packetLenField, packetLenField.getModifiers() & ~Modifier.FINAL);\n-    modifiersField.setInt(childrenLimitField, childrenLimitField.getModifiers() & ~Modifier.FINAL);\n-\n-    boolean isPacketLenAccessible = packetLenField.isAccessible();\n-    packetLenField.setAccessible(true);\n-    int originPacketLen = packetLenField.getInt(null);\n-    // Keep 150 bytes for successfully creating each child node.\n-    packetLenField.set(null, 150);\n-\n-    boolean isChildrenLimitAccessible = childrenLimitField.isAccessible();\n-    childrenLimitField.setAccessible(true);\n-    int originChildrenLimit = childrenLimitField.getInt(null);\n-    childrenLimitField.set(null, 2);\n-\n-    String path = \"/\" + TestHelper.getTestMethodName();\n-    // Create 5 children to make packet length of children exceed 150 bytes\n+    // Create 110K children to make packet length of children exceed 4 MB\n     // and cause connection loss for getChildren() operation\n-    for (int i = 0; i < 5; i++) {\n-      _zkClient.createPersistent(path + \"/\" + UUID.randomUUID().toString(), true);\n+    String path = \"/\" + TestHelper.getTestMethodName();\n+\n+    _zkClient.createPersistent(path);\n+\n+    for (int i = 0; i < 110; i++) {\n+      List<Op> ops = new ArrayList<>(1000);\n+      for (int j = 0; j < 1000; j++) {\n+        String child = path + \"/\" + UUID.randomUUID().toString();", "originalCommit": "86c62b489ff7e8304f8591a1d3147351389e0721", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNTA2OQ==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464215069", "bodyText": "Nit: let's say this a little more clearly:\nSomething on the lines of \"Should fail because listing 110K znodes with UUID names should cause packet length exceeded error, causing a connection loss.\"", "author": "narendly", "createdAt": "2020-08-03T06:22:10Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -868,60 +864,41 @@ public void testAsyncWriteOperations() {\n    * Tests getChildren() when there are an excessive number of children and connection loss happens,\n    * the operation should terminate and exit retry loop.\n    */\n-  @Test\n+  @Test(timeOut = 30 * 1000L)\n   public void testGetChildrenOnLargeNumChildren() throws Exception {\n-    // Default packetLen is 4M. It is static final and initialized\n-    // when first zkClient is created.\n-    // So we could not just set \"jute.maxbuffer\" to change the value.\n-    // Reflection is needed to change the value.\n-    // Remove \"final\" modifier\n-    Field modifiersField = Field.class.getDeclaredField(\"modifiers\");\n-    boolean isModifierAccessible = modifiersField.isAccessible();\n-    modifiersField.setAccessible(true);\n-\n-    Field packetLenField = ClientCnxn.class.getDeclaredField(\"packetLen\");\n-    Field childrenLimitField =\n-        org.apache.helix.zookeeper.zkclient.ZkClient.class.getDeclaredField(\"NUM_CHILDREN_LIMIT\");\n-    modifiersField.setInt(packetLenField, packetLenField.getModifiers() & ~Modifier.FINAL);\n-    modifiersField.setInt(childrenLimitField, childrenLimitField.getModifiers() & ~Modifier.FINAL);\n-\n-    boolean isPacketLenAccessible = packetLenField.isAccessible();\n-    packetLenField.setAccessible(true);\n-    int originPacketLen = packetLenField.getInt(null);\n-    // Keep 150 bytes for successfully creating each child node.\n-    packetLenField.set(null, 150);\n-\n-    boolean isChildrenLimitAccessible = childrenLimitField.isAccessible();\n-    childrenLimitField.setAccessible(true);\n-    int originChildrenLimit = childrenLimitField.getInt(null);\n-    childrenLimitField.set(null, 2);\n-\n-    String path = \"/\" + TestHelper.getTestMethodName();\n-    // Create 5 children to make packet length of children exceed 150 bytes\n+    // Create 110K children to make packet length of children exceed 4 MB\n     // and cause connection loss for getChildren() operation\n-    for (int i = 0; i < 5; i++) {\n-      _zkClient.createPersistent(path + \"/\" + UUID.randomUUID().toString(), true);\n+    String path = \"/\" + TestHelper.getTestMethodName();\n+\n+    _zkClient.createPersistent(path);\n+\n+    for (int i = 0; i < 110; i++) {\n+      List<Op> ops = new ArrayList<>(1000);\n+      for (int j = 0; j < 1000; j++) {\n+        String child = path + \"/\" + UUID.randomUUID().toString();\n+        ops.add(Op.create(child, new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL));\n+      }\n+      // Reduce total creation time by batch creating znodes\n+      _zkClient.multi(ops);\n     }\n \n     try {\n       _zkClient.getChildren(path);\n-      Assert.fail(\"Should not successfully get children.\");\n+      Assert.fail(\"Should not successfully get children because of connection loss.\");", "originalCommit": "86c62b489ff7e8304f8591a1d3147351389e0721", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNjA1MA==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464216050", "bodyText": "Shouldn't you delete recursively? Wouldn't this fail because of children nodes?", "author": "narendly", "createdAt": "2020-08-03T06:25:18Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -868,60 +864,41 @@ public void testAsyncWriteOperations() {\n    * Tests getChildren() when there are an excessive number of children and connection loss happens,\n    * the operation should terminate and exit retry loop.\n    */\n-  @Test\n+  @Test(timeOut = 30 * 1000L)\n   public void testGetChildrenOnLargeNumChildren() throws Exception {\n-    // Default packetLen is 4M. It is static final and initialized\n-    // when first zkClient is created.\n-    // So we could not just set \"jute.maxbuffer\" to change the value.\n-    // Reflection is needed to change the value.\n-    // Remove \"final\" modifier\n-    Field modifiersField = Field.class.getDeclaredField(\"modifiers\");\n-    boolean isModifierAccessible = modifiersField.isAccessible();\n-    modifiersField.setAccessible(true);\n-\n-    Field packetLenField = ClientCnxn.class.getDeclaredField(\"packetLen\");\n-    Field childrenLimitField =\n-        org.apache.helix.zookeeper.zkclient.ZkClient.class.getDeclaredField(\"NUM_CHILDREN_LIMIT\");\n-    modifiersField.setInt(packetLenField, packetLenField.getModifiers() & ~Modifier.FINAL);\n-    modifiersField.setInt(childrenLimitField, childrenLimitField.getModifiers() & ~Modifier.FINAL);\n-\n-    boolean isPacketLenAccessible = packetLenField.isAccessible();\n-    packetLenField.setAccessible(true);\n-    int originPacketLen = packetLenField.getInt(null);\n-    // Keep 150 bytes for successfully creating each child node.\n-    packetLenField.set(null, 150);\n-\n-    boolean isChildrenLimitAccessible = childrenLimitField.isAccessible();\n-    childrenLimitField.setAccessible(true);\n-    int originChildrenLimit = childrenLimitField.getInt(null);\n-    childrenLimitField.set(null, 2);\n-\n-    String path = \"/\" + TestHelper.getTestMethodName();\n-    // Create 5 children to make packet length of children exceed 150 bytes\n+    // Create 110K children to make packet length of children exceed 4 MB\n     // and cause connection loss for getChildren() operation\n-    for (int i = 0; i < 5; i++) {\n-      _zkClient.createPersistent(path + \"/\" + UUID.randomUUID().toString(), true);\n+    String path = \"/\" + TestHelper.getTestMethodName();\n+\n+    _zkClient.createPersistent(path);\n+\n+    for (int i = 0; i < 110; i++) {\n+      List<Op> ops = new ArrayList<>(1000);\n+      for (int j = 0; j < 1000; j++) {\n+        String child = path + \"/\" + UUID.randomUUID().toString();\n+        ops.add(Op.create(child, new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL));\n+      }\n+      // Reduce total creation time by batch creating znodes\n+      _zkClient.multi(ops);\n     }\n \n     try {\n       _zkClient.getChildren(path);\n-      Assert.fail(\"Should not successfully get children.\");\n+      Assert.fail(\"Should not successfully get children because of connection loss.\");\n     } catch (ZkException expected) {\n       Assert.assertEquals(expected.getMessage(),\n           \"org.apache.zookeeper.KeeperException$MarshallingErrorException: \"\n               + \"KeeperErrorCode = MarshallingError\");\n     } finally {\n-      packetLenField.set(null, originPacketLen);\n-      packetLenField.setAccessible(isPacketLenAccessible);\n-\n-      childrenLimitField.set(null, originChildrenLimit);\n-      childrenLimitField.setAccessible(isChildrenLimitAccessible);\n-\n-      modifiersField.setAccessible(isModifierAccessible);\n+      _zkClient.close();\n+      _zkClient = new ZkClient(ZkTestBase.ZK_ADDR);\n \n       Assert.assertTrue(TestHelper.verify(() -> {\n-        _zkClient.deleteRecursively(path);\n-        return !_zkClient.exists(path);\n+        try {\n+          return _zkClient.delete(path);", "originalCommit": "86c62b489ff7e8304f8591a1d3147351389e0721", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwODI4Ng==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464608286", "bodyText": "They are ephemeral nodes and closing the zkClient deletes the ephemeral nodes for cleanup.", "author": "huizhilu", "createdAt": "2020-08-03T19:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNjA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc3MTk3Mw==", "url": "https://github.com/apache/helix/pull/1194#discussion_r464771973", "bodyText": "I think this is fine for testing purposes, but here are some scenarios we can think about that gets us from, say, 95% to 99% stability:\n\n\ndoesn't the packet len error cause the session to be terminated? Or does your fix change that behavior? In this case if my assumption is true, the client that created the ephemeral nodes will lose its session and the ephemerals tied to the session will be gone anyway, so the nodes will be gone before zkclient.close()?\n\n\nthis is a rare scenario and probably being extra nitpicky, but sometimes we observe in-memory local clients lose connection for some unknown reason. What impact would that have on the test since that would cause ephemerals to be gone prematurely?\n\n\nIf we really wanted to be right and thorough, I would write persistent nodes, and check that the numChildren field comes out to 110K from Stats with an Assert statement, and then do the explicit deletion at the end. This would guard against any potential client-side and server-side glitches and failures.", "author": "narendly", "createdAt": "2020-08-04T03:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIxNjA1MA=="}], "type": "inlineReview"}, {"oid": "12bb7d9f0f5ceb4a150ccb50ac03da50ac76d89b", "url": "https://github.com/apache/helix/commit/12bb7d9f0f5ceb4a150ccb50ac03da50ac76d89b", "message": "Naming", "committedDate": "2020-08-03T19:24:49Z", "type": "commit"}, {"oid": "f3ba6bd43eb0950b291d56cfb15521d06d682a7a", "url": "https://github.com/apache/helix/commit/f3ba6bd43eb0950b291d56cfb15521d06d682a7a", "message": "Add comments", "committedDate": "2020-08-03T20:40:26Z", "type": "commit"}]}