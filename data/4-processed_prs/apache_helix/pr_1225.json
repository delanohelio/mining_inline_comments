{"pr_number": 1225, "pr_title": "Update customized view after all calculation is done", "pr_createdAt": "2020-08-06T20:20:44Z", "pr_url": "https://github.com/apache/helix/pull/1225", "timeline": [{"oid": "f94ecbfe2415071e072b088ecadee7964227ee66", "url": "https://github.com/apache/helix/commit/f94ecbfe2415071e072b088ecadee7964227ee66", "message": "Update customized view after all calculation is done", "committedDate": "2020-08-06T20:18:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyNzY2Nw==", "url": "https://github.com/apache/helix/pull/1225#discussion_r466727667", "bodyText": "I'm not sure what HelixException you expect from this method? I think you could move this try and catch to the end of this method, since I could imagine some exceptions being thrown when updating to zk? computeCustomizedStateView is local computation so should be fine.", "author": "mgao0", "createdAt": "2020-08-06T22:53:15Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/CustomizedViewAggregationStage.java", "diffHunk": "@@ -98,34 +98,34 @@ public void execute(final ClusterEvent event) throws Exception {\n         try {\n           computeCustomizedStateView(resource, stateType, customizedStateOutput, curCustomizedViews,\n               updatedCustomizedViews);\n-\n-          List<PropertyKey> keys = new ArrayList<>();\n-          for (Iterator<CustomizedView> it = updatedCustomizedViews.iterator(); it.hasNext(); ) {\n-            CustomizedView view = it.next();\n-            String resourceName = view.getResourceName();\n-            keys.add(keyBuilder.customizedView(stateType, resourceName));\n-          }\n-          // add/update customized-views from zk and cache\n-          if (updatedCustomizedViews.size() > 0) {\n-            dataAccessor.setChildren(keys, updatedCustomizedViews);\n-            cache.updateCustomizedViews(stateType, updatedCustomizedViews);\n-          }\n-\n-          // remove stale customized views from zk and cache\n-          List<String> customizedViewToRemove = new ArrayList<>();\n-          for (String resourceName : curCustomizedViews.keySet()) {\n-            if (!resourceMap.keySet().contains(resourceName)) {\n-              LogUtil.logInfo(LOG, _eventId, \"Remove customizedView for resource: \" + resourceName);\n-              dataAccessor.removeProperty(keyBuilder.customizedView(stateType, resourceName));\n-              customizedViewToRemove.add(resourceName);\n-            }\n-          }\n-          cache.removeCustomizedViews(stateType, customizedViewToRemove);\n         } catch (HelixException ex) {", "originalCommit": "f94ecbfe2415071e072b088ecadee7964227ee66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc1MDkyMw==", "url": "https://github.com/apache/helix/pull/1225#discussion_r466750923", "bodyText": "The purpose is to keep the loop continue without stopping at a possible exception thrown by a resource. For the zk exceptions, we may not want to hide them. We will let them thrown out and stop the pipeline if necessary.", "author": "zhangmeng916", "createdAt": "2020-08-07T00:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyNzY2Nw=="}], "type": "inlineReview"}, {"oid": "f94ecbfe2415071e072b088ecadee7964227ee66", "url": "https://github.com/apache/helix/commit/f94ecbfe2415071e072b088ecadee7964227ee66", "message": "Update customized view after all calculation is done", "committedDate": "2020-08-06T20:18:01Z", "type": "forcePushed"}]}