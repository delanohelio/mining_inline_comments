{"pr_number": 1344, "pr_title": "Reduce unnecessary getChildren call in subscribeForChanges", "pr_createdAt": "2020-09-03T05:25:17Z", "pr_url": "https://github.com/apache/helix/pull/1344", "timeline": [{"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "url": "https://github.com/apache/helix/commit/6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "message": "Reduce unnecessary getChildren call in subscribeForChanges", "committedDate": "2020-09-03T05:28:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxNTY5NA==", "url": "https://github.com/apache/helix/pull/1344#discussion_r482715694", "bodyText": "I feel like we could create an empty list here. So we won\u2019t return a null and no need to do the nullptr check later.", "author": "xyuanlu", "createdAt": "2020-09-03T05:39:21Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -533,7 +533,7 @@ public void invoke(NotificationContext changeContext) throws Exception {\n     }\n   }\n \n-  private void subscribeChildChange(String path, NotificationContext.Type callbackType) {\n+  private List<String> subscribeChildChange(String path, NotificationContext.Type callbackType) {\n     if (callbackType == NotificationContext.Type.INIT", "originalCommit": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjczOTkyOA==", "url": "https://github.com/apache/helix/pull/1344#discussion_r482739928", "bodyText": "I thought about it. There is still a possibility that childrenSubscribeResult.getChildren() returns null. The caller still needs to do the null check. So I just make it consistent with zkClient.subscribeChildChanges and let the caller determine the behavior.\nI also thought about using Optional, but it doesn't seem that would add too much value. And Optional will add more overhead than null. The original code also does null check, so for now I'd keep the change minimum. Later we will still have a better design and hopefully will make the code cleaner.", "author": "huizhilu", "createdAt": "2020-09-03T06:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxNTY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMTgxNA==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483201814", "bodyText": "Is it possible that you just return ChildrenSubscribeResult?\nThen if _isInstalled is false, no one will read the children. Otherwise, if _isInstalled, then the list should never be null.", "author": "jiajunwang", "createdAt": "2020-09-03T19:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxNTY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI4Mjc3MQ==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483282771", "bodyText": "I also thought about it. But from the code, if _isInstalled == true, it is still possible that the children list is null:\n        try {\n          return getChildren(path, true);\n        } catch (ZkNoNodeException e) {\n          // ignore, the \"exists\" watch will listen for the parent node to appear\n          LOG.info(\"watchForChilds path not existing:{} skipWatchingNodeNoteExist: {}\",\n              path, skipWatchingNonExistNode);\n        }\n        return null;\n\nSo we could not determine if children list is null or not based on _isInstalled.", "author": "huizhilu", "createdAt": "2020-09-03T22:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxNTY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc5Mjc3MA==", "url": "https://github.com/apache/helix/pull/1344#discussion_r482792770", "bodyText": "There is a slightly behavior difference here. Originally before this change, if type is Finalize, we still iterate trough all node and do subscribeDataChange .\nNow we do not return a children list when finalize (line 565) so we do not do subscribeDataChange for those nodes.\nI think we need to keep the getChildren when finalize. Also, This behavior difference cause unit test TestListenerCallbackBatchMode fail on my side. May I ask did you run in to this problem?\nThx.", "author": "xyuanlu", "createdAt": "2020-09-03T08:14:45Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +645,9 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              if (children != null) {", "originalCommit": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE4NTM4Ng==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483185386", "bodyText": "Yeah, I was aware of the failed test and the code in subscribeChildChange() for NotificationContext.Type.FINALIZE.", "author": "huizhilu", "createdAt": "2020-09-03T18:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc5Mjc3MA=="}], "type": "inlineReview"}, {"oid": "f45fddee6e66505621a9bcb10730a833cd7e1f92", "url": "https://github.com/apache/helix/commit/f45fddee6e66505621a9bcb10730a833cd7e1f92", "message": "Reduce unnecessary getChildren call in subscribeForChanges", "committedDate": "2020-09-03T18:12:07Z", "type": "forcePushed"}, {"oid": "651ac9f2d06009398508917da73076369a5a4045", "url": "https://github.com/apache/helix/commit/651ac9f2d06009398508917da73076369a5a4045", "message": "Reduce unnecessary getChildren call in subscribeForChanges", "committedDate": "2020-09-03T18:50:30Z", "type": "forcePushed"}, {"oid": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "url": "https://github.com/apache/helix/commit/c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "message": "Reduce unnecessary getChildren call in subscribeForChanges", "committedDate": "2020-09-03T18:51:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2OTM0Mw==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483169343", "bodyText": "Method comment, please.", "author": "jiajunwang", "createdAt": "2020-09-03T18:18:56Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -533,7 +533,7 @@ public void invoke(NotificationContext changeContext) throws Exception {\n     }\n   }\n \n-  private void subscribeChildChange(String path, NotificationContext.Type callbackType) {\n+  private List<String> subscribeChildChange(String path, NotificationContext.Type callbackType) {", "originalCommit": "f45fddee6e66505621a9bcb10730a833cd7e1f92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMjg2Mg==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483202862", "bodyText": "For debug, please add new fields to the end of the string. And don't change the existing content if they are not hurt too much. Otherwise, the dev needs to switch the code version back and forth to double-check before debugging the older version deployment.", "author": "jiajunwang", "createdAt": "2020-09-03T19:21:08Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -592,8 +595,8 @@ private void subscribeForChangesAsyn(NotificationContext.Type callbackType, Stri\n \n   private void subscribeForChanges(NotificationContext.Type callbackType, String path,\n       boolean watchChild) {\n-    logger.info(\"Subscribing changes listener to path: {}, type: {}, listener: {}\", path,\n-        callbackType, _listener);\n+    logger.info(\"Subscribing changes listener to path: {}, callback type: {}, event types: {}, \"", "originalCommit": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzMjgzMg==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483232832", "bodyText": "Actually when grepping, Subscribing changes listener to path:  would be good enough. Those variables could change for different callback and paths. we could grep for a specific string. Anyway, I'll address this to append the new fields to the end.", "author": "huizhilu", "createdAt": "2020-09-03T20:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMjg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMzU0MQ==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483203541", "bodyText": "I personally think these 2 info logs are still desired. Especially we are changing the subscription mechanism.", "author": "jiajunwang", "createdAt": "2020-09-03T19:22:30Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -604,11 +607,8 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n     }\n \n     if (_eventTypes.contains(EventType.NodeChildrenChanged)) {\n-      logger.info(\"Subscribing child change listener to path: {}\", path);", "originalCommit": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzMTU3Nw==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483231577", "bodyText": "From my debug experience, these 2 logs are distracting and not helping much. The import log we want is event type. We can use event type to determine the code logic here. And these 2 add too many lines of logs to the log file. So I prefer to remove them and instead log the event types.", "author": "huizhilu", "createdAt": "2020-09-03T20:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMzU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNTI4Ng==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483205286", "bodyText": "As I mentioned above, if the return value is ChildrenSubscribeResult, then you just need to check \"_isInstalled\" for the following logic.", "author": "jiajunwang", "createdAt": "2020-09-03T19:26:06Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +645,14 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              // When callback type is FINALIZE or PERIODIC_REFRESH, subscribeChildChange doesn't\n+              // get children list. We need to read children to unsubscribe data change listeners.\n+              if (callbackType != Type.INIT && callbackType != Type.CALLBACK) {", "originalCommit": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzMDcwNQ==", "url": "https://github.com/apache/helix/pull/1344#discussion_r484530705", "bodyText": "Replied above.", "author": "huizhilu", "createdAt": "2020-09-07T17:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNTI4Ng=="}], "type": "inlineReview"}, {"oid": "7dd53547af981b0760d522d23012c25d99e2445f", "url": "https://github.com/apache/helix/commit/7dd53547af981b0760d522d23012c25d99e2445f", "message": "Reduce unnecessary getChildren call in subscribeForChanges", "committedDate": "2020-09-03T19:36:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNDUwOQ==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483224509", "bodyText": "Parallel this using Asyc should bring more performance gain, right? why don't we do it here?", "author": "kaisun2000", "createdAt": "2020-09-03T20:06:26Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +645,14 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              // When callback type is FINALIZE, subscribeChildChange doesn't\n+              // get children list. We need to read children to unsubscribe data change listeners.\n+              if (callbackType == Type.FINALIZE) {\n+                children = _zkClient.getChildren(path);\n+              }\n+              if (children != null) {\n+                for (String child : children) {", "originalCommit": "7dd53547af981b0760d522d23012c25d99e2445f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyOTMyMQ==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483229321", "bodyText": "async processing this will have more changes. I'll leave that later in another PR.", "author": "huizhilu", "createdAt": "2020-09-03T20:16:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNDUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNjEwMg==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483226102", "bodyText": "I think the main issue here is that line 551\n_zkClient.subscribeChildChanges(path, this, callbackType != Type.INIT); we have two code path.\nif callbackType is init, the parent path of callback handler may not be created. Thus, the return would be null, or empty? Please verify.\nThe potentially issue is that note later at default, we re-use the return children list from here.\nNote, original code retrieve children one more time and it may retrieve node by then. Here, it may not.\nThis is different from previous logic. Not sure if this would bring a bug or not.", "author": "kaisun2000", "createdAt": "2020-09-03T20:09:43Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -554,12 +554,15 @@ private void subscribeChildChange(String path, NotificationContext.Type callback\n       if (!childrenSubscribeResult.isInstalled()) {\n         logger.info(\"CallbackHandler {} subscribe data path {} failed!\", this, path);\n       }\n+      return childrenSubscribeResult.getChildren();", "originalCommit": "7dd53547af981b0760d522d23012c25d99e2445f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzNjcxNg==", "url": "https://github.com/apache/helix/pull/1344#discussion_r483236716", "bodyText": "subscribeChildChanges returns null when the parent path doesn't exist.\nAbout the potential race condition, we can't rely on later getChildren to fetch children node if subscribeChildChanges returns null. Between these two calls, the time window is very tiny. And I believe the system could handle the change. If first is null (parent node does not exist), later it exists, we should be able to have another callback to handle.", "author": "huizhilu", "createdAt": "2020-09-03T20:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNjEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MDU4OA==", "url": "https://github.com/apache/helix/pull/1344#discussion_r489690588", "bodyText": "As we discussed, I think this check is not necessary. The later check for children != null is good enough.\nIf the node was not created and then create during this callback processing, then we will have another callback to process the event since the watcher has been added.", "author": "jiajunwang", "createdAt": "2020-09-16T19:13:32Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +652,14 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              // When callback type is FINALIZE, subscribeChildChange doesn't\n+              // get children list. We need to read children to unsubscribe data change listeners.\n+              if (callbackType == Type.FINALIZE) {\n+                children = _zkClient.getChildren(path);\n+              }", "originalCommit": "0eb643fb3620ea3381c5547432f13214a793ff2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNjIzNw==", "url": "https://github.com/apache/helix/pull/1344#discussion_r494636237", "bodyText": "Moved the logic to subscribeChildChange: for FINALIZE, it also returns the children.", "author": "huizhilu", "createdAt": "2020-09-24T22:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MDU4OA=="}], "type": "inlineReview"}, {"oid": "6c5eecd19d8aeb859f91efce182ad0fdf20caf5c", "url": "https://github.com/apache/helix/commit/6c5eecd19d8aeb859f91efce182ad0fdf20caf5c", "message": "Reduce unnecessary getChildren call in subscribeForChanges", "committedDate": "2020-09-24T21:59:33Z", "type": "commit"}, {"oid": "9e6598db2dd5c735a5a2335a543eed8183ae4bbd", "url": "https://github.com/apache/helix/commit/9e6598db2dd5c735a5a2335a543eed8183ae4bbd", "message": "Add comments", "committedDate": "2020-09-24T22:02:39Z", "type": "commit"}, {"oid": "26c8b0dda05a40cc72af93b3e03ce59c797753e0", "url": "https://github.com/apache/helix/commit/26c8b0dda05a40cc72af93b3e03ce59c797753e0", "message": "Return children for FINALIZE in subscribeChildChange", "committedDate": "2020-09-24T22:02:40Z", "type": "forcePushed"}, {"oid": "8397ce26bb449c9bf76c995377051c05a895ed1b", "url": "https://github.com/apache/helix/commit/8397ce26bb449c9bf76c995377051c05a895ed1b", "message": "Return children in subscribeChildChange", "committedDate": "2020-09-24T22:10:35Z", "type": "commit"}, {"oid": "8397ce26bb449c9bf76c995377051c05a895ed1b", "url": "https://github.com/apache/helix/commit/8397ce26bb449c9bf76c995377051c05a895ed1b", "message": "Return children in subscribeChildChange", "committedDate": "2020-09-24T22:10:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5MDE4NQ==", "url": "https://github.com/apache/helix/pull/1344#discussion_r494690185", "bodyText": "The current logic will return a list even the type is not INIT/CALLBACK/FINALIZE, right? Although I guess it is expected.\n\nPlease fix the comment.\nThe method name becomes misleading somehow with this change. I guess it should be called getChildrenAndSubscribeChildChange. Obviously, not a good name. But feel free to change if you have a better idea. This is just a nice to have thing.", "author": "jiajunwang", "createdAt": "2020-09-25T01:01:46Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -538,7 +538,12 @@ public void invoke(NotificationContext changeContext) throws Exception {\n     }\n   }\n \n-  private void subscribeChildChange(String path, NotificationContext.Type callbackType) {\n+  /*\n+   * If callback type is INIT or CALLBACK, subscribes child change listener to the path\n+   * and returns the path's children names. The children list might be null when the path\n+   * doesn't exist or callback type is other than INIT/CALLBACK/FINALIZE.", "originalCommit": "8397ce26bb449c9bf76c995377051c05a895ed1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5NDk0Ng==", "url": "https://github.com/apache/helix/pull/1344#discussion_r494694946", "bodyText": "Resolved comment.\nSince we also have subscribeChildChanges() in ZkClient that returns children, so I'd like to keep it as it is to be consistent. Besides, I don't have a better name for this and I think it is OK to keep it.", "author": "huizhilu", "createdAt": "2020-09-25T01:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5MDE4NQ=="}], "type": "inlineReview"}, {"oid": "173b911b4efe0df4964ca439c4a82fa3108b7f4e", "url": "https://github.com/apache/helix/commit/173b911b4efe0df4964ca439c4a82fa3108b7f4e", "message": "Change comments", "committedDate": "2020-09-25T01:22:47Z", "type": "commit"}]}