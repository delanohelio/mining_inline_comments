{"pr_number": 1295, "pr_title": "fix TestRawZkClient unstableness", "pr_createdAt": "2020-08-20T01:18:12Z", "pr_url": "https://github.com/apache/helix/pull/1295", "timeline": [{"oid": "e50fcea9d4d74cb5ba4fade88356757c5599b53d", "url": "https://github.com/apache/helix/commit/e50fcea9d4d74cb5ba4fade88356757c5599b53d", "message": "fix TestRawZkClient unstableness #1294\n\nZkClient connect to ZooKeeper client first before monitor bean\ninitialization. If the monitor is not fully constructed, the\ntest would pass. Otherwise, as in github, it would not. Fix this\nissue by properly construct the object.", "committedDate": "2020-08-20T01:13:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNjY1OQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474336659", "bodyText": "These fields are not helpful to the ZkClient.\nCould you try to change the ZkClientMonitor instead so as to avoid these fields? What I am thinking is that, allowing the _eventThread sub-monitor to be added later after the ZkClientMonitor has been constructed. So it can be done in the connect() by referring to _monitor.", "author": "jiajunwang", "createdAt": "2020-08-21T00:07:16Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -124,6 +125,13 @@\n   private PathBasedZkSerializer _pathBasedZkSerializer;\n   private ZkClientMonitor _monitor;\n \n+  final private String _monitorKey;", "originalCommit": "e50fcea9d4d74cb5ba4fade88356757c5599b53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg3MDk5Nw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474870997", "bodyText": "Changed.", "author": "kaisun2000", "createdAt": "2020-08-21T18:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNjY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzE4Mg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474337182", "bodyText": "the comment is not updated accordingly.\nCould you please justify the reason we need to triple the wait duration?", "author": "jiajunwang", "createdAt": "2020-08-21T00:09:08Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/TestHelper.java", "diffHunk": "@@ -32,7 +32,7 @@\n \n public class TestHelper {\n   private static final Logger LOG = LoggerFactory.getLogger(TestHelper.class);\n-  public static final long WAIT_DURATION = 20 * 1000L; // 20 seconds\n+  public static final long WAIT_DURATION = 60 * 1000L; // 20 seconds", "originalCommit": "e50fcea9d4d74cb5ba4fade88356757c5599b53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0NzQ5OQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474347499", "bodyText": "Github zookeeper is slow. See #1268 for profiling result. Using 60 secs does not really hurt anything, as we still poll the condition every 500ms.\nOtherwise, the test can be flaky.", "author": "kaisun2000", "createdAt": "2020-08-21T00:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyODEyMg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483228122", "bodyText": "\"the comment is not updated accordingly.\"", "author": "jiajunwang", "createdAt": "2020-09-03T20:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMxNzA4MA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483317080", "bodyText": "Good point, will update this one. Let us first resolve the bigger issue about how to initialize and how to make test stable.", "author": "kaisun2000", "createdAt": "2020-09-04T00:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474337348", "bodyText": "What happen to these 2 checks?", "author": "jiajunwang", "createdAt": "2020-08-21T00:09:44Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -285,18 +285,26 @@ public void testZkClientMonitor()\n     Assert.assertTrue(beanServer.isRegistered(idealStatename));\n \n     Assert.assertEquals((long) beanServer.getAttribute(name, \"DataChangeEventCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 0);\n+    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 1);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"ExpiredSessionCounter\"), 0);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"OutstandingRequestGauge\"), 0);\n     // account for doAsyncSync()\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"TotalCallbackCounter\"), 1);\n \n-    // Test exists\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadLatencyGauge.Max\"), 0);\n-    zkClient.exists(TEST_ROOT);\n+    // Note, we need to wait here for the reason that doAsyncSync() blocks only the zkClient event thread. The main\n+    // thread of zkClient would issue exits(TEST_ROOT) without blocking. The return of doAsyncSync() would be asyc\n+    // to main thread. doAsyncSync() is a source of 1 read and main thread exists(TEST_ROOT) would be another.\n+    TestHelper.verify(()->{\n+      return ((org.apache.helix.zookeeper.zkclient.ZkClient)zkClient).getSyncStatus();\n+    }, TestHelper.WAIT_DURATION);\n+\n     Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 1);\n+    //Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\"), 1);", "originalCommit": "e50fcea9d4d74cb5ba4fade88356757c5599b53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODE4Nw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474338187", "bodyText": "Do we really need this check? If we ensure after exists(), the read is 2, then we shall be good, right?\nNote that to check this read counter one by one, we need to add one method just for this purpose. I think it is an overkill and it is not necessary.", "author": "jiajunwang", "createdAt": "2020-08-21T00:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0ODU2Ng==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474348566", "bodyText": "You are right. line 302 and 303 can/should be removed.  The time value is indeterministic.\nline 301 is fine.", "author": "kaisun2000", "createdAt": "2020-08-21T00:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MTQ1Mw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474351453", "bodyText": "Seems you have concern about this one by increase it one by one https://github.com/apache/helix/pull/1295/files#r474338328\nLet me share my thinking here.\nThe doAsyncSync() callback finishing is async to main thread here. It can increase the read counter anytime.  Thus, we need TestHelper.verify to wait for this read from sync(). Here, delete line 301  assert is also ok, just wait for 307 having read counter as 2. Same reason, assert 301 is 1 is fine.\nIn sum, either way it is fine. But without TestHelper.verify waiting is not fine.", "author": "kaisun2000", "createdAt": "2020-08-21T01:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgzMzk4MQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r476833981", "bodyText": "2 ways are different because you will need to add code for supporting the check. If you think both ways of checking are fine, let's do the simpler one.", "author": "jiajunwang", "createdAt": "2020-08-25T23:07:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzMDY4MA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483230680", "bodyText": "\"But without TestHelper.verify waiting is not fine.\" why is that? You can TestHelper.verify to wait until the count is 2.\nMy suggestion is still getting rid of the getSyncStatus()", "author": "jiajunwang", "createdAt": "2020-09-03T20:18:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMxNjA5Nw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483316097", "bodyText": "Unfortunately, you can't or you have race condition in this case, if my understanding is right. Let me illustrate:\ndoAsycSync(), when the success code returns, it would increase by read counter one from the asyncThread in the ZkClient.\nNote, the main thread running zkClient.exist(Test_Root ) would increase read counter synchronously from main thread.\nThe problem is that the doAsynSync() increase to read counter is totally async to the main thread. It is the case that after main thread finish zkClient.exist(Test_Root ), the doAsyncSync() would finish for sure. Recent github test actually illustrate this point. Previous we don't realize as it did not happen.\nIn fact, theoretically, the doAsyncSync() increase can happen a lot later too.\nLet me know if there is other ways you think that we can make the test stable while also no need to use getSyncStatus().", "author": "kaisun2000", "createdAt": "2020-09-04T00:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQwMTA2Mg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r488401062", "bodyText": "Let's sync up tomorrow. I didn't get why waiting for the read count = 2 won't work.", "author": "jiajunwang", "createdAt": "2020-09-15T05:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzNTc0Nw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r489835747", "bodyText": "changed to waiting for 2", "author": "kaisun2000", "createdAt": "2020-09-17T00:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNzM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODMyOA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474338328", "bodyText": "I have multiple questions.\n\nIf this is just for test, please make it package-private.\nDo we really need to check the read count one by one increase?", "author": "jiajunwang", "createdAt": "2020-08-21T00:13:12Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -1281,6 +1279,10 @@ protected void doRetry() throws Exception {\n         });\n   }\n \n+  public boolean getSyncStatus() {", "originalCommit": "e50fcea9d4d74cb5ba4fade88356757c5599b53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MTY5MQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474351691", "bodyText": "1/ make this one @VisibleForTesting.\n2/ See my comment https://github.com/apache/helix/pull/1295/files#r474351453. See if this address the concern.", "author": "kaisun2000", "createdAt": "2020-08-21T01:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyOTU3OA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483229578", "bodyText": "Sorry that I cannot make the link work. Maybe because code has been changed. Could you please copy-paste your comment here? I still think this is not necessary.", "author": "jiajunwang", "createdAt": "2020-09-03T20:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMxNDY4Nw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483314687", "bodyText": "See the discussion above about why think we can't get rid of this getSyncStatus().", "author": "kaisun2000", "createdAt": "2020-09-04T00:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzNTQ5OA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r489835498", "bodyText": "removed.", "author": "kaisun2000", "createdAt": "2020-09-17T00:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxMzg3Mw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474313873", "bodyText": "Does the test really need 60s to poll the result? In my opinion it is too long. It would fail with 20s?", "author": "huizhilu", "createdAt": "2020-08-20T22:50:06Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/TestHelper.java", "diffHunk": "@@ -32,7 +32,7 @@\n \n public class TestHelper {\n   private static final Logger LOG = LoggerFactory.getLogger(TestHelper.class);\n-  public static final long WAIT_DURATION = 20 * 1000L; // 20 seconds\n+  public static final long WAIT_DURATION = 60 * 1000L; // 20 seconds", "originalCommit": "e50fcea9d4d74cb5ba4fade88356757c5599b53d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODYyNw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474338627", "bodyText": "We should consider closing the monitor to avoid leakage. If the later part of code zk connection timeout and throws exception, the monitor should also be closed.", "author": "huizhilu", "createdAt": "2020-08-21T00:14:10Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -2156,6 +2160,21 @@ public void connect(final long maxMsToWaitUntilConnected, Watcher watcher)\n \n       LOG.debug(\"ZkClient created with _uid {}, _eventThread {}\", _uid, _eventThread.getId());\n \n+      // initiate monitor\n+      try {\n+        if (_monitorKey != null && !_monitorKey.isEmpty() && _monitorType != null && !_monitorType\n+            .isEmpty()) {\n+          _monitor =\n+              new ZkClientMonitor(_monitorType, _monitorKey, _monitorInstanceName, _monitorRootPathOnly,", "originalCommit": "e50fcea9d4d74cb5ba4fade88356757c5599b53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0OTYyMQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474349621", "bodyText": "My thinking is that ZkClientMonitor does not hold any session object, nor thread. Let GC deal with it would be fine. Or do you see otherwise?", "author": "kaisun2000", "createdAt": "2020-08-21T00:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1NzExMw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474357113", "bodyText": "Why we move this into connect()? what problem we try to solve here?", "author": "lei-xia", "createdAt": "2020-08-21T01:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg3MjgxMg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r474872812", "bodyText": "Basically, currently code has a race condition. The event of _monitor construction and _monitor first event recording sequence are not deterministic. _monitor construction is in main thread which construct szkclient while statechangecount in _monitor is increased in zookeeper client event thread by calling process() of zkclient.\nSee the description of the issue #1294 for more info.", "author": "kaisun2000", "createdAt": "2020-08-21T18:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzODYyNw=="}], "type": "inlineReview"}, {"oid": "eb7dedf8a1edff93559ca1260217d913010cba98", "url": "https://github.com/apache/helix/commit/eb7dedf8a1edff93559ca1260217d913010cba98", "message": "change the zkmonitor construction sequence a little bit based on review.", "committedDate": "2020-08-21T03:08:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDMzMA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r476840330", "bodyText": "Let's give it a more complete change.\n\nThe constructor will not require _eventThread anymore, it will be null anyway.\nsetAndInitZkEventThreadMonitor shall create the event thread monitor and call updateAttributesInfo() to update the attribute. Re-register the whole monitor is wrong, you will end up either having 2 mbeans or the 2nd register will fail.", "author": "jiajunwang", "createdAt": "2020-08-25T23:13:34Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -222,22 +226,16 @@ protected ZkClient(IZkConnection zkConnection, int connectionTimeout, long opera\n     _asyncCallRetryThread.start();\n     LOG.debug(\"ZkClient created with _uid {}, _asyncCallRetryThread id {}\", _uid, _asyncCallRetryThread.getId());\n \n-    connect(connectionTimeout, this);\n-\n-    // initiate monitor\n-    try {\n-      if (monitorKey != null && !monitorKey.isEmpty() && monitorType != null && !monitorType\n-          .isEmpty()) {\n-        _monitor =\n-            new ZkClientMonitor(monitorType, monitorKey, monitorInstanceName, monitorRootPathOnly,\n-                _eventThread);\n-        _monitor.register();\n-      } else {\n-        LOG.info(\"ZkClient monitor key or type is not provided. Skip monitoring.\");\n-      }\n-    } catch (JMException e) {\n-      LOG.error(\"Error in creating ZkClientMonitor\", e);\n+    if (monitorKey != null && !monitorKey.isEmpty() && monitorType != null && !monitorType\n+        .isEmpty()) {\n+      _monitor =\n+          new ZkClientMonitor(monitorType, monitorKey, monitorInstanceName, monitorRootPathOnly,\n+              _eventThread);", "originalCommit": "eb7dedf8a1edff93559ca1260217d913010cba98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg2MjkwNA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r476862904", "bodyText": "Synced with Kai offline, the 2nd point is fine since the register will be postpone to the connect. Given this, I would prefer making the registration logic closer to the monitor construct logic.\nSo shall we pass the ZkClientMonitor into connect() to explicitly update it in the call. Then register the monitor after the connect(), but still in the constructor.\npseudo code:\n_monitor = new ZkClientMonitor();\n// Comment that we need to update the _monitor in the event lock to avoid missing any records about event thread.\nconnect(connectTimeout, this, _monitor);\n_monitor.register()", "author": "jiajunwang", "createdAt": "2020-08-25T23:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkxMDYzNw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r476910637", "bodyText": "This does not seem to work.\nFirst  it is not necessary to pass _monitor into connect(connectTimeout, this, _monitor); as _monitor is instance variable and connect is method. Connect can see it anyway.\nSecond, the gist to avoid all these racing issue is that we must make sure _monitor is fully constructed and also register-ed before ZkClient either get callback from ZK.", "author": "kaisun2000", "createdAt": "2020-08-26T00:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNzU5NA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483227594", "bodyText": "This is to make the code cleaner. It is a good practice for module the code that the private method does not refer to the class private fields directly.\n\n\nThe thread monitor is the only one impacted, so if you do the set there, there should be no problem. Mix everything together is chaotic. Ideally, I would suggest splitting the ZK client monitor and ZK thread monitor.", "author": "jiajunwang", "createdAt": "2020-09-03T20:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMxOTE0OA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r483319148", "bodyText": "Maybe I mis-understand what do you mean. Can you draw the code a little bit more specific?\nfrom the above pseduo code\n_monitor = new ZkClientMonitor();\n// Comment that we need to update the _monitor in the event lock to avoid missing any records about event thread.\nconnect(connectTimeout, this, _monitor);\n_monitor.register()\n\nAssertion: construction of ZkMonitor and ZkThreadMonitor and their registration must be done before the first doAsyncSync() is sent out, or you have race condition of missing some read/write.\nIn the above pseudo code, _monitor.register() is too late, the first sycn() is already out and it may complete earlier than this register().  This violate the above assertion. You may miss one increase of read counter.\nI may not fully understand your idea. Let us be more specific. As long as it works, I can change it to that way.", "author": "kaisun2000", "createdAt": "2020-09-04T00:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwODg4NA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r486708884", "bodyText": "The registration does not need to happen prior. Even not registered, the metric can record data.", "author": "jiajunwang", "createdAt": "2020-09-11T00:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzMjkyNA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r489832924", "bodyText": "I test it. It seems not true. We need to register the bean in connect() under the lock. Otherwise, depends on timing, you may lose one read.", "author": "kaisun2000", "createdAt": "2020-09-17T00:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0MDMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAyODAzOQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r477028039", "bodyText": "What's the reason to catch exception and print? I guess you want to have the stacktrace for debugging. But please be noted that if exception is thrown, this change will return a zkServer that's not started. I don't think this is what you expected, is it?\nI guest keeping it to throw exception so the test would not proceed.", "author": "huizhilu", "createdAt": "2020-08-26T04:33:59Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/ZkTestBase.java", "diffHunk": "@@ -143,7 +143,11 @@ protected ZkServer startZkServer(final String zkAddress) {\n     int port = Integer.parseInt(zkAddress.substring(zkAddress.lastIndexOf(':') + 1));\n     ZkServer zkServer = new ZkServer(dataDir, logDir, defaultNameSpace, port);\n     System.out.println(\"Starting ZK server at \" + zkAddress);\n-    zkServer.start();\n+    try {\n+      zkServer.start();\n+    } catch (Exception e) {", "originalCommit": "eb7dedf8a1edff93559ca1260217d913010cba98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4MDY2OA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r477480668", "bodyText": "You are right. Let me re-throw the exception to prevent the test from proceeding.\nWithout printing it out here, the problem is that Intellij will not print out the exception here. Thus, it seems to be a mystery as why all the test is skipped.", "author": "kaisun2000", "createdAt": "2020-08-26T17:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAyODAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM4NjQ2Ng==", "url": "https://github.com/apache/helix/pull/1295#discussion_r480386466", "bodyText": "Revert this part.", "author": "kaisun2000", "createdAt": "2020-08-31T20:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAyODAzOQ=="}], "type": "inlineReview"}, {"oid": "56a86cb7e9fb055b62b078dcd54fa756e8d755f2", "url": "https://github.com/apache/helix/commit/56a86cb7e9fb055b62b078dcd54fa756e8d755f2", "message": "rethrow exception based on feedback", "committedDate": "2020-08-26T17:55:56Z", "type": "commit"}, {"oid": "2c6beb5d9d69dda8a6a9c55bae3e1e25a90c5039", "url": "https://github.com/apache/helix/commit/2c6beb5d9d69dda8a6a9c55bae3e1e25a90c5039", "message": "revert catch exception in creating zkserver", "committedDate": "2020-08-31T20:39:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ1NDA3Ng==", "url": "https://github.com/apache/helix/pull/1295#discussion_r481454076", "bodyText": "Nit: If we need to check exits(), we should assert true? I actually don't think it is necessary as below already checks. But if really check, assert true is needed.\nif (!_zkClient.exists(TEST_ROOT)) {\n       _zkClient.createPersistent(TEST_ROOT, true);\n}", "author": "huizhilu", "createdAt": "2020-09-01T21:55:16Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -285,18 +285,24 @@ public void testZkClientMonitor()\n     Assert.assertTrue(beanServer.isRegistered(idealStatename));\n \n     Assert.assertEquals((long) beanServer.getAttribute(name, \"DataChangeEventCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 0);\n+    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 1);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"ExpiredSessionCounter\"), 0);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"OutstandingRequestGauge\"), 0);\n     // account for doAsyncSync()\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"TotalCallbackCounter\"), 1);\n \n-    // Test exists\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadLatencyGauge.Max\"), 0);\n-    zkClient.exists(TEST_ROOT);\n+    // Note, we need to wait here for the reason that doAsyncSync() blocks only the zkClient event thread. The main\n+    // thread of zkClient would issue exits(TEST_ROOT) without blocking. The return of doAsyncSync() would be asyc\n+    // to main thread. doAsyncSync() is a source of 1 read and main thread exists(TEST_ROOT) would be another.\n+    TestHelper.verify(()->{\n+      return ((org.apache.helix.zookeeper.zkclient.ZkClient)zkClient).getSyncStatus();\n+    }, TestHelper.WAIT_DURATION);\n+\n     Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 1);\n+\n+    zkClient.exists(TEST_ROOT);", "originalCommit": "2c6beb5d9d69dda8a6a9c55bae3e1e25a90c5039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ1ODc4Mg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r481458782", "bodyText": "This is not to assert exists() return true. This is to make sure the next Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 2); would be true. Namely this trigger a read and get recorded by bean.\nThis is not functionality added by me. It is basically line 298 in previous version.", "author": "kaisun2000", "createdAt": "2020-09-01T22:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ1NDA3Ng=="}], "type": "inlineReview"}, {"oid": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "url": "https://github.com/apache/helix/commit/d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "message": "waiting for 2 read coming back based on feedback.", "committedDate": "2020-09-17T00:49:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzNDAxOA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r489834018", "bodyText": "Note, It seems crucial to register here. Or depending on timing, we may lose read of the first sync().", "author": "kaisun2000", "createdAt": "2020-09-17T00:55:18Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -2152,6 +2150,19 @@ public void connect(final long maxMsToWaitUntilConnected, Watcher watcher)\n \n       IZkConnection zkConnection = getConnection();\n       _eventThread = new ZkEventThread(zkConnection.getServers());\n+\n+      if (_monitor != null) {\n+        _monitor.setAndInitZkEventThreadMonitor(_eventThread);\n+      }\n+\n+      try {", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNTExMg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490635112", "bodyText": "I debugged with your code, so the ZkClientPathMonitor objects are currently only created in the register() method. So that's the reason we lose the count if register later.\nThere is a simple fix, we can instantiate all the ZkClientPathMonitors in the ZkClientMonitor constructor. Like this,\nfor (ZkClientPathMonitor.PredefinedPath path :\nZkClientPathMonitor.PredefinedPath.values()) {\n      // If monitor root path only, check if the current path is Root.\n      // Otherwise, add monitors for every path.\n      if (!_monitorRootOnly || path.equals(ZkClientPathMonitor.PredefinedPath.Root)) {\n        _zkClientPathMonitorMap.put(path,\n            new ZkClientPathMonitor(path, _monitorType, _monitorKey, _monitorInstanceName));\n      }\n    }\n\nThen in the register(), just register all the ZkClientPathMonitor objects that are in the _zkClientPathMonitorMap.\nThe good thing is that it seems to be the right change that we should do no matter we want to fix the test or not.", "author": "jiajunwang", "createdAt": "2020-09-18T00:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzNDAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2NzY3MQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490667671", "bodyText": "implemeted this way", "author": "kaisun2000", "createdAt": "2020-09-18T02:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzNDAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNTY1Nw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490635657", "bodyText": "nit, throw Exception if the _zkEventThreadMetric has already been set or the monitor object has already been registered. Otherwise, we may see an unexpected monitor value in the final result.", "author": "jiajunwang", "createdAt": "2020-09-18T00:37:20Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/metric/ZkClientMonitor.java", "diffHunk": "@@ -96,6 +96,12 @@ public static ObjectName getObjectName(String monitorType, String monitorKey,\n             (monitorKey + (monitorInstanceName == null ? \"\" : \".\" + monitorInstanceName)));\n   }\n \n+  public void setAndInitZkEventThreadMonitor(ZkEventThread zkEventThread) {\n+    if (_zkEventThreadMetric == null) {\n+      _zkEventThreadMetric = new ZkThreadMetric(zkEventThread);", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNjM3MA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490636370", "bodyText": "BTW, you can check for registration status by checking _objectName with a synchronized lock on the monitor object.", "author": "jiajunwang", "createdAt": "2020-09-18T00:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNTY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MTI3Mw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490641273", "bodyText": "What type of exception would be good here?", "author": "kaisun2000", "createdAt": "2020-09-18T00:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNTY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0NjE1OQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490646159", "bodyText": "Let me put a return value as false and let the calling layer log error", "author": "kaisun2000", "createdAt": "2020-09-18T01:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNTY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNjg1OQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490636859", "bodyText": "Is this value still validatable?", "author": "jiajunwang", "createdAt": "2020-09-18T00:42:01Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -285,18 +285,20 @@ public void testZkClientMonitor()\n     Assert.assertTrue(beanServer.isRegistered(idealStatename));\n \n     Assert.assertEquals((long) beanServer.getAttribute(name, \"DataChangeEventCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 0);\n+    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 1);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"ExpiredSessionCounter\"), 0);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"OutstandingRequestGauge\"), 0);\n-    // account for doAsyncSync()\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"TotalCallbackCounter\"), 1);", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2NzUyNg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490667526", "bodyText": "no, not realiably I guess.", "author": "kaisun2000", "createdAt": "2020-09-18T02:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNjg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzU0Nw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490637547", "bodyText": "no need anymore?", "author": "jiajunwang", "createdAt": "2020-09-18T00:44:33Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -31,9 +31,11 @@\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.CopyOnWriteArraySet;\n import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0Mzk2OA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490643968", "bodyText": "fix.", "author": "kaisun2000", "createdAt": "2020-09-18T01:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzYzNA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490637634", "bodyText": "With the latest proposal, this one can be removed too.", "author": "jiajunwang", "createdAt": "2020-09-18T00:44:52Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -31,9 +31,11 @@\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.CopyOnWriteArraySet;\n import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.concurrent.atomic.AtomicLong;\n import javax.management.JMException;\n \n+import com.google.common.annotations.VisibleForTesting;", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0NDAxOA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490644018", "bodyText": "fixed.", "author": "kaisun2000", "createdAt": "2020-09-18T01:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzODMyNQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490638325", "bodyText": "Actually, can we wait here before \"zkClient.exists(TEST_ROOT);\" for ReadCounter == 1. Then wait here for 2? So we ensure exist call will increase one counter too.", "author": "jiajunwang", "createdAt": "2020-09-18T00:47:22Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -285,18 +285,20 @@ public void testZkClientMonitor()\n     Assert.assertTrue(beanServer.isRegistered(idealStatename));\n \n     Assert.assertEquals((long) beanServer.getAttribute(name, \"DataChangeEventCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 0);\n+    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 1);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"ExpiredSessionCounter\"), 0);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"OutstandingRequestGauge\"), 0);\n-    // account for doAsyncSync()\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"TotalCallbackCounter\"), 1);\n \n-    // Test exists\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 0);", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2NzM4Mw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490667383", "bodyText": "right.", "author": "kaisun2000", "createdAt": "2020-09-18T02:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzODMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzODUxNA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490638514", "bodyText": "If you wait for the counter in the previous line, then here we can still check for\nAssert.assertTrue((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\") >= 0);\nAssert.assertTrue((long) beanServer.getAttribute(rootname, \"ReadLatencyGauge.Max\") >= 0);\t    \n\nright?", "author": "jiajunwang", "createdAt": "2020-09-18T00:48:06Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -285,18 +285,20 @@ public void testZkClientMonitor()\n     Assert.assertTrue(beanServer.isRegistered(idealStatename));\n \n     Assert.assertEquals((long) beanServer.getAttribute(name, \"DataChangeEventCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 0);\n+    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 1);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"ExpiredSessionCounter\"), 0);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"OutstandingRequestGauge\"), 0);\n-    // account for doAsyncSync()\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"TotalCallbackCounter\"), 1);\n \n-    // Test exists\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadLatencyGauge.Max\"), 0);", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzODY2Ng==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490638666", "bodyText": "I propose that we record the ReadTotalLatencyCounter that we get before exists() call. Then we check if this counter is equal to the previous value or is increased here.", "author": "jiajunwang", "createdAt": "2020-09-18T00:48:44Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -285,18 +285,20 @@ public void testZkClientMonitor()\n     Assert.assertTrue(beanServer.isRegistered(idealStatename));\n \n     Assert.assertEquals((long) beanServer.getAttribute(name, \"DataChangeEventCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 0);\n+    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 1);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"ExpiredSessionCounter\"), 0);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"OutstandingRequestGauge\"), 0);\n-    // account for doAsyncSync()\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"TotalCallbackCounter\"), 1);\n \n-    // Test exists\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadLatencyGauge.Max\"), 0);\n     zkClient.exists(TEST_ROOT);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 1);\n+\n+    // Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 2);\n+    // wait for both doAysncSync() finish and zkClient.exists(Test_ROOT) finish from 2 different threads.\n+    // The condition would be ReadCounter is 2.\n+    boolean verifyResult = TestHelper.verify(()->{\n+       return (long) beanServer.getAttribute(rootname, \"ReadCounter\") == 2;\n+    }, TestHelper.WAIT_DURATION);\n+    Assert.assertTrue(verifyResult, \" did not see 2 read yet\");\n+\n     Assert.assertTrue((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\") >= 0);", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2NzIxMw==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490667213", "bodyText": "fixed.", "author": "kaisun2000", "createdAt": "2020-09-18T02:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzODY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzOTA5OQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490639099", "bodyText": "If we checked \"ReadLatencyGauge.Max\" before, then this one can be ignored.", "author": "jiajunwang", "createdAt": "2020-09-18T00:50:17Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -285,18 +285,20 @@ public void testZkClientMonitor()\n     Assert.assertTrue(beanServer.isRegistered(idealStatename));\n \n     Assert.assertEquals((long) beanServer.getAttribute(name, \"DataChangeEventCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 0);\n+    Assert.assertEquals((long) beanServer.getAttribute(name, \"StateChangeEventCounter\"), 1);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"ExpiredSessionCounter\"), 0);\n     Assert.assertEquals((long) beanServer.getAttribute(name, \"OutstandingRequestGauge\"), 0);\n-    // account for doAsyncSync()\n-    Assert.assertEquals((long) beanServer.getAttribute(name, \"TotalCallbackCounter\"), 1);\n \n-    // Test exists\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\"), 0);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadLatencyGauge.Max\"), 0);\n     zkClient.exists(TEST_ROOT);\n-    Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 1);\n+\n+    // Assert.assertEquals((long) beanServer.getAttribute(rootname, \"ReadCounter\"), 2);\n+    // wait for both doAysncSync() finish and zkClient.exists(Test_ROOT) finish from 2 different threads.\n+    // The condition would be ReadCounter is 2.\n+    boolean verifyResult = TestHelper.verify(()->{\n+       return (long) beanServer.getAttribute(rootname, \"ReadCounter\") == 2;\n+    }, TestHelper.WAIT_DURATION);\n+    Assert.assertTrue(verifyResult, \" did not see 2 read yet\");\n+\n     Assert.assertTrue((long) beanServer.getAttribute(rootname, \"ReadTotalLatencyCounter\") >= 0);\n     Assert.assertTrue((long) beanServer.getAttribute(rootname, \"ReadLatencyGauge.Max\") >= 0);", "originalCommit": "d344bb4f8d3bb84d5c0ffab6111cbd96c3014d9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2NzE5Mg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r490667192", "bodyText": "fixed.", "author": "kaisun2000", "createdAt": "2020-09-18T02:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzOTA5OQ=="}], "type": "inlineReview"}, {"oid": "fd11e750f6969c11580fdec851fd2d328d9b5345", "url": "https://github.com/apache/helix/commit/fd11e750f6969c11580fdec851fd2d328d9b5345", "message": "refactor based on feedback.", "committedDate": "2020-09-18T03:06:45Z", "type": "commit"}, {"oid": "dfbc7ba8bfcfc719974133a478e6722aed052535", "url": "https://github.com/apache/helix/commit/dfbc7ba8bfcfc719974133a478e6722aed052535", "message": "a little beautification", "committedDate": "2020-09-18T03:09:16Z", "type": "commit"}, {"oid": "bda05c989a413f2b9113691bdc29db4777f72a40", "url": "https://github.com/apache/helix/commit/bda05c989a413f2b9113691bdc29db4777f72a40", "message": "fix null point issue.", "committedDate": "2020-09-18T06:32:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNTQ3OQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r492425479", "bodyText": "_logger exists in the super class. There is no need to add a new one here.", "author": "jiajunwang", "createdAt": "2020-09-22T01:01:17Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/metric/ZkClientMonitor.java", "diffHunk": "@@ -38,9 +38,13 @@\n import org.apache.helix.monitoring.mbeans.dynamicMBeans.SimpleDynamicMetric;\n import org.apache.helix.monitoring.mbeans.exception.MetricException;\n import org.apache.helix.zookeeper.zkclient.ZkEventThread;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n \n public class ZkClientMonitor extends DynamicMBeanProvider {\n+  private static final Logger LOG = LoggerFactory.getLogger(ZkClientMonitor.class);", "originalCommit": "bda05c989a413f2b9113691bdc29db4777f72a40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzMjIwMg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r492432202", "bodyText": "fixed.", "author": "kaisun2000", "createdAt": "2020-09-22T01:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNTQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNjAzMQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r492426031", "bodyText": "nit, it could be simpler to be:\n_zkClientPathMonitorMap.values().stream().foreach(...);", "author": "jiajunwang", "createdAt": "2020-09-22T01:03:48Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/metric/ZkClientMonitor.java", "diffHunk": "@@ -109,12 +135,8 @@ public DynamicMBeanProvider register() throws JMException {\n     doRegister(attributeList, MBEAN_DESCRIPTION,\n         getObjectName(_monitorType, _monitorKey, _monitorInstanceName));\n     for (ZkClientPathMonitor.PredefinedPath path : ZkClientPathMonitor.PredefinedPath.values()) {\n-      // If monitor root path only, check if the current path is Root.\n-      // Otherwise, add monitors for every path.\n-      if (!_monitorRootOnly || path.equals(ZkClientPathMonitor.PredefinedPath.Root)) {\n-        _zkClientPathMonitorMap.put(path,\n-            new ZkClientPathMonitor(path, _monitorType, _monitorKey, _monitorInstanceName)\n-                .register());\n+      if (_zkClientPathMonitorMap.get(path) != null)  {\n+        _zkClientPathMonitorMap.get(path).register();", "originalCommit": "bda05c989a413f2b9113691bdc29db4777f72a40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzNjM3Mg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r492436372", "bodyText": "There are many ways to write a loop and now we have stream.\nStill, I will just change it anyway.", "author": "kaisun2000", "createdAt": "2020-09-22T01:50:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNjAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNjEwNQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r492426105", "bodyText": "Unnecessary?", "author": "jiajunwang", "createdAt": "2020-09-22T01:04:06Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/metric/ZkClientPathMonitor.java", "diffHunk": "@@ -32,6 +32,9 @@\n import org.apache.helix.monitoring.mbeans.dynamicMBeans.DynamicMetric;\n import org.apache.helix.monitoring.mbeans.dynamicMBeans.HistogramDynamicMetric;\n import org.apache.helix.monitoring.mbeans.dynamicMBeans.SimpleDynamicMetric;\n+import org.apache.helix.zookeeper.zkclient.ZkClient;", "originalCommit": "bda05c989a413f2b9113691bdc29db4777f72a40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQzMjM2MA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r492432360", "bodyText": "removed.", "author": "kaisun2000", "createdAt": "2020-09-22T01:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNjEwNQ=="}], "type": "inlineReview"}, {"oid": "df7f28e34fcfaf2fad7811ccdcf79a5acce03cb7", "url": "https://github.com/apache/helix/commit/df7f28e34fcfaf2fad7811ccdcf79a5acce03cb7", "message": "some minor fix based on feedback.", "committedDate": "2020-09-22T01:45:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3NDI3OA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r492474278", "bodyText": "Unnecessary.", "author": "jiajunwang", "createdAt": "2020-09-22T04:58:21Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/metric/ZkClientPathMonitor.java", "diffHunk": "@@ -34,6 +34,7 @@\n import org.apache.helix.monitoring.mbeans.dynamicMBeans.SimpleDynamicMetric;\n \n \n+", "originalCommit": "df7f28e34fcfaf2fad7811ccdcf79a5acce03cb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExNjA3NQ==", "url": "https://github.com/apache/helix/pull/1295#discussion_r493116075", "bodyText": "removed.", "author": "kaisun2000", "createdAt": "2020-09-23T01:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3NDI3OA=="}], "type": "inlineReview"}, {"oid": "6299574b08c97ca30cf282cdad331de750408dd1", "url": "https://github.com/apache/helix/commit/6299574b08c97ca30cf282cdad331de750408dd1", "message": "touch", "committedDate": "2020-09-22T19:52:42Z", "type": "commit"}, {"oid": "c6122a841da629e09b5e2699d4f2ddcdf51782d0", "url": "https://github.com/apache/helix/commit/c6122a841da629e09b5e2699d4f2ddcdf51782d0", "message": "remove additional empty lines", "committedDate": "2020-09-23T01:04:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAzOTAwOA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r494039008", "bodyText": "nit, but could you please revert this \"touch\" change?", "author": "jiajunwang", "createdAt": "2020-09-24T04:58:22Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/metric/ZkClientMonitor.java", "diffHunk": "@@ -96,7 +96,7 @@ public ZkClientMonitor(String monitorType, String monitorKey, String monitorInst\n \n     for (ZkClientPathMonitor.PredefinedPath path : ZkClientPathMonitor.PredefinedPath.values()) {\n       // If monitor root path only, check if the current path is Root.\n-      // Otherwise, add monitors for every path.\n+      // Otherwise, add monitors for every  path.", "originalCommit": "6299574b08c97ca30cf282cdad331de750408dd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "24d8138f3cfcfb32c5e73cf36ca9173faab5709c", "url": "https://github.com/apache/helix/commit/24d8138f3cfcfb32c5e73cf36ca9173faab5709c", "message": "remove an space", "committedDate": "2020-09-24T06:32:47Z", "type": "commit"}, {"oid": "9eb1df0c25b36d5fe008a97ab6ea459e6bb7b599", "url": "https://github.com/apache/helix/commit/9eb1df0c25b36d5fe008a97ab6ea459e6bb7b599", "message": "touch helix-core to trigger a run", "committedDate": "2020-09-24T21:53:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0NDEyNA==", "url": "https://github.com/apache/helix/pull/1295#discussion_r498544124", "bodyText": "Please remove the extra space before merge.", "author": "jiajunwang", "createdAt": "2020-10-01T22:31:55Z", "path": "helix-core/src/test/java/org/apache/helix/integration/TestPartitionMovementThrottle.java", "diffHunk": "@@ -215,7 +215,7 @@ public void testANYtypeThrottle() throws InterruptedException {\n     DelayedTransition.setDelay(20);\n     DelayedTransition.enableThrottleRecord();\n \n-    // start another 3 nodes\n+    // start another 3 nodes ", "originalCommit": "9eb1df0c25b36d5fe008a97ab6ea459e6bb7b599", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU1MzE2Mg==", "url": "https://github.com/apache/helix/pull/1295#discussion_r498553162", "bodyText": "removed.", "author": "kaisun2000", "createdAt": "2020-10-01T23:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0NDEyNA=="}], "type": "inlineReview"}, {"oid": "1a353d38f67510f2d39922bf94e2a91db635e287", "url": "https://github.com/apache/helix/commit/1a353d38f67510f2d39922bf94e2a91db635e287", "message": "remove an extra space", "committedDate": "2020-10-01T23:02:45Z", "type": "commit"}]}