{"pr_number": 1157, "pr_title": "fix TestRebalancePipeline test", "pr_createdAt": "2020-07-20T00:33:13Z", "pr_url": "https://github.com/apache/helix/pull/1157", "timeline": [{"oid": "416f69352e4011294423581f351e8ae405e25f2a", "url": "https://github.com/apache/helix/commit/416f69352e4011294423581f351e8ae405e25f2a", "message": "fix TestRebalancePipeline test", "committedDate": "2020-07-20T00:29:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk5Njg2Mw==", "url": "https://github.com/apache/helix/pull/1157#discussion_r456996863", "bodyText": "Could you add a comment here stating why we need to set async tasks thread pool? What happens if we don't? I ask because it doesn't seem like we do this in the previous version.", "author": "narendly", "createdAt": "2020-07-20T02:30:46Z", "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +62,9 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    dataCache.setAsyncTasksThreadPool(Executors.newSingleThreadExecutor());", "originalCommit": "416f69352e4011294423581f351e8ae405e25f2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNTQ3NQ==", "url": "https://github.com/apache/helix/pull/1157#discussion_r457015475", "bodyText": "Sure. I'll add. The reason I found this issue is that when I changed the session Id to be a valid one, the test actually failed. And debugging, I found it's due to the Executor was not set up, and thus the periodically clean up job for pending messages throw an NPE, which caused the pipeline to stop.\nDetails:\n1    [main] ERROR org.apache.helix.common.ZkTestBase  - Exception while executing pipeline:org.apache.helix.controller.pipeline.Pipeline@9597028. Will not continue to next pipeline\njava.lang.NullPointerException at org.apache.helix.controller.stages.MessageGenerationPhase.schedulePendingMessageCleanUp(MessageGenerationPhase.java:339)", "author": "zhangmeng916", "createdAt": "2020-07-20T03:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk5Njg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEyNDc3MA==", "url": "https://github.com/apache/helix/pull/1157#discussion_r457124770", "bodyText": "I see. Although not directly related to this PR, do you think we should consider handling this NPE? It seems like something we should handle more gracefully (we probably won't have this issue in production, the urgency won't be too high). I'm fine with creating an issue with a clear context/what to fix so that someone could pick it up in the future.", "author": "narendly", "createdAt": "2020-07-20T07:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk5Njg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUyNTAxNg==", "url": "https://github.com/apache/helix/pull/1157#discussion_r457525016", "bodyText": "Our controller has properly set this field during construction: cache.setAsyncTasksThreadPool(_asyncTasksThreadPool);\nI'd think the code itself should be safe.", "author": "zhangmeng916", "createdAt": "2020-07-20T16:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk5Njg2Mw=="}], "type": "inlineReview"}, {"oid": "bd859e4d7e9316e46843cef9114a68c3bda15839", "url": "https://github.com/apache/helix/commit/bd859e4d7e9316e46843cef9114a68c3bda15839", "message": "add comment", "committedDate": "2020-07-20T03:50:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEyNTg3Nw==", "url": "https://github.com/apache/helix/pull/1157#discussion_r457125877", "bodyText": "Once we create an issue, you could link that issue number in the comment so we could track it better.", "author": "narendly", "createdAt": "2020-07-20T07:22:28Z", "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +62,11 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    // The AsyncTasksThreadPool needs to be set, otherwise to start pending message cleanup job\n+    // will throw NPE and stop the pipeline.", "originalCommit": "bd859e4d7e9316e46843cef9114a68c3bda15839", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d47b7afd53d634cf7b9d163a06bae54c022aa12", "url": "https://github.com/apache/helix/commit/7d47b7afd53d634cf7b9d163a06bae54c022aa12", "message": "refer issue", "committedDate": "2020-07-20T16:04:10Z", "type": "commit"}, {"oid": "ba9d614ff757debf3354fc8758f22217d9e6552a", "url": "https://github.com/apache/helix/commit/ba9d614ff757debf3354fc8758f22217d9e6552a", "message": "add tracking issue", "committedDate": "2020-07-20T19:02:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYzMTMxNw==", "url": "https://github.com/apache/helix/pull/1157#discussion_r457631317", "bodyText": "Another important thing we should do here is to shut down the threads/thread pool. Otherwise, there will be a thread pool/thread leak throughout the test suite. This has been a real pain for Helix's test suite, so let's make sure we don't leak it here.\nWe could pull out this single thread executor to create a reference and shut it down at the end of the test.", "author": "narendly", "createdAt": "2020-07-20T19:09:13Z", "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +62,11 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    // The AsyncTasksThreadPool needs to be set, otherwise to start pending message cleanup job\n+    // will throw NPE and stop the pipeline. TODO: https://github.com/apache/helix/issues/1158\n+    dataCache.setAsyncTasksThreadPool(Executors.newSingleThreadExecutor());", "originalCommit": "ba9d614ff757debf3354fc8758f22217d9e6552a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3f6cdf2497706a6f287a468561075c1638661750", "url": "https://github.com/apache/helix/commit/3f6cdf2497706a6f287a468561075c1638661750", "message": "add thread shut down", "committedDate": "2020-07-20T19:30:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDI2NA==", "url": "https://github.com/apache/helix/pull/1157#discussion_r457680264", "bodyText": "Should we not have this variable in the scope of the class? Since this isn't being used throughout the class, we could just create the reference in the test method and shut down at the very end of the method. That way, we don't need to add the afterClass() method.", "author": "narendly", "createdAt": "2020-07-20T20:43:52Z", "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -45,10 +47,17 @@\n import org.apache.helix.model.Message;\n import org.apache.helix.model.Partition;\n import org.testng.Assert;\n+import org.testng.annotations.AfterClass;\n import org.testng.annotations.Test;\n \n public class TestRebalancePipeline extends ZkUnitTestBase {\n   private final String _className = getShortClassName();\n+  private ExecutorService _executorService;", "originalCommit": "3f6cdf2497706a6f287a468561075c1638661750", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDU1Mg==", "url": "https://github.com/apache/helix/pull/1157#discussion_r457680552", "bodyText": "_executorService  does not have to be a private variable. We could probably just use a local reference, and shut down at the end of the method.", "author": "narendly", "createdAt": "2020-07-20T20:44:27Z", "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +70,12 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    // The AsyncTasksThreadPool needs to be set, otherwise to start pending message cleanup job\n+    // will throw NPE and stop the pipeline. TODO: https://github.com/apache/helix/issues/1158\n+    _executorService = Executors.newSingleThreadExecutor();", "originalCommit": "3f6cdf2497706a6f287a468561075c1638661750", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aa2c2554ddea1572a39f7cdb3a04f802194126ca", "url": "https://github.com/apache/helix/commit/aa2c2554ddea1572a39f7cdb3a04f802194126ca", "message": "move shut down to test", "committedDate": "2020-07-20T21:44:38Z", "type": "commit"}]}