{"pr_number": 4537, "pr_title": "Create TownPreUnclaimCmdEvent, Relocate and extend Town(Pre)UnclaimEvents.", "pr_createdAt": "2020-12-07T09:56:24Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4537", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMzYzNw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r537523637", "bodyText": "On a previous change (maybe neutrality toggling) I put in returns after the event.setCancelled(true), just in case this first statement and the following statement were both true, the 2nd cancellation message would override the first.", "author": "LlmDl", "createdAt": "2020-12-07T13:55:29Z", "path": "src/com/palmergames/bukkit/towny/war/flagwar/listeners/TownyCommonListener.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package com.palmergames.bukkit.towny.war.flagwar.listeners;\r\n+\r\n+import com.palmergames.bukkit.towny.TownySettings;\r\n+import com.palmergames.bukkit.towny.object.Translation;\r\n+import com.palmergames.bukkit.towny.war.common.events.WarPreUnclaimEvent;\r\n+import com.palmergames.bukkit.towny.war.flagwar.FlagWar;\r\n+import org.bukkit.event.EventHandler;\r\n+import org.bukkit.event.EventPriority;\r\n+import org.bukkit.event.Listener;\r\n+\r\n+/**\r\n+ * Listener for processing events from Towny's Common War Events.\r\n+ */\r\n+public class TownyCommonListener implements Listener {\r\n+\r\n+  @EventHandler (priority= EventPriority.HIGH)\r\n+  private void onWarPreUnclaim(WarPreUnclaimEvent event) {\r\n+    if (FlagWar.isUnderAttack(event.getTown()) && TownySettings.isFlaggedInteractionTown()) {\r\n+      event.setCancelMessage(Translation.of(\"msg_war_flag_deny_town_under_attack\"));\r\n+      event.setCancelled(true);\r", "originalCommit": "39f0c93c3e8afd4c92a18e10a213b7e431b2eebf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc0NjA3NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r537746074", "bodyText": "I don't think it was the Neutrality toggles, but I see what you're saying there.", "author": "TheFlagCourier", "createdAt": "2020-12-07T18:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMzYzNw=="}], "type": "inlineReview"}, {"oid": "612cd487e53a1e7da215e5008429e89b0eaaf316", "url": "https://github.com/TownyAdvanced/Towny/commit/612cd487e53a1e7da215e5008429e89b0eaaf316", "message": "Re-pkg WarPreUnclaimEvent as TownPreUnclaimCmdEvent in `event.town` pkg.\n\nMakes a bit more sense, when you think about it. It's capable of being called by more than just war plugins, and fragmenting events into separate packages within the same project is insane on it's own.\n\nAdded note to class Javadoc about potential confusion with TownyPreUnclaimEvent.\n\nThanks to @Silverwolfg11 and @LlmDl for discussing this and offering the suggestion.", "committedDate": "2020-12-09T00:44:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk2MzgxNg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r538963816", "bodyText": "Complete TODO.", "author": "LlmDl", "createdAt": "2020-12-09T02:47:26Z", "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -626,32 +626,25 @@ public void removeResident(Resident resident) {\n \n \t@Override\n \tpublic void removeTownBlock(TownBlock townBlock) {\n+\t\tTown town = null;\n+\t\ttry {\n+\t\t\ttown = townBlock.getTown();\n+\t\t} catch (NotRegisteredException e) {\n+\t\t\t// TODO: Log why a TownBlock would not have a town.\n+\t\t\t// If there is not an associated town, it's probably not a valid TownBlock. Should we return?\n+\t\t}\n \n-\t\tTownPreUnclaimEvent event = new TownPreUnclaimEvent(townBlock);\n+\t\tTownPreUnclaimEvent event = new TownPreUnclaimEvent(town, townBlock);\n \t\tBukkitTools.getPluginManager().callEvent(event);\n \t\t\n-\t\tif (event.isCancelled())\n+\t\tif (event.isCancelled() || town == null) {\n+\t\t\tSystem.out.println(event.getCancelMessage()); //TODO: Replace with a Log4J logger.", "originalCommit": "bb7ab9bac430b6489dc9b1bb19622220a1bb8242", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgyODk4OA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r539828988", "bodyText": "Should be resolved as of 3c64903 (#4537)", "author": "TheFlagCourier", "createdAt": "2020-12-10T04:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk2MzgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzMTMwNA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r539631304", "bodyText": "if it has no valid town it should be nuked still (I don't think townless townblocks are possible anyways nowadays.)", "author": "LlmDl", "createdAt": "2020-12-09T20:39:49Z", "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -626,32 +626,25 @@ public void removeResident(Resident resident) {\n \n \t@Override\n \tpublic void removeTownBlock(TownBlock townBlock) {\n+\t\tTown town = null;\n+\t\ttry {\n+\t\t\ttown = townBlock.getTown();\n+\t\t} catch (NotRegisteredException e) {\n+\t\t\t// TODO: Log why a TownBlock would not have a town.\n+\t\t\t// If there is not an associated town, it's probably not a valid TownBlock. Should we return?", "originalCommit": "bb7ab9bac430b6489dc9b1bb19622220a1bb8242", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgyOTI5NQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r539829295", "bodyText": "Should now log as an error, with an early return.", "author": "TheFlagCourier", "createdAt": "2020-12-10T04:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzMTMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExMDM4Ng==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r540110386", "bodyText": "By nuking, I meant it should be removed. Any townblock missing a town has to get removed otherwise we end up with ghost-townblocks. The return can be removed from here, I've made a separate comment about the TownPreUnclaimEvent having the town annotated as well.", "author": "LlmDl", "createdAt": "2020-12-10T11:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzMTMwNA=="}], "type": "inlineReview"}, {"oid": "3c649034d2f98f28eb0fce1a38c4437d5b265505", "url": "https://github.com/TownyAdvanced/Towny/commit/3c649034d2f98f28eb0fce1a38c4437d5b265505", "message": "Early return to removeTownBlock on catch. Implement Log4j2 I/O\n\nAdds an early return if the TownBlock has no valid town.\nImplements Log4J 2, replacing System.out.", "committedDate": "2020-12-10T04:02:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExMjUyOA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r540112528", "bodyText": "This should get an @nullable annotation on it to handle the cases where townless-townblocks are being removed, or alternatively, no event should be fired if the removeTownBlock() method has a null town.", "author": "LlmDl", "createdAt": "2020-12-10T12:01:21Z", "path": "src/com/palmergames/bukkit/towny/event/town/TownPreUnclaimEvent.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.palmergames.bukkit.towny.event.town;\r\n+\r\n+import com.palmergames.bukkit.towny.object.Town;\r\n+import com.palmergames.bukkit.towny.object.TownBlock;\r\n+import com.palmergames.bukkit.towny.object.Translation;\r\n+import org.bukkit.Bukkit;\r\n+import org.bukkit.event.Cancellable;\r\n+import org.bukkit.event.Event;\r\n+import org.bukkit.event.HandlerList;\r\n+import org.jetbrains.annotations.NotNull;\r\n+\r\n+\r\n+public class TownPreUnclaimEvent extends Event implements Cancellable {\r\n+\r\n+    private static final HandlerList handlers = new HandlerList();\r\n+    private final TownBlock townBlock;\r\n+    private final Town town;\r\n+    private boolean isCancelled = false;\r\n+    private String cancelMessage = Translation.of(\"msg_err_town_unclaim_canceled\");\r\n+\r\n+    @NotNull\r\n+    @Override\r\n+    public HandlerList getHandlers() {\r\n+        return getHandlerList();\r\n+    }\r\n+    \r\n+    public static HandlerList getHandlerList() {\r\n+\t\treturn handlers;\r\n+\t}\r\n+\r\n+    /**\r\n+     * Event thrown prior to a {@link TownBlock} being unclaimed by a {@link Town}.\r\n+     * <p>\r\n+     * This is cancellable but it is probably not a good idea to do\r\n+     * so without testing.\r\n+     *\r\n+     * @param town The Town unclaiming the TownBlock.\r\n+     * @param townBlock The TownBlock that will be unclaimed.\r\n+     */\r\n+    public TownPreUnclaimEvent(Town town, TownBlock townBlock) {\r\n+        super(!Bukkit.getServer().isPrimaryThread());\r\n+        this.town = town;\r\n+        this.townBlock = townBlock;\r\n+\r\n+        // Don't even bother with things if town is null.\r\n+        if (this.town == null){\r\n+            this.cancelMessage = Translation.of(\"msg_area_not_recog\");\r\n+            setCancelled(true);\r\n+        }\r\n+    }\r\n+\r\n+    /**\r\n+     * @return Check if the event is cancelled or not, yet.\r\n+     */\r\n+    @Override\r\n+    public boolean isCancelled() {\r\n+        return isCancelled;\r\n+    }\r\n+\r\n+    /**\r\n+     * @param cancelled The incoming boolean that sets if the event is to be cancelled.\r\n+     */\r\n+    @Override\r\n+    public void setCancelled(boolean cancelled) {\r\n+        isCancelled = cancelled;\r\n+    }\r\n+    \r\n+    /**\r\n+     * @return the {@link Town}.\r\n+     */\r\n+    public Town getTown() {\r", "originalCommit": "3c649034d2f98f28eb0fce1a38c4437d5b265505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUzMDU1Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4537#discussion_r540530557", "bodyText": "Given that there's 28 instances of removeTownBlock() being declared or called (not counting instances in comments and the changelog), I've opted for the shorter route. I'm a tired dunce right now, forgot that's the method I'm working with in TDH...", "author": "TheFlagCourier", "createdAt": "2020-12-10T22:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExMjUyOA=="}], "type": "inlineReview"}, {"oid": "b838e26c55343b1c2566438dea9f2db28b36f403", "url": "https://github.com/TownyAdvanced/Towny/commit/b838e26c55343b1c2566438dea9f2db28b36f403", "message": "Move `Town(Pre)UnclaimEvent` to the `...events.town` package\n\n- Deprecate at old locations with deprecation messages.\n- Add cancellation messages to the TownPreUnclaimEvent\n- Add a generic language string.\n- Change TownyDatabaseHandler constructor from public to protected. We're in an abstract class, so only other package members can even access this.\n\nIn deprecated methods, the [VERSION] will need to be changed post-merge, as I have no idea when that could be.", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "d850409f303173e0b2edfd41ad427da48528a3e0", "url": "https://github.com/TownyAdvanced/Towny/commit/d850409f303173e0b2edfd41ad427da48528a3e0", "message": "Create event to catch unclaim commands for war systems\n\n- Creates WarPreUnclaimEvent\n  - Cancellable\n  - Default message from previous commit.\n  - Event runs where FlagWar used to check if the town was under attack, or was attacked recently.\n  - Usable by other war systems wishing to hook into it; it makes the town, resident, and TownyWorld available.\n  - Accessible through  the war.common package.\n- Creates TownyCommonListener in flagwar.listeners\n  - Handles the WarPreUnclaimEvent with the previously mentioned executions.\n  - May be refactored post-split, but intended to listen to any events in war.common.event package.\n- Register TownyCommonListener within FlagWar (as opposed to Towny)", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "99ab4ebe16754af765412d7377699659cb7400bb", "url": "https://github.com/TownyAdvanced/Towny/commit/99ab4ebe16754af765412d7377699659cb7400bb", "message": "Add a breaking return to TownyCommonListener\n\nPrevent second if from overwriting the first's message.", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "539d61fb1c16fee24b86f621fdfd1bebd6120cca", "url": "https://github.com/TownyAdvanced/Towny/commit/539d61fb1c16fee24b86f621fdfd1bebd6120cca", "message": "Re-pkg WarPreUnclaimEvent as TownPreUnclaimCmdEvent in `event.town` pkg.\n\nMakes a bit more sense, when you think about it. It's capable of being called by more than just war plugins, and fragmenting events into separate packages within the same project is insane on it's own.\n\nAdded note to class Javadoc about potential confusion with TownyPreUnclaimEvent.\n\nThanks to @Silverwolfg11 and @LlmDl for discussing this and offering the suggestion.", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "f2bebbaf566ed3b663594d6dbc89f03416ec3c3d", "url": "https://github.com/TownyAdvanced/Towny/commit/f2bebbaf566ed3b663594d6dbc89f03416ec3c3d", "message": "Add Javadocs to TownPreUnclaimCmdEvent's methods.\n\nJust filling in documentation.", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "3b3e4e1bd6fda13f2cc1e797ef15347cea9d6ffe", "url": "https://github.com/TownyAdvanced/Towny/commit/3b3e4e1bd6fda13f2cc1e797ef15347cea9d6ffe", "message": "Bump remaining language files to 0.93\n\nI guess someone forgot to bump them? Adds relevant keys from this PR and https://github.com/TownyAdvanced/Towny/commit/b910e2b9b273d2eaf33ebc9163c57dde1569bc76", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "b7bc4e4a977f8aff11ef3685400327335f841099", "url": "https://github.com/TownyAdvanced/Towny/commit/b7bc4e4a977f8aff11ef3685400327335f841099", "message": "Merge TownyCommonListener into FlagWarCustomListener", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "94c6c2f9022499a32eb8eba524f5422d35059f62", "url": "https://github.com/TownyAdvanced/Towny/commit/94c6c2f9022499a32eb8eba524f5422d35059f62", "message": "Early return to removeTownBlock on catch. Implement Log4j2 I/O\n\nAdds an early return if the TownBlock has no valid town.\nImplements Log4J 2, replacing System.out.", "committedDate": "2020-12-10T21:52:03Z", "type": "commit"}, {"oid": "4b927ed43834d96d87daf260432bdafceb5b535c", "url": "https://github.com/TownyAdvanced/Towny/commit/4b927ed43834d96d87daf260432bdafceb5b535c", "message": "Annotate Nullable contract for getTown\n\nSee [Jetbrains Annotations: Nullable and NotNull](https://www.jetbrains.com/help/idea/nullable-and-notnull-annotations.html#notnull)", "committedDate": "2020-12-10T22:00:25Z", "type": "commit"}, {"oid": "4b927ed43834d96d87daf260432bdafceb5b535c", "url": "https://github.com/TownyAdvanced/Towny/commit/4b927ed43834d96d87daf260432bdafceb5b535c", "message": "Annotate Nullable contract for getTown\n\nSee [Jetbrains Annotations: Nullable and NotNull](https://www.jetbrains.com/help/idea/nullable-and-notnull-annotations.html#notnull)", "committedDate": "2020-12-10T22:00:25Z", "type": "forcePushed"}, {"oid": "8e816c5d36da19fe40958a879806929c8bc3af5d", "url": "https://github.com/TownyAdvanced/Towny/commit/8e816c5d36da19fe40958a879806929c8bc3af5d", "message": "Remove a return in TDH#removeTownBlock(); add Nullable to TUE#getTown()\n\nThe town is allowed to be null, the TownPreUnclaimCmdEvent simply cancels itself if it is.", "committedDate": "2020-12-10T22:19:49Z", "type": "commit"}]}