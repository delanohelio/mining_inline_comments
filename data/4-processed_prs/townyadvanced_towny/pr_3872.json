{"pr_number": 3872, "pr_title": "Hotfix/paper async", "pr_createdAt": "2020-04-04T03:36:57Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3872", "timeline": [{"oid": "36de6868996509f44d05ab2bffe0f07e9d86f070", "url": "https://github.com/TownyAdvanced/Towny/commit/36de6868996509f44d05ab2bffe0f07e9d86f070", "message": "Shade in paperlib for async chunk loading.", "committedDate": "2020-04-03T18:31:01Z", "type": "commit"}, {"oid": "a1c184bd5cc6945bf2dace6ee61a17c61beda0ac", "url": "https://github.com/TownyAdvanced/Towny/commit/a1c184bd5cc6945bf2dace6ee61a17c61beda0ac", "message": "fix spawn events and clean up async teleporting.", "committedDate": "2020-04-04T03:35:55Z", "type": "commit"}, {"oid": "a2a201e502c010b8f078ed0e45b35d3da8aaa67e", "url": "https://github.com/TownyAdvanced/Towny/commit/a2a201e502c010b8f078ed0e45b35d3da8aaa67e", "message": "Merge remote-tracking branch 'origin/master'", "committedDate": "2020-04-04T03:37:21Z", "type": "commit"}, {"oid": "16ed583ad2a69fdf847442287a0ef99cee008fd6", "url": "https://github.com/TownyAdvanced/Towny/commit/16ed583ad2a69fdf847442287a0ef99cee008fd6", "message": "Merge branch 'master' into hotfix/paper-async\n\n# Conflicts:\n#\tsrc/com/palmergames/bukkit/towny/utils/SpawnUtil.java", "committedDate": "2020-04-04T03:38:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ1ODEzMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3872#discussion_r403458133", "bodyText": "This still doesn't work when the player is going to an outpost.", "author": "LlmDl", "createdAt": "2020-04-04T11:15:01Z", "path": "src/com/palmergames/bukkit/towny/utils/SpawnUtil.java", "diffHunk": "@@ -349,40 +351,72 @@ else if (town != null)\n \t\t\t}\r\n \t\t}\r\n \t\t\r\n-\t\t// Used later to make sure the chunk we teleport to is loaded.\r\n-\t\tCompletableFuture<Chunk> chunkFuture = PaperLib.getChunkAtAsync(spawnLoc);\r\n-\t\t\r\n-\t\t// Legacy code (non-paper sync)\r\n-\t\t//Chunk chunk = spawnLoc.getChunk();\r\n+\t\tif (!sendSpawnEvent(player, spawnType, townyObject)) {\r\n+\t\t\treturn;\r\n+\t\t}\r\n \r\n-\t\tLocation finalSpawnLoc = spawnLoc;\r\n-\t\tchunkFuture.thenAccept((chunk -> {\r\n-\t\t\t// If an Admin or Essentials teleport isn't being used, use our own.\r\n-\t\t\tif (isTownyAdmin) {\r\n-\t\t\t\tif (player.getVehicle() != null)\r\n-\t\t\t\t\tplayer.getVehicle().eject();\r\n-\t\t\t\tplayer.teleport(finalSpawnLoc, TeleportCause.COMMAND);\r\n-\t\t\t\treturn;\r\n-\t\t\t}\r\n+\t\t// If an Admin or Essentials teleport isn't being used, use our own.\r\n+\t\tif (isTownyAdmin) {\r\n+\t\t\tif (player.getVehicle() != null)\r\n+\t\t\t\tplayer.getVehicle().eject();\r\n+\t\t\tPaperLib.teleportAsync(player, spawnLoc, TeleportCause.COMMAND);\r\n+\t\t\treturn;\r\n+\t\t}\r\n \r\n \t\t\tif (!usingESS) {\r\n \t\t\t\tif (TownyTimerHandler.isTeleportWarmupRunning()) {\r\n \t\t\t\t\t// Use teleport warmup\r\n \t\t\t\t\tplayer.sendMessage(String.format(TownySettings.getLangString(\"msg_town_spawn_warmup\"),\r\n \t\t\t\t\t\tTownySettings.getTeleportWarmupTime()));\r\n-\t\t\t\t\tTownyAPI.getInstance().requestTeleport(player, finalSpawnLoc);\r\n-\t\t\t\t} else {\r\n-\t\t\t\t\t// Don't use teleport warmup\r\n-\t\t\t\t\tif (player.getVehicle() != null)\r\n-\t\t\t\t\t\tplayer.getVehicle().eject();\r\n-\t\t\t\t\tplayer.teleport(finalSpawnLoc, TeleportCause.COMMAND);\r\n-\t\t\t\t\tif (TownySettings.getSpawnCooldownTime() > 0)\r\n-\t\t\t\t\t\tCooldownTimerTask.addCooldownTimer(resident.getName(), CooldownType.TELEPORT);\r\n-\t\t\t\t}\r\n+\t\t\t\tTownyAPI.getInstance().requestTeleport(player, spawnLoc);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Don't use teleport warmup\r\n+\t\t\t\tif (player.getVehicle() != null)\r\n+\t\t\t\t\tplayer.getVehicle().eject();\r\n+\t\t\t\tPaperLib.teleportAsync(player, spawnLoc, TeleportCause.COMMAND);\r\n+\t\t\t\tif (TownySettings.getSpawnCooldownTime() > 0)\r\n+\t\t\t\t\tCooldownTimerTask.addCooldownTimer(resident.getName(), CooldownType.TELEPORT);\r\n \t\t\t}\r\n-\t\t}));\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\tpublic static boolean sendSpawnEvent(Player player, SpawnType type, TownyObject object) {\r\n+\t\tswitch (type) {\r\n+\t\t\tcase TOWN:\r\n+\t\t\t\tTown town = (Town)object;\r\n+\t\t\t\tLocation to;\r\n+\t\t\t\ttry {\r\n+\t\t\t\t\tto = town.getSpawn();\r", "originalCommit": "16ed583ad2a69fdf847442287a0ef99cee008fd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5d3ac9e345275b2084fc3a7ad17ca46f9101d9eb", "url": "https://github.com/TownyAdvanced/Towny/commit/5d3ac9e345275b2084fc3a7ad17ca46f9101d9eb", "message": "fix outpost for town spawn events.", "committedDate": "2020-04-04T15:56:22Z", "type": "commit"}, {"oid": "ad97a5adc606a46a9bf1083ad2788d6f63566134", "url": "https://github.com/TownyAdvanced/Towny/commit/ad97a5adc606a46a9bf1083ad2788d6f63566134", "message": "Remove testing code.", "committedDate": "2020-04-04T16:17:40Z", "type": "commit"}, {"oid": "848f39f303590ff77badd76c81f0cfad2a475675", "url": "https://github.com/TownyAdvanced/Towny/commit/848f39f303590ff77badd76c81f0cfad2a475675", "message": "clean up and add proper docs.", "committedDate": "2020-04-04T19:20:40Z", "type": "commit"}, {"oid": "329413a1869b4421788bc1b931e2b7764816d3ec", "url": "https://github.com/TownyAdvanced/Towny/commit/329413a1869b4421788bc1b931e2b7764816d3ec", "message": "fix typo", "committedDate": "2020-04-04T19:22:39Z", "type": "commit"}, {"oid": "41c254fc6ba6e4ed858b016e53b1e573f691933f", "url": "https://github.com/TownyAdvanced/Towny/commit/41c254fc6ba6e4ed858b016e53b1e573f691933f", "message": "revert custom listener changes.", "committedDate": "2020-04-04T19:40:21Z", "type": "commit"}]}