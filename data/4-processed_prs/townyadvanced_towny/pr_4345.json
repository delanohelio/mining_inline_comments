{"pr_number": 4345, "pr_title": "Dragon Fireball Damage handling.", "pr_createdAt": "2020-09-28T16:44:58Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4345", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMDM5Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4345#discussion_r496110397", "bodyText": "I would cancel and do event.getEntity().remove() this way the same checks aren't being done every 5 ticks.", "author": "creatorfromhell", "createdAt": "2020-09-28T17:16:20Z", "path": "src/com/palmergames/bukkit/towny/listeners/TownyEntityListener.java", "diffHunk": "@@ -375,6 +378,39 @@ public void onEntityDamageByEntityEvent(EntityDamageByEntityEvent event) {\n \t\t\t\r\n \t}\r\n \r\n+\t/**\r\n+\t * Handles dragon fireball's cloud damage to players.\r\n+\t * \r\n+\t * @param event AreaEffectCloudApplyEvent\r\n+\t */\r\n+\t@EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)\r\n+\tpublic void onDragonFireBallCloudDamage(AreaEffectCloudApplyEvent event) {\r\n+\t\tif (!TownyAPI.getInstance().isTownyWorld(event.getEntity().getWorld()))\r\n+\t\t\treturn;\r\n+\t\t\r\n+\t\tif (!event.getEntity().getBasePotionData().getType().equals(PotionType.UNCRAFTABLE))\r\n+\t\t\treturn;\r\n+\r\n+\t\tif (!(event.getEntity().getSource() instanceof Player) || !(event.getEntity().getSource() instanceof DragonFireball))\r\n+\t\t\treturn;\r\n+\r\n+\t\tList<LivingEntity> entities = event.getAffectedEntities();\r\n+\r\n+\t\tTownyWorld townyWorld = null;\r\n+\t\ttry {\r\n+\t\t\ttownyWorld = TownyUniverse.getInstance().getDataSource().getWorld(event.getEntity().getWorld().getName());\r\n+\t\t} catch (NotRegisteredException e) {\r\n+\t\t\t// Failed to fetch a world\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\tfor (LivingEntity entity : entities) {\r\n+\t\t\tTownBlock townBlock = TownyAPI.getInstance().getTownBlock(entity.getLocation());\r\n+\t\t\tif (CombatUtil.preventPvP(townyWorld, townBlock)) {\r\n+\t\t\t\tevent.setCancelled(true);\r", "originalCommit": "b6942303fa1c2ef69d023fa57d7465ac4d4d0491", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyODM0Nw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4345#discussion_r496128347", "bodyText": "Yeah, not all entities might be immune from the cloud though, some could be in a PVP-enabled area.", "author": "LlmDl", "createdAt": "2020-09-28T17:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMDM5Nw=="}], "type": "inlineReview"}, {"oid": "e6cdbec3355ace2f4d345202636a0ba64df66e27", "url": "https://github.com/TownyAdvanced/Towny/commit/e6cdbec3355ace2f4d345202636a0ba64df66e27", "message": "Dragon Fireball Damage handling.\n\n - Potential solution for #4100.\n - Not ideal.\n - So far I have not found a way to handle Dragon Fireballs better.\n - They fire a ProjectileHitEvent which cannot be cancelled.\n - They generate an AreaEffectCloud which only returns the type\nUNCRAFTABLE.\n - The only way so far is to listen for the AreaEffectCloudApplyEvent\nand if it is UNCRAFTABLE, check the hurt entities one by one using the\nCombatUtil.\n - As this is technically a mob damage, it shouldn't really be\nconsidered PVP (arrows fired by a skeleton from outside of town still\nhurts players with PVP off.)\n - Some people are using slimefun to have dragon pets that end up\nshooting these fireballs...", "committedDate": "2020-11-21T12:12:03Z", "type": "commit"}, {"oid": "8296b64daa11921351509d620b724209a9dfc2f7", "url": "https://github.com/TownyAdvanced/Towny/commit/8296b64daa11921351509d620b724209a9dfc2f7", "message": "Revise check to just remove the AreaEffectCloud when it has spawned in a\nPVP-off area.", "committedDate": "2020-11-21T12:12:03Z", "type": "commit"}, {"oid": "7cca3cb78780aa271cd21898c281c18292d54fcb", "url": "https://github.com/TownyAdvanced/Towny/commit/7cca3cb78780aa271cd21898c281c18292d54fcb", "message": "creatorfromhell's annual contribution.", "committedDate": "2020-11-21T12:12:03Z", "type": "commit"}, {"oid": "7cca3cb78780aa271cd21898c281c18292d54fcb", "url": "https://github.com/TownyAdvanced/Towny/commit/7cca3cb78780aa271cd21898c281c18292d54fcb", "message": "creatorfromhell's annual contribution.", "committedDate": "2020-11-21T12:12:03Z", "type": "forcePushed"}, {"oid": "2a756587181295cc6d3d0d40e4e21bd632355982", "url": "https://github.com/TownyAdvanced/Towny/commit/2a756587181295cc6d3d0d40e4e21bd632355982", "message": "- Remove unused import.", "committedDate": "2020-11-21T12:13:35Z", "type": "commit"}]}