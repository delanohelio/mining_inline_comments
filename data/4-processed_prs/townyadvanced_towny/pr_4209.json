{"pr_number": 4209, "pr_title": "Remove Manual Config Changes and Migrate them automatically instead.", "pr_createdAt": "2020-07-24T00:51:16Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/4209", "timeline": [{"oid": "b48c8ee827dcffc7274486e5831643fa18c87b4a", "url": "https://github.com/TownyAdvanced/Towny/commit/b48c8ee827dcffc7274486e5831643fa18c87b4a", "message": "Initial Commit", "committedDate": "2020-07-24T00:33:01Z", "type": "commit"}, {"oid": "2d218646a3662e6bac74610b3fbc5e516bb55761", "url": "https://github.com/TownyAdvanced/Towny/commit/2d218646a3662e6bac74610b3fbc5e516bb55761", "message": "Merge branches 'feature/config-migration' and 'master' of https://github.com/TownyAdvanced/Towny into feature/config-migration\n\n\u0001 Conflicts:\n\u0001\tpom.xml", "committedDate": "2020-07-24T00:34:43Z", "type": "commit"}, {"oid": "191676952f246920baedd5211436849998881b17", "url": "https://github.com/TownyAdvanced/Towny/commit/191676952f246920baedd5211436849998881b17", "message": "Add support for adding town and nation level properties.", "committedDate": "2020-07-24T03:04:33Z", "type": "commit"}, {"oid": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "url": "https://github.com/TownyAdvanced/Towny/commit/44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "message": "Removed unused code.", "committedDate": "2020-07-24T20:01:19Z", "type": "commit"}, {"oid": "ca201a077cd93af2637912ee72ee23be4f7c0a60", "url": "https://github.com/TownyAdvanced/Towny/commit/ca201a077cd93af2637912ee72ee23be4f7c0a60", "message": "revert datasource change.", "committedDate": "2020-07-24T20:31:09Z", "type": "commit"}, {"oid": "32f414c571937510f6f037273ba1c9391d8fe895", "url": "https://github.com/TownyAdvanced/Towny/commit/32f414c571937510f6f037273ba1c9391d8fe895", "message": "Remove test migrations from json file.", "committedDate": "2020-07-24T20:32:55Z", "type": "commit"}, {"oid": "4b0a25b73af773b1b92761df9c3a7702b6c42346", "url": "https://github.com/TownyAdvanced/Towny/commit/4b0a25b73af773b1b92761df9c3a7702b6c42346", "message": "Remove unused files.", "committedDate": "2020-07-24T20:36:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MTk3Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460271973", "bodyText": "Nuke these ones", "author": "LlmDl", "createdAt": "2020-07-24T20:26:32Z", "path": "resources/config-migration.json", "diffHunk": "@@ -0,0 +1,55 @@\n+[\n+  {\n+    \"version\": \"0.96.2.2\",\n+    \"changes\": [\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"protection.switch_ids\",\n+        \"value\": \",CRIMSON_PRESSURE_PLATE,WARPED_PRESSURE_PLATE,POLISHED_BLACKSTONE_PRESSURE_PLATE,CRIMSON_BUTTON,WARPED_BUTTON,POLISHED_BLACKSTONE_BUTTON,CRIMSON_DOOR,WARPED_DOOR,CRIMSON_FENCE_GATE,WARPED_FENCE_GATE,CRIMSON_TRAPDOOR,WARPED_TRAPDOOR,LODESTONE,RESPAWN_ANCHOR,TARGET\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"protection.item_use_ids\",\n+        \"value\": \",NETHERITE_AXE\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"new_world_settings.plot_management.revert_on_unclaim.block_ignore\",\n+        \"value\": \",NETHER_GOLD_ORE,ANCIENT_DEBRIS,SOUL_TORCH,SOUL_WALL_TORCH,CRIMSON_SIGN,CRIMSON_WALL_SIGN,WARPED_SIGN,WARPED_WALL_SIGN,LODESTONE,RESPAWN_ANCHOR\",\n+        \"worldAction\": \"UPDATE_WORLD_BLOCK_IGNORE\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"new_world_settings.plot_management.mayor_plotblock_delete.mayor_plot_delete\",\n+        \"value\": \",CRIMSON_WALL_SIGN,CRIMSON_SIGN,WARPED_WALL_SIGN,WARPED_SIGN\",\n+        \"worldAction\": \"UPDATE_WORLD_DELETE_MAYOR\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"new_world_settings.plot_management.block_delete.unclaim_delete\",\n+        \"value\": \",CRIMSON_SIGN,WARPED_SIGN,CRIMSON_WALL_SIGN,WARPED_WALL_SIGN,CRIMSON_DOOR,WARPED_DOOR,SOUL_TORCH,SOUL_WALL_TORCH,CRIMSON_PRESSURE_PLATE,WARPED_PRESSURE_PLATE,POLISHED_BLACKSTONE_PRESSURE_PLATE\",\n+        \"worldAction\": \"UPDATE_WORLD_UNCLAIM_DELETE\"\n+      }\n+    ]\n+  },\n+  {\n+    \"version\": \"0.96.2.3\",\n+    \"changes\": [\n+      {\n+        \"type\": \"OVERWRITE\",\n+        \"path\": \"notification.format\",\n+        \"value\": \"This is a test\"\n+      }\n+    ]\n+  },\n+  {\n+    \"version\": \"0.96.2.4\",\n+    \"changes\": [\n+      {\n+        \"type\": \"TOWN_LEVEL_ADD\",\n+        \"key\": \"foo\",\n+        \"value\": \"bar\"\n+      }\n+    ]\n+  }", "originalCommit": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjM4OA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460272388", "bodyText": "remove unused import", "author": "LlmDl", "createdAt": "2020-07-24T20:27:33Z", "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -2,6 +2,7 @@\n \n import com.palmergames.bukkit.config.CommentedConfiguration;\n import com.palmergames.bukkit.config.ConfigNodes;\n+import com.palmergames.bukkit.config.migration.ConfigMigrator;", "originalCommit": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjQxMQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460272411", "bodyText": "Remove formatting change.", "author": "LlmDl", "createdAt": "2020-07-24T20:27:36Z", "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -231,7 +236,7 @@ public static void loadConfig(String filepath, String version) throws IOExceptio\n \t\t\t}\n \n \t\t\tsetDefaults(version, file);\n-\n+\t\t\t", "originalCommit": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjYyMg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460272622", "bodyText": "Add [Towny] to beginning of Performing ....", "author": "LlmDl", "createdAt": "2020-07-24T20:28:11Z", "path": "src/com/palmergames/bukkit/towny/TownyUniverse.java", "diffHunk": "@@ -142,6 +144,16 @@ boolean loadSettings() {\n             return false;\n         }\n         \n+        Version lastRunVersion = new Version(TownySettings.getLastRunVersion(Towny.getPlugin().getVersion()));\n+        Version curVersion = new Version(Towny.getPlugin().getVersion());\n+        \n+        // Only migrate if the user just updated.\n+        if (!lastRunVersion.equals(curVersion)) {\n+\t\t\tSystem.out.println(\"Performing Config Migrations...\");", "originalCommit": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NTg3Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460275872", "bodyText": "remove", "author": "LlmDl", "createdAt": "2020-07-24T20:36:25Z", "path": "src/com/palmergames/bukkit/towny/db/TownyDataSource.java", "diffHunk": "@@ -46,6 +46,7 @@\n \tfinal Lock lock = new ReentrantLock();\n \tprotected final Towny plugin;\n \tprotected final TownyUniverse universe;\n+\tprivate Runnable completionHandler;", "originalCommit": "32f414c571937510f6f037273ba1c9391d8fe895", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjAyOQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460276029", "bodyText": "delete class", "author": "LlmDl", "createdAt": "2020-07-24T20:36:48Z", "path": "src/com/palmergames/bukkit/config/migration/NationLevelMigration.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.palmergames.bukkit.config.migration;", "originalCommit": "32f414c571937510f6f037273ba1c9391d8fe895", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjA2NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460276064", "bodyText": "delete class", "author": "LlmDl", "createdAt": "2020-07-24T20:36:55Z", "path": "src/com/palmergames/bukkit/config/migration/TownLevelMigration.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.palmergames.bukkit.config.migration;", "originalCommit": "32f414c571937510f6f037273ba1c9391d8fe895", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b43b4f384998c5fc0ef23ea699aa8fc912a3194", "url": "https://github.com/TownyAdvanced/Towny/commit/5b43b4f384998c5fc0ef23ea699aa8fc912a3194", "message": "Make requested changes.", "committedDate": "2020-07-24T20:40:43Z", "type": "commit"}, {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c", "url": "https://github.com/TownyAdvanced/Towny/commit/788266fb3fb221562d48f2d47718116d5d50ef6c", "message": "Cleanup", "committedDate": "2020-07-24T20:45:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNTcyMQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460305721", "bodyText": "Use the logger", "author": "silverwolfg11", "createdAt": "2020-07-24T21:58:25Z", "path": "src/com/palmergames/bukkit/config/migration/ConfigMigrator.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package com.palmergames.bukkit.config.migration;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+import com.palmergames.bukkit.config.CommentedConfiguration;\n+import com.palmergames.bukkit.towny.Towny;\n+import com.palmergames.bukkit.towny.TownySettings;\n+import com.palmergames.bukkit.towny.TownyUniverse;\n+import com.palmergames.bukkit.towny.object.TownyWorld;\n+import com.palmergames.bukkit.util.Version;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.Reader;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * An object which manages the procces of migrating towny config versions to \n+ * up-to-date ones.\n+ */\n+public class ConfigMigrator {\n+\t\n+\tprivate final String migrationFilename;\n+\tprivate static final Gson GSON = new GsonBuilder()\n+\t\t.registerTypeAdapter(Version.class, new VersionDeserializer()).create();\n+\tprivate final CommentedConfiguration config;\n+\t\n+\tpublic ConfigMigrator(CommentedConfiguration config, String filename) {\n+\t\tObjects.requireNonNull(config, filename);\n+\t\tthis.migrationFilename = filename;\n+\t\tthis.config = config;\n+\t}\n+\n+\t/**\n+\t * Migrates configuration to latest version availibe in the given JSON file.\n+\t */\n+\tpublic void migrate() {\n+\t\t// Use the last run version as a reference.\n+\t\tVersion configVersion = new Version(TownySettings.getLastRunVersion(Towny.getPlugin().getVersion()));\n+\t\t\n+\t\t// Go through each migration element.\n+\t\tfor (Migration migration : readMigrator()) {\n+\t\t\t// If a migration version is greater than our version, upgrade with it.\n+\t\t\tif (configVersion.compareTo(migration.version) < 0) {\n+\t\t\t\t// Perform all desired changes.\n+\t\t\t\tfor (Change change : migration.changes) {\n+\t\t\t\t\tperformChange(change);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tconfig.save();\n+\t}\n+\t\n+\tprivate void performChange(Change change) {\n+\t\tswitch (change.type) {\n+\t\t\tcase OVERWRITE:\n+\t\t\t\tconfig.set(change.path, change.value);\n+\t\t\t\tbreak;\n+\t\t\tcase APPEND:\n+\t\t\t\tString base = config.getString(change.path);\n+\t\t\t\tconfig.set(change.path, base + change.value);\n+\t\t\t\tbreak;\n+\t\t\tcase TOWN_LEVEL_ADD:\n+\t\t\t\taddTownLevelProperty(change.key, change.value);\n+\t\t\t\tbreak;\n+\t\t\tcase NATION_LEVEL_ADD:\n+\t\t\t\taddNationLevelProperty(change.key, change.value);\n+\t\t\t\tbreak;\n+\t\t\tdefault:\n+\t\t\t\tthrow new UnsupportedOperationException(\"Unsupported Change type: \" + change);\n+\t\t}\n+\n+\t\tif (change.path != null) {\n+\t\t\t// Perform change.\n+\t\t\tSystem.out.println(\"Updating \" + change.path + \"...\");", "originalCommit": "788266fb3fb221562d48f2d47718116d5d50ef6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNzkxMw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460307913", "bodyText": "I think this class is small enough just to be a class inside ConfigMigrator.java", "author": "silverwolfg11", "createdAt": "2020-07-24T22:05:55Z", "path": "src/com/palmergames/bukkit/config/migration/Migration.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.palmergames.bukkit.config.migration;\n+\n+import com.palmergames.bukkit.util.Version;\n+\n+import java.util.List;\n+\n+/**\n+ * Represents a collection of changes.\n+ */\n+class Migration {", "originalCommit": "788266fb3fb221562d48f2d47718116d5d50ef6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwODA1Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460308052", "bodyText": "Use the logger here", "author": "silverwolfg11", "createdAt": "2020-07-24T22:06:37Z", "path": "src/com/palmergames/bukkit/towny/TownyUniverse.java", "diffHunk": "@@ -142,6 +144,16 @@ boolean loadSettings() {\n             return false;\n         }\n         \n+        Version lastRunVersion = new Version(TownySettings.getLastRunVersion(Towny.getPlugin().getVersion()));\n+        Version curVersion = new Version(Towny.getPlugin().getVersion());\n+        \n+        // Only migrate if the user just updated.\n+        if (!lastRunVersion.equals(curVersion)) {\n+\t\t\tSystem.out.println(\"[Towny] Performing Config Migrations...\");", "originalCommit": "788266fb3fb221562d48f2d47718116d5d50ef6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwOTI1Mg==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460309252", "bodyText": "I prefer not using the logger in teh startup sequence, because most of it doesn't and if some does use it, it jumps all over with different indentation.\nThe other one above can probably be a debug message, I glazed over that one.", "author": "LlmDl", "createdAt": "2020-07-24T22:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwODA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwOTI5Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460309293", "bodyText": "I think this has the possibility of being recursive since Object.equals() internally calls .equals(). At the least it's a useless call.", "author": "silverwolfg11", "createdAt": "2020-07-24T22:10:57Z", "path": "src/com/palmergames/bukkit/util/Version.java", "diffHunk": "@@ -35,14 +37,23 @@ public Version(String version) {\n \t\treturn 0;\n \t}\n \n-\t@Override public boolean equals(Object that) {\n-\t\tif(this == that)\n-\t\t\treturn true;\n-\t\tif(that == null)\n-\t\t\treturn false;\n-\t\tif(this.getClass() != that.getClass())\n-\t\t\treturn false;\n-\t\treturn this.compareTo((Version) that) == 0;\n+\t@Override\n+\tpublic boolean equals(Object o) {\n+\t\tif (this == o) return true;\n+\t\tif (!(o instanceof Version)) return false;\n+\t\tVersion version1 = (Version) o;\n+\t\treturn Objects.equals(version, version1.version);", "originalCommit": "788266fb3fb221562d48f2d47718116d5d50ef6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxOTA0Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460319043", "bodyText": "It's calling it on the field \u201cversion\u201d not the object itself.", "author": null, "createdAt": "2020-07-24T22:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwOTI5Mw=="}], "type": "inlineReview"}, {"oid": "61f855149a4ab9c2b62bde081ab46fbbe5464505", "url": "https://github.com/TownyAdvanced/Towny/commit/61f855149a4ab9c2b62bde081ab46fbbe5464505", "message": "Make requested changes.", "committedDate": "2020-07-24T22:53:13Z", "type": "commit"}, {"oid": "77874ac03d5e671acf0dddaa7c9a59c7a3ba2e29", "url": "https://github.com/TownyAdvanced/Towny/commit/77874ac03d5e671acf0dddaa7c9a59c7a3ba2e29", "message": "Merge remote-tracking branch 'origin/feature/config-migration' into feature/config-migration\n\n# Conflicts:\n#\tsrc/com/palmergames/bukkit/config/migration/ConfigMigrator.java", "committedDate": "2020-07-24T22:53:35Z", "type": "commit"}, {"oid": "17444d299f6bdfa125270c11dbddffc0d0537345", "url": "https://github.com/TownyAdvanced/Towny/commit/17444d299f6bdfa125270c11dbddffc0d0537345", "message": "Update and add messaging.", "committedDate": "2020-07-24T23:38:27Z", "type": "commit"}]}