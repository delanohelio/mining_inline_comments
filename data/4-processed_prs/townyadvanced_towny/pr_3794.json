{"pr_number": 3794, "pr_title": "Add Calculation Events", "pr_createdAt": "2020-03-18T19:07:47Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3794", "timeline": [{"oid": "b753b44c0a2cc42b170c84907ca622f055c67ca2", "url": "https://github.com/TownyAdvanced/Towny/commit/b753b44c0a2cc42b170c84907ca622f055c67ca2", "message": "Add Calculation Events", "committedDate": "2020-03-18T19:04:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyNTE2NA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3794#discussion_r394725164", "bodyText": "You're not using these variables outside the scope of the if-statement, so just put them in the if-statement.", "author": "silverwolfg11", "createdAt": "2020-03-19T00:44:02Z", "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -1911,26 +1918,34 @@ public static boolean isUpkeepPayingPlots() {\n \n \t\treturn getBoolean(ConfigNodes.ECO_UPKEEP_PLOTPAYMENTS);\n \t}\n-\t\n-    public static double getTownPenaltyUpkeepCost(Town town) {\n-    \t\n-    \tint claimed, allowedClaims, overClaimed;\n-    \t\n-\t    if (getUpkeepPenalty() > 0) {\n-\t    \t\n-\t    \tclaimed = town.getTownBlocks().size();\n-\t    \tallowedClaims = getMaxTownBlocks(town);\n-\t    \toverClaimed = claimed - allowedClaims;\n-\n-\t    \tif (!town.isOverClaimed())\n-\t    \t\treturn 0;\n-\t    \t\n-\t    \tif (isUpkeepPenaltyByPlot())\n-\t    \t\treturn getUpkeepPenalty() * overClaimed;\n-\t    \telse\n-\t    \t\treturn getUpkeepPenalty();\n-\t    } else return 0;\n-    }\n+\n+\tpublic static double getTownPenaltyUpkeepCost(Town town) {\n+\t\tTownUpkeepPenalityCalculationEvent event = new TownUpkeepPenalityCalculationEvent(town, getTownPenaltyUpkeepCostRaw(town));\n+\t\tBukkit.getPluginManager().callEvent(event);\n+\t\treturn event.getUpkeep();\n+\t}\n+\n+\tprivate static double getTownPenaltyUpkeepCostRaw(Town town) {\n+\n+\t\tint claimed;\n+\t\tint allowedClaims;\n+\t\tint overClaimed;", "originalCommit": "b753b44c0a2cc42b170c84907ca622f055c67ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyNTM3OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3794#discussion_r394725379", "bodyText": "Since that else is pretty much the last line, you can just remove it, and put return 0.", "author": "silverwolfg11", "createdAt": "2020-03-19T00:44:57Z", "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -1911,26 +1918,34 @@ public static boolean isUpkeepPayingPlots() {\n \n \t\treturn getBoolean(ConfigNodes.ECO_UPKEEP_PLOTPAYMENTS);\n \t}\n-\t\n-    public static double getTownPenaltyUpkeepCost(Town town) {\n-    \t\n-    \tint claimed, allowedClaims, overClaimed;\n-    \t\n-\t    if (getUpkeepPenalty() > 0) {\n-\t    \t\n-\t    \tclaimed = town.getTownBlocks().size();\n-\t    \tallowedClaims = getMaxTownBlocks(town);\n-\t    \toverClaimed = claimed - allowedClaims;\n-\n-\t    \tif (!town.isOverClaimed())\n-\t    \t\treturn 0;\n-\t    \t\n-\t    \tif (isUpkeepPenaltyByPlot())\n-\t    \t\treturn getUpkeepPenalty() * overClaimed;\n-\t    \telse\n-\t    \t\treturn getUpkeepPenalty();\n-\t    } else return 0;\n-    }\n+\n+\tpublic static double getTownPenaltyUpkeepCost(Town town) {\n+\t\tTownUpkeepPenalityCalculationEvent event = new TownUpkeepPenalityCalculationEvent(town, getTownPenaltyUpkeepCostRaw(town));\n+\t\tBukkit.getPluginManager().callEvent(event);\n+\t\treturn event.getUpkeep();\n+\t}\n+\n+\tprivate static double getTownPenaltyUpkeepCostRaw(Town town) {\n+\n+\t\tint claimed;\n+\t\tint allowedClaims;\n+\t\tint overClaimed;\n+\n+\t\tif (getUpkeepPenalty() > 0) {\n+\n+\t\t\tclaimed = town.getTownBlocks().size();\n+\t\t\tallowedClaims = getMaxTownBlocks(town);\n+\t\t\toverClaimed = claimed - allowedClaims;\n+\n+\t\t\tif (!town.isOverClaimed())\n+\t\t\t\treturn 0;\n+\n+\t\t\tif (isUpkeepPenaltyByPlot())\n+\t\t\t\treturn getUpkeepPenalty() * overClaimed;\n+\t\t\telse\n+\t\t\t\treturn getUpkeepPenalty();\n+\t\t} else return 0;", "originalCommit": "b753b44c0a2cc42b170c84907ca622f055c67ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyNTU1Mw==", "url": "https://github.com/TownyAdvanced/Towny/pull/3794#discussion_r394725553", "bodyText": "Can just initialize multiplier to 1.0 in the beginning to avoid this. Doesn't really make it less readable.", "author": "silverwolfg11", "createdAt": "2020-03-19T00:45:45Z", "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -1947,20 +1962,27 @@ public static double getNationUpkeep() {\n \t}\n \n \tpublic static double getNationUpkeepCost(Nation nation) {\n+\t\tNationUpkeepCalculationEvent event = new NationUpkeepCalculationEvent(nation, getNationUpkeepCostRaw(nation));\n+\t\tBukkit.getPluginManager().callEvent(event);\n+\t\treturn event.getUpkeep();\n+\t}\n+\n+\tprivate static double getNationUpkeepCostRaw(Nation nation) {\n \n \t\tdouble multiplier;\n \n \t\tif (nation != null) {\n \t\t\tif (isNationUpkeepPerTown()) {\n \t\t\t\tif (isNationLevelModifierAffectingNationUpkeepPerTown())\n-\t\t\t\t\treturn (getNationUpkeep() * nation.getTowns().size()) * Double.valueOf(getNationLevel(nation).get(TownySettings.NationLevel.UPKEEP_MULTIPLIER).toString());\n+\t\t\t\t\treturn (getNationUpkeep() * nation.getTowns().size()) * Double.parseDouble(getNationLevel(nation).get(TownySettings.NationLevel.UPKEEP_MULTIPLIER).toString());\n \t\t\t\telse\n \t\t\t\t\treturn (getNationUpkeep() * nation.getTowns().size());\n \t\t\t} else {\n-\t\t\t\tmultiplier = Double.valueOf(getNationLevel(nation).get(TownySettings.NationLevel.UPKEEP_MULTIPLIER).toString());\n+\t\t\t\tmultiplier = Double.parseDouble(getNationLevel(nation).get(TownySettings.NationLevel.UPKEEP_MULTIPLIER).toString());\n \t\t\t}\n-\t\t} else\n+\t\t} else {\n \t\t\tmultiplier = 1.0;", "originalCommit": "b753b44c0a2cc42b170c84907ca622f055c67ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyNTgyMA==", "url": "https://github.com/TownyAdvanced/Towny/pull/3794#discussion_r394725820", "bodyText": "Can just initialize multiplier to 1.0 to avoid the else statement.", "author": "silverwolfg11", "createdAt": "2020-03-19T00:46:40Z", "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -1839,52 +1843,55 @@ public static boolean isRemovingOnMonarchDeath() {\n \t\treturn getBoolean(ConfigNodes.WAR_EVENT_REMOVE_ON_MONARCH_DEATH);\n \t}\n \n-    public static double getTownUpkeepCost(Town town) {\n-    \t \n-        double multiplier;\n- \n-        if (town != null) {\n-            if (isUpkeepByPlot()) {\n-                multiplier = town.getTownBlocks().size(); // town.getTotalBlocks();\n-            } else {\n-                multiplier = Double.valueOf(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString());\n-            }\n-        } else\n-            multiplier = 1.0;\n- \n-        Double amount = 0.0;\n-        if (town.hasNation()) {\n-            double nationMultiplier = 1.0;\n-            try {\n-                nationMultiplier = Double.valueOf(getNationLevel(town.getNation()).get(TownySettings.NationLevel.NATION_TOWN_UPKEEP_MULTIPLIER).toString());\n-            } catch (NumberFormatException e) {\n-                e.printStackTrace();\n-            } catch (NotRegisteredException e) {\n-                e.printStackTrace();\n-            }\n-            if (isUpkeepByPlot()) {\n-            \tif (isTownLevelModifiersAffectingPlotBasedUpkeep())\n-            \t\tamount = (((getTownUpkeep() * multiplier) * Double.valueOf(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString())) * nationMultiplier);\n-            \telse\n-            \t\tamount = (getTownUpkeep() * multiplier) * nationMultiplier;\n-            \tif (TownySettings.getPlotBasedUpkeepMinimumAmount() > 0.0 && amount < TownySettings.getPlotBasedUpkeepMinimumAmount())\n-               \t\tamount = TownySettings.getPlotBasedUpkeepMinimumAmount();\n-                return amount;\n-            } else\n-                return (getTownUpkeep() * multiplier) * nationMultiplier;\n-        } else {\n-            if (isUpkeepByPlot()) {\n-            \tif (isTownLevelModifiersAffectingPlotBasedUpkeep())\n-            \t\tamount = (getTownUpkeep() * multiplier) * Double.valueOf(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString());\n-            \telse\n-            \t\tamount = getTownUpkeep() * multiplier;\n-                if (TownySettings.getPlotBasedUpkeepMinimumAmount() > 0.0 && amount < TownySettings.getPlotBasedUpkeepMinimumAmount())\n-               \t\tamount = TownySettings.getPlotBasedUpkeepMinimumAmount();\n-                return amount;\n-            } else\n-                return getTownUpkeep() * multiplier;\n-        }\n-    }\n+\tpublic static double getTownUpkeepCost(Town town) {\n+\t\tTownUpkeepCalculationEvent event = new TownUpkeepCalculationEvent(town,getTownUpkeepCostRaw(town));\n+\t\tBukkit.getPluginManager().callEvent(event);\n+\t\treturn event.getUpkeep();\n+\t}\n+\n+\tprivate static double getTownUpkeepCostRaw(Town town) {\n+\t\tdouble multiplier;\n+\n+\t\tif (town != null) {\n+\t\t\tif (isUpkeepByPlot()) {\n+\t\t\t\tmultiplier = town.getTownBlocks().size(); // town.getTotalBlocks();\n+\t\t\t} else {\n+\t\t\t\tmultiplier = Double.parseDouble(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString());\n+\t\t\t}\n+\t\t} else\n+\t\t\tmultiplier = 1.0;", "originalCommit": "b753b44c0a2cc42b170c84907ca622f055c67ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyNjQ2MQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3794#discussion_r394726461", "bodyText": "This variable is assigned within specific scopes and not used outside of them, so it's best to initialize it within the appropriate scopes instead of here.", "author": "silverwolfg11", "createdAt": "2020-03-19T00:49:14Z", "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -1839,52 +1843,55 @@ public static boolean isRemovingOnMonarchDeath() {\n \t\treturn getBoolean(ConfigNodes.WAR_EVENT_REMOVE_ON_MONARCH_DEATH);\n \t}\n \n-    public static double getTownUpkeepCost(Town town) {\n-    \t \n-        double multiplier;\n- \n-        if (town != null) {\n-            if (isUpkeepByPlot()) {\n-                multiplier = town.getTownBlocks().size(); // town.getTotalBlocks();\n-            } else {\n-                multiplier = Double.valueOf(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString());\n-            }\n-        } else\n-            multiplier = 1.0;\n- \n-        Double amount = 0.0;\n-        if (town.hasNation()) {\n-            double nationMultiplier = 1.0;\n-            try {\n-                nationMultiplier = Double.valueOf(getNationLevel(town.getNation()).get(TownySettings.NationLevel.NATION_TOWN_UPKEEP_MULTIPLIER).toString());\n-            } catch (NumberFormatException e) {\n-                e.printStackTrace();\n-            } catch (NotRegisteredException e) {\n-                e.printStackTrace();\n-            }\n-            if (isUpkeepByPlot()) {\n-            \tif (isTownLevelModifiersAffectingPlotBasedUpkeep())\n-            \t\tamount = (((getTownUpkeep() * multiplier) * Double.valueOf(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString())) * nationMultiplier);\n-            \telse\n-            \t\tamount = (getTownUpkeep() * multiplier) * nationMultiplier;\n-            \tif (TownySettings.getPlotBasedUpkeepMinimumAmount() > 0.0 && amount < TownySettings.getPlotBasedUpkeepMinimumAmount())\n-               \t\tamount = TownySettings.getPlotBasedUpkeepMinimumAmount();\n-                return amount;\n-            } else\n-                return (getTownUpkeep() * multiplier) * nationMultiplier;\n-        } else {\n-            if (isUpkeepByPlot()) {\n-            \tif (isTownLevelModifiersAffectingPlotBasedUpkeep())\n-            \t\tamount = (getTownUpkeep() * multiplier) * Double.valueOf(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString());\n-            \telse\n-            \t\tamount = getTownUpkeep() * multiplier;\n-                if (TownySettings.getPlotBasedUpkeepMinimumAmount() > 0.0 && amount < TownySettings.getPlotBasedUpkeepMinimumAmount())\n-               \t\tamount = TownySettings.getPlotBasedUpkeepMinimumAmount();\n-                return amount;\n-            } else\n-                return getTownUpkeep() * multiplier;\n-        }\n-    }\n+\tpublic static double getTownUpkeepCost(Town town) {\n+\t\tTownUpkeepCalculationEvent event = new TownUpkeepCalculationEvent(town,getTownUpkeepCostRaw(town));\n+\t\tBukkit.getPluginManager().callEvent(event);\n+\t\treturn event.getUpkeep();\n+\t}\n+\n+\tprivate static double getTownUpkeepCostRaw(Town town) {\n+\t\tdouble multiplier;\n+\n+\t\tif (town != null) {\n+\t\t\tif (isUpkeepByPlot()) {\n+\t\t\t\tmultiplier = town.getTownBlocks().size(); // town.getTotalBlocks();\n+\t\t\t} else {\n+\t\t\t\tmultiplier = Double.parseDouble(getTownLevel(town).get(TownySettings.TownLevel.UPKEEP_MULTIPLIER).toString());\n+\t\t\t}\n+\t\t} else\n+\t\t\tmultiplier = 1.0;\n+\n+\t\tdouble amount;", "originalCommit": "b753b44c0a2cc42b170c84907ca622f055c67ca2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8468941e18f23b6f648ba6a2921a8019f96803d", "url": "https://github.com/TownyAdvanced/Towny/commit/c8468941e18f23b6f648ba6a2921a8019f96803d", "message": "Code quality improvements", "committedDate": "2020-03-19T01:20:18Z", "type": "commit"}]}