{"pr_number": 3739, "pr_title": "Trie optimization", "pr_createdAt": "2020-03-03T01:00:07Z", "pr_url": "https://github.com/TownyAdvanced/Towny/pull/3739", "timeline": [{"oid": "dc87eb6ccf42d0aa8bfd409138fd0534b0972d5d", "url": "https://github.com/TownyAdvanced/Towny/commit/dc87eb6ccf42d0aa8bfd409138fd0534b0972d5d", "message": "Optimized Trie by removing optionals and streams", "committedDate": "2020-03-03T00:25:40Z", "type": "commit"}, {"oid": "d37bdf7db59a14977dce386f7f1256a5237b84f1", "url": "https://github.com/TownyAdvanced/Towny/commit/d37bdf7db59a14977dce386f7f1256a5237b84f1", "message": "Remove test code, fix removeKey", "committedDate": "2020-03-03T00:57:06Z", "type": "commit"}, {"oid": "65385afd996d213ec4502a081511cc8b53a7aaea", "url": "https://github.com/TownyAdvanced/Towny/commit/65385afd996d213ec4502a081511cc8b53a7aaea", "message": "whitespace, unused commits", "committedDate": "2020-03-03T00:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4MjQ0MQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3739#discussion_r387182441", "bodyText": "You could probably store entry.getValue() + node.character in a variable to prevent having to call newNodes.get() in the code below.", "author": "silverwolfg11", "createdAt": "2020-03-03T17:36:39Z", "path": "src/com/palmergames/util/Trie.java", "diffHunk": "@@ -144,17 +132,21 @@ public boolean removeKey(String key) {\n \t\tnodes.put(root, \"\"); // Start with the root node\n \n \t\tfor (int i = 0; i < key.length(); i++) {\n-\t\t\tint finalI = i;\n \t\t\tMap<TrieNode, String> newNodes = new HashMap<>(); // An updated version of nodes, will not contain the old values\n+\t\t\tchar index = Character.toLowerCase(key.charAt(i));\n+\n \t\t\tfor (Map.Entry<TrieNode, String> entry : nodes.entrySet()) { // Loop through the old nodes\n-\t\t\t\tList<TrieNode> list = entry.getKey().children.stream()\n-\t\t\t\t\t.filter(e -> Character.toLowerCase(e.character) == Character.toLowerCase(key.charAt(finalI))).collect(Collectors.toList()); // Find matches for lower and upper case\n-\n-\t\t\t\tfor (TrieNode listNode : list) { // Loop through all matches, could be a list of 1 or 2 - for example if we looked for \"e\" and the node had children \"e\" and \"E\" the list would have 2 values\n-\t\t\t\t\tnewNodes.put(listNode, entry.getValue()+listNode.character); // entry.getValue is the old key for the node, for example \"bana\" as entry.getValue() and \"n\" as listNode.character resulting in \"banan\" for listNode\n-\t\t\t\t\tif (i == key.length() - 1) { // Check if this is the last character of the key, indicating a word ending. From here we need to find all the possible children\n-\t\t\t\t\t\tfor (String string : getChildrenStrings(listNode, new ArrayList<>())) { // Recursively find all children\n-\t\t\t\t\t\t\tstrings.add(newNodes.get(listNode) + string); // Add the key to the front of each child string\n+\n+\t\t\t\tfor (TrieNode node : entry.getKey().children) {\n+\n+\t\t\t\t\tif (Character.toLowerCase(node.character) == index) {\n+\t\t\t\t\t\tnewNodes.put(node, entry.getValue()+node.character); // entry.getValue is the old key for the node, for example \"bana\" as entry.getValue() and \"n\" as listNode.character resulting in \"banan\" for listNode", "originalCommit": "65385afd996d213ec4502a081511cc8b53a7aaea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MzI5OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3739#discussion_r387373299", "bodyText": "Changed, thanks for the catch", "author": "stzups", "createdAt": "2020-03-04T00:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4MjQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4Mzg5OQ==", "url": "https://github.com/TownyAdvanced/Towny/pull/3739#discussion_r387183899", "bodyText": "I am against using labels where preventable because of readability. I believe this label can be avoided by setting trieNode to null before the for loop and then if it is null after the loop then you can create the new TrieNode and add it to the last node.", "author": "silverwolfg11", "createdAt": "2020-03-03T17:39:29Z", "path": "src/com/palmergames/util/Trie.java", "diffHunk": "@@ -45,85 +43,75 @@ public Trie() {\n \t * Adds and links new TrieNodes to the trie for each character in the string\n \t * \n \t * @param key key to add to trie, can be longer than one character\n-\t * @return true if the key was added properly, otherwise false \n \t */\n-\tpublic boolean addKey(String key) {\n+\tpublic void addKey(String key) {\n \t\t// Current trieNode to crawl through\n \t\tTrieNode trieNode = root;\n \n \t\t// Loop through each character of key\n+\t\touter:\n \t\tfor (int i = 0; i < key.length(); i++) {\n \t\t\tchar index = key.charAt(i);\n \n \t\t\tTrieNode lastNode = trieNode;\n-\t\t\tOptional<TrieNode> optional = lastNode.children.stream()\n-\t\t\t\t        .filter(e -> e.character == index).findFirst();\n-\n-\t\t\tif (!optional.isPresent()) { // No existing TrieNode here, so make a new one\n-\t\t\t\ttrieNode = new TrieNode(index);\n-\t\t\t\tlastNode.children.add(trieNode); // Put this node as one of lastNode's children\n-\t\t\t} else {\n-\t\t\t\ttrieNode = optional.get();\n+\t\t\tfor (TrieNode node : lastNode.children) {\n+\t\t\t\tif (node.character == index) {\n+\t\t\t\t\ttrieNode = node;\n+\t\t\t\t\tcontinue outer;", "originalCommit": "65385afd996d213ec4502a081511cc8b53a7aaea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3MzIyMg==", "url": "https://github.com/TownyAdvanced/Towny/pull/3739#discussion_r387373222", "bodyText": "Changed, performance remains unaffected", "author": "stzups", "createdAt": "2020-03-04T00:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4Mzg5OQ=="}], "type": "inlineReview"}, {"oid": "785f5aaf4a18492a4ead00000fc4baae1ca2039f", "url": "https://github.com/TownyAdvanced/Towny/commit/785f5aaf4a18492a4ead00000fc4baae1ca2039f", "message": "Removed unnecessary newNodes.get()", "committedDate": "2020-03-04T00:20:01Z", "type": "commit"}, {"oid": "0012ac33469cf70085d9199936670c8a8cb51a56", "url": "https://github.com/TownyAdvanced/Towny/commit/0012ac33469cf70085d9199936670c8a8cb51a56", "message": "Removed labels for readability, performance is unaffected", "committedDate": "2020-03-04T00:20:54Z", "type": "commit"}]}