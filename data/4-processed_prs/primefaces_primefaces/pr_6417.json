{"pr_number": 6417, "pr_title": "#6355: DatePicker: merged Ajax requests", "pr_createdAt": "2020-10-17T09:58:18Z", "pr_url": "https://github.com/primefaces/primefaces/pull/6417", "timeline": [{"oid": "334d1b3a44eaaed2eeee06cbe4f15dbdc3c858a4", "url": "https://github.com/primefaces/primefaces/commit/334d1b3a44eaaed2eeee06cbe4f15dbdc3c858a4", "message": "DatePicker merged Ajax requests", "committedDate": "2020-10-17T09:48:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzODkwMw==", "url": "https://github.com/primefaces/primefaces/pull/6417#discussion_r506938903", "bodyText": "I think it might be becaue you are missing:\nsource: _self.id,\n                    process: _self.id,\n                    update: _self.id,\n                    formId: _self.cfg.formId,", "author": "melloware", "createdAt": "2020-10-17T12:34:39Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/1-datepicker.js", "diffHunk": "@@ -278,64 +278,58 @@ PrimeFaces.widget.DatePicker = PrimeFaces.widget.BaseWidget.extend({\n         var _self = this;\n         this.cfg.onViewDateChange = function(event, date) {\n             _self.viewDateOption = date;\n-\n-            if(_self.hasBehavior('viewChange')) {\n-                _self.fireViewChangeEvent(date.getFullYear(), date.getMonth());\n-            }\n-            if (_self.cfg.lazyModel) {\n-                var options = {\n-                    source: _self.id,\n-                    process: _self.id,\n-                    update: _self.id,\n-                    formId: _self.cfg.formId,\n-                    params: [\n-                        {name: _self.id + '_year', value: date.getFullYear()},\n-                        {name: _self.id + '_month', value: date.getMonth()}\n-                    ],\n-                    onsuccess: function(responseXML, status, xhr) {\n-                        PrimeFaces.ajax.Response.handle(responseXML, status, xhr, {\n-                            widget: _self,\n-                            handle: function(content) {\n-                                var dateMetadata = JSON.parse(content).dateMetadata;\n-                                var disabledDates = [];\n-                                for (date in dateMetadata) {\n-                                    if (dateMetadata[date].disabled) {\n-                                        disabledDates.push(date);\n-                                    }\n-                                }\n-                                _self.setDisabledDates(disabledDates);\n-                            }\n-                        });\n-\n-                        return true;\n-                    }\n-                };\n-                PrimeFaces.ajax.Request.handle(options);\n-            }\n+            _self.fireViewChangeEvent(date);\n         };\n     },\n \n     /**\n      * Triggers the event for when the date picker changed to a different month or year page.\n      * @private\n-     * @param {number} year The year to which the date picker changed.\n-     * @param {number} month The year to which the date picker changed, starting with `0` for `Janurary`.\n+     * @param {Date} date The date to which the date picker changed.\n      */\n-    fireViewChangeEvent: function(year, month) {\n-        if(this.cfg.behaviors) {\n+    fireViewChangeEvent: function(date) {\n+        var _self = this, fired = false;\n+        var options = {\n+            params: [\n+                {name: this.id + '_year', value: date.getFullYear()},\n+                {name: this.id + '_month', value: date.getMonth()}\n+            ]", "originalCommit": "334d1b3a44eaaed2eeee06cbe4f15dbdc3c858a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk0MTUxNw==", "url": "https://github.com/primefaces/primefaces/pull/6417#discussion_r506941517", "bodyText": "Yes, update did the job!", "author": "jepsar", "createdAt": "2020-10-17T13:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzODkwMw=="}], "type": "inlineReview"}, {"oid": "d7e8544f340f4399b0a879f1c486a22496408e11", "url": "https://github.com/primefaces/primefaces/commit/d7e8544f340f4399b0a879f1c486a22496408e11", "message": "Added update on viewChange handler", "committedDate": "2020-10-17T13:04:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk0MzQxNw==", "url": "https://github.com/primefaces/primefaces/pull/6417#discussion_r506943417", "bodyText": "Not sure if you need to add process too?", "author": "melloware", "createdAt": "2020-10-17T13:29:00Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/1-datepicker.js", "diffHunk": "@@ -318,6 +318,7 @@ PrimeFaces.widget.DatePicker = PrimeFaces.widget.BaseWidget.extend({\n             var viewChangeBehavior = this.cfg.behaviors['viewChange'];\n \n             if(viewChangeBehavior) {\n+                options.update = (options.update||'') +' '+ this.id;", "originalCommit": "d7e8544f340f4399b0a879f1c486a22496408e11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2MjkwMg==", "url": "https://github.com/primefaces/primefaces/pull/6417#discussion_r506962902", "bodyText": "I'm not sure. Did some minor improvements and tested with the showcase PR I submitted (I've added events) and it's all working for me.", "author": "jepsar", "createdAt": "2020-10-17T17:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk0MzQxNw=="}], "type": "inlineReview"}, {"oid": "797f878c89dfc0d7be534e0747ca97a4f35968a0", "url": "https://github.com/primefaces/primefaces/commit/797f878c89dfc0d7be534e0747ca97a4f35968a0", "message": "Improved viewChange handler", "committedDate": "2020-10-17T16:56:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2MzM4Ng==", "url": "https://github.com/primefaces/primefaces/pull/6417#discussion_r506963386", "bodyText": "Please add spaces before/after || and +", "author": "tandraschko", "createdAt": "2020-10-17T17:08:45Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/1-datepicker.js", "diffHunk": "@@ -278,63 +278,55 @@ PrimeFaces.widget.DatePicker = PrimeFaces.widget.BaseWidget.extend({\n         var _self = this;\n         this.cfg.onViewDateChange = function(event, date) {\n             _self.viewDateOption = date;\n-\n-            if(_self.hasBehavior('viewChange')) {\n-                _self.fireViewChangeEvent(date.getFullYear(), date.getMonth());\n-            }\n-            if (_self.cfg.lazyModel) {\n-                var options = {\n-                    source: _self.id,\n-                    process: _self.id,\n-                    update: _self.id,\n-                    formId: _self.cfg.formId,\n-                    params: [\n-                        {name: _self.id + '_year', value: date.getFullYear()},\n-                        {name: _self.id + '_month', value: date.getMonth()}\n-                    ],\n-                    onsuccess: function(responseXML, status, xhr) {\n-                        PrimeFaces.ajax.Response.handle(responseXML, status, xhr, {\n-                            widget: _self,\n-                            handle: function(content) {\n-                                var dateMetadata = JSON.parse(content).dateMetadata;\n-                                var disabledDates = [];\n-                                for (date in dateMetadata) {\n-                                    if (dateMetadata[date].disabled) {\n-                                        disabledDates.push(date);\n-                                    }\n-                                }\n-                                _self.setDisabledDates(disabledDates);\n-                            }\n-                        });\n-\n-                        return true;\n-                    }\n-                };\n-                PrimeFaces.ajax.Request.handle(options);\n-            }\n+            _self.fireViewChangeEvent(date);\n         };\n     },\n \n     /**\n      * Triggers the event for when the date picker changed to a different month or year page.\n      * @private\n-     * @param {number} year The year to which the date picker changed.\n-     * @param {number} month The year to which the date picker changed, starting with `0` for `Janurary`.\n+     * @param {Date} date The date to which the date picker changed.\n      */\n-    fireViewChangeEvent: function(year, month) {\n-        if(this.cfg.behaviors) {\n-            var viewChangeBehavior = this.cfg.behaviors['viewChange'];\n-\n-            if(viewChangeBehavior) {\n-                var ext = {\n-                        params: [\n-                            {name: this.id + '_month', value: month},\n-                            {name: this.id + '_year', value: year}\n-                        ]\n-                };\n+    fireViewChangeEvent: function(date) {\n+        var _self = this;\n+        var lazy = this.cfg.lazyModel;\n+        var options = {\n+            params: [\n+                {name: this.id + '_year', value: date.getFullYear()},\n+                {name: this.id + '_month', value: date.getMonth()}\n+            ]\n+        }\n+        if (lazy) {\n+            options.onsuccess = function(responseXML, status, xhr) {\n+                PrimeFaces.ajax.Response.handle(responseXML, status, xhr, {\n+                    widget: _self,\n+                    handle: function(content) {\n+                        var dateMetadata = JSON.parse(content).dateMetadata;\n+                        var disabledDates = [];\n+                        for (date in dateMetadata) {\n+                            if (dateMetadata[date].disabled) {\n+                                disabledDates.push(date);\n+                            }\n+                        }\n+                        _self.setDisabledDates(disabledDates);\n+                    }\n+                });\n+                return true;\n+            };\n+        }\n \n-                viewChangeBehavior.call(this, ext);\n+        if (this.hasBehavior('viewChange')) {\n+            if (lazy) {\n+                options.update = (options.update||'') +' '+ this.id;", "originalCommit": "797f878c89dfc0d7be534e0747ca97a4f35968a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2MzUwNg==", "url": "https://github.com/primefaces/primefaces/pull/6417#discussion_r506963506", "bodyText": "isRequestSource && eventName == viewChange && lazy=true\nthen you also dont need to the _year+_month null check next", "author": "tandraschko", "createdAt": "2020-10-17T17:10:00Z", "path": "src/main/java/org/primefaces/component/datepicker/DatePickerRenderer.java", "diffHunk": "@@ -41,21 +41,25 @@\n import org.primefaces.component.calendar.BaseCalendarRenderer;\n import org.primefaces.expression.SearchExpressionFacade;\n import org.primefaces.expression.SearchExpressionUtils;\n+import org.primefaces.model.datepicker.DateMetadata;\n+import org.primefaces.model.datepicker.DateMetadataModel;\n import org.primefaces.model.datepicker.LazyDateMetadataModel;\n import org.primefaces.util.CalendarUtils;\n import org.primefaces.util.ComponentUtils;\n import org.primefaces.util.WidgetBuilder;\n-import org.primefaces.model.datepicker.DateMetadata;\n-import org.primefaces.model.datepicker.DateMetadataModel;\n \n public class DatePickerRenderer extends BaseCalendarRenderer {\n \n     @Override\n     public void encodeEnd(FacesContext context, UIComponent component) throws IOException {\n         DatePicker datePicker = (DatePicker) component;\n \n-        if (context.getExternalContext().getRequestParameterMap().containsKey(datePicker.getClientId(context))) {\n-            encodeDateMetadata(context, datePicker);\n+        if (ComponentUtils.isRequestSource(datePicker, context)) {", "originalCommit": "797f878c89dfc0d7be534e0747ca97a4f35968a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "650a8b2688e9c4d5de50eaffc22c3c99944656c4", "url": "https://github.com/primefaces/primefaces/commit/650a8b2688e9c4d5de50eaffc22c3c99944656c4", "message": "Remarks Thomas", "committedDate": "2020-10-17T17:33:32Z", "type": "commit"}, {"oid": "51ffaa871d6971f05dbdf0ced721567afe481720", "url": "https://github.com/primefaces/primefaces/commit/51ffaa871d6971f05dbdf0ced721567afe481720", "message": "Performance", "committedDate": "2020-10-17T17:42:51Z", "type": "commit"}, {"oid": "2d97e8096eea26c7306815d4777acb8b0b7e4674", "url": "https://github.com/primefaces/primefaces/commit/2d97e8096eea26c7306815d4777acb8b0b7e4674", "message": "Only encode metadata for lazy model", "committedDate": "2020-10-17T17:54:51Z", "type": "commit"}, {"oid": "aa3bd78da5e356abe55fa85e44e06f10bf238edb", "url": "https://github.com/primefaces/primefaces/commit/aa3bd78da5e356abe55fa85e44e06f10bf238edb", "message": "super.encodeEnd for other events", "committedDate": "2020-10-17T21:01:54Z", "type": "commit"}]}