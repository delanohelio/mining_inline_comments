{"pr_number": 6009, "pr_title": "Fix #2223 and #6008: PhotoCam error handling improvements and device selection", "pr_createdAt": "2020-06-08T06:31:51Z", "pr_url": "https://github.com/primefaces/primefaces/pull/6009", "timeline": [{"oid": "cbc79812adfae8897d80486ac4c1213d55fb62ea", "url": "https://github.com/primefaces/primefaces/commit/cbc79812adfae8897d80486ac4c1213d55fb62ea", "message": "+ video input device list & seletion AND custom error handling", "committedDate": "2020-06-08T04:19:34Z", "type": "commit"}, {"oid": "d80a4c731d2478c242543fce5646026f2006f2a7", "url": "https://github.com/primefaces/primefaces/commit/d80a4c731d2478c242543fce5646026f2006f2a7", "message": "added Doc for onCameraError", "committedDate": "2020-06-08T06:46:11Z", "type": "commit"}, {"oid": "37a508940ca5b14b49a0db53f79eaaf52ff1da7f", "url": "https://github.com/primefaces/primefaces/commit/37a508940ca5b14b49a0db53f79eaaf52ff1da7f", "message": "doc errorObj onCameraError param", "committedDate": "2020-06-08T06:58:30Z", "type": "commit"}, {"oid": "26bb1893038c60f8bde1fafc485e160db61439b1", "url": "https://github.com/primefaces/primefaces/commit/26bb1893038c60f8bde1fafc485e160db61439b1", "message": "onCameraError errorObj param decription", "committedDate": "2020-06-08T07:09:51Z", "type": "commit"}, {"oid": "ee620c9bafa0a916daafc303d8d030d00bb92cc2", "url": "https://github.com/primefaces/primefaces/commit/ee620c9bafa0a916daafc303d8d030d00bb92cc2", "message": "avoiding namespace absence in Webcam.Error errorObj doc", "committedDate": "2020-06-08T07:20:55Z", "type": "commit"}, {"oid": "67d8e0c2e595cff094bab832c90d9c1889ad3423", "url": "https://github.com/primefaces/primefaces/commit/67d8e0c2e595cff094bab832c90d9c1889ad3423", "message": "fix param type on ts doc", "committedDate": "2020-06-08T07:36:21Z", "type": "commit"}, {"oid": "dc72f94bb7c9b250a33f45219cc1ed8fdf0202d9", "url": "https://github.com/primefaces/primefaces/commit/dc72f94bb7c9b250a33f45219cc1ed8fdf0202d9", "message": "fixing jsdoc type", "committedDate": "2020-06-08T07:49:20Z", "type": "commit"}, {"oid": "e2f3f4a57d4b94d51f460d83dba4c1d038294523", "url": "https://github.com/primefaces/primefaces/commit/e2f3f4a57d4b94d51f460d83dba4c1d038294523", "message": "fix errorObj declaration", "committedDate": "2020-06-08T07:59:17Z", "type": "commit"}, {"oid": "c4ef887956de92bd62a3336585942fd4a5581b67", "url": "https://github.com/primefaces/primefaces/commit/c4ef887956de92bd62a3336585942fd4a5581b67", "message": "case of doc parameter description", "committedDate": "2020-06-08T08:09:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyOTY5Nw==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436629697", "bodyText": "Suggests a video input devices such as 'user' (aka font camera) or 'environment' (aka rear camera).", "author": "melloware", "createdAt": "2020-06-08T11:33:45Z", "path": "docs/9_0/components/photocam.md", "diffHunk": "@@ -44,6 +44,8 @@ photoHeight | 240 | Integer | Height of the captured photo, defaults to height.\n format | jpeg | Boolean | Format of the image, valid values are \"jpeg\" default and png.\n jpegQuality | 90 | Integer | Quality of the image between 0 and 100 when the format is jpeg, default value is 90.\n forceFlash | false | Boolean | Enables always using flash fallback even in an HTML5 environment.\n+device | false | String | Suggests a video input device.", "originalCommit": "c4ef887956de92bd62a3336585942fd4a5581b67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyMzE4Nw==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436923187", "bodyText": "fixed!", "author": "doleron", "createdAt": "2020-06-08T18:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyOTY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyOTgwOA==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436629808", "bodyText": "Suggests a video input devices such as 'user' (aka font camera) or 'environment' (aka rear camera).", "author": "melloware", "createdAt": "2020-06-08T11:34:01Z", "path": "src/main/resources/META-INF/primefaces-p.taglib.xml", "diffHunk": "@@ -18720,6 +18720,22 @@\n             <required>false</required>\n             <type>java.lang.Boolean</type>\n         </attribute>\n+        <attribute>\n+            <description>\n+                <![CDATA[An device to grab images]]>", "originalCommit": "c4ef887956de92bd62a3336585942fd4a5581b67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzMDU1OA==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436630558", "bodyText": "Client side callback executed if the camera has an error.", "author": "melloware", "createdAt": "2020-06-08T11:35:35Z", "path": "src/main/resources/META-INF/primefaces-p.taglib.xml", "diffHunk": "@@ -18720,6 +18720,22 @@\n             <required>false</required>\n             <type>java.lang.Boolean</type>\n         </attribute>\n+        <attribute>\n+            <description>\n+                <![CDATA[An device to grab images]]>\n+            </description>\n+            <name>device</name>\n+            <required>false</required>\n+            <type>java.lang.String</type>\n+        </attribute>\n+        <attribute>\n+            <description>\n+                <![CDATA[Webcam engine error fallback]]>", "originalCommit": "c4ef887956de92bd62a3336585942fd4a5581b67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b07dc4d956f8c718e1a6407561fab46f07650a5c", "url": "https://github.com/primefaces/primefaces/commit/b07dc4d956f8c718e1a6407561fab46f07650a5c", "message": "fix docs reviews pending", "committedDate": "2020-06-08T16:11:29Z", "type": "commit"}, {"oid": "bcbc355c331fa0e55da9836b0702d4f390696427", "url": "https://github.com/primefaces/primefaces/commit/bcbc355c331fa0e55da9836b0702d4f390696427", "message": "fixing case of reload function doc description", "committedDate": "2020-06-08T18:15:44Z", "type": "commit"}, {"oid": "87fa8a95e30e8ce537ef197db1b3b2d72e1a50ee", "url": "https://github.com/primefaces/primefaces/commit/87fa8a95e30e8ce537ef197db1b3b2d72e1a50ee", "message": "added Browser Compatibility section to docs", "committedDate": "2020-06-08T18:41:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxOTY2OQ==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436919669", "bodyText": "PhotoCam does not support Microsoft Internet Explorer 11 or below. Other legacy browsers are also not likely to be functional.", "author": "melloware", "createdAt": "2020-06-08T18:48:44Z", "path": "docs/9_0/components/photocam.md", "diffHunk": "@@ -73,4 +75,65 @@ public class PhotoCamBean {\n         }\n     }\n }\n-```\n\\ No newline at end of file\n+```\n+\n+## Video input device ids\n+\n+The tag attribute `device` allows the suggestion of a device to be used by the internal camera engine to retrieve images. If it is `null` (default)\n+the client-side operational system & browser will choose the preferred device to use with. Usually, in mobile devices the value `\"user\"`\n+will be resolved as the front camera and `\"environment\"` will be resolved as the rear camera.\n+\n+A specific device can be also addressed. For this purpose, the PhotoCam widget is shipped with an attribute `devices` filled with browser native \n+`InputDeviceInfo` objects which can provide the required `deviceId` hash. The code below shows how to extract this information to populate a HTML select dropdown:\n+\n+```javascript\n+    window.setTimeout(function() {\n+\t    var photoCam = PF('photoCam');\n+\t    var devices = photoCam.devices;\n+\t    if (devices) {\n+\t        var deviceSelector = document.querySelector(\"select\");\n+\t        devices.forEach(device => {\n+\t            if (device.deviceId) {\n+\t                var option = document.createElement(\"option\");\n+\t                if (device.label) {\n+\t                    option.text = device.label;\n+\t                } else {\n+\t                    option.text = \"unamed device\";\n+\t                }\n+\t                option.value = device.deviceId;\n+\t                deviceSelector.appendChild(option);\n+\t            }\n+\t        });\n+\t    } else {\n+\t        console.log(\"no devices found\");\n+\t    }\n+\t}, 500);\n+\n+```\n+\n+It turns out that even browsers in regular or fast PCs may be a bit lazy to fill up the `InputDeviceInfo` collection data into the `devices` widget attribute.\n+Thus, it is a good idea to wait some mills before consume these objects, for example, using the `window.setTimeout` idiom as shown above.\n+\n+## Error handling\n+\n+The default error handling is a browser native alert() popup prompting the user about some low level / browser / device undesired event.\n+Lucky, `onCameraError` fallback can be defined to indicate a custom handler to deal with these errors. For instance:\n+\n+```javascript\n+    function myCustomErrorHandler(errorObj) {\n+        console.log(\"error\", errorObj);\n+    }\n+```\n+```xhtml\n+    <p:photoCam widgetVar=\"photoCam\" onCameraError=\"myCustomErrorHandler(errorObj);\"/>\n+```\n+will swept to console any error thrown by the PhotoCam underlying engine.\n+\n+## Browser Compatibility \n+\n+This component is strongly dependent of browser / operational system faculties and constraints. Some of known restrictions are listed below:\n+\n+- Navigators like Google Chrome (version 47 and later) require secure origins (HTTPS or LOCALHOST) to activate media devices functionality. Thus, unless you are accessing the page from LOCALHOST, PhotoCam is likely to do not work in a plain HTTP call. More details can be found here: https://developers.google.com/web/updates/2015/10/chrome-47-webrtc\n+- Third-party browsers on iOS devices (Iphone, Ipad, etc) do not have same access to media devices as the Apple native browser Safari. Thus, on an iOS device, PhotoCam should works fine on Safari but not on Chrome or Firefox (or other no-Safari navigators). See http://www.openradar.me/33571214 for any updates on this. Note that this restriction is applied only for iOS devices. In general, third-party browsers running on OSx systems (mackbooks, iMacs and so on) don't have this same restriction.\n+- PhotoCam does not support Microsoft Internet Explorer 11 or below. Other eldery browsers are likely to do not work as well.", "originalCommit": "87fa8a95e30e8ce537ef197db1b3b2d72e1a50ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyMzM3MA==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436923370", "bodyText": "Done!", "author": "doleron", "createdAt": "2020-06-08T18:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxOTY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNTMzNA==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436925334", "bodyText": "Just this one last wording change above...", "author": "melloware", "createdAt": "2020-06-08T18:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxOTY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0NTUxMg==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r436945512", "bodyText": "Ops! Fixed in last commit.", "author": "doleron", "createdAt": "2020-06-08T19:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxOTY2OQ=="}], "type": "inlineReview"}, {"oid": "bacfb6890dc199ffcc3e4073f33e7efd9b89ec66", "url": "https://github.com/primefaces/primefaces/commit/bacfb6890dc199ffcc3e4073f33e7efd9b89ec66", "message": "Microsoft Internet Explorer 11 support text rewriting", "committedDate": "2020-06-08T19:08:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MjE1Mw==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r437492153", "bodyText": "Just a quick note regarding the types: As far as I can tell from the name and how it's used, the type of errorObj should probably be Error instead of () => void. Cross-checking with the source code of PhotoCam, WebcamError and FlashError inherit from the builtin Error class.\nAlso, you can use @private to mark a method as private. Since this is an internally used callback, it qualifies in my opinion.", "author": "blutorange", "createdAt": "2020-06-09T15:00:30Z", "path": "src/main/resources/META-INF/resources/primefaces/photocam/photocam.js", "diffHunk": "@@ -1137,11 +1158,31 @@ PrimeFaces.widget.PhotoCam = PrimeFaces.widget.BaseWidget.extend({\n                     PrimeFaces.ajax.Request.handle(options);\n                 }\n             });\n+            \n+            $this = this;\n+            Webcam.on(\"error\", this.onCameraError);\n \n             Webcam.attach(this.id);\n             this.attached = true;\n         }\n     },\n+    \n+    /**\n+     * Default error handler for webcam events\n+     * @param {() => void} errorObj Error object containing message, stacktrace and so on.", "originalCommit": "bacfb6890dc199ffcc3e4073f33e7efd9b89ec66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9eaaab46171bc186e40fcdd218ca6cc4b338717f", "url": "https://github.com/primefaces/primefaces/commit/9eaaab46171bc186e40fcdd218ca6cc4b338717f", "message": "rewriting devices attrb as getAvailableDevices function", "committedDate": "2020-06-09T17:17:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2MzEyNw==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r437663127", "bodyText": "Lambdas are nice and easier to write, but unfortunately not supported by all target browsers yet, and not used anywhere else in the codebase afaik. Can you change that to function(devices) { ... }", "author": "blutorange", "createdAt": "2020-06-09T19:21:10Z", "path": "src/main/resources/META-INF/resources/primefaces/photocam/photocam.js", "diffHunk": "@@ -1163,6 +1202,33 @@ PrimeFaces.widget.PhotoCam = PrimeFaces.widget.BaseWidget.extend({\n         } else {\n             PrimeFaces.error('Capture error: AdvancedPhotoCam not attached to the camera');\n         }\n+    },\n+    \n+    /**\n+     *  Retrieves the available video input device list \n+     *  @return {Promise<InputDeviceInfo[]>} Returns a promise to resolve the enumeration or null if the browser doesn't support media devices enumeration\n+     */\n+    getAvailableDevices: function() {\n+        var result = null;\n+        if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {\n+            result = navigator.mediaDevices.enumerateDevices().then(devices => devices.filter(", "originalCommit": "9eaaab46171bc186e40fcdd218ca6cc4b338717f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2OTY3OQ==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r437669679", "bodyText": "@blutorange is correct. Only ECMASCRIPT5 features are used and supported in PF.", "author": "melloware", "createdAt": "2020-06-09T19:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2MzEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2OTc2NQ==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r437669765", "bodyText": "This is a little bit pedantic, but TypeScript types allow us to be explicit about the nullness of values (personally I prefer to use undefined in favor of null, but I don't think there's any consensus on that, so it's fine as it is):\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *  @return {Promise<InputDeviceInfo[]>} Returns a promise to resolve the enumeration or null if the browser doesn't support media devices enumeration\n          \n          \n            \n                 *  @return {Promise<InputDeviceInfo[]> | null} Returns a promise to resolve the enumeration or `null` if the browser does not support media devices enumeration.\n          \n      \n    \n    \n  \n\nBut other than that, the JavaScript docs look pretty good : ) I'm glad it's being maintained by everybody now.", "author": "blutorange", "createdAt": "2020-06-09T19:33:49Z", "path": "src/main/resources/META-INF/resources/primefaces/photocam/photocam.js", "diffHunk": "@@ -1163,6 +1202,33 @@ PrimeFaces.widget.PhotoCam = PrimeFaces.widget.BaseWidget.extend({\n         } else {\n             PrimeFaces.error('Capture error: AdvancedPhotoCam not attached to the camera');\n         }\n+    },\n+    \n+    /**\n+     *  Retrieves the available video input device list \n+     *  @return {Promise<InputDeviceInfo[]>} Returns a promise to resolve the enumeration or null if the browser doesn't support media devices enumeration", "originalCommit": "9eaaab46171bc186e40fcdd218ca6cc4b338717f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MjAzNA==", "url": "https://github.com/primefaces/primefaces/pull/6009#discussion_r437682034", "bodyText": "Could you add the new properties of the widget configuration to the JavaScript docs around line 1073? Like this:\n * @prop {string} cfg.device Suggests a video input device such as `user` (font camera) or `environment` (rear camera).\n * @prop {string} cfg.onCameraError Client side callback executed if the camera has an error. This string must be valid\n * JavaScript code. It is executed within the context of a function with a single parameter `errorObj` of type `Error`.", "author": "blutorange", "createdAt": "2020-06-09T19:57:03Z", "path": "src/main/resources/META-INF/resources/primefaces/photocam/photocam.js", "diffHunk": "@@ -1092,12 +1103,19 @@ PrimeFaces.widget.PhotoCam = PrimeFaces.widget.BaseWidget.extend({\n         if (!(\"autoStart\" in this.cfg)) {\n             this.cfg.autoStart = true;\n         }\n+        ", "originalCommit": "9eaaab46171bc186e40fcdd218ca6cc4b338717f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f604dc4650546a2bf30ebe09d37743d1ca0436aa", "url": "https://github.com/primefaces/primefaces/commit/f604dc4650546a2bf30ebe09d37743d1ca0436aa", "message": "jsdocs stuff", "committedDate": "2020-06-10T01:32:18Z", "type": "commit"}, {"oid": "a21ba24389558fc035eedfb16080276d261d7c22", "url": "https://github.com/primefaces/primefaces/commit/a21ba24389558fc035eedfb16080276d261d7c22", "message": "documentation improvements", "committedDate": "2020-06-10T18:00:31Z", "type": "commit"}]}