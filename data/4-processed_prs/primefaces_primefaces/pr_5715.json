{"pr_number": 5715, "pr_title": "Fix #5713: DatePicker Add showWeek and weekCalculator", "pr_createdAt": "2020-03-20T14:16:55Z", "pr_url": "https://github.com/primefaces/primefaces/pull/5715", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3MjIzMg==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395672232", "bodyText": "Brace indent issue. on line 118", "author": "melloware", "createdAt": "2020-03-20T14:26:57Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/0-datepicker.js", "diffHunk": "@@ -109,6 +111,22 @@\n                 $.extend(this.options.locale, this.options.userLocale);\n             }\n \n+            if(this.options.showWeek && !this.options.weekCalculator) {\n+                var sundayIndex = this.getSundayIndex();\n+                if(sundayIndex == 0) {\n+                    this.options.weekCalculator = this.calculateWeekNumber_sundayFirst;\n+            \t}\n+                else if(sundayIndex == 1) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDEzNg==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395680136", "bodyText": "Fixed with the next commit", "author": "fanste", "createdAt": "2020-03-20T14:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3MjIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3MzM3Ng==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395673376", "bodyText": "Feel like there has to be a way to refactor the above 3 methods as there is a lot of duplicate code expecially around yearStart and WeekNo.", "author": "melloware", "createdAt": "2020-03-20T14:28:36Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/0-datepicker.js", "diffHunk": "@@ -1292,9 +1319,42 @@\n             return dayNamesHtml;\n         },\n \n+        calculateWeekNumber_iso8601: function(d) {\n+        \td = new Date(Date.UTC(d.year, d.month, d.day));\n+            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));\n+            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));\n+            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);\n+            return weekNo;\n+        },\n+\n+        calculateWeekNumber_sundayFirst: function (d) {\n+            d = new Date(Date.UTC(d.year, d.month, d.day));\n+            d.setUTCDate(d.getUTCDate() + 3 - d.getUTCDay());\n+            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));\n+            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);\n+            return weekNo;\n+        },\n+\n+        calculateWeekNumber_saturdayFirst: function (d) {\n+        \td = new Date(Date.UTC(d.year, d.month, d.day));\n+            d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 6) % 7));\n+            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));\n+            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);\n+            return weekNo;\n+        },\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4NDM0Mg==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395684342", "bodyText": "I thought about it, but the only solution I could think of seemed somehow wrong. Anyway, I refactored it.", "author": "fanste", "createdAt": "2020-03-20T14:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3MzM3Ng=="}], "type": "inlineReview"}, {"oid": "5c0411b22d4d21144257c5cffa7d7f556fd4bfdd", "url": "https://github.com/primefaces/primefaces/commit/5c0411b22d4d21144257c5cffa7d7f556fd4bfdd", "message": "Fix primefaces#5713: Add showWeek and weekCalculator", "committedDate": "2020-03-20T14:33:54Z", "type": "commit"}, {"oid": "e9ff082a203fb9752c372f574af041e9297aee2d", "url": "https://github.com/primefaces/primefaces/commit/e9ff082a203fb9752c372f574af041e9297aee2d", "message": "Fix primefaces#5713: Update documentation for 9.0", "committedDate": "2020-03-20T14:33:55Z", "type": "commit"}, {"oid": "e9ff082a203fb9752c372f574af041e9297aee2d", "url": "https://github.com/primefaces/primefaces/commit/e9ff082a203fb9752c372f574af041e9297aee2d", "message": "Fix primefaces#5713: Update documentation for 9.0", "committedDate": "2020-03-20T14:33:55Z", "type": "forcePushed"}, {"oid": "7f1146b3b351a0e89201edec75cda5cb844922ea", "url": "https://github.com/primefaces/primefaces/commit/7f1146b3b351a0e89201edec75cda5cb844922ea", "message": "Refactor calculateWeekNumber_X", "committedDate": "2020-03-20T14:47:44Z", "type": "commit"}, {"oid": "7f1146b3b351a0e89201edec75cda5cb844922ea", "url": "https://github.com/primefaces/primefaces/commit/7f1146b3b351a0e89201edec75cda5cb844922ea", "message": "Refactor calculateWeekNumber_X", "committedDate": "2020-03-20T14:47:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNTI5Mw==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395705293", "bodyText": "Why not put this method right below the 3 methods using it?", "author": "melloware", "createdAt": "2020-03-20T15:15:39Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/0-datepicker.js", "diffHunk": "@@ -17,6 +17,12 @@\n     }\n }(function ($) {\n \n+    function calculateWeekNumber(d) {\n+        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));\n+        var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);\n+        return weekNo;\n+    }", "originalCommit": "7f1146b3b351a0e89201edec75cda5cb844922ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk3NzI3Ng==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395977276", "bodyText": "I don't think that it would be a good idea to invoke the calculation method with the this scope. So I can't add the common method to the widget because then I have to invoke it with this.\nAt least that is my understanding, but I have to test it.", "author": "fanste", "createdAt": "2020-03-21T09:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNTI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5MTU0Mg==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395991542", "bodyText": "yeah and if you consider it a private method of the widget you can name it with an underscore so _calculateWeekNumber that is how other widgets do methods like these as internal helper methods..", "author": "melloware", "createdAt": "2020-03-21T13:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNTI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0ODc1Mg==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396348752", "bodyText": "Also, why UTC? could you please remove UTC format?\nhttps://github.com/primefaces/primereact/blob/master/src/components/calendar/Calendar.js#L1586\ngetWeekNumber(date) {\n        let checkDate = new Date(date.getTime());\n        checkDate.setDate(checkDate.getDate() + 4 - ( checkDate.getDay() || 7 ));\n        let time = checkDate.getTime();\n        checkDate.setMonth( 0 );\n        checkDate.setDate( 1 );\n        return Math.floor( Math.round((time - checkDate.getTime()) / 86400000 ) / 7 ) + 1;\n    }", "author": "mertsincan", "createdAt": "2020-03-23T10:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNTI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3MDkzOA==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396470938", "bodyText": "I used UTC because there are multiple reports on the web (e.g. SO, edit from 2017) that not using UTC may result in incorrect weeks. Additionally I refactored the week calculation a bit based on code from moment.js (which also uses UTC) to really fix non-ISO8601 calendar views (and issue #1052).", "author": "fanste", "createdAt": "2020-03-23T13:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNTI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk3NDMzOQ==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r395974339", "bodyText": "please add ui-state-disabled", "author": "christophs78", "createdAt": "2020-03-21T08:39:25Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/0-datepicker.js", "diffHunk": "@@ -1293,9 +1326,36 @@\n             return dayNamesHtml;\n         },\n \n+        calculateWeekNumber_iso8601: function(d) {\n+            d = new Date(Date.UTC(d.year, d.month, d.day));\n+            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));\n+            return calculateWeekNumber(d);\n+        },\n+\n+        calculateWeekNumber_sundayFirst: function (d) {\n+            d = new Date(Date.UTC(d.year, d.month, d.day));\n+            d.setUTCDate(d.getUTCDate() + 3 - d.getUTCDay());\n+            return calculateWeekNumber(d);\n+        },\n+\n+        calculateWeekNumber_saturdayFirst: function (d) {\n+            d = new Date(Date.UTC(d.year, d.month, d.day));\n+            d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 6) % 7));\n+            return calculateWeekNumber(d);\n+        },\n+\n         renderWeek: function (weekDates) {\n             var weekHtml = '';\n \n+            if(this.options.showWeek) {\n+                var date = weekDates[0],\n+                    cellClass = date.otherMonth && !this.options.showOtherMonths ? ' ui-datepicker-other-month-hidden' : '';\n+\n+                weekHtml += '<td class=\"ui-datepicker-week-col' + cellClass + '\">' + ", "originalCommit": "7f1146b3b351a0e89201edec75cda5cb844922ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI3NTM5Ng==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396275396", "bodyText": "I have implemeted it the same ways a jquery did it. What is your intention adding this CSS class? When I add ui-state-disabled, selecting of the week number is still allowed but it is/may be rendered nearly unreadable (due to some disabled styling like opacity)", "author": "fanste", "createdAt": "2020-03-23T08:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk3NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMxMjY2OQ==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396312669", "bodyText": "IMO we should use PrimeNG and PrimeReact as reference.\nhttps://primefaces.org/primeng/showcase/#/calendar\nhttps://primefaces.org/primereact/showcase/#/calendar\nBoth use ui-state-disabled.\nAs far as i know PrimeTek uses the (almost) same base SASS for all themes independent of technology. So it would make sense to render the same code like PrimeNG/PrimeReact/PrimeVue.\n@mertsincan: Do you want to add something?", "author": "christophs78", "createdAt": "2020-03-23T09:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk3NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0Mjk3NA==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396342974", "bodyText": "Hi,\nDOM structure can be like;\n<td class=\"ui-datepicker-weeknumber\">\n     <span class=\"ui-state-disabled\">13</span>\n</td>", "author": "mertsincan", "createdAt": "2020-03-23T10:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk3NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2NTQ2NQ==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396465465", "bodyText": "OK, I will change the DOM structure as requested.", "author": "fanste", "createdAt": "2020-03-23T13:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk3NDMzOQ=="}], "type": "inlineReview"}, {"oid": "a27d03bc0cb5478ddb6b9056ac2bfdeef834d2e1", "url": "https://github.com/primefaces/primefaces/commit/a27d03bc0cb5478ddb6b9056ac2bfdeef834d2e1", "message": "Add new datepicker attributes to taglib", "committedDate": "2020-03-23T08:13:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM3MTg4Mw==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396371883", "bodyText": "I think you can remove this if statement. Users can calculate week numbers using a custom weekCalculator function;\nfunction myWeekCalculator(date) {\n    ...\n    return weekNo;\n}\n\n<p:datePicker weekCalculator=\"myWeekCalculator\"", "author": "mertsincan", "createdAt": "2020-03-23T11:08:58Z", "path": "src/main/resources/META-INF/resources/primefaces/datepicker/0-datepicker.js", "diffHunk": "@@ -110,6 +112,22 @@\n                 $.extend(this.options.locale, this.options.userLocale);\n             }\n \n+            if(this.options.showWeek && !this.options.weekCalculator) {", "originalCommit": "5c0411b22d4d21144257c5cffa7d7f556fd4bfdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2Njc4Mw==", "url": "https://github.com/primefaces/primefaces/pull/5715#discussion_r396466783", "bodyText": "No I can't remove it. This if checks if a custom week calculator is provided or if some internal defaults have to be configured. But only if showWeek is enabled. If the user provides a custom week calculator I don't have to check if the internals are correctly configured because it is totally up to the user.", "author": "fanste", "createdAt": "2020-03-23T13:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM3MTg4Mw=="}], "type": "inlineReview"}, {"oid": "52f097a28c29090cc34a6eda13ba991c079a7ed1", "url": "https://github.com/primefaces/primefaces/commit/52f097a28c29090cc34a6eda13ba991c079a7ed1", "message": "Refactor calculation to really fix non-ISO8601 calendar views\n\nThe code is based on the logic implemented in moment.js", "committedDate": "2020-03-23T14:21:08Z", "type": "commit"}]}