{"pr_number": 1316, "pr_title": "Fix EcsCommandExecutor to use finish marker to know if logging is finished or not", "pr_createdAt": "2020-01-10T09:19:06Z", "pr_url": "https://github.com/treasure-data/digdag/pull/1316", "timeline": [{"oid": "b7304d8f03674c166bec24a5323a1495a5cf5767", "url": "https://github.com/treasure-data/digdag/commit/b7304d8f03674c166bec24a5323a1495a5cf5767", "message": "Fix EcsCommandExecutor to use finish marker to know if task is finished or not", "committedDate": "2020-01-10T09:16:16Z", "type": "commit"}, {"oid": "a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "url": "https://github.com/treasure-data/digdag/commit/a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "message": "Add timeout and refactor", "committedDate": "2020-01-14T08:22:13Z", "type": "commit"}, {"oid": "a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "url": "https://github.com/treasure-data/digdag/commit/a7adc4f0d7c5537b6dea03ebedba1ff813fde44c", "message": "Add timeout and refactor", "committedDate": "2020-01-14T08:22:13Z", "type": "forcePushed"}, {"oid": "1ed8b398e30344c79a92046311d4418e05656dc6", "url": "https://github.com/treasure-data/digdag/commit/1ed8b398e30344c79a92046311d4418e05656dc6", "message": "move log uploading to after marker is checked", "committedDate": "2020-01-14T09:02:24Z", "type": "commit"}, {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "url": "https://github.com/treasure-data/digdag/commit/e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "message": "Fix to use contain for checking finish marker", "committedDate": "2020-01-15T08:53:41Z", "type": "commit"}, {"oid": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "url": "https://github.com/treasure-data/digdag/commit/e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "message": "Fix to use contain for checking finish marker", "committedDate": "2020-01-15T08:53:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1NDkxNA==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370854914", "bodyText": "We can make this happen earlier. As soon as a task finishes, right before // always return false to check if ... comment, we can set status_code.", "author": "frsyuki", "createdAt": "2020-01-24T21:41:04Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -287,8 +288,39 @@ CommandStatus createNextCommandStatus(\n         }\n \n         final EcsTaskStatus taskStatus = EcsTaskStatus.of(task.getLastStatus());\n-        final ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n-        final ObjectNode nextExecutorStatus;\n+        ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n+        ObjectNode nextExecutorStatus;\n+\n+        // To fetch log until all logs is written in CloudWatch, it should wait until getting finish marker in end of task.\n+        // (finished previous poll once considering risk of crushing while running previous actual poll.)\n+        final Optional<Long> taskFinishedAt = !previousStatus.has(\"task_finished_at\") ?\n+                Optional.absent() : Optional.of(previousStatus.get(\"task_finished_at\").asLong());\n+        if (taskFinishedAt.isPresent()) {\n+            long timeout = taskFinishedAt.get() + 60;\n+            do {\n+                previousExecutorStatus = fetchLogEvents(client, task, previousStatus, previousExecutorStatus);\n+                if (previousExecutorStatus.get(\"logging_finished\") != null) {\n+                    break;\n+                }\n+            } while (Instant.now().getEpochSecond() < timeout);\n+\n+            final String outputArchivePathName = \"archive-output.tar.gz\";\n+            final String outputArchiveKey = createStorageKey(commandContext.getTaskRequest(), outputArchivePathName); // url format\n+            // Download output config archive\n+            final TemporalProjectArchiveStorage temporalStorage = createTemporalProjectArchiveStorage(commandContext.getTaskRequest().getConfig());\n+            try (final InputStream in = temporalStorage.getContentInputStream(outputArchiveKey)) {\n+                ProjectArchives.extractTarArchive(commandContext.getLocalProjectPath(), in); // IOException\n+            }\n+\n+            final ObjectNode nextStatus = previousStatus.deepCopy();\n+            nextStatus.set(\"executor_state\", previousExecutorStatus);\n+\n+            // Set exit code of container finished to nextStatus\n+            nextStatus.put(\"status_code\", task.getContainers().get(0).getExitCode());", "originalCommit": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTIzMA==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r371329230", "bodyText": "I moved status_code putting to after task is finished.\n3c6c3dc", "author": "naritta", "createdAt": "2020-01-27T16:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1NDkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MDMwMQ==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370860301", "bodyText": "After 1., if you feel you have energy (meaning it's optional to do), it's better to do a refactoring around execution status data:\n\n\ntoLogStreamName is formatting a string but it's unnecessary if previousStatus includes the pre-built string. As like toLogGroupName is doing. If toLogStreamName simply uses previousStatus.get(\"awslogs\").get(\"awslogs-stream\").asText() then, we can do as following:\nrun calls createCurrentStatus to set awslogs to the status. It's calling getAwsLogsConfiguration(td), which copies all of the logConfig.getOptions().entrySet() to the executor status. This becomes unnecessary. Instead, it simply needs to copy awslogs.awslogs-group and format&set awslogs.awslogs-stream only.\nBecause toLogStreamName gets pre-formatted text from the executor status, it doesn't need TaskDefinition td any more. It also means that fetchLogEvents doesn't need Task task. It means that createNextCommandStatus doesn't have to pass Task task to fetchLogEvents. Therefore, you can move this entire block (if (taskFinishedAt.isPresent()) { ... }) right before client.getTask call. It means that EcsCommandExecutor doesn't have to call ECS API when it's waiting for logs.\n\nThis is helpful to mitigate API call rate limit of ECS API.", "author": "frsyuki", "createdAt": "2020-01-24T21:56:26Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -287,8 +288,39 @@ CommandStatus createNextCommandStatus(\n         }\n \n         final EcsTaskStatus taskStatus = EcsTaskStatus.of(task.getLastStatus());\n-        final ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n-        final ObjectNode nextExecutorStatus;\n+        ObjectNode previousExecutorStatus = (ObjectNode) previousStatus.get(\"executor_state\");\n+        ObjectNode nextExecutorStatus;\n+\n+        // To fetch log until all logs is written in CloudWatch, it should wait until getting finish marker in end of task.\n+        // (finished previous poll once considering risk of crushing while running previous actual poll.)\n+        final Optional<Long> taskFinishedAt = !previousStatus.has(\"task_finished_at\") ?\n+                Optional.absent() : Optional.of(previousStatus.get(\"task_finished_at\").asLong());\n+        if (taskFinishedAt.isPresent()) {\n+            long timeout = taskFinishedAt.get() + 60;\n+            do {\n+                previousExecutorStatus = fetchLogEvents(client, task, previousStatus, previousExecutorStatus);", "originalCommit": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0ODE4Mw==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r371348183", "bodyText": "Thank for teaching, I refactored like that to reduce ECS API call.\nd8de229", "author": "naritta", "createdAt": "2020-01-27T16:35:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MDMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTMwMg==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370861302", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            } else {\n          \n          \n            \n                            }\n          \n          \n            \n                            else {", "author": "frsyuki", "createdAt": "2020-01-24T21:59:25Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -361,7 +386,12 @@ ObjectNode fetchLogEvents(final EcsClient client,\n         }\n         else {\n             for (final OutputLogEvent logEvent : logEvents) {\n-                log(logEvent.getMessage() + \"\\n\", clog);\n+                String log = logEvent.getMessage();\n+                if (log.contains(ECS_TASK_FINISHED)) {\n+                    nextExecutorStatus.set(\"logging_finished\", JsonNodeFactory.instance.textNode(\"true\"));\n+                } else {", "originalCommit": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyODAxMw==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r371328013", "bodyText": "I fixed here.\nc8a0ac6", "author": "naritta", "createdAt": "2020-01-27T16:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTU4Ng==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370861586", "bodyText": "It's better to use a self-explaining name:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String ECS_TASK_FINISHED = \"ECS_TASK_FINISHED\";\n          \n          \n            \n                private static final String ECS_END_OF_TASK_LOG_MARK = \"ECS_TASK_FINISHED\";", "author": "frsyuki", "createdAt": "2020-01-24T22:00:20Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -66,6 +66,7 @@\n \n     private static final String ECS_COMMAND_EXECUTOR_SYSTEM_CONFIG_PREFIX = \"agent.command_executor.ecs.\";\n     private static final String DEFAULT_COMMAND_TASK_TTL = ECS_COMMAND_EXECUTOR_SYSTEM_CONFIG_PREFIX + \"default_command_task_ttl\";\n+    private static final String ECS_TASK_FINISHED = \"ECS_TASK_FINISHED\";", "originalCommit": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2NTI5MA==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370865290", "bodyText": "I think the value (\"ECS_TASK_FINISHED\") needs to be something more unlike because log stream finishes unexpectedly if a script outputs this message.\nHow about using \"--RWNzQ29tbWFuZEV4ZWN1dG9y--\"  // base64(\"EcsCommandExecutor\") for example? Idea is partially taken from https://www.w3.org/Protocols/rfc1341/7_2_Multipart.html", "author": "frsyuki", "createdAt": "2020-01-24T22:11:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyNzI0OA==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r371327248", "bodyText": "I changed key to ECS_END_OF_TASK_LOG_MARK  and value to \"--RWNzQ29tbWFuZEV4ZWN1dG9y--\" here.\nc57f438", "author": "naritta", "createdAt": "2020-01-27T16:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MTU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2Mjk3OA==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370862978", "bodyText": "I recommend to use logging_finished_at and set timestamp instead of true because we can know when waiting logging has finished without much overhead. It helps us to investigate problems if some happened.", "author": "frsyuki", "createdAt": "2020-01-24T22:04:26Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -361,7 +386,12 @@ ObjectNode fetchLogEvents(final EcsClient client,\n         }\n         else {\n             for (final OutputLogEvent logEvent : logEvents) {\n-                log(logEvent.getMessage() + \"\\n\", clog);\n+                String log = logEvent.getMessage();\n+                if (log.contains(ECS_TASK_FINISHED)) {\n+                    nextExecutorStatus.set(\"logging_finished\", JsonNodeFactory.instance.textNode(\"true\"));", "originalCommit": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyNzc0Mg==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r371327742", "bodyText": "Sorry I forgot to fix, and I fixed to use time here.\nb45c5fb", "author": "naritta", "createdAt": "2020-01-27T16:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2Mjk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MzM5Nw==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r370863397", "bodyText": "This needs escaping:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    bashArguments.add(s(\"echo %s\", ECS_TASK_FINISHED));\n          \n          \n            \n                    bashArguments.add(s(\"echo \\\"%s\\\"\", ECS_TASK_FINISHED));", "author": "frsyuki", "createdAt": "2020-01-24T22:05:45Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/EcsCommandExecutor.java", "diffHunk": "@@ -618,6 +648,7 @@ protected void setEcsContainerOverrideCommand(\n         }\n         bashArguments.add(s(\"tar -zcf %s  --exclude %s --exclude %s .digdag/tmp/\", outputProjectArchivePathName, relativeProjectArchivePath.toString(), outputProjectArchivePathName));\n         bashArguments.add(s(\"curl -s -X PUT -T %s -L \\\"%s\\\"\", outputProjectArchivePathName, outputProjectArchiveDirectUploadUrl));\n+        bashArguments.add(s(\"echo %s\", ECS_TASK_FINISHED));", "originalCommit": "e7a04fb48c8febdc8838a8533eba16fb474b0ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyODQ0Mw==", "url": "https://github.com/treasure-data/digdag/pull/1316#discussion_r371328443", "bodyText": "I added escape here.\nec0e18e", "author": "naritta", "createdAt": "2020-01-27T16:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MzM5Nw=="}], "type": "inlineReview"}, {"oid": "c57f438030abfbb3c95c6fd4b960f9e291f96561", "url": "https://github.com/treasure-data/digdag/commit/c57f438030abfbb3c95c6fd4b960f9e291f96561", "message": "Fix task finished marker name and value", "committedDate": "2020-01-27T05:23:50Z", "type": "commit"}, {"oid": "b45c5fb60f7480a6ad6c21f9d71d90ed663ae23b", "url": "https://github.com/treasure-data/digdag/commit/b45c5fb60f7480a6ad6c21f9d71d90ed663ae23b", "message": "Fix logging finished status to use time for investigation", "committedDate": "2020-01-27T05:39:10Z", "type": "commit"}, {"oid": "c8a0ac626ea82458e90db004fddb885208c3ea77", "url": "https://github.com/treasure-data/digdag/commit/c8a0ac626ea82458e90db004fddb885208c3ea77", "message": "Fix code indent for else", "committedDate": "2020-01-27T05:40:07Z", "type": "commit"}, {"oid": "ec0e18ecc8a2133b5efbd17e26fddb6ccb21bb04", "url": "https://github.com/treasure-data/digdag/commit/ec0e18ecc8a2133b5efbd17e26fddb6ccb21bb04", "message": "Fix to escape", "committedDate": "2020-01-27T05:42:46Z", "type": "commit"}, {"oid": "3c6c3dc7afe0e488d1767018c0894fdb89a7b03a", "url": "https://github.com/treasure-data/digdag/commit/3c6c3dc7afe0e488d1767018c0894fdb89a7b03a", "message": "Move status_code setting right after task is finished", "committedDate": "2020-01-27T06:00:43Z", "type": "commit"}, {"oid": "d8de229d1475895705fd39658cc4d4fcccb129e6", "url": "https://github.com/treasure-data/digdag/commit/d8de229d1475895705fd39658cc4d4fcccb129e6", "message": "Refactor", "committedDate": "2020-01-27T16:33:31Z", "type": "commit"}, {"oid": "d8de229d1475895705fd39658cc4d4fcccb129e6", "url": "https://github.com/treasure-data/digdag/commit/d8de229d1475895705fd39658cc4d4fcccb129e6", "message": "Refactor", "committedDate": "2020-01-27T16:33:31Z", "type": "forcePushed"}]}