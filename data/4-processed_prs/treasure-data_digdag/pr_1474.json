{"pr_number": 1474, "pr_title": "Fetch sensitive data from `systemConfig`", "pr_createdAt": "2020-10-30T08:20:03Z", "pr_url": "https://github.com/treasure-data/digdag/pull/1474", "timeline": [{"oid": "cd60ba62c27568bfab28775f93fad18fd3c1726c", "url": "https://github.com/treasure-data/digdag/commit/cd60ba62c27568bfab28775f93fad18fd3c1726c", "message": "Fetch sensitive data from `systemConfig`", "committedDate": "2020-10-30T08:09:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNDUwOA==", "url": "https://github.com/treasure-data/digdag/pull/1474#discussion_r515714508", "bodyText": "Where were these fields set in the nested config?", "author": "komamitsu", "createdAt": "2020-11-02T02:39:33Z", "path": "digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java", "diffHunk": "@@ -33,29 +33,31 @@ public EcsClientConfig(EcsClientConfigBuilder builder)\n         this.assignPublicIp = builder.isAssignPublicIp();\n     }\n \n-    public static EcsClientConfig createFromTaskConfig(final Optional<String> clusterName, final Config config)\n+    public static EcsClientConfig createFromTaskConfig(final Optional<String> clusterName, final Config taskConfig, final Config systemConfig)\n     {\n         final String name;\n-        // `config` is assumed to have a nested config with following values\n-        // at the key of `TASK_CONFIG_ECS_KEY` from `config`.\n+        // `taskConfig` is assumed to have a nested taskConfig with following values\n+        // at the key of `TASK_CONFIG_ECS_KEY` from `taskConfig`.\n         // - launch_type (optional)\n-        // - access_key_id", "originalCommit": "cd60ba62c27568bfab28775f93fad18fd3c1726c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNTk0MA==", "url": "https://github.com/treasure-data/digdag/pull/1474#discussion_r515715940", "bodyText": "I expect that these fields are set in the caller (e.g. CommandExecutor classes) or task definitions.", "author": "serihiro", "createdAt": "2020-11-02T02:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNDUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0MTI3OA==", "url": "https://github.com/treasure-data/digdag/pull/1474#discussion_r515741278", "bodyText": "Oh, I just thought we might need to remove these system credentials (access_key_id and secret_access_key) from all task configs as well in this PR., but you didn't add any code that puts the credentials in a task config? If so, I'm not sure these system credentials are set by callers...", "author": "komamitsu", "createdAt": "2020-11-02T05:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNDUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzM3MQ==", "url": "https://github.com/treasure-data/digdag/pull/1474#discussion_r515747371", "bodyText": "Ah sorry. Maybe I wrongly understood what you meant.\nI thought that you have mentioned about ALL fields of them ( including launch_type, region, subnets and so on). But it seems that you mentioned about ONLY access_key_id and secret_access_key, is it correct?\nWith explaining the background from the beginning,\n\nIn the first time when EcsCommandExecutor was released, access_key_id and secret_access_key were expected to be put only into systemConfig. So EcsClientConfig had been built only from systemConfig.\nAt #1469, I added a support of building EcsClientConfig from taskConfig so that we can change the contents of EcsClientConfig for each taskConfig.\nAfter merging #1469, I thought that sensitive data should not be included in taskConfig. So I sent this PR so that access_key_id and secret_access_key are retrieved only from systemConfig.\n\n\nOh, I just thought we might need to remove these system credentials (access_key_id and secret_access_key) from all task configs as well in this PR.\n\nYes, you are correct.\n\nbut you didn't add any code that puts the credentials in a task config?\n\nImplicitly it depended on users whether access_key_id and secret_access_key were put into the taskConfig not. Surely it was not good implementation. But this PR fixes it as well.\nSo this PR does not include any code change to remove system credentials from task configs.\nIn the original implementation, access_key_id and secret_access_key were expected to be put on server.properties and can be fetched with agent.command_executor.ecs.{cluster_name}.access_key_id and agent.command_executor.ecs.{cluster_name}.secret_access_key repeatedly as follows.\n\n  \n    \n      digdag/digdag-standards/src/main/java/io/digdag/standards/command/ecs/EcsClientConfig.java\n    \n    \n        Lines 48 to 57\n      in\n      ead8c27\n    \n    \n    \n    \n\n        \n          \n           final String extractedPrefix = SYSTEM_CONFIG_PREFIX + name + \".\"; \n        \n\n        \n          \n           final Config extracted = StorageManager.extractKeyPrefix(systemConfig, extractedPrefix); \n        \n\n        \n          \n           return new EcsClientConfig(name, \n        \n\n        \n          \n                   extracted.get(\"launch_type\", String.class), \n        \n\n        \n          \n                   extracted.get(\"access_key_id\", String.class), \n        \n\n        \n          \n                   extracted.get(\"secret_access_key\", String.class), \n        \n\n        \n          \n                   extracted.get(\"region\", String.class), \n        \n\n        \n          \n                   extracted.get(\"subnets\", String.class), \n        \n\n        \n          \n                   extracted.get(\"max_retries\", int.class, 3) \n        \n\n        \n          \n           ); \n        \n    \n  \n\n\n\nIf so, I'm not sure these system credentials are set by callers...\n\nAs I explained above, they were expected to be set systemConfig implicitly. So originally there has not been the explicit implementations to do that.", "author": "serihiro", "createdAt": "2020-11-02T05:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNDUwOA=="}], "type": "inlineReview"}]}