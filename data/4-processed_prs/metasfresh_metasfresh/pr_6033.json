{"pr_number": 6033, "pr_title": "#3552 Added Action to export number of sales invoices in specific date range for business partners.", "pr_createdAt": "2020-01-13T16:57:58Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6033", "timeline": [{"oid": "1ab220c494aff8c44da72f23fad1f00bf88ccb40", "url": "https://github.com/metasfresh/metasfresh/commit/1ab220c494aff8c44da72f23fad1f00bf88ccb40", "message": "#3552 Added Action to export number of sales invoices in specific date range for business partners.", "committedDate": "2020-01-13T16:57:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIyMzk1Ng==", "url": "https://github.com/metasfresh/metasfresh/pull/6033#discussion_r366223956", "bodyText": "Also filter on inv.AD_Client_ID=1000000 AND inv.IsaCtive='Y' pls", "author": "metas-ts", "createdAt": "2020-01-14T09:15:51Z", "path": "de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/ddl/functions/exportSalesInvoicesInDateRange.sql", "diffHunk": "@@ -0,0 +1,38 @@\n+DROP FUNCTION IF EXISTS exportSalesInvoicesInDateRange(TIMESTAMP With Time Zone, TIMESTAMP With Time Zone, numeric);\n+\n+CREATE OR REPLACE FUNCTION exportSalesInvoicesInDateRange(IN p_C_Invoice_dateinvoiced_start TIMESTAMP With Time Zone, \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_C_Invoice_dateinvoiced_end TIMESTAMP With Time Zone,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_AD_Org_ID numeric)\n+\n+    RETURNS TABLE\n+            (\n+                AD_Org_ID character varying,\n+\t\t\t\tC_Bpartner_ID character varying,\n+\t\t\t\tC_Invoices_Count bigint\n+            )\n+AS\n+\n+$BODY$\n+\n+SELECT DISTINCT org.name as AD_Org_ID,\n+\tbp.name as C_Bpartner_ID,\n+\t(SELECT COUNT(*)\n+\t FROM   C_Invoice other\n+\t WHERE other.c_bpartner_id = inv.c_bpartner_id\n+ \t AND other.ad_org_id = inv.ad_org_id\n+\t AND other.dateinvoiced >= p_C_Invoice_dateinvoiced_start\n+     AND other.dateinvoiced <= p_C_Invoice_dateinvoiced_end\n+\t)\n+\t AS C_Invoices_Count\n+\t\n+FROM C_Invoice inv\n+\tLEFT OUTER JOIN ad_org org on org.ad_org_id = inv.ad_org_id\n+\tLEFT OUTER JOIN c_bpartner bp on bp.c_bpartner_id = inv.c_bpartner_id\n+WHERE inv.dateinvoiced >= p_C_Invoice_dateinvoiced_start", "originalCommit": "1ab220c494aff8c44da72f23fad1f00bf88ccb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIyODQ2NA==", "url": "https://github.com/metasfresh/metasfresh/pull/6033#discussion_r366228464", "bodyText": "This is a misunderstanding: the org-partner means the BPartner that \"represents\" the org...not the invoice's partner.\nSo basically, if you write a sales-invoice with Org=ABC, then\n\nthe BPartner from inv.c_bpartner_id is supposed to pay to Org ABC\nand ABC's \"organization-bpartner\" will find the paid money on their bank-accound\n\nSo, to get from an invoice to the \"organization-bpartner\", you go C_Invoice.AD_Org_ID and then AD_Org.AD_OrgBP_ID.", "author": "metas-ts", "createdAt": "2020-01-14T09:25:40Z", "path": "de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/ddl/functions/exportSalesInvoicesInDateRange.sql", "diffHunk": "@@ -0,0 +1,38 @@\n+DROP FUNCTION IF EXISTS exportSalesInvoicesInDateRange(TIMESTAMP With Time Zone, TIMESTAMP With Time Zone, numeric);\n+\n+CREATE OR REPLACE FUNCTION exportSalesInvoicesInDateRange(IN p_C_Invoice_dateinvoiced_start TIMESTAMP With Time Zone, \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_C_Invoice_dateinvoiced_end TIMESTAMP With Time Zone,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_AD_Org_ID numeric)\n+\n+    RETURNS TABLE\n+            (\n+                AD_Org_ID character varying,\n+\t\t\t\tC_Bpartner_ID character varying,\n+\t\t\t\tC_Invoices_Count bigint\n+            )\n+AS\n+\n+$BODY$\n+\n+SELECT DISTINCT org.name as AD_Org_ID,\n+\tbp.name as C_Bpartner_ID,\n+\t(SELECT COUNT(*)\n+\t FROM   C_Invoice other\n+\t WHERE other.c_bpartner_id = inv.c_bpartner_id\n+ \t AND other.ad_org_id = inv.ad_org_id\n+\t AND other.dateinvoiced >= p_C_Invoice_dateinvoiced_start\n+     AND other.dateinvoiced <= p_C_Invoice_dateinvoiced_end\n+\t)\n+\t AS C_Invoices_Count\n+\t\n+FROM C_Invoice inv\n+\tLEFT OUTER JOIN ad_org org on org.ad_org_id = inv.ad_org_id", "originalCommit": "1ab220c494aff8c44da72f23fad1f00bf88ccb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIzMDY2NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6033#discussion_r366230665", "bodyText": "please rewrite the select to get rid of the subselect, and have just one where-clause.\nyou can do this with \"group by\"", "author": "metas-ts", "createdAt": "2020-01-14T09:30:12Z", "path": "de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/ddl/functions/exportSalesInvoicesInDateRange.sql", "diffHunk": "@@ -0,0 +1,38 @@\n+DROP FUNCTION IF EXISTS exportSalesInvoicesInDateRange(TIMESTAMP With Time Zone, TIMESTAMP With Time Zone, numeric);\n+\n+CREATE OR REPLACE FUNCTION exportSalesInvoicesInDateRange(IN p_C_Invoice_dateinvoiced_start TIMESTAMP With Time Zone, \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_C_Invoice_dateinvoiced_end TIMESTAMP With Time Zone,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_AD_Org_ID numeric)\n+\n+    RETURNS TABLE\n+            (\n+                AD_Org_ID character varying,\n+\t\t\t\tC_Bpartner_ID character varying,\n+\t\t\t\tC_Invoices_Count bigint\n+            )\n+AS\n+\n+$BODY$\n+\n+SELECT DISTINCT org.name as AD_Org_ID,\n+\tbp.name as C_Bpartner_ID,\n+\t(SELECT COUNT(*)", "originalCommit": "1ab220c494aff8c44da72f23fad1f00bf88ccb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIzMTE3MA==", "url": "https://github.com/metasfresh/metasfresh/pull/6033#discussion_r366231170", "bodyText": "Also, filter by inv.DocType IN ('CO', 'CL'), because you don't want drafted or reversed invoices", "author": "metas-ts", "createdAt": "2020-01-14T09:31:06Z", "path": "de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/ddl/functions/exportSalesInvoicesInDateRange.sql", "diffHunk": "@@ -0,0 +1,38 @@\n+DROP FUNCTION IF EXISTS exportSalesInvoicesInDateRange(TIMESTAMP With Time Zone, TIMESTAMP With Time Zone, numeric);\n+\n+CREATE OR REPLACE FUNCTION exportSalesInvoicesInDateRange(IN p_C_Invoice_dateinvoiced_start TIMESTAMP With Time Zone, \n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_C_Invoice_dateinvoiced_end TIMESTAMP With Time Zone,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  IN p_AD_Org_ID numeric)\n+\n+    RETURNS TABLE\n+            (\n+                AD_Org_ID character varying,\n+\t\t\t\tC_Bpartner_ID character varying,\n+\t\t\t\tC_Invoices_Count bigint\n+            )\n+AS\n+\n+$BODY$\n+\n+SELECT DISTINCT org.name as AD_Org_ID,\n+\tbp.name as C_Bpartner_ID,\n+\t(SELECT COUNT(*)\n+\t FROM   C_Invoice other\n+\t WHERE other.c_bpartner_id = inv.c_bpartner_id\n+ \t AND other.ad_org_id = inv.ad_org_id\n+\t AND other.dateinvoiced >= p_C_Invoice_dateinvoiced_start\n+     AND other.dateinvoiced <= p_C_Invoice_dateinvoiced_end\n+\t)\n+\t AS C_Invoices_Count\n+\t\n+FROM C_Invoice inv\n+\tLEFT OUTER JOIN ad_org org on org.ad_org_id = inv.ad_org_id\n+\tLEFT OUTER JOIN c_bpartner bp on bp.c_bpartner_id = inv.c_bpartner_id\n+WHERE inv.dateinvoiced >= p_C_Invoice_dateinvoiced_start\n+      AND inv.dateinvoiced <= p_C_Invoice_dateinvoiced_end\n+      AND CASE WHEN p_AD_Org_ID > 0 THEN inv.ad_org_id = p_AD_Org_ID ELSE 1 = 1 END", "originalCommit": "1ab220c494aff8c44da72f23fad1f00bf88ccb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bdb6258e8f0cf9c9f57debcbf780167b596425b6", "url": "https://github.com/metasfresh/metasfresh/commit/bdb6258e8f0cf9c9f57debcbf780167b596425b6", "message": "#3552 Updated Export Function.", "committedDate": "2020-01-14T12:51:51Z", "type": "commit"}, {"oid": "6e4d142981cc2762a498b129e5026c8cd664dee1", "url": "https://github.com/metasfresh/metasfresh/commit/6e4d142981cc2762a498b129e5026c8cd664dee1", "message": "Merge branch 'master' into gh3552", "committedDate": "2020-01-14T12:52:00Z", "type": "commit"}]}