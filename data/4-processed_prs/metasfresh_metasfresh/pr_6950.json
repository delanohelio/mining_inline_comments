{"pr_number": 6950, "pr_title": "`Picking Terminal V2`: Add process for picking and packing in 1 step", "pr_createdAt": "2020-07-02T12:37:37Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6950", "timeline": [{"oid": "de15f93671928eb15282c23db187589f321f7ff3", "url": "https://github.com/metasfresh/metasfresh/commit/de15f93671928eb15282c23db187589f321f7ff3", "message": "Extract common process logic to helper component and implement process for both steps\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T09:58:33Z", "type": "commit"}, {"oid": "461debc58ea8887dd86b130838be07eb13e9ebc3", "url": "https://github.com/metasfresh/metasfresh/commit/461debc58ea8887dd86b130838be07eb13e9ebc3", "message": "Add column/field `M_HU_PI.IsDefaultForPicking`\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T09:58:34Z", "type": "commit"}, {"oid": "970f8953221f5a200f308046f70c23177b71ccfe", "url": "https://github.com/metasfresh/metasfresh/commit/970f8953221f5a200f308046f70c23177b71ccfe", "message": "Use the default PI for picking + ensure there's only 1 set\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:00:09Z", "type": "commit"}, {"oid": "9d8746ee51c04b336072d698fc5127b6c676133a", "url": "https://github.com/metasfresh/metasfresh/commit/9d8746ee51c04b336072d698fc5127b6c676133a", "message": "Add sql migration\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:00:18Z", "type": "commit"}, {"oid": "a933c95284270796f83cacb65be2d3d045b29474", "url": "https://github.com/metasfresh/metasfresh/commit/a933c95284270796f83cacb65be2d3d045b29474", "message": "Ensure default Packing Instruction exists before running PickAndPack process\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:00:19Z", "type": "commit"}, {"oid": "757de28a8d59ac7096dd35066be33ba4c01bffc5", "url": "https://github.com/metasfresh/metasfresh/commit/757de28a8d59ac7096dd35066be33ba4c01bffc5", "message": "Fix wording\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:00:19Z", "type": "commit"}, {"oid": "0550d77aa600022c1b346350c8c43fdd2e2b8c76", "url": "https://github.com/metasfresh/metasfresh/commit/0550d77aa600022c1b346350c8c43fdd2e2b8c76", "message": "Fix warnings\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:01:53Z", "type": "commit"}, {"oid": "0550d77aa600022c1b346350c8c43fdd2e2b8c76", "url": "https://github.com/metasfresh/metasfresh/commit/0550d77aa600022c1b346350c8c43fdd2e2b8c76", "message": "Fix warnings\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:01:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEyNTE4Nw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450125187", "bodyText": "suggestion: don't have to cache it here. relly entirely on PickingConfigRepositoryV2", "author": "teosarca", "createdAt": "2020-07-06T10:17:54Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/process/ProductsToPickHelper.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.process;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import de.metas.handlingunits.HuPackingInstructionsId;\n+import de.metas.handlingunits.picking.PickingCandidate;\n+import de.metas.handlingunits.picking.PickingCandidateId;\n+import de.metas.handlingunits.picking.PickingCandidateService;\n+import de.metas.handlingunits.picking.candidate.commands.PickHUResult;\n+import de.metas.handlingunits.picking.requests.PickRequest;\n+import de.metas.ui.web.pickingV2.config.PickingConfigRepositoryV2;\n+import de.metas.ui.web.pickingV2.config.PickingConfigV2;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRow;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRowsService;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import de.metas.util.GuavaCollectors;\n+import lombok.NonNull;\n+import org.adempiere.util.lang.ImmutablePair;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+@Component\n+class ProductsToPickHelper\n+{\n+\tprivate final PickingCandidateService pickingCandidateService;\n+\tprivate final ProductsToPickRowsService productsToPickRowsService;\n+\n+\tprivate final PickingConfigRepositoryV2 pickingConfigRepo;\n+\tprivate PickingConfigV2 _pickingConfig; // lazy", "originalCommit": "0550d77aa600022c1b346350c8c43fdd2e2b8c76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzNDQ5Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450134493", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-07-06T10:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEyNTE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzMDMwNw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450130307", "bodyText": "instead of ImmutablePair<DocumentId, PickingCandidate> why not having a small class like\nclass WebuiPickHUResult { DocumentId rowId; PickingCadidate pickingCandidate } ?", "author": "teosarca", "createdAt": "2020-07-06T10:28:09Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/process/ProductsToPickHelper.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.process;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import de.metas.handlingunits.HuPackingInstructionsId;\n+import de.metas.handlingunits.picking.PickingCandidate;\n+import de.metas.handlingunits.picking.PickingCandidateId;\n+import de.metas.handlingunits.picking.PickingCandidateService;\n+import de.metas.handlingunits.picking.candidate.commands.PickHUResult;\n+import de.metas.handlingunits.picking.requests.PickRequest;\n+import de.metas.ui.web.pickingV2.config.PickingConfigRepositoryV2;\n+import de.metas.ui.web.pickingV2.config.PickingConfigV2;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRow;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRowsService;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import de.metas.util.GuavaCollectors;\n+import lombok.NonNull;\n+import org.adempiere.util.lang.ImmutablePair;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+@Component\n+class ProductsToPickHelper\n+{\n+\tprivate final PickingCandidateService pickingCandidateService;\n+\tprivate final ProductsToPickRowsService productsToPickRowsService;\n+\n+\tprivate final PickingConfigRepositoryV2 pickingConfigRepo;\n+\tprivate PickingConfigV2 _pickingConfig; // lazy\n+\n+\tprotected final PickingConfigV2 getPickingConfig()\n+\t{\n+\t\tPickingConfigV2 pickingConfig = _pickingConfig;\n+\t\tif (pickingConfig == null)\n+\t\t{\n+\t\t\tpickingConfig = _pickingConfig = pickingConfigRepo.getPickingConfig();\n+\t\t}\n+\t\treturn pickingConfig;\n+\t}\n+\n+\tProductsToPickHelper(final PickingCandidateService pickingCandidateService,\n+\t\t\tfinal ProductsToPickRowsService productsToPickRowsService,\n+\t\t\tfinal PickingConfigRepositoryV2 pickingConfigRepo)\n+\t{\n+\t\tthis.pickingCandidateService = pickingCandidateService;\n+\t\tthis.productsToPickRowsService = productsToPickRowsService;\n+\t\tthis.pickingConfigRepo = pickingConfigRepo;\n+\t}\n+\n+\t@NonNull\n+\tpublic ImmutableList<ImmutablePair<DocumentId, PickingCandidate>> pick(final List<ProductsToPickRow> selectedRows)", "originalCommit": "0550d77aa600022c1b346350c8c43fdd2e2b8c76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0MjgzOA==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450142838", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-07-06T10:55:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzMDMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzMDU2Ng==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450130566", "bodyText": "minor: u can use ImmutableList.toImmutableList()", "author": "teosarca", "createdAt": "2020-07-06T10:28:43Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/process/ProductsToPickHelper.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.process;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import de.metas.handlingunits.HuPackingInstructionsId;\n+import de.metas.handlingunits.picking.PickingCandidate;\n+import de.metas.handlingunits.picking.PickingCandidateId;\n+import de.metas.handlingunits.picking.PickingCandidateService;\n+import de.metas.handlingunits.picking.candidate.commands.PickHUResult;\n+import de.metas.handlingunits.picking.requests.PickRequest;\n+import de.metas.ui.web.pickingV2.config.PickingConfigRepositoryV2;\n+import de.metas.ui.web.pickingV2.config.PickingConfigV2;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRow;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRowsService;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import de.metas.util.GuavaCollectors;\n+import lombok.NonNull;\n+import org.adempiere.util.lang.ImmutablePair;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+@Component\n+class ProductsToPickHelper\n+{\n+\tprivate final PickingCandidateService pickingCandidateService;\n+\tprivate final ProductsToPickRowsService productsToPickRowsService;\n+\n+\tprivate final PickingConfigRepositoryV2 pickingConfigRepo;\n+\tprivate PickingConfigV2 _pickingConfig; // lazy\n+\n+\tprotected final PickingConfigV2 getPickingConfig()\n+\t{\n+\t\tPickingConfigV2 pickingConfig = _pickingConfig;\n+\t\tif (pickingConfig == null)\n+\t\t{\n+\t\t\tpickingConfig = _pickingConfig = pickingConfigRepo.getPickingConfig();\n+\t\t}\n+\t\treturn pickingConfig;\n+\t}\n+\n+\tProductsToPickHelper(final PickingCandidateService pickingCandidateService,\n+\t\t\tfinal ProductsToPickRowsService productsToPickRowsService,\n+\t\t\tfinal PickingConfigRepositoryV2 pickingConfigRepo)\n+\t{\n+\t\tthis.pickingCandidateService = pickingCandidateService;\n+\t\tthis.productsToPickRowsService = productsToPickRowsService;\n+\t\tthis.pickingConfigRepo = pickingConfigRepo;\n+\t}\n+\n+\t@NonNull\n+\tpublic ImmutableList<ImmutablePair<DocumentId, PickingCandidate>> pick(final List<ProductsToPickRow> selectedRows)\n+\t{\n+\t\treturn streamRowsEligibleForPicking(selectedRows)\n+\t\t\t\t.map(row -> {\n+\t\t\t\t\tfinal PickHUResult result = pickingCandidateService.pickHU(createPickRequest(row));\n+\t\t\t\t\treturn ImmutablePair.of(row.getId(), result.getPickingCandidate());\n+\t\t\t\t})\n+\t\t\t\t.collect(GuavaCollectors.toImmutableList());\n+\t}\n+\n+\tpublic ImmutableList<ImmutablePair<DocumentId, PickingCandidate>> setPackingInstruction(final List<ProductsToPickRow> selectedRows, final HuPackingInstructionsId huPackingInstructionsId)\n+\t{\n+\n+\t\tfinal Map<PickingCandidateId, DocumentId> rowIdsByPickingCandidateId = streamRowsEligibleForPacking(selectedRows)\n+\t\t\t\t.collect(ImmutableMap.toImmutableMap(ProductsToPickRow::getPickingCandidateId, ProductsToPickRow::getId));\n+\n+\t\tfinal Set<PickingCandidateId> pickingCandidateIds = rowIdsByPickingCandidateId.keySet();\n+\t\tfinal List<PickingCandidate> pickingCandidates = pickingCandidateService.setHuPackingInstructionId(pickingCandidateIds, huPackingInstructionsId);\n+\n+\t\treturn pickingCandidates.stream()\n+\t\t\t\t.map(cand -> ImmutablePair.of(rowIdsByPickingCandidateId.get(cand.getId()), cand))\n+\t\t\t\t.collect(GuavaCollectors.toImmutableList());", "originalCommit": "0550d77aa600022c1b346350c8c43fdd2e2b8c76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzNTA2Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450135063", "bodyText": "Pretty sure i looked for that one and missed it. no idea how.\nAnyway, done.", "author": "TheBestPessimist", "createdAt": "2020-07-06T10:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzMDU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzMjEwNw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450132107", "bodyText": "not sure if it will work, but consider:\n\nmoving all methods of this class into ProductsToPickRowsService\ndelete this class", "author": "teosarca", "createdAt": "2020-07-06T10:31:48Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/process/ProductsToPickHelper.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.process;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import de.metas.handlingunits.HuPackingInstructionsId;\n+import de.metas.handlingunits.picking.PickingCandidate;\n+import de.metas.handlingunits.picking.PickingCandidateId;\n+import de.metas.handlingunits.picking.PickingCandidateService;\n+import de.metas.handlingunits.picking.candidate.commands.PickHUResult;\n+import de.metas.handlingunits.picking.requests.PickRequest;\n+import de.metas.ui.web.pickingV2.config.PickingConfigRepositoryV2;\n+import de.metas.ui.web.pickingV2.config.PickingConfigV2;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRow;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRowsService;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import de.metas.util.GuavaCollectors;\n+import lombok.NonNull;\n+import org.adempiere.util.lang.ImmutablePair;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+@Component\n+class ProductsToPickHelper", "originalCommit": "0550d77aa600022c1b346350c8c43fdd2e2b8c76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE0ODQxNw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450148417", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-07-06T11:07:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzMjEwNw=="}], "type": "inlineReview"}, {"oid": "7d09e7d5bc6bf42cdd501360b837d8bea4675d16", "url": "https://github.com/metasfresh/metasfresh/commit/7d09e7d5bc6bf42cdd501360b837d8bea4675d16", "message": "More fixes\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:39:11Z", "type": "commit"}, {"oid": "3089e3158da0410429b416a430a3ef0dd87f9afa", "url": "https://github.com/metasfresh/metasfresh/commit/3089e3158da0410429b416a430a3ef0dd87f9afa", "message": "Extract `ImmutablePair<DocumentId, PickingCandidate>` to own class\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T10:56:46Z", "type": "commit"}, {"oid": "0e29cd005bc8b261cd7189e1cd9a36e5ab73ec69", "url": "https://github.com/metasfresh/metasfresh/commit/0e29cd005bc8b261cd7189e1cd9a36e5ab73ec69", "message": "Remove `ProductsToPickHelper` and move all methods to `ProductsToPickRowsService`\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T11:04:09Z", "type": "commit"}, {"oid": "879d8a3d998033d0a7a5ed2840e16c72ace64d1f", "url": "https://github.com/metasfresh/metasfresh/commit/879d8a3d998033d0a7a5ed2840e16c72ace64d1f", "message": "Refactoring row update\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-06T11:06:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE5NDk5NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450194995", "bodyText": "pls extract Services.get(IHandlingUnitsDAO.class) to be a field", "author": "metas-ts", "createdAt": "2020-07-06T12:45:23Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/process/ProductsToPick_PickAndPackSelected.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.process;\n+\n+import com.google.common.collect.ImmutableList;\n+import de.metas.handlingunits.HuPackingInstructionsId;\n+import de.metas.handlingunits.IHandlingUnitsDAO;\n+import de.metas.handlingunits.model.I_M_HU_PI;\n+import de.metas.i18n.AdMessageKey;\n+import de.metas.process.ProcessPreconditionsResolution;\n+import de.metas.process.RunOutOfTrx;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.ProductsToPickRowsService;\n+import de.metas.ui.web.pickingV2.productsToPick.rows.WebuiPickHUResult;\n+import de.metas.util.Services;\n+import lombok.NonNull;\n+import org.adempiere.exceptions.AdempiereException;\n+import org.compiere.SpringContextHolder;\n+\n+public class ProductsToPick_PickAndPackSelected extends ProductsToPickViewBasedProcess\n+{\n+\tprivate final ProductsToPickRowsService rowsService = SpringContextHolder.instance.getBean(ProductsToPickRowsService.class);\n+\n+\tprivate final AdMessageKey MSG_SET_DEFAULT_PACKING_INSTRUCTION = AdMessageKey.of(\"de.metas.ui.web.pickingV2.productsToPick.process.ProductsToPick_PickAndPackSelected.SetDefaultPackingInstruction\");\n+\n+\t@Override\n+\tprotected ProcessPreconditionsResolution checkPreconditionsApplicable()\n+\t{\n+\t\tif (!isPickerProfile())\n+\t\t{\n+\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"only picker shall pick\");\n+\t\t}\n+\n+\t\tif (!rowsService.anyRowsEligibleForPicking(getSelectedRows()))\n+\t\t{\n+\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"select only rows that can be picked\");\n+\t\t}\n+\n+\t\treturn ProcessPreconditionsResolution.accept();\n+\t}\n+\n+\t@Override\n+\t@RunOutOfTrx\n+\tprotected String doIt()\n+\t{\n+\t\tensureDefaultPackingInstructionExists();\n+\t\tpick();\n+\t\tpack();\n+\n+\t\tinvalidateView();\n+\n+\t\treturn MSG_OK;\n+\t}\n+\n+\tprivate void pick()\n+\t{\n+\t\tfinal ImmutableList<WebuiPickHUResult> result = rowsService.pick(getSelectedRows());\n+\n+\t\tupdateViewRowFromPickingCandidate(result);\n+\t}\n+\n+\tprivate void pack()\n+\t{\n+\t\tfinal ImmutableList<WebuiPickHUResult> result = rowsService.setPackingInstruction(getSelectedRows(), getHuPackingInstructionsId());\n+\n+\t\tupdateViewRowFromPickingCandidate(result);\n+\t}\n+\n+\t@NonNull\n+\tprivate HuPackingInstructionsId getHuPackingInstructionsId()\n+\t{\n+\t\tfinal I_M_HU_PI defaultPIForPicking = Services.get(IHandlingUnitsDAO.class).retrievePIDefaultForPicking();", "originalCommit": "879d8a3d998033d0a7a5ed2840e16c72ace64d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMzAwNw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450603007", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-07-07T04:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE5NDk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMDQ2MA==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450200460", "bodyText": "we usually ignore inactive records and in the AD_TableIndex-UC's whereclauses we have IsActive='Y'.\nThat way, some old stuff can be deactivated and doesn't play any role anymore and is also left untouched.\nThere are situations where we need also inactive records, but here I don't see why we should deviate from the default approach", "author": "metas-ts", "createdAt": "2020-07-06T12:55:14Z", "path": "backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/impl/HandlingUnitsDAO.java", "diffHunk": "@@ -487,6 +487,17 @@ public I_M_HU_Item retrieveAggregatedItemOrNull(final I_M_HU hu, final I_M_HU_PI\n \t\treturn Collections.unmodifiableList(piItems);\n \t}\n \n+\t@Override\n+\t@Nullable\n+\tpublic I_M_HU_PI retrievePIDefaultForPicking()\n+\t{\n+\t\treturn Services.get(IQueryBL.class).createQueryBuilder(I_M_HU_PI.class)\n+\t\t\t\t.addEqualsFilter(I_M_HU_PI.COLUMNNAME_IsDefaultForPicking, true)\n+\t\t\t\t.create()\n+\t\t\t\t.setOnlyActiveRecords(false) // also return inactive PIs", "originalCommit": "879d8a3d998033d0a7a5ed2840e16c72ace64d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMzAzNA==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450603034", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-07-07T04:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMDQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMzUyMA==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450603520", "bodyText": "this raises a question:\n\nPI1 = active\nPI1.IsDefaultForPicking = Y\nPI1 = inactive\nPI2.IsDefaultForPicking = Y\neverything is ok so far\n\nAt this point, if i activate PI1 again, ill get an error UQ key constraint violation. Is this acceptable?", "author": "TheBestPessimist", "createdAt": "2020-07-07T04:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMDQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxMjY1MQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450612651", "bodyText": "At this point, if i activate PI1 again, ill get an error UQ key constraint violation. Is this acceptable?\n\nYou are right, that's also not great. I believe what i wrote above assumes that users don't have write acccess to the isactive flag.\nI think we can leave it here the way it is now, but the convention I described doesn't really seem valid anymore.", "author": "metas-ts", "createdAt": "2020-07-07T05:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMDQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMzM3Mg==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450203372", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (!newDefault.isDefaultForPicking())\n          \n          \n            \n            \t\t{\n          \n          \n            \n            \t\t\treturn;\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \n          \n          \n            \n            \t\tfinal I_M_HU_PI previousDefault = Services.get(IHandlingUnitsDAO.class).retrievePIDefaultForPicking();\n          \n          \n            \n            \t\tif (previousDefault != null)\n          \n          \n            \n            \t\t{\n          \n          \n            \n            \t\t\tpreviousDefault.setIsDefaultForPicking(false);\n          \n          \n            \n            \t\t\tInterfaceWrapperHelper.save(previousDefault);\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\ttry (final MDCCloseable ignored = TableRecordMDC.putTableRecordReference(newDefault))\n          \n          \n            \n            \t\t{\n          \n          \n            \n            \t\t\tif (!newDefault.isDefaultForPicking())\n          \n          \n            \n            \t\t\t{\n          \n          \n            \n            \t\t\t\treturn;\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \n          \n          \n            \n            \t\t\tfinal I_M_HU_PI previousDefault = Services.get(IHandlingUnitsDAO.class).retrievePIDefaultForPicking();\n          \n          \n            \n            \t\t\tif (previousDefault != null)\n          \n          \n            \n            \t\t\t{\n          \n          \n            \n            \t\t\t\tlogger.debug(\"M_HU_PI={} is now IsDefaultForPicking; -> Change previousDefault M_HU_PI={} to IsDefaultForPicking='N'\",\n          \n          \n            \n            \t\t\t\t\t\tnewDefault.getM_HU_PI_ID(), previousDefault.getM_HU_PI_ID());\n          \n          \n            \n            \t\t\t\tpreviousDefault.setIsDefaultForPicking(false);\n          \n          \n            \n            \t\t\t\tInterfaceWrapperHelper.save(previousDefault);\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t}", "author": "metas-ts", "createdAt": "2020-07-06T13:00:21Z", "path": "backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/model/validator/M_HU_PI.java", "diffHunk": "@@ -47,4 +46,22 @@ public void onDeleteMHUPI(final I_M_HU_PI pi)\n \t\t\tInterfaceWrapperHelper.delete(version);\n \t\t}\n \t}\n+\n+\t@ModelChange(timings = { ModelValidator.TYPE_BEFORE_NEW, ModelValidator.TYPE_BEFORE_CHANGE },\n+\t\t\tifColumnsChanged = I_M_HU_PI.COLUMNNAME_IsDefaultForPicking\n+\t)\n+\tpublic void ensureOnlyOneDefaultForPicking(@NonNull final I_M_HU_PI newDefault)\n+\t{\n+\t\tif (!newDefault.isDefaultForPicking())\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tfinal I_M_HU_PI previousDefault = Services.get(IHandlingUnitsDAO.class).retrievePIDefaultForPicking();\n+\t\tif (previousDefault != null)\n+\t\t{\n+\t\t\tpreviousDefault.setIsDefaultForPicking(false);\n+\t\t\tInterfaceWrapperHelper.save(previousDefault);\n+\t\t}", "originalCommit": "879d8a3d998033d0a7a5ed2840e16c72ace64d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MDAyMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450340021", "bodyText": "also, instead of\n\nInterfaceWrapperHelper.save(previousDefault);\n\npls introduce and use: IHandlingUnitsDAO.save(I_M_HU_PI)", "author": "teosarca", "createdAt": "2020-07-06T16:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwNDEyOA==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450604128", "bodyText": "done and done", "author": "TheBestPessimist", "createdAt": "2020-07-07T04:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMzM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MDkyOQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450340929", "bodyText": "@NonNull", "author": "teosarca", "createdAt": "2020-07-06T16:29:22Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/process/WebuiPickHUResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.process;\n+\n+import de.metas.handlingunits.picking.PickingCandidate;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import lombok.Value;\n+\n+@Value(staticConstructor = \"of\")\n+public class WebuiPickHUResult\n+{\n+\tDocumentId documentId;", "originalCommit": "3089e3158da0410429b416a430a3ef0dd87f9afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMTExMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450601111", "bodyText": "yes, i overlooked that.\ndone", "author": "TheBestPessimist", "createdAt": "2020-07-07T04:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MDkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MDk4OA==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450340988", "bodyText": "@NonNull", "author": "teosarca", "createdAt": "2020-07-06T16:29:29Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/process/WebuiPickHUResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.process;\n+\n+import de.metas.handlingunits.picking.PickingCandidate;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import lombok.Value;\n+\n+@Value(staticConstructor = \"of\")\n+public class WebuiPickHUResult\n+{\n+\tDocumentId documentId;\n+\tPickingCandidate pickingCandidate;", "originalCommit": "3089e3158da0410429b416a430a3ef0dd87f9afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMTA5Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450601093", "bodyText": "yes, i overlooked that.\ndone", "author": "TheBestPessimist", "createdAt": "2020-07-07T04:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MDk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MTUyMw==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450341523", "bodyText": "mark those fields as @NonNull", "author": "teosarca", "createdAt": "2020-07-06T16:30:23Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/pickingV2/productsToPick/rows/WebuiPickHUResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.pickingV2.productsToPick.rows;\n+\n+import de.metas.handlingunits.picking.PickingCandidate;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import lombok.Value;\n+\n+@Value(staticConstructor = \"of\")\n+public class WebuiPickHUResult\n+{\n+\tDocumentId documentId;\n+\tPickingCandidate pickingCandidate;", "originalCommit": "879d8a3d998033d0a7a5ed2840e16c72ace64d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMTA3OQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6950#discussion_r450601079", "bodyText": "yes, i overlooked that.\ndone", "author": "TheBestPessimist", "createdAt": "2020-07-07T04:13:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MTUyMw=="}], "type": "inlineReview"}, {"oid": "cd8784d9fe54b42e243cd31b2169d1fdeed6c827", "url": "https://github.com/metasfresh/metasfresh/commit/cd8784d9fe54b42e243cd31b2169d1fdeed6c827", "message": "M_HU_PI.IsDefaultForPicking: ignore active records for UQ constraint\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-07T04:33:30Z", "type": "commit"}, {"oid": "878263526ab03d70e7a08b7c38103e1cbddad182", "url": "https://github.com/metasfresh/metasfresh/commit/878263526ab03d70e7a08b7c38103e1cbddad182", "message": "Introduce `IHandlingUnitsDAO.save(I_M_HU_PI)`\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-07T04:34:44Z", "type": "commit"}, {"oid": "fe3cc5966df036589adf696b97c3614fab607690", "url": "https://github.com/metasfresh/metasfresh/commit/fe3cc5966df036589adf696b97c3614fab607690", "message": "Log changing the default for picking M_HU_PI\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-07T04:35:23Z", "type": "commit"}, {"oid": "3d58cb8a96038ebb008faa9b4a8337c3e4092541", "url": "https://github.com/metasfresh/metasfresh/commit/3d58cb8a96038ebb008faa9b4a8337c3e4092541", "message": "Add nullability\n\nhttps://github.com/metasfresh/metasfresh/issues/6949", "committedDate": "2020-07-07T04:35:38Z", "type": "commit"}]}