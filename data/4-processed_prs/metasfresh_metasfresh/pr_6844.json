{"pr_number": 6844, "pr_title": "TableCell refactoring", "pr_createdAt": "2020-06-15T10:12:07Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6844", "timeline": [{"oid": "28c2ccdeec9c60ac5da77366dec5a005103b156a", "url": "https://github.com/metasfresh/metasfresh/commit/28c2ccdeec9c60ac5da77366dec5a005103b156a", "message": "TableCell refactoring", "committedDate": "2020-06-15T10:08:39Z", "type": "commit"}, {"oid": "33012efc68354443443e7f55b817cea62f16d015", "url": "https://github.com/metasfresh/metasfresh/commit/33012efc68354443443e7f55b817cea62f16d015", "message": "Removed unused code", "committedDate": "2020-06-15T10:13:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5MDU1OA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440090558", "bodyText": "pls document what is state", "author": "teosarca", "createdAt": "2020-06-15T10:49:03Z", "path": "frontend/src/components/table/TableCell.js", "diffHunk": "@@ -1,184 +1,51 @@\n-import Moment from 'moment-timezone';\n import PropTypes from 'prop-types';\n-import numeral from 'numeral';\n import React, { PureComponent, createRef } from 'react';\n import classnames from 'classnames';\n-\n import MasterWidget from '../widget/MasterWidget';\n-import {\n-  AMOUNT_FIELD_TYPES,\n-  AMOUNT_FIELD_FORMATS_BY_PRECISION,\n-  SPECIAL_FIELD_TYPES,\n-  DATE_FIELD_TYPES,\n-  TIME_FIELD_TYPES,\n-  DATE_FIELD_FORMATS,\n-  TIME_REGEX_TEST,\n-  TIME_FORMAT,\n-} from '../../constants/Constants';\n+import { getDateFormat, fieldValueToString } from '../../utils/tableHelpers';\n+import { DATE_FIELD_FORMATS } from '../../constants/Constants';\n import WidgetTooltip from '../widget/WidgetTooltip';\n-\n class TableCell extends PureComponent {\n-  static getAmountFormatByPrecision = (precision) =>\n-    precision &&\n-    precision >= 0 &&\n-    precision < AMOUNT_FIELD_FORMATS_BY_PRECISION.length\n-      ? AMOUNT_FIELD_FORMATS_BY_PRECISION[precision]\n-      : null;\n-\n-  static getDateFormat = (fieldType) => DATE_FIELD_FORMATS[fieldType];\n-\n-  static createDate = (fieldValue, fieldType) => {\n-    if (fieldValue) {\n-      return !Moment.isMoment(fieldValue) && fieldValue.match(TIME_REGEX_TEST)\n-        ? Moment.utc(Moment.duration(fieldValue).asMilliseconds()).format(\n-            TIME_FORMAT\n-          )\n-        : Moment(fieldValue).format(TableCell.getDateFormat(fieldType));\n-    }\n-\n-    return '';\n-  };\n-\n-  static createAmount = (fieldValue, precision, isGerman) => {\n-    if (fieldValue) {\n-      const fieldValueAsNum = numeral(parseFloat(fieldValue));\n-      const numberFormat = TableCell.getAmountFormatByPrecision(precision);\n-      const returnValue = numberFormat\n-        ? fieldValueAsNum.format(numberFormat)\n-        : fieldValueAsNum.format();\n-\n-      // For German natives we want to show numbers with comma as a value separator\n-      // https://github.com/metasfresh/me03/issues/1822\n-      if (isGerman && parseFloat(returnValue) != null) {\n-        const commaRegexp = /,/g;\n-        commaRegexp.test(returnValue);\n-        const lastIdx = commaRegexp.lastIndex;\n-\n-        if (lastIdx) {\n-          return returnValue;\n-        }\n-\n-        return `${returnValue}`.replace('.', ',');\n-      }\n-\n-      return returnValue;\n-    }\n-\n-    return '';\n-  };\n-\n-  static createSpecialField = (fieldType, fieldValue) => {\n-    switch (fieldType) {\n-      case 'Color': {\n-        const style = {\n-          backgroundColor: fieldValue,\n-        };\n-        return <span className=\"widget-color-display\" style={style} />;\n-      }\n-      default:\n-        return fieldValue;\n-    }\n-  };\n-\n-  // @TODO: THIS NEEDS URGENT REFACTORING, WHY THE HECK ARE WE RETURNING\n-  // SIX DIFFERENT TYPES OF VALUES HERE ? UBER-BAD DESIGN !\n-  static fieldValueToString = (\n-    fieldValue,\n-    fieldType = 'Text',\n-    precision = null,\n-    isGerman\n-  ) => {\n-    if (fieldValue === null) {\n-      return '';\n-    }\n-\n-    switch (typeof fieldValue) {\n-      case 'object': {\n-        if (Array.isArray(fieldValue)) {\n-          return fieldValue\n-            .map((value) => TableCell.fieldValueToString(value, fieldType))\n-            .join(' - ');\n-        }\n-\n-        return DATE_FIELD_TYPES.includes(fieldType) ||\n-          TIME_FIELD_TYPES.includes(fieldType)\n-          ? TableCell.createDate(fieldValue, fieldType)\n-          : fieldValue.caption;\n-      }\n-      case 'boolean': {\n-        return fieldValue ? (\n-          <i className=\"meta-icon-checkbox-1\" />\n-        ) : (\n-          <i className=\"meta-icon-checkbox\" />\n-        );\n-      }\n-      case 'string': {\n-        if (\n-          DATE_FIELD_TYPES.includes(fieldType) ||\n-          TIME_FIELD_TYPES.includes(fieldType)\n-        ) {\n-          return TableCell.createDate(fieldValue, fieldType);\n-        } else if (AMOUNT_FIELD_TYPES.includes(fieldType)) {\n-          return TableCell.createAmount(fieldValue, precision, isGerman);\n-        } else if (SPECIAL_FIELD_TYPES.includes(fieldType)) {\n-          return TableCell.createSpecialField(fieldType, fieldValue);\n-        }\n-        return fieldValue;\n-      }\n-      default: {\n-        return fieldValue;\n-      }\n-    }\n-  };\n-\n   constructor(props) {\n     super(props);\n-\n     this.widget = createRef();\n-\n     this.clearWidgetValue = false;\n \n     this.state = {\n-      tooltipToggled: false,\n+      tooltipToggled: false, // keeping in the local state the flag for the tooltip\n     };\n   }\n \n-  UNSAFE_componentWillReceiveProps(nextProps) {\n-    const { updateRow, readonly, rowId, tdValue } = this.props;\n-    const { tdValue: nextTdValue } = nextProps;\n-    // We should avoid highlighting when whole row is exchanged (sorting)\n-    if (rowId !== nextProps.rowId) {\n-      return;\n-    }\n-\n-    if (!readonly && tdValue !== nextTdValue) {\n-      updateRow();\n-    }\n-  }\n-\n-  widgetTooltipToggle = (field, value) => {\n+  /**\n+   * @method widgetTooltipToggle\n+   * @summary Alternative method to open dropdown, in case of disabled opening on focus.\n+   * @param {string|null} value\n+   */\n+  widgetTooltipToggle = (value) => {\n     const curVal = this.state.tooltipToggled;\n     const newVal = value != null ? value : !curVal;\n \n-    this.setState({\n-      tooltipToggled: newVal,\n-    });\n+    this.setState({ tooltipToggled: newVal });\n   };\n \n+  /**\n+   * @method handleBackdropLock\n+   * @summary checks widget against widget list and calls parent onClickOutside fnct\n+   * @param {object} state", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE0NjU2Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440146563", "bodyText": "Done", "author": "petrican", "createdAt": "2020-06-15T12:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5MDU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5MzA3MQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440093071", "bodyText": "why not making sure we get the right entity when <TableCell ...> is called?", "author": "teosarca", "createdAt": "2020-06-15T10:54:23Z", "path": "frontend/src/components/table/TableCell.js", "diffHunk": "@@ -303,20 +244,7 @@ class TableCell extends PureComponent {\n           })\n         : null;\n \n-    if (cellExtended) {\n-      style = {\n-        height: extendLongText * 20,\n-      };\n-    }\n-\n-    let entityEffective;\n-    if (viewId) {\n-      entityEffective = 'documentView';\n-    } else if (mainTable) {\n-      entityEffective = 'window';\n-    } else {\n-      entityEffective = entity;\n-    }\n+    let entityEffective = this.getEntity({ viewId, mainTable, entity });", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3MzYxMA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440173610", "bodyText": "Fixed. Ditched the getEntity function and passing just the entity along", "author": "petrican", "createdAt": "2020-06-15T13:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5MzA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NDYzOA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440094638", "bodyText": "why we need activeLocale and not using our functions from utils/locale.js?", "author": "teosarca", "createdAt": "2020-06-15T10:57:24Z", "path": "frontend/src/components/table/TableCell.js", "diffHunk": "@@ -431,6 +359,7 @@ TableCell.propTypes = {\n   viewId: PropTypes.string,\n   modalVisible: PropTypes.bool,\n   docId: PropTypes.any,\n+  activeLocale: PropTypes.object,", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE0NTkwMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440145901", "bodyText": "This is because activeLocale is passed from the parent component. Also note that this was branched from a branch that did not had the changes added in utils/locale.js. This will be fixed along with the merging on which @siemiatj is currently working on.", "author": "petrican", "createdAt": "2020-06-15T12:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NDYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1MTM0Mg==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440251342", "bodyText": "@petrican @siemiatj  ok, but just to be sure.\nAt the end i would expect to have the locale\n\nonly in local store and accessed via getCurrentActiveLocale function\nor we have it in redux state and accessed from there or mapped to properties.\n\nWhat I would really avoid is having it in both places.\nPS: personally I think the best way would be to have it in redux store...", "author": "teosarca", "createdAt": "2020-06-15T15:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NDYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU3OTk3OQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440579979", "bodyText": "Ok I will sync with @siemiatj after everything is merged together to make sure there's only one way of getting the locale across the app. Thanks", "author": "petrican", "createdAt": "2020-06-16T04:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NDYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTM4Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440095383", "bodyText": "pls add unit test(s)", "author": "teosarca", "createdAt": "2020-06-15T10:58:55Z", "path": "frontend/src/utils/tableHelpers.js", "diffHunk": "@@ -62,6 +75,38 @@ export function constructorFn() {\n   };\n }\n \n+/**\n+ * @method getAmountFormatByPrecisiont\n+ * @param {string} precision\n+ **/\n+export function getAmountFormatByPrecision(precision) {", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYwNjE4OQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440606189", "bodyText": "Done", "author": "petrican", "createdAt": "2020-06-16T06:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTY2NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440095665", "bodyText": "pls add unit test(s)", "author": "teosarca", "createdAt": "2020-06-15T10:59:28Z", "path": "frontend/src/utils/tableHelpers.js", "diffHunk": "@@ -91,6 +136,146 @@ export function getSizeClass(col) {\n   }\n }\n \n+/**\n+ * @method createDate\n+ * @param {object} containing the fieldValue, fieldType and the active locale\n+ * @summary creates a Date using Moment lib formatting it with the locale passed as param\n+ */\n+export function createDate({ fieldValue, fieldType, activeLocale }) {", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5ODAyNg==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440098026", "bodyText": "also, instead of activeLocale={key, caption}, IMHO just sending the language name would be enough (i.e. activeLocale.key).", "author": "teosarca", "createdAt": "2020-06-15T11:04:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2NjA3OA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440166078", "bodyText": "// Adding a TODO in here and will make sure that after we have the utils/locale.js will adapt\nAlso added comment in the next issues such that we won't forget -> metasfresh/me03#4540 (comment)", "author": "petrican", "createdAt": "2020-06-15T13:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTc0Nw==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440095747", "bodyText": "pls add unit test(s)", "author": "teosarca", "createdAt": "2020-06-15T10:59:38Z", "path": "frontend/src/utils/tableHelpers.js", "diffHunk": "@@ -91,6 +136,146 @@ export function getSizeClass(col) {\n   }\n }\n \n+/**\n+ * @method createDate\n+ * @param {object} containing the fieldValue, fieldType and the active locale\n+ * @summary creates a Date using Moment lib formatting it with the locale passed as param\n+ */\n+export function createDate({ fieldValue, fieldType, activeLocale }) {\n+  const languageKey = activeLocale ? activeLocale.key : null;\n+  if (fieldValue) {\n+    return !Moment.isMoment(fieldValue) && fieldValue.match(TIME_REGEX_TEST)\n+      ? Moment.utc(Moment.duration(fieldValue).asMilliseconds())\n+          .locale(languageKey)\n+          .format(TIME_FORMAT)\n+      : Moment(fieldValue)\n+          .locale(languageKey)\n+          .format(getDateFormat(fieldType));\n+  }\n+\n+  return '';\n+}\n+\n+/**\n+ * @method createAmount\n+ * @param {string} fieldValue\n+ * @param {string} precision\n+ * @param {boolean} isGerman\n+ * @summary creates an amount for a given value with the desired precision and it provides special formatting\n+ *          for the case when german language is set\n+ */\n+export function createAmount(fieldValue, precision, isGerman) {", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTgyOA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440095828", "bodyText": "pls add unit test(s)", "author": "teosarca", "createdAt": "2020-06-15T10:59:49Z", "path": "frontend/src/utils/tableHelpers.js", "diffHunk": "@@ -91,6 +136,146 @@ export function getSizeClass(col) {\n   }\n }\n \n+/**\n+ * @method createDate\n+ * @param {object} containing the fieldValue, fieldType and the active locale\n+ * @summary creates a Date using Moment lib formatting it with the locale passed as param\n+ */\n+export function createDate({ fieldValue, fieldType, activeLocale }) {\n+  const languageKey = activeLocale ? activeLocale.key : null;\n+  if (fieldValue) {\n+    return !Moment.isMoment(fieldValue) && fieldValue.match(TIME_REGEX_TEST)\n+      ? Moment.utc(Moment.duration(fieldValue).asMilliseconds())\n+          .locale(languageKey)\n+          .format(TIME_FORMAT)\n+      : Moment(fieldValue)\n+          .locale(languageKey)\n+          .format(getDateFormat(fieldType));\n+  }\n+\n+  return '';\n+}\n+\n+/**\n+ * @method createAmount\n+ * @param {string} fieldValue\n+ * @param {string} precision\n+ * @param {boolean} isGerman\n+ * @summary creates an amount for a given value with the desired precision and it provides special formatting\n+ *          for the case when german language is set\n+ */\n+export function createAmount(fieldValue, precision, isGerman) {\n+  if (fieldValue) {\n+    const fieldValueAsNum = numeral(parseFloat(fieldValue));\n+    const numberFormat = getAmountFormatByPrecision(precision);\n+    const returnValue = numberFormat\n+      ? fieldValueAsNum.format(numberFormat)\n+      : fieldValueAsNum.format();\n+\n+    // For German natives we want to show numbers with comma as a value separator\n+    // https://github.com/metasfresh/me03/issues/1822\n+    if (isGerman && parseFloat(returnValue) != null) {\n+      const commaRegexp = /,/g;\n+      commaRegexp.test(returnValue);\n+      const lastIdx = commaRegexp.lastIndex;\n+\n+      if (lastIdx) {\n+        return returnValue;\n+      }\n+\n+      return `${returnValue}`.replace('.', ',');\n+    }\n+\n+    return returnValue;\n+  }\n+\n+  return '';\n+}\n+\n+/**\n+ * @method createSpecialField\n+ * @param {string}  fieldType\n+ * @param {string}  fieldValue\n+ * @summary For the special case of fieldType being of type 'Color' it will show a circle in the TableCell\n+ *          with the hex value given - fieldValue\n+ *          More details on : https://github.com/metasfresh/metasfresh-webui-frontend-legacy/issues/1603\n+ */\n+export function createSpecialField(fieldType, fieldValue) {", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYwNjIzNA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440606234", "bodyText": "Done", "author": "petrican", "createdAt": "2020-06-16T06:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTg5OA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440095898", "bodyText": "pls add unit test(s)", "author": "teosarca", "createdAt": "2020-06-15T10:59:56Z", "path": "frontend/src/utils/tableHelpers.js", "diffHunk": "@@ -91,6 +136,146 @@ export function getSizeClass(col) {\n   }\n }\n \n+/**\n+ * @method createDate\n+ * @param {object} containing the fieldValue, fieldType and the active locale\n+ * @summary creates a Date using Moment lib formatting it with the locale passed as param\n+ */\n+export function createDate({ fieldValue, fieldType, activeLocale }) {\n+  const languageKey = activeLocale ? activeLocale.key : null;\n+  if (fieldValue) {\n+    return !Moment.isMoment(fieldValue) && fieldValue.match(TIME_REGEX_TEST)\n+      ? Moment.utc(Moment.duration(fieldValue).asMilliseconds())\n+          .locale(languageKey)\n+          .format(TIME_FORMAT)\n+      : Moment(fieldValue)\n+          .locale(languageKey)\n+          .format(getDateFormat(fieldType));\n+  }\n+\n+  return '';\n+}\n+\n+/**\n+ * @method createAmount\n+ * @param {string} fieldValue\n+ * @param {string} precision\n+ * @param {boolean} isGerman\n+ * @summary creates an amount for a given value with the desired precision and it provides special formatting\n+ *          for the case when german language is set\n+ */\n+export function createAmount(fieldValue, precision, isGerman) {\n+  if (fieldValue) {\n+    const fieldValueAsNum = numeral(parseFloat(fieldValue));\n+    const numberFormat = getAmountFormatByPrecision(precision);\n+    const returnValue = numberFormat\n+      ? fieldValueAsNum.format(numberFormat)\n+      : fieldValueAsNum.format();\n+\n+    // For German natives we want to show numbers with comma as a value separator\n+    // https://github.com/metasfresh/me03/issues/1822\n+    if (isGerman && parseFloat(returnValue) != null) {\n+      const commaRegexp = /,/g;\n+      commaRegexp.test(returnValue);\n+      const lastIdx = commaRegexp.lastIndex;\n+\n+      if (lastIdx) {\n+        return returnValue;\n+      }\n+\n+      return `${returnValue}`.replace('.', ',');\n+    }\n+\n+    return returnValue;\n+  }\n+\n+  return '';\n+}\n+\n+/**\n+ * @method createSpecialField\n+ * @param {string}  fieldType\n+ * @param {string}  fieldValue\n+ * @summary For the special case of fieldType being of type 'Color' it will show a circle in the TableCell\n+ *          with the hex value given - fieldValue\n+ *          More details on : https://github.com/metasfresh/metasfresh-webui-frontend-legacy/issues/1603\n+ */\n+export function createSpecialField(fieldType, fieldValue) {\n+  switch (fieldType) {\n+    case 'Color': {\n+      const style = {\n+        backgroundColor: fieldValue,\n+      };\n+      return <span className=\"widget-color-display\" style={style} />;\n+    }\n+    default:\n+      return fieldValue;\n+  }\n+}\n+\n+/**\n+ * @method fieldValueToString\n+ * @param {string} fieldValue\n+ * @param {string} fieldType\n+ * @param {string} precision\n+ * @param {boolean} isGerman\n+ * @param {string} activeLocale\n+ * @summary This is a patch function to mangle the desired output used at table level within TableCell, Filters components\n+ */\n+export function fieldValueToString({", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYwNjI2MQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440606261", "bodyText": "Done", "author": "petrican", "createdAt": "2020-06-16T06:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NTg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NzA5MQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440097091", "bodyText": "pls, move this line near the place where it is first used.\nAlso, not sure if it would bring any benefit, but this value can be calculated once on construction time instead of each time on render().", "author": "teosarca", "createdAt": "2020-06-15T11:02:22Z", "path": "frontend/src/components/table/TableCell.js", "diffHunk": "@@ -259,35 +219,16 @@ class TableCell extends PureComponent {\n       viewId,\n       modalVisible,\n       onClickOutside,\n-      isGerman,\n     } = this.props;\n     const widgetData = getWidgetData(item, isEditable, supportFieldEdit);\n-\n     const docId = `${this.props.docId}`;\n     const { tooltipToggled } = this.state;\n-    const tdValue = !isEdited\n-      ? TableCell.fieldValueToString(\n-          widgetData[0].value,\n-          item.widgetType,\n-          widgetData[0].precision,\n-          isGerman\n-        )\n-      : null;\n-    const description =\n-      widgetData[0].value && widgetData[0].value.description\n-        ? widgetData[0].value.description\n-        : tdValue;\n-    let tdTitle =\n-      item.widgetType === 'YesNo' ||\n-      item.widgetType === 'Switch' ||\n-      item.widgetType === 'Color'\n-        ? ''\n-        : description;\n+    const tdValue = this.getTdValue(widgetData);\n+    const description = this.getDescription({ widgetData, tdValue });\n+    let tdTitle = this.getTdTitle({ item, description });\n     const isOpenDatePicker = isEdited && item.widgetType === 'Date';\n-    const isDateField = DATE_FIELD_FORMATS[item.widgetType]\n-      ? TableCell.getDateFormat(item.widgetType)\n-      : false;\n-    let style = {};\n+    const isDateField = this.checkIfDateField({ item });", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE1OTEzNA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440159134", "bodyText": "As discussed. Props change", "author": "petrican", "createdAt": "2020-06-15T13:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NzA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5ODc5Mg==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440098792", "bodyText": "pls document what value is", "author": "teosarca", "createdAt": "2020-06-15T11:06:01Z", "path": "frontend/src/components/table/TableCell.js", "diffHunk": "@@ -1,184 +1,51 @@\n-import Moment from 'moment-timezone';\n import PropTypes from 'prop-types';\n-import numeral from 'numeral';\n import React, { PureComponent, createRef } from 'react';\n import classnames from 'classnames';\n-\n import MasterWidget from '../widget/MasterWidget';\n-import {\n-  AMOUNT_FIELD_TYPES,\n-  AMOUNT_FIELD_FORMATS_BY_PRECISION,\n-  SPECIAL_FIELD_TYPES,\n-  DATE_FIELD_TYPES,\n-  TIME_FIELD_TYPES,\n-  DATE_FIELD_FORMATS,\n-  TIME_REGEX_TEST,\n-  TIME_FORMAT,\n-} from '../../constants/Constants';\n+import { getDateFormat, fieldValueToString } from '../../utils/tableHelpers';\n+import { DATE_FIELD_FORMATS } from '../../constants/Constants';\n import WidgetTooltip from '../widget/WidgetTooltip';\n-\n class TableCell extends PureComponent {\n-  static getAmountFormatByPrecision = (precision) =>\n-    precision &&\n-    precision >= 0 &&\n-    precision < AMOUNT_FIELD_FORMATS_BY_PRECISION.length\n-      ? AMOUNT_FIELD_FORMATS_BY_PRECISION[precision]\n-      : null;\n-\n-  static getDateFormat = (fieldType) => DATE_FIELD_FORMATS[fieldType];\n-\n-  static createDate = (fieldValue, fieldType) => {\n-    if (fieldValue) {\n-      return !Moment.isMoment(fieldValue) && fieldValue.match(TIME_REGEX_TEST)\n-        ? Moment.utc(Moment.duration(fieldValue).asMilliseconds()).format(\n-            TIME_FORMAT\n-          )\n-        : Moment(fieldValue).format(TableCell.getDateFormat(fieldType));\n-    }\n-\n-    return '';\n-  };\n-\n-  static createAmount = (fieldValue, precision, isGerman) => {\n-    if (fieldValue) {\n-      const fieldValueAsNum = numeral(parseFloat(fieldValue));\n-      const numberFormat = TableCell.getAmountFormatByPrecision(precision);\n-      const returnValue = numberFormat\n-        ? fieldValueAsNum.format(numberFormat)\n-        : fieldValueAsNum.format();\n-\n-      // For German natives we want to show numbers with comma as a value separator\n-      // https://github.com/metasfresh/me03/issues/1822\n-      if (isGerman && parseFloat(returnValue) != null) {\n-        const commaRegexp = /,/g;\n-        commaRegexp.test(returnValue);\n-        const lastIdx = commaRegexp.lastIndex;\n-\n-        if (lastIdx) {\n-          return returnValue;\n-        }\n-\n-        return `${returnValue}`.replace('.', ',');\n-      }\n-\n-      return returnValue;\n-    }\n-\n-    return '';\n-  };\n-\n-  static createSpecialField = (fieldType, fieldValue) => {\n-    switch (fieldType) {\n-      case 'Color': {\n-        const style = {\n-          backgroundColor: fieldValue,\n-        };\n-        return <span className=\"widget-color-display\" style={style} />;\n-      }\n-      default:\n-        return fieldValue;\n-    }\n-  };\n-\n-  // @TODO: THIS NEEDS URGENT REFACTORING, WHY THE HECK ARE WE RETURNING\n-  // SIX DIFFERENT TYPES OF VALUES HERE ? UBER-BAD DESIGN !\n-  static fieldValueToString = (\n-    fieldValue,\n-    fieldType = 'Text',\n-    precision = null,\n-    isGerman\n-  ) => {\n-    if (fieldValue === null) {\n-      return '';\n-    }\n-\n-    switch (typeof fieldValue) {\n-      case 'object': {\n-        if (Array.isArray(fieldValue)) {\n-          return fieldValue\n-            .map((value) => TableCell.fieldValueToString(value, fieldType))\n-            .join(' - ');\n-        }\n-\n-        return DATE_FIELD_TYPES.includes(fieldType) ||\n-          TIME_FIELD_TYPES.includes(fieldType)\n-          ? TableCell.createDate(fieldValue, fieldType)\n-          : fieldValue.caption;\n-      }\n-      case 'boolean': {\n-        return fieldValue ? (\n-          <i className=\"meta-icon-checkbox-1\" />\n-        ) : (\n-          <i className=\"meta-icon-checkbox\" />\n-        );\n-      }\n-      case 'string': {\n-        if (\n-          DATE_FIELD_TYPES.includes(fieldType) ||\n-          TIME_FIELD_TYPES.includes(fieldType)\n-        ) {\n-          return TableCell.createDate(fieldValue, fieldType);\n-        } else if (AMOUNT_FIELD_TYPES.includes(fieldType)) {\n-          return TableCell.createAmount(fieldValue, precision, isGerman);\n-        } else if (SPECIAL_FIELD_TYPES.includes(fieldType)) {\n-          return TableCell.createSpecialField(fieldType, fieldValue);\n-        }\n-        return fieldValue;\n-      }\n-      default: {\n-        return fieldValue;\n-      }\n-    }\n-  };\n-\n   constructor(props) {\n     super(props);\n-\n     this.widget = createRef();\n-\n     this.clearWidgetValue = false;\n \n     this.state = {\n-      tooltipToggled: false,\n+      tooltipToggled: false, // keeping in the local state the flag for the tooltip\n     };\n   }\n \n-  UNSAFE_componentWillReceiveProps(nextProps) {\n-    const { updateRow, readonly, rowId, tdValue } = this.props;\n-    const { tdValue: nextTdValue } = nextProps;\n-    // We should avoid highlighting when whole row is exchanged (sorting)\n-    if (rowId !== nextProps.rowId) {\n-      return;\n-    }\n-\n-    if (!readonly && tdValue !== nextTdValue) {\n-      updateRow();\n-    }\n-  }\n-\n-  widgetTooltipToggle = (field, value) => {\n+  /**\n+   * @method widgetTooltipToggle\n+   * @summary Alternative method to open dropdown, in case of disabled opening on focus.\n+   * @param {string|null} value", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDk1Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440100953", "bodyText": "I think this was == null because it's a falsy value check, and not a strict comparison. So worth checking what clearValue can be called with to be sure it's ok to make this change.", "author": "siemiatj", "createdAt": "2020-06-15T11:10:27Z", "path": "frontend/src/components/table/TableCell.js", "diffHunk": "@@ -224,15 +104,95 @@ class TableCell extends PureComponent {\n     } = this.props;\n     const widgetData = getWidgetData(item, isEditable, supportFieldEdit);\n \n-    if (isEditable) {\n-      handleDoubleClick(e, property, true, widgetData[0]);\n-    }\n+    isEditable && handleDoubleClick(e, property, true, widgetData[0]);\n   };\n \n+  /**\n+   * @method clearValue\n+   * @summary Set `clearWidgetValue` value based on a given `reset` param\n+   * {string|null} reset\n+   */\n   clearValue = (reset) => {\n-    this.clearWidgetValue = reset == null ? true : false;\n+    this.clearWidgetValue = reset === null ? true : false;", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNzUwOA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440137508", "bodyText": "Reverting as you are right. When is undefined  it this.clearWidgetValue will be true. I've checked the calls in the TableItem", "author": "petrican", "createdAt": "2020-06-15T12:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDk1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0NzIwMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440247201", "bodyText": "@petrican  why not documenting this inside clearValue function because it seems it wasn't obvious.\nAlso I think it would make sense to document the reset parameter.", "author": "teosarca", "createdAt": "2020-06-15T15:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDk1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4MTc1OA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440581758", "bodyText": "Done.", "author": "petrican", "createdAt": "2020-06-16T04:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExMTczMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440111731", "bodyText": "is there a type event ?", "author": "siemiatj", "createdAt": "2020-06-15T11:32:58Z", "path": "frontend/src/components/table/TableCell.js", "diffHunk": "@@ -1,184 +1,51 @@\n-import Moment from 'moment-timezone';\n import PropTypes from 'prop-types';\n-import numeral from 'numeral';\n import React, { PureComponent, createRef } from 'react';\n import classnames from 'classnames';\n-\n import MasterWidget from '../widget/MasterWidget';\n-import {\n-  AMOUNT_FIELD_TYPES,\n-  AMOUNT_FIELD_FORMATS_BY_PRECISION,\n-  SPECIAL_FIELD_TYPES,\n-  DATE_FIELD_TYPES,\n-  TIME_FIELD_TYPES,\n-  DATE_FIELD_FORMATS,\n-  TIME_REGEX_TEST,\n-  TIME_FORMAT,\n-} from '../../constants/Constants';\n+import { getDateFormat, fieldValueToString } from '../../utils/tableHelpers';\n+import { DATE_FIELD_FORMATS } from '../../constants/Constants';\n import WidgetTooltip from '../widget/WidgetTooltip';\n-\n class TableCell extends PureComponent {\n-  static getAmountFormatByPrecision = (precision) =>\n-    precision &&\n-    precision >= 0 &&\n-    precision < AMOUNT_FIELD_FORMATS_BY_PRECISION.length\n-      ? AMOUNT_FIELD_FORMATS_BY_PRECISION[precision]\n-      : null;\n-\n-  static getDateFormat = (fieldType) => DATE_FIELD_FORMATS[fieldType];\n-\n-  static createDate = (fieldValue, fieldType) => {\n-    if (fieldValue) {\n-      return !Moment.isMoment(fieldValue) && fieldValue.match(TIME_REGEX_TEST)\n-        ? Moment.utc(Moment.duration(fieldValue).asMilliseconds()).format(\n-            TIME_FORMAT\n-          )\n-        : Moment(fieldValue).format(TableCell.getDateFormat(fieldType));\n-    }\n-\n-    return '';\n-  };\n-\n-  static createAmount = (fieldValue, precision, isGerman) => {\n-    if (fieldValue) {\n-      const fieldValueAsNum = numeral(parseFloat(fieldValue));\n-      const numberFormat = TableCell.getAmountFormatByPrecision(precision);\n-      const returnValue = numberFormat\n-        ? fieldValueAsNum.format(numberFormat)\n-        : fieldValueAsNum.format();\n-\n-      // For German natives we want to show numbers with comma as a value separator\n-      // https://github.com/metasfresh/me03/issues/1822\n-      if (isGerman && parseFloat(returnValue) != null) {\n-        const commaRegexp = /,/g;\n-        commaRegexp.test(returnValue);\n-        const lastIdx = commaRegexp.lastIndex;\n-\n-        if (lastIdx) {\n-          return returnValue;\n-        }\n-\n-        return `${returnValue}`.replace('.', ',');\n-      }\n-\n-      return returnValue;\n-    }\n-\n-    return '';\n-  };\n-\n-  static createSpecialField = (fieldType, fieldValue) => {\n-    switch (fieldType) {\n-      case 'Color': {\n-        const style = {\n-          backgroundColor: fieldValue,\n-        };\n-        return <span className=\"widget-color-display\" style={style} />;\n-      }\n-      default:\n-        return fieldValue;\n-    }\n-  };\n-\n-  // @TODO: THIS NEEDS URGENT REFACTORING, WHY THE HECK ARE WE RETURNING\n-  // SIX DIFFERENT TYPES OF VALUES HERE ? UBER-BAD DESIGN !\n-  static fieldValueToString = (\n-    fieldValue,\n-    fieldType = 'Text',\n-    precision = null,\n-    isGerman\n-  ) => {\n-    if (fieldValue === null) {\n-      return '';\n-    }\n-\n-    switch (typeof fieldValue) {\n-      case 'object': {\n-        if (Array.isArray(fieldValue)) {\n-          return fieldValue\n-            .map((value) => TableCell.fieldValueToString(value, fieldType))\n-            .join(' - ');\n-        }\n-\n-        return DATE_FIELD_TYPES.includes(fieldType) ||\n-          TIME_FIELD_TYPES.includes(fieldType)\n-          ? TableCell.createDate(fieldValue, fieldType)\n-          : fieldValue.caption;\n-      }\n-      case 'boolean': {\n-        return fieldValue ? (\n-          <i className=\"meta-icon-checkbox-1\" />\n-        ) : (\n-          <i className=\"meta-icon-checkbox\" />\n-        );\n-      }\n-      case 'string': {\n-        if (\n-          DATE_FIELD_TYPES.includes(fieldType) ||\n-          TIME_FIELD_TYPES.includes(fieldType)\n-        ) {\n-          return TableCell.createDate(fieldValue, fieldType);\n-        } else if (AMOUNT_FIELD_TYPES.includes(fieldType)) {\n-          return TableCell.createAmount(fieldValue, precision, isGerman);\n-        } else if (SPECIAL_FIELD_TYPES.includes(fieldType)) {\n-          return TableCell.createSpecialField(fieldType, fieldValue);\n-        }\n-        return fieldValue;\n-      }\n-      default: {\n-        return fieldValue;\n-      }\n-    }\n-  };\n-\n   constructor(props) {\n     super(props);\n-\n     this.widget = createRef();\n-\n     this.clearWidgetValue = false;\n \n     this.state = {\n-      tooltipToggled: false,\n+      tooltipToggled: false, // keeping in the local state the flag for the tooltip\n     };\n   }\n \n-  UNSAFE_componentWillReceiveProps(nextProps) {\n-    const { updateRow, readonly, rowId, tdValue } = this.props;\n-    const { tdValue: nextTdValue } = nextProps;\n-    // We should avoid highlighting when whole row is exchanged (sorting)\n-    if (rowId !== nextProps.rowId) {\n-      return;\n-    }\n-\n-    if (!readonly && tdValue !== nextTdValue) {\n-      updateRow();\n-    }\n-  }\n-\n-  widgetTooltipToggle = (field, value) => {\n+  /**\n+   * @method widgetTooltipToggle\n+   * @summary Alternative method to open dropdown, in case of disabled opening on focus.\n+   * @param {string|null} value\n+   */\n+  widgetTooltipToggle = (value) => {\n     const curVal = this.state.tooltipToggled;\n     const newVal = value != null ? value : !curVal;\n \n-    this.setState({\n-      tooltipToggled: newVal,\n-    });\n+    this.setState({ tooltipToggled: newVal });\n   };\n \n+  /**\n+   * @method handleBackdropLock\n+   * @summary checks widget against widget list and calls parent onClickOutside fnct\n+   * @param {object} state\n+   */\n   handleBackdropLock = (state) => {\n     const { item } = this.props;\n-\n-    if (\n-      !['ProductAttributes', 'Attributes', 'List', 'Lookup'].includes(\n-        item.widgetType\n-      )\n-    ) {\n-      if (!state) {\n-        this.props.onClickOutside();\n-      }\n+    const widgetsList = ['ProductAttributes', 'Attributes', 'List', 'Lookup'];\n+    if (!widgetsList.includes(item.widgetType)) {\n+      !state && this.props.onClickOutside();\n     }\n   };\n \n+  /**\n+   * @method handleKeyDown\n+   * @summary Key down function handler\n+   * @param {object} e", "originalCommit": "33012efc68354443443e7f55b817cea62f16d015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExNzgyMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440117821", "bodyText": "this is the corresponding event from a text input for example when you change a value within a table cell by typing something in that specific cell.", "author": "petrican", "createdAt": "2020-06-15T11:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExMTczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0ODQ3MA==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440248470", "bodyText": "@petrican  why not writing this info as @param e documentation?", "author": "teosarca", "createdAt": "2020-06-15T15:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExMTczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU3Njk0Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6844#discussion_r440576943", "bodyText": "Ok I'll add it in there. Thanks", "author": "petrican", "createdAt": "2020-06-16T04:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExMTczMQ=="}], "type": "inlineReview"}, {"oid": "28bc46bb15c88404f6877e6b20eb296825ae9137", "url": "https://github.com/metasfresh/metasfresh/commit/28bc46bb15c88404f6877e6b20eb296825ae9137", "message": "Reverting to == as it was intended like thats afais", "committedDate": "2020-06-15T12:24:59Z", "type": "commit"}, {"oid": "0f03d25f2660f93aed4ad869f7e4183c2baa2f93", "url": "https://github.com/metasfresh/metasfresh/commit/0f03d25f2660f93aed4ad869f7e4183c2baa2f93", "message": "Doc state", "committedDate": "2020-06-15T12:41:04Z", "type": "commit"}, {"oid": "acbdc8a0f3224a45471bac15a23978734fb3e612", "url": "https://github.com/metasfresh/metasfresh/commit/acbdc8a0f3224a45471bac15a23978734fb3e612", "message": "Added doc", "committedDate": "2020-06-15T13:06:02Z", "type": "commit"}, {"oid": "6fba32fe8944b541889fed9401e27d52d01cac7c", "url": "https://github.com/metasfresh/metasfresh/commit/6fba32fe8944b541889fed9401e27d52d01cac7c", "message": "Ditch entityEffective and use just the passed entity", "committedDate": "2020-06-15T13:24:47Z", "type": "commit"}, {"oid": "6da07bc58c31a3eab7d39402e0b1835feeb3694a", "url": "https://github.com/metasfresh/metasfresh/commit/6da07bc58c31a3eab7d39402e0b1835feeb3694a", "message": "Added some more doc and unit tests", "committedDate": "2020-06-16T05:24:23Z", "type": "commit"}, {"oid": "051331551d16d6fc213af79514d20e365031727e", "url": "https://github.com/metasfresh/metasfresh/commit/051331551d16d6fc213af79514d20e365031727e", "message": "Completed the unit tests", "committedDate": "2020-06-16T06:06:11Z", "type": "commit"}]}