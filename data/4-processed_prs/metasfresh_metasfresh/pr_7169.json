{"pr_number": 7169, "pr_title": "Forecast: set datepromised if not exists", "pr_createdAt": "2020-08-20T09:24:57Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/7169", "timeline": [{"oid": "61cb5c9e1c62246987fa0570c23bbde5c3f388bd", "url": "https://github.com/metasfresh/metasfresh/commit/61cb5c9e1c62246987fa0570c23bbde5c3f388bd", "message": "Forecast: set datepromised if not exists\n\nhttps://github.com/metasfresh/metasfresh/issues/3856", "committedDate": "2020-08-20T09:23:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3NDYxMw==", "url": "https://github.com/metasfresh/metasfresh/pull/7169#discussion_r473874613", "bodyText": "u think you need to do sth like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                SELECT startdate::Timestamp\n          \n          \n            \n                FROM c_period p\n          \n          \n            \n                WHERE p.c_period_id = m_forecast.c_period_id\n          \n          \n            \n            \n          \n          \n            \n                UNION\n          \n          \n            \n            \n          \n          \n            \n                SELECT to_timestamp(fiscalyear, 'YYYY') /* eg. 2020.01.01 */\n          \n          \n            \n                FROM c_year y\n          \n          \n            \n                WHERE y.c_year_id = m_forecast.m_forecast_id\n          \n          \n            \n            \n          \n          \n            \n                LIMIT 1\n          \n          \n            \n                SELECT 1 as seq, startdate::Timestamp\n          \n          \n            \n                FROM c_period p\n          \n          \n            \n                WHERE p.c_period_id = m_forecast.c_period_id\n          \n          \n            \n            \n          \n          \n            \n                UNION\n          \n          \n            \n            \n          \n          \n            \n                SELECT 2, to_timestamp(fiscalyear, 'YYYY') /* eg. 2020.01.01 */\n          \n          \n            \n                FROM c_year y\n          \n          \n            \n                WHERE y.c_year_id = m_forecast.m_forecast_id <-- this seems wrong\n          \n          \n            \n                \n          \n          \n            \n                UNION \n          \n          \n            \n                \n          \n          \n            \n                SELECT 3, '2010-01-01'\n          \n          \n            \n                \n          \n          \n            \n                ORDER BY seq\n          \n          \n            \n                LIMIT 1\n          \n      \n    \n    \n  \n\n\nto make sure your subselect prefers the ones with a period_id\nm_forecast.c_year_id is not mandatory, so AFAIU we need a 3rd fallback", "author": "metas-ts", "createdAt": "2020-08-20T10:46:20Z", "path": "backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5565380_sys_gh3856_setM_Forecast.DatePromissed_IfNotExists.sql", "diffHunk": "@@ -0,0 +1,18 @@\n+UPDATE m_forecast\n+SET datepromised = (\n+    SELECT startdate::Timestamp\n+    FROM c_period p\n+    WHERE p.c_period_id = m_forecast.c_period_id\n+\n+    UNION\n+\n+    SELECT to_timestamp(fiscalyear, 'YYYY') /* eg. 2020.01.01 */\n+    FROM c_year y\n+    WHERE y.c_year_id = m_forecast.m_forecast_id\n+\n+    LIMIT 1", "originalCommit": "61cb5c9e1c62246987fa0570c23bbde5c3f388bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk4NTU2NA==", "url": "https://github.com/metasfresh/metasfresh/pull/7169#discussion_r473985564", "bodyText": "Fixed", "author": "TheBestPessimist", "createdAt": "2020-08-20T13:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3NDYxMw=="}], "type": "inlineReview"}, {"oid": "4d4692bf8adfccaba1d53381b452aeaa307b07c0", "url": "https://github.com/metasfresh/metasfresh/commit/4d4692bf8adfccaba1d53381b452aeaa307b07c0", "message": "More options, proper ordering\n\nhttps://github.com/metasfresh/metasfresh/issues/3856", "committedDate": "2020-08-20T13:46:00Z", "type": "commit"}]}