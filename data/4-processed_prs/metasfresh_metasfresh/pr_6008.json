{"pr_number": 6008, "pr_title": "#409 Aded UOM conversion check when adding a new price to a product.", "pr_createdAt": "2020-01-08T13:43:47Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6008", "timeline": [{"oid": "af3773d5649dafcccd7f74c8766fb3b1b0ed106d", "url": "https://github.com/metasfresh/metasfresh/commit/af3773d5649dafcccd7f74c8766fb3b1b0ed106d", "message": "#409 Aded UOM conversion check when adding a new price to a product.", "committedDate": "2020-01-08T13:35:26Z", "type": "commit"}, {"oid": "7c3e2984ef600faa77c31f6c48744814d078a37d", "url": "https://github.com/metasfresh/metasfresh/commit/7c3e2984ef600faa77c31f6c48744814d078a37d", "message": "#409 Removed unnecessary import.", "committedDate": "2020-01-08T13:59:54Z", "type": "commit"}, {"oid": "1bde99f829e71649f00b61f19f9c5a12d5563f3e", "url": "https://github.com/metasfresh/metasfresh/commit/1bde99f829e71649f00b61f19f9c5a12d5563f3e", "message": "#409 Changed ModelChange configuration to the check", "committedDate": "2020-01-08T15:18:37Z", "type": "commit"}, {"oid": "ce6fd776cfb1f0b959d466934e612137c0d46e6e", "url": "https://github.com/metasfresh/metasfresh/commit/ce6fd776cfb1f0b959d466934e612137c0d46e6e", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-08T15:34:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU4NDg0NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6008#discussion_r364584845", "bodyText": "Create an AD_Message record with translations (we'll need en_US, de_DE and de_CH) and use IMsg (Services.get(IMsg.class)) to get a translatable string instance.\nPassing hardcoded strings  generally doesn't make sense for user-errors", "author": "metas-ts", "createdAt": "2020-01-09T07:07:50Z", "path": "de.metas.business/src/main/java/de/metas/pricing/service/ProductPrices.java", "diffHunk": "@@ -124,6 +127,38 @@ public static void assertMainProductPriceIsNotDuplicate(final I_M_ProductPrice p\n \t\tgetFirstOrThrowExceptionIfMoreThanOne(allMainPrices);\n \t}\n \n+\tpublic static void assertUomConversionExists(final I_M_ProductPrice productPrice)\n+\t{\n+\t\tif (productPrice == null || !productPrice.isActive())\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tif (productPrice.isInvalidPrice())\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tfinal IProductDAO productDAO = Services.get(IProductDAO.class);\n+\t\tfinal org.compiere.model.I_M_Product product = productDAO.getById(productPrice.getM_Product_ID());\n+\n+\t\tif (UomId.ofRepoId(product.getC_UOM_ID()).equals(UomId.ofRepoId(productPrice.getC_UOM_ID())))\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tfinal IUOMConversionDAO uomConversionRepo = Services.get(IUOMConversionDAO.class);\n+\t\tfinal ProductId productId = ProductId.ofRepoId(productPrice.getM_Product_ID());\n+\n+\t\tUOMConversionsMap conversionsMap = uomConversionRepo.getProductConversions(productId);\n+\n+\t\tif (conversionsMap.getRateIfExists(UomId.ofRepoId(product.getC_UOM_ID()), UomId.ofRepoId(productPrice.getC_UOM_ID())).isPresent())\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\t\tthrow new AdempiereException(\"UOM Conversion to the selected UOM doesn't exist\").markAsUserValidationError();", "originalCommit": "ce6fd776cfb1f0b959d466934e612137c0d46e6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY5Nzc3NA==", "url": "https://github.com/metasfresh/metasfresh/pull/6008#discussion_r364697774", "bodyText": "fully agree", "author": "teosarca", "createdAt": "2020-01-09T11:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU4NDg0NQ=="}], "type": "inlineReview"}, {"oid": "23261c41744eb50ebf54456e9080c80cb2461a18", "url": "https://github.com/metasfresh/metasfresh/commit/23261c41744eb50ebf54456e9080c80cb2461a18", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-09T09:12:36Z", "type": "commit"}, {"oid": "b9e3054d9f37718448dc56b89ca925ec8bed80bf", "url": "https://github.com/metasfresh/metasfresh/commit/b9e3054d9f37718448dc56b89ca925ec8bed80bf", "message": "#409 Removed hardcoded Error message. Added translated one in AD_Message.", "committedDate": "2020-01-09T12:29:47Z", "type": "commit"}, {"oid": "616a3c263e3ee0267f9bd8ff9cf5bcdfaba187f3", "url": "https://github.com/metasfresh/metasfresh/commit/616a3c263e3ee0267f9bd8ff9cf5bcdfaba187f3", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-09T12:30:33Z", "type": "commit"}, {"oid": "301b4559cf80a833de42145e9ba5de80d9ed1a73", "url": "https://github.com/metasfresh/metasfresh/commit/301b4559cf80a833de42145e9ba5de80d9ed1a73", "message": "#409 Removed unnecessary duplicate product check.", "committedDate": "2020-01-09T13:00:29Z", "type": "commit"}, {"oid": "2a4cc7bbbea9ed4219f2c6ee8cb82c722a742f01", "url": "https://github.com/metasfresh/metasfresh/commit/2a4cc7bbbea9ed4219f2c6ee8cb82c722a742f01", "message": "#409 Removed unnecessary duplicate product check.", "committedDate": "2020-01-09T13:01:31Z", "type": "commit"}, {"oid": "088ad39a251539b0cfe10319e5446e07a73965c6", "url": "https://github.com/metasfresh/metasfresh/commit/088ad39a251539b0cfe10319e5446e07a73965c6", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-09T13:46:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc5ODk2OQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6008#discussion_r364798969", "bodyText": "why were the checks here unnecessary? remember, you never know who is going to call this public static method.\nMaybe you can annotate the productPrice parameter with @NonNull (lombok!), but i thik you should check still for IsActive and IsValid", "author": "metas-ts", "createdAt": "2020-01-09T15:23:22Z", "path": "de.metas.business/src/main/java/de/metas/pricing/service/ProductPrices.java", "diffHunk": "@@ -124,6 +130,29 @@ public static void assertMainProductPriceIsNotDuplicate(final I_M_ProductPrice p\n \t\tgetFirstOrThrowExceptionIfMoreThanOne(allMainPrices);\n \t}\n \n+\tpublic static void assertUomConversionExists(final I_M_ProductPrice productPrice)\n+\t{\n+\t\tfinal IProductDAO productDAO = Services.get(IProductDAO.class);", "originalCommit": "088ad39a251539b0cfe10319e5446e07a73965c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDgwMDc1NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6008#discussion_r364800755", "bodyText": "As it's only called in one place right now, it gets called at the same time as the assert before it (the one that checks that the product price is not duplicate), and the checks are removed are already gone through there.\nBut sure, for further use cases or the case the assert that checks the price is not duplicate gets changed I could add them to be there.", "author": "dragospodariu96", "createdAt": "2020-01-09T15:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc5ODk2OQ=="}], "type": "inlineReview"}, {"oid": "b603656fe9291a37d3726c244bf42c284cc73858", "url": "https://github.com/metasfresh/metasfresh/commit/b603656fe9291a37d3726c244bf42c284cc73858", "message": "#409 Added back the checks.", "committedDate": "2020-01-09T15:35:02Z", "type": "commit"}, {"oid": "c6b3f21e30eb06b65ae056b672bf081e0eaa848e", "url": "https://github.com/metasfresh/metasfresh/commit/c6b3f21e30eb06b65ae056b672bf081e0eaa848e", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-09T15:35:37Z", "type": "commit"}, {"oid": "49a24fee829d1ff0b849e5f2359d3f939ea191d9", "url": "https://github.com/metasfresh/metasfresh/commit/49a24fee829d1ff0b849e5f2359d3f939ea191d9", "message": "#5895 Added ifcolumnschanged conditions to the @ModelChange annotation.", "committedDate": "2020-01-10T08:59:03Z", "type": "commit"}, {"oid": "43299dd12da06e5f057080ced12ca4e7d531d12e", "url": "https://github.com/metasfresh/metasfresh/commit/43299dd12da06e5f057080ced12ca4e7d531d12e", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-10T09:02:38Z", "type": "commit"}, {"oid": "0d7697ae3a9fac2b1c740f270adb6a9c4d5f0fd9", "url": "https://github.com/metasfresh/metasfresh/commit/0d7697ae3a9fac2b1c740f270adb6a9c4d5f0fd9", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-10T10:03:06Z", "type": "commit"}, {"oid": "3d78cbf30b6db1e28a10086ff8faec4d650d7383", "url": "https://github.com/metasfresh/metasfresh/commit/3d78cbf30b6db1e28a10086ff8faec4d650d7383", "message": "Merge branch 'master' into gh409", "committedDate": "2020-01-10T15:44:21Z", "type": "commit"}]}