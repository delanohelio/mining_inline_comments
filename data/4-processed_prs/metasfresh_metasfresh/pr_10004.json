{"pr_number": 10004, "pr_title": "Gh10001 Compute taxes based on C_Invoice.M_Warehouse_ID", "pr_createdAt": "2020-09-23T22:37:41Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/10004", "timeline": [{"oid": "5605a3b09b01fe58c483ce3d0bcb685adef27956", "url": "https://github.com/metasfresh/metasfresh/commit/5605a3b09b01fe58c483ce3d0bcb685adef27956", "message": "#10001 Warehouse_ID in C_Invoice\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-23T21:46:04Z", "type": "commit"}, {"oid": "7463a17d0f01a2dd6ee7c66133f6ae9e2e95e86f", "url": "https://github.com/metasfresh/metasfresh/commit/7463a17d0f01a2dd6ee7c66133f6ae9e2e95e86f", "message": "#10001 compute taxes based on invoice warehouse if set\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-23T21:46:38Z", "type": "commit"}, {"oid": "1281b3ea248e73cfc2f82056828704c46209d3d5", "url": "https://github.com/metasfresh/metasfresh/commit/1281b3ea248e73cfc2f82056828704c46209d3d5", "message": "#10001 improve interceptor\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-23T22:26:07Z", "type": "commit"}, {"oid": "4ea0a496fb4df61ecd2cbef4a1b32a318fc789b0", "url": "https://github.com/metasfresh/metasfresh/commit/4ea0a496fb4df61ecd2cbef4a1b32a318fc789b0", "message": "#10001 take warehouse form invoice in this old callout too\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-23T22:36:43Z", "type": "commit"}, {"oid": "980c191607bd0b36611883f48869266e5244febf", "url": "https://github.com/metasfresh/metasfresh/commit/980c191607bd0b36611883f48869266e5244febf", "message": "#10001 refactroring broke tests so I reverted it\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-23T23:21:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1MzczNw==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494053737", "bodyText": "why is the Warehouse mandatory?", "author": "teosarca", "createdAt": "2020-09-24T05:50:36Z", "path": "backend/de.metas.adempiere.adempiere/base/src/main/java-gen/org/compiere/model/I_C_Invoice.java", "diffHunk": "@@ -1971,4 +1971,33 @@\n     public static final org.adempiere.model.ModelColumn<I_C_Invoice, Object> COLUMN_UserFlag = new org.adempiere.model.ModelColumn<I_C_Invoice, Object>(I_C_Invoice.class, \"UserFlag\", null);\n     /** Column name UserFlag */\n     public static final String COLUMNNAME_UserFlag = \"UserFlag\";\n+    \n+    \n+    /**\n+\t * Set Lager.\n+\t * Storage Warehouse and Service Point\n+\t *\n+\t * <br>Type: TableDir\n+\t * <br>Mandatory: true", "originalCommit": "980c191607bd0b36611883f48869266e5244febf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEyMjQ1Nw==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494122457", "bodyText": "Copy - paste problem.\nRegenerated the classes and hey are now ok.", "author": "metas-rc", "createdAt": "2020-09-24T08:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1MzczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1NDUyNg==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494054526", "bodyText": "why ctx is needed. For legacy APIs u can extract it from invoice.", "author": "teosarca", "createdAt": "2020-09-24T05:53:13Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/service/IInvoiceBL.java", "diffHunk": "@@ -423,4 +424,6 @@ void registerLineCopyHandler(\n \t * - set Price_UOM_ID to C_InvoiceLine.C_UOM_ID\n \t */\n \tvoid ensureUOMsAreNotNull(@NonNull InvoiceId invoiceId);\n+\n+\tvoid setInvoiceLineTaxes(Properties ctx, de.metas.adempiere.model.@NonNull I_C_Invoice invoice);", "originalCommit": "980c191607bd0b36611883f48869266e5244febf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1NDY4OA==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494054688", "bodyText": "why ctx is needed. for legacy APIs u can extract it from il.", "author": "teosarca", "createdAt": "2020-09-24T05:53:44Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/service/IInvoiceLineBL.java", "diffHunk": "@@ -98,4 +104,6 @@\n \tvoid updateLineNetAmt(I_C_InvoiceLine line, BigDecimal qtyEntered);\n \n \tvoid updatePrices(I_C_InvoiceLine invoiceLine);\n+\n+\tboolean setTaxForInvoiceLine(Properties ctx, org.compiere.model.I_C_InvoiceLine il, OrgId orgId, Timestamp taxDate, CountryId countryFromId, BPartnerLocationId partnerLocationId, boolean isSOTrx);", "originalCommit": "980c191607bd0b36611883f48869266e5244febf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MDMxMw==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494060313", "bodyText": "the fromCountryId in this method is computed in a different way compared with MInvoiceLine.setTax() method.\nPls make sure we are always computing things in one way.\nMore, I would advise to introduce some getFromCountryId(I_C_Invoice invoice, I_C_InvoiceLine invoiceLine) method in IInvoiceBL.\nYou could call that method from both places.", "author": "teosarca", "createdAt": "2020-09-24T06:10:10Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/service/impl/AbstractInvoiceBL.java", "diffHunk": "@@ -1371,6 +1383,66 @@ public final boolean isTaxIncluded(@NonNull final org.compiere.model.I_C_Invoice\n \t\treturn invoice.isTaxIncluded(); // 08486: use the invoice's flag, not whatever the PL sais right now\n \t}\n \n+\t@Override\n+\tpublic void setInvoiceLineTaxes(final Properties ctx, @NonNull final I_C_Invoice invoice)", "originalCommit": "980c191607bd0b36611883f48869266e5244febf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MDY5OA==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494060698", "bodyText": "avoid duplicating the get countryFromId logic.\nsee above.", "author": "teosarca", "createdAt": "2020-09-24T06:11:09Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/service/impl/InvoiceLineBL.java", "diffHunk": "@@ -108,6 +114,68 @@ public void setTaxAmtInfo(final Properties ctx, final I_C_InvoiceLine il, final\n \t@Override\n \tpublic boolean setTax(final Properties ctx, final org.compiere.model.I_C_InvoiceLine il, final String trxName)\n \t{\n+\t\tfinal IInOutDAO inoutDAO = Services.get(IInOutDAO.class);\n+\t\tfinal IInvoiceDAO invoiceDAO = Services.get(IInvoiceDAO.class);\n+\t\tfinal IWarehouseBL warehouseBL = Services.get(IWarehouseBL.class);\n+\n+\t\tfinal InvoiceId invoiceId = InvoiceId.ofRepoId(il.getC_Invoice_ID());\n+\t\tfinal I_C_Invoice invoice = invoiceDAO.getByIdInTrx(invoiceId);\n+\n+\t\tif (il.getM_InOutLine_ID() <= 0)\n+\t\t{\n+\t\t\tlogger.debug(il + \"has M_InOutLine_ID=\" + il.getM_InOutLine_ID() + \": returning\");\n+\t\t\treturn false;\n+\t\t}\n+\n+\t\tfinal InOutLineId inoutLineId = InOutLineId.ofRepoId(il.getM_InOutLine_ID());\n+\t\tfinal I_M_InOutLine inoutLineRecord = inoutDAO.getLineById(inoutLineId);\n+\n+\t\tfinal I_M_InOut io = inoutDAO.getById(InOutId.ofRepoId(inoutLineRecord.getM_InOut_ID()));\n+\n+\t\tfinal OrgId inOutOrgId = OrgId.ofRepoId(io.getAD_Org_ID());\n+\n+\t\tfinal Timestamp shipDate = io.getMovementDate();\n+\n+\t\tfinal BPartnerLocationId partnerLocationId = BPartnerLocationId.ofRepoId(io.getC_BPartner_ID(), io.getC_BPartner_Location_ID());\n+\n+\t\tfinal WarehouseId warehouseId = WarehouseId.ofRepoId(io.getM_Warehouse_ID());\n+\n+\t\tfinal boolean isSOTrx = io.isSOTrx();\n+\n+\t\tfinal CountryId countryFromId;\n+\t\tfinal WarehouseId invoiceWarehouseId = WarehouseId.ofRepoIdOrNull(invoice.getM_Warehouse_ID());", "originalCommit": "980c191607bd0b36611883f48869266e5244febf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MDg2MA==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494060860", "bodyText": "minor: avoid ctx param", "author": "teosarca", "createdAt": "2020-09-24T06:11:38Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/service/impl/InvoiceLineBL.java", "diffHunk": "@@ -108,6 +114,68 @@ public void setTaxAmtInfo(final Properties ctx, final I_C_InvoiceLine il, final\n \t@Override\n \tpublic boolean setTax(final Properties ctx, final org.compiere.model.I_C_InvoiceLine il, final String trxName)\n \t{\n+\t\tfinal IInOutDAO inoutDAO = Services.get(IInOutDAO.class);\n+\t\tfinal IInvoiceDAO invoiceDAO = Services.get(IInvoiceDAO.class);\n+\t\tfinal IWarehouseBL warehouseBL = Services.get(IWarehouseBL.class);\n+\n+\t\tfinal InvoiceId invoiceId = InvoiceId.ofRepoId(il.getC_Invoice_ID());\n+\t\tfinal I_C_Invoice invoice = invoiceDAO.getByIdInTrx(invoiceId);\n+\n+\t\tif (il.getM_InOutLine_ID() <= 0)\n+\t\t{\n+\t\t\tlogger.debug(il + \"has M_InOutLine_ID=\" + il.getM_InOutLine_ID() + \": returning\");\n+\t\t\treturn false;\n+\t\t}\n+\n+\t\tfinal InOutLineId inoutLineId = InOutLineId.ofRepoId(il.getM_InOutLine_ID());\n+\t\tfinal I_M_InOutLine inoutLineRecord = inoutDAO.getLineById(inoutLineId);\n+\n+\t\tfinal I_M_InOut io = inoutDAO.getById(InOutId.ofRepoId(inoutLineRecord.getM_InOut_ID()));\n+\n+\t\tfinal OrgId inOutOrgId = OrgId.ofRepoId(io.getAD_Org_ID());\n+\n+\t\tfinal Timestamp shipDate = io.getMovementDate();\n+\n+\t\tfinal BPartnerLocationId partnerLocationId = BPartnerLocationId.ofRepoId(io.getC_BPartner_ID(), io.getC_BPartner_Location_ID());\n+\n+\t\tfinal WarehouseId warehouseId = WarehouseId.ofRepoId(io.getM_Warehouse_ID());\n+\n+\t\tfinal boolean isSOTrx = io.isSOTrx();\n+\n+\t\tfinal CountryId countryFromId;\n+\t\tfinal WarehouseId invoiceWarehouseId = WarehouseId.ofRepoIdOrNull(invoice.getM_Warehouse_ID());\n+\n+\t\tif (invoiceWarehouseId != null)\n+\t\t{\n+\t\t\tcountryFromId = warehouseBL.getCountryId(invoiceWarehouseId);\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tcountryFromId = warehouseBL.getCountryId(warehouseId);\n+\t\t}\n+\n+\t\treturn setTaxForInvoiceLine(ctx, il, inOutOrgId, shipDate, countryFromId, partnerLocationId, isSOTrx);\n+\t}\n+\n+\t@Override\n+\tpublic boolean setTaxForInvoiceLine(final Properties ctx,", "originalCommit": "980c191607bd0b36611883f48869266e5244febf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MTI5NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494061295", "bodyText": "rename partnerLocationId parameter to billLocationId or similar (to underline that we are talking about BILL BPartner and location)", "author": "teosarca", "createdAt": "2020-09-24T06:12:49Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/service/impl/InvoiceLineBL.java", "diffHunk": "@@ -108,6 +114,68 @@ public void setTaxAmtInfo(final Properties ctx, final I_C_InvoiceLine il, final\n \t@Override\n \tpublic boolean setTax(final Properties ctx, final org.compiere.model.I_C_InvoiceLine il, final String trxName)\n \t{\n+\t\tfinal IInOutDAO inoutDAO = Services.get(IInOutDAO.class);\n+\t\tfinal IInvoiceDAO invoiceDAO = Services.get(IInvoiceDAO.class);\n+\t\tfinal IWarehouseBL warehouseBL = Services.get(IWarehouseBL.class);\n+\n+\t\tfinal InvoiceId invoiceId = InvoiceId.ofRepoId(il.getC_Invoice_ID());\n+\t\tfinal I_C_Invoice invoice = invoiceDAO.getByIdInTrx(invoiceId);\n+\n+\t\tif (il.getM_InOutLine_ID() <= 0)\n+\t\t{\n+\t\t\tlogger.debug(il + \"has M_InOutLine_ID=\" + il.getM_InOutLine_ID() + \": returning\");\n+\t\t\treturn false;\n+\t\t}\n+\n+\t\tfinal InOutLineId inoutLineId = InOutLineId.ofRepoId(il.getM_InOutLine_ID());\n+\t\tfinal I_M_InOutLine inoutLineRecord = inoutDAO.getLineById(inoutLineId);\n+\n+\t\tfinal I_M_InOut io = inoutDAO.getById(InOutId.ofRepoId(inoutLineRecord.getM_InOut_ID()));\n+\n+\t\tfinal OrgId inOutOrgId = OrgId.ofRepoId(io.getAD_Org_ID());\n+\n+\t\tfinal Timestamp shipDate = io.getMovementDate();\n+\n+\t\tfinal BPartnerLocationId partnerLocationId = BPartnerLocationId.ofRepoId(io.getC_BPartner_ID(), io.getC_BPartner_Location_ID());\n+\n+\t\tfinal WarehouseId warehouseId = WarehouseId.ofRepoId(io.getM_Warehouse_ID());\n+\n+\t\tfinal boolean isSOTrx = io.isSOTrx();\n+\n+\t\tfinal CountryId countryFromId;\n+\t\tfinal WarehouseId invoiceWarehouseId = WarehouseId.ofRepoIdOrNull(invoice.getM_Warehouse_ID());\n+\n+\t\tif (invoiceWarehouseId != null)\n+\t\t{\n+\t\t\tcountryFromId = warehouseBL.getCountryId(invoiceWarehouseId);\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tcountryFromId = warehouseBL.getCountryId(warehouseId);\n+\t\t}\n+\n+\t\treturn setTaxForInvoiceLine(ctx, il, inOutOrgId, shipDate, countryFromId, partnerLocationId, isSOTrx);\n+\t}\n+\n+\t@Override\n+\tpublic boolean setTaxForInvoiceLine(final Properties ctx,\n+\t\t\tfinal org.compiere.model.I_C_InvoiceLine il,\n+\t\t\tfinal OrgId orgId,\n+\t\t\tfinal Timestamp taxDate,\n+\t\t\tfinal CountryId countryFromId,\n+\t\t\tfinal BPartnerLocationId partnerLocationId,", "originalCommit": "980c191607bd0b36611883f48869266e5244febf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MjA1MA==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494062050", "bodyText": "... or is this the shipToLocation? can u pls clarify and name it correctly?", "author": "teosarca", "createdAt": "2020-09-24T06:15:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MTI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIwMjA0Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494202043", "bodyText": "Hi, @teosarca\n\nI checked and saw that before, we took the shipment bp and location whensetting the tax from de.metas.invoice.service.impl.InvoiceLineBL.setTax(I_C_InvoiceLine, String) and the invoice bp and location when setting it from org.compiere.model.MInvoiceLine.setTax()\nNote that in the latter one the inout is not even searched for.\nWhich partner and location should be considered when computing the tax? How is this legally done in the real world?\nSimilar: Which date should be used on tax computation? The shipment date or the invoice date?", "author": "metas-rc", "createdAt": "2020-09-24T10:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MTI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyNTYzOQ==", "url": "https://github.com/metasfresh/metasfresh/pull/10004#discussion_r494225639", "bodyText": "I renamed the method to make it obvious the data is based on the inoutLine linked to the invoice. If there is no inoutline, the tax is not set.\n\nIn the other places, I take the info from the inout if it is available and form the invoice otherwise.", "author": "metas-rc", "createdAt": "2020-09-24T11:04:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MTI5NQ=="}], "type": "inlineReview"}, {"oid": "82026ada03c98536427c694e3b85fb36041f24ea", "url": "https://github.com/metasfresh/metasfresh/commit/82026ada03c98536427c694e3b85fb36041f24ea", "message": "#10001 repair script\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-24T07:54:36Z", "type": "commit"}, {"oid": "fdc5e087aa4f547c411c52585327aaefdcc94a6a", "url": "https://github.com/metasfresh/metasfresh/commit/fdc5e087aa4f547c411c52585327aaefdcc94a6a", "message": "#10001 invoice classes  regenerated -> warehouse\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-24T08:10:53Z", "type": "commit"}, {"oid": "7ccb8eeb4b2b68557515f521c0f81a5e344adb23", "url": "https://github.com/metasfresh/metasfresh/commit/7ccb8eeb4b2b68557515f521c0f81a5e344adb23", "message": "#10001 Refactoring, cleanup\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-24T10:16:18Z", "type": "commit"}, {"oid": "d59f0e43500759fe23f04fa3a64ebb647d3ac65a", "url": "https://github.com/metasfresh/metasfresh/commit/d59f0e43500759fe23f04fa3a64ebb647d3ac65a", "message": "#10001 harmonize tax calculation\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-24T10:58:26Z", "type": "commit"}, {"oid": "d32248ec5b1415aa99feccff7059e6bb92b4ec90", "url": "https://github.com/metasfresh/metasfresh/commit/d32248ec5b1415aa99feccff7059e6bb92b4ec90", "message": "#10001 small cleanup\n\nhttps://github.com/metasfresh/metasfresh/issues/10001", "committedDate": "2020-09-24T11:08:20Z", "type": "commit"}]}