{"pr_number": 6614, "pr_title": "Gh6608", "pr_createdAt": "2020-05-08T12:18:46Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6614", "timeline": [{"oid": "e0bf2bccb9fb8ee4bda0ed979a4530347ed1c678", "url": "https://github.com/metasfresh/metasfresh/commit/e0bf2bccb9fb8ee4bda0ed979a4530347ed1c678", "message": "UX: Sidelist references loading takes far to long\n\nhttps://github.com/metasfresh/metasfresh/issues/6608", "committedDate": "2020-05-07T18:50:31Z", "type": "commit"}, {"oid": "cbec578fbf432e8ec816f14c4c5ce35e8c920bda", "url": "https://github.com/metasfresh/metasfresh/commit/cbec578fbf432e8ec816f14c4c5ce35e8c920bda", "message": "frontend: use /references/sse endpoint", "committedDate": "2020-05-07T18:51:01Z", "type": "commit"}, {"oid": "3ec8b00383ee7f4154107f2bcf822a3ea099f52a", "url": "https://github.com/metasfresh/metasfresh/commit/3ec8b00383ee7f4154107f2bcf822a3ea099f52a", "message": "fix TableRecordIdDAO caching", "committedDate": "2020-05-07T19:27:19Z", "type": "commit"}, {"oid": "a8553328570c1551e90415eeddea521d67b71822", "url": "https://github.com/metasfresh/metasfresh/commit/a8553328570c1551e90415eeddea521d67b71822", "message": "Update DocumentReferencesRestController.java", "committedDate": "2020-05-07T19:46:02Z", "type": "commit"}, {"oid": "4b1dffd9849e6e07f7416b2b16cee801033a8ba6", "url": "https://github.com/metasfresh/metasfresh/commit/4b1dffd9849e6e07f7416b2b16cee801033a8ba6", "message": "fix log levels", "committedDate": "2020-05-07T19:49:11Z", "type": "commit"}, {"oid": "3909b7d9060f2792a8803ae530a5b7ae6fc5c4f5", "url": "https://github.com/metasfresh/metasfresh/commit/3909b7d9060f2792a8803ae530a5b7ae6fc5c4f5", "message": "refactor", "committedDate": "2020-05-07T22:23:10Z", "type": "commit"}, {"oid": "3b1f19060f2ec71599711fbf8a8a70d1a46d6144", "url": "https://github.com/metasfresh/metasfresh/commit/3b1f19060f2ec71599711fbf8a8a70d1a46d6144", "message": "organize packages", "committedDate": "2020-05-07T22:31:03Z", "type": "commit"}, {"oid": "91c57027e91829b8cdc6b34f3be10330ca03fbf5", "url": "https://github.com/metasfresh/metasfresh/commit/91c57027e91829b8cdc6b34f3be10330ca03fbf5", "message": "remove unused code", "committedDate": "2020-05-07T22:32:20Z", "type": "commit"}, {"oid": "150a3c2ffdc4c3f5b5495c94fc64ef7b345f252b", "url": "https://github.com/metasfresh/metasfresh/commit/150a3c2ffdc4c3f5b5495c94fc64ef7b345f252b", "message": "minor", "committedDate": "2020-05-07T22:35:16Z", "type": "commit"}, {"oid": "1d712ec0ff986cc9834ee698ed859ecb4555cda0", "url": "https://github.com/metasfresh/metasfresh/commit/1d712ec0ff986cc9834ee698ed859ecb4555cda0", "message": "evaluate each reference in a separate thread", "committedDate": "2020-05-08T09:58:27Z", "type": "commit"}, {"oid": "f74ae12749b5058fc06beb932f488f79bdbbaf53", "url": "https://github.com/metasfresh/metasfresh/commit/f74ae12749b5058fc06beb932f488f79bdbbaf53", "message": "organize", "committedDate": "2020-05-08T10:21:21Z", "type": "commit"}, {"oid": "f63b3840854e42121f4a8afb61ebe4addd41301d", "url": "https://github.com/metasfresh/metasfresh/commit/f63b3840854e42121f4a8afb61ebe4addd41301d", "message": "Merge branch 'master' into gh6608", "committedDate": "2020-05-08T10:25:21Z", "type": "commit"}, {"oid": "b53b1da88ad1ed8dd87192f38012a7992bd64698", "url": "https://github.com/metasfresh/metasfresh/commit/b53b1da88ad1ed8dd87192f38012a7992bd64698", "message": "use SSE for included document level references", "committedDate": "2020-05-08T12:06:41Z", "type": "commit"}, {"oid": "ec91cf5fddbf6c0fb6abec74da5e519d244cd87c", "url": "https://github.com/metasfresh/metasfresh/commit/ec91cf5fddbf6c0fb6abec74da5e519d244cd87c", "message": "Update metasfresh-webui-api.launch", "committedDate": "2020-05-08T12:06:48Z", "type": "commit"}, {"oid": "31d75f57b427a4e6e482ee0549842de8dfc8d5cf", "url": "https://github.com/metasfresh/metasfresh/commit/31d75f57b427a4e6e482ee0549842de8dfc8d5cf", "message": "minor", "committedDate": "2020-05-08T12:10:45Z", "type": "commit"}, {"oid": "352108ef4902145e12fd12c081110f7704984621", "url": "https://github.com/metasfresh/metasfresh/commit/352108ef4902145e12fd12c081110f7704984621", "message": "remove unused code", "committedDate": "2020-05-08T12:36:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyOTQ5OA==", "url": "https://github.com/metasfresh/metasfresh/pull/6614#discussion_r422129498", "bodyText": "This should be a separate component like ReferenceItem", "author": "petrican", "createdAt": "2020-05-08T13:01:51Z", "path": "frontend/src/components/table/TableContextMenu.js", "diffHunk": "@@ -183,23 +204,36 @@ class TableContextMenu extends Component {\n           </div>\n         )}\n \n-        {references && <hr className=\"context-menu-separator\" />}\n-\n-        {references &&\n-          references.map((item, index) => (\n-            <div\n-              className=\"context-menu-item\"\n-              key={index}\n-              onClick={() => {\n-                this.handleReferenceClick(item.documentType, item.filter);\n-              }}\n-            >\n-              <i className=\"meta-icon-share\" /> {item.caption}\n-            </div>\n-          ))}\n+        {this.renderReferences()}\n       </div>\n     );\n   }\n+\n+  renderReferences() {\n+    const { loadingReferences, references } = this.state;\n+\n+    if (!references && !loadingReferences) {\n+      return;\n+    }\n+\n+    return (\n+      <Fragment>\n+        <hr className=\"context-menu-separator\" />\n+        {references.map((item, index) => (\n+          <div", "originalCommit": "352108ef4902145e12fd12c081110f7704984621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEzNDIyMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6614#discussion_r422134221", "bodyText": "Maybe a simpler solution could be used either using reduce https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce. or  with some lodash utils. Looks big. Not mandatory to do that just a thought", "author": "petrican", "createdAt": "2020-05-08T13:12:00Z", "path": "frontend/src/utils/documentReferencesHelper.js", "diffHunk": "@@ -0,0 +1,90 @@\n+export function mergePartialGroupToGroupsArray(groups, partialGroup) {\n+  if (!partialGroup) {\n+    return groups;\n+  }\n+\n+  let result = [];\n+  let partialGroupMerged = false;\n+\n+  for (const group of groups) {", "originalCommit": "352108ef4902145e12fd12c081110f7704984621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE2MzkzOQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6614#discussion_r422163939", "bodyText": "const url =\n  `${config.API_URL}/window/${windowId}/${documentId}/${rowId ? `/${tabId}/${rowId}` :  '/references/sse'}`;", "author": "siemiatj", "createdAt": "2020-05-08T14:08:06Z", "path": "frontend/src/actions/GenericActions.js", "diffHunk": "@@ -210,19 +210,35 @@ export function rowActionsRequest({ windowId, documentId, tabId, rowId }) {\n   );\n }\n \n-export function referencesRequest(entity, type, docId, tabId, rowId) {\n-  return axios.get(\n-    config.API_URL +\n-      '/' +\n-      entity +\n-      '/' +\n-      type +\n-      '/' +\n-      docId +\n-      (tabId ? '/' + tabId : '') +\n-      (rowId ? '/' + rowId : '') +\n-      '/references'\n-  );\n+export function referencesEventSource({\n+  windowId,\n+  documentId,\n+  tabId,\n+  rowId,\n+  onPartialResult,\n+  onComplete,\n+}) {\n+  var url = `${config.API_URL}/window/${windowId}/${documentId}`;", "originalCommit": "352108ef4902145e12fd12c081110f7704984621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE2NDE2Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6614#discussion_r422164163", "bodyText": "please use const instead of var", "author": "siemiatj", "createdAt": "2020-05-08T14:08:29Z", "path": "frontend/src/actions/GenericActions.js", "diffHunk": "@@ -210,19 +210,35 @@ export function rowActionsRequest({ windowId, documentId, tabId, rowId }) {\n   );\n }\n \n-export function referencesRequest(entity, type, docId, tabId, rowId) {\n-  return axios.get(\n-    config.API_URL +\n-      '/' +\n-      entity +\n-      '/' +\n-      type +\n-      '/' +\n-      docId +\n-      (tabId ? '/' + tabId : '') +\n-      (rowId ? '/' + rowId : '') +\n-      '/references'\n-  );\n+export function referencesEventSource({\n+  windowId,\n+  documentId,\n+  tabId,\n+  rowId,\n+  onPartialResult,\n+  onComplete,\n+}) {\n+  var url = `${config.API_URL}/window/${windowId}/${documentId}`;\n+  if (rowId) {\n+    url = url + `/${tabId}/${rowId}`;\n+  }\n+  url = url + '/references/sse';\n+\n+  var eventSource = new EventSource(url, { withCredentials: true });", "originalCommit": "352108ef4902145e12fd12c081110f7704984621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE2NTc5Mg==", "url": "https://github.com/metasfresh/metasfresh/pull/6614#discussion_r422165792", "bodyText": "key has to be unique (for performance reasons), so we can instead do:\n      return data.map((item, idx) => {\n        return [\n          <div\n            key=`${caption_idx}`", "author": "siemiatj", "createdAt": "2020-05-08T14:11:28Z", "path": "frontend/src/components/header/Referenced.js", "diffHunk": "@@ -76,10 +96,10 @@ class Referenced extends Component {\n   };\n \n   renderData = () => {\n-    const { data } = this.state;\n+    const { loading, data } = this.state;\n \n-    return data && data.length ? (\n-      data.map((item) => {\n+    if (data && data.length) {\n+      return data.map((item) => {\n         return [\n           <div\n             key=\"caption\"", "originalCommit": "352108ef4902145e12fd12c081110f7704984621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3NTQ0Ng==", "url": "https://github.com/metasfresh/metasfresh/pull/6614#discussion_r422175446", "bodyText": "I'd use reduce instead of the for of", "author": "siemiatj", "createdAt": "2020-05-08T14:28:29Z", "path": "frontend/src/utils/documentReferencesHelper.js", "diffHunk": "@@ -0,0 +1,90 @@\n+export function mergePartialGroupToGroupsArray(groups, partialGroup) {\n+  if (!partialGroup) {\n+    return groups;\n+  }\n+\n+  let result = [];\n+  let partialGroupMerged = false;\n+\n+  for (const group of groups) {", "originalCommit": "352108ef4902145e12fd12c081110f7704984621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3NjAwMA==", "url": "https://github.com/metasfresh/metasfresh/pull/6614#discussion_r422176000", "bodyText": "Again reduce or map.", "author": "siemiatj", "createdAt": "2020-05-08T14:29:20Z", "path": "frontend/src/utils/documentReferencesHelper.js", "diffHunk": "@@ -0,0 +1,90 @@\n+export function mergePartialGroupToGroupsArray(groups, partialGroup) {\n+  if (!partialGroup) {\n+    return groups;\n+  }\n+\n+  let result = [];\n+  let partialGroupMerged = false;\n+\n+  for (const group of groups) {\n+    if (!partialGroupMerged && group.caption === partialGroup.caption) {\n+      const changedGroup = mergeReferencesToGroup(\n+        group,\n+        partialGroup.references\n+      );\n+\n+      result.push(changedGroup);\n+      partialGroupMerged = true;\n+    } else {\n+      result.push(group);\n+    }\n+  }\n+\n+  if (!partialGroupMerged) {\n+    result.push(partialGroup);\n+    partialGroupMerged = true;\n+  }\n+\n+  //\n+  // Sort groups by caption alphabetically, keep miscGroup last.\n+  result = result.sort((group1, group2) => {\n+    if (group1.miscGroup == group2.miscGroup) {\n+      return group1.caption.localeCompare(group2.caption);\n+    } else if (group1.miscGroup) {\n+      return +1; // keep misc group last\n+    } else {\n+      return -1;\n+    }\n+  });\n+\n+  return result;\n+}\n+\n+function mergeReferencesToGroup(group, referencesToAdd) {\n+  if (!referencesToAdd || !referencesToAdd.length) {\n+    return group;\n+  }\n+\n+  return {\n+    ...group,\n+    references: mergeReferencesToReferences(group.references, referencesToAdd),\n+  };\n+}\n+\n+export function mergeReferencesToReferences(\n+  existingReferences,\n+  referencesToAdd\n+) {\n+  if (!referencesToAdd) {\n+    return existingReferences;\n+  }\n+\n+  const referencesToAddById = {};\n+  referencesToAdd.forEach((reference) => {\n+    referencesToAddById[reference.id] = reference;\n+  });\n+\n+  let references = [];\n+\n+  for (const existingReference of existingReferences) {", "originalCommit": "352108ef4902145e12fd12c081110f7704984621", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8bfe3de1086bf455861895f25a83698a5d3cc3c9", "url": "https://github.com/metasfresh/metasfresh/commit/8bfe3de1086bf455861895f25a83698a5d3cc3c9", "message": "use template literals", "committedDate": "2020-05-08T15:09:46Z", "type": "commit"}, {"oid": "bacda5492db34691ebd655f7a30075cce6d0512b", "url": "https://github.com/metasfresh/metasfresh/commit/bacda5492db34691ebd655f7a30075cce6d0512b", "message": "refactor to components, set `key` prop when needed", "committedDate": "2020-05-08T17:21:10Z", "type": "commit"}, {"oid": "4371f5e09abecdc871c938e6b7f8d3b0befa0ba9", "url": "https://github.com/metasfresh/metasfresh/commit/4371f5e09abecdc871c938e6b7f8d3b0befa0ba9", "message": "move code to api/", "committedDate": "2020-05-08T17:31:19Z", "type": "commit"}, {"oid": "ce613b69616559a636a98eef1dfabe8d2edc404c", "url": "https://github.com/metasfresh/metasfresh/commit/ce613b69616559a636a98eef1dfabe8d2edc404c", "message": "add tests", "committedDate": "2020-05-08T19:15:57Z", "type": "commit"}, {"oid": "be820e48c51f0a319e557f177ba58b3202548dfe", "url": "https://github.com/metasfresh/metasfresh/commit/be820e48c51f0a319e557f177ba58b3202548dfe", "message": "Update documentReferencesHelper.js", "committedDate": "2020-05-08T20:43:15Z", "type": "commit"}, {"oid": "1bfa4e6f9384c8dbcf83092fbdad3ff8364cf11a", "url": "https://github.com/metasfresh/metasfresh/commit/1bfa4e6f9384c8dbcf83092fbdad3ff8364cf11a", "message": "fix ubiquitous language", "committedDate": "2020-05-08T21:23:08Z", "type": "commit"}, {"oid": "6a3b3126bece98a7415f842eab99193aa1318f5b", "url": "https://github.com/metasfresh/metasfresh/commit/6a3b3126bece98a7415f842eab99193aa1318f5b", "message": "handle ctrl+click", "committedDate": "2020-05-08T21:39:15Z", "type": "commit"}, {"oid": "f0908608532393ca1feeb19bb9e41adc14b8f943", "url": "https://github.com/metasfresh/metasfresh/commit/f0908608532393ca1feeb19bb9e41adc14b8f943", "message": "minor", "committedDate": "2020-05-08T21:39:37Z", "type": "commit"}, {"oid": "096d3e68db6b12a52f7b571f1587d777ae8fa3f0", "url": "https://github.com/metasfresh/metasfresh/commit/096d3e68db6b12a52f7b571f1587d777ae8fa3f0", "message": "buildRelatedDocumentsViewUrl", "committedDate": "2020-05-08T21:54:48Z", "type": "commit"}, {"oid": "ea1b4eda97f0e1f5d853c7975b00552226e88fe3", "url": "https://github.com/metasfresh/metasfresh/commit/ea1b4eda97f0e1f5d853c7975b00552226e88fe3", "message": "handle ctrl+enter", "committedDate": "2020-05-08T22:19:10Z", "type": "commit"}, {"oid": "7d7be64d03bda54636dccdd66f1f9a7c1c893e44", "url": "https://github.com/metasfresh/metasfresh/commit/7d7be64d03bda54636dccdd66f1f9a7c1c893e44", "message": "Update TableContextMenu.js", "committedDate": "2020-05-08T22:36:31Z", "type": "commit"}, {"oid": "9e94966a1f0a6143e38b4a966285001f15d6740c", "url": "https://github.com/metasfresh/metasfresh/commit/9e94966a1f0a6143e38b4a966285001f15d6740c", "message": "fix view row right click + open in a new tab", "committedDate": "2020-05-08T22:54:11Z", "type": "commit"}, {"oid": "42db73080df732973df0e8795f423c4e43b3aa04", "url": "https://github.com/metasfresh/metasfresh/commit/42db73080df732973df0e8795f423c4e43b3aa04", "message": "hotfix TablContextMenu was not opened near mouse", "committedDate": "2020-05-09T09:42:16Z", "type": "commit"}, {"oid": "aaf6a4690004fd2b02251516df9ac778fe107bab", "url": "https://github.com/metasfresh/metasfresh/commit/aaf6a4690004fd2b02251516df9ac778fe107bab", "message": "fix propTypes", "committedDate": "2020-05-09T10:04:14Z", "type": "commit"}, {"oid": "edd2450611f6d9cde541e27867836b0086be094a", "url": "https://github.com/metasfresh/metasfresh/commit/edd2450611f6d9cde541e27867836b0086be094a", "message": "fix propTypes", "committedDate": "2020-05-09T10:04:28Z", "type": "commit"}, {"oid": "d0432a67bbe732017eb4b66521a186e5888bb13a", "url": "https://github.com/metasfresh/metasfresh/commit/d0432a67bbe732017eb4b66521a186e5888bb13a", "message": "fix propTypes", "committedDate": "2020-05-09T10:07:11Z", "type": "commit"}, {"oid": "12f87dd55c03e0599475686b2d03c96a297e2bc3", "url": "https://github.com/metasfresh/metasfresh/commit/12f87dd55c03e0599475686b2d03c96a297e2bc3", "message": "close eventSource on component unmount", "committedDate": "2020-05-09T15:47:45Z", "type": "commit"}]}