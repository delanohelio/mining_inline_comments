{"pr_number": 1070, "pr_title": "[CDAP-16532] multi-level input schema serialization as csv, tsv or delimited validation errors", "pr_createdAt": "2020-04-05T21:46:47Z", "pr_url": "https://github.com/cdapio/hydrator-plugins/pull/1070", "timeline": [{"oid": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f", "url": "https://github.com/cdapio/hydrator-plugins/commit/d3b5a9c268a1d5920e68b7c89a35c6248842f42f", "message": "[CDAP-16532] multi-level input schema serialization as csv, tsv or delimited validation error", "committedDate": "2020-04-05T21:44:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDM1Mw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r403764353", "bodyText": "Was the default CSV? Or are we changing it to CSV?", "author": "chtyim", "createdAt": "2020-04-05T22:16:16Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,32 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.CSV;", "originalCommit": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDExNzU5Mw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404117593", "bodyText": "We are not changing from what it is. But, in any case changed it to JSON (which is the default).", "author": "nitinmotgi", "createdAt": "2020-04-06T14:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDg5NA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r403764894", "bodyText": "Can be just\nboolean allSimple = schema.getFields().stream().map(Schema.Field::getSchema).allMatch(Schema::isSimpleOrNullableSimple)", "author": "chtyim", "createdAt": "2020-04-05T22:21:02Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,32 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.CSV;\n     try {\n-      getFormat();\n+      format = getFormat();\n     } catch (IllegalArgumentException e) {\n       collector.addFailure(e.getMessage(), null).withConfigProperty(NAME_FORMAT).withStacktrace(e.getStackTrace());\n     }\n     try {\n-      getSchema();\n+      Schema schema = getSchema();\n+      // Checks if the output schema has fields that are not simple type.\n+      // If there are non-simple field types, then serializing as CSV might not be appropriate.\n+      // This restriction is on Csv, Delimited and Tab separated files.\n+      if (format == FileFormat.CSV || format == FileFormat.DELIMITED || format == FileFormat.TSV) {\n+        boolean simpleFields = true;\n+        for (Schema.Field field : schema.getFields()) {", "originalCommit": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA5NDczNA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404094734", "bodyText": "this will logic will not short circuit right and go through all the elements.", "author": "nitinmotgi", "createdAt": "2020-04-06T13:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEyMTQ4NQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404121485", "bodyText": "Found that it does. changing it.", "author": "nitinmotgi", "createdAt": "2020-04-06T14:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NDg5NA=="}], "type": "inlineReview"}, {"oid": "13f63f1686efa91fcb1977fb5bb506d040623a4c", "url": "https://github.com/cdapio/hydrator-plugins/commit/13f63f1686efa91fcb1977fb5bb506d040623a4c", "message": "[CDAP-16532] Addressed review comments, defaulted format to JSON as in UI as well changed to use streams", "committedDate": "2020-04-06T15:16:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE3MzYyOQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404173629", "bodyText": "should we use the word \"nested\" in the message? Also, it would help to add the name of the field that has the problem?", "author": "bdmogal", "createdAt": "2020-04-06T15:17:34Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,32 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.CSV;\n     try {\n-      getFormat();\n+      format = getFormat();\n     } catch (IllegalArgumentException e) {\n       collector.addFailure(e.getMessage(), null).withConfigProperty(NAME_FORMAT).withStacktrace(e.getStackTrace());\n     }\n     try {\n-      getSchema();\n+      Schema schema = getSchema();\n+      // Checks if the output schema has fields that are not simple type.\n+      // If there are non-simple field types, then serializing as CSV might not be appropriate.\n+      // This restriction is on Csv, Delimited and Tab separated files.\n+      if (format == FileFormat.CSV || format == FileFormat.DELIMITED || format == FileFormat.TSV) {\n+        boolean simpleFields = true;\n+        for (Schema.Field field : schema.getFields()) {\n+          if (!field.getSchema().isSimpleOrNullableSimple()) {\n+            simpleFields = false;\n+            break;\n+          }\n+        }\n+        collector.addFailure(\n+          String.format(\"Input has multi-level structure that cannot be represented appropriately in %s.\",", "originalCommit": "d3b5a9c268a1d5920e68b7c89a35c6248842f42f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxNTg0OA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404215848", "bodyText": "I thought about that. But if there are multiple fields then we need to list\nthem all. But ultimately, if you think from user perspective we are not\nsuggesting them to remove the fields, the intent here is to suggest user to\nuse the right format for the data that they have. Suggesting to remove the\nfield can be conceived as limitation. So had to carefully word it.", "author": "nitinmotgi", "createdAt": "2020-04-06T16:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE3MzYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMDEyMw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404330123", "bodyText": "this validation should be done in the format (DelimitedOutputFormatProvider's validate method), not in the file sink.", "author": "albertshau", "createdAt": "2020-04-06T19:19:26Z", "path": "format-common/src/main/java/io/cdap/plugin/format/plugin/AbstractFileSinkConfig.java", "diffHunk": "@@ -84,13 +84,30 @@ public void validate(FailureCollector collector) {\n           .withConfigProperty(NAME_SUFFIX).withStacktrace(e.getStackTrace());\n       }\n     }\n+\n+    FileFormat format = FileFormat.JSON;\n     try {\n-      getFormat();\n+      format = getFormat();\n     } catch (IllegalArgumentException e) {\n       collector.addFailure(e.getMessage(), null).withConfigProperty(NAME_FORMAT).withStacktrace(e.getStackTrace());\n     }\n     try {\n-      getSchema();\n+      Schema schema = getSchema();\n+      // Checks if the output schema has fields that are not simple type.\n+      // If there are non-simple field types, then serializing as CSV might not be appropriate.\n+      // This restriction is on Csv, Delimited and Tab separated files.\n+      if (format == FileFormat.CSV || format == FileFormat.DELIMITED || format == FileFormat.TSV) {", "originalCommit": "13f63f1686efa91fcb1977fb5bb506d040623a4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3OTM5Nw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1070#discussion_r404479397", "bodyText": "discussed offline, the problem is there isn't a way to pass down the name of the format field, since we want to highlight it. So we can keep it for now and open a jira to fix this in a cleaner way.", "author": "albertshau", "createdAt": "2020-04-07T01:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMDEyMw=="}], "type": "inlineReview"}]}