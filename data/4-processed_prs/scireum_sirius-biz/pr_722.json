{"pr_number": 722, "pr_title": "SIRI-96: Provides a rudimentary UI for  BlobHardRefs", "pr_createdAt": "2020-04-16T11:22:30Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/722", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxNjM1MQ==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r409616351", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Note that this blob object itself will also be update with the aprropriate metadata\n          \n          \n            \n                 * Note that this blob object itself will also be updated with the appropriate metadata", "author": "mkeckmkeck", "createdAt": "2020-04-16T14:46:59Z", "path": "src/main/java/sirius/biz/storage/layer2/Blob.java", "diffHunk": "@@ -160,6 +160,9 @@\n      * <p>\n      * Also note that if a file is used to provide the new contents of this blob, use\n      * {@link #updateContent(String, File)} as this is likely way more efficient.\n+     * <p>\n+     * Note that this blob object itself will also be update with the aprropriate metadata", "originalCommit": "341d2f3aee5582fda9ea22648a12581277606ea3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxNjYzOA==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r409616638", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void uploaduploadFile(final WebContext ctx,\n          \n          \n            \n                public void uploadFile(final WebContext ctx,", "author": "mkeckmkeck", "createdAt": "2020-04-16T14:47:20Z", "path": "src/main/java/sirius/biz/storage/layer2/BlobController.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer2;\n+\n+import io.netty.handler.codec.http.HttpHeaderNames;\n+import sirius.biz.storage.util.StorageUtils;\n+import sirius.biz.web.BizController;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.controller.Controller;\n+import sirius.web.controller.Routed;\n+import sirius.web.http.InputStreamHandler;\n+import sirius.web.http.WebContext;\n+import sirius.web.security.LoginRequired;\n+import sirius.web.services.JSONStructuredOutput;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Provides some helper routes for managing and uploading {@link Blob blobs}.\n+ * <p>\n+ * Note that most of the management UI is handled via the VFS (layer 3) in the\n+ * {@link sirius.biz.storage.layer3.VFSController}.\n+ */\n+@Register(framework = StorageUtils.FRAMEWORK_STORAGE, classes = Controller.class)\n+public class BlobController extends BizController {\n+\n+    @Part\n+    private BlobStorage blobStorage;\n+\n+    /**\n+     * Uploads a file into a temporary Blob, to be later persisted via a {@link BlobHardRef}.\n+     * <p>\n+     * As long as the blob remains unreferenced, it will be marked as temporary and will be eventually\n+     * deleted. However, if an entity references the blob via a {@link BlobHardRef}, it will be marked\n+     * as permanent.\n+     *\n+     * @param ctx       the request to handle\n+     * @param out       the response to the AJAX call\n+     * @param spaceName the {@link BlobStorageSpace} to store the object in\n+     * @param upload    the content of the upload\n+     */\n+    @Routed(value = \"/dasd/upload-file/:1\", preDispatchable = true, jsonCall = true)\n+    @LoginRequired\n+    public void uploaduploadFile(final WebContext ctx,", "originalCommit": "341d2f3aee5582fda9ea22648a12581277606ea3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1MjM5Ng==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r410052396", "bodyText": "This also changes the logic not only readability??", "author": "sabieber", "createdAt": "2020-04-17T07:51:23Z", "path": "src/main/java/sirius/biz/storage/layer2/BlobHardRefProperty.java", "diffHunk": "@@ -151,13 +151,14 @@ protected void onBeforeSaveChecks(Object entity) {\n     @Override\n     protected void onAfterSave(Object entity) {\n         BlobHardRef ref = getRef(entity);\n-        if (ref.changed && ref.isFilled()) {\n-            ref.getBlob()\n-               .getStorageSpace()\n-               .markAsUsed(((BaseEntity<?>) entity).getUniqueName(), getName(), ref.getKey());\n-            ref.getBlob()\n-               .getStorageSpace()\n-               .deleteReferencedBlobs(((BaseEntity<?>) entity).getUniqueName(), getName(), ref.getKey());\n+        if (ref.changed) {\n+            BlobStorageSpace storageSpace = ref.getBlob().getStorageSpace();\n+            String uniqueName = ((BaseEntity<?>) entity).getUniqueName();\n+\n+            if (ref.isFilled()) {\n+                storageSpace.markAsUsed(uniqueName, getName(), ref.getKey());\n+            }\n+            storageSpace.deleteReferencedBlobs(uniqueName, getName(), ref.getKey());", "originalCommit": "319097dcc543f3c405177555f124b70d89a96168", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1NTIwMQ==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r410055201", "bodyText": "Das Kommentar von oben \u00fcbernehmen?", "author": "sabieber", "createdAt": "2020-04-17T07:56:47Z", "path": "src/main/java/sirius/biz/storage/layer2/mongo/MongoBlobStorageSpace.java", "diffHunk": "@@ -341,7 +341,14 @@ protected MongoDirectory fetchBlobParent(MongoBlob blob) {\n                                      .executeFor(MongoBlob.class)\n                                      .getModifiedCount();\n             if (numUpdated == 1) {\n-                return Optional.ofNullable(blob.getPhysicalObjectKey());\n+                String previousPhysicalObjectKey = blob.getPhysicalObjectKey();", "originalCommit": "acbfc23b65b0ccf07cb0ffb39f0993f50d172f91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1OTI0Nw==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r410059247", "bodyText": "Oder kann man das vllt in ne Methode auslagern?", "author": "sabieber", "createdAt": "2020-04-17T08:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1NTIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1NTgyMQ==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r410055821", "bodyText": "link blob?", "author": "sabieber", "createdAt": "2020-04-17T07:57:58Z", "path": "src/main/java/sirius/biz/storage/layer2/BlobController.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer2;\n+\n+import io.netty.handler.codec.http.HttpHeaderNames;\n+import sirius.biz.storage.util.StorageUtils;\n+import sirius.biz.web.BizController;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.controller.Controller;\n+import sirius.web.controller.Routed;\n+import sirius.web.http.InputStreamHandler;\n+import sirius.web.http.WebContext;\n+import sirius.web.security.LoginRequired;\n+import sirius.web.services.JSONStructuredOutput;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Provides some helper routes for managing and uploading {@link Blob blobs}.\n+ * <p>\n+ * Note that most of the management UI is handled via the VFS (layer 3) in the\n+ * {@link sirius.biz.storage.layer3.VFSController}.\n+ */\n+@Register(framework = StorageUtils.FRAMEWORK_STORAGE, classes = Controller.class)\n+public class BlobController extends BizController {\n+\n+    @Part\n+    private BlobStorage blobStorage;\n+\n+    /**\n+     * Uploads a file into a temporary Blob, to be later persisted via a {@link BlobHardRef}.", "originalCommit": "b13fcbea08602ad3ce5e1579f0d125f1d15ae530", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1NjAyMA==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r410056020", "bodyText": "TODO ohne Ticket referenz?", "author": "sabieber", "createdAt": "2020-04-17T07:58:20Z", "path": "src/main/java/sirius/biz/storage/layer2/BlobController.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer2;\n+\n+import io.netty.handler.codec.http.HttpHeaderNames;\n+import sirius.biz.storage.util.StorageUtils;\n+import sirius.biz.web.BizController;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.controller.Controller;\n+import sirius.web.controller.Routed;\n+import sirius.web.http.InputStreamHandler;\n+import sirius.web.http.WebContext;\n+import sirius.web.security.LoginRequired;\n+import sirius.web.services.JSONStructuredOutput;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Provides some helper routes for managing and uploading {@link Blob blobs}.\n+ * <p>\n+ * Note that most of the management UI is handled via the VFS (layer 3) in the\n+ * {@link sirius.biz.storage.layer3.VFSController}.\n+ */\n+@Register(framework = StorageUtils.FRAMEWORK_STORAGE, classes = Controller.class)\n+public class BlobController extends BizController {\n+\n+    @Part\n+    private BlobStorage blobStorage;\n+\n+    /**\n+     * Uploads a file into a temporary Blob, to be later persisted via a {@link BlobHardRef}.\n+     * <p>\n+     * As long as the blob remains unreferenced, it will be marked as temporary and will be eventually\n+     * deleted. However, if an entity references the blob via a {@link BlobHardRef}, it will be marked\n+     * as permanent.\n+     *\n+     * @param ctx       the request to handle\n+     * @param out       the response to the AJAX call\n+     * @param spaceName the {@link BlobStorageSpace} to store the object in\n+     * @param upload    the content of the upload\n+     */\n+    @Routed(value = \"/dasd/upload-file/:1\", preDispatchable = true, jsonCall = true)\n+    @LoginRequired\n+    public void uploaduploadFile(final WebContext ctx,\n+                                 JSONStructuredOutput out,\n+                                 String spaceName,\n+                                 InputStreamHandler upload) {\n+        Blob blob = blobStorage.getSpace(spaceName).createTemporaryBlob();\n+        try {\n+            try {\n+                ctx.markAsLongCall();\n+                //TODO remove legacy qqfile once library is updated...", "originalCommit": "b13fcbea08602ad3ce5e1579f0d125f1d15ae530", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1NjEwNA==", "url": "https://github.com/scireum/sirius-biz/pull/722#discussion_r410056104", "bodyText": "TODO ohne Ticket Referenz?", "author": "sabieber", "createdAt": "2020-04-17T07:58:29Z", "path": "src/main/java/sirius/biz/storage/layer2/BlobController.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer2;\n+\n+import io.netty.handler.codec.http.HttpHeaderNames;\n+import sirius.biz.storage.util.StorageUtils;\n+import sirius.biz.web.BizController;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.controller.Controller;\n+import sirius.web.controller.Routed;\n+import sirius.web.http.InputStreamHandler;\n+import sirius.web.http.WebContext;\n+import sirius.web.security.LoginRequired;\n+import sirius.web.services.JSONStructuredOutput;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Provides some helper routes for managing and uploading {@link Blob blobs}.\n+ * <p>\n+ * Note that most of the management UI is handled via the VFS (layer 3) in the\n+ * {@link sirius.biz.storage.layer3.VFSController}.\n+ */\n+@Register(framework = StorageUtils.FRAMEWORK_STORAGE, classes = Controller.class)\n+public class BlobController extends BizController {\n+\n+    @Part\n+    private BlobStorage blobStorage;\n+\n+    /**\n+     * Uploads a file into a temporary Blob, to be later persisted via a {@link BlobHardRef}.\n+     * <p>\n+     * As long as the blob remains unreferenced, it will be marked as temporary and will be eventually\n+     * deleted. However, if an entity references the blob via a {@link BlobHardRef}, it will be marked\n+     * as permanent.\n+     *\n+     * @param ctx       the request to handle\n+     * @param out       the response to the AJAX call\n+     * @param spaceName the {@link BlobStorageSpace} to store the object in\n+     * @param upload    the content of the upload\n+     */\n+    @Routed(value = \"/dasd/upload-file/:1\", preDispatchable = true, jsonCall = true)\n+    @LoginRequired\n+    public void uploaduploadFile(final WebContext ctx,\n+                                 JSONStructuredOutput out,\n+                                 String spaceName,\n+                                 InputStreamHandler upload) {\n+        Blob blob = blobStorage.getSpace(spaceName).createTemporaryBlob();\n+        try {\n+            try {\n+                ctx.markAsLongCall();\n+                //TODO remove legacy qqfile once library is updated...\n+                String name = ctx.get(\"filename\").asString(ctx.get(\"qqfile\").asString());\n+                blob.updateContent(name, upload, Long.parseLong(ctx.getHeader(HttpHeaderNames.CONTENT_LENGTH)));\n+\n+                out.property(\"fileId\", blob.getBlobKey());\n+\n+                // TODO remove once the blobHardRefField has been refactored", "originalCommit": "b13fcbea08602ad3ce5e1579f0d125f1d15ae530", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30a5620e8be131405564023f1fd94609e13ed6d2", "url": "https://github.com/scireum/sirius-biz/commit/30a5620e8be131405564023f1fd94609e13ed6d2", "message": "Always deletes left-over blobs if a reference changes.\n\nIf a new blob key is placed in a reference, we previously\nonly marked the old blob as deleted, if a new one was given.\n\nHowever, if the reference is cleared (set to null), we still should\nmark the previously referenced blob as deleted.", "committedDate": "2020-04-17T08:02:50Z", "type": "commit"}, {"oid": "532115d05c4415e69f6f1bd24c4d8956e56df14f", "url": "https://github.com/scireum/sirius-biz/commit/532115d05c4415e69f6f1bd24c4d8956e56df14f", "message": "Also updates the in memory blob when updating the metadata store.\n\nWe previously only updated the underlying database but left the given\nblob filled with the previous values. This is kind of unexpected for\nthe caller of \"update\", therefore we also update the in-memory blob\n(without a fetch from the database).\n\nFixes: SIRI-96", "committedDate": "2020-04-17T08:04:29Z", "type": "commit"}, {"oid": "90c0d904494b4e9ab4c1ca6cf45280532d2a20ad", "url": "https://github.com/scireum/sirius-biz/commit/90c0d904494b4e9ab4c1ca6cf45280532d2a20ad", "message": "Uses the filename in the given blob if available.\n\nThis will avoid an unnecessary cache lookup.", "committedDate": "2020-04-17T08:04:59Z", "type": "commit"}, {"oid": "241e9d0f10484aa2fa0e990ce067a4be80f34c19", "url": "https://github.com/scireum/sirius-biz/commit/241e9d0f10484aa2fa0e990ce067a4be80f34c19", "message": "Provides a UI component to update the value of a BlobHardRef.\n\nThis is done by performing an AJAX upload into a temporary blob.\nOnce the entity containing the BlobHardRef is persisted,\nthe blob is marked as non-temporary. Otherwise, the blob is\nautomatically deleted after a timeout.\n\nThe controller provided here supports the actual AJAX call.\n\nNote that the UI is very rudimentary and more or less a copy of\nstoredObjectUploader.html.pasta. This needs some love+work\nin the near future.\n\nFixes: SIRI-96", "committedDate": "2020-04-17T08:07:04Z", "type": "commit"}, {"oid": "666bf83502d3cd94c9eb1bfbeba61f1d6ecce654", "url": "https://github.com/scireum/sirius-biz/commit/666bf83502d3cd94c9eb1bfbeba61f1d6ecce654", "message": "Prevents a NPE when a BlobHardRef is set to null.\n\nPreviously we tried to determine which space is used\nby using ref.getBlob().getStorageSpace(), we now use\na newly helper method provided by the BlobHardRef which\nis smart enough to lookup the space, if no blob is present.\n\nFixes: SIRI-96", "committedDate": "2020-04-17T08:07:49Z", "type": "commit"}, {"oid": "666bf83502d3cd94c9eb1bfbeba61f1d6ecce654", "url": "https://github.com/scireum/sirius-biz/commit/666bf83502d3cd94c9eb1bfbeba61f1d6ecce654", "message": "Prevents a NPE when a BlobHardRef is set to null.\n\nPreviously we tried to determine which space is used\nby using ref.getBlob().getStorageSpace(), we now use\na newly helper method provided by the BlobHardRef which\nis smart enough to lookup the space, if no blob is present.\n\nFixes: SIRI-96", "committedDate": "2020-04-17T08:07:49Z", "type": "forcePushed"}]}