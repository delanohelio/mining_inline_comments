{"pr_number": 676, "pr_title": "Efficient move operations for VFS files (SIRI-102)", "pr_createdAt": "2020-01-28T22:40:58Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/676", "timeline": [{"oid": "fc95474715fa76bcbca143a0c90999611788f5f1", "url": "https://github.com/scireum/sirius-biz/commit/fc95474715fa76bcbca143a0c90999611788f5f1", "message": "Merge branch 'aha/13.0-rc79-HF' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/sftp/SFTPUplinkConnectorConfig.java\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnector.java\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorFactory.java", "committedDate": "2020-01-28T21:40:51Z", "type": "commit"}, {"oid": "4287e709877194122d308a1d5182086899fcb1be", "url": "https://github.com/scireum/sirius-biz/commit/4287e709877194122d308a1d5182086899fcb1be", "message": "Merge remote-tracking branch 'origin/master' into aha/vfs-move", "committedDate": "2020-01-28T21:40:58Z", "type": "commit"}, {"oid": "6a274c537c26b0f48fc65487cb93ce24edd8fec1", "url": "https://github.com/scireum/sirius-biz/commit/6a274c537c26b0f48fc65487cb93ce24edd8fec1", "message": "Adds some retry magic for the SFTPUplink.\n\nThis had previously been done for the FTPUplink", "committedDate": "2020-01-28T21:42:41Z", "type": "commit"}, {"oid": "45b1f587721c3446b0fa0e52763fb35edc7682f8", "url": "https://github.com/scireum/sirius-biz/commit/45b1f587721c3446b0fa0e52763fb35edc7682f8", "message": "Properly names efficient move functions.\n\nThese are considered \"fastMove\" operations as they\nhopefully only perform a rename or inode move instead of\njuggling any bytes.", "committedDate": "2020-01-28T21:44:54Z", "type": "commit"}, {"oid": "52bfc626811af049ae3515c1bbdf9ea31080d6c4", "url": "https://github.com/scireum/sirius-biz/commit/52bfc626811af049ae3515c1bbdf9ea31080d6c4", "message": "Provides an efficient move operation when moving files within a CIFS share.\n\nFixes: SIRI-102", "committedDate": "2020-01-28T21:45:33Z", "type": "commit"}, {"oid": "c0a608e4b496d8d5f110c487ea0036a0816f45ce", "url": "https://github.com/scireum/sirius-biz/commit/c0a608e4b496d8d5f110c487ea0036a0816f45ce", "message": "Provides an efficient move operation when moving files within the local file system.\n\nFixes: SIRI-102", "committedDate": "2020-01-28T21:45:50Z", "type": "commit"}, {"oid": "4cb6636d8ff320fae5f74206cc76195f2694d52a", "url": "https://github.com/scireum/sirius-biz/commit/4cb6636d8ff320fae5f74206cc76195f2694d52a", "message": "Provides an efficient move operation when moving files within a FTP uplink.\n\nFixes: SIRI-102", "committedDate": "2020-01-28T21:46:12Z", "type": "commit"}, {"oid": "28203d96b3f97e8a93ddf02a90f92108bfe9e5dc", "url": "https://github.com/scireum/sirius-biz/commit/28203d96b3f97e8a93ddf02a90f92108bfe9e5dc", "message": "Provides an efficient move operation when moving files within a SFTP uplink.\n\nFixes: SIRI-102", "committedDate": "2020-01-28T21:46:29Z", "type": "commit"}, {"oid": "4296b16155f3fa3ed40b9e2c286f0c464ef877fa", "url": "https://github.com/scireum/sirius-biz/commit/4296b16155f3fa3ed40b9e2c286f0c464ef877fa", "message": "Makes the efficient move operations of Level 2 accessible in the layer 3 (VFS).\n\nFixes: SIRI-102", "committedDate": "2020-01-28T21:47:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTMzNQ==", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r372211335", "bodyText": "javadoc ?: can move file into new parent directory if they belong both to the same space", "author": "tbiScireum", "createdAt": "2020-01-29T06:41:51Z", "path": "src/main/java/sirius/biz/storage/layer2/L3Uplink.java", "diffHunk": "@@ -359,16 +359,32 @@ private boolean deleteHandler(VirtualFile file) {\n         return false;\n     }\n \n-    private boolean moveHandler(VirtualFile file, VirtualFile newParent) {\n+    private boolean canFastMoveHandler(VirtualFile file, VirtualFile newParent) {", "originalCommit": "4296b16155f3fa3ed40b9e2c286f0c464ef877fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk4ODk5OQ==", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r372988999", "bodyText": "well, its a private method as simply provides the implementation as defined by MutableVirtualFile.withCanFastMoveHandler", "author": "andyHa", "createdAt": "2020-01-30T14:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMjkyMA==", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r372212920", "bodyText": "unncessary", "author": "tbiScireum", "createdAt": "2020-01-29T06:48:45Z", "path": "src/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorPool.java", "diffHunk": "@@ -8,9 +8,11 @@\n \n package sirius.biz.storage.layer3.uplink.util;\n \n+import org.apache.commons.pool2.impl.DefaultPooledObject;", "originalCommit": "4296b16155f3fa3ed40b9e2c286f0c464ef877fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bff5e7d07f9b26191ce9ba1100cded52f3cfde54", "url": "https://github.com/scireum/sirius-biz/commit/bff5e7d07f9b26191ce9ba1100cded52f3cfde54", "message": "Widens the number of exceptions being handled.", "committedDate": "2020-01-29T19:37:17Z", "type": "commit"}, {"oid": "e5d3e2c55f46515ad29b6aa9e63d7ffc44ef9c80", "url": "https://github.com/scireum/sirius-biz/commit/e5d3e2c55f46515ad29b6aa9e63d7ffc44ef9c80", "message": "Also force closes a connector when a fast move fails.", "committedDate": "2020-01-29T19:37:38Z", "type": "commit"}, {"oid": "1248fe58173f5872014aeace648f6edf13677990", "url": "https://github.com/scireum/sirius-biz/commit/1248fe58173f5872014aeace648f6edf13677990", "message": "Merge branch 'aha/13.0-rc79-3' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/ftp/FTPUplink.java", "committedDate": "2020-01-29T19:38:16Z", "type": "commit"}, {"oid": "1742f7114d2911853b51e39c179779324982ffc6", "url": "https://github.com/scireum/sirius-biz/commit/1742f7114d2911853b51e39c179779324982ffc6", "message": "Fixes the name of the commend being referenced.", "committedDate": "2020-01-29T19:39:26Z", "type": "commit"}, {"oid": "96059ff10c936d227b8ad6e38e825619018267e5", "url": "https://github.com/scireum/sirius-biz/commit/96059ff10c936d227b8ad6e38e825619018267e5", "message": "Code format.", "committedDate": "2020-01-29T19:39:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc3NjM0Nw==", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r372776347", "bodyText": "Wie w\u00e4rs mit Exceptions.getRootCause ?", "author": "tbiScireum", "createdAt": "2020-01-30T06:23:21Z", "path": "src/main/java/sirius/biz/storage/layer3/uplink/util/Attempt.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer3.uplink.util;\n+\n+import sirius.biz.storage.layer3.uplink.sftp.SFTPUplink;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Helps to distinguishes an initial first attempt from a rety.\n+ * <p>\n+ * If is used by uplinks like {@link sirius.biz.storage.layer3.uplink.ftp.FTPUplink} or {@link SFTPUplink} to\n+ * permit a retry for all IO related operations. Therefore the helper method {@link #shouldThrow(Exception)}\n+ * can be used to determine if an <tt>IOException</tt> is swallowed if it occurs during a first attempt but\n+ * will be thrown during a retry.\n+ * <p>\n+ * The pattern to use this looks something like:\n+ * <pre>{@code\n+ * for(Attempt attempt : Attempt.values()) {\n+ *     try {\n+ *         ...do something\n+ *         return;\n+ *     } catch(Exception e) {\n+ *         if (attempt.shouldThrow(e)) {\n+ *             throw Exceptions.handle...\n+ *         }\n+ *     }\n+ * }\n+ * }</pre>\n+ * <p>\n+ * This approach permits to perform inner returns and also enables some optimizations to the compiler (as opposed to\n+ * use lambdas).\n+ */\n+public enum Attempt {\n+    FIRST_ATTEMPT, RETRY;\n+\n+    /**\n+     * Determines if the given exception should be thrown.\n+     *\n+     * @param exception the exception to check\n+     * @return <tt>true</tt> if the exception should be thrown, <tt>false</tt> if it should be swallowed\n+     */\n+    public boolean shouldThrow(Exception exception) {\n+        return this == RETRY || !((exception instanceof IOException) || (exception.getCause() instanceof IOException));", "originalCommit": "96059ff10c936d227b8ad6e38e825619018267e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "62542c6f66680c20fee6300a5ff11ac0209a2072", "url": "https://github.com/scireum/sirius-biz/commit/62542c6f66680c20fee6300a5ff11ac0209a2072", "message": "Merge branch 'aha/13.0-rc79-3' into aha/vfs-move", "committedDate": "2020-01-30T14:36:57Z", "type": "commit"}, {"oid": "ad0717b76a93710e1cabf69a4578be42bb271fa6", "url": "https://github.com/scireum/sirius-biz/commit/ad0717b76a93710e1cabf69a4578be42bb271fa6", "message": "Also test connectors being returned into the pool.\n\nIf a retry-able io operation crashes, we attempt a retry\nbut we also forcefully close the connector we used.\n\nThis will invalidate the object. By enforcing a validation\nbefore actually returning the object into the pool we\ncan save some overhead. Note that this shouldn't\nhave any semantic side-effects as the connector would\nbe tested before its use anyway - therefore this is really\njust a shortcut.", "committedDate": "2020-01-30T14:41:40Z", "type": "commit"}, {"oid": "3f11e124b09fcbfaf8ab13fbf39ef79adb034518", "url": "https://github.com/scireum/sirius-biz/commit/3f11e124b09fcbfaf8ab13fbf39ef79adb034518", "message": "Code cleanup.", "committedDate": "2020-01-30T14:41:54Z", "type": "commit"}, {"oid": "3eb00f529135b056a32b6b2691fd7997862dc4db", "url": "https://github.com/scireum/sirius-biz/commit/3eb00f529135b056a32b6b2691fd7997862dc4db", "message": "Moves a helper into a generic package as it is used by several sub-frameworks.", "committedDate": "2020-01-30T14:47:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4NjQ2MQ==", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r373486461", "bodyText": "can we put that for loop & error handling in an extra method with a runnable or consumer as parameter?\nThis looks like copy & paste on 3 different places. Maybe:\nattemptConnection(Consumer<UplinkConnector>)", "author": "tbiScireum", "createdAt": "2020-01-31T13:47:44Z", "path": "src/main/java/sirius/biz/storage/layer3/uplink/ftp/FTPUplink.java", "diffHunk": "@@ -185,25 +204,35 @@ private MutableVirtualFile wrap(VirtualFile parent, FTPFile file, String filenam\n             return Optional.of(result);\n         }\n \n-        try (UplinkConnector<FTPClient> connector = connectorPool.obtain(ftpConfig)) {\n-            FTPFile[] ftpFiles = list(connector.connector(),\n-                                      file.parent().as(RemotePath.class),\n-                                      ftpFile -> Strings.areEqual(ftpFile.getName(), file.name()));\n-            if (ftpFiles.length == 1) {\n-                file.attach(ftpFiles[0]);\n-                return Optional.of(ftpFiles[0]);\n-            } else {\n-                return Optional.empty();\n+        for (Attempt attempt : Attempt.values()) {", "originalCommit": "3eb00f529135b056a32b6b2691fd7997862dc4db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1MjgyNQ==", "url": "https://github.com/scireum/sirius-biz/pull/676#discussion_r378952825", "bodyText": "doesn't work within a lambda we need an inner return point", "author": "andyHa", "createdAt": "2020-02-13T15:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4NjQ2MQ=="}], "type": "inlineReview"}, {"oid": "b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "url": "https://github.com/scireum/sirius-biz/commit/b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "message": "Merge remote-tracking branch 'origin/master' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorFactory.java", "committedDate": "2020-02-13T15:55:36Z", "type": "commit"}, {"oid": "b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "url": "https://github.com/scireum/sirius-biz/commit/b7889a0a7eb7ce1c2c687fa8d66aaba3ae5890a2", "message": "Merge remote-tracking branch 'origin/master' into aha/vfs-move\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/storage/layer3/uplink/util/UplinkConnectorFactory.java", "committedDate": "2020-02-13T15:55:36Z", "type": "forcePushed"}]}