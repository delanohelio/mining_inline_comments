{"pr_number": 936, "pr_title": "Handles additional actions to blobs and directories", "pr_createdAt": "2020-12-01T16:09:19Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/936", "timeline": [{"oid": "8cf486d2f7555f889db28553317d3d91eb1b48c1", "url": "https://github.com/scireum/sirius-biz/commit/8cf486d2f7555f889db28553317d3d91eb1b48c1", "message": "Marks blobs as parent changed when moved to another directory", "committedDate": "2020-12-01T16:04:07Z", "type": "commit"}, {"oid": "109b7c9bab1b7ec6a6f10532dec8d8824b0301e5", "url": "https://github.com/scireum/sirius-biz/commit/109b7c9bab1b7ec6a6f10532dec8d8824b0301e5", "message": "Marks directories as renamed", "committedDate": "2020-12-01T16:04:37Z", "type": "commit"}, {"oid": "c017dd8ff3241a38126f0aa6291627774bc48d30", "url": "https://github.com/scireum/sirius-biz/commit/c017dd8ff3241a38126f0aa6291627774bc48d30", "message": "Processed additional actions on blobs and directories\n\nMoving a blob to another folder triggers a new handler which can be implemented to process a parent change\n\nRenaming a directory marks all child blobs as parent changes and propagates it to child directories", "committedDate": "2020-12-01T16:06:58Z", "type": "commit"}, {"oid": "c5639497f93de78a310564077c79c0f66158458a", "url": "https://github.com/scireum/sirius-biz/commit/c5639497f93de78a310564077c79c0f66158458a", "message": "Implements the new database-specific loop methods", "committedDate": "2020-12-01T16:07:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUzNzc4OA==", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533537788", "bodyText": "sure? shouldnt this be SqlDirectory.ID == dir.getId()?", "author": "sabieber", "createdAt": "2020-12-01T16:13:53Z", "path": "src/main/java/sirius/biz/storage/layer2/jdbc/SQLProcessBlobChangesLoop.java", "diffHunk": "@@ -91,4 +91,61 @@ protected void propagateDelete(Directory dir) {\n                     dir.getSpaceName()).handle();\n         }\n     }\n+\n+    @Override\n+    protected void processRenamedDirectories(Runnable counter) {\n+        oma.select(SQLDirectory.class).eq(SQLDirectory.RENAMED, true).limit(256).iterateAll(dir -> {\n+            try {\n+                propagateRename(dir);\n+                oma.updateStatement(SQLDirectory.class)\n+                   .set(SQLDirectory.RENAMED, false)\n+                   .where(SQLDirectory.PARENT, dir.getId())", "originalCommit": "c5639497f93de78a310564077c79c0f66158458a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d", "url": "https://github.com/scireum/sirius-biz/commit/f0cf38a4f9e1a25099c3c40901a631af1c2f853d", "message": "Fixes columns used in query - bad copy & paste", "committedDate": "2020-12-01T16:17:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MDQ1OA==", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533990458", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Method executed when a blob has its parent {@link Directory} changed.\n          \n          \n            \n                 * Executed when a blob has its parent {@link Directory} changed.", "author": "andyHa", "createdAt": "2020-12-02T08:48:32Z", "path": "src/main/java/sirius/biz/storage/layer2/BlobParentChangedHandler.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer2;\n+\n+import sirius.kernel.di.std.Priorized;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Defines handlers to process {@link Blob blobs} which parent have been moved between {@link Directory directories}.\n+ *\n+ * @see ProcessBlobChangesLoop\n+ */\n+public interface BlobParentChangedHandler extends Priorized {\n+    /**\n+     * Method executed when a blob has its parent {@link Directory} changed.", "originalCommit": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MjE0Mw==", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r533992143", "bodyText": "didn't we want to increase all the 256's to s.th. larger - like 1k oder 512? goes for all blocks. First step would be to define a constant in a base class and use this everywhere to it can be centrally controlled(?)", "author": "andyHa", "createdAt": "2020-12-02T08:51:11Z", "path": "src/main/java/sirius/biz/storage/layer2/mongo/MongoProcessBlobChangesLoop.java", "diffHunk": "@@ -78,4 +78,45 @@ protected void propagateDelete(@Nonnull Directory dir) {\n              .executeFor(MongoDirectory.class);\n         mongo.update().set(MongoBlob.DELETED, true).where(MongoBlob.PARENT, directoryId).executeFor(MongoBlob.class);\n     }\n+\n+    @Override\n+    protected void processRenamedDirectories(Runnable counter) {\n+        mango.select(MongoDirectory.class).eq(MongoDirectory.RENAMED, true).limit(256).iterateAll(dir -> {\n+            try {\n+                propagateRename(dir);\n+                mongo.update()\n+                     .set(MongoDirectory.RENAMED, false)\n+                     .where(MongoDirectory.ID, dir.getId())\n+                     .executeFor(MongoDirectory.class);\n+            } catch (Exception e) {\n+                handleDirectoryRenameException(dir, e);\n+            }\n+            counter.run();\n+        });\n+    }\n+\n+    @Override\n+    protected void propagateRename(@Nonnull Directory dir) {\n+        String directoryId = dir.getIdAsString();\n+        mongo.update()\n+             .set(MongoDirectory.RENAMED, true)\n+             .where(MongoDirectory.PARENT, directoryId)\n+             .executeFor(MongoDirectory.class);\n+        mongo.update()\n+             .set(MongoBlob.PARENT_CHANGED, true)\n+             .where(MongoBlob.PARENT, directoryId)\n+             .executeFor(MongoBlob.class);\n+    }\n+\n+    @Override\n+    protected void processParentChangedBlobs(Runnable counter) {\n+        mango.select(MongoBlob.class).eq(MongoBlob.PARENT_CHANGED, true).limit(256).iterateAll(blob -> {", "originalCommit": "f0cf38a4f9e1a25099c3c40901a631af1c2f853d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4cc3a172980d3f8a39972174a57dcdc4054e851", "url": "https://github.com/scireum/sirius-biz/commit/d4cc3a172980d3f8a39972174a57dcdc4054e851", "message": "Improves JavaDoc", "committedDate": "2020-12-02T08:54:48Z", "type": "commit"}, {"oid": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46", "url": "https://github.com/scireum/sirius-biz/commit/1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46", "message": "Defines a constant for all query limits (defaults to 1024)", "committedDate": "2020-12-02T09:09:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTg3NA==", "url": "https://github.com/scireum/sirius-biz/pull/936#discussion_r534019874", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static final int CURSOR_LIMIT = 1024;\n          \n          \n            \n                /**\n          \n          \n            \n                 * Defines the block size used for queries to propagate and handle various change flags.\n          \n          \n            \n                 */\n          \n          \n            \n                protected static final int CURSOR_LIMIT = 1024;", "author": "andyHa", "createdAt": "2020-12-02T09:32:39Z", "path": "src/main/java/sirius/biz/storage/layer2/ProcessBlobChangesLoop.java", "diffHunk": "@@ -25,10 +25,14 @@\n public abstract class ProcessBlobChangesLoop extends BackgroundLoop {\n \n     private static final double FREQUENCY_EVERY_FIFTEEN_SECONDS = 1 / 15d;\n+    protected static final int CURSOR_LIMIT = 1024;", "originalCommit": "1ba4e70b7a92e1112d9e2c9edfed6a88d4be9e46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0abaa881c7ea167e7ff09e7fb93edc3185977379", "url": "https://github.com/scireum/sirius-biz/commit/0abaa881c7ea167e7ff09e7fb93edc3185977379", "message": "Adds a JavaDoc explaining the purpose of the constant", "committedDate": "2020-12-02T09:35:36Z", "type": "commit"}]}