{"pr_number": 5187, "pr_title": "Fix crash when no default browser is set and improve share dialogs (on some devices)", "pr_createdAt": "2020-12-15T19:33:39Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/5187", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzMDQ1NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557430454", "bodyText": "Why Boolean and not boolean?", "author": "Stypox", "createdAt": "2021-01-14T14:23:54Z", "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -21,22 +22,80 @@ private ShareUtils() {\n      * Open the url with the system default browser.\n      * <p>\n      * If no browser is set as default, fallbacks to\n-     * {@link ShareUtils#openInDefaultApp(Context, String)}\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context                the context to use\n+     * @param url                    the url to browse\n+     * @param httpDefaultBrowserTest the boolean to set if the\n+     *                               test for the default browser will be for HTTP protocol\n+     *                               or for the created intent\n+     */\n+    public static void openUrlInBrowser(final Context context, final String url,\n+                                        final Boolean httpDefaultBrowserTest) {", "originalCommit": "2a3df743de42dad4676f26e2557aa206dedaad8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1MDA1OQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557550059", "bodyText": "Oh, I didn't know this (I am not a developer). I will change it.", "author": "TiA4f8R", "createdAt": "2021-01-14T17:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzMDQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzMDg1Mw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557430853", "bodyText": "Copy-paste leftover", "author": "Stypox", "createdAt": "2021-01-14T14:24:28Z", "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -21,22 +22,80 @@ private ShareUtils() {\n      * Open the url with the system default browser.\n      * <p>\n      * If no browser is set as default, fallbacks to\n-     * {@link ShareUtils#openInDefaultApp(Context, String)}\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context                the context to use\n+     * @param url                    the url to browse\n+     * @param httpDefaultBrowserTest the boolean to set if the\n+     *                               test for the default browser will be for HTTP protocol\n+     *                               or for the created intent\n+     */\n+    public static void openUrlInBrowser(final Context context, final String url,\n+                                        final Boolean httpDefaultBrowserTest) {\n+        final String defaultPackageName;\n+        final Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url))\n+                .setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n+        if (httpDefaultBrowserTest) {\n+            defaultPackageName = getDefaultBrowserPackageName(context);\n+        } else {\n+            defaultPackageName = getDefaultAppPackageName(context, intent);\n+        }\n+\n+        if (defaultPackageName.equals(\"android\")) {\n+            // no browser set as default (doesn't work on some devices)\n+            openInDefaultApp(context, intent);\n+        } else {\n+            try {\n+                intent.setPackage(defaultPackageName);\n+                context.startActivity(intent);\n+            } catch (final ActivityNotFoundException e) {\n+                // not a browser but an app chooser because of OEMs changes\n+                intent.setPackage(null);\n+                openInDefaultApp(context, intent);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Open the url with the system default browser.\n+     * <p>\n+     * If no browser is set as default, fallbacks to\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     * <p>\n+     * This call {@link ShareUtils#openUrlInBrowser(Context, String, Boolean)} with true\n+     * for the boolean parameter\n      *\n      * @param context the context to use\n      * @param url     the url to browse\n-     */\n+     **/\n     public static void openUrlInBrowser(final Context context, final String url) {\n-        final String defaultBrowserPackageName = getDefaultBrowserPackageName(context);\n+        openUrlInBrowser(context, url, true);\n+    }\n+\n+    /**\n+     * Open a content with the system default browser.", "originalCommit": "2a3df743de42dad4676f26e2557aa206dedaad8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNDE4NQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557434185", "bodyText": "This can probably also be moved to ShareUtils", "author": "Stypox", "createdAt": "2021-01-14T14:28:48Z", "path": "app/src/main/java/org/schabi/newpipe/util/NavigationHelper.java", "diffHunk": "@@ -569,27 +567,14 @@ public static Intent getIntentByLink(final Context context,\n         return getOpenIntent(context, url, service.getServiceId(), linkType);\n     }\n \n-    private static Uri openMarketUrl(final String packageName) {\n-        return Uri.parse(\"market://details\")\n-                .buildUpon()\n-                .appendQueryParameter(\"id\", packageName)\n-                .build();\n-    }\n-\n-    private static Uri getGooglePlayUrl(final String packageName) {\n-        return Uri.parse(\"https://play.google.com/store/apps/details\")\n-                .buildUpon()\n-                .appendQueryParameter(\"id\", packageName)\n-                .build();\n-    }\n-\n     private static void installApp(final Context context, final String packageName) {\n         try {\n             // Try market:// scheme\n-            context.startActivity(new Intent(Intent.ACTION_VIEW, openMarketUrl(packageName)));\n+            ShareUtils.openUrlInBrowser(context, \"market://details?id=\" + packageName, false);\n         } catch (final ActivityNotFoundException e) {\n             // Fall back to google play URL (don't worry F-Droid can handle it :)\n-            context.startActivity(new Intent(Intent.ACTION_VIEW, getGooglePlayUrl(packageName)));\n+            ShareUtils.openUrlInBrowser(context,\n+                    \"https://play.google.com/store/apps/details?id=\" + packageName, false);\n         }", "originalCommit": "2a3df743de42dad4676f26e2557aa206dedaad8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNDg2OA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557434868", "bodyText": "Could you give a better name to this? For me the difference between openContentInApp and openInDefaultApp isn't clear", "author": "Stypox", "createdAt": "2021-01-14T14:29:46Z", "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -21,22 +22,80 @@ private ShareUtils() {\n      * Open the url with the system default browser.\n      * <p>\n      * If no browser is set as default, fallbacks to\n-     * {@link ShareUtils#openInDefaultApp(Context, String)}\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context                the context to use\n+     * @param url                    the url to browse\n+     * @param httpDefaultBrowserTest the boolean to set if the\n+     *                               test for the default browser will be for HTTP protocol\n+     *                               or for the created intent\n+     */\n+    public static void openUrlInBrowser(final Context context, final String url,\n+                                        final Boolean httpDefaultBrowserTest) {\n+        final String defaultPackageName;\n+        final Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url))\n+                .setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n+        if (httpDefaultBrowserTest) {\n+            defaultPackageName = getDefaultBrowserPackageName(context);\n+        } else {\n+            defaultPackageName = getDefaultAppPackageName(context, intent);\n+        }\n+\n+        if (defaultPackageName.equals(\"android\")) {\n+            // no browser set as default (doesn't work on some devices)\n+            openInDefaultApp(context, intent);\n+        } else {\n+            try {\n+                intent.setPackage(defaultPackageName);\n+                context.startActivity(intent);\n+            } catch (final ActivityNotFoundException e) {\n+                // not a browser but an app chooser because of OEMs changes\n+                intent.setPackage(null);\n+                openInDefaultApp(context, intent);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Open the url with the system default browser.\n+     * <p>\n+     * If no browser is set as default, fallbacks to\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     * <p>\n+     * This call {@link ShareUtils#openUrlInBrowser(Context, String, Boolean)} with true\n+     * for the boolean parameter\n      *\n      * @param context the context to use\n      * @param url     the url to browse\n-     */\n+     **/\n     public static void openUrlInBrowser(final Context context, final String url) {\n-        final String defaultBrowserPackageName = getDefaultBrowserPackageName(context);\n+        openUrlInBrowser(context, url, true);\n+    }\n+\n+    /**\n+     * Open a content with the system default browser.\n+     * <p>\n+     * If no app is set as default, fallbacks to\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context the context to use\n+     * @param intent  the intent of the file to open\n+     */\n+    public static void openContentInApp(final Context context, final Intent intent) {", "originalCommit": "2a3df743de42dad4676f26e2557aa206dedaad8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1NDE3NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557554174", "bodyText": "I was thinking first of openFileInApp but I also use this method to play content in an external app.", "author": "TiA4f8R", "createdAt": "2021-01-14T17:08:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNDg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQwNjY2OQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r558406669", "bodyText": "Method name changed to openIntentInApp", "author": "TiA4f8R", "createdAt": "2021-01-15T16:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNDg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNjk4Nw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557436987", "bodyText": "Could you move the falses that would fit into the 100 character limit inline? Also above", "author": "Stypox", "createdAt": "2021-01-14T14:32:23Z", "path": "app/src/main/java/org/schabi/newpipe/about/AboutActivity.java", "diffHunk": "@@ -146,16 +146,20 @@ public View onCreateView(@NonNull final LayoutInflater inflater, final ViewGroup\n             aboutBinding.appVersion.setText(BuildConfig.VERSION_NAME);\n \n             aboutBinding.githubLink.setOnClickListener(nv ->\n-                    openUrlInBrowser(context, context.getString(R.string.github_url)));\n+                    openUrlInBrowser(context, context.getString(R.string.github_url),\n+                            false));\n \n             aboutBinding.donationLink.setOnClickListener(v ->\n-                    openUrlInBrowser(context, context.getString(R.string.donation_url)));\n+                    openUrlInBrowser(context, context.getString(R.string.donation_url),\n+                            false));\n \n             aboutBinding.websiteLink.setOnClickListener(nv ->\n-                    openUrlInBrowser(context, context.getString(R.string.website_url)));\n+                    openUrlInBrowser(context, context.getString(R.string.website_url),\n+                            false));", "originalCommit": "2a3df743de42dad4676f26e2557aa206dedaad8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzOTc0MA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557439740", "bodyText": "LinkHelper doesn't feel like the right name to me, though I don't have a better suggestion", "author": "Stypox", "createdAt": "2021-01-14T14:36:18Z", "path": "app/src/main/java/org/schabi/newpipe/util/LinkHelper.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package org.schabi.newpipe.util;\n+\n+import android.content.Context;\n+import android.text.SpannableStringBuilder;\n+import android.text.method.LinkMovementMethod;\n+import android.text.style.ClickableSpan;\n+import android.text.style.URLSpan;\n+import android.text.util.Linkify;\n+import android.view.View;\n+import android.widget.TextView;\n+\n+import androidx.core.text.HtmlCompat;\n+\n+import io.noties.markwon.Markwon;\n+import io.noties.markwon.linkify.LinkifyPlugin;\n+\n+public final class LinkHelper {", "originalCommit": "2a3df743de42dad4676f26e2557aa206dedaad8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU0NjQ1NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557546454", "bodyText": "What do you think of something like LinkCreator or LinkTransformer?", "author": "TiA4f8R", "createdAt": "2021-01-14T16:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzOTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU1MjMxMg==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557552312", "bodyText": "TextLinkifier, maybe?", "author": "Stypox", "createdAt": "2021-01-14T17:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzOTc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ0MTY1Ng==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557441656", "bodyText": "Shouldn't this be called shareText, since it is now used to also share json?", "author": "Stypox", "createdAt": "2021-01-14T14:38:53Z", "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -79,13 +156,15 @@ private static String getDefaultBrowserPackageName(final Context context) {\n      * @param url     the url to share\n      */\n     public static void shareUrl(final Context context, final String subject, final String url) {", "originalCommit": "2a3df743de42dad4676f26e2557aa206dedaad8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU0NzY4Nw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557547687", "bodyText": "Yes, I will change method name (a lot files will be changed).", "author": "TiA4f8R", "createdAt": "2021-01-14T16:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ0MTY1Ng=="}], "type": "inlineReview"}, {"oid": "a57fd69fb4787d08982c6cfb0d867f365588d6dc", "url": "https://github.com/TeamNewPipe/NewPipe/commit/a57fd69fb4787d08982c6cfb0d867f365588d6dc", "message": "External sharing improvements\n\nImprove NewPipe's share on some devices + fix crash when no browser is set on some devices\n\nCatching ActivityNotFoundException when trying to open the default browser\nUse an ACTION_CHOOSER intent and put as an extra intent the intent to\nopen an URI / share an URI when no default app is set.\n\nAdd a LinkHelper class which set a custom action when clicking web links\nin the description of a content. This class also helps to implement a confirmation dialog when trying to open web links in an external app.", "committedDate": "2021-01-16T12:23:06Z", "type": "commit"}, {"oid": "79e98db3bd58adfe2bc298ce672e963587facf33", "url": "https://github.com/TeamNewPipe/NewPipe/commit/79e98db3bd58adfe2bc298ce672e963587facf33", "message": "Apply the requested changes and little improvements\nApply the requested changes, use ShareUtils.shareText to share an stream in the play queue and optimize imports for Java files, using Android Studio functionality.\n\nApply the requested changes and do little improvements\nApply the requested changes, use ShareUtils.shareText to share an stream in the play queue and optimize imports for Java files, using Android Studio functionality.", "committedDate": "2021-01-16T12:23:42Z", "type": "commit"}, {"oid": "594f0b10ba379b24669bfcb4c04a0f5c3537ea50", "url": "https://github.com/TeamNewPipe/NewPipe/commit/594f0b10ba379b24669bfcb4c04a0f5c3537ea50", "message": "Move TextLinkifier computation out of main thread", "committedDate": "2021-01-16T12:23:42Z", "type": "commit"}]}