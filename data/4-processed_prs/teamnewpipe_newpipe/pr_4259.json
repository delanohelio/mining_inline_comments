{"pr_number": 4259, "pr_title": "Add settings migration, improve share dialog and minimize to background by default", "pr_createdAt": "2020-09-09T19:27:37Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/4259", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyOTU2Nw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4259#discussion_r486629567", "bodyText": "Shouldn't we consider the preferences up to date when we just fresh installed the app? An option would be to replace that 0 above with VERSION, but it would also imply that updating to this version does not do anything. Another option I could think of is checking whether shared preferences were accessed before, in order to determine if we are in a fresh install or not (I am not sure, but I think this can be done by just checking if the number of keys stored in the preferences is zero).", "author": "Stypox", "createdAt": "2020-09-10T20:58:25Z", "path": "app/src/main/java/org/schabi/newpipe/settings/SettingMigrations.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package org.schabi.newpipe.settings;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.preference.PreferenceManager;\n+\n+import org.schabi.newpipe.R;\n+import org.schabi.newpipe.report.ErrorActivity;\n+import org.schabi.newpipe.report.ErrorActivity.ErrorInfo;\n+import org.schabi.newpipe.report.UserAction;\n+\n+public final class SettingMigrations {\n+    /**\n+     * Version number for preferences. Must be incremented every time a migration is necessary.\n+     */\n+    public static final int VERSION = 2;\n+    private static SharedPreferences sp;\n+\n+    public static final Migration MIGRATION_0_1 = new Migration(0, 1) {\n+        @Override\n+        public void migrate(final Context context) {\n+            // We changed the content of the dialog which opens when sharing a link to NewPipe\n+            // by removing the \"open detail page\" option.\n+            // Therefore, show the dialog once again to ensure users need to choose again and are\n+            // aware of the changed dialog.\n+            final SharedPreferences.Editor editor = sp.edit();\n+            editor.putString(context.getString(R.string.preferred_open_action_key),\n+                    context.getString(R.string.always_ask_open_action_key));\n+            editor.apply();\n+        }\n+    };\n+\n+    public static final Migration MIGRATION_1_2 = new Migration(1, 2) {\n+        @Override\n+        protected void migrate(final Context context) {\n+            // The new application workflow introduced in #2907 allows minimizing videos\n+            // while playing to do other stuff within the app.\n+            // For an even better workflow, we minimize a stream when switching the app to play in\n+            // background.\n+            // Therefore, set default value to background, if it has not been changed yet.\n+            final String minimizeOnExitKey = context.getString(R.string.minimize_on_exit_key);\n+            if (sp.getString(minimizeOnExitKey, \"\")\n+                    .equals(context.getString(R.string.minimize_on_exit_none_key))) {\n+                final SharedPreferences.Editor editor = sp.edit();\n+                editor.putString(minimizeOnExitKey,\n+                        context.getString(R.string.minimize_on_exit_background_key));\n+                editor.apply();\n+            }\n+        }\n+    };\n+\n+    /**\n+     * List of all implemented migrations.\n+     * <p>\n+     * <b>Append new migrations to the end of the list</b> to keep it sorted ascending.\n+     * If not sorted correctly, migrations which depend on each other, may fail.\n+     */\n+    private static final Migration[] SETTING_MIGRATIONS = {\n+            MIGRATION_0_1,\n+            MIGRATION_1_2\n+    };\n+\n+\n+    public static void initMigrations(final Context context) {\n+        // setup migrations and check if there is something to do\n+        sp = PreferenceManager.getDefaultSharedPreferences(context);\n+        final String lastPrefVersionKey = context.getString(R.string.last_used_preferences_version);\n+        final int lastPrefVersion = sp.getInt(lastPrefVersionKey, 0);\n+        if (lastPrefVersion == VERSION) { // no migration to run, already up to date\n+            return;", "originalCommit": "c67340285fdee295dded46a0b8b4e826b53a8297", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyMzc5Ng==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4259#discussion_r487223796", "bodyText": "Ah yes. I only focused on migrating old versions, but did not think about new releases.\nChecking if there are any prefs seems like a good solution. I'll just need to check whether it is okay to move the call to injt thr migrations before the other stuff for the download died in done.", "author": "TobiGr", "createdAt": "2020-09-11T18:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyOTU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzMTQ1Nw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4259#discussion_r486631457", "bodyText": "Not in this PR, but we may consider adding junit tests for migrations, using some kind of mocked shared preferences", "author": "Stypox", "createdAt": "2020-09-10T21:02:14Z", "path": "app/src/main/java/org/schabi/newpipe/settings/SettingMigrations.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package org.schabi.newpipe.settings;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.preference.PreferenceManager;\n+\n+import org.schabi.newpipe.R;\n+import org.schabi.newpipe.report.ErrorActivity;\n+import org.schabi.newpipe.report.ErrorActivity.ErrorInfo;\n+import org.schabi.newpipe.report.UserAction;\n+\n+public final class SettingMigrations {", "originalCommit": "c67340285fdee295dded46a0b8b4e826b53a8297", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU0MzUxMw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4259#discussion_r487543513", "bodyText": "Completely agree with that.", "author": "TobiGr", "createdAt": "2020-09-13T15:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzMTQ1Nw=="}], "type": "inlineReview"}, {"oid": "18015520f9de8b8ddc626d25fc61eb98bb785cac", "url": "https://github.com/TeamNewPipe/NewPipe/commit/18015520f9de8b8ddc626d25fc61eb98bb785cac", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-13T15:29:34Z", "type": "forcePushed"}, {"oid": "f814806c87adf7fe05decc15e782dc157fa8462d", "url": "https://github.com/TeamNewPipe/NewPipe/commit/f814806c87adf7fe05decc15e782dc157fa8462d", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-13T15:36:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU0NTQ5MQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4259#discussion_r487545491", "bodyText": "Isn't VERSION equal to SETTINGS_MIGRATIONS[-1].newVersion? Even though fixing this would probably reduce redundancy, I am not sure if it should be done, since what you have done looks clearer", "author": "Stypox", "createdAt": "2020-09-13T15:51:21Z", "path": "app/src/main/java/org/schabi/newpipe/settings/SettingMigrations.java", "diffHunk": "@@ -0,0 +1,131 @@\n+package org.schabi.newpipe.settings;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.preference.PreferenceManager;\n+\n+import org.schabi.newpipe.R;\n+import org.schabi.newpipe.report.ErrorActivity;\n+import org.schabi.newpipe.report.ErrorActivity.ErrorInfo;\n+import org.schabi.newpipe.report.UserAction;\n+\n+public final class SettingMigrations {\n+    /**\n+     * Version number for preferences. Must be incremented every time a migration is necessary.\n+     */\n+    public static final int VERSION = 2;\n+    private static SharedPreferences sp;\n+\n+    public static final Migration MIGRATION_0_1 = new Migration(0, 1) {\n+        @Override\n+        public void migrate(final Context context) {\n+            // We changed the content of the dialog which opens when sharing a link to NewPipe\n+            // by removing the \"open detail page\" option.\n+            // Therefore, show the dialog once again to ensure users need to choose again and are\n+            // aware of the changed dialog.\n+            final SharedPreferences.Editor editor = sp.edit();\n+            editor.putString(context.getString(R.string.preferred_open_action_key),\n+                    context.getString(R.string.always_ask_open_action_key));\n+            editor.apply();\n+        }\n+    };\n+\n+    public static final Migration MIGRATION_1_2 = new Migration(1, 2) {\n+        @Override\n+        protected void migrate(final Context context) {\n+            // The new application workflow introduced in #2907 allows minimizing videos\n+            // while playing to do other stuff within the app.\n+            // For an even better workflow, we minimize a stream when switching the app to play in\n+            // background.\n+            // Therefore, set default value to background, if it has not been changed yet.\n+            final String minimizeOnExitKey = context.getString(R.string.minimize_on_exit_key);\n+            if (sp.getString(minimizeOnExitKey, \"\")\n+                    .equals(context.getString(R.string.minimize_on_exit_none_key))) {\n+                final SharedPreferences.Editor editor = sp.edit();\n+                editor.putString(minimizeOnExitKey,\n+                        context.getString(R.string.minimize_on_exit_background_key));\n+                editor.apply();\n+            }\n+        }\n+    };\n+\n+    /**\n+     * List of all implemented migrations.\n+     * <p>\n+     * <b>Append new migrations to the end of the list</b> to keep it sorted ascending.\n+     * If not sorted correctly, migrations which depend on each other, may fail.\n+     */\n+    private static final Migration[] SETTING_MIGRATIONS = {\n+            MIGRATION_0_1,\n+            MIGRATION_1_2\n+    };\n+\n+\n+    public static void initMigrations(final Context context, final boolean isFirstRun) {\n+        // setup migrations and check if there is something to do\n+        sp = PreferenceManager.getDefaultSharedPreferences(context);\n+        final String lastPrefVersionKey = context.getString(R.string.last_used_preferences_version);\n+        final int lastPrefVersion = sp.getInt(lastPrefVersionKey, 0);\n+\n+        // no migration to run, already up to date\n+        if (isFirstRun) {\n+            sp.edit().putInt(lastPrefVersionKey, VERSION).apply();\n+            return;\n+        } else if (lastPrefVersion == VERSION) {", "originalCommit": "f814806c87adf7fe05decc15e782dc157fa8462d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTMzMTc0Mg==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4259#discussion_r491331742", "bodyText": "That's correct, but as you said, this makes the code harder to read.", "author": "TobiGr", "createdAt": "2020-09-19T08:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU0NTQ5MQ=="}], "type": "inlineReview"}, {"oid": "787837143ec56e38af852b794f1ba92033125eaa", "url": "https://github.com/TeamNewPipe/NewPipe/commit/787837143ec56e38af852b794f1ba92033125eaa", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-19T11:27:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQwOTUxNQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4259#discussion_r491409515", "bodyText": "In order to achieve what was discussed in #4071, I'd just add a condition here that shows \"R.string.show_info\" if autoplay is off, but still uses \"R.string.video_player_key\" as the key in any case. At the end of the day both options open the same activity, even though the outcome is different, so I think users would expect \"Show info\" to be selected in the dialog if they had used the \"Video player\" choice before disabling autoplay, and viceversa.\nI don't think you would need to do anything else in order to achieve what I described above, since VideoDetailFragment already handles autoplay by itself.", "author": "Stypox", "createdAt": "2020-09-19T12:09:46Z", "path": "app/src/main/java/org/schabi/newpipe/RouterActivity.java", "diffHunk": "@@ -377,10 +376,6 @@ private void showDialog(final List<AdapterChoiceItem> choices) {\n         final boolean isExtAudioEnabled = preferences.getBoolean(\n                 getString(R.string.use_external_audio_player_key), false);\n \n-        returnList.add(new AdapterChoiceItem(getString(R.string.show_info_key),\n-                getString(R.string.show_info),\n-                resolveResourceIdFromAttr(context, R.attr.ic_info_outline)));\n-\n         if (capabilities.contains(VIDEO) && !(isExtVideoEnabled && linkType != LinkType.STREAM)) {\n             returnList.add(new AdapterChoiceItem(getString(R.string.video_player_key),\n                     getString(R.string.video_player),", "originalCommit": "787837143ec56e38af852b794f1ba92033125eaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4e46fa81899548dcbff94bf1801c13f3590d3905", "url": "https://github.com/TeamNewPipe/NewPipe/commit/4e46fa81899548dcbff94bf1801c13f3590d3905", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-22T13:39:48Z", "type": "forcePushed"}, {"oid": "a0c12e1d45c164a36a25f90d9bc9b9fd1bf30905", "url": "https://github.com/TeamNewPipe/NewPipe/commit/a0c12e1d45c164a36a25f90d9bc9b9fd1bf30905", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-22T13:46:08Z", "type": "forcePushed"}, {"oid": "c701d4f929c22a491028fa628f173714d1ae4aff", "url": "https://github.com/TeamNewPipe/NewPipe/commit/c701d4f929c22a491028fa628f173714d1ae4aff", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-22T20:49:43Z", "type": "forcePushed"}, {"oid": "ad3364671d48ea697f40dcb31ca5d72232716656", "url": "https://github.com/TeamNewPipe/NewPipe/commit/ad3364671d48ea697f40dcb31ca5d72232716656", "message": "Add migration concept for shared preferences", "committedDate": "2020-09-26T19:43:58Z", "type": "commit"}, {"oid": "5940cc416f61eca8dcfaca42c3f8e3be4c535946", "url": "https://github.com/TeamNewPipe/NewPipe/commit/5940cc416f61eca8dcfaca42c3f8e3be4c535946", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-26T19:47:00Z", "type": "forcePushed"}, {"oid": "0e5f85db95b9aed6ad824db591a354633b67319d", "url": "https://github.com/TeamNewPipe/NewPipe/commit/0e5f85db95b9aed6ad824db591a354633b67319d", "message": "Remove \"Detail Page\" open action from share dialog under certain circumstances\n\nWith the new application workflow and unified player, video detail page and video player are the same activity. So show only one of these options based on whether autoplay is enabled or not, and show both if using external player", "committedDate": "2020-09-26T19:58:34Z", "type": "commit"}, {"oid": "3c4a4e53840bf5bfe91d1ec1492ab22ab7ddf29a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/3c4a4e53840bf5bfe91d1ec1492ab22ab7ddf29a", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-26T19:58:38Z", "type": "commit"}, {"oid": "3c4a4e53840bf5bfe91d1ec1492ab22ab7ddf29a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/3c4a4e53840bf5bfe91d1ec1492ab22ab7ddf29a", "message": "Set default value for \"minimize_on_exit\" to background for better UX.", "committedDate": "2020-09-26T19:58:38Z", "type": "forcePushed"}]}