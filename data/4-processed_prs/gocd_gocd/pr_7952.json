{"pr_number": 7952, "pr_title": "Use ephemeral auto register keys for elastic agents #000", "pr_createdAt": "2020-04-01T22:13:54Z", "pr_url": "https://github.com/gocd/gocd/pull/7952", "timeline": [{"oid": "eb28ff99a420f19a535befe56fb7639546f4213d", "url": "https://github.com/gocd/gocd/commit/eb28ff99a420f19a535befe56fb7639546f4213d", "message": "Use ephemeral auto register keys for elastic agents #000\n\n* The ephemeral keys are short lived and expire based on the system\n  property 'gocd.ephemeral.auto.register.key.expiry.millis' defaulted to\n  30 mins.\n* The ephemeral keys can be used only once, the keys will be revoked upon\n  validation.\n* Elastic agents can only register using the ephemeral keys, non-elastic\n  agents continue to use the autoRegisterKey.", "committedDate": "2020-04-02T00:30:26Z", "type": "forcePushed"}, {"oid": "f012adfac5bd78cf236d10dfee5e20ef5169fea7", "url": "https://github.com/gocd/gocd/commit/f012adfac5bd78cf236d10dfee5e20ef5169fea7", "message": "Use ephemeral auto register keys for elastic agents #000\n\n* The ephemeral keys are short lived and expire based on the system\n  property 'gocd.ephemeral.auto.register.key.expiry.millis' defaulted to\n  30 mins.\n* The ephemeral keys can be used only once, the keys will be revoked upon\n  validation.\n* Elastic agents can only register using the ephemeral keys, non-elastic\n  agents continue to use the autoRegisterKey.", "committedDate": "2020-04-02T22:02:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyMDc5OQ==", "url": "https://github.com/gocd/gocd/pull/7952#discussion_r402720799", "bodyText": "@maheshp Is this line necessary? Looking at its impl, it doesn't seem to have any special side effects that were obvious to me. It doesn't appear to hit any critical paths under test. Its return value is not used.\nAlso, when commenting out, the test still passes.", "author": "marques-work", "createdAt": "2020-04-03T03:44:23Z", "path": "server/src/test-fast/java/com/thoughtworks/go/server/controller/AgentRegistrationControllerTest.java", "diffHunk": "@@ -383,6 +383,28 @@ public void shouldAutoRegisterElasticAgent() {\n         verify(agentService).requestRegistration(ElasticAgentRuntimeInfo.fromServer(agentRuntimeInfo, elasticAgentId, elasticPluginId));\n     }\n \n+    @Test\n+    public void shouldNotRelyOnAutoRegisterKeyForRegisteringElasticAgents() {\n+        String uuid = \"elastic-uuid\";\n+        String autoRegisterKey = \"auto_register_key\";\n+\n+        final ServerConfig serverConfig = mockedServerConfig(\"token-generation-key\", autoRegisterKey);\n+        final String token = token(uuid, serverConfig.getTokenGenerationKey());\n+\n+        when(agentService.isRegistered(uuid)).thenReturn(false);\n+        when(goConfigService.serverConfig()).thenReturn(serverConfig);\n+        when(agentService.createAgentUsername(uuid, request.getRemoteAddr(), \"host\")).thenReturn(new Username(\"some-agent-login-name\"));\n+        when(ephemeralAutoRegisterKeyService.validateAndRevoke(any())).thenReturn(false);\n+\n+        String elasticAgentId = \"elastic-agent-id\";\n+        String elasticPluginId = \"elastic-plugin-id\";\n+        AgentRuntimeInfo.fromServer(new Agent(uuid, \"host\", request.getRemoteAddr()), false, \"location\", 233232L, \"osx\");", "originalCommit": "f012adfac5bd78cf236d10dfee5e20ef5169fea7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE4ODE4OQ==", "url": "https://github.com/gocd/gocd/pull/7952#discussion_r403188189", "bodyText": "Yes, it's redundant. I have changed it.", "author": "maheshp", "createdAt": "2020-04-03T17:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyMDc5OQ=="}], "type": "inlineReview"}, {"oid": "6e399c5b464e7bd67d569803084134f6916ef54f", "url": "https://github.com/gocd/gocd/commit/6e399c5b464e7bd67d569803084134f6916ef54f", "message": "Use ephemeral auto register keys for elastic agents #000\n\n* The ephemeral keys are short lived and expire based on the system\n  property 'gocd.ephemeral.auto.register.key.expiry.millis' defaulted to\n  30 mins.\n* The ephemeral keys can be used only once, the keys will be revoked upon\n  validation.\n* Elastic agents can only register using the ephemeral keys, non-elastic\n  agents continue to use the autoRegisterKey.", "committedDate": "2020-04-03T17:46:16Z", "type": "commit"}, {"oid": "6e399c5b464e7bd67d569803084134f6916ef54f", "url": "https://github.com/gocd/gocd/commit/6e399c5b464e7bd67d569803084134f6916ef54f", "message": "Use ephemeral auto register keys for elastic agents #000\n\n* The ephemeral keys are short lived and expire based on the system\n  property 'gocd.ephemeral.auto.register.key.expiry.millis' defaulted to\n  30 mins.\n* The ephemeral keys can be used only once, the keys will be revoked upon\n  validation.\n* Elastic agents can only register using the ephemeral keys, non-elastic\n  agents continue to use the autoRegisterKey.", "committedDate": "2020-04-03T17:46:16Z", "type": "forcePushed"}]}