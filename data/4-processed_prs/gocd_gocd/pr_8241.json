{"pr_number": 8241, "pr_title": "`GoFileConfigDataSource#areKnownPartialsSameAsValidPartials()` should base its result on structure and not just the origins", "pr_createdAt": "2020-06-17T02:29:49Z", "pr_url": "https://github.com/gocd/gocd/pull/8241", "timeline": [{"oid": "20a3cf689a85621e0fb5b3e44dbd995f8b3794ae", "url": "https://github.com/gocd/gocd/commit/20a3cf689a85621e0fb5b3e44dbd995f8b3794ae", "message": "`GoFileConfigDataSource#areKnownPartialsSameAsValidPartials()` should base its result on structure and not just the origins\n\nThis involves a number of refactorings, but most importantly:\n\n  - Extract `PartialConfig` digest and diffing logic into `PartialConfigHelper`.\n  - Extract digest calculations into `EntityHashes` component.\n  - Replace all `hashCode()` digests with serialized content digests;\n    `hashCode()` collisions are surprisingly easy as uniqueness is not\n    part of the contract of `hashCode()`; its purpose is to help\n    distribute objects in memory sections for hashed data structures\n    such as `HashMap` and friends.\n  - The above changes allow us to share `PartialConfig` comparison logic\n    without causing circular dependencies during Spring dependency\n    injection.\n\nKnown innocent bystanders of drive-by/hand-grenade refactoring:\n\n  - `GoPartialConfig` renamed to `PartialConfigService` and no longer\n    holds the implementation for `PartialConfig` comparison.\n  - `EntityHashingService` is no longer responsible for the digest\n    implementation (that is now handled by `EntityHashes`); rather, it\n    is concerned with listener registration and etag generation of\n    specific entity types, and caching those digest values.\n  - /Go.*Config.*(Service|DataSource)?.*/ and friends - so, so many\n    dependent components suffered refactoring on account of all of the\n    above as well as housekeeping (a number of unused constructor params\n    were gutted).", "committedDate": "2020-06-17T23:15:45Z", "type": "forcePushed"}, {"oid": "93a48662074e527549156178185dd4d1fa1e11e6", "url": "https://github.com/gocd/gocd/commit/93a48662074e527549156178185dd4d1fa1e11e6", "message": "`GoFileConfigDataSource#areKnownPartialsSameAsValidPartials()` should base its result on structure and not just the origins\n\nThis involves a number of refactorings, but most importantly:\n\n  - Extract `PartialConfig` digest and diffing logic into `PartialConfigHelper`.\n  - Extract digest calculations into `EntityHashes` component.\n  - Replace all `hashCode()` digests with serialized content digests;\n    `hashCode()` collisions are surprisingly easy as uniqueness is not\n    part of the contract of `hashCode()`; its purpose is to help\n    distribute objects in memory sections for hashed data structures\n    such as `HashMap` and friends.\n  - The above changes allow us to share `PartialConfig` comparison logic\n    without causing circular dependencies during Spring dependency\n    injection.\n\nKnown innocent bystanders of drive-by/hand-grenade refactoring:\n\n  - `GoPartialConfig` renamed to `PartialConfigService` and no longer\n    holds the implementation for `PartialConfig` comparison.\n  - `EntityHashingService` is no longer responsible for the digest\n    implementation (that is now handled by `EntityHashes`); rather, it\n    is concerned with listener registration and etag generation of\n    specific entity types, and caching those digest values.\n  - /Go.*Config.*(Service|DataSource)?.*/ and friends - so, so many\n    dependent components suffered refactoring on account of all of the\n    above as well as housekeeping (a number of unused constructor params\n    were gutted).", "committedDate": "2020-06-19T02:36:07Z", "type": "forcePushed"}, {"oid": "9233e1d3c43e1bfb60fb69194a540474d994d224", "url": "https://github.com/gocd/gocd/commit/9233e1d3c43e1bfb60fb69194a540474d994d224", "message": "`GoFileConfigDataSource#areKnownPartialsSameAsValidPartials()` should base its result on structure and not just the origins\n\nThis involves a number of refactorings, but most importantly:\n\n  - Extract `PartialConfig` digest and diffing logic into `PartialConfigHelper`.\n  - Extract digest calculations into `EntityHashes` component.\n  - Replace all `hashCode()` digests with serialized content digests;\n    `hashCode()` collisions are surprisingly easy as uniqueness is not\n    part of the contract of `hashCode()`; its purpose is to help\n    distribute objects in memory sections for hashed data structures\n    such as `HashMap` and friends.\n  - The above changes allow us to share `PartialConfig` comparison logic\n    without causing circular dependencies during Spring dependency\n    injection.\n\nKnown innocent bystanders of drive-by/hand-grenade refactoring:\n\n  - `GoPartialConfig` renamed to `PartialConfigService` and no longer\n    holds the implementation for `PartialConfig` comparison.\n  - `EntityHashingService` is no longer responsible for the digest\n    implementation (that is now handled by `EntityHashes`); rather, it\n    is concerned with listener registration and etag generation of\n    specific entity types, and caching those digest values.\n  - /Go.*Config.*(Service|DataSource)?.*/ and friends - so, so many\n    dependent components suffered refactoring on account of all of the\n    above as well as housekeeping (a number of unused constructor params\n    were gutted).", "committedDate": "2020-06-29T16:30:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5NjcyMQ==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r445196721", "bodyText": "Maybe rename partials =>  partialConfigHelper?", "author": "maheshp", "createdAt": "2020-06-24T22:01:49Z", "path": "server/src/main/java/com/thoughtworks/go/config/PartialConfigService.java", "diffHunk": "@@ -28,49 +27,36 @@\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n-import java.util.List;\n-import java.util.Objects;\n-import java.util.Optional;\n import java.util.Set;\n \n import static java.lang.String.format;\n \n-/**\n- * @understands current state of configuration part.\n- * <p/>\n- * Provides partial configurations.\n- */\n @Component\n-public class GoPartialConfig implements PartialConfigUpdateCompletedListener, ChangedRepoConfigWatchListListener {\n+public class PartialConfigService implements PartialConfigUpdateCompletedListener, ChangedRepoConfigWatchListListener {\n     public static final String INVALID_CRUISE_CONFIG_MERGE = \"Invalid Merged Configuration\";\n \n     private final GoConfigService goConfigService;\n     private final CachedGoPartials cachedGoPartials;\n     private final ServerHealthService serverHealthService;\n-    private final EntityHashingService entityHashingService;\n+    private final PartialConfigHelper partials;\n     private final GoConfigRepoConfigDataSource repoConfigDataSource;\n     private final GoConfigWatchList configWatchList;\n \n     @Autowired\n-    public GoPartialConfig(GoConfigRepoConfigDataSource repoConfigDataSource,\n-                           GoConfigWatchList configWatchList, GoConfigService goConfigService,\n-                           CachedGoPartials cachedGoPartials, ServerHealthService serverHealthService,\n-                           EntityHashingService entityHashingService) {\n+    public PartialConfigService(GoConfigRepoConfigDataSource repoConfigDataSource,\n+                                GoConfigWatchList configWatchList, GoConfigService goConfigService,\n+                                CachedGoPartials cachedGoPartials, ServerHealthService serverHealthService, PartialConfigHelper partials) {\n         this.repoConfigDataSource = repoConfigDataSource;\n         this.configWatchList = configWatchList;\n         this.goConfigService = goConfigService;\n         this.cachedGoPartials = cachedGoPartials;\n         this.serverHealthService = serverHealthService;\n-        this.entityHashingService = entityHashingService;\n+        this.partials = partials;", "originalCommit": "93a48662074e527549156178185dd4d1fa1e11e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzNTYyMA==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r447335620", "bodyText": "Sure, I can do that", "author": "marques-work", "createdAt": "2020-06-30T00:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5NjcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzNjc4MA==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r447336780", "bodyText": "Done.", "author": "marques-work", "createdAt": "2020-06-30T00:30:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5NjcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMzg5OQ==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r445223899", "bodyText": "Why do we need to hash values separately here? src.getValue() returns a plain text value.", "author": "maheshp", "createdAt": "2020-06-24T23:21:43Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/EntityHashes.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.server.service;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSerializer;\n+import com.thoughtworks.go.config.ConfigCache;\n+import com.thoughtworks.go.config.EnvironmentVariableConfig;\n+import com.thoughtworks.go.config.MagicalGoConfigXmlWriter;\n+import com.thoughtworks.go.config.registry.ConfigElementImplementationRegistry;\n+import com.thoughtworks.go.config.remote.PartialConfig;\n+import com.thoughtworks.go.domain.config.ConfigurationProperty;\n+import com.thoughtworks.go.plugin.domain.common.PluginInfo;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.Collection;\n+import java.util.stream.Collectors;\n+\n+import static com.thoughtworks.go.util.CachedDigestUtils.sha512_256Hex;\n+import static org.apache.commons.lang3.StringUtils.join;\n+\n+@Component\n+public class EntityHashes {\n+    public static final String SEP_CHAR = \"/\";\n+\n+    private static final Gson GSON = new GsonBuilder().\n+            registerTypeAdapter(ConfigurationProperty.class, Serializers.CONFIGURATION_PROPERTY).\n+            registerTypeAdapter(EnvironmentVariableConfig.class, Serializers.ENVIRONMENT_VARIABLE).\n+            registerTypeAdapter(PluginInfo.class, Serializers.PLUGIN_INFO).\n+            create();\n+\n+    private final MagicalGoConfigXmlWriter xmlSerializer;\n+\n+    @Autowired\n+    public EntityHashes(ConfigCache configCache, ConfigElementImplementationRegistry registry) {\n+        xmlSerializer = new MagicalGoConfigXmlWriter(configCache, registry);\n+    }\n+\n+    private static String digestHex(String data) {\n+        return sha512_256Hex(data);\n+    }\n+\n+    /**\n+     * Computes a digest of a {@link PartialConfig}.\n+     *\n+     * @param partial a {@link PartialConfig} to hash\n+     * @return a cryptographic digest that can be used for comparison.\n+     */\n+    public String digestPartial(PartialConfig partial) {\n+        if (null == partial) {\n+            return null;\n+        }\n+\n+        return digestMany(\n+                digestMany(partial.getGroups()),\n+                digestMany(partial.getEnvironments()),\n+                digestMany(partial.getScms())\n+        );\n+    }\n+\n+    public String digestMany(String... data) {\n+        return digestHex(join(data, SEP_CHAR));\n+    }\n+\n+    /**\n+     * Computes a cryptographic digest of a collection's contents\n+     *\n+     * @param entities any {@link Collection} of config entities\n+     * @return a cryptographic hex digest ({@link String})\n+     */\n+    public String digestMany(Collection<?> entities) {\n+        if (null == entities) {\n+            return null;\n+        }\n+\n+        return digestHex(entities.stream().\n+                map(this::digestDomainConfigEntity).\n+                collect(Collectors.joining(SEP_CHAR)));\n+    }\n+\n+    public String digestDomainConfigEntity(Object entity) {\n+        return digestHex(serializeDomainEntity(entity));\n+    }\n+\n+    public String digestDomainNonConfigEntity(Object entity) {\n+        return digestHex(GSON.toJson(entity));\n+    }\n+\n+    protected String serializeDomainEntity(Object domainObject) {\n+        return xmlSerializer.toXmlPartial(domainObject);\n+    }\n+\n+    private interface Serializers {\n+        /**\n+         * Custom serializer for encrypted data to ensure stable JSON output when crypto salt changes\n+         * over certain requests due to re-encryption\n+         */\n+        JsonSerializer<ConfigurationProperty> CONFIGURATION_PROPERTY = (src, typeOfSrc, context) -> {\n+            final JsonObject result = new JsonObject();\n+            result.addProperty(\"key\", src.getConfigKeyName());\n+            result.addProperty(\"value\", sha512_256Hex(src.getValue()));", "originalCommit": "93a48662074e527549156178185dd4d1fa1e11e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzNTI3Mw==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r447335273", "bodyText": "@maheshp I think I did this mostly out of paranoia; in case anyone ever exposes the Gson instance without thinking about consequences, I didn't want actual secrets ever making it out to I/O (getValue() may return decrypted secrets if src is an encrypted value, IIRC). It's not really necessary. If you think performance will be negatively impacted (I don't, but you may know that something I don't), I can change it to be plaintext.", "author": "marques-work", "createdAt": "2020-06-30T00:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMzg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyNTg5Ng==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r448025896", "bodyText": "I get your point.\nI am not sure how much of a performance impact this will have since we hash values for each config property. We will have to verify the impact and take a call.", "author": "maheshp", "createdAt": "2020-06-30T23:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMzg5OQ=="}], "type": "inlineReview"}, {"oid": "dd988589bf54f0da13420837478f1e0528e6e826", "url": "https://github.com/gocd/gocd/commit/dd988589bf54f0da13420837478f1e0528e6e826", "message": "`GoFileConfigDataSource#areKnownPartialsSameAsValidPartials()` should base its result on structure and not just the origins\n\nThis involves a number of refactorings, but most importantly:\n\n  - Extract `PartialConfig` digest and diffing logic into `PartialConfigHelper`.\n  - Extract digest calculations into `EntityHashes` component.\n  - Replace all `hashCode()` digests with serialized content digests;\n    `hashCode()` collisions are surprisingly easy as uniqueness is not\n    part of the contract of `hashCode()`; its purpose is to help\n    distribute objects in memory sections for hashed data structures\n    such as `HashMap` and friends.\n  - The above changes allow us to share `PartialConfig` comparison logic\n    without causing circular dependencies during Spring dependency\n    injection.\n\nKnown innocent bystanders of drive-by/hand-grenade refactoring:\n\n  - `GoPartialConfig` renamed to `PartialConfigService` and no longer\n    holds the implementation for `PartialConfig` comparison.\n  - `EntityHashingService` is no longer responsible for the digest\n    implementation (that is now handled by `EntityHashes`); rather, it\n    is concerned with listener registration and etag generation of\n    specific entity types, and caching those digest values.\n  - /Go.*Config.*(Service|DataSource)?.*/ and friends - so, so many\n    dependent components suffered refactoring on account of all of the\n    above as well as housekeeping (a number of unused constructor params\n    were gutted).", "committedDate": "2020-06-30T00:29:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMTI1Mg==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r448021252", "bodyText": "@marques-work origins comparison checks for equality of ConfigRepoConfig and revision. Since we check for revision equality do we need to check if it is isStructurallyEquivalent? Am I missing anything here?", "author": "maheshp", "createdAt": "2020-06-30T22:48:20Z", "path": "server/src/main/java/com/thoughtworks/go/config/PartialConfigHelper.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.config;\n+\n+import com.thoughtworks.go.config.remote.PartialConfig;\n+import com.thoughtworks.go.config.remote.RepoConfigOrigin;\n+import com.thoughtworks.go.server.service.EntityHashes;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class PartialConfigHelper {\n+    private final EntityHashes hashes;\n+\n+    @Autowired\n+    public PartialConfigHelper(EntityHashes hashes) {\n+        this.hashes = hashes;\n+    }\n+\n+    /**\n+     * Tests whether two {@link PartialConfig} instances have identical structure and origin\n+     *\n+     * @param left  a {@link PartialConfig}\n+     * @param right a {@link PartialConfig}\n+     * @return whether or not the {@link PartialConfig}s are equivalent\n+     */\n+    public boolean isEquivalent(PartialConfig left, PartialConfig right) {\n+        return hasSameOrigins(left, right) && isStructurallyEquivalent(left, right);", "originalCommit": "dd988589bf54f0da13420837478f1e0528e6e826", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxMzUyNQ==", "url": "https://github.com/gocd/gocd/pull/8241#discussion_r448413525", "bodyText": "Ignore my previous comment. Once we add branch support the partials can change for the same revision, hence I understand we would need to check if they are structurally same.", "author": "maheshp", "createdAt": "2020-07-01T14:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMTI1Mg=="}], "type": "inlineReview"}, {"oid": "16eb91c6e99d6cfd4bb4e25a4b66ebe7e2c6d2e2", "url": "https://github.com/gocd/gocd/commit/16eb91c6e99d6cfd4bb4e25a4b66ebe7e2c6d2e2", "message": "`GoFileConfigDataSource#areKnownPartialsSameAsValidPartials()` should base its result on structure and not just the origins\n\nThis involves a number of refactorings, but most importantly:\n\n  - Extract `PartialConfig` digest and diffing logic into `PartialConfigHelper`.\n  - Extract digest calculations into `EntityHashes` component.\n  - Replace all `hashCode()` digests with serialized content digests;\n    `hashCode()` collisions are surprisingly easy as uniqueness is not\n    part of the contract of `hashCode()`; its purpose is to help\n    distribute objects in memory sections for hashed data structures\n    such as `HashMap` and friends.\n  - The above changes allow us to share `PartialConfig` comparison logic\n    without causing circular dependencies during Spring dependency\n    injection.\n\nKnown innocent bystanders of drive-by/hand-grenade refactoring:\n\n  - `GoPartialConfig` renamed to `PartialConfigService` and no longer\n    holds the implementation for `PartialConfig` comparison.\n  - `EntityHashingService` is no longer responsible for the digest\n    implementation (that is now handled by `EntityHashes`); rather, it\n    is concerned with listener registration and etag generation of\n    specific entity types, and caching those digest values.\n  - /Go.*Config.*(Service|DataSource)?.*/ and friends - so, so many\n    dependent components suffered refactoring on account of all of the\n    above as well as housekeeping (a number of unused constructor params\n    were gutted).", "committedDate": "2020-07-01T18:07:07Z", "type": "commit"}, {"oid": "16eb91c6e99d6cfd4bb4e25a4b66ebe7e2c6d2e2", "url": "https://github.com/gocd/gocd/commit/16eb91c6e99d6cfd4bb4e25a4b66ebe7e2c6d2e2", "message": "`GoFileConfigDataSource#areKnownPartialsSameAsValidPartials()` should base its result on structure and not just the origins\n\nThis involves a number of refactorings, but most importantly:\n\n  - Extract `PartialConfig` digest and diffing logic into `PartialConfigHelper`.\n  - Extract digest calculations into `EntityHashes` component.\n  - Replace all `hashCode()` digests with serialized content digests;\n    `hashCode()` collisions are surprisingly easy as uniqueness is not\n    part of the contract of `hashCode()`; its purpose is to help\n    distribute objects in memory sections for hashed data structures\n    such as `HashMap` and friends.\n  - The above changes allow us to share `PartialConfig` comparison logic\n    without causing circular dependencies during Spring dependency\n    injection.\n\nKnown innocent bystanders of drive-by/hand-grenade refactoring:\n\n  - `GoPartialConfig` renamed to `PartialConfigService` and no longer\n    holds the implementation for `PartialConfig` comparison.\n  - `EntityHashingService` is no longer responsible for the digest\n    implementation (that is now handled by `EntityHashes`); rather, it\n    is concerned with listener registration and etag generation of\n    specific entity types, and caching those digest values.\n  - /Go.*Config.*(Service|DataSource)?.*/ and friends - so, so many\n    dependent components suffered refactoring on account of all of the\n    above as well as housekeeping (a number of unused constructor params\n    were gutted).", "committedDate": "2020-07-01T18:07:07Z", "type": "forcePushed"}]}