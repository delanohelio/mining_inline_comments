{"pr_number": 8426, "pr_title": "Add internal endpoint to render modifications for a given material", "pr_createdAt": "2020-08-05T07:41:28Z", "pr_url": "https://github.com/gocd/gocd/pull/8426", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg1MDgyNw==", "url": "https://github.com/gocd/gocd/pull/8426#discussion_r465850827", "bodyText": "I would probably add these methods to ApiController over creating this new interface.", "author": "maheshp", "createdAt": "2020-08-05T16:26:33Z", "path": "api/api-base/src/main/java/com/thoughtworks/go/api/HistoryMethods.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.thoughtworks.go.api;\n+\n+import com.thoughtworks.go.config.exceptions.BadRequestException;\n+import spark.Request;\n+\n+import static org.apache.commons.lang3.StringUtils.isBlank;\n+\n+public interface HistoryMethods {\n+    String BAD_PAGE_SIZE_MSG = \"The query parameter 'page_size', if specified must be a number between 10 and 100.\";\n+    String BAD_CURSOR_MSG = \"The query parameter '%s', if specified, must be a positive integer.\";\n+\n+    default Integer getPageSize(Request request) {", "originalCommit": "ab3ce163418dd6e4352b6e8df66e2c291a288867", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxNjA0Nw==", "url": "https://github.com/gocd/gocd/pull/8426#discussion_r465916047", "bodyText": "Is the lookup for MaterialInstance required, we get the material fingerprint as part of the request, can't we just fire a single query to fetch modifications and join on materials which matches the fingerprint?", "author": "maheshp", "createdAt": "2020-08-05T18:19:03Z", "path": "server/src/main/java/com/thoughtworks/go/server/service/MaterialService.java", "diffHunk": "@@ -169,4 +172,44 @@ private void resolveSecretParams(Material material) {\n                 .stream()\n                 .collect(toMap(mod -> mod.getMaterialInstance().getFingerprint(), mod -> mod));\n     }\n+\n+    public List<Modification> getModificationsFor(MaterialConfig materialConfig, long afterCursor, long beforeCursor, Integer pageSize) {\n+        MaterialInstance materialInstance = materialRepository.findMaterialInstance(materialConfig);", "originalCommit": "ab3ce163418dd6e4352b6e8df66e2c291a288867", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NTg1OQ==", "url": "https://github.com/gocd/gocd/pull/8426#discussion_r466155859", "bodyText": "This query is cached. Also, IMO, join would be an expensive operation. Will deploy this as is on build.gocd. Based on the response there - we can later on raise another PR for performance improvement. WDYT?", "author": "kritika-singh3", "createdAt": "2020-08-06T05:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxNjA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3NjMyOQ==", "url": "https://github.com/gocd/gocd/pull/8426#discussion_r466476329", "bodyText": "Previously I had seen 3 queries fired to fetch the modifications, hence I suggested we use joins. Since MaterialInstance lookup is cached a query to fetch modifications should be fine. Either way we should benchmark  these queries before taking a decision.", "author": "maheshp", "createdAt": "2020-08-06T14:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxNjA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxNjg3Mg==", "url": "https://github.com/gocd/gocd/pull/8426#discussion_r465916872", "bodyText": "Why do we need a exactMatchQuery, are we expecting users to provide the complete material revision?", "author": "maheshp", "createdAt": "2020-08-05T18:20:30Z", "path": "server/src/main/java/com/thoughtworks/go/server/persistence/MaterialRepository.java", "diffHunk": "@@ -1040,4 +1042,172 @@ public File folderFor(Material material) {\n                     .list();\n         });\n     }\n+\n+    public List<Modification> loadHistory(long materialId, FeedModifier modifier, long cursor, Integer pageSize) {\n+        Map<String, Object> params = new HashMap<>();\n+        String queryString = null;\n+        switch (modifier) {\n+            case Latest:\n+                queryString = \"SELECT * \" +\n+                        \"FROM modifications \" +\n+                        \"WHERE materialid = :materialId \" +\n+                        \"ORDER BY id DESC \" +\n+                        \"LIMIT :size \";\n+                params.put(\"materialId\", materialId);\n+                params.put(\"size\", pageSize);\n+                break;\n+            case After:\n+                queryString = \"SELECT * \" +\n+                        \"FROM modifications \" +\n+                        \"WHERE materialid = :materialId \" +\n+                        \"  and id < :cursor \" +\n+                        \"ORDER BY id DESC \" +\n+                        \"LIMIT :size \";\n+                params.put(\"materialId\", materialId);\n+                params.put(\"size\", pageSize);\n+                params.put(\"cursor\", cursor);\n+                break;\n+            case Before:\n+                queryString = \"SELECT * \" +\n+                        \"FROM (SELECT * \" +\n+                        \"      FROM modifications \" +\n+                        \"      WHERE materialid = :materialId \" +\n+                        \"        and id > :cursor \" +\n+                        \"      ORDER BY id ASC \" +\n+                        \"      LIMIT :size ) as HistoryBeforeSpecifiedId \" +\n+                        \"ORDER BY id DESC\";\n+                params.put(\"materialId\", materialId);\n+                params.put(\"size\", pageSize);\n+                params.put(\"cursor\", cursor);\n+                break;\n+        }\n+        String finalQueryString = queryString;\n+        List<Modification> mods = (List<Modification>) getHibernateTemplate().execute((HibernateCallback) session -> {\n+            SQLQuery query = session.createSQLQuery(finalQueryString);\n+            query.setProperties(params);\n+            return query.addEntity(\"mods\", Modification.class)\n+                    .list();\n+        });\n+        return mods;\n+    }\n+\n+    public PipelineRunIdInfo getOldestAndLatestModificationId(long materialId, String pattern) {\n+        String queryString = \"SELECT MAX(modifications.id) as latestRunId, MIN(modifications.id) as oldestRunId \" +\n+                \"FROM modifications \" +\n+                \"WHERE modifications.materialid = :materialId \";\n+        Map<String, Object> params = new HashMap<>();\n+        params.put(\"materialId\", materialId);\n+        if (isNotBlank(pattern)) {\n+            queryString = queryString +\n+                    \"  AND (LOWER(modifications.comment) LIKE :pattern \" +\n+                    \"  OR LOWER(modifications.userName) LIKE :pattern \" +\n+                    \"  OR LOWER(modifications.revision) LIKE :pattern ) \";\n+\n+            params.put(\"pattern\", \"%\" + pattern.toLowerCase() + \"%\");\n+        }\n+        String finalQueryString = queryString;\n+        Object[] info = (Object[]) getHibernateTemplate().execute((HibernateCallback) session -> {\n+            SQLQuery query = session.createSQLQuery(finalQueryString);\n+            query.setProperties(params);\n+            return query.addScalar(\"latestRunId\", new LongType())\n+                    .addScalar(\"oldestRunId\", new LongType())\n+                    .uniqueResult();\n+        });\n+        if (info == null || info[0] == null || info[1] == null) {\n+            return null;\n+        }\n+        return new PipelineRunIdInfo((long) info[0], (long) info[1]);\n+    }\n+\n+    public List<Modification> findLatestMatchingModifications(long materialId, String pattern, Integer pageSize) {\n+        Map<String, Object> params = new HashMap<>();\n+        params.put(\"materialId\", materialId);\n+        params.put(\"pattern\", \"%\" + pattern.toLowerCase() + \"%\");\n+        params.put(\"rawPattern\", pattern.toLowerCase());\n+        params.put(\"size\", pageSize);\n+        String exactMatchQuery = \"SELECT * \" +\n+                \"FROM modifications \" +\n+                \"WHERE materialid = :materialId \" +\n+                \"  AND LOWER(revision) = :rawPattern \" +\n+                \"ORDER BY id DESC \" +\n+                \"LIMIT :size\";\n+        String likeMatchQuery = \"SELECT * \" +\n+                \"FROM modifications \" +\n+                \"WHERE materialid = :materialId \" +\n+                \"  AND (LOWER(modifications.comment) LIKE :pattern \" +\n+                \"  OR LOWER(userName) LIKE :pattern \" +\n+                \"  OR LOWER(revision) LIKE :pattern ) \" +\n+                \"ORDER BY id DESC \" +\n+                \"LIMIT :size\";\n+        return getMatchingModifications(exactMatchQuery, likeMatchQuery, params);\n+    }\n+\n+    public List<Modification> findMatchingModificationsBeforeCursor(long materialId, String pattern, long cursor, Integer pageSize) {\n+        Map<String, Object> params = new HashMap<>();\n+        params.put(\"materialId\", materialId);\n+        params.put(\"pattern\", \"%\" + pattern.toLowerCase() + \"%\");\n+        params.put(\"rawPattern\", pattern.toLowerCase());\n+        params.put(\"size\", pageSize);\n+        params.put(\"cursor\", cursor);\n+        String exactMatchQuery = \"SELECT * \" +\n+                \"FROM ( SELECT * \" +\n+                \"    FROM modifications \" +\n+                \"    WHERE materialid = :materialId AND id > :cursor \" +\n+                \"      AND LOWER(revision) = :rawPattern \" +\n+                \"    ORDER BY id DESC \" +\n+                \"    LIMIT :size ) as MatchBeforeSpecifiedCursor \" +\n+                \"ORDER BY id DESC\";\n+        String likeMatchQuery = \"SELECT * \" +\n+                \"FROM ( SELECT * \" +\n+                \"    FROM modifications \" +\n+                \"    WHERE materialid = :materialId AND id > :cursor \" +\n+                \"      AND (LOWER(modifications.comment) LIKE :pattern \" +\n+                \"      OR LOWER(userName) LIKE :pattern \" +\n+                \"      OR LOWER(revision) LIKE :pattern ) \" +\n+                \"    ORDER BY id DESC \" +\n+                \"    LIMIT :size) as LikeMatchBeforeSpecifiedCursor \" +\n+                \"ORDER BY id DESC\";\n+        return getMatchingModifications(exactMatchQuery, likeMatchQuery, params);\n+    }\n+\n+    public List<Modification> findMatchingModificationsAfterCursor(long materialId, String pattern, long cursor, Integer pageSize) {\n+        Map<String, Object> params = new HashMap<>();\n+        params.put(\"materialId\", materialId);\n+        params.put(\"pattern\", \"%\" + pattern.toLowerCase() + \"%\");\n+        params.put(\"rawPattern\", pattern.toLowerCase());\n+        params.put(\"size\", pageSize);\n+        params.put(\"cursor\", cursor);\n+        String exactMatchQuery = \"SELECT * \" +", "originalCommit": "ab3ce163418dd6e4352b6e8df66e2c291a288867", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NjAxNA==", "url": "https://github.com/gocd/gocd/pull/8426#discussion_r466156014", "bodyText": "No we explicitly don't have any usecase as of now. Will remove this.", "author": "kritika-singh3", "createdAt": "2020-08-06T05:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxNjg3Mg=="}], "type": "inlineReview"}, {"oid": "22f9231d3e4470b1c8fa7085b58eae2de16fe288", "url": "https://github.com/gocd/gocd/commit/22f9231d3e4470b1c8fa7085b58eae2de16fe288", "message": "Removed the exact match query from modification search\n - refactored a bit", "committedDate": "2020-08-06T05:31:02Z", "type": "forcePushed"}, {"oid": "79eb91373253078fb565ad73718c9a5f0242b996", "url": "https://github.com/gocd/gocd/commit/79eb91373253078fb565ad73718c9a5f0242b996", "message": "Removed the exact match query from modification search\n - refactored a bit", "committedDate": "2020-08-06T08:05:37Z", "type": "forcePushed"}, {"oid": "3e78edca4bd164b9220be7a330bb401ef87119b3", "url": "https://github.com/gocd/gocd/commit/3e78edca4bd164b9220be7a330bb401ef87119b3", "message": "Refactored:\n - moved the logic of extracting cursor and page_size to interface HistoryMethods\n - moved the logic of validating cursor to ServiceConstants", "committedDate": "2020-08-07T03:49:23Z", "type": "commit"}, {"oid": "8d922baf8f42ef5ec9255bd46f690292fc31f7a6", "url": "https://github.com/gocd/gocd/commit/8d922baf8f42ef5ec9255bd46f690292fc31f7a6", "message": "Updates\n - added modification endpoint for a given material fingerprint\n - utilized cursor based pagination for the same", "committedDate": "2020-08-07T03:49:23Z", "type": "commit"}, {"oid": "65638505267995d0c812a8123fb93022320be83a", "url": "https://github.com/gocd/gocd/commit/65638505267995d0c812a8123fb93022320be83a", "message": "Update:\n\n - added support for `pattern` query paramater for modification endpoint\n - will return modifications which contains the specified pattern in revision, comment and username\n - supports cursor based pagination", "committedDate": "2020-08-07T03:49:23Z", "type": "commit"}, {"oid": "fbe5c1965223d9be7634a7f0281c7dedfc25249c", "url": "https://github.com/gocd/gocd/commit/fbe5c1965223d9be7634a7f0281c7dedfc25249c", "message": "Merge HistoryMethods with ApiController. The former served as a holder for helper methods. The latter was a better place for them.", "committedDate": "2020-08-07T03:49:23Z", "type": "commit"}, {"oid": "7ccd8de2ab296ca2c64f33086ae2e8a7ae26b696", "url": "https://github.com/gocd/gocd/commit/7ccd8de2ab296ca2c64f33086ae2e8a7ae26b696", "message": "Removed the exact match query from modification search\n - refactored a bit", "committedDate": "2020-08-07T03:49:23Z", "type": "commit"}, {"oid": "037b9016a2693a9885cfc840bc6a74986b0601f2", "url": "https://github.com/gocd/gocd/commit/037b9016a2693a9885cfc840bc6a74986b0601f2", "message": "Refactored for cleaner code\n - add pattern to the next and previous link if present", "committedDate": "2020-08-07T05:10:56Z", "type": "commit"}, {"oid": "037b9016a2693a9885cfc840bc6a74986b0601f2", "url": "https://github.com/gocd/gocd/commit/037b9016a2693a9885cfc840bc6a74986b0601f2", "message": "Refactored for cleaner code\n - add pattern to the next and previous link if present", "committedDate": "2020-08-07T05:10:56Z", "type": "forcePushed"}]}