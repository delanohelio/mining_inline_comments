{"pr_number": 175, "pr_title": "S3S3Copier thread updates", "pr_createdAt": "2020-03-12T22:40:15Z", "pr_url": "https://github.com/ExpediaGroup/circus-train/pull/175", "timeline": [{"oid": "bb70d85f401ef3f9871e0846828529cb6b5c6438", "url": "https://github.com/ExpediaGroup/circus-train/commit/bb70d85f401ef3f9871e0846828529cb6b5c6438", "message": "testing s3 copier assume-role issues", "committedDate": "2020-03-05T22:43:14Z", "type": "commit"}, {"oid": "ce0f2a1dffe03829cef71e1a961b97f55efc72fe", "url": "https://github.com/ExpediaGroup/circus-train/commit/ce0f2a1dffe03829cef71e1a961b97f55efc72fe", "message": "refactor s3 retry logic to be job based vs all or nothing. This should catch errors sooner", "committedDate": "2020-03-09T17:30:03Z", "type": "commit"}, {"oid": "bb76993aa15b8bc598e1894f968d39fa39394e46", "url": "https://github.com/ExpediaGroup/circus-train/commit/bb76993aa15b8bc598e1894f968d39fa39394e46", "message": "defensive coding against cred failure", "committedDate": "2020-03-09T17:36:33Z", "type": "commit"}, {"oid": "2f988f373fab0bb657bd0b8bb2dd29805e771838", "url": "https://github.com/ExpediaGroup/circus-train/commit/2f988f373fab0bb657bd0b8bb2dd29805e771838", "message": "revert some code", "committedDate": "2020-03-09T18:15:54Z", "type": "commit"}, {"oid": "966b6cf20546537ee84ad99146e305732093cc09", "url": "https://github.com/ExpediaGroup/circus-train/commit/966b6cf20546537ee84ad99146e305732093cc09", "message": "update log comments", "committedDate": "2020-03-09T18:18:43Z", "type": "commit"}, {"oid": "085740a991b10d682c93d558ccd985c664a7ee63", "url": "https://github.com/ExpediaGroup/circus-train/commit/085740a991b10d682c93d558ccd985c664a7ee63", "message": "revert whitespace", "committedDate": "2020-03-09T18:20:04Z", "type": "commit"}, {"oid": "ad63df289ccf31bbae3e45f0fe7fe9320e481c92", "url": "https://github.com/ExpediaGroup/circus-train/commit/ad63df289ccf31bbae3e45f0fe7fe9320e481c92", "message": "set to minimum duration", "committedDate": "2020-03-09T18:24:59Z", "type": "commit"}, {"oid": "f620ce60f399cc9e8042edb6edb5a2d2d64b18f0", "url": "https://github.com/ExpediaGroup/circus-train/commit/f620ce60f399cc9e8042edb6edb5a2d2d64b18f0", "message": "wip", "committedDate": "2020-03-09T22:02:33Z", "type": "commit"}, {"oid": "001cd306bb49e0c4f63e905666475bbd2d6bd74f", "url": "https://github.com/ExpediaGroup/circus-train/commit/001cd306bb49e0c4f63e905666475bbd2d6bd74f", "message": "debugging wip", "committedDate": "2020-03-11T16:09:30Z", "type": "commit"}, {"oid": "9bd36e7c466856ff33492848b05d7e272ff3cce6", "url": "https://github.com/ExpediaGroup/circus-train/commit/9bd36e7c466856ff33492848b05d7e272ff3cce6", "message": "optimize some threadpooling logic", "committedDate": "2020-03-11T22:14:31Z", "type": "commit"}, {"oid": "50279ff0eb8c2ec7a3f665509eee9256154d2eec", "url": "https://github.com/ExpediaGroup/circus-train/commit/50279ff0eb8c2ec7a3f665509eee9256154d2eec", "message": "update readme & changelog", "committedDate": "2020-03-12T21:38:28Z", "type": "commit"}, {"oid": "a4abfa2fd36a15b8493c230a5686d834327f409d", "url": "https://github.com/ExpediaGroup/circus-train/commit/a4abfa2fd36a15b8493c230a5686d834327f409d", "message": "add transfermanagerFactoryTest", "committedDate": "2020-03-12T22:39:56Z", "type": "commit"}, {"oid": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "url": "https://github.com/ExpediaGroup/circus-train/commit/e8454abc8598f24e2a7e682da8ea0eed2f8db236", "message": "reset untouched files", "committedDate": "2020-03-12T22:42:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwMjQxNw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392102417", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final int DEFAULT_CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n          \n          \n            \n              private static final int DEFAULT_MAX_CREDENTIALS_DURATION_SECONDS = TimeUnit.HOURS.toSeconds(12);", "author": "teabot", "createdAt": "2020-03-13T09:01:02Z", "path": "circus-train-aws/src/main/java/com/hotels/bdp/circustrain/aws/AssumeRoleCredentialProvider.java", "diffHunk": "@@ -16,45 +16,57 @@\n package com.hotels.bdp.circustrain.aws;\n \n import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Preconditions.checkNotNull;\n \n import org.apache.commons.lang3.StringUtils;\n import org.apache.hadoop.conf.Configuration;\n \n import com.amazonaws.auth.AWSCredentials;\n import com.amazonaws.auth.AWSCredentialsProvider;\n import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider;\n-import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider.Builder;\n \n public class AssumeRoleCredentialProvider implements AWSCredentialsProvider {\n \n   public static final String ASSUME_ROLE_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRole\";\n-  private static final int CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n+  public static final String ASSUME_ROLE_CREDENTIAL_DURATION_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRoleCredentialDuration\";\n+  private static final int DEFAULT_CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwMzUxMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392103510", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return MapUtils.getIntValue(copierOptions, Keys.ASSUME_ROLE_CREDENTIAL_DURATION.keyName(), 12 * 60 * 60);\n          \n          \n            \n                return MapUtils.getIntValue(copierOptions, Keys.ASSUME_ROLE_CREDENTIAL_DURATION.keyName(), TimeUnit.HOURS.toSeconds(12));", "author": "teabot", "createdAt": "2020-03-13T09:03:29Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3CopierOptions.java", "diffHunk": "@@ -131,6 +148,10 @@ public String getAssumedRole() {\n     return MapUtils.getString(copierOptions, Keys.ASSUME_ROLE.keyName(), null);\n   }\n \n+  public int getAssumedRoleCredentialDuration() {\n+    return MapUtils.getIntValue(copierOptions, Keys.ASSUME_ROLE_CREDENTIAL_DURATION.keyName(), 12 * 60 * 60);", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNDcxMg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392104712", "bodyText": "What does -1 mean in this context? If it for example means 'unbounded', then assign to suitably named constant:\n   private static final int UNBOUNDED = -1;\n   ...\n   return MapUtils.getInteger(copierOptions, Keys.MAX_THREAD_POOL_SIZE.keyName(), UNBOUNDED);\n\nNote, I use unbounded as an example - I don't know what -1 means in this context - which is precisely the problem this addresses.", "author": "teabot", "createdAt": "2020-03-13T09:06:09Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3CopierOptions.java", "diffHunk": "@@ -86,6 +95,14 @@ public S3S3CopierOptions(Map<String, Object> copierOptions) {\n     this.copierOptions = new HashMap<>(copierOptions);\n   }\n \n+  public void overrideMaxThreadPoolSize(int newMax) {\n+    copierOptions.put(Keys.MAX_THREAD_POOL_SIZE.keyName(), newMax);\n+  }\n+\n+  public int getMaxThreadPoolSize() {\n+    return MapUtils.getInteger(copierOptions, Keys.MAX_THREAD_POOL_SIZE.keyName(), -1);", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4MTUzNA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392281534", "bodyText": "-1 in this context means to default to using the default pool size for transferManager. Took that suggestion though and updated the code accordingly to get rid of any magic number checks. New var name is USE_DEFAULT_THREAD_POOL_MAX", "author": "KenFigueiredo", "createdAt": "2020-03-13T15:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNDcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNzkzOQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392337939", "bodyText": "removed as per @patduin comment of just defaulting to 10 w/ our own executor.", "author": "KenFigueiredo", "createdAt": "2020-03-13T16:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNDcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI0MTAzMQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392241031", "bodyText": "Amount of time", "author": "barnharts4", "createdAt": "2020-03-13T13:53:44Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3CopierOptions.java", "diffHunk": "@@ -60,10 +60,19 @@\n      * access to the target.\n      */\n     ASSUME_ROLE(\"assume-role\"),\n+    /**\n+     * Number of time (in seconds) that the AWS SDK should assume the given role for.", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df860e16c709278b091bec93d7b99119f376f6f5", "url": "https://github.com/ExpediaGroup/circus-train/commit/df860e16c709278b091bec93d7b99119f376f6f5", "message": "fix the nits", "committedDate": "2020-03-13T14:54:24Z", "type": "commit"}, {"oid": "6b7356b0958d6ec301ced55981b6811b0d2b53f5", "url": "https://github.com/ExpediaGroup/circus-train/commit/6b7356b0958d6ec301ced55981b6811b0d2b53f5", "message": "default_max_thread_pool -> default_thread_pool_max", "committedDate": "2020-03-13T15:01:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4MzAxMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392283010", "bodyText": "perhaps default this to 10 (as per readme)  and remove the if check for -1 in the TransferManagerFactory. Just always set our own.", "author": "patduin", "createdAt": "2020-03-13T15:02:31Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3CopierOptions.java", "diffHunk": "@@ -77,6 +87,7 @@ public String keyName() {\n   }\n \n   private final Map<String, Object> copierOptions;\n+  public static final int USE_DEFAULT_MAX_THREAD_POOL = -1;", "originalCommit": "df860e16c709278b091bec93d7b99119f376f6f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4Mzg2NA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392283864", "bodyText": "just always set our own executor, will be easier to read the code.", "author": "patduin", "createdAt": "2020-03-13T15:03:51Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/TransferManagerFactory.java", "diffHunk": "@@ -26,12 +31,19 @@\n @Component\n public class TransferManagerFactory {\n \n+  private static final Logger LOG = LoggerFactory.getLogger(TransferManagerFactory.class);\n+\n   public TransferManager newInstance(AmazonS3 targetS3Client, S3S3CopierOptions s3s3CopierOptions) {\n-    return TransferManagerBuilder\n-        .standard()\n+    TransferManagerBuilder builder = TransferManagerBuilder.standard()\n         .withMultipartCopyThreshold(s3s3CopierOptions.getMultipartCopyThreshold())\n         .withMultipartCopyPartSize(s3s3CopierOptions.getMultipartCopyPartSize())\n-        .withS3Client(targetS3Client)\n-        .build();\n+        .withS3Client(targetS3Client);\n+\n+    if (s3s3CopierOptions.getMaxThreadPoolSize() != S3S3CopierOptions.USE_DEFAULT_THREAD_POOL_MAX) {", "originalCommit": "6b7356b0958d6ec301ced55981b6811b0d2b53f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NDUyNw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392284527", "bodyText": "remove the if just set the default.", "author": "patduin", "createdAt": "2020-03-13T15:04:58Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/JceksAmazonS3ClientFactory.java", "diffHunk": "@@ -103,13 +103,27 @@ private String regionForUri(AmazonS3 client, AmazonS3URI uri) {\n     return bucketRegion;\n   }\n \n+  private AmazonS3ClientBuilder applyClientConfigurations(AmazonS3ClientBuilder builder, S3S3CopierOptions s3s3CopierOptions) {\n+    ClientConfiguration clientConfiguration = new ClientConfiguration();\n+\n+    if (s3s3CopierOptions.getMaxThreadPoolSize() != S3S3CopierOptions.USE_DEFAULT_THREAD_POOL_MAX) {", "originalCommit": "6b7356b0958d6ec301ced55981b6811b0d2b53f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI2NzU1Mg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392267552", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ## [16.0.1] - TBD\n          \n          \n            \n            ## [16.1.0] - TBD\n          \n      \n    \n    \n  \n\nI think we can consider this a new feature rather than just a bug fix.", "author": "massdosage", "createdAt": "2020-03-13T14:37:47Z", "path": "CHANGELOG.md", "diffHunk": "@@ -1,3 +1,8 @@\n+## [16.0.1] - TBD", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MDY1Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392270653", "bodyText": "I don't want to overcomplicate things but I do want to make sure our configuration across the whole project is consistent. Currently when we've used the word duration (see expired-path-duration) this refers to an ISO duration (see https://www.digi.com/resources/documentation/digidocs/90001437-13/reference/r_iso_8601_duration_format.htm). The other time-based configuration I can spot is the metrics reporter period and time-unit. I'd prefer we use that, or if we only ever want to support seconds then we add that to the configuration property name.", "author": "massdosage", "createdAt": "2020-03-13T14:42:44Z", "path": "README.md", "diffHunk": "@@ -396,7 +396,9 @@ If data is being replicated from S3 to S3 then Circus Train will use the AWS S3\n |`copier-options.canned-acl`|No|AWS Canned ACL name. See [Access Control List (ACL) Overview](https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl) for possible values. If not specified `S3S3Copier` will not specify any canned ACL.|\n |`copier-options.copier-factory-class`|No|Controls which copier is used for replication if provided.|\n |`copier-options.s3s3-retry-max-copy-attempts`|No|Controls the maximum number of attempts if AWS throws an error during copy. Default value is 3.|\n-| `copier-options.assume-role`|No|ARN of an IAM role to assume when writing S3 data to the target S3 location. Useful when the target is in a different AWS account than Circus Train is running in. Note that if JCEKS is also configured, JCEKS credentials will be used instead of assuming a role. If `assume-role` is not specified, the copier will use instance credentials. The role provided must have read access to the S3 source and write access to the S3 target.|\n+|`copier-options.assume-role`|No|ARN of an IAM role to assume when writing S3 data to the target S3 location. Useful when the target is in a different AWS account than Circus Train is running in. Note that if JCEKS is also configured, JCEKS credentials will be used instead of assuming a role. If `assume-role` is not specified, the copier will use instance credentials. The role provided must have read access to the S3 source and write access to the S3 target.|\n+|`copier-options.assume-role-credential-duration`|No| Number of time (in seconds) that the AWS SDK should assume the given role for. Default value is 12 hours.|", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjYwMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392372600", "bodyText": "moved to #176", "author": "KenFigueiredo", "createdAt": "2020-03-13T17:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MDY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MTU3MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392271570", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`s3s3-max-thread-pool-size`|No| Max number of threads to use for the transferManager thread pool. Defaults internally to 10 if unset on the client.|\n          \n          \n            \n            |`s3s3-max-thread-pool-size`|No| Max number of threads to use for the transferManager thread pool. Default value is 10.|\n          \n      \n    \n    \n  \n\nThe end users don't know about and can't use the client themselves can they?", "author": "massdosage", "createdAt": "2020-03-13T14:44:13Z", "path": "README.md", "diffHunk": "@@ -396,7 +396,9 @@ If data is being replicated from S3 to S3 then Circus Train will use the AWS S3\n |`copier-options.canned-acl`|No|AWS Canned ACL name. See [Access Control List (ACL) Overview](https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl) for possible values. If not specified `S3S3Copier` will not specify any canned ACL.|\n |`copier-options.copier-factory-class`|No|Controls which copier is used for replication if provided.|\n |`copier-options.s3s3-retry-max-copy-attempts`|No|Controls the maximum number of attempts if AWS throws an error during copy. Default value is 3.|\n-| `copier-options.assume-role`|No|ARN of an IAM role to assume when writing S3 data to the target S3 location. Useful when the target is in a different AWS account than Circus Train is running in. Note that if JCEKS is also configured, JCEKS credentials will be used instead of assuming a role. If `assume-role` is not specified, the copier will use instance credentials. The role provided must have read access to the S3 source and write access to the S3 target.|\n+|`copier-options.assume-role`|No|ARN of an IAM role to assume when writing S3 data to the target S3 location. Useful when the target is in a different AWS account than Circus Train is running in. Note that if JCEKS is also configured, JCEKS credentials will be used instead of assuming a role. If `assume-role` is not specified, the copier will use instance credentials. The role provided must have read access to the S3 source and write access to the S3 target.|\n+|`copier-options.assume-role-credential-duration`|No| Number of time (in seconds) that the AWS SDK should assume the given role for. Default value is 12 hours.|\n+|`s3s3-max-thread-pool-size`|No| Max number of threads to use for the transferManager thread pool. Defaults internally to 10 if unset on the client.|", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MjAwNg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392272006", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private STSAssumeRoleSessionCredentialsProvider credProvider;\n          \n          \n            \n              private STSAssumeRoleSessionCredentialsProvider credentialsProvider;", "author": "massdosage", "createdAt": "2020-03-13T14:44:58Z", "path": "circus-train-aws/src/main/java/com/hotels/bdp/circustrain/aws/AssumeRoleCredentialProvider.java", "diffHunk": "@@ -16,45 +16,57 @@\n package com.hotels.bdp.circustrain.aws;\n \n import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Preconditions.checkNotNull;\n \n import org.apache.commons.lang3.StringUtils;\n import org.apache.hadoop.conf.Configuration;\n \n import com.amazonaws.auth.AWSCredentials;\n import com.amazonaws.auth.AWSCredentialsProvider;\n import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider;\n-import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider.Builder;\n \n public class AssumeRoleCredentialProvider implements AWSCredentialsProvider {\n \n   public static final String ASSUME_ROLE_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRole\";\n-  private static final int CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n+  public static final String ASSUME_ROLE_CREDENTIAL_DURATION_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRoleCredentialDuration\";\n+  private static final int DEFAULT_CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n \n-  private AWSCredentials credentials;\n   private final Configuration conf;\n+  private STSAssumeRoleSessionCredentialsProvider credProvider;", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjUwMw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392372503", "bodyText": "moved to #176", "author": "KenFigueiredo", "createdAt": "2020-03-13T17:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MjAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MjYyOQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392272629", "bodyText": "Move this to line 42, there's no point getting the duration if this is going to fail.", "author": "massdosage", "createdAt": "2020-03-13T14:45:52Z", "path": "circus-train-aws/src/main/java/com/hotels/bdp/circustrain/aws/AssumeRoleCredentialProvider.java", "diffHunk": "@@ -16,45 +16,57 @@\n package com.hotels.bdp.circustrain.aws;\n \n import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Preconditions.checkNotNull;\n \n import org.apache.commons.lang3.StringUtils;\n import org.apache.hadoop.conf.Configuration;\n \n import com.amazonaws.auth.AWSCredentials;\n import com.amazonaws.auth.AWSCredentialsProvider;\n import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider;\n-import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider.Builder;\n \n public class AssumeRoleCredentialProvider implements AWSCredentialsProvider {\n \n   public static final String ASSUME_ROLE_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRole\";\n-  private static final int CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n+  public static final String ASSUME_ROLE_CREDENTIAL_DURATION_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRoleCredentialDuration\";\n+  private static final int DEFAULT_CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n \n-  private AWSCredentials credentials;\n   private final Configuration conf;\n+  private STSAssumeRoleSessionCredentialsProvider credProvider;\n \n   public AssumeRoleCredentialProvider(Configuration conf) {\n     this.conf = conf;\n   }\n \n+  private void initializeCredProvider() {\n+    String roleArn = conf.get(ASSUME_ROLE_PROPERTY_NAME);\n+    int credDuration = conf.getInt(ASSUME_ROLE_CREDENTIAL_DURATION_PROPERTY_NAME, DEFAULT_CREDENTIALS_DURATION);\n+\n+    checkArgument(StringUtils.isNotEmpty(roleArn),", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjQ1MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392372450", "bodyText": "moved to #176", "author": "KenFigueiredo", "createdAt": "2020-03-13T17:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3MjYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3Mzc5Nw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392273797", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private void initializeCredProvider() {\n          \n          \n            \n              private void initializeCredentialProvider() {", "author": "massdosage", "createdAt": "2020-03-13T14:47:48Z", "path": "circus-train-aws/src/main/java/com/hotels/bdp/circustrain/aws/AssumeRoleCredentialProvider.java", "diffHunk": "@@ -16,45 +16,57 @@\n package com.hotels.bdp.circustrain.aws;\n \n import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Preconditions.checkNotNull;\n \n import org.apache.commons.lang3.StringUtils;\n import org.apache.hadoop.conf.Configuration;\n \n import com.amazonaws.auth.AWSCredentials;\n import com.amazonaws.auth.AWSCredentialsProvider;\n import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider;\n-import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider.Builder;\n \n public class AssumeRoleCredentialProvider implements AWSCredentialsProvider {\n \n   public static final String ASSUME_ROLE_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRole\";\n-  private static final int CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n+  public static final String ASSUME_ROLE_CREDENTIAL_DURATION_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRoleCredentialDuration\";\n+  private static final int DEFAULT_CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n \n-  private AWSCredentials credentials;\n   private final Configuration conf;\n+  private STSAssumeRoleSessionCredentialsProvider credProvider;\n \n   public AssumeRoleCredentialProvider(Configuration conf) {\n     this.conf = conf;\n   }\n \n+  private void initializeCredProvider() {", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjM2NQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392372365", "bodyText": "moved to #176", "author": "KenFigueiredo", "createdAt": "2020-03-13T17:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3Mzc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3NTEwMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392275100", "bodyText": "I'm a bit confused why there are so many other changes to this class when the only change I can really see that is necessary is making this value configurable instead of a hardcoded value?", "author": "massdosage", "createdAt": "2020-03-13T14:49:52Z", "path": "circus-train-aws/src/main/java/com/hotels/bdp/circustrain/aws/AssumeRoleCredentialProvider.java", "diffHunk": "@@ -16,45 +16,57 @@\n package com.hotels.bdp.circustrain.aws;\n \n import static com.google.common.base.Preconditions.checkArgument;\n-import static com.google.common.base.Preconditions.checkNotNull;\n \n import org.apache.commons.lang3.StringUtils;\n import org.apache.hadoop.conf.Configuration;\n \n import com.amazonaws.auth.AWSCredentials;\n import com.amazonaws.auth.AWSCredentialsProvider;\n import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider;\n-import com.amazonaws.auth.STSAssumeRoleSessionCredentialsProvider.Builder;\n \n public class AssumeRoleCredentialProvider implements AWSCredentialsProvider {\n \n   public static final String ASSUME_ROLE_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRole\";\n-  private static final int CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n+  public static final String ASSUME_ROLE_CREDENTIAL_DURATION_PROPERTY_NAME = \"com.hotels.bdp.circustrain.aws.AssumeRoleCredentialProvider.assumeRoleCredentialDuration\";\n+  private static final int DEFAULT_CREDENTIALS_DURATION = 12 * 60 * 60; // max duration in seconds for assumed role credentials\n \n-  private AWSCredentials credentials;\n   private final Configuration conf;\n+  private STSAssumeRoleSessionCredentialsProvider credProvider;\n \n   public AssumeRoleCredentialProvider(Configuration conf) {\n     this.conf = conf;\n   }\n \n+  private void initializeCredProvider() {\n+    String roleArn = conf.get(ASSUME_ROLE_PROPERTY_NAME);\n+    int credDuration = conf.getInt(ASSUME_ROLE_CREDENTIAL_DURATION_PROPERTY_NAME, DEFAULT_CREDENTIALS_DURATION);\n+\n+    checkArgument(StringUtils.isNotEmpty(roleArn),\n+        \"Role ARN must not be empty, please set: \" + ASSUME_ROLE_PROPERTY_NAME);\n+\n+    // STSAssumeRoleSessionCredentialsProvider should auto refresh its creds in the background.\n+    this.credProvider = new STSAssumeRoleSessionCredentialsProvider\n+        .Builder(roleArn, \"ct-assume-role-session\")\n+        .withRoleSessionDurationSeconds(credDuration)", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjMzNA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392372334", "bodyText": "moved to #176", "author": "KenFigueiredo", "createdAt": "2020-03-13T17:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3NTEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3Nzk3MQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392277971", "bodyText": "What's the reason for splitting this into two lines? I think it was fine the way it was before.", "author": "massdosage", "createdAt": "2020-03-13T14:54:33Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3Copier.java", "diffHunk": "@@ -173,8 +172,16 @@ private void initialiseAllCopyRequests() {\n         initialiseCopyJobs(subLocation, targetS3Uri);\n       }\n     }\n-    LOG\n-        .info(\"Finished initialising {} copy job(s)\", copyJobRequests.size());\n+\n+    int totalCopyJobs = copyJobRequests.size();", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyOTA3Ng==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392329076", "bodyText": "I use the totalCopyJob request number to make a determination about what the thread pool size should be in the determineThreadPoolSize method. I figured since we use it twice it could be worth throwing into a variable.", "author": "KenFigueiredo", "createdAt": "2020-03-13T16:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3Nzk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMDA0OA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392330048", "bodyText": "Ah, OK, I didn't spot that, sorry, you're right.", "author": "massdosage", "createdAt": "2020-03-13T16:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3Nzk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMDQ5NQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392330495", "bodyText": "\ud83d\udc4d", "author": "massdosage", "createdAt": "2020-03-13T16:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3Nzk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODE2MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392278160", "bodyText": "Why has all this been moved down here instead of where it was being done above?", "author": "massdosage", "createdAt": "2020-03-13T14:54:52Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3Copier.java", "diffHunk": "@@ -173,8 +172,16 @@ private void initialiseAllCopyRequests() {\n         initialiseCopyJobs(subLocation, targetS3Uri);\n       }\n     }\n-    LOG\n-        .info(\"Finished initialising {} copy job(s)\", copyJobRequests.size());\n+\n+    int totalCopyJobs = copyJobRequests.size();\n+    LOG.info(\"Finished initialising {} copy job(s)\", totalCopyJobs);\n+    s3s3CopierOptions.overrideMaxThreadPoolSize(determineThreadPoolSize(totalCopyJobs, s3s3CopierOptions.getMaxThreadPoolSize()));", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMDg2Mg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392330862", "bodyText": "OK, so that's why you had to move it down here then.", "author": "massdosage", "createdAt": "2020-03-13T16:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMTkyMg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392331922", "bodyText": "So the thought behind this was that we don't initialize the target & transferManager until we know how much work we need to do and we can optimize how we allocate those threads dynamically. The number of threads we allocate to the threadpool has a diminishing return if we go over the total number of copies we need to make.\nI.e. if we have 250 copy jobs and we allocate a threadpool of 1000 to transfermanager, we're going to have ~750 idle threads. This made a fairly significant difference in overhead and the total replication time from our testing of about an average of ~400 MB/s (granted the # of files & size of those files will drastically change that number)", "author": "KenFigueiredo", "createdAt": "2020-03-13T16:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMzg1NA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392333854", "bodyText": "OK.", "author": "massdosage", "createdAt": "2020-03-13T16:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODgwMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392278800", "bodyText": "I've got a feeling this was set to debug for a reason, why is it being changed to warn?", "author": "massdosage", "createdAt": "2020-03-13T14:55:48Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3Copier.java", "diffHunk": "@@ -292,7 +299,7 @@ private Copy submitCopyJob(CopyJobRequest copyJob) {\n                   copyObjectRequest.getSourceBucketName(),\n                   copyObjectRequest.getSourceKey());\n           LOG\n-              .debug(\"Copy failed with exception:\", e);\n+              .warn(\"Copy failed with exception:\", e);", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMTg1Ng==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392331856", "bodyText": "The reason I say this is because we usually log errors on warn/error level so if we don't then it's usually been done like that for a reason. My assumption is that we have some retry logic so this was causing the logs to be noisy and was downgraded to debug but I could be wrong, in which case warn is fine.", "author": "massdosage", "createdAt": "2020-03-13T16:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNTEyNw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392335127", "bodyText": "I changed this because during my testing of all of this since some of the failures we had around the testing of this made those errors fail silently. If we're running in production, we don't necessarily want to have debug logs on but we still want to see what the failure for a given job was.", "author": "KenFigueiredo", "createdAt": "2020-03-13T16:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNjQwMg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392336402", "bodyText": "OK, well, let's leave it like this then and if it later becomes apparent why we put this down to debug we'll just just put it back again.", "author": "massdosage", "createdAt": "2020-03-13T16:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3ODgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4MDIyNQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392280225", "bodyText": "I don't really mind but why was this removed?", "author": "massdosage", "createdAt": "2020-03-13T14:57:58Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/JceksAmazonS3ClientFactory.java", "diffHunk": "@@ -56,15 +57,14 @@ public JceksAmazonS3ClientFactory(Security security) {\n   @Override\n   public AmazonS3 newInstance(AmazonS3URI uri, S3S3CopierOptions s3s3CopierOptions) {\n     HadoopAWSCredentialProviderChain credentialProviderChain = getCredentialsProviderChain(\n-        s3s3CopierOptions.getAssumedRole());\n+        s3s3CopierOptions.getAssumedRole(), s3s3CopierOptions.getAssumedRoleCredentialDuration());\n     return newS3Client(uri, s3s3CopierOptions, credentialProviderChain);\n   }\n \n   private AmazonS3 newS3Client(\n       AmazonS3URI uri,\n       S3S3CopierOptions s3s3CopierOptions,\n       HadoopAWSCredentialProviderChain credentialProviderChain) {\n-    LOG.debug(\"trying to get a client for uri '{}'\", uri);", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNTk2OA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392335968", "bodyText": "unintentional - I had a ton of additional debug logs that I had reverted for the PR, and this one must have gotten caught with it.", "author": "KenFigueiredo", "createdAt": "2020-03-13T16:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4MDIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4MjcxMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392282710", "bodyText": "Depending on what you decide to do based on @teabot's comment about the -1 magic number, it might be worth introducing a \"can't be <=0 check\" when we get the config and then this can just check >0", "author": "massdosage", "createdAt": "2020-03-13T15:02:04Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/JceksAmazonS3ClientFactory.java", "diffHunk": "@@ -103,13 +103,27 @@ private String regionForUri(AmazonS3 client, AmazonS3URI uri) {\n     return bucketRegion;\n   }\n \n+  private AmazonS3ClientBuilder applyClientConfigurations(AmazonS3ClientBuilder builder, S3S3CopierOptions s3s3CopierOptions) {\n+    ClientConfiguration clientConfiguration = new ClientConfiguration();\n+\n+    if (s3s3CopierOptions.getMaxThreadPoolSize() != -1) {", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzODk2Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392338963", "bodyText": "removed entirely as per @patduin comments", "author": "KenFigueiredo", "createdAt": "2020-03-13T16:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4MjcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NDY2Mg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392284662", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                TransferManagerConfiguration tmConfig = transferManager.getConfiguration();\n          \n          \n            \n                TransferManagerConfiguration managerConfig = transferManager.getConfiguration();", "author": "massdosage", "createdAt": "2020-03-13T15:05:12Z", "path": "circus-train-s3-s3-copier/src/test/java/com/hotels/bdp/circustrain/s3s3copier/aws/TransferManagerFactoryTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.hotels.bdp.circustrain.s3s3copier.aws;\n+\n+import static org.junit.Assert.assertThat;\n+import static org.hamcrest.CoreMatchers.is;\n+\n+import java.util.HashMap;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import com.amazonaws.services.s3.AmazonS3;\n+import com.amazonaws.services.s3.transfer.TransferManager;\n+import com.amazonaws.services.s3.transfer.TransferManagerConfiguration;\n+\n+import com.hotels.bdp.circustrain.s3s3copier.S3S3CopierOptions;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class TransferManagerFactoryTest {\n+\n+  @Mock private AmazonS3 mockClient;\n+  private final Long MULTIPART_COPY_THRESHOLD_VALUE = 1L;\n+  private final Long MULTIPART_COPY_PART_SIZE = 1L;\n+\n+  @Test\n+  public void shouldCreateDefaultTransferManagerClient() {\n+    S3S3CopierOptions s3Options = new S3S3CopierOptions(new HashMap<String, Object>() {{\n+      put(S3S3CopierOptions.Keys.MULTIPART_COPY_THRESHOLD.keyName(), MULTIPART_COPY_THRESHOLD_VALUE);\n+      put(S3S3CopierOptions.Keys.MULTIPART_COPY_PART_SIZE.keyName(), MULTIPART_COPY_PART_SIZE);\n+    }});\n+\n+    TransferManagerFactory factory = new TransferManagerFactory();\n+    TransferManager transferManager = factory.newInstance(mockClient, s3Options);\n+    assertThat(transferManager.getAmazonS3Client(), is(mockClient));\n+\n+    TransferManagerConfiguration tmConfig = transferManager.getConfiguration();", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NTI4MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392285280", "bodyText": "Thanks for adding this, shocking we didn't already have a test class for it!", "author": "massdosage", "createdAt": "2020-03-13T15:06:11Z", "path": "circus-train-s3-s3-copier/src/test/java/com/hotels/bdp/circustrain/s3s3copier/aws/TransferManagerFactoryTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.hotels.bdp.circustrain.s3s3copier.aws;", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NTg0NQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392285845", "bodyText": "Can we add a unit test for this if statement or is it not straightforward to check the existence of the executor factory?", "author": "massdosage", "createdAt": "2020-03-13T15:07:08Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/TransferManagerFactory.java", "diffHunk": "@@ -26,12 +31,19 @@\n @Component\n public class TransferManagerFactory {\n \n+  private static final Logger LOG = LoggerFactory.getLogger(TransferManagerFactory.class);\n+\n   public TransferManager newInstance(AmazonS3 targetS3Client, S3S3CopierOptions s3s3CopierOptions) {\n-    return TransferManagerBuilder\n-        .standard()\n+    TransferManagerBuilder builder = TransferManagerBuilder.standard()\n         .withMultipartCopyThreshold(s3s3CopierOptions.getMultipartCopyThreshold())\n         .withMultipartCopyPartSize(s3s3CopierOptions.getMultipartCopyPartSize())\n-        .withS3Client(targetS3Client)\n-        .build();\n+        .withS3Client(targetS3Client);\n+\n+    if (s3s3CopierOptions.getMaxThreadPoolSize() != -1) {", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxMDAyMg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392310022", "bodyText": "I had originally added the transfermanagerFactoryTest to cover it but found that it wasn't straightforward. That property is directly set on the executor factory which transferManager stores under a private final w/o any getters.", "author": "KenFigueiredo", "createdAt": "2020-03-13T15:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NTg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NzMyOA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392287328", "bodyText": "Why do we need this here as well as in the TransferManagerFactory?", "author": "massdosage", "createdAt": "2020-03-13T15:09:41Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/JceksAmazonS3ClientFactory.java", "diffHunk": "@@ -103,13 +103,27 @@ private String regionForUri(AmazonS3 client, AmazonS3URI uri) {\n     return bucketRegion;\n   }\n \n+  private AmazonS3ClientBuilder applyClientConfigurations(AmazonS3ClientBuilder builder, S3S3CopierOptions s3s3CopierOptions) {\n+    ClientConfiguration clientConfiguration = new ClientConfiguration();\n+\n+    if (s3s3CopierOptions.getMaxThreadPoolSize() != -1) {\n+      clientConfiguration.withMaxConnections(s3s3CopierOptions.getMaxThreadPoolSize());\n+    }\n+\n+    return builder.withClientConfiguration(clientConfiguration);", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxMTQwMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392311400", "bodyText": "The call in TransferManagerFactory sets the max threads that are available for its pool but doesn't update the default connection limit that the S3Client has of 50. So if you were to set a thread pool of 100, you'd start hitting connection failures.\nFrom my research into it, the most efficient scenario is to match # of threads to # of available connections.", "author": "KenFigueiredo", "createdAt": "2020-03-13T15:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NzMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0OTk5NQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392949995", "bodyText": "OK", "author": "massdosage", "createdAt": "2020-03-16T11:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NzMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NzU3OQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392287579", "bodyText": "Can we just have a simple test class for this?", "author": "massdosage", "createdAt": "2020-03-13T15:10:10Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/ExecutorServiceFactory.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**", "originalCommit": "e8454abc8598f24e2a7e682da8ea0eed2f8db236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM1MzUxOQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392353519", "bodyText": "good catch - this is actually completely unused and unneeded now due to it being replaced by the lambda call. Removed.", "author": "KenFigueiredo", "createdAt": "2020-03-13T16:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI4NzU3OQ=="}], "type": "inlineReview"}, {"oid": "facd8ee9770645e7fa733c73b1bd201f6c5f0d70", "url": "https://github.com/ExpediaGroup/circus-train/commit/facd8ee9770645e7fa733c73b1bd201f6c5f0d70", "message": "stash assume role changes for a seperate PR", "committedDate": "2020-03-13T15:59:50Z", "type": "commit"}, {"oid": "cbf14913f902d359f243386fbd18baab592d2d2e", "url": "https://github.com/ExpediaGroup/circus-train/commit/cbf14913f902d359f243386fbd18baab592d2d2e", "message": "remove missed copier option", "committedDate": "2020-03-13T16:01:25Z", "type": "commit"}, {"oid": "387cbdbc1074568728919e6cb400dbc2f362d866", "url": "https://github.com/ExpediaGroup/circus-train/commit/387cbdbc1074568728919e6cb400dbc2f362d866", "message": "Apply suggestions from code review\n\nCo-Authored-By: Adrian Woodhead <massdosage@gmail.com>", "committedDate": "2020-03-13T16:03:50Z", "type": "commit"}, {"oid": "f6fc56e28885e74ef1c0a87f8cd3df654584b880", "url": "https://github.com/ExpediaGroup/circus-train/commit/f6fc56e28885e74ef1c0a87f8cd3df654584b880", "message": "tmConfig -> managerConfig", "committedDate": "2020-03-13T16:04:50Z", "type": "commit"}, {"oid": "3115dd44c3414fc422b7b1e38daafa46e5299120", "url": "https://github.com/ExpediaGroup/circus-train/commit/3115dd44c3414fc422b7b1e38daafa46e5299120", "message": "always set executor factory w/ default of 10", "committedDate": "2020-03-13T16:12:12Z", "type": "commit"}, {"oid": "09021b6652365e793997bb09e976af7311b46ba6", "url": "https://github.com/ExpediaGroup/circus-train/commit/09021b6652365e793997bb09e976af7311b46ba6", "message": "revert debug log in JCEKS", "committedDate": "2020-03-13T16:28:00Z", "type": "commit"}, {"oid": "ea51e748dd225d9a834f5141aac73f9cfe8bf870", "url": "https://github.com/ExpediaGroup/circus-train/commit/ea51e748dd225d9a834f5141aac73f9cfe8bf870", "message": "remove unused executorServiceFactory", "committedDate": "2020-03-13T16:53:03Z", "type": "commit"}, {"oid": "8b2e3868d25857625c887266649bd2e91773e867", "url": "https://github.com/ExpediaGroup/circus-train/commit/8b2e3868d25857625c887266649bd2e91773e867", "message": "cherrypick logs for assumerole", "committedDate": "2020-03-13T17:40:57Z", "type": "commit"}, {"oid": "463fbb2bcd1a68b0e6f0f8888584e21254079199", "url": "https://github.com/ExpediaGroup/circus-train/commit/463fbb2bcd1a68b0e6f0f8888584e21254079199", "message": "method formatting", "committedDate": "2020-03-13T17:43:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ0NjcyNQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392446725", "bodyText": "beating elliot to it let's make 10 a constant: DEFAULT_MAX_THREAD_POOL_SIZE", "author": "patduin", "createdAt": "2020-03-13T20:16:51Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3CopierOptions.java", "diffHunk": "@@ -86,6 +91,14 @@ public S3S3CopierOptions(Map<String, Object> copierOptions) {\n     this.copierOptions = new HashMap<>(copierOptions);\n   }\n \n+  public void overrideMaxThreadPoolSize(int newMax) {\n+    copierOptions.put(Keys.MAX_THREAD_POOL_SIZE.keyName(), newMax);\n+  }\n+\n+  public int getMaxThreadPoolSize() {\n+    return MapUtils.getInteger(copierOptions, Keys.MAX_THREAD_POOL_SIZE.keyName(), 10);", "originalCommit": "463fbb2bcd1a68b0e6f0f8888584e21254079199", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0ODQyOQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392948429", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void overrideMaxThreadPoolSize(int newMax) {\n          \n          \n            \n              public void setMaxThreadPoolSize(int maxThreadPoolSize) {", "author": "massdosage", "createdAt": "2020-03-16T11:24:33Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3CopierOptions.java", "diffHunk": "@@ -86,6 +91,14 @@ public S3S3CopierOptions(Map<String, Object> copierOptions) {\n     this.copierOptions = new HashMap<>(copierOptions);\n   }\n \n+  public void overrideMaxThreadPoolSize(int newMax) {", "originalCommit": "463fbb2bcd1a68b0e6f0f8888584e21254079199", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MDM2Ng==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392950366", "bodyText": "Left over from other PR, NABD though.", "author": "massdosage", "createdAt": "2020-03-16T11:28:13Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/S3S3CopierOptions.java", "diffHunk": "@@ -18,6 +18,7 @@\n import java.net.URI;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.concurrent.TimeUnit;", "originalCommit": "463fbb2bcd1a68b0e6f0f8888584e21254079199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NTc4Nw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r393045787", "bodyText": "Removed!", "author": "KenFigueiredo", "createdAt": "2020-03-16T14:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MDM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MDc3MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r392950770", "bodyText": "This doesn't look right?", "author": "massdosage", "createdAt": "2020-03-16T11:29:02Z", "path": "circus-train-s3-s3-copier/src/main/java/com/hotels/bdp/circustrain/s3s3copier/aws/TransferManagerFactory.java", "diffHunk": "@@ -15,8 +15,15 @@\n  */\n package com.hotels.bdp.circustrain.s3s3copier.aws;\n \n+\n+import java.util.concurrent.Executors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n+import jline.internal.Log;", "originalCommit": "463fbb2bcd1a68b0e6f0f8888584e21254079199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NTgzNA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r393045834", "bodyText": "looks like left over from an incorrect import. May need to tweak my IDE settings \ud83d\ude05\nRemoved.", "author": "KenFigueiredo", "createdAt": "2020-03-16T14:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MDc3MA=="}], "type": "inlineReview"}, {"oid": "f5ab2b3666fda97d8ce3da90142c8acad1a20855", "url": "https://github.com/ExpediaGroup/circus-train/commit/f5ab2b3666fda97d8ce3da90142c8acad1a20855", "message": "Set changes from pr", "committedDate": "2020-03-16T14:05:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA2MzcwMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r393063700", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`s3s3-max-thread-pool-size`|No| Max number of threads to use for the transferManager thread pool. Default value is 10.|\n          \n          \n            \n            |`copier-options.s3s3-max-thread-pool-size`|No| Max number of threads to use for the transferManager thread pool. Default value is 10.|\n          \n      \n    \n    \n  \n\nMissed the prefix that all the others have ^", "author": "massdosage", "createdAt": "2020-03-16T14:25:10Z", "path": "README.md", "diffHunk": "@@ -396,7 +396,8 @@ If data is being replicated from S3 to S3 then Circus Train will use the AWS S3\n |`copier-options.canned-acl`|No|AWS Canned ACL name. See [Access Control List (ACL) Overview](https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl) for possible values. If not specified `S3S3Copier` will not specify any canned ACL.|\n |`copier-options.copier-factory-class`|No|Controls which copier is used for replication if provided.|\n |`copier-options.s3s3-retry-max-copy-attempts`|No|Controls the maximum number of attempts if AWS throws an error during copy. Default value is 3.|\n-| `copier-options.assume-role`|No|ARN of an IAM role to assume when writing S3 data to the target S3 location. Useful when the target is in a different AWS account than Circus Train is running in. Note that if JCEKS is also configured, JCEKS credentials will be used instead of assuming a role. If `assume-role` is not specified, the copier will use instance credentials. The role provided must have read access to the S3 source and write access to the S3 target.|\n+|`copier-options.assume-role`|No|ARN of an IAM role to assume when writing S3 data to the target S3 location. Useful when the target is in a different AWS account than Circus Train is running in. Note that if JCEKS is also configured, JCEKS credentials will be used instead of assuming a role. If `assume-role` is not specified, the copier will use instance credentials. The role provided must have read access to the S3 source and write access to the S3 target.|\n+|`s3s3-max-thread-pool-size`|No| Max number of threads to use for the transferManager thread pool. Default value is 10.|", "originalCommit": "f5ab2b3666fda97d8ce3da90142c8acad1a20855", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA5NDU1NQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/175#discussion_r393094555", "bodyText": "good catch - updated", "author": "KenFigueiredo", "createdAt": "2020-03-16T15:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA2MzcwMA=="}], "type": "inlineReview"}, {"oid": "cdd768f2d4285bcc4ac91c44d496953503faf9bf", "url": "https://github.com/ExpediaGroup/circus-train/commit/cdd768f2d4285bcc4ac91c44d496953503faf9bf", "message": "Merge branch 'master' into s3s3copier-threads-and-assume-role-fix", "committedDate": "2020-03-16T14:51:53Z", "type": "commit"}, {"oid": "e6fe106e8552d0db55d02af2ef66e61929fe2c50", "url": "https://github.com/ExpediaGroup/circus-train/commit/e6fe106e8552d0db55d02af2ef66e61929fe2c50", "message": "tidy up space", "committedDate": "2020-03-16T14:53:47Z", "type": "commit"}, {"oid": "ad9b5824b5d90b7eb7fc8ded420a12a0cd34541f", "url": "https://github.com/ExpediaGroup/circus-train/commit/ad9b5824b5d90b7eb7fc8ded420a12a0cd34541f", "message": "add prefix", "committedDate": "2020-03-16T15:01:12Z", "type": "commit"}, {"oid": "8662d42a40f054c204f3bde5b2674c50674236ec", "url": "https://github.com/ExpediaGroup/circus-train/commit/8662d42a40f054c204f3bde5b2674c50674236ec", "message": "fix & merge master", "committedDate": "2020-03-16T15:03:38Z", "type": "commit"}, {"oid": "cb6d0e32359945f8664a8b254e1ebdc956c0e3ea", "url": "https://github.com/ExpediaGroup/circus-train/commit/cb6d0e32359945f8664a8b254e1ebdc956c0e3ea", "message": "remove duplicate readme entry", "committedDate": "2020-03-16T15:07:45Z", "type": "commit"}]}