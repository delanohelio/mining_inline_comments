{"pr_number": 196, "pr_title": "Copier context", "pr_createdAt": "2020-08-21T15:47:39Z", "pr_url": "https://github.com/ExpediaGroup/circus-train/pull/196", "timeline": [{"oid": "b32abd2ed83050d1219710747e72e7e419acdcc0", "url": "https://github.com/ExpediaGroup/circus-train/commit/b32abd2ed83050d1219710747e72e7e419acdcc0", "message": "rough cut at possibilities for using a CopierContext", "committedDate": "2020-08-18T17:02:24Z", "type": "commit"}, {"oid": "3554609f4b3d7745a750a50aa7e75c610037b41f", "url": "https://github.com/ExpediaGroup/circus-train/commit/3554609f4b3d7745a750a50aa7e75c610037b41f", "message": "remove unused local variables", "committedDate": "2020-08-18T17:04:32Z", "type": "commit"}, {"oid": "3ace077c655b965f3e83c680f89704b3991a1e06", "url": "https://github.com/ExpediaGroup/circus-train/commit/3ace077c655b965f3e83c680f89704b3991a1e06", "message": "* use a default method for backwards compatibility (maybe only\ntemporarily to get test code compiling quicker)\n* WIP on tests passing", "committedDate": "2020-08-20T17:00:45Z", "type": "commit"}, {"oid": "06118ae72c71c8201ecc83e2d9f780e2b5956160", "url": "https://github.com/ExpediaGroup/circus-train/commit/06118ae72c71c8201ecc83e2d9f780e2b5956160", "message": "more tests now passing", "committedDate": "2020-08-21T14:58:15Z", "type": "commit"}, {"oid": "188394cd06adad93227f27ccf970043b03c9dfde", "url": "https://github.com/ExpediaGroup/circus-train/commit/188394cd06adad93227f27ccf970043b03c9dfde", "message": "remove todos", "committedDate": "2020-08-21T15:02:18Z", "type": "commit"}, {"oid": "ca8599c37c246da4d0b471186cc13bfb1cd923d1", "url": "https://github.com/ExpediaGroup/circus-train/commit/ca8599c37c246da4d0b471186cc13bfb1cd923d1", "message": "fix failing integration tests", "committedDate": "2020-08-21T15:42:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjMyNQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r474782325", "bodyText": "Instead of deprecating these we could remove them and then just have the method above and clearly document in the CHANGELOG what the required change is for this. It's basically just updating any custom CopierFactory implementations to implement the new method and pull the values they need out of the CopierContext instead of having them passed as method arguments. Thoughts?", "author": "massdosage", "createdAt": "2020-08-21T15:49:36Z", "path": "circus-train-api/src/main/java/com/hotels/bdp/circustrain/api/copier/CopierFactory.java", "diffHunk": "@@ -25,13 +25,28 @@\n   boolean supportsSchemes(String sourceScheme, String replicaScheme);\n \n   /**\n+   * Creates a new Copier.\n+   * \n+   * @param copierContext Context object containing configuration values for the Copier.\n+   * @return\n+   */\n+  default Copier newInstance(CopierContext copierContext) {\n+    //TODO: this is only here for backwards compatibility with CopierFactorys using older versions of Circus Train, when the below\n+    //deprecated methods are removed so should this default implementation\n+    return newInstance(copierContext.getEventId(), copierContext.getSourceBaseLocation(), copierContext.getSourceSubLocations(), copierContext.getReplicaLocation(), \n+        copierContext.getCopierOptions());\n+  }\n+\n+  /**\n+   * @deprecated As of release 16.3.0, replaced by {@link #newInstance(CopierContext)}.", "originalCommit": "ca8599c37c246da4d0b471186cc13bfb1cd923d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4MjMwMg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475482302", "bodyText": "I'd still rather deprecate it and, in case, have it removed later on.", "author": "nvitucci", "createdAt": "2020-08-24T09:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4NzU3Nw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475487577", "bodyText": "deprecate and remove is the more friendly way, I'm ok either way though it's not a big change to do.", "author": "patduin", "createdAt": "2020-08-24T10:03:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU5OTA2Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475599063", "bodyText": "OK, let's go with a 16.3.0 release that is backwards compatible, I'll update the changelog accordingly.", "author": "massdosage", "createdAt": "2020-08-24T13:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MjMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3Njk5NA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475476994", "bodyText": "Nice simplification.", "author": "nvitucci", "createdAt": "2020-08-24T09:44:23Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/ReplicationFactoryImpl.java", "diffHunk": "@@ -134,29 +124,25 @@ private Replication createPartitionedTableReplication(\n   private Replication createUnpartitionedTableReplication(\n       TableReplication tableReplication,\n       Source source,\n-      Replica replica,\n-      String sourceDatabaseName,\n-      String sourceTableName,\n-      String replicaDatabaseName,\n-      String replicaTableName,\n-      String replicaTableLocation) {\n+      Replica replica) {", "originalCommit": "ca8599c37c246da4d0b471186cc13bfb1cd923d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475488274", "bodyText": "thoughts on making this immutable? Is there a risk of a copier accidentally change one of these fields which might affect further copiers in the chain?", "author": "patduin", "createdAt": "2020-08-24T10:04:48Z", "path": "circus-train-api/src/main/java/com/hotels/bdp/circustrain/api/copier/CopierContext.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/**\n+ * Copyright (C) 2016-2020 Expedia, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hotels.bdp.circustrain.api.copier;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.hadoop.fs.Path;\n+\n+import com.hotels.bdp.circustrain.api.conf.TableReplication;\n+\n+public class CopierContext {", "originalCommit": "ca8599c37c246da4d0b471186cc13bfb1cd923d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUwODE3OA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475508178", "bodyText": "Yeah, I thought about making this immutable and having a builder instead of this big constructor but this was quicker and easier to do in terms of updating the existing code. However the TableReplication isn't immutable so we'd only be halfway there unless I looked into that too (not sure that's really possible as it maps directly to the config which needs to set values).\nIf we didn't want to use a builder I could add 2 more constructors which allow the TableReplication to be passed in too and then I make immutable copies of the List and Map member variables and we live with TableReplication not being immutable.\nI can do either (or if someone has better suggestions) if we think it's worth it?", "author": "massdosage", "createdAt": "2020-08-24T10:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMzQ0Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475513443", "bodyText": "I think since this is a new one we make the good example and make it immutable. I'm ok leaving TableReplication for another time as that will be backward incompatible change I guess.", "author": "patduin", "createdAt": "2020-08-24T10:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxODI3Ng==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475518276", "bodyText": "Isn't there any place where the context may actually need to be updated?", "author": "nvitucci", "createdAt": "2020-08-24T10:56:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1MDg1Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475550853", "bodyText": "yeah I was also thinking about that, not sure what we want to achieve. The order in which copiers are run is guaranteed by spring so you could have a copier relying on another copier updating the context. If that's they way we want to go then obviously we don't want to make it immutable. Could argue either way I guess :)", "author": "patduin", "createdAt": "2020-08-24T12:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU2Nzg2Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475567863", "bodyText": "At the moment I don't see any of the copiers updating the context but yes, you could argue that that could be a useful feature ;) My suggestion would be to follow our usual best practice and make them immutable for now, if we ever find we need some way of modifying/sharing context between copiers we could break that and make them mutable (or at that point perhaps some other solution presents itself).", "author": "massdosage", "createdAt": "2020-08-24T12:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3OTk4OQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475579989", "bodyText": "If it keeps on being backward-compatible and not too difficult to do, go ahead with making it immutable then. All the other things being equal, immutable objects are always preferable.", "author": "nvitucci", "createdAt": "2020-08-24T12:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU5ODU3Nw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475598577", "bodyText": "I've changed it to be as immutable as I think I can :)", "author": "massdosage", "createdAt": "2020-08-24T13:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYwMTcxOA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475601718", "bodyText": "Looks good!", "author": "nvitucci", "createdAt": "2020-08-24T13:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYyMDU4MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475620580", "bodyText": "the class needs to be final", "author": "patduin", "createdAt": "2020-08-24T13:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYyMjk3Nw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475622977", "bodyText": "It does! Good spot!", "author": "massdosage", "createdAt": "2020-08-24T13:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYyNjMzOQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475626339", "bodyText": "and because TableReplication isn't immutable you need to copy it as well. Path also isn't :/ it's a pandemic. Not sure how much you want to open that can of worms. I can live with a not fully immutable class for the sake of pragmatism.", "author": "patduin", "createdAt": "2020-08-24T13:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzNzc2Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475637763", "bodyText": "Yeah, you're right, I think we either leave as it is now and live with a decent attempt but TableReplication and Path are mutable or we just roll the whole set of immutable changes back.", "author": "massdosage", "createdAt": "2020-08-24T14:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzODkwMg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/196#discussion_r475638902", "bodyText": "I'm ok with this.", "author": "patduin", "createdAt": "2020-08-24T14:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4ODI3NA=="}], "type": "inlineReview"}, {"oid": "cf29415cfb170fc9a82cdd111f78e27ca8a2da18", "url": "https://github.com/ExpediaGroup/circus-train/commit/cf29415cfb170fc9a82cdd111f78e27ca8a2da18", "message": "make CopierContext immutable", "committedDate": "2020-08-24T13:26:25Z", "type": "commit"}, {"oid": "4599ca882d52ffda46a3e892feb782ca9c22fe5c", "url": "https://github.com/ExpediaGroup/circus-train/commit/4599ca882d52ffda46a3e892feb782ca9c22fe5c", "message": "set target version number to 16.3.0", "committedDate": "2020-08-24T13:39:12Z", "type": "commit"}, {"oid": "d4b10239d8c64457ad070d1e32a84c0dc084002d", "url": "https://github.com/ExpediaGroup/circus-train/commit/d4b10239d8c64457ad070d1e32a84c0dc084002d", "message": "made final", "committedDate": "2020-08-24T14:11:15Z", "type": "commit"}, {"oid": "bfbc100a3da5fa2e6c0ae535c9317628e523af01", "url": "https://github.com/ExpediaGroup/circus-train/commit/bfbc100a3da5fa2e6c0ae535c9317628e523af01", "message": "revert mistake", "committedDate": "2020-08-25T07:41:40Z", "type": "commit"}]}