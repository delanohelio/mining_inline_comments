{"pr_number": 5399, "pr_title": "fix(TDI-45015): tFileInputMail - slow attachments retrieval.", "pr_createdAt": "2020-10-20T10:41:20Z", "pr_url": "https://github.com/Talend/tdi-studio-se/pull/5399", "timeline": [{"oid": "dfd8c5c3fc8fa12a68e17b72fbfc12954f6e5e66", "url": "https://github.com/Talend/tdi-studio-se/commit/dfd8c5c3fc8fa12a68e17b72fbfc12954f6e5e66", "message": "fix(TDI-45015): fix for low Input/OutputStreams performance.", "committedDate": "2020-10-20T10:37:51Z", "type": "commit"}, {"oid": "4ec87a8dbb106a509244e51054798e10bac982aa", "url": "https://github.com/Talend/tdi-studio-se/commit/4ec87a8dbb106a509244e51054798e10bac982aa", "message": "fix(TDI-45015): increase buffer size to align sizes of internal and external buffers.", "committedDate": "2020-10-20T12:03:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MzM4NA==", "url": "https://github.com/Talend/tdi-studio-se/pull/5399#discussion_r508463384", "bodyText": "I see it's an extra operation to flush each write operation, since BufferedOutputStream does its own flushBuffer() + it is flushing on close().", "author": "mbasiuk-talend", "createdAt": "2020-10-20T12:36:36Z", "path": "main/plugins/org.talend.designer.components.localprovider/components/tFileInputMail/tFileInputMail_MIME.javajet", "diffHunk": "@@ -222,19 +222,18 @@\n                         }\n                         path = path + attachFileName;\n                         <% if(isLog4jEnabled){ %>\n-                                log.info(\"<%= cid %> - Extracted attachment: '\" + attachFileName + \"'.\");\n+                                log.info(\"<%= cid %> - Extracting attachment: '\" + attachFileName + \"'.\");\n                         <% } %>\n-\n                         java.io.File attachFile = new java.io.File(path);\n-                        java.io.BufferedOutputStream out = new java.io.BufferedOutputStream(new java.io.FileOutputStream(attachFile));\n-                        java.io.BufferedInputStream in = new java.io.BufferedInputStream(mpart.getInputStream());\n-                        int buffer = 0;\n-                        while ((buffer = in.read()) != -1) {\n-                            out.write(buffer);\n-                            out.flush();\n+                        try (java.io.BufferedOutputStream out = new java.io.BufferedOutputStream(new java.io.FileOutputStream(attachFile));\n+                            java.io.BufferedInputStream in = new java.io.BufferedInputStream(mpart.getInputStream())){\n+                            byte[] buffer = new byte[8192];\n+                            int bytesRead = 0;\n+                            while ((bytesRead = in.read(buffer)) > 0) {\n+                                out.write(buffer, 0, bytesRead);\n+                                out.flush();", "originalCommit": "4ec87a8dbb106a509244e51054798e10bac982aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MzU5Mw==", "url": "https://github.com/Talend/tdi-studio-se/pull/5399#discussion_r508463593", "bodyText": "You may get it out from while loop.", "author": "mbasiuk-talend", "createdAt": "2020-10-20T12:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MzM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ4NDc5Nw==", "url": "https://github.com/Talend/tdi-studio-se/pull/5399#discussion_r508484797", "bodyText": "Fixed - moved flush() out of cycle.", "author": "dmytrogrygorenko", "createdAt": "2020-10-20T13:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MzM4NA=="}], "type": "inlineReview"}, {"oid": "54278f6319f8b6687aa2cd9b17a4475a9801c6f0", "url": "https://github.com/Talend/tdi-studio-se/commit/54278f6319f8b6687aa2cd9b17a4475a9801c6f0", "message": "fix(TDI-45015): moved flush() out of cycle.", "committedDate": "2020-10-20T13:00:26Z", "type": "commit"}]}