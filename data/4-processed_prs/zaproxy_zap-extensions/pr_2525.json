{"pr_number": 2525, "pr_title": "Allow to save and import HARs (HTTP archives)", "pr_createdAt": "2020-08-26T08:25:31Z", "pr_url": "https://github.com/zaproxy/zap-extensions/pull/2525", "timeline": [{"oid": "a4749e52168b6d87c0cb27d573cabf3672ac754e", "url": "https://github.com/zaproxy/zap-extensions/commit/a4749e52168b6d87c0cb27d573cabf3672ac754e", "message": "Save and imoprts Hars (HTTP archives)\n\nSigned-off-by: Bunyanuch Saengnet <bunyanuch.saengnet@kabelsurfer.com>", "committedDate": "2020-08-26T08:27:29Z", "type": "forcePushed"}, {"oid": "ed46a20926342837054f65f20ab9b0e7281d76d3", "url": "https://github.com/zaproxy/zap-extensions/commit/ed46a20926342837054f65f20ab9b0e7281d76d3", "message": "Save and import Hars (HTTP archives)\n\nSigned-off-by: Bunyanuch Saengnet <bunyanuch.saengnet@kabelsurfer.com>", "committedDate": "2021-04-19T15:12:21Z", "type": "forcePushed"}, {"oid": "d63f414d84d34853009373f4d8589af6efd70b16", "url": "https://github.com/zaproxy/zap-extensions/commit/d63f414d84d34853009373f4d8589af6efd70b16", "message": "Save and import Hars (HTTP archives)\n\nSigned-off-by: Bunyanuch Saengnet <bunyanuch.saengnet@kabelsurfer.com>", "committedDate": "2021-04-19T15:13:34Z", "type": "commit"}, {"oid": "d63f414d84d34853009373f4d8589af6efd70b16", "url": "https://github.com/zaproxy/zap-extensions/commit/d63f414d84d34853009373f4d8589af6efd70b16", "message": "Save and import Hars (HTTP archives)\n\nSigned-off-by: Bunyanuch Saengnet <bunyanuch.saengnet@kabelsurfer.com>", "committedDate": "2021-04-19T15:13:34Z", "type": "forcePushed"}, {"oid": "a27a366da3cb6816596929cfa6e8add379764665", "url": "https://github.com/zaproxy/zap-extensions/commit/a27a366da3cb6816596929cfa6e8add379764665", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-19T15:56:32Z", "type": "forcePushed"}, {"oid": "4d2abbd2c062cdaeaf4103158696a732a32f1a37", "url": "https://github.com/zaproxy/zap-extensions/commit/4d2abbd2c062cdaeaf4103158696a732a32f1a37", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-19T16:00:45Z", "type": "forcePushed"}, {"oid": "af0648c8fce00d2fc9b228c00fe6ddda6c3e072c", "url": "https://github.com/zaproxy/zap-extensions/commit/af0648c8fce00d2fc9b228c00fe6ddda6c3e072c", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-20T02:13:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM4MDEzMw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2525#discussion_r616380133", "bodyText": "URLs \u2192 data? It allows to import whole messages.", "author": "thc202", "createdAt": "2021-04-20T06:29:23Z", "path": "addOns/exim/src/main/java/org/zaproxy/addon/exim/har/HarApi.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.exim.har;\n+\n+import java.io.File;\n+import net.sf.json.JSONObject;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.zaproxy.zap.extension.api.ApiAction;\n+import org.zaproxy.zap.extension.api.ApiException;\n+import org.zaproxy.zap.extension.api.ApiException.Type;\n+import org.zaproxy.zap.extension.api.ApiImplementor;\n+import org.zaproxy.zap.extension.api.ApiResponse;\n+import org.zaproxy.zap.extension.api.ApiResponseElement;\n+import org.zaproxy.zap.utils.ApiUtils;\n+\n+/** The API for importing URLs from a file. */", "originalCommit": "af0648c8fce00d2fc9b228c00fe6ddda6c3e072c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM4MDE1Mg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2525#discussion_r616380152", "bodyText": "I'd suggest exim (the same as the add-on ID), to reduce the likelihood of conflicts with other add-ons.", "author": "thc202", "createdAt": "2021-04-20T06:29:25Z", "path": "addOns/exim/src/main/java/org/zaproxy/addon/exim/har/HarApi.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.exim.har;\n+\n+import java.io.File;\n+import net.sf.json.JSONObject;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.zaproxy.zap.extension.api.ApiAction;\n+import org.zaproxy.zap.extension.api.ApiException;\n+import org.zaproxy.zap.extension.api.ApiException.Type;\n+import org.zaproxy.zap.extension.api.ApiImplementor;\n+import org.zaproxy.zap.extension.api.ApiResponse;\n+import org.zaproxy.zap.extension.api.ApiResponseElement;\n+import org.zaproxy.zap.utils.ApiUtils;\n+\n+/** The API for importing URLs from a file. */\n+public class HarApi extends ApiImplementor {\n+\n+    private static final Logger LOG = LogManager.getLogger(HarApi.class);\n+    private static final String PREFIX = \"importexport\";", "originalCommit": "af0648c8fce00d2fc9b228c00fe6ddda6c3e072c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM4MDIwNQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2525#discussion_r616380205", "bodyText": "Can be removed.", "author": "thc202", "createdAt": "2021-04-20T06:29:33Z", "path": "addOns/exim/src/main/java/org/zaproxy/addon/exim/har/HarApi.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.exim.har;\n+\n+import java.io.File;\n+import net.sf.json.JSONObject;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.zaproxy.zap.extension.api.ApiAction;\n+import org.zaproxy.zap.extension.api.ApiException;\n+import org.zaproxy.zap.extension.api.ApiException.Type;\n+import org.zaproxy.zap.extension.api.ApiImplementor;\n+import org.zaproxy.zap.extension.api.ApiResponse;\n+import org.zaproxy.zap.extension.api.ApiResponseElement;\n+import org.zaproxy.zap.utils.ApiUtils;\n+\n+/** The API for importing URLs from a file. */\n+public class HarApi extends ApiImplementor {\n+\n+    private static final Logger LOG = LogManager.getLogger(HarApi.class);\n+    private static final String PREFIX = \"importexport\";\n+    private static final String ACTION_IMPORTHAR = \"importhar\";\n+    private static final String PARAM_FILE_PATH = \"filePath\";\n+\n+    /** Provided only for API client generator usage. */", "originalCommit": "af0648c8fce00d2fc9b228c00fe6ddda6c3e072c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM4MDg3MQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2525#discussion_r616380871", "bodyText": "This needs to be changed, if the view is not initialised it should not execute in the EDT.", "author": "thc202", "createdAt": "2021-04-20T06:30:49Z", "path": "addOns/exim/src/main/java/org/zaproxy/addon/exim/har/HarImporter.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.exim.har;\n+\n+import edu.umass.cs.benchlab.har.HarContent;\n+import edu.umass.cs.benchlab.har.HarEntries;\n+import edu.umass.cs.benchlab.har.HarEntry;\n+import edu.umass.cs.benchlab.har.HarHeader;\n+import edu.umass.cs.benchlab.har.HarLog;\n+import edu.umass.cs.benchlab.har.HarResponse;\n+import edu.umass.cs.benchlab.har.tools.HarFileReader;\n+import java.awt.EventQueue;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.parosproxy.paros.control.Control;\n+import org.parosproxy.paros.db.DatabaseException;\n+import org.parosproxy.paros.extension.history.ExtensionHistory;\n+import org.parosproxy.paros.model.HistoryReference;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.network.HttpMalformedHeaderException;\n+import org.parosproxy.paros.network.HttpMessage;\n+import org.parosproxy.paros.network.HttpResponseHeader;\n+import org.zaproxy.zap.network.HttpResponseBody;\n+import org.zaproxy.zap.utils.HarUtils;\n+\n+public class HarImporter {\n+\n+    private static final Logger LOG = LogManager.getLogger(HarImporter.class);\n+\n+    public static List<HttpMessage> getHttpMessages(HarLog log)\n+            throws HttpMalformedHeaderException {\n+        List<HttpMessage> result = new ArrayList<>();\n+        HarEntries entries = log.getEntries();\n+        for (HarEntry entry : entries.getEntries()) {\n+            result.add(getHttpMessage(entry));\n+        }\n+        return result;\n+    }\n+\n+    private static HttpMessage getHttpMessage(HarEntry harEntry)\n+            throws HttpMalformedHeaderException {\n+        HttpMessage result = HarUtils.createHttpMessage(harEntry.getRequest());\n+        setHttpResponse(harEntry.getResponse(), result);\n+        setHistoryReference(harEntry, result);\n+        return result;\n+    }\n+\n+    private static void setHistoryReference(HarEntry harEntry, HttpMessage httpMessage) {\n+        if (harEntry.getCustomFields().getCustomFieldValue(HarUtils.MESSAGE_ID_CUSTOM_FIELD)\n+                == null) {\n+            return;\n+        }\n+\n+        Integer historyId =\n+                Integer.valueOf(\n+                        harEntry.getCustomFields()\n+                                .getCustomFieldValue(HarUtils.MESSAGE_ID_CUSTOM_FIELD));\n+        try {\n+            httpMessage.setHistoryRef(new HistoryReference(historyId.intValue()));\n+        } catch (DatabaseException | HttpMalformedHeaderException e) {\n+            // Ignore.\n+        }\n+    }\n+\n+    private static void setHttpResponse(HarResponse harResponse, HttpMessage message)\n+            throws HttpMalformedHeaderException {\n+        StringBuilder strBuilderResHeader = new StringBuilder();\n+\n+        // empty responses without status code are possible\n+        if (harResponse.getStatus() == 0) {\n+            return;\n+        }\n+\n+        strBuilderResHeader\n+                .append(harResponse.getHttpVersion())\n+                .append(' ')\n+                .append(harResponse.getStatus())\n+                .append(' ')\n+                .append(harResponse.getStatusText())\n+                .append(\"\\r\\n\");\n+\n+        for (HarHeader harHeader : harResponse.getHeaders().getHeaders()) {\n+            strBuilderResHeader\n+                    .append(harHeader.getName())\n+                    .append(\": \")\n+                    .append(harHeader.getValue())\n+                    .append(\"\\r\\n\");\n+        }\n+        strBuilderResHeader.append(\"\\r\\n\");\n+\n+        HarContent harContent = harResponse.getContent();\n+        message.setResponseHeader(new HttpResponseHeader(strBuilderResHeader.toString()));\n+        if (harContent != null) {\n+            message.setResponseBody(new HttpResponseBody(harContent.getText()));\n+        }\n+    }\n+\n+    static boolean importHarFile(File file) {\n+        try {\n+            processMessages(file);\n+            return true;\n+        } catch (IOException e) {\n+            LOG.error(e);\n+            return false;\n+        }\n+    }\n+\n+    public static void processMessages(File file) throws IOException {\n+        List<HttpMessage> messages =\n+                HarImporter.getHttpMessages(new HarFileReader().readHarFile(file));\n+        messages.forEach(message -> persistMessage(message));\n+    }\n+\n+    private static void persistMessage(HttpMessage message) {\n+        HistoryReference historyRef;\n+\n+        if (message.getHistoryRef() == null) {\n+            try {\n+                historyRef =\n+                        new HistoryReference(\n+                                Model.getSingleton().getSession(),\n+                                HistoryReference.TYPE_ZAP_USER,\n+                                message);\n+            } catch (Exception e) {\n+                LOG.warn(e.getMessage(), e);\n+                return;\n+            }\n+        } else {\n+            historyRef = message.getHistoryRef();\n+        }\n+\n+        ExtensionHistory extHistory =\n+                Control.getSingleton().getExtensionLoader().getExtension(ExtensionHistory.class);\n+        if (extHistory != null) {\n+            EventQueue.invokeLater(", "originalCommit": "af0648c8fce00d2fc9b228c00fe6ddda6c3e072c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM4MjQ0Ng==", "url": "https://github.com/zaproxy/zap-extensions/pull/2525#discussion_r616382446", "bodyText": "I'd suggest removing this (and related logic in persistMessage), it's very unlikely that the IDs would still match.", "author": "thc202", "createdAt": "2021-04-20T06:33:52Z", "path": "addOns/exim/src/main/java/org/zaproxy/addon/exim/har/HarImporter.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.exim.har;\n+\n+import edu.umass.cs.benchlab.har.HarContent;\n+import edu.umass.cs.benchlab.har.HarEntries;\n+import edu.umass.cs.benchlab.har.HarEntry;\n+import edu.umass.cs.benchlab.har.HarHeader;\n+import edu.umass.cs.benchlab.har.HarLog;\n+import edu.umass.cs.benchlab.har.HarResponse;\n+import edu.umass.cs.benchlab.har.tools.HarFileReader;\n+import java.awt.EventQueue;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.parosproxy.paros.control.Control;\n+import org.parosproxy.paros.db.DatabaseException;\n+import org.parosproxy.paros.extension.history.ExtensionHistory;\n+import org.parosproxy.paros.model.HistoryReference;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.network.HttpMalformedHeaderException;\n+import org.parosproxy.paros.network.HttpMessage;\n+import org.parosproxy.paros.network.HttpResponseHeader;\n+import org.zaproxy.zap.network.HttpResponseBody;\n+import org.zaproxy.zap.utils.HarUtils;\n+\n+public class HarImporter {\n+\n+    private static final Logger LOG = LogManager.getLogger(HarImporter.class);\n+\n+    public static List<HttpMessage> getHttpMessages(HarLog log)\n+            throws HttpMalformedHeaderException {\n+        List<HttpMessage> result = new ArrayList<>();\n+        HarEntries entries = log.getEntries();\n+        for (HarEntry entry : entries.getEntries()) {\n+            result.add(getHttpMessage(entry));\n+        }\n+        return result;\n+    }\n+\n+    private static HttpMessage getHttpMessage(HarEntry harEntry)\n+            throws HttpMalformedHeaderException {\n+        HttpMessage result = HarUtils.createHttpMessage(harEntry.getRequest());\n+        setHttpResponse(harEntry.getResponse(), result);\n+        setHistoryReference(harEntry, result);\n+        return result;\n+    }\n+\n+    private static void setHistoryReference(HarEntry harEntry, HttpMessage httpMessage) {", "originalCommit": "af0648c8fce00d2fc9b228c00fe6ddda6c3e072c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aeebbba97cde9c68a4a60cac8fa349ead3c11090", "url": "https://github.com/zaproxy/zap-extensions/commit/aeebbba97cde9c68a4a60cac8fa349ead3c11090", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-20T12:13:01Z", "type": "forcePushed"}, {"oid": "b5545c484a0688e0c8469e6ef2fefc14f15f2bc9", "url": "https://github.com/zaproxy/zap-extensions/commit/b5545c484a0688e0c8469e6ef2fefc14f15f2bc9", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-20T12:21:19Z", "type": "forcePushed"}, {"oid": "fa5a142830c1dc63217248d6068ddb7f9b236e32", "url": "https://github.com/zaproxy/zap-extensions/commit/fa5a142830c1dc63217248d6068ddb7f9b236e32", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-20T12:24:00Z", "type": "forcePushed"}, {"oid": "03c816015082d97b23f457a779c301202ba0bb4f", "url": "https://github.com/zaproxy/zap-extensions/commit/03c816015082d97b23f457a779c301202ba0bb4f", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-20T12:24:51Z", "type": "commit"}, {"oid": "03c816015082d97b23f457a779c301202ba0bb4f", "url": "https://github.com/zaproxy/zap-extensions/commit/03c816015082d97b23f457a779c301202ba0bb4f", "message": "exim: Add HAR functionality\n\nAdd HAR import/export functionality.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2021-04-20T12:24:51Z", "type": "forcePushed"}]}