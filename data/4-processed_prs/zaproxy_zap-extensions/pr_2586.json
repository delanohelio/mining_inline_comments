{"pr_number": 2586, "pr_title": "pscanrules: CSP Scan Rule handle potential IllegalArgumentException", "pr_createdAt": "2020-10-26T18:22:51Z", "pr_url": "https://github.com/zaproxy/zap-extensions/pull/2586", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwNDI1NQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2586#discussion_r512604255", "bodyText": "Remove.", "author": "thc202", "createdAt": "2020-10-27T11:12:41Z", "path": "addOns/pscanrules/src/main/java/org/zaproxy/zap/extension/pscanrules/ContentSecurityPolicyScanRule.java", "diffHunk": "@@ -145,13 +148,16 @@ public void scanHttpResponseReceive(HttpMessage msg, int id, Source source) {\n             Origin origin = URI.parse(msg.getRequestHeader().getURI().toString());\n             Policy unifiedPolicy = new Policy(origin);\n             boolean multipleCsp = cspOptions.size() > 1;\n-            if (multipleCsp) {\n+            boolean hasReportUri = hasReportUri(cspOptions);\n+            if (multipleCsp && !hasReportUri) {\n                 for (String csp : cspOptions) {\n                     Policy policy = ParserWithLocation.parse(csp, origin);\n                     unifiedPolicy.intersect(policy);\n                 }\n             }\n-            String unifiedPolicyText = multipleCsp ? unifiedPolicy.show() : cspOptions.get(0);\n+            String unifiedPolicyText =\n+                    multipleCsp && !hasReportUri ? unifiedPolicy.show() : cspOptions.get(0);\n+            System.out.println(unifiedPolicyText);", "originalCommit": "d33465ea5cc95d2f3891fc2e639774d3839788f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwNTEwNg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2586#discussion_r512605106", "bodyText": "static", "author": "thc202", "createdAt": "2020-10-27T11:14:16Z", "path": "addOns/pscanrules/src/main/java/org/zaproxy/zap/extension/pscanrules/ContentSecurityPolicyScanRule.java", "diffHunk": "@@ -245,6 +255,16 @@ public void scanHttpResponseReceive(HttpMessage msg, int id, Source source) {\n         }\n     }\n \n+    private boolean hasReportUri(List<String> cspOptions) {", "originalCommit": "d33465ea5cc95d2f3891fc2e639774d3839788f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwNTEzMw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2586#discussion_r512605133", "bodyText": "Should check just report-uri? The report-to does not seem to cause an exception(?).", "author": "thc202", "createdAt": "2020-10-27T11:14:20Z", "path": "addOns/pscanrules/src/main/java/org/zaproxy/zap/extension/pscanrules/ContentSecurityPolicyScanRule.java", "diffHunk": "@@ -245,6 +255,16 @@ public void scanHttpResponseReceive(HttpMessage msg, int id, Source source) {\n         }\n     }\n \n+    private boolean hasReportUri(List<String> cspOptions) {\n+        for (String csp : cspOptions) {\n+            String lowerCsp = csp.toLowerCase(Locale.ROOT);\n+            if (lowerCsp.contains(\"report-uri\") || lowerCsp.contains(\"report-to\")) {", "originalCommit": "d33465ea5cc95d2f3891fc2e639774d3839788f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwNTIyNQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2586#discussion_r512605225", "bodyText": "This could be done as an else if of the following, it's clearer that the hasReportUri takes precedence that way.", "author": "thc202", "createdAt": "2020-10-27T11:14:30Z", "path": "addOns/pscanrules/src/main/java/org/zaproxy/zap/extension/pscanrules/ContentSecurityPolicyScanRule.java", "diffHunk": "@@ -383,12 +403,16 @@ private void raiseAlert(\n             int risk,\n             String evidence,\n             boolean multipleCsp,\n+            boolean hasReportUri,\n             String policy) {\n         String alertName = StringUtils.isEmpty(name) ? getName() : getName() + \": \" + name;\n-        String otherInfo =\n-                multipleCsp\n-                        ? Constant.messages.getString(MESSAGE_PREFIX + \"otherinfo\", policy)\n-                        : \"\";\n+        String otherInfo = \"\";\n+        if (multipleCsp) {\n+            otherInfo = Constant.messages.getString(MESSAGE_PREFIX + \"otherinfo\", policy);\n+        }", "originalCommit": "d33465ea5cc95d2f3891fc2e639774d3839788f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwNTU5MA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2586#discussion_r512605590", "bodyText": "them", "author": "thc202", "createdAt": "2020-10-27T11:15:08Z", "path": "addOns/pscanrules/src/main/resources/org/zaproxy/zap/extension/pscanrules/resources/Messages.properties", "diffHunk": "@@ -181,6 +181,7 @@ pscanrules.csp.name=CSP\n pscanrules.csp.desc=Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks. Including (but not limited to) Cross Site Scripting (XSS), and data injection attacks. These attacks are used for everything from data theft to site defacement or distribution of malware. CSP provides a set of standard HTTP headers that allow website owners to declare approved sources of content that browsers should be allowed to load on that page \\u2014 covered types are JavaScript, CSS, HTML frames, fonts, images and embeddable objects such as Java applets, ActiveX, audio and video files.\n pscanrules.csp.desc.extended=\\n\\nThe directive(s): {0} are among the directives that do not fallback to default-src, missing/excluding them is the same as allowing anything.\n pscanrules.csp.otherinfo=The response contained multiple CSP headers, these were merged (intersected) into a single policy for evaluation:\\n{0}\\nNote: The highlighting and evidence for this alert may be inaccurate due to these multiple headers.\n+pscanrules.csp.otherinfo.nomerge=The response contained multiple CSP headers, one or more of then contained a report-uri or report-to directive and therefore they could not be merged. The first identified header/policy was analyzed.", "originalCommit": "d33465ea5cc95d2f3891fc2e639774d3839788f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbc9de6eb4a4c7a56dcebdec04f83b37bfeb033e", "url": "https://github.com/zaproxy/zap-extensions/commit/dbc9de6eb4a4c7a56dcebdec04f83b37bfeb033e", "message": "pscanrules: CSP Scan Rule handle potential IllegalArgumentException\n\n- Handle an IllegalArgumentException that could occur in the CSP scan\nrule if multiple CSP headers were present and one (or more) had a\nreport-uri or report-to directive when trying to merge them.\n- Add unit tests and add change note to CHANGELOG.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-10-27T12:23:39Z", "type": "forcePushed"}, {"oid": "8c6bd234f9a786c208de12c3c0c60034045f6122", "url": "https://github.com/zaproxy/zap-extensions/commit/8c6bd234f9a786c208de12c3c0c60034045f6122", "message": "pscanrules: CSP Scan Rule handle potential IllegalArgumentException\n\n- Handle an IllegalArgumentException that could occur in the CSP scan\nrule if multiple CSP headers were present and one (or more) had a\nreport-uri or report-to directive when trying to merge them.\n- Add unit tests and add change note to CHANGELOG.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-10-27T12:25:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcyNzQwNw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2586#discussion_r512727407", "bodyText": "Needs update (remove report-to).", "author": "thc202", "createdAt": "2020-10-27T14:14:12Z", "path": "addOns/pscanrules/CHANGELOG.md", "diffHunk": "@@ -9,6 +9,7 @@ The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).\n - The CSP scan rule now includes further information in the description of allowed wildcard directives alerts when the impacted directive is one (or more) which doesn't fallback to default-src.\n - Maintenance changes.\n - Changed ViewState and XFrameOption rules to return example alerts for the docs\n+- Handle an IllegalArgumentException that could occur in the CSP scan rule if multiple CSP headers were present and one (or more) had a report-uri or report-to directive when trying to merge them.", "originalCommit": "8c6bd234f9a786c208de12c3c0c60034045f6122", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcyNzQ0Ng==", "url": "https://github.com/zaproxy/zap-extensions/pull/2586#discussion_r512727446", "bodyText": "Same here.", "author": "thc202", "createdAt": "2020-10-27T14:14:14Z", "path": "addOns/pscanrules/src/main/resources/org/zaproxy/zap/extension/pscanrules/resources/Messages.properties", "diffHunk": "@@ -181,6 +181,7 @@ pscanrules.csp.name=CSP\n pscanrules.csp.desc=Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks. Including (but not limited to) Cross Site Scripting (XSS), and data injection attacks. These attacks are used for everything from data theft to site defacement or distribution of malware. CSP provides a set of standard HTTP headers that allow website owners to declare approved sources of content that browsers should be allowed to load on that page \\u2014 covered types are JavaScript, CSS, HTML frames, fonts, images and embeddable objects such as Java applets, ActiveX, audio and video files.\n pscanrules.csp.desc.extended=\\n\\nThe directive(s): {0} are among the directives that do not fallback to default-src, missing/excluding them is the same as allowing anything.\n pscanrules.csp.otherinfo=The response contained multiple CSP headers, these were merged (intersected) into a single policy for evaluation:\\n{0}\\nNote: The highlighting and evidence for this alert may be inaccurate due to these multiple headers.\n+pscanrules.csp.otherinfo.nomerge=The response contained multiple CSP headers, one or more of them contained a report-uri or report-to directive and therefore they could not be merged. The first identified header/policy was analyzed.", "originalCommit": "8c6bd234f9a786c208de12c3c0c60034045f6122", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8112050cb209737c1ae36a3307d965967e22e7d", "url": "https://github.com/zaproxy/zap-extensions/commit/b8112050cb209737c1ae36a3307d965967e22e7d", "message": "pscanrules: CSP Scan Rule handle potential IllegalArgumentException\n\n- Handle an IllegalArgumentException that could occur in the CSP scan\nrule if multiple CSP headers were present and one (or more) had a\nreport-uri or report-to directive when trying to merge them.\n- Add unit tests and add change note to CHANGELOG.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-10-27T16:54:11Z", "type": "forcePushed"}, {"oid": "b88edacb9050b1cc72bdbeb7a50f351592975733", "url": "https://github.com/zaproxy/zap-extensions/commit/b88edacb9050b1cc72bdbeb7a50f351592975733", "message": "pscanrules: CSP Scan Rule handle potential IllegalArgumentException\n\n- Handle an IllegalArgumentException that could occur in the CSP scan\nrule if multiple CSP headers were present and one (or more) had a\nreport-uri directive when trying to merge them.\n- Add unit tests and add change note to CHANGELOG.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-10-27T17:01:56Z", "type": "commit"}, {"oid": "b88edacb9050b1cc72bdbeb7a50f351592975733", "url": "https://github.com/zaproxy/zap-extensions/commit/b88edacb9050b1cc72bdbeb7a50f351592975733", "message": "pscanrules: CSP Scan Rule handle potential IllegalArgumentException\n\n- Handle an IllegalArgumentException that could occur in the CSP scan\nrule if multiple CSP headers were present and one (or more) had a\nreport-uri directive when trying to merge them.\n- Add unit tests and add change note to CHANGELOG.\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-10-27T17:01:56Z", "type": "forcePushed"}]}