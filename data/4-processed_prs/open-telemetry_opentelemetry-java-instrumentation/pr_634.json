{"pr_number": 634, "pr_title": "Server spans", "pr_createdAt": "2020-07-05T14:47:51Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634", "timeline": [{"oid": "ea6a486f3feb428c0d3d1a2f267dbcae16823e56", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ea6a486f3feb428c0d3d1a2f267dbcae16823e56", "message": "Milestone 1", "committedDate": "2020-07-05T12:43:08Z", "type": "commit"}, {"oid": "03f6e51915faf23d171fee04ae02a7e5028c415b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/03f6e51915faf23d171fee04ae02a7e5028c415b", "message": "Netty 4.1 done", "committedDate": "2020-07-05T12:43:30Z", "type": "commit"}, {"oid": "dc701d53dc8641760f5730c9e32f0980aead64c5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/dc701d53dc8641760f5730c9e32f0980aead64c5", "message": "Netty 4.0 done", "committedDate": "2020-07-05T12:43:30Z", "type": "commit"}, {"oid": "b03b5ee5efbf2314ababd0c246cbd195c8b613df", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b03b5ee5efbf2314ababd0c246cbd195c8b613df", "message": "Netty 3.8 done", "committedDate": "2020-07-05T12:43:30Z", "type": "commit"}, {"oid": "0fc92ad77c46794b5fbe7cfc48cf40c5d888cb91", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0fc92ad77c46794b5fbe7cfc48cf40c5d888cb91", "message": "All tests pass", "committedDate": "2020-07-05T12:44:07Z", "type": "commit"}, {"oid": "2a5b40dc29ccec974bff316ed522be9d6c726d7b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2a5b40dc29ccec974bff316ed522be9d6c726d7b", "message": "Test fix", "committedDate": "2020-07-05T12:44:07Z", "type": "commit"}, {"oid": "e6db0db86c2b32a29f4e37b0bb21f7bb87055198", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e6db0db86c2b32a29f4e37b0bb21f7bb87055198", "message": "Last proper server tracers done", "committedDate": "2020-07-05T14:42:45Z", "type": "commit"}, {"oid": "2bf7819035bd4f62f3c891fce1a6a551337b7740", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2bf7819035bd4f62f3c891fce1a6a551337b7740", "message": "Format fix", "committedDate": "2020-07-05T15:04:03Z", "type": "commit"}, {"oid": "39d7338cca36cd7a6f01e655b140a6517add32ea", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/39d7338cca36cd7a6f01e655b140a6517add32ea", "message": "Tests fixed", "committedDate": "2020-07-05T18:29:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4Mjc1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r449982759", "bodyText": "Do we need to check whether there is a current CONTEXT_SERVER_SPAN_KEY to prevent duplicate server spans here?", "author": "anuraaga", "createdAt": "2020-07-06T04:53:42Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -56,25 +59,31 @@ public HttpServerTracer() {\n \n   protected abstract String getVersion();\n \n-  public Span startSpan(REQUEST request, Method origin, String originType) {\n+  public Span startSpan(REQUEST request, CONNECTION connection, Method origin, String originType) {\n+    String spanName = spanNameForMethod(origin);\n+    return startSpan(request, connection, spanName, originType);\n+  }\n+\n+  public Span startSpan(\n+      REQUEST request, CONNECTION connection, String spanName, String originType) {\n     final Span.Builder builder =", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDExNjYyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450116622", "bodyText": "It was @trask wish to never return null from startSpan methods. And to let every instrumentation to check the existence of the server span themselves. Unfortunately :) I saw his point, so couldn't object too much.", "author": "iNikem", "createdAt": "2020-07-06T10:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4Mjc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ5OTkzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450499936", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  attributeKey(HttpServerTracingHandler.class.getName() + \".span\");\n          \n          \n            \n                  attributeKey(HttpServerTracingHandler.class.getName() + \".context\");", "author": "trask", "createdAt": "2020-07-06T21:55:10Z", "path": "instrumentation/netty/netty-4.0/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_0/AttributeKeys.java", "diffHunk": "@@ -39,7 +40,7 @@\n   public static final AttributeKey<Span> PARENT_CONNECT_SPAN_ATTRIBUTE_KEY =\n       attributeKey(\"io.opentelemetry.auto.instrumentation.netty.v4_0.parent.connect.span\");\n \n-  public static final AttributeKey<Span> SERVER_ATTRIBUTE_KEY =\n+  public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n       attributeKey(HttpServerTracingHandler.class.getName() + \".span\");", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyODE4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450528183", "bodyText": "i'm not opposed to this change, but curious your reason?", "author": "trask", "createdAt": "2020-07-06T23:22:05Z", "path": "instrumentation/akka-http-10.0/src/lagomTest/groovy/LagomTest.groovy", "diffHunk": "@@ -124,7 +123,7 @@ class LagomTest extends AgentTestRunner {\n     }\n   }\n \n-  String expectedOperationName(String method) {\n-    return method != null ? \"HTTP $method\" : HttpServerDecorator.DEFAULT_SPAN_NAME\n+  String expectedOperationName() {\n+    return \"akka.request\"", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMDAzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450620031", "bodyText": "Main reason is that I didn't want to migrate HttpServerDecorator#spanNameForRequest to HttpServerTracer", "author": "iNikem", "createdAt": "2020-07-07T05:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyODE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYzNjAwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450636001", "bodyText": "In cases where we don't have a nice route-based span name, I think we most commonly fall back to Class(simpleName).method\nI guess in this case that would be something like HttpExt.bindAndHandleSync or HttpExt.bindAndHandleAsync, which isn't super awesome either.", "author": "trask", "createdAt": "2020-07-07T06:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyODE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYzNzc3NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450637774", "bodyText": "Yeah, that fallback works if we have some sensible class.method at hand. I don't have good ideas here", "author": "iNikem", "createdAt": "2020-07-07T06:28:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyODE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzMDQ2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450530469", "bodyText": "there's several of call sites that pass 500, maybe an overload that defaults to 500?", "author": "trask", "createdAt": "2020-07-06T23:29:38Z", "path": "instrumentation/akka-http-10.0/src/main/java/io/opentelemetry/auto/instrumentation/akkahttp/AkkaHttpServerInstrumentation.java", "diffHunk": "@@ -149,16 +110,13 @@ public SyncWrapper(final Function1<HttpRequest, HttpResponse> userHandler) {\n \n     @Override\n     public HttpResponse apply(final HttpRequest request) {\n-      final SpanWithScope spanWithScope = WrapperHelper.createSpan(request);\n-      final Span span = spanWithScope.getSpan();\n-      try {\n+      Span span = TRACER.startSpan(request, request, \"akka.request\", null);\n+      try (Scope ignored = TRACER.startScope(span, request)) {\n         final HttpResponse response = userHandler.apply(request);\n-        spanWithScope.closeScope();\n-        WrapperHelper.finishSpan(span, response);\n+        TRACER.end(span, response.status().intValue());\n         return response;\n       } catch (final Throwable t) {\n-        spanWithScope.closeScope();\n-        WrapperHelper.finishSpan(span, t);\n+        TRACER.endExceptionally(span, t, 500);", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0MTUzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450541533", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns context stored to the given storage by {@link #attachServerSpanContext(Context,\n          \n          \n            \n               * STORAGE)}.\n          \n          \n            \n               * Returns context stored to the given request-response-loop storage by {@link #attachServerSpanContext(Context,\n          \n          \n            \n               * STORAGE)}.", "author": "trask", "createdAt": "2020-07-07T00:08:50Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -218,23 +234,24 @@ private void setStatus(Span span, int status) {\n     span.setStatus(HttpStatusConverter.statusFromHttpStatus(status));\n   }\n \n-  protected abstract Integer peerPort(REQUEST request);\n+  protected abstract Integer peerPort(CONNECTION connection);\n \n-  protected abstract String peerHostIP(REQUEST request);\n+  protected abstract String peerHostIP(CONNECTION connection);\n \n   protected abstract HttpTextFormat.Getter<REQUEST> getGetter();\n \n   protected abstract URI url(REQUEST request) throws URISyntaxException;\n \n   protected abstract String method(REQUEST request);\n \n-  /** Stores given context in the given request in implementation specific way. */\n-  protected abstract void attachContextToRequest(Context context, REQUEST request);\n+  /** Stores given context in the given storage in implementation specific way. */\n+  protected abstract void attachServerSpanContext(Context context, STORAGE storage);\n \n   /**\n-   * Returns context stored to given request by {@link #attachContextToRequest(Context, REQUEST)}.\n+   * Returns context stored to the given storage by {@link #attachServerSpanContext(Context,\n+   * STORAGE)}.", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0MjM2MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450542361", "bodyText": "to self doc that it doesn't use storage\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class AkkaHttpServerTracer extends HttpServerTracer<HttpRequest, HttpRequest, HttpRequest> {\n          \n          \n            \n            public class AkkaHttpServerTracer extends HttpServerTracer<HttpRequest, HttpRequest, Void> {", "author": "trask", "createdAt": "2020-07-07T00:11:52Z", "path": "instrumentation/akka-http-10.0/src/main/java/io/opentelemetry/auto/instrumentation/akkahttp/AkkaHttpServerTracer.java", "diffHunk": "@@ -17,25 +17,28 @@\n package io.opentelemetry.auto.instrumentation.akkahttp;\n \n import akka.http.scaladsl.model.HttpRequest;\n-import akka.http.scaladsl.model.HttpResponse;\n-import io.opentelemetry.OpenTelemetry;\n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpServerDecorator;\n-import io.opentelemetry.trace.Tracer;\n+import io.grpc.Context;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpServerTracer;\n+import io.opentelemetry.context.propagation.HttpTextFormat.Getter;\n import java.net.URI;\n import java.net.URISyntaxException;\n \n-public class AkkaHttpServerDecorator\n-    extends HttpServerDecorator<HttpRequest, HttpRequest, HttpResponse> {\n-  public static final AkkaHttpServerDecorator DECORATE = new AkkaHttpServerDecorator();\n-\n-  public static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.akka-http-10.0\");\n+public class AkkaHttpServerTracer extends HttpServerTracer<HttpRequest, HttpRequest, HttpRequest> {", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0Mjc0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450542748", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              protected void attachServerSpanContext(Context context, HttpRequest httpRequest) {}\n          \n          \n            \n              protected void attachServerSpanContext(Context context, Void storage) {}", "author": "trask", "createdAt": "2020-07-07T00:13:21Z", "path": "instrumentation/akka-http-10.0/src/main/java/io/opentelemetry/auto/instrumentation/akkahttp/AkkaHttpServerTracer.java", "diffHunk": "@@ -17,25 +17,28 @@\n package io.opentelemetry.auto.instrumentation.akkahttp;\n \n import akka.http.scaladsl.model.HttpRequest;\n-import akka.http.scaladsl.model.HttpResponse;\n-import io.opentelemetry.OpenTelemetry;\n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpServerDecorator;\n-import io.opentelemetry.trace.Tracer;\n+import io.grpc.Context;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpServerTracer;\n+import io.opentelemetry.context.propagation.HttpTextFormat.Getter;\n import java.net.URI;\n import java.net.URISyntaxException;\n \n-public class AkkaHttpServerDecorator\n-    extends HttpServerDecorator<HttpRequest, HttpRequest, HttpResponse> {\n-  public static final AkkaHttpServerDecorator DECORATE = new AkkaHttpServerDecorator();\n-\n-  public static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.akka-http-10.0\");\n+public class AkkaHttpServerTracer extends HttpServerTracer<HttpRequest, HttpRequest, HttpRequest> {\n+  public static final AkkaHttpServerTracer TRACER = new AkkaHttpServerTracer();\n \n   @Override\n   protected String method(final HttpRequest httpRequest) {\n     return httpRequest.method().value();\n   }\n \n+  @Override\n+  protected void attachServerSpanContext(Context context, HttpRequest httpRequest) {}", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0Mjc5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450542797", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Context getServerSpanContext(HttpRequest httpRequest) {\n          \n          \n            \n              public Context getServerSpanContext(Void storage) {", "author": "trask", "createdAt": "2020-07-07T00:13:31Z", "path": "instrumentation/akka-http-10.0/src/main/java/io/opentelemetry/auto/instrumentation/akkahttp/AkkaHttpServerTracer.java", "diffHunk": "@@ -17,25 +17,28 @@\n package io.opentelemetry.auto.instrumentation.akkahttp;\n \n import akka.http.scaladsl.model.HttpRequest;\n-import akka.http.scaladsl.model.HttpResponse;\n-import io.opentelemetry.OpenTelemetry;\n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpServerDecorator;\n-import io.opentelemetry.trace.Tracer;\n+import io.grpc.Context;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpServerTracer;\n+import io.opentelemetry.context.propagation.HttpTextFormat.Getter;\n import java.net.URI;\n import java.net.URISyntaxException;\n \n-public class AkkaHttpServerDecorator\n-    extends HttpServerDecorator<HttpRequest, HttpRequest, HttpResponse> {\n-  public static final AkkaHttpServerDecorator DECORATE = new AkkaHttpServerDecorator();\n-\n-  public static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.akka-http-10.0\");\n+public class AkkaHttpServerTracer extends HttpServerTracer<HttpRequest, HttpRequest, HttpRequest> {\n+  public static final AkkaHttpServerTracer TRACER = new AkkaHttpServerTracer();\n \n   @Override\n   protected String method(final HttpRequest httpRequest) {\n     return httpRequest.method().value();\n   }\n \n+  @Override\n+  protected void attachServerSpanContext(Context context, HttpRequest httpRequest) {}\n+\n+  @Override\n+  public Context getServerSpanContext(HttpRequest httpRequest) {", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NjAyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450546022", "bodyText": "can merge inner try/catch into the outer try-with-resources (and i think same in v4_0 and v4_1 copies)", "author": "trask", "createdAt": "2020-07-07T00:25:43Z", "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/server/HttpServerRequestTracingHandler.java", "diffHunk": "@@ -48,43 +45,25 @@ public void messageReceived(final ChannelHandlerContext ctx, final MessageEvent\n         contextStore.putIfAbsent(ctx.getChannel(), ChannelTraceContext.Factory.INSTANCE);\n \n     if (!(msg.getMessage() instanceof HttpRequest)) {\n-      final Span span = channelTraceContext.getServerSpan();\n-      if (span == null) {\n-        ctx.sendUpstream(msg); // superclass does not throw\n+      Context serverSpanContext = TRACER.getServerSpanContext(channelTraceContext);\n+      if (serverSpanContext == null) {\n+        ctx.sendUpstream(msg);\n       } else {\n-        try (final Scope scope = TRACER.withSpan(span)) {\n-          ctx.sendUpstream(msg); // superclass does not throw\n+        try (final Scope ignored = ContextUtils.withScopedContext(serverSpanContext)) {\n+          ctx.sendUpstream(msg);\n         }\n       }\n       return;\n     }\n \n     final HttpRequest request = (HttpRequest) msg.getMessage();\n \n-    final Span.Builder spanBuilder =\n-        TRACER.spanBuilder(DECORATE.spanNameForRequest(request)).setSpanKind(SERVER);\n-    final SpanContext extractedContext = extract(request.headers(), GETTER);\n-    if (extractedContext.isValid()) {\n-      spanBuilder.setParent(extractedContext);\n-    } else {\n-      // explicitly setting \"no parent\" in case a span was propagated to this thread\n-      // by the java-concurrent instrumentation when the thread was started\n-      spanBuilder.setNoParent();\n-    }\n-    final Span span = spanBuilder.startSpan();\n-    try (final Scope scope = TRACER.withSpan(span)) {\n-      DECORATE.afterStart(span);\n-      DECORATE.onConnection(span, ctx.getChannel());\n-      DECORATE.onRequest(span, request);\n-\n-      channelTraceContext.setServerSpan(span);\n-\n+    Span span = TRACER.startSpan(request, ctx.getChannel(), \"netty.request\", null);\n+    try (final Scope ignored = TRACER.startScope(span, channelTraceContext)) {", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0NzA3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450547073", "bodyText": "can be single-level try, e.g. (and same in v4_0 and v4_1 copies)\n    Span span = TracingContextUtils.getSpan(context);\n    try (final Scope ignored = ContextUtils.withScopedContext(context)) {\n      ctx.write(msg, prm);\n    } catch (final Throwable throwable) {\n      TRACER.endExceptionally(span, throwable, 500);\n      throw throwable;\n    }\n    TRACER.end(span, ((HttpResponse) msg).status().code());", "author": "trask", "createdAt": "2020-07-07T00:29:33Z", "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/server/HttpServerResponseTracingHandler.java", "diffHunk": "@@ -44,26 +45,21 @@ public void writeRequested(final ChannelHandlerContext ctx, final MessageEvent m\n     final ChannelTraceContext channelTraceContext =\n         contextStore.putIfAbsent(ctx.getChannel(), ChannelTraceContext.Factory.INSTANCE);\n \n-    final Span span = channelTraceContext.getServerSpan();\n-    if (span == null || !(msg.getMessage() instanceof HttpResponse)) {\n+    final Context context = TRACER.getServerSpanContext(channelTraceContext);\n+    if (context == null || !(msg.getMessage() instanceof HttpResponse)) {\n       ctx.sendDownstream(msg);\n       return;\n     }\n \n-    try (final Scope scope = TRACER.withSpan(span)) {\n-      final HttpResponse response = (HttpResponse) msg.getMessage();\n-\n+    try (final Scope ignored = ContextUtils.withScopedContext(context)) {", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0Nzg0Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450547846", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  attributeKey(HttpServerTracingHandler.class.getName() + \".span\");\n          \n          \n            \n                  attributeKey(HttpServerTracingHandler.class.getName() + \".context\");", "author": "trask", "createdAt": "2020-07-07T00:32:35Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_1/AttributeKeys.java", "diffHunk": "@@ -44,10 +45,10 @@\n    * io.opentelemetry.auto.instrumentation.ratpack.server.TracingHandler, so if this changes, that\n    * must also change.\n    */\n-  // TODO understand and change to context\n-  public static final AttributeKey<Span> SERVER_ATTRIBUTE_KEY =\n+  public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n       attributeKey(HttpServerTracingHandler.class.getName() + \".span\");", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0ODg1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450548852", "bodyText": "i think all these server helpers can go away", "author": "trask", "createdAt": "2020-07-07T00:36:59Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_1/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -69,7 +69,7 @@ public ChannelFutureListenerInstrumentation() {\n       packageName + \".client.HttpClientResponseTracingHandler\",\n       packageName + \".client.HttpClientTracingHandler\",\n       // server helpers\n-      packageName + \".server.NettyHttpServerDecorator\",\n+      packageName + \".server.NettyHttpServerTracer\",", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMTgxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450621811", "bodyText": "Why? From class loading perspective they don't differ from old decorator, do they?", "author": "iNikem", "createdAt": "2020-07-07T05:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0ODg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMzk5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450623993", "bodyText": "A, I see what you mean... Let me try", "author": "iNikem", "createdAt": "2020-07-07T05:46:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0ODg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyOTEwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450629106", "bodyText": "Nope, they cannot. ChannelFutureListenerInstrumentation uses AttributeKeys, which depends on HttpServerTracingHandler", "author": "iNikem", "createdAt": "2020-07-07T06:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0ODg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0OTAzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450549038", "bodyText": "i think this is a good catch, it seems to me this instrumentation only applies to netty client, should we move it to the client subpackage?", "author": "trask", "createdAt": "2020-07-07T00:37:44Z", "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_1/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -27,7 +27,7 @@\n \n import com.google.auto.service.AutoService;\n import io.netty.channel.ChannelFuture;\n-import io.opentelemetry.auto.instrumentation.netty.v4_1.server.NettyHttpServerDecorator;\n+import io.opentelemetry.auto.instrumentation.netty.v4_1.client.NettyHttpClientDecorator;", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU1MDM2MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450550361", "bodyText": "trying to differentiate more between the different storages\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /** Stores given context in the given storage in implementation specific way. */\n          \n          \n            \n              /** Stores given context in the request-response-loop storage in implementation specific way. */```", "author": "trask", "createdAt": "2020-07-07T00:43:14Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -218,23 +234,24 @@ private void setStatus(Span span, int status) {\n     span.setStatus(HttpStatusConverter.statusFromHttpStatus(status));\n   }\n \n-  protected abstract Integer peerPort(REQUEST request);\n+  protected abstract Integer peerPort(CONNECTION connection);\n \n-  protected abstract String peerHostIP(REQUEST request);\n+  protected abstract String peerHostIP(CONNECTION connection);\n \n   protected abstract HttpTextFormat.Getter<REQUEST> getGetter();\n \n   protected abstract URI url(REQUEST request) throws URISyntaxException;\n \n   protected abstract String method(REQUEST request);\n \n-  /** Stores given context in the given request in implementation specific way. */\n-  protected abstract void attachContextToRequest(Context context, REQUEST request);\n+  /** Stores given context in the given storage in implementation specific way. */", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU1MTE0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450551143", "bodyText": "i found \"server span context\" a bit confusing. i got used to it by the end of reviewing the PR, but maybe just \"server context\"?\nand this method, being defined in HttpServerTracer could be just\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              protected abstract void attachServerSpanContext(Context context, STORAGE storage);\n          \n          \n            \n              protected abstract void attachContext(Context context, STORAGE storage);", "author": "trask", "createdAt": "2020-07-07T00:46:14Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -218,23 +234,24 @@ private void setStatus(Span span, int status) {\n     span.setStatus(HttpStatusConverter.statusFromHttpStatus(status));\n   }\n \n-  protected abstract Integer peerPort(REQUEST request);\n+  protected abstract Integer peerPort(CONNECTION connection);\n \n-  protected abstract String peerHostIP(REQUEST request);\n+  protected abstract String peerHostIP(CONNECTION connection);\n \n   protected abstract HttpTextFormat.Getter<REQUEST> getGetter();\n \n   protected abstract URI url(REQUEST request) throws URISyntaxException;\n \n   protected abstract String method(REQUEST request);\n \n-  /** Stores given context in the given request in implementation specific way. */\n-  protected abstract void attachContextToRequest(Context context, REQUEST request);\n+  /** Stores given context in the given storage in implementation specific way. */\n+  protected abstract void attachServerSpanContext(Context context, STORAGE storage);", "originalCommit": "39d7338cca36cd7a6f01e655b140a6517add32ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMjc4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450622780", "bodyText": "I can rename attach method because it is protected, but getServerSpanContext is public, meant to be used by instrumentations. And I think there the longer, more explicit name, is better.", "author": "iNikem", "createdAt": "2020-07-07T05:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU1MTE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyODgzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/634#discussion_r450628835", "bodyText": "what do u think of  attachServerContext() and getServerContext()?", "author": "trask", "createdAt": "2020-07-07T06:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU1MTE0Mw=="}], "type": "inlineReview"}, {"oid": "bb260334037ad60fde5378ca2ce0dc32c4aee9dd", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bb260334037ad60fde5378ca2ce0dc32c4aee9dd", "message": "Polish", "committedDate": "2020-07-07T07:07:49Z", "type": "commit"}, {"oid": "beb1ba89228cf5514e9f8d017c9cd7e6b6781515", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/beb1ba89228cf5514e9f8d017c9cd7e6b6781515", "message": "Polish", "committedDate": "2020-07-07T08:33:37Z", "type": "commit"}]}