{"pr_number": 1184, "pr_title": "Implement some support for JAX-RS 2.1 additions", "pr_createdAt": "2020-09-09T12:19:45Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184", "timeline": [{"oid": "c207902636429c525d81141e64e758b8671cf187", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c207902636429c525d81141e64e758b8671cf187", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-09T12:21:08Z", "type": "forcePushed"}, {"oid": "1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-09T12:33:40Z", "type": "forcePushed"}, {"oid": "116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-09T12:41:24Z", "type": "forcePushed"}, {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/32db9a852fc02bd5f893f74387835b5c6931532c", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T07:20:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0OTEwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486849105", "bodyText": "I don't think we consistently do so in this codebase, but FWIU handle has much better performance than whenComplete (due to a JDK bug?)\nline/armeria#1426\nCan we use handle here?", "author": "anuraaga", "createdAt": "2020-09-11T08:12:22Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-common/src/main/java/io/opentelemetry/instrumentation/auto/jaxrs/v2_0/JaxRsAnnotationsInstrumentation.java", "diffHunk": "@@ -155,15 +157,23 @@ public static void stopSpan(\n         return;\n       }\n \n+      CompletionStage<?> asyncReturnValue =\n+          returnValue instanceof CompletionStage ? (CompletionStage<?>) returnValue : null;\n+\n       if (asyncResponse != null && !asyncResponse.isSuspended()) {\n         // Clear span from the asyncResponse. Logically this should never happen. Added to be safe.\n         InstrumentationContext.get(AsyncResponse.class, Span.class).put(asyncResponse, null);\n       }\n-      if (asyncResponse == null || !asyncResponse.isSuspended()) {\n+      if (asyncReturnValue != null) {\n+        // span finished by CompletionStageFinishCallback\n+        asyncReturnValue = asyncReturnValue.whenComplete(new CompletionStageFinishCallback<>(span));", "originalCommit": "32db9a852fc02bd5f893f74387835b5c6931532c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg4NTg1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486885857", "bodyText": "Can we use handle here?\n\nOf course -- changed. Thanks!", "author": "mateuszrzeszutek", "createdAt": "2020-09-11T09:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0OTEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1MDk4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486850980", "bodyText": "If this is false normally and true when running latest deps, recommend being more explicit about it like our redisson instrumentation\nhttps://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/master/instrumentation/redisson-3.0/redisson-3.0.gradle#L21", "author": "anuraaga", "createdAt": "2020-09-11T08:15:59Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-testing/src/main/groovy/JaxRsHttpServerTest.groovy", "diffHunk": "@@ -73,6 +104,15 @@ abstract class JaxRsHttpServerTest<S> extends HttpServerTest<S> {\n     true\n   }\n \n+  private static boolean supportsJaxRs21() {", "originalCommit": "32db9a852fc02bd5f893f74387835b5c6931532c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg4NjEzOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486886139", "bodyText": "\ud83d\udc4d\nThat's much better, done.", "author": "mateuszrzeszutek", "createdAt": "2020-09-11T09:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1MDk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1MjIzNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486852237", "bodyText": "IIUC, it's important our test makes sure a span hasn't been ended before the future is completed. How about adding some sleep in the API method, and separate out making the call, checking there are no traces (with previous code I think there would have been), than joining on the future, then checking there are traces?", "author": "anuraaga", "createdAt": "2020-09-11T08:18:25Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-testing/src/main/groovy/JaxRsHttpServerTest.groovy", "diffHunk": "@@ -58,6 +59,36 @@ abstract class JaxRsHttpServerTest<S> extends HttpServerTest<S> {\n     \"canceled\"   | \"cancel\"  | 503        | { it instanceof String } | true        | false   | null\n   }\n \n+  @Unroll\n+  def \"should handle #desc CompletionStage (JAX-RS 2.1+ only)\"() {\n+    assumeTrue(supportsJaxRs21())\n+\n+    given:\n+    def url = HttpUrl.get(address.resolve(\"/async-completion-stage\")).newBuilder()\n+      .addQueryParameter(\"action\", action)\n+      .build()\n+    def request = request(url, \"GET\", null).build()\n+\n+    when:\n+    def response = client.newCall(request).execute()", "originalCommit": "32db9a852fc02bd5f893f74387835b5c6931532c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg4NzM4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486887381", "bodyText": "Instead of adding sleep (which would make this test at least a bit flaky) I've added synchronisation using a CyclicBarrier -- but the principle is the same: no traces until the future is complete.", "author": "mateuszrzeszutek", "createdAt": "2020-09-11T09:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1MjIzNw=="}], "type": "inlineReview"}, {"oid": "4330e12dc1689e831d2168556b41f4092318cabf", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4330e12dc1689e831d2168556b41f4092318cabf", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:06:35Z", "type": "forcePushed"}, {"oid": "cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:13:34Z", "type": "forcePushed"}, {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/da831c1c1d09b980e1bc52042a60f969b79c9650", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:20:10Z", "type": "commit"}, {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/da831c1c1d09b980e1bc52042a60f969b79c9650", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`", "committedDate": "2020-09-11T09:20:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3NTk3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486975970", "bodyText": "Why is this needed? @anuraaga is it?", "author": "iNikem", "createdAt": "2020-09-11T11:11:38Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-jersey-2.0/jaxrs-2.0-jersey-2.0.gradle", "diffHunk": "@@ -24,3 +24,7 @@ dependencies {\n   testImplementation group: 'javax.xml.bind', name: 'jaxb-api', version: '2.2.3'\n   testImplementation group: 'com.fasterxml.jackson.module', name: 'jackson-module-afterburner', version: '2.9.10'\n }\n+\n+test {\n+  systemProperty 'testLatestDeps', testLatestDeps", "originalCommit": "da831c1c1d09b980e1bc52042a60f969b79c9650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3NjI0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486976243", "bodyText": "A, got it...", "author": "iNikem", "createdAt": "2020-09-11T11:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3NTk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MTc0NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r487171744", "bodyText": "A, but this is a great point out. @mateuszrzeszutek if you get a chance to add a one line comment here sometime to avoid future confusion would be great!", "author": "anuraaga", "createdAt": "2020-09-11T16:57:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3NTk3MA=="}], "type": "inlineReview"}]}