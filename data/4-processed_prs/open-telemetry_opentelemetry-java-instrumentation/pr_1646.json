{"pr_number": 1646, "pr_title": "Prevent bootstrap classes from being included into agent classloader", "pr_createdAt": "2020-11-16T14:45:18Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1646", "timeline": [{"oid": "9ac73b049375fefd8290fd64198900b3c9bf3f6c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9ac73b049375fefd8290fd64198900b3c9bf3f6c", "message": "Prevent bootstrap classes from being included into agent classloader", "committedDate": "2020-11-16T14:44:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzMjcxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1646#discussion_r524632717", "bodyText": "seems better (generally at least) to exclude at dependency level, can be done below:\n  dependencies {\n    exclude(project(':instrumentation-api'))\n    exclude(project(':javaagent-api'))\n    exclude(project(':javaagent-bootstrap'))\n  }", "author": "trask", "createdAt": "2020-11-16T21:51:14Z", "path": "instrumentation/instrumentation.gradle", "diffHunk": "@@ -53,6 +50,9 @@ shadowJar {\n   mergeServiceFiles()\n \n   exclude '**/module-info.class'\n+  //These classes are added to bootstrap classloader by javaagent module\n+  exclude 'io/opentelemetry/instrumentation/api/**/*.*'\n+  exclude 'io/opentelemetry/javaagent/instrumentation/api/**/*.*'", "originalCommit": "9ac73b049375fefd8290fd64198900b3c9bf3f6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgwMjg5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1646#discussion_r524802897", "bodyText": "With the dependencies changed to compileOnly do we need any change here?", "author": "anuraaga", "createdAt": "2020-11-17T00:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzMjcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgwNDQxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1646#discussion_r524804418", "bodyText": "it's also getting these dependencies through :javaagent-tooling", "author": "trask", "createdAt": "2020-11-17T00:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzMjcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg5NDQyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1646#discussion_r524894422", "bodyText": "Should this also be compileOnly?", "author": "anuraaga", "createdAt": "2020-11-17T05:34:22Z", "path": "instrumentation/instrumentation.gradle", "diffHunk": "@@ -34,16 +34,13 @@ subprojects {\n }\n \n dependencies {\n-  implementation project(':instrumentation-api')\n-  implementation project(':javaagent-api')\n-  implementation(project(':javaagent-tooling')) {\n-    exclude module: ':javaagent-bootstrap'\n-  }\n+  compileOnly project(':instrumentation-api')\n+  compileOnly project(':javaagent-api')\n+  implementation(project(':javaagent-tooling'))", "originalCommit": "9ac73b049375fefd8290fd64198900b3c9bf3f6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI0MjYyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1646#discussion_r525242620", "bodyText": "javaagent module currently has only :javaagent-bootstrap in shadowInclude configuration. Which transitively depends on :javaagent-api and :instrumentation-api. All these three should be added to bootstrap classloader. This is done by javaagent module and thus these three modules should NOT come via instrumentation module. Everything that comes from the latter goes into inst folder inside jar and thus into agent classloader. javaagent-tooling should go there as well. Thus it is correct that instrumentation module includes it into its own shadowJar.", "author": "iNikem", "createdAt": "2020-11-17T15:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg5NDQyMg=="}], "type": "inlineReview"}, {"oid": "df0b21066daa01192f52251a6b41940a360b4c46", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/df0b21066daa01192f52251a6b41940a360b4c46", "message": "Better exclusion", "committedDate": "2020-11-17T15:25:10Z", "type": "commit"}]}