{"pr_number": 1441, "pr_title": "Log normalised full statement in Redis instrumentations", "pr_createdAt": "2020-10-21T14:02:27Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1Nzk4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510057986", "bodyText": "Why this is removed?", "author": "iNikem", "createdAt": "2020-10-22T10:37:08Z", "path": "instrumentation/jedis/jedis-3.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jedis/v3_0/JedisInstrumentation.java", "diffHunk": "@@ -59,14 +63,10 @@ public JedisInstrumentation() {\n     public static void onEnter(\n         @Advice.This Connection connection,\n         @Advice.Argument(0) ProtocolCommand command,\n+        @Advice.Argument(1) byte[][] args,\n         @Advice.Local(\"otelSpan\") Span span,\n         @Advice.Local(\"otelScope\") Scope scope) {\n-      int callDepth = CallDepthThreadLocalMap.incrementCallDepth(Connection.class);", "originalCommit": "270b7cc11876285f433d04744ece70af6a43c826", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNzU1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510137557", "bodyText": "It's no longer needed - I changed the method matcher so that exactly one method matches; previously there were 2 or 3 methods that got matched.", "author": "mateuszrzeszutek", "createdAt": "2020-10-22T12:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1Nzk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1OTIyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510059221", "bodyText": "I am not sure about this. foo here is cache key, right? Thus its cardinality is high. Thousands and millions potentially. Semantic convention says that span name should be low-cardinality value. select * from table_name is Ok span name, but here in Redis having cache key as part of the name - I am not sure.", "author": "iNikem", "createdAt": "2020-10-22T10:39:33Z", "path": "instrumentation/jedis/jedis-3.0/src/test/groovy/Jedis30ClientTest.groovy", "diffHunk": "@@ -76,29 +76,29 @@ class Jedis30ClientTest extends AgentTestRunner {\n     assertTraces(2) {\n       trace(0, 1) {\n         span(0) {\n-          name \"SET\"\n+          name \"SET foo ?\"\n           kind CLIENT\n           attributes {\n-            \"${SemanticAttributes.DB_SYSTEM.key()}\" \"redis\"\n-            \"${SemanticAttributes.DB_CONNECTION_STRING.key()}\" \"localhost:$port\"\n-            \"${SemanticAttributes.DB_STATEMENT.key()}\" \"SET\"\n-            \"${SemanticAttributes.NET_PEER_IP.key()}\" \"127.0.0.1\"\n-            \"${SemanticAttributes.NET_PEER_NAME.key()}\" \"localhost\"\n-            \"${SemanticAttributes.NET_PEER_PORT.key()}\" port\n+            \"$SemanticAttributes.DB_SYSTEM.key\" \"redis\"\n+            \"$SemanticAttributes.DB_CONNECTION_STRING.key\" \"localhost:$port\"\n+            \"$SemanticAttributes.DB_STATEMENT.key\" \"SET foo ?\"\n+            \"$SemanticAttributes.NET_PEER_IP.key\" \"127.0.0.1\"\n+            \"$SemanticAttributes.NET_PEER_NAME.key\" \"localhost\"\n+            \"$SemanticAttributes.NET_PEER_PORT.key\" port\n           }\n         }\n       }\n       trace(1, 1) {\n         span(0) {\n-          name \"GET\"\n+          name \"GET foo\"", "originalCommit": "270b7cc11876285f433d04744ece70af6a43c826", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzOTU3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510139572", "bodyText": "Hmm, that's true. Lettuce 5.1 uses just the command name as span name, how about making all other Redis instrumentations do the same? I think it matches the spec:\n\nThe span name SHOULD be set to a low cardinality value representing the statement executed on the database. It may be a stored procedure name (without arguments), SQL statement without variable arguments, operation name, etc.", "author": "mateuszrzeszutek", "createdAt": "2020-10-22T12:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1OTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE1MjAxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510152013", "bodyText": "Yes, just command name seems good.", "author": "iNikem", "createdAt": "2020-10-22T13:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1OTIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA2MDQ4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r512060488", "bodyText": "Done.", "author": "mateuszrzeszutek", "createdAt": "2020-10-26T15:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1OTIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2NzU3OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510067578", "bodyText": "Can args be List<Object>? This would eliminate this stream and thus extra allocations.", "author": "iNikem", "createdAt": "2020-10-22T10:54:36Z", "path": "instrumentation/redisson-3.0/src/main/java/io/opentelemetry/javaagent/instrumentation/redisson/RedissonClientTracer.java", "diffHunk": "@@ -24,24 +28,33 @@ protected String getInstrumentationName() {\n   }\n \n   @Override\n-  protected String normalizeQuery(Object args) {\n+  protected String normalizeQuery(Object command) {\n     // get command\n-    if (args instanceof CommandsData) {\n-      List<CommandData<?, ?>> commands = ((CommandsData) args).getCommands();\n+    if (command instanceof CommandsData) {\n+      List<CommandData<?, ?>> commands = ((CommandsData) command).getCommands();\n       StringBuilder commandStrings = new StringBuilder();\n-      for (CommandData commandData : commands) {\n-        commandStrings.append(commandData.getCommand().getName()).append(\";\");\n+      for (CommandData<?, ?> commandData : commands) {\n+        commandStrings.append(normalizeSingleCommand(commandData)).append(\";\");\n       }\n       if (commandStrings.length() > 0) {\n         commandStrings.deleteCharAt(commandStrings.length() - 1);\n       }\n       return commandStrings.toString();\n-    } else if (args instanceof CommandData) {\n-      return ((CommandData) args).getCommand().getName();\n+    } else if (command instanceof CommandData) {\n+      return normalizeSingleCommand((CommandData<?, ?>) command);\n     }\n     return \"Redis Command\";\n   }\n \n+  private static String normalizeSingleCommand(CommandData<?, ?> command) {\n+    List<String> args = new ArrayList<>();\n+    if (command.getCommand().getSubName() != null) {\n+      args.add(command.getCommand().getSubName());\n+    }\n+    args.addAll(Stream.of(command.getParams()).map(String::valueOf).collect(Collectors.toList()));", "originalCommit": "270b7cc11876285f433d04744ece70af6a43c826", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA2MDU0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r512060543", "bodyText": "Done.", "author": "mateuszrzeszutek", "createdAt": "2020-10-26T15:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2NzU3OA=="}], "type": "inlineReview"}, {"oid": "cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894", "message": "Log only command in redis span names", "committedDate": "2020-10-26T15:31:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4MDgzNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r512180834", "bodyText": "can we extract constant for new byte[0][] to avoid allocating each time?", "author": "trask", "createdAt": "2020-10-26T18:30:31Z", "path": "instrumentation/jedis/jedis-1.4/src/main/java/io/opentelemetry/javaagent/instrumentation/jedis/v1_4/JedisInstrumentation.java", "diffHunk": "@@ -47,34 +50,81 @@ public JedisInstrumentation() {\n   @Override\n   public String[] helperClassNames() {\n     return new String[] {\n-      packageName + \".JedisClientTracer\",\n+      packageName + \".JedisClientTracer$CommandWithArgs\", packageName + \".JedisClientTracer\",\n     };\n   }\n \n   @Override\n   public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n-    return singletonMap(\n+    // FIXME: This instrumentation only incorporates sending the command, not processing the result.\n+    Map<ElementMatcher.Junction<MethodDescription>, String> transformers = new HashMap<>();\n+    transformers.put(\n         isMethod()\n             .and(named(\"sendCommand\"))\n+            .and(takesArguments(1))\n             .and(takesArgument(0, named(\"redis.clients.jedis.Protocol$Command\"))),\n-        JedisInstrumentation.class.getName() + \"$JedisAdvice\");\n-    // FIXME: This instrumentation only incorporates sending the command, not processing the result.\n+        JedisInstrumentation.class.getName() + \"$JedisNoArgsAdvice\");\n+    transformers.put(\n+        isMethod()\n+            .and(named(\"sendCommand\"))\n+            .and(takesArguments(2))\n+            .and(takesArgument(0, named(\"redis.clients.jedis.Protocol$Command\")))\n+            .and(takesArgument(1, is(byte[][].class))),\n+        JedisInstrumentation.class.getName() + \"$JedisArgsAdvice\");\n+    return transformers;\n+  }\n+\n+  public static class JedisNoArgsAdvice {\n+\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static void onEnter(\n+        @Advice.This Connection connection,\n+        @Advice.Argument(0) Command command,\n+        @Advice.Local(\"otelSpan\") Span span,\n+        @Advice.Local(\"otelScope\") Scope scope) {\n+      int callDepth = CallDepthThreadLocalMap.incrementCallDepth(Connection.class);\n+      if (callDepth > 0) {\n+        return;\n+      }\n+\n+      span = TRACER.startSpan(connection, new CommandWithArgs(command, new byte[0][]));", "originalCommit": "cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a46d2a21cda879f929f1ba43bb6e5a5487aab666", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a46d2a21cda879f929f1ba43bb6e5a5487aab666", "message": "Apply code review comments", "committedDate": "2020-10-27T10:27:40Z", "type": "forcePushed"}, {"oid": "3d72f77050fe469462210456a4a550dec42e0d25", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3d72f77050fe469462210456a4a550dec42e0d25", "message": "Log normalised full statement in Redis instrumentations (jedis, lettuce, redisson)", "committedDate": "2020-10-27T14:05:53Z", "type": "commit"}, {"oid": "7ce878dc0a3f15cbc47ccd19d244c20986cc6bb7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7ce878dc0a3f15cbc47ccd19d244c20986cc6bb7", "message": "Use List<?> for command args to avoid unnecessary allocation", "committedDate": "2020-10-27T14:05:53Z", "type": "commit"}, {"oid": "895b5ddd84585786311f6ea2ccbe84a3b2a02aa2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/895b5ddd84585786311f6ea2ccbe84a3b2a02aa2", "message": "Log only command in redis span names", "committedDate": "2020-10-27T14:05:53Z", "type": "commit"}, {"oid": "27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "message": "Apply code review comments", "committedDate": "2020-10-27T14:05:53Z", "type": "commit"}, {"oid": "27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "message": "Apply code review comments", "committedDate": "2020-10-27T14:05:53Z", "type": "forcePushed"}]}