{"pr_number": 1270, "pr_title": "Add high level Muzzle docs", "pr_createdAt": "2020-09-27T16:57:29Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNTIxMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495605212", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            on the application classpath. The Muzzle can prevent loading an instrumentation\n          \n          \n            \n            on the application classpath. The Muzzle will prevent loading an instrumentation", "author": "trask", "createdAt": "2020-09-27T19:14:39Z", "path": "buildSrc/muzzle.md", "diffHunk": "@@ -0,0 +1,27 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle can prevent loading an instrumentation", "originalCommit": "434b0d2c03240bd525af615073ae719f185f5045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNTI5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495605295", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            At build time the Muzzle gradle plugin generates matcher for 3rd party APIs used by the agent.\n          \n          \n            \n            At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.", "author": "trask", "createdAt": "2020-09-27T19:15:22Z", "path": "buildSrc/muzzle.md", "diffHunk": "@@ -0,0 +1,27 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle can prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates matcher for 3rd party APIs used by the agent.", "originalCommit": "434b0d2c03240bd525af615073ae719f185f5045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNTM5OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495605399", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            and symbols at the application classpath. Before inspecting the classpath\n          \n          \n            \n            and symbols in the application class loader. Before inspecting the class loader", "author": "trask", "createdAt": "2020-09-27T19:16:20Z", "path": "buildSrc/muzzle.md", "diffHunk": "@@ -0,0 +1,27 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle can prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n+\n+At runtime the Muzzle checks API compatibility between symbols used by the Agent\n+and symbols at the application classpath. Before inspecting the classpath", "originalCommit": "434b0d2c03240bd525af615073ae719f185f5045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "264109fd69c3adea808dc35cdf596b6d30f0b503", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/264109fd69c3adea808dc35cdf596b6d30f0b503", "message": "Review comments\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-28T06:35:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNzM4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495717382", "bodyText": "Is this correct? In this location there is MuzzleGradlePlugin but it more seems like ByteBuddy plugin as it implements bytebuddy plugin interface.", "author": "pavolloffay", "createdAt": "2020-09-28T06:37:48Z", "path": "docs/contributing/muzzle.md", "diffHunk": "@@ -0,0 +1,32 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle will prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n+\n+At runtime the Muzzle checks API compatibility between symbols used by the Agent\n+and symbols in the application class loader. Before inspecting the class loader\n+the Muzzle plugin checks symbols defined in `SomeInstrumentation.typeMatcher()`\n+as a performance optimization. If the symbols do not match the instrumentation\n+is not loaded.\n+\n+## Muzzle gradle plugin\n+\n+The `printReferences` task prints 3rd party API references in a given module.\n+\n+```bash\n+./gradlew :instrumentation:google-http-client-1.19:printReferences\n+```\n+\n+## Muzzle location\n+\n+* `buildSrc` - Muzzle Gradle plugin\n+* `agent-tooling/src/main/java/io/opentelemetry/javaagent/tooling/muzzle` - Muzzle ByteBuddy plugin", "originalCommit": "264109fd69c3adea808dc35cdf596b6d30f0b503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5ODQ3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495998479", "bodyText": "cc) @tylerbenson", "author": "pavolloffay", "createdAt": "2020-09-28T14:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAwNzU5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496007597", "bodyText": "The ByteBuddy plugin is what does the source graph traversal to find all the references for purposes of matching at run time as well as build time in the muzzle task.", "author": "tylerbenson", "createdAt": "2020-09-28T14:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzMjkxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496032916", "bodyText": "Yeah, it's a ByteBuddy plugin. The name's a bit misleading and it should be changed in the future -- though to be honest I don't have any great idea right now.", "author": "mateuszrzeszutek", "createdAt": "2020-09-28T15:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ0NjI2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496446266", "bodyText": "We could rename it to MuzzleByteBuddyPlugin", "author": "pavolloffay", "createdAt": "2020-09-29T06:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5OTQ1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496899457", "bodyText": "I created #1288 for renaming it", "author": "trask", "createdAt": "2020-09-29T17:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNzM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc1NDUyNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495754526", "bodyText": "Do you mean classLoaderMatcher?", "author": "iNikem", "createdAt": "2020-09-28T07:57:55Z", "path": "docs/contributing/muzzle.md", "diffHunk": "@@ -0,0 +1,32 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle will prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n+\n+At runtime the Muzzle checks API compatibility between symbols used by the Agent\n+and symbols in the application class loader. Before inspecting the class loader\n+the Muzzle plugin checks symbols defined in `SomeInstrumentation.typeMatcher()`", "originalCommit": "264109fd69c3adea808dc35cdf596b6d30f0b503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgzOTQxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495839411", "bodyText": "No I meant this \n  \n    \n      opentelemetry-java-instrumentation/instrumentation/google-http-client-1.19/src/main/java/io/opentelemetry/instrumentation/auto/googlehttpclient/GoogleHttpClientInstrumentation.java\n    \n    \n         Line 57\n      in\n      5d2ae07\n    \n    \n    \n    \n\n        \n          \n           return named(\"com.google.api.client.http.HttpRequest\");", "author": "pavolloffay", "createdAt": "2020-09-28T10:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc1NDUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5NjI2NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495996264", "bodyText": "This part of muzzle isn't really documented above.  This plugin is responsible for downloading the range of libraries from Maven Central and verifying expected compatibility.  If a new incompatible version is published, this is what will break the build.", "author": "tylerbenson", "createdAt": "2020-09-28T14:47:24Z", "path": "docs/contributing/muzzle.md", "diffHunk": "@@ -0,0 +1,32 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle will prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n+\n+At runtime the Muzzle checks API compatibility between symbols used by the Agent\n+and symbols in the application class loader. Before inspecting the class loader\n+the Muzzle plugin checks symbols defined in `SomeInstrumentation.typeMatcher()`\n+as a performance optimization. If the symbols do not match the instrumentation\n+is not loaded.\n+\n+## Muzzle gradle plugin\n+\n+The `printReferences` task prints 3rd party API references in a given module.\n+\n+```bash\n+./gradlew :instrumentation:google-http-client-1.19:printReferences\n+```\n+\n+## Muzzle location\n+\n+* `buildSrc` - Muzzle Gradle plugin", "originalCommit": "264109fd69c3adea808dc35cdf596b6d30f0b503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5ODI4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r495998280", "bodyText": "Is there also a task to run it explicitly?", "author": "pavolloffay", "createdAt": "2020-09-28T14:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5NjI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAwNTEwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496005103", "bodyText": "Yeah, this is what actually runs when you call the muzzle task.\nhttps://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/master/.circleci/config.yml#L132\nThat can be called at the top level, or for an individual project.\nAs an optimization, these tasks are only added to gradle if muzzle is explicitly listed as a task, otherwise it slows down the config stage substantially.", "author": "tylerbenson", "createdAt": "2020-09-28T14:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5NjI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzNDk2MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496034961", "bodyText": "It prints all references that are collected & later validated by muzzle -- not only the 3rd party ones.", "author": "mateuszrzeszutek", "createdAt": "2020-09-28T15:21:59Z", "path": "docs/contributing/muzzle.md", "diffHunk": "@@ -0,0 +1,32 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle will prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n+\n+At runtime the Muzzle checks API compatibility between symbols used by the Agent\n+and symbols in the application class loader. Before inspecting the class loader\n+the Muzzle plugin checks symbols defined in `SomeInstrumentation.typeMatcher()`\n+as a performance optimization. If the symbols do not match the instrumentation\n+is not loaded.\n+\n+## Muzzle gradle plugin\n+\n+The `printReferences` task prints 3rd party API references in a given module.", "originalCommit": "264109fd69c3adea808dc35cdf596b6d30f0b503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5NjM0Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496296347", "bodyText": "I'm hoping we can optimize it to only check 3rd party ones", "author": "trask", "createdAt": "2020-09-28T23:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzNDk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ0ODIxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496448213", "bodyText": "ack, changing it to all APIs for now.", "author": "pavolloffay", "createdAt": "2020-09-29T06:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzNDk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzNzUyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496037524", "bodyText": "Muzzle actually collects symbols from advice classes -- values of the map returned by transformers() method. Muzzle by itself calls neither classLoaderMatcher() nor typeMatcher().", "author": "mateuszrzeszutek", "createdAt": "2020-09-28T15:24:11Z", "path": "docs/contributing/muzzle.md", "diffHunk": "@@ -0,0 +1,32 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle will prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n+\n+At runtime the Muzzle checks API compatibility between symbols used by the Agent\n+and symbols in the application class loader. Before inspecting the class loader\n+the Muzzle plugin checks symbols defined in `SomeInstrumentation.typeMatcher()`", "originalCommit": "264109fd69c3adea808dc35cdf596b6d30f0b503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ0ODU3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496448572", "bodyText": "@trask mentioned that muzzle first checks API referenced in typeMatcher() for optimization purposes", "author": "pavolloffay", "createdAt": "2020-09-29T06:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzNzUyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0ODQ2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496048466", "bodyText": "Can you add a sentence explaining where do the symbols come from?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n          \n          \n            \n            The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n          \n          \n            \n            At build time, for each instrumentation the Muzzle ByteBuddy plugin collects symbols referring to both internal and 3rd party APIs used by the currently processed instrumentation. The reference collection process starts from advice classes - values of the map returned by the `Instrumenter.Default#transformers()` method.\n          \n          \n            \n            All those references are then used to create a `ReferenceMatcher` instance.\n          \n          \n            \n            The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.", "author": "mateuszrzeszutek", "createdAt": "2020-09-28T15:39:22Z", "path": "docs/contributing/muzzle.md", "diffHunk": "@@ -0,0 +1,32 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle will prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.", "originalCommit": "264109fd69c3adea808dc35cdf596b6d30f0b503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5MjcxNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496292714", "bodyText": "this is nice, i'm not sure about \"internal\" APIs though, we do currently, but hopefully we won't after #1233?", "author": "trask", "createdAt": "2020-09-28T23:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0ODQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3MTYxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496871617", "bodyText": "Hopefully we'll get rid of at least most of these", "author": "mateuszrzeszutek", "createdAt": "2020-09-29T16:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0ODQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5NjAyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496296027", "bodyText": "another suggestion \ud83d\ude04\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            and symbols in the application class loader. Before inspecting the class loader\n          \n          \n            \n            the Muzzle plugin checks symbols defined in `SomeInstrumentation.typeMatcher()`\n          \n          \n            \n            as a performance optimization. If the symbols do not match the instrumentation\n          \n          \n            \n            is not loaded.\n          \n          \n            \n            and symbols in the application class loader. If the symbols do not match the instrumentation is not loaded.\n          \n          \n            \n            Because the muzzle matcher is expensive, it is only performed after a match has been made by the `classLoaderMatcher()` and `typeMatcher()` matchers.", "author": "trask", "createdAt": "2020-09-28T23:47:57Z", "path": "docs/contributing/muzzle.md", "diffHunk": "@@ -0,0 +1,32 @@\n+# Muzzle\n+\n+Muzzle is a feature of the Java agent that ensures API compatibility\n+between libraries/symbols on the application classpath and APIs of instrumented\n+3rd party libraries used by the Agent. In other words the Muzzle ensures\n+that the API symbols used by the Agent are compatible with API symbols\n+on the application classpath. The Muzzle will prevent loading an instrumentation\n+if the APIs do not match.\n+\n+## How does it work\n+\n+At build time the Muzzle gradle plugin generates a matcher for 3rd party APIs used by the agent.\n+The matcher is stored in the instrumentation class in method `ReferenceMatcher getInstrumentationMuzzle()`.\n+\n+At runtime the Muzzle checks API compatibility between symbols used by the Agent\n+and symbols in the application class loader. Before inspecting the class loader\n+the Muzzle plugin checks symbols defined in `SomeInstrumentation.typeMatcher()`\n+as a performance optimization. If the symbols do not match the instrumentation\n+is not loaded.", "originalCommit": "264109fd69c3adea808dc35cdf596b6d30f0b503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1MDAwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496450003", "bodyText": "+1. The match for classLoaderMatcher() and typeMatcher() is done by ByteBuddy right?", "author": "pavolloffay", "createdAt": "2020-09-29T06:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5NjAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3MzAzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1270#discussion_r496873036", "bodyText": "Yeah, it's done a few steps before the MuzzleMatcher runs.", "author": "mateuszrzeszutek", "createdAt": "2020-09-29T16:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI5NjAyNw=="}], "type": "inlineReview"}, {"oid": "b65bb0d67b48c080652bc3bf21af59ad8785e2b8", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b65bb0d67b48c080652bc3bf21af59ad8785e2b8", "message": "Add high level muzzle docs\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-29T17:23:02Z", "type": "commit"}, {"oid": "9fbb9ca48925c28694c46188f4b159cfdc5cd75b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9fbb9ca48925c28694c46188f4b159cfdc5cd75b", "message": "docs\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-29T17:23:02Z", "type": "commit"}, {"oid": "94e70eee36df1a56a8b650533eb9faac62cae23e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/94e70eee36df1a56a8b650533eb9faac62cae23e", "message": "Review comments\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-29T17:23:02Z", "type": "commit"}, {"oid": "0bdb30b9b4ecd2c1828a3d89d0722f05bc0a63ac", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0bdb30b9b4ecd2c1828a3d89d0722f05bc0a63ac", "message": "Review comments\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-29T17:23:02Z", "type": "commit"}, {"oid": "e531e97fbcafbe339db30ead1ffc45a9d12d9ce1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e531e97fbcafbe339db30ead1ffc45a9d12d9ce1", "message": "style\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-29T17:23:02Z", "type": "commit"}, {"oid": "e531e97fbcafbe339db30ead1ffc45a9d12d9ce1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e531e97fbcafbe339db30ead1ffc45a9d12d9ce1", "message": "style\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>", "committedDate": "2020-09-29T17:23:02Z", "type": "forcePushed"}]}