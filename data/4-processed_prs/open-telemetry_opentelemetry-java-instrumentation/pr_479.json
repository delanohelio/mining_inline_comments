{"pr_number": 479, "pr_title": "Configured trace config to read from env vars/sys props", "pr_createdAt": "2020-06-05T22:43:55Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479", "timeline": [{"oid": "044f2013c59f7be005a782b2209007ecad47a9cf", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/044f2013c59f7be005a782b2209007ecad47a9cf", "message": "Configured trace config to read from env vars/sys props", "committedDate": "2020-06-05T22:38:25Z", "type": "commit"}, {"oid": "46db1554b87877f074d167698d04ec84cf6b5284", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/46db1554b87877f074d167698d04ec84cf6b5284", "message": "Fixed the codenarc violation", "committedDate": "2020-06-06T00:06:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyNjc2OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436226768", "bodyText": "i think the test might pass currently even if sampling is not configured above, because SpanCounter stops counting spans as soon as it hits the targets\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                def spanCounter = new SpanCounter(logfile, [\n          \n          \n            \n                  (HANDLER_SPAN): SPAN_COUNT_TARGET,\n          \n          \n            \n                  (SERVLET_SPAN): SPAN_COUNT_TARGET,\n          \n          \n            \n                ], 10000)\n          \n          \n            \n                // since sampling is enabled, not really expecting to receive NUM_TRIES spans,\n          \n          \n            \n                // instead giving it 10 seconds and then checking below how many spans were received\n          \n          \n            \n                def spanCounter = new SpanCounter(logfile, [\n          \n          \n            \n                  (HANDLER_SPAN): NUM_TRIES,\n          \n          \n            \n                  (SERVLET_SPAN): NUM_TRIES,\n          \n          \n            \n                ], 10000)", "author": "trask", "createdAt": "2020-06-06T01:49:34Z", "path": "smoke-tests/springboot/src/test/groovy/io/opentelemetry/smoketest/SpringBootWithSamplingSmokeTest.groovy", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.opentelemetry.smoketest\n+\n+import okhttp3.Request\n+\n+class SpringBootWithSamplingSmokeTest extends AbstractServerSmokeTest {\n+\n+  static final HANDLER_SPAN = \"LOGGED_SPAN WebController.greeting\"\n+  static final SERVLET_SPAN = \"LOGGED_SPAN /greeting\"\n+  static final double SAMPLER_PROBABILITY = 0.2\n+  static final int NUM_TRIES = 1000\n+  static final int ALLOWED_DEVIATION = 0.1 * NUM_TRIES\n+  static final int SPAN_COUNT_TARGET = (SAMPLER_PROBABILITY + 0.1) * NUM_TRIES\n+\n+\n+  @Override\n+  ProcessBuilder createProcessBuilder() {\n+    String springBootShadowJar = System.getProperty(\"io.opentelemetry.smoketest.springboot.shadowJar.path\")\n+\n+    List<String> command = new ArrayList<>()\n+    command.add(javaPath())\n+    command.addAll(defaultJavaProperties)\n+    command.addAll((String[]) [\"-Dota.exporter.jar=${exporterPath}\", \"-Dota.exporter.logging.prefix=LOGGED_SPAN\", \"-jar\", springBootShadowJar, \"--server.port=${httpPort}\"])\n+    ProcessBuilder processBuilder = new ProcessBuilder(command)\n+    processBuilder.environment().put(\"OTEL_CONFIG_SAMPLER_PROBABILITY\", \"${SAMPLER_PROBABILITY}\")\n+    processBuilder.directory(new File(buildDirectory))\n+  }\n+\n+  def \"default home page with probability sampling enabled\"() {\n+    setup:\n+    def spanCounter = new SpanCounter(logfile, [\n+      (HANDLER_SPAN): SPAN_COUNT_TARGET,\n+      (SERVLET_SPAN): SPAN_COUNT_TARGET,\n+    ], 10000)", "originalCommit": "46db1554b87877f074d167698d04ec84cf6b5284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0Mzk1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436243954", "bodyText": "Yes. This makes sense. Done.", "author": "RashmiRam", "createdAt": "2020-06-06T06:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyNjc2OA=="}], "type": "inlineReview"}, {"oid": "84217356a65b1e67cc685aa42ab517da4b6e8e09", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/84217356a65b1e67cc685aa42ab517da4b6e8e09", "message": "Addressing review comments\n\n1. Updated span count target to num_tries in the test since SpanCounter stops counting spans as soon as it hits the targets", "committedDate": "2020-06-06T06:32:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0OTk4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436249981", "bodyText": "This is now unused?", "author": "iNikem", "createdAt": "2020-06-06T08:15:15Z", "path": "smoke-tests/springboot/src/test/groovy/io/opentelemetry/smoketest/SpringBootWithSamplingSmokeTest.groovy", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.opentelemetry.smoketest\n+\n+import okhttp3.Request\n+\n+class SpringBootWithSamplingSmokeTest extends AbstractServerSmokeTest {\n+\n+  static final HANDLER_SPAN = \"LOGGED_SPAN WebController.greeting\"\n+  static final SERVLET_SPAN = \"LOGGED_SPAN /greeting\"\n+  static final double SAMPLER_PROBABILITY = 0.2\n+  static final int NUM_TRIES = 1000\n+  static final int ALLOWED_DEVIATION = 0.1 * NUM_TRIES\n+  static final int SPAN_COUNT_TARGET = (SAMPLER_PROBABILITY + 0.1) * NUM_TRIES", "originalCommit": "84217356a65b1e67cc685aa42ab517da4b6e8e09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436250202", "bodyText": "I am not sure this is the right place for this code. This method is called installExportersFromJar, does not seem to be related to sampling. I would create a new method, e.g. configure or configureSampler, and call it from installAgentTracer method. Independently of exporter.", "author": "iNikem", "createdAt": "2020-06-06T08:19:36Z", "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/TracerInstaller.java", "diffHunk": "@@ -75,6 +76,14 @@ private static synchronized void installExportersFromJar(final String exporterJa\n               .readEnvironmentVariables()\n               .readSystemProperties()\n               .build();\n+      TraceConfig activeTraceConfig = OpenTelemetrySdk.getTracerProvider().getActiveTraceConfig();", "originalCommit": "84217356a65b1e67cc685aa42ab517da4b6e8e09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQwNDUwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436404503", "bodyText": "good thought, makes sense \ud83d\udc4d", "author": "trask", "createdAt": "2020-06-07T21:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3MDE3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436470172", "bodyText": "Done", "author": "RashmiRam", "createdAt": "2020-06-08T05:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3MjEzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436472135", "bodyText": "Currently configure method is called from installExportersFromJar, which is only called when exporterJar is configured. Does not seem right to me. Call configure from installAgentTracer?", "author": "iNikem", "createdAt": "2020-06-08T06:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3NDE5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436474191", "bodyText": "Sorry. Totally missed it. Running whole tests suite in local takes more time. I am running googleJavaFormat, integration:test and integration:latestDepTest. Is there any selected set of tests that can be run before pushing?", "author": "RashmiRam", "createdAt": "2020-06-08T06:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3NTc4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436475787", "bodyText": "Not really :( I don't think we have a set of \"important\" tests to run when changing such base functionality. Any ideas are very welcomed!", "author": "iNikem", "createdAt": "2020-06-08T06:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3ODM1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436478353", "bodyText": "Ah Yes. Agreed that changes in base functionality requires the full suite to be run and I didn't know what exactly needed to be run before raising a PR. I am more looking for a kind of checklist to be verified before raising a PR. Do you think that is useful or Is it just me?", "author": "RashmiRam", "createdAt": "2020-06-08T06:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ4MTQ0NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/479#discussion_r436481444", "bodyText": "I think it would be mildly useful :) E.g. I don't ever run latestDepTest locally before making PR. googleJavaFormat is certainly needed and then just test your changes with corresponding test task. Not sure if there are any more required steps.", "author": "iNikem", "createdAt": "2020-06-08T06:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1MDIwMg=="}], "type": "inlineReview"}, {"oid": "81dea272b342a220ae0abc276077155d5909dafc", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/81dea272b342a220ae0abc276077155d5909dafc", "message": "Extracted the configure method outside of installExportersFromJar", "committedDate": "2020-06-08T05:53:31Z", "type": "commit"}, {"oid": "bc777ed5ff6f80d2db2f0d6884df9a7985d65147", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bc777ed5ff6f80d2db2f0d6884df9a7985d65147", "message": "Addressing comments", "committedDate": "2020-06-08T06:09:57Z", "type": "commit"}]}