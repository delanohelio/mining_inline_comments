{"pr_number": 1167, "pr_title": "Fix Servlet instrumentation for servlet-api 3.1+ - remove output stream wrapper", "pr_createdAt": "2020-09-03T14:35:10Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1167", "timeline": [{"oid": "e48396ce04e13dd9590863627c1589ab8f05b14c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e48396ce04e13dd9590863627c1589ab8f05b14c", "message": "Fix Servlet instrumentation for servlet-api 3.1+ - remove output stream wrapper", "committedDate": "2020-09-03T15:32:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MzU2NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1167#discussion_r483273564", "bodyText": "allowing 0 indicates that the response was not counted. if it's not counted in the tests I wouldn't expect it to be counted elsewhere.", "author": "FrankSpitulski", "createdAt": "2020-09-03T21:52:08Z", "path": "instrumentation/dropwizard-testing/src/test/groovy/DropwizardTest.groovy", "diffHunk": "@@ -122,7 +122,7 @@ class DropwizardTest extends HttpServerTest<DropwizardTestSupport> {\n         \"${SemanticAttributes.HTTP_USER_AGENT.key()}\" TEST_USER_AGENT\n         \"${SemanticAttributes.HTTP_CLIENT_IP.key()}\" TEST_CLIENT_IP\n         // exception bodies are not yet recorded\n-        \"${SemanticAttributes.HTTP_RESPONSE_CONTENT_LENGTH.key()}\" { it == responseContentLength || /* async */it == null }\n+        \"${SemanticAttributes.HTTP_RESPONSE_CONTENT_LENGTH.key()}\" { it == 0 || it == responseContentLength || /* async */it == null }", "originalCommit": "e48396ce04e13dd9590863627c1589ab8f05b14c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU1ODkwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1167#discussion_r483558907", "bodyText": "Well, it's to be expected that all frameworks that use getOutputStream() will now get a 0.", "author": "mateuszrzeszutek", "createdAt": "2020-09-04T11:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYwMDMxMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1167#discussion_r483600312", "bodyText": "This means it misses spring boot's default configuration which I'd hazard to say is a large portion of applications being instrumented. Is there some alternative implementation or is this attribute just being dropped?", "author": "FrankSpitulski", "createdAt": "2020-09-04T13:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3Mzk4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1167#discussion_r483673988", "bodyText": "There were two:\n\n#1104 contained a separate instrumentation for servlet 3.0 and 3.1; it had lots of copy-pasted code\nIn #1149 I initially tried to just copy the WriteListener class that was absent in 3.0, but that failed. Then I tried to generate a class extending ServletOutputStream in runtime, which probably should work -- but there's no way to load it correctly without modifying Instrumenter.Default heavily.", "author": "mateuszrzeszutek", "createdAt": "2020-09-04T15:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3NDQ4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1167#discussion_r485374487", "bodyText": "@FrankSpitulski We're leaning towards just using content-length header for servlet. The counting approach seems to have too many corner cases for us to deal with well unfortunately \ud83d\ude3f\n@mateuszrzeszutek I don't think we should set 0 if we couldn't count, 0 means no content, not content couldn't be counted - can you update the implementation of getContentLength to avoid setting 0 when printWriter is null?", "author": "anuraaga", "createdAt": "2020-09-09T06:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NjE4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1167#discussion_r485576188", "bodyText": "I've removed all the counting stuff altogether, according to #1167 (comment)", "author": "mateuszrzeszutek", "createdAt": "2020-09-09T12:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3MzU2NA=="}], "type": "inlineReview"}, {"oid": "cd90a0bb7c25ff1a1f3cb92d2480ec4bf1e3e444", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cd90a0bb7c25ff1a1f3cb92d2480ec4bf1e3e444", "message": "Fix Servlet instrumentation for servlet-api 3.1+ - remove output stream wrapper", "committedDate": "2020-09-04T11:24:01Z", "type": "forcePushed"}, {"oid": "9386e201b6529f0ae1e2e20ce746050b521b9ddd", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9386e201b6529f0ae1e2e20ce746050b521b9ddd", "message": "Fix Servlet instrumentation for servlet-api 3.1+ - remove output stream wrapper", "committedDate": "2020-09-04T11:43:04Z", "type": "forcePushed"}, {"oid": "f1b01d9fb924aa8b723557f2ba604401e290209e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f1b01d9fb924aa8b723557f2ba604401e290209e", "message": "Fix Servlet instrumentation for servlet-api 3.1+ - remove output stream wrapper", "committedDate": "2020-09-09T07:10:31Z", "type": "forcePushed"}, {"oid": "5341441b3a943608637d869a7407711541c1eb56", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5341441b3a943608637d869a7407711541c1eb56", "message": "Fix Servlet instrumentation for servlet-api 3.1+ - remove output stream wrapper", "committedDate": "2020-09-09T07:17:42Z", "type": "commit"}, {"oid": "5341441b3a943608637d869a7407711541c1eb56", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5341441b3a943608637d869a7407711541c1eb56", "message": "Fix Servlet instrumentation for servlet-api 3.1+ - remove output stream wrapper", "committedDate": "2020-09-09T07:17:42Z", "type": "forcePushed"}]}