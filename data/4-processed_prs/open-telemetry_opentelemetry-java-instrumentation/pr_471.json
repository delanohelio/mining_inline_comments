{"pr_number": 471, "pr_title": "Fixed Mongo client double tracing bug", "pr_createdAt": "2020-06-03T08:12:21Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471", "timeline": [{"oid": "254de93321b296e5ff269f3210d70f01e03bb9c2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/254de93321b296e5ff269f3210d70f01e03bb9c2", "message": "Fixes #457", "committedDate": "2020-06-03T08:08:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0MzU5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434443591", "bodyText": "Inline this variable", "author": "iNikem", "createdAt": "2020-06-03T09:45:07Z", "path": "instrumentation/mongo/mongo-3.1/src/main/java/io/opentelemetry/auto/instrumentation/mongo/v3_1/MongoClientInstrumentation.java", "diffHunk": "@@ -75,8 +77,16 @@ public MongoClientInstrumentation() {\n   public static class MongoClientAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static void injectTraceListener(@Advice.This final MongoClientOptions.Builder builder) {\n-      builder.addCommandListener(new TracingCommandListener());\n+    public static void injectTraceListener(\n+        @Advice.This final MongoClientOptions.Builder builder,\n+        @Advice.FieldValue(\"commandListeners\") final List<CommandListener> commandListeners) {\n+      for (final CommandListener commandListener : commandListeners) {\n+        if (commandListener instanceof TracingCommandListener) {\n+          return;\n+        }\n+      }\n+      final TracingCommandListener listener = new TracingCommandListener();", "originalCommit": "254de93321b296e5ff269f3210d70f01e03bb9c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NDQ2NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434444464", "bodyText": "I think you don't need where block here. Just use this values/variable directly in setup block", "author": "iNikem", "createdAt": "2020-06-03T09:46:30Z", "path": "instrumentation/mongo/mongo-3.1/src/test/groovy/MongoClientTest.groovy", "diffHunk": "@@ -68,6 +68,27 @@ class MongoClientTest extends MongoBaseTest {\n     collectionName = \"testCollection\"\n   }\n \n+  def \"test create collection with already built ClientSettings\"() {\n+    setup:\n+    def clientOptions = client.mongoClientOptions\n+    def newClientOptions = MongoClientOptions.builder(clientOptions).build()\n+    MongoDatabase db = new MongoClient(new ServerAddress(\"localhost\", port), newClientOptions).getDatabase(dbName)\n+\n+    when:\n+    db.createCollection(collectionName)\n+\n+    then:\n+    assertTraces(1) {\n+      trace(0, 1) {\n+        mongoSpan(it, 0, \"{\\\"create\\\":\\\"$collectionName\\\",\\\"capped\\\":\\\"?\\\"}\")\n+      }\n+    }\n+\n+    where:", "originalCommit": "254de93321b296e5ff269f3210d70f01e03bb9c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwMTE2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434801166", "bodyText": "using the where block like this is consistent with the other tests in this class, so I think it's good", "author": "trask", "createdAt": "2020-06-03T19:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NDQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NTU2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434445562", "bodyText": "I don't quite understand how this test is related to the change in MongoClientAdvice. I would expect that you test e.g. calling build method twice and then check that only one span is created. Do I miss something?", "author": "iNikem", "createdAt": "2020-06-03T09:48:29Z", "path": "instrumentation/mongo/mongo-3.1/src/test/groovy/MongoClientTest.groovy", "diffHunk": "@@ -68,6 +68,27 @@ class MongoClientTest extends MongoBaseTest {\n     collectionName = \"testCollection\"\n   }\n \n+  def \"test create collection with already built ClientSettings\"() {", "originalCommit": "254de93321b296e5ff269f3210d70f01e03bb9c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwMzQ2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434803463", "bodyText": "it's using an existing client.mongoClientOptions (which will already have our CommandListener), so it tests that we don't add it again on top of that", "author": "trask", "createdAt": "2020-06-03T19:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwODY0NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434808644", "bodyText": "Why client.mongoClientOptions will already have a CommandListener? And in any case this then should be documented in test :) I always assume that if some code was confusing to me, it will probably be confusing to somebody else :)", "author": "iNikem", "createdAt": "2020-06-03T19:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk4MzI2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434983260", "bodyText": "\ud83d\udc4d comment here would be great", "author": "trask", "createdAt": "2020-06-04T04:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA4NjE1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r435086153", "bodyText": "Thanks for the comment. I completely agree. Initially, I was also little not sure about readability of this test. I added a comment now. Let me know if that's alright.", "author": "RashmiRam", "createdAt": "2020-06-04T08:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NTU2Mg=="}], "type": "inlineReview"}, {"oid": "c573f1df84b2ca8eb1f8e68867871d46495cc3df", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c573f1df84b2ca8eb1f8e68867871d46495cc3df", "message": "Addressing review comments\n1. Added comments in test\n2. Fixed latestDepTest failures in MongoAsyncClient by adding `declaresField`\n3. Made TracingCommandListener inline in MongoClientAdvice", "committedDate": "2020-06-04T08:31:21Z", "type": "commit"}, {"oid": "0b9f17c10655f70f6f81e9359e6b22c3eddfda8c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0b9f17c10655f70f6f81e9359e6b22c3eddfda8c", "message": "Merge branch 'master' into master", "committedDate": "2020-06-04T14:40:31Z", "type": "commit"}]}