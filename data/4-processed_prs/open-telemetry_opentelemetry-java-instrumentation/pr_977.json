{"pr_number": 977, "pr_title": "Create abstraction for library dependencies for instrumentation.", "pr_createdAt": "2020-08-14T07:07:55Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/977", "timeline": [{"oid": "6e094307ed2238522acaa54ac4e9ef0727ecc9e2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6e094307ed2238522acaa54ac4e9ef0727ecc9e2", "message": "Create abstraction for library dependencies for instrumentation.", "committedDate": "2020-08-14T07:06:02Z", "type": "commit"}, {"oid": "0377e326d40f74b3f05083d5fb443291e0a00861", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0377e326d40f74b3f05083d5fb443291e0a00861", "message": "Migrate more latestdeptest", "committedDate": "2020-08-15T07:25:07Z", "type": "commit"}, {"oid": "23764ec7303a300370f404e71844f53e171c184f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/23764ec7303a300370f404e71844f53e171c184f", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into latestdeptest-abstraction", "committedDate": "2020-08-17T05:00:01Z", "type": "commit"}, {"oid": "a6b588313b6484db1559d14189f72ee23ea37a49", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a6b588313b6484db1559d14189f72ee23ea37a49", "message": "More", "committedDate": "2020-08-17T07:17:20Z", "type": "commit"}, {"oid": "ded466f4f5790cca307631aecadf2a5060a86d5f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ded466f4f5790cca307631aecadf2a5060a86d5f", "message": "More", "committedDate": "2020-08-17T07:23:28Z", "type": "commit"}, {"oid": "c5a69d85deef551caee403d439bbaa796ae5bba5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c5a69d85deef551caee403d439bbaa796ae5bba5", "message": "Progress", "committedDate": "2020-08-17T08:14:07Z", "type": "commit"}, {"oid": "9c1a98f2973ae0dfd24258eaaa2fbeb753c76707", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9c1a98f2973ae0dfd24258eaaa2fbeb753c76707", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into latestdeptest-abstraction", "committedDate": "2020-08-17T08:47:13Z", "type": "commit"}, {"oid": "08b98baf353a842d33d153a1d3411932b838262a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/08b98baf353a842d33d153a1d3411932b838262a", "message": "More", "committedDate": "2020-08-17T08:49:44Z", "type": "commit"}, {"oid": "71c463c0e4ec3f9452a817c0292f7fd49795d667", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/71c463c0e4ec3f9452a817c0292f7fd49795d667", "message": "More", "committedDate": "2020-08-17T09:14:23Z", "type": "commit"}, {"oid": "e979ce60f4e8b9ac407b21e3ab851e4d757aa972", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e979ce60f4e8b9ac407b21e3ab851e4d757aa972", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into latestdeptest-abstraction", "committedDate": "2020-08-18T04:37:03Z", "type": "commit"}, {"oid": "cdfe115c0e88bac4ea87bf34ac74b28952381115", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cdfe115c0e88bac4ea87bf34ac74b28952381115", "message": "More", "committedDate": "2020-08-18T04:59:22Z", "type": "commit"}, {"oid": "efdebbeb3d15b58a5b7a0a71b1656714d20afdfa", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/efdebbeb3d15b58a5b7a0a71b1656714d20afdfa", "message": "Most", "committedDate": "2020-08-18T05:56:58Z", "type": "commit"}, {"oid": "adba99e5bf804b392188f66b8d294d721f8ef878", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/adba99e5bf804b392188f66b8d294d721f8ef878", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into latestdeptest-abstraction", "committedDate": "2020-08-18T05:57:05Z", "type": "commit"}, {"oid": "64d0547c8b4489123bd388e577ef26ea09f5a677", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/64d0547c8b4489123bd388e577ef26ea09f5a677", "message": "More", "committedDate": "2020-08-18T06:04:12Z", "type": "commit"}, {"oid": "dac2746136ac58364af1662513bb3eae00c71019", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/dac2746136ac58364af1662513bb3eae00c71019", "message": "More", "committedDate": "2020-08-18T07:44:16Z", "type": "commit"}, {"oid": "425eed63f504edc5519b11e639bd53082c1651b7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/425eed63f504edc5519b11e639bd53082c1651b7", "message": "Done?", "committedDate": "2020-08-18T08:00:17Z", "type": "commit"}, {"oid": "c172fcf5bf21d6c54bd8456ac1b94b088a70fd2f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c172fcf5bf21d6c54bd8456ac1b94b088a70fd2f", "message": "Drift", "committedDate": "2020-08-18T08:13:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4MDE4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/977#discussion_r472480186", "bodyText": "Does 2.x work also?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   example to restrict to just a major version by specifying `2.x`.\n          \n          \n            \n             *   example to restrict to just a major version by specifying `2.+`.", "author": "trask", "createdAt": "2020-08-18T20:41:10Z", "path": "gradle/instrumentation-common.gradle", "diffHunk": "@@ -0,0 +1,76 @@\n+/** Common setup for manual instrumentation of libraries and auto instrumentation. */\n+\n+\n+/**\n+ * We define three dependency configurations to use when adding dependencies to libraries being\n+ * instrumented.\n+ *\n+ * - library: A dependency on the instrumented library. Results in the dependency being added to\n+ *     compileOnly and testImplementation. If the build is run with -PtestLatestDeps=true, the\n+ *     version when added to testImplementation will be overridden by `+`, the latest version\n+ *     possible. For simple libraries without different behavior between versions, it is possible\n+ *     to have a single dependency on library only.\n+ *\n+ * - testLibrary: A dependency on a library for testing. This will usually be used to either\n+ *     a) use a different version of the library for compilation and testing and b) to add a helper\n+ *     that is only required for tests (e.g., library-testing artifact). The dependency will be\n+ *     added to testImplementation and will have a version of `+` when testing latest deps as\n+ *     described above.\n+ *\n+ * - latestDepTestLibrary: A dependency on a library for testing when testing of latest dependency\n+ *   version is enabled. This dependency will be added as-is to testImplementation, but only if\n+ *   -PtestLatestDeps=true. The version will not be modified but it will be given highest\n+ *   precedence. Use this to restrict the latest version dependency from the default `+`, for\n+ *   example to restrict to just a major version by specifying `2.x`.", "originalCommit": "c172fcf5bf21d6c54bd8456ac1b94b088a70fd2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxNDM5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/977#discussion_r472514392", "bodyText": "Also see more general version of this issue #749", "author": "trask", "createdAt": "2020-08-18T21:52:34Z", "path": "instrumentation/hibernate/hibernate-4.3/hibernate-4.3.gradle", "diffHunk": "@@ -26,13 +19,12 @@ dependencies {\n   testImplementation project(':instrumentation:hibernate:hibernate-3.3')\n   testImplementation project(':instrumentation:hibernate:hibernate-4.0')\n \n-  testImplementation group: 'org.hibernate', name: 'hibernate-core', version: '4.3.0.Final'\n-  testImplementation group: 'org.hibernate', name: 'hibernate-entitymanager', version: '4.3.0.Final'\n+  testLibrary group: 'org.hibernate', name: 'hibernate-entitymanager', version: '4.3.0.Final'\n   testImplementation group: 'org.hsqldb', name: 'hsqldb', version: '2.0.0'\n-  testImplementation group: 'org.springframework.data', name: 'spring-data-jpa', version: '1.5.1.RELEASE'\n+  testLibrary group: 'org.springframework.data', name: 'spring-data-jpa', version: '1.5.1.RELEASE'\n \n-  latestDepTestImplementation group: 'org.hibernate', name: 'hibernate-core', version: '(,6.0.0.Final)'\n-  latestDepTestImplementation group: 'org.hibernate', name: 'hibernate-entitymanager', version: '(,6.0.0.Final)'\n-  latestDepTestImplementation group: 'org.hsqldb', name: 'hsqldb', version: '2.0.0'\n-  latestDepTestImplementation group: 'org.springframework.data', name: 'spring-data-jpa', version: '+'\n+  // TODO(anuraaga): Investigate why these tests don't pass on 5 or 6\n+  // https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/1042", "originalCommit": "c172fcf5bf21d6c54bd8456ac1b94b088a70fd2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxNjk5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/977#discussion_r472516996", "bodyText": "unrelated, but since we're here \ud83d\ude04\nit's not related to requiring different instrumentation (anymore since #152)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              //This seems to be the earliest version that has org.apache.catalina.loader.WebappClassLoaderBase\n          \n          \n            \n              //Older versions would require slightly different instrumentation.\n          \n          \n            \n              // This is the earliest version that has org.apache.catalina.loader.ParallelWebappClassLoader\n          \n          \n            \n              // which is used in the test", "author": "trask", "createdAt": "2020-08-18T21:58:36Z", "path": "instrumentation/java-classloader/tomcat-testing/tomcat-testing.gradle", "diffHunk": "@@ -12,18 +11,10 @@ muzzle {\n   }\n }\n \n-testSets {\n-  latestDepTest {\n-    dirName = 'test'\n-  }\n-}\n-\n dependencies {\n   testImplementation project(':instrumentation:java-classloader')\n \n   //This seems to be the earliest version that has org.apache.catalina.loader.WebappClassLoaderBase\n   //Older versions would require slightly different instrumentation.", "originalCommit": "c172fcf5bf21d6c54bd8456ac1b94b088a70fd2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUyMjU4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/977#discussion_r472522582", "bodyText": "i think?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              testImplementation group: 'org.eclipse.jetty', name: 'jetty-server', version: '7.0.0.v20091005'\n          \n          \n            \n              testImplementation group: 'org.eclipse.jetty', name: 'jetty-servlet', version: '7.0.0.v20091005'\n          \n          \n            \n              testLibrary group: 'org.eclipse.jetty', name: 'jetty-server', version: '7.0.0.v20091005'\n          \n          \n            \n              testLibrary group: 'org.eclipse.jetty', name: 'jetty-servlet', version: '7.0.0.v20091005'", "author": "trask", "createdAt": "2020-08-18T22:12:19Z", "path": "instrumentation/servlet/servlet-common/servlet-common.gradle", "diffHunk": "@@ -22,7 +17,4 @@ dependencies {\n   }\n   testImplementation group: 'org.eclipse.jetty', name: 'jetty-server', version: '7.0.0.v20091005'\n   testImplementation group: 'org.eclipse.jetty', name: 'jetty-servlet', version: '7.0.0.v20091005'", "originalCommit": "c172fcf5bf21d6c54bd8456ac1b94b088a70fd2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2ODQ2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/977#discussion_r472668469", "bodyText": "Oops, no it wasn't - the previous latestDepTest was a ghost, it didn't specify the source set :P #1051", "author": "anuraaga", "createdAt": "2020-08-19T04:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUyMjU4Mg=="}], "type": "inlineReview"}, {"oid": "371fdf8e45fa78acab40cab75a6cd1d8b9ef5fbb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/371fdf8e45fa78acab40cab75a6cd1d8b9ef5fbb", "message": "Apply suggestions from code review\n\nCo-authored-by: Trask Stalnaker <trask.stalnaker@gmail.com>", "committedDate": "2020-08-18T23:12:48Z", "type": "commit"}]}