{"pr_number": 606, "pr_title": "Always translate HTTP status code to Status", "pr_createdAt": "2020-06-29T03:25:08Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606", "timeline": [{"oid": "a7a73bb28673fa80830aaabbc06fbdbcdd998f3e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a7a73bb28673fa80830aaabbc06fbdbcdd998f3e", "message": "Translate HTTP status code to Status", "committedDate": "2020-06-29T03:17:22Z", "type": "commit"}, {"oid": "0870a149d78a94314a71f142f75055736c57a93e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0870a149d78a94314a71f142f75055736c57a93e", "message": "oops", "committedDate": "2020-06-29T04:19:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3MDI0Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446770242", "bodyText": "i think cite the spec instead?\nhttps://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/semantic_conventions/http.md#status", "author": "trask", "createdAt": "2020-06-29T04:48:50Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpUtil.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import io.opentelemetry.trace.Status;\n+\n+final class HttpUtil {\n+\n+  // https://github.com/open-telemetry/opentelemetry-collector/blob/8aa273184455591cad278c92c7cfcf75ad353d57/translator/trace/grpc_http_mapper.go#L55", "originalCommit": "0870a149d78a94314a71f142f75055736c57a93e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3Nzg5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446777892", "bodyText": "Yup good point", "author": "anuraaga", "createdAt": "2020-06-29T05:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3MDI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3MDYyNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446770625", "bodyText": "this isn't in the spec, and i don't think we need to map it, as the way i read https://httpstatuses.com/499 is that nginx just uses this internally (b/c how can it return 499 to the client if the client closes the connection \ud83d\ude04)", "author": "trask", "createdAt": "2020-06-29T04:50:29Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpUtil.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import io.opentelemetry.trace.Status;\n+\n+final class HttpUtil {\n+\n+  // https://github.com/open-telemetry/opentelemetry-collector/blob/8aa273184455591cad278c92c7cfcf75ad353d57/translator/trace/grpc_http_mapper.go#L55\n+  static Status statusFromHttpStatus(int httpStatus) {\n+    if (httpStatus >= 100 && httpStatus < 400) {\n+      return Status.OK;\n+    }\n+\n+    switch (httpStatus) {\n+      case 401:\n+        return Status.UNAUTHENTICATED;\n+      case 403:\n+        return Status.PERMISSION_DENIED;\n+      case 404:\n+        return Status.NOT_FOUND;\n+      case 429:\n+        return Status.RESOURCE_EXHAUSTED;\n+      case 499:\n+        return Status.CANCELLED;", "originalCommit": "0870a149d78a94314a71f142f75055736c57a93e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3ODAyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446778028", "bodyText": "Thanks, will see about updating collector too", "author": "anuraaga", "createdAt": "2020-06-29T05:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3MDYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3ODczMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446778731", "bodyText": "open-telemetry/opentelemetry-collector#1226", "author": "anuraaga", "createdAt": "2020-06-29T05:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3MDYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3ODg5OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446778899", "bodyText": "it might(?) make sense in the collector if nginx is sending spans to it", "author": "trask", "createdAt": "2020-06-29T05:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3MDYyNQ=="}], "type": "inlineReview"}, {"oid": "8de67a001b4e8c47c955828487256b99123cd0be", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8de67a001b4e8c47c955828487256b99123cd0be", "message": "Use spec, not Go", "committedDate": "2020-06-29T05:20:49Z", "type": "commit"}, {"oid": "6db724e3064c7dd3cd8c57478e872406851d1765", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6db724e3064c7dd3cd8c57478e872406851d1765", "message": "400", "committedDate": "2020-06-29T06:14:50Z", "type": "commit"}, {"oid": "1d6d5bfbfb25d0ad85dc9cfbe6f24a99a8d35e54", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1d6d5bfbfb25d0ad85dc9cfbe6f24a99a8d35e54", "message": "JSP", "committedDate": "2020-06-29T06:47:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgxMzc3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446813776", "bodyText": "we should change all errored verifications to status verifications (issue is fine to track this, it's probably lots of places)", "author": "trask", "createdAt": "2020-06-29T07:05:30Z", "path": "instrumentation/jsp-2.3/src/test/groovy/JSPInstrumentationForwardTests.groovy", "diffHunk": "@@ -525,7 +525,7 @@ class JSPInstrumentationForwardTests extends AgentTestRunner {\n           parent()\n           operationName expectedOperationName()\n           spanKind SERVER\n-          errored false\n+          errored true", "originalCommit": "1d6d5bfbfb25d0ad85dc9cfbe6f24a99a8d35e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NTcyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446845721", "bodyText": "Yup - #608", "author": "anuraaga", "createdAt": "2020-06-29T08:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgxMzc3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzMDg5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446830891", "bodyText": "Why don't we set Ok status?", "author": "iNikem", "createdAt": "2020-06-29T07:40:44Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientDecorator.java", "diffHunk": "@@ -120,8 +120,9 @@ public Span onResponse(final Span span, final RESPONSE response) {\n       if (status != null) {\n         span.setAttribute(Tags.HTTP_STATUS, status);\n \n-        if (Config.get().getHttpClientErrorStatuses().get(status)) {\n-          span.setStatus(Status.UNKNOWN);\n+        Status otelStatus = HttpUtil.statusFromHttpStatus(status);\n+        if (!otelStatus.isOk()) {", "originalCommit": "1d6d5bfbfb25d0ad85dc9cfbe6f24a99a8d35e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NDM3NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446844374", "bodyText": "Thought it's not helpful and would just cause extra data to be sent, but indeed this probably isn't the correct layer to worry about it (exporters could strip out OK status if they want)", "author": "anuraaga", "createdAt": "2020-06-29T08:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzMDg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzMTY5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446831697", "bodyText": "Can we call this StatusConverter or StatusFactory or similar? Util just calls to put more methods here :)", "author": "iNikem", "createdAt": "2020-06-29T07:42:28Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpUtil.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import io.opentelemetry.trace.Status;\n+\n+public final class HttpUtil {", "originalCommit": "1d6d5bfbfb25d0ad85dc9cfbe6f24a99a8d35e54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzMzI5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446833291", "bodyText": "getIntegerRangeSettingFromEnvironment is now used and can be removed?", "author": "iNikem", "createdAt": "2020-06-29T07:45:43Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/config/Config.java", "diffHunk": "@@ -173,14 +171,6 @@\n \n     excludedClasses = getListSettingFromEnvironment(TRACE_CLASSES_EXCLUDE, null);\n \n-    httpServerErrorStatuses =\n-        getIntegerRangeSettingFromEnvironment(\n-            HTTP_SERVER_ERROR_STATUSES, DEFAULT_HTTP_SERVER_ERROR_STATUSES);\n-\n-    httpClientErrorStatuses =\n-        getIntegerRangeSettingFromEnvironment(", "originalCommit": "1d6d5bfbfb25d0ad85dc9cfbe6f24a99a8d35e54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NjI3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446846277", "bodyText": "Nice catch lots of code removed", "author": "anuraaga", "createdAt": "2020-06-29T08:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzMzI5MQ=="}], "type": "inlineReview"}, {"oid": "eae3cb907baa9b0d05763da69ce2f8af055de379", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/eae3cb907baa9b0d05763da69ce2f8af055de379", "message": "Cleanup", "committedDate": "2020-06-29T08:52:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg3MzEwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446873107", "bodyText": "missed this?", "author": "iNikem", "createdAt": "2020-06-29T08:55:47Z", "path": "instrumentation/finatra-2.9/src/main/java/io/opentelemetry/auto/instrumentation/finatra/FinatraInstrumentation.java", "diffHunk": "@@ -131,8 +131,9 @@ public void onSuccess(final Response response) {\n       final Span span = spanWithScope.getSpan();\n \n       // Don't use DECORATE.onResponse because this is the controller span\n-      if (Config.get().getHttpServerErrorStatuses().get(DECORATE.status(response))) {\n-        span.setStatus(Status.UNKNOWN);\n+      Status status = HttpStatusConverter.statusFromHttpStatus(DECORATE.status(response));\n+      if (!status.isOk()) {", "originalCommit": "eae3cb907baa9b0d05763da69ce2f8af055de379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg3MzU2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/606#discussion_r446873566", "bodyText": "Second time in same PR ;)", "author": "anuraaga", "createdAt": "2020-06-29T08:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg3MzEwNw=="}], "type": "inlineReview"}, {"oid": "d5e6abc64448a8e5411a16f5c0d392e9b0b126d1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d5e6abc64448a8e5411a16f5c0d392e9b0b126d1", "message": "finatra take two", "committedDate": "2020-06-29T11:18:51Z", "type": "commit"}, {"oid": "d5e6abc64448a8e5411a16f5c0d392e9b0b126d1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d5e6abc64448a8e5411a16f5c0d392e9b0b126d1", "message": "finatra take two", "committedDate": "2020-06-29T11:18:51Z", "type": "forcePushed"}, {"oid": "df78d5253d5467f0769199bc48e02bed64ec3fcb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/df78d5253d5467f0769199bc48e02bed64ec3fcb", "message": "Java 11 rats", "committedDate": "2020-06-29T12:47:52Z", "type": "commit"}, {"oid": "3d567459b88bd893fa50404d4524e6034a45008b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3d567459b88bd893fa50404d4524e6034a45008b", "message": "Right branch", "committedDate": "2020-06-29T13:57:47Z", "type": "commit"}, {"oid": "a09a64275997042f6c2a1668b7397d218b9656a4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a09a64275997042f6c2a1668b7397d218b9656a4", "message": "play", "committedDate": "2020-06-29T14:39:33Z", "type": "commit"}, {"oid": "cc283fa4412372919221eb5ca15c634c49277054", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cc283fa4412372919221eb5ca15c634c49277054", "message": "play", "committedDate": "2020-06-29T15:02:08Z", "type": "commit"}]}