{"pr_number": 1530, "pr_title": "Activate SystemMetrics", "pr_createdAt": "2020-10-30T05:49:24Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530", "timeline": [{"oid": "c1ccf76387f9a703d3de125ceb305cc5d6af6109", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c1ccf76387f9a703d3de125ceb305cc5d6af6109", "message": "#1508 Activate SystemMetrics\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-10-30T05:48:53Z", "type": "commit"}, {"oid": "902ca0760d4a92b21d7542c8becddc56725e3a75", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/902ca0760d4a92b21d7542c8becddc56725e3a75", "message": "refactoring\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-10-30T05:57:29Z", "type": "commit"}, {"oid": "acbbe89a0dcf58180a286dab3970c624ad56cdf3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/acbbe89a0dcf58180a286dab3970c624ad56cdf3", "message": "Merge branch 'master' into activate-system-metrics", "committedDate": "2020-10-30T06:38:17Z", "type": "commit"}, {"oid": "fe1acfbe94b3e317994bc1db98645c3b5bc0aa29", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fe1acfbe94b3e317994bc1db98645c3b5bc0aa29", "message": "fix formatting\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-10-30T07:41:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQxOTM1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530#discussion_r516419350", "bodyText": "since only one Instrumentation class, don't need to break out abstract base class", "author": "trask", "createdAt": "2020-11-03T04:12:00Z", "path": "instrumentation/oshi/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/oshi/AbstractOshiInstrumentation.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.oshi;\n+\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+\n+public abstract class AbstractOshiInstrumentation extends Instrumenter.Default {", "originalCommit": "fe1acfbe94b3e317994bc1db98645c3b5bc0aa29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2MDM2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530#discussion_r517060362", "bodyText": "removed", "author": "malafeev", "createdAt": "2020-11-04T02:15:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQxOTM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQxOTQzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530#discussion_r516419431", "bodyText": "I don't think u need helper class, can call SystemMetrics.registerObservers() directly from here", "author": "trask", "createdAt": "2020-11-03T04:12:29Z", "path": "instrumentation/oshi/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/oshi/OshiInstrumentation.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.oshi;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.isStatic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public class OshiInstrumentation extends AbstractOshiInstrumentation {\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"oshi.SystemInfo\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return named(\"oshi.SystemInfo\");\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod().and(isPublic()).and(isStatic()).and(named(\"getCurrentPlatformEnum\")),\n+        OshiInstrumentation.class.getName() + \"$OshiInstrumentationAdvice\");\n+  }\n+\n+  public static class OshiInstrumentationAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static void onEnter() {\n+      OshiInstrumentationHelper.registerObservers();", "originalCommit": "fe1acfbe94b3e317994bc1db98645c3b5bc0aa29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYwNTM2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530#discussion_r516605363", "bodyText": "removed helper", "author": "malafeev", "createdAt": "2020-11-03T11:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQxOTQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQyMDI4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530#discussion_r516420286", "bodyText": "I'm ok with this approach for now, and we can log an issue to improve this in the future (ideally the agent wouldn't know about the instrumentation), @iNikem @anuraaga?", "author": "trask", "createdAt": "2020-11-03T04:16:53Z", "path": "javaagent/src/main/java/io/opentelemetry/javaagent/OpenTelemetryAgent.java", "diffHunk": "@@ -67,6 +67,17 @@ public static void agentmain(String agentArgs, Instrumentation inst) {\n       System.err.println(\"ERROR \" + thisClass.getName());\n       ex.printStackTrace();\n     }\n+\n+    try {\n+      // Call oshi.SystemInfo.getCurrentPlatformEnum() to activate SystemMetrics.\n+      // Oshi instrumentation will intercept this call and enable SystemMetrics.\n+      Class<?> oshiSystemInfoClass =\n+          ClassLoader.getSystemClassLoader().loadClass(\"oshi.SystemInfo\");\n+      Method getCurrentPlatformEnumMethod = oshiSystemInfoClass.getMethod(\"getCurrentPlatformEnum\");\n+      getCurrentPlatformEnumMethod.invoke(null);\n+    } catch (Throwable ex) {\n+      // OK\n+    }", "originalCommit": "fe1acfbe94b3e317994bc1db98645c3b5bc0aa29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5NjUxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530#discussion_r517796516", "bodyText": "@trask Do we have any gotchas for using system classloader here? It'd be good to understand well if there are cases we don't support right now.\nFollowing up with the classloader callback approach sounds fine though.", "author": "anuraaga", "createdAt": "2020-11-05T05:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQyMDI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2MTQ4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1530#discussion_r518361488", "bodyText": "Added #1565 to track this", "author": "trask", "createdAt": "2020-11-05T21:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQyMDI4Ng=="}], "type": "inlineReview"}, {"oid": "5908597e7eb9cd6c5adf3aa65fc8397783e3cbd3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5908597e7eb9cd6c5adf3aa65fc8397783e3cbd3", "message": "get rid of helper\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-11-03T11:34:00Z", "type": "commit"}, {"oid": "f8d257508ff2a97edff8baa0b3ceacc361229f3f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f8d257508ff2a97edff8baa0b3ceacc361229f3f", "message": "Merge branch 'master' into activate-system-metrics", "committedDate": "2020-11-03T11:34:47Z", "type": "commit"}, {"oid": "b6a570ae331a47f8d7672dff1857cd2cd489b788", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b6a570ae331a47f8d7672dff1857cd2cd489b788", "message": "get rid of AbstractOshiInstrumentation\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-11-04T02:14:57Z", "type": "commit"}]}