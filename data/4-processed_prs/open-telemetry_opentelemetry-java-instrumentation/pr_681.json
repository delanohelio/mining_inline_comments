{"pr_number": 681, "pr_title": "Lettuce and Cassandra migrated from deprecated Decarator to new Tracer", "pr_createdAt": "2020-07-13T13:30:07Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681", "timeline": [{"oid": "fc141e44dde174a4a32be42a962bb4f63550f098", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fc141e44dde174a4a32be42a962bb4f63550f098", "message": "Lettuce and Cassandra migrated from deprecated Decarator to new Tracer", "committedDate": "2020-07-13T13:23:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc4NDA2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453784060", "bodyText": "swap arg order to match startSpan(String, CONNECTION, String)?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Span startSpan(CONNECTION connection, QUERY query, String originType) {\n          \n          \n            \n              public Span startSpan(QUERY query, CONNECTION connection, String originType) {", "author": "trask", "createdAt": "2020-07-13T16:41:54Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/DatabaseClientTracer.java", "diffHunk": "@@ -40,37 +47,60 @@ public DatabaseClientTracer() {\n     tracer = OpenTelemetry.getTracerProvider().get(getInstrumentationName(), getVersion());\n   }\n \n-  // TODO make abstract when implemented in all subclasses\n-  protected String getInstrumentationName() {\n-    return null;\n-  }\n-\n-  private String getVersion() {\n-    return null;\n-  }\n-\n-  public Scope withSpan(Span span) {\n-    return tracer.withSpan(span);\n-  }\n-\n   public Span startSpan(CONNECTION connection, QUERY query, String originType) {", "originalCommit": "fc141e44dde174a4a32be42a962bb4f63550f098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyNTg5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453825892", "bodyText": "alas, no :( Some subclasses use String as QUERY and they will have 2 methods with same signature.", "author": "iNikem", "createdAt": "2020-07-13T17:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc4NDA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NTMwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453795309", "bodyText": "remove?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                //    final String spanName = command == null ? \"Redis Command\" : command.getType().name();", "author": "trask", "createdAt": "2020-07-13T17:00:35Z", "path": "instrumentation/lettuce/lettuce-4.0/src/main/java/io/opentelemetry/auto/instrumentation/lettuce/v4_0/InstrumentationPoints.java", "diffHunk": "@@ -38,11 +36,9 @@\n   private static final Set<CommandType> NON_INSTRUMENTING_COMMANDS = EnumSet.of(SHUTDOWN, DEBUG);\n \n   public static SpanWithScope beforeCommand(final RedisCommand<?, ?, ?> command) {\n-    final String spanName = command == null ? \"Redis Command\" : command.getType().name();\n-    final Span span =\n-        LettuceClientDecorator.TRACER.spanBuilder(spanName).setSpanKind(CLIENT).startSpan();\n-    LettuceClientDecorator.DECORATE.afterStart(span);\n-    return new SpanWithScope(span, currentContextWith(span));\n+    //    final String spanName = command == null ? \"Redis Command\" : command.getType().name();", "originalCommit": "fc141e44dde174a4a32be42a962bb4f63550f098", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NjA2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453796066", "bodyText": "can be pulled up into outer, e.g. if / else if / else", "author": "trask", "createdAt": "2020-07-13T17:01:47Z", "path": "instrumentation/lettuce/lettuce-4.0/src/main/java/io/opentelemetry/auto/instrumentation/lettuce/v4_0/InstrumentationPoints.java", "diffHunk": "@@ -52,45 +48,41 @@ public static void afterCommand(\n       final AsyncCommand<?, ?, ?> asyncCommand) {\n     final Span span = spanWithScope.getSpan();\n     if (throwable != null) {\n-      LettuceClientDecorator.DECORATE.onError(span, throwable);\n-      LettuceClientDecorator.DECORATE.beforeFinish(span);\n-      span.end();\n+      LettuceDatabaseClientTracer.TRACER.endExceptionally(span, throwable);\n     } else if (expectsResponse(command)) {\n       asyncCommand.handleAsync(\n           (value, ex) -> {\n-            if (ex instanceof CancellationException) {\n-              span.setAttribute(\"db.command.cancelled\", true);\n+            if (ex == null) {\n+              LettuceDatabaseClientTracer.TRACER.end(span);\n             } else {\n-              LettuceClientDecorator.DECORATE.onError(span, ex);\n+              if (ex instanceof CancellationException) {\n+                span.setAttribute(\"db.command.cancelled\", true);\n+                LettuceDatabaseClientTracer.TRACER.end(span);\n+              } else {\n+                LettuceDatabaseClientTracer.TRACER.endExceptionally(span, ex);\n+              }", "originalCommit": "fc141e44dde174a4a32be42a962bb4f63550f098", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDE5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453814192", "bodyText": "conditional not needed(?)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (scope != null) {\n          \n          \n            \n                  scope.close();\n          \n          \n            \n                }\n          \n          \n            \n                scope.close();", "author": "trask", "createdAt": "2020-07-13T17:32:01Z", "path": "instrumentation/lettuce/lettuce-5.0/src/main/java/io/opentelemetry/auto/instrumentation/lettuce/v5_0/ConnectionFutureAdvice.java", "diffHunk": "@@ -16,41 +16,39 @@\n \n package io.opentelemetry.auto.instrumentation.lettuce.v5_0;\n \n-import static io.opentelemetry.trace.Span.Kind.CLIENT;\n-import static io.opentelemetry.trace.TracingContextUtils.currentContextWith;\n+import static io.opentelemetry.auto.instrumentation.lettuce.v5_0.LettuceDatabaseClientTracer.TRACER;\n \n import io.lettuce.core.ConnectionFuture;\n import io.lettuce.core.RedisURI;\n-import io.opentelemetry.auto.instrumentation.api.SpanWithScope;\n+import io.opentelemetry.context.Scope;\n import io.opentelemetry.trace.Span;\n import net.bytebuddy.asm.Advice;\n \n public class ConnectionFutureAdvice {\n \n   @Advice.OnMethodEnter(suppress = Throwable.class)\n-  public static SpanWithScope onEnter(@Advice.Argument(1) final RedisURI redisURI) {\n-    final Span span =\n-        LettuceClientDecorator.TRACER.spanBuilder(\"CONNECT\").setSpanKind(CLIENT).startSpan();\n-    LettuceClientDecorator.DECORATE.afterStart(span);\n-    LettuceClientDecorator.DECORATE.onConnection(span, redisURI);\n-    return new SpanWithScope(span, currentContextWith(span));\n+  public static void onEnter(\n+      @Advice.Argument(1) final RedisURI redisURI,\n+      @Advice.Local(\"otelSpan\") Span span,\n+      @Advice.Local(\"otelScope\") Scope scope) {\n+    span = TRACER.startSpan(\"CONNECT\", redisURI, null);\n+    scope = TRACER.startScope(span);\n   }\n \n   @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n   public static void stopSpan(\n-      @Advice.Enter final SpanWithScope spanWithScope,\n       @Advice.Thrown final Throwable throwable,\n-      @Advice.Return final ConnectionFuture<?> connectionFuture) {\n-    final Span span = spanWithScope.getSpan();\n+      @Advice.Return final ConnectionFuture<?> connectionFuture,\n+      @Advice.Local(\"otelSpan\") Span span,\n+      @Advice.Local(\"otelScope\") Scope scope) {\n+    if (scope != null) {\n+      scope.close();\n+    }", "originalCommit": "fc141e44dde174a4a32be42a962bb4f63550f098", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyNTU2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453825567", "bodyText": "I used the same pattern as we have in HttpServerTracer. And the same pattern will be used later in HttpClientTracer. But I can remove it here.", "author": "iNikem", "createdAt": "2020-07-13T17:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MjgzOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453842839", "bodyText": "i think remove, otherwise the reader wonders the question when can scope be null", "author": "trask", "createdAt": "2020-07-13T18:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDM1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453814356", "bodyText": "conditional not needed(?)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (scope != null) {\n          \n          \n            \n                  scope.close();\n          \n          \n            \n                }\n          \n          \n            \n                scope.close();", "author": "trask", "createdAt": "2020-07-13T17:32:17Z", "path": "instrumentation/lettuce/lettuce-5.0/src/main/java/io/opentelemetry/auto/instrumentation/lettuce/v5_0/LettuceAsyncCommandsAdvice.java", "diffHunk": "@@ -16,55 +16,48 @@\n \n package io.opentelemetry.auto.instrumentation.lettuce.v5_0;\n \n+import static io.opentelemetry.auto.instrumentation.lettuce.v5_0.LettuceDatabaseClientTracer.TRACER;\n import static io.opentelemetry.auto.instrumentation.lettuce.v5_0.LettuceInstrumentationUtil.expectsResponse;\n-import static io.opentelemetry.trace.Span.Kind.CLIENT;\n-import static io.opentelemetry.trace.TracingContextUtils.currentContextWith;\n \n import io.lettuce.core.protocol.AsyncCommand;\n import io.lettuce.core.protocol.RedisCommand;\n-import io.opentelemetry.auto.instrumentation.api.SpanWithScope;\n+import io.opentelemetry.context.Scope;\n import io.opentelemetry.trace.Span;\n import net.bytebuddy.asm.Advice;\n \n public class LettuceAsyncCommandsAdvice {\n \n   @Advice.OnMethodEnter(suppress = Throwable.class)\n-  public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand command) {\n+  public static void onEnter(\n+      @Advice.Argument(0) final RedisCommand<?, ?, ?> command,\n+      @Advice.Local(\"otelSpan\") Span span,\n+      @Advice.Local(\"otelScope\") Scope scope) {\n \n-    final Span span =\n-        LettuceClientDecorator.TRACER\n-            .spanBuilder(LettuceInstrumentationUtil.getCommandName(command))\n-            .setSpanKind(CLIENT)\n-            .startSpan();\n-    LettuceClientDecorator.DECORATE.afterStart(span);\n-\n-    return new SpanWithScope(span, currentContextWith(span));\n+    span = TRACER.startSpan(null, command, null);\n+    scope = TRACER.startScope(span);\n   }\n \n   @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n   public static void stopSpan(\n-      @Advice.Argument(0) final RedisCommand command,\n-      @Advice.Enter final SpanWithScope spanWithScope,\n+      @Advice.Argument(0) final RedisCommand<?, ?, ?> command,\n       @Advice.Thrown final Throwable throwable,\n-      @Advice.Return final AsyncCommand<?, ?, ?> asyncCommand) {\n+      @Advice.Return final AsyncCommand<?, ?, ?> asyncCommand,\n+      @Advice.Local(\"otelSpan\") Span span,\n+      @Advice.Local(\"otelScope\") Scope scope) {\n+    if (scope != null) {\n+      scope.close();\n+    }", "originalCommit": "fc141e44dde174a4a32be42a962bb4f63550f098", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNjAyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r453816022", "bodyText": "nice catch on this duplicatation", "author": "trask", "createdAt": "2020-07-13T17:35:15Z", "path": "instrumentation/lettuce/lettuce-5.0/src/main/java/io/opentelemetry/auto/instrumentation/lettuce/v5_0/rx/LettuceFluxTerminationRunnable.java", "diffHunk": "@@ -74,25 +73,18 @@ public void accept(final Signal signal) {\n \n   @Override\n   public void run() {\n-    if (span != null) {\n-      finishSpan(true, null);\n-    } else {\n-      LoggerFactory.getLogger(Flux.class)\n-          .error(\n-              \"Failed to finish this.span to indicate cancellation, LettuceFluxTerminationRunnable\"\n-                  + \" cannot find this.span because it probably wasn't started.\");", "originalCommit": "fc141e44dde174a4a32be42a962bb4f63550f098", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "faebddc59b15e7fe40fc26cd4757aa3b88a95649", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/faebddc59b15e7fe40fc26cd4757aa3b88a95649", "message": "Polish", "committedDate": "2020-07-13T18:07:38Z", "type": "commit"}, {"oid": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4cff94bf69b980eae3bf76a403c047cdd4b01910", "message": "Polish", "committedDate": "2020-07-13T18:29:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyNzc3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454027777", "bodyText": "Shouldn't spanName(query) be called in the overload that accepts a query, not here?", "author": "anuraaga", "createdAt": "2020-07-14T00:36:34Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/DatabaseClientTracer.java", "diffHunk": "@@ -40,37 +47,60 @@ public DatabaseClientTracer() {\n     tracer = OpenTelemetry.getTracerProvider().get(getInstrumentationName(), getVersion());\n   }\n \n-  // TODO make abstract when implemented in all subclasses\n-  protected String getInstrumentationName() {\n-    return null;\n-  }\n-\n-  private String getVersion() {\n-    return null;\n-  }\n-\n-  public Scope withSpan(Span span) {\n-    return tracer.withSpan(span);\n-  }\n-\n   public Span startSpan(CONNECTION connection, QUERY query, String originType) {\n     String normalizedQuery = normalizeQuery(query);\n \n+    return startSpan(normalizedQuery, connection, originType);\n+  }\n+\n+  public Span startSpan(String spanName, CONNECTION connection, String originType) {\n     final Span span =\n         tracer\n-            .spanBuilder(spanName(normalizedQuery))\n+            .spanBuilder(spanName(spanName))", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NjMzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454256333", "bodyText": "Fixed", "author": "iNikem", "createdAt": "2020-07-14T10:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyNzc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyNzgyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454027829", "bodyText": "Shouldn't onStatement only be called in the overload that accepts a query, onStatement(span, normalizedQuery)?", "author": "anuraaga", "createdAt": "2020-07-14T00:36:47Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/DatabaseClientTracer.java", "diffHunk": "@@ -40,37 +47,60 @@ public DatabaseClientTracer() {\n     tracer = OpenTelemetry.getTracerProvider().get(getInstrumentationName(), getVersion());\n   }\n \n-  // TODO make abstract when implemented in all subclasses\n-  protected String getInstrumentationName() {\n-    return null;\n-  }\n-\n-  private String getVersion() {\n-    return null;\n-  }\n-\n-  public Scope withSpan(Span span) {\n-    return tracer.withSpan(span);\n-  }\n-\n   public Span startSpan(CONNECTION connection, QUERY query, String originType) {\n     String normalizedQuery = normalizeQuery(query);\n \n+    return startSpan(normalizedQuery, connection, originType);\n+  }\n+\n+  public Span startSpan(String spanName, CONNECTION connection, String originType) {\n     final Span span =\n         tracer\n-            .spanBuilder(spanName(normalizedQuery))\n+            .spanBuilder(spanName(spanName))\n             .setSpanKind(CLIENT)\n             .setAttribute(SemanticAttributes.DB_TYPE.key(), dbType())\n             .setAttribute(\"span.origin.type\", originType)\n             .startSpan();\n \n-    onConnection(span, connection);\n-    onPeerConnection(span, connection);\n-    onStatement(span, normalizedQuery);\n+    if (connection != null) {\n+      onConnection(span, connection);\n+      onPeerConnection(span, connection);\n+    }\n+    onStatement(span, spanName);", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5NzkwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454097909", "bodyText": "Hm, I will take a look...", "author": "iNikem", "createdAt": "2020-07-14T04:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyNzgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NjQ4NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454256484", "bodyText": "Thanks, @anuraaga , for spotting this bug.", "author": "iNikem", "createdAt": "2020-07-14T10:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyNzgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyODIxNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454028215", "bodyText": "Just a note not necessarily this PR but I was confused by having both onConnection and onPeerConnection, I think a connection always has a peer. Based on the javadoc, maybe it's onConnectionAttempt and onConnectionComplete but not quite sure", "author": "anuraaga", "createdAt": "2020-07-14T00:37:57Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/DatabaseClientTracer.java", "diffHunk": "@@ -87,17 +117,14 @@ protected Span afterStart(final Span span) {\n   }\n \n   /** This should be called when the connection is being used, not when it's created. */\n-  public Span onConnection(final Span span, final CONNECTION connection) {\n-    assert span != null;\n-    if (connection != null) {\n-      span.setAttribute(SemanticAttributes.DB_USER.key(), dbUser(connection));\n-      span.setAttribute(SemanticAttributes.DB_INSTANCE.key(), dbInstance(connection));\n-      span.setAttribute(SemanticAttributes.DB_URL.key(), dbUrl(connection));\n-    }\n+  protected Span onConnection(final Span span, final CONNECTION connection) {", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5ODA3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454098070", "bodyText": "I am always confused by that as well. There will be a round of cleanup of all new tracers, when all/majority of instrumentations are migrated.", "author": "iNikem", "createdAt": "2020-07-14T04:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyODIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyOTU3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454029570", "bodyText": "Filed #688 since seems important", "author": "anuraaga", "createdAt": "2020-07-14T00:42:17Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -84,6 +80,57 @@ public Span startSpan(\n     return span;\n   }\n \n+  /**\n+   * Creates new scoped context with the given span.\n+   *\n+   * <p>Attaches new context to the request to avoid creating duplicate server spans.\n+   */\n+  public Scope startScope(Span span, STORAGE storage) {\n+    // TODO we could do this in one go, but TracingContextUtils.CONTEXT_SPAN_KEY is private\n+    Context serverSpanContext = Context.current().withValue(CONTEXT_SERVER_SPAN_KEY, span);\n+    Context newContext = withSpan(span, serverSpanContext);\n+    attachServerContext(newContext, storage);\n+    return withScopedContext(newContext);\n+  }\n+\n+  // TODO should end methods remove SPAN attribute from request as well?\n+  public void end(Span span, int responseStatus) {\n+    setStatus(span, responseStatus);\n+    span.end();\n+  }\n+\n+  /** Ends given span exceptionally with default response status code 500. */\n+  public void endExceptionally(Span span, Throwable throwable) {\n+    endExceptionally(span, throwable, 500);\n+  }\n+\n+  public void endExceptionally(Span span, Throwable throwable, int responseStatus) {\n+    if (responseStatus == 200) {\n+      // TODO I think this is wrong.", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMDYxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454030616", "bodyText": "I think we can be setting null here which is surprising, but same as previous code", "author": "anuraaga", "createdAt": "2020-07-14T00:45:38Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/DatabaseClientTracer.java", "diffHunk": "@@ -40,37 +47,60 @@ public DatabaseClientTracer() {\n     tracer = OpenTelemetry.getTracerProvider().get(getInstrumentationName(), getVersion());\n   }\n \n-  // TODO make abstract when implemented in all subclasses\n-  protected String getInstrumentationName() {\n-    return null;\n-  }\n-\n-  private String getVersion() {\n-    return null;\n-  }\n-\n-  public Scope withSpan(Span span) {\n-    return tracer.withSpan(span);\n-  }\n-\n   public Span startSpan(CONNECTION connection, QUERY query, String originType) {\n     String normalizedQuery = normalizeQuery(query);\n \n+    return startSpan(normalizedQuery, connection, originType);\n+  }\n+\n+  public Span startSpan(String spanName, CONNECTION connection, String originType) {\n     final Span span =\n         tracer\n-            .spanBuilder(spanName(normalizedQuery))\n+            .spanBuilder(spanName(spanName))\n             .setSpanKind(CLIENT)\n             .setAttribute(SemanticAttributes.DB_TYPE.key(), dbType())\n             .setAttribute(\"span.origin.type\", originType)", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5ODI0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454098243", "bodyText": "Setting null will remove attribute, so no harm done. But I really dislike this attribute :)", "author": "iNikem", "createdAt": "2020-07-14T04:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMDYxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5OTA3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454099076", "bodyText": "I will open an issue to discuss/remove span.origin.type \ud83d\udc4d", "author": "trask", "createdAt": "2020-07-14T04:52:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMDYxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwOTI1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454109254", "bodyText": "For me this is part of #602", "author": "iNikem", "createdAt": "2020-07-14T05:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMDYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMTMzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454031330", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final Span span = LettuceDatabaseClientTracer.TRACER.startSpan(null, command, null);\n          \n          \n            \n                final Span span = LettuceDatabaseClientTracer.TRACER.startSpan(/* connection= */ null, command, /* originType= */ null);", "author": "anuraaga", "createdAt": "2020-07-14T00:47:58Z", "path": "instrumentation/lettuce/lettuce-4.0/src/main/java/io/opentelemetry/auto/instrumentation/lettuce/v4_0/InstrumentationPoints.java", "diffHunk": "@@ -38,11 +36,8 @@\n   private static final Set<CommandType> NON_INSTRUMENTING_COMMANDS = EnumSet.of(SHUTDOWN, DEBUG);\n \n   public static SpanWithScope beforeCommand(final RedisCommand<?, ?, ?> command) {\n-    final String spanName = command == null ? \"Redis Command\" : command.getType().name();\n-    final Span span =\n-        LettuceClientDecorator.TRACER.spanBuilder(spanName).setSpanKind(CLIENT).startSpan();\n-    LettuceClientDecorator.DECORATE.afterStart(span);\n-    return new SpanWithScope(span, currentContextWith(span));\n+    final Span span = LettuceDatabaseClientTracer.TRACER.startSpan(null, command, null);", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMjUyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454032522", "bodyText": "So many optional parameters does make this API a bit suspicious - would be good to confirm we got the right abstraction here. I sort of wonder if it's possible for the instrumentation tracer to define the API expected for the instrumentation rather than leaking the base class API over here.", "author": "anuraaga", "createdAt": "2020-07-14T00:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5ODg3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454098877", "bodyText": "Partly you are correct and I want to remove that originType as soon as I understand WTH is this.\nPartly Lettuce instrumentations are somewhat special in that they have connection info only in some places and not another. Otherwise I still think that startSpan(Connection, Query) is a good API.", "author": "iNikem", "createdAt": "2020-07-14T04:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNTA2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454335063", "bodyText": "Makes sense. Still recommend the \"param docs\" to make this a but clearer.", "author": "anuraaga", "createdAt": "2020-07-14T12:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMTMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMTUwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454031509", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final Span span = TRACER.startSpan(session, query, null);\n          \n          \n            \n                final Span span = TRACER.startSpan(session, query, /* originType= */ null);\n          \n      \n    \n    \n  \n\nThough using null origin seems to be a pattern, maybe can have an overload", "author": "anuraaga", "createdAt": "2020-07-14T00:48:30Z", "path": "instrumentation/cassandra/cassandra-4.0/src/main/java/io/opentelemetry/auto/instrumentation/cassandra/v4_0/TracingCqlSession.java", "diffHunk": "@@ -232,36 +224,36 @@ public ResultSet execute(@NonNull String query) {\n   @NonNull\n   public CompletionStage<AsyncResultSet> executeAsync(@NonNull Statement<?> statement) {\n     final String query = getQuery(statement);\n-    final Span span = startSpan(query);\n \n-    try (final Scope scope = currentContextWith(span)) {\n+    final Span span = TRACER.startSpan(session, query, null);", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1Njk1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454256954", "bodyText": "Let it leave be for a moment and we will address it in #689", "author": "iNikem", "createdAt": "2020-07-14T10:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMTUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMzUxNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454033515", "bodyText": "I think we do need to solve @trask's suggestion, probably by having methods with different names. It's super-confusing to see methods used in the same file with different ordering, looked like a bug at first.", "author": "anuraaga", "createdAt": "2020-07-14T00:54:19Z", "path": "instrumentation/lettuce/lettuce-4.0/src/main/java/io/opentelemetry/auto/instrumentation/lettuce/v4_0/InstrumentationPoints.java", "diffHunk": "@@ -52,45 +47,39 @@ public static void afterCommand(\n       final AsyncCommand<?, ?, ?> asyncCommand) {\n     final Span span = spanWithScope.getSpan();\n     if (throwable != null) {\n-      LettuceClientDecorator.DECORATE.onError(span, throwable);\n-      LettuceClientDecorator.DECORATE.beforeFinish(span);\n-      span.end();\n+      LettuceDatabaseClientTracer.TRACER.endExceptionally(span, throwable);\n     } else if (expectsResponse(command)) {\n       asyncCommand.handleAsync(\n           (value, ex) -> {\n-            if (ex instanceof CancellationException) {\n+            if (ex == null) {\n+              LettuceDatabaseClientTracer.TRACER.end(span);\n+            } else if (ex instanceof CancellationException) {\n               span.setAttribute(\"db.command.cancelled\", true);\n+              LettuceDatabaseClientTracer.TRACER.end(span);\n             } else {\n-              LettuceClientDecorator.DECORATE.onError(span, ex);\n+              LettuceDatabaseClientTracer.TRACER.endExceptionally(span, ex);\n             }\n-            LettuceClientDecorator.DECORATE.beforeFinish(span);\n-            span.end();\n             return null;\n           });\n     } else {\n       // No response is expected, so we must finish the span now.\n-      LettuceClientDecorator.DECORATE.beforeFinish(span);\n-      span.end();\n+      LettuceDatabaseClientTracer.TRACER.end(span);\n     }\n     spanWithScope.closeScope();\n-    // span may be finished by handleAsync call above.\n   }\n \n   public static SpanWithScope beforeConnect(final RedisURI redisURI) {\n-    final Span span =\n-        LettuceClientDecorator.TRACER.spanBuilder(\"CONNECT\").setSpanKind(CLIENT).startSpan();\n-    LettuceClientDecorator.DECORATE.afterStart(span);\n-    LettuceClientDecorator.DECORATE.onConnection(span, redisURI);\n-    return new SpanWithScope(span, currentContextWith(span));\n+    final Span span = LettuceDatabaseClientTracer.TRACER.startSpan(\"CONNECT\", redisURI, null);", "originalCommit": "4cff94bf69b980eae3bf76a403c047cdd4b01910", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5OTIzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454099231", "bodyText": "Agreed this is bad. But this IS startSpan method... I will take another look if I can improve it somehow...", "author": "iNikem", "createdAt": "2020-07-14T04:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExMTAxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454111016", "bodyText": "This is Java, so I think it's pretty idiomatic when running into issues with overloads, instead of reordering arguments, to use with, e.g., startSpanWithQuery / startSpanWithName. If we expect one of these to be the vast majority, than that one can be shortened to startSpan. What do you think?", "author": "anuraaga", "createdAt": "2020-07-14T05:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NTg3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454255877", "bodyText": "I have reworked this a little, PTAL.", "author": "iNikem", "createdAt": "2020-07-14T10:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAzMzUxNQ=="}], "type": "inlineReview"}, {"oid": "cffcfc4c0caab1b51e33d7e85683d41b011ceff8", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cffcfc4c0caab1b51e33d7e85683d41b011ceff8", "message": "Split a connection specific handling out of Lettuce database client tracers.\n\nThis eliminates the need of awkward method override in the common DatabaseClientTracer.", "committedDate": "2020-07-14T10:22:24Z", "type": "commit"}, {"oid": "57fdb7456cd251f72eaec2bca6fa7bd0a15fbd4b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/57fdb7456cd251f72eaec2bca6fa7bd0a15fbd4b", "message": "Muzzle fix", "committedDate": "2020-07-14T11:17:02Z", "type": "commit"}, {"oid": "c1be7f17456eff82d150f468e5ec113c9eb0c6d5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c1be7f17456eff82d150f468e5ec113c9eb0c6d5", "message": "Format", "committedDate": "2020-07-14T11:41:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNTQ3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/681#discussion_r454335470", "bodyText": "Believe we don't want to add this to prevent conflict with other PR which will delete it right away", "author": "anuraaga", "createdAt": "2020-07-14T12:56:37Z", "path": "instrumentation/cassandra/cassandra-3.0/src/main/java/io/opentelemetry/auto/instrumentation/cassandra/v3_0/TracingSession.java", "diffHunk": "@@ -81,78 +76,79 @@ public Session apply(final Session session) {\n   }\n \n   @Override\n-  public ResultSet execute(final String query) {\n-    final Span span = startSpan(query);\n-    try (final Scope scope = currentContextWith(span)) {\n+  @NonNull", "originalCommit": "c1be7f17456eff82d150f468e5ec113c9eb0c6d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}