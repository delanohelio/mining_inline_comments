{"pr_number": 1836, "pr_title": "Use Context more in DatabaseClientTracer", "pr_createdAt": "2020-12-05T19:19:51Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836", "timeline": [{"oid": "050b702fcf07dc2090c60f17a43af0a0650e00d5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/050b702fcf07dc2090c60f17a43af0a0650e00d5", "message": "Use Context more in DatabaseClientTracer", "committedDate": "2020-12-05T19:17:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5MDQyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#discussion_r537190423", "bodyText": "We're really lucky that default interface methods work fine, heh", "author": "anuraaga", "createdAt": "2020-12-07T02:33:04Z", "path": "instrumentation/elasticsearch/elasticsearch-transport-5.3/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/elasticsearch/transport/v5_3/Elasticsearch53TransportClientInstrumentationModule.java", "diffHunk": "@@ -67,27 +68,27 @@ public Elasticsearch53TransportClientInstrumentationModule() {\n     public static void onEnter(\n         @Advice.Argument(0) Action action,\n         @Advice.Argument(1) ActionRequest actionRequest,\n-        @Advice.Local(\"otelSpan\") Span span,\n+        @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope,\n         @Advice.Argument(value = 2, readOnly = false)\n             ActionListener<ActionResponse> actionListener) {\n \n-      span = tracer().startSpan(null, action);\n-      scope = tracer().startScope(span);\n+      context = tracer().startSpan(currentContext(), null, action);\n+      scope = context.makeCurrent();", "originalCommit": "050b702fcf07dc2090c60f17a43af0a0650e00d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NzIyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#discussion_r537267227", "bodyText": "In some places above you use Context.current() directly. What are the rules? How to choose when to use which? Are they written in CONTRIBUTING.md?", "author": "iNikem", "createdAt": "2020-12-07T06:47:25Z", "path": "instrumentation/elasticsearch/elasticsearch-rest-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/elasticsearch/rest/v5_0/Elasticsearch5RestClientInstrumentationModule.java", "diffHunk": "@@ -5,6 +5,7 @@\n \n package io.opentelemetry.javaagent.instrumentation.elasticsearch.rest.v5_0;\n \n+import static io.opentelemetry.javaagent.instrumentation.api.Java8BytecodeBridge.currentContext;", "originalCommit": "050b702fcf07dc2090c60f17a43af0a0650e00d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI3Mzc5NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#discussion_r537273794", "bodyText": "See the Javadoc for Java8BytecodeBridge. This situation is not good though. #1840 looks promising, less code in advice, less (no?) need for Java8BytecodeBridge.", "author": "trask", "createdAt": "2020-12-07T07:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NzIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI3NTA2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#discussion_r537275062", "bodyText": "If developers know about Java8BytecodeBridge they can read javadoc and understand what is going on. But how can they find it in the first place? :)", "author": "iNikem", "createdAt": "2020-12-07T07:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NzIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI3NjE1Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#discussion_r537276152", "bodyText": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/master/docs/contributing/writing-instrumentation.md#java-agent-instrumentation-gotchas", "author": "trask", "createdAt": "2020-12-07T07:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NzIyNw=="}], "type": "inlineReview"}]}