{"pr_number": 1346, "pr_title": "spotbugs upgrade and fixes for JMS1 tests", "pr_createdAt": "2020-10-08T10:46:25Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTM4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501659387", "bodyText": "Why older version here?", "author": "iNikem", "createdAt": "2020-10-08T11:52:27Z", "path": "gradle/spotbugs.gradle", "diffHunk": "@@ -7,6 +7,26 @@ allprojects {\n     omitVisitors = [\"FindDeadLocalStores\"]\n     effort = \"max\"\n     excludeFilter = file(\"$rootDir/gradle/spotbugs-exclude.xml\")\n+    toolVersion = '4.1.3'", "originalCommit": "a6525b40e700bf52a8dcf707cdad68bc0fa9bb91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4Mzc1NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501683755", "bodyText": "This is the latest spotbugs tool version, the gradle plugin has a different version cadence.", "author": "imavroukakis", "createdAt": "2020-10-08T12:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4OTQyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501689424", "bodyText": "And do you have to specify it here? If you don't will anything break?", "author": "iNikem", "createdAt": "2020-10-08T12:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMTA2NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501701065", "bodyText": "no, nothing breaks; if left unspecified it will revert to whatever version the plugin defines. IMO it is probably better to peg the tool version instead of leaving it undefined.", "author": "imavroukakis", "createdAt": "2020-10-08T13:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc5ODA1OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501798058", "bodyText": "Extra unnecessary configuration is extra code to maintain. If we already peg the version of the plugin, it should be enough, no?", "author": "iNikem", "createdAt": "2020-10-08T15:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxNzIwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501817207", "bodyText": "If you upgrade the gradle plugin, you get additional plugin fixes and/or configuration but you might also get a new version of the spotBugs tool. If you're explicit about the tool version, you can be reasonably confident of it not changing underneath your feet - having said that I don't feel strongly about it, so I'm happy to go with whatever direction you decide.", "author": "imavroukakis", "createdAt": "2020-10-08T15:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgyNjY5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501826697", "bodyText": "I prefer not to fix tool versions unless there is an actual reason for that :) Upgrade all the things! :)", "author": "iNikem", "createdAt": "2020-10-08T15:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTM4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTgwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501659807", "bodyText": "First, why html report for tests is enabled and for other code disabled? Second, if this report is disabled, why do you configure its destination?", "author": "iNikem", "createdAt": "2020-10-08T11:53:17Z", "path": "gradle/spotbugs.gradle", "diffHunk": "@@ -7,6 +7,26 @@ allprojects {\n     omitVisitors = [\"FindDeadLocalStores\"]\n     effort = \"max\"\n     excludeFilter = file(\"$rootDir/gradle/spotbugs-exclude.xml\")\n+    toolVersion = '4.1.3'\n+  }\n+\n+  spotbugsTest {\n+    reports {\n+      html {\n+        enabled = true\n+        destination = file(\"$buildDir/reports/spotbugs/main/spotbugs.html\")\n+        stylesheet = 'fancy-hist.xsl'\n+      }\n+    }\n+  }\n+  spotbugsMain {\n+    reports {\n+      html {\n+        enabled = false", "originalCommit": "a6525b40e700bf52a8dcf707cdad68bc0fa9bb91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5MTk1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501691953", "bodyText": "Good catch, it shouldn't have been. Ideally, what I would like to do is, conditionally run HTML reports if not under a CI environment and XML otherwise for the CI server to process -  but I'm not sure if I can do this within the context of the script. I did notice some tests that picked up a system environment variable, maybe the same would work here?", "author": "imavroukakis", "createdAt": "2020-10-08T12:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxMzI3NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501713275", "bodyText": "Ah I found it in the root gradle file! def isCI = System.getenv(\"CI\") != null", "author": "imavroukakis", "createdAt": "2020-10-08T13:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1OTgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDA0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501660048", "bodyText": "what check requires uppercase names?", "author": "iNikem", "createdAt": "2020-10-08T11:53:47Z", "path": "instrumentation/jms-1.1/src/test/groovy/JMS1Test.groovy", "diffHunk": "@@ -33,7 +33,7 @@ class JMS1Test extends AgentTestRunner {\n \n   private static final Logger logger = LoggerFactory.getLogger(JMS1Test)\n \n-  public static GenericContainer activemq = new GenericContainer(\"rmohr/activemq\")\n+  private static final GenericContainer BROKER = new GenericContainer(\"rmohr/activemq\")", "originalCommit": "a6525b40e700bf52a8dcf707cdad68bc0fa9bb91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4Nzk1MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501687951", "bodyText": "spotBugs recommends this to be private (although maybe sharing it between the tests might also make sense) and once you turn it private final codeNarc complains about the naming - I believe @trask was going to look into this.", "author": "imavroukakis", "createdAt": "2020-10-08T12:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4ODk1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501688950", "bodyText": "I believe he already did: #1335. Is your baseline fresh enough?", "author": "iNikem", "createdAt": "2020-10-08T12:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMzMxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501703317", "bodyText": "probably not. I will rebase and run the tasks again, thanks", "author": "imavroukakis", "createdAt": "2020-10-08T13:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDA0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDQ3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501660473", "bodyText": "Why this change was required?", "author": "iNikem", "createdAt": "2020-10-08T11:54:33Z", "path": "instrumentation/kotlin-coroutines/src/test/kotlin/KotlinCoroutineTests.kt", "diffHunk": "@@ -105,27 +104,17 @@ class KotlinCoroutineTests(private val dispatcher: CoroutineDispatcher) {\n    */\n   fun tracedWithDeferredFirstCompletions() = runTest {\n \n-    val children = listOf(\n-      async {\n-        tracedChild(\"timeout1\")\n-        false\n-      },\n-      async {\n-        tracedChild(\"timeout2\")\n-        false\n-      },\n-      async {\n-        tracedChild(\"timeout3\")\n-        true\n-      }\n-    )\n-\n     withTimeout(TimeUnit.SECONDS.toMillis(30)) {\n-      select<Boolean> {\n-        children.forEach { child ->\n-          child.onAwait { it }\n-        }\n-      }\n+      tracedChild(\"timeout1\")", "originalCommit": "a6525b40e700bf52a8dcf707cdad68bc0fa9bb91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5MDU3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501690570", "bodyText": "The way I understand what this test does is, that it launches these coroutines and then onAwaits for the results from each with a timeout. spotBugs complains about passing null into https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346/files/a6525b40e700bf52a8dcf707cdad68bc0fa9bb91#diff-ca9202f7cbd3f2a56910810901063998L126 - it's obviously confused! Instead of adding the class to the exclusion, rewriting it this way keeps the original intent, makes the code somewhat simpler and satisfies spotBugs.", "author": "imavroukakis", "createdAt": "2020-10-08T12:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgyNDI4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501824283", "bodyText": "I am not sure these are equivalent. First, old test waited 30s max in total, new test waits 30 seconds on each child.\nAnd reading spotbugs/spotbugs#573 I wonder if we should run spotbugs on Kotlin code at all :)", "author": "iNikem", "createdAt": "2020-10-08T15:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkxMzIxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501913216", "bodyText": "detekt is definitely more appropriate.", "author": "imavroukakis", "createdAt": "2020-10-08T18:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2MDQ3Mw=="}], "type": "inlineReview"}, {"oid": "64e676df6905d798edcff5f65392e8fafc666949", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/64e676df6905d798edcff5f65392e8fafc666949", "message": "spotless upgrade and fixes for JMS1 tests\n\n* includes missed bugs in KotlinCoroutineTests", "committedDate": "2020-10-08T15:06:24Z", "type": "commit"}, {"oid": "750954a1b9f9fb5d58953e5e78b3c4e2ad301263", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/750954a1b9f9fb5d58953e5e78b3c4e2ad301263", "message": "create spotBugs XML reports on CI, HTML locally", "committedDate": "2020-10-08T15:06:24Z", "type": "commit"}, {"oid": "224ec9a1a2dfde8c17b5af468a9ed6e48f6106c5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/224ec9a1a2dfde8c17b5af468a9ed6e48f6106c5", "message": "use updatedCodeNarc rules with lowercase tolerance", "committedDate": "2020-10-08T15:21:29Z", "type": "commit"}, {"oid": "224ec9a1a2dfde8c17b5af468a9ed6e48f6106c5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/224ec9a1a2dfde8c17b5af468a9ed6e48f6106c5", "message": "use updatedCodeNarc rules with lowercase tolerance", "committedDate": "2020-10-08T15:21:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxNDE3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501814177", "bodyText": "What of these are default configuration anyway and what specifically you want to override?", "author": "iNikem", "createdAt": "2020-10-08T15:30:39Z", "path": "gradle/spotbugs.gradle", "diffHunk": "@@ -2,11 +2,35 @@ allprojects {\n   apply plugin: 'com.github.spotbugs'\n \n   spotbugs {\n-    ignoreFailures = true\n+    ignoreFailures = false\n     reportLevel = \"high\"\n     omitVisitors = [\"FindDeadLocalStores\"]\n     effort = \"max\"\n     excludeFilter = file(\"$rootDir/gradle/spotbugs-exclude.xml\")\n+    toolVersion = '4.1.3'\n+  }\n+\n+  if (!isCI) {\n+    spotbugsTest {", "originalCommit": "224ec9a1a2dfde8c17b5af468a9ed6e48f6106c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxNzk4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501817982", "bodyText": "Default config is to generate an XML file for machine consumption, makes sense on a CI environment, not as much sense on a local machine.", "author": "imavroukakis", "createdAt": "2020-10-08T15:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxNDE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgyNjMyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501826320", "bodyText": "Then I believe this whole if block can be replaced with\n  spotbugsTest {\n    reports {\n      html.enabled = !isCI\n    }\n  }", "author": "iNikem", "createdAt": "2020-10-08T15:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxNDE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgzNTIxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501835210", "bodyText": "oh minor snag, you still need to explicitly disable XML reports to get HTML ones, there's an open bug for this on the plugin.", "author": "imavroukakis", "createdAt": "2020-10-08T16:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxNDE3Nw=="}], "type": "inlineReview"}, {"oid": "e50bc5875b755f1f1bdbfd9494ae2aba45c2a486", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e50bc5875b755f1f1bdbfd9494ae2aba45c2a486", "message": "remove if and move bool to each property", "committedDate": "2020-10-08T16:20:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDk4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501874988", "bodyText": "If these are default values anyway, then remove them", "author": "iNikem", "createdAt": "2020-10-08T17:02:47Z", "path": "gradle/spotbugs.gradle", "diffHunk": "@@ -10,27 +10,24 @@ allprojects {\n     toolVersion = '4.1.3'\n   }\n \n-  if (!isCI) {\n-    spotbugsTest {\n-      reports {\n-        html.enabled = true\n-        xml.enabled = false\n-        html {\n-          destination = file(\"$buildDir/reports/spotbugs/main.html\")\n-          stylesheet = 'fancy-hist.xsl'\n-        }\n+  spotbugsTest {\n+    reports {\n+      html.enabled = !isCI\n+      xml.enabled = isCI\n+      html {\n+        destination = file(\"$buildDir/reports/spotbugs/main.html\")\n+        stylesheet = 'fancy-hist.xsl'\n       }\n     }\n-    spotbugsMain {\n-      reports {\n-        html.enabled = true\n-        xml.enabled = false\n-        html {\n-          destination = file(\"$buildDir/reports/spotbugs/main.html\")\n-          stylesheet = 'fancy-hist.xsl'\n-        }\n+  }\n+  spotbugsMain {\n+    reports {\n+      html.enabled = !isCI\n+      xml.enabled = isCI\n+      html {", "originalCommit": "e50bc5875b755f1f1bdbfd9494ae2aba45c2a486", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg4ODcxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501888710", "bodyText": "Default is true for xml.enabled. However, to enable HTML reports, you have to explicitly disable the XML ones so both need to be present and set. Does this make sense or have I missed your point entirely?", "author": "imavroukakis", "createdAt": "2020-10-08T17:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkyNjUzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501926535", "bodyText": "I was talking about html configuration for stylesheet and report location. Why default values for them are not enough?", "author": "iNikem", "createdAt": "2020-10-08T18:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNTEwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1346#discussion_r501935106", "bodyText": "Oh I follow. Yeah we can remove the report location, but maybe keep the stylesheet, as it's not the default?", "author": "imavroukakis", "createdAt": "2020-10-08T18:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDk4OA=="}], "type": "inlineReview"}, {"oid": "276b0dfa55879d17615df9207992860d591ec40a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/276b0dfa55879d17615df9207992860d591ec40a", "message": "allow spotBugs gradle plugin to upgrade the spotbugs tool", "committedDate": "2020-10-08T18:01:13Z", "type": "commit"}, {"oid": "ef06096c5f5a506d0db7c6aa01138d104b410373", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ef06096c5f5a506d0db7c6aa01138d104b410373", "message": "revert to original test", "committedDate": "2020-10-08T18:24:22Z", "type": "commit"}, {"oid": "c7426c1281e4da8bf32260ae8cb27147fadd58ab", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c7426c1281e4da8bf32260ae8cb27147fadd58ab", "message": "exclude all kotlin source from spotbugs", "committedDate": "2020-10-08T18:31:49Z", "type": "commit"}, {"oid": "57275252a55be4bf474ed17c217009ee3ac7992f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/57275252a55be4bf474ed17c217009ee3ac7992f", "message": "remove default location for spotBugs report", "committedDate": "2020-10-08T18:51:25Z", "type": "commit"}, {"oid": "6d59c9bb9f2f7f82b7fc5e89d3476af5070e106e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6d59c9bb9f2f7f82b7fc5e89d3476af5070e106e", "message": "do not pass null to a Span's attribute", "committedDate": "2020-10-09T05:39:41Z", "type": "commit"}, {"oid": "7ca5dba63fd00657cc7e2fda05778eefaf04daab", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7ca5dba63fd00657cc7e2fda05778eefaf04daab", "message": "Merge branch 'master' into spotless-jms1tests-fixes", "committedDate": "2020-10-09T06:39:34Z", "type": "commit"}]}