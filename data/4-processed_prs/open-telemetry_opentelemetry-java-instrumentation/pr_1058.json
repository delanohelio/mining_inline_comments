{"pr_number": 1058, "pr_title": "Add missing RESTEasy (and Jersey) unit tests", "pr_createdAt": "2020-08-19T14:07:42Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058", "timeline": [{"oid": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "message": "Add missing RESTEasy (and Jersey) unit tests\n\n* Standard HTTP server test (extending HttpServerTest)\n* AsyncResponse tests\n* Error handling in JAX-RS HTTP client\n* HTTP client JDK proxies (this one is RESTEasy only)", "committedDate": "2020-08-19T14:07:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2NTMwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473565302", "bodyText": "can you check your Intellij settings for import layout? https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/master/docs/contributing/intellij-setup.md", "author": "trask", "createdAt": "2020-08-20T03:25:46Z", "path": "instrumentation/jaxrs-client/jaxrs-client-2.0/src/test/groovy/JaxRsClientTest.groovy", "diffHunk": "@@ -14,21 +14,26 @@\n  * limitations under the License.\n  */\n \n+import static io.opentelemetry.trace.Span.Kind.CLIENT\n+\n import io.opentelemetry.auto.test.base.HttpClientTest\n-import java.util.concurrent.TimeUnit\n+import io.opentelemetry.trace.attributes.SemanticAttributes\n+import org.apache.cxf.jaxrs.client.spec.ClientBuilderImpl\n+import org.glassfish.jersey.client.ClientConfig\n+import org.glassfish.jersey.client.ClientProperties\n+import org.glassfish.jersey.client.JerseyClientBuilder\n+import org.jboss.resteasy.client.jaxrs.ResteasyClientBuilder\n+import spock.lang.Timeout\n+import spock.lang.Unroll\n+\n import javax.ws.rs.client.Client\n import javax.ws.rs.client.ClientBuilder", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY4NjE1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473686156", "bodyText": "Yep, I had java.* and javax.* below all other imports \ud83e\udd26\nSorry for trivial stuff", "author": "mateuszrzeszutek", "createdAt": "2020-08-20T07:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2NTMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2NTgxMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473565812", "bodyText": "I'm not completely sure this is something useful to test, but if it is, can we test it in HttpClientTest across all http clients?", "author": "trask", "createdAt": "2020-08-20T03:27:35Z", "path": "instrumentation/jaxrs-client/jaxrs-client-2.0/src/test/groovy/JaxRsClientTest.groovy", "diffHunk": "@@ -47,6 +52,44 @@ abstract class JaxRsClientTest extends HttpClientTest {\n   }\n \n   abstract ClientBuilder builder()\n+\n+  @Unroll\n+  def \"should properly convert HTTP status #statusCode to span error status\"() {", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgyNDY4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473824688", "bodyText": "Do you mind if I create a separate issue or PR for this? Adding tests in HttpClientTest will affect all HTTP clients that we instrument and this may involve lots of changes that are unrelated to this PS's topic (RESTEasy).", "author": "mateuszrzeszutek", "createdAt": "2020-08-20T09:44:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2NTgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2NzA5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473567096", "bodyText": "so this is weird, if we didn't have a cap here before, that means the instrumentation also applies to 4.0", "author": "trask", "createdAt": "2020-08-20T03:32:43Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-resteasy-3.0/jaxrs-2.0-resteasy-3.0.gradle", "diffHunk": "@@ -14,7 +15,7 @@ muzzle {\n   pass {\n     group = \"org.jboss.resteasy\"\n     module = \"resteasy-jaxrs\"\n-    versions = \"[3.5.0.Final,)\"\n+    versions = \"[3.5.0.Final,4)\"", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzcxNzAyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473717027", "bodyText": "Yes and no -- since 4.0 there's no resteasy-jaxrs module, it's now called resteasy-core. This means that this line does not actually change anything and the coverage is still exactly the same -- but I've added to explicitly document that 4.0 (and newer) is not supported by this module.", "author": "mateuszrzeszutek", "createdAt": "2020-08-20T07:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2NzA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NDA4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473574086", "bodyText": "Any chance that this can extend HttpClientTest and get all of the good verification that provides (e.g. distributed trace context propagation)?", "author": "trask", "createdAt": "2020-08-20T04:00:52Z", "path": "instrumentation/jaxrs-client/jaxrs-client-2.0/src/test/groovy/ResteasyProxyClientTest.groovy", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import static io.opentelemetry.auto.test.server.http.TestHttpServer.httpServer\n+import static io.opentelemetry.trace.Span.Kind.CLIENT\n+\n+import io.opentelemetry.auto.test.AgentTestRunner\n+import io.opentelemetry.auto.test.asserts.TraceAssert\n+import io.opentelemetry.sdk.trace.data.SpanData\n+import io.opentelemetry.trace.attributes.SemanticAttributes\n+import org.jboss.resteasy.client.jaxrs.ResteasyClientBuilder\n+import org.jboss.resteasy.client.jaxrs.ResteasyWebTarget\n+import spock.lang.AutoCleanup\n+import spock.lang.Shared\n+import spock.lang.Unroll\n+\n+import javax.ws.rs.GET\n+import javax.ws.rs.Path\n+import javax.ws.rs.Produces\n+import javax.ws.rs.core.Response\n+\n+class ResteasyProxyClientTest extends AgentTestRunner {", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgyMzQyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473823429", "bodyText": "Good point, done.", "author": "mateuszrzeszutek", "createdAt": "2020-08-20T09:43:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NDA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NDQ0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473574441", "bodyText": "is this needed?", "author": "trask", "createdAt": "2020-08-20T04:01:57Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0.gradle", "diffHunk": "@@ -15,6 +15,8 @@ muzzle {\n }\n \n testSets {\n+  latestDepTest\n+", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzcxOTk2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473719966", "bodyText": "Nope, when I got rid of latestDepTestImplementation this line is unnecessary. I guess I was a bit confused how the new \"library\" thing worked.", "author": "mateuszrzeszutek", "createdAt": "2020-08-20T07:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NDQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3NDk4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473574982", "bodyText": "i think this is the default since you have same testLibrary definition above\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              latestDepTestLibrary group: 'org.jboss.resteasy', name: 'resteasy-jaxrs', version: '+'", "author": "trask", "createdAt": "2020-08-20T04:04:03Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0.gradle", "diffHunk": "@@ -38,8 +40,26 @@ dependencies {\n \n   // Resteasy\n   testLibrary group: 'org.jboss.resteasy', name: 'resteasy-jaxrs', version: '3.0.0.Final'\n+  testImplementation(group: 'org.jboss.resteasy', name: 'resteasy-undertow', version: '3.0.4.Final') {\n+    exclude group: 'org.jboss.resteasy', module: 'resteasy-client'\n+  }\n+  testImplementation group: 'io.undertow', name: 'undertow-servlet', version: '1.0.0.Final'\n \n   resteasy31TestImplementation(group: 'org.jboss.resteasy', name: 'resteasy-jaxrs', version: '3.1.0.Final')\n+  resteasy31TestImplementation(group: 'org.jboss.resteasy', name: 'resteasy-undertow', version: '3.1.0.Final') {\n+    exclude group: 'org.jboss.resteasy', module: 'resteasy-client'\n+  }\n+\n+  latestDepTestLibrary group: 'org.jboss.resteasy', name: 'resteasy-jaxrs', version: '+'", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MDE1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473580154", "bodyText": "oh wow I hadn't noticed this, suggestion to clarify further:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Resteasy changes a class's package in 3.1.0\n          \n          \n            \n              // 3.0 is continued in 3.5, up to 4; 3.1 is continued in 4.0\n          \n          \n            \n              // Resteasy changes a class's package in 3.1.0 then moves it back in 3.5.0 and then moves it forward again in 4.0.0\n          \n          \n            \n              // so the jaxrs-2.0-resteasy-3.0 module applies to [3.0, 3.1) and [3.5, 4.0)\n          \n          \n            \n              // and the jaxrs-2.0-resteasy-3.1 module applies to [3.5, 4.0)", "author": "trask", "createdAt": "2020-08-20T04:23:54Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-resteasy-3.0/jaxrs-2.0-resteasy-3.0.gradle", "diffHunk": "@@ -4,7 +4,8 @@ muzzle {\n   // Cant assert fails because muzzle assumes all instrumentations will fail\n   // Instrumentations in jaxrs-2.0 will pass\n \n-  // Resteasy changes a class's package in 3.1.0 then moves it back in 3.5.0 \n+  // Resteasy changes a class's package in 3.1.0\n+  // 3.0 is continued in 3.5, up to 4; 3.1 is continued in 4.0", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MzUyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1058#discussion_r473583522", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              latestDepTestImplementation(group: 'org.jboss.resteasy', name: 'resteasy-undertow', version: '3.+') {\n          \n          \n            \n              latestDepTestLibrary(group: 'org.jboss.resteasy', name: 'resteasy-undertow', version: '3.+') {", "author": "anuraaga", "createdAt": "2020-08-20T04:37:55Z", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0.gradle", "diffHunk": "@@ -38,8 +40,26 @@ dependencies {\n \n   // Resteasy\n   testLibrary group: 'org.jboss.resteasy', name: 'resteasy-jaxrs', version: '3.0.0.Final'\n+  testImplementation(group: 'org.jboss.resteasy', name: 'resteasy-undertow', version: '3.0.4.Final') {\n+    exclude group: 'org.jboss.resteasy', module: 'resteasy-client'\n+  }\n+  testImplementation group: 'io.undertow', name: 'undertow-servlet', version: '1.0.0.Final'\n \n   resteasy31TestImplementation(group: 'org.jboss.resteasy', name: 'resteasy-jaxrs', version: '3.1.0.Final')\n+  resteasy31TestImplementation(group: 'org.jboss.resteasy', name: 'resteasy-undertow', version: '3.1.0.Final') {\n+    exclude group: 'org.jboss.resteasy', module: 'resteasy-client'\n+  }\n+\n+  latestDepTestLibrary group: 'org.jboss.resteasy', name: 'resteasy-jaxrs', version: '+'\n+  latestDepTestImplementation(group: 'org.jboss.resteasy', name: 'resteasy-undertow', version: '3.+') {", "originalCommit": "dd3eb65ab6e997ed1f3bb6f4ba1ce8d6601f56f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0af63c6a1df9f4ce4963c8021c0abb9008af051", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d0af63c6a1df9f4ce4963c8021c0abb9008af051", "message": "Add missing RESTEasy (and Jersey) unit tests\n\n* Standard HTTP server test (extending HttpServerTest)\n* AsyncResponse tests\n* Error handling in JAX-RS HTTP client\n* HTTP client JDK proxies (this one is RESTEasy only)", "committedDate": "2020-08-20T08:07:46Z", "type": "commit"}, {"oid": "9572418555be645794c8f9efcbde36dcc12eb0f5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9572418555be645794c8f9efcbde36dcc12eb0f5", "message": "Update instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0.gradle\n\nCo-authored-by: Trask Stalnaker <trask.stalnaker@gmail.com>", "committedDate": "2020-08-20T08:07:46Z", "type": "commit"}, {"oid": "3e1fa91108fb670feb1816fc40eb03a88f99fec5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3e1fa91108fb670feb1816fc40eb03a88f99fec5", "message": "Update instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0.gradle\n\nCo-authored-by: Anuraag Agrawal <anuraaga@gmail.com>", "committedDate": "2020-08-20T08:07:46Z", "type": "commit"}, {"oid": "222198044deddd3b2f8584aebe966b894e7dee7b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/222198044deddd3b2f8584aebe966b894e7dee7b", "message": "Update instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-resteasy-3.0/jaxrs-2.0-resteasy-3.0.gradle\n\nCo-authored-by: Trask Stalnaker <trask.stalnaker@gmail.com>", "committedDate": "2020-08-20T08:07:46Z", "type": "commit"}, {"oid": "222faf6b31d5221095f4d3a4977ed5bc7fea145c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/222faf6b31d5221095f4d3a4977ed5bc7fea145c", "message": "Add missing RESTEasy (and Jersey) unit tests\n\n* Standard HTTP server test (extending HttpServerTest)\n* AsyncResponse tests\n* Error handling in JAX-RS HTTP client\n* HTTP client JDK proxies (this one is RESTEasy only)", "committedDate": "2020-08-20T08:07:46Z", "type": "forcePushed"}, {"oid": "4c938c5c6eb7c89d0750bc5c936fca8d622d0cd4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4c938c5c6eb7c89d0750bc5c936fca8d622d0cd4", "message": "Add missing RESTEasy (and Jersey) unit tests\n\n* Standard HTTP server test (extending HttpServerTest)\n* AsyncResponse tests\n* Error handling in JAX-RS HTTP client\n* HTTP client JDK proxies (this one is RESTEasy only)", "committedDate": "2020-08-20T09:41:38Z", "type": "forcePushed"}, {"oid": "c0c789b285904f5e7b0ceec4bbea4147fa1a2a02", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c0c789b285904f5e7b0ceec4bbea4147fa1a2a02", "message": "Add missing RESTEasy (and Jersey) unit tests\n\n* Standard HTTP server test (extending HttpServerTest)\n* AsyncResponse tests\n* Error handling in JAX-RS HTTP client\n* HTTP client JDK proxies (this one is RESTEasy only)", "committedDate": "2020-08-20T09:56:34Z", "type": "commit"}, {"oid": "c0c789b285904f5e7b0ceec4bbea4147fa1a2a02", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c0c789b285904f5e7b0ceec4bbea4147fa1a2a02", "message": "Add missing RESTEasy (and Jersey) unit tests\n\n* Standard HTTP server test (extending HttpServerTest)\n* AsyncResponse tests\n* Error handling in JAX-RS HTTP client\n* HTTP client JDK proxies (this one is RESTEasy only)", "committedDate": "2020-08-20T09:56:34Z", "type": "forcePushed"}]}