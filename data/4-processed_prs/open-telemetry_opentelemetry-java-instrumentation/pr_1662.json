{"pr_number": 1662, "pr_title": "Report only known collection names in MongoClientTracer (#1625)", "pr_createdAt": "2020-11-17T18:39:18Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662", "timeline": [{"oid": "dbfac2c2c6dc604422afedc998185b3cbdae057e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/dbfac2c2c6dc604422afedc998185b3cbdae057e", "message": "Report only known collection names in MongoClientTracer (#1625)\n\n* Use allow-list of commands that are known to use collection name as the value of the command\n* Special-case getMore command, which uses a different field for the collection name", "committedDate": "2020-11-17T17:11:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMzI3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r525403273", "bodyText": "While a n allow-list is in some ways not future proof, in practice I think it's safe as the trend in MongoDB has been to use new initiating stages in aggregation pipelines to add new functionality (e.g. the $changeStream stage.", "author": "jyemin", "createdAt": "2020-11-17T18:47:57Z", "path": "instrumentation/mongo/mongo-common/src/main/java/io/opentelemetry/javaagent/instrumentation/mongo/MongoClientTracer.java", "diffHunk": "@@ -130,10 +133,24 @@ private static BsonValue scrub(BsonValue origin) {\n     return scrubbed;\n   }\n \n+  private static final Set<String> COMMANDS_WITH_COLLECTION_NAME_AS_VALUE =\n+      new HashSet<>(asList(\n+          \"aggregate\", \"count\", \"distinct\", \"mapReduce\", \"geoSearch\", \"delete\", \"find\", \"killCursors\",", "originalCommit": "dbfac2c2c6dc604422afedc998185b3cbdae057e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMzUzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r525403535", "bodyText": "See https://docs.mongodb.com/manual/reference/command/getMore/", "author": "jyemin", "createdAt": "2020-11-17T18:48:26Z", "path": "instrumentation/mongo/mongo-common/src/main/java/io/opentelemetry/javaagent/instrumentation/mongo/MongoClientTracer.java", "diffHunk": "@@ -130,10 +133,24 @@ private static BsonValue scrub(BsonValue origin) {\n     return scrubbed;\n   }\n \n+  private static final Set<String> COMMANDS_WITH_COLLECTION_NAME_AS_VALUE =\n+      new HashSet<>(asList(\n+          \"aggregate\", \"count\", \"distinct\", \"mapReduce\", \"geoSearch\", \"delete\", \"find\", \"killCursors\",\n+          \"findAndModify\", \"insert\", \"update\", \"listIndexes\"));\n+\n   private static String collectionName(CommandStartedEvent event) {\n-    BsonValue collectionValue = event.getCommand().get(event.getCommandName());\n-    if (collectionValue != null && collectionValue.isString()) {\n-      return collectionValue.asString().getValue();\n+    if (event.getCommandName().equals(\"getMore\")) {\n+      if (event.getCommand().containsKey(\"collection\")) {", "originalCommit": "dbfac2c2c6dc604422afedc998185b3cbdae057e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8dfd36984d01631bd4034d7f2b27a5219a58c4a8", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8dfd36984d01631bd4034d7f2b27a5219a58c4a8", "message": "Run spotlessApply", "committedDate": "2020-11-17T21:29:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyMzE4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r525823186", "bodyText": "does it make sense to include create in this list?", "author": "trask", "createdAt": "2020-11-18T05:26:52Z", "path": "instrumentation/mongo/mongo-common/src/main/java/io/opentelemetry/javaagent/instrumentation/mongo/MongoClientTracer.java", "diffHunk": "@@ -130,10 +133,35 @@ private static BsonValue scrub(BsonValue origin) {\n     return scrubbed;\n   }\n \n+  private static final Set<String> COMMANDS_WITH_COLLECTION_NAME_AS_VALUE =\n+      new HashSet<>(\n+          asList(\n+              \"aggregate\",\n+              \"count\",\n+              \"distinct\",\n+              \"mapReduce\",\n+              \"geoSearch\",\n+              \"delete\",\n+              \"find\",\n+              \"killCursors\",\n+              \"findAndModify\",\n+              \"insert\",\n+              \"update\",\n+              \"listIndexes\"));", "originalCommit": "8dfd36984d01631bd4034d7f2b27a5219a58c4a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzNDMwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r526034302", "bodyText": "I considered it.  It doesn't do any harm, but I left it out because in MongoDB AFAIK it's not so common to create collections explicitly, as MongoDB will create them implicitly on first insert.\nBut happy to add it (and drop as well, I guess) if there's support.", "author": "jyemin", "createdAt": "2020-11-18T12:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyMzE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyNzAwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r526627000", "bodyText": "sure, let's include them both \ud83d\udc4d", "author": "trask", "createdAt": "2020-11-19T06:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyMzE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzOTU0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r526839541", "bodyText": "Added create, drop, and createIndexes", "author": "jyemin", "createdAt": "2020-11-19T12:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyMzE4Ng=="}], "type": "inlineReview"}, {"oid": "4844c7a8f339568716adf3c0c7dbf5bb58bf173b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4844c7a8f339568716adf3c0c7dbf5bb58bf173b", "message": "Add create, drop, and createIndexes to list of commands with collection name as their values", "committedDate": "2020-11-19T12:30:30Z", "type": "commit"}, {"oid": "c9eba0a2c2dfa4aae807dd593e8eeae9b73cbc5e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c9eba0a2c2dfa4aae807dd593e8eeae9b73cbc5e", "message": "Fixed async test", "committedDate": "2020-11-19T12:37:26Z", "type": "commit"}, {"oid": "cf30e5ba0d45ee652089d26f1ea8ec5352b0d993", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cf30e5ba0d45ee652089d26f1ea8ec5352b0d993", "message": "Merge remote-tracking branch 'upstream/master' into pr-1625-2", "committedDate": "2020-11-19T22:56:33Z", "type": "commit"}]}