{"pr_number": 1627, "pr_title": "Update to Gradle 6.7 and use new toolchains feature for testing on Ja\u2026", "pr_createdAt": "2020-11-13T05:50:16Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627", "timeline": [{"oid": "4343acafaf09a33ed2352652e28ae7dbeed22cba", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4343acafaf09a33ed2352652e28ae7dbeed22cba", "message": "Update to Gradle 6.7 and use new toolchains feature for testing on Java versions.", "committedDate": "2020-11-13T05:49:05Z", "type": "commit"}, {"oid": "b2174e7268f15c244f8df0a448fa52015f555b18", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b2174e7268f15c244f8df0a448fa52015f555b18", "message": "Update docs", "committedDate": "2020-11-13T05:52:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY2OTkyNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r522669925", "bodyText": "I added this like the -java repo has since it doesn't hurt. Here, the tradeoff of test vs build time is so high that it probably doesn't make sense to take advantage of \"build once, test many\" that we do there, and instead continue to matrix in GitHub resulting in \"build + test many\" which is fine.", "author": "anuraaga", "createdAt": "2020-11-13T05:53:16Z", "path": "gradle/java.gradle", "diffHunk": "@@ -218,62 +190,18 @@ def isJavaVersionAllowed(JavaVersion version) {\n   return true\n }\n \n-/**\n- * For a given java home return the location of java executable\n- */\n-static String toExecutable(String javaHome) {\n-  return Objects.requireNonNull(javaHome) + \"/bin/java\"\n-}\n-\n-/**\n- * Returns java home for a given version or {@code null} if not found\n- */\n-String findJavaHome(JavaVersion version) {\n-  def javaHome = System.getenv(\"JAVA_${version.majorVersion}_HOME\")\n-  if (javaHome == null) {\n-    return null\n+[8, 15].findAll { isJavaVersionAllowed(JavaVersion.toVersion(it)) }.each {version ->\n+  def testJavaForVersion = tasks.register(\"testJava${version}\", Test) {\n+    javaLauncher = javaToolchains.launcherFor {\n+      languageVersion = JavaLanguageVersion.of(version)\n+    }\n   }\n-  def foundVersion = getJavaHomeVersion(javaHome)\n-  return version == foundVersion ? javaHome : null\n-}\n-\n-ext {\n-  findJavaHome = this.&findJavaHome\n-  toExecutable = this.&toExecutable\n-}\n-\n-def addTestRule(String testTaskName) {\n-  def prefix = testTaskName + \"Java\"\n-  tasks.addRule(\"Pattern: $prefix<Version>: Runs tests using given java version\") { String taskName ->\n-    if (taskName.startsWith(prefix)) {\n-      def requestedJavaVersion = JavaVersion.toVersion(taskName - prefix)\n-      def gradleJavaVersion = JavaVersion.current()\n-\n-      if (gradleJavaVersion != requestedJavaVersion) {\n-        def javaHomeForTests = findJavaHome(requestedJavaVersion)\n-        if (javaHomeForTests != null) {\n-\n-          tasks.withType(Test).all {\n-            executable = toExecutable(javaHomeForTests)\n-            enabled = isJavaVersionAllowed(requestedJavaVersion)\n-          }\n-        } else {\n-          throw new BuildCancelledException(\"Requested java version $requestedJavaVersion not found\")\n-        }\n-      }\n \n-      task(taskName) {\n-        if (project.tasks.findByName(testTaskName) != null) {\n-          dependsOn testTaskName\n-        }\n-      }\n-    }\n+  if (rootProject.findProperty('testAdditionalJavaVersions') == 'true') {", "originalCommit": "b2174e7268f15c244f8df0a448fa52015f555b18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwNzg5NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r522807894", "bodyText": "I don't see where do we specify this property?", "author": "iNikem", "createdAt": "2020-11-13T08:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY2OTkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4MDIyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523380220", "bodyText": "Thought it could be useful from command line but on second thought guess not so much.", "author": "anuraaga", "createdAt": "2020-11-14T05:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY2OTkyNQ=="}], "type": "inlineReview"}, {"oid": "ea7c2aa84df9d20ac9b7b238e9ca2fd071c2b13e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ea7c2aa84df9d20ac9b7b238e9ca2fd071c2b13e", "message": "Add back sum", "committedDate": "2020-11-13T05:54:09Z", "type": "commit"}, {"oid": "b0c454de9c19e3ce86a551ec3a8410dd3e3d2f1b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b0c454de9c19e3ce86a551ec3a8410dd3e3d2f1b", "message": "Use GitHub test JDK for toolchain.", "committedDate": "2020-11-13T06:03:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3MjQ3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r522672477", "bodyText": "We're using -bin in -java per recommendation from Gradle team I believe", "author": "anuraaga", "createdAt": "2020-11-13T06:04:04Z", "path": "build.gradle", "diffHunk": "@@ -48,10 +48,6 @@ repositories {\n \n description = 'OpenTelemetry instrumentations for Java'\n \n-wrapper {\n-  distributionType = Wrapper.DistributionType.ALL", "originalCommit": "b0c454de9c19e3ce86a551ec3a8410dd3e3d2f1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "37cc5b10c839c9fd808aeacfbef905a02d26a28d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/37cc5b10c839c9fd808aeacfbef905a02d26a28d", "message": "Use maxJavaVersionForTests for default test version when set.", "committedDate": "2020-11-13T06:11:14Z", "type": "commit"}, {"oid": "2738513322299de0007270c76be8ec3c954ac28b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2738513322299de0007270c76be8ec3c954ac28b", "message": "Fix RMI", "committedDate": "2020-11-13T06:48:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwODQxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r522808411", "bodyText": "Can you add comment explaining this?", "author": "iNikem", "createdAt": "2020-11-13T08:50:58Z", "path": "gradle/java.gradle", "diffHunk": "@@ -297,6 +224,12 @@ tasks.withType(Test).configureEach {\n   testLogging {\n     exceptionFormat = 'full'\n   }\n+\n+  if (!isJavaVersionAllowed(JavaVersion.toVersion(11))) {", "originalCommit": "2738513322299de0007270c76be8ec3c954ac28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4MDIyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523380224", "bodyText": "Yeah - also made sure it only applies to test task which I guess is more appropriate.", "author": "anuraaga", "createdAt": "2020-11-14T05:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwODQxMQ=="}], "type": "inlineReview"}, {"oid": "1a313bf76a229d9e136af957141096beeec1a76e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1a313bf76a229d9e136af957141096beeec1a76e", "message": "Fix configs", "committedDate": "2020-11-14T05:38:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4MDI3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523380276", "bodyText": "Noticed that since this approach doesn't override test tasks like the previous one did, some configs get more complicated. I think it's rare so it might be ok but I can go back to the approach of overriding test instead of defining new tasks if it makes more sense.", "author": "anuraaga", "createdAt": "2020-11-14T05:39:26Z", "path": "testing-common/testing-common.gradle", "diffHunk": "@@ -67,6 +67,8 @@ tasks.register(\"testDisabledFieldInjection\", Test) {\n   includes = [\"context/FieldBackedProviderFieldInjectionDisabledTest.class\"]\n }\n test.dependsOn(testDisabledFieldInjection)\n-test.forkEvery 1\n+tasks.withType(Test) {", "originalCommit": "1a313bf76a229d9e136af957141096beeec1a76e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM5MjUxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523392511", "bodyText": "Found another file that was affected and realized it's probably hard to reason about right now, went back to the approach of using a rule.", "author": "anuraaga", "createdAt": "2020-11-14T08:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4MDI3Ng=="}], "type": "inlineReview"}, {"oid": "f4c0a782fa0a9718bb5481a97257ebeab47d576f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f4c0a782fa0a9718bb5481a97257ebeab47d576f", "message": "Go back to rule", "committedDate": "2020-11-14T08:12:14Z", "type": "commit"}, {"oid": "93d9c15cc5903d164acca19d19593b9ca3bc7d7c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/93d9c15cc5903d164acca19d19593b9ca3bc7d7c", "message": "Extract variable for default Java version.", "committedDate": "2020-11-14T08:19:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwMzk4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523703982", "bodyText": "no more JAVA_X_HOME, yay!", "author": "trask", "createdAt": "2020-11-15T04:01:04Z", "path": ".github/workflows/nightly.yaml", "diffHunk": "@@ -51,15 +51,13 @@ jobs:\n       fail-fast: false\n     steps:\n       - uses: actions/checkout@v2\n-      - name: Set up JDK ${{ matrix.java }} for running tests\n+      - id: setup-test-java\n+        name: Set up JDK ${{ matrix.java }} for running tests\n         uses: actions/setup-java@v1\n         with:\n           java-version: ${{ matrix.java }}\n-      - name: Set JDK ${{ matrix.java }} home\n-        run: echo JAVA_${{ matrix.java }}_HOME=${{ env.JAVA_HOME }} >> $GITHUB_ENV", "originalCommit": "93d9c15cc5903d164acca19d19593b9ca3bc7d7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwNDEyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523704120", "bodyText": "this is so cool", "author": "trask", "createdAt": "2020-11-15T04:03:06Z", "path": "docs/contributing/running-tests.md", "diffHunk": "@@ -22,14 +22,9 @@ instrumented library.\n \n #### Executing tests with specific java version\n \n-In order to run tests on a specific java version, just execute `./gradlew\n-testJava7` (or `testJava11` etc). Then Gradle task\n-rule will kick in and do the following:\n-\n-- check, if Gradle already runs on a java with required version\n-- if not, look for an environment variable named `JAVA_N_HOME`, where `N` is the requested java version\n-- if Gradle could not found requested java version, then build will fail\n-- Gradle will now find all corresponding test tasks and configure them to use java executable of the requested version.\n+We run all tests on Java 11 by default, along with Java 8 and 15. To run on the later, use\n+`./gradlew testJava8` or `./gradlew testJava15`. If you don't have a JDK of these versions\n+installed, Gradle will automatically download it for you.", "originalCommit": "93d9c15cc5903d164acca19d19593b9ca3bc7d7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwNDcwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523704709", "bodyText": "nice", "author": "trask", "createdAt": "2020-11-15T04:11:31Z", "path": "gradle/java.gradle", "diffHunk": "@@ -218,28 +193,15 @@ def isJavaVersionAllowed(JavaVersion version) {\n   return true\n }\n \n-/**\n- * For a given java home return the location of java executable\n- */\n-static String toExecutable(String javaHome) {\n-  return Objects.requireNonNull(javaHome) + \"/bin/java\"\n-}\n-\n-/**\n- * Returns java home for a given version or {@code null} if not found\n- */\n-String findJavaHome(JavaVersion version) {\n-  def javaHome = System.getenv(\"JAVA_${version.majorVersion}_HOME\")\n-  if (javaHome == null) {\n-    return null\n+// We default to testing with Java 11 for most tests, but some tests don't support it, where we change\n+// the default test task's version so commands like `./gradlew check` can test all projects regardless\n+// of Java version.", "originalCommit": "93d9c15cc5903d164acca19d19593b9ca3bc7d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0MzIzNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523943237", "bodyText": "@anuraaga Have you tested that this interplays correctly with test rule below? I think that when java version is requested explicitly by \"testJava15\", then we should not silently decrease it to satisfy \"maxJavaVersion\".", "author": "iNikem", "createdAt": "2020-11-16T07:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwNDcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk1NTQwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1627#discussion_r523955405", "bodyText": "Yeah that's the main reason I added it here, above the test rule. Though I don't think we have any situation to trigger ambiguity either because we have no case where minJavaVersionForTests is higher than 11. Even if we added it, it should work though.", "author": "anuraaga", "createdAt": "2020-11-16T08:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcwNDcwOQ=="}], "type": "inlineReview"}]}