{"pr_number": 934, "pr_title": "Improved smoke tests", "pr_createdAt": "2020-08-09T12:33:41Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934", "timeline": [{"oid": "0bc6fe43d7637b29b96c8f236e890eebc925a524", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0bc6fe43d7637b29b96c8f236e890eebc925a524", "message": "Preping smoke tests", "committedDate": "2020-08-09T12:28:42Z", "type": "commit"}, {"oid": "469ce6248d8984a91a711029d30549b3b1d5888b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/469ce6248d8984a91a711029d30549b3b1d5888b", "message": "Improved smoke tests", "committedDate": "2020-08-09T12:58:55Z", "type": "forcePushed"}, {"oid": "8afb367548563e3a7693b196f8fb40bd385780d9", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8afb367548563e3a7693b196f8fb40bd385780d9", "message": "Improved smoke tests", "committedDate": "2020-08-09T13:01:01Z", "type": "forcePushed"}, {"oid": "b86a30b6a632879fdce787be76c49aaf83c06794", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b86a30b6a632879fdce787be76c49aaf83c06794", "message": "Improved smoke tests", "committedDate": "2020-08-09T13:12:10Z", "type": "forcePushed"}, {"oid": "f5d937ead22c7e74968e84140d90152c54dcc63e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f5d937ead22c7e74968e84140d90152c54dcc63e", "message": "Improved smoke tests", "committedDate": "2020-08-09T14:15:46Z", "type": "forcePushed"}, {"oid": "7280152b926369a68257794ae8a416b65017d1ca", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7280152b926369a68257794ae8a416b65017d1ca", "message": "Improved smoke tests", "committedDate": "2020-08-09T14:43:22Z", "type": "commit"}, {"oid": "7280152b926369a68257794ae8a416b65017d1ca", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7280152b926369a68257794ae8a416b65017d1ca", "message": "Improved smoke tests", "committedDate": "2020-08-09T14:43:22Z", "type": "forcePushed"}, {"oid": "d79f9f1679be1ca688e6d739f207f703a8240cc2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d79f9f1679be1ca688e6d739f207f703a8240cc2", "message": "Merge remote-tracking branch 'upstream/master' into smoke-tests", "committedDate": "2020-08-10T16:42:19Z", "type": "commit"}, {"oid": "9626b4a5ca226a531126af4deda5104b621e0924", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9626b4a5ca226a531126af4deda5104b621e0924", "message": "Make it work in Linux", "committedDate": "2020-08-11T15:36:00Z", "type": "commit"}, {"oid": "5e1122d4f2eccaf2f2631bd67ef99b1f82dbf9f6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5e1122d4f2eccaf2f2631bd67ef99b1f82dbf9f6", "message": "Add workflow to run tests on PR", "committedDate": "2020-08-11T15:41:49Z", "type": "commit"}, {"oid": "47d8925632e06d54933a0ad88731803917c70700", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/47d8925632e06d54933a0ad88731803917c70700", "message": "Build Smoke tests", "committedDate": "2020-08-11T15:48:46Z", "type": "commit"}, {"oid": "6205065c564f7c3c95d3ea7ba4bf5ebb4d968766", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6205065c564f7c3c95d3ea7ba4bf5ebb4d968766", "message": "Fix PR workflow trigger", "committedDate": "2020-08-11T15:54:04Z", "type": "commit"}, {"oid": "edb43dc2bf2d624c8879689796a71cea7448448a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/edb43dc2bf2d624c8879689796a71cea7448448a", "message": "Fix smoke test apps trigger", "committedDate": "2020-08-11T15:59:13Z", "type": "commit"}, {"oid": "d82c32963c8c04f6dd50c739c4b3e3ff3757f07d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d82c32963c8c04f6dd50c739c4b3e3ff3757f07d", "message": "Disable smoke tests in CircleCI and let them run in Github Actions only", "committedDate": "2020-08-11T16:23:53Z", "type": "commit"}, {"oid": "0638055db0b7dec9f13b21c46948ffdcb82a58c0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0638055db0b7dec9f13b21c46948ffdcb82a58c0", "message": "Merge remote-tracking branch 'upstream/master' into smoke-tests", "committedDate": "2020-08-11T16:43:05Z", "type": "commit"}, {"oid": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/331b04828598a6ed939b7ec3d17719b8a129fe5a", "message": "Fix smoke test apps docker image names", "committedDate": "2020-08-11T18:38:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2MzA3NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r468863074", "bodyText": "just checking that we want to do this retry on PRs (not just nightly)?", "author": "trask", "createdAt": "2020-08-11T21:02:25Z", "path": ".github/workflows/pr.yaml", "diffHunk": "@@ -0,0 +1,37 @@\n+name: PR build\n+\n+on: pull_request\n+\n+jobs:\n+  test:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        java: [8, 11, 14]\n+      fail-fast: false\n+    steps:\n+      - uses: actions/checkout@v2\n+      - name: Set up JDK ${{ matrix.java }} for running tests\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+      - name: Set JDK ${{ matrix.java }} home\n+        run: echo \"::set-env name=JAVA_${{ matrix.java }}_HOME::${{ env.JAVA_HOME }}\"\n+\n+      - name: Set up JDK 11 for running Gradle\n+        if: matrix.java != 11\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: 11\n+\n+      - name: Cache gradle dependencies\n+        uses: burrunan/gradle-cache-action@v1\n+        with:\n+          job-id: jdk${{ matrix.java }}\n+\n+      - name: Test with Gradle\n+        uses: nick-invision/retry@v1\n+        with:\n+          command: ./gradlew testJava${{ matrix.java }} --stacktrace\n+          timeout_minutes: 60\n+          max_attempts: 3", "originalCommit": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTExMTY3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r469111676", "bodyText": "I think we still want to protect PRs from flaky test.", "author": "iNikem", "createdAt": "2020-08-12T08:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2MzA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyOTk0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r469429945", "bodyText": "just realized, this will slow down feedback (3x?) on real failing builds, which are common in PRs", "author": "trask", "createdAt": "2020-08-12T17:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2MzA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQzMTY0Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r469431642", "bodyText": "Not exactly 3x, because already passed tests will not be re-run. But you are right. Will see how this goes...", "author": "iNikem", "createdAt": "2020-08-12T17:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg2MzA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3MTY0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r468871643", "bodyText": "now that this dir has gradle?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    run: cd smoke-tests/play && ../../gradlew jib\n          \n          \n            \n                    run: cd smoke-tests/play && ./gradlew jib", "author": "trask", "createdAt": "2020-08-11T21:20:39Z", "path": ".github/workflows/build-play-smoke-dist.yaml", "diffHunk": "@@ -0,0 +1,28 @@\n+name: Build Play smoke test distribution\n+\n+on:\n+  push:\n+    paths:\n+      - 'smoke-tests/play/**'\n+    branches: 'master'\n+\n+jobs:\n+  test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - name: Set up JDK 11 for running Gradle\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: 11\n+\n+      - name: Cache gradle dependencies\n+        uses: burrunan/gradle-cache-action@v1\n+        with:\n+          job-id: jdk11\n+\n+      - name: Login to GitHub Package Registry\n+        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u ${{ github.repository }} --password-stdin\n+\n+      - name: Build Docker Image\n+        run: cd smoke-tests/play && ../../gradlew jib", "originalCommit": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3MTc1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r468871753", "bodyText": "same\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    run: cd smoke-tests/springboot && ../../gradlew jib\n          \n          \n            \n                    run: cd smoke-tests/springboot && ./gradlew jib", "author": "trask", "createdAt": "2020-08-11T21:20:54Z", "path": ".github/workflows/build-springboot-smoke-dist.yaml", "diffHunk": "@@ -0,0 +1,28 @@\n+name: Build Spring Boot smoke test distribution\n+\n+on:\n+  push:\n+    paths:\n+      - 'smoke-tests/springboot/**'\n+    branches: 'master'\n+\n+jobs:\n+  test:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v2\n+      - name: Set up JDK 11 for running Gradle\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: 11\n+\n+      - name: Cache gradle dependencies\n+        uses: burrunan/gradle-cache-action@v1\n+        with:\n+          job-id: jdk11\n+\n+      - name: Login to GitHub Package Registry\n+        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u ${{ github.repository }} --password-stdin\n+\n+      - name: Build Docker Image\n+        run: cd smoke-tests/springboot && ../../gradlew jib", "originalCommit": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3MjQzMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r468872432", "bodyText": "\ud83d\udc4d", "author": "trask", "createdAt": "2020-08-11T21:22:20Z", "path": "smoke-tests/play/README.md", "diffHunk": "@@ -0,0 +1,6 @@\n+# Play framework smoke test\n+Play application used by smoke tests of OpenTelemetry java agent.\n+Builds and publishes Docker image containing a trivial Play application.\n+\n+This is a separate gradle project, independent from the rest. This was done to allow\n+to build and publish it only when actually needed and not on every project build. ", "originalCommit": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3MzY5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r468873696", "bodyText": "i think nice to keep our smoke tests targeted to Java 8, even if we are only running them on Java 11 currently\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            sourceCompatibility = '11'\n          \n          \n            \n            sourceCompatibility = '8'", "author": "trask", "createdAt": "2020-08-11T21:25:00Z", "path": "smoke-tests/springboot/build.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+plugins {\n+  id 'org.springframework.boot' version '2.3.2.RELEASE'\n+  id 'io.spring.dependency-management' version '1.0.9.RELEASE'\n+  id 'java'\n+  id 'com.google.cloud.tools.jib' version '2.4.0'\n+}\n+\n+group = 'io.opentelemetry'\n+version = '0.0.1-SNAPSHOT'\n+sourceCompatibility = '11'", "originalCommit": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NTA2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r468875063", "bodyText": "nice \ud83d\udc4d", "author": "trask", "createdAt": "2020-08-11T21:27:57Z", "path": "smoke-tests/src/test/groovy/io/opentelemetry/smoketest/SmokeTest.groovy", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.smoketest\n+\n+import com.google.protobuf.util.JsonFormat\n+import io.opentelemetry.auto.test.utils.OkHttpUtils\n+import io.opentelemetry.proto.collector.trace.v1.ExportTraceServiceRequest\n+import io.opentelemetry.proto.trace.v1.Span\n+import java.nio.file.Files\n+import java.util.concurrent.TimeUnit\n+import java.util.stream.Stream\n+import okhttp3.OkHttpClient\n+import org.slf4j.Logger\n+import org.slf4j.LoggerFactory\n+import org.testcontainers.containers.BindMode\n+import org.testcontainers.containers.GenericContainer\n+import org.testcontainers.containers.Network\n+import org.testcontainers.containers.output.Slf4jLogConsumer\n+import spock.lang.Shared\n+import spock.lang.Specification\n+\n+abstract class SmokeTest extends Specification {\n+  private static final Logger logger = LoggerFactory.getLogger(SmokeTest)\n+\n+  protected static OkHttpClient client = OkHttpUtils.client()\n+\n+  @Shared\n+  private Network network = Network.newNetwork()\n+  @Shared\n+  protected String agentPath = System.getProperty(\"io.opentelemetry.smoketest.agent.shadowJar.path\")\n+\n+  @Shared\n+  protected GenericContainer target = new GenericContainer<>(getTargetImage())\n+    .withExposedPorts(8080)\n+    .withNetwork(network)\n+    .withLogConsumer(new Slf4jLogConsumer(logger))\n+    .withFileSystemBind(agentPath, \"/opentelemetry-javaagent-all.jar\")\n+    .withEnv(\"JAVA_TOOL_OPTIONS\", \"-javaagent:/opentelemetry-javaagent-all.jar\")\n+    .withEnv(\"OTEL_BSP_MAX_EXPORT_BATCH\", \"1\")\n+    .withEnv(\"OTEL_BSP_SCHEDULE_DELAY\", \"10\")\n+    .withEnv(\"OTEL_OTLP_ENDPOINT\", \"collector:55680\")\n+    .withEnv(extraEnv)", "originalCommit": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NzU1OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r468877558", "bodyText": "i think this should work now with real span verification, the reason it didn't before is because we were verifying from logging exporter and wildfly messed with stdout/stderr, i can try it out after the merge", "author": "trask", "createdAt": "2020-08-11T21:33:19Z", "path": "smoke-tests/src/test/groovy/io/opentelemetry/smoketest/WildflySmokeTest.groovy", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.smoketest\n+\n+\n+import okhttp3.Request\n+\n+class WildflySmokeTest extends SmokeTest {\n+\n+  protected String getTargetImage() {\n+    \"jboss/wildfly:latest\"\n+  }\n+\n+  //We don't have support for Wildfly Undertow server yet.\n+  //So this test just verifies that Wildfly has come up.", "originalCommit": "331b04828598a6ed939b7ec3d17719b8a129fe5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTExMzQ3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/934#discussion_r469113476", "bodyText": "I haven't seen any spans generated during this test", "author": "iNikem", "createdAt": "2020-08-12T09:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NzU1OA=="}], "type": "inlineReview"}, {"oid": "0dde2fa470d02d9e119ce8861f82dcd343e3d69b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0dde2fa470d02d9e119ce8861f82dcd343e3d69b", "message": "Polish", "committedDate": "2020-08-12T09:09:50Z", "type": "commit"}]}