{"pr_number": 979, "pr_title": "Implement Armeria instrumentation context propagation.", "pr_createdAt": "2020-08-14T09:01:55Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/979", "timeline": [{"oid": "ec915bf4e5356b735040325eab5d9cfbd5ad41cc", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ec915bf4e5356b735040325eab5d9cfbd5ad41cc", "message": "Implement Armeria instrumentation context propagation.", "committedDate": "2020-08-14T09:01:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUzODc2NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/979#discussion_r470538764", "bodyText": "How this will work in production where java_concurrent instrumentation IS enabled by default? Don't you want to test in realistic env?", "author": "iNikem", "createdAt": "2020-08-14T10:16:07Z", "path": "instrumentation/armeria-1.0/auto/armeria-1.0-auto.gradle", "diffHunk": "@@ -22,3 +22,9 @@ dependencies {\n \n   testImplementation project(':instrumentation:armeria-1.0:testing')\n }\n+\n+tasks.withType(Test) {\n+  // Armeria has its own mechanism for context propagation which we don't want our automatic context\n+  // propagation mechanism to interfere with.\n+  jvmArgs '-Dotel.integration.java_concurrent.enabled=false'", "originalCommit": "ec915bf4e5356b735040325eab5d9cfbd5ad41cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgzOTk1OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/979#discussion_r472839958", "bodyText": "Yeah I don't have a good story for this yet - I tried to inject the context storage override and play with this flag disabled but the bootstrap classloader issue I ran into is problematic. I may need to just instrument the context methods themselves. I will follow up for it.\nInterestingly, even with concurrent instrumentation, my unit test fails - I don't do anything particularly weird in it I think, just call CompletableFuture :(", "author": "anuraaga", "createdAt": "2020-08-19T08:09:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUzODc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0MDYyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/979#discussion_r470540621", "bodyText": "First, javadoc please :)\nSecond, having this class will override context storage for the whole JVM with our agent. Including all our instrumentations. And may change the before of the application, if it already has its own override.", "author": "iNikem", "createdAt": "2020-08-14T10:20:15Z", "path": "instrumentation/armeria-1.0/library/src/main/java/io/grpc/override/ContextStorageOverride.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.override;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import io.grpc.Context;\n+import io.grpc.Context.Storage;\n+import io.netty.util.AttributeKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextStorageOverride extends Storage {", "originalCommit": "ec915bf4e5356b735040325eab5d9cfbd5ad41cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg0MTk2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/979#discussion_r472841963", "bodyText": "Yeah - I think this is better behavior for Armeria users than the default. When Armeria context isn't available, the behavior is the same as normal so I'm not terribly worried about affecting the JVM.\nBut this gRPC API is silly so is problematic... indeed most problematic is if the user wants to override this themselves. Best I can think of is to provide our implementation (I extracted into a separate class) so they can delegate to it.", "author": "anuraaga", "createdAt": "2020-08-19T08:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0MDYyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3OTkzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/979#discussion_r473279930", "bodyText": "Have you tested this with the full javaagent? I think (shaded) io.grpc.override.ContextStorageOverride will be in the AgentClassLoader, while (shaded) io.grpc.Context will be in the bootstrap class loader, so may not find the (shaded) io.grpc.override.ContextStorageOverride.", "author": "trask", "createdAt": "2020-08-19T19:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0MDYyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3ODgyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/979#discussion_r473578822", "bodyText": "Yeah I think this is why the auto unit tests don't work. I'll continue to follow up on it, but any quick ideas on why the java_concurrent instrumentation wouldn't be enough anyways? #979 (comment)", "author": "anuraaga", "createdAt": "2020-08-20T04:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0MDYyMQ=="}], "type": "inlineReview"}, {"oid": "548287828b466bf49199ef56d23cabbfe685c3eb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/548287828b466bf49199ef56d23cabbfe685c3eb", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into armeria-context-storage-override", "committedDate": "2020-08-19T07:54:44Z", "type": "commit"}, {"oid": "ddc98f1a9b17c2a403dd614e3b18b755229a4756", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ddc98f1a9b17c2a403dd614e3b18b755229a4756", "message": "Doc and cleanup", "committedDate": "2020-08-19T08:03:43Z", "type": "commit"}, {"oid": "f5062b9d9b52aaa07ab2c04d31b084d811ddc8c5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f5062b9d9b52aaa07ab2c04d31b084d811ddc8c5", "message": "Update", "committedDate": "2020-08-19T08:10:18Z", "type": "commit"}, {"oid": "18cf6507e8de94cf3c71da75bd1f4893e360b783", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/18cf6507e8de94cf3c71da75bd1f4893e360b783", "message": "Clean", "committedDate": "2020-08-19T08:13:11Z", "type": "commit"}]}