{"pr_number": 1310, "pr_title": "Refactor all tests that use Config so that they don't fail locally", "pr_createdAt": "2020-10-02T17:14:18Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1310", "timeline": [{"oid": "a5a6eb8cfe94476c454cb9338fd2c9895137c96d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a5a6eb8cfe94476c454cb9338fd2c9895137c96d", "message": "Refactor all tests that use Config so that they don't fail locally", "committedDate": "2020-10-02T18:49:45Z", "type": "forcePushed"}, {"oid": "06156049b3bf97f6ad2f10f19036495512181341", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/06156049b3bf97f6ad2f10f19036495512181341", "message": "Refactor all tests that use Config so that they don't fail locally", "committedDate": "2020-10-02T19:08:54Z", "type": "forcePushed"}, {"oid": "22e150c255f02f7c8d9115fde8eb63ef9b489034", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/22e150c255f02f7c8d9115fde8eb63ef9b489034", "message": "Refactor all tests that use Config so that they don't fail locally", "committedDate": "2020-10-02T19:25:35Z", "type": "forcePushed"}, {"oid": "02fdaef9f7860ab4317d54fe482892be6f2b7980", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/02fdaef9f7860ab4317d54fe482892be6f2b7980", "message": "Refactor all tests that use Config so that they don't fail locally", "committedDate": "2020-10-07T08:34:50Z", "type": "commit"}, {"oid": "19ed53478fdb90d0ab42ac33e60aa93baa638cde", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/19ed53478fdb90d0ab42ac33e60aa93baa638cde", "message": "USe ConfigUtils in tests for all config-related things", "committedDate": "2020-10-07T09:46:19Z", "type": "forcePushed"}, {"oid": "be077f4d588fe9c0763cb8a8d8fd23f1c875bcd0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/be077f4d588fe9c0763cb8a8d8fd23f1c875bcd0", "message": "Use ConfigUtils in tests for all config-related things", "committedDate": "2020-10-07T10:10:01Z", "type": "commit"}, {"oid": "be077f4d588fe9c0763cb8a8d8fd23f1c875bcd0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/be077f4d588fe9c0763cb8a8d8fd23f1c875bcd0", "message": "Use ConfigUtils in tests for all config-related things", "committedDate": "2020-10-07T10:10:01Z", "type": "forcePushed"}, {"oid": "701e54a990a688efda6365cef6f12a6a37bad28e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/701e54a990a688efda6365cef6f12a6a37bad28e", "message": "Fix spotless and codenarc", "committedDate": "2020-10-07T10:25:06Z", "type": "commit"}, {"oid": "a1b3bacae75e0dddf5601bc0c39c66a7167a718e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a1b3bacae75e0dddf5601bc0c39c66a7167a718e", "message": "Fix spotless", "committedDate": "2020-10-07T10:44:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyNDY1OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1310#discussion_r501224658", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final PREVIOUS_CONFIG = ConfigUtils.updateConfig {\n          \n          \n            \n                it.setProperty(\n          \n          \n            \n                  \"otel.endpoint.peer.service.mapping\",\n          \n          \n            \n                  \"1.2.3.4=catservice,dogs.com=dogsservice,opentelemetry.io=specservice\")\n          \n          \n            \n              }\n          \n          \n            \n              static final PREVIOUS_CONFIG = ConfigUtils.updateConfig {\n          \n          \n            \n                it.setProperty(\n          \n          \n            \n                  \"otel.endpoint.peer.service.mapping\",\n          \n          \n            \n                  \"dogs.com=dogsservice\")\n          \n          \n            \n              }", "author": "trask", "createdAt": "2020-10-07T18:28:22Z", "path": "instrumentation-api/src/test/groovy/io/opentelemetry/instrumentation/api/tracer/HttpClientTracerTest.groovy", "diffHunk": "@@ -5,28 +5,29 @@\n \n package io.opentelemetry.instrumentation.api.tracer\n \n-import static io.opentelemetry.auto.test.utils.ConfigUtils.updateConfig\n-\n+import io.opentelemetry.auto.test.utils.ConfigUtils\n import io.opentelemetry.context.propagation.TextMapPropagator\n import io.opentelemetry.instrumentation.api.decorator.HttpStatusConverter\n import io.opentelemetry.trace.Span\n import io.opentelemetry.trace.attributes.SemanticAttributes\n import spock.lang.Shared\n \n class HttpClientTracerTest extends BaseTracerTest {\n-  static {\n-    updateConfig {\n-      System.setProperty(\n-        \"otel.endpoint.peer.service.mapping\",\n-        \"myhost-mapped=reservation-service\")\n-    }\n+  static final PREVIOUS_CONFIG = ConfigUtils.updateConfig {\n+    it.setProperty(\n+      \"otel.endpoint.peer.service.mapping\",\n+      \"1.2.3.4=catservice,dogs.com=dogsservice,opentelemetry.io=specservice\")\n+  }", "originalCommit": "a1b3bacae75e0dddf5601bc0c39c66a7167a718e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1ODc5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1310#discussion_r501558797", "bodyText": "I can only remove specservice, catservice is used by e.g. NetPeerUtilsTest. Will be fixed after next PR (ConfigValue!)", "author": "mateuszrzeszutek", "createdAt": "2020-10-08T08:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyNDY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyNTY0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1310#discussion_r501225640", "bodyText": "Is this needed?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final PREVIOUS_CONFIG = ConfigUtils.updateConfigAndResetInstrumentation {\n          \n          \n            \n                it.setProperty(\"otel.trace.classes.exclude\",\n          \n          \n            \n                  \"org.springframework.jms.config.JmsListenerEndpointRegistry\\$AggregatingCallback,\"\n          \n          \n            \n                    + \"org.springframework.context.support.DefaultLifecycleProcessor\\$1\")\n          \n          \n            \n              }", "author": "trask", "createdAt": "2020-10-07T18:29:56Z", "path": "instrumentation/jms-1.1/src/jms2Test/groovy/JMS2Test.groovy", "diffHunk": "@@ -34,6 +35,11 @@ import org.hornetq.jms.client.HornetQTextMessage\n import spock.lang.Shared\n \n class JMS2Test extends AgentTestRunner {\n+  static final PREVIOUS_CONFIG = ConfigUtils.updateConfigAndResetInstrumentation {\n+    it.setProperty(\"otel.trace.classes.exclude\",\n+      \"org.springframework.jms.config.JmsListenerEndpointRegistry\\$AggregatingCallback,\"\n+        + \"org.springframework.context.support.DefaultLifecycleProcessor\\$1\")\n+  }", "originalCommit": "a1b3bacae75e0dddf5601bc0c39c66a7167a718e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyNTg5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1310#discussion_r501225895", "bodyText": "is this needed?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final PREVIOUS_CONFIG = ConfigUtils.updateConfigAndResetInstrumentation {\n          \n          \n            \n                it.setProperty(\"otel.trace.classes.exclude\",\n          \n          \n            \n                  \"org.springframework.jms.config.JmsListenerEndpointRegistry\\$AggregatingCallback,\"\n          \n          \n            \n                    + \"org.springframework.context.support.DefaultLifecycleProcessor\\$1\")\n          \n          \n            \n              }\n          \n          \n            \n            \n          \n          \n            \n              def cleanupSpec() {\n          \n          \n            \n                ConfigUtils.setConfig(PREVIOUS_CONFIG)\n          \n          \n            \n              }", "author": "trask", "createdAt": "2020-10-07T18:30:21Z", "path": "instrumentation/jms-1.1/src/jms2Test/groovy/SpringListenerJMS2Test.groovy", "diffHunk": "@@ -15,6 +16,15 @@ import org.springframework.jms.core.JmsTemplate\n import org.springframework.jms.listener.adapter.MessagingMessageListenerAdapter\n \n class SpringListenerJMS2Test extends AgentTestRunner {\n+  static final PREVIOUS_CONFIG = ConfigUtils.updateConfigAndResetInstrumentation {\n+    it.setProperty(\"otel.trace.classes.exclude\",\n+      \"org.springframework.jms.config.JmsListenerEndpointRegistry\\$AggregatingCallback,\"\n+        + \"org.springframework.context.support.DefaultLifecycleProcessor\\$1\")\n+  }\n+\n+  def cleanupSpec() {\n+    ConfigUtils.setConfig(PREVIOUS_CONFIG)\n+  }", "originalCommit": "a1b3bacae75e0dddf5601bc0c39c66a7167a718e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1OTI0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1310#discussion_r501559248", "bodyText": "Nope, not needed anymore.", "author": "mateuszrzeszutek", "createdAt": "2020-10-08T09:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyNTg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyNjA2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1310#discussion_r501226067", "bodyText": "same\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final PREVIOUS_CONFIG = ConfigUtils.updateConfigAndResetInstrumentation {\n          \n          \n            \n                it.setProperty(\"otel.trace.classes.exclude\",\n          \n          \n            \n                  \"org.springframework.jms.config.JmsListenerEndpointRegistry\\$AggregatingCallback,\"\n          \n          \n            \n                    + \"org.springframework.context.support.DefaultLifecycleProcessor\\$1\")\n          \n          \n            \n              }", "author": "trask", "createdAt": "2020-10-07T18:30:38Z", "path": "instrumentation/jms-1.1/src/jms2Test/groovy/SpringTemplateJMS2Test.groovy", "diffHunk": "@@ -28,6 +29,11 @@ import org.springframework.jms.core.JmsTemplate\n import spock.lang.Shared\n \n class SpringTemplateJMS2Test extends AgentTestRunner {\n+  static final PREVIOUS_CONFIG = ConfigUtils.updateConfigAndResetInstrumentation {\n+    it.setProperty(\"otel.trace.classes.exclude\",\n+      \"org.springframework.jms.config.JmsListenerEndpointRegistry\\$AggregatingCallback,\"\n+        + \"org.springframework.context.support.DefaultLifecycleProcessor\\$1\")\n+  }", "originalCommit": "a1b3bacae75e0dddf5601bc0c39c66a7167a718e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a41606c5815f4a937cfae0842dce3265ee21c894", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a41606c5815f4a937cfae0842dce3265ee21c894", "message": "PR comments: remove unnecessary config", "committedDate": "2020-10-08T09:01:58Z", "type": "commit"}]}