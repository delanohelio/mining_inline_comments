{"pr_number": 398, "pr_title": "Merge changes from dd-trace-java 0.51.0", "pr_createdAt": "2020-05-10T03:46:25Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398", "timeline": [{"oid": "a51253f1c66aae01073e3693ab16c14cf687174f", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a51253f1c66aae01073e3693ab16c14cf687174f", "message": "Don't listen 0.0.0.0 in tests (DataDog/dd-trace-java#1434)", "committedDate": "2020-05-10T04:26:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwNDg3OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r422804878", "bodyText": "Remove dd- prefix?", "author": "iNikem", "createdAt": "2020-05-11T06:17:06Z", "path": "instrumentation/cassandra/cassandra-3.0/src/main/java/io/opentelemetry/auto/instrumentation/cassandra/v3_0/TracingSession.java", "diffHunk": "@@ -45,7 +46,9 @@\n   private static final Tracer TRACER =\n       OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.cassandra-3.0\");\n \n-  private final ExecutorService executorService = Executors.newCachedThreadPool();\n+  private static final ExecutorService EXECUTOR_SERVICE =\n+      Executors.newCachedThreadPool(new DaemonThreadFactory(\"dd-cassandra-session-executor\"));", "originalCommit": "a51253f1c66aae01073e3693ab16c14cf687174f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwNTE1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r422805159", "bodyText": "Is this needed for all tests or for latestDepTest only?", "author": "iNikem", "createdAt": "2020-05-11T06:17:52Z", "path": "instrumentation/lettuce/lettuce-5.0/lettuce-5.0.gradle", "diffHunk": "@@ -28,7 +28,7 @@ dependencies {\n \n   testCompile group: 'com.github.kstyrc', name: 'embedded-redis', version: '0.6'\n   testCompile group: 'io.lettuce', name: 'lettuce-core', version: '5.0.0.RELEASE'\n+  testCompile project(':instrumentation:reactor-3.1')", "originalCommit": "a51253f1c66aae01073e3693ab16c14cf687174f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAzNTU4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r423035580", "bodyText": "All, the earliest versions of Lettuce 5 use project reactor", "author": "devinsba", "createdAt": "2020-05-11T13:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwNTE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwNjc2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r422806767", "bodyText": "I don't see that auto-tooling depends on okhttp", "author": "iNikem", "createdAt": "2020-05-11T06:22:00Z", "path": "instrumentation/okhttp/okhttp-2.2/okhttp-2.2.gradle", "diffHunk": "@@ -0,0 +1,41 @@\n+apply from: \"${rootDir}/gradle/instrumentation.gradle\"\n+apply plugin: 'org.unbroken-dome.test-sets'\n+\n+/*\n+Note: The Interceptor class for OkHttp was not introduced until 2.2+, so we need to make sure the\n+instrumentation is not loaded unless the dependency is 2.2+.\n+*/\n+muzzle {\n+  pass {\n+    group = \"com.squareup.okhttp\"\n+    module = \"okhttp\"\n+    versions = \"[2.2,3)\"\n+    assertInverse = true\n+  }\n+}\n+\n+testSets {\n+  latestDepTest {\n+    dirName = 'test'\n+  }\n+}\n+\n+dependencies {\n+  compileOnly(group: 'com.squareup.okhttp', name: 'okhttp', version: '2.2.0')\n+\n+  compile(project(':auto-tooling')) {\n+    exclude module: 'okhttp'", "originalCommit": "a51253f1c66aae01073e3693ab16c14cf687174f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwNzA2OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r422807068", "bodyText": "Same here?", "author": "iNikem", "createdAt": "2020-05-11T06:22:38Z", "path": "instrumentation/okhttp/okhttp-2.2/okhttp-2.2.gradle", "diffHunk": "@@ -0,0 +1,41 @@\n+apply from: \"${rootDir}/gradle/instrumentation.gradle\"\n+apply plugin: 'org.unbroken-dome.test-sets'\n+\n+/*\n+Note: The Interceptor class for OkHttp was not introduced until 2.2+, so we need to make sure the\n+instrumentation is not loaded unless the dependency is 2.2+.\n+*/\n+muzzle {\n+  pass {\n+    group = \"com.squareup.okhttp\"\n+    module = \"okhttp\"\n+    versions = \"[2.2,3)\"\n+    assertInverse = true\n+  }\n+}\n+\n+testSets {\n+  latestDepTest {\n+    dirName = 'test'\n+  }\n+}\n+\n+dependencies {\n+  compileOnly(group: 'com.squareup.okhttp', name: 'okhttp', version: '2.2.0')\n+\n+  compile(project(':auto-tooling')) {\n+    exclude module: 'okhttp'\n+  }\n+\n+  testCompile(project(':testing')) {\n+    exclude module: 'okhttp'\n+  }\n+  testCompile(project(':instrumentation:java-concurrent')) {\n+    exclude module: 'okhttp'", "originalCommit": "a51253f1c66aae01073e3693ab16c14cf687174f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwOTcxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r422809713", "bodyText": "Maybe easier to use one CompletableFuture instead of two AtomicReference and a CountDownLatch? Callback will call either complete or completeExceptionally and test can end in just one line return future.get(10, SECONDS).", "author": "iNikem", "createdAt": "2020-05-11T06:29:32Z", "path": "instrumentation/okhttp/okhttp-2.2/src/test/groovy/OkHttp2AsyncTest.groovy", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+import com.squareup.okhttp.Callback\n+import com.squareup.okhttp.Headers\n+import com.squareup.okhttp.MediaType\n+import com.squareup.okhttp.Request\n+import com.squareup.okhttp.RequestBody\n+import com.squareup.okhttp.Response\n+import com.squareup.okhttp.internal.http.HttpMethod\n+\n+import java.util.concurrent.CountDownLatch\n+import java.util.concurrent.atomic.AtomicReference\n+\n+import static java.util.concurrent.TimeUnit.SECONDS\n+\n+class OkHttp2AsyncTest extends OkHttp2Test {\n+  @Override\n+  int doRequest(String method, URI uri, Map<String, String> headers, Closure callback) {\n+    def body = HttpMethod.requiresRequestBody(method) ? RequestBody.create(MediaType.parse(\"text/plain\"), \"\") : null\n+    def request = new Request.Builder()\n+      .url(uri.toURL())\n+      .method(method, body)\n+      .headers(Headers.of(HeadersUtil.headersToArray(headers)))\n+      .build()\n+\n+    AtomicReference<Response> responseRef = new AtomicReference()", "originalCommit": "a51253f1c66aae01073e3693ab16c14cf687174f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQwMDAzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r423400030", "bodyText": "Ah, this didn't end up working out because the Java 7 tests failed, oh well, it was a nice idea \ud83d\udc4d", "author": "trask", "createdAt": "2020-05-12T00:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwOTcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAzNzE1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r423037154", "bodyText": "I should have removed these comments. They no longer apply now that the tests pass", "author": "devinsba", "createdAt": "2020-05-11T13:26:11Z", "path": "instrumentation/lettuce/lettuce-5.0/src/test/groovy/LettuceReactiveClientTest.groovy", "diffHunk": "@@ -287,4 +290,121 @@ class LettuceReactiveClientTest extends AgentTestRunner {\n     }\n   }\n \n+  def \"blocking subscriber\"() {\n+    when:\n+    runUnderTrace(\"test-parent\") {\n+      reactiveCommands.set(\"a\", \"1\")\n+        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n+        .block()\n+    }\n+\n+    then:\n+    assertTraces(1) {\n+      trace(0, 3) {\n+        span(0) {\n+          operationName \"test-parent\"\n+          errored false\n+          tags {\n+          }\n+        }\n+        span(1) {\n+          operationName \"SET\"\n+          spanKind CLIENT\n+          errored false\n+          childOf span(0)\n+          tags {\n+            \"$Tags.DB_TYPE\" \"redis\"\n+          }\n+        }\n+        span(2) {\n+          operationName \"GET\"\n+          spanKind CLIENT\n+          errored false\n+          childOf span(0)\n+          tags {\n+            \"$Tags.DB_TYPE\" \"redis\"\n+          }\n+        }\n+      }\n+    }\n+  }\n+\n+  def \"async subscriber\"() {\n+    when:\n+    runUnderTrace(\"test-parent\") {\n+      reactiveCommands.set(\"a\", \"1\")\n+        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace\n+        .subscribe()\n+    }\n+\n+    then:\n+    assertTraces(1) {\n+      trace(0, 3) {\n+        span(0) {\n+          operationName \"test-parent\"\n+          errored false\n+          tags {\n+          }\n+        }\n+        span(1) {\n+          operationName \"SET\"\n+          spanKind CLIENT\n+          errored false\n+          childOf span(0)\n+          tags {\n+            \"$Tags.DB_TYPE\" \"redis\"\n+          }\n+        }\n+        span(2) {\n+          operationName \"GET\"\n+          spanKind CLIENT\n+          errored false\n+          childOf span(0)\n+          tags {\n+            \"$Tags.DB_TYPE\" \"redis\"\n+          }\n+        }\n+      }\n+    }\n+  }\n+\n+  def \"async subscriber with specific thread pool\"() {\n+    when:\n+    runUnderTrace(\"test-parent\") {\n+      reactiveCommands.set(\"a\", \"1\")\n+        .then(reactiveCommands.get(\"a\")) // The get here is ending up in another trace", "originalCommit": "a51253f1c66aae01073e3693ab16c14cf687174f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1NjMwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/398#discussion_r423256300", "bodyText": "timeout on get?", "author": "iNikem", "createdAt": "2020-05-11T19:05:58Z", "path": "instrumentation/okhttp/okhttp-2.2/src/test/groovy/OkHttp2AsyncTest.groovy", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import com.squareup.okhttp.*\n+import com.squareup.okhttp.internal.http.HttpMethod\n+\n+import java.util.concurrent.CompletableFuture\n+\n+class OkHttp2AsyncTest extends OkHttp2Test {\n+  @Override\n+  int doRequest(String method, URI uri, Map<String, String> headers, Closure callback) {\n+    def body = HttpMethod.requiresRequestBody(method) ? RequestBody.create(MediaType.parse(\"text/plain\"), \"\") : null\n+    def request = new Request.Builder()\n+        .url(uri.toURL())\n+        .method(method, body)\n+        .headers(Headers.of(HeadersUtil.headersToArray(headers)))\n+        .build()\n+\n+    def future = new CompletableFuture<Response>()\n+\n+    client.newCall(request).enqueue(new Callback() {\n+      void onResponse(Response response) {\n+        callback?.call()\n+        future.complete(response)\n+      }\n+\n+      void onFailure(Request req, IOException e) {\n+        future.completeExceptionally(e)\n+      }\n+    })\n+    return future.get().code()", "originalCommit": "a8d9134a36c72d0597d64a76ffed11a2e5da3f1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fcd9abda84b7322ed4f66b6431b0c76e9dd6c56d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fcd9abda84b7322ed4f66b6431b0c76e9dd6c56d", "message": "fixup! fixup! Add instrumentation for okhttp 2.2+ (DataDog/dd-trace-java#1402)", "committedDate": "2020-05-11T23:43:22Z", "type": "forcePushed"}, {"oid": "cfac325c13b3abe2a020fa22c57b7fc317445fc7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cfac325c13b3abe2a020fa22c57b7fc317445fc7", "message": "fixup! Fix projectreactor instrumentation to keep span context connected (DataDog/dd-trace-java#1308)", "committedDate": "2020-05-12T00:42:52Z", "type": "forcePushed"}, {"oid": "933f8f271308403a6deaa9ab86bbab2601271838", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/933f8f271308403a6deaa9ab86bbab2601271838", "message": "Don't listen 0.0.0.0 in tests (DataDog/dd-trace-java#1434)", "committedDate": "2020-05-12T01:29:12Z", "type": "forcePushed"}, {"oid": "6f472a62a0eea340608c9b275f7333ef22945ff6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6f472a62a0eea340608c9b275f7333ef22945ff6", "message": "Fix projectreactor instrumentation to keep span context connected (DataDog/dd-trace-java#1308)", "committedDate": "2020-05-14T18:49:44Z", "type": "commit"}, {"oid": "c63b4fd9a373fa22ec3bd3c95787eddebe16e3b4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c63b4fd9a373fa22ec3bd3c95787eddebe16e3b4", "message": "Add scopes to http server response (DataDog/dd-trace-java#1408)", "committedDate": "2020-05-14T18:49:44Z", "type": "commit"}, {"oid": "5ecd8cb81e7f3f02ae9b19d9259451afad01d727", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5ecd8cb81e7f3f02ae9b19d9259451afad01d727", "message": "Add instrumentation for okhttp 2.2+ (DataDog/dd-trace-java#1402)", "committedDate": "2020-05-14T18:50:27Z", "type": "commit"}, {"oid": "ca27485a5c5c28a20e8320b3e05ca7b7657468a7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ca27485a5c5c28a20e8320b3e05ca7b7657468a7", "message": "Upgrade Byte Buddy to 1.10.10 (DataDog/dd-trace-java#1409)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "b36a7aef8c005ec0bb0d593eb8dc12315951ac1b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b36a7aef8c005ec0bb0d593eb8dc12315951ac1b", "message": "Upgrade test-sets plugin to 3.0.1 (DataDog/dd-trace-java#1411)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "95cac497d29d92dab6d9e239ae555a442fd1a9a0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/95cac497d29d92dab6d9e239ae555a442fd1a9a0", "message": "Replace collection.size() > 0 with not collection.isEmpty() (DataDog/dd-trace-java#1420)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "672776412321afc4475a818cdc8697695a1bafe8", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/672776412321afc4475a818cdc8697695a1bafe8", "message": "Netty 3.8 had the wrong version in the config property (DataDog/dd-trace-java#1423)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "6b359d11ec620295237d1e82e24fe96a604a5f2e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6b359d11ec620295237d1e82e24fe96a604a5f2e", "message": "Fix cassandra instrumentation to use a daemon thread (DataDog/dd-trace-java#1422)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "f8593cbbad03b4caee62fd096af668c5c9401dc7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f8593cbbad03b4caee62fd096af668c5c9401dc7", "message": "Upgrade to latest version of publishing plugins (DataDog/dd-trace-java#1427)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "847d59fa7a0d0d5904a2def0be62db4a2ca323f6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/847d59fa7a0d0d5904a2def0be62db4a2ca323f6", "message": "Fix publishing to artifactory (DataDog/dd-trace-java#1432)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "f540ae8fc1a36df98ced1585d600a65e237e1230", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f540ae8fc1a36df98ced1585d600a65e237e1230", "message": "Add null servlet context check (DataDog/dd-trace-java#1414)", "committedDate": "2020-05-14T18:50:30Z", "type": "commit"}, {"oid": "fbf31d3a392366433d46a28460c0d2aa9be028c4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fbf31d3a392366433d46a28460c0d2aa9be028c4", "message": "Don't listen 0.0.0.0 in tests (DataDog/dd-trace-java#1434)", "committedDate": "2020-05-14T18:50:31Z", "type": "commit"}, {"oid": "fbf31d3a392366433d46a28460c0d2aa9be028c4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fbf31d3a392366433d46a28460c0d2aa9be028c4", "message": "Don't listen 0.0.0.0 in tests (DataDog/dd-trace-java#1434)", "committedDate": "2020-05-14T18:50:31Z", "type": "forcePushed"}]}