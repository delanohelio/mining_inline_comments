{"pr_number": 1426, "pr_title": "Remove usage of Contexts from grpc instrumentation.", "pr_createdAt": "2020-10-20T07:40:00Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1426", "timeline": [{"oid": "ecac00807d333589f744c66bdb5225bfbf90a5ff", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ecac00807d333589f744c66bdb5225bfbf90a5ff", "message": "Fix grpc instrumentation cannot be applied due to muzzle error and add smoke test.", "committedDate": "2020-10-20T07:36:14Z", "type": "commit"}, {"oid": "1d96f8c2e92c4772991afd4283bb23a7936e60d4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1d96f8c2e92c4772991afd4283bb23a7936e60d4", "message": "Add workflow for building smoke test image", "committedDate": "2020-10-20T07:41:22Z", "type": "commit"}, {"oid": "3343ad38ab088b52b05a1a52a2df54487c8dbd2b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3343ad38ab088b52b05a1a52a2df54487c8dbd2b", "message": "Revert debug logging", "committedDate": "2020-10-20T07:44:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1MTExNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1426#discussion_r508451116", "bodyText": "That's not Spring Boot, right?", "author": "iNikem", "createdAt": "2020-10-20T12:17:34Z", "path": ".github/workflows/build-grpc-smoke-dist.yaml", "diffHunk": "@@ -0,0 +1,33 @@\n+name: Build Spring Boot smoke test distribution", "originalCommit": "3343ad38ab088b52b05a1a52a2df54487c8dbd2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1MTMwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1426#discussion_r508451307", "bodyText": "Why?", "author": "iNikem", "createdAt": "2020-10-20T12:17:55Z", "path": ".gitignore", "diffHunk": "@@ -58,7 +57,4 @@ hs_err_pid*\n replay_pid*\n \n !java-agent/benchmark/releases/*.jar\n-/smoke-tests/play/.gradle/", "originalCommit": "3343ad38ab088b52b05a1a52a2df54487c8dbd2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1NjI4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1426#discussion_r508656287", "bodyText": "I made .gradle a non-absolute path above which seems like low chance of collision :)", "author": "anuraaga", "createdAt": "2020-10-20T16:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1MTMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1MjkwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1426#discussion_r508452908", "bodyText": "Wanna change back?", "author": "iNikem", "createdAt": "2020-10-20T12:20:27Z", "path": "smoke-tests/src/test/groovy/io/opentelemetry/smoketest/GrpcSmokeTest.groovy", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.smoketest\n+\n+import static java.util.stream.Collectors.toSet\n+\n+import io.grpc.ManagedChannelBuilder\n+import io.opentelemetry.proto.collector.trace.v1.ExportTraceServiceRequest\n+import io.opentelemetry.proto.collector.trace.v1.TraceServiceGrpc\n+import java.util.jar.Attributes\n+import java.util.jar.JarFile\n+import spock.lang.Unroll\n+\n+class GrpcSmokeTest extends SmokeTest {\n+\n+  protected String getTargetImage(int jdk) {\n+    \"open-telemetry-docker-dev.bintray.io/java/smoke-grpc-jdk$jdk:latest\"\n+  }\n+\n+  @Unroll\n+  def \"grpc smoke test on JDK #jdk\"(int jdk) {\n+    setup:\n+    startTarget(jdk)\n+\n+    def channel = ManagedChannelBuilder.forAddress(\"localhost\", target.getMappedPort(8080))\n+      .usePlaintext()\n+      .build()\n+    def stub = TraceServiceGrpc.newBlockingStub(channel)\n+\n+    def currentAgentVersion = new JarFile(agentPath).getManifest().getMainAttributes().get(Attributes.Name.IMPLEMENTATION_VERSION)\n+\n+    when:\n+    stub.export(ExportTraceServiceRequest.getDefaultInstance())\n+    Collection<ExportTraceServiceRequest> traces = waitForTraces()\n+\n+    then:\n+    countSpansByName(traces, 'opentelemetry.proto.collector.trace.v1.TraceService/Export') == 1\n+    countSpansByName(traces, 'TestService.withSpan') == 1\n+\n+    [currentAgentVersion] as Set == findResourceAttribute(traces, \"telemetry.auto.version\")\n+      .map { it.stringValue }\n+      .collect(toSet())\n+\n+    cleanup:\n+    stopTarget()\n+\n+    where:\n+    jdk << [11]\n+    // jdk << [8, 11, 15]", "originalCommit": "3343ad38ab088b52b05a1a52a2df54487c8dbd2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1NjQ1OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1426#discussion_r508656458", "bodyText": "Doh yeah", "author": "anuraaga", "createdAt": "2020-10-20T16:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1MjkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUxOTY5OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1426#discussion_r508519699", "bodyText": "Shouldn't it be 8 here? If you want it to run on Java 8", "author": "mateuszrzeszutek", "createdAt": "2020-10-20T13:48:43Z", "path": "smoke-tests/grpc/build.gradle", "diffHunk": "@@ -0,0 +1,35 @@\n+plugins {\n+  id \"java\"\n+  id \"com.google.cloud.tools.jib\" version \"2.6.0\"\n+}\n+\n+group = \"io.opentelemetry\"\n+version = \"0.0.1-SNAPSHOT\"\n+\n+repositories {\n+  jcenter()\n+}\n+\n+dependencies {\n+  implementation platform(\"org.apache.logging.log4j:log4j-bom:2.13.3\")\n+\n+  implementation \"io.grpc:grpc-netty-shaded:1.32.1\"\n+  implementation \"io.grpc:grpc-protobuf:1.32.1\"\n+  implementation \"io.grpc:grpc-stub:1.32.1\"\n+  implementation \"io.opentelemetry:opentelemetry-proto:0.9.1\"\n+  implementation \"io.opentelemetry:opentelemetry-extension-auto-annotations:0.9.1\"\n+  implementation \"org.apache.logging.log4j:log4j-core\"\n+\n+  runtimeOnly(\"org.apache.logging.log4j:log4j-slf4j-impl\")\n+}\n+\n+compileJava {\n+  options.release = 11", "originalCommit": "3343ad38ab088b52b05a1a52a2df54487c8dbd2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "38b0fde66d2d81637fd99396869eb69d5f1f3b2e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/38b0fde66d2d81637fd99396869eb69d5f1f3b2e", "message": "Java versions", "committedDate": "2020-10-21T00:04:36Z", "type": "commit"}]}