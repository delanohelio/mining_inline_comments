{"pr_number": 1479, "pr_title": "Update to latest SDK snapshot.", "pr_createdAt": "2020-10-26T05:38:28Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479", "timeline": [{"oid": "be86c8fef109c1285e4c33be00fd6362c5461aaf", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/be86c8fef109c1285e4c33be00fd6362c5461aaf", "message": "Update to latest SDK snapshot.", "committedDate": "2020-10-26T05:38:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyODU3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r511728573", "bodyText": "I just deleted this since I think even previously, this wasn't required because of instrumentation of withSpan and makeCurrent", "author": "anuraaga", "createdAt": "2020-10-26T05:39:31Z", "path": "instrumentation/opentelemetry-api-beta/src/main/java/io/opentelemetry/javaagent/instrumentation/opentelemetryapi/trace/TracingContextUtils.java", "diffHunk": "@@ -77,22 +74,4 @@ public static Span getSpanWithoutDefault(\n         io.opentelemetry.trace.Span.fromContextOrNull(agentContext);\n     return agentSpan == null ? null : toApplication(agentSpan);\n   }\n-\n-  public static Scope currentContextWith(Span applicationSpan) {", "originalCommit": "be86c8fef109c1285e4c33be00fd6362c5461aaf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29b5752e80a40a62d2f89c6d8b9fd73c92024746", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/29b5752e80a40a62d2f89c6d8b9fd73c92024746", "message": "Disable muzzle for now", "committedDate": "2020-10-26T06:58:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0OTkwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r511749901", "bodyText": "I guess this is better than having muzzle pull in random versions from snapshot repo? Let me know if there's a better way.\nI'm surprised the smoke tests pass though - actually I had flaky behavior this time where sometimes they fail with no WithSpan and sometimes they pass fine locally, and have similar seemingly bad-cache behavior before so a bit anxious they may have some problem @iNikem", "author": "anuraaga", "createdAt": "2020-10-26T06:59:54Z", "path": "instrumentation/external-annotations/external-annotations.gradle", "diffHunk": "@@ -1,5 +1,7 @@\n apply from: \"$rootDir/gradle/instrumentation.gradle\"\n \n+// TODO(anuraaga): Reenable after SDK 0.10.0 is published", "originalCommit": "29b5752e80a40a62d2f89c6d8b9fd73c92024746", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1NTQ0Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r511755442", "bodyText": "Did something change in the annotations that broke muzzle's compatibility check?", "author": "trask", "createdAt": "2020-10-26T07:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0OTkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MzUyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r511763521", "bodyText": "Now the implementation uses Span.makeCurrent() instead of TracingContextUtils which isn't available in previous opentelemetry API", "author": "anuraaga", "createdAt": "2020-10-26T07:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0OTkwMQ=="}], "type": "inlineReview"}, {"oid": "8825e08d0bf725057490f42275de6e42e441eac6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8825e08d0bf725057490f42275de6e42e441eac6", "message": "Smoke tests snapshot sdk", "committedDate": "2020-10-26T07:02:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512114875", "bodyText": "is this change needed, since the annotation API itself hasn't changed (only our underlying instrumentation)?", "author": "trask", "createdAt": "2020-10-26T16:51:44Z", "path": "smoke-tests/springboot/build.gradle", "diffHunk": "@@ -11,11 +11,18 @@ version = '0.0.1-SNAPSHOT'\n repositories {\n   mavenCentral()\n   jcenter()\n+  // this is only needed for the working against unreleased otel-java snapshots\n+  maven {\n+    url \"https://oss.jfrog.org/artifactory/oss-snapshot-local\"\n+    content {\n+      includeGroup \"io.opentelemetry\"\n+    }\n+  }\n }\n \n dependencies {\n   implementation 'org.springframework.boot:spring-boot-starter-web'\n-  implementation 'io.opentelemetry:opentelemetry-extension-auto-annotations:0.7.0'\n+  implementation 'io.opentelemetry:opentelemetry-extension-auto-annotations:0.10.0-SNAPSHOT'", "originalCommit": "8825e08d0bf725057490f42275de6e42e441eac6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMjkwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512332903", "bodyText": "Ah thanks I got confused since muzzle was failing", "author": "anuraaga", "createdAt": "2020-10-26T23:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzOTUzNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512339537", "bodyText": "Ah wait - yeah the main point of the change wasn't the annotations but to pull in the newer API package (figured it's more idiomatic to just use the transitive dependency to manage that). I'm a bit confused why the smoke tests are passing - wouldn't you expect the instrumentation to get muzzled since missing Span.makeCurrent?", "author": "anuraaga", "createdAt": "2020-10-27T00:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0Mjg0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512342840", "bodyText": "WithSpanAnnotationInstrumentation uses shaded Span.makeCurrent, but doesn't rely on OpenTelemetry API in user class loader, so no muzzle problem (though we want to apply muzzle consistently across all instrumentation in a single module in the future #1274 (comment))\nOh, and this made me realized @WithSpan instrumentation is no longer in external-annotations, which makes me think maybe your change to external-annotations.gradle is not needed?", "author": "trask", "createdAt": "2020-10-27T00:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0NDYzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512344636", "bodyText": "Hmm - the :muzzle task was definitely failing in external-annotations though. Muzzle explicitly depends on the otel api, which doesn't have Span.makeCurrent, but should it be checking our shaded version instead?", "author": "anuraaga", "createdAt": "2020-10-27T00:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0OTYxNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512349615", "bodyText": "oh sorry, we should remove the annotations dep from that muzzle block in external-annotations.gradle since that module doesn't use it anymore (we should have removed it when we moved WithSpan annotation instrumentation from external-annotations to opentelemetry-api-beta), e.g.\nmuzzle {\n  pass {\n    group = \"io.opentracing.contrib.dropwizard\"\n    module = \"dropwizard-opentracing\"\n    versions = \"[0.2.2,)\"\n  }\n}", "author": "trask", "createdAt": "2020-10-27T00:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3MTQxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512371418", "bodyText": "Thanks!\nNot sure if you meant this literally or figuratively - I tried adding muzzle for other libraries as well but dropwizard-opentracing seems to be the only one that passes for some reason.", "author": "anuraaga", "createdAt": "2020-10-27T02:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM3ODkxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512378917", "bodyText": "Not sure if you meant this literally or figuratively\n\nI use e.g. to mean a lot of things at once \ud83d\ude02", "author": "trask", "createdAt": "2020-10-27T02:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEzODkzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1479#discussion_r512138936", "bodyText": "is this change needed? smoke tests are passing on this PR, and I think(?) they use docker images from last build on master", "author": "trask", "createdAt": "2020-10-26T17:24:22Z", "path": "smoke-tests/grpc/build.gradle", "diffHunk": "@@ -17,8 +24,8 @@ dependencies {\n   implementation \"io.grpc:grpc-netty-shaded:1.32.1\"\n   implementation \"io.grpc:grpc-protobuf:1.32.1\"\n   implementation \"io.grpc:grpc-stub:1.32.1\"\n-  implementation \"io.opentelemetry:opentelemetry-proto:0.9.1\"\n-  implementation \"io.opentelemetry:opentelemetry-extension-auto-annotations:0.9.1\"\n+  implementation \"io.opentelemetry:opentelemetry-proto:0.10.0-SNAPSHOT\"\n+  implementation \"io.opentelemetry:opentelemetry-extension-auto-annotations:0.10.0-SNAPSHOT\"", "originalCommit": "8825e08d0bf725057490f42275de6e42e441eac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd41c06d005e81555cfb106d77aa0f8f1438797a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bd41c06d005e81555cfb106d77aa0f8f1438797a", "message": "Revert silliness", "committedDate": "2020-10-26T23:43:06Z", "type": "commit"}, {"oid": "3da08e5e3ddfaf6a16f34b1f865ce1740a104f4a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3da08e5e3ddfaf6a16f34b1f865ce1740a104f4a", "message": "Remove unnecessary repos too", "committedDate": "2020-10-27T00:04:21Z", "type": "commit"}, {"oid": "c22fae7b46faef644b0280107f847bfe9d91bdc1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c22fae7b46faef644b0280107f847bfe9d91bdc1", "message": "Restore external-annotations muzzle", "committedDate": "2020-10-27T01:59:35Z", "type": "commit"}]}