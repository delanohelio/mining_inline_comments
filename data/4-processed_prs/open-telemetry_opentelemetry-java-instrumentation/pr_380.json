{"pr_number": 380, "pr_title": "Add documentation about java agent structure and related classloaders", "pr_createdAt": "2020-05-05T13:01:34Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380", "timeline": [{"oid": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/429118612ba1da32ac6ee1a0d65895e44673d5ab", "message": "Add documentation about java agent structure and related classloaders", "committedDate": "2020-05-05T12:59:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUzMTg3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380#discussion_r420531873", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.\n          \n          \n            \n            OpenTelemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.", "author": "trask", "createdAt": "2020-05-06T03:55:33Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -8,6 +8,53 @@ In order to fully build and test this whole repository you need the following:\n * Java 8 should be set as default: `java -version` should give you version 8.\n * Defined environment variables `JAVA_8_HOME` and `JAVA_9_HOME` which point to the corresponding java homes. \n \n+### Plugin structure\n+Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.", "originalCommit": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUzMjAzMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380#discussion_r420532032", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            His sole responsibility is to push agent's classes into JVM's bootstrap classloader \n          \n          \n            \n            Its sole responsibility is to push agent's classes into JVM's bootstrap classloader", "author": "trask", "createdAt": "2020-05-06T03:56:16Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -8,6 +8,53 @@ In order to fully build and test this whole repository you need the following:\n * Java 8 should be set as default: `java -version` should give you version 8.\n * Defined environment variables `JAVA_8_HOME` and `JAVA_9_HOME` which point to the corresponding java homes. \n \n+### Plugin structure\n+Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.\n+\n+#### `java-agent` module\n+This module consists of single class `io.opentelemetry.auto.bootstrap.AgentBootstrap` \n+which implements [Java instrumentation agent](https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html).\n+This class is loaded during application startup by application classloader. \n+His sole responsibility is to push agent's classes into JVM's bootstrap classloader ", "originalCommit": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUzMjMzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380#discussion_r420532336", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            and immediately delegate to `io.opentelemetry.auto.bootstrap.Agent` class from there.\n          \n          \n            \n            and immediately delegate to `io.opentelemetry.auto.bootstrap.Agent` (now in the bootstrap class loader) class from there.", "author": "trask", "createdAt": "2020-05-06T03:57:53Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -8,6 +8,53 @@ In order to fully build and test this whole repository you need the following:\n * Java 8 should be set as default: `java -version` should give you version 8.\n * Defined environment variables `JAVA_8_HOME` and `JAVA_9_HOME` which point to the corresponding java homes. \n \n+### Plugin structure\n+Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.\n+\n+#### `java-agent` module\n+This module consists of single class `io.opentelemetry.auto.bootstrap.AgentBootstrap` \n+which implements [Java instrumentation agent](https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html).\n+This class is loaded during application startup by application classloader. \n+His sole responsibility is to push agent's classes into JVM's bootstrap classloader \n+and immediately delegate to `io.opentelemetry.auto.bootstrap.Agent` class from there.", "originalCommit": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUzMzAxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380#discussion_r420533013", "bodyText": "not totally sure about this suggestion\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * When `io.opentelemetry.auto.bootstrap.Agent` starts instrumentation agent, \n          \n          \n            \n            * When `io.opentelemetry.auto.bootstrap.Agent` starts up,", "author": "trask", "createdAt": "2020-05-06T04:01:01Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -8,6 +8,53 @@ In order to fully build and test this whole repository you need the following:\n * Java 8 should be set as default: `java -version` should give you version 8.\n * Defined environment variables `JAVA_8_HOME` and `JAVA_9_HOME` which point to the corresponding java homes. \n \n+### Plugin structure\n+Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.\n+\n+#### `java-agent` module\n+This module consists of single class `io.opentelemetry.auto.bootstrap.AgentBootstrap` \n+which implements [Java instrumentation agent](https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html).\n+This class is loaded during application startup by application classloader. \n+His sole responsibility is to push agent's classes into JVM's bootstrap classloader \n+and immediately delegate to `io.opentelemetry.auto.bootstrap.Agent` class from there.\n+\n+#### `agent-bootstrap` module\n+This module contains support classes for actual instrumentations to be loaded later and separately. \n+These classes should be available from all possible classloaders in the running application. \n+For this reason `java-agent` puts all these classes into JVM's bootstrap classloader.\n+For the same reason this module should be as small as possible and have as few dependencies as possible. \n+Otherwise, there is a risk of accidentally exposing this classes to the actual application.\n+\n+#### `agent-tooling` module and `instrumentation` submodules\n+Contains everything necessary to make instrumentation machinery work, \n+including integration with [ByteBuddy](https://bytebuddy.net/) and actual library-specific instrumentations. \n+As these classes depend on many classes from different libraries, \n+it is paramount to hide all these classes from the host application. \n+This is achieved in the following way:\n+* When `java-agent` module builds the final agent, it moves all classes from `instrumentation` submodules \n+and `agent-tooling` module into a separate folder inside final jar file, called `auto-tooling-and-instrumentation.isolated`. \n+In addition, the extension of all class files is changed from `class` to `classdata`. \n+This ensures that general classloaders cannot find nor load these classes.\n+* When `io.opentelemetry.auto.bootstrap.Agent` starts instrumentation agent, ", "originalCommit": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUzMzM4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380#discussion_r420533386", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            and lets it install all instrumentations with the help of ByteBuddy.\n          \n          \n            \n            and then passes control on to the `AgentInstaller` (now in the `AgentClassLoader`). The `AgentInstaller` then installs all of the instrumentations with the help of ByteBuddy.", "author": "trask", "createdAt": "2020-05-06T04:02:47Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -8,6 +8,53 @@ In order to fully build and test this whole repository you need the following:\n * Java 8 should be set as default: `java -version` should give you version 8.\n * Defined environment variables `JAVA_8_HOME` and `JAVA_9_HOME` which point to the corresponding java homes. \n \n+### Plugin structure\n+Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.\n+\n+#### `java-agent` module\n+This module consists of single class `io.opentelemetry.auto.bootstrap.AgentBootstrap` \n+which implements [Java instrumentation agent](https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html).\n+This class is loaded during application startup by application classloader. \n+His sole responsibility is to push agent's classes into JVM's bootstrap classloader \n+and immediately delegate to `io.opentelemetry.auto.bootstrap.Agent` class from there.\n+\n+#### `agent-bootstrap` module\n+This module contains support classes for actual instrumentations to be loaded later and separately. \n+These classes should be available from all possible classloaders in the running application. \n+For this reason `java-agent` puts all these classes into JVM's bootstrap classloader.\n+For the same reason this module should be as small as possible and have as few dependencies as possible. \n+Otherwise, there is a risk of accidentally exposing this classes to the actual application.\n+\n+#### `agent-tooling` module and `instrumentation` submodules\n+Contains everything necessary to make instrumentation machinery work, \n+including integration with [ByteBuddy](https://bytebuddy.net/) and actual library-specific instrumentations. \n+As these classes depend on many classes from different libraries, \n+it is paramount to hide all these classes from the host application. \n+This is achieved in the following way:\n+* When `java-agent` module builds the final agent, it moves all classes from `instrumentation` submodules \n+and `agent-tooling` module into a separate folder inside final jar file, called `auto-tooling-and-instrumentation.isolated`. \n+In addition, the extension of all class files is changed from `class` to `classdata`. \n+This ensures that general classloaders cannot find nor load these classes.\n+* When `io.opentelemetry.auto.bootstrap.Agent` starts instrumentation agent, \n+it creates an instance of `io.opentelemetry.auto.bootstrap.AgentClassLoader`, \n+loads an `io.opentelemetry.auto.tooling.AgentInstaller` from that `AgentClassLoader` \n+and lets it install all instrumentations with the help of ByteBuddy.", "originalCommit": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUzMzUwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380#discussion_r420533501", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Including Open Telemetry SDK.\n          \n          \n            \n            Including OpenTelemetry SDK.", "author": "trask", "createdAt": "2020-05-06T04:03:23Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -8,6 +8,53 @@ In order to fully build and test this whole repository you need the following:\n * Java 8 should be set as default: `java -version` should give you version 8.\n * Defined environment variables `JAVA_8_HOME` and `JAVA_9_HOME` which point to the corresponding java homes. \n \n+### Plugin structure\n+Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.\n+\n+#### `java-agent` module\n+This module consists of single class `io.opentelemetry.auto.bootstrap.AgentBootstrap` \n+which implements [Java instrumentation agent](https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html).\n+This class is loaded during application startup by application classloader. \n+His sole responsibility is to push agent's classes into JVM's bootstrap classloader \n+and immediately delegate to `io.opentelemetry.auto.bootstrap.Agent` class from there.\n+\n+#### `agent-bootstrap` module\n+This module contains support classes for actual instrumentations to be loaded later and separately. \n+These classes should be available from all possible classloaders in the running application. \n+For this reason `java-agent` puts all these classes into JVM's bootstrap classloader.\n+For the same reason this module should be as small as possible and have as few dependencies as possible. \n+Otherwise, there is a risk of accidentally exposing this classes to the actual application.\n+\n+#### `agent-tooling` module and `instrumentation` submodules\n+Contains everything necessary to make instrumentation machinery work, \n+including integration with [ByteBuddy](https://bytebuddy.net/) and actual library-specific instrumentations. \n+As these classes depend on many classes from different libraries, \n+it is paramount to hide all these classes from the host application. \n+This is achieved in the following way:\n+* When `java-agent` module builds the final agent, it moves all classes from `instrumentation` submodules \n+and `agent-tooling` module into a separate folder inside final jar file, called `auto-tooling-and-instrumentation.isolated`. \n+In addition, the extension of all class files is changed from `class` to `classdata`. \n+This ensures that general classloaders cannot find nor load these classes.\n+* When `io.opentelemetry.auto.bootstrap.Agent` starts instrumentation agent, \n+it creates an instance of `io.opentelemetry.auto.bootstrap.AgentClassLoader`, \n+loads an `io.opentelemetry.auto.tooling.AgentInstaller` from that `AgentClassLoader` \n+and lets it install all instrumentations with the help of ByteBuddy.\n+\n+The complicated process above ensures that the majority of auto-instrumentation agent's classes\n+are totally isolated from application classes, \n+and an instrumented class from arbitrary classloader in JVM can still access helper classes from bootstrap classloader.\n+\n+#### Agent jar structure\n+If you now look inside `java-agent/build/libs/opentelemetry-auto-<version>.jar`, \n+you will see the following \"clusters\" of classes:\n+* `auto-tooling-and-instrumentation.isolated/` - contains `agent-tooling` module and \n+`instrumentation` submodules, loaded and isolated inside `AgentClassLoader`. \n+Including Open Telemetry SDK.", "originalCommit": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUzMzU4NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/380#discussion_r420533584", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * `io/opentelemetry/auto/shaded/` - contains Open Telemetry API and its dependencies. \n          \n          \n            \n            * `io/opentelemetry/auto/shaded/` - contains OpenTelemetry API and its dependencies.", "author": "trask", "createdAt": "2020-05-06T04:03:47Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -8,6 +8,53 @@ In order to fully build and test this whole repository you need the following:\n * Java 8 should be set as default: `java -version` should give you version 8.\n * Defined environment variables `JAVA_8_HOME` and `JAVA_9_HOME` which point to the corresponding java homes. \n \n+### Plugin structure\n+Open Telemetry Auto Instrumentation java agent's jar can logically be divided into 3 parts.\n+\n+#### `java-agent` module\n+This module consists of single class `io.opentelemetry.auto.bootstrap.AgentBootstrap` \n+which implements [Java instrumentation agent](https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html).\n+This class is loaded during application startup by application classloader. \n+His sole responsibility is to push agent's classes into JVM's bootstrap classloader \n+and immediately delegate to `io.opentelemetry.auto.bootstrap.Agent` class from there.\n+\n+#### `agent-bootstrap` module\n+This module contains support classes for actual instrumentations to be loaded later and separately. \n+These classes should be available from all possible classloaders in the running application. \n+For this reason `java-agent` puts all these classes into JVM's bootstrap classloader.\n+For the same reason this module should be as small as possible and have as few dependencies as possible. \n+Otherwise, there is a risk of accidentally exposing this classes to the actual application.\n+\n+#### `agent-tooling` module and `instrumentation` submodules\n+Contains everything necessary to make instrumentation machinery work, \n+including integration with [ByteBuddy](https://bytebuddy.net/) and actual library-specific instrumentations. \n+As these classes depend on many classes from different libraries, \n+it is paramount to hide all these classes from the host application. \n+This is achieved in the following way:\n+* When `java-agent` module builds the final agent, it moves all classes from `instrumentation` submodules \n+and `agent-tooling` module into a separate folder inside final jar file, called `auto-tooling-and-instrumentation.isolated`. \n+In addition, the extension of all class files is changed from `class` to `classdata`. \n+This ensures that general classloaders cannot find nor load these classes.\n+* When `io.opentelemetry.auto.bootstrap.Agent` starts instrumentation agent, \n+it creates an instance of `io.opentelemetry.auto.bootstrap.AgentClassLoader`, \n+loads an `io.opentelemetry.auto.tooling.AgentInstaller` from that `AgentClassLoader` \n+and lets it install all instrumentations with the help of ByteBuddy.\n+\n+The complicated process above ensures that the majority of auto-instrumentation agent's classes\n+are totally isolated from application classes, \n+and an instrumented class from arbitrary classloader in JVM can still access helper classes from bootstrap classloader.\n+\n+#### Agent jar structure\n+If you now look inside `java-agent/build/libs/opentelemetry-auto-<version>.jar`, \n+you will see the following \"clusters\" of classes:\n+* `auto-tooling-and-instrumentation.isolated/` - contains `agent-tooling` module and \n+`instrumentation` submodules, loaded and isolated inside `AgentClassLoader`. \n+Including Open Telemetry SDK.\n+* `io/opentelemetry/auto/bootstrap/` - contains `agent-bootstrap` module and available in\n+bootstrap classloader.\n+* `io/opentelemetry/auto/shaded/` - contains Open Telemetry API and its dependencies. ", "originalCommit": "429118612ba1da32ac6ee1a0d65895e44673d5ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5fb0a2e58a5109afdb4a126a509c33f5253ea4c7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5fb0a2e58a5109afdb4a126a509c33f5253ea4c7", "message": "Apply suggestions from code review\n\nCo-authored-by: Trask Stalnaker <trask.stalnaker@gmail.com>", "committedDate": "2020-05-06T04:39:32Z", "type": "commit"}, {"oid": "83b835d45694e63f5802e44ca490cecf0551a9fb", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/83b835d45694e63f5802e44ca490cecf0551a9fb", "message": "Merge branch 'master' into documentation", "committedDate": "2020-05-06T16:49:19Z", "type": "commit"}]}