{"pr_number": 813, "pr_title": "Use Span.recordException for logging throwable", "pr_createdAt": "2020-07-27T10:10:44Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813", "timeline": [{"oid": "b5ba3af43c98b601cc38e0d4d4fcc75e7a56f971", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b5ba3af43c98b601cc38e0d4d4fcc75e7a56f971", "message": "Use Span.recordException", "committedDate": "2020-07-27T08:01:11Z", "type": "commit"}, {"oid": "20598318d7d336e4c68d032e38d93cedef0d796d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/20598318d7d336e4c68d032e38d93cedef0d796d", "message": "Fix tests", "committedDate": "2020-07-27T10:11:37Z", "type": "commit"}, {"oid": "20598318d7d336e4c68d032e38d93cedef0d796d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/20598318d7d336e4c68d032e38d93cedef0d796d", "message": "Fix tests", "committedDate": "2020-07-27T10:11:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzMTIxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r460831217", "bodyText": "Why not usual errorEvent?", "author": "iNikem", "createdAt": "2020-07-27T11:42:47Z", "path": "instrumentation/jsp-2.3/src/test/groovy/JSPInstrumentationBasicTests.groovy", "diffHunk": "@@ -282,6 +282,18 @@ class JSPInstrumentationBasicTests extends AgentTestRunner {\n           operationName expectedOperationName()\n           spanKind SERVER\n           errored true\n+          event(0) {\n+            eventName(SemanticAttributes.EXCEPTION_EVENT_NAME)", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5Nzg2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461297863", "bodyText": "The assertions are more complex not just matching", "author": "anuraaga", "createdAt": "2020-07-28T03:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzMTIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzMjYxMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r460832612", "bodyText": "If this is false, how can the if on line 128 be ever true?", "author": "iNikem", "createdAt": "2020-07-27T11:45:43Z", "path": "instrumentation/ratpack-1.4/src/test/groovy/server/RatpackHttpServerTest.groovy", "diffHunk": "@@ -137,4 +135,11 @@ class RatpackHttpServerTest extends HttpServerTest<EmbeddedApp> {\n   String expectedServerSpanName(String method, ServerEndpoint endpoint) {\n     return endpoint.status == 404 ? \"/\" : endpoint == PATH_PARAM ? \"/path/:id/param\" : endpoint.path\n   }\n+\n+  @Override\n+  boolean testException() {\n+    // TODO(anuraaga): We record exception both in the ratpack controller and in the error handler.\n+    // Do we need the latter? https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/810\n+    return false", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5ODI1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461298254", "bodyText": "It can't - but I would remove that if along with the TODO if this can't ever be fixed, similar to all the tests I've only supressed the exception cases for further debugging.", "author": "anuraaga", "createdAt": "2020-07-28T03:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzMjYxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNDI4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r460834283", "bodyText": "Why was this just removed?", "author": "iNikem", "createdAt": "2020-07-27T11:49:10Z", "path": "instrumentation/google-http-client-1.19/src/main/java/io/opentelemetry/auto/instrumentation/googlehttpclient/GoogleHttpClientInstrumentation.java", "diffHunk": "@@ -143,7 +142,6 @@ public static void methodExit(\n           // for a failed request.  Thus, check the response code\n           if (response != null && !response.isSuccessStatusCode()) {\n             span.setStatus(Status.UNKNOWN);\n-            span.setAttribute(MoreAttributes.ERROR_MSG, response.getStatusMessage());", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5NzcxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461297710", "bodyText": "This is setting an HTTP response as an error tag, but our new convention is only about exceptions, not HTTP status line. Keeping this would be confusing wrt to our other tags.", "author": "anuraaga", "createdAt": "2020-07-28T03:37:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNDI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4OTUyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461289523", "bodyText": "\ud83c\udf89", "author": "trask", "createdAt": "2020-07-28T03:04:02Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "diffHunk": "@@ -114,12 +111,7 @@ public static void setPeer(final Span span, String peerName, String peerIp) {\n   }\n \n   public static void addThrowable(final Span span, final Throwable throwable) {\n-    span.setAttribute(MoreAttributes.ERROR_MSG, throwable.getMessage());\n-    span.setAttribute(MoreAttributes.ERROR_TYPE, throwable.getClass().getName());\n-\n-    StringWriter errorString = new StringWriter();\n-    throwable.printStackTrace(new PrintWriter(errorString));\n-    span.setAttribute(MoreAttributes.ERROR_STACK, errorString.toString());\n+    span.recordException(throwable);", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5MDE1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461290157", "bodyText": "\ud83d\udc4d", "author": "trask", "createdAt": "2020-07-28T03:06:24Z", "path": "instrumentation/grizzly-2.0/src/test/groovy/GrizzlyTest.groovy", "diffHunk": "@@ -111,4 +111,10 @@ class GrizzlyTest extends HttpServerTest<HttpServer> {\n   String expectedServerSpanName(String method, ServerEndpoint endpoint) {\n     return \"HttpCodecFilter.handleRead\"\n   }\n+\n+  @Override\n+  boolean testException() {\n+    // TODO(anuraaga): https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/807", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5MDQyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461290421", "bodyText": "no replacement for this?", "author": "trask", "createdAt": "2020-07-28T03:07:28Z", "path": "instrumentation/dropwizard-testing/src/test/groovy/DropwizardTest.groovy", "diffHunk": "@@ -126,11 +124,6 @@ class DropwizardTest extends HttpServerTest<DropwizardTestSupport> {\n         \"${SemanticAttributes.HTTP_RESPONSE_CONTENT_LENGTH.key()}\" { it == responseContentLength || /* async */ it == null }\n         \"servlet.context\" \"\"\n         \"servlet.path\" \"\"\n-        if (endpoint.errored) {\n-          \"error.msg\" { it == null || it == EXCEPTION.body }\n-          \"error.type\" { it == null || it == Exception.name }\n-          \"error.stack\" { it == null || it instanceof String }\n-        }", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5NzUzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461297536", "bodyText": "Don't think so - the exception is recorded in the handler span so isn't on this one. Not sure if this is an issue with the instrumentation or expected though.", "author": "anuraaga", "createdAt": "2020-07-28T03:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5MDQyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5OTc4OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461299789", "bodyText": "ah, makes sense, i think this is expected", "author": "trask", "createdAt": "2020-07-28T03:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5MDQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5Mjk5MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461292990", "bodyText": "just helping with the future search \ud83d\ude04\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/807\n          \n          \n            \n                // TODO(anuraaga): https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/807", "author": "trask", "createdAt": "2020-07-28T03:17:55Z", "path": "instrumentation/vertx-reactive-3.5/src/test/groovy/server/VertxRxHttpServerTest.groovy", "diffHunk": "@@ -68,6 +68,12 @@ class VertxRxHttpServerTest extends HttpServerTest<Vertx> {\n     return false\n   }\n \n+  @Override\n+  boolean testException() {\n+    // https://github.com/open-telemetry/opentelemetry-java-instrumentation/issues/807", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5NDE5OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461294199", "bodyText": "there are a few places that look like they could use errorEvent", "author": "trask", "createdAt": "2020-07-28T03:22:58Z", "path": "instrumentation/netty/netty-3.8/src/latestDepTest/groovy/Netty38ClientTest.groovy", "diffHunk": "@@ -97,17 +98,19 @@ class Netty38ClientTest extends HttpClientTest {\n           operationName \"CONNECT\"\n           childOf span(0)\n           errored true\n-          attributes {\n-            Class errorClass = ConnectException\n-            try {\n-              errorClass = Class.forName('io.netty.channel.AbstractChannel$AnnotatedConnectException')\n-            } catch (ClassNotFoundException e) {\n-              // Older versions use 'java.net.ConnectException' and do not have 'io.netty.channel.AbstractChannel$AnnotatedConnectException'\n+          Class errorClass = ConnectException\n+          try {\n+            errorClass = Class.forName('io.netty.channel.AbstractChannel$AnnotatedConnectException')\n+          } catch (ClassNotFoundException e) {\n+            // Older versions use 'java.net.ConnectException' and do not have 'io.netty.channel.AbstractChannel$AnnotatedConnectException'\n+          }\n+          event(0) {\n+            eventName(SemanticAttributes.EXCEPTION_EVENT_NAME)\n+            attributes {\n+              \"${SemanticAttributes.EXCEPTION_TYPE.key()}\" errorClass.name\n+              \"${SemanticAttributes.EXCEPTION_MESSAGE.key()}\" ~/Connection refused:( no further information:)? \\/127.0.0.1:$UNUSABLE_PORT/\n+              \"${SemanticAttributes.EXCEPTION_STACKTRACE.key()}\" String", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5ODAxNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461298014", "bodyText": "This one's because the message is matched using regex. I could make errorevent more powerful but didn't find enough of these places to warrant it yet.", "author": "anuraaga", "createdAt": "2020-07-28T03:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5NDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwMDE4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461300181", "bodyText": "it looks like you are using errorEvent in other places with regex?", "author": "trask", "createdAt": "2020-07-28T03:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5NDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMwMTQ5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461301497", "bodyText": "Ah didn't even notice - message is the only one in my function without a type parameter mostly by accident :D Yeah I'll use it then", "author": "anuraaga", "createdAt": "2020-07-28T03:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5NDE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI5ODU2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461298567", "bodyText": "This one I'll update", "author": "anuraaga", "createdAt": "2020-07-28T03:40:42Z", "path": "testing-common/src/main/groovy/io/opentelemetry/auto/test/base/HttpServerTest.groovy", "diffHunk": "@@ -464,6 +462,16 @@ abstract class HttpServerTest<SERVER> extends AgentTestRunner {\n       } else {\n         parent()\n       }\n+      if (endpoint == EXCEPTION && !hasHandlerSpan()) {\n+        event(0) {\n+          eventName(SemanticAttributes.EXCEPTION_EVENT_NAME)\n+          attributes {\n+            \"${SemanticAttributes.EXCEPTION_TYPE.key()}\" { it == null || it == Exception.name }", "originalCommit": "20598318d7d336e4c68d032e38d93cedef0d796d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb53d5144150771cf87bb35e94f581a7b2c8df32", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bb53d5144150771cf87bb35e94f581a7b2c8df32", "message": "Cleanup", "committedDate": "2020-07-28T04:47:47Z", "type": "commit"}, {"oid": "1da01baea851585aaec4749f7d453b7dfc2f0fa4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1da01baea851585aaec4749f7d453b7dfc2f0fa4", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into use-record-exception", "committedDate": "2020-07-28T04:49:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMxOTI1OA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/813#discussion_r461319258", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // having this set allows us to test with old verseions of the tomcat api since\n          \n          \n            \n                // having this set allows us to test with old versions of the tomcat api since", "author": "trask", "createdAt": "2020-07-28T05:01:42Z", "path": "instrumentation/jsp-2.3/src/test/groovy/JSPInstrumentationBasicTests.groovy", "diffHunk": "@@ -38,7 +38,7 @@ class JSPInstrumentationBasicTests extends AgentTestRunner {\n   static {\n     // skip jar scanning using environment variables:\n     // http://tomcat.apache.org/tomcat-7.0-doc/config/systemprops.html#JAR_Scanning\n-    // having this set allows us to test with old versions of the tomcat api since\n+    // having this set allows us to test with old verseions of the tomcat api since", "originalCommit": "bb53d5144150771cf87bb35e94f581a7b2c8df32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90c20e9443208930e30311bee09b388a1253beca", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/90c20e9443208930e30311bee09b388a1253beca", "message": "Update instrumentation/jsp-2.3/src/test/groovy/JSPInstrumentationBasicTests.groovy\n\nCo-authored-by: Trask Stalnaker <trask.stalnaker@gmail.com>", "committedDate": "2020-07-28T05:05:17Z", "type": "commit"}, {"oid": "fcf849d0d974ca4de8dd8648ff1b03a3fd0032f5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fcf849d0d974ca4de8dd8648ff1b03a3fd0032f5", "message": "Spotless (IntelliJ acts weird with groovy files for me :()", "committedDate": "2020-07-28T05:08:10Z", "type": "commit"}, {"oid": "a154bc62bdc3c14e43c97accad6c6dcfa93ccf77", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a154bc62bdc3c14e43c97accad6c6dcfa93ccf77", "message": "Merge branch 'use-record-exception' of github.com:anuraaga/opentelemetry-auto-instr-java into use-record-exception", "committedDate": "2020-07-28T05:09:09Z", "type": "commit"}, {"oid": "d8a96cc6301d1fad5d2a9e0799cb923543dd784a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d8a96cc6301d1fad5d2a9e0799cb923543dd784a", "message": "Update for merge", "committedDate": "2020-07-28T05:27:23Z", "type": "commit"}]}