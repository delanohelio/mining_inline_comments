{"pr_number": 1403, "pr_title": "ipv6 support for modified-URL-like", "pr_createdAt": "2020-10-16T11:33:52Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403", "timeline": [{"oid": "4e4d618e6993d18a585a70ac661f67304da365d6", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4e4d618e6993d18a585a70ac661f67304da365d6", "message": "ipv6 support for modified-URL-like", "committedDate": "2020-10-16T11:30:25Z", "type": "commit"}, {"oid": "95650a2a45c0069d31b58396793c32fbf1122104", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/95650a2a45c0069d31b58396793c32fbf1122104", "message": "add a \"pure\" v6 address to the tests", "committedDate": "2020-10-16T12:30:22Z", "type": "commit"}, {"oid": "72c56b6e8eec78a15c19a81086375af0ebc1510d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/72c56b6e8eec78a15c19a81086375af0ebc1510d", "message": "wrap the regex pattern", "committedDate": "2020-10-16T12:39:34Z", "type": "commit"}, {"oid": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/83e3c1f4eeefc42d83def6d2a2670f68fa4223ab", "message": "individually comment the regex parts", "committedDate": "2020-10-16T14:11:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507491503", "bodyText": "There cannot be port in this case?", "author": "iNikem", "createdAt": "2020-10-19T06:09:39Z", "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "diffHunk": "@@ -159,7 +188,19 @@\n         serverName = serverName.substring(0, instanceLoc);\n       }\n \n-      int portLoc = serverName.indexOf(\":\");\n+      Matcher ipv6Matcher = IPv6.matcher(serverName);\n+      boolean isIpv6 = ipv6Matcher.find();\n+\n+      int portLoc = -1;\n+      if (isIpv6) {\n+        if (serverName.startsWith(\"[\")) {\n+          portLoc = serverName.indexOf(\"]:\") + 1;\n+        } else {\n+          serverName = \"[\" + serverName + \"]\";", "originalCommit": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU1ODcwMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507558702", "bodyText": "There isn't one, but because the shortUrl contains the port number, it needs to be formatted that way\nshortUrl example sqlserver://[2001:0db8:85a3:0000:0000:8a2e:0370:7334]:1433.\nI'm now thinking though, whether this is not appropriate for the host attribute i.e. [2001:0db8:85a3:0000:0000:8a2e:0370:7334]. What do you think?\nBy the way, the mariadb test is partially incorrect because it includes the port as part of the shortUrl\nEDIT\nFor\n\"jdbc:mariadb:loadbalance://[2001:0660:7401:0200:0000:0000:0edf:bdd7]:33,mdb.host/mdbdb\"\n\nshortUrl becomes\n\"mariadb:loadbalance://2001:0660:7401:0200:0000:0000:0edf:bdd7:33\"", "author": "imavroukakis", "createdAt": "2020-10-19T08:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MzgwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507683809", "bodyText": "You lost me :) I am not proficient with ip6 formats. I just see:\nif (serverName.startsWith(\"[\")) {\n   portLoc = XXX\n} else {\n  serverName = \"[\" + serverName + \"]\";\n}\n\nand wonder, why if serverName does not start with [, then it means there is no port?", "author": "iNikem", "createdAt": "2020-10-19T11:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzczNzU0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507737540", "bodyText": "Apologies, I went neck-deep into IPv6 land. Yes, since : is a delimiter for the IPv6 parts, the only way to define a port in a URL/URI-like manner, is to wrap the address in [-] and then append the port with a :\nDoes this make sense, especially with regards to my point about the MariaDB tests?", "author": "imavroukakis", "createdAt": "2020-10-19T13:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc0Njc4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507746787", "bodyText": "Clarification, when I say\n\nthe only way to define a port in a URL/URI-like manner\n\n, I should have said instead, \"the only unambigious way to define a port in a URL/URI-like manner\"", "author": "imavroukakis", "createdAt": "2020-10-19T13:29:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5ODMzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507798338", "bodyText": "I see. I have left a comment in #1421, but that is a separate issue.", "author": "iNikem", "createdAt": "2020-10-19T14:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}], "type": "inlineReview"}]}