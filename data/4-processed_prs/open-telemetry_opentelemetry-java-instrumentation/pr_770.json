{"pr_number": 770, "pr_title": "Run tests using JUnit5 platform and remove SpockRunner", "pr_createdAt": "2020-07-23T09:10:58Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770", "timeline": [{"oid": "ca6e7173242d67bd4064f49b82f105acfd0bbd72", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ca6e7173242d67bd4064f49b82f105acfd0bbd72", "message": "Run tests using JUnit5 platform", "committedDate": "2020-07-23T09:03:34Z", "type": "forcePushed"}, {"oid": "d5549e2b172643ad27768e6fca49694550931eb3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d5549e2b172643ad27768e6fca49694550931eb3", "message": "Run tests with JUnit platform", "committedDate": "2020-08-03T08:47:53Z", "type": "commit"}, {"oid": "d5549e2b172643ad27768e6fca49694550931eb3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d5549e2b172643ad27768e6fca49694550931eb3", "message": "Run tests with JUnit platform", "committedDate": "2020-08-03T08:47:53Z", "type": "forcePushed"}, {"oid": "4a8ba9a92ca943032e1d890f4f5bb13e86efccf4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4a8ba9a92ca943032e1d890f4f5bb13e86efccf4", "message": "Matcher", "committedDate": "2020-08-03T08:52:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3OTc5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r464279797", "bodyText": "In this PR PlayJavaWEClientTest fails because of invalid header name characters (space) which looks correct to me... The Play tests have a couple other assertions that fail (TimeoutException vs ConnectException) that seem similarly like they should be failing, as if on current master we're not actually running these tests so I need to investigate more what's going on...", "author": "anuraaga", "createdAt": "2020-08-03T08:52:43Z", "path": "testing-common/src/main/groovy/io/opentelemetry/auto/test/base/HttpClientTest.groovy", "diffHunk": "@@ -42,7 +42,7 @@ import static org.junit.Assume.assumeTrue\n abstract class HttpClientTest extends AgentTestRunner {\n   protected static final BODY_METHODS = [\"POST\", \"PUT\"]\n   protected static final CONNECT_TIMEOUT_MS = 1000\n-  protected static final BASIC_AUTH_KEY = \"custom authorization header\"\n+  protected static final BASIC_AUTH_KEY = \"custom-authorization-header\"", "originalCommit": "d5549e2b172643ad27768e6fca49694550931eb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY2NjEzNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r469666137", "bodyText": "as if on current master we're not actually running these tests\n\noh, wow, they were not, before this PR!!!\ncc: @tylerbenson", "author": "trask", "createdAt": "2020-08-13T02:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3OTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2Mzk4NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r470063984", "bodyText": "@anuraaga could you elaborate... which task isn't failing that should be?  Any idea why they aren't being executed?", "author": "tylerbenson", "createdAt": "2020-08-13T16:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3OTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDEzNjgxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r470136813", "bodyText": "I didn't end up digging on the why, but I think it was this test that started failing with this PR\nhttps://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/874b157fe5fdaad80fd82f3ece0600b6860924e7/instrumentation/play-ws/play-ws-2.1/src/test/groovy/PlayWSClientTest.groovy\nNetty threw a validation error because of the spaces in this header name which seems right to me.", "author": "anuraaga", "createdAt": "2020-08-13T17:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3OTc5Nw=="}], "type": "inlineReview"}, {"oid": "b0cb3396b643816e1847b682f136e14a7e7b5c14", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b0cb3396b643816e1847b682f136e14a7e7b5c14", "message": "Restore", "committedDate": "2020-08-03T09:16:04Z", "type": "commit"}, {"oid": "c70bd27cee544542dec733e367ae65f07ba1dd39", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c70bd27cee544542dec733e367ae65f07ba1dd39", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform", "committedDate": "2020-08-04T05:28:22Z", "type": "commit"}, {"oid": "29cb1fc8a446d21038c4c3b3a396606e7006a6ae", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/29cb1fc8a446d21038c4c3b3a396606e7006a6ae", "message": "Don't mix JUnit4 with JUunit5 in spring tests", "committedDate": "2020-08-04T05:35:08Z", "type": "commit"}, {"oid": "5dc18c14f3df6801698f4e1006bc20ac3a8288ec", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5dc18c14f3df6801698f4e1006bc20ac3a8288ec", "message": "Merge branch 'spring-no-mix-junit4' into junit-platform", "committedDate": "2020-08-04T05:40:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgyMjAxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r464822011", "bodyText": "@trask Yup! My biggest concern right now is this test, not sure why it's not passing with JUnit5. The issues with assumeTrue I'll need to file an issue with JUnit team for.", "author": "anuraaga", "createdAt": "2020-08-04T06:13:39Z", "path": "agent-tooling/src/test/groovy/io/opentelemetry/auto/test/HelperInjectionTest.groovy", "diffHunk": "@@ -33,13 +32,15 @@ import java.util.concurrent.atomic.AtomicReference\n import static io.opentelemetry.auto.test.utils.ClasspathUtils.isClassLoaded\n import static io.opentelemetry.auto.tooling.ClassLoaderMatcher.BOOTSTRAP_CLASSLOADER\n import static io.opentelemetry.auto.util.gc.GCUtils.awaitGC\n+import static org.junit.Assume.assumeTrue\n \n class HelperInjectionTest extends AgentSpecification {\n \n   @Timeout(10)\n   def \"helpers injected to non-delegating classloader\"() {\n     setup:\n     String helperClassName = HelperInjectionTest.getPackage().getName() + '.HelperClass'\n+    assumeTrue(!isClassLoaded(helperClassName, Utils.getAgentClassLoader()))", "originalCommit": "5dc18c14f3df6801698f4e1006bc20ac3a8288ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f9521d6614c5eba2ba4e0b1d7b36d89d18ad00ea", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f9521d6614c5eba2ba4e0b1d7b36d89d18ad00ea", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform", "committedDate": "2020-08-04T06:20:49Z", "type": "commit"}, {"oid": "65e07fc651d5c4edae25d44602a3189d222715b7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/65e07fc651d5c4edae25d44602a3189d222715b7", "message": "Separate out tests that need custom class loader.", "committedDate": "2020-08-04T06:33:33Z", "type": "commit"}, {"oid": "c6b3540d9271d8f7862c2adf885b55eccf917642", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c6b3540d9271d8f7862c2adf885b55eccf917642", "message": "Separate out test for a couple classes that need it, try to remove SpockRunner, but Grizzly?", "committedDate": "2020-08-04T07:24:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1Mzc3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r464853770", "bodyText": "When I thought I finally had a good mental model of what's going on in our tests, a grizzly shows up \ud83d\udc3b\nI think one of the reasons a couple of test failed is because with JUnit5, there is no way to intercept class loading\njunit-team/junit5#201\nThis is a fundamental aspect of JUnit5 so presumably even when using the vintage engine, the limitation applies.\nI noticed only two tests in the entire repo actually seem to rely on this behavior though, so I gave them special treatment. At that point, it seemed SpockRunner doesn't actually do anything anymore, so I tried removing it completely. Everything worked, except for this one test.\n@trask if you feel like it, maybe you could look at this test without and with SpockRunner and teach me what function it's serving and why it would only affect this test :)", "author": "anuraaga", "createdAt": "2020-08-04T07:28:16Z", "path": "instrumentation/grizzly-client-1.9/src/test/groovy/GrizzlyAsyncHttpClientTest.groovy", "diffHunk": "@@ -20,10 +20,13 @@ import com.ning.http.client.Request\n import com.ning.http.client.RequestBuilder\n import com.ning.http.client.Response\n import com.ning.http.client.uri.Uri\n+import io.opentelemetry.auto.test.SpockRunner\n import io.opentelemetry.auto.test.base.HttpClientTest\n+import org.junit.runner.RunWith\n import spock.lang.AutoCleanup\n import spock.lang.Shared\n \n+@RunWith(SpockRunner)", "originalCommit": "c6b3540d9271d8f7862c2adf885b55eccf917642", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2Mjc0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r465462745", "bodyText": "Yeah, that's a tricky one...\nThere are two things conspiring against that test:\n\nthe test code itself gets instrumented, not only the library under test (GrizzlyAsyncHttpClientTest$AsyncCompletionHandlerMock)\nthe instrumentation that gets injected into that test code uses InstrumentationContext, and tries to put a null value into it\n\nBecause AsyncCompletionHandlerMock is a nested class inside of the test, it appears that class is loaded before we install bytebuddy, which means we can only retransform it, which means InstrumentationContext cannot use the (fast) field-backed provider, and instead has to use the WeakMap.\nThis is fine.\nBut then comes (2) and tries to put a null value into the WeakMap, which is what then causes the NPE.\nMoving AsyncCompletionHandlerMock out into a top-level class resolves the issue.\nI'll also open an issue about the WeakMap implementation not supporting null values, though in general we don't use the the WeakMap when running as -javaagent:..., since in that case we are typically able to do initial transform (not structure limited re-transform) and so we can inject a field into the class and use the field-backed provider.", "author": "trask", "createdAt": "2020-08-05T04:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1Mzc3MA=="}], "type": "inlineReview"}, {"oid": "fcc1d8f21e2b565c024f4b6941c62e152d9099cc", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fcc1d8f21e2b565c024f4b6941c62e152d9099cc", "message": "Remove SpockRunner", "committedDate": "2020-08-05T04:55:38Z", "type": "commit"}, {"oid": "9fae9f6daf6dc7455147efc13cb6b7bf3e5ccd6b", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9fae9f6daf6dc7455147efc13cb6b7bf3e5ccd6b", "message": "Fix grizzly", "committedDate": "2020-08-05T07:17:49Z", "type": "commit"}, {"oid": "2178f04b6c077aeac702c0ef89fa96c01e3f1dc9", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2178f04b6c077aeac702c0ef89fa96c01e3f1dc9", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform", "committedDate": "2020-08-06T08:59:54Z", "type": "commit"}, {"oid": "85b9d10aa1f6ef41b5443897167c820ae172d235", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/85b9d10aa1f6ef41b5443897167c820ae172d235", "message": "Remove assumeTrue workaround.", "committedDate": "2020-08-06T09:03:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTE1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466819150", "bodyText": "Do we need a milestone or current stable is enough?", "author": "iNikem", "createdAt": "2020-08-07T04:50:30Z", "path": "gradle/dependencies.gradle", "diffHunk": "@@ -24,6 +24,7 @@ ext {\n     kotlin            : \"1.3.72\",\n     coroutines        : \"1.3.0\",\n     springboot        : \"2.3.1.RELEASE\",\n+    junit5            : \"5.7.0-M1\",", "originalCommit": "85b9d10aa1f6ef41b5443897167c820ae172d235", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgyMDcwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466820700", "bodyText": "Yeah this milestone fixed a spock issue", "author": "anuraaga", "createdAt": "2020-08-07T04:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTI1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466819254", "bodyText": "Do we need both old and new engines?", "author": "iNikem", "createdAt": "2020-08-07T04:50:56Z", "path": "gradle/java.gradle", "diffHunk": "@@ -99,6 +99,12 @@ repositories {\n }\n \n dependencies {\n+  testImplementation enforcedPlatform(group: 'org.junit', name: 'junit-bom', version: versions.junit5)\n+  testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter-api'\n+  testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter-params'\n+  testRuntimeOnly group: 'org.junit.jupiter', name: 'junit-jupiter-engine'\n+  testRuntimeOnly group: 'org.junit.vintage', name: 'junit-vintage-engine'", "originalCommit": "85b9d10aa1f6ef41b5443897167c820ae172d235", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgyMDg2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466820869", "bodyText": "We need new engine for any Java tests, we have one PatchLoggerTest. If we get to Spock 2.0 we'll remove vintage at that point.", "author": "anuraaga", "createdAt": "2020-08-07T04:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTQ2NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466819465", "bodyText": "Why?", "author": "iNikem", "createdAt": "2020-08-07T04:51:41Z", "path": "instrumentation/annotations/annotations.gradle", "diffHunk": "@@ -28,3 +28,17 @@ dependencies {\n     transitive = false\n   }\n }\n+\n+test {\n+  filter {\n+    excludeTestsMatching 'TraceProvidersTest'\n+  }\n+}\n+\n+// Needs a fresh classloader.", "originalCommit": "85b9d10aa1f6ef41b5443897167c820ae172d235", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgyMDkwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466820900", "bodyText": "No clue :P Filed an issue", "author": "anuraaga", "createdAt": "2020-08-07T04:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTQ2NQ=="}], "type": "inlineReview"}, {"oid": "f02afd24e7477a35c5c7e0c2a9c1e857136d21b1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f02afd24e7477a35c5c7e0c2a9c1e857136d21b1", "message": "Comments", "committedDate": "2020-08-07T04:56:24Z", "type": "commit"}, {"oid": "298c7a00e2ba6e68128c2707071012c26d3cadf9", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/298c7a00e2ba6e68128c2707071012c26d3cadf9", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform", "committedDate": "2020-08-09T01:46:56Z", "type": "commit"}, {"oid": "bf2ba6646936ab7d6ffe0da42d5eb9b8ba6141fe", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bf2ba6646936ab7d6ffe0da42d5eb9b8ba6141fe", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform", "committedDate": "2020-08-11T11:25:16Z", "type": "commit"}]}