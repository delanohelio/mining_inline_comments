{"pr_number": 1987, "pr_title": "bot efficiency improvements; bug fixes", "pr_createdAt": "2020-06-03T00:41:50Z", "pr_url": "https://github.com/MegaMek/megamek/pull/1987", "timeline": [{"oid": "8d7daef42a0cb97f6b50ac8fff53c9fab4ce8ca6", "url": "https://github.com/MegaMek/megamek/commit/8d7daef42a0cb97f6b50ac8fff53c9fab4ce8ca6", "message": "cleanup and bug fixes", "committedDate": "2020-05-31T02:43:43Z", "type": "commit"}, {"oid": "a2d8c253dcac74fb5c04b3d024ee0ec33072c761", "url": "https://github.com/MegaMek/megamek/commit/a2d8c253dcac74fb5c04b3d024ee0ec33072c761", "message": "wheeled cluster fixes", "committedDate": "2020-06-02T00:55:47Z", "type": "commit"}, {"oid": "93a38bc8d32383f9ff2769820d15835b284b41e5", "url": "https://github.com/MegaMek/megamek/commit/93a38bc8d32383f9ff2769820d15835b284b41e5", "message": "Merge branch 'long_range_pathfinding' of https://github.com/NickAragua/megamek into efficiency_improvements", "committedDate": "2020-06-02T01:04:19Z", "type": "commit"}, {"oid": "45c06a5d978c8000ecf8e422b684ee9a393b12a0", "url": "https://github.com/MegaMek/megamek/commit/45c06a5d978c8000ecf8e422b684ee9a393b12a0", "message": "stop generating dumb paths", "committedDate": "2020-06-02T03:20:55Z", "type": "commit"}, {"oid": "b59a243e6be4b10b80eb01e51454b1a82724242c", "url": "https://github.com/MegaMek/megamek/commit/b59a243e6be4b10b80eb01e51454b1a82724242c", "message": "fix issues with jump paths; don't attack stupid targets", "committedDate": "2020-06-02T04:05:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3MzUxNA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r434273514", "bodyText": "Could we rename this to fitnessOfPathToEdge or something?", "author": "sixlettervariables", "createdAt": "2020-06-03T02:26:43Z", "path": "megamek/src/megamek/client/bot/BotClient.java", "diffHunk": "@@ -915,33 +920,30 @@ protected Coords getFirstValidCoords(Entity deployedUnit, List<Coords> possibleD\n         return result;\n     }\n \n-    /**\n-     * Gets the {@link BoardEdgePathFinder} for an {@link Entity} for their\n-     * current movement mode.\n-     * @param entity The entity to retrieve the {@link BoardEdgePathFinder}.\n-     * @return The appropriate {@link BoardEdgePathFinder} for the given entity.\n-     */\n-    private BoardEdgePathFinder getBoardEdgePathFinder(Entity entity) {\n-        return deploymentPathFinders.computeIfAbsent(entity.getMovementMode(), \n-            e -> new BoardEdgePathFinder());\n-    }\n-\n-    // ToDo: Change this to 'hasSafePathToCenter' to account for buildings, lava and similar hazards.\n     /**\n      * Determines if the given entity has a reasonable path to the \"opposite\" edge of the board from its\n-     * current position.\n-     * @param entity\n-     * @param board\n-     * @return\n+     * current position. Returns 0 if this can be accomplished without destroying any terrain, \n+     * -50 if this can be accomplished but terrain must be destroyed,\n+     * -100 if this cannot be accomplished at all\n      */\n-    private boolean hasPathToEdge(Entity entity, IBoard board) {\n+    private int hasPathToEdge(Entity entity, IBoard board) {", "originalCommit": "b59a243e6be4b10b80eb01e51454b1a82724242c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3MzczMg==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r434273732", "bodyText": "If this is expensive you could move this into an else block after the noReductionZoneSize > 0 check.", "author": "sixlettervariables", "createdAt": "2020-06-03T02:27:45Z", "path": "megamek/src/megamek/client/bot/BotClient.java", "diffHunk": "@@ -915,33 +920,30 @@ protected Coords getFirstValidCoords(Entity deployedUnit, List<Coords> possibleD\n         return result;\n     }\n \n-    /**\n-     * Gets the {@link BoardEdgePathFinder} for an {@link Entity} for their\n-     * current movement mode.\n-     * @param entity The entity to retrieve the {@link BoardEdgePathFinder}.\n-     * @return The appropriate {@link BoardEdgePathFinder} for the given entity.\n-     */\n-    private BoardEdgePathFinder getBoardEdgePathFinder(Entity entity) {\n-        return deploymentPathFinders.computeIfAbsent(entity.getMovementMode(), \n-            e -> new BoardEdgePathFinder());\n-    }\n-\n-    // ToDo: Change this to 'hasSafePathToCenter' to account for buildings, lava and similar hazards.\n     /**\n      * Determines if the given entity has a reasonable path to the \"opposite\" edge of the board from its\n-     * current position.\n-     * @param entity\n-     * @param board\n-     * @return\n+     * current position. Returns 0 if this can be accomplished without destroying any terrain, \n+     * -50 if this can be accomplished but terrain must be destroyed,\n+     * -100 if this cannot be accomplished at all\n      */\n-    private boolean hasPathToEdge(Entity entity, IBoard board) {\n+    private int hasPathToEdge(Entity entity, IBoard board) {\n         // Flying units can always get anywhere\n         if (entity.isAirborne() || entity instanceof VTOL) {\n-            return true;\n+            return 0;\n         }\n         \n-        MovePath mp = getBoardEdgePathFinder(entity).findPathToEdge(entity);\n-        return mp != null;\n+        CardinalEdge destinationEdge = BoardUtilities.determineOppositeEdge(entity);\n+        \n+        int noReductionZoneSize = getClusterTracker().getDestinationCoords(entity, destinationEdge, false).size();\n+        int reductionZoneSize = getClusterTracker().getDestinationCoords(entity, destinationEdge, true).size();", "originalCommit": "b59a243e6be4b10b80eb01e51454b1a82724242c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NTU4MA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r434275580", "bodyText": "Running time of n hashmap lookups where n is the width/height of the edge, so probably not worth it.", "author": "NickAragua", "createdAt": "2020-06-03T02:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3MzczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDM3Mw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r434274373", "bodyText": "These and's and or's are confusing as to who binds to who, so I'm struggling to determine if these are \"correct\".", "author": "sixlettervariables", "createdAt": "2020-06-03T02:30:40Z", "path": "megamek/src/megamek/common/Tank.java", "diffHunk": "@@ -580,59 +580,60 @@ public boolean isLocationProhibited(Coords c, int currElevation) {\n \n         boolean hasFlotationHull = hasWorkingMisc(MiscType.F_FLOTATION_HULL);\n         boolean isAmphibious = hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS);\n+        boolean hexHasRoad =  hex.containsTerrain(Terrains.ROAD);\n \n         switch (movementMode) {\n             case TRACKED:\n                 if (!isSuperHeavy()) {\n-                    return (hex.terrainLevel(Terrains.WOODS) > 1)\n+                    return (hex.terrainLevel(Terrains.WOODS) > 1) && !hexHasRoad", "originalCommit": "b59a243e6be4b10b80eb01e51454b1a82724242c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NTY3MA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r434275670", "bodyText": "I can put 'em into parens, and write up some comments.", "author": "NickAragua", "createdAt": "2020-06-03T02:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDQ5Nw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r434274497", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        for(int y = 0; y < board.getHeight(); y++) {                \n          \n          \n            \n                        for(int y = 0; y < board.getHeight(); y++) {", "author": "sixlettervariables", "createdAt": "2020-06-03T02:31:08Z", "path": "megamek/src/megamek/common/pathfinder/BoardClusterTracker.java", "diffHunk": "@@ -157,18 +192,18 @@ public void updateMovableAreas(Entity entity) {\n         IBoard board = entity.getGame().getBoard();\n         int clusterID = 0;\n         \n-        boolean isHovercraft = entity.getMovementMode() == EntityMovementMode.HOVER;\n-        boolean isAmphibious = entity.hasWorkingMisc(MiscType.F_AMPHIBIOUS) ||\n-                                entity.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS) ||\n-                                entity.hasWorkingMisc(MiscType.F_LIMITED_AMPHIBIOUS);\n+        MovementType movementType = MovementType.getMovementType(entity);\n+        boolean isHovercraft = movementType == MovementType.Hover;\n+        boolean isAmphibious = movementType == MovementType.WheeledAmphi ||\n+                                movementType == MovementType.TrackedAmphi;\n         \n         for(int x = 0; x < board.getWidth(); x++) {\n-            for(int y = 0; y < board.getHeight(); y++) {\n+            for(int y = 0; y < board.getHeight(); y++) {                ", "originalCommit": "b59a243e6be4b10b80eb01e51454b1a82724242c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fc2ed5026197a2dab8a1d8a199136f2a6b35ea6", "url": "https://github.com/MegaMek/megamek/commit/7fc2ed5026197a2dab8a1d8a199136f2a6b35ea6", "message": "Update megamek/src/megamek/common/pathfinder/BoardClusterTracker.java\n\nCo-authored-by: Christopher Watford <christopher.watford@gmail.com>", "committedDate": "2020-06-03T02:36:07Z", "type": "commit"}, {"oid": "55cd98416734bec0f5e42a81b7b43ea958a47820", "url": "https://github.com/MegaMek/megamek/commit/55cd98416734bec0f5e42a81b7b43ea958a47820", "message": "code review changes", "committedDate": "2020-06-03T02:43:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MDkxMw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435890913", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(noReductionZoneSize > 0) {\n          \n          \n            \n                        return 0;\n          \n          \n            \n                    } else if(reductionZoneSize > 0) {\n          \n          \n            \n                    if (noReductionZoneSize > 0) {\n          \n          \n            \n                        return 0;\n          \n          \n            \n                    } else if (reductionZoneSize > 0) {", "author": "Windchild292", "createdAt": "2020-06-05T12:34:11Z", "path": "megamek/src/megamek/client/bot/BotClient.java", "diffHunk": "@@ -916,32 +921,29 @@ protected Coords getFirstValidCoords(Entity deployedUnit, List<Coords> possibleD\n     }\n \n     /**\n-     * Gets the {@link BoardEdgePathFinder} for an {@link Entity} for their\n-     * current movement mode.\n-     * @param entity The entity to retrieve the {@link BoardEdgePathFinder}.\n-     * @return The appropriate {@link BoardEdgePathFinder} for the given entity.\n+     * Determines if the given entity has reasonable access to the \"opposite\" edge of the board from its\n+     * current position. Returns 0 if this can be accomplished without destroying any terrain, \n+     * -50 if this can be accomplished but terrain must be destroyed,\n+     * -100 if this cannot be accomplished at all\n      */\n-    private BoardEdgePathFinder getBoardEdgePathFinder(Entity entity) {\n-        return deploymentPathFinders.computeIfAbsent(entity.getMovementMode(), \n-            e -> new BoardEdgePathFinder());\n-    }\n-\n-    // ToDo: Change this to 'hasSafePathToCenter' to account for buildings, lava and similar hazards.\n-    /**\n-     * Determines if the given entity has a reasonable path to the \"opposite\" edge of the board from its\n-     * current position.\n-     * @param entity\n-     * @param board\n-     * @return\n-     */\n-    private boolean hasPathToEdge(Entity entity, IBoard board) {\n+    private int calculateEdgeAccessFitness(Entity entity, IBoard board) {\n         // Flying units can always get anywhere\n         if (entity.isAirborne() || entity instanceof VTOL) {\n-            return true;\n+            return 0;\n         }\n         \n-        MovePath mp = getBoardEdgePathFinder(entity).findPathToEdge(entity);\n-        return mp != null;\n+        CardinalEdge destinationEdge = BoardUtilities.determineOppositeEdge(entity);\n+        \n+        int noReductionZoneSize = getClusterTracker().getDestinationCoords(entity, destinationEdge, false).size();\n+        int reductionZoneSize = getClusterTracker().getDestinationCoords(entity, destinationEdge, true).size();\n+        \n+        if(noReductionZoneSize > 0) {\n+            return 0;\n+        } else if(reductionZoneSize > 0) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MTU3Mg==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435891572", "bodyText": "Shouldn't this say closest instead of opposite?", "author": "Windchild292", "createdAt": "2020-06-05T12:35:28Z", "path": "megamek/src/megamek/common/util/BoardUtilities.java", "diffHunk": "@@ -1564,7 +1566,7 @@ private static int normRNG(int factor) {\n     }\n \n     /**\n-     * Figures out the \"opposite\" edge for the given entity on the entity's game board\n+     * Figures out the \"closest\" edge for the given entity on the entity's game board\n      * @param entity Entity to evaluate\n      * @return the Board.START_ constant representing the \"opposite\" edge", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxMTI1OQ==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r436211259", "bodyText": "Yep.", "author": "NickAragua", "createdAt": "2020-06-06T00:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MTgwNw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435891807", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(oppositeEdge != Board.START_NONE) {\n          \n          \n            \n                    if (oppositeEdge != Board.START_NONE) {", "author": "Windchild292", "createdAt": "2020-06-05T12:35:53Z", "path": "megamek/src/megamek/common/util/BoardUtilities.java", "diffHunk": "@@ -1586,6 +1588,26 @@ public static CardinalEdge getClosestEdge(Entity entity) {\n             return closerNorthThanSouth ? CardinalEdge.NORTH : CardinalEdge.SOUTH;\n         }\n     }\n+    \n+    /**\n+     * Figures out the \"opposite\" edge for the given entity.\n+     * @param entity Entity to evaluate\n+     * @return the Board.START_ constant representing the \"opposite\" edge\n+     */\n+    public static CardinalEdge determineOppositeEdge(Entity entity) {\n+        IBoard board = entity.getGame().getBoard();\n+\n+        // the easiest part is if the entity is supposed to start on a particular edge. Just return the opposite edge.\n+        int oppositeEdge = board.getOppositeEdge(entity.getStartingPos());\n+        if(oppositeEdge != Board.START_NONE) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MjU4Nw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435892587", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                (bestPath == null || movePathComparator.compare(bestPath, currentPath) > 0)) {\n          \n          \n            \n                                ((bestPath == null) || (movePathComparator.compare(bestPath, currentPath) > 0))) {", "author": "Windchild292", "createdAt": "2020-06-05T12:37:34Z", "path": "megamek/src/megamek/common/pathfinder/DestructionAwareDestinationPathfinder.java", "diffHunk": "@@ -100,11 +100,10 @@ public BulldozerMovePath findPathToCoords(Entity entity, Set<Coords> destination\n \n         while(!candidates.isEmpty()) {\n             BulldozerMovePath currentPath = candidates.pollFirst();\n-            \n-            candidates.addAll(generateChildNodes(currentPath, shortestPathsToCoords));\n+            candidates.addAll(generateChildNodes(currentPath, shortestPathsToCoords));            \n             \n             if(destinationCoords.contains(currentPath.getFinalCoords()) &&\n-                    (bestPath == null || movePathComparator.compare(bestPath, currentPath) < 0)) {\n+                    (bestPath == null || movePathComparator.compare(bestPath, currentPath) > 0)) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MjgyMQ==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435892821", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(tieBreakerDiff == 0) {\n          \n          \n            \n                            if (tieBreakerDiff == 0) {", "author": "Windchild292", "createdAt": "2020-06-05T12:38:03Z", "path": "megamek/src/megamek/common/pathfinder/DestructionAwareDestinationPathfinder.java", "diffHunk": "@@ -246,15 +251,22 @@ public int compare(BulldozerMovePath first, BulldozerMovePath second) {\n             // getFacingDiff returns a number between 0 and 3 inclusive. \n             // if the value diff is larger than 3, then it won't make a difference and we skip calculating it\n             if (Math.abs(dd) < 4) {\n+                dd *= 10; // facing diff doesn't matter as much as the other stuff, only use it as a tie-breaker\n                 dd += ShortestPathFinder.getFacingDiff(first, destination, backwards);\n                 dd -= ShortestPathFinder.getFacingDiff(second, destination, backwards);\n             }\n     \n+            // dd != 0 implies that the two paths are not identical\n             if (dd != 0) {\n                 return dd;\n             } else {\n-                return first.getHexesMoved() - second.getHexesMoved();\n-            }           \n+                int tieBreakerDiff = first.getHexesMoved() - second.getHexesMoved();\n+                if(tieBreakerDiff == 0) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MzMzMw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435893333", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(entity.hasETypeFlag(Entity.ETYPE_MECH) && \n          \n          \n            \n                    if (entity.hasETypeFlag(Entity.ETYPE_MECH) &&", "author": "Windchild292", "createdAt": "2020-06-05T12:39:01Z", "path": "megamek/src/megamek/common/pathfinder/BoardEdgePathFinder.java", "diffHunk": "@@ -620,7 +624,8 @@ public static int calculateUnitElevationInHex(IHex hex, Entity entity, boolean i\n \n         int hexElevation = hex.getLevel();\n \n-        if(entity.hasETypeFlag(Entity.ETYPE_MECH) && hex.containsTerrain(Terrains.BLDG_CF)) {\n+        if(entity.hasETypeFlag(Entity.ETYPE_MECH) && ", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5MzUwMw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435893503", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            || (destHex.containsTerrain(Terrains.SNOW) && destHex.terrainLevel(Terrains.SNOW) > 1));\n          \n          \n            \n                            || (destHex.containsTerrain(Terrains.SNOW) && (destHex.terrainLevel(Terrains.SNOW) > 1)));", "author": "Windchild292", "createdAt": "2020-06-05T12:39:21Z", "path": "megamek/src/megamek/common/pathfinder/BoardEdgePathFinder.java", "diffHunk": "@@ -584,9 +587,10 @@ private MoveLegalityIndicator isLegalMove(MovePath movePath, IHex destHex, Build\n \n         // wheeled tanks cannot go into rough terrain or rubble of any kind, or buildings for that matter\n         // even if you level them they still turn to rubble. Additionally, they cannot go into deep snow.\n-        mli.wheeledTankRestriction = isWheeled &&\n+        mli.wheeledTankRestriction = isWheeled && !destHexHasRoad &&\n                 (destHex.containsTerrain(Terrains.ROUGH) || destHex.containsTerrain(Terrains.RUBBLE)\n-                || destHex.containsTerrain(Terrains.BLDG_CF) || (destHex.containsTerrain(Terrains.SNOW) && destHex.terrainLevel(Terrains.SNOW) > 1));\n+                || destinationHasBuilding\n+                || (destHex.containsTerrain(Terrains.SNOW) && destHex.terrainLevel(Terrains.SNOW) > 1));", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5NDU1OA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435894558", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    switch(direction) {\n          \n          \n            \n                    switch (direction) {", "author": "Windchild292", "createdAt": "2020-06-05T12:41:20Z", "path": "megamek/src/megamek/client/bot/princess/CardinalEdge.java", "diffHunk": "@@ -46,4 +48,35 @@ public static CardinalEdge getCardinalEdge(int index) {\n         }\r\n         return null;\r\n     }\r\n+    \r\n+    public static CardinalEdge getCardinalEdge(OffBoardDirection direction) {\r\n+        switch(direction) {\r", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5NDYyNg==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435894626", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    switch(edge) {\n          \n          \n            \n                    switch (edge) {", "author": "Windchild292", "createdAt": "2020-06-05T12:41:26Z", "path": "megamek/src/megamek/client/bot/princess/CardinalEdge.java", "diffHunk": "@@ -46,4 +48,35 @@ public static CardinalEdge getCardinalEdge(int index) {\n         }\r\n         return null;\r\n     }\r\n+    \r\n+    public static CardinalEdge getCardinalEdge(OffBoardDirection direction) {\r\n+        switch(direction) {\r\n+        case NORTH:\r\n+            return NORTH;\r\n+        case SOUTH:\r\n+            return SOUTH;\r\n+        case EAST:\r\n+            return EAST;\r\n+        case WEST:\r\n+            return WEST;\r\n+        default:\r\n+            return NEAREST_OR_NONE;\r\n+        }\r\n+    }\r\n+    \r\n+    public static CardinalEdge getOppositeEdge(CardinalEdge edge) {\r\n+        switch(edge) {\r", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5NTUzNA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435895534", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(checkCrew && (null != getCrew()) && getCrew().isDead()) {\n          \n          \n            \n                    if (checkCrew && (null != getCrew()) && getCrew().isDead()) {", "author": "Windchild292", "createdAt": "2020-06-05T12:43:14Z", "path": "megamek/src/megamek/common/GunEmplacement.java", "diffHunk": "@@ -479,11 +479,14 @@ public int getTotalCommGearTons() {\n \n     @Override\n     public boolean isCrippled(boolean checkCrew) {\n-        return isCrippled();\n-    }\n-\n-    @Override\n-    public boolean isCrippled() {\n+        if(checkCrew && (null != getCrew()) && getCrew().isDead()) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5NjQzNA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435896434", "bodyText": "Maybe add a comment here mentioning it is for debugging, or remove this line", "author": "Windchild292", "createdAt": "2020-06-05T12:44:53Z", "path": "megamek/src/megamek/common/MovePath.java", "diffHunk": "@@ -1197,16 +1199,7 @@ public void findPathTo(final Coords dest, final MoveStepType type) {\n \n         pf.run(this.clone());\n         MovePath finPath = pf.getComputedPath(dest);\n-        // code that's useful to test the destruction-aware pathfinder\n-        // remove when code review and testing complete\n-        /*DestructionAwareDestinationPathfinder dpf = new DestructionAwareDestinationPathfinder();\n-        Set<Coords> destinationSet = new HashSet<Coords>();\n-        destinationSet.add(dest);\n-        \n-        long marker1 = System.currentTimeMillis();\n-        MovePath finPath = dpf.findPathToCoords(entity, destinationSet, true);\n-        long marker2 = System.currentTimeMillis();\n-        long marker3 = marker2 - marker1;*/\n+        //MovePath finPath = calculateDestructionAwarePath(dest);", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5Njg4Mw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435896883", "bodyText": "Is this meant to be removed now?", "author": "Windchild292", "createdAt": "2020-06-05T12:45:40Z", "path": "megamek/src/megamek/common/MovePath.java", "diffHunk": "@@ -1840,4 +1833,26 @@ public boolean setStrafingStep(Coords pos) {\n     public boolean nextForwardStepOffBoard() {\n         return !game.getBoard().contains(getFinalCoords().translated(getFinalFacing()));\n     }\n+    \n+    /**\n+     * Debugging method that calculates a destruction-aware move path to the destination coordinates\n+     */\n+    public MovePath calculateDestructionAwarePath(Coords dest) {\n+        // code that's useful to test the destruction-aware pathfinder\n+        // remove when code review and testing complete", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxMTAxOQ==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r436211019", "bodyText": "Guess not anymore.", "author": "NickAragua", "createdAt": "2020-06-06T00:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5Njg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5NzgwNw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435897807", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!movableAreas.containsKey(movementType)) {\n          \n          \n            \n                    if (!movableAreas.containsKey(movementType)) {", "author": "Windchild292", "createdAt": "2020-06-05T12:47:26Z", "path": "megamek/src/megamek/common/pathfinder/BoardClusterTracker.java", "diffHunk": "@@ -131,8 +161,13 @@ public void clearMovableAreas() {\n     public void updateMovableAreas(Entity entity) {\n         MovementType movementType = MovementType.getMovementType(entity);\n         \n-        movableAreas.putIfAbsent(movementType, generateClusters(entity, false));\n-        movableAreasWithTerrainReduction.putIfAbsent(movementType, generateClusters(entity, true));\n+        if(!movableAreas.containsKey(movementType)) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5ODE3Mw==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435898173", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!movableAreasWithTerrainReduction.containsKey(movementType)) {\n          \n          \n            \n                    if (!movableAreasWithTerrainReduction.containsKey(movementType)) {", "author": "Windchild292", "createdAt": "2020-06-05T12:48:06Z", "path": "megamek/src/megamek/common/pathfinder/BoardClusterTracker.java", "diffHunk": "@@ -131,8 +161,13 @@ public void clearMovableAreas() {\n     public void updateMovableAreas(Entity entity) {\n         MovementType movementType = MovementType.getMovementType(entity);\n         \n-        movableAreas.putIfAbsent(movementType, generateClusters(entity, false));\n-        movableAreasWithTerrainReduction.putIfAbsent(movementType, generateClusters(entity, true));\n+        if(!movableAreas.containsKey(movementType)) {\n+            movableAreas.put(movementType, generateClusters(entity, false));\n+        }\n+        \n+        if(!movableAreasWithTerrainReduction.containsKey(movementType)) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5ODQ4OA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435898488", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    if((elevationDiff > entity.getMaxElevationChange())\n          \n          \n            \n                                    if ((elevationDiff > entity.getMaxElevationChange())", "author": "Windchild292", "createdAt": "2020-06-05T12:48:43Z", "path": "megamek/src/megamek/common/pathfinder/BoardClusterTracker.java", "diffHunk": "@@ -185,8 +220,11 @@ public void updateMovableAreas(Entity entity) {\n                         int myElevation = BoardEdgePathFinder.calculateUnitElevationInHex(board.getHex(c), entity, isHovercraft, isAmphibious);\n                         \n                         // if we can't reach from here to the neighbor due to elevation differences, move on\n+                        // buildings require special handling - while a tank technically CAN plow through a building\n+                        // it is highly inadvisable and we will avoid it for now.\n                         int elevationDiff = Math.abs(neighborElevation - myElevation);\n-                        if(elevationDiff > entity.getMaxElevationChange()) {\n+                        if((elevationDiff > entity.getMaxElevationChange())", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5ODg1NA==", "url": "https://github.com/MegaMek/megamek/pull/1987#discussion_r435898854", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } else if (relevantMovementType != MovementType.Flyer &&\n          \n          \n            \n                            relevantMovementType != MovementType.Jump &&\n          \n          \n            \n                            relevantMovementType != MovementType.None &&\n          \n          \n            \n                            relevantMovementType != MovementType.Water) {\n          \n          \n            \n                    } else if ((relevantMovementType != MovementType.Flyer) &&\n          \n          \n            \n                            (relevantMovementType != MovementType.Jump) &&\n          \n          \n            \n                            (relevantMovementType != MovementType.None) &&\n          \n          \n            \n                            (relevantMovementType != MovementType.Water)) {", "author": "Windchild292", "createdAt": "2020-06-05T12:49:23Z", "path": "megamek/src/megamek/common/pathfinder/BoardClusterTracker.java", "diffHunk": "@@ -231,6 +269,34 @@ public void updateMovableAreas(Entity entity) {\n         return clusters;\n     }\n     \n+    /**\n+     * Whether or not we are required to plow through a building if we enter this hex.\n+     */\n+    private boolean buildingPlowThroughRequired(Entity entity, MovementType relevantMovementType, Coords coords) {\n+        // basic premise:\n+        // ground tanks cannot climb over buildings and must plow through\n+        // mechs can climb over buildings that won't collapse under them\n+        // the relative height comparison is handled elsewhere\n+        \n+        IBoard board = entity.getGame().getBoard();\n+        IHex hex = board.getHex(coords);\n+        \n+        if (!hex.containsTerrain(Terrains.BLDG_CF) && !hex.containsExit(Terrains.FUEL_TANK_CF)) {\n+            return false;\n+        } else if (relevantMovementType == MovementType.Walker) {\n+            int buildingCF = board.getBuildingAt(coords).getCurrentCF(coords);\n+            \n+            return entity.getWeight() > buildingCF;            \n+        } else if (relevantMovementType != MovementType.Flyer &&\n+                relevantMovementType != MovementType.Jump &&\n+                relevantMovementType != MovementType.None &&\n+                relevantMovementType != MovementType.Water) {", "originalCommit": "55cd98416734bec0f5e42a81b7b43ea958a47820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06c1f964785100ad4c93e5b29b5cd0d53edb3ac3", "url": "https://github.com/MegaMek/megamek/commit/06c1f964785100ad4c93e5b29b5cd0d53edb3ac3", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-06-06T00:01:45Z", "type": "commit"}, {"oid": "9d8dc96bad0282edc8f6fa84c7e1942f256fc920", "url": "https://github.com/MegaMek/megamek/commit/9d8dc96bad0282edc8f6fa84c7e1942f256fc920", "message": "Update megamek/src/megamek/client/bot/BotClient.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-06-06T00:02:10Z", "type": "commit"}, {"oid": "16ebb4713cf2bee53dc4e698975585eab98e38ff", "url": "https://github.com/MegaMek/megamek/commit/16ebb4713cf2bee53dc4e698975585eab98e38ff", "message": "Update BoardUtilities.java", "committedDate": "2020-06-06T00:03:10Z", "type": "commit"}, {"oid": "eee4db4b97787d2517d904c07813628169462318", "url": "https://github.com/MegaMek/megamek/commit/eee4db4b97787d2517d904c07813628169462318", "message": "Update MovePath.java", "committedDate": "2020-06-06T00:04:39Z", "type": "commit"}, {"oid": "784cda210816cd55d80ad3d92de21a2ff7b187a5", "url": "https://github.com/MegaMek/megamek/commit/784cda210816cd55d80ad3d92de21a2ff7b187a5", "message": "Update megamek/src/megamek/client/bot/princess/CardinalEdge.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-06-06T00:05:15Z", "type": "commit"}, {"oid": "a30c7b3a9e0735d81ad714385bfa0d744b691af9", "url": "https://github.com/MegaMek/megamek/commit/a30c7b3a9e0735d81ad714385bfa0d744b691af9", "message": "Update megamek/src/megamek/client/bot/princess/CardinalEdge.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-06-06T00:05:30Z", "type": "commit"}]}