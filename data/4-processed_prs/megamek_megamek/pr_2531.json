{"pr_number": 2531, "pr_title": "MekHQ 1727: Colour Camouflage", "pr_createdAt": "2020-12-25T23:46:05Z", "pr_url": "https://github.com/MegaMek/megamek/pull/2531", "timeline": [{"oid": "444fc4eb49ba82071111ee113356d22eb378aed8", "url": "https://github.com/MegaMek/megamek/commit/444fc4eb49ba82071111ee113356d22eb378aed8", "message": "PlayerColours, Colour Camo Standardization, and standardizing camo selector", "committedDate": "2020-12-25T22:30:36Z", "type": "commit"}, {"oid": "aebace10abc9ba8f067007ba3f2c7301192e7431", "url": "https://github.com/MegaMek/megamek/commit/aebace10abc9ba8f067007ba3f2c7301192e7431", "message": "Applying changes as per review", "committedDate": "2020-12-25T23:30:57Z", "type": "commit"}, {"oid": "68a23ae3076d0f06f5f3667ecb1d35ee03f8a978", "url": "https://github.com/MegaMek/megamek/commit/68a23ae3076d0f06f5f3667ecb1d35ee03f8a978", "message": "Bugfixing Player Colours implementation", "committedDate": "2020-12-27T01:43:58Z", "type": "commit"}, {"oid": "ae5051db38ec0c3c58a8987dd8e77dfaff2930ee", "url": "https://github.com/MegaMek/megamek/commit/ae5051db38ec0c3c58a8987dd8e77dfaff2930ee", "message": "Cleaning up ECM Effects", "committedDate": "2020-12-27T02:28:25Z", "type": "commit"}, {"oid": "f11ddd5aa0aaa4646ca32342ea9a09abe98ec457", "url": "https://github.com/MegaMek/megamek/commit/f11ddd5aa0aaa4646ca32342ea9a09abe98ec457", "message": "1727: Fixing duplicated player colours during initial assignment, provided there are free new colours", "committedDate": "2020-12-27T03:39:21Z", "type": "commit"}, {"oid": "a4a36130bea4a2d04fe2ab3aaa022a41e14d98ad", "url": "https://github.com/MegaMek/megamek/commit/a4a36130bea4a2d04fe2ab3aaa022a41e14d98ad", "message": "Fixing a few AbstractIconChooser comments", "committedDate": "2020-12-27T04:00:56Z", "type": "commit"}, {"oid": "2529d78d2639e223e1f9db5d5e73d9c60b20f6f1", "url": "https://github.com/MegaMek/megamek/commit/2529d78d2639e223e1f9db5d5e73d9c60b20f6f1", "message": "Merge remote-tracking branch 'upstream/master' into dev_Windchild_1727", "committedDate": "2020-12-28T20:53:20Z", "type": "commit"}, {"oid": "4348a54d51610c3b170302287aa825e8e25a711f", "url": "https://github.com/MegaMek/megamek/commit/4348a54d51610c3b170302287aa825e8e25a711f", "message": "Merge remote-tracking branch 'upstream/master' into dev_Windchild_1727", "committedDate": "2020-12-31T15:50:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MDQ2Mw==", "url": "https://github.com/MegaMek/megamek/pull/2531#discussion_r550780463", "bodyText": "Could this be moved to showDialog? This isn't necessary but I started playing with unit testing swing and it would be nice to have effortless ctors going forward.", "author": "sixlettervariables", "createdAt": "2021-01-01T15:53:46Z", "path": "megamek/src/megamek/client/ui/swing/dialog/imageChooser/CamoChooser.java", "diffHunk": "@@ -19,49 +19,53 @@\n package megamek.client.ui.swing.dialog.imageChooser;\n \n import megamek.client.ui.swing.tileset.MMStaticDirectoryManager;\n-import megamek.client.ui.swing.util.PlayerColors;\n+import megamek.client.ui.swing.util.PlayerColour;\n+import megamek.common.annotations.Nullable;\n import megamek.common.icons.AbstractIcon;\n import megamek.common.icons.Camouflage;\n import megamek.common.util.fileUtils.DirectoryItems;\n \n import java.util.ArrayList;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.Objects;\n \n public class CamoChooser extends AbstractIconChooser {\n     //region Variable Declarations\n-    /** True when an individual camo is being selected for an entity. */\n-    private boolean individualCamo = false;\n-\n-    /** When an individual camo is being selected, the player's camo is displayed as a reset option. */\n-    private AbstractIcon entityOwnerCamo;\n+    private AbstractIcon ownerCamouflage;\n+    private AbstractIcon individualCamouflage;\n     //endregion Variable Declarations\n \n     //region Constructors\n-    public CamoChooser() {\n-        this(null);\n-    }\n-\n-    public CamoChooser(AbstractIcon icon) {\n-        super(new CamoChooserTree(), icon);\n+    public CamoChooser(@Nullable AbstractIcon ownerCamouflage, AbstractIcon individualCamouflage) {\n+        super(null, individualCamouflage);\n+        setOwnerCamouflage(ownerCamouflage);\n+        setIndividualCamouflage(individualCamouflage);\n+        refreshDirectory(new CamoChooserTree(hasIndividualCamouflage()));", "originalCommit": "4348a54d51610c3b170302287aa825e8e25a711f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc5NDg5OQ==", "url": "https://github.com/MegaMek/megamek/pull/2531#discussion_r550794899", "bodyText": "To fix the search and some other performance oddities I've found for it I'll need to do a significant rework of parts of the dialog, so I'll add it to that list for you", "author": "Windchild292", "createdAt": "2021-01-01T18:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MDQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MDYwNw==", "url": "https://github.com/MegaMek/megamek/pull/2531#discussion_r550780607", "bodyText": "Perhaps an overload of getCamouflage could help simplify this pattern?\nentity.getCamouflageOrElse(player.getCamouflage())", "author": "sixlettervariables", "createdAt": "2021-01-01T15:55:40Z", "path": "megamek/src/megamek/client/ui/swing/skinEditor/SkinEditorMainGUI.java", "diffHunk": "@@ -872,10 +870,9 @@ public JFrame getFrame() {\n     }\n    \n     public void loadPreviewImage(JLabel bp, Entity entity, IPlayer player) {\n-        Image camo = ((entity.getCamoCategory() != null) && !Camouflage.NO_CAMOUFLAGE.equals(entity.getCamoCategory())\n-                ? entity.getCamouflage() : player.getCamouflage()).getImage();\n-        int tint = PlayerColors.getColorRGB(player.getColorIndex());\n-        bp.setIcon(new ImageIcon(bv.getTilesetManager().loadPreviewImage(entity, camo, tint, bp)));\n+        Image camo = (entity.getCamouflage().hasDefaultCategory()", "originalCommit": "4348a54d51610c3b170302287aa825e8e25a711f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MDk4OQ==", "url": "https://github.com/MegaMek/megamek/pull/2531#discussion_r550780989", "bodyText": "Is this still needed?", "author": "sixlettervariables", "createdAt": "2021-01-01T15:59:55Z", "path": "megamek/src/megamek/common/preference/IClientPreferences.java", "diffHunk": "@@ -14,6 +14,8 @@\n \n package megamek.common.preference;\n \n+import megamek.client.ui.swing.util.PlayerColour;", "originalCommit": "4348a54d51610c3b170302287aa825e8e25a711f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MTAzOQ==", "url": "https://github.com/MegaMek/megamek/pull/2531#discussion_r550781039", "bodyText": "Should this be equals?", "author": "sixlettervariables", "createdAt": "2021-01-01T16:01:13Z", "path": "megamek/src/megamek/server/Server.java", "diffHunk": "@@ -1022,23 +1022,21 @@ private IPlayer addNewPlayer(int connId, String name) {\n             team++;\n         }\n         IPlayer newPlayer = new Player(connId, name);\n-        int colorInd = newPlayer.getColorIndex();\n+        PlayerColour colour = newPlayer.getColour();\n         Enumeration<IPlayer> players = game.getPlayers();\n-        while (players.hasMoreElements() && (colorInd < PlayerColors.COLOR_NAMES.length)) {\n+        final PlayerColour[] colours = PlayerColour.values();\n+        while (players.hasMoreElements()) {\n             final IPlayer p = players.nextElement();\n             if (p.getId() == newPlayer.getId()) {\n                 continue;\n             }\n-            if (p.getColorIndex() == colorInd) {\n-                colorInd++;\n+            if ((p.getColour() == colour) && (colours.length < (colour.ordinal() + 1))) {", "originalCommit": "4348a54d51610c3b170302287aa825e8e25a711f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc5MTEwNg==", "url": "https://github.com/MegaMek/megamek/pull/2531#discussion_r550791106", "bodyText": "No, but it should be greater than instead of less than\nThat's there to prevent an index out of bounds error.", "author": "Windchild292", "createdAt": "2021-01-01T18:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MTAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc4MTE2Mg==", "url": "https://github.com/MegaMek/megamek/pull/2531#discussion_r550781162", "bodyText": "Consider Set<PlayerColour>", "author": "sixlettervariables", "createdAt": "2021-01-01T16:02:34Z", "path": "megamek/src/megamek/server/Server.java", "diffHunk": "@@ -1051,26 +1049,31 @@ private IPlayer addNewPlayer(int connId, String name) {\n     public void validatePlayerInfo(int playerId) {\n         final IPlayer player = getPlayer(playerId);\n \n-        // TODO : check for duplicate or reserved names\n-\n-        // make sure colorIndex is unique\n-        boolean[] colorUsed = new boolean[PlayerColors.COLOR_NAMES.length];\n-        for (Enumeration<IPlayer> i = game.getPlayers(); i.hasMoreElements(); ) {\n-            final IPlayer otherPlayer = i.nextElement();\n-            if (otherPlayer.getId() != playerId) {\n-                colorUsed[otherPlayer.getColorIndex()] = true;\n+        if (player != null) {\n+            // TODO : check for duplicate or reserved names\n+\n+            // Colour Assignment\n+            final PlayerColour[] playerColours = PlayerColour.values();\n+            boolean allUsed = true;\n+            boolean[] colourUtilization = new boolean[playerColours.length];", "originalCommit": "4348a54d51610c3b170302287aa825e8e25a711f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e97072d7562e1ece518680df1197d41fc45018b6", "url": "https://github.com/MegaMek/megamek/commit/e97072d7562e1ece518680df1197d41fc45018b6", "message": "Implementing changes per review", "committedDate": "2021-01-01T18:48:13Z", "type": "commit"}]}