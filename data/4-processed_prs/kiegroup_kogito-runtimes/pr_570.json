{"pr_number": 570, "pr_title": "KOGITO-2286 Pipeline modifications for release process", "pr_createdAt": "2020-06-18T20:44:58Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/570", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MDQ0OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r442690448", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    stage('Deploy') {\n          \n          \n            \n                    stage('Deploy artifacts') {", "author": "radtriste", "createdAt": "2020-06-19T07:54:58Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -76,33 +97,38 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Deploy') {", "originalCommit": "34a8596d1de6f9568d23fd8ebdaa4bf9812bf589", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MDcyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r442690729", "bodyText": "This should be done only in the case of release", "author": "radtriste", "createdAt": "2020-06-19T07:55:36Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -76,33 +97,38 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Deploy') {\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-apps') {\n-            steps {\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            input {", "originalCommit": "34a8596d1de6f9568d23fd8ebdaa4bf9812bf589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0OTU3OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r443249579", "bodyText": "Oops. I forgot to add the check here. \ud83d\ude05 Fixed in latest commit.", "author": "Kevin-Mok", "createdAt": "2020-06-21T19:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MDcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MTg0Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r442691846", "bodyText": "do we want to have a specific folder for the file ?", "author": "radtriste", "createdAt": "2020-06-19T07:57:42Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -76,33 +97,38 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Deploy') {\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-apps') {\n-            steps {\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            input {\n+                message \"Enter staging repository URL:\"\n+                parameters {\n+                    string(name: 'STAGING_REPO_URL')\n+                }\n+            }\n+            steps {\n+                sh \"mkdir -p archive\"", "originalCommit": "34a8596d1de6f9568d23fd8ebdaa4bf9812bf589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0OTc0Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r443249746", "bodyText": "I guess it's not necessary. I was just copying the example where they made a folder for the archived artifacts. I put the artifacts directly into $WORKSPACE in the latest commit.", "author": "Kevin-Mok", "createdAt": "2020-06-21T19:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5MTg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5Mjg3OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r442692879", "bodyText": "we should have one property file containing all deploy properties (key=value), so we can add more to that file, without having many files", "author": "radtriste", "createdAt": "2020-06-19T08:00:00Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -76,33 +97,38 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Deploy') {\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-apps') {\n-            steps {\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            input {\n+                message \"Enter staging repository URL:\"\n+                parameters {\n+                    string(name: 'STAGING_REPO_URL')\n+                }\n+            }\n+            steps {\n+                sh \"mkdir -p archive\"\n+                writeFile(file: \"archive/staging-url.txt\", text: \"${STAGING_REPO_URL}\")\n+                archiveArtifacts(artifacts: \"archive/staging-url.txt\")", "originalCommit": "34a8596d1de6f9568d23fd8ebdaa4bf9812bf589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkzMjYzNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r442932634", "bodyText": "Just thinking that the staging-repository is needed by the main release pipeline to be transmitted to the images & operator pipeline so that staging-url.txt is fine in fact.\nbut we could still add a property file that will be used to store the PR links in https://issues.redhat.com/browse/KOGITO-2415 and so we could add the staging-repository as well in there", "author": "radtriste", "createdAt": "2020-06-19T16:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5Mjg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0OTk3Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r443249976", "bodyText": "I'm archiving deployment.properties and staging-url.txt in the latest commit. Do we even really need the staging-url.txt then? Couldn't the main release/operator pipeline read the deployment.properties file as well and get the URL that way?", "author": "Kevin-Mok", "createdAt": "2020-06-21T19:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5Mjg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNTE2MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r443435161", "bodyText": "That is open.\nThe way I see it:\n\ndeployment.properties if for discussion between deploy and promote pipeline jobs, like \"private information\"\nstaging-url.txt is \"public\" information\n\nBut I think it makes no sense to duplicate the information, so you can remove the staging-url.txt file and let everything in the deployment.properties.", "author": "radtriste", "createdAt": "2020-06-22T09:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY5Mjg3OQ=="}], "type": "inlineReview"}, {"oid": "873f258357ce5b0dc8bcdbfffcedd65e0a87a9cb", "url": "https://github.com/kiegroup/kogito-runtimes/commit/873f258357ce5b0dc8bcdbfffcedd65e0a87a9cb", "message": "KOGITO-2286 Add release parameter and staging repository information", "committedDate": "2020-06-21T19:26:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM1NjQ0OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r443356448", "bodyText": "could we have this in lowercase ?", "author": "radtriste", "createdAt": "2020-06-22T07:09:15Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -76,33 +97,39 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Deploy artifacts') {\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-apps') {\n-            steps {\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            steps {\n+                script {\n+                    if (params.RELEASE) {\n+                        def STAGING_REPO_URL = input(message: \"Enter staging repository URL:\", parameters: [text(name: 'STAGING_REPO_URL')])\n+                        def STAGING_URL_FILE = \"staging-url.txt\"\n+                        def PROPERTIES_FILE = \"deployment.properties\"\n+                        sh \"echo ${STAGING_REPO_URL} > ${STAGING_URL_FILE}\"\n+                        sh \"printf \\\"STAGING_REPO_URL=%s\\\" \\\"${STAGING_REPO_URL}\\\" > ${PROPERTIES_FILE}\"", "originalCommit": "873f258357ce5b0dc8bcdbfffcedd65e0a87a9cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNTYwNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r443435605", "bodyText": "like a property:  staging-repo.url=<VALUE>", "author": "radtriste", "createdAt": "2020-06-22T09:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM1NjQ0OA=="}], "type": "inlineReview"}, {"oid": "7a79552248fff89e9547050f00ead285f8809566", "url": "https://github.com/kiegroup/kogito-runtimes/commit/7a79552248fff89e9547050f00ead285f8809566", "message": "KOGITO-2286 Add release parameter and staging repository information", "committedDate": "2020-06-22T20:07:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgwODUxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r444808513", "bodyText": "Can we just manually expand this to cp -r kogito-examples kogito-examples-persistence? I think it looks much understandable than the current form.", "author": "MarianMacik", "createdAt": "2020-06-24T10:49:36Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -34,9 +35,33 @@ pipeline {\n                 }\n             }\n         }\n+        stage('Clone repositories') { \n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-runtimes\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-apps\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-examples\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                // Use a separate dir for persistence to not overwrite the test results\n+                sh \"cp -r kogito-examples{,-persistence}\"", "originalCommit": "7a79552248fff89e9547050f00ead285f8809566", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "baaf1b1157b7cee837978df86f6886c83985789d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/baaf1b1157b7cee837978df86f6886c83985789d", "message": "KOGITO-2286 Add release parameter and staging repository information", "committedDate": "2020-06-24T12:54:14Z", "type": "forcePushed"}, {"oid": "df854e7b307454c37fa9c9abd4561d488ae8a485", "url": "https://github.com/kiegroup/kogito-runtimes/commit/df854e7b307454c37fa9c9abd4561d488ae8a485", "message": "KOGITO-2286 Add release parameter and staging repository information", "committedDate": "2020-06-25T02:07:10Z", "type": "forcePushed"}, {"oid": "e841c8c51c2b34793e6f03bc21e18ac50fa1a121", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e841c8c51c2b34793e6f03bc21e18ac50fa1a121", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step", "committedDate": "2020-06-29T22:40:12Z", "type": "forcePushed"}, {"oid": "cc9b9cad3634d401dc469ca84e1cdb4d52dfe8f4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/cc9b9cad3634d401dc469ca84e1cdb4d52dfe8f4", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step", "committedDate": "2020-06-29T22:43:38Z", "type": "forcePushed"}, {"oid": "ae7b0274a9707b429074fc4812cdd1306cc3d1ea", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ae7b0274a9707b429074fc4812cdd1306cc3d1ea", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step", "committedDate": "2020-06-29T22:55:03Z", "type": "forcePushed"}, {"oid": "1d66a7059113b11bd60e3b1450bcb0d2e018046a", "url": "https://github.com/kiegroup/kogito-runtimes/commit/1d66a7059113b11bd60e3b1450bcb0d2e018046a", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step", "committedDate": "2020-06-29T22:58:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NDIwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r447544208", "bodyText": "The Maven version should not be the Maven binary version but the project version we want to set.\nSo there should not be any default value as this is an optional field, and I would rename it PROJECT_VERSION.\nAlso it could be used without the RELEASE so the description should be changed.\nExample:\nstring(name: 'PROJECT_VERSION', defaultValue: '', description: 'Set the version to the project')", "author": "radtriste", "createdAt": "2020-06-30T09:27:35Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -1,15 +1,24 @@\n @Library('jenkins-pipeline-shared-libraries')_\n \n+def deployProperties = [:]\n+\n pipeline {\n     agent {\n         label 'kie-rhel7 && kie-mem16g'\n     }\n     parameters {\n         string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n         string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Which branch to build ? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Is this build for a release?')\n+        string(name: 'MAVEN_VERSION', defaultValue: '3.6.2', description: 'Only used if RELEASE.')", "originalCommit": "1d66a7059113b11bd60e3b1450bcb0d2e018046a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1OTc2Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r447559763", "bodyText": "but we should check in the Initialize stage that if RELEASE is enabled, then PROJECT_VERSION should not be empty", "author": "radtriste", "createdAt": "2020-06-30T09:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NDIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NDYyNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r447544626", "bodyText": "NEW_BRANCH should contain the PROJECT_VERSION and should be initialized only if that version is specified (we don't fork/merge if no version)", "author": "radtriste", "createdAt": "2020-06-30T09:28:17Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -1,15 +1,24 @@\n @Library('jenkins-pipeline-shared-libraries')_\n \n+def deployProperties = [:]\n+\n pipeline {\n     agent {\n         label 'kie-rhel7 && kie-mem16g'\n     }\n     parameters {\n         string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n         string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Which branch to build ? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Is this build for a release?')\n+        string(name: 'MAVEN_VERSION', defaultValue: '3.6.2', description: 'Only used if RELEASE.')\n     }\n     environment {\n         MAVEN_OPTS = '-Xms1024m -Xmx4g'\n+        NEW_BRANCH = \"${JOB_BASE_NAME}-${BUILD_NUMBER}\"", "originalCommit": "1d66a7059113b11bd60e3b1450bcb0d2e018046a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAzNTY0OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448035649", "bodyText": "NEW_BRANCH is now an optional parameter (as per your other comment) that becomes the new branch name if set. If not, the new branch name is PROJECT_VERSION.\nThe description for the parameter mentions it's only used if RELEASE since a branch is only needed if it's a release and PR's are being made. RELEASE also now guarantees PROJECT_VERSION is specified as per your other comment.", "author": "Kevin-Mok", "createdAt": "2020-06-30T23:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NDYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NTUyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r447545529", "bodyText": "We should make that configurable directly into Jenkins instead of here", "author": "radtriste", "createdAt": "2020-06-30T09:29:42Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -1,15 +1,24 @@\n @Library('jenkins-pipeline-shared-libraries')_\n \n+def deployProperties = [:]\n+\n pipeline {\n     agent {\n         label 'kie-rhel7 && kie-mem16g'\n     }\n     parameters {\n         string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n         string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Which branch to build ? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Is this build for a release?')\n+        string(name: 'MAVEN_VERSION', defaultValue: '3.6.2', description: 'Only used if RELEASE.')\n     }\n     environment {\n         MAVEN_OPTS = '-Xms1024m -Xmx4g'\n+        NEW_BRANCH = \"${JOB_BASE_NAME}-${BUILD_NUMBER}\"\n+        GIT_USER = \"Jenkins CI\"\n+        GIT_USER_EMAIL = \"jenkins@rhba-jenkins.rhev-ci-vms.eng.rdu2.redhat.com\"", "originalCommit": "1d66a7059113b11bd60e3b1450bcb0d2e018046a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAzMzA3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448033077", "bodyText": "These are all parameters now in the latest commit.", "author": "Kevin-Mok", "createdAt": "2020-06-30T23:25:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NTUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NjA0OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r447546049", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    COMMIT_MSG = \"Update Maven version for release\"\n          \n          \n            \n                    COMMIT_MSG = \"Update Maven version for release to version ${PROJECT_VERSION}\"", "author": "radtriste", "createdAt": "2020-06-30T09:30:31Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -1,15 +1,24 @@\n @Library('jenkins-pipeline-shared-libraries')_\n \n+def deployProperties = [:]\n+\n pipeline {\n     agent {\n         label 'kie-rhel7 && kie-mem16g'\n     }\n     parameters {\n         string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n         string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Which branch to build ? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Is this build for a release?')\n+        string(name: 'MAVEN_VERSION', defaultValue: '3.6.2', description: 'Only used if RELEASE.')\n     }\n     environment {\n         MAVEN_OPTS = '-Xms1024m -Xmx4g'\n+        NEW_BRANCH = \"${JOB_BASE_NAME}-${BUILD_NUMBER}\"\n+        GIT_USER = \"Jenkins CI\"\n+        GIT_USER_EMAIL = \"jenkins@rhba-jenkins.rhev-ci-vms.eng.rdu2.redhat.com\"\n+        COMMIT_MSG = \"Update Maven version for release\"", "originalCommit": "1d66a7059113b11bd60e3b1450bcb0d2e018046a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAzNTk5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448035998", "bodyText": "I went with COMMIT_MSG = \"Update project version to ${params.PROJECT_VERSION} for release\".", "author": "Kevin-Mok", "createdAt": "2020-06-30T23:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0NjA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1ODkwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r447558904", "bodyText": "we could create the deployment.properties in any case I think", "author": "radtriste", "createdAt": "2020-06-30T09:51:20Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -76,37 +125,80 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.createBranch(NEW_BRANCH)\n+                        githubscm.commitChanges(GIT_USER, GIT_USER_EMAIL, COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", NEW_BRANCH)\n+                        deployProperties[\"kogito-runtimes.pr\"] = githubscm.createPR(COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        githubscm.createBranch(NEW_BRANCH)\n+                        githubscm.commitChanges(GIT_USER, GIT_USER_EMAIL, COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", NEW_BRANCH)\n+                        deployProperties[\"kogito-apps.pr\"] = githubscm.createPR(COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        githubscm.createBranch(NEW_BRANCH)\n+                        githubscm.commitChanges(GIT_USER, GIT_USER_EMAIL, COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", NEW_BRANCH)\n+                        deployProperties[\"kogito-examples.pr\"] = githubscm.createPR(COMMIT_MSG, \"master\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            when {\n+                expression { return params.RELEASE }\n+            }\n+            steps {\n+                script {\n+                    deployProperties[\"staging-repo.url\"] = input(message: \"Enter staging repository URL:\", parameters: [string(name: 'STAGING_REPO_URL')])\n+                }\n+            }\n+        }\n     }\n     post {\n         always {\n             junit '**/target/surefire-reports/**/*.xml, **/target/failsafe-reports/**/*.xml'\n+            script {\n+                if (params.RELEASE) {", "originalCommit": "1d66a7059113b11bd60e3b1450bcb0d2e018046a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAzNjkwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448036900", "bodyText": "Done. This makes more sense now that deployment.properties stores the  RELEASE and PROJECT_VERSION parameters and will never be empty.", "author": "Kevin-Mok", "createdAt": "2020-06-30T23:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1ODkwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU4NDgwNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r447584806", "bodyText": "We need to forkRepo first, else it won't work\nhttps://github.com/kiegroup/jenkins-pipeline-shared-libraries/blob/760f283ce035e125d8d97647894b72ee5871d455/vars/githubscm.groovy#L94\ncreatePR will return the PR link that we can save into the deployProperties as {project}.pr.link key", "author": "radtriste", "createdAt": "2020-06-30T10:36:36Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -76,37 +125,80 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.createBranch(NEW_BRANCH)", "originalCommit": "1d66a7059113b11bd60e3b1450bcb0d2e018046a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA0MDgwOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448040809", "bodyText": "We need to forkRepo first, else it won't work\n\nIt seems to work without forkRepo though. With the current flow of createBranch -> commitChanges -> pushObject -> createPR, I am still able to create a PR. See this log starting from the \"Create PR\" stage. The resulting PR links can be found in the archived deployment.properties.\n\ncreatePR will return the PR link that we can save into the deployProperties as {project}.pr.link key\n\nYep. I've set it up like so:\ndeployProperties[\"kogito-runtimes.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")", "author": "Kevin-Mok", "createdAt": "2020-06-30T23:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU4NDgwNg=="}], "type": "inlineReview"}, {"oid": "4ece5ceb9f48db89e55c47d8604fe55c2968e7b3", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4ece5ceb9f48db89e55c47d8604fe55c2968e7b3", "message": "Implement Tristan's requested fixes on 6/30", "committedDate": "2020-06-30T21:17:19Z", "type": "forcePushed"}, {"oid": "07bf37de39e3f01b2c8d0d02bc53a39a99047477", "url": "https://github.com/kiegroup/kogito-runtimes/commit/07bf37de39e3f01b2c8d0d02bc53a39a99047477", "message": "Implement Tristan's requested fixes on 6/30", "committedDate": "2020-06-30T23:24:18Z", "type": "forcePushed"}, {"oid": "fc9739cc6c288dfdbb9f4cae894cda21a0c97ab3", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fc9739cc6c288dfdbb9f4cae894cda21a0c97ab3", "message": "Implement Tristan's requested fixes on 6/30", "committedDate": "2020-06-30T23:36:04Z", "type": "forcePushed"}, {"oid": "2b16c5aca4a290657fef2be471b70a7d1cf98703", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2b16c5aca4a290657fef2be471b70a7d1cf98703", "message": "Implement Tristan's requested fixes on 6/30", "committedDate": "2020-07-01T00:03:08Z", "type": "forcePushed"}, {"oid": "77f614e3d02ab0dcf5ff3ef7264ad785c682469e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/77f614e3d02ab0dcf5ff3ef7264ad785c682469e", "message": "Implement Tristan's requested fixes on 6/30", "committedDate": "2020-07-01T00:13:30Z", "type": "forcePushed"}, {"oid": "5f8b53c0115e47dd30235c92c3030144a4f886f1", "url": "https://github.com/kiegroup/kogito-runtimes/commit/5f8b53c0115e47dd30235c92c3030144a4f886f1", "message": "Implement Tristan's requested fixes on 6/30", "committedDate": "2020-07-01T00:30:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDMxOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448214319", "bodyText": "This is only used in Create PR stage, so I think we can move this part to that stage. what do you think ?\n(the check of Version if RELEASE is set can stay)\nAlso do we need the parameter NEW_BRANCH_NAME as it will be done only in the case of a RELEASE, so the version should be set?", "author": "radtriste", "createdAt": "2020-07-01T08:48:35Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -31,12 +42,74 @@ pipeline {\n                         // Switch to branch if not on a multibranch pipeline\n                         env.BRANCH_NAME = params.BUILD_BRANCH_NAME\n                     }\n+                    deployProperties['release'] = params.RELEASE\n+                    deployProperties['project-version'] = params.PROJECT_VERSION\n+                    env.NEW_BRANCH = params.NEW_BRANCH_NAME", "originalCommit": "5f8b53c0115e47dd30235c92c3030144a4f886f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMzk4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448323982", "bodyText": "This is only used in Create PR stage, so I think we can move this part to that stage.\n\nThere will be an empty deployment.properties if the assert fails. I guess that's fine?\n\nAlso do we need the parameter NEW_BRANCH_NAME as it will be done only in the case of a RELEASE, so the version should be set?\n\nI was under the impression that your other comment suggested making NEW_BRANCH a parameter. \ud83e\udd14", "author": "Kevin-Mok", "createdAt": "2020-07-01T12:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM5MTY4Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448391683", "bodyText": "This is only used in Create PR stage, so I think we can move this part to that stage.\n\nThere will be an empty deployment.properties if the assert fails. I guess that's fine?\n\nI was referencing the NEW_BRANCH part that should be moved to Create PR stage.\nThe set of deploy properties can stay here\n\n\nAlso do we need the parameter NEW_BRANCH_NAME as it will be done only in the case of a RELEASE, so the version should be set?\n\nI was under the impression that your other comment suggested making NEW_BRANCH a parameter.\nOh I was mentioning the fact that GITHUB_USER and GITHUB_USER_EMAIL could be environment variables configured globally in Jenkins and not specifically here. Sorry if I was not clear ... no need to have them as params.  GITHUB_USER and GITHUB_USER_EMAIL can stay as env ... Sorry for the extra work there :S", "author": "radtriste", "createdAt": "2020-07-01T14:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5NDUzOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449294539", "bodyText": "I've reverted the branch name to just the PROJECT_VERSION parameter and removed the GITHUB_USER and GITHUB_USER_EMAIL parameters in favor of the globally set ones.", "author": "Kevin-Mok", "createdAt": "2020-07-02T22:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNDMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNTg1OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448215859", "bodyText": "we need to forkRepo before creating the branch", "author": "radtriste", "createdAt": "2020-07-01T08:51:04Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +165,85 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.createBranch(env.NEW_BRANCH)", "originalCommit": "5f8b53c0115e47dd30235c92c3030144a4f886f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwODQxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448308412", "bodyText": "we have multiple pom which are updated by the updateMavenVersion so they should also be added", "author": "radtriste", "createdAt": "2020-07-01T11:48:31Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +165,85 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.createBranch(env.NEW_BRANCH)\n+                        githubscm.commitChanges(params.GIT_USER, params.GIT_USER_EMAIL, env.COMMIT_MSG, \"pom.xml\")", "originalCommit": "5f8b53c0115e47dd30235c92c3030144a4f886f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNDQyMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448324423", "bodyText": "Would it just be \"pom.xml */pom.xml\"?", "author": "Kevin-Mok", "createdAt": "2020-07-01T12:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwODQxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM5MzAzOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448393038", "bodyText": "**/pom.xml should be or ?", "author": "radtriste", "createdAt": "2020-07-01T14:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwODQxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI2ODczOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449268738", "bodyText": "So, globbing won't work with functions. If you pass '**/pom.xml' to commitChanges() from the shared library as the filesToAdd parameter, it turns '**/pom.xml' into a string literal such that the shell command becomes git add '**/pom.xml' and won't match the files. See this build log which was ran with commitChanges(_, _, _, '**/README.md').  It also doesn't work with double quotes (\"**/README.md\") where it just gets converted back to single quotes in the command.\nInterestingly, if you pass in 'README.md', \"README.md\" or just use the default parameter of '--all', the parameter doesn't get turned into a string literal, and the quotes do get removed in the final command.  I'm not sure how to get around this problem. \ud83e\udd14 @Kaitou786?", "author": "Kevin-Mok", "createdAt": "2020-07-02T21:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwODQxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NDE2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450584166", "bodyText": "So after some more testing, it seems that the problem is not that ** doesn't work in quotes because apparently it does; it's just that it ** behaves strangely in Jenkins.  With the files a/b/c d/e/c f/c c, git add **/c becomes git add f/c only matches f/c.  With the files a/b/c d/e/c c, git add **/c becomes git add '**/c' and matches a/b/c and d/e/c. Basically, it seems to be inconsistent in its behavior and unreliable. So, what I came up with (with the help of this SO answer) is to use find with command substitution, which seems to get the job done.", "author": "Kevin-Mok", "createdAt": "2020-07-07T02:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwODQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwOTA2Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448309062", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                         subject: \"${env.PIPELINE_NAME} #${env.BRANCH_NAME}\",\n          \n          \n            \n                                         subject: \"${env.PIPELINE_NAME} #${env.BUILD_BRANCH_NAME}\",", "author": "radtriste", "createdAt": "2020-07-01T11:49:55Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +165,85 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.createBranch(env.NEW_BRANCH)\n+                        githubscm.commitChanges(params.GIT_USER, params.GIT_USER_EMAIL, env.COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", env.NEW_BRANCH)\n+                        deployProperties[\"kogito-runtimes.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        githubscm.createBranch(env.NEW_BRANCH)\n+                        githubscm.commitChanges(params.GIT_USER, params.GIT_USER_EMAIL, env.COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", env.NEW_BRANCH)\n+                        deployProperties[\"kogito-apps.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        githubscm.createBranch(env.NEW_BRANCH)\n+                        githubscm.commitChanges(params.GIT_USER, params.GIT_USER_EMAIL, env.COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", env.NEW_BRANCH)\n+                        deployProperties[\"kogito-examples.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            when {\n+                expression { return params.RELEASE }\n+            }\n+            steps {\n+                script {\n+                    emailext body: \"${env.PIPELINE_NAME} #${env.BUILD_NUMBER} needs a staging repository URL: ${env.BUILD_URL}input\",\n+                             subject: \"${env.PIPELINE_NAME} #${env.BRANCH_NAME}\",", "originalCommit": "5f8b53c0115e47dd30235c92c3030144a4f886f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4Nzc0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450587740", "bodyText": "Shouldn't it actually be env.BRANCH_NAME since we're checking out that branch and building it?\n\n  \n    \n      kogito-runtimes/Jenkinsfile.deploy.new\n    \n    \n         Line 39\n      in\n      1240c1f\n    \n    \n    \n    \n\n        \n          \n           checkout([$class: 'GitSCM', branches: [[name: env.BRANCH_NAME]], browser: [$class: 'GithubWeb', repoUrl: 'git@github.com:kiegroup/kogito-runtimes.git'], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'kogito-runtimes']], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'kie-ci-user-key', url: 'git@github.com:kiegroup/kogito-runtimes.git']]])", "author": "Kevin-Mok", "createdAt": "2020-07-07T03:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwOTA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2NzYwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450667608", "bodyText": "yeah because we set\nif (env.BRANCH_NAME != \"\") {\n                        // Switch to branch if not on a multibranch pipeline\n                        env.BRANCH_NAME = params.BUILD_BRANCH_NAME\n                    }\n\nlet it with BRANCH_NAME, I will surely PR later to unify this", "author": "radtriste", "createdAt": "2020-07-07T07:36:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwOTA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDYyMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r451254622", "bodyText": "I used getBuildBranch().", "author": "Kevin-Mok", "createdAt": "2020-07-08T03:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwOTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxMTMyNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448311326", "bodyText": "could we do something like this ?\npropertiesStr = deployProperties.collect{ entry ->  \"${entry.key}=${entry.value}\" }.join(\"\\n\")", "author": "radtriste", "createdAt": "2020-07-01T11:54:42Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +165,85 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.createBranch(env.NEW_BRANCH)\n+                        githubscm.commitChanges(params.GIT_USER, params.GIT_USER_EMAIL, env.COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", env.NEW_BRANCH)\n+                        deployProperties[\"kogito-runtimes.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        githubscm.createBranch(env.NEW_BRANCH)\n+                        githubscm.commitChanges(params.GIT_USER, params.GIT_USER_EMAIL, env.COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", env.NEW_BRANCH)\n+                        deployProperties[\"kogito-apps.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        githubscm.createBranch(env.NEW_BRANCH)\n+                        githubscm.commitChanges(params.GIT_USER, params.GIT_USER_EMAIL, env.COMMIT_MSG, \"pom.xml\")\n+                        githubscm.pushObject(\"origin\", env.NEW_BRANCH)\n+                        deployProperties[\"kogito-examples.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            when {\n+                expression { return params.RELEASE }\n+            }\n+            steps {\n+                script {\n+                    emailext body: \"${env.PIPELINE_NAME} #${env.BUILD_NUMBER} needs a staging repository URL: ${env.BUILD_URL}input\",\n+                             subject: \"${env.PIPELINE_NAME} #${env.BRANCH_NAME}\",\n+                             to: env.KOGITO_CI_EMAIL_TO\n+                    deployProperties[\"staging-repo.url\"] = input(message: \"Enter staging repository URL:\", parameters: [string(name: 'STAGING_REPO_URL')])\n+                }\n+            }\n+        }\n     }\n     post {\n         always {\n+            script {\n+                def propertiesStr = \"\"", "originalCommit": "5f8b53c0115e47dd30235c92c3030144a4f886f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5NDc1OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449294758", "bodyText": "Fancy. \ud83d\ude04", "author": "Kevin-Mok", "createdAt": "2020-07-02T22:35:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMxMTMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg1MTExNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r448851116", "bodyText": "can we set the project version only if not empty ?", "author": "radtriste", "createdAt": "2020-07-02T08:53:40Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -31,12 +42,74 @@ pipeline {\n                         // Switch to branch if not on a multibranch pipeline\n                         env.BRANCH_NAME = params.BUILD_BRANCH_NAME\n                     }\n+                    deployProperties['release'] = params.RELEASE\n+                    deployProperties['project-version'] = params.PROJECT_VERSION", "originalCommit": "5f8b53c0115e47dd30235c92c3030144a4f886f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fbcadbe21dce4e31a52a4010353b10ca289adbd7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fbcadbe21dce4e31a52a4010353b10ca289adbd7", "message": "Implement Tristan's requested fixes on 7/1", "committedDate": "2020-07-02T22:58:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ4ODcxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449488717", "bodyText": "we should maybe create some \"utils\" methods like getProjectVersion or isRelease to retrieve this kind of information. I guess it would be then more readable and easier to change if we add any change to it. wdyt ?", "author": "radtriste", "createdAt": "2020-07-03T09:43:29Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -31,12 +42,72 @@ pipeline {\n                         // Switch to branch if not on a multibranch pipeline\n                         env.BRANCH_NAME = params.BUILD_BRANCH_NAME\n                     }\n+                    if (params.RELEASE) {\n+                        assert params.PROJECT_VERSION != ''\n+                    }\n+                    deployProperties['release'] = params.RELEASE\n+                    if (params.PROJECT_VERSION != '') {\n+                        deployProperties['project-version'] = params.PROJECT_VERSION\n+                    }\n+                }\n+            }\n+        }\n+        stage('Clone repositories') { \n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-runtimes\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-apps\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-examples\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                // Use a separate dir for persistence to not overwrite the test results\n+                dir(\"kogito-examples-persistence\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-examples\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+            }\n+        }\n+        stage('Setup Maven release config'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n+            steps {\n+                configFileProvider([configFile(fileId: '771ff52a-a8b4-40e6-9b22-d54c7314aa1e', targetLocation: 'maven-settings.xml', variable: 'MAVEN_SETTINGS_FILE')]){\n+                    sh \"echo '-B -s ${MAVEN_SETTINGS_FILE}' | tee kogito-{runtimes,apps,examples,examples-persistence}/.mvn/maven.config\"\n+                }\n+            }\n+        }\n+        stage('Update project version'){\n+            when {\n+                expression { return params.PROJECT_VERSION != '' }", "originalCommit": "fbcadbe21dce4e31a52a4010353b10ca289adbd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3NTUwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450575501", "bodyText": "IMO, it'd be unnecessary for this deploy Jenkinsfile because the project version and release would always be parameters? We were discussing how they may be retrieved differently in the promote pipeline, and helper functions make more sense to me there. However, since it's simply going to always going to return the parameter itself in this case, it seems more readable and simplified to me if the direct parameter was used here?", "author": "Kevin-Mok", "createdAt": "2020-07-07T02:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ4ODcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2ODMxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450668312", "bodyText": "Just that I find it more readable and we unify both deploy and promote in their way of writing the code.", "author": "radtriste", "createdAt": "2020-07-07T07:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ4ODcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUwODk4NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449508984", "bodyText": "not sure that one is really needed as en var. we could just have it as local var in stage Create PR", "author": "radtriste", "createdAt": "2020-07-03T10:26:35Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -1,15 +1,26 @@\n @Library('jenkins-pipeline-shared-libraries')_\n \n+def deployProperties = [:]\n+\n pipeline {\n     agent {\n         label 'kie-rhel7 && kie-mem16g'\n     }\n     parameters {\n         string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n-        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Which branch to build ? Set if you are not on a multibranch pipeline.')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Optional if not RELEASE. If RELEASE, cannot be empty.')\n     }\n     environment {\n+        KOGITO_CI_EMAIL_TO = credentials(\"KOGITO_CI_EMAIL_TO\")\n+        PIPELINE_NAME = \"Kogito Runtimes deploy pipeline\"\n         MAVEN_OPTS = '-Xms1024m -Xmx4g'\n+        PROPERTIES_FILE = \"deployment.properties\"\n+        FILES_TO_ADD = '**/pom.xml'", "originalCommit": "fbcadbe21dce4e31a52a4010353b10ca289adbd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUwOTM0NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449509344", "bodyText": "Set pipeline name as a local var as only used here", "author": "radtriste", "createdAt": "2020-07-03T10:27:28Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +163,85 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+                        githubscm.createBranch(params.PROJECT_VERSION)\n+                        githubscm.commitChanges(env.GIT_COMMITTER_NAME, env.GIT_COMMITTER_EMAIL, env.COMMIT_MSG, env.FILES_TO_ADD)\n+                        githubscm.pushObject(\"origin\", params.PROJECT_VERSION)\n+                        deployProperties[\"kogito-runtimes.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+                        githubscm.createBranch(params.PROJECT_VERSION)\n+                        githubscm.commitChanges(env.GIT_COMMITTER_NAME, env.GIT_COMMITTER_EMAIL, env.COMMIT_MSG, env.FILES_TO_ADD)\n+                        githubscm.pushObject(\"origin\", params.PROJECT_VERSION)\n+                        deployProperties[\"kogito-apps.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+                        githubscm.createBranch(params.PROJECT_VERSION)\n+                        githubscm.commitChanges(env.GIT_COMMITTER_NAME, env.GIT_COMMITTER_EMAIL, env.COMMIT_MSG, env.FILES_TO_ADD)\n+                        githubscm.pushObject(\"origin\", params.PROJECT_VERSION)\n+                        deployProperties[\"kogito-examples.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            when {\n+                expression { return params.RELEASE }\n+            }\n+            steps {\n+                script {\n+                    emailext body: \"${env.PIPELINE_NAME} #${env.BUILD_NUMBER} needs a staging repository URL: ${env.BUILD_URL}input\",", "originalCommit": "fbcadbe21dce4e31a52a4010353b10ca289adbd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUwOTU2NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449509565", "bodyText": "I would add at the end RELEASE in the subject so we know it is in release process", "author": "radtriste", "createdAt": "2020-07-03T10:27:59Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +163,85 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+                        githubscm.createBranch(params.PROJECT_VERSION)\n+                        githubscm.commitChanges(env.GIT_COMMITTER_NAME, env.GIT_COMMITTER_EMAIL, env.COMMIT_MSG, env.FILES_TO_ADD)\n+                        githubscm.pushObject(\"origin\", params.PROJECT_VERSION)\n+                        deployProperties[\"kogito-runtimes.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+                        githubscm.createBranch(params.PROJECT_VERSION)\n+                        githubscm.commitChanges(env.GIT_COMMITTER_NAME, env.GIT_COMMITTER_EMAIL, env.COMMIT_MSG, env.FILES_TO_ADD)\n+                        githubscm.pushObject(\"origin\", params.PROJECT_VERSION)\n+                        deployProperties[\"kogito-apps.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+                        githubscm.createBranch(params.PROJECT_VERSION)\n+                        githubscm.commitChanges(env.GIT_COMMITTER_NAME, env.GIT_COMMITTER_EMAIL, env.COMMIT_MSG, env.FILES_TO_ADD)\n+                        githubscm.pushObject(\"origin\", params.PROJECT_VERSION)\n+                        deployProperties[\"kogito-examples.pr.link\"] = githubscm.createPR(env.COMMIT_MSG, \"master\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Archive staging repository URL') {\n+            when {\n+                expression { return params.RELEASE }\n+            }\n+            steps {\n+                script {\n+                    emailext body: \"${env.PIPELINE_NAME} #${env.BUILD_NUMBER} needs a staging repository URL: ${env.BUILD_URL}input\",\n+                             subject: \"${env.PIPELINE_NAME} #${env.BUILD_BRANCH_NAME}\",", "originalCommit": "fbcadbe21dce4e31a52a4010353b10ca289adbd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUxMDAwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449510000", "bodyText": "COMMIT_MSG could be a local var as well IMO", "author": "radtriste", "createdAt": "2020-07-03T10:28:54Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +163,85 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+                        githubscm.createBranch(params.PROJECT_VERSION)\n+                        githubscm.commitChanges(env.GIT_COMMITTER_NAME, env.GIT_COMMITTER_EMAIL, env.COMMIT_MSG, env.FILES_TO_ADD)", "originalCommit": "fbcadbe21dce4e31a52a4010353b10ca289adbd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2NTg3MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449565870", "bodyText": "I believe I tried this initially but since each of these scripts are separated into their own dir block, they can't access a shared local variable. But, I will refactor those very similar scripts into a function, and I can create a commitMessage variable there.", "author": "Kevin-Mok", "createdAt": "2020-07-03T12:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUxMDAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUxMDgzNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449510836", "bodyText": "maybe add also the BUILD_BRANCH_NAME as git.branch property ?", "author": "radtriste", "createdAt": "2020-07-03T10:30:48Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -31,12 +42,72 @@ pipeline {\n                         // Switch to branch if not on a multibranch pipeline\n                         env.BRANCH_NAME = params.BUILD_BRANCH_NAME\n                     }\n+                    if (params.RELEASE) {", "originalCommit": "fbcadbe21dce4e31a52a4010353b10ca289adbd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "58f3b233f3a99c978cc8833bd0f4454a29437d74", "url": "https://github.com/kiegroup/kogito-runtimes/commit/58f3b233f3a99c978cc8833bd0f4454a29437d74", "message": "Implement Tristan's requested fixes on 7/3", "committedDate": "2020-07-07T02:18:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2OTI5Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450669297", "bodyText": "as discussed in https://github.com/kiegroup/kogito-cloud-operator/pull/420/files#r450517728, it should be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            def deployProperties = [:]\n          \n          \n            \n            deployProperties = [:]\n          \n      \n    \n    \n  \n\nto have global scope", "author": "radtriste", "createdAt": "2020-07-07T07:40:00Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -1,12 +1,16 @@\n @Library('jenkins-pipeline-shared-libraries')_\n \n+def deployProperties = [:]", "originalCommit": "58f3b233f3a99c978cc8833bd0f4454a29437d74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2OTgyNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450669827", "bodyText": "BUILD_BRANCH_NAME will never be empty (default is master)", "author": "radtriste", "createdAt": "2020-07-07T07:41:03Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -31,12 +35,75 @@ pipeline {\n                         // Switch to branch if not on a multibranch pipeline\n                         env.BRANCH_NAME = params.BUILD_BRANCH_NAME\n                     }\n+                    if (params.RELEASE) {\n+                        assert params.PROJECT_VERSION != ''\n+                    }\n+                    if (params.BUILD_BRANCH_NAME != '') {", "originalCommit": "58f3b233f3a99c978cc8833bd0f4454a29437d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDM4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r451254382", "bodyText": "I copied your line: setDeployPropertyIfNeeded('git.branch', getBuildBranch()).", "author": "Kevin-Mok", "createdAt": "2020-07-08T03:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2OTgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MDI2Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r450670262", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            def propertiesFile = \"deployment.properties\"\n          \n          \n            \n                            writeFile(text: propertiesStr, file: propertiesFile)\n          \n          \n            \n                            writeFile(text: propertiesStr, file: \"deployment.properties\")", "author": "radtriste", "createdAt": "2020-07-07T07:41:54Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +159,92 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return params.RELEASE }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Get staging repository URL') {\n+            when {\n+                expression { return params.RELEASE }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes deploy pipeline\"\n+                    emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for release and needs a staging repository URL: ${env.BUILD_URL}input\",\n+                             subject: \"${pipelineName} #${params.BUILD_BRANCH_NAME}\",\n+                             to: credentials(\"KOGITO_CI_EMAIL_TO\")\n+                    deployProperties[\"staging-repo.url\"] = input(message: \"Enter staging repository URL:\", parameters: [string(name: 'STAGING_REPO_URL')])\n+                }\n+            }\n+        }\n     }\n     post {\n         always {\n+            script {\n+                def propertiesStr = deployProperties.collect{ entry ->  \"${entry.key}=${entry.value}\" }.join(\"\\n\")\n+                def propertiesFile = \"deployment.properties\"\n+                writeFile(text: propertiesStr, file: propertiesFile)", "originalCommit": "58f3b233f3a99c978cc8833bd0f4454a29437d74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQxODY5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r451418691", "bodyText": "as it is immutable, I would put that one in environment part", "author": "radtriste", "createdAt": "2020-07-08T09:45:18Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -1,12 +1,17 @@\n @Library('jenkins-pipeline-shared-libraries')_\n \n+deployProperties = [:]\n+BOT_CREDENTIALS_ID = \"bsig-gh-bot\"", "originalCommit": "b55f13c98ef999123693d7f213a4acd2da00b07b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQyMDU1OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r451420559", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for release and needs a staging repository URL: ${env.BUILD_URL}input\",\n          \n          \n            \n                                    emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for release and needs the staging repository URL. Please provide it to ${env.BUILD_URL}input\",", "author": "radtriste", "createdAt": "2020-07-08T09:48:31Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -96,41 +172,126 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Get staging repository URL') {\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes deploy pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for release and needs a staging repository URL: ${env.BUILD_URL}input\",", "originalCommit": "b55f13c98ef999123693d7f213a4acd2da00b07b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "217b614322d60ac64f3bfca826f289063ecb2edb", "url": "https://github.com/kiegroup/kogito-runtimes/commit/217b614322d60ac64f3bfca826f289063ecb2edb", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes", "committedDate": "2020-07-09T04:13:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE3NTY4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452175686", "bodyText": "This stage is done to let the pipeline knows that the staging repository has been promoted to Maven Central.\nI would set the name of the stage with a question mark, like Is staging repository promoted ?", "author": "radtriste", "createdAt": "2020-07-09T12:20:29Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,136 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Approve promotion') {", "originalCommit": "217b614322d60ac64f3bfca826f289063ecb2edb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE3NTk5OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452175999", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                             \"Approve the promotion here: ${env.BUILD_URL}input\",\n          \n          \n            \n                                             \"Please confirm promote this repository and then confirm the promotion here: ${env.BUILD_URL}input\",", "author": "radtriste", "createdAt": "2020-07-09T12:21:01Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,136 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Approve promotion') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Approve the promotion here: ${env.BUILD_URL}input\",", "originalCommit": "217b614322d60ac64f3bfca826f289063ecb2edb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE3NjUzNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452176535", "bodyText": "As stated here: https://github.com/kiegroup/kogito-cloud-operator/pull/420/files?file-filters%5B%5D=.promote#r452030869\nI am not sure we need the TOKEN", "author": "radtriste", "createdAt": "2020-07-09T12:22:06Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,136 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Approve promotion') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Approve the promotion here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Approve for promotion?\"\n+                }\n+            }\n+        }\n+        /* stage('Merge PR') { // TODO\n+            when {\n+                expression {\n+                    return isRelease()\n+                }\n+            }\n+            steps{\n+                script {\n+                    githubscm.mergePR()\n+                }\n+            }\n+        } */\n+        /* stage('Git tag') { // TODO\n+            when {\n+                expression {\n+                    return getGitTag() != \"\"\n+                }\n+            }\n+            steps {\n+                // TODO: retrieve latest BUILD_BRANCH_NAME/GIT_AUTHOR?\n+                githubscm.tagRepository()\n+            }\n+        } */\n+        /* stage('Set next snapshot') { // TODO\n+        } */\n+    }\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Deployment properties\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void readDeployProperties(){\n+    if (params.DEPLOY_BUILD_URL != null){\n+        withCredentials([usernamePassword(credentialsId: 'rhba-jenkins-token', usernameVariable: 'JENKINS_USER', passwordVariable: 'JENKINS_TOKEN')]) {", "originalCommit": "217b614322d60ac64f3bfca826f289063ecb2edb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "url": "https://github.com/kiegroup/kogito-runtimes/commit/77e9de002ddbc0ad864a31ab431dc2bb061d1249", "message": "KOGITO-{2375,2376,2377} (untested)", "committedDate": "2020-07-10T09:54:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1NjE2OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452756169", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    sh \"mvn -B clean install -DskipTests\"\n          \n          \n            \n                                    // Step needed to have runtimes artifacts into the local repository, in order to set apps version correctly\n          \n          \n            \n                                    sh \"mvn -B clean install -DskipTests\"", "author": "radtriste", "createdAt": "2020-07-10T10:17:20Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -29,14 +33,90 @@ pipeline {\n \n                     if (env.BRANCH_NAME != \"\") {\n                         // Switch to branch if not on a multibranch pipeline\n-                        env.BRANCH_NAME = params.BUILD_BRANCH_NAME\n+                        env.BRANCH_NAME = getBuildBranch()\n+                    }\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    setDeployPropertyIfNeeded('git.branch', getBuildBranch())\n+                    setDeployPropertyIfNeeded('project.version', getProjectVersion())\n+                    setDeployPropertyIfNeeded('release', isRelease())\n+                }\n+            }\n+        }\n+        stage('Clone repositories') { \n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-runtimes\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-apps\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-examples\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+                // Use a separate dir for persistence to not overwrite the test results\n+                dir(\"kogito-examples-persistence\") {\n+                    checkout(githubscm.resolveRepository(\"kogito-examples\", \"kiegroup\", env.BRANCH_NAME, false))\n+                }\n+            }\n+        }\n+        stage('Prepare for PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-apps\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-examples\") {\n+                    prepareForPR()\n+                }\n+            }\n+        }\n+        stage('Setup Maven release config'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                configFileProvider([configFile(fileId: '771ff52a-a8b4-40e6-9b22-d54c7314aa1e', targetLocation: 'maven-settings.xml', variable: 'MAVEN_SETTINGS_FILE')]){\n+                    sh \"echo '-B -s ${MAVEN_SETTINGS_FILE}' | tee kogito-{runtimes,apps,examples,examples-persistence}/.mvn/maven.config\"\n+                }\n+            }\n+        }\n+        stage('Update project version'){\n+            when {\n+                expression { return getProjectVersion() != '' }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.mvnVersionsSet(getProjectVersion())\n+                        sh \"mvn -B clean install -DskipTests\"", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1NzY2OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452757668", "bodyText": "I think we should have 3 different stages here, one for each project for the Merge PR", "author": "radtriste", "createdAt": "2020-07-10T10:20:40Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge deploy PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1ODU3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452758577", "bodyText": "push of a tag should be git push --tags\nand we should push the getGitTag()", "author": "radtriste", "createdAt": "2020-07-10T10:22:37Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge deploy PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Git tag') {\n+            when {\n+                expression { return getGitTag() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    tagLatest(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    tagLatest(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    tagLatest(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Prepare for snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    prepareForPR()\n+                }\n+            }\n+        }\n+        stage('Set next snapshot') {\n+            when {\n+                expression { return getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    sh \"mvn -B clean install -DskipTests\"\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                }\n+            }\n+        }\n+        stage('Create snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge snapshot PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Deployment properties\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void readDeployProperties(){\n+    if (params.DEPLOY_BUILD_URL != null){\n+        sh \"wget ${params.DEPLOY_BUILD_URL}artifact/${PROPERTIES_FILE_NAME}\"\n+        deployProperties = readProperties file: PROPERTIES_FILE_NAME\n+        // echo all properties\n+        echo deployProperties.collect{ entry -> \"${entry.key}=${entry.value}\" }.join(\"\\n\")\n+    }\n+}\n+\n+boolean hasDeployProperty(String key){\n+    return deployProperties[key] != null\n+}\n+\n+String getDeployProperty(String key){\n+    if(hasDeployProperty(key)){\n+        return deployProperties[key]\n+    }\n+    return \"\"\n+}\n+\n+String getParamOrDeployProperty(String paramKey, String deployPropertyKey){\n+    if (params[paramKey] != \"\"){\n+        return params[paramKey]\n+    }\n+    return getDeployProperty(deployPropertyKey)\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Getter / Setter\n+//////////////////////////////////////////////////////////////////////////////\n+\n+boolean isRelease() {\n+    return params.RELEASE || (getDeployProperty(\"release\") == \"true\")\n+}\n+\n+String getProjectVersion() {\n+    return getParamOrDeployProperty(\"PROJECT_VERSION\", \"project.version\")\n+}\n+\n+String getSnapshotVersion() {\n+    return util.getNextSnapshot(getProjectVersion())\n+}\n+\n+String getGitTag() {\n+    return params.GIT_TAG != \"\" ? params.GIT_TAG : getProjectVersion()\n+}\n+\n+String getBuildBranch() {\n+    return getParamOrDeployProperty(\"BUILD_BRANCH_NAME\", \"git.branch\")\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Git\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void checkoutRepo(String repo) {\n+    checkout(githubscm.resolveRepository(repo, \"kiegroup\", getBuildBranch(), false))\n+    sh \"git checkout ${getBuildBranch()}\"\n+}\n+\n+void mergeAndPush(String repo) {\n+    githubscm.mergePR(getDeployProperty(\"${repo}.pr.link\"))\n+    githubscm.pushObject(\"origin\", getBuildBranch())\n+}\n+\n+void tagLatest(String repo) {\n+    githubscm.tagRepository(getGitTag(), BUILD_TAG)\n+    githubscm.pushObject(\"origin\", BUILD_TAG)", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1NDU2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452854566", "bodyText": "btw, we would need to have latest change before tagging or ?", "author": "radtriste", "createdAt": "2020-07-10T13:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1ODU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NTU5MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r453355590", "bodyText": "btw, we would need to have latest change before tagging or ?\n\nI don't think so because in the previous \"Merge deploy PR\" stage, we check out the repo, merge the PR and push to origin, so the local version should already be the most updated.", "author": "Kevin-Mok", "createdAt": "2020-07-12T19:43:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1ODU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg2MjUyNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454862525", "bodyText": "so when merging the PR, changes are automatically merged also on local ?", "author": "radtriste", "createdAt": "2020-07-15T07:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1ODU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg2MzgzOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454863839", "bodyText": "ok just saw the other comment ...", "author": "radtriste", "createdAt": "2020-07-15T07:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1ODU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1OTI5Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452759292", "bodyText": "why tagLatest ?", "author": "radtriste", "createdAt": "2020-07-10T10:24:08Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge deploy PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Git tag') {\n+            when {\n+                expression { return getGitTag() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    tagLatest(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    tagLatest(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    tagLatest(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Prepare for snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    prepareForPR()\n+                }\n+            }\n+        }\n+        stage('Set next snapshot') {\n+            when {\n+                expression { return getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    sh \"mvn -B clean install -DskipTests\"\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                }\n+            }\n+        }\n+        stage('Create snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge snapshot PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Deployment properties\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void readDeployProperties(){\n+    if (params.DEPLOY_BUILD_URL != null){\n+        sh \"wget ${params.DEPLOY_BUILD_URL}artifact/${PROPERTIES_FILE_NAME}\"\n+        deployProperties = readProperties file: PROPERTIES_FILE_NAME\n+        // echo all properties\n+        echo deployProperties.collect{ entry -> \"${entry.key}=${entry.value}\" }.join(\"\\n\")\n+    }\n+}\n+\n+boolean hasDeployProperty(String key){\n+    return deployProperties[key] != null\n+}\n+\n+String getDeployProperty(String key){\n+    if(hasDeployProperty(key)){\n+        return deployProperties[key]\n+    }\n+    return \"\"\n+}\n+\n+String getParamOrDeployProperty(String paramKey, String deployPropertyKey){\n+    if (params[paramKey] != \"\"){\n+        return params[paramKey]\n+    }\n+    return getDeployProperty(deployPropertyKey)\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Getter / Setter\n+//////////////////////////////////////////////////////////////////////////////\n+\n+boolean isRelease() {\n+    return params.RELEASE || (getDeployProperty(\"release\") == \"true\")\n+}\n+\n+String getProjectVersion() {\n+    return getParamOrDeployProperty(\"PROJECT_VERSION\", \"project.version\")\n+}\n+\n+String getSnapshotVersion() {\n+    return util.getNextSnapshot(getProjectVersion())\n+}\n+\n+String getGitTag() {\n+    return params.GIT_TAG != \"\" ? params.GIT_TAG : getProjectVersion()\n+}\n+\n+String getBuildBranch() {\n+    return getParamOrDeployProperty(\"BUILD_BRANCH_NAME\", \"git.branch\")\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Git\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void checkoutRepo(String repo) {\n+    checkout(githubscm.resolveRepository(repo, \"kiegroup\", getBuildBranch(), false))\n+    sh \"git checkout ${getBuildBranch()}\"\n+}\n+\n+void mergeAndPush(String repo) {\n+    githubscm.mergePR(getDeployProperty(\"${repo}.pr.link\"))\n+    githubscm.pushObject(\"origin\", getBuildBranch())\n+}\n+\n+void tagLatest(String repo) {", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NTg3NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r453355875", "bodyText": "I was basing it on your TODO comment in the \"Git tag\" stage: // TODO Retrieve latest BUILD_BRANCH_NAME / GIT_AUTHOR ? I'm not sure what else to call it; do you have a suggestion?", "author": "Kevin-Mok", "createdAt": "2020-07-12T19:46:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1OTI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg2Mjc1NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454862755", "bodyText": "tagRemoteRepo ?", "author": "radtriste", "createdAt": "2020-07-15T07:55:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc1OTI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2MDUxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452760513", "bodyText": "I think we could have one stage by project doing those steps instead of having many staging for each action\nIt would be called something like Set and push next snapshot and include so:\n\nPrepare\nSet next snapshot\nCreate & Merge PR", "author": "radtriste", "createdAt": "2020-07-10T10:26:45Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge deploy PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Git tag') {\n+            when {\n+                expression { return getGitTag() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    tagLatest(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    tagLatest(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    tagLatest(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Prepare for snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    prepareForPR()\n+                }\n+            }\n+        }\n+        stage('Set next snapshot') {\n+            when {\n+                expression { return getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    sh \"mvn -B clean install -DskipTests\"\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                }\n+            }\n+        }\n+        stage('Create snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge snapshot PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM2NDAwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r453364004", "bodyText": "This is a much cleaner approach.", "author": "Kevin-Mok", "createdAt": "2020-07-12T21:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2MDUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2MDgxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452760814", "bodyText": "why do you checkout the getBuildBranch() after ? isn't it done by the first checkout ?", "author": "radtriste", "createdAt": "2020-07-10T10:27:26Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge deploy PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Git tag') {\n+            when {\n+                expression { return getGitTag() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    tagLatest(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    tagLatest(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    tagLatest(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Prepare for snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    prepareForPR()\n+                }\n+            }\n+        }\n+        stage('Set next snapshot') {\n+            when {\n+                expression { return getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    sh \"mvn -B clean install -DskipTests\"\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                }\n+            }\n+        }\n+        stage('Create snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge snapshot PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Deployment properties\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void readDeployProperties(){\n+    if (params.DEPLOY_BUILD_URL != null){\n+        sh \"wget ${params.DEPLOY_BUILD_URL}artifact/${PROPERTIES_FILE_NAME}\"\n+        deployProperties = readProperties file: PROPERTIES_FILE_NAME\n+        // echo all properties\n+        echo deployProperties.collect{ entry -> \"${entry.key}=${entry.value}\" }.join(\"\\n\")\n+    }\n+}\n+\n+boolean hasDeployProperty(String key){\n+    return deployProperties[key] != null\n+}\n+\n+String getDeployProperty(String key){\n+    if(hasDeployProperty(key)){\n+        return deployProperties[key]\n+    }\n+    return \"\"\n+}\n+\n+String getParamOrDeployProperty(String paramKey, String deployPropertyKey){\n+    if (params[paramKey] != \"\"){\n+        return params[paramKey]\n+    }\n+    return getDeployProperty(deployPropertyKey)\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Getter / Setter\n+//////////////////////////////////////////////////////////////////////////////\n+\n+boolean isRelease() {\n+    return params.RELEASE || (getDeployProperty(\"release\") == \"true\")\n+}\n+\n+String getProjectVersion() {\n+    return getParamOrDeployProperty(\"PROJECT_VERSION\", \"project.version\")\n+}\n+\n+String getSnapshotVersion() {\n+    return util.getNextSnapshot(getProjectVersion())\n+}\n+\n+String getGitTag() {\n+    return params.GIT_TAG != \"\" ? params.GIT_TAG : getProjectVersion()\n+}\n+\n+String getBuildBranch() {\n+    return getParamOrDeployProperty(\"BUILD_BRANCH_NAME\", \"git.branch\")\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Git\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void checkoutRepo(String repo) {\n+    checkout(githubscm.resolveRepository(repo, \"kiegroup\", getBuildBranch(), false))\n+    sh \"git checkout ${getBuildBranch()}\"", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NjkxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r453356913", "bodyText": "It's on a detached branch after checkout. See this build log where the following script was run (end of line comments are output):\ncheckout(githubscm.resolveRepository(\"jenkins-test\", \"Kevin-Mok\", \"master\", false))\nsh \"\"\"\ngit branch          # (detached from c73ac4d)\ngit checkout master # Switched to a new branch 'master'\ngit branch          # master\n\"\"\"", "author": "Kevin-Mok", "createdAt": "2020-07-12T19:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2MDgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg2NTE3OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454865178", "bodyText": "oki. Can you add a comment so we understand that quickly ? :)", "author": "radtriste", "createdAt": "2020-07-15T08:00:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2MDgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2MTIyNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452761226", "bodyText": "why do we need to push after the merging of PR ?", "author": "radtriste", "createdAt": "2020-07-10T10:28:20Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge deploy PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Git tag') {\n+            when {\n+                expression { return getGitTag() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    tagLatest(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    tagLatest(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    tagLatest(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Prepare for snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    prepareForPR()\n+                }\n+            }\n+        }\n+        stage('Set next snapshot') {\n+            when {\n+                expression { return getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    sh \"mvn -B clean install -DskipTests\"\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                }\n+            }\n+        }\n+        stage('Create snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge snapshot PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Deployment properties\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void readDeployProperties(){\n+    if (params.DEPLOY_BUILD_URL != null){\n+        sh \"wget ${params.DEPLOY_BUILD_URL}artifact/${PROPERTIES_FILE_NAME}\"\n+        deployProperties = readProperties file: PROPERTIES_FILE_NAME\n+        // echo all properties\n+        echo deployProperties.collect{ entry -> \"${entry.key}=${entry.value}\" }.join(\"\\n\")\n+    }\n+}\n+\n+boolean hasDeployProperty(String key){\n+    return deployProperties[key] != null\n+}\n+\n+String getDeployProperty(String key){\n+    if(hasDeployProperty(key)){\n+        return deployProperties[key]\n+    }\n+    return \"\"\n+}\n+\n+String getParamOrDeployProperty(String paramKey, String deployPropertyKey){\n+    if (params[paramKey] != \"\"){\n+        return params[paramKey]\n+    }\n+    return getDeployProperty(deployPropertyKey)\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Getter / Setter\n+//////////////////////////////////////////////////////////////////////////////\n+\n+boolean isRelease() {\n+    return params.RELEASE || (getDeployProperty(\"release\") == \"true\")\n+}\n+\n+String getProjectVersion() {\n+    return getParamOrDeployProperty(\"PROJECT_VERSION\", \"project.version\")\n+}\n+\n+String getSnapshotVersion() {\n+    return util.getNextSnapshot(getProjectVersion())\n+}\n+\n+String getGitTag() {\n+    return params.GIT_TAG != \"\" ? params.GIT_TAG : getProjectVersion()\n+}\n+\n+String getBuildBranch() {\n+    return getParamOrDeployProperty(\"BUILD_BRANCH_NAME\", \"git.branch\")\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Git\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void checkoutRepo(String repo) {\n+    checkout(githubscm.resolveRepository(repo, \"kiegroup\", getBuildBranch(), false))\n+    sh \"git checkout ${getBuildBranch()}\"\n+}\n+\n+void mergeAndPush(String repo) {\n+    githubscm.mergePR(getDeployProperty(\"${repo}.pr.link\"))\n+    githubscm.pushObject(\"origin\", getBuildBranch())", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1Nzg1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r453357850", "bodyText": "hub merge only creates a local commit. From its man page:\n\n[hub merge] creates a local merge commit in the current branch, but does not actually change the state of the pull request. However, the pull request will get auto-closed and marked as \"merged\" as soon as the newly created merge commit is pushed to the default branch of the remote repository.", "author": "Kevin-Mok", "createdAt": "2020-07-12T20:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc2MTIyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMDEwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452810100", "bodyText": "build branch should not be empty anyway here or ?", "author": "radtriste", "createdAt": "2020-07-10T12:24:54Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1ODA3OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r453358079", "bodyText": "I just copied an older version of your \"Initialization\" stage. But, I see that it's gone now, so I will remove it too. \ud83d\ude04", "author": "Kevin-Mok", "createdAt": "2020-07-12T20:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMDEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1OTU2NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r452859564", "bodyText": "is that needed here ?", "author": "radtriste", "createdAt": "2020-07-10T13:56:04Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,282 @@\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                    if (getGitTag() != \"\"){\n+                        assert getBuildBranch() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge deploy PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Git tag') {\n+            when {\n+                expression { return getGitTag() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes\") {\n+                    tagLatest(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    tagLatest(\"kogito-apps\")\n+                }\n+                dir(\"kogito-examples\") {\n+                    tagLatest(\"kogito-examples\")\n+                }\n+            }\n+        }\n+        stage('Prepare for snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR()\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    prepareForPR()\n+                }\n+            }\n+        }\n+        stage('Set next snapshot') {\n+            when {\n+                expression { return getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    sh \"mvn -B clean install -DskipTests\"\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                }\n+                dir(\"kogito-examples-bot\") {\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                }\n+            }\n+        }\n+        stage('Create snapshot PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps-bot\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge snapshot PR') {\n+            when {\n+                expression {\n+                    return isRelease() && \n+                           getDeployProperty('kogito-runtimes.pr.link') != '' && \n+                           getDeployProperty('kogito-apps.pr.link') != '' && \n+                           getDeployProperty('kogito-examples.pr.link') != ''", "originalCommit": "77e9de002ddbc0ad864a31ab431dc2bb061d1249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1ODgxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r453358814", "bodyText": "This will be gone when I create separate stages for each project as you suggested in your other comment.", "author": "Kevin-Mok", "createdAt": "2020-07-12T20:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1OTU2NA=="}], "type": "inlineReview"}, {"oid": "f0ce05c97770dd50da910d8129c85f3b51de0740", "url": "https://github.com/kiegroup/kogito-runtimes/commit/f0ce05c97770dd50da910d8129c85f3b51de0740", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-07-14T23:20:06Z", "type": "forcePushed"}, {"oid": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "url": "https://github.com/kiegroup/kogito-runtimes/commit/21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-07-15T00:40:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyOTc5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454929794", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                             subject: \"${pipelineName} #${getBuildBranch()}\",\n          \n          \n            \n                                             subject: \"Release #${getBuildBranch()}\",\n          \n      \n    \n    \n  \n\nI don't remember if I asked for a change on that ...\nI think it would be good to add the Release in the subject and not put the pipeline name, so if other pipelines need also to notify, they can reuse the same stream.", "author": "radtriste", "createdAt": "2020-07-15T09:48:58Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -111,41 +186,125 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Create PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n             steps {\n                 dir(\"kogito-runtimes\") {\n                     script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                        commitAndCreatePR(\"kogito-runtimes\")\n+                    }\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-apps\")\n+                    }\n+                }\n+                dir(\"kogito-examples\") {\n+                    script {\n+                        commitAndCreatePR(\"kogito-examples\")\n                     }\n                 }\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Deploy artifacts') {\n             steps {\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                    }\n+                }\n                 dir(\"kogito-apps\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n-            }\n-        }\n-        stage('Deploy kogito-examples') {\n-            steps {\n                 dir(\"kogito-examples\") {\n                     script {\n                         maven.runMavenWithSubmarineSettings('clean deploy', true)\n                     }\n                 }\n             }\n         }\n+        stage('Get staging repository URL') {\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes deploy pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for release and needs the staging repository URL. Please provide it at: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzMzMxNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r455433315", "bodyText": "Should it be the build branch after it or the project version then?", "author": "Kevin-Mok", "createdAt": "2020-07-16T00:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyOTc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NzA1Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r455667057", "bodyText": "good question.\nI would keep one stream per release branch. so the build branch should be enough for now. We can still easily update this later", "author": "radtriste", "createdAt": "2020-07-16T09:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyOTc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzMTgzNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454931834", "bodyText": "sorry for being a PITA, but could we also add a STAGING_REPO_URL parameter that would override this deploy property if set ? I think it could be useful...", "author": "radtriste", "createdAt": "2020-07-15T09:52:22Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzMjE0NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454932145", "bodyText": "Same here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                             subject: \"${pipelineName} #${getBuildBranch()}\",\n          \n          \n            \n                                             subject: \"Release #${getBuildBranch()}\",", "author": "radtriste", "createdAt": "2020-07-15T09:52:54Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzMzA2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454933066", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n          \n          \n            \n                                    emailext body: \"${getProjectVersion()} artifacts are ready for promotion.\\n\" +", "author": "radtriste", "createdAt": "2020-07-15T09:54:33Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNDAxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454934013", "bodyText": "we would still merge if no git tag I think.\n(but indeed the other way would not be wise)\nI think we can just check isRelease() here and do accordingly in the steps", "author": "radtriste", "createdAt": "2020-07-15T09:56:12Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzNzEyOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r455437128", "bodyText": "So for here and the other stages, only check isRelease() and that's it?", "author": "Kevin-Mok", "createdAt": "2020-07-16T00:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNDAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NjIxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r455666214", "bodyText": "yep, and add if clause for each of the steps in the  script that will execute if the value is not empty", "author": "radtriste", "createdAt": "2020-07-16T09:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNDAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNDMwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454934300", "bodyText": "no git tag check here then ?", "author": "radtriste", "createdAt": "2020-07-15T09:56:44Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNDM0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454934340", "bodyText": "no git tag check here then ?", "author": "radtriste", "createdAt": "2020-07-15T09:56:48Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-examples.pr.link') != ''", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNDg4Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454934883", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            expression { return isRelease() && getProjectVersion() != \"\" }\n          \n          \n            \n                            expression { return isRelease() }\n          \n      \n    \n    \n  \n\nproject version cannot be empty if release :)", "author": "radtriste", "createdAt": "2020-07-15T09:57:45Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Create/merge runtimes snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNTE1NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454935155", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    stage('Create/merge runtimes snapshot PR'){\n          \n          \n            \n                    stage('Set runtimes next snapshot version'){", "author": "radtriste", "createdAt": "2020-07-15T09:58:11Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Create/merge runtimes snapshot PR'){", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNTQ4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454935482", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            expression { return isRelease() && getProjectVersion() != \"\" }\n          \n          \n            \n                            expression { return isRelease() }", "author": "radtriste", "createdAt": "2020-07-15T09:58:42Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Create/merge runtimes snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR(\"kogito-runtimes\")\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    // Step needed to have runtimes artifacts into the local repository, in order to set apps version correctly\n+                    sh \"mvn -B clean install -DskipTests\"\n+                    commitAndCreatePR(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        if (getDeployProperty('kogito-runtimes.pr.link') != ''){\n+                            mergeAndPush(\"kogito-runtimes\")\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        stage('Create/merge apps snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNTY4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454935686", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    stage('Create/merge apps snapshot PR'){\n          \n          \n            \n                    stage('Set apps next snapshot version'){", "author": "radtriste", "createdAt": "2020-07-15T09:59:03Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Create/merge runtimes snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR(\"kogito-runtimes\")\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    // Step needed to have runtimes artifacts into the local repository, in order to set apps version correctly\n+                    sh \"mvn -B clean install -DskipTests\"\n+                    commitAndCreatePR(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        if (getDeployProperty('kogito-runtimes.pr.link') != ''){\n+                            mergeAndPush(\"kogito-runtimes\")\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        stage('Create/merge apps snapshot PR'){", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNjU1MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454936551", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    stage('Create/merge examples snapshot PR'){\n          \n          \n            \n                    stage('Set examples next snapshot version'){", "author": "radtriste", "createdAt": "2020-07-15T10:00:20Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Create/merge runtimes snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR(\"kogito-runtimes\")\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    // Step needed to have runtimes artifacts into the local repository, in order to set apps version correctly\n+                    sh \"mvn -B clean install -DskipTests\"\n+                    commitAndCreatePR(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        if (getDeployProperty('kogito-runtimes.pr.link') != ''){\n+                            mergeAndPush(\"kogito-runtimes\")\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        stage('Create/merge apps snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR(\"kogito-apps\")\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                    commitAndCreatePR(\"kogito-apps\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        if (getDeployProperty('kogito-apps.pr.link') != ''){\n+                            mergeAndPush(\"kogito-apps\")\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        stage('Create/merge examples snapshot PR'){", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkzNjYyMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r454936621", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            expression { return isRelease() && getProjectVersion() != \"\" }\n          \n          \n            \n                            expression { return isRelease() }", "author": "radtriste", "createdAt": "2020-07-15T10:00:28Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,272 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7 && kie-mem16g'\n+    }\n+    environment {\n+        PROPERTIES_FILE_NAME = \"deployment.properties\"\n+        BOT_CREDENTIALS_ID = \"bsig-gh-bot\"\n+    }\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        string(name: 'GIT_AUTHOR', defaultValue: 'kiegroup', description: 'Which Git author repository ?')\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: 'master', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    if (params.DISPLAY_NAME != \"\") {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getDeployProperty('staging-repo.url') != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes promote pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getDeployProperty('staging-repo.url')}\\n\" +\n+                                 \"Please confirm that the staging repository has been promoted here: ${env.BUILD_URL}input\",\n+                                 subject: \"${pipelineName} #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: \"Has the staging repository been promoted?\", ok: \"Yes\"\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() &&\n+                           getDeployProperty('kogito-runtimes.pr.link') != '' &&\n+                           getGitTag() != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-runtimes\") {\n+                    checkoutRepo(\"kogito-runtimes\")\n+                    mergeAndPush(\"kogito-runtimes\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-apps.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-apps\") {\n+                    checkoutRepo(\"kogito-apps\")\n+                    mergeAndPush(\"kogito-apps\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression {\n+                    return isRelease() && getDeployProperty('kogito-examples.pr.link') != ''\n+                }\n+            }\n+            steps{\n+                dir(\"kogito-examples\") {\n+                    checkoutRepo(\"kogito-examples\")\n+                    mergeAndPush(\"kogito-examples\")\n+                    tagLatest()\n+                }\n+            }\n+        }\n+        stage('Create/merge runtimes snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-runtimes-bot\") {\n+                    prepareForPR(\"kogito-runtimes\")\n+                    maven.mvnVersionsSet(getSnapshotVersion())\n+                    // Step needed to have runtimes artifacts into the local repository, in order to set apps version correctly\n+                    sh \"mvn -B clean install -DskipTests\"\n+                    commitAndCreatePR(\"kogito-runtimes\")\n+                }\n+                dir(\"kogito-runtimes\") {\n+                    script {\n+                        if (getDeployProperty('kogito-runtimes.pr.link') != ''){\n+                            mergeAndPush(\"kogito-runtimes\")\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        stage('Create/merge apps snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }\n+            }\n+            steps {\n+                dir(\"kogito-apps-bot\") {\n+                    prepareForPR(\"kogito-apps\")\n+                    maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion())\n+                    commitAndCreatePR(\"kogito-apps\")\n+                }\n+                dir(\"kogito-apps\") {\n+                    script {\n+                        if (getDeployProperty('kogito-apps.pr.link') != ''){\n+                            mergeAndPush(\"kogito-apps\")\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        stage('Create/merge examples snapshot PR'){\n+            when {\n+                expression { return isRelease() && getProjectVersion() != \"\" }", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyMDQ0OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r455120448", "bodyText": "what about copying the Jenkinsfile.promote to resources before compiling and testing, via copy-resources plugin ?", "author": "radtriste", "createdAt": "2020-07-15T14:59:10Z", "path": "jenkins-spock-tests/src/test/resources/Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1 @@\n+../../../../Jenkinsfile.promote", "originalCommit": "21d95582c7d282aa8c18b36a7791e1d7e0124fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df7f89d7768ae51ce25db80fe09ebde0b204eda4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/df7f89d7768ae51ce25db80fe09ebde0b204eda4", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-07-16T05:41:43Z", "type": "forcePushed"}, {"oid": "3990c7dfee96b4efb74c80ee92467766a4f0f3c5", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3990c7dfee96b4efb74c80ee92467766a4f0f3c5", "message": "Implement Tristan's requested fixes on 7/15 (2)", "committedDate": "2020-07-16T14:42:03Z", "type": "forcePushed"}, {"oid": "cee377ee556b2d16969d1b6fb7b43a4d920a9622", "url": "https://github.com/kiegroup/kogito-runtimes/commit/cee377ee556b2d16969d1b6fb7b43a4d920a9622", "message": "KOGITO-2286 Modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-07-16T14:45:52Z", "type": "forcePushed"}, {"oid": "cb49119d71ab556b6c92011c059db5da8cdd44f9", "url": "https://github.com/kiegroup/kogito-runtimes/commit/cb49119d71ab556b6c92011c059db5da8cdd44f9", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-07-16T16:22:52Z", "type": "forcePushed"}, {"oid": "68420d1f6ce04879efb7ce0290beea50f26ad014", "url": "https://github.com/kiegroup/kogito-runtimes/commit/68420d1f6ce04879efb7ce0290beea50f26ad014", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-07-20T23:02:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY1NjM2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r458656366", "bodyText": "wasn't there a branch problem here ?", "author": "radtriste", "createdAt": "2020-07-22T09:21:14Z", "path": "Jenkinsfile.deploy.new", "diffHunk": "@@ -111,41 +156,152 @@ pipeline {\n                 }\n             }\n         }\n-        stage('Deploy kogito-runtimes') {\n+        stage('Deploy artifacts') {\n             steps {\n-                dir(\"kogito-runtimes\") {\n-                    script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n-                    }\n-                }\n+                mavenDeploy(\"kogito-runtimes\")\n+                mavenDeploy(\"kogito-apps\")\n+                mavenDeploy(\"kogito-examples\")\n             }\n         }\n-        stage('Deploy kogito-apps') {\n+        stage('Get staging repository URL') {\n+            when {\n+                expression { return isRelease() }\n+            }\n             steps {\n-                dir(\"kogito-apps\") {\n-                    script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                script {\n+                    def pipelineName = \"Kogito Runtimes deploy pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for release and needs the staging repository URL. Please provide it at: ${env.BUILD_URL}input\",\n+                                 subject: \"Release #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n                     }\n+                    deployProperties[\"staging-repo.url\"] = input(message: \"Enter staging repository URL:\", parameters: [string(name: 'STAGING_REPO_URL')])\n                 }\n             }\n         }\n-        stage('Deploy kogito-examples') {\n+        stage('Create PR'){\n+            when {\n+                expression { return isRelease() }\n+            }\n             steps {\n-                dir(\"kogito-examples\") {\n-                    script {\n-                        maven.runMavenWithSubmarineSettings('clean deploy', true)\n+                commitAndCreatePR(\"kogito-runtimes\")\n+                commitAndCreatePR(\"kogito-apps\")\n+                commitAndCreatePR(\"kogito-examples\")\n+            }\n+        }\n+        stage('Get staging repository URL') {\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = \"Kogito Runtimes deploy pipeline\"\n+                    withCredentials([string(credentialsId: \"KOGITO_CI_EMAIL_TO\", variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${pipelineName} #${env.BUILD_NUMBER} is ready for release and needs the staging repository URL. Please provide it at: ${env.BUILD_URL}input\",\n+                                 subject: \"Release #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n                     }\n+                    deployProperties[\"staging-repo.url\"] = input(message: \"Enter staging repository URL:\", parameters: [string(name: 'STAGING_REPO_URL')])\n                 }\n             }\n         }\n     }\n     post {\n         always {\n+            script {\n+                def propertiesStr = deployProperties.collect{ entry ->  \"${entry.key}=${entry.value}\" }.join(\"\\n\")\n+                writeFile(text: propertiesStr, file: \"deployment.properties\")\n+                archiveArtifacts(artifacts: \"deployment.properties\")\n+            }\n             cleanWs()\n         }\n     }\n }\n \n void saveReports(boolean allowEmpty=false){\n     junit testResults: '**/target/surefire-reports/**/*.xml, **/target/failsafe-reports/**/*.xml', allowEmptyResults: allowEmpty\n-}\n\\ No newline at end of file\n+}\n+\n+void cloneRepo(String repo, String dirName=repo) {\n+    dir(dirName) {\n+        checkout(githubscm.resolveRepository(repo, getGitAuthor(), getBuildBranch(), false))", "originalCommit": "68420d1f6ce04879efb7ce0290beea50f26ad014", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0NDY2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r458744666", "bodyText": "That's only for the promote Jenkinsfile since we need to merge a PR and push it. Here, we create a new branch in the \"Prepare for PR\" stage, so it's not a problem.", "author": "Kevin-Mok", "createdAt": "2020-07-22T12:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY1NjM2Ng=="}], "type": "inlineReview"}, {"oid": "ba7f3783b4a8571ac94faf4691a1c6d3b92ee927", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ba7f3783b4a8571ac94faf4691a1c6d3b92ee927", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-07-29T04:18:09Z", "type": "forcePushed"}, {"oid": "4a516b9209d9ce09261dfffed66717f18a47108e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4a516b9209d9ce09261dfffed66717f18a47108e", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot", "committedDate": "2020-08-04T13:30:21Z", "type": "forcePushed"}, {"oid": "699e08791baa45cfebd755a427393fd3888777d9", "url": "https://github.com/kiegroup/kogito-runtimes/commit/699e08791baa45cfebd755a427393fd3888777d9", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot\n\nTesting/adjustments for the release pipeline were done by Tristan:\nhttps://github.com/Kevin-Mok/kogito-runtimes/pull/15\n\nCo-authored-by: Tristan Radisson <tristan.radisson@gmail.com>", "committedDate": "2020-08-10T14:10:58Z", "type": "forcePushed"}, {"oid": "1399cada918c089afb7c3f0464f65a89b31b431e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/1399cada918c089afb7c3f0464f65a89b31b431e", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot\n\nTesting/adjustments for the release pipeline were done by Tristan: https://github.com/Kevin-Mok/kogito-runtimes/pull/15\n\nCo-authored-by: Tristan Radisson <tristan.radisson@gmail.com>", "committedDate": "2020-08-10T14:14:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzODgyMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r467938821", "bodyText": "@radtriste Do we actually need this block?", "author": "Kevin-Mok", "createdAt": "2020-08-10T14:22:36Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -0,0 +1,375 @@\n+import org.jenkinsci.plugins.workflow.libs.Library\n+@Library('jenkins-pipeline-shared-libraries')_\n+\n+deployProperties = [:]\n+pipelineProperties = [:]\n+\n+pipeline {\n+    agent {\n+        label 'kie-rhel7'\n+    }\n+\n+    tools {\n+        maven 'kie-maven-3.6.2'\n+        jdk 'kie-jdk11'\n+    }\n+    \n+    options {\n+        buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '10')\n+    }\n+\n+    parameters {\n+        string(name: 'DISPLAY_NAME', defaultValue: '', description: 'Setup a specific build display name')\n+        \n+        // Deploy job url to retrieve deployment.properties\n+        string(name: 'DEPLOY_BUILD_URL', defaultValue: '', description: 'URL to jenkins deploy build to retrieve the `deployment.properties` file. If base parameters are defined, they will override the `deployment.properties` information')\n+        \n+        // Git information which can override `deployment.properties`\n+        string(name: 'BUILD_BRANCH_NAME', defaultValue: '', description: 'Override `deployment.properties`. Which branch to build? Set if you are not on a multibranch pipeline.')\n+        string(name: 'GIT_AUTHOR', defaultValue: '', description: 'Override `deployment.properties`. Which Git author repository ?')\n+        \n+        // Release information which can override `deployment.properties`\n+        booleanParam(name: 'RELEASE', defaultValue: false, description: 'Override `deployment.properties`. Is this build for a release?')\n+        string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Override `deployment.properties`. Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        string(name: 'STAGING_REPO_URL', defaultValue: '', description: 'Override `deployment.properties`.')\n+        string(name: 'GIT_TAG', defaultValue: '', description: 'Git tag to set, if different from PROJECT_VERSION')\n+    }\n+\n+    environment {\n+        PROPERTIES_FILE_NAME = 'deployment.properties'\n+        \n+        AUTHOR_CREDS_ID = 'kie-ci'\n+        GITHUB_TOKEN_CREDS_ID = 'kie-ci2-token'\n+        BOT_CREDENTIALS_ID = 'bsig-gh-bot'\n+\n+        BOT_BRANCH_HASH = \"${util.generateHash(10)}\"\n+        \n+        GITHUB_CLI_VERSION = '0.11.1'\n+    }\n+\n+    stages {\n+        stage('Initialization') {\n+            steps {\n+                script {\n+                    cleanWs()\n+                    \n+                    if (params.DISPLAY_NAME != '') {\n+                        currentBuild.displayName = params.DISPLAY_NAME\n+                    }\n+\n+                    readDeployProperties()\n+\n+                    if (isRelease()) {\n+                        assert getProjectVersion() != ''\n+                    }\n+\n+                    installGithubCLI()\n+                }\n+            }\n+        }\n+        stage('Is staging repository promoted?') {\n+            when {\n+                expression { return isRelease() && getStagingRepoUrl() != '' }\n+            }\n+            steps {\n+                script {\n+                    def pipelineName = 'Kogito Runtimes promote pipeline'\n+                    withCredentials([string(credentialsId: 'KOGITO_CI_EMAIL_TO', variable: 'ZULIP_EMAIL')]) {\n+                        emailext body: \"${getProjectVersion()} artifacts are ready for promotion.\\n\" +\n+                                 \"The staging repository can be found at: ${getStagingRepoUrl()}\\n\" +\n+                                 \"Please promote the repository and then confirm the promotion here: ${env.BUILD_URL}input\",\n+                                 subject: \"Kogito Release on #${getBuildBranch()}\",\n+                                 to: ZULIP_EMAIL\n+                    }\n+                    input message: 'Has the staging repository been promoted?', ok: 'Yes'\n+                }\n+            }\n+        }\n+        stage('Merge runtimes deploy PR and tag') {\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps{\n+                script {\n+                    dir('kogito-runtimes') {\n+                        checkoutRepo('kogito-runtimes')\n+                        mergeAndPush('kogito-runtimes', getDeployPrLink('kogito-runtimes'))\n+                        tagLatest()\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge apps deploy PR and tag') {\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps{\n+                script {\n+                    dir('kogito-apps') {\n+                        checkoutRepo('kogito-apps')\n+                        mergeAndPush('kogito-apps', getDeployPrLink('kogito-apps'))\n+                        tagLatest()\n+                    }\n+                }\n+            }\n+        }\n+        stage('Merge examples deploy PR and tag') {\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps{\n+                script {\n+                    dir('kogito-examples') {\n+                        checkoutRepo('kogito-examples')\n+                        mergeAndPush('kogito-examples', getDeployPrLink('kogito-examples'))\n+                        tagLatest()\n+\n+\n+                        githubscm.createBranch('stable')\n+                        forcePushProtectedBranch('kogito-examples', 'stable', 'master')\n+                    }\n+                }\n+            }\n+        }\n+        stage('Set runtimes next snapshot version'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                script {\n+                    dir('kogito-runtimes-bot') {\n+                        prepareForPR('kogito-runtimes')\n+\n+                        // first build&install the current version (usually SNAPSHOT) as it is needed later by other repos\n+                        sh 'mvn -B -U -Dfull clean install -DskipTests'\n+                        maven.mvnVersionsSet(getSnapshotVersion(), true)\n+                        // Step needed to have runtimes artifacts into the local repository, in order to set apps version correctly\n+                        sh 'mvn -B clean install -DskipTests'\n+\n+                        commitAndCreatePR('kogito-runtimes')\n+                    }\n+                    dir('kogito-runtimes') {\n+                        sh \"git checkout ${getBuildBranch()}\"\n+                        mergeAndPush('kogito-runtimes', getPipelinePrLink('kogito-runtimes'))\n+                    }\n+                }\n+            }\n+        }\n+        stage('Set apps next snapshot version'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                script {\n+                    dir('kogito-apps-bot') {\n+                        prepareForPR('kogito-apps')\n+                        maven.mvnVersionsUpdateParentAndChildModules(getSnapshotVersion(), true)\n+                        commitAndCreatePR('kogito-apps')\n+                    }\n+                    dir('kogito-apps') {\n+                        sh \"git checkout ${getBuildBranch()}\"\n+                        mergeAndPush('kogito-apps', getPipelinePrLink('kogito-apps'))\n+                    }\n+                }\n+            }\n+        }\n+        stage('Set examples next snapshot version'){\n+            when {\n+                expression { return isRelease() }\n+            }\n+            steps {\n+                script {\n+                    dir('kogito-examples-bot') {\n+                        prepareForPR('kogito-examples')\n+                        maven.mvnVersionsSet(getSnapshotVersion(), true)\n+                        commitAndCreatePR('kogito-examples')\n+                    }\n+                    dir('kogito-examples') {\n+                        sh \"git checkout ${getBuildBranch()}\"\n+                        mergeAndPush('kogito-examples', getPipelinePrLink('kogito-examples'))\n+                    }\n+                }\n+            }\n+        }\n+    }\n+    post {\n+        always {\n+            cleanWs()\n+        }\n+    }\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Deployment properties\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void readDeployProperties(){\n+    String deployUrl = params.DEPLOY_BUILD_URL\n+    if (deployUrl != ''){\n+        if(!deployUrl.endsWith('/')){\n+            deployUrl += '/'\n+        }\n+        sh \"wget ${deployUrl}artifact/${PROPERTIES_FILE_NAME} -O ${PROPERTIES_FILE_NAME}\"\n+        deployProperties = readProperties file: PROPERTIES_FILE_NAME\n+        // echo all properties\n+        echo deployProperties.collect{ entry -> \"${entry.key}=${entry.value}\" }.join('\\n')\n+    }\n+}\n+\n+boolean hasDeployProperty(String key){\n+    return deployProperties[key] != null\n+}\n+\n+String getDeployProperty(String key){\n+    if(hasDeployProperty(key)){\n+        return deployProperties[key]\n+    }\n+    return ''\n+}\n+\n+String getParamOrDeployProperty(String paramKey, String deployPropertyKey){\n+    if (params[paramKey] != ''){\n+        return params[paramKey]\n+    }\n+    return getDeployProperty(deployPropertyKey)\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Getter / Setter\n+//////////////////////////////////////////////////////////////////////////////\n+\n+boolean isRelease() {\n+    return params.RELEASE || (getDeployProperty('release') == 'true')\n+}\n+\n+String getProjectVersion() {\n+    return getParamOrDeployProperty('PROJECT_VERSION', 'project.version')\n+}\n+\n+String getSnapshotVersion() {\n+    return util.getNextVersion(getProjectVersion(), 'micro')\n+}\n+\n+String getGitTag() {\n+    return params.GIT_TAG != '' ? params.GIT_TAG : getProjectVersion()\n+}\n+\n+String getBuildBranch() {\n+    return getParamOrDeployProperty('BUILD_BRANCH_NAME', 'git.branch')\n+}\n+\n+String getGitAuthor() {\n+    return getParamOrDeployProperty('GIT_AUTHOR', 'git.author')\n+}\n+\n+String getStagingRepoUrl(){\n+    return getParamOrDeployProperty('STAGING_REPO_URL', 'staging-repo.url')\n+}\n+\n+String getDeployPrLink(String repo){\n+    return getDeployProperty(\"${repo}.pr.link\")\n+}\n+\n+String getPipelinePrLink(String repo){\n+    return pipelineProperties[\"${repo}.pr.link\"]\n+}\n+\n+void setPipelinePrLink(String repo, String value){\n+    pipelineProperties[\"${repo}.pr.link\"] = value\n+}\n+\n+String getSnapshotBranch(){\n+    return \"${getSnapshotVersion().toLowerCase()}-${env.BOT_BRANCH_HASH}\"\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////\n+// Git\n+//////////////////////////////////////////////////////////////////////////////\n+\n+void checkoutRepo(String repo) {\n+    deleteDir()\n+    checkout(githubscm.resolveRepository(repo, getGitAuthor(), getBuildBranch(), false))\n+    // need to manually checkout branch since on a detached branch after checkout command\n+    sh \"git checkout ${getBuildBranch()}\"\n+}\n+\n+void mergeAndPush(String repo, String prLink) {\n+    if (prLink != '') {\n+        githubscm.mergePR(prLink, env.AUTHOR_CREDS_ID)\n+        githubscm.pushObject('origin', getBuildBranch(), env.AUTHOR_CREDS_ID)\n+    }\n+}\n+\n+void tagLatest() {\n+    if (getGitTag() != '') {\n+        githubscm.tagRepository(getGitTag(), env.BUILD_TAG)\n+        githubscm.pushObject('origin', \"--tags ${getGitTag()}\", env.AUTHOR_CREDS_ID)\n+    }\n+}\n+\n+void prepareForPR(String repo) {\n+    checkoutRepo(repo)\n+    githubscm.forkRepo(env.BOT_CREDENTIALS_ID)\n+    githubscm.createBranch(getSnapshotBranch())\n+}\n+\n+void addNotIgnoredPoms() {\n+    // based on https://stackoverflow.com/a/59888964/8811872\n+    sh '''\n+    find . -type f -name 'pom.xml' > found_poms.txt\n+    poms_to_add=\"\"\n+    while IFS= read -r pom; do\n+        if ! git check-ignore -q \"\\$pom\"; then\n+            poms_to_add=\"\\$poms_to_add \\$pom\"\n+        fi\n+    done < found_poms.txt\n+    rm found_poms.txt\n+    git add \\$poms_to_add\n+    '''\n+}\n+\n+void commitAndCreatePR(String repo) {\n+    def commitMsg = \"Update snapshot version to ${getSnapshotBranch()}\"\n+    def prBody = \"Generated by build ${BUILD_TAG}: ${BUILD_URL}\"\n+    // Not using githubscm.commitChanges() because globbing won't work.\n+    // See: https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449268738\n+    addNotIgnoredPoms()\n+    sh \"git commit -m '${commitMsg}'\"\n+    githubscm.pushObject('origin', getSnapshotBranch(), env.BOT_CREDENTIALS_ID)\n+    setPipelinePrLink(repo, githubscm.createPR(commitMsg, prBody, getBuildBranch(), env.BOT_CREDENTIALS_ID))\n+}\n+\n+void installGithubCLI() {\n+    sh \"\"\"\n+    wget https://github.com/cli/cli/releases/download/v${env.GITHUB_CLI_VERSION}/gh_${env.GITHUB_CLI_VERSION}_linux_amd64.tar.gz\n+    tar xzf gh_${env.GITHUB_CLI_VERSION}_linux_amd64.tar.gz\n+    mv gh_${env.GITHUB_CLI_VERSION}_linux_amd64/bin/gh .\n+    rm -r gh_${env.GITHUB_CLI_VERSION}_linux_amd64*\n+    \"\"\"\n+}\n+\n+void setDefaultBranch(String repo, String defaultBranch) {\n+    withCredentials([usernamePassword(credentialsId: env.AUTHOR_CREDS_ID, usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {", "originalCommit": "1399cada918c089afb7c3f0464f65a89b31b431e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0Mzg5Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r467943897", "bodyText": "right... not sure we still need it ... GITHUB_TOKEN should be enough", "author": "radtriste", "createdAt": "2020-08-10T14:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzODgyMQ=="}], "type": "inlineReview"}, {"oid": "eb9c4434f34e085a8c65632407e9b5ea9776d8c7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/eb9c4434f34e085a8c65632407e9b5ea9776d8c7", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot\n\nTesting/adjustments for the release pipeline were done by Tristan: https://github.com/Kevin-Mok/kogito-runtimes/pull/15\n\nCo-authored-by: Tristan Radisson <tristan.radisson@gmail.com>", "committedDate": "2020-08-10T15:22:28Z", "type": "forcePushed"}, {"oid": "847701617ec44144609f60fc395a1f48401b3308", "url": "https://github.com/kiegroup/kogito-runtimes/commit/847701617ec44144609f60fc395a1f48401b3308", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot\n\nTesting/adjustments for the release pipeline were done by Tristan: https://github.com/Kevin-Mok/kogito-runtimes/pull/15\n\nCo-authored-by: Tristan Radisson <tristan.radisson@gmail.com>", "committedDate": "2020-08-10T15:23:47Z", "type": "commit"}, {"oid": "847701617ec44144609f60fc395a1f48401b3308", "url": "https://github.com/kiegroup/kogito-runtimes/commit/847701617ec44144609f60fc395a1f48401b3308", "message": "KOGITO-2286 Pipeline modifications for release process\n\nThis is a commit for the following issues:\n- KOGITO-2286 Kogito Runtimes deploy pipeline: Add release parameter and staging repository information\n- KOGITO-2414 Kogito Runtimes deploy pipeline: Add \"Set mvn version\" step\n- KOGITO-2415 Kogito Runtimes deploy pipeline: Add \"Create PR\" step\n- KOGITO-2287 Kogito Runtimes promote pipeline: Create Jenkinsfile for promoting runtimes\n- KOGITO-2375 Kogito Runtimes promote pipeline: Handling of Merge PR\n- KOGITO-2376 Kogito Runtimes promote pipeline: Handling of Git tagging\n- KOGITO-2377 Kogito Runtimes promote pipeline: Set next snapshot\n\nTesting/adjustments for the release pipeline were done by Tristan: https://github.com/Kevin-Mok/kogito-runtimes/pull/15\n\nCo-authored-by: Tristan Radisson <tristan.radisson@gmail.com>", "committedDate": "2020-08-10T15:23:47Z", "type": "forcePushed"}]}