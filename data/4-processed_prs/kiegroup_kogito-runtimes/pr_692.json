{"pr_number": 692, "pr_title": "KOGITO-3009 Consolidate Docker image tests to use kogito-test-utils", "pr_createdAt": "2020-08-11T13:55:36Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/692", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MzA4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469043082", "bodyText": "I named it KogitoKafkaContainer on purpose to distinguish from the one provided by testcontainers. If both are called the same, final user could have doubts about which one to use.", "author": "Sgitario", "createdAt": "2020-08-12T06:53:36Z", "path": "kogito-test-utils/src/main/java/org/kie/kogito/testcontainers/KafkaContainer.java", "diffHunk": "@@ -18,26 +18,24 @@\n import org.kie.kogito.resources.TestResource;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.testcontainers.containers.KafkaContainer;\n import org.testcontainers.containers.output.Slf4jLogConsumer;\n \n /**\n  * Kafka Container for Kogito examples.\n  */\n-public class KogitoKafkaContainer extends KafkaContainer implements TestResource {\n+public class KafkaContainer extends org.testcontainers.containers.KafkaContainer implements TestResource {", "originalCommit": "a5d0a47060ac9f9ee650da96d75880c0b0b129b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTczOTU4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469739582", "bodyText": "so I think we should rename Infinispan and Keyckloack to Kogito* ? Its just that the naming is not consistent between these. I dont really have a strong preference for one way or another.", "author": "cristianonicolai", "createdAt": "2020-08-13T07:04:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MzA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0MDk5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469740994", "bodyText": "I would rather to append Kogito to Infinispan and Keycloak test containers instead of having a name conflict with KafkaContainer. But that's only my feeling :)", "author": "Sgitario", "createdAt": "2020-08-13T07:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MzA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5NzI4NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469897284", "bodyText": "np, added Kogito* as prefix for container names.", "author": "cristianonicolai", "createdAt": "2020-08-13T11:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MzA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjczNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469046737", "bodyText": "There is an issue here. If the container is disabled by configuration, the start will be called, but the inner container won't be started.\nA possible solution to this could be:\n\nMake the start method \"final\" in ConditionalQuarkusTestResource and ConditionalSpringBootTestResource, so we won't allow to override it.\nAdd a new method preStart in ConditionalQuarkusTestResource and ConditionalSpringBootTestResource which is executed always when the test resource is enabled.\nThe new preStart method could return the map and the start method could join the maps.\n\nWhat do you think?", "author": "Sgitario", "createdAt": "2020-08-12T07:01:39Z", "path": "kogito-test-utils/src/main/java/org/kie/kogito/testcontainers/quarkus/KeycloakQuarkusTestResource.java", "diffHunk": "@@ -40,12 +57,21 @@ protected String getKogitoPropertyValue() {\n         return String.format(\"http://localhost:%s/auth/realms/kogito\", getTestResource().getMappedPort());\n     }\n \n+    @Override\n+    public Map<String, String> start() {\n+        final Map<String, String> start = super.start();", "originalCommit": "a5d0a47060ac9f9ee650da96d75880c0b0b129b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0MTAxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469741017", "bodyText": "In that case start map would be empty so the entire logic here would be skipped. Am I missing something?", "author": "cristianonicolai", "createdAt": "2020-08-13T07:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0MzUyNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469743524", "bodyText": "Well, we're relying on an underlying implementation detail: start() returns an empty map. Tomorrow, it might return an inmmutable map and this code would return an exception. Or maybe we could decide to inject the parameters in the start() method.", "author": "Sgitario", "createdAt": "2020-08-13T07:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5Nzk4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469897986", "bodyText": "ok, for now I changed the implementation so that it doesnt matter if the returned map is immutable or not. Regarding future improvements, we can look into that as needed :)", "author": "cristianonicolai", "createdAt": "2020-08-13T11:59:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0ODIxNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469048216", "bodyText": "I was following the approach of having the arguments \"container.image.[COMPONENT].version\" (see this PR to consolidate the one in Infinispan).\nI don't mind to use either \"version.org.[COMPONENT]\" or \"container.image.[COMPONENT].version\" but let's use the same approach.\nIf you prefer using \"version.org.[COMPONENT]\", I would need to make some changes in some PRs (as it implies changes also in kogito-apps and kogito-examples).", "author": "Sgitario", "createdAt": "2020-08-12T07:04:57Z", "path": "pom.xml", "diffHunk": "@@ -154,8 +154,7 @@\n \n     <!-- container images for testing -->\n     <container.image.infinispan>quay.io/infinispan/server:${version.org.infinispan.image}</container.image.infinispan>\n-    <container.image.keycloak.version>8.0.1</container.image.keycloak.version>", "originalCommit": "a5d0a47060ac9f9ee650da96d75880c0b0b129b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTczOTk5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469739994", "bodyText": "As discussed, we will prefer to use \"version.org.[COMPONENT]\"", "author": "cristianonicolai", "createdAt": "2020-08-13T07:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0ODIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0MDQ3OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/692#discussion_r469740479", "bodyText": "+1", "author": "Sgitario", "createdAt": "2020-08-13T07:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0ODIxNg=="}], "type": "inlineReview"}, {"oid": "2038fcc91158e571d9cd6a47c2ed7724d045cc8f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2038fcc91158e571d9cd6a47c2ed7724d045cc8f", "message": "KOGITO-3009 Consolidate Docker image tests to use kogito-test-utils", "committedDate": "2020-08-13T11:39:57Z", "type": "forcePushed"}, {"oid": "3e95ab1eead8b3db43ed675f6512d498800d53d0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3e95ab1eead8b3db43ed675f6512d498800d53d0", "message": "KOGITO-3009 Consolidate Docker image tests to use kogito-test-utils", "committedDate": "2020-08-13T11:41:25Z", "type": "forcePushed"}, {"oid": "b5cf4c9f50ef97c3d8edda8c34270519f70d68ef", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b5cf4c9f50ef97c3d8edda8c34270519f70d68ef", "message": "KOGITO-3009 Consolidate Docker image tests to use kogito-test-utils", "committedDate": "2020-08-13T11:43:33Z", "type": "commit"}, {"oid": "b5cf4c9f50ef97c3d8edda8c34270519f70d68ef", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b5cf4c9f50ef97c3d8edda8c34270519f70d68ef", "message": "KOGITO-3009 Consolidate Docker image tests to use kogito-test-utils", "committedDate": "2020-08-13T11:43:33Z", "type": "forcePushed"}]}