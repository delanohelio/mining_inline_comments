{"pr_number": 293, "pr_title": "KOGITO-885 [Jobs Service] Add health check for Jobs Service", "pr_createdAt": "2020-01-23T18:51:54Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/293", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2NjcwNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r370666705", "bodyText": "The scope is also inherited?", "author": "ricardozanini", "createdAt": "2020-01-24T14:39:38Z", "path": "addons/persistence/infinispan-quarkus-health/pom.xml", "diffHunk": "@@ -0,0 +1,74 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+  ~\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~ You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <parent>\n+    <artifactId>persistence</artifactId>\n+    <groupId>org.kie.kogito</groupId>\n+    <version>8.0.0-SNAPSHOT</version>\n+  </parent>\n+  <modelVersion>4.0.0</modelVersion>\n+\n+  <artifactId>infinispan-quarkus-health</artifactId>\n+  <description>Infinispan Health Check for Quarkus</description>\n+\n+  <dependencies>\n+    <dependency>\n+      <groupId>io.quarkus</groupId>\n+      <artifactId>quarkus-infinispan-client</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>io.smallrye</groupId>\n+      <artifactId>smallrye-health</artifactId>\n+    </dependency>\n+\n+    <!-- test dependencies -->\n+    <dependency>\n+      <groupId>io.quarkus</groupId>\n+      <artifactId>quarkus-junit5</artifactId>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.testcontainers</groupId>\n+      <artifactId>testcontainers</artifactId>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.assertj</groupId>\n+      <artifactId>assertj-core</artifactId>", "originalCommit": "e0820f1b1d97cb2dfda9bf6fa1eab5d0092e9e8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEyNjU5NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r371126595", "bodyText": "no, it should be test scope, great catch.", "author": "tiagodolphine", "createdAt": "2020-01-27T09:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2NjcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEyODMxMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r371128310", "bodyText": "done", "author": "tiagodolphine", "createdAt": "2020-01-27T09:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2NjcwNQ=="}], "type": "inlineReview"}, {"oid": "f8cfe51dbaf3704fea84c423050a48d40b5dc35f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/f8cfe51dbaf3704fea84c423050a48d40b5dc35f", "message": "KOGITO-885 [Jobs Service] Add health check for Jobs Service", "committedDate": "2020-01-27T09:05:21Z", "type": "commit"}, {"oid": "41465626566aeb0fb2c9cfc2e941990e646c4e9e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/41465626566aeb0fb2c9cfc2e941990e646c4e9e", "message": "changing assertj scope to test", "committedDate": "2020-01-27T09:14:15Z", "type": "commit"}, {"oid": "41465626566aeb0fb2c9cfc2e941990e646c4e9e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/41465626566aeb0fb2c9cfc2e941990e646c4e9e", "message": "changing assertj scope to test", "committedDate": "2020-01-27T09:14:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MzY0OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372553648", "bodyText": "Isn't this overridden anyway when deploying to Openshift? Or is it for local testing?", "author": "MarianMacik", "createdAt": "2020-01-29T18:26:04Z", "path": "addons/jobs/jobs-service/src/main/resources/application.properties", "diffHunk": "@@ -64,8 +64,10 @@ kogito.service.url=http://localhost:8080\n kogito.jobs-service.events-support=false\n \n #enabled with the profile: 'events-support' (-Dquarkus.profile=events-support)\n+%events-support.quarkus.kafka.health.enabled=true\n+%events-support.quarkus.kafka.bootstrap-servers=localhost:9092", "originalCommit": "41465626566aeb0fb2c9cfc2e941990e646c4e9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjU1MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372806551", "bodyText": "yes, it must be overridden on openshift and it could be overridden in case, in your local testing you use a Kafka cluster on a different host other than the localhost, np.\nThis property is set with localhost just to make things easier, to see the property name and override, this does not affect any behavior just explicitly show the default is localhost:9092.", "author": "tiagodolphine", "createdAt": "2020-01-30T08:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MzY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2OTUwNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372869506", "bodyText": "ok, thanks", "author": "MarianMacik", "createdAt": "2020-01-30T10:28:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1MzY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MjU5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372562591", "bodyText": "The name of the method suggests we will always return DOWN response, but it depends on the state parameter. Can we remain it to just buildReponse or buildHealthCheckResponse for the sake of readability?", "author": "MarianMacik", "createdAt": "2020-01-29T18:43:50Z", "path": "addons/persistence/infinispan-quarkus-health/src/main/java/org/kie/kogito/infinispan/health/InfinispanHealthCheck.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.infinispan.health;\n+\n+import java.net.SocketAddress;\n+import java.util.Collections;\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+\n+import javax.enterprise.inject.Instance;\n+\n+import org.eclipse.microprofile.health.HealthCheck;\n+import org.eclipse.microprofile.health.HealthCheckResponse;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.configuration.Configuration;\n+import org.infinispan.client.hotrod.event.impl.ClientListenerNotifier;\n+import org.infinispan.client.hotrod.impl.operations.OperationsFactory;\n+import org.infinispan.client.hotrod.impl.operations.PingOperation;\n+import org.infinispan.client.hotrod.impl.operations.PingResponse;\n+import org.infinispan.client.hotrod.impl.protocol.Codec;\n+import org.infinispan.client.hotrod.impl.transport.netty.ChannelFactory;\n+\n+/**\n+ * This is a health check implementation for Infinispan Hot Rod Server, based on client and\n+ * {@link RemoteCacheManager}. Basically it executes a ping operation to all nodes and if all are down it responds as\n+ * Down, otherwise it responds as Up.\n+ */\n+public class InfinispanHealthCheck implements HealthCheck {\n+\n+    private Optional<RemoteCacheManager> cacheManagerOptional;\n+\n+    public InfinispanHealthCheck(Instance<RemoteCacheManager> cacheManagerInstance) {\n+        this.cacheManagerOptional = Optional.of(cacheManagerInstance)\n+                .filter(Instance::isResolvable)\n+                .map(Instance::get);\n+    }\n+\n+    @Override\n+    public HealthCheckResponse call() {\n+        return cacheManagerOptional.map(cacheManager -> {\n+\n+            final ChannelFactory channelFactory = cacheManager.getChannelFactory();\n+            final Codec codec = cacheManager.getCodec();\n+            final Configuration configuration = cacheManager.getConfiguration();\n+            final ClientListenerNotifier listenerNotifier = new ClientListenerNotifier(codec,\n+                                                                                       cacheManager.getMarshaller(),\n+                                                                                       channelFactory,\n+                                                                                       configuration);\n+            final OperationsFactory operationsFactory = new OperationsFactory(channelFactory,\n+                                                                              codec,\n+                                                                              listenerNotifier,\n+                                                                              configuration);\n+\n+            return Optional.of(channelFactory\n+                                       .getServers()\n+                                       .stream()\n+                                       .map(server -> invokePingOperation(channelFactory, operationsFactory, server)\n+                                               .thenApply(PingResponse::isSuccess)\n+                                               .exceptionally(ex -> false))\n+                                       .map(op -> {\n+                                           try {\n+                                               return op.get(500, TimeUnit.MILLISECONDS);\n+                                           } catch (Exception e) {\n+                                               return false;\n+                                           }\n+                                       })\n+                                       .allMatch(Boolean.FALSE::equals))\n+                    .map(allDown -> buildDownResponse(channelFactory, !allDown))\n+                    .orElse(buildDownResponse(channelFactory, false));\n+        }).orElse(null);\n+    }\n+\n+    private HealthCheckResponse buildDownResponse(ChannelFactory channelFactory, boolean state) {", "originalCommit": "41465626566aeb0fb2c9cfc2e941990e646c4e9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNTA2Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372805067", "bodyText": "Done.", "author": "tiagodolphine", "createdAt": "2020-01-30T08:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MjU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2Mzc3Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372563772", "bodyText": "Just FYI, after this is merged we will have 3 almost identical InfinispanServerTestResource classes. Wdyt about unifying them? I can create a separate module for test resources/test classes in general so we won't duplicate things. Wdyt @cristianonicolai ?", "author": "MarianMacik", "createdAt": "2020-01-29T18:46:06Z", "path": "addons/persistence/infinispan-quarkus-health/src/test/java/org/kie/kogito/infinispan/InfinispanServerTestResource.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.infinispan;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import io.quarkus.test.common.QuarkusTestResourceLifecycleManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+\n+public class InfinispanServerTestResource implements QuarkusTestResourceLifecycleManager {", "originalCommit": "41465626566aeb0fb2c9cfc2e941990e646c4e9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4NDY4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372584685", "bodyText": "+1 to unify, we need to create a shared module for these test resources.", "author": "cristianonicolai", "createdAt": "2020-01-29T19:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2Mzc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4NTQ0NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372585445", "bodyText": "I'm happy for that to be handled on another JIRA/PR.", "author": "cristianonicolai", "createdAt": "2020-01-29T19:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2Mzc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc5MTU5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372791591", "bodyText": "Sure, I can probably plan something for next week/sprint.", "author": "MarianMacik", "createdAt": "2020-01-30T07:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2Mzc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNDExMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372804113", "bodyText": "+1", "author": "tiagodolphine", "createdAt": "2020-01-30T08:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2Mzc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3OTE4Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372579183", "bodyText": "Just an organizational question. Since this is really not an addon, rather a permanent part of jobs-service, wouldn't it make more sense to put it in the job-service module? Or do we want to include it into the Kogito generated app as well in the future? Then I guess it won't make sense for Spring Boot runtime.", "author": "MarianMacik", "createdAt": "2020-01-29T19:16:15Z", "path": "addons/persistence/pom.xml", "diffHunk": "@@ -11,5 +11,6 @@\n   <description>Kogito Persistence Implementations</description>\n   <modules>\n     <module>infinispan-persistence-addon</module>\n+    <module>infinispan-quarkus-health</module>", "originalCommit": "41465626566aeb0fb2c9cfc2e941990e646c4e9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4NDkyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372584929", "bodyText": "it will be included into data index as well.", "author": "cristianonicolai", "createdAt": "2020-01-29T19:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3OTE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNDAyOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372804028", "bodyText": "the reason as Cristiano mentioned for this module, is to be shared with whatever service that uses infinispan. I chose this place to insert but we can move it to any other module.", "author": "tiagodolphine", "createdAt": "2020-01-30T08:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3OTE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3MTE5OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r372871199", "bodyText": "OK, makes sense, then I would just make the name consistent with other addons, e.g. infinispan-quarkus-health-addon. Wdyt? So users can in future add it into the kogito app knowing it is an addon. I guess then we will provide code generation to expose the healthcheck endpoint in case addon is on classpath.", "author": "MarianMacik", "createdAt": "2020-01-30T10:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3OTE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM4MTU3OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/293#discussion_r373381578", "bodyText": "done", "author": "tiagodolphine", "createdAt": "2020-01-31T09:18:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3OTE4Mw=="}], "type": "inlineReview"}, {"oid": "dd209ff4fced07ceeebad9022a7459a2504e3d3a", "url": "https://github.com/kiegroup/kogito-runtimes/commit/dd209ff4fced07ceeebad9022a7459a2504e3d3a", "message": "Changing buildResponse method name on InfinispanHealthCheck", "committedDate": "2020-01-30T08:05:57Z", "type": "commit"}, {"oid": "547fb0f40833abd50585d8b1b7f61776160e48d0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/547fb0f40833abd50585d8b1b7f61776160e48d0", "message": "Reinserting the onStart on InfinispanConfiguration", "committedDate": "2020-01-30T08:48:09Z", "type": "commit"}, {"oid": "a1f124f90a703ad6f62b7716b32adf3a12696898", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a1f124f90a703ad6f62b7716b32adf3a12696898", "message": "changing module name infinispan-quarkus-health-addon", "committedDate": "2020-01-31T09:15:04Z", "type": "commit"}]}