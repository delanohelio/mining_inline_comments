{"pr_number": 865, "pr_title": "KOGITO-3716 Allow automatic close of staging repo", "pr_createdAt": "2020-11-03T07:46:11Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/865", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg4NjE2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r517886166", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \"--projects ${parentProjectName ?: directory}\"\n          \n          \n            \n                    cmd += \" --projects ${parentProjectName ?: directory}\"", "author": "radtriste", "createdAt": "2020-11-05T08:55:53Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -270,9 +273,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \"--projects ${parentProjectName ?: directory}\"", "originalCommit": "2020d8585240de01fd3429f99cf34ce2bb3e626c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwMDU2Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r517900562", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \" --projects ${parentProjectName ?: directory}\"\n          \n          \n            \n                    cmd += \" --projects :${parentProjectName ?: directory}\"", "author": "radtriste", "createdAt": "2020-11-05T09:18:27Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -270,9 +273,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \" --projects ${parentProjectName ?: directory}\"", "originalCommit": "2a6b4193614734bb85a37fff0c0d8a1f88e96673", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyMDEyNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r517920127", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \"--projects ${directory}\"\n          \n          \n            \n                    cmd += \" --projects :${parentProjectName ?: directory}\"", "author": "radtriste", "createdAt": "2020-11-05T09:49:10Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -270,9 +273,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \" --projects :${parentProjectName ?: directory}\"\n+        cmd += \" -DnexusUrl=${env.NEXUS_RELEASE_URL}\"\n+        cmd += \" -DserverId=${env.NEXUS_RELEASE_REPOSITORY_ID}\" \n+        cmd += \" -DrepositoryDirectory=${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        cmd += \" -DstagingProfileId=${env.NEXUS_STAGING_REPOSITORY_ID}\" \n+        cmd += \" -DstagingDescription=\\\"Kogito Runtimes ${getProjectVersion()}\\\"\"\n+        echo \"Run maven cmd $cmd\"\n+        runMaven(cmd, directory)\n+\n+        // Promote to build profile\n+        cmd = \"org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:promote -DbuildPromotionProfileId=${env.NEXUS_BUILD_PROMOTION_PROFILE_ID}\"\n+        cmd += \"--projects ${directory}\"", "originalCommit": "2cc6b409e9763445162ebbd15a6b36b7d0e12db5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8544d2e1ca831bc211527bc4d1b269ddbcfd387", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b8544d2e1ca831bc211527bc4d1b269ddbcfd387", "message": "KOGITO-3716 Allow automatic close of staging repo", "committedDate": "2020-11-05T13:47:33Z", "type": "forcePushed"}, {"oid": "be9c7dec7e6942c030530b705b231b3c46f79f9b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/be9c7dec7e6942c030530b705b231b3c46f79f9b", "message": "updated", "committedDate": "2020-11-12T12:33:08Z", "type": "forcePushed"}, {"oid": "686f2c71071895595eacbb7ac317b969580d4c9b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/686f2c71071895595eacbb7ac317b969580d4c9b", "message": "KOGITO-3716 Allow automatic close of staging repo", "committedDate": "2020-11-12T13:08:38Z", "type": "forcePushed"}, {"oid": "7eec26cde1945e0136c8f7902803b098bca515d2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/7eec26cde1945e0136c8f7902803b098bca515d2", "message": "KOGITO-3716 Allow automatic close of staging repo", "committedDate": "2020-11-12T16:26:05Z", "type": "forcePushed"}, {"oid": "eada3f4266dc7087255a55635329a6e68dc42dd7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/eada3f4266dc7087255a55635329a6e68dc42dd7", "message": "test", "committedDate": "2020-11-12T16:40:21Z", "type": "forcePushed"}, {"oid": "a40747a7fc8d072e1ba7aeeca013c0f3db1f223d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a40747a7fc8d072e1ba7aeeca013c0f3db1f223d", "message": "update", "committedDate": "2020-11-12T16:39:38Z", "type": "forcePushed"}, {"oid": "3108bdecfb87112981bd9e161653deb966bd6202", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3108bdecfb87112981bd9e161653deb966bd6202", "message": "KOGITO-3716 Allow automatic close of staging repo", "committedDate": "2020-11-26T13:18:26Z", "type": "forcePushed"}, {"oid": "c7e813a6cda7a497fa086285ef85a03d7dfa93de", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c7e813a6cda7a497fa086285ef85a03d7dfa93de", "message": "update", "committedDate": "2020-11-26T14:10:05Z", "type": "forcePushed"}, {"oid": "fd360e33d3b627b955490dce3af42ee36f984577", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fd360e33d3b627b955490dce3af42ee36f984577", "message": "KOGITO-3716 Allow automatic close of staging repo", "committedDate": "2020-11-30T11:18:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5NzY0Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r533997642", "bodyText": "what if you replace it by\ndef prBody = \"\"\"\nGenerated by build ${BUILD_TAG}: ${BUILD_URL}.\nPlease do not merge, it will be merged automatically after testing.\n\"\"\"", "author": "Ginxo", "createdAt": "2020-12-02T09:00:03Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -203,30 +224,12 @@ void prepareForPR(String repo) {\n     }\n }\n \n-void addNotIgnoredPoms() {\n-    // based on https://stackoverflow.com/a/59888964/8811872\n-    sh '''\n-    find . -type f -name 'pom.xml' > found_poms.txt\n-    poms_to_add=\"\"\n-    while IFS= read -r pom; do\n-        if ! git check-ignore -q \"\\$pom\"; then\n-            poms_to_add=\"\\$poms_to_add \\$pom\"\n-        fi\n-    done < found_poms.txt\n-    rm found_poms.txt\n-    git add \\$poms_to_add\n-    git status\n-    '''\n-}\n-\n void commitAndCreatePR(String repo) {\n-    def commitMsg = \"Update project version to ${getProjectVersion()} for release\"\n-    def prBody = \"Generated by build ${BUILD_TAG}: ${BUILD_URL}.\\nPlease do not merge, it will be merged automatically after testing.\"\n-    // Not using githubscm.commitChanges() because globbing won't work.\n-    // See: https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449268738\n     dir(repo) {\n-        addNotIgnoredPoms()\n-        sh \"git commit -m '${commitMsg}'\"\n+        def commitMsg = \"Update project version to ${getProjectVersion()} for release\"\n+        def prBody = \"Generated by build ${BUILD_TAG}: ${BUILD_URL}.\\nPlease do not merge, it will be merged automatically after testing.\"", "originalCommit": "d4a02d64368c427fa90db41a23c0e736defcbc8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMTczMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534001732", "bodyText": "This is a good idea :) I guess I will implement it as a nice to have in another PR because I would like that one to be merged asap ;)\nThx for suggestion !", "author": "radtriste", "createdAt": "2020-12-02T09:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5NzY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTYxOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534015618", "bodyText": "Are these two IDs constant between releases or do we have to provide new ones per release?", "author": "rsynek", "createdAt": "2020-12-02T09:26:31Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -24,13 +32,20 @@ pipeline {\n \n         // Build&test information\n         booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'Skip tests')\n+        string(name: 'MAVEN_SETTINGS_CONFIG_FILE_ID', defaultValue: 'kogito_release_settings', description: 'Maven settings configfile to use in pipeline for Maven commands')\n \n         // Deploy information\n         string(name: 'MAVEN_DEPLOY_REPOSITORY', defaultValue: '', description: 'Specify a Maven repository to deploy the artifacts.')\n \n         // Release information\n         booleanParam(name: 'RELEASE', defaultValue: false, description: 'Is this build for a release?')\n         string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        \n+        // Nexus staging default parameters\n+        string(name: 'NEXUS_RELEASE_URL', defaultValue: 'https://repository.jboss.org/nexus', description: 'Nexus URL for release staging')\n+        string(name: 'NEXUS_RELEASE_REPOSITORY_ID', defaultValue: 'jboss-releases-repository', description: 'Nexus Release repository ID for staging')\n+        string(name: 'NEXUS_STAGING_PROFILE_ID', defaultValue: '2161b7b8da0080', description: 'Nexus staging profile ID for release process ')\n+        string(name: 'NEXUS_BUILD_PROMOTION_PROFILE_ID', defaultValue: 'ea49ccd6f174', description: 'Nexus Build Promotion profile ID for release process')", "originalCommit": "d4a02d64368c427fa90db41a23c0e736defcbc8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNDAxOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534034019", "bodyText": "those are constant. but for testing purpose, there might be different", "author": "radtriste", "createdAt": "2020-12-02T09:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNzE5Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534017197", "bodyText": "Formatting:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n          \n          \n            \n                                if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY) {", "author": "rsynek", "createdAt": "2020-12-02T09:28:48Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -142,8 +152,19 @@ pipeline {\n         }\n         stage('Deploy artifacts') {\n             steps {\n-                mavenDeploy('kogito-runtimes')\n-                mavenDeploy('kogito-apps')\n+                script {\n+                    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){", "originalCommit": "d4a02d64368c427fa90db41a23c0e736defcbc8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTIwNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534019205", "bodyText": "If the params.MAVEN_DEPLOY_REPOSITORY is used only for testing, a comment would be nice.", "author": "rsynek", "createdAt": "2020-12-02T09:31:37Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -142,8 +152,19 @@ pipeline {\n         }\n         stage('Deploy artifacts') {\n             steps {\n-                mavenDeploy('kogito-runtimes')\n-                mavenDeploy('kogito-apps')\n+                script {\n+                    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){", "originalCommit": "d4a02d64368c427fa90db41a23c0e736defcbc8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNTg0MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534035841", "bodyText": "done", "author": "radtriste", "createdAt": "2020-12-02T09:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNDcxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534024713", "bodyText": "Nice to see this replacing the addNotIgnoredPoms().", "author": "rsynek", "createdAt": "2020-12-02T09:39:41Z", "path": "Jenkinsfile.promote", "diffHunk": "@@ -284,28 +279,11 @@ void prepareForPR(String repo) {\n     githubscm.createBranch(getSnapshotBranch())\n }\n \n-void addNotIgnoredPoms() {\n-    // based on https://stackoverflow.com/a/59888964/8811872\n-    sh '''\n-    find . -type f -name 'pom.xml' > found_poms.txt\n-    poms_to_add=\"\"\n-    while IFS= read -r pom; do\n-        if ! git check-ignore -q \"\\$pom\"; then\n-            poms_to_add=\"\\$poms_to_add \\$pom\"\n-        fi\n-    done < found_poms.txt\n-    rm found_poms.txt\n-    git add \\$poms_to_add\n-    '''\n-}\n-\n void commitAndCreatePR(String repo) {\n     def commitMsg = \"Update snapshot version to ${getSnapshotVersion()}\"\n     def prBody = \"Generated by build ${BUILD_TAG}: ${BUILD_URL}.\\nPlease do not merge, it will be merged automatically after testing.\"\n-    // Not using githubscm.commitChanges() because globbing won't work.\n-    // See: https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449268738\n-    addNotIgnoredPoms()\n-    sh \"git commit -m '${commitMsg}'\"\n+    \n+    githubscm.commitChanges(commitMsg, { githubscm.findAndStageNotIgnoredFiles('pom.xml') })", "originalCommit": "d4a02d64368c427fa90db41a23c0e736defcbc8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ed5129eca0e0178abaaff14e71818e0e871709db", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ed5129eca0e0178abaaff14e71818e0e871709db", "message": "KOGITO-3716 Allow automatic close of staging repo", "committedDate": "2020-12-02T16:00:06Z", "type": "commit"}, {"oid": "ed5129eca0e0178abaaff14e71818e0e871709db", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ed5129eca0e0178abaaff14e71818e0e871709db", "message": "KOGITO-3716 Allow automatic close of staging repo", "committedDate": "2020-12-02T16:00:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk3OTMwMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534979302", "bodyText": "Was this formatting change intentional?", "author": "rsynek", "createdAt": "2020-12-03T09:08:02Z", "path": ".jenkins/tests/src/test/vars/JenkinsfilePromote.groovy", "diffHunk": "@@ -4,8 +4,8 @@ class JenkinsfilePromote extends JenkinsPipelineSpecification {\n \tdef Jenkinsfile = null\n \n     def setup() {\n-        Jenkinsfile = loadPipelineScriptForTest('Jenkinsfile.promote')\n-        Jenkinsfile.getBinding().setVariable('PROPERTIES_FILE_NAME', 'deployment.properties')\n+\t\t\tJenkinsfile = loadPipelineScriptForTest('Jenkinsfile.promote')", "originalCommit": "ed5129eca0e0178abaaff14e71818e0e871709db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk4NzY4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534987686", "bodyText": "nope, it is my IDE using real tabs instead of whitespaces ... gonna correct that ...", "author": "radtriste", "createdAt": "2020-12-03T09:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk3OTMwMg=="}], "type": "inlineReview"}, {"oid": "d3a22869bfb6f088cfa21bf3daaaf3a514e865eb", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d3a22869bfb6f088cfa21bf3daaaf3a514e865eb", "message": "updated tests", "committedDate": "2020-12-03T09:37:13Z", "type": "commit"}]}