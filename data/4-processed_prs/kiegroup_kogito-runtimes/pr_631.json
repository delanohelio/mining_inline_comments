{"pr_number": 631, "pr_title": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "pr_createdAt": "2020-07-13T14:09:09Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/631", "timeline": [{"oid": "26752e22c82cb327d3f31f05ac1dfdfcc104487d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/26752e22c82cb327d3f31f05ac1dfdfcc104487d", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-14T15:02:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NTA3MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r454975070", "bodyText": "right import?", "author": "cristianonicolai", "createdAt": "2020-07-15T11:14:39Z", "path": "kogito-codegen/src/main/resources/class-templates/RestResourceUserTaskTemplate.java", "diffHunk": "@@ -2,6 +2,7 @@\n \n import java.util.List;\n \n+import org.dmg.pmml.Application;", "originalCommit": "26752e22c82cb327d3f31f05ac1dfdfcc104487d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NzMzMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r454977330", "bodyText": "This should not be there (it is not really used), I guess it was automatically introduced by the IDE while trying different approaches. I removed it. really good catch!!!", "author": "fjtirado", "createdAt": "2020-07-15T11:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NTA3MA=="}], "type": "inlineReview"}, {"oid": "295af1cc84cac887243cb2e8ed05343e1b9e54ff", "url": "https://github.com/kiegroup/kogito-runtimes/commit/295af1cc84cac887243cb2e8ed05343e1b9e54ff", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-15T11:18:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgxNzM1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r455817356", "bodyText": "wishlist for the future: I'd like it better to have two different interfaces, one with this method, the other without.\n\nWorkItemHandler\nCustomPhaseWorkItemHandler extends WorkItemHandler\n\nor something along those lines", "author": "evacchi", "createdAt": "2020-07-16T14:12:07Z", "path": "api/kogito-api/src/main/java/org/kie/api/runtime/process/WorkItemHandler.java", "diffHunk": "@@ -81,7 +81,7 @@ default void transitionToPhase(WorkItem workItem, WorkItemManager manager, Trans\n         throw new UnsupportedOperationException();\n     }\n \n-    default Set<String> allowedPhases(WorkItem workItem) {\n+    default Set<String> allowedPhases(String phaseId) {", "originalCommit": "295af1cc84cac887243cb2e8ed05343e1b9e54ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgyNzk3Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r455827976", "bodyText": "haven't we agree that this method will be in LifeCycle and not on WorkItemHandler, @fjtirado?", "author": "mswiderski", "createdAt": "2020-07-16T14:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgxNzM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg5NDcyMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r455894720", "bodyText": "yes, thats the idea, but I have not uploaded changes related with it yet.\nIm not sure it is feasible to inject LifeCycle, without changing current customtask example. Im currently studying the code.\nLet me elaborate a bit more. Currently, in the example, which is injected is the CustomWorkItemHandlerConfig, which register HumanTaskWorkItemHandler speciying a custom LifeCycle implementaiton. I guess we can just tell customers interested on providing a custom life cycle to simply  provide a bean than implements LifeCycle. But this implies changing the example and any related documentation. Are you aware of any blog talking about this? (it will need to be modified)\nAlso, do you know if we have @ConditionalOnMissingBean BootSpring equivalent annotation on quarkus?  so, the idea is, if user specify a LifeCycle bean we use it, if not we use the default one, BaseHumanTaskLifeCycle", "author": "fjtirado", "createdAt": "2020-07-16T15:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgxNzM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkwODkyMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r455908920", "bodyText": "Anyway, independently on the issue of injecting LifeCycle, I have a foundamental doubt, WorkItemHandler inerface already have these methods:\n\n void executeWorkItem(WorkItem workItem,\n                         WorkItemManager manager);\n\n    \n    void abortWorkItem(WorkItem workItem,\n                       WorkItemManager manager);\n    \n    default String getName() {\n        return getClass().getSimpleName();\n    };\n    \n    /\n    default void transitionToPhase(WorkItem workItem, WorkItemManager manager, Transition<?> transition) {\n        throw new UnsupportedOperationException();\n    }\n\nso, there is actually one existing method in this inteface which is aware of  \"phase\", which issue is associate with adding  allowedPhases to it?, I need to understand because I felt Im missing something.", "author": "fjtirado", "createdAt": "2020-07-16T16:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgxNzM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1MTMwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r455951304", "bodyText": "Remove the \u2018ToPhase\u2019 from the method name and there is no more reference to phases any longer. It just the name that is maybe not named in the best way. Nothing more I\u2019d say.", "author": "mswiderski", "createdAt": "2020-07-16T17:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgxNzM1Ng=="}], "type": "inlineReview"}, {"oid": "debf8e8c3cc4902a32c74ab9c77a6a05bca4c43d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/debf8e8c3cc4902a32c74ab9c77a6a05bca4c43d", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-20T15:42:06Z", "type": "forcePushed"}, {"oid": "16945de751525fbf11bb7b07da2be4b82594d7d1", "url": "https://github.com/kiegroup/kogito-runtimes/commit/16945de751525fbf11bb7b07da2be4b82594d7d1", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-20T16:03:57Z", "type": "forcePushed"}, {"oid": "6183b8e7e03fb8be3c686c2b92d9582bc9200ed2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6183b8e7e03fb8be3c686c2b92d9582bc9200ed2", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-20T16:13:04Z", "type": "forcePushed"}, {"oid": "6d246efaa28f907bfa6fafdf889446a6db392e9c", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6d246efaa28f907bfa6fafdf889446a6db392e9c", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-20T16:49:37Z", "type": "forcePushed"}, {"oid": "6423356b51947f67d2e3a3d681b3961203a59ad4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6423356b51947f67d2e3a3d681b3961203a59ad4", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-20T16:52:02Z", "type": "forcePushed"}, {"oid": "8e18b2c3dfe9641116d8a5fd2f240c74ef0da549", "url": "https://github.com/kiegroup/kogito-runtimes/commit/8e18b2c3dfe9641116d8a5fd2f240c74ef0da549", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-21T12:22:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMzYwOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r458913609", "bodyText": "please review code style, its missing spaces between vars, see https://github.com/kiegroup/droolsjbpm-build-bootstrap/tree/master/ide-configuration", "author": "cristianonicolai", "createdAt": "2020-07-22T16:16:18Z", "path": "kogito-codegen/src/main/resources/class-templates/RestResourceUserTaskTemplate.java", "diffHunk": "@@ -86,10 +87,8 @@\n     @GET()\n     @Path(\"/{id}/$taskName$/{workItemId}/schema\")\n     @Produces(MediaType.APPLICATION_JSON)\n-    public Map<String,Object> getSchemaAndPhases(@PathParam(\"id\") final String id, @PathParam(\"workItemId\") final String workItemId) {\n-        Map<String,Object> jsonSchema = JsonSchemaUtil.load(this.getClass().getClassLoader(),process.id(),\"$taskName$\");\n-        process.instances().findById(id).ifPresent(pi ->jsonSchema.put(\"phases\",pi.allowedPhases(workItemId)));\n-        return jsonSchema;\n+    public Map<String,Object> getSchemaAndPhases(@PathParam(\"id\") final String id, @PathParam(\"workItemId\") final String workItemId , @QueryParam(\"user\") final String user, @QueryParam(\"group\") final List<String> groups) {\n+        return JsonSchemaUtil.addPhases(process,application,id,workItemId, policies(user,groups),JsonSchemaUtil.load(this.getClass().getClassLoader(),process.id(),\"$taskName$\"));", "originalCommit": "8e18b2c3dfe9641116d8a5fd2f240c74ef0da549", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NzgzNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r458977837", "bodyText": "I have it configured, but it was not appliead automatically to template file because is not considered source, I applied it manually now", "author": "fjtirado", "createdAt": "2020-07-22T17:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMzYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDY0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r458914640", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Mockito.when(process.instances()).thenReturn(processInstances);\n          \n          \n            \n                    when(process.instances()).thenReturn(processInstances);", "author": "cristianonicolai", "createdAt": "2020-07-22T16:17:55Z", "path": "jbpm/jbpm-flow/src/test/java/org/jbpm/util/JsonSchemaUtilTest.java", "diffHunk": "@@ -67,4 +82,30 @@ void testJsonSchema() throws IOException {\n         assertTrue((Boolean)((Map)properties.get(\"approved\")).get(\"output\"));\n         assertTrue((Boolean)((Map)properties.get(\"traveller\")).get(\"input\"));\n     }\n+\n+    @Test\n+    <T> void testJsonSchemaPhases() throws IOException {\n+        InputStream in = new ByteArrayInputStream(example.getBytes());\n+        Policy<T>[] policies = new Policy[0];\n+        Map<String, Object> schemaMap = JsonSchemaUtil.load(in);\n+        Process<T> process = Mockito.mock(Process.class);\n+        ProcessInstances<T> processInstances = Mockito.mock(ProcessInstances.class);\n+        Mockito.when(process.instances()).thenReturn(processInstances);", "originalCommit": "8e18b2c3dfe9641116d8a5fd2f240c74ef0da549", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3ODkyMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/631#discussion_r458978922", "bodyText": "Using static import now (Im not fan of them, but in this case I agree save a lot of code)", "author": "fjtirado", "createdAt": "2020-07-22T17:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDY0MA=="}], "type": "inlineReview"}, {"oid": "f43b1c70d4ce9235f54aa8920cbfbc35c641741f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/f43b1c70d4ce9235f54aa8920cbfbc35c641741f", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-22T17:56:14Z", "type": "forcePushed"}, {"oid": "007ceffc3866a0c614a5ec24a3bb178b259913f0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/007ceffc3866a0c614a5ec24a3bb178b259913f0", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-23T09:06:58Z", "type": "commit"}, {"oid": "007ceffc3866a0c614a5ec24a3bb178b259913f0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/007ceffc3866a0c614a5ec24a3bb178b259913f0", "message": "[KOGITO-2736] Removing allowedPhases from ProcessInstance", "committedDate": "2020-07-23T09:06:58Z", "type": "forcePushed"}]}