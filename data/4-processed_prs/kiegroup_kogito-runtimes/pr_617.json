{"pr_number": 617, "pr_title": "KOGITO-2710 Correct Jenkinsfile drools", "pr_createdAt": "2020-07-08T17:11:04Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/617", "timeline": [{"oid": "810d107342d4443d030cc80160d5a922df5dd911", "url": "https://github.com/kiegroup/kogito-runtimes/commit/810d107342d4443d030cc80160d5a922df5dd911", "message": "KOGITO-2710 Correct Jenkinsfile drools", "committedDate": "2020-07-08T17:12:27Z", "type": "forcePushed"}, {"oid": "1a015c32873138611626aa3ab9f3c006df23aa7b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/1a015c32873138611626aa3ab9f3c006df23aa7b", "message": "KOGITO-2710 Correct Jenkinsfile drools", "committedDate": "2020-07-08T17:15:59Z", "type": "forcePushed"}, {"oid": "912ba054118adc51f99e72a179079097fe2d16e5", "url": "https://github.com/kiegroup/kogito-runtimes/commit/912ba054118adc51f99e72a179079097fe2d16e5", "message": "KOGITO-2710 Correct Jenkinsfile drools", "committedDate": "2020-07-09T07:18:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxMzMwNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/617#discussion_r452013306", "bodyText": "is  ${MAVEN_EXTRA_ARGS} not needed here?", "author": "evacchi", "createdAt": "2020-07-09T07:19:38Z", "path": "Jenkinsfile.drools", "diffHunk": "@@ -15,66 +15,119 @@ pipeline {\n         buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5')\n         timeout(time: 120, unit: 'MINUTES')\n     }\n+    parameters {\n+        string(name: 'BRANCH_NAME', defaultValue: \"master\", description: 'Set the branch to build&test')\n+    }\n     environment {\n         KOGITO_CI_EMAIL_TO = credentials('KOGITO_CI_EMAIL_TO')\n-        // query mvn to get the latest version\n-        DROOLS_VERSION = \"\"\"${sh (\n-            script: '$(mvn versions:display-property-updates -DincludeProperties=version.org.kie7 -DallowSnapshots -N  | grep version.org.kie7| cut -d\" \" -f8))'\n-            returnStdout: true).trim()}\"\"\"\n-        MAVEN_EXTRA_ARGS=\"-Dversion.org.kie7=${DROOLS_VERSION}\"\n         MAVEN_OPTS = '-Xms1024m -Xmx4g'\n+\n+        // Set into 'Initialize' stage\n+        // DROOLS_VERSION\n+        // MAVEN_EXTRA_ARGS\n     }\n     stages {\n+        stage(\"Initialize\"){\n+            steps {\n+                script {\n+                    // query mvn to get the latest version\n+                    env.DROOLS_VERSION = \"\"\"${sh (\n+                            script: 'mvn versions:display-property-updates -DincludeProperties=version.org.kie7 -DallowSnapshots -N  | grep version.org.kie7 | cut -d \" \" -f8',\n+                            returnStdout: true\n+                        ).trim()}\"\"\"\n+                    echo \"Latest kie7 version is: ${env.DROOLS_VERSION}\"\n+\n+                    env.MAVEN_EXTRA_ARGS=\"-Dversion.org.kie7=${DROOLS_VERSION}\"\n+                }\n+            }\n+        }\n         stage('Build kogito-runtimes') {\n             steps {\n                 script {\n-                    echo \"Latest kie7 version is: ${DROOLS_VERSION}\"\n-                    maven.runMavenWithSubmarineSettings(\"clean install ${MAVEN_EXTRA_ARGS}\", false)\n+                    dir(\"kogito-runtimes\") {\n+                        checkout(githubscm.resolveRepository(\"kogito-runtimes\", \"kiegroup\", params.BRANCH_NAME, false))\n+                        maven.runMavenWithSubmarineSettings(\"clean install ${env.MAVEN_EXTRA_ARGS}\", false)\n+                    }\n+                }\n+            }\n+            post {\n+                always {\n+                    saveReports()\n                 }\n             }\n         }\n         stage('Build kogito-apps') {\n             steps {\n-                dir(\"kogito-apps\") {\n-                    script {\n-                        checkout([$class: 'GitSCM', branches: [[name: env.BRANCH_NAME]], browser: [$class: 'GithubWeb', repoUrl: 'git@github.com:kiegroup/kogito-apps.git'], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'kogito-apps']], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'kie-ci-user-key', url: 'git@github.com:kiegroup/kogito-apps.git']]])\n-                        maven.runMavenWithSubmarineSettings(\"clean install ${MAVEN_EXTRA_ARGS}\", false)\n+                script {\n+                    dir(\"kogito-apps\") {\n+                        checkout(githubscm.resolveRepository(\"kogito-apps\", \"kiegroup\", params.BRANCH_NAME, false))\n+                        maven.runMavenWithSubmarineSettings(\"clean install ${env.MAVEN_EXTRA_ARGS}\", false)\n                     }\n                 }\n             }\n+            post {\n+                always {\n+                    saveReports()\n+                }\n+            }\n         }\n         stage('Build kogito-examples') {\n             steps {\n-                checkout([$class: 'GitSCM', branches: [[name: env.BRANCH_NAME]], browser: [$class: 'GithubWeb', repoUrl: 'git@github.com:kiegroup/kogito-examples.git'], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'kogito-examples']], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'kie-ci-user-key', url: 'git@github.com:kiegroup/kogito-examples.git']]])\n-                dir(\"kogito-examples\") {\n-                    script {\n-                        maven.runMavenWithSubmarineSettings(\"clean install ${MAVEN_EXTRA_ARGS}\", false)\n+                script {\n+                    dir(\"kogito-examples\") {\n+                        checkout(githubscm.resolveRepository(\"kogito-examples\", \"kiegroup\", params.BRANCH_NAME, false))\n+                        maven.runMavenWithSubmarineSettings(\"clean install ${env.MAVEN_EXTRA_ARGS}\", false)\n                     }\n                 }\n-                // Use a separate dir for persistence to not overwrite the test results\n-                checkout([$class: 'GitSCM', branches: [[name: env.BRANCH_NAME]], browser: [$class: 'GithubWeb', repoUrl: 'git@github.com:kiegroup/kogito-examples.git'], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'kogito-examples-persistence']], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'kie-ci-user-key', url: 'git@github.com:kiegroup/kogito-examples.git']]])\n+            }\n+            post {\n+                always {\n+                    saveReports()\n+                }\n+            }\n+        }\n+        stage('Build kogito-examples with persistence') {\n+            steps {\n                 dir(\"kogito-examples-persistence\") {\n                     script {\n-                        // Don't run with tests so far, see: https://github.com/quarkusio/quarkus/issues/6885\n-                        maven.runMavenWithSubmarineSettings(\"clean install ${MAVEN_EXTRA_ARGS} -Ppersistence\", true)\n+                        checkout(githubscm.resolveRepository(\"kogito-examples\", \"kiegroup\", params.BRANCH_NAME, false))\n+                        maven.runMavenWithSubmarineSettings('clean install -Ppersistence', false)", "originalCommit": "912ba054118adc51f99e72a179079097fe2d16e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxNjEyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/617#discussion_r452016129", "bodyText": "it is, I will add it", "author": "radtriste", "createdAt": "2020-07-09T07:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAxMzMwNg=="}], "type": "inlineReview"}, {"oid": "847c43de2f4531e615d16b5846365207e87f4e18", "url": "https://github.com/kiegroup/kogito-runtimes/commit/847c43de2f4531e615d16b5846365207e87f4e18", "message": "KOGITO-2710 Correct Jenkinsfile drools", "committedDate": "2020-07-09T07:55:03Z", "type": "forcePushed"}, {"oid": "3c59eccb1133304cee52e75755cb42ab4927f31b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3c59eccb1133304cee52e75755cb42ab4927f31b", "message": "KOGITO-2710 Correct Jenkinsfile drools", "committedDate": "2020-07-09T11:24:25Z", "type": "commit"}, {"oid": "3c59eccb1133304cee52e75755cb42ab4927f31b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3c59eccb1133304cee52e75755cb42ab4927f31b", "message": "KOGITO-2710 Correct Jenkinsfile drools", "committedDate": "2020-07-09T11:24:25Z", "type": "forcePushed"}]}