{"pr_number": 404, "pr_title": "KOGITO-1306 Error during code generation when using java reserved word on variable", "pr_createdAt": "2020-03-31T20:33:17Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/404", "timeline": [{"oid": "c5281effae6a0d2531aafe9a80cfc2304f1e7481", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c5281effae6a0d2531aafe9a80cfc2304f1e7481", "message": "KOGITO-1306 Error during code generation when using java reserved words on process variables", "committedDate": "2020-03-31T20:18:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MTMxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401391312", "bodyText": "I think we can simplify this by just prepending a \"$\" sign or a mix of \"$\" sign and some other stuff. This will keep it readable and make it safe.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Optional.ofNullable(name)\n          \n          \n            \n                                    .filter(SourceVersion::isName)\n          \n          \n            \n                                    .orElseGet(() -> Optional.ofNullable(StringUtils.extractFirstIdentifier(name, 0))\n          \n          \n            \n                                            .filter(s -> !StringUtils.isEmpty(s))\n          \n          \n            \n                                            .filter(SourceVersion::isName)\n          \n          \n            \n                                            .orElseGet(() -> \"attribute\" + StringUtils.generateUUID()));\n          \n          \n            \n                   // prepend v$ in front of the variable name to prevent clashing with reserved keywords\n          \n          \n            \n                    return String.format(\"v$%s\", name);", "author": "evacchi", "createdAt": "2020-04-01T06:50:34Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/core/context/variable/Variable.java", "diffHunk": "@@ -64,6 +69,27 @@ public String getName() {\n \n     public void setName(final String name) {\n         this.name = name;\n+        this.sanitizedName = sanitizeIdentifier(name);\n+    }\n+\n+    public String getSanitizedName() {\n+        return sanitizedName;\n+    }\n+\n+    /**\n+     * Return a valid unique Java identifier based on the given @param name. It consider valid characters and\n+     * reserved words.\n+     * In case the input is valid it is returned itself otherwise a unique valid identifier is generated.\n+     * @param name the input\n+     * @return the output valid Java identifier\n+     */\n+    private static String sanitizeIdentifier(String name) {\n+        return Optional.ofNullable(name)\n+                        .filter(SourceVersion::isName)\n+                        .orElseGet(() -> Optional.ofNullable(StringUtils.extractFirstIdentifier(name, 0))\n+                                .filter(s -> !StringUtils.isEmpty(s))\n+                                .filter(SourceVersion::isName)\n+                                .orElseGet(() -> \"attribute\" + StringUtils.generateUUID()));", "originalCommit": "c5281effae6a0d2531aafe9a80cfc2304f1e7481", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxOTc0NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401719744", "bodyText": "+1 though I would leave the decision logic there. So in case it is not a reserved word, use it as is, otherwise prepend v$.\nIn addition, we can directly assert that in tests because we know the expected outcome (v$<input>).", "author": "MarianMacik", "createdAt": "2020-04-01T15:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MTMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgxODk1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401818954", "bodyText": "done.", "author": "tiagodolphine", "createdAt": "2020-04-01T18:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MTMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MjkxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401392917", "bodyText": "because setters and getters are always prepended with get and set they can never be invalid. So maybe we can use the \"regular\" name?", "author": "evacchi", "createdAt": "2020-04-01T06:54:34Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ModelMetaData.java", "diffHunk": "@@ -112,26 +112,27 @@ public BlockStmt copyInto(String sourceVarName, String destVarName, ModelMetaDat\n         BlockStmt blockStmt = new BlockStmt();\n \n         for (Map.Entry<String, String> e : mapping.entrySet()) {\n-            String destField = e.getKey();\n+            String destField = variableScope.getTypes().get(e.getKey()).getSanitizedName();\n             String sourceField = e.getValue();\n             blockStmt.addStatement(\n                     dest.callSetter(destVarName, destField, dest.callGetter(sourceVarName, sourceField)));\n         }\n \n         return blockStmt;\n     }\n-    \n+\n     public MethodCallExpr callSetter(String targetVar, String destField, String value) {\n         if (value.startsWith(\"#{\")) {\n-            value = value.substring(2, value.length() -1);\n+            value = value.substring(2, value.length() - 1);\n         }\n-        \n+\n         return callSetter(targetVar, destField, new NameExpr(value));\n     }\n \n     public MethodCallExpr callSetter(String targetVar, String destField, Expression value) {\n+        String name = variableScope.getTypes().get(destField).getSanitizedName();", "originalCommit": "c5281effae6a0d2531aafe9a80cfc2304f1e7481", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxNzc5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401717798", "bodyText": "On the other hand in case somebody wants to browse the generated code, it makes more sense to prepend the whole name of the variable with set or get. So it would be consistent with Java Beans spec.", "author": "MarianMacik", "createdAt": "2020-04-01T15:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MjkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgyMTgzNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401821836", "bodyText": "@evacchi the way to make the getter/setter work was to manually change the method name after the fd.createSetter(), but even with this we may have problems in case the variable names contain invalid characters like []()!*?! ... to the logic could be more complicated and it will not be 100% compatible with the original name and as @MarianMacik  pointed out it will not be consistent with Java Beans. So IMHO it is better to keep the default getter/setter name unless we found bugs or anything affecting other points on the runtime.", "author": "tiagodolphine", "createdAt": "2020-04-01T18:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MjkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA5NzUxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r402097513", "bodyText": "ok i am not too much opinionated on this, especially because at this time this is an impl detail. Maybe when this becomes public/scaffolding we can revisit if needed :)", "author": "evacchi", "createdAt": "2020-04-02T07:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MjkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MzkyMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401393923", "bodyText": "same here: if we call a getter, then the getter may retain its original name", "author": "evacchi", "createdAt": "2020-04-01T06:56:53Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ModelMetaData.java", "diffHunk": "@@ -112,26 +112,27 @@ public BlockStmt copyInto(String sourceVarName, String destVarName, ModelMetaDat\n         BlockStmt blockStmt = new BlockStmt();\n \n         for (Map.Entry<String, String> e : mapping.entrySet()) {\n-            String destField = e.getKey();\n+            String destField = variableScope.getTypes().get(e.getKey()).getSanitizedName();", "originalCommit": "c5281effae6a0d2531aafe9a80cfc2304f1e7481", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgyMTkyOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401821928", "bodyText": "#404 (comment)", "author": "tiagodolphine", "createdAt": "2020-04-01T18:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5MzkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5NDY2OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401394669", "bodyText": "If these accept params maybe we can override the name. If they don't it may be just enough to create the FD with the unsanitized name and then after these lines add fd.setName(sanitizedName)", "author": "evacchi", "createdAt": "2020-04-01T06:58:40Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ModelMetaData.java", "diffHunk": "@@ -175,36 +176,41 @@ private CompilationUnit compilationUnit() {\n             staticFromMap.addStatement(new AssignExpr(idField, new NameExpr(\"id\"), AssignExpr.Operator.ASSIGN));\n         }\n \n-        for (String vname : variableScope.getTypes().keySet()) {\n-            \n-            String vtype = variableScope.getType(vname);\n-            FieldDeclaration fd = declareField(vname, vtype);\n+        for (Map.Entry<String, Variable> variable : variableScope.getTypes().entrySet()) {\n+            String varName = variable.getValue().getName();\n+            String vtype = variable.getValue().getType().getStringType();\n+            String sanitizedName = variable.getValue().getSanitizedName();\n+\n+            FieldDeclaration fd = declareField(sanitizedName, vtype);\n             modelClass.addMember(fd);\n-            \n-            List<String> tags = variableScope.getTags(vname);\n+\n+            List<String> tags = variable.getValue().getTags();\n             fd.addAnnotation(new NormalAnnotationExpr(new Name(VariableInfo.class.getCanonicalName()), NodeList.nodeList(new MemberValuePair(\"tags\", new StringLiteralExpr(tags.stream().collect(Collectors.joining(\",\")))))));\n+            fd.addAnnotation(new NormalAnnotationExpr(new Name(JsonProperty.class.getCanonicalName()),\n+                                                      NodeList.nodeList(new MemberValuePair(\"value\",\n+                                                                                            new StringLiteralExpr(varName)))));\n \n             applyValidation(fd, tags);\n-            \n+\n             fd.createGetter();\n             fd.createSetter();", "originalCommit": "c5281effae6a0d2531aafe9a80cfc2304f1e7481", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3NzkxNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401677916", "bodyText": "Great idea, I try to do that and see if it works. At the beginning, I tried but the fd.createGetter(); was automatically generated based on the fd name.. so...\nLet's see.", "author": "tiagodolphine", "createdAt": "2020-04-01T14:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5NDY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgyMTk4Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/404#discussion_r401821987", "bodyText": "#404 (comment)", "author": "tiagodolphine", "createdAt": "2020-04-01T18:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5NDY2OQ=="}], "type": "inlineReview"}, {"oid": "e847c41b3f027f05a77d7ef797cedbc21f11813f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e847c41b3f027f05a77d7ef797cedbc21f11813f", "message": "Apply suggested sanitized variable generation", "committedDate": "2020-04-01T18:20:59Z", "type": "commit"}]}