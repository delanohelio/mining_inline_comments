{"pr_number": 731, "pr_title": "[KOGITO-1031] Add Maven local deploy", "pr_createdAt": "2020-08-28T00:07:28Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/731", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg4MDk1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r491880956", "bodyText": "you should try to avoid browsing folder this way, you can do\ndir(${env.LOCAL_DEPLOY_DIR}) {\n    sh \"\"\"\n    zip -r kiegroup .\n    curl --silent --upload-file kiegroup.zip -u ${kieUnpack} -v ${params.MAVEN_DEPLOY_REPOSITORY}/content-compressed\n    \"\"\"\n}", "author": "Ginxo", "createdAt": "2020-09-21T08:48:51Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -176,15 +183,28 @@ pipeline {\n             }\n             post {\n                 always {\n-                    saveReports()\n+                    saveReports(params.SKIP_TESTS)\n                 }\n             }\n         }\n-        stage('Deploy artifacts') {\n+        stage('Deploy artifacts locally') {\n+            steps {\n+                mavenLocalDeploy('kogito-runtimes')\n+                mavenLocalDeploy('kogito-apps')\n+                mavenLocalDeploy('kogito-examples')\n+            }\n+        }\n+        stage('Push zip of artifacts to Maven repository') {\n             steps {\n-                mavenDeploy('kogito-runtimes')\n-                mavenDeploy('kogito-apps')\n-                mavenDeploy('kogito-examples')\n+                withCredentials([usernameColonPassword(credentialsId: 'unpacks-zip-on-qa-nexus', variable: 'kieUnpack')]) {\n+                    // unpack zip to QA Nexus\n+                    sh \"\"\"\n+                    cd ${env.LOCAL_DEPLOY_DIR}", "originalCommit": "59b89dbb014626ea5dafbb2d9e66923d6047f42b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg4MTYzMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r491881631", "bodyText": "if (!params.PR_TARGET_BRANCH)", "author": "Ginxo", "createdAt": "2020-09-21T08:49:58Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -312,6 +332,20 @@ String getBuildBranch(){\n     return params.BUILD_BRANCH_NAME\n }\n \n+String getDefaultBranch(String repo) {\n+    // if not triggered by PR\n+    if (params.PR_TARGET_BRANCH == '') {", "originalCommit": "59b89dbb014626ea5dafbb2d9e66923d6047f42b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg4MjE5Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r491882193", "bodyText": "I would suggest to replace 340-346 by\nreturn repositoryScm ? params.PR_TARGET_BRANCH : 'master'", "author": "Ginxo", "createdAt": "2020-09-21T08:50:59Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -312,6 +332,20 @@ String getBuildBranch(){\n     return params.BUILD_BRANCH_NAME\n }\n \n+String getDefaultBranch(String repo) {\n+    // if not triggered by PR\n+    if (params.PR_TARGET_BRANCH == '') {\n+        return 'master'\n+    }\n+    // if PR target branch exists\n+    def repositoryScm = githubscm.getRepositoryScm(repo, 'kiegroup', params.PR_TARGET_BRANCH)\n+    if (repositoryScm != null) {\n+        return params.PR_TARGET_BRANCH\n+    }\n+    // if target branch doesn't exist in repos other than PR repo\n+    return 'master'", "originalCommit": "59b89dbb014626ea5dafbb2d9e66923d6047f42b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg4MjY4MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r491882681", "bodyText": "fix indentation problems please", "author": "Ginxo", "createdAt": "2020-09-21T08:51:49Z", "path": "jenkins-tests/src/test/vars/JenkinsfileDeploy.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import com.homeaway.devtools.jenkins.testing.JenkinsPipelineSpecification\n+\n+class JenkinsfileDeploy extends JenkinsPipelineSpecification {", "originalCommit": "59b89dbb014626ea5dafbb2d9e66923d6047f42b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMTI5Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r494631296", "bodyText": "Same as comment in pipelines PR.", "author": "Kevin-Mok", "createdAt": "2020-09-24T21:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg4MjY4MQ=="}], "type": "inlineReview"}, {"oid": "3b49b28fc332bc1a5c96be31fee9d0799766a59d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3b49b28fc332bc1a5c96be31fee9d0799766a59d", "message": "[KOGITO-1031] Run BDD tests from PR", "committedDate": "2020-09-24T22:04:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzNjEyOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r496436128", "bodyText": "I would do\nString getMavenRepoZipUrl() {\n     return \"${params.MAVEN_DEPLOY_REPOSITORY.replaceAll('/content/', '/service/local/').replaceFirst('/*$', '')}/content-compressed\"\n}\n\nthe $ matches the end of a string and * in case there are multiple slashes, so it will remove it in case it exists and you always concatenate / after url.\nThis is just a suggestion.", "author": "Ginxo", "createdAt": "2020-09-29T06:00:36Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -334,11 +363,18 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY}\" : ''\n+void mavenLocalDeploy(String directory) {\n+    extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.LOCAL_DEPLOY_DIR}\"\n     runMaven('clean deploy', directory, true, [], extraArgs)\n }\n \n+String getMavenRepoZipUrl() {\n+    String repoUrl = params.MAVEN_DEPLOY_REPOSITORY\n+    // ensure URL has trailing slash\n+    repoUrl += (!repoUrl.endsWith('/')) ? '/' : ''\n+    return repoUrl.replaceAll('/content/', '/service/local/') + 'content-compressed'", "originalCommit": "3b49b28fc332bc1a5c96be31fee9d0799766a59d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUzMzEyOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r496533128", "bodyText": "what happens here if no MAVEN_DEPLOY_REPOSITORY is given ?\nUsually, if none mentioned, we are using the default one defined into the pom.xml.", "author": "radtriste", "createdAt": "2020-09-29T08:34:26Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -334,11 +363,18 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY}\" : ''\n+void mavenLocalDeploy(String directory) {\n+    extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.LOCAL_DEPLOY_DIR}\"\n     runMaven('clean deploy', directory, true, [], extraArgs)\n }\n \n+String getMavenRepoZipUrl() {\n+    String repoUrl = params.MAVEN_DEPLOY_REPOSITORY", "originalCommit": "3b49b28fc332bc1a5c96be31fee9d0799766a59d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA4MDE4MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r521080181", "bodyText": "I'm not sure how to go about deployment now. I tried just using the current mavenDeploy() with the parameter of the PR check repository, but this results in a 401 error when deploying to that repo.\nThis zip and curl method I was using previously uses the unpacks-zip-on-qa-nexus credential to authenticate itself to the repo, I'm not sure how to deploy to the default repo in the pom.xml in that case.\nI could create 2 different branches of deployment depending on whether or not there is a MAVEN_DEPLOY_REPOSITORY parameter, but that seems kind of hacky. Also, would the unpacks-zip-on-qa-nexus credential even work universally for that?\nHow would you suggest I go about this?", "author": "Kevin-Mok", "createdAt": "2020-11-11T03:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUzMzEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5ODU5Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r522098593", "bodyText": "I guess we would also need to retrieve the user/pwd from settings.xml to upload to usual maven as it is a different one...\nor have different credentials with this information to do the curl. and so I would have the creds name as optional parameter of the pipeline (if empty get from settings.xml) and the main pipeline would send directly this information (here it would send unpacks-zip-on-qa-nexus for this use case).\nwdyt ?", "author": "radtriste", "createdAt": "2020-11-12T13:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUzMzEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI0NjM4Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r522246383", "bodyText": "Using the zip and curl method if there are artifact repository and credentials parameters passed in requires using a withCredentials block, but authenticating with the retrieved credentials from settings.xml wouldn't. In this case, would it just be simpler to create two different branches depending on whether artifact repository and credentials parameters are passed in? That is, using a withCredentials block if there are and the current mavenDeploy() with no repository argument if there isn't. I initially thought this was not ideal, but it may be the simplest implementation after all?", "author": "Kevin-Mok", "createdAt": "2020-11-12T16:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUzMzEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI1MTY0Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r522251642", "bodyText": "yep you could have an if statement and have 2 different behaviors. I have no problem with that ;)", "author": "radtriste", "createdAt": "2020-11-12T16:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUzMzEyOA=="}], "type": "inlineReview"}, {"oid": "24ec9002e387888cd70ef56a0a52d8a13506af35", "url": "https://github.com/kiegroup/kogito-runtimes/commit/24ec9002e387888cd70ef56a0a52d8a13506af35", "message": "[KOGITO-1031] Run BDD tests from PR", "committedDate": "2020-11-18T05:08:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI5ODQ3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r526298477", "bodyText": "is that still used ? as far as I can see kiegroup/kogito-pipelines#46, you are checking before calling if the branch exist (which I prefer :))", "author": "radtriste", "createdAt": "2020-11-18T17:48:58Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -35,10 +37,14 @@ pipeline {\n         // Bot author information. Set as params for easy testing.\n         string(name: 'GIT_AUTHOR_BOT', defaultValue: 'bsig-gh-bot', description: 'From which author should the PR be created ?')\n         string(name: 'BOT_CREDENTIALS_ID', defaultValue: 'bsig-gh-bot', description: 'Credentials for PR creation')\n+\n+        // PR parameter to be filled out by GitHub Pull Request Builder for PR checks\n+        string(name: 'PR_TARGET_BRANCH', defaultValue: '', description: 'What is the target branch of the PR? Will be automatically filled out by GitHub Pull Request Builder.')", "originalCommit": "24ec9002e387888cd70ef56a0a52d8a13506af35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjI5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r526502294", "bodyText": "This is still needed because there are 2 repositories being checked out in runtimes. The original pipeline only checks if the branch exists for one of them (the one the PR is for). The other repository will need to fall back to checking out the target branch.", "author": "Kevin-Mok", "createdAt": "2020-11-18T23:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI5ODQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MjU0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r526652540", "bodyText": "ah I see, you want to make use of the checkoutIfExist and the merge capability in there.\nIn that case, I think that would need to be added to each deploy pipeline (not only runtimes) => https://github.com/kiegroup/kogito-pipelines/pull/46/files#r526653004\nalso, 2 small things:\n\ncan you change the comment on that param ? This is confusing as it is not automatic, the main pipeline is setting it\ncould you move that param to the Git information part ?", "author": "radtriste", "createdAt": "2020-11-19T07:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI5ODQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI5OTM0Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r526299347", "bodyText": "I guess that one could then be deleted", "author": "radtriste", "createdAt": "2020-11-18T17:50:16Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -192,10 +214,19 @@ void saveReports(boolean allowEmpty=false){\n void checkoutRepo(String repo, String dirName=repo) {\n     dir(dirName) {\n         deleteDir()\n-        checkout(githubscm.resolveRepository(repo, getGitAuthor(), getBuildBranch(), false))\n+        githubscm.checkoutIfExists(repo, getGitAuthor(), getBuildBranch(), 'kiegroup', getDefaultBranch(repo), true)\n     }\n }\n \n+String getDefaultBranch(String repo) {\n+    // if not triggered by PR\n+    if (!params.PR_TARGET_BRANCH) {\n+        return 'master'\n+    }\n+    def repositoryScm = githubscm.getRepositoryScm(repo, 'kiegroup', params.PR_TARGET_BRANCH)\n+    return repositoryScm ? params.PR_TARGET_BRANCH : 'master'\n+}\n+", "originalCommit": "24ec9002e387888cd70ef56a0a52d8a13506af35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI5OTk5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r526299998", "bodyText": "This should not be deleted because in case of MAVEN_DEPLOY_CREDS_ID not defined we may still need to deploy to MAVEN_DEPLOY_REPOSITORY", "author": "radtriste", "createdAt": "2020-11-18T17:51:09Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -271,10 +302,18 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n }\n \n void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''", "originalCommit": "24ec9002e387888cd70ef56a0a52d8a13506af35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0067eb44cdd5b351ca071b74b3616fb7cb7121fc", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0067eb44cdd5b351ca071b74b3616fb7cb7121fc", "message": "[KOGITO-1031] Run BDD tests from PR", "committedDate": "2020-11-18T23:57:21Z", "type": "forcePushed"}, {"oid": "6a557e048c462e87010bbd273a85136ce58034cb", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6a557e048c462e87010bbd273a85136ce58034cb", "message": "[KOGITO-1031] Add Maven local deploy\n\nReplace hardcoded \"kogito-runtimes\" string with function.", "committedDate": "2021-01-09T01:38:25Z", "type": "forcePushed"}, {"oid": "592bef7a69909070bebe70d6f8ec660d6aea1c60", "url": "https://github.com/kiegroup/kogito-runtimes/commit/592bef7a69909070bebe70d6f8ec660d6aea1c60", "message": "[KOGITO-1031] Add Maven local deploy\n\nReplace hardcoded \"kogito-runtimes\" string with function.", "committedDate": "2021-01-15T12:55:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODMyODY5Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r558328696", "bodyText": "when do you need to set another directory ?", "author": "radtriste", "createdAt": "2021-01-15T14:07:23Z", "path": "Jenkinsfile.deploy", "diffHunk": "@@ -227,10 +238,13 @@ void setDeployPropertyIfNeeded(String key, def value){\n     }\n }\n \n-MavenCommand getMavenCommand(){\n+MavenCommand getMavenCommand(String directory = ''){\n+    if(!directory) {", "originalCommit": "592bef7a69909070bebe70d6f8ec660d6aea1c60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM0MzQ0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/731#discussion_r558343440", "bodyText": "We don't need to. I'll remove it from the other repositories as well.", "author": "Kevin-Mok", "createdAt": "2021-01-15T14:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODMyODY5Ng=="}], "type": "inlineReview"}, {"oid": "8b5360dac09e0a9dd22d025b3a5f86b92ec7efec", "url": "https://github.com/kiegroup/kogito-runtimes/commit/8b5360dac09e0a9dd22d025b3a5f86b92ec7efec", "message": "[KOGITO-1031] Add Maven local deploy\n\nReplace hardcoded \"kogito-runtimes\" string with function.", "committedDate": "2021-01-15T14:28:54Z", "type": "forcePushed"}, {"oid": "e783e4e2c263ccd9360c509938a4a4ff4700c4c3", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e783e4e2c263ccd9360c509938a4a4ff4700c4c3", "message": "KOGITO-4167 Set optaplanner before apps (#976)\n\n* KOGITO-4167 Set optaplanner before apps\r\n\r\n* added native command to Optaplanner\r\n\r\n* updated drools maven command name", "committedDate": "2021-01-21T08:09:06Z", "type": "forcePushed"}, {"oid": "c9a7ea40316f1b041359fe4b5d9fa12d047c2051", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c9a7ea40316f1b041359fe4b5d9fa12d047c2051", "message": "[KOGITO-1031] Add Maven local deploy\n\nReplace hardcoded \"kogito-runtimes\" string with function.", "committedDate": "2021-01-21T13:46:46Z", "type": "commit"}]}