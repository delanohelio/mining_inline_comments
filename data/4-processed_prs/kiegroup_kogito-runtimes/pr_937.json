{"pr_number": 937, "pr_title": "[KOGITO-3911] [master] Cherry-pick: Fix to ack received kafka messages on Quarkus", "pr_createdAt": "2020-12-15T17:05:28Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/937", "timeline": [{"oid": "04c81d8020f9d09b693cdb8f404a95c21ebccccb", "url": "https://github.com/kiegroup/kogito-runtimes/commit/04c81d8020f9d09b693cdb8f404a95c21ebccccb", "message": "[KOGITO-3911] [1.0.x] Fix to ack received kafka messages on QuarkusCloudEventPublisher #910", "committedDate": "2020-12-15T16:57:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA4NDE2Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/937#discussion_r555084163", "bodyText": "What about the atomicity here? What happens if we already acked all messages received from Kafka, but there is an issue when broadcasting them further down? Can it happen that broadcasting fails and the events are thus not resend as all of them are acked in the Kafka?", "author": "MarianMacik", "createdAt": "2021-01-11T14:28:54Z", "path": "addons/cloudevents/cloudevents-quarkus-addon/src/main/java/org/kie/kogito/addon/cloudevents/quarkus/QuarkusCloudEventPublisher.java", "diffHunk": "@@ -35,13 +36,15 @@\n @ApplicationScoped\n public class QuarkusCloudEventPublisher {\n     @Channel(KogitoEventStreams.INCOMING)\n-    Multi<String> events;\n+    Multi<Message<String>> events;\n \n     @Produces\n     @ApplicationScoped\n     @Named(KogitoEventStreams.PUBLISHER)\n     public Multi<String> makeMulti() {\n-        return events.broadcast().toAllSubscribers();\n-    }\n-\n-}\n+        return events\n+                .invoke(Message::ack)\n+                .map(Message::getPayload)\n+                .broadcast().toAllSubscribers();", "originalCommit": "04c81d8020f9d09b693cdb8f404a95c21ebccccb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ4NzM4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/937#discussion_r556487382", "bodyText": "@tiagodolphine ^^", "author": "MarianMacik", "createdAt": "2021-01-13T12:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA4NDE2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjQ5MTQwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/937#discussion_r556491408", "bodyText": "@MarianMacik yeah, we should design a proper way to let the consumers to ack the received messages we already pointed this when this fix was made, this requires some refactoring on the code because now the consumers receive only the payload of the messages as a String. Anyway, this was just a cherry-pick made for the 1.0.\nThere is a Jira I created to handle this issue https://issues.redhat.com/browse/KOGITO-3933.", "author": "tiagodolphine", "createdAt": "2021-01-13T12:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA4NDE2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzIzOTYwNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/937#discussion_r557239605", "bodyText": "@tiagodolphine Thanks, just wanted to make sure it is tracked somewhere ;)", "author": "MarianMacik", "createdAt": "2021-01-14T09:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA4NDE2Mw=="}], "type": "inlineReview"}]}