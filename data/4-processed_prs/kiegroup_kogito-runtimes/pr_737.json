{"pr_number": 737, "pr_title": "[KOGITO-3222] Implement jpmml/trustypmml co-existence", "pr_createdAt": "2020-09-01T13:18:15Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/737", "timeline": [{"oid": "32751ac95606c6ae61ba557dea697814622ff8af", "url": "https://github.com/kiegroup/kogito-runtimes/commit/32751ac95606c6ae61ba557dea697814622ff8af", "message": "[KOGITO-3222] Implement jpmml/trustypmml co-existence", "committedDate": "2020-09-01T13:07:55Z", "type": "commit"}, {"oid": "8a933086d771c88d46fa828aeb5ea1f3a84b1f08", "url": "https://github.com/kiegroup/kogito-runtimes/commit/8a933086d771c88d46fa828aeb5ea1f3a84b1f08", "message": "[KOGITO-3222] Implement jpmml/trustypmml co-existence", "committedDate": "2020-09-01T15:19:59Z", "type": "commit"}, {"oid": "c4edb4708d1450d4203226f16bc1cbc19b338f24", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c4edb4708d1450d4203226f16bc1cbc19b338f24", "message": "[KOGITO-3222] Using Jandex to verify jpmml presence in quarkus. Completely disabling trusty-pmml if jpmml is present", "committedDate": "2020-09-02T07:09:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzMzkyMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482133921", "bodyText": "Can you please add a log message?", "author": "danielezonca", "createdAt": "2020-09-02T14:54:42Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -88,15 +90,23 @@ public PredictionCodegen(List<PMMLResource> resources) {\n         this.moduleGenerator = new PredictionContainerGenerator(applicationCanonicalName, resources);\n     }\n \n-    public static PredictionCodegen ofCollectedResources(Collection<CollectedResource> resources) {\n+    public static PredictionCodegen ofCollectedResources(boolean isJPMMLAvailable,\n+                                                         Collection<CollectedResource> resources) {\n+        if (isJPMMLAvailable) {\n+            return ofPredictions(Collections.emptyList());", "originalCommit": "c4edb4708d1450d4203226f16bc1cbc19b338f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4ODA1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482688056", "bodyText": "@danielezonca\ndone", "author": "gitgabrio", "createdAt": "2020-09-03T03:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzMzkyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzNDA1NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482134055", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-09-02T14:54:51Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -88,15 +90,23 @@ public PredictionCodegen(List<PMMLResource> resources) {\n         this.moduleGenerator = new PredictionContainerGenerator(applicationCanonicalName, resources);\n     }\n \n-    public static PredictionCodegen ofCollectedResources(Collection<CollectedResource> resources) {\n+    public static PredictionCodegen ofCollectedResources(boolean isJPMMLAvailable,\n+                                                         Collection<CollectedResource> resources) {\n+        if (isJPMMLAvailable) {\n+            return ofPredictions(Collections.emptyList());\n+        }\n         List<PMMLResource> dmnResources = resources.stream()\n                 .filter(r -> r.resource().getResourceType() == ResourceType.PMML)\n-                .flatMap(r -> parsePredictions(r.basePath(), Collections.singletonList(r.resource())).stream())\n+                .flatMap(r -> parsePredictions(r.basePath(),\n+                                               Collections.singletonList(r.resource())).stream())\n                 .collect(toList());\n         return ofPredictions(dmnResources);\n     }\n \n-    public static PredictionCodegen ofJar(Path... jarPaths) throws IOException {\n+    public static PredictionCodegen ofJar(boolean isJPMMLAvailable, Path... jarPaths) throws IOException {\n+        if (isJPMMLAvailable) {\n+            return ofPredictions(Collections.emptyList());", "originalCommit": "c4edb4708d1450d4203226f16bc1cbc19b338f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4ODA4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482688086", "bodyText": "@danielezonca\nSame as above", "author": "gitgabrio", "createdAt": "2020-09-03T03:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzNDA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzNDE5Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482134193", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-09-02T14:54:59Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -119,7 +129,10 @@ public static PredictionCodegen ofJar(Path... jarPaths) throws IOException {\n         return ofPredictions(pmmlResources);\n     }\n \n-    public static PredictionCodegen ofPath(Path... paths) throws IOException {\n+    public static PredictionCodegen ofPath(boolean isJPMMLAvailable, Path... paths) throws IOException {\n+        if (isJPMMLAvailable) {\n+            return ofPredictions(Collections.emptyList());", "originalCommit": "c4edb4708d1450d4203226f16bc1cbc19b338f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4ODExOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482688118", "bodyText": "@danielezonca\nSame as above", "author": "gitgabrio", "createdAt": "2020-09-03T03:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzNDE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzNDMzMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482134330", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-09-02T14:55:09Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -133,7 +146,10 @@ public static PredictionCodegen ofPath(Path... paths) throws IOException {\n         return ofPredictions(resources);\n     }\n \n-    public static PredictionCodegen ofFiles(Path basePath, List<File> files) {\n+    public static PredictionCodegen ofFiles(boolean isJPMMLAvailable, Path basePath, List<File> files) {\n+        if (isJPMMLAvailable) {\n+            return ofPredictions(Collections.emptyList());", "originalCommit": "c4edb4708d1450d4203226f16bc1cbc19b338f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4ODEzNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r482688134", "bodyText": "@danielezonca\nSame as above", "author": "gitgabrio", "createdAt": "2020-09-03T03:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEzNDMzMA=="}], "type": "inlineReview"}, {"oid": "59089f36679eafc60349f8dd39d4acbabecf2cf4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/59089f36679eafc60349f8dd39d4acbabecf2cf4", "message": "[KOGITO-3222] Logging usage of jpmml", "committedDate": "2020-09-03T03:52:21Z", "type": "commit"}, {"oid": "faaacf0d4d7cfc51981ffd4618ea1ea68fa4077b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/faaacf0d4d7cfc51981ffd4618ea1ea68fa4077b", "message": "Merge remote-tracking branch 'origin/master' into KOGITO-3222", "committedDate": "2020-09-03T03:52:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTMwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484949301", "bodyText": "I would advise merging #741 before. Most of these factory methods have been deleted for good", "author": "evacchi", "createdAt": "2020-09-08T14:07:58Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -88,15 +90,25 @@ public PredictionCodegen(List<PMMLResource> resources) {\n         this.moduleGenerator = new PredictionContainerGenerator(applicationCanonicalName, resources);\n     }\n \n-    public static PredictionCodegen ofCollectedResources(Collection<CollectedResource> resources) {\n+    public static PredictionCodegen ofCollectedResources(boolean isJPMMLAvailable,\n+                                                         Collection<CollectedResource> resources) {\n+        if (isJPMMLAvailable) {\n+            logger.info(\"jpmml libraries available on classpath, skipping kie-pmml parsing and compilation\");\n+            return ofPredictions(Collections.emptyList());\n+        }\n         List<PMMLResource> dmnResources = resources.stream()\n                 .filter(r -> r.resource().getResourceType() == ResourceType.PMML)\n-                .flatMap(r -> parsePredictions(r.basePath(), Collections.singletonList(r.resource())).stream())\n+                .flatMap(r -> parsePredictions(r.basePath(),\n+                                               Collections.singletonList(r.resource())).stream())\n                 .collect(toList());\n         return ofPredictions(dmnResources);\n     }\n \n-    public static PredictionCodegen ofJar(Path... jarPaths) throws IOException {\n+    public static PredictionCodegen ofJar(boolean isJPMMLAvailable, Path... jarPaths) throws IOException {", "originalCommit": "faaacf0d4d7cfc51981ffd4618ea1ea68fa4077b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4NTg0Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484985843", "bodyText": "@evacchi\n\ud83d\udc4d", "author": "gitgabrio", "createdAt": "2020-09-08T14:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTk2OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484949969", "bodyText": "is the rest of this file just being reformatted or...?", "author": "evacchi", "createdAt": "2020-09-08T14:08:51Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -198,14 +217,15 @@ public PredictionContainerGenerator moduleGenerator() {\n         if (resources.isEmpty()) {\n             return Collections.emptyList();\n         }\n-        ModelBuilderImpl<KogitoPackageSources> modelBuilder = new ModelBuilderImpl<>( KogitoPackageSources::dumpSources,\n-                new KnowledgeBuilderConfigurationImpl(getClass().getClassLoader()), new ReleaseIdImpl(\"dummy:dummy:0.0.0\"), true, false );\n+        ModelBuilderImpl<KogitoPackageSources> modelBuilder = new ModelBuilderImpl<>(KogitoPackageSources::dumpSources,", "originalCommit": "faaacf0d4d7cfc51981ffd4618ea1ea68fa4077b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4NDc2MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484984761", "bodyText": "@evacchi\nYup", "author": "gitgabrio", "createdAt": "2020-09-08T14:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1MDU5Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484950597", "bodyText": "let's merge after 7.43.0 is Final", "author": "evacchi", "createdAt": "2020-09-08T14:09:45Z", "path": "kogito-build-parent/pom.xml", "diffHunk": "@@ -129,7 +129,8 @@\n     <version.org.keycloak>11.0.0</version.org.keycloak>\n     <version.org.mockito>3.3.3</version.org.mockito>\n     <version.org.mvel>2.4.7.Final</version.org.mvel>\n-    <version.org.kie7>7.43.0.t20200824</version.org.kie7>\n+<!--    <version.org.kie7>7.43.0.t20200824</version.org.kie7>-->\n+    <version.org.kie7>7.43.0-SNAPSHOT</version.org.kie7>", "originalCommit": "faaacf0d4d7cfc51981ffd4618ea1ea68fa4077b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3NjIzMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484976231", "bodyText": "\ud83d\udc4d", "author": "gitgabrio", "createdAt": "2020-09-08T14:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1MDU5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNzg5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r485017894", "bodyText": "Except for this line, thank you for keeping me in the loop Gabriele, lgtm", "author": "tarilabs", "createdAt": "2020-09-08T15:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1MDU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1MTE1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484951154", "bodyText": "all the remaining changes in this file are just whitespace changes right?", "author": "evacchi", "createdAt": "2020-09-08T14:10:30Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -198,14 +217,15 @@ public PredictionContainerGenerator moduleGenerator() {\n         if (resources.isEmpty()) {\n             return Collections.emptyList();\n         }\n-        ModelBuilderImpl<KogitoPackageSources> modelBuilder = new ModelBuilderImpl<>( KogitoPackageSources::dumpSources,\n-                new KnowledgeBuilderConfigurationImpl(getClass().getClassLoader()), new ReleaseIdImpl(\"dummy:dummy:0.0.0\"), true, false );\n+        ModelBuilderImpl<KogitoPackageSources> modelBuilder = new ModelBuilderImpl<>(KogitoPackageSources::dumpSources,\n+                                                                                     new KnowledgeBuilderConfigurationImpl(getClass().getClassLoader()), new ReleaseIdImpl(\"dummy:dummy:0.0.0\"), true, false);\n         CompositeKnowledgeBuilder batch = modelBuilder.batch();\n         for (PMMLResource resource : resources) {\n             List<KiePMMLModel> kiepmmlModels = resource.getKiePmmlModels();\n             for (KiePMMLModel model : kiepmmlModels) {\n                 if (model.getName() == null || model.getName().isEmpty()) {\n-                    String errorMessage = String.format(\"Model name should not be empty inside %s\", resource.getModelPath());\n+                    String errorMessage = String.format(\"Model name should not be empty inside %s\",", "originalCommit": "faaacf0d4d7cfc51981ffd4618ea1ea68fa4077b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3NjgxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r484976814", "bodyText": "@evacchi\nYes", "author": "gitgabrio", "createdAt": "2020-09-08T14:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1MTE1NA=="}], "type": "inlineReview"}, {"oid": "553dc45ecc01182b1939ad4491af55bdf944f859", "url": "https://github.com/kiegroup/kogito-runtimes/commit/553dc45ecc01182b1939ad4491af55bdf944f859", "message": "Merge remote-tracking branch 'origin/master' into KOGITO-3222\n\n# Conflicts:\n#\tkogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java\n#\tkogito-codegen/src/test/java/org/kie/kogito/codegen/AbstractCodegenTest.java\n#\tkogito-codegen/src/test/java/org/kie/kogito/codegen/prediction/PredictionCodegenTest.java\n#\tkogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateModelMojo.java\n#\tkogito-quarkus-extension/deployment/src/main/java/org/kie/kogito/quarkus/deployment/KogitoAssetsProcessor.java", "committedDate": "2020-09-09T09:01:26Z", "type": "commit"}, {"oid": "473a4fb1d5be8eff6b9d395790145ad4d2802a12", "url": "https://github.com/kiegroup/kogito-runtimes/commit/473a4fb1d5be8eff6b9d395790145ad4d2802a12", "message": "[KOGITO-3222] Merged with master. Removing snapshot dependency", "committedDate": "2020-09-09T09:50:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2MzAwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r485563001", "bodyText": "Why this new line?", "author": "jiripetrlik", "createdAt": "2020-09-09T12:14:03Z", "path": "drools/kogito-pmml/src/test/java/org/kie/kogito/pmml/PmmlPredictionModelTest.java", "diffHunk": "@@ -93,6 +94,7 @@ private static PMMLRuntime getPMMLRuntime() {\n             public PMML4Result evaluate(String s, PMMLContext pmmlContext) {\n                 return PMML_4_RESULT;\n             }\n+", "originalCommit": "473a4fb1d5be8eff6b9d395790145ad4d2802a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2NTk2NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/737#discussion_r485565964", "bodyText": "@jiripetrlik\nRemoved", "author": "gitgabrio", "createdAt": "2020-09-09T12:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2MzAwMQ=="}], "type": "inlineReview"}, {"oid": "9a0f60ed4c5d803e03c315ef1a9d06b27427cc41", "url": "https://github.com/kiegroup/kogito-runtimes/commit/9a0f60ed4c5d803e03c315ef1a9d06b27427cc41", "message": "[KOGITO-3222] Removed empty line", "committedDate": "2020-09-09T12:18:43Z", "type": "commit"}]}