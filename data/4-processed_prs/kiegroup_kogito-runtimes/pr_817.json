{"pr_number": 817, "pr_title": "KOGITO-3601 DMN integrate programmatically generated OAS definitions", "pr_createdAt": "2020-10-09T13:43:38Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/817", "timeline": [{"oid": "cf5cd8df0e80449aaec97239a8b551e9b7fa1b60", "url": "https://github.com/kiegroup/kogito-runtimes/commit/cf5cd8df0e80449aaec97239a8b551e9b7fa1b60", "message": "DROOLS-5714 DMN produce programmatically OAS first iteration", "committedDate": "2020-10-19T15:57:33Z", "type": "commit"}, {"oid": "1ce433080f1828fe84e99b90bd10a0e6ef06f201", "url": "https://github.com/kiegroup/kogito-runtimes/commit/1ce433080f1828fe84e99b90bd10a0e6ef06f201", "message": "update 2020-10-13, full build green", "committedDate": "2020-10-19T15:57:34Z", "type": "commit"}, {"oid": "e95ce57d6eafa326a7762fcd9bbfc8c58b22ca64", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e95ce57d6eafa326a7762fcd9bbfc8c58b22ca64", "message": "basic test to ensure the OAS dmnDefinitions.json is present and served", "committedDate": "2020-10-19T15:57:34Z", "type": "commit"}, {"oid": "e95ce57d6eafa326a7762fcd9bbfc8c58b22ca64", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e95ce57d6eafa326a7762fcd9bbfc8c58b22ca64", "message": "basic test to ensure the OAS dmnDefinitions.json is present and served", "committedDate": "2020-10-19T15:57:34Z", "type": "forcePushed"}, {"oid": "22a2ae63eb790fb2452f39118409b967dc3cbc03", "url": "https://github.com/kiegroup/kogito-runtimes/commit/22a2ae63eb790fb2452f39118409b967dc3cbc03", "message": "wiring DS for JSON unmarshalling semantics", "committedDate": "2020-10-20T08:23:38Z", "type": "commit"}, {"oid": "2f8d75de512ec767f743ce093f74121839f0cf99", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2f8d75de512ec767f743ce093f74121839f0cf99", "message": "DS type annotations and IT Quarkus", "committedDate": "2020-10-20T09:12:33Z", "type": "commit"}, {"oid": "3c486ea7660b8c25fc42e1509dca67b70e1d03c8", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3c486ea7660b8c25fc42e1509dca67b70e1d03c8", "message": "SpringBoot IT test", "committedDate": "2020-10-20T09:43:40Z", "type": "commit"}, {"oid": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "message": "fix typo in header", "committedDate": "2020-10-20T09:46:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NDgwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509264800", "bodyText": "Just for curiosity, is this PR compatible with stronglytyped option?", "author": "danielezonca", "createdAt": "2020-10-21T13:11:32Z", "path": "integration-tests/integration-tests-quarkus-decisions/src/main/resources/application.properties", "diffHunk": "@@ -0,0 +1,2 @@\n+# for these tests, we do NOT want stronglytyped to be enabled, leave it as default disabled.\n+# kogito.decisions.stronglytyped=false", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3OTU1Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509279553", "bodyText": "It is a very valid point Daniele, thank you this question.\nThey are 100% compatible:\n\nSwagger/OpenAPI deals with specifying a protocol\nStronglyTyped deal with Kogito API internals AND it has implications for the Marshaller (Jackson)\n\nbut since Jackson does work independently of Swagger/OAS, these features are independent as a result as well.\nNaturally, we want them consistent, and this PR ensures that. \ud83d\udc4d", "author": "tarilabs", "createdAt": "2020-10-21T13:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NDgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NTYxOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509265618", "bodyText": "Why do we need to expose this file? I saw it is used in OpenAPI/Swagger annotations so I expect it is used during openapi.json generation but not sure if it is needed at runtime", "author": "danielezonca", "createdAt": "2020-10-21T13:12:43Z", "path": "integration-tests/integration-tests-quarkus-decisions/src/test/java/org/kie/kogito/integrationtests/quarkus/OASTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.kie.kogito.integrationtests.quarkus;\n+\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.hamcrest.Matchers.aMapWithSize;\n+import static org.hamcrest.Matchers.greaterThan;\n+\n+@QuarkusTest\n+class OASTest {\n+\n+    static {\n+        RestAssured.enableLoggingOfRequestAndResponseIfValidationFails();\n+    }\n+\n+    @Test\n+    public void testOASdmnDefinitions() {\n+        RestAssured.given()\n+                   .get(\"/dmnDefinitions.json\")", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MDMwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509280300", "bodyText": "it is needed at runtime since the openapi.json/.yaml will Reference the dmnDefinitions.json content.\nThis is a standard mechanism for OAS", "author": "tarilabs", "createdAt": "2020-10-21T13:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NTYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NTk4NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509265984", "bodyText": "What about make this dependency part of Kogito Springboot archetype? I think this feature could be considered enabled by default. Wdyt?", "author": "danielezonca", "createdAt": "2020-10-21T13:13:13Z", "path": "integration-tests/integration-tests-springboot/src/it/integration-tests-springboot-it/pom.xml", "diffHunk": "@@ -48,6 +48,11 @@\n             <groupId>org.kie.kogito</groupId>\n             <artifactId>kogito-springboot-starter</artifactId>\n         </dependency>\n+        \n+        <dependency>\n+          <groupId>io.swagger.core.v3</groupId>\n+          <artifactId>swagger-annotations</artifactId>\n+        </dependency>", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4MjUwNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509282506", "bodyText": "As a separate JIRA please https://issues.redhat.com/browse/KOGITO-3671", "author": "tarilabs", "createdAt": "2020-10-21T13:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NTk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NjUyNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509266525", "bodyText": "Is it a known issue?", "author": "danielezonca", "createdAt": "2020-10-21T13:14:00Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/decision/DecisionCodegen.java", "diffHunk": "@@ -67,6 +71,7 @@\n     public static String VALIDATION_CONFIGURATION_KEY = \"kogito.decisions.validation\";\n \n     public static DecisionCodegen ofCollectedResources(Collection<CollectedResource> resources) {\n+        OASFactoryResolver.instance(); // manually invoke SPI, o/w Kogito CodeGen Kogito Quarkus extension failure at NewFileHotReloadTest due to java.util.ServiceConfigurationError: org.eclipse.microprofile.openapi.spi.OASFactoryResolver: io.smallrye.openapi.spi.OASFactoryResolverImpl not a subtype", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4Mzg5Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509283896", "bodyText": "Discussed with Mario, yes. He suggested for me to place code comment indeed for this known Quarkus extension <> Codegen limitation of interaction", "author": "tarilabs", "createdAt": "2020-10-21T13:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NjUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NzIwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509267208", "bodyText": "What about make this error fatal (aka propagate) if\nisMPAnnotationsPresent() || isIOSwaggerOASv3AnnotationsPresent()\nis true?", "author": "danielezonca", "createdAt": "2020-10-21T13:14:57Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/decision/DecisionCodegen.java", "diffHunk": "@@ -140,6 +146,16 @@ public void setDependencyInjection(DependencyInjectionAnnotator annotator) {\n \n     private void generateAndStoreRestResources() {\n         List<DecisionRestResourceGenerator> rgs = new ArrayList<>(); // REST resources\n+        \n+        DMNOASResult oasResult = null;\n+        try {\n+            List<DMNModel> models = resources.stream().map(DMNResource::getDmnModel).collect(Collectors.toList());\n+            oasResult = DMNOASGeneratorFactory.generator(models).build();\n+            String jsonContent = new ObjectMapper().writeValueAsString(oasResult.getJsonSchemaNode());\n+            storeFile(GeneratedFile.Type.GENERATED_CP_RESOURCE, \"META-INF/resources/dmnDefinitions.json\", jsonContent);\n+        } catch (Exception e) {\n+            LOG.error(\"Error while trying to generate OpenAPI specification for the DMN models\", e);", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4NTcyMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509285723", "bodyText": "can't implement that due to limitation of CodeGen design choices of today\nAlso, this OAS generation should be seen as accessory: I don't want to hard fail if I can't generate some metadata", "author": "tarilabs", "createdAt": "2020-10-21T13:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NzIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2ODIzOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509268239", "bodyText": "What about something like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new IllegalStateException();\n          \n          \n            \n                            throw new IllegalStateException(\"Impossible to find annotation \" + parentName + \" on method \" + dmnMethod.toString());", "author": "danielezonca", "createdAt": "2020-10-21T13:15:57Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/decision/DecisionRestResourceGenerator.java", "diffHunk": "@@ -150,6 +161,66 @@ public String generate() {\n         return clazz.toString();\n     }\n \n+    private void processOASAnn(MethodDeclaration dmnMethod, DecisionService ds) {\n+        String inputRef = null;\n+        String outputRef = null;\n+        if (withOASResult!= null) {\n+            DMNModelIOSets ioSets = withOASResult.lookupIOSetsByModel(dmnModel);\n+            DMNType identifyInputSet = ds != null ? ioSets.lookupDSIOSetsByName(ds.getName()).getDSInputSet() : ioSets.getInputSet();\n+            DMNType identifyOutputSet = ds != null ? ioSets.lookupDSIOSetsByName(ds.getName()).getDSOutputSet() : ioSets.getOutputSet();\n+            inputRef = withOASResult.getNamingPolicy().getRef(identifyInputSet);\n+            outputRef = withOASResult.getNamingPolicy().getRef(identifyOutputSet);\n+        }\n+        // MP / Quarkus\n+        processAnnForRef(dmnMethod,\n+                         \"org.eclipse.microprofile.openapi.annotations.parameters.RequestBody\",\n+                         \"org.eclipse.microprofile.openapi.annotations.media.Schema\",\n+                         \"/dmnDefinitions.json\" + inputRef,\n+                         !mpAnnPresent);\n+        processAnnForRef(dmnMethod,\n+                         \"org.eclipse.microprofile.openapi.annotations.responses.APIResponse\",\n+                         \"org.eclipse.microprofile.openapi.annotations.media.Schema\",\n+                         \"/dmnDefinitions.json\" + outputRef,\n+                         !mpAnnPresent);\n+        // io.swagger / SB\n+        processAnnForRef(dmnMethod,\n+                         \"io.swagger.v3.oas.annotations.parameters.RequestBody\",\n+                         \"io.swagger.v3.oas.annotations.media.Schema\",\n+                         \"/docs/dmnDefinitions.json\" + inputRef,\n+                         !swaggerAnnPresent);\n+        processAnnForRef(dmnMethod,\n+                         \"io.swagger.v3.oas.annotations.responses.ApiResponse\",\n+                         \"io.swagger.v3.oas.annotations.media.Schema\",\n+                         \"/docs/dmnDefinitions.json\" + outputRef,\n+                         !swaggerAnnPresent);\n+    }\n+\n+    private void processAnnForRef(MethodDeclaration dmnMethod, String parentName, String innerName, String ref, boolean removeIt) {\n+        List<NormalAnnotationExpr> findAll = dmnMethod.findAll(NormalAnnotationExpr.class, x -> x.getName().toString().equals(parentName));\n+        if (findAll.isEmpty()) {\n+            if (removeIt) {\n+                return; // nothing to do\n+            } else {\n+                throw new IllegalStateException();", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2ODc3Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509268772", "bodyText": "Good point. Do you think it makes sense to add schema declaration also for this return type in the future?", "author": "danielezonca", "createdAt": "2020-10-21T13:16:38Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/decision/DecisionRestResourceGenerator.java", "diffHunk": "@@ -170,6 +241,9 @@ private void modifyDmnMethodForStronglyTyped(ClassOrInterfaceDeclaration templat\n \n     private MethodDeclaration cloneForDMNResult(MethodDeclaration dmnMethod, String name, String pathName) {\n         MethodDeclaration clonedDmnMethod = dmnMethod.clone();\n+        // a DMNResult-returning method doesn't need the OAS annotations for the $ref of return type.", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzMzU1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509333556", "bodyText": "Possibly, but that will be much harded, since OAS doesn't have a concept for \"generic\", in other words there is not a simple way to describe DMNResult<OutputSet123>. Deferring.", "author": "tarilabs", "createdAt": "2020-10-21T14:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2ODc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3MDYxOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509270619", "bodyText": "When PCLResolverFn is overridden, the value of classLoader field is not used so we can remove the first call. Btw this could become no more true in the future so up to you :)", "author": "danielezonca", "createdAt": "2020-10-21T13:19:04Z", "path": "kogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateModelMojo.java", "diffHunk": "@@ -281,7 +281,8 @@ private ApplicationGenerator createApplicationGenerator() throws IOException, Mo\n         if (generateDecisions()) {\n             appGen.withGenerator(DecisionCodegen.ofCollectedResources(CollectedResource.fromDirectory(kieSourcesDirectory.toPath())))\n                   .withAddons(addonsConfig)\n-                  .withClassLoader(projectClassLoader);\n+                  .withClassLoader(projectClassLoader)\n+                  .withPCLResolverFn(x -> hasClassOnClasspath(project, x));", "originalCommit": "6c4d8811d76a1ae589b3cfaf81bd858faa214cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzMjc1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/817#discussion_r509332752", "bodyText": "as discussed in call, leaving as-is for the scope of this PR. When CodeGen design will eventually change, can always revise.", "author": "tarilabs", "createdAt": "2020-10-21T14:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3MDYxOQ=="}], "type": "inlineReview"}, {"oid": "e9e6202ec9fd4e1a82ee40a5f31762469aff660e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e9e6202ec9fd4e1a82ee40a5f31762469aff660e", "message": "Update kogito-codegen/src/main/java/org/kie/kogito/codegen/decision/DecisionRestResourceGenerator.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-10-21T14:23:24Z", "type": "commit"}, {"oid": "dcbc32cc465e4a057f636cb77e425dfd7218c2dc", "url": "https://github.com/kiegroup/kogito-runtimes/commit/dcbc32cc465e4a057f636cb77e425dfd7218c2dc", "message": "align pom.xml mods to PR KOGITO-3499", "committedDate": "2020-10-22T07:55:06Z", "type": "commit"}, {"oid": "133b3609eee334a21181f4032920be37e6a5cdd1", "url": "https://github.com/kiegroup/kogito-runtimes/commit/133b3609eee334a21181f4032920be37e6a5cdd1", "message": "Merge branch 'master' into tarilabs-20201006-openapigenerator", "committedDate": "2020-10-22T07:56:53Z", "type": "commit"}]}