{"pr_number": 629, "pr_title": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance f\u2026", "pr_createdAt": "2020-07-13T12:40:19Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/629", "timeline": [{"oid": "1096b6d97e7e7f22c289e9aa395325c6b91e9f23", "url": "https://github.com/kiegroup/kogito-runtimes/commit/1096b6d97e7e7f22c289e9aa395325c6b91e9f23", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence", "committedDate": "2020-07-13T13:33:31Z", "type": "forcePushed"}, {"oid": "086473779c28d59af7cb3d5cee9a8d68fd07465a", "url": "https://github.com/kiegroup/kogito-runtimes/commit/086473779c28d59af7cb3d5cee9a8d68fd07465a", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence", "committedDate": "2020-07-15T08:45:26Z", "type": "forcePushed"}, {"oid": "c14f24f95114d7e3399145019f523cf1d77e050d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c14f24f95114d7e3399145019f523cf1d77e050d", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence", "committedDate": "2020-07-15T11:09:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NTAyMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455185021", "bodyText": "why this changed?", "author": "mswiderski", "createdAt": "2020-07-15T16:40:25Z", "path": "addons/persistence/filesystem-persistence-addon/src/test/java/org/kie/persistence/filesystem/FileSystemProcessInstancesTest.java", "diffHunk": "@@ -84,13 +83,12 @@ public void testBasicFlow() {\n         assertThat(processInstance.status()).isEqualTo(STATE_COMPLETED);\n \n         fileSystemBasedStorage = (FileSystemProcessInstances) process.instances();\n-        verify(fileSystemBasedStorage, times(2)).remove(any());\n+        verify(fileSystemBasedStorage, times(3)).remove(any());", "originalCommit": "c14f24f95114d7e3399145019f523cf1d77e050d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxNzM0MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455917341", "bodyText": "fixed now, I missed a changed in the reload supplier https://github.com/kiegroup/kogito-runtimes/pull/629/files#diff-be94bd4c400c02c83293fd0cb5164e0cR160", "author": "cristianonicolai", "createdAt": "2020-07-16T16:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NTAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NjA3MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455186071", "bodyText": "maybe make it protected so it can be adjusted by subclasses if needed", "author": "mswiderski", "createdAt": "2020-07-15T16:42:11Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -93,25 +93,24 @@ public AbstractProcessInstance(AbstractProcess<T> process, T variables, String b\n \n         Map<String, Object> map = bind(variables);\n         String processId = process.process().getId();\n-        this.processInstance = (WorkflowProcessInstance)((CorrelationAwareProcessRuntime) rt).createProcessInstance(processId, correlationKey, map);\n-        this.description = processInstance.getDescription();\n-        this.status = ProcessInstance.STATE_PENDING;\n+        reloadProcessInstance((WorkflowProcessInstance) ((CorrelationAwareProcessRuntime) rt).createProcessInstance(processId, correlationKey, map));\n     }\n \n-    // for marshaller/persistence only\n-    public void internalSetProcessInstance(WorkflowProcessInstance processInstance) {\n-        if (this.processInstance != null && this.status != ProcessInstance.STATE_PENDING) {\n-            throw new IllegalStateException(\"Impossible to override process instance that already exists\");\n+    public AbstractProcessInstance(AbstractProcess<T> process, T variables, ProcessRuntime rt, org.kie.api.runtime.process.WorkflowProcessInstance wpi) {\n+        this.process = process;\n+        this.rt = rt;\n+        this.variables = variables;\n+        reloadProcessInstance((WorkflowProcessInstance) wpi);\n+        reconnect();\n+    }\n+\n+    private void reconnect() {", "originalCommit": "c14f24f95114d7e3399145019f523cf1d77e050d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxNzQxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455917412", "bodyText": "done", "author": "cristianonicolai", "createdAt": "2020-07-16T16:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NjA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzQyMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455187422", "bodyText": "bit misleading method name ... maybe syncProcessInstanceState or similar so it indicates that the is no actual reloading of process instance here :)", "author": "mswiderski", "createdAt": "2020-07-15T16:44:24Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -122,6 +121,37 @@ public void internalSetProcessInstance(WorkflowProcessInstance processInstance)\n         unbind(variables, processInstance.getVariables());\n     }\n \n+    private void addCompletionEventListener() {\n+        if (completionEventListener == null) {\n+            completionEventListener = new CompletionEventListener();\n+            processInstance.addEventListener(\"processInstanceCompleted:\" + id, completionEventListener, false);\n+        }\n+    }\n+\n+    private void removeCompletionListener() {\n+        if (completionEventListener != null) {\n+            processInstance.removeEventListener(\"processInstanceCompleted:\" + id, completionEventListener, false);\n+            completionEventListener = null;\n+        }\n+    }\n+\n+    private void disconnect() {\n+        if (processInstance == null) {\n+            return;\n+        }\n+\n+        processInstance.disconnect();\n+        processInstance.setMetaData(\"KogitoProcessInstance\", null);\n+    }\n+\n+    private void reloadProcessInstance(WorkflowProcessInstance wpi) {", "originalCommit": "c14f24f95114d7e3399145019f523cf1d77e050d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxNzU2Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455917562", "bodyText": "+1, renamed to syncProcessInstanceState", "author": "cristianonicolai", "createdAt": "2020-07-16T16:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzQyMg=="}], "type": "inlineReview"}, {"oid": "0bae343ddf462510b038dd3dc26b1a2d0afa879b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0bae343ddf462510b038dd3dc26b1a2d0afa879b", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence", "committedDate": "2020-07-16T16:28:35Z", "type": "commit"}, {"oid": "0bae343ddf462510b038dd3dc26b1a2d0afa879b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0bae343ddf462510b038dd3dc26b1a2d0afa879b", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence", "committedDate": "2020-07-16T16:28:35Z", "type": "forcePushed"}]}