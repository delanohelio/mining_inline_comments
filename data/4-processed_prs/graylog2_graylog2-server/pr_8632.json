{"pr_number": 8632, "pr_title": "Consolidate index mappings and associated tests", "pr_createdAt": "2020-07-28T10:02:23Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8632", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI1MzE5Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8632#discussion_r464253193", "bodyText": "What is the actual todo item here?", "author": "dennisoelkers", "createdAt": "2020-08-03T07:59:20Z", "path": "graylog2-server/src/main/java/org/graylog2/indexer/EventsIndexMapping6.java", "diffHunk": "@@ -16,194 +16,13 @@\n  */\n package org.graylog2.indexer;\n \n-import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableMap;\n-import org.graylog2.indexer.indexset.IndexSetConfig;\n-import org.graylog2.plugin.Tools;\n \n-import java.util.Map;\n-\n-public class EventsIndexMapping6 implements IndexMappingTemplate {\n+public class EventsIndexMapping6 extends EventsIndexMapping {\n     @Override\n-    public Map<String, Object> toTemplate(IndexSetConfig indexSetConfig, String indexPattern, int order) {\n-        final String indexPatternsField = \"index_patterns\";\n-        final Object indexPatternsValue = indexPattern;\n-        final String indexRefreshInterval = \"1s\"; // TODO: Index refresh interval must be configurable\n-\n+    protected ImmutableMap<String, Object> buildMappings() {\n         return map()\n-                .put(indexPatternsField, indexPatternsValue)\n-                .put(\"order\", order)\n-                .put(\"settings\", map()\n-                        .put(\"index.refresh_interval\", indexRefreshInterval)\n-                        .build())\n-                .put(\"mappings\", map()\n-                        .put(IndexMapping.TYPE_MESSAGE, map() // TODO: Type name is \"message\" because the index field type poller is using that\n-                                .put(\"_source\", map()\n-                                        .put(\"enabled\", true)\n-                                        .build())\n-                                .put(\"dynamic\", false)\n-                                .put(\"dynamic_templates\", list()\n-                                        .add(map()\n-                                                .put(\"fields\", map()\n-                                                        .put(\"path_match\", \"fields.*\")\n-                                                        .put(\"mapping\", map()\n-                                                                .put(\"type\", \"keyword\")\n-                                                                .put(\"doc_values\", true)\n-                                                                .put(\"index\", true)\n-                                                                .build())\n-                                                        .build())\n-                                                .build())\n-                                        /* TODO: Enable the typed fields once we decided if that's the way to go\n-                                        .add(map()\n-                                                .put(\"fields-typed-long\", map()\n-                                                        .put(\"path_match\", \"fields_typed.long.*\")\n-                                                        .put(\"mapping\", map()\n-                                                                .put(\"type\", \"long\")\n-                                                                .put(\"doc_values\", true)\n-                                                                .put(\"index\", true)\n-                                                                .build())\n-                                                        .build())\n-                                                .build())\n-                                        .add(map()\n-                                                .put(\"fields-typed-double\", map()\n-                                                        .put(\"path_match\", \"fields_typed.double.*\")\n-                                                        .put(\"mapping\", map()\n-                                                                .put(\"type\", \"double\")\n-                                                                .put(\"doc_values\", true)\n-                                                                .put(\"index\", true)\n-                                                                .build())\n-                                                        .build())\n-                                                .build())\n-                                        .add(map()\n-                                                .put(\"fields-typed-boolean\", map()\n-                                                        .put(\"path_match\", \"fields_typed.boolean.*\")\n-                                                        .put(\"mapping\", map()\n-                                                                .put(\"type\", \"boolean\")\n-                                                                .put(\"doc_values\", true)\n-                                                                .put(\"index\", true)\n-                                                                .build())\n-                                                        .build())\n-                                                .build())\n-                                        .add(map()\n-                                                .put(\"fields-typed-ip\", map()\n-                                                        .put(\"path_match\", \"fields_typed.ip.*\")\n-                                                        .put(\"mapping\", map()\n-                                                                .put(\"type\", \"ip\")\n-                                                                .put(\"doc_values\", true)\n-                                                                .put(\"index\", true)\n-                                                                .build())\n-                                                        .build())\n-                                                .build())\n-                                         */\n-                                        .build())\n-                                .put(\"properties\", map()\n-                                        .put(\"id\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"event_definition_type\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"event_definition_id\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"origin_context\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"timestamp\", map()\n-                                                .put(\"type\", \"date\")\n-                                                // Use the same format we use for the \"message\" mapping to make sure we\n-                                                // can use the search.\n-                                                .put(\"format\", Tools.ES_DATE_FORMAT)\n-                                                .build())\n-                                        .put(\"timestamp_processing\", map()\n-                                                .put(\"type\", \"date\")\n-                                                // Use the same format we use for the \"message\" mapping to make sure we\n-                                                // can use the search.\n-                                                .put(\"format\", Tools.ES_DATE_FORMAT)\n-                                                .build())\n-                                        .put(\"timerange_start\", map()\n-                                                .put(\"type\", \"date\")\n-                                                // Use the same format we use for the \"message\" mapping to make sure we\n-                                                // can use the search.\n-                                                .put(\"format\", Tools.ES_DATE_FORMAT)\n-                                                .build())\n-                                        .put(\"timerange_end\", map()\n-                                                .put(\"type\", \"date\")\n-                                                // Use the same format we use for the \"message\" mapping to make sure we\n-                                                // can use the search.\n-                                                .put(\"format\", Tools.ES_DATE_FORMAT)\n-                                                .build())\n-                                        .put(\"streams\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"source_streams\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"message\", map()\n-                                                .put(\"type\", \"text\")\n-                                                .put(\"analyzer\", \"standard\")\n-                                                .put(\"norms\", false)\n-                                                .put(\"fields\", map()\n-                                                        .put(\"keyword\", map()\n-                                                                .put(\"type\", \"keyword\")\n-                                                                .build())\n-                                                        .build())\n-                                                .build())\n-                                        .put(\"source\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"key\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"key_tuple\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .put(\"priority\", map()\n-                                                .put(\"type\", \"long\")\n-                                                .build())\n-                                        .put(\"alert\", map()\n-                                                .put(\"type\", \"boolean\")\n-                                                .build())\n-                                        .put(\"fields\", map()\n-                                                .put(\"type\", \"object\")\n-                                                .put(\"dynamic\", true)\n-                                                .build())\n-                                        /* TODO: Enable the typed fields once we decided if that's the way to go\n-                                        .put(\"fields_typed\", map()\n-                                                .put(\"type\", \"object\")\n-                                                .put(\"properties\", map()\n-                                                        .put(\"long\", map()\n-                                                                .put(\"type\", \"object\")\n-                                                                .put(\"dynamic\", true)\n-                                                                .build())\n-                                                        .put(\"double\", map()\n-                                                                .put(\"type\", \"object\")\n-                                                                .put(\"dynamic\", true)\n-                                                                .build())\n-                                                        .put(\"boolean\", map()\n-                                                                .put(\"type\", \"object\")\n-                                                                .put(\"dynamic\", true)\n-                                                                .build())\n-                                                        .put(\"ip\", map()\n-                                                                .put(\"type\", \"object\")\n-                                                                .put(\"dynamic\", true)\n-                                                                .build())\n-                                                        .build())\n-                                                .build())\n-                                         */\n-                                        .put(\"triggered_jobs\", map()\n-                                                .put(\"type\", \"keyword\")\n-                                                .build())\n-                                        .build())\n-                                .build())\n-                        .build())\n+                .put(IndexMapping.TYPE_MESSAGE, super.buildMappings()) // TODO: Type name is \"message\" because the index field type poller is using that", "originalCommit": "29d96de148ea84d7da4e7c006f3ac4b183ab6886", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4MjI0Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8632#discussion_r464282243", "bodyText": "What is the actual todo item here?\n\nI don't know. That comment was there before, so I left it in.", "author": "alex-konn", "createdAt": "2020-08-03T08:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI1MzE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAxMjQ3MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8632#discussion_r465012470", "bodyText": "I guess we should remove it then.", "author": "dennisoelkers", "createdAt": "2020-08-04T12:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI1MzE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTExNzE1MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8632#discussion_r465117150", "bodyText": "Fair enough. Will do.", "author": "alex-konn", "createdAt": "2020-08-04T15:00:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI1MzE5Mw=="}], "type": "inlineReview"}, {"oid": "e95c143c812aea99fe3ba717b2e3d196b30bb547", "url": "https://github.com/Graylog2/graylog2-server/commit/e95c143c812aea99fe3ba717b2e3d196b30bb547", "message": "Removed old TODO comment", "committedDate": "2020-08-06T10:42:45Z", "type": "forcePushed"}, {"oid": "b5171c949fb5bba2a2a6922a14cb5cacb5066511", "url": "https://github.com/Graylog2/graylog2-server/commit/b5171c949fb5bba2a2a6922a14cb5cacb5066511", "message": "Parameterize unsupported version tests in IndexMappingFactoryTest", "committedDate": "2020-08-06T10:50:31Z", "type": "commit"}, {"oid": "805f979b8360d87a784987b40c3d867247ce8ad7", "url": "https://github.com/Graylog2/graylog2-server/commit/805f979b8360d87a784987b40c3d867247ce8ad7", "message": "Add tests for ES7 to IndexMappingFactoryTest", "committedDate": "2020-08-06T10:50:32Z", "type": "commit"}, {"oid": "92fbd7fef5c801b672637ea574c7ca33e4e82157", "url": "https://github.com/Graylog2/graylog2-server/commit/92fbd7fef5c801b672637ea574c7ca33e4e82157", "message": "Convert EventsIndexMappingTest to JUnit 5", "committedDate": "2020-08-06T10:50:32Z", "type": "commit"}, {"oid": "031d23ed11121e67a6df638683ed3dea5a83f67d", "url": "https://github.com/Graylog2/graylog2-server/commit/031d23ed11121e67a6df638683ed3dea5a83f67d", "message": "Parameterize tests in EventsIndexMappingTest", "committedDate": "2020-08-06T10:50:33Z", "type": "commit"}, {"oid": "964e99d2b79d75e424d6ab6bd0469315a382eaaf", "url": "https://github.com/Graylog2/graylog2-server/commit/964e99d2b79d75e424d6ab6bd0469315a382eaaf", "message": "Include ES7 in EventsIndexMappingTest#createsValidMappingTemplates", "committedDate": "2020-08-06T10:50:33Z", "type": "commit"}, {"oid": "09df73841164c6ccaaf5b311a6b28d006e3242f0", "url": "https://github.com/Graylog2/graylog2-server/commit/09df73841164c6ccaaf5b311a6b28d006e3242f0", "message": "Extract base class EventsIndexMapping\n\nThe mapping is the same except for the \"message\" key that's only necessary for ES6", "committedDate": "2020-08-06T10:51:00Z", "type": "commit"}, {"oid": "6961f0378eaeacf269f518472366336c1fbbdf63", "url": "https://github.com/Graylog2/graylog2-server/commit/6961f0378eaeacf269f518472366336c1fbbdf63", "message": "Added IndexMapping7Test", "committedDate": "2020-08-06T10:51:00Z", "type": "commit"}, {"oid": "efc8ba39c6acd85c57fda179c15cbfe10f9aa1ec", "url": "https://github.com/Graylog2/graylog2-server/commit/efc8ba39c6acd85c57fda179c15cbfe10f9aa1ec", "message": "Move tests for unsupported ES version for event mappings\n\nThe tests are equivalent to those for message mappings which were already present in IndexMappingFactoryTest.", "committedDate": "2020-08-06T10:51:00Z", "type": "commit"}, {"oid": "71e25d4844cd214b1da39d5af4481b32436c5057", "url": "https://github.com/Graylog2/graylog2-server/commit/71e25d4844cd214b1da39d5af4481b32436c5057", "message": "Consolidated index mapping tests in one class\n\n- Added IndexMappingTest\n- Consolidated tests from IndexMapping5Test, IndexMapping6Test and IndexMapping7Test into one parameterized test in IndexMappingTest.\n- Deleted IndexMappingTestBase and moved contents into IndexMappingTest\n\nThis has the added benefit of being more similar to equivalent tests in EventsIndexMappingTest. The difference of using fixture files for the message mapping tests was left in place. It makes sense to use fixtures here, because the mappings are somewhat more complicated than those for events.", "committedDate": "2020-08-06T10:51:01Z", "type": "commit"}, {"oid": "537745822581d9bbd76b851624a0de5e1c44fa21", "url": "https://github.com/Graylog2/graylog2-server/commit/537745822581d9bbd76b851624a0de5e1c44fa21", "message": "Use explicit LOCALE in String#format call", "committedDate": "2020-08-06T10:51:01Z", "type": "commit"}, {"oid": "22fd89334fb8476b4346f1a4af4fbe64ad1a5e96", "url": "https://github.com/Graylog2/graylog2-server/commit/22fd89334fb8476b4346f1a4af4fbe64ad1a5e96", "message": "Removed old TODO comment", "committedDate": "2020-08-06T10:51:01Z", "type": "commit"}, {"oid": "9e36471fad4b4a97112a5db61b67fc5c4c27cf12", "url": "https://github.com/Graylog2/graylog2-server/commit/9e36471fad4b4a97112a5db61b67fc5c4c27cf12", "message": "Added field alias to EventsIndexMapping7", "committedDate": "2020-08-06T11:14:58Z", "type": "commit"}, {"oid": "9e36471fad4b4a97112a5db61b67fc5c4c27cf12", "url": "https://github.com/Graylog2/graylog2-server/commit/9e36471fad4b4a97112a5db61b67fc5c4c27cf12", "message": "Added field alias to EventsIndexMapping7", "committedDate": "2020-08-06T11:14:58Z", "type": "forcePushed"}]}