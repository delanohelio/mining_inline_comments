{"pr_number": 9836, "pr_title": "Use plotlys colorscales for Heatmap Aggregation", "pr_createdAt": "2020-12-21T09:27:30Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9836", "timeline": [{"oid": "03476022d2f22a2ba75ee0a36e3d15b3c3b5abc1", "url": "https://github.com/Graylog2/graylog2-server/commit/03476022d2f22a2ba75ee0a36e3d15b3c3b5abc1", "message": "Add HeatmapVisualizationConfig", "committedDate": "2020-12-17T10:23:37Z", "type": "commit"}, {"oid": "e2677f2de2e1c92656b9e00b7b421cbeab96dfd3", "url": "https://github.com/Graylog2/graylog2-server/commit/e2677f2de2e1c92656b9e00b7b421cbeab96dfd3", "message": "Add HeatMapVisualizationConfiguration component", "committedDate": "2020-12-17T10:34:28Z", "type": "commit"}, {"oid": "6016e0e1cfa3af1c66094a60a7d989d9894a5635", "url": "https://github.com/Graylog2/graylog2-server/commit/6016e0e1cfa3af1c66094a60a7d989d9894a5635", "message": "Use VisualizationConfig in Component", "committedDate": "2020-12-17T10:47:32Z", "type": "commit"}, {"oid": "d6c8a0a0fab2e2d03820bf6d489f97cfd9df3a21", "url": "https://github.com/Graylog2/graylog2-server/commit/d6c8a0a0fab2e2d03820bf6d489f97cfd9df3a21", "message": "Add reverseScale config options", "committedDate": "2020-12-17T11:00:43Z", "type": "commit"}, {"oid": "0100b7f1b35f9b20b06d04d257d5ace436dc3000", "url": "https://github.com/Graylog2/graylog2-server/commit/0100b7f1b35f9b20b06d04d257d5ace436dc3000", "message": "Add useful config options", "committedDate": "2020-12-17T13:21:31Z", "type": "commit"}, {"oid": "50e85fe9a208fed9aa710ea28358358a40c58961", "url": "https://github.com/Graylog2/graylog2-server/commit/50e85fe9a208fed9aa710ea28358358a40c58961", "message": "xxx", "committedDate": "2020-12-17T15:25:46Z", "type": "commit"}, {"oid": "5e0e67b8808a1a11f4ca7a64a665b4ca399162ad", "url": "https://github.com/Graylog2/graylog2-server/commit/5e0e67b8808a1a11f4ca7a64a665b4ca399162ad", "message": "Create HeatmapVisualizationConfig for the Backend", "committedDate": "2020-12-18T11:03:49Z", "type": "commit"}, {"oid": "cc8127b5129197b792687cc68e8409d6c7822ee9", "url": "https://github.com/Graylog2/graylog2-server/commit/cc8127b5129197b792687cc68e8409d6c7822ee9", "message": "Validation to color scheme", "committedDate": "2020-12-18T14:26:44Z", "type": "commit"}, {"oid": "a3c3c297588788900c57b53801bab8bf3d83abc5", "url": "https://github.com/Graylog2/graylog2-server/commit/a3c3c297588788900c57b53801bab8bf3d83abc5", "message": "Adapting failing test", "committedDate": "2020-12-21T09:12:14Z", "type": "commit"}, {"oid": "b02a9c21bcb9612cbd222d0cf3ee122d416dfaf5", "url": "https://github.com/Graylog2/graylog2-server/commit/b02a9c21bcb9612cbd222d0cf3ee122d416dfaf5", "message": "Fix linter warnings", "committedDate": "2020-12-21T09:14:27Z", "type": "commit"}, {"oid": "ef13f9e6c0ef04d14865130be18b54d503cf9ac0", "url": "https://github.com/Graylog2/graylog2-server/commit/ef13f9e6c0ef04d14865130be18b54d503cf9ac0", "message": "Make possible to auto set the default value to the smallest value", "committedDate": "2020-12-21T10:07:51Z", "type": "commit"}, {"oid": "347dcc3e2cf8820263e4bfd2c6787f6f83a8a467", "url": "https://github.com/Graylog2/graylog2-server/commit/347dcc3e2cf8820263e4bfd2c6787f6f83a8a467", "message": "Add useSmallestAsDefault to backend", "committedDate": "2020-12-21T10:17:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5NjA0NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9836#discussion_r550196044", "bodyText": "We could clean this up a bit by introducing something like this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              const _onColorScaleChange = useCallback(({ value }) => onChange(config.toBuilder().colorScale(value).build()), [config, onChange]);\n          \n          \n            \n              const modifyConfig = useCallback((fn: (builder: HeatmapVisualizationConfigBuilder) => HeatmapVisualizationConfigBuilder) => {\n          \n          \n            \n                onChange(fn(config.toBuilder()).build());\n          \n          \n            \n              }, [onChange, config]);\n          \n          \n            \n              const _onColorScaleChange = useCallback(({ value }) => modifyConfig((builder) => builder.colorScale(value)), [modifyConfig]);\n          \n      \n    \n    \n  \n\nThe next five callbacks could then reuse modifyConfig as well. It would require exporting the type from the Builder class in HeatmapVisualizationConfig as HeatmapVisualizationConfigBuilder though.", "author": "dennisoelkers", "createdAt": "2020-12-30T13:31:57Z", "path": "graylog2-web-interface/src/views/components/aggregationbuilder/HeatmapVisualizationConfiguration.tsx", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+import React, { useCallback, useState } from 'react';\n+import styled from 'styled-components';\n+\n+import { Checkbox } from 'components/graylog';\n+import { Input } from 'components/bootstrap';\n+import HeatmapVisualizationConfig, { COLORSCALES } from 'views/logic/aggregationbuilder/visualizations/HeatmapVisualizationConfig';\n+\n+import Select from '../Select';\n+\n+const StyledInput = styled(Input)`\n+  > label {\n+    font-weight: normal;\n+  }\n+`;\n+\n+type Props = {\n+  onChange: (config: HeatmapVisualizationConfig) => void,\n+  config: HeatmapVisualizationConfig,\n+};\n+\n+const _makeOption = (value) => ({ label: value, value });\n+const colorScalesOptions = COLORSCALES.map(_makeOption);\n+\n+type Error = {\n+  zmin?: string,\n+  zmax?: string,\n+  defaultValue?: string,\n+}\n+\n+const _validateConfig = (config: HeatmapVisualizationConfig, setErrors): boolean => {\n+  const { zMax, zMin, defaultValue } = config;\n+  const errors = {} as Error;\n+\n+  if (zMin || zMax) {\n+    if (zMin >= zMax) {\n+      errors.zmin = 'Min is bigger than Max';\n+    }\n+\n+    if (zMax <= zMin) {\n+      errors.zmin = 'Max is smaller than Min';\n+    }\n+\n+    if (defaultValue) {\n+      if (defaultValue > zMax || defaultValue < zMin) {\n+        errors.defaultValue = 'Default Value is out of range from Min and Max';\n+      }\n+    }\n+  }\n+\n+  setErrors(errors);\n+\n+  return Object.keys(errors).length <= 0;\n+};\n+\n+const _parseEvent = (event) => {\n+  const { value } = event.target;\n+\n+  if (value === undefined) {\n+    return undefined;\n+  }\n+\n+  return parseFloat(value);\n+};\n+\n+const HeatmapVisualizationConfiguration = ({ config = HeatmapVisualizationConfig.empty(), onChange: onChangeFunc }: Props) => {\n+  const [errors, setErrors] = useState<Error>({});\n+  const onChange = useCallback((newConfig) => {\n+    if (_validateConfig(newConfig, setErrors)) {\n+      onChangeFunc(newConfig);\n+    }\n+  }, [onChangeFunc]);\n+  const _onColorScaleChange = useCallback(({ value }) => onChange(config.toBuilder().colorScale(value).build()), [config, onChange]);", "originalCommit": "347dcc3e2cf8820263e4bfd2c6787f6f83a8a467", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5NjQyNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9836#discussion_r550196426", "bodyText": "Why is this commented out?", "author": "dennisoelkers", "createdAt": "2020-12-30T13:33:17Z", "path": "graylog2-web-interface/src/views/components/visualizations/heatmap/HeatmapVisualization.tsx", "diffHunk": "@@ -134,7 +120,7 @@ const _chartLayout = (heatmapData) => {\n   return {\n     yaxis: axisConfig,\n     xaxis: axisConfig,\n-    plot_bgcolor: hasContent ? BG_COLOR : 'transparent',\n+    // plot_bgcolor: hasContent ? BG_COLOR : 'transparent',", "originalCommit": "347dcc3e2cf8820263e4bfd2c6787f6f83a8a467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE3Njk5Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/9836#discussion_r551176996", "bodyText": "It must be deleted, we can't set the BG_COLOR anymore, since we do not have it, with the themes.", "author": "kmerz", "createdAt": "2021-01-04T08:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5NjQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5NjU2MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9836#discussion_r550196560", "bodyText": "This could use some braces to make the operator precedence clearer.", "author": "dennisoelkers", "createdAt": "2020-12-30T13:33:46Z", "path": "graylog2-web-interface/src/views/components/visualizations/heatmap/HeatmapVisualization.tsx", "diffHunk": "@@ -98,11 +78,17 @@ const _transposeMatrix = (z: Array<Array<any>> = []) => {\n   return z[0].map((_, c) => { return z.map((r) => { return r[c]; }); });\n };\n \n-const _formatSeries = ({ valuesBySeries, xLabels }: {valuesBySeries: ValuesBySeries, xLabels: Array<any>}): ExtractedSeries => {\n+const _findSmallestValue = (valuesFound: Array<Array<number>>) => valuesFound.reduce((result, valueArray) => valueArray.reduce((acc, value) => (acc > value ? value : acc), result), valuesFound[0][0]);\n+\n+const _formatSeries = (visualizationConfig) => ({ valuesBySeries, xLabels }: {valuesBySeries: ValuesBySeries, xLabels: Array<any>}): ExtractedSeries => {\n+  const valuesFoundBySeries = values(valuesBySeries);\n   // When using the hovertemplate, we need to provie a value for empty z values.\n   // Otherwise plotly would throw errors when hovering over a field.\n   // We need to transpose the z matrix, because we are changing the x and y label in the generator function\n-  const z = _transposeMatrix(_fillUpMatrix(values(valuesBySeries), xLabels));\n+  const defaultValue = visualizationConfig.useSmallestAsDefault\n+    ? _findSmallestValue(valuesFoundBySeries)\n+    : visualizationConfig.defaultValue ?? 'None';", "originalCommit": "347dcc3e2cf8820263e4bfd2c6787f6f83a8a467", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE5OTAwMQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9836#discussion_r550199001", "bodyText": "To avoid duplicating all values in the type, we can do:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            export const COLORSCALES = ['Greys', 'YlGnBu', 'Greens', 'YlOrRd', 'Bluered', 'RdBu', 'Reds', 'Blues', 'Picnic', 'Rainbow', 'Portland', 'Jet', 'Hot', 'Blackbody', 'Earth', 'Electric', 'Viridis', 'Cividis'];\n          \n          \n            \n            export const COLORSCALES = ['Greys', 'YlGnBu', 'Greens', 'YlOrRd', 'Bluered', 'RdBu', 'Reds', 'Blues', 'Picnic', 'Rainbow', 'Portland', 'Jet', 'Hot', 'Blackbody', 'Earth', 'Electric', 'Viridis', 'Cividis'];\n          \n          \n            \n            \n          \n          \n            \n            type ColorScale = typeof COLORSCALES[number];", "author": "dennisoelkers", "createdAt": "2020-12-30T13:42:17Z", "path": "graylog2-web-interface/src/views/logic/aggregationbuilder/visualizations/HeatmapVisualizationConfig.ts", "diffHunk": "@@ -0,0 +1,248 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+import * as Immutable from 'immutable';\n+\n+import VisualizationConfig from 'views/logic/aggregationbuilder/visualizations/VisualizationConfig';\n+\n+type ColorScale =\n+    'Greys'\n+  | 'YlGnBu'\n+  | 'Greens'\n+  | 'YlOrRd'\n+  | 'Bluered'\n+  | 'RdBu'\n+  | 'Reds'\n+  | 'Blues'\n+  | 'Picnic'\n+  | 'Rainbow'\n+  | 'Portland'\n+  | 'Jet'\n+  | 'Hot'\n+  | 'Blackbody'\n+  | 'Earth'\n+  | 'Electric'\n+  | 'Viridis'\n+  | 'Cividis';\n+\n+export const COLORSCALES = ['Greys', 'YlGnBu', 'Greens', 'YlOrRd', 'Bluered', 'RdBu', 'Reds', 'Blues', 'Picnic', 'Rainbow', 'Portland', 'Jet', 'Hot', 'Blackbody', 'Earth', 'Electric', 'Viridis', 'Cividis'];", "originalCommit": "347dcc3e2cf8820263e4bfd2c6787f6f83a8a467", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6fbf8a70fe0cf69e5d0edaf20a49932239389500", "url": "https://github.com/Graylog2/graylog2-server/commit/6fbf8a70fe0cf69e5d0edaf20a49932239389500", "message": "Recommendations and fixes from @dennisoelkers", "committedDate": "2021-01-04T08:51:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk0OTEyOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9836#discussion_r551949129", "bodyText": "Can we add isClearable={false} here? IMO it does not make sense to show the clear icon in here.", "author": "dennisoelkers", "createdAt": "2021-01-05T14:01:09Z", "path": "graylog2-web-interface/src/views/components/aggregationbuilder/HeatmapVisualizationConfiguration.tsx", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+import React, { useCallback, useState } from 'react';\n+import styled from 'styled-components';\n+\n+import { Checkbox } from 'components/graylog';\n+import { Input } from 'components/bootstrap';\n+import HeatmapVisualizationConfig, { COLORSCALES, Builder as HeatmapConfigBuilder } from 'views/logic/aggregationbuilder/visualizations/HeatmapVisualizationConfig';\n+\n+import Select from '../Select';\n+\n+const StyledInput = styled(Input)`\n+  > label {\n+    font-weight: normal;\n+  }\n+`;\n+\n+type Props = {\n+  onChange: (config: HeatmapVisualizationConfig) => void,\n+  config: HeatmapVisualizationConfig,\n+};\n+\n+const _makeOption = (value) => ({ label: value, value });\n+const colorScalesOptions = COLORSCALES.map(_makeOption);\n+\n+type Error = {\n+  zmin?: string,\n+  zmax?: string,\n+  defaultValue?: string,\n+}\n+\n+const _validateConfig = (config: HeatmapVisualizationConfig, setErrors): boolean => {\n+  const { zMax, zMin, defaultValue } = config;\n+  const errors = {} as Error;\n+\n+  if (zMin || zMax) {\n+    if (zMin >= zMax) {\n+      errors.zmin = 'Min is bigger than Max';\n+    }\n+\n+    if (zMax <= zMin) {\n+      errors.zmin = 'Max is smaller than Min';\n+    }\n+\n+    if (defaultValue) {\n+      if (defaultValue > zMax || defaultValue < zMin) {\n+        errors.defaultValue = 'Default Value is out of range from Min and Max';\n+      }\n+    }\n+  }\n+\n+  setErrors(errors);\n+\n+  return Object.keys(errors).length <= 0;\n+};\n+\n+const _parseEvent = (event) => {\n+  const { value } = event.target;\n+\n+  if (value === undefined) {\n+    return undefined;\n+  }\n+\n+  return parseFloat(value);\n+};\n+\n+const HeatmapVisualizationConfiguration = ({ config = HeatmapVisualizationConfig.empty(), onChange: onChangeFunc }: Props) => {\n+  const [errors, setErrors] = useState<Error>({});\n+  const onChange = useCallback((newConfig) => {\n+    if (_validateConfig(newConfig, setErrors)) {\n+      onChangeFunc(newConfig);\n+    }\n+  }, [onChangeFunc]);\n+  const modifyConfig = useCallback((fn: (HeatmapConfigBuilder) => HeatmapConfigBuilder) => {\n+    onChange(fn(config.toBuilder()).build());\n+  }, [config, onChange]);\n+\n+  const _onColorScaleChange = useCallback(({ value }) => modifyConfig((builder: HeatmapConfigBuilder) => builder.colorScale(value)), [modifyConfig]);\n+  const _onReverseScaleChange = useCallback((e) => modifyConfig((builder: HeatmapConfigBuilder) => builder.reverseScale(e.target.checked)), [modifyConfig]);\n+  const _onAutoScaleChange = useCallback((e) => modifyConfig((builder: HeatmapConfigBuilder) => builder.autoScale(e.target.checked)), [modifyConfig]);\n+  const _onZminChange = useCallback((e) => modifyConfig((builder: HeatmapConfigBuilder) => builder.zMin(_parseEvent(e))), [modifyConfig]);\n+  const _onZmaxChange = useCallback((e) => modifyConfig((builder: HeatmapConfigBuilder) => builder.zMax(_parseEvent(e))), [modifyConfig]);\n+  const _onUseSmallestAsDefaultChange = useCallback((e) => modifyConfig((builder: HeatmapConfigBuilder) => builder.useSmallestAsDefault(e.target.checked)), [modifyConfig]);\n+  const _onDefaultValueChange = useCallback((e) => modifyConfig((builder: HeatmapConfigBuilder) => builder.defaultValue(_parseEvent(e))), [modifyConfig]);\n+\n+  return (\n+    <>\n+      <span>Color Scheme</span>\n+      <Select placeholder=\"Select Color Scheme\"\n+              onChange={_onColorScaleChange}\n+              options={colorScalesOptions}", "originalCommit": "6fbf8a70fe0cf69e5d0edaf20a49932239389500", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7ce2e31e3b9dba9d8eccccbd6dc21e20ec5efce", "url": "https://github.com/Graylog2/graylog2-server/commit/a7ce2e31e3b9dba9d8eccccbd6dc21e20ec5efce", "message": "Add isClearable=false", "committedDate": "2021-01-05T16:24:44Z", "type": "commit"}]}