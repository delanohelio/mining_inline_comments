{"pr_number": 9278, "pr_title": "HTTP header authentication realm", "pr_createdAt": "2020-10-26T15:45:02Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9278", "timeline": [{"oid": "c711cf32df1981b33301fe7760ce8c1c810013a3", "url": "https://github.com/Graylog2/graylog2-server/commit/c711cf32df1981b33301fe7760ce8c1c810013a3", "message": "Adjust naming on authenticators pages", "committedDate": "2020-11-03T15:34:07Z", "type": "forcePushed"}, {"oid": "b5980dc024fdf1a9987e19178af08bb9f48cd409", "url": "https://github.com/Graylog2/graylog2-server/commit/b5980dc024fdf1a9987e19178af08bb9f48cd409", "message": "Start HTTP header authentication realm", "committedDate": "2020-11-03T16:26:32Z", "type": "commit"}, {"oid": "fa58510ecdd3d76d8ec982f44335818c613e78fc", "url": "https://github.com/Graylog2/graylog2-server/commit/fa58510ecdd3d76d8ec982f44335818c613e78fc", "message": "Add comment", "committedDate": "2020-11-03T16:26:32Z", "type": "commit"}, {"oid": "318eb88c92d8abeab09dd99ca2c97307023a9aca", "url": "https://github.com/Graylog2/graylog2-server/commit/318eb88c92d8abeab09dd99ca2c97307023a9aca", "message": "Fix forbidden apis error", "committedDate": "2020-11-03T16:26:32Z", "type": "commit"}, {"oid": "1bdbd71c7636aea0c6c46fe5b1e6fea05b1d4b57", "url": "https://github.com/Graylog2/graylog2-server/commit/1bdbd71c7636aea0c6c46fe5b1e6fea05b1d4b57", "message": "Add HTTP endpoint to manage the HTTP header auth config", "committedDate": "2020-11-03T16:26:32Z", "type": "commit"}, {"oid": "149d914ba5ab523f0e2dbccaf810f1e3c165458e", "url": "https://github.com/Graylog2/graylog2-server/commit/149d914ba5ab523f0e2dbccaf810f1e3c165458e", "message": "Create value class for HTTPHeaderAuthConfig", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "2a31ad4d4e9ed7f09379da4f627b6ac4b932779b", "url": "https://github.com/Graylog2/graylog2-server/commit/2a31ad4d4e9ed7f09379da4f627b6ac4b932779b", "message": "Create HTTPHeaderAuthConfigStore, HTTPHeaderAuthConfigActions and HTTPHeaderAuthConfig api routes", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "1c97be9b99f8458827b35960255729df6d9c5026", "url": "https://github.com/Graylog2/graylog2-server/commit/1c97be9b99f8458827b35960255729df6d9c5026", "message": "Create HTTPHeaderAuthConfigDomain", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "d6dbaa3dc1c7927e503155d699b0c5fc5916d150", "url": "https://github.com/Graylog2/graylog2-server/commit/d6dbaa3dc1c7927e503155d699b0c5fc5916d150", "message": "Create authenticator pages", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "b85b193da59b9a7343f2b8d99d50007944a199f6", "url": "https://github.com/Graylog2/graylog2-server/commit/b85b193da59b9a7343f2b8d99d50007944a199f6", "message": "Rename BackendOverviewLink to AuthenticationOverviewLinks", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "ac75ca92fe896d62c85e5b66e33e58c52e3aa38d", "url": "https://github.com/Graylog2/graylog2-server/commit/ac75ca92fe896d62c85e5b66e33e58c52e3aa38d", "message": "Add missing audit event information", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "497f21b75ada167e10d6c0eb275dcfc04f7ac70b", "url": "https://github.com/Graylog2/graylog2-server/commit/497f21b75ada167e10d6c0eb275dcfc04f7ac70b", "message": "Create HTTP header auth config update form", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "48e01efdd628aa6a50214d64dfcc62a9a9f18488", "url": "https://github.com/Graylog2/graylog2-server/commit/48e01efdd628aa6a50214d64dfcc62a9a9f18488", "message": "Create HTTP header auth config details component", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "df630cde262f4ae9fcb95ba613572fee828a48a2", "url": "https://github.com/Graylog2/graylog2-server/commit/df630cde262f4ae9fcb95ba613572fee828a48a2", "message": "Add tests for HTTPHeaderAuthConfigSections", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "b823828efc4784e4d807f604f05317798485d07d", "url": "https://github.com/Graylog2/graylog2-server/commit/b823828efc4784e4d807f604f05317798485d07d", "message": "Redirect to authenticator details page after updating authenticator", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "810e2076d29fe0aa617251ea4125109a6f05a31a", "url": "https://github.com/Graylog2/graylog2-server/commit/810e2076d29fe0aa617251ea4125109a6f05a31a", "message": "Fix linter warnings", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "929e2145bc1895c575db85bfdee6bc97e3c1aced", "url": "https://github.com/Graylog2/graylog2-server/commit/929e2145bc1895c575db85bfdee6bc97e3c1aced", "message": "Adjust naming on authenticators pages", "committedDate": "2020-11-03T16:26:33Z", "type": "commit"}, {"oid": "929e2145bc1895c575db85bfdee6bc97e3c1aced", "url": "https://github.com/Graylog2/graylog2-server/commit/929e2145bc1895c575db85bfdee6bc97e3c1aced", "message": "Adjust naming on authenticators pages", "committedDate": "2020-11-03T16:26:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQxMjE4Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9278#discussion_r517412187", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.warn(\"Request with trusted HTTP header <{}={}> received from <{}> which is not in the trusted subnets: {}\",\n          \n          \n            \n                        LOG.warn(\"Request with trusted HTTP header <{}={}> received from <{}> which is not in the trusted proxies: <{}>\",", "author": "mpfz0r", "createdAt": "2020-11-04T15:07:28Z", "path": "graylog2-server/src/main/java/org/graylog2/security/realm/HTTPHeaderAuthenticationRealm.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.security.realm;\n+\n+import com.google.common.base.Joiner;\n+import org.apache.shiro.authc.AuthenticationException;\n+import org.apache.shiro.authc.AuthenticationInfo;\n+import org.apache.shiro.authc.AuthenticationToken;\n+import org.apache.shiro.authc.SimpleAccount;\n+import org.apache.shiro.authc.credential.AllowAllCredentialsMatcher;\n+import org.apache.shiro.realm.AuthenticatingRealm;\n+import org.graylog.security.authservice.AuthServiceAuthenticator;\n+import org.graylog.security.authservice.AuthServiceCredentials;\n+import org.graylog.security.authservice.AuthServiceException;\n+import org.graylog.security.authservice.AuthServiceResult;\n+import org.graylog2.plugin.cluster.ClusterConfigService;\n+import org.graylog2.security.headerauth.HTTPHeaderAuthConfig;\n+import org.graylog2.shared.security.HttpHeadersToken;\n+import org.graylog2.utilities.IpSubnet;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.ws.rs.core.MultivaluedMap;\n+import java.net.UnknownHostException;\n+import java.util.Locale;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static org.apache.commons.lang3.StringUtils.isBlank;\n+\n+public class HTTPHeaderAuthenticationRealm extends AuthenticatingRealm {\n+    private static final Logger LOG = LoggerFactory.getLogger(HTTPHeaderAuthenticationRealm.class);\n+    private static final Joiner JOINER = Joiner.on(\", \");\n+\n+    public static final String NAME = \"http-header-authentication\";\n+\n+    private final ClusterConfigService clusterConfigService;\n+    private final AuthServiceAuthenticator authServiceAuthenticator;\n+    private final Set<IpSubnet> trustedProxies;\n+\n+    @Inject\n+    public HTTPHeaderAuthenticationRealm(ClusterConfigService clusterConfigService,\n+                                         AuthServiceAuthenticator authServiceAuthenticator,\n+                                         @Named(\"trusted_proxies\") Set<IpSubnet> trustedProxies) {\n+        this.clusterConfigService = clusterConfigService;\n+        this.authServiceAuthenticator = authServiceAuthenticator;\n+        this.trustedProxies = trustedProxies;\n+\n+        setAuthenticationTokenClass(HttpHeadersToken.class);\n+        setCachingEnabled(false);\n+        // Credentials will be matched via the authentication service itself so we don't need Shiro to do it\n+        setCredentialsMatcher(new AllowAllCredentialsMatcher());\n+    }\n+\n+    @Override\n+    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {\n+        final HttpHeadersToken headersToken = (HttpHeadersToken) token;\n+        final HTTPHeaderAuthConfig config = loadConfig();\n+\n+        if (!config.enabled()) {\n+            LOG.debug(\"Skipping disabled HTTP header authentication\");\n+            return null;\n+        }\n+\n+        final MultivaluedMap<String, String> headers = headersToken.getHeaders();\n+        final Optional<String> optionalUsername = headerValue(headers, config.usernameHeader());\n+\n+        if (optionalUsername.isPresent()) {\n+            final String username = optionalUsername.get().trim();\n+\n+            if (isBlank(username)) {\n+                LOG.warn(\"Skipping request with trusted HTTP header <{}> and blank value\", config.usernameHeader());\n+                return null;\n+            }\n+\n+            if (inTrustedSubnets(headersToken.getRemoteAddr())) {\n+                return doAuthenticate(username);\n+            }\n+\n+            LOG.warn(\"Request with trusted HTTP header <{}={}> received from <{}> which is not in the trusted subnets: {}\",", "originalCommit": "929e2145bc1895c575db85bfdee6bc97e3c1aced", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "745c59d311fc4ad8d6369041ea35603fc0e6e10d", "url": "https://github.com/Graylog2/graylog2-server/commit/745c59d311fc4ad8d6369041ea35603fc0e6e10d", "message": "Don't try already authorized users on ADAuthServiceBackend", "committedDate": "2020-11-04T15:28:07Z", "type": "commit"}, {"oid": "0666bfb0ceb5a3940890846d56261a4c46a1a807", "url": "https://github.com/Graylog2/graylog2-server/commit/0666bfb0ceb5a3940890846d56261a4c46a1a807", "message": "Update graylog2-server/src/main/java/org/graylog2/security/realm/HTTPHeaderAuthenticationRealm.java", "committedDate": "2020-11-04T16:29:32Z", "type": "commit"}, {"oid": "f5f35902a5ccc847ca1d89ee7644aaebe2423d11", "url": "https://github.com/Graylog2/graylog2-server/commit/f5f35902a5ccc847ca1d89ee7644aaebe2423d11", "message": "Merge remote-tracking branch 'origin/master' into feature/http-header-authentication", "committedDate": "2020-11-04T17:33:22Z", "type": "commit"}, {"oid": "eb4216764c92be0dd3c999ecb8529a19789b473e", "url": "https://github.com/Graylog2/graylog2-server/commit/eb4216764c92be0dd3c999ecb8529a19789b473e", "message": "Explicitly mention that headers are matched case-insensitive", "committedDate": "2020-11-04T17:39:52Z", "type": "commit"}, {"oid": "2b785327fc00aee31777779196a05365ef1bf8e4", "url": "https://github.com/Graylog2/graylog2-server/commit/2b785327fc00aee31777779196a05365ef1bf8e4", "message": "Improve login failure log message", "committedDate": "2020-11-04T17:40:40Z", "type": "commit"}, {"oid": "ccd68da09b9584dc6b6d6d89cbdf48521e425799", "url": "https://github.com/Graylog2/graylog2-server/commit/ccd68da09b9584dc6b6d6d89cbdf48521e425799", "message": "Merge remote-tracking branch 'origin/feature/http-header-authentication' into feature/http-header-authentication", "committedDate": "2020-11-04T17:48:27Z", "type": "commit"}]}