{"pr_number": 7140, "pr_title": "Convert week/month bucket interval to days if value is bigger than 1.", "pr_createdAt": "2020-01-10T10:25:26Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7140", "timeline": [{"oid": "2fb0f5037fb22e378f65362c6871ace9e952434c", "url": "https://github.com/Graylog2/graylog2-server/commit/2fb0f5037fb22e378f65362c6871ace9e952434c", "message": "Convert week/month bucket interval to days if value is bigger than 1.\n\nDue to limitations in Elasticsearch, it does not support time unit\nbucket intervals with values bigger than 1 for units bigger than days.\nTherefore, this PR transparently converts these to days (with multiples\nof 7 resp. 30) if the value is bigger than 1, leaving the original unit\notherwise.\n\nIn contrast to the initial attempt in #7055, this PR is performing the\nchange in the backend, transparent to the caller and relieving the\ncaller from having to do the conversion before.\n\nFixes #7022.", "committedDate": "2020-01-10T10:22:01Z", "type": "commit"}, {"oid": "44f38fa4433cd5e12145c820f4b6db819fa3a09d", "url": "https://github.com/Graylog2/graylog2-server/commit/44f38fa4433cd5e12145c820f4b6db819fa3a09d", "message": "Adding license header.", "committedDate": "2020-01-10T10:26:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE4NzYzNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365187636", "bodyText": "What's the benefit of specifying a radix of 10 here explicitly? I would find it clearer, if we omitted it.", "author": "alex-konn", "createdAt": "2020-01-10T11:18:06Z", "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitInterval.java", "diffHunk": "@@ -24,21 +24,45 @@\n import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n @AutoValue\n @JsonTypeName(TimeUnitInterval.type)\n @JsonDeserialize(builder = TimeUnitInterval.Builder.class)\n public abstract class TimeUnitInterval implements Interval {\n     public static final String type = \"timeunit\";\n+    public static final Pattern TIMEUNIT_PATTERN = Pattern.compile(\"(?<quantity>\\\\d+)(?<unit>[smhdwM])\");\n \n     @JsonProperty\n     public abstract String type();\n \n     @JsonProperty\n     public abstract String timeunit();\n \n+    private String adjustUnitsLongerThanDays(String timeunit) {\n+        final Matcher matcher = TIMEUNIT_PATTERN.matcher(timeunit());\n+        checkArgument(matcher.matches(),\n+                \"Time unit must be {quantity}{unit}, where quantity is a positive number and unit [smhdwM].\");\n+        final int quantity = Integer.parseInt(matcher.group(\"quantity\"), 10);", "originalCommit": "44f38fa4433cd5e12145c820f4b6db819fa3a09d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIwMzYzNw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365203637", "bodyText": "No other reason besides being as explicit as possible. If it's too explicit, I will remove it :)", "author": "dennisoelkers", "createdAt": "2020-01-10T12:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE4NzYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE4OTM5MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365189391", "bodyText": "Can we move the method below toDateHistogramInterval where it's first used?", "author": "alex-konn", "createdAt": "2020-01-10T11:23:08Z", "path": "graylog2-server/src/main/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitInterval.java", "diffHunk": "@@ -24,21 +24,45 @@\n import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n \n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n @AutoValue\n @JsonTypeName(TimeUnitInterval.type)\n @JsonDeserialize(builder = TimeUnitInterval.Builder.class)\n public abstract class TimeUnitInterval implements Interval {\n     public static final String type = \"timeunit\";\n+    public static final Pattern TIMEUNIT_PATTERN = Pattern.compile(\"(?<quantity>\\\\d+)(?<unit>[smhdwM])\");\n \n     @JsonProperty\n     public abstract String type();\n \n     @JsonProperty\n     public abstract String timeunit();\n \n+    private String adjustUnitsLongerThanDays(String timeunit) {", "originalCommit": "44f38fa4433cd5e12145c820f4b6db819fa3a09d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MjA0Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365192043", "bodyText": "\ud83d\udc4d for validating the exception message! I usually put the message in a static field on the class and reference it in the test to avoid having it to change it in two places when the time comes.", "author": "alex-konn", "createdAt": "2020-01-10T11:30:00Z", "path": "graylog2-server/src/test/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitIntervalTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.search.searchtypes.pivot.buckets;\n+\n+import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n+import org.graylog2.plugin.indexer.searches.timeranges.InvalidRangeParametersException;\n+import org.graylog2.plugin.indexer.searches.timeranges.RelativeRange;\n+import org.junit.Test;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+\n+public class TimeUnitIntervalTest {\n+    private TimeUnitInterval.Builder builder() {\n+        return TimeUnitInterval.Builder.builder();\n+    }\n+\n+    @Test\n+    public void doesNotAllowInvalidTimeUnit() {\n+        assertThatExceptionOfType(RuntimeException.class)\n+                .isThrownBy(() -> builder().timeunit(\"foobar\").build())\n+                .withMessage(\"Time unit must be {quantity}{unit}, where quantity is a positive number and unit [smhdwM].\");", "originalCommit": "44f38fa4433cd5e12145c820f4b6db819fa3a09d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIwNDA4MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365204080", "bodyText": "I do understand that, but I usually prefer to have literals in tests, because it is harder for me to overlook mismatching expectations because I think I know what the variable is.", "author": "dennisoelkers", "createdAt": "2020-01-10T12:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MjA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MzI5OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365193299", "bodyText": "Nice and clean tests! I think they could be further improved by using parameterized tests. That would make them even more compact and facilitate adding more cases. Totally optional though. The tests are fine as they are now.", "author": "alex-konn", "createdAt": "2020-01-10T11:33:24Z", "path": "graylog2-server/src/test/java/org/graylog/plugins/views/search/searchtypes/pivot/buckets/TimeUnitIntervalTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.search.searchtypes.pivot.buckets;\n+\n+import org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramInterval;\n+import org.graylog2.plugin.indexer.searches.timeranges.InvalidRangeParametersException;\n+import org.graylog2.plugin.indexer.searches.timeranges.RelativeRange;\n+import org.junit.Test;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+", "originalCommit": "44f38fa4433cd5e12145c820f4b6db819fa3a09d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIwNTEzNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365205135", "bodyText": "I was also thinking about that, but I hesitated doing it, because afaik it requires all methods of a test class to be parameterized, so the test class would have to be split up into one for the validation tests and one for the valid inputs. I can still do it though, I just preferred to have a single test class right now, because it makes it easier to spot corner cases which are not covered.", "author": "dennisoelkers", "createdAt": "2020-01-10T12:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MzI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIwNjQ1Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365206452", "bodyText": "Well no, I can just wrap those in an inner class. Will do!", "author": "dennisoelkers", "createdAt": "2020-01-10T12:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MzI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIwODkyNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7140#discussion_r365208926", "bodyText": "Right. Forgot that we're on JUnit 4. JUnit 5 has much better support for parameterized tests. For the short term we should consider using https://github.com/Pragmatists/JUnitParams then.", "author": "alex-konn", "createdAt": "2020-01-10T12:20:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE5MzI5OQ=="}], "type": "inlineReview"}, {"oid": "710685b574b2a1cc78de6c5e8eb293c8c42c6107", "url": "https://github.com/Graylog2/graylog2-server/commit/710685b574b2a1cc78de6c5e8eb293c8c42c6107", "message": "Moving private method below its consumer.", "committedDate": "2020-01-10T12:10:24Z", "type": "commit"}, {"oid": "5c3bdaadbdbed24df2a3a59ce9e5840f32345a93", "url": "https://github.com/Graylog2/graylog2-server/commit/5c3bdaadbdbed24df2a3a59ce9e5840f32345a93", "message": "Removing optional radix parameter for clarity.", "committedDate": "2020-01-10T12:10:52Z", "type": "commit"}, {"oid": "52907def91e359d72a00cf79fd93b28d15bcc171", "url": "https://github.com/Graylog2/graylog2-server/commit/52907def91e359d72a00cf79fd93b28d15bcc171", "message": "Parameterizing tests, extracting message constant.", "committedDate": "2020-01-10T12:33:45Z", "type": "commit"}, {"oid": "c899fab0b2669b8b506a9066a47a99b149cd4d49", "url": "https://github.com/Graylog2/graylog2-server/commit/c899fab0b2669b8b506a9066a47a99b149cd4d49", "message": "Fixing license header.", "committedDate": "2020-01-10T12:46:16Z", "type": "commit"}]}