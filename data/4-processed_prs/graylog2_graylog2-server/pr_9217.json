{"pr_number": 9217, "pr_title": "Use user ID instead of username for user management API calls", "pr_createdAt": "2020-10-20T13:28:01Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9217", "timeline": [{"oid": "0edcfb1e2fa7a82a2d8f2169ba7348aaabd0d029", "url": "https://github.com/Graylog2/graylog2-server/commit/0edcfb1e2fa7a82a2d8f2169ba7348aaabd0d029", "message": "Change shares/user endpoint to userId as well", "committedDate": "2020-10-26T13:36:11Z", "type": "forcePushed"}, {"oid": "db678a8af8d785805dacd985608d929757d6e796", "url": "https://github.com/Graylog2/graylog2-server/commit/db678a8af8d785805dacd985608d929757d6e796", "message": "Change more user endpoints to userId", "committedDate": "2020-10-27T14:31:29Z", "type": "forcePushed"}, {"oid": "5e7a6bc92261d79de1f357cd85d664448283a77d", "url": "https://github.com/Graylog2/graylog2-server/commit/5e7a6bc92261d79de1f357cd85d664448283a77d", "message": "Use user id instead of username for api calls on user management pages", "committedDate": "2020-10-27T18:18:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI3NjI1Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513276253", "bodyText": "The endpoint is /users not /system/users.", "author": "bernd", "createdAt": "2020-10-28T08:59:03Z", "path": "UPGRADING.rst", "diffHunk": "@@ -11,6 +11,11 @@ Prior to v3.3.3, the certificates of LDAP servers which are connected to using a\n \n A `CVE <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15813>`_ is tracked for this issue.\n \n+Change of API endpoint for user retrieval and modification\n+==========================================================\n+\n+In 4.0 we changed most of the user API endpoint `/system/users` to expect user IDs instead of names.", "originalCommit": "ce2392be8ac6ae2f0fd4da225bd13ce3ebf66a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4NjM5OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513286399", "bodyText": "How about putting the handling code into a separate method so we don't duplicate the same code in get and getbyId? \ud83d\ude04", "author": "bernd", "createdAt": "2020-10-28T09:15:28Z", "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/users/UsersResource.java", "diffHunk": "@@ -173,6 +174,32 @@ public UserSummary get(@ApiParam(name = \"username\", value = \"The username to ret\n         return toUserResponse(user, isSelf || canEditUserPermissions, AllUserSessions.create(sessionService));\n     }\n \n+    @GET\n+    @Path(\"id/{userId}\")\n+    @ApiOperation(value = \"Get user details by userId\", notes = \"The user's permissions are only included if a user asks for his \" +\n+            \"own account or for users with the necessary permissions to edit permissions.\")\n+    @ApiResponses({\n+            @ApiResponse(code = 404, message = \"The user could not be found.\")\n+    })\n+    public UserSummary getbyId(@ApiParam(name = \"userId\", value = \"The userId to return information for.\", required = true)\n+                           @PathParam(\"userId\") String userId,\n+                           @Context UserContext userContext) {\n+\n+        final User user = loadUserById(userId);\n+        final String username = user.getName();\n+        // If a user has permissions to edit another user's profile, it should be able to see it.", "originalCommit": "96c5a5184ad294dc4dd4f09e535a20f5965c507a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MjQxMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513292413", "bodyText": "Why don't we delete users by ID and still use the username for that?", "author": "bernd", "createdAt": "2020-10-28T09:24:57Z", "path": "graylog2-web-interface/src/actions/users/UsersActions.js", "diffHunk": "@@ -40,13 +40,14 @@ export type PaginatedUsers = PaginatedList<UserOverview> & {\n \n export type ActionsType = {\n   create: (user: UserCreate) => Promise<void>,\n-  load: (username: string) => Promise<User>,\n-  update: (username: string, request: any) => Promise<void>,\n-  delete: (username: string) => Promise<void>,\n-  changePassword: (username: string, request: ChangePasswordRequest) => Promise<void>,\n-  createToken: (username: string, tokenName: string) => Promise<Token>,\n-  loadTokens: (username: string) => Promise<Token[]>,\n-  deleteToken: (username: string, tokenId: string, tokenName: string) => Promise<void>,\n+  load: (userId: string) => Promise<User>,\n+  loadByUsername: (username: string) => Promise<User>,\n+  update: (userId: string, request: any) => Promise<void>,\n+  delete: (username: string, fullName: string) => Promise<void>,", "originalCommit": "96c5a5184ad294dc4dd4f09e535a20f5965c507a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQxNDM0Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513414346", "bodyText": "I didn't want to touch the delete code, because that also needs changes to the UserService.delete() which has these weird functionality that allows to remove multiple users with the same name..", "author": "mpfz0r", "createdAt": "2020-10-28T12:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MjQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQyMTM0Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513421347", "bodyText": "@mpfz0r How about creating a UserService#deleteById method and a DELETE /users/id/<id> endpoint so we can leave the other code untouched?", "author": "bernd", "createdAt": "2020-10-28T12:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MjQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQyNDQ2OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513424468", "bodyText": "@bernd that I can do, of course", "author": "mpfz0r", "createdAt": "2020-10-28T13:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MjQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ0MjgzMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513442833", "bodyText": "ok, done. @linuspahl there is also user deletebyId endpoint now", "author": "mpfz0r", "createdAt": "2020-10-28T13:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MjQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwMTIzMQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513301231", "bodyText": "for permission we need to use the username", "author": "kmerz", "createdAt": "2020-10-28T09:38:28Z", "path": "graylog2-web-interface/src/pages/UserTokensEditPage.jsx", "diffHunk": "@@ -31,16 +31,16 @@ const PageTitle = ({ fullName }: {fullName: ?string}) => (\n   </>\n );\n \n-const _loadTokens = (username, currentUser, setTokens) => {\n-  if (isPermitted(currentUser?.permissions, [`users:tokenlist:${username}`])) {\n-    UsersDomain.loadTokens(username).then(setTokens);\n+const _loadTokens = (userId, currentUser, setTokens) => {\n+  if (isPermitted(currentUser?.permissions, [`users:tokenlist:${userId}`])) {", "originalCommit": "96c5a5184ad294dc4dd4f09e535a20f5965c507a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMxMTIyNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9217#discussion_r513311225", "bodyText": "Good catch", "author": "linuspahl", "createdAt": "2020-10-28T09:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwMTIzMQ=="}], "type": "inlineReview"}, {"oid": "59322883a0c4391668b53e53d112088e651223ad", "url": "https://github.com/Graylog2/graylog2-server/commit/59322883a0c4391668b53e53d112088e651223ad", "message": "Add Resource to load user by userId", "committedDate": "2020-10-28T15:17:45Z", "type": "commit"}, {"oid": "bb8969aa4a6adcab966732b2c24255c9efc2c0e3", "url": "https://github.com/Graylog2/graylog2-server/commit/bb8969aa4a6adcab966732b2c24255c9efc2c0e3", "message": "Change shares/user endpoint to userId as well", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "f625b62b20e6efc105d6564d5264c1fc34414595", "url": "https://github.com/Graylog2/graylog2-server/commit/f625b62b20e6efc105d6564d5264c1fc34414595", "message": "Change more user endpoints to userId", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "6510efb81645d893611ca126dab3a6044a4208df", "url": "https://github.com/Graylog2/graylog2-server/commit/6510efb81645d893611ca126dab3a6044a4208df", "message": "Add API change note to UPGRADING", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "1c06fa2ce05c5f6b1b287070b3a781ed73d8b923", "url": "https://github.com/Graylog2/graylog2-server/commit/1c06fa2ce05c5f6b1b287070b3a781ed73d8b923", "message": "Adopt to AllUserSessions change", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "5ef9e41a1b50240a3862446860691f44700962ad", "url": "https://github.com/Graylog2/graylog2-server/commit/5ef9e41a1b50240a3862446860691f44700962ad", "message": "Use user id instead of username for api calls on user management pages", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "24b40babf36798aaa77a273d93308f84eff21f51", "url": "https://github.com/Graylog2/graylog2-server/commit/24b40babf36798aaa77a273d93308f84eff21f51", "message": "Fix user edit and details link in user menu", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "1880404a49215cf9d7a656415267cd459b15a062", "url": "https://github.com/Graylog2/graylog2-server/commit/1880404a49215cf9d7a656415267cd459b15a062", "message": "Fix user link in shared entities overview", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "e69061fdb129c8fbe9bfe504d80d16da94164fc5", "url": "https://github.com/Graylog2/graylog2-server/commit/e69061fdb129c8fbe9bfe504d80d16da94164fc5", "message": "Remove not needed component UserManagementLinks", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "a94373d351bb782ade943debc8d9cfee5d2a73cd", "url": "https://github.com/Graylog2/graylog2-server/commit/a94373d351bb782ade943debc8d9cfee5d2a73cd", "message": "Fix linter warnings and tests", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "fc82d7200e6134e0d825bb3d9cb4286a0f4b9172", "url": "https://github.com/Graylog2/graylog2-server/commit/fc82d7200e6134e0d825bb3d9cb4286a0f4b9172", "message": "Remove not needed encodeURIComponent and fix system admin edit tokens link", "committedDate": "2020-10-28T15:17:46Z", "type": "commit"}, {"oid": "a34aab5b50ec98c3d27fc6bd08b49a98f6cc00c0", "url": "https://github.com/Graylog2/graylog2-server/commit/a34aab5b50ec98c3d27fc6bd08b49a98f6cc00c0", "message": "Fix permissions check for user tokens edit page", "committedDate": "2020-10-28T15:17:47Z", "type": "commit"}, {"oid": "0753649121c16fd99095147bd0d0f52c63f5d1f1", "url": "https://github.com/Graylog2/graylog2-server/commit/0753649121c16fd99095147bd0d0f52c63f5d1f1", "message": "Mention correct /users endpoint in UPGRADING.rst", "committedDate": "2020-10-28T15:17:47Z", "type": "commit"}, {"oid": "b40e62520994fcaa5bb24176ccf1d0569e2624d1", "url": "https://github.com/Graylog2/graylog2-server/commit/b40e62520994fcaa5bb24176ccf1d0569e2624d1", "message": "Reduce code duplication", "committedDate": "2020-10-28T15:17:47Z", "type": "commit"}, {"oid": "1122471d1287112fc8de2c05f26079662077dc65", "url": "https://github.com/Graylog2/graylog2-server/commit/1122471d1287112fc8de2c05f26079662077dc65", "message": "Implement deleteUserById  (DELETE /users/id/{userId})", "committedDate": "2020-10-28T15:17:47Z", "type": "commit"}, {"oid": "dc8df3a16da4b5c00e52eea334edf76f0ee80d0a", "url": "https://github.com/Graylog2/graylog2-server/commit/dc8df3a16da4b5c00e52eea334edf76f0ee80d0a", "message": "Actually call deleteById from UsersResource :-D", "committedDate": "2020-10-28T15:17:47Z", "type": "commit"}, {"oid": "4e6ba83d31a6f53572bae18f23f7588238aede03", "url": "https://github.com/Graylog2/graylog2-server/commit/4e6ba83d31a6f53572bae18f23f7588238aede03", "message": "Use /users/id/[user-id] instead of /users/[username] endpoint to delete a user", "committedDate": "2020-10-28T15:24:25Z", "type": "commit"}, {"oid": "4e6ba83d31a6f53572bae18f23f7588238aede03", "url": "https://github.com/Graylog2/graylog2-server/commit/4e6ba83d31a6f53572bae18f23f7588238aede03", "message": "Use /users/id/[user-id] instead of /users/[username] endpoint to delete a user", "committedDate": "2020-10-28T15:24:25Z", "type": "forcePushed"}]}