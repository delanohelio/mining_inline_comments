{"pr_number": 7108, "pr_title": "Add current function to value path.", "pr_createdAt": "2020-01-08T10:15:09Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7108", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY1MjIyMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#discussion_r364652222", "bodyText": "What is the purpose of !value !== undefined, should it be value !== undefined?", "author": "linuspahl", "createdAt": "2020-01-09T10:04:46Z", "path": "graylog2-web-interface/src/views/components/datatable/DataTableEntry.jsx", "diffHunk": "@@ -31,25 +32,34 @@ const _column = (field: string, value: *, selectedQuery: string, idx: number, ty\n   <td key={`${selectedQuery}-${field}=${value}-${idx}`}>\n     <AdditionalContext.Provider value={{ valuePath }}>\n       <CustomHighlighting field={field} value={value}>\n-        {value && <Value field={field} type={type} value={value} queryId={selectedQuery} render={DecoratedValue} />}\n+        {value !== null && !value !== undefined ? <Value field={field} type={type} value={value} queryId={selectedQuery} render={DecoratedValue} /> : <EmptyValue />}", "originalCommit": "183069f9dcba0932466f9406e41ad8510131aff9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIzNzQ2Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#discussion_r365237463", "bodyText": "Seems like it slipped in, fixed it. Thanks!", "author": "dennisoelkers", "createdAt": "2020-01-10T13:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY1MjIyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3Mjk2OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#discussion_r364672968", "bodyText": "While testing these changes, I found another bug. When using the \"Show documents for value\" action, within a data table with the fields source and timestamp, the newly created widget will have these fields twice. Implementing something like this will fix the issue:\nconst newWidgetFields = uniq([...DEFAULT_MESSAGE_FIELDS, ...valuePathFields])\n...\n.fields(newWidgetFields)\n\nShould we fix the issue inside this PR or should I create an Issue, because the problem also exists in the master branch?", "author": "linuspahl", "createdAt": "2020-01-09T10:48:15Z", "path": "graylog2-web-interface/src/views/logic/valueactions/ShowDocumentsHandler.js", "diffHunk": "@@ -22,24 +22,35 @@ type Arguments = {\n   contexts: Contexts;\n };\n \n+const extractFieldsFromValuePath = (valuePath: ValuePath): Array<string> => {\n+  return valuePath.map(item => Object.entries(item)\n+    // $FlowFixMe: We know that values are strings\n+    .map(([key, value]: [string, string]) => (\n+      key === '_exists_' ? value : key)))\n+    .reduce((prev, cur) => [...prev, ...cur], [])\n+    .reduce((prev, cur) => (prev.includes(cur) ? prev : [...prev, cur]), []);\n+};\n+\n const ShowDocumentsHandler: ValueActionHandler = ({ contexts: { valuePath, widget, view } }: Arguments) => {\n   const mergedObject = valuePath.reduce((elem, acc) => ({ ...acc, ...elem }), {});\n   const widgetQuery = widget && widget.query ? widget.query.query_string : '';\n   const valuePathQuery = Object.entries(mergedObject)\n     .map(([k, v]) => `${k}:${escape(String(v))}`)\n     .reduce((prev: string, next: string) => addToQuery(prev, next), '');\n   const query = addToQuery(widgetQuery, valuePathQuery);\n+  const valuePathFields = extractFieldsFromValuePath(valuePath);\n   const newWidgetBuilder = MessagesWidget.builder()\n     .query(createElasticsearchQueryString(query))\n     .newId()\n     .config(new MessagesWidgetConfig.builder()\n-      .fields([...DEFAULT_MESSAGE_FIELDS, ...(Object.keys(mergedObject))])\n+      .fields([...DEFAULT_MESSAGE_FIELDS, ...valuePathFields])", "originalCommit": "183069f9dcba0932466f9406e41ad8510131aff9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIzNzM3Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7108#discussion_r365237373", "bodyText": "I fixed this in this PR as well. Thanks for finding this!", "author": "dennisoelkers", "createdAt": "2020-01-10T13:40:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3Mjk2OA=="}], "type": "inlineReview"}, {"oid": "02ce4cad199db07ba3157d98a211f61e60571d3e", "url": "https://github.com/Graylog2/graylog2-server/commit/02ce4cad199db07ba3157d98a211f61e60571d3e", "message": "Correcting conditional.", "committedDate": "2020-01-10T13:25:03Z", "type": "forcePushed"}, {"oid": "a31d58729d0a97c009ddc967077c7176d741ca16", "url": "https://github.com/Graylog2/graylog2-server/commit/a31d58729d0a97c009ddc967077c7176d741ca16", "message": "Return original term if new term is empty.", "committedDate": "2020-01-10T14:02:34Z", "type": "commit"}, {"oid": "ee1b37a088391d29306480858fee357e8a21e4be", "url": "https://github.com/Graylog2/graylog2-server/commit/ee1b37a088391d29306480858fee357e8a21e4be", "message": "Adjust flow types for helper function.", "committedDate": "2020-01-10T14:02:34Z", "type": "commit"}, {"oid": "b43aaf71a3a04caa52348d0a1c3e7ae35ecfb51e", "url": "https://github.com/Graylog2/graylog2-server/commit/b43aaf71a3a04caa52348d0a1c3e7ae35ecfb51e", "message": "Extract field from value instead of key if value path segment is `_exists_` clause.", "committedDate": "2020-01-10T14:02:34Z", "type": "commit"}, {"oid": "d4397eda4f9bca7414c1be898b2b04a7280031d0", "url": "https://github.com/Graylog2/graylog2-server/commit/d4397eda4f9bca7414c1be898b2b04a7280031d0", "message": "Fix conditional rendering of `Value`/`EmptyValue`.\n\nFixes #7104.", "committedDate": "2020-01-10T14:02:34Z", "type": "commit"}, {"oid": "14a2b548ac41e03ac0b0953f5fa3d3f3f79368d3", "url": "https://github.com/Graylog2/graylog2-server/commit/14a2b548ac41e03ac0b0953f5fa3d3f3f79368d3", "message": "Add current function to value path.\n\nPrior to this change, only field:value pairs were added to the value\npath of a value in a data table. This led to empty/incomplete queries\nbeing generated from the \"Show documents for value\" action.\n\nThis change is now adding functions to the value path as well if they\nrefer to a field. A function like this generates a `_exists_:<field>`\nclause, so all documents containing this field match.\n\nFixes #7103.\nFixes #7104.", "committedDate": "2020-01-10T14:02:51Z", "type": "commit"}, {"oid": "e9e5ce1edc0dcc77a42621b333421bb18d752bee", "url": "https://github.com/Graylog2/graylog2-server/commit/e9e5ce1edc0dcc77a42621b333421bb18d752bee", "message": "Correcting conditional.", "committedDate": "2020-01-10T14:02:51Z", "type": "commit"}, {"oid": "fbf9080e662d55d527e878755d78062def4302ee", "url": "https://github.com/Graylog2/graylog2-server/commit/fbf9080e662d55d527e878755d78062def4302ee", "message": "Do not include source/timestamp fields twice in resulting widget.", "committedDate": "2020-01-10T14:02:51Z", "type": "commit"}, {"oid": "fbf9080e662d55d527e878755d78062def4302ee", "url": "https://github.com/Graylog2/graylog2-server/commit/fbf9080e662d55d527e878755d78062def4302ee", "message": "Do not include source/timestamp fields twice in resulting widget.", "committedDate": "2020-01-10T14:02:51Z", "type": "forcePushed"}]}