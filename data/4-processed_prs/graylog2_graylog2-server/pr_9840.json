{"pr_number": 9840, "pr_title": "Report system stats with OSHI instead of libsigar", "pr_createdAt": "2020-12-21T23:29:52Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9840", "timeline": [{"oid": "2d9aadb40e0a11da42e3658b9fca08471a0d786d", "url": "https://github.com/Graylog2/graylog2-server/commit/2d9aadb40e0a11da42e3658b9fca08471a0d786d", "message": "Add OSHI as system stats reporter\n\nThis commit adds a new Operating System and Hardware Information library, OSHI, that does not require the cumbersome packaging that Sigar currently needs. This library has a very active community and a pretty good platform options. A new config option, enable_oshi, is added, that defaults to false.", "committedDate": "2020-08-13T02:36:06Z", "type": "commit"}, {"oid": "d55467091d9db111ef40e1a271873c655d97834b", "url": "https://github.com/Graylog2/graylog2-server/commit/d55467091d9db111ef40e1a271873c655d97834b", "message": "Completely remove sigar, update to latest oshi", "committedDate": "2020-08-13T02:37:51Z", "type": "commit"}, {"oid": "ca1847ddbb21ead4dcfa89e1b1e33cbcf88d86dd", "url": "https://github.com/Graylog2/graylog2-server/commit/ca1847ddbb21ead4dcfa89e1b1e33cbcf88d86dd", "message": "remove sigar folder", "committedDate": "2020-08-13T02:37:52Z", "type": "commit"}, {"oid": "2fb6b54c252a463e78cda9945ec9e31c9fbc5b66", "url": "https://github.com/Graylog2/graylog2-server/commit/2fb6b54c252a463e78cda9945ec9e31c9fbc5b66", "message": "Add license header", "committedDate": "2020-08-13T02:37:52Z", "type": "commit"}, {"oid": "a0bfa9aa8a0c01acaebbbbe11e7c1b98efab8d08", "url": "https://github.com/Graylog2/graylog2-server/commit/a0bfa9aa8a0c01acaebbbbe11e7c1b98efab8d08", "message": "Reformat", "committedDate": "2020-08-13T02:37:52Z", "type": "commit"}, {"oid": "cdbb28bed76afab2c0fff10686659620532e1611", "url": "https://github.com/Graylog2/graylog2-server/commit/cdbb28bed76afab2c0fff10686659620532e1611", "message": "Add init call (whoops)", "committedDate": "2020-08-13T02:37:52Z", "type": "commit"}, {"oid": "7046beea4206382d24ec9f70c10c448591b9be72", "url": "https://github.com/Graylog2/graylog2-server/commit/7046beea4206382d24ec9f70c10c448591b9be72", "message": "Rebase and update OSHI version", "committedDate": "2020-08-13T02:47:02Z", "type": "commit"}, {"oid": "a54e7da2b449f95ef9d2df60a8249480f4041b37", "url": "https://github.com/Graylog2/graylog2-server/commit/a54e7da2b449f95ef9d2df60a8249480f4041b37", "message": "Merge remote-tracking branch 'origin/master' into oshi", "committedDate": "2020-12-15T22:16:00Z", "type": "commit"}, {"oid": "f759251ed8e38282d9ad58469c1f6643385d1f26", "url": "https://github.com/Graylog2/graylog2-server/commit/f759251ed8e38282d9ad58469c1f6643385d1f26", "message": "Update licenses", "committedDate": "2020-12-15T22:19:11Z", "type": "commit"}, {"oid": "4714e319b58216a6d70327f06b354698253e6a7b", "url": "https://github.com/Graylog2/graylog2-server/commit/4714e319b58216a6d70327f06b354698253e6a7b", "message": "Update OSHI to 5.3.6", "committedDate": "2020-12-16T21:12:05Z", "type": "commit"}, {"oid": "bcf01dd8459fbb9b373390c77a73ce1ebff3cc0e", "url": "https://github.com/Graylog2/graylog2-server/commit/bcf01dd8459fbb9b373390c77a73ce1ebff3cc0e", "message": "Fix filesystem lookup\n\nFlip the mountpoint path comparision the other way around.\nWe need to compare the path against the mountpoint.", "committedDate": "2020-12-16T21:12:42Z", "type": "commit"}, {"oid": "e336d6b2baeb7435cedac0b2c14d1c770e23feff", "url": "https://github.com/Graylog2/graylog2-server/commit/e336d6b2baeb7435cedac0b2c14d1c770e23feff", "message": "Fix JvmStats with Java 11\n\nThere is no bootclasspath option anymore", "committedDate": "2020-12-16T21:34:21Z", "type": "commit"}, {"oid": "09d284ca5f21aeb87bf35480285cc456e983236a", "url": "https://github.com/Graylog2/graylog2-server/commit/09d284ca5f21aeb87bf35480285cc456e983236a", "message": "Report absolute path, like libsigar did.", "committedDate": "2020-12-17T08:56:13Z", "type": "commit"}, {"oid": "000dbd154c2bf3efd6d1b79f293f709f73e3430b", "url": "https://github.com/Graylog2/graylog2-server/commit/000dbd154c2bf3efd6d1b79f293f709f73e3430b", "message": "Keep libsigar semantics for type_name and sys_type_name", "committedDate": "2020-12-17T10:28:37Z", "type": "commit"}, {"oid": "629fd17e89ed5f53ae2daa3e89e988092860f12f", "url": "https://github.com/Graylog2/graylog2-server/commit/629fd17e89ed5f53ae2daa3e89e988092860f12f", "message": "Find diskstore via volume name\n\nThis is simpler and also supports LVM mapped disks.\nE.g. with a LUKS setup:\n\n lrwxrwxrwx 1 root root 7 Nov 26 10:33 /dev/mapper/ubuntu--vg-root -> ../dm-1", "committedDate": "2020-12-21T23:10:56Z", "type": "commit"}, {"oid": "0203fde9f601e69fe19fea1e288f36a0ed293531", "url": "https://github.com/Graylog2/graylog2-server/commit/0203fde9f601e69fe19fea1e288f36a0ed293531", "message": "Find primary interface by the systems default gateway\n\nThe lookup via InetAddress.getLocalHost() isn't always\nrelieable. Ubuntu for instance defaults the hostname to 127.0.1.1\nwhich isn't bound to any interface.", "committedDate": "2020-12-21T23:15:05Z", "type": "commit"}, {"oid": "0f962c5da591eff4666bb6b117e88d38a1d5f3f0", "url": "https://github.com/Graylog2/graylog2-server/commit/0f962c5da591eff4666bb6b117e88d38a1d5f3f0", "message": "Fix Processor info\n\nkHZ -> MHz\n\nUse full processor string instead of model number", "committedDate": "2020-12-21T23:27:46Z", "type": "commit"}, {"oid": "cf4eaffe708bce9ee1c2b4a321a9e2b1b1ffa056", "url": "https://github.com/Graylog2/graylog2-server/commit/cf4eaffe708bce9ee1c2b4a321a9e2b1b1ffa056", "message": "Try two approaches for searching the diskstore\n\nFirst try search for the diskstore with the logical volume or volume name.\nIf that finds nothing, try to search for the diskstore with the partition of our mountpoint.\n\nUsing only the volume names, did not work on MacOS", "committedDate": "2020-12-22T09:08:20Z", "type": "commit"}, {"oid": "f00cd410770ce8efb90e8056062c5e241aec7a54", "url": "https://github.com/Graylog2/graylog2-server/commit/f00cd410770ce8efb90e8056062c5e241aec7a54", "message": "Fix space and inodes use percentage calculation", "committedDate": "2020-12-22T09:28:19Z", "type": "commit"}, {"oid": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe", "url": "https://github.com/Graylog2/graylog2-server/commit/425f7d94c9805cf8b20c3c6d161981d6cf28b0fe", "message": "Merge remote-tracking branch 'origin/master' into oshi", "committedDate": "2021-01-13T15:37:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY5OTc4Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556699782", "bodyText": "Can you please update to 5.3.7 release of oshi?", "author": "bernd", "createdAt": "2021-01-13T17:25:11Z", "path": "pom.xml", "diffHunk": "@@ -147,7 +147,7 @@\n         <scala.version>2.11.8</scala.version>\n         <semver4j.version>2.2.0-graylog.1</semver4j.version>\n         <shiro.version>1.5.2</shiro.version>\n-        <sigar.version>1.6.4</sigar.version>\n+        <oshi.version>5.3.6</oshi.version>", "originalCommit": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzI2OTI2Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r557269266", "bodyText": "can do. but when I did this PR it wasn't even released \ud83e\udd37\u200d\u2642\ufe0f", "author": "mpfz0r", "createdAt": "2021-01-14T09:50:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY5OTc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwMDQyOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556700429", "bodyText": "I think we should add this change to the UPGRADING.rst file.", "author": "bernd", "createdAt": "2021-01-13T17:26:02Z", "path": "misc/graylog.conf", "diffHunk": "@@ -637,8 +637,8 @@ mongodb_threads_allowed_to_block_multiplier = 5\n # Connection timeout for a configured LDAP server (e. g. ActiveDirectory) in milliseconds.\n #ldap_connection_timeout = 2000\n \n-# Disable the use of SIGAR for collecting system stats\n-#disable_sigar = false\n+# Disable the use of OSHI for collecting system stats\n+#disable_oshi = false", "originalCommit": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwMjkyNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556702925", "bodyText": "And what do you think about using something like disable_native_system_stats_collector instead? That way we don't have to rename it again in the future. \ud83d\ude09", "author": "bernd", "createdAt": "2021-01-13T17:29:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwMDQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwNDQ0NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9840#discussion_r556704445", "bodyText": "Can we remove the commented code?", "author": "bernd", "createdAt": "2021-01-13T17:32:02Z", "path": "graylog2-server/src/main/java/org/graylog2/shared/system/stats/fs/OshiFsProbe.java", "diffHunk": "@@ -0,0 +1,225 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+package org.graylog2.shared.system.stats.fs;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.apache.commons.lang3.StringUtils;\n+import org.graylog2.Configuration;\n+import org.graylog2.plugin.KafkaJournalConfiguration;\n+import org.graylog2.shared.system.stats.OshiService;\n+import oshi.hardware.HWDiskStore;\n+import oshi.hardware.HWPartition;\n+import oshi.hardware.HardwareAbstractionLayer;\n+import oshi.hardware.common.AbstractHWDiskStore;\n+import oshi.software.common.AbstractOSFileStore;\n+import oshi.software.os.FileSystem;\n+import oshi.software.os.OSFileStore;\n+import oshi.software.os.OperatingSystem;\n+import oshi.util.tuples.Pair;\n+\n+import javax.inject.Inject;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+public class OshiFsProbe implements FsProbe {\n+\n+    private final OshiService service;\n+\n+    private final Set<Path> locations;\n+    private final Map<Path, Pair<OSFileStore, HWDiskStore>> oshiFileSystems = new HashMap<>();\n+\n+    @Inject\n+    public OshiFsProbe(OshiService service, Configuration configuration,\n+                       KafkaJournalConfiguration kafkaJournalConfiguration) {\n+        this.service = service;\n+\n+        this.locations = ImmutableSet.of(\n+                configuration.getBinDir(),\n+                configuration.getDataDir(),\n+                configuration.getPluginDir(),\n+                kafkaJournalConfiguration.getMessageJournalDir()\n+        );\n+\n+        init();\n+    }\n+\n+    private void init() {\n+        final OperatingSystem os = service.getOs();\n+\n+        final FileSystem fileSystem = os.getFileSystem();\n+\n+        final HardwareAbstractionLayer hardware = service.getHal();\n+\n+        for (Path location : locations) {\n+            Path path = location.toAbsolutePath();\n+            oshiFileSystems.put(path,\n+                    fileSystem.getFileStores().stream()\n+                            .filter(fs -> path.startsWith(fs.getMount()))\n+                            // We want the mountpoint closest to our location\n+                            .max(Comparator.comparingInt(p -> Paths.get(p.getMount()).getNameCount()))\n+                            .map(fs -> {\n+                                // First try search for the diskstore with the logical volume or volume name\n+                                Optional<HWDiskStore> diskStore = hardware.getDiskStores().stream()\n+                                        .filter(ds -> ds.getName().equals(StringUtils.defaultIfEmpty(fs.getLogicalVolume(), fs.getVolume())))\n+                                        .findFirst(); //.orElse(generateDummyDiskStore());", "originalCommit": "425f7d94c9805cf8b20c3c6d161981d6cf28b0fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d299ea45afab9d771b08e6917f8594d24ae78752", "url": "https://github.com/Graylog2/graylog2-server/commit/d299ea45afab9d771b08e6917f8594d24ae78752", "message": "Rename disable_oshi to disable_native_system_stats_collector", "committedDate": "2021-01-14T09:39:52Z", "type": "commit"}, {"oid": "788e88751c56c176d4758b846979feee90423ba3", "url": "https://github.com/Graylog2/graylog2-server/commit/788e88751c56c176d4758b846979feee90423ba3", "message": "Mention SIGAR removal", "committedDate": "2021-01-14T09:40:30Z", "type": "commit"}, {"oid": "dfda09ac2025fcf185046d9a7e01d6b36a475ca1", "url": "https://github.com/Graylog2/graylog2-server/commit/dfda09ac2025fcf185046d9a7e01d6b36a475ca1", "message": "update oshi to 5.3.7", "committedDate": "2021-01-14T09:51:11Z", "type": "commit"}, {"oid": "373a52c2ca67882ca17a5348dcbef0d3095e3d90", "url": "https://github.com/Graylog2/graylog2-server/commit/373a52c2ca67882ca17a5348dcbef0d3095e3d90", "message": "remove stale comment", "committedDate": "2021-01-14T09:51:52Z", "type": "commit"}, {"oid": "1d8f6fecdc4b2616872d5986348ecd0cdb5e9a8e", "url": "https://github.com/Graylog2/graylog2-server/commit/1d8f6fecdc4b2616872d5986348ecd0cdb5e9a8e", "message": "Avoid division by zero when DummyFileStore is being used", "committedDate": "2021-01-14T10:16:43Z", "type": "commit"}, {"oid": "2a2fc62f2079e835993b4eefa38aef79f4a391ac", "url": "https://github.com/Graylog2/graylog2-server/commit/2a2fc62f2079e835993b4eefa38aef79f4a391ac", "message": "Fix disk statistics on docker\n\n Don't let OSHI filter out \"overlay\" filesystems.\n Otherwise we cannot get proper disk statistics from within Docker.", "committedDate": "2021-01-15T16:47:32Z", "type": "commit"}, {"oid": "9d90b515da1517e03c63caa55fff02b4bc8c514d", "url": "https://github.com/Graylog2/graylog2-server/commit/9d90b515da1517e03c63caa55fff02b4bc8c514d", "message": "Add SystemStatsIT full-backend test", "committedDate": "2021-01-15T16:58:42Z", "type": "commit"}, {"oid": "88061cc3cedaaa2b5c8bfb0eaaf52933283c330b", "url": "https://github.com/Graylog2/graylog2-server/commit/88061cc3cedaaa2b5c8bfb0eaaf52933283c330b", "message": "Fix license header", "committedDate": "2021-01-15T17:01:52Z", "type": "commit"}]}