{"pr_number": 9810, "pr_title": "DateTimePicker - Adding limitDuration config to Widget", "pr_createdAt": "2020-12-15T20:35:02Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9810", "timeline": [{"oid": "8dc4179f864228e6e7d135783033ab1095fd695b", "url": "https://github.com/Graylog2/graylog2-server/commit/8dc4179f864228e6e7d135783033ab1095fd695b", "message": "Adding limitDuration config to Widget", "committedDate": "2020-12-15T19:53:21Z", "type": "commit"}, {"oid": "02720a9533ed8f931e73595c963320fb5df42fbc", "url": "https://github.com/Graylog2/graylog2-server/commit/02720a9533ed8f931e73595c963320fb5df42fbc", "message": "test & snap", "committedDate": "2020-12-15T20:33:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMDU1Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544120553", "bodyText": "I would suggest using connect only for class-based components and use useStore for function components. The benefit is the simpler API and it does not create a wrapper component.\nFor this, you can just do:\nconst config = useStore(SearchConfigStore, ({ configurations: { searchesClusterConfig } }) => searchesClusterConfig);", "author": "dennisoelkers", "createdAt": "2020-12-16T08:55:31Z", "path": "graylog2-web-interface/src/views/components/widgets/EditWidgetFrame.tsx", "diffHunk": "@@ -124,4 +130,8 @@ EditWidgetFrame.propTypes = {\n   children: PropTypes.node.isRequired,\n };\n \n-export default EditWidgetFrame;\n+export default connect(EditWidgetFrame, {", "originalCommit": "02720a9533ed8f931e73595c963320fb5df42fbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMzMjU4NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544332585", "bodyText": "Great suggestion! Had to modify slightly, but thanks for the reminder on this hook!", "author": "kyleknighted", "createdAt": "2020-12-16T14:16:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMDU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMjI5Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544122292", "bodyText": "Is the time range limit really part of the form state? IMO it is a static setting that is not changed in the form, so it should not be part of its state. If we want to pass it through to other subcomponents, we could use a context instead.", "author": "dennisoelkers", "createdAt": "2020-12-16T08:57:59Z", "path": "graylog2-web-interface/src/views/components/widgets/EditWidgetFrame.tsx", "diffHunk": "@@ -93,7 +99,7 @@ const EditWidgetFrame = ({ children }: Props) => {\n            animation={false}\n            dialogComponentClass={EditWidgetDialog}\n            enforceFocus={false}>\n-      <SearchBarForm initialValues={{ limitDuration: 0, timerange, streams, queryString }}\n+      <SearchBarForm initialValues={{ limitDuration, timerange, streams, queryString }}", "originalCommit": "02720a9533ed8f931e73595c963320fb5df42fbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMzMzkyNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544333924", "bodyText": "It's not really part of the entire state, and I agree having a wrapping context may be better, but this is already written in such a way across Search and Dashboard, so it would require updating in a few places. Maybe this is something we can include as a follow-up later or do you feel it is important enough to rework all of them?", "author": "kyleknighted", "createdAt": "2020-12-16T14:18:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk4NTI0OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544985249", "bodyText": "If you keep track of it and rework it before the picker is merged into master, then this is fine.", "author": "dennisoelkers", "createdAt": "2020-12-17T10:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk4ODk4NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r555988984", "bodyText": "This conversation was followed-up in #9893", "author": "kyleknighted", "createdAt": "2021-01-12T18:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMjI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyNDUyOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544124529", "bodyText": "Do we need checks here if\n\nconfig or\nquery_time_range_limit are undefined?\n\nThe first would result in an exception, the second forces us to rely on moment.duration returning an empty duration if the argument is undefined. IMO we should make this more explicit like this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              const limitDuration = moment.duration(config.query_time_range_limit).asSeconds();\n          \n          \n            \n              const limitDuration = config?.query_time_range_limit !== undefined ? moment.duration(config.query_time_range_limit).asSeconds() : 0;", "author": "dennisoelkers", "createdAt": "2020-12-16T09:01:23Z", "path": "graylog2-web-interface/src/views/components/widgets/EditWidgetFrame.tsx", "diffHunk": "@@ -83,6 +88,7 @@ const EditWidgetFrame = ({ children }: Props) => {\n     return <Spinner text=\"Loading widget ...\" />;\n   }\n \n+  const limitDuration = moment.duration(config.query_time_range_limit).asSeconds();", "originalCommit": "02720a9533ed8f931e73595c963320fb5df42fbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MzUyMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544353522", "bodyText": "moment.duration(undefined | null) will return 0.\nIf config does not return Search Config, then we are already having issues everywhere else with searching because we will not have the necessary data.\nIf query_time_range_limit also does not return something, then we should define this as a default in the SearchConfigStore to always return 0 if it does not exist.\nI do agree that there should be some checking though so added the optional chaining to the object\nconst limitDuration = moment.duration(config?.query_time_range_limit).asSeconds();\nMaybe something like const limitDuration = moment.duration(config?.query_time_range_limit ?? 0).asSeconds(); would be good?", "author": "kyleknighted", "createdAt": "2020-12-16T14:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyNDUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk4NTg2Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544985862", "bodyText": "The last option would be okay for me too.", "author": "dennisoelkers", "createdAt": "2020-12-17T10:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyNDUyOQ=="}], "type": "inlineReview"}, {"oid": "732943b50fdc968e3a57b973ed81f3ab9b8acc6b", "url": "https://github.com/Graylog2/graylog2-server/commit/732943b50fdc968e3a57b973ed81f3ab9b8acc6b", "message": "update connect HOC to useStore hook", "committedDate": "2020-12-16T14:16:14Z", "type": "commit"}, {"oid": "23526e1da4367ad95f203108d9bc095a34e4c37d", "url": "https://github.com/Graylog2/graylog2-server/commit/23526e1da4367ad95f203108d9bc095a34e4c37d", "message": "Optional chaining in moment duration", "committedDate": "2020-12-16T14:32:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk4NjUxOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r544986518", "bodyText": "IMO we can remove the explicit SearchesConfig type. It should be inferred from SearchConfigStore's type.", "author": "dennisoelkers", "createdAt": "2020-12-17T10:40:15Z", "path": "graylog2-web-interface/src/views/components/widgets/EditWidgetFrame.tsx", "diffHunk": "@@ -71,6 +75,8 @@ const onSubmit = (values, widget: Widget) => {\n };\n \n const EditWidgetFrame = ({ children }: Props) => {\n+  const config: SearchesConfig = useStore(SearchConfigStore, ({ searchesClusterConfig }) => searchesClusterConfig);", "originalCommit": "23526e1da4367ad95f203108d9bc095a34e4c37d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIzMzIxNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9810#discussion_r555233215", "bodyText": "@dennisoelkers Updated!", "author": "kyleknighted", "createdAt": "2021-01-11T17:53:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk4NjUxOA=="}], "type": "inlineReview"}, {"oid": "44df1e0c4884c7578180e00a6d320e4a317a7c1c", "url": "https://github.com/Graylog2/graylog2-server/commit/44df1e0c4884c7578180e00a6d320e4a317a7c1c", "message": "Merge branch 'feature/DateTimeRange' into dtp_widget_limitDuration", "committedDate": "2021-01-11T17:44:46Z", "type": "commit"}, {"oid": "96448f26c5fa738fe1c1207391157d6da75ffaa3", "url": "https://github.com/Graylog2/graylog2-server/commit/96448f26c5fa738fe1c1207391157d6da75ffaa3", "message": "remove the explicit SearchesConfig type", "committedDate": "2021-01-11T17:52:46Z", "type": "commit"}, {"oid": "db6d247dd64a2e69d80f84a2aac9020460be4e65", "url": "https://github.com/Graylog2/graylog2-server/commit/db6d247dd64a2e69d80f84a2aac9020460be4e65", "message": "Merge branch 'feature/DateTimeRange' into dtp_widget_limitDuration", "committedDate": "2021-01-13T15:46:41Z", "type": "commit"}, {"oid": "eba07428372ca627f15498ba326689ae0c381521", "url": "https://github.com/Graylog2/graylog2-server/commit/eba07428372ca627f15498ba326689ae0c381521", "message": "Updated tests and snapshots", "committedDate": "2021-01-13T17:06:24Z", "type": "commit"}]}