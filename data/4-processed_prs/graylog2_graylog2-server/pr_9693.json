{"pr_number": 9693, "pr_title": "Simplify pulsar processing", "pr_createdAt": "2020-12-03T10:47:27Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9693", "timeline": [{"oid": "636688c6a100ebc2c3bae67ff7afb4027c132fb3", "url": "https://github.com/Graylog2/graylog2-server/commit/636688c6a100ebc2c3bae67ff7afb4027c132fb3", "message": "Compare array content. Found by errorprone plugin", "committedDate": "2020-12-03T14:40:48Z", "type": "forcePushed"}, {"oid": "c59db5ea3a4978ff03d57172fa22bb6626b6a460", "url": "https://github.com/Graylog2/graylog2-server/commit/c59db5ea3a4978ff03d57172fa22bb6626b6a460", "message": "Simplify input processing\n\nGet rid of a few intermediate classes and use RawMessageEvent\ndirectly.\nThis saves us a few conversion steps.", "committedDate": "2020-12-03T15:18:51Z", "type": "commit"}, {"oid": "c59db5ea3a4978ff03d57172fa22bb6626b6a460", "url": "https://github.com/Graylog2/graylog2-server/commit/c59db5ea3a4978ff03d57172fa22bb6626b6a460", "message": "Simplify input processing\n\nGet rid of a few intermediate classes and use RawMessageEvent\ndirectly.\nThis saves us a few conversion steps.", "committedDate": "2020-12-03T15:18:51Z", "type": "forcePushed"}, {"oid": "ba289fc81fab36b7485601bf5bfb3ac0ea98acae", "url": "https://github.com/Graylog2/graylog2-server/commit/ba289fc81fab36b7485601bf5bfb3ac0ea98acae", "message": "Unify messageQueueId and journalOffset", "committedDate": "2020-12-03T15:20:25Z", "type": "commit"}, {"oid": "dcc0704828389d28d1203539300861bc146aaed7", "url": "https://github.com/Graylog2/graylog2-server/commit/dcc0704828389d28d1203539300861bc146aaed7", "message": "Merge remote-tracking branch 'origin/pulsar' into simplify-pulsar-processing", "committedDate": "2020-12-03T16:35:29Z", "type": "commit"}, {"oid": "5a2bed586f1548b8fe327c5de282a0b91c7eb0c2", "url": "https://github.com/Graylog2/graylog2-server/commit/5a2bed586f1548b8fe327c5de282a0b91c7eb0c2", "message": "Use MessageQueueAcknowledger instead of Journal", "committedDate": "2020-12-03T16:37:01Z", "type": "commit"}, {"oid": "f2019ee8378554555c133424a6cdc1bb53c65efb", "url": "https://github.com/Graylog2/graylog2-server/commit/f2019ee8378554555c133424a6cdc1bb53c65efb", "message": "Merge pull request #9700 from Graylog2/use-messagequeue-acknowledger\n\nUse MessageQueueAcknowledger instead of Journal", "committedDate": "2020-12-04T10:23:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxMjIwMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9693#discussion_r536012202", "bodyText": "Yes please!", "author": "thll", "createdAt": "2020-12-04T10:53:29Z", "path": "graylog2-server/src/main/java/org/graylog2/shared/messageq/kafka/KafkaMessageQueueReader.java", "diffHunk": "@@ -16,22 +16,15 @@\n  */\n package org.graylog2.shared.messageq.kafka;\n \n-import com.google.common.base.Function;\n-import com.google.common.collect.Lists;\n import com.google.common.util.concurrent.AbstractService;\n-import org.graylog2.shared.journal.Journal;\n import org.graylog2.shared.journal.KafkaJournal;\n-import org.graylog2.shared.messageq.MessageQueue;\n import org.graylog2.shared.messageq.MessageQueueException;\n import org.graylog2.shared.messageq.MessageQueueReader;\n \n-import javax.annotation.Nullable;\n import javax.inject.Inject;\n-import java.util.ArrayList;\n import java.util.List;\n \n-import static com.google.common.collect.Lists.transform;\n-\n+// TODO this doesn't do anything but to please the interface. remove?", "originalCommit": "f2019ee8378554555c133424a6cdc1bb53c65efb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEwMTU0Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9693#discussion_r536101543", "bodyText": "Afaics the commitId can now not be null anymore, so we should also remove the @Nullable annotation from #commitId().", "author": "thll", "createdAt": "2020-12-04T13:32:23Z", "path": "graylog2-server/src/main/java/org/graylog2/shared/messageq/pulsar/PulsarMessageQueueEntry.java", "diffHunk": "@@ -43,15 +43,6 @@\n         this.timestamp = message.getEventTime();\n     }\n \n-    PulsarMessageQueueEntry(byte[] id, @Nullable byte[] key, byte[] value, long timestamp) {\n-        this.commitId = null;", "originalCommit": "f2019ee8378554555c133424a6cdc1bb53c65efb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjExNzQ1NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9693#discussion_r536117455", "bodyText": "Do you think we still need the exception handling? If so, we should adjust the error message and re-add the filtering of null messages in #onEvent. I have the feeling we can just remove the exception handling though because we are not doing much which would be prone to throwing exceptions, except maybe a NPE in line 126 which we then probably should guard against.", "author": "thll", "createdAt": "2020-12-04T13:57:40Z", "path": "graylog2-server/src/main/java/org/graylog2/shared/buffers/JournallingMessageHandler.java", "diffHunk": "@@ -161,12 +132,7 @@ public DateTime getLatestReceiveTime() {\n                     latestReceiveTime = latestReceiveTime.isBefore(messageTimestamp) ? messageTimestamp : latestReceiveTime;\n                 }\n \n-                // clear for gc and to avoid promotion to tenured space\n-                input.setMessageIdBytes(null);\n-                input.setEncodedRawMessage(null);\n-                input.setMessageTimestamp(null);\n-                // convert to journal entry\n-                return journal.createEntry(messageIdBytes, encodedRawMessage);\n+                return input;\n             } catch (Exception e) {\n                 log.error(\"Unable to convert RawMessageEvent to Journal.Entry - skipping event\", e);\n                 return null;", "originalCommit": "f2019ee8378554555c133424a6cdc1bb53c65efb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM1NzgxMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9693#discussion_r537357810", "bodyText": "I agree. I've removed the try/catch.\nI think we don't need to handle a NPE in 126. If the RawMessageEncoder fails, we won't to this step in the disruptor chain.", "author": "mpfz0r", "createdAt": "2020-12-07T09:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjExNzQ1NQ=="}], "type": "inlineReview"}, {"oid": "b21e9f69a00a282e70fef4d4c4e032d436881ed6", "url": "https://github.com/Graylog2/graylog2-server/commit/b21e9f69a00a282e70fef4d4c4e032d436881ed6", "message": "Remove MessageQueueReader interface\n\n - It doesn't fit our current abstraction", "committedDate": "2020-12-07T09:11:32Z", "type": "commit"}, {"oid": "711fa9f313e5cab18e420a5b7a9a03a5741b3423", "url": "https://github.com/Graylog2/graylog2-server/commit/711fa9f313e5cab18e420a5b7a9a03a5741b3423", "message": "Remove Nullable from commitId", "committedDate": "2020-12-07T09:16:23Z", "type": "commit"}, {"oid": "8440a10bcb44621499959229d24714fd8fcef4de", "url": "https://github.com/Graylog2/graylog2-server/commit/8440a10bcb44621499959229d24714fd8fcef4de", "message": "Remove exception handling from Filter.\n\nIt doesn't do any conversion anymore, but simply\nrecord statistics.", "committedDate": "2020-12-07T09:36:22Z", "type": "commit"}, {"oid": "d57a49360bcc01c26f82269f9bfcac73f887e0a2", "url": "https://github.com/Graylog2/graylog2-server/commit/d57a49360bcc01c26f82269f9bfcac73f887e0a2", "message": "Remove unneded dependency", "committedDate": "2020-12-07T09:46:15Z", "type": "commit"}, {"oid": "4d8558b44c2c0e2fa4317e66dfa86386d58c8be4", "url": "https://github.com/Graylog2/graylog2-server/commit/4d8558b44c2c0e2fa4317e66dfa86386d58c8be4", "message": "Keep updating the processingStatusRecorder\n\nThis got deleted by accident :-/", "committedDate": "2020-12-07T09:46:29Z", "type": "commit"}, {"oid": "b3f7bb25a450736bbf5ba1eaa470d9420602f7d6", "url": "https://github.com/Graylog2/graylog2-server/commit/b3f7bb25a450736bbf5ba1eaa470d9420602f7d6", "message": "Remove more unused code", "committedDate": "2020-12-07T09:52:00Z", "type": "commit"}, {"oid": "e641637cdda7a026afc54c7773c808a3c8a4e7cc", "url": "https://github.com/Graylog2/graylog2-server/commit/e641637cdda7a026afc54c7773c808a3c8a4e7cc", "message": "Don't journal messages where encodedRawMessage is null\n\nThis restores the previous behaviour of the JournallingMessageHandler.\n\nUse Streams instead of arcane guava Lists transform.", "committedDate": "2020-12-07T10:54:56Z", "type": "commit"}]}