{"pr_number": 8774, "pr_title": "Remove shared entities mock from EntityShareStore", "pr_createdAt": "2020-08-12T07:51:40Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8774", "timeline": [{"oid": "53f26ea88dc71b8f12dd3857d2e1fd891773f048", "url": "https://github.com/Graylog2/graylog2-server/commit/53f26ea88dc71b8f12dd3857d2e1fd891773f048", "message": "Fix UserDetails test", "committedDate": "2020-08-13T14:51:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5MzY3MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r470493671", "bodyText": "I just saw, I forgot to remove this line. If there is nothing else that needs to be adjusted, I will remove it in feature/permissions", "author": "linuspahl", "createdAt": "2020-08-14T08:44:54Z", "path": "graylog2-web-interface/src/stores/permissions/EntityShareStore.js", "diffHunk": "@@ -53,24 +52,25 @@ const EntityShareStore: EntityShareStoreType = singletonStore(\n     },\n \n     searchPaginatedUserShares(username: string, page: number, perPage: number, query: string, additionalQueries?: AdditionalQueries): Promise<PaginatedEnititySharesType> {\n-      // const url = PaginationURL(ApiRoutes.EntityShareController.userSharesPaginated(username).url, page, perPage, query, additionalQueries);\n-      // const promise = fetch('GET', qualifyUrl(url)).then((response: PaginatedUserSharesResponse) => {\n-      //   return {\n-      //     list: Immutable.List(response.entities.map((se) => SharedEntity.fromJSON(se))),\n-      //     context: {\n-      //       userCapabilities: response.context.user_capabilities,\n-      //     },\n-      //     pagination: {\n-      //       count: response.count,\n-      //       total: response.total,\n-      //       page: response.page,\n-      //       perPage: response.per_page,\n-      //       query: response.query,\n-      //     },\n-      //   };\n-      // });\n-\n-      const promise = permissionsMock.searchPaginatedEntitySharesResponse(page, perPage, query, additionalQueries);\n+      const url = PaginationURL(ApiRoutes.EntityShareController.userSharesPaginated(username).url, page, perPage, query, additionalQueries);\n+      const promise = fetch('GET', qualifyUrl(url)).then((response) => {\n+        return {\n+          list: Immutable.List(response.entities.map((se) => SharedEntity.fromJSON(se))),\n+          context: {\n+            granteeCapabilities: response.context.grantee_capabilities,\n+          },\n+          pagination: {\n+            additionalQueries: response.additional_queries,\n+            count: response.count,\n+            total: response.total,\n+            page: response.page,\n+            perPage: response.per_page,\n+            query: response.query,\n+          },\n+        };\n+      });\n+\n+      // const promise = permissionsMock.searchPaginatedEntitySharesResponse(page, perPage, query, additionalQueries);", "originalCommit": "0f8d4d40733eea4b610ac0742621c341ec490e00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMjk2OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r469302969", "bodyText": "I would rather suggest a regex for this. Because if we ever fill the other colons of the GRN no one will remember this. Let's make it future proof. I can help you with that if you need help", "author": "kmerz", "createdAt": "2020-08-12T14:30:08Z", "path": "graylog2-web-interface/src/logic/permissions/GRN.js", "diffHunk": "@@ -2,3 +2,9 @@\n \n // eslint-disable-next-line import/prefer-default-export\n export const createGRN = (id: string, type: string) => `grn::::${type}:${id}`;\n+\n+export const getIdFromGRN = (grn: string, type: string) => {\n+  const grnStart = `grn::::${type}:`;", "originalCommit": "5efdf14ec28ea4052f3dfa702135e227462a8b44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzQzNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r469303434", "bodyText": "And we should now definitely write some minimal tests for this.", "author": "kmerz", "createdAt": "2020-08-12T14:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMjk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5MDIwOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r470490209", "bodyText": "We might need this in the future. So I would advise to to move this to the GRN lib and call it getRouteFromGRN(grn: GRN) what do you think? And does the id not already contain the type?", "author": "kmerz", "createdAt": "2020-08-14T08:38:41Z", "path": "graylog2-web-interface/src/components/permissions/SharedEntitiesOverview/SharedEntitiesOverviewItem/TitleCell.jsx", "diffHunk": "@@ -0,0 +1,40 @@\n+// @flow strict\n+import * as React from 'react';\n+import { Link } from 'react-router';\n+\n+import { getIdFromGRN } from 'logic/permissions/GRN';\n+import Routes from 'routing/Routes';\n+import SharedEntity from 'logic/permissions/SharedEntity';\n+\n+type Props = {\n+  title: $PropertyType<SharedEntity, 'title'>,\n+  type: $PropertyType<SharedEntity, 'type'>,\n+  id: $PropertyType<SharedEntity, 'id'>,\n+};\n+\n+const _getTitleLink = (id, type) => {", "originalCommit": "0f8d4d40733eea4b610ac0742621c341ec490e00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3c7674fb44838982e0cedba1ccbd4392b0add0da", "url": "https://github.com/Graylog2/graylog2-server/commit/3c7674fb44838982e0cedba1ccbd4392b0add0da", "message": "Remove shared entities mock from EntityShareStore\n\n- Update response structure\n- Remove not needed SharedEntitesOverviewItem", "committedDate": "2020-08-20T08:12:40Z", "type": "commit"}, {"oid": "7a6a145e5d1f4eaf9ff75ba0a46b9c2248e55354", "url": "https://github.com/Graylog2/graylog2-server/commit/7a6a145e5d1f4eaf9ff75ba0a46b9c2248e55354", "message": "Fix owners link", "committedDate": "2020-08-20T08:12:40Z", "type": "commit"}, {"oid": "8b0ccab3f456fa78a5ba45083bcb3d43d203978e", "url": "https://github.com/Graylog2/graylog2-server/commit/8b0ccab3f456fa78a5ba45083bcb3d43d203978e", "message": "Unify SharedEntitiesOverview pagination handling", "committedDate": "2020-08-20T08:12:40Z", "type": "commit"}, {"oid": "3ff7635c03181cd546b791ad846c3f5ed0888ff9", "url": "https://github.com/Graylog2/graylog2-server/commit/3ff7635c03181cd546b791ad846c3f5ed0888ff9", "message": "Fix UserDetails test", "committedDate": "2020-08-20T08:13:27Z", "type": "commit"}, {"oid": "539bfe05544392bfded60d1fe1ebc86e01174549", "url": "https://github.com/Graylog2/graylog2-server/commit/539bfe05544392bfded60d1fe1ebc86e01174549", "message": "Add link for title in shared entites overview", "committedDate": "2020-08-20T08:13:27Z", "type": "commit"}, {"oid": "139e4d2493479c9811eb0fe9dce3903577cab15b", "url": "https://github.com/Graylog2/graylog2-server/commit/139e4d2493479c9811eb0fe9dce3903577cab15b", "message": "Fix user details test", "committedDate": "2020-08-20T08:13:27Z", "type": "commit"}, {"oid": "e348230c10e587ecbbf36c6c2e4e8ca93e5afd94", "url": "https://github.com/Graylog2/graylog2-server/commit/e348230c10e587ecbbf36c6c2e4e8ca93e5afd94", "message": "Add ifPermitted for owners of a shared entity", "committedDate": "2020-08-20T08:13:27Z", "type": "commit"}, {"oid": "98a88e56f01343efde86de2c7df0ab764d219bb6", "url": "https://github.com/Graylog2/graylog2-server/commit/98a88e56f01343efde86de2c7df0ab764d219bb6", "message": "Define correct sorting for owners", "committedDate": "2020-08-20T08:13:27Z", "type": "commit"}, {"oid": "5b50f828be88d14cf282af8dac94bb7057897894", "url": "https://github.com/Graylog2/graylog2-server/commit/5b50f828be88d14cf282af8dac94bb7057897894", "message": "Remove not needed comment", "committedDate": "2020-08-20T08:14:04Z", "type": "commit"}, {"oid": "d8acad39fb0aa5d97de487635dc562d9e42d8aed", "url": "https://github.com/Graylog2/graylog2-server/commit/d8acad39fb0aa5d97de487635dc562d9e42d8aed", "message": "Improve GRN handling and add tests", "committedDate": "2020-08-20T08:14:04Z", "type": "commit"}, {"oid": "81ad917badfb2b6a003eba62b4b4a3631e689419", "url": "https://github.com/Graylog2/graylog2-server/commit/81ad917badfb2b6a003eba62b4b4a3631e689419", "message": "Extract logic to generate show url based on a GRN", "committedDate": "2020-08-20T08:14:04Z", "type": "commit"}, {"oid": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c", "url": "https://github.com/Graylog2/graylog2-server/commit/bb15dabaae6e1c45cad981e5aafd4f3ce00c437c", "message": "Fix import", "committedDate": "2020-08-20T08:14:04Z", "type": "commit"}, {"oid": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c", "url": "https://github.com/Graylog2/graylog2-server/commit/bb15dabaae6e1c45cad981e5aafd4f3ce00c437c", "message": "Fix import", "committedDate": "2020-08-20T08:14:04Z", "type": "forcePushed"}, {"oid": "93a9967ebe348bbd21b579be6d42e0d51b0d51cd", "url": "https://github.com/Graylog2/graylog2-server/commit/93a9967ebe348bbd21b579be6d42e0d51b0d51cd", "message": "Update createGRN usage for HasOwnership", "committedDate": "2020-08-20T08:18:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1MjQ1NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r473752455", "bodyText": "Routes.getPluginRoute\nis what you want to use here. Otherwise it thorws an error if enterprise is not installed", "author": "kmerz", "createdAt": "2020-08-20T08:21:20Z", "path": "graylog2-web-interface/src/logic/permissions/GRN.js", "diffHunk": "@@ -1,4 +1,33 @@\n // @flow strict\n-\n // eslint-disable-next-line import/prefer-default-export\n-export const createGRN = (id: string, type: string) => `grn::::${type}:${id}`;\n+import Routes from 'routing/Routes';\n+\n+const _convertEmptyString = (value: string) => (value === '' ? undefined : value);\n+\n+export const createGRN = (type: string, id: string) => `grn::::${type}:${id}`;\n+\n+export const getValuesFromGRN = (grn: string) => {\n+  const grnValues = grn.split(':');\n+  const [resourceNameType, cluster, tenent, scope, type, id] = grnValues.map(_convertEmptyString);\n+\n+  return { resourceNameType, cluster, tenent, scope, type, id };\n+};\n+\n+export const getShowRouteFromGRN = (grn: string) => {\n+  const { id, type } = getValuesFromGRN(grn);\n+\n+  switch (type) {\n+    case 'user':\n+      return Routes.SYSTEM.USERS.show(id);\n+    case 'team':\n+      return Routes.pluginRoute('SYSTEM_TEAMS_TEAMID')(id);", "originalCommit": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1MzA1Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r473753057", "bodyText": "Either you mock Routes.getPluginRoute for teams or you do not test it at all.\nSince you can't ensure that enterprise plugin is checked out. Especially for open source users.", "author": "kmerz", "createdAt": "2020-08-20T08:22:02Z", "path": "graylog2-web-interface/src/logic/permissions/GRN.test.js", "diffHunk": "@@ -0,0 +1,38 @@\n+// @flow strict\n+import Routes from 'routing/Routes';\n+\n+import { createGRN, getValuesFromGRN, getShowRouteFromGRN } from './GRN';\n+\n+describe('GRN', () => {\n+  it('createGRN should generate GRN with correct format', () => {\n+    expect(createGRN('dashboard', 'dashboard-id')).toBe('grn::::dashboard:dashboard-id');\n+  });\n+\n+  it('getValuesFromGRN should extract correct values from GRN', () => {\n+    expect(getValuesFromGRN('grn::::stream:stream-id')).toStrictEqual({\n+      resourceNameType: 'grn',\n+      cluster: undefined,\n+      tenent: undefined,\n+      scope: undefined,\n+      type: 'stream',\n+      id: 'stream-id',\n+    });\n+  });\n+\n+  describe('getShowRouteFromGRN should return correct route for', () => {\n+    const createsCorrectShowEntityURL = ({ grn, entityShowURL }) => {\n+      expect(getShowRouteFromGRN(grn)).toBe(entityShowURL);\n+    };\n+\n+    it.each`\n+      type            | grn                                 | entityShowURL\n+      ${'user'}       | ${'grn::::user:user-id'}            | ${Routes.SYSTEM.USERS.show('user-id')}\n+      ${'stream'}     | ${'grn::::stream:stream-id'}        | ${Routes.stream_search('stream-id')}\n+    `('type $type with grn $grn', createsCorrectShowEntityURL);\n+\n+    // We can test the following cases after we've adjusted the pluginRoute behaviour\n+    // ${'team'}       | ${'grn::::team:team-id'}            | ${Routes.pluginRoute('SYSTEM_TEAMS_TEAMID')('team-id')}", "originalCommit": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1MzU0MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8774#discussion_r473753540", "bodyText": "\"Routes.pluginRoute('DASHBOARDS_VIEWID')('dashboard-id')\"\nI would not do that ;)", "author": "kmerz", "createdAt": "2020-08-20T08:22:34Z", "path": "graylog2-web-interface/src/logic/permissions/GRN.test.js", "diffHunk": "@@ -0,0 +1,38 @@\n+// @flow strict\n+import Routes from 'routing/Routes';\n+\n+import { createGRN, getValuesFromGRN, getShowRouteFromGRN } from './GRN';\n+\n+describe('GRN', () => {\n+  it('createGRN should generate GRN with correct format', () => {\n+    expect(createGRN('dashboard', 'dashboard-id')).toBe('grn::::dashboard:dashboard-id');\n+  });\n+\n+  it('getValuesFromGRN should extract correct values from GRN', () => {\n+    expect(getValuesFromGRN('grn::::stream:stream-id')).toStrictEqual({\n+      resourceNameType: 'grn',\n+      cluster: undefined,\n+      tenent: undefined,\n+      scope: undefined,\n+      type: 'stream',\n+      id: 'stream-id',\n+    });\n+  });\n+\n+  describe('getShowRouteFromGRN should return correct route for', () => {\n+    const createsCorrectShowEntityURL = ({ grn, entityShowURL }) => {\n+      expect(getShowRouteFromGRN(grn)).toBe(entityShowURL);\n+    };\n+\n+    it.each`\n+      type            | grn                                 | entityShowURL\n+      ${'user'}       | ${'grn::::user:user-id'}            | ${Routes.SYSTEM.USERS.show('user-id')}\n+      ${'stream'}     | ${'grn::::stream:stream-id'}        | ${Routes.stream_search('stream-id')}\n+    `('type $type with grn $grn', createsCorrectShowEntityURL);\n+\n+    // We can test the following cases after we've adjusted the pluginRoute behaviour\n+    // ${'team'}       | ${'grn::::team:team-id'}            | ${Routes.pluginRoute('SYSTEM_TEAMS_TEAMID')('team-id')}\n+    // ${'dashboard'}  | ${'grn::::dashboard:dashboard-id'}  | ${Routes.pluginRoute('DASHBOARDS_VIEWID')('dashboard-id')}", "originalCommit": "bb15dabaae6e1c45cad981e5aafd4f3ce00c437c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bda40fb01a9181ca90cc2b684fd12ec8d1a85c77", "url": "https://github.com/Graylog2/graylog2-server/commit/bda40fb01a9181ca90cc2b684fd12ec8d1a85c77", "message": "Replace pluginRoute usage with getPluginRoute", "committedDate": "2020-08-20T08:37:10Z", "type": "commit"}]}