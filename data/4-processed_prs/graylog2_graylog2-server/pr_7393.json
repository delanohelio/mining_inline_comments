{"pr_number": 7393, "pr_title": "Migrate untyped views to dashboards, migrate widget filters to queries & push down query strings, time ranges & streams from query to widgets/search types", "pr_createdAt": "2020-02-05T10:17:32Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7393", "timeline": [{"oid": "9507e2dafb9a0a0300e91f3ebee51c7d5ba59222", "url": "https://github.com/Graylog2/graylog2-server/commit/9507e2dafb9a0a0300e91f3ebee51c7d5ba59222", "message": "Allowing relative paths with directory prefixes by changing check in importer.", "committedDate": "2020-02-04T15:44:40Z", "type": "commit"}, {"oid": "4cf3f66428473b473dd482dd9213d49af669b3ab", "url": "https://github.com/Graylog2/graylog2-server/commit/4cf3f66428473b473dd482dd9213d49af669b3ab", "message": "Adding migration for untyped views, turning them into dashboards.", "committedDate": "2020-02-04T15:44:52Z", "type": "commit"}, {"oid": "99987573d72a32df1a36ccafd7f6fa5c6465ac3d", "url": "https://github.com/Graylog2/graylog2-server/commit/99987573d72a32df1a36ccafd7f6fa5c6465ac3d", "message": "Concatenate existing query, add tests.", "committedDate": "2020-02-05T10:09:27Z", "type": "commit"}, {"oid": "c9b7f9d7466111e8d4eaf2bc7d217ca12c11ce26", "url": "https://github.com/Graylog2/graylog2-server/commit/c9b7f9d7466111e8d4eaf2bc7d217ca12c11ce26", "message": "Adding license headers.", "committedDate": "2020-02-05T10:18:10Z", "type": "commit"}, {"oid": "48d6eac5c1fcfc27b5052ac520eebd33180ccaf3", "url": "https://github.com/Graylog2/graylog2-server/commit/48d6eac5c1fcfc27b5052ac520eebd33180ccaf3", "message": "Extracting methods to make intentions clearer.", "committedDate": "2020-02-05T10:59:13Z", "type": "commit"}, {"oid": "361651c9d5da0aa1cad7d4b5f9e9e86bd8a506cc", "url": "https://github.com/Graylog2/graylog2-server/commit/361651c9d5da0aa1cad7d4b5f9e9e86bd8a506cc", "message": "Extracting query concatenation method.", "committedDate": "2020-02-05T12:47:18Z", "type": "commit"}, {"oid": "48afd2c96704f44c6a5a92e7fc931c852e300fc6", "url": "https://github.com/Graylog2/graylog2-server/commit/48afd2c96704f44c6a5a92e7fc931c852e300fc6", "message": "Restructure migration, merge query string from query of widget.", "committedDate": "2020-02-06T11:45:53Z", "type": "commit"}, {"oid": "7dd183d2edb3c4d8ad5b33d4e58951eccf981f70", "url": "https://github.com/Graylog2/graylog2-server/commit/7dd183d2edb3c4d8ad5b33d4e58951eccf981f70", "message": "Fixing handling of empty queries list.", "committedDate": "2020-02-06T12:37:34Z", "type": "commit"}, {"oid": "7754fc180b3081c197df1bedbeba8a4015c7fdac", "url": "https://github.com/Graylog2/graylog2-server/commit/7754fc180b3081c197df1bedbeba8a4015c7fdac", "message": "Extract and simplify types.", "committedDate": "2020-02-06T13:04:24Z", "type": "commit"}, {"oid": "59783ea2eee58eb0a8b076fd594ce30bcf083b4d", "url": "https://github.com/Graylog2/graylog2-server/commit/59783ea2eee58eb0a8b076fd594ce30bcf083b4d", "message": "Adapting tests and fixtures.", "committedDate": "2020-02-06T13:29:15Z", "type": "commit"}, {"oid": "348353bf66a9019def661f477383d38b5c035e97", "url": "https://github.com/Graylog2/graylog2-server/commit/348353bf66a9019def661f477383d38b5c035e97", "message": "Adding missing searches fixtures.", "committedDate": "2020-02-06T13:34:49Z", "type": "commit"}, {"oid": "8d9fd5e427d82d5d02401e12175fd6ffa3c3a9e6", "url": "https://github.com/Graylog2/graylog2-server/commit/8d9fd5e427d82d5d02401e12175fd6ffa3c3a9e6", "message": "Fixing type handling.", "committedDate": "2020-02-06T13:51:38Z", "type": "commit"}, {"oid": "743b297150bc0dc884624d0b5aeaed58ec916439", "url": "https://github.com/Graylog2/graylog2-server/commit/743b297150bc0dc884624d0b5aeaed58ec916439", "message": "Adapting tests to search type query/timerange sync.", "committedDate": "2020-02-06T14:18:07Z", "type": "commit"}, {"oid": "6efc4051899d01a924e4692463d5ed5ad6380df3", "url": "https://github.com/Graylog2/graylog2-server/commit/6efc4051899d01a924e4692463d5ed5ad6380df3", "message": "Adding license headers.", "committedDate": "2020-02-06T14:18:43Z", "type": "commit"}, {"oid": "6600fffbfb91977f4cb71d3c311bd47e4256a14a", "url": "https://github.com/Graylog2/graylog2-server/commit/6600fffbfb91977f4cb71d3c311bd47e4256a14a", "message": "Adding test case for merging query string/timerange from query.", "committedDate": "2020-02-06T14:36:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3MTgxMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376371810", "bodyText": "You can reuse the mergeQueryString method here.", "author": "alex-konn", "createdAt": "2020-02-07T12:44:51Z", "path": "graylog2-server/src/main/java/org/graylog/plugins/views/migrations/V20200204122000_MigrateUntypedViewsToDashboards/Widget.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.migrations.V20200204122000_MigrateUntypedViewsToDashboards;\n+\n+import org.bson.Document;\n+import org.elasticsearch.common.util.set.Sets;\n+\n+import java.util.Collections;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+class Widget {\n+    private static final String FIELD_FILTER = \"filter\";\n+    private static final String FIELD_QUERY = \"query\";\n+    private static final String FIELD_QUERY_STRING = \"query_string\";\n+    private static final String FIELD_TIMERANGE = \"timerange\";\n+    private static final String FIELD_STREAMS = \"streams\";\n+    private static final String FIELD_ID = \"id\";\n+\n+    private final Document widgetDocument;\n+\n+    Widget(Document widgetDocument) {\n+        this.widgetDocument = widgetDocument;\n+    }\n+\n+    void mergeFilterIntoQueryIfPresent() {\n+        filter().ifPresent(filter -> {\n+            widgetDocument.remove(FIELD_FILTER);\n+            final String newWidgetQuery = concatenateQueryIfExists(filter);\n+            setQueryString(newWidgetQuery);", "originalCommit": "6600fffbfb91977f4cb71d3c311bd47e4256a14a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5OTM1MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376399351", "bodyText": "\u2705", "author": "dennisoelkers", "createdAt": "2020-02-07T13:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3MTgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3OTY1Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376379653", "bodyText": "I think it would be even better to verify that nothing was even read. Not writing anything could result from either the migration having been completed before OR not finding any views in need of migration.\nNot crucial though.", "author": "alex-konn", "createdAt": "2020-02-07T13:06:05Z", "path": "graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200204122000_MigrateUntypedViewsToDashboardsTest.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.migrations;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoDatabase;\n+import org.bson.Document;\n+import org.graylog.plugins.views.migrations.V20200204122000_MigrateUntypedViewsToDashboards.V20200204122000_MigrateUntypedViewsToDashboards;\n+import org.graylog.testing.mongodb.MongoDBFixtures;\n+import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.graylog2.database.MongoConnection;\n+import org.graylog2.migrations.Migration;\n+import org.graylog2.plugin.cluster.ClusterConfigService;\n+import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.graylog.plugins.views.migrations.V20200204122000_MigrateUntypedViewsToDashboards.V20200204122000_MigrateUntypedViewsToDashboards.MigrationCompleted;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.internal.verification.VerificationModeFactory.times;\n+\n+public class V20200204122000_MigrateUntypedViewsToDashboardsTest {\n+    private static final String COLLECTION_VIEWS = \"views\";\n+    private static final String COLLECTION_SEARCHES = \"searches\";\n+\n+    @Rule\n+    public final MongoDBInstance mongodb = MongoDBInstance.createForClass();\n+    @Rule\n+    public final MockitoRule mockitoRule = MockitoJUnit.rule();\n+\n+    @Mock\n+    private ClusterConfigService clusterConfigService;\n+\n+    private final ObjectMapper objectMapper = new ObjectMapperProvider().get();\n+\n+    private Migration migration;\n+    private MongoCollection<Document> viewsCollection;\n+    private MongoCollection<Document> searchesCollection;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        this.viewsCollection = spy(mongodb.mongoConnection().getMongoDatabase().getCollection(COLLECTION_VIEWS));\n+        this.searchesCollection = spy(mongodb.mongoConnection().getMongoDatabase().getCollection(COLLECTION_SEARCHES));\n+        final MongoConnection mongoConnection = mock(MongoConnection.class);\n+        when(mongoConnection.getMongoDatabase()).thenReturn(mock(MongoDatabase.class));\n+        when(mongoConnection.getMongoDatabase().getCollection(COLLECTION_VIEWS)).thenReturn(viewsCollection);\n+        when(mongoConnection.getMongoDatabase().getCollection(COLLECTION_SEARCHES)).thenReturn(searchesCollection);\n+        this.migration = new V20200204122000_MigrateUntypedViewsToDashboards(mongoConnection, clusterConfigService);\n+    }\n+\n+    @Test\n+    public void runsIfNoViewsArePresent() {\n+        this.migration.upgrade();\n+    }\n+\n+    @Test\n+    public void writesMigrationCompletedAfterSuccess() {\n+        this.migration.upgrade();\n+\n+        final MigrationCompleted migrationCompleted = captureMigrationCompleted();\n+        assertThat(migrationCompleted.viewIds()).isEmpty();\n+    }\n+\n+    @Test\n+    public void doesNotRunAgainIfMigrationHadCompletedBefore() {\n+        when(clusterConfigService.get(MigrationCompleted.class)).thenReturn(MigrationCompleted.create(Collections.emptyList()));\n+\n+        this.migration.upgrade();\n+\n+        verify(clusterConfigService, never()).write(any());", "originalCommit": "6600fffbfb91977f4cb71d3c311bd47e4256a14a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwMTQxMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376401412", "bodyText": "\u2705", "author": "dennisoelkers", "createdAt": "2020-02-07T13:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3OTY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4NTQxNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376385415", "bodyText": "I think it would make sense to extract the assertion into another private method and convert checked exceptions into RuntimeExceptions there to get rid of all the throws declarations.", "author": "alex-konn", "createdAt": "2020-02-07T13:20:49Z", "path": "graylog2-server/src/test/java/org/graylog/plugins/views/migrations/V20200204122000_MigrateUntypedViewsToDashboardsTest.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.migrations;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoDatabase;\n+import org.bson.Document;\n+import org.graylog.plugins.views.migrations.V20200204122000_MigrateUntypedViewsToDashboards.V20200204122000_MigrateUntypedViewsToDashboards;\n+import org.graylog.testing.mongodb.MongoDBFixtures;\n+import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.graylog2.database.MongoConnection;\n+import org.graylog2.migrations.Migration;\n+import org.graylog2.plugin.cluster.ClusterConfigService;\n+import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.graylog.plugins.views.migrations.V20200204122000_MigrateUntypedViewsToDashboards.V20200204122000_MigrateUntypedViewsToDashboards.MigrationCompleted;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.internal.verification.VerificationModeFactory.times;\n+\n+public class V20200204122000_MigrateUntypedViewsToDashboardsTest {\n+    private static final String COLLECTION_VIEWS = \"views\";\n+    private static final String COLLECTION_SEARCHES = \"searches\";\n+\n+    @Rule\n+    public final MongoDBInstance mongodb = MongoDBInstance.createForClass();\n+    @Rule\n+    public final MockitoRule mockitoRule = MockitoJUnit.rule();\n+\n+    @Mock\n+    private ClusterConfigService clusterConfigService;\n+\n+    private final ObjectMapper objectMapper = new ObjectMapperProvider().get();\n+\n+    private Migration migration;\n+    private MongoCollection<Document> viewsCollection;\n+    private MongoCollection<Document> searchesCollection;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        this.viewsCollection = spy(mongodb.mongoConnection().getMongoDatabase().getCollection(COLLECTION_VIEWS));\n+        this.searchesCollection = spy(mongodb.mongoConnection().getMongoDatabase().getCollection(COLLECTION_SEARCHES));\n+        final MongoConnection mongoConnection = mock(MongoConnection.class);\n+        when(mongoConnection.getMongoDatabase()).thenReturn(mock(MongoDatabase.class));\n+        when(mongoConnection.getMongoDatabase().getCollection(COLLECTION_VIEWS)).thenReturn(viewsCollection);\n+        when(mongoConnection.getMongoDatabase().getCollection(COLLECTION_SEARCHES)).thenReturn(searchesCollection);\n+        this.migration = new V20200204122000_MigrateUntypedViewsToDashboards(mongoConnection, clusterConfigService);\n+    }\n+\n+    @Test\n+    public void runsIfNoViewsArePresent() {\n+        this.migration.upgrade();\n+    }\n+\n+    @Test\n+    public void writesMigrationCompletedAfterSuccess() {\n+        this.migration.upgrade();\n+\n+        final MigrationCompleted migrationCompleted = captureMigrationCompleted();\n+        assertThat(migrationCompleted.viewIds()).isEmpty();\n+    }\n+\n+    @Test\n+    public void doesNotRunAgainIfMigrationHadCompletedBefore() {\n+        when(clusterConfigService.get(MigrationCompleted.class)).thenReturn(MigrationCompleted.create(Collections.emptyList()));\n+\n+        this.migration.upgrade();\n+\n+        verify(clusterConfigService, never()).write(any());\n+        verify(this.viewsCollection, never()).updateOne(any(), any());\n+        verify(this.searchesCollection, never()).updateOne(any(), any());\n+    }\n+\n+    @Test\n+    @MongoDBFixtures(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_widgets_with_filter.json\")\n+    public void migratesWidgetFiltersToWidgetQueries() throws Exception {\n+        this.migration.upgrade();\n+\n+        assertViewsMigrated(\"5c8a613a844d02001a1fd2f4\");\n+\n+        assertSavedViews(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_widgets_with_filter-views_after.json\"));\n+        assertSavedSearches(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_widgets_with_filter-searches_after.json\"));\n+    }\n+\n+    @Test\n+    @MongoDBFixtures(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_widgets_with_filter_and_query.json\")\n+    public void migratesWidgetFiltersToWidgetQueriesAndConcatenatesToExistingQuery() throws Exception {\n+        this.migration.upgrade();\n+\n+        assertViewsMigrated(\"5c8a613a844d02001a1fd2f4\");\n+\n+        assertSavedViews(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_widgets_with_filter_and_query-views_after.json\"));\n+        assertSavedSearches(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_widgets_with_filter_and_query-searches_after.json\"));\n+    }\n+\n+    @Test\n+    @MongoDBFixtures(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_no_widgets.json\")\n+    public void migratesUntypedViewWithNoWidgets() throws Exception {\n+        this.migration.upgrade();\n+\n+        assertViewsMigrated(\"5c8a613a844d02001a1fd2f4\");\n+\n+        assertSavedViews(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_no_widgets-views_after.json\"));\n+        assertSavedSearches(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/untyped_view_with_no_widgets-searches_after.json\"));\n+    }\n+\n+    @Test\n+    @MongoDBFixtures(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/typed_views.json\")\n+    public void doesNotChangeTypedViews() throws Exception {\n+        this.migration.upgrade();\n+\n+        final MigrationCompleted migrationCompleted = captureMigrationCompleted();\n+        assertThat(migrationCompleted.viewIds()).isEmpty();\n+\n+        verify(this.viewsCollection, never()).updateOne(any(), any());\n+        verify(this.searchesCollection, never()).updateOne(any(), any());\n+    }\n+\n+    @Test\n+    @MongoDBFixtures(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/mixed_typed_and_untyped_views.json\")\n+    public void migratesOnlyUntypedViewsIfMixedOnesArePresent() throws Exception {\n+        this.migration.upgrade();\n+\n+        assertViewsMigrated(\"5c8a613a844d02001a1fd2f4\");\n+\n+        assertSavedViews(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/mixed_typed_and_untyped_views-views_after.json\"));\n+        assertSavedSearches(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/mixed_typed_and_untyped_views-searches_after.json\"));\n+    }\n+\n+    @Test\n+    @MongoDBFixtures(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/query_with_query_string.json\")\n+    public void migratesQueryStringFromQueryIntoWidgetsAndSearchTypes() throws Exception {\n+        this.migration.upgrade();\n+\n+        assertViewsMigrated(\"5c8a613a844d02001a1fd2f4\");\n+\n+        assertSavedViews(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/query_with_query_string-views_after.json\"));\n+        assertSavedSearches(1, resourceFile(\"V20200204122000_MigrateUntypedViewsToDashboardsTest/query_with_query_string-searches_after.json\"));\n+    }\n+\n+    private void assertViewsMigrated(String... viewId) {\n+        final MigrationCompleted migrationCompleted = captureMigrationCompleted();\n+        assertThat(migrationCompleted.viewIds()).containsExactlyInAnyOrder(viewId);\n+    }\n+\n+    private void assertSavedViews(int count, String viewsCollection) throws Exception {\n+        assertEntityCollection(count, viewsCollection, this.viewsCollection);\n+    }\n+\n+    private void assertSavedSearches(int count, String searchesCollection) throws Exception {\n+        assertEntityCollection(count, searchesCollection, this.searchesCollection);\n+    }\n+\n+    private void assertEntityCollection(int count, String expectedCollection, MongoCollection<Document> actualCollection) throws Exception {\n+        final ArgumentCaptor<Document> newEntitiesCaptor = ArgumentCaptor.forClass(Document.class);\n+        verify(actualCollection, times(count)).updateOne(any(), newEntitiesCaptor.capture());\n+        final List<Document> newEntities = newEntitiesCaptor.getAllValues();\n+        assertThat(newEntities).hasSize(count);\n+\n+        JSONAssert.assertEquals(expectedCollection, toJSON(newEntities), true);", "originalCommit": "6600fffbfb91977f4cb71d3c311bd47e4256a14a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwMzg4NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376403884", "bodyText": "\u2705", "author": "dennisoelkers", "createdAt": "2020-02-07T14:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4NTQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4Njk4Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376386983", "bodyText": "Maybe it's just me, but I think searchTypesByIds implies a map keyed by ID and would prefer the name searchTypesForIds.", "author": "alex-konn", "createdAt": "2020-02-07T13:24:19Z", "path": "graylog2-server/src/main/java/org/graylog/plugins/views/migrations/V20200204122000_MigrateUntypedViewsToDashboards/Query.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.plugins.views.migrations.V20200204122000_MigrateUntypedViewsToDashboards;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.graph.Traverser;\n+import org.bson.Document;\n+\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+import static com.google.common.base.MoreObjects.firstNonNull;\n+import static java.util.stream.Collectors.toSet;\n+\n+class Query {\n+    private static final String FIELD_ID = \"id\";\n+    private static final String FIELD_FILTER = \"filter\";\n+    private static final String FIELD_SEARCH_TYPE_ID = \"id\";\n+    private static final String FIELD_SEARCH_TYPES = \"search_types\";\n+    private static final String FIELD_QUERY = \"query\";\n+    private static final String FIELD_QUERY_STRING = \"query_string\";\n+    private static final String FIELD_TIMERANGE = \"timerange\";\n+    private static final String FIELD_SUB_FILTERS = \"filters\";\n+    private static final String FIELD_FILTER_TYPE = \"type\";\n+    private static final String TYPE_STREAM_FILTER = \"stream\";\n+    private static final String FIELD_STREAM_ID = \"id\";\n+\n+    private final Document queryDocument;\n+\n+    Query(Document queryDocument) {\n+        this.queryDocument = queryDocument;\n+    }\n+\n+    String id() {\n+        return this.queryDocument.getString(FIELD_ID);\n+    }\n+\n+    private Set<SearchType> searchTypesByIds(Set<String> searchTypeIds) {", "originalCommit": "6600fffbfb91977f4cb71d3c311bd47e4256a14a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwNDM0Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7393#discussion_r376404343", "bodyText": "\u2705", "author": "dennisoelkers", "createdAt": "2020-02-07T14:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4Njk4Mw=="}], "type": "inlineReview"}, {"oid": "4ca248ffa4a2e4d596f3edc6d8d3dd74f6eb75a3", "url": "https://github.com/Graylog2/graylog2-server/commit/4ca248ffa4a2e4d596f3edc6d8d3dd74f6eb75a3", "message": "Reusing `mergeQueryString`.", "committedDate": "2020-02-07T13:50:58Z", "type": "commit"}, {"oid": "fdc4cad3c5c8b6b1ce74e752c7488dc270c6a1a2", "url": "https://github.com/Graylog2/graylog2-server/commit/fdc4cad3c5c8b6b1ce74e752c7488dc270c6a1a2", "message": "Verifying nothing has been read by migration.", "committedDate": "2020-02-07T13:54:01Z", "type": "commit"}, {"oid": "1305ca3495e6afd1e34b3c55e81a97d548f0164a", "url": "https://github.com/Graylog2/graylog2-server/commit/1305ca3495e6afd1e34b3c55e81a97d548f0164a", "message": "Verifying something has actually been read by migration.", "committedDate": "2020-02-07T13:55:24Z", "type": "commit"}, {"oid": "3e63717fb4ee9c866f292cb44e8ca40cb1d294f1", "url": "https://github.com/Graylog2/graylog2-server/commit/3e63717fb4ee9c866f292cb44e8ca40cb1d294f1", "message": "Rethrowing side exceptions of assertion unchecked.", "committedDate": "2020-02-07T14:00:19Z", "type": "commit"}, {"oid": "4023ed1a7562c0f767152cee1274ae9f520d23b1", "url": "https://github.com/Graylog2/graylog2-server/commit/4023ed1a7562c0f767152cee1274ae9f520d23b1", "message": "Changing method name to make purpose clearer.", "committedDate": "2020-02-07T14:01:17Z", "type": "commit"}, {"oid": "10823e43e13d763c7f155fe26fd92fe75210c1ec", "url": "https://github.com/Graylog2/graylog2-server/commit/10823e43e13d763c7f155fe26fd92fe75210c1ec", "message": "Using `Collection` when reading lists/sets from mongo.", "committedDate": "2020-02-07T14:13:34Z", "type": "commit"}]}