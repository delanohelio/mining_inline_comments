{"pr_number": 9063, "pr_title": "Refactor Search Page Components.", "pr_createdAt": "2020-10-01T07:49:42Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9063", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwOTUyOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500309528", "bodyText": "There is still a history.push in SavedSearchControls:162 which does the same and is no longer needed. I found it because I got the warning Saving view failed: TypeError: Cannot read property 'then' of undefined after creating a new saved search.\nloadView returned a Promise before these changes, but I could not find another case where this could be a problem.", "author": "linuspahl", "createdAt": "2020-10-06T14:04:22Z", "path": "graylog2-web-interface/src/views/logic/views/Actions.js", "diffHunk": "@@ -0,0 +1,15 @@\n+// @flow strict\n+import history from 'util/History';\n+import Routes from 'routing/Routes';\n+\n+export const loadNewView = () => {\n+  return history.push(`${Routes.SEARCH}/new`);\n+};\n+\n+export const loadNewViewForStream = (streamId: string) => {\n+  return history.push(`${Routes.stream_search(streamId)}/new`);\n+};\n+\n+export const loadView = (viewId: string) => {\n+  return history.push(`${Routes.SEARCH}/${viewId}`);", "originalCommit": "336c8f3f6c559127e9c906014cc6d84ca096f513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzMTY4Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500831682", "bodyText": "\u2705", "author": "dennisoelkers", "createdAt": "2020-10-07T08:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwOTUyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMDc4Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500310782", "bodyText": "It was a little bit confusing, that the SavedSearchPage component is being used for the NewSearchPage and StreamSearchPage what about the name SearchPage?", "author": "linuspahl", "createdAt": "2020-10-06T14:05:37Z", "path": "graylog2-web-interface/src/views/pages/SavedSearchPage.jsx", "diffHunk": "@@ -0,0 +1,31 @@\n+// @flow strict\n+import * as React from 'react';\n+\n+import ViewLoaderContext from 'views/logic/ViewLoaderContext';\n+import NewViewLoaderContext from 'views/logic/NewViewLoaderContext';\n+import { ExtendedSearchPage } from 'views/pages';\n+import { loadNewView as defaultLoadNewView, loadView as defaultLoadView } from 'views/logic/views/Actions';\n+import IfUserHasAccessToAnyStream from 'views/components/IfUserHasAccessToAnyStream';\n+\n+type Props = {\n+  loadNewView?: () => mixed,\n+  loadView?: (string) => mixed,\n+  route: any,\n+};\n+\n+const SavedSearchPage = ({ loadNewView = defaultLoadNewView, loadView = defaultLoadView, route }: Props) => (", "originalCommit": "336c8f3f6c559127e9c906014cc6d84ca096f513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1ODA4OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500358089", "bodyText": "Having a look at the code I had the following idea. This is a summary of all suggestions. We could:\n\nrename this component to SearchPage\nimplement the SearchPage for the NewDashboardPage. In this case we would use the SearchPage for every search page. A side effect would be, that the ExtendedSearchPage is only being used inside the SearchPage.\nrename ExtendedSearchPage to e.g. just Search and move it from pages to components/search\n\nThis way the relation between the search pages and the search would be easier to understand, imo.", "author": "linuspahl", "createdAt": "2020-10-06T14:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMDc4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyNDk4MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500824981", "bodyText": "Excellent idea, thanks!", "author": "dennisoelkers", "createdAt": "2020-10-07T08:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMDc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxNDM3MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500314371", "bodyText": "When I reset a saved search, I get redirected to /search/new.", "author": "linuspahl", "createdAt": "2020-10-06T14:09:18Z", "path": "graylog2-web-interface/src/views/logic/views/Actions.js", "diffHunk": "@@ -0,0 +1,15 @@\n+// @flow strict\n+import history from 'util/History';\n+import Routes from 'routing/Routes';\n+\n+export const loadNewView = () => {\n+  return history.push(`${Routes.SEARCH}/new`);", "originalCommit": "336c8f3f6c559127e9c906014cc6d84ca096f513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg0MTQyNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500841424", "bodyText": "I just realised this is the desired behaviour, please ignore this comment.", "author": "linuspahl", "createdAt": "2020-10-07T08:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxNDM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzMzQ4MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500333481", "bodyText": "For the ShowViewPage, which is being used for saved dashboards, we are using the SavedSearchPage.\nI am wondering if we should implement the SavedSearchPage for this component as well.\nWe do not need the ViewLoaderContext and NewViewLoaderContext, but we would use IfUserHasAccessToAnyStream here as well. Or am I missing a reason why we should not use IfUserHasAccessToAnyStream here?", "author": "linuspahl", "createdAt": "2020-10-06T14:28:43Z", "path": "graylog2-web-interface/src/views/pages/NewDashboardPage.jsx", "diffHunk": "@@ -1,63 +1,44 @@\n // @flow strict\n-import React, { useEffect, useState } from 'react';\n+import * as React from 'react';\n+import { useMemo } from 'react';\n import PropTypes from 'prop-types';\n \n import Spinner from 'components/common/Spinner';\n-import type { ViewHook } from 'views/logic/hooks/ViewHook';\n-import { processHooks } from 'views/logic/views/ViewLoader';\n import withPluginEntities from 'views/logic/withPluginEntities';\n import viewTransformer from 'views/logic/views/ViewTransformer';\n import { ViewActions } from 'views/stores/ViewStore';\n import View from 'views/logic/views/View';\n-import type { ViewJson } from 'views/logic/views/View';\n import { ExtendedSearchPage } from 'views/pages';\n import { IfPermitted } from 'components/common';\n+import useLoadView from 'views/logic/views/UseLoadView';\n \n type Props = {\n   route: {},\n   location: {\n     state?: {\n-      view?: View | ViewJson,\n+      view?: View,\n     },\n     query: { [string]: any },\n-  };\n-  loadingViewHooks: Array<ViewHook>,\n-  executingViewHooks: Array<ViewHook>,\n+  },\n };\n-const NewDashboardPage = ({ route, location, loadingViewHooks, executingViewHooks }: Props) => {\n-  const [loaded, setLoaded] = useState(false);\n-  const [hookComponent, setHookComponent] = useState(undefined);\n \n-  useEffect(() => {\n-    let mounted = true;\n-    const { state = {} } = location;\n-    const { view: searchView } = state;\n-\n-    if (searchView && searchView.search) {\n-      const { query } = location;\n-      /* $FlowFixMe the searchView.search is guard enough and instanceof does not work here */\n+const NewDashboardPage = ({ route, location }: Props) => {", "originalCommit": "336c8f3f6c559127e9c906014cc6d84ca096f513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzMTk3Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9063#discussion_r500831973", "bodyText": "\u2705", "author": "dennisoelkers", "createdAt": "2020-10-07T08:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzMzQ4MQ=="}], "type": "inlineReview"}, {"oid": "1e864d4d2abd9294aab367e63c43d50f494d800a", "url": "https://github.com/Graylog2/graylog2-server/commit/1e864d4d2abd9294aab367e63c43d50f494d800a", "message": "Renaming `SavedSearchPage` to `SearchPage`.", "committedDate": "2020-10-07T07:53:57Z", "type": "forcePushed"}, {"oid": "b3d5ce1c48c59c535aa82dd64976ee3c302a9953", "url": "https://github.com/Graylog2/graylog2-server/commit/b3d5ce1c48c59c535aa82dd64976ee3c302a9953", "message": "Avoid unnecessary search execution when starting/loading search.\n\nBefore this change, starting a new or loading an existing search\ntriggered a search job execution at least twice. This leads to\nunnecessary load and might even be the cause for bugs which are hard to\nreproduce (#8820).\n\nThis change is removing two unneeded search executions during mount.\nBoth are factually unneeded, as the initial search execution after\nloading the saved search is performed in `_refreshIfNotUndeclared`.", "committedDate": "2020-10-07T12:53:24Z", "type": "commit"}, {"oid": "652d6f6ca7b152ddca1dc4115dd81f9e48e484a5", "url": "https://github.com/Graylog2/graylog2-server/commit/652d6f6ca7b152ddca1dc4115dd81f9e48e484a5", "message": "Removing unneeded import, fixing linter hint.", "committedDate": "2020-10-07T12:53:24Z", "type": "commit"}, {"oid": "915f31447c4cecfd4e8efc5a403422c89490e0ad", "url": "https://github.com/Graylog2/graylog2-server/commit/915f31447c4cecfd4e8efc5a403422c89490e0ad", "message": "Removing unneeded import.", "committedDate": "2020-10-07T12:53:24Z", "type": "commit"}, {"oid": "f7bc413c05beb7dbb38667c8070fda9895343931", "url": "https://github.com/Graylog2/graylog2-server/commit/f7bc413c05beb7dbb38667c8070fda9895343931", "message": "Removing unneeded search reexecution in `StreamSearchPage`.", "committedDate": "2020-10-07T12:53:24Z", "type": "commit"}, {"oid": "2adfc5eb1069c6ab96db0683c6dd4f55a03be023", "url": "https://github.com/Graylog2/graylog2-server/commit/2adfc5eb1069c6ab96db0683c6dd4f55a03be023", "message": "Removing unneeded import.", "committedDate": "2020-10-07T12:53:24Z", "type": "commit"}, {"oid": "4d51851d0274e874c772111431d703c977d13857", "url": "https://github.com/Graylog2/graylog2-server/commit/4d51851d0274e874c772111431d703c977d13857", "message": "Replacing search page component view loading logic with custom hooks.", "committedDate": "2020-10-07T12:54:48Z", "type": "commit"}, {"oid": "a6a488f7374eed738afcaf50d36ed4c9dff883b3", "url": "https://github.com/Graylog2/graylog2-server/commit/a6a488f7374eed738afcaf50d36ed4c9dff883b3", "message": "Fix view creation for stream search page.", "committedDate": "2020-10-07T12:54:48Z", "type": "commit"}, {"oid": "f296b6862e85add37cb49439ebdabdea86f0de11", "url": "https://github.com/Graylog2/graylog2-server/commit/f296b6862e85add37cb49439ebdabdea86f0de11", "message": "Extract new saved search creation to `useCreateSavedSearch` hook.", "committedDate": "2020-10-07T12:54:48Z", "type": "commit"}, {"oid": "f7683bcd7d5a07d90ef0ac751171e73d670512cd", "url": "https://github.com/Graylog2/graylog2-server/commit/f7683bcd7d5a07d90ef0ac751171e73d670512cd", "message": "Memoize plugin store result to avoid rerendering.", "committedDate": "2020-10-07T12:54:48Z", "type": "commit"}, {"oid": "004f078a737c869304901a2e102ec28b7fd83089", "url": "https://github.com/Graylog2/graylog2-server/commit/004f078a737c869304901a2e102ec28b7fd83089", "message": "Avoid rendering hook component twice.", "committedDate": "2020-10-07T12:54:48Z", "type": "commit"}, {"oid": "c919d5446533f9d1fbd4400b2b46803b43f83e72", "url": "https://github.com/Graylog2/graylog2-server/commit/c919d5446533f9d1fbd4400b2b46803b43f83e72", "message": "Extracting common contexts to shared component.", "committedDate": "2020-10-07T12:55:52Z", "type": "commit"}, {"oid": "57089348ed236d36b60ab8433a0c596971e0b0cd", "url": "https://github.com/Graylog2/graylog2-server/commit/57089348ed236d36b60ab8433a0c596971e0b0cd", "message": "Reinit loaded/hookComponent states, do not depend on query.", "committedDate": "2020-10-07T12:55:52Z", "type": "commit"}, {"oid": "67a64c50235cabde010d85900df2399b8419229f", "url": "https://github.com/Graylog2/graylog2-server/commit/67a64c50235cabde010d85900df2399b8419229f", "message": "Fixing \"Reset search\" across normal and stream search.", "committedDate": "2020-10-07T12:55:52Z", "type": "commit"}, {"oid": "fd09b109d4f680b9a73f47370b1b778c98694c7a", "url": "https://github.com/Graylog2/graylog2-server/commit/fd09b109d4f680b9a73f47370b1b778c98694c7a", "message": "Adjusting `NewDashboardPage` test.", "committedDate": "2020-10-07T12:55:52Z", "type": "commit"}, {"oid": "c4b439d9b89fe1e6bc9d50b09315615a57b6c0d9", "url": "https://github.com/Graylog2/graylog2-server/commit/c4b439d9b89fe1e6bc9d50b09315615a57b6c0d9", "message": "Calling action from context.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "6731390400c2b50d32a33082d4779760816586e3", "url": "https://github.com/Graylog2/graylog2-server/commit/6731390400c2b50d32a33082d4779760816586e3", "message": "Removing now unneeded test case.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "3bf9bfc645eaceee7a9b97e6eb1304bf6847bf34", "url": "https://github.com/Graylog2/graylog2-server/commit/3bf9bfc645eaceee7a9b97e6eb1304bf6847bf34", "message": "Adjusting tests to changes and simplifying them.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "d80d58506344b5c7119ffdccae7f6b5107562418", "url": "https://github.com/Graylog2/graylog2-server/commit/d80d58506344b5c7119ffdccae7f6b5107562418", "message": "Simplifying tests.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "66c3debcfb5e8b0518638ca3ae68429f8cd2b558", "url": "https://github.com/Graylog2/graylog2-server/commit/66c3debcfb5e8b0518638ca3ae68429f8cd2b558", "message": "Simplifying mocking.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "b8871d7fe5d60a00d6428b1ad9c80d8a532666f0", "url": "https://github.com/Graylog2/graylog2-server/commit/b8871d7fe5d60a00d6428b1ad9c80d8a532666f0", "message": "Removing unused imports.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "9004346f93cc45e85abaf3338a45be4821d857ac", "url": "https://github.com/Graylog2/graylog2-server/commit/9004346f93cc45e85abaf3338a45be4821d857ac", "message": "Remove unused `useFetchView` hook.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "f54c5ee584f71e84b3e3be8931a9b434bb40c450", "url": "https://github.com/Graylog2/graylog2-server/commit/f54c5ee584f71e84b3e3be8931a9b434bb40c450", "message": "Replacing `withPluginEntities` with `usePluginEntities`.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "42b9bd2cea569dfe54abd6fe9409333012c23707", "url": "https://github.com/Graylog2/graylog2-server/commit/42b9bd2cea569dfe54abd6fe9409333012c23707", "message": "Disabling linter hint, as we do want to execute the effect only once.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "2294b2fa92d7b3b80cb2f48140ced6152fe54749", "url": "https://github.com/Graylog2/graylog2-server/commit/2294b2fa92d7b3b80cb2f48140ced6152fe54749", "message": "Removing unused variable.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "7e5cfeb5d1c59e46606bd20f6fc183eb38f83226", "url": "https://github.com/Graylog2/graylog2-server/commit/7e5cfeb5d1c59e46606bd20f6fc183eb38f83226", "message": "Disabling linter hints, as we do not want to take `query` changes into account.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "422ef8b32f1b0699a6ffa5ab38c7b2697a840197", "url": "https://github.com/Graylog2/graylog2-server/commit/422ef8b32f1b0699a6ffa5ab38c7b2697a840197", "message": "Revert \"Disabling linter hint, as we do want to execute the effect only once.\"\n\nThis reverts commit a3fd93406a67b9345d501c76ada898d6dc520990.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "195160473c28bd9a8bf1c8c8d820ad656379fe57", "url": "https://github.com/Graylog2/graylog2-server/commit/195160473c28bd9a8bf1c8c8d820ad656379fe57", "message": "Pulling out destructuring, adding actual state element to dependencies.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "e7c65f241ed6ba6d4fdbe1b109666052261c537c", "url": "https://github.com/Graylog2/graylog2-server/commit/e7c65f241ed6ba6d4fdbe1b109666052261c537c", "message": "Removing unused type and unneeded guard/FlowFixMe.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "fe03f9b8c32a8b1559f035e09bc46e77c3c01488", "url": "https://github.com/Graylog2/graylog2-server/commit/fe03f9b8c32a8b1559f035e09bc46e77c3c01488", "message": "Removing unused variable.", "committedDate": "2020-10-07T12:55:53Z", "type": "commit"}, {"oid": "d464cda3e24a5884ae22c00d8d7e3894fa04eef4", "url": "https://github.com/Graylog2/graylog2-server/commit/d464cda3e24a5884ae22c00d8d7e3894fa04eef4", "message": "Leaving in guard to support test.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "a4dddf3f9cdcec6ca27cbbf991bde9e46b243728", "url": "https://github.com/Graylog2/graylog2-server/commit/a4dddf3f9cdcec6ca27cbbf991bde9e46b243728", "message": "Renaming `SavedSearchPage` to `SearchPage`.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "93b1645f7a49cc21b0793760548b07e23186d8b7", "url": "https://github.com/Graylog2/graylog2-server/commit/93b1645f7a49cc21b0793760548b07e23186d8b7", "message": "Renaming `ExtendedSearchPage` to `Search`, adjusting tests.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "1a54cbf55c098f8bc62550d793830debddd97b22", "url": "https://github.com/Graylog2/graylog2-server/commit/1a54cbf55c098f8bc62550d793830debddd97b22", "message": "Reusing `SearchPage` in `NewDashboardPage`.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "c4df9c5205312f5afe7b2f89ddcfa8b2ba157c77", "url": "https://github.com/Graylog2/graylog2-server/commit/c4df9c5205312f5afe7b2f89ddcfa8b2ba157c77", "message": "Close modal before redirecting, remove duplicate redirect.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "1813e2d249fa8e282a6e5f0d8fa147219a09c09d", "url": "https://github.com/Graylog2/graylog2-server/commit/1813e2d249fa8e282a6e5f0d8fa147219a09c09d", "message": "Small cleanup.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "65a634a9099477d9169b69c4567422e5d31bd071", "url": "https://github.com/Graylog2/graylog2-server/commit/65a634a9099477d9169b69c4567422e5d31bd071", "message": "Reverting adding `return`.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "36c433777ea422f1520a74d7089f6d341f096169", "url": "https://github.com/Graylog2/graylog2-server/commit/36c433777ea422f1520a74d7089f6d341f096169", "message": "User needs at least one stream now.", "committedDate": "2020-10-07T12:55:54Z", "type": "commit"}, {"oid": "36c433777ea422f1520a74d7089f6d341f096169", "url": "https://github.com/Graylog2/graylog2-server/commit/36c433777ea422f1520a74d7089f6d341f096169", "message": "User needs at least one stream now.", "committedDate": "2020-10-07T12:55:54Z", "type": "forcePushed"}]}