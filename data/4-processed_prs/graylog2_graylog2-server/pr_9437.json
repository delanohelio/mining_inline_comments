{"pr_number": 9437, "pr_title": "Prevent disabling your own user account", "pr_createdAt": "2020-11-11T09:32:11Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9437", "timeline": [{"oid": "e1f62911ab3b5769a19d488e7eb50813ab514f74", "url": "https://github.com/Graylog2/graylog2-server/commit/e1f62911ab3b5769a19d488e7eb50813ab514f74", "message": "Prevent disabling your own user account\n\n## Motivation\nPrior to this change, a logged in user was able to disable himself (if\nhe had the necessary permissions).\n\n## Description\nThis change will hide the menu item `Enable`/`Disable` for the user\nhimself.\n\n## Also\nAdd a confirmation dialog for disabling user which explains that\ndisabling a user also stops its current session.", "committedDate": "2020-11-11T09:28:45Z", "type": "commit"}, {"oid": "09f80bddf2a25eeb93e959902b53e7c8ef6c9732", "url": "https://github.com/Graylog2/graylog2-server/commit/09f80bddf2a25eeb93e959902b53e7c8ef6c9732", "message": "Add backend code to prevent users from setting their own status", "committedDate": "2020-11-11T09:58:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1MjA3Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#discussion_r521252077", "bodyText": "We have @Context UserContext userContext for this now.", "author": "mpfz0r", "createdAt": "2020-11-11T10:11:47Z", "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/users/UsersResource.java", "diffHunk": "@@ -556,11 +557,17 @@ public void changePassword(\n     @ApiOperation(\"Update the account status for a user\")\n     @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n     public Response updateAccountStatus(\n-            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true) @PathParam(\"userId\") String userId,\n+            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true)\n+            @PathParam(\"userId\") @NotBlank String userId,\n             @ApiParam(name = \"newStatus\", value = \"The account status to be set\", required = true,\n-                    defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n+                      defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n             @PathParam(\"newStatus\") @NotBlank String newStatusString) throws ValidationException {\n \n+        final User currentUser = requireNonNull(getCurrentUser(), \"currentUser cannot be null\");", "originalCommit": "09f80bddf2a25eeb93e959902b53e7c8ef6c9732", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1MzQwMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#discussion_r521253403", "bodyText": "Hah, you are right! \ud83d\ude04 I will change it. Thank you!", "author": "bernd", "createdAt": "2020-11-11T10:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1MjA3Nw=="}], "type": "inlineReview"}, {"oid": "42db1c9085452ddc77753212a63b2522dbfb72d4", "url": "https://github.com/Graylog2/graylog2-server/commit/42db1c9085452ddc77753212a63b2522dbfb72d4", "message": "Use UserContext instead of getCurrentUser()", "committedDate": "2020-11-11T10:15:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxNDQwOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9437#discussion_r521314408", "bodyText": "When disabling a user and closing the confirm dialog, UsersDomain.setStatus(id, 'enabled'); is being called and the API responds with Error: Not Modified", "author": "linuspahl", "createdAt": "2020-11-11T12:10:37Z", "path": "graylog2-web-interface/src/components/users/UsersOverview/UserOverviewItem/ActionsCell.jsx", "diffHunk": "@@ -50,9 +52,17 @@ const ReadOnlyActions = ({ user }: { user: UserOverview }) => {\n };\n \n const EditActions = ({ user, user: { username, id, fullName, accountStatus, external, readOnly } }: { user: UserOverview }) => {\n+  const currentUser = useContext(CurrentUserContext) || {};\n+\n   const _toggleStatus = () => {\n-    const newStatus = accountStatus === 'enabled' ? 'disabled' : 'enabled';\n-    UsersDomain.setStatus(id, newStatus);\n+    // eslint-disable-next-line no-alert\n+    if (accountStatus === 'enabled' && window.confirm(`Do you really want to disable user ${fullName}? All current sessions will be terminated.`)) {\n+      UsersDomain.setStatus(id, 'disabled');\n+\n+      return;\n+    }\n+\n+    UsersDomain.setStatus(id, 'enabled');", "originalCommit": "42db1c9085452ddc77753212a63b2522dbfb72d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f261df3d36da612454341abb9cbd02b3f4802b00", "url": "https://github.com/Graylog2/graylog2-server/commit/f261df3d36da612454341abb9cbd02b3f4802b00", "message": "Break out of the funtion if confirmation was not given", "committedDate": "2020-11-11T15:05:22Z", "type": "commit"}]}