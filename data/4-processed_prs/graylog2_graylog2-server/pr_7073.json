{"pr_number": 7073, "pr_title": "Fix issue when clicking on Roles menu after clicking \"Create role\" button", "pr_createdAt": "2020-01-02T15:02:18Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7073", "timeline": [{"oid": "0a883ac60211745ea03bc843bb35ffa7b5492579", "url": "https://github.com/Graylog2/graylog2-server/commit/0a883ac60211745ea03bc843bb35ffa7b5492579", "message": "Use default state on EditRole when using role menu\n\n* Refactore Component to use class instead of createReactClass\n* use getDerivedStateFromProps instead of componentWillReceiveProps\n* set default state if any is provided", "committedDate": "2020-01-02T14:33:33Z", "type": "commit"}, {"oid": "1db62019be425b125a5b72afa3f2f32135b86d94", "url": "https://github.com/Graylog2/graylog2-server/commit/1db62019be425b125a5b72afa3f2f32135b86d94", "message": "Merge branch 'master' into issue-5908", "committedDate": "2020-01-20T11:03:57Z", "type": "commit"}, {"oid": "dc8e58d5afcaa94157ea6935205e05756517077d", "url": "https://github.com/Graylog2/graylog2-server/commit/dc8e58d5afcaa94157ea6935205e05756517077d", "message": "Initialize state", "committedDate": "2020-01-20T11:15:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NTI5OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7073#discussion_r368555299", "bodyText": "Since we use getDerivedStateFromProps to initialize an \"empty\" role, and getDerivedStateFromProps is called before the first render and before any subsequent update is rendered, I think the constructor can be simplified and doesn't need to handle the default case.\nSo I think we can simplify this logic doing the following:\n\nIn the constructor, we set the role to the initialRole, since we are also using that to get the initialName\nIn getDerivedStateFromProps we check if prevState.role is set, and if it is not set we initialize it to the \"empty\" role", "author": "edmundoa", "createdAt": "2020-01-20T13:46:52Z", "path": "graylog2-web-interface/src/components/users/EditRole.jsx", "diffHunk": "@@ -1,85 +1,77 @@\n import PropTypes from 'prop-types';\n import React from 'react';\n-import createReactClass from 'create-react-class';\n import Immutable from 'immutable';\n \n import { Button, Alert, Col, ControlLabel, FormGroup, HelpBlock, Row } from 'components/graylog';\n import { Input } from 'components/bootstrap';\n import PermissionSelector from 'components/users/PermissionSelector';\n-import PermissionsMixin from 'util/PermissionsMixin';\n \n-const EditRole = createReactClass({\n-  displayName: 'EditRole',\n-\n-  propTypes: {\n-    initialRole: PropTypes.object.isRequired,\n-    onSave: PropTypes.func.isRequired,\n-    cancelEdit: PropTypes.func.isRequired,\n-    streams: PropTypes.object.isRequired,\n-    dashboards: PropTypes.object.isRequired,\n-  },\n-\n-  mixins: [PermissionsMixin],\n-\n-  getInitialState() {\n+class EditRole extends React.Component {\n+  constructor(props) {\n+    super(props);\n     const { initialRole } = this.props;\n-\n     let role = initialRole;\n-    if (role === null) {\n-      // for the create dialog\n+    if (!role) {\n       role = {\n         name: null,\n         description: null,\n         permissions: [],\n       };\n     }\n-    return {\n+    this.state = {\n       role,\n       initialName: this._safeRoleName(initialRole),\n     };\n-  },\n+  }\n \n-  componentWillReceiveProps(newProps) {\n-    this.setState({ role: newProps.initialRole, initialName: this._safeRoleName(newProps.initialRole) });\n-  },\n+  static getDerivedStateFromProps(nextProps, prevState) {\n+    const {\n+      role = {", "originalCommit": "dc8e58d5afcaa94157ea6935205e05756517077d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU5NDU1Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7073#discussion_r368594552", "bodyText": "Ok for that, added the update", "author": "ousmaneo", "createdAt": "2020-01-20T15:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NTI5OQ=="}], "type": "inlineReview"}, {"oid": "32ddfbce3f5265faf1333515be216b8aaed7fa33", "url": "https://github.com/Graylog2/graylog2-server/commit/32ddfbce3f5265faf1333515be216b8aaed7fa33", "message": "Refactoring", "committedDate": "2020-01-20T15:04:21Z", "type": "commit"}]}