{"pr_number": 7110, "pr_title": "Add URL whitelist service (#6854 and #6915)", "pr_createdAt": "2020-01-08T11:00:42Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7110", "timeline": [{"oid": "90c71ac4c82b87efbc96061f9c1d26898d0861d7", "url": "https://github.com/Graylog2/graylog2-server/commit/90c71ac4c82b87efbc96061f9c1d26898d0861d7", "message": "Backport: Add URL whitelist service (#6854)\n\n* Initial support for reading and writing url whitelist via REST API\n\n* Add permissions for reading and writing url whitelist\n\n* Fire audit event for url whitelist change\n\n* Implement matching strings against whitelist\n\n* Add shortcut method for whitelist check\n\n* Bind url whitelist service as singleton\n\n* Use whitelist service in JSON path data adapter\n\n* Use whitelist service in DSV HTTP data adapter\n\n* Use whitelist service for HTTP event notifications\n\n* Improve error propagation\n\nWhen the URL is not whitelisted, we want that error to be exposed so\nthat it can be displayed on the frontend. When the url becomes\nwhitelisted, we want the error to go away and any previous or new errors\nrelated to parsing the DSV file or requesting the file should be\nexposed.\n\nTo make this work reliably, we have to make sure that in case of a\nwhitelist error the file is fetched again so that the errors related\nto file fetching and/or processing surface again. Also we want errors\nrelated to parsing the file show up in the UI, which was not the case\nbefore when the file became corrupted at the source when the data\nadapter was already running. Those errors would only show up when the\ndata adapter was (re-)started.\n\n* Provide REST endpoint for checking URLs against the whitelist\n\n* Add @NoAuditEvent annotation to validation endpoint\n\n* Check URL whitelist when validating data adapters\n\n* Add license headers\n\n* Add migration to create initial whitelist\n\n* Add missing jackson annotations\n\n* Add system notification on whitelist failure\n\nSet a system notification when a url doesn't pass the whitelist check\nduring operation.\n\n* Indicate whitelist problem with JSONPath adapter by setting error\n\nUse the same mechanism as with the DSV over HTTP adapter to indicate\nthat a whitelist error happened.\n\n* Add \"id\" and \"title\" fields to whitelist entries.\n\n* Add ability to disable a whitelist\n\n* Add basic content pack support for url whitelist entries\n\n* Add simple caching of whitelist in whitelist service\n\nSimply try not to fetch the whitelist from mongo DB each time it is\nrequested. May fetch the whitelist from the DB more often than it needs\nto but we'll accept that in favor of adding synchronization.\n\n* Add REST endpoint to validate java regular expressions\n\n* Add service to conveniently publish url whitelist failure notifications\n\n* Use annotations in rest resource for permission checks and validation\n\n* Add whitelist checks and migration for URL in legacy http alarm callback\n\nDid not add a system notification for runtime whitelist failures of this\n kind as this wouldn't be straight forward. This is legacy code so we\n should be ok without this.\n\n* Use AutoValue classes for whitelist entries. Make \"title\" required\n\n* Clear cached whitelist on write.\n\nCluster events don't propagate fast enough, so we have a race condition\nwhen saving subsequently on the same node. Mitigate that by clearing the\n cache explicitly.\n\nReferences #6853\n\n(cherry picked from commit f0c9374b9f32670c354857715ffbc08d1a65d146)\n\nConflicts:\n\tgraylog2-server/src/main/java/org/graylog2/contentpacks/ContentPacksModule.java\n\tgraylog2-server/src/main/java/org/graylog2/contentpacks/model/ModelTypes.java\n\tgraylog2-server/src/main/java/org/graylog2/lookup/LookupModule.java\n\tgraylog2-server/src/main/java/org/graylog2/lookup/adapters/HTTPJSONPathDataAdapter.java\n\tgraylog2-server/src/main/java/org/graylog2/migrations/MigrationsModule.java\n\tgraylog2-server/src/main/java/org/graylog2/rest/resources/system/lookup/LookupTableResource.java", "committedDate": "2020-01-08T10:31:15Z", "type": "commit"}, {"oid": "d5daf5164d98d8d5b8f7a2934b6e844b063a4a74", "url": "https://github.com/Graylog2/graylog2-server/commit/d5daf5164d98d8d5b8f7a2934b6e844b063a4a74", "message": "Backport: Implement ui for url white lists configuration (#6915)\n\n*  Update Stores & Actions to add Whitelist configuration\n\n This change allows to query and update Whitelist configuration.\n * Update ConfigurationsStore and ConfigurationActions\n * refactor ConfigurationsStore to be used with `connect` f:unction\n\n* Add UrlWhitelist component to list and update\n\nThis change allow listing existing whitelist on configurations page\nand add functionality to add, remove, update whitelist.\n\n* Add UrlWhiteListConfig component\n* Add UrlWhitelist list action to ConfigurationsPage\n* Load UrlWhitelistConfig on ConfigurationsPage\n(#6853)\n\n* Fix eslint.\n\n* Refactor code to fix eslint issue\n\n* Add Flow type to component and helper function\n\n* Add migration to create initial whitelist\n\n* Add missing jackson annotations\n\n* Add system notification on whitelist failure\n\nSet a system notification when a url doesn't pass the whitelist check\nduring operation.\n\n* Indicate whitelist problem with JSONPath adapter by setting error\n\nUse the same mechanism as with the DSV over HTTP adapter to indicate\nthat a whitelist error happened.\n\n* Extract url whitelist to its own component\n\n* Refactor UrlWhiteListConfig component\n* create new UrlWhitelistForm Component\n\n* Add flow type\n\n* Add type ConfigurationsStore to allow reusability\n* Update UrlWhiteListConfig to use imported types\n* Add flow to UrlWhitelistForm\n\n* Add \"id\" and \"title\" fields to whitelist entries.\n\n* Add ability to disable a whitelist\n\n* Fix eslint.\n\n* Refactor code to fix eslint issue\n\n* Add Flow type to component and helper function\n\n* Extract url whitelist to its own component\n\n* Refactor UrlWhiteListConfig component\n* create new UrlWhitelistForm Component\n\n* Update whitelist form with new field\n\n* use uuid to generate url id.\n* Add fields id, title to url\n* Add field disable to whitelist config\n* update flowtypes\n\n* Clone state before change to avoid mutation\n\n* Add basic content pack support for url whitelist entries\n\n* Refactor UrlWhitelist to use single state\n* Add form validation to Whitelist form\n* Add Url and regex validation function\n* check the state and validate each row in the form\n\n* Fix linter\n\n* Add uuid as key for tr list\n\n* Add test for UrlWhiteListConfig Component\n\n* Replace regex url validation with native URL api\n\n* Add REST endpoint to validate java regular expressions\n\n* Add regex validate to toolStore and refactore validation\n\n* Update urlwhitelist form to include regex validation:\n\n* Refactor validation to validate regex server side\n* Add error message on validation failure\n\n* Fix linter\n\n* Add some test for UrlWhitelist form\n\n* fix issue with render not updating ui\n* add bsSize to modal to make it large\n* add more tests\n\n* Replace UrlWhiteList component with relative import\n* Update File name in imports\n\n* Update import in UrlConfig Component\n\n* remove test snapshot\n\n* Update test snapsots\n\n* Fix flow issue for bootstrapModalForm ref\n\n* Organize imports\n\n* Fix unable to save config issue\n\nBefore this change adding a row on the form, leaving it not valid\nand then deleting it was making the form enable to save.\n* Remove field from validation state if it deleted\n\n*  Fix variable case\n\n* Rename update function to onUpdate.\n\n* Update prop types for onUpdate function\n\n* Refactor state name to use config and setConfig\n\n* Remove unnecessary title modal\n\n* Add second button on top of table\n\n* Update tests and snapshots\n\n* Add permissions checking\n\n* Fix case\n\n* Disable form submit if not valid\n\n* rename valid to isValid.\n\n* Add better error message\n\n* Clean JSX, remove unused tag and properties\n\n* Replace ObjectUtils.clone with lodash.cloneDeep\n\n* add required field error messages\n\n* Add debounce to validate for regex validationState\n\n* Add style to form table number cell\n\n* add style to table number cell\n\n* Remove obsolete fields.\n\n* Make variable final.\n\n* Fix typo and update snapshot\n\n* Replace \"literal\" with \"Exact match\"\n\n* remove unnecessary eslint comments and properties\n\n* Fix debounce function and update snapshot\n\n* Add help message for urlwhitelist config\n\n* Update snapshot\n\n* Use combinedProvider for store and actions\n\n* Move const outside of class\n\n* Fix url type case\n\n* Update snapshot\n* replace Icon Component with i html tag\nCo-authored-by: Othello Maurer <othello@graylog.com>", "committedDate": "2020-01-08T15:29:18Z", "type": "commit"}, {"oid": "833f2697cbc00211586831343496e019ea24c4f1", "url": "https://github.com/Graylog2/graylog2-server/commit/833f2697cbc00211586831343496e019ea24c4f1", "message": "fix linter", "committedDate": "2020-01-08T15:46:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MTIwNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7110#discussion_r364861204", "bodyText": "Adding this store may be problematic, since 3.1. still had the old Typescript ToolStore.ts (see #6766 for the PR doing that change).\nI think it should be possible to keep this new JS version of the store and remove the old Typescript store, but we should ensure that only one of them is there, otherwise I'm not sure which one the import is going to get.", "author": "edmundoa", "createdAt": "2020-01-09T17:13:17Z", "path": "graylog2-web-interface/src/stores/tools/ToolsStore.js", "diffHunk": "@@ -0,0 +1,166 @@\n+// @flow strict\n+import Reflux from 'reflux';\n+\n+import fetch from 'logic/rest/FetchProvider';\n+import ApiRoutes from 'routing/ApiRoutes';\n+import URLUtils from 'util/URLUtils';\n+import UserNotification from 'util/UserNotification';\n+\n+const ToolsStore = Reflux.createStore({", "originalCommit": "833f2697cbc00211586831343496e019ea24c4f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d05d8623ece424816d60871660fc17fa928a5402", "url": "https://github.com/Graylog2/graylog2-server/commit/d05d8623ece424816d60871660fc17fa928a5402", "message": " Remove unused ToolsStore.ts", "committedDate": "2020-01-10T14:04:22Z", "type": "commit"}, {"oid": "e15213b6ba60e32caada97f42f3b418c2f824fb1", "url": "https://github.com/Graylog2/graylog2-server/commit/e15213b6ba60e32caada97f42f3b418c2f824fb1", "message": "Fix issue with search page not showing", "committedDate": "2020-01-13T07:58:22Z", "type": "commit"}]}