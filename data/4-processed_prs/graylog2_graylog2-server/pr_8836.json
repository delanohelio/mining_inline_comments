{"pr_number": 8836, "pr_title": "Display confirm dialog on entity share modal save if grantees select is not empty", "pr_createdAt": "2020-08-20T12:18:13Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8836", "timeline": [{"oid": "42a1661ce3551d7fb7f6288ebedcc06d5d01c440", "url": "https://github.com/Graylog2/graylog2-server/commit/42a1661ce3551d7fb7f6288ebedcc06d5d01c440", "message": "Display confirm dialog on entity share modal save if grantees select is not empty", "committedDate": "2020-08-20T12:20:27Z", "type": "forcePushed"}, {"oid": "0e248401c1bd7f0fa5f8ebee6a6a05c2118dedeb", "url": "https://github.com/Graylog2/graylog2-server/commit/0e248401c1bd7f0fa5f8ebee6a6a05c2118dedeb", "message": "Reset grantees selector after form submit", "committedDate": "2020-08-20T15:25:20Z", "type": "forcePushed"}, {"oid": "8179bf9955ab8f653093790a6c7a8be4344dc148", "url": "https://github.com/Graylog2/graylog2-server/commit/8179bf9955ab8f653093790a6c7a8be4344dc148", "message": "Display confirm dialog on entity share modal save if grantees select is not empty", "committedDate": "2020-08-20T15:40:39Z", "type": "commit"}, {"oid": "b45529f6e687677bee3d301ffb763d39ba59da1e", "url": "https://github.com/Graylog2/graylog2-server/commit/b45529f6e687677bee3d301ffb763d39ba59da1e", "message": "Reset grantees selector after form submit", "committedDate": "2020-08-20T15:40:39Z", "type": "commit"}, {"oid": "b45529f6e687677bee3d301ffb763d39ba59da1e", "url": "https://github.com/Graylog2/graylog2-server/commit/b45529f6e687677bee3d301ffb763d39ba59da1e", "message": "Reset grantees selector after form submit", "committedDate": "2020-08-20T15:40:39Z", "type": "forcePushed"}, {"oid": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc", "url": "https://github.com/Graylog2/graylog2-server/commit/151b256a2aedfe26c852a35edcdf9a6679c2ccbc", "message": "Enable submit button after save is finished", "committedDate": "2020-08-21T08:03:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDUzODUyNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8836#discussion_r474538525", "bodyText": "I tried to add a more complex test but this is not possible with due to the mocking and usage of the EntityShareStore. We will be able to handle the mocking better when we use the return value of our actions inside the EntityShareModal instead of the state from the EntityShareState", "author": "linuspahl", "createdAt": "2020-08-21T08:49:36Z", "path": "graylog2-web-interface/src/components/permissions/EntityShareModal.jsx", "diffHunk": "@@ -25,18 +25,40 @@ const EntityShareModal = ({ description, entityId, entityType, entityTitle, onCl\n   const { state: entityShareState } = useStore(EntityShareStore);\n   const [disableSubmit, setDisableSubmit] = useState(false);\n   const entityGRN = createGRN(entityType, entityId);\n+  const granteesSelectRef = useRef();\n \n   useEffect(() => {\n     EntityShareActions.prepare(entityGRN);\n   }, [entityGRN]);\n \n   const _handleSave = () => {\n     setDisableSubmit(true);\n+    const granteesSelect = granteesSelectRef?.current;\n+    const garnteesSelectValue = granteesSelect?.state?.value;\n+    const granteesSelectOptions = granteesSelect?.props?.options;\n     const payload: EntitySharePayload = {\n       selected_grantee_capabilities: entityShareState.selectedGranteeCapabilities,\n     };\n \n-    return EntityShareActions.update(entityGRN, payload).then(onClose);\n+    if (garnteesSelectValue) {\n+      const selectedOption = granteesSelectOptions?.find((option) => option.value === garnteesSelectValue);\n+\n+      if (!selectedOption) {\n+        throw Error(`Can't find ${garnteesSelectValue} in grantees select options on save`);\n+      }\n+\n+      // eslint-disable-next-line no-alert\n+      if (!window.confirm(`\"${selectedOption.label}\" got selected but was never added as a collaborator. Do you want to continue anyway?`)) {\n+        setDisableSubmit(false);\n+\n+        return;\n+      }\n+    }\n+\n+    EntityShareActions.update(entityGRN, payload).then(() => {\n+      setDisableSubmit(true);\n+      onClose();\n+    });", "originalCommit": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY0MjQwOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8836#discussion_r474642408", "bodyText": "What about we do throw an error if we are running in development and ignore it if we are in production?", "author": "kmerz", "createdAt": "2020-08-21T11:37:11Z", "path": "graylog2-web-interface/src/components/permissions/EntityShareModal.jsx", "diffHunk": "@@ -25,18 +25,40 @@ const EntityShareModal = ({ description, entityId, entityType, entityTitle, onCl\n   const { state: entityShareState } = useStore(EntityShareStore);\n   const [disableSubmit, setDisableSubmit] = useState(false);\n   const entityGRN = createGRN(entityType, entityId);\n+  const granteesSelectRef = useRef();\n \n   useEffect(() => {\n     EntityShareActions.prepare(entityGRN);\n   }, [entityGRN]);\n \n   const _handleSave = () => {\n     setDisableSubmit(true);\n+    const granteesSelect = granteesSelectRef?.current;\n+    const garnteesSelectValue = granteesSelect?.state?.value;\n+    const granteesSelectOptions = granteesSelect?.props?.options;\n     const payload: EntitySharePayload = {\n       selected_grantee_capabilities: entityShareState.selectedGranteeCapabilities,\n     };\n \n-    return EntityShareActions.update(entityGRN, payload).then(onClose);\n+    if (garnteesSelectValue) {\n+      const selectedOption = granteesSelectOptions?.find((option) => option.value === garnteesSelectValue);\n+\n+      if (!selectedOption) {\n+        throw Error(`Can't find ${garnteesSelectValue} in grantees select options on save`);", "originalCommit": "151b256a2aedfe26c852a35edcdf9a6679c2ccbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}