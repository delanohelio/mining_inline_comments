{"pr_number": 7071, "pr_title": "Handle Request Entity Too Large errors in ElasticSearchOutput", "pr_createdAt": "2020-01-02T11:21:42Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7071", "timeline": [{"oid": "7facbb2b0ebf33bc8e587f60c1ab322b865f6e83", "url": "https://github.com/Graylog2/graylog2-server/commit/7facbb2b0ebf33bc8e587f60c1ab322b865f6e83", "message": "Handle Request Entity Too Large errors in ElasticSearchOutput\n\nIf we try to bulk index a batch of messages that exceeds the\nelastic search `bulk_max_body_size` setting. (default 100MB)\nElastic will respond with an HTTP 413 Entity Too Large error.\n\nIn this case we retry the request by splitting the message batch\nin half.\n\nWhen responding with an HTTP 413 error, the server is allowed to close the connection\nimmediately. This means that our HTTP client (Jest) will simply report\nan IOException (Broken pipe) instead of the actual error.\nThis can be avoided by sending the request with an Expect-Continue\nheader, which also avoids sending data that will be discarded later on.\n\nFixes #5091", "committedDate": "2020-01-03T16:24:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMzOTMwOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7071#discussion_r364339309", "bodyText": "I noticed the following in the documentation for RequestConfig#isExpectContinueEnabled():\n\n'Expect: 100-continue' handshake should be used with caution, as it may cause problems with HTTP servers and proxies that do not support HTTP/1.1 protocol.\n\nSo I wonder if we should make this configurable in graylog.conf? (default: enabled) Otherwise we cannot do anything if a user has a broken proxy in front of Elasticsearch.", "author": "bernd", "createdAt": "2020-01-08T17:00:37Z", "path": "graylog2-server/src/main/java/org/graylog2/indexer/messages/Messages.java", "diffHunk": "@@ -185,7 +238,9 @@ private void recordTimestamp(List<Map.Entry<IndexSet, Message>> messageList, Set\n \n     private BulkResult runBulkRequest(final Bulk request, int count) {\n         try {\n-            return BULK_REQUEST_RETRYER.call(() -> client.execute(request));\n+            // Enable Expect-Continue to catch 413 errors before we send the actual data\n+            final RequestConfig requestConfig = RequestConfig.custom().setExpectContinueEnabled(true).build();", "originalCommit": "6383ac8c537138e216ca6334b511dd127936c74a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIyMDMzMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7071#discussion_r365220333", "bodyText": "good idea. I've added an option", "author": "mpfz0r", "createdAt": "2020-01-10T12:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMzOTMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM1NzA1Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7071#discussion_r364357057", "bodyText": "I think this implementation assumes that the messages inside messageList are uniformly sized.\nLet's say we have a body limit of 10 MB and we have a messageList with message sizes of [1 MB, 1 MB, 1 MB, 10 MB]. If we run this, we will get a 413 for the first try and split the message list into two partitions. The first partition (two messages) will be successfully written to ES but for the second partition we will get a 413 response from ES again. Then we throw an EntityTooLargeException and start over indexing all messages again.\nThis will result in duplicated messages.\nOne possible solution could be to store the offset of the successfully written messages in the EntityTooLargeException and then use List#subList() to only pass in the remaining messages into bulkIndexChunked().\nThis would still not handle the issue that failedItems of successful bulk requests would be lost. (we could include them in the exception as well...)\nThere might be a better way.", "author": "bernd", "createdAt": "2020-01-08T17:40:34Z", "path": "graylog2-server/src/main/java/org/graylog2/indexer/messages/Messages.java", "diffHunk": "@@ -137,40 +142,88 @@ public ResultMessage get(String messageId, String index) throws DocumentNotFound\n             return Collections.emptyList();\n         }\n \n-        final Bulk.Builder bulk = new Bulk.Builder();\n-        for (Map.Entry<IndexSet, Message> entry : messageList) {\n-            final Message message = entry.getValue();\n-            if (isSystemTraffic) {\n-                systemTrafficCounter.inc(message.getSize());\n-            } else {\n-                outputByteCounter.inc(message.getSize());\n+        int chunkSize = messageList.size();\n+        List<BulkResult.BulkResultItem> failedItems = new ArrayList<>();\n+        for (;;) {\n+            try {\n+                failedItems = bulkIndexChunked(messageList, isSystemTraffic, chunkSize);\n+                break; // on success\n+            } catch (EntityTooLargeException e) {\n+                LOG.warn(\"Bulk index failed with 'Request Entity Too Large' error. Retrying by splitting up batch size <{}>.\", chunkSize);\n+                if (chunkSize == messageList.size()) {\n+                    LOG.warn(\"Consider lowering the \\\"output_batch_size\\\" setting.\");\n+                }\n+                chunkSize /= 2;\n+            }\n+            if (chunkSize == 0) {\n+                throw new ElasticsearchException(\"Bulk index cannot split output batch any further.\");\n             }\n-\n-            bulk.addAction(new Index.Builder(message.toElasticSearchObject(invalidTimestampMeter))\n-                .index(entry.getKey().getWriteIndexAlias())\n-                .type(IndexMapping.TYPE_MESSAGE)\n-                .id(message.getId())\n-                .build());\n         }\n \n-        final BulkResult result = runBulkRequest(bulk.build(), messageList.size());\n-        final List<BulkResult.BulkResultItem> failedItems = result.getFailedItems();\n-\n-        if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"Index: Bulk indexed {} messages, took {} ms, failures: {}\",\n-                    result.getItems().size(), result, failedItems.size());\n-        }\n \n         if (!failedItems.isEmpty()) {\n             final Set<String> failedIds = failedItems.stream().map(item -> item.id).collect(Collectors.toSet());\n             recordTimestamp(messageList, failedIds);\n-            return propagateFailure(failedItems, messageList, result.getErrorMessage());\n+            return propagateFailure(failedItems, messageList);\n         } else {\n             recordTimestamp(messageList, Collections.emptySet());\n             return Collections.emptyList();\n         }\n     }\n \n+    private List<BulkResult.BulkResultItem> bulkIndexChunked(final List<Map.Entry<IndexSet, Message>> messageList, boolean isSystemTraffic, int chunkSize) throws EntityTooLargeException {\n+        chunkSize = Math.min(messageList.size(), chunkSize);\n+\n+        final List<BulkResult.BulkResultItem> failedItems = new ArrayList<>();\n+        final Iterable<List<Map.Entry<IndexSet, Message>>> partition = Iterables.partition(messageList, chunkSize);\n+        int partitionCount = 1;\n+        for (List<Map.Entry<IndexSet, Message>> subMessageList: partition) {", "originalCommit": "6383ac8c537138e216ca6334b511dd127936c74a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE4MjI1MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7071#discussion_r365182251", "bodyText": "Good catch! I've made some changes to handle this.", "author": "mpfz0r", "createdAt": "2020-01-10T11:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM1NzA1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2MjkzMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7071#discussion_r364362930", "bodyText": "I think we don't exclude the failed IDs because we don't know if we can retry the failed messages. If we have a message that couldn't be written to ES due to a data type error and we don't commit its offset, then it will be retried over and over again. Okay, in practice it will most probably not because that would require the message to be the last one.\nBut then it also doesn't make sense to exclude the offset either because if the faulty message is in the middle of a batch and we commit the last offset, it's gone anyway.", "author": "bernd", "createdAt": "2020-01-08T17:54:05Z", "path": "graylog2-server/src/main/java/org/graylog2/outputs/ElasticSearchOutput.java", "diffHunk": "@@ -112,6 +112,7 @@ public void writeMessageEntries(List<Map.Entry<IndexSet, Message>> messageList)\n         }\n         failures.mark(failedMessageIds.size());\n \n+        // TODO why doesn't this exclude the failedMessageIds?", "originalCommit": "6383ac8c537138e216ca6334b511dd127936c74a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE4MjYzOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7071#discussion_r365182638", "bodyText": "fair enough. should I add that to the comment?", "author": "mpfz0r", "createdAt": "2020-01-10T11:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2MjkzMA=="}], "type": "inlineReview"}, {"oid": "e95fb74d6592e9d1cdc188e1a80ee72db52fb555", "url": "https://github.com/Graylog2/graylog2-server/commit/e95fb74d6592e9d1cdc188e1a80ee72db52fb555", "message": "Handle Request Entity Too Large errors in ElasticSearchOutput\n\nIf we try to bulk index a batch of messages that exceeds the\nelastic search `http.max_content_length` setting. (default 100MB)\nElastic will respond with an HTTP 413 Entity Too Large error.\n\nIn this case we retry the request by splitting the message batch\nin half.\n\nWhen responding with an HTTP 413 error, the server is allowed to close the connection\nimmediately. This means that our HTTP client (Jest) will simply report\nan IOException (Broken pipe) instead of the actual error.\nThis can be avoided by sending the request with an Expect-Continue\nheader, which also avoids sending data that will be discarded later on.\n\nFixes #5091", "committedDate": "2020-01-10T12:50:29Z", "type": "commit"}, {"oid": "23bd997806c78e6a5767362989e01f57642e2f13", "url": "https://github.com/Graylog2/graylog2-server/commit/23bd997806c78e6a5767362989e01f57642e2f13", "message": "Please forbiddenapi checker", "committedDate": "2020-01-10T12:51:24Z", "type": "commit"}, {"oid": "5c358f7505b1db2f0493d533783dfd6dc5c5073a", "url": "https://github.com/Graylog2/graylog2-server/commit/5c358f7505b1db2f0493d533783dfd6dc5c5073a", "message": "Try splitting up batch until we reach size 1", "committedDate": "2020-01-10T12:51:24Z", "type": "commit"}, {"oid": "bce63d3266338e2a0f6a8c2e7cccd9fa523e3b8a", "url": "https://github.com/Graylog2/graylog2-server/commit/bce63d3266338e2a0f6a8c2e7cccd9fa523e3b8a", "message": "Move JestClient execution with RequestConfig into JestUtils", "committedDate": "2020-01-10T12:51:24Z", "type": "commit"}, {"oid": "462e9d841d94fe542b3bf28c47460f25e914de2d", "url": "https://github.com/Graylog2/graylog2-server/commit/462e9d841d94fe542b3bf28c47460f25e914de2d", "message": "Please forbiddenapi checker", "committedDate": "2020-01-10T12:51:24Z", "type": "commit"}, {"oid": "a6bd60c395bb171f9aa283db30b2c4bcd87a8785", "url": "https://github.com/Graylog2/graylog2-server/commit/a6bd60c395bb171f9aa283db30b2c4bcd87a8785", "message": "Correctly handle batches with unevenly sized messages\n\nIf we have a batch where only the messages at the end will\nexceed the Entity Too Large limit, we could end up duplicating\nmessages.\nThus keep track of the already indexed offset and report it within the\nEntityTooLargeException.", "committedDate": "2020-01-10T12:51:24Z", "type": "commit"}, {"oid": "69edda28c43f6d3eb1e9e27da3a6ca448a34f378", "url": "https://github.com/Graylog2/graylog2-server/commit/69edda28c43f6d3eb1e9e27da3a6ca448a34f378", "message": "Make use of Expect: 100-continue header configurable", "committedDate": "2020-01-10T12:51:24Z", "type": "commit"}, {"oid": "69edda28c43f6d3eb1e9e27da3a6ca448a34f378", "url": "https://github.com/Graylog2/graylog2-server/commit/69edda28c43f6d3eb1e9e27da3a6ca448a34f378", "message": "Make use of Expect: 100-continue header configurable", "committedDate": "2020-01-10T12:51:24Z", "type": "forcePushed"}, {"oid": "9f62a04797ba49bd13f10853be52d29efcf2d356", "url": "https://github.com/Graylog2/graylog2-server/commit/9f62a04797ba49bd13f10853be52d29efcf2d356", "message": "clarify comment", "committedDate": "2020-01-10T13:31:21Z", "type": "commit"}, {"oid": "203cf38c26e4d621bac992f9e29bc8268e56df18", "url": "https://github.com/Graylog2/graylog2-server/commit/203cf38c26e4d621bac992f9e29bc8268e56df18", "message": "Don't loose failedItems if we hit the error path twice", "committedDate": "2020-01-10T15:00:42Z", "type": "commit"}]}