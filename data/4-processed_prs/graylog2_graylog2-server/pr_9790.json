{"pr_number": 9790, "pr_title": "Add HTML emails compatibility for alerts notifications", "pr_createdAt": "2020-12-13T15:05:26Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9790", "timeline": [{"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "url": "https://github.com/Graylog2/graylog2-server/commit/1507fc14e23380fe6f07ada0d949df8fe9c9499f", "message": "Add HTML emails compatibility for alerts notifications", "committedDate": "2020-12-13T15:57:41Z", "type": "commit"}, {"oid": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "url": "https://github.com/Graylog2/graylog2-server/commit/1507fc14e23380fe6f07ada0d949df8fe9c9499f", "message": "Add HTML emails compatibility for alerts notifications", "committedDate": "2020-12-13T15:57:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxMjc4MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551812781", "bodyText": "We need to make sure that older content packs (without this field) are still installable.\nI suggest you initialize the htmlBodyTemplate in the Builder.create()\nhttps://github.com/Graylog2/graylog2-server/pull/9790/files#diff-455b0c407c9c4eac48cf30ae314d1e2222e29fb27954534f291d6a84b3facf87L70\n.htmlBodyTemplate(ValueReference.of(\"\"))", "author": "mpfz0r", "createdAt": "2021-01-05T09:28:23Z", "path": "graylog2-server/src/main/java/org/graylog/events/contentpack/entities/EmailEventNotificationConfigEntity.java", "diffHunk": "@@ -50,6 +51,9 @@\n     @JsonProperty(FIELD_BODY_TEMPLATE)\n     public abstract ValueReference bodyTemplate();\n \n+    @JsonProperty(FIELD_HTML_BODY_TEMPLATE)\n+    public abstract ValueReference htmlBodyTemplate();", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDYwNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551814606", "bodyText": "This should be an empty String by default. We don't want to automatically upgrade existing notifications to HTML.", "author": "mpfz0r", "createdAt": "2021-01-05T09:31:46Z", "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailEventNotificationConfig.java", "diffHunk": "@@ -134,7 +166,8 @@ public static Builder create() {\n                     .subject(DEFAULT_SUBJECT)\n                     .emailRecipients(ImmutableSet.of())\n                     .userRecipients(ImmutableSet.of())\n-                    .bodyTemplate(DEFAULT_BODY_TEMPLATE);\n+                    .bodyTemplate(DEFAULT_BODY_TEMPLATE)\n+                    .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDgwMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551814800", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .htmlBodyTemplate(DEFAULT_HTML_BODY_TEMPLATE);\n          \n          \n            \n                                .htmlBodyTemplate(\"\");", "author": "mpfz0r", "createdAt": "2021-01-05T09:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNDYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNjA3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551816079", "bodyText": "I think we should respect that user's wish and not fill in the default body if that is left empty.\n(see next comment on how I would handle this)", "author": "mpfz0r", "createdAt": "2021-01-05T09:34:31Z", "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java", "diffHunk": "@@ -104,6 +103,21 @@ private String buildBody(EmailEventNotificationConfig config, Map<String, Object\n         return this.templateEngine.transform(template, model);\n     }\n \n+    @VisibleForTesting\n+    private String buildHtmlBody(EmailEventNotificationConfig config, Map<String, Object> model) {\n+        final String template;\n+        if (isNullOrEmpty(config.htmlBodyTemplate())) {", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNjQxOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551816418", "bodyText": "How about we keep using SimpleEmail if the html body is empty?", "author": "mpfz0r", "createdAt": "2021-01-05T09:35:07Z", "path": "graylog2-server/src/main/java/org/graylog/events/notifications/types/EmailSender.java", "diffHunk": "@@ -115,7 +129,7 @@ private void sendEmail(EmailEventNotificationConfig config, String emailAddress,\n             throw new TransportConfigurationException(\"Email transport is not enabled in server configuration file!\");\n         }\n \n-        final Email email = new SimpleEmail();\n+        final HtmlEmail email = new HtmlEmail();", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNzY0OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551817648", "bodyText": "Since we are now defaulting to an empty html body on the server side, we can actually remove that TODO,\nand also remove the DEFAULT_HTML_BODY_TEMPLATE from EmailEventNotificationConfig", "author": "mpfz0r", "createdAt": "2021-01-05T09:37:21Z", "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/EmailNotificationForm.jsx", "diffHunk": "@@ -50,6 +50,37 @@ Last messages accounting for this alert:\n \\${end}\n `;\n \n+// TODO: Default html body template should come from the server\n+const DEFAULT_HTML_BODY_TEMPLATE = `<table width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\" style=\"background-color:#f9f9f9;border:none;line-height:1.2\"><tbody>", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNzc3Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551817772", "bodyText": "same", "author": "mpfz0r", "createdAt": "2021-01-05T09:37:40Z", "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/EmailNotificationForm.jsx", "diffHunk": "@@ -63,6 +94,7 @@ class EmailNotificationForm extends React.Component {\n     // eslint-disable-next-line no-template-curly-in-string\n     subject: 'Graylog event notification: ${event_definition_title}', // TODO: Default subject should come from the server\n     body_template: DEFAULT_BODY_TEMPLATE, // TODO: Default body template should come from the server\n+    html_body_template: DEFAULT_HTML_BODY_TEMPLATE, // TODO: Default html body template should come from the server", "originalCommit": "1507fc14e23380fe6f07ada0d949df8fe9c9499f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cd59eddfa5b9e0e152fb5f717e121d880c39e344", "url": "https://github.com/Graylog2/graylog2-server/commit/cd59eddfa5b9e0e152fb5f717e121d880c39e344", "message": "Default html body as empty string", "committedDate": "2021-01-05T10:59:53Z", "type": "commit"}, {"oid": "a3d20f6daa1acfdb10dc8aaf58d0c71d54feb51c", "url": "https://github.com/Graylog2/graylog2-server/commit/a3d20f6daa1acfdb10dc8aaf58d0c71d54feb51c", "message": "Send only HtmlEmail when needed", "committedDate": "2021-01-05T10:59:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg5NDA4MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551894080", "bodyText": "I've meant to keep this one, actually.\nHaving a nice default template is great. I just didn't want to force it on the users for existing notifications.\nBut it should be filled in when creating a new notification.", "author": "mpfz0r", "createdAt": "2021-01-05T12:11:32Z", "path": "graylog2-web-interface/src/components/event-notifications/event-notification-types/EmailNotificationForm.jsx", "diffHunk": "@@ -50,37 +50,6 @@ Last messages accounting for this alert:\n \\${end}\n `;\n \n-// TODO: Default html body template should come from the server", "originalCommit": "cd59eddfa5b9e0e152fb5f717e121d880c39e344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkzMjY3Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9790#discussion_r551932673", "bodyText": "Oh, sorry I misunderstood it", "author": "radykal-com", "createdAt": "2021-01-05T13:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg5NDA4MA=="}], "type": "inlineReview"}, {"oid": "3b4bff27b56998bb508246cae25f33f5ba7cdc4b", "url": "https://github.com/Graylog2/graylog2-server/commit/3b4bff27b56998bb508246cae25f33f5ba7cdc4b", "message": "Restore default html body for new notifications", "committedDate": "2021-01-05T13:35:59Z", "type": "commit"}]}