{"pr_number": 7992, "pr_title": "Allow free license request from the Enterprise overview page", "pr_createdAt": "2020-04-28T14:34:23Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7992", "timeline": [{"oid": "0fc762e5f8fc1a731448de789955b3a4d8f1e8ca", "url": "https://github.com/Graylog2/graylog2-server/commit/0fc762e5f8fc1a731448de789955b3a4d8f1e8ca", "message": "always show a single Enterprise menu item if no plugin contributes something else in its place", "committedDate": "2020-03-24T12:48:16Z", "type": "commit"}, {"oid": "fe8b55a21fab701f511199ed776bb867320890dd", "url": "https://github.com/Graylog2/graylog2-server/commit/fe8b55a21fab701f511199ed776bb867320890dd", "message": "remove System/Enterprise menu item, but leave its route intact", "committedDate": "2020-03-24T13:14:14Z", "type": "commit"}, {"oid": "b7a21a85609974d7c32b817be5bab8c29aebc57d", "url": "https://github.com/Graylog2/graylog2-server/commit/b7a21a85609974d7c32b817be5bab8c29aebc57d", "message": "Merge branch 'master' into enterprise-page", "committedDate": "2020-03-31T16:17:53Z", "type": "commit"}, {"oid": "6842dc0c40422e5396c66ea5b989f63c3eb5080b", "url": "https://github.com/Graylog2/graylog2-server/commit/6842dc0c40422e5396c66ea5b989f63c3eb5080b", "message": "Fix eslint errors in Navigation.jsx", "committedDate": "2020-03-31T16:21:48Z", "type": "commit"}, {"oid": "e66103882299b2cad8986aca3e1ddd6ee9df0327", "url": "https://github.com/Graylog2/graylog2-server/commit/e66103882299b2cad8986aca3e1ddd6ee9df0327", "message": "Use Route constant instead of hardcoding the path", "committedDate": "2020-03-31T16:50:53Z", "type": "commit"}, {"oid": "a5bd9e8b339df04f3e18fea15fa9892751b24165", "url": "https://github.com/Graylog2/graylog2-server/commit/a5bd9e8b339df04f3e18fea15fa9892751b24165", "message": "Start a free enterprise license form", "committedDate": "2020-04-01T17:09:44Z", "type": "commit"}, {"oid": "6ea1ea4726f40b926b13614ad2d453a307f89272", "url": "https://github.com/Graylog2/graylog2-server/commit/6ea1ea4726f40b926b13614ad2d453a307f89272", "message": "Merge branch 'master' into enterprise-page", "committedDate": "2020-04-01T17:11:20Z", "type": "commit"}, {"oid": "31c0acbda26cc539627e8cfced6f91eaf29dced1", "url": "https://github.com/Graylog2/graylog2-server/commit/31c0acbda26cc539627e8cfced6f91eaf29dced1", "message": "Some form cleanup", "committedDate": "2020-04-01T17:17:12Z", "type": "commit"}, {"oid": "ab66bfccd66af47ffa8b84b41cd43cc46a1ea063", "url": "https://github.com/Graylog2/graylog2-server/commit/ab66bfccd66af47ffa8b84b41cd43cc46a1ea063", "message": "Merge branch 'master' into enterprise-page", "committedDate": "2020-04-03T10:33:26Z", "type": "commit"}, {"oid": "84edf3ce8a5d1b57b9b1f810d13bacbe49674890", "url": "https://github.com/Graylog2/graylog2-server/commit/84edf3ce8a5d1b57b9b1f810d13bacbe49674890", "message": "Merge branch 'master' into enterprise-page", "committedDate": "2020-04-06T11:49:20Z", "type": "commit"}, {"oid": "b722117edd5aeeb3770ed7489a9bfffbb5df7838", "url": "https://github.com/Graylog2/graylog2-server/commit/b722117edd5aeeb3770ed7489a9bfffbb5df7838", "message": "Start free enterprise license backend", "committedDate": "2020-04-06T18:01:30Z", "type": "commit"}, {"oid": "63ee8d90787a18ee257a4c5c39317870d695d140", "url": "https://github.com/Graylog2/graylog2-server/commit/63ee8d90787a18ee257a4c5c39317870d695d140", "message": "Store and post received license and improve UI", "committedDate": "2020-04-07T17:13:38Z", "type": "commit"}, {"oid": "4d38b665857ce448b44a6dfb2ab618c008dca9e9", "url": "https://github.com/Graylog2/graylog2-server/commit/4d38b665857ce448b44a6dfb2ab618c008dca9e9", "message": "No need to submit the cluster ID from the UI", "committedDate": "2020-04-07T17:28:35Z", "type": "commit"}, {"oid": "85373ab4684180aec2c5459e1ec958506b9dce57", "url": "https://github.com/Graylog2/graylog2-server/commit/85373ab4684180aec2c5459e1ec958506b9dce57", "message": "Don't trim form values to allow whitespace", "committedDate": "2020-04-08T16:22:26Z", "type": "commit"}, {"oid": "0b62a67d848f820222f5f187e190ab225eefe82b", "url": "https://github.com/Graylog2/graylog2-server/commit/0b62a67d848f820222f5f187e190ab225eefe82b", "message": "Merge remote-tracking branch 'origin/master' into enterprise-page", "committedDate": "2020-04-28T11:32:38Z", "type": "commit"}, {"oid": "d0699ff3c1a81b173bb56fbd8d9d32e1183604b3", "url": "https://github.com/Graylog2/graylog2-server/commit/d0699ff3c1a81b173bb56fbd8d9d32e1183604b3", "message": "Merge remote-tracking branch 'origin/master' into enterprise-page", "committedDate": "2020-04-28T11:32:51Z", "type": "commit"}, {"oid": "c757176448b28290abab503191299a803637fadc", "url": "https://github.com/Graylog2/graylog2-server/commit/c757176448b28290abab503191299a803637fadc", "message": "Introduce a \"compact\" layout for GraylogClusterOverview", "committedDate": "2020-04-28T14:19:23Z", "type": "commit"}, {"oid": "60154be4afec1e2cabd11c561d5a7ae9c44c658b", "url": "https://github.com/Graylog2/graylog2-server/commit/60154be4afec1e2cabd11c561d5a7ae9c44c658b", "message": "Modify page layout and text", "committedDate": "2020-04-28T14:19:57Z", "type": "commit"}, {"oid": "f510db8071f73e1e0dec50342d9c3dd143c3b242", "url": "https://github.com/Graylog2/graylog2-server/commit/f510db8071f73e1e0dec50342d9c3dd143c3b242", "message": "Tweak text", "committedDate": "2020-04-28T14:24:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI1NzI5OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7992#discussion_r417257298", "bodyText": "This leads to a truncated form:\n\nCan we make it a bit wider?", "author": "kroepke", "createdAt": "2020-04-29T11:53:27Z", "path": "graylog2-web-interface/src/components/enterprise/EnterpriseFreeLicenseForm.jsx", "diffHunk": "@@ -0,0 +1,127 @@\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+\n+import { Button, ButtonToolbar, Col, Row } from 'components/graylog';\n+import { Input } from 'components/bootstrap';\n+import lodash from 'lodash';\n+\n+const FORM_FIELDS = ['firstName', 'lastName', 'email', 'company'];\n+\n+export default class EnterpriseFreeLicenseForm extends React.Component {\n+  static propTypes = {\n+    onSubmit: PropTypes.func.isRequired,\n+  };\n+\n+  constructor(props) {\n+    super(props);\n+    this.state = {\n+      formFields: {\n+        firstName: '',\n+        lastName: '',\n+        email: '',\n+        company: '',\n+      },\n+      isSubmitting: false,\n+    };\n+  }\n+\n+  clearValues = (callback) => {\n+    const clearedFields = FORM_FIELDS.reduce((acc, key) => Object.assign(acc, { [key]: '' }), {});\n+    this.setState({ formFields: clearedFields }, callback);\n+  };\n+\n+  handleInput = (key) => {\n+    return (event) => {\n+      const { formFields } = this.state;\n+      const newFormFields = Object.assign(formFields, { [key]: event.target.value });\n+      this.setState({ formFields: newFormFields });\n+    };\n+  };\n+\n+  formIsInvalid = () => {\n+    const { isSubmitting, formFields } = this.state;\n+\n+    return isSubmitting || !lodash.isEmpty(FORM_FIELDS.filter((key) => lodash.isEmpty(lodash.trim(formFields[key]))));\n+  };\n+\n+  submitForm = (event) => {\n+    event.preventDefault();\n+\n+    const { onSubmit } = this.props;\n+    const { formFields } = this.state;\n+\n+    // First set \"submitting\" status to make sure we disable the submit button (avoid double-click)\n+    this.setState({ isSubmitting: true }, () => {\n+      onSubmit(formFields, (success) => {\n+        if (success) {\n+          // Clear form before unsetting \"submitting\" status, again, to avoid double-click\n+          this.clearValues(() => {\n+            this.setState({ isSubmitting: false });\n+          });\n+        } else {\n+          this.setState({ isSubmitting: false });\n+        }\n+      });\n+    });\n+  };\n+\n+  resetForm = () => {\n+    this.clearValues();\n+  };\n+\n+  render() {\n+    const { formFields: { firstName, lastName, company, email } } = this.state;\n+\n+    return (\n+      <form onSubmit={this.submitForm}>\n+        <Row>\n+          <Col md={5}>", "originalCommit": "f510db8071f73e1e0dec50342d9c3dd143c3b242", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMDYwMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7992#discussion_r417300603", "bodyText": "Good catch. Yes! \ud83d\udc4d", "author": "bernd", "createdAt": "2020-04-29T13:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI1NzI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI1ODIzMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7992#discussion_r417258232", "bodyText": "I would add a break after the first sentence to make it stand out a little more.", "author": "kroepke", "createdAt": "2020-04-29T11:55:22Z", "path": "graylog2-web-interface/src/pages/EnterprisePage.jsx", "diffHunk": "@@ -1,48 +1,153 @@\n import React from 'react';\n+import PropTypes from 'prop-types';\n import createReactClass from 'create-react-class';\n import Reflux from 'reflux';\n+import styled from 'styled-components';\n \n-import { DocumentTitle, PageHeader } from 'components/common';\n+import { DocumentTitle, IfPermitted, PageHeader, Spinner } from 'components/common';\n+import { Alert, Col, Row } from 'components/graylog';\n import { GraylogClusterOverview } from 'components/cluster';\n+import DocumentationLink from 'components/support/DocumentationLink';\n+import { Link } from 'react-router';\n+import Routes from 'routing/Routes';\n+import EnterpriseFreeLicenseForm from 'components/enterprise/EnterpriseFreeLicenseForm';\n import PluginList from 'components/enterprise/PluginList';\n \n-import StoreProvider from 'injection/StoreProvider';\n+import CombinedProvider from 'injection/CombinedProvider';\n \n-const NodesStore = StoreProvider.getStore('Nodes');\n+const { EnterpriseActions, EnterpriseStore } = CombinedProvider.get('Enterprise');\n+\n+const EnterpriseProductLink = ({ children }) => {\n+  return (\n+    <a href=\"https://www.graylog.org/products/enterprise\"\n+       rel=\"noopener noreferrer\"\n+       target=\"_blank\">\n+      {children}\n+    </a>\n+  );\n+};\n+\n+EnterpriseProductLink.propTypes = {\n+  children: PropTypes.array,\n+};\n+EnterpriseProductLink.defaultProps = {\n+  children: null,\n+};\n+\n+const EnterpriseFeatureList = styled.ul`\n+list-style-type: disc;\n+padding-left: 20px;\n+`;\n+\n+const BiggerFontSize = styled.div`\n+font-size: 1.5em;\n+`;\n \n const EnterprisePage = createReactClass({\n   displayName: 'EnterprisePage',\n-  mixins: [Reflux.connect(NodesStore)],\n+  mixins: [Reflux.connect(EnterpriseStore)],\n \n-  _isLoading() {\n-    return !this.state.nodes;\n+  componentDidMount() {\n+    EnterpriseActions.getLicenseInfo();\n   },\n \n-  render() {\n-    let orderLink = 'https://www.graylog.org/enterprise';\n+  onFreeLicenseFormSubmit(formFields, callback) {\n+    EnterpriseActions.requestFreeEnterpriseLicense(formFields)\n+      .then(() => callback(true))\n+      .catch(() => callback(false));\n+  },\n+\n+  _isLoading() {\n+    const { licenseStatus } = this.state;\n+    return !licenseStatus;\n+  },\n \n-    if (this.state.clusterId) {\n-      orderLink = `https://www.graylog.org/enterprise?cid=${this.state.clusterId}&nodes=${this.state.nodeCount}`;\n+  renderLicenseFormContent(licenseStatus) {\n+    let licenseFormContent;\n+    if (this._isLoading()) {\n+      licenseFormContent = <Spinner text=\"Loading license status\" />;\n+    } else if (licenseStatus === 'installed') {\n+      licenseFormContent = (\n+        <Alert bsStyle=\"success\">\n+          You have a Graylog Enterprise license installed.\n+        </Alert>\n+      );\n+    } else if (licenseStatus === 'staged') {\n+      licenseFormContent = (\n+        <Alert bsStyle=\"warning\">\n+          You requested a free Graylog Enterprise license. It will be activated once you restart the Graylog\n+          server with the Graylog Enterprise plugins installed.\n+        </Alert>\n+      );\n+    } else {\n+      licenseFormContent = <EnterpriseFreeLicenseForm onSubmit={this.onFreeLicenseFormSubmit} />;\n     }\n \n+    return licenseFormContent;\n+  },\n+\n+  render() {\n+    const { licenseStatus } = this.state;\n+\n     return (\n-      <DocumentTitle title=\"Graylog Enterprise\">\n+      <DocumentTitle title=\"Try Graylog Enterprise\">\n         <div>\n-          <PageHeader title=\"Graylog Enterprise\">\n+          <PageHeader title=\"Try Graylog Enterprise\">\n             {null}\n \n             <span>\n               Graylog Enterprise adds commercial functionality to the Open Source Graylog core. You can learn more\n-              about Graylog Enterprise and order a license on the <a href={orderLink} target=\"_blank\">product page</a>.\n-            </span>\n-\n-            <span>\n-              <a className=\"btn btn-lg btn-success\" href={orderLink} target=\"_blank\">Order a license</a>\n+              about Graylog Enterprise on the <EnterpriseProductLink>product page</EnterpriseProductLink>.\n             </span>\n           </PageHeader>\n \n-          <GraylogClusterOverview />\n-          <PluginList />\n+          <GraylogClusterOverview layout=\"compact\">\n+            <PluginList />\n+          </GraylogClusterOverview>\n+          <IfPermitted permissions=\"freelicenses:create\">\n+            <Row className=\"content\">\n+              <Col md={6}>\n+                <BiggerFontSize>\n+                  <p>Extend Graylog\u2019s Open Source capabilities with a free trial of Graylog Enterprise (up to 5 GB/Day).", "originalCommit": "f510db8071f73e1e0dec50342d9c3dd143c3b242", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI1ODc0Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/7992#discussion_r417258746", "bodyText": "If the enterprise plugin isn't installed the internal links will end up in 404s, which isn't pretty.\nShould we instead always link to the website?", "author": "kroepke", "createdAt": "2020-04-29T11:56:20Z", "path": "graylog2-web-interface/src/pages/EnterprisePage.jsx", "diffHunk": "@@ -1,48 +1,153 @@\n import React from 'react';\n+import PropTypes from 'prop-types';\n import createReactClass from 'create-react-class';\n import Reflux from 'reflux';\n+import styled from 'styled-components';\n \n-import { DocumentTitle, PageHeader } from 'components/common';\n+import { DocumentTitle, IfPermitted, PageHeader, Spinner } from 'components/common';\n+import { Alert, Col, Row } from 'components/graylog';\n import { GraylogClusterOverview } from 'components/cluster';\n+import DocumentationLink from 'components/support/DocumentationLink';\n+import { Link } from 'react-router';\n+import Routes from 'routing/Routes';\n+import EnterpriseFreeLicenseForm from 'components/enterprise/EnterpriseFreeLicenseForm';\n import PluginList from 'components/enterprise/PluginList';\n \n-import StoreProvider from 'injection/StoreProvider';\n+import CombinedProvider from 'injection/CombinedProvider';\n \n-const NodesStore = StoreProvider.getStore('Nodes');\n+const { EnterpriseActions, EnterpriseStore } = CombinedProvider.get('Enterprise');\n+\n+const EnterpriseProductLink = ({ children }) => {\n+  return (\n+    <a href=\"https://www.graylog.org/products/enterprise\"\n+       rel=\"noopener noreferrer\"\n+       target=\"_blank\">\n+      {children}\n+    </a>\n+  );\n+};\n+\n+EnterpriseProductLink.propTypes = {\n+  children: PropTypes.array,\n+};\n+EnterpriseProductLink.defaultProps = {\n+  children: null,\n+};\n+\n+const EnterpriseFeatureList = styled.ul`\n+list-style-type: disc;\n+padding-left: 20px;\n+`;\n+\n+const BiggerFontSize = styled.div`\n+font-size: 1.5em;\n+`;\n \n const EnterprisePage = createReactClass({\n   displayName: 'EnterprisePage',\n-  mixins: [Reflux.connect(NodesStore)],\n+  mixins: [Reflux.connect(EnterpriseStore)],\n \n-  _isLoading() {\n-    return !this.state.nodes;\n+  componentDidMount() {\n+    EnterpriseActions.getLicenseInfo();\n   },\n \n-  render() {\n-    let orderLink = 'https://www.graylog.org/enterprise';\n+  onFreeLicenseFormSubmit(formFields, callback) {\n+    EnterpriseActions.requestFreeEnterpriseLicense(formFields)\n+      .then(() => callback(true))\n+      .catch(() => callback(false));\n+  },\n+\n+  _isLoading() {\n+    const { licenseStatus } = this.state;\n+    return !licenseStatus;\n+  },\n \n-    if (this.state.clusterId) {\n-      orderLink = `https://www.graylog.org/enterprise?cid=${this.state.clusterId}&nodes=${this.state.nodeCount}`;\n+  renderLicenseFormContent(licenseStatus) {\n+    let licenseFormContent;\n+    if (this._isLoading()) {\n+      licenseFormContent = <Spinner text=\"Loading license status\" />;\n+    } else if (licenseStatus === 'installed') {\n+      licenseFormContent = (\n+        <Alert bsStyle=\"success\">\n+          You have a Graylog Enterprise license installed.\n+        </Alert>\n+      );\n+    } else if (licenseStatus === 'staged') {\n+      licenseFormContent = (\n+        <Alert bsStyle=\"warning\">\n+          You requested a free Graylog Enterprise license. It will be activated once you restart the Graylog\n+          server with the Graylog Enterprise plugins installed.\n+        </Alert>\n+      );\n+    } else {\n+      licenseFormContent = <EnterpriseFreeLicenseForm onSubmit={this.onFreeLicenseFormSubmit} />;\n     }\n \n+    return licenseFormContent;\n+  },\n+\n+  render() {\n+    const { licenseStatus } = this.state;\n+\n     return (\n-      <DocumentTitle title=\"Graylog Enterprise\">\n+      <DocumentTitle title=\"Try Graylog Enterprise\">\n         <div>\n-          <PageHeader title=\"Graylog Enterprise\">\n+          <PageHeader title=\"Try Graylog Enterprise\">\n             {null}\n \n             <span>\n               Graylog Enterprise adds commercial functionality to the Open Source Graylog core. You can learn more\n-              about Graylog Enterprise and order a license on the <a href={orderLink} target=\"_blank\">product page</a>.\n-            </span>\n-\n-            <span>\n-              <a className=\"btn btn-lg btn-success\" href={orderLink} target=\"_blank\">Order a license</a>\n+              about Graylog Enterprise on the <EnterpriseProductLink>product page</EnterpriseProductLink>.\n             </span>\n           </PageHeader>\n \n-          <GraylogClusterOverview />\n-          <PluginList />\n+          <GraylogClusterOverview layout=\"compact\">\n+            <PluginList />\n+          </GraylogClusterOverview>\n+          <IfPermitted permissions=\"freelicenses:create\">\n+            <Row className=\"content\">\n+              <Col md={6}>\n+                <BiggerFontSize>\n+                  <p>Extend Graylog\u2019s Open Source capabilities with a free trial of Graylog Enterprise (up to 5 GB/Day).\n+                    Graylog Enterprise introduces productivity and compliance features designed to help organizations\n+                    reduce risk while encouraging collaboration across a large number of users.</p>\n+\n+                  <p>Graylog Enterprise includes:</p>\n+\n+                  <EnterpriseFeatureList>\n+                    <li>Automated <Link to={Routes.pluginRoute('SYSTEM_ARCHIVES')}><strong>archiving</strong></Link> and", "originalCommit": "f510db8071f73e1e0dec50342d9c3dd143c3b242", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMjAzMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7992#discussion_r417302033", "bodyText": "Good catch! \ud83d\udc4d", "author": "bernd", "createdAt": "2020-04-29T13:11:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI1ODc0Ng=="}], "type": "inlineReview"}, {"oid": "4cd7f8315e7dcaf74ddaede93b8cea96aa9648a2", "url": "https://github.com/Graylog2/graylog2-server/commit/4cd7f8315e7dcaf74ddaede93b8cea96aa9648a2", "message": "Fix review comments\n\n- Use full width for the form\n- Some formatting of the text\n- Always use documentation links so we don't show dead links if the\n  enterprise plugins are not installed", "committedDate": "2020-04-29T13:30:17Z", "type": "commit"}, {"oid": "f37d1d4a6855ea583b6b2bfd603a050a97e79bfc", "url": "https://github.com/Graylog2/graylog2-server/commit/f37d1d4a6855ea583b6b2bfd603a050a97e79bfc", "message": "Add missing NoAuditEvent annotation", "committedDate": "2020-04-29T13:34:49Z", "type": "commit"}, {"oid": "8f14d7f27421d02b96e5d4c14f4002638675c433", "url": "https://github.com/Graylog2/graylog2-server/commit/8f14d7f27421d02b96e5d4c14f4002638675c433", "message": "Merge remote-tracking branch 'origin/master' into enterprise-page", "committedDate": "2020-04-29T14:10:14Z", "type": "commit"}, {"oid": "644e591c31804265f0287618ea34b2afef45d05f", "url": "https://github.com/Graylog2/graylog2-server/commit/644e591c31804265f0287618ea34b2afef45d05f", "message": "Fix SystemMenu test after Enterprise removal", "committedDate": "2020-04-29T14:11:14Z", "type": "commit"}, {"oid": "bb54c64f1421b7222173e9a9a3348605892c5e58", "url": "https://github.com/Graylog2/graylog2-server/commit/bb54c64f1421b7222173e9a9a3348605892c5e58", "message": "Fix test errors\n\nWhen rendering a plugin menu entry in on the top-level nav bar, we\ncannot use MenuItem but have to use NavItem.", "committedDate": "2020-04-29T15:50:23Z", "type": "commit"}, {"oid": "1ae1b582e4452746efb6250d7655dfbb51f43e5b", "url": "https://github.com/Graylog2/graylog2-server/commit/1ae1b582e4452746efb6250d7655dfbb51f43e5b", "message": "Fix prop validation errors", "committedDate": "2020-04-29T15:51:20Z", "type": "commit"}]}