{"pr_number": 8192, "pr_title": "Add verbose failure support to LDAP authentication", "pr_createdAt": "2020-05-25T08:13:35Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8192", "timeline": [{"oid": "085c92fca9a9dd6c16faf2e918d361941b7e5cf8", "url": "https://github.com/Graylog2/graylog2-server/commit/085c92fca9a9dd6c16faf2e918d361941b7e5cf8", "message": "Add verbose failure support to LDAP authentication\n\nIf the LDAP authentication cannot be done due to a server\nerror, throw an AuthenticationServiceUnavailableException.\nThis gives the user (and the audit log) an indicator, that\nit wasn't his fault that he couldn't log in.\n\nRefs #8136", "committedDate": "2020-05-25T07:55:18Z", "type": "commit"}, {"oid": "60f6823199d2aee31126000892ba2063164b26d8", "url": "https://github.com/Graylog2/graylog2-server/commit/60f6823199d2aee31126000892ba2063164b26d8", "message": "Fix test", "committedDate": "2020-05-25T09:05:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyNzk5OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8192#discussion_r431627998", "bodyText": "It seems that (at least in some cases) the flow for an authentication failure might not be what the code suggests. If I'm trying to log in with an existing LDAP user and a wrong password, I'll end up in this catch clause:\n\n\nRuntimeException\n\n2020-05-28 09:04:39,292 ERROR: org.graylog2.security.realm.LdapUserAuthenticator - Error during LDAP user account sync. Cannot log in user bender\njava.lang.RuntimeException: MessageType : BIND_RESPONSE\nMessage ID : 3\n    BindResponse\n        Ldap Result\n            Result code : (INVALID_CREDENTIALS) invalidCredentials\n            Matched Dn : ''\n            Diagnostic message : ''\nat org.graylog2.security.ldap.LdapConnector.authenticate(LdapConnector.java:402) ~[classes/:?]\nat org.graylog2.security.realm.LdapUserAuthenticator.doGetAuthenticationInfo(LdapUserAuthenticator.java:118) [classes/:?]\nat org.apache.shiro.realm.AuthenticatingRealm.getAuthenticationInfo(AuthenticatingRealm.java:571) [shiro-core-1.5.2.jar:1.5.2]\nat org.apache.shiro.authc.pam.ModularRealmAuthenticator.doMultiRealmAuthentication(ModularRealmAuthenticator.java:225) [shiro-core-1.5.2.jar:1.5.2]\nat org.apache.shiro.authc.pam.ModularRealmAuthenticator.doAuthenticate(ModularRealmAuthenticator.java:275) [shiro-core-1.5.2.jar:1.5.2]\nat org.apache.shiro.authc.AbstractAuthenticator.authenticate(AbstractAuthenticator.java:198) [shiro-core-1.5.2.jar:1.5.2]\nat org.apache.shiro.mgt.AuthenticatingSecurityManager.authenticate(AuthenticatingSecurityManager.java:106) [shiro-core-1.5.2.jar:1.5.2]\nat org.apache.shiro.mgt.DefaultSecurityManager.login(DefaultSecurityManager.java:275) [shiro-core-1.5.2.jar:1.5.2]\nat org.apache.shiro.subject.support.DelegatingSubject.login(DelegatingSubject.java:260) [shiro-core-1.5.2.jar:1.5.2]\nat org.graylog2.shared.security.SessionCreator.create(SessionCreator.java:80) [classes/:?]\nat org.graylog2.rest.resources.system.SessionsResource.newSession(SessionsResource.java:130) [classes/:?]\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:1.8.0_222]\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:1.8.0_222]\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:1.8.0_222]\nat java.lang.reflect.Method.invoke(Method.java:498) ~[?:1.8.0_222]\nat org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory$1.invoke(ResourceMethodInvocationHandlerFactory.java:81) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:144) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:161) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$TypeOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:205) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:99) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.model.ResourceMethodInvoker.invoke(ResourceMethodInvoker.java:389) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:347) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.model.ResourceMethodInvoker.apply(ResourceMethodInvoker.java:102) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.ServerRuntime$2.run(ServerRuntime.java:326) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.internal.Errors$1.call(Errors.java:271) [jersey-common-2.25.1.jar:?]\nat org.glassfish.jersey.internal.Errors$1.call(Errors.java:267) [jersey-common-2.25.1.jar:?]\nat org.glassfish.jersey.internal.Errors.process(Errors.java:315) [jersey-common-2.25.1.jar:?]\nat org.glassfish.jersey.internal.Errors.process(Errors.java:297) [jersey-common-2.25.1.jar:?]\nat org.glassfish.jersey.internal.Errors.process(Errors.java:267) [jersey-common-2.25.1.jar:?]\nat org.glassfish.jersey.process.internal.RequestScope.runInScope(RequestScope.java:317) [jersey-common-2.25.1.jar:?]\nat org.glassfish.jersey.server.ServerRuntime.process(ServerRuntime.java:305) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.server.ApplicationHandler.handle(ApplicationHandler.java:1154) [jersey-server-2.25.1.jar:?]\nat org.glassfish.jersey.grizzly2.httpserver.GrizzlyHttpContainer.service(GrizzlyHttpContainer.java:384) [jersey-container-grizzly2-http-2.25.1.jar:?]\nat org.glassfish.grizzly.http.server.HttpHandler$1.run(HttpHandler.java:224) [grizzly-http-server-2.3.28.jar:2.3.28]\nat com.codahale.metrics.InstrumentedExecutorService$InstrumentedRunnable.run(InstrumentedExecutorService.java:181) [metrics-core-4.0.3.jar:4.0.3]\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_222]\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_222]\nat java.lang.Thread.run(Thread.java:748) [?:1.8.0_222]", "author": "thll", "createdAt": "2020-05-28T07:14:27Z", "path": "graylog2-server/src/main/java/org/graylog2/security/realm/LdapUserAuthenticator.java", "diffHunk": "@@ -132,14 +133,14 @@ protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authtok\n             return new SimpleAccount(principal, null, \"ldap realm\");\n         } catch (LdapException e) {\n             LOG.error(\"LDAP error\", e);\n+            throw new AuthenticationServiceUnavailableException(\"LDAP error\", e);\n         } catch (CursorException e) {\n             LOG.error(\"Unable to read LDAP entry\", e);\n+            throw new AuthenticationServiceUnavailableException(\"Unable to read LDAP entry\", e);\n         } catch (Exception e) {\n             LOG.error(\"Error during LDAP user account sync. Cannot log in user {}\", principal, e);\n+            throw new AuthenticationServiceUnavailableException(\"Error during LDAP user account sync\", e);", "originalCommit": "60f6823199d2aee31126000892ba2063164b26d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzczNDUxNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8192#discussion_r433734516", "bodyText": "Thanks for testing this. I think I forgot to try an invalid password.\nI suggest we simply return null in this catch clause.\nWe don't need to spend too much time on this, because there are already plans to rewrite the LDAP backend..", "author": "mpfz0r", "createdAt": "2020-06-02T09:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYyNzk5OA=="}], "type": "inlineReview"}, {"oid": "e53aac640396e767cfaf845dfb0a50088494b6cb", "url": "https://github.com/Graylog2/graylog2-server/commit/e53aac640396e767cfaf845dfb0a50088494b6cb", "message": "Merge remote-tracking branch 'origin/master' into verbose-auth-failure-ldap", "committedDate": "2020-06-02T10:00:43Z", "type": "commit"}, {"oid": "04691d107140d9eea52594af920b6f620072be61", "url": "https://github.com/Graylog2/graylog2-server/commit/04691d107140d9eea52594af920b6f620072be61", "message": "Avoid AuthenticationServiceUnavailableException w/ invalid credentials\n\nFor reasons we are not gonna fix right now,\nfailing a bind with wrong credentials always\nraises a RuntimeExcepction.\n\nJust return null for now to avoid indicating a server problem.", "committedDate": "2020-06-02T11:20:55Z", "type": "commit"}]}