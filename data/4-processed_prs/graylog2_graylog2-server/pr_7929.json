{"pr_number": 7929, "pr_title": "Implement field types context for search pages", "pr_createdAt": "2020-04-21T08:16:08Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7929", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3NjAwNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r411976004", "bodyText": "Because we need viewMetadata for this component independently of the fields, I removed  the ViewMetadataStore connect from the ExtendedSearchPage FieldList and implemented it as a part of the component.", "author": "linuspahl", "createdAt": "2020-04-21T08:21:00Z", "path": "graylog2-web-interface/src/views/components/sidebar/FieldList.jsx", "diffHunk": "@@ -175,10 +179,29 @@ const FieldList = createReactClass({\n           {this.showFieldsByLink('allreserved', 'all including reserved', 'This shows all fields, including reserved (gl2_*) fields.')} fields.\n         </div>\n         <hr />\n-        {this._renderFieldList({ fields, allFields, showFieldsBy })}\n+        {this._renderFieldList({ activeQueryFields, allFields, showFieldsBy })}\n       </div>\n     );\n   },\n });\n \n-export default FieldList;\n+const FieldListWithContext = (props) => (\n+  <FieldTypesContext.Consumer>\n+    {({ all, queryFields } = {}) => {\n+      const { viewMetadata: { activeQuery } } = props;\n+      const activeQueryFields = queryFields?.get(activeQuery, all);\n+      return <FieldList {...props} allFields={all} activeQueryFields={activeQueryFields} />;\n+    }}\n+  </FieldTypesContext.Consumer>\n+);\n+\n+FieldListWithContext.propTypes = {\n+  viewMetadata: PropTypes.object.isRequired,\n+  listHeight: PropTypes.number,\n+};\n+\n+FieldListWithContext.defaultProps = {\n+  listHeight: 50,\n+};\n+\n+export default connect(FieldListWithContext, { viewMetadata: ViewMetadataStore });", "originalCommit": "17fb73e61af2003564128d3972caec2f22dc5d94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAwMzExNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r412003115", "bodyText": "The ViewMetadataStore is probably the next target that could be provided with a context instead.", "author": "dennisoelkers", "createdAt": "2020-04-21T08:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3NjAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3ODE5NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r411978195", "bodyText": "We had this discussion for e.g. the CurrentUserProvider: Right now I am expecting fieldTypes to be undefined initially, which means we need to test / check the undefined case in every component where we are using the FieldTypesContext.", "author": "linuspahl", "createdAt": "2020-04-21T08:23:56Z", "path": "graylog2-web-interface/src/views/components/contexts/FieldTypesProvider.jsx", "diffHunk": "@@ -0,0 +1,26 @@\n+// @flow strict\n+import * as React from 'react';\n+import PropTypes from 'prop-types';\n+\n+import { useStore } from 'stores/connect';\n+import { FieldTypesStore } from 'views/stores/FieldTypesStore';\n+import FieldTypesContext from './FieldTypesContext';\n+\n+const FieldTypesProvider = ({ children }: { children: React.Node }) => {\n+  const fieldTypes = useStore(FieldTypesStore);\n+  return (\n+    fieldTypes\n+      ? (\n+        <FieldTypesContext.Provider value={fieldTypes}>\n+          {children}\n+        </FieldTypesContext.Provider>\n+      )\n+      : children\n+  );\n+};", "originalCommit": "17fb73e61af2003564128d3972caec2f22dc5d94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5NjIzNw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r411996237", "bodyText": "We should split this up into:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import React, { useContext } from 'react';\n          \n          \n            \n            import * as React from 'react';\n          \n          \n            \n            import { useContext } from 'react';\n          \n      \n    \n    \n  \n\nThis way we really do have React containing all exports and not just default.", "author": "dennisoelkers", "createdAt": "2020-04-21T08:48:27Z", "path": "graylog2-web-interface/src/views/components/SearchResult.jsx", "diffHunk": "@@ -1,12 +1,11 @@\n // @flow strict\n-import * as React from 'react';\n+import React, { useContext } from 'react';", "originalCommit": "17fb73e61af2003564128d3972caec2f22dc5d94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5MDcxMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r412090713", "bodyText": "So far I've used * as React only when needed, but I see the benefit in always exporting not just default", "author": "linuspahl", "createdAt": "2020-04-21T11:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5NjIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5NzU4NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r411997585", "bodyText": "Instead of reusing the store state, we should create an own type in the context that we are populating. If it is structurally identical to FieldTypesStoreState, we do not even need a conversion. This helps us decouple the context from any component that is providing it.", "author": "dennisoelkers", "createdAt": "2020-04-21T08:50:10Z", "path": "graylog2-web-interface/src/views/components/contexts/FieldTypesContext.jsx", "diffHunk": "@@ -0,0 +1,8 @@\n+// @flow strict\n+import * as React from 'react';\n+\n+import { singleton } from 'views/logic/singleton';\n+import type { FieldTypesStoreState } from 'views/stores/FieldTypesStore';\n+\n+const FieldTypesContext = React.createContext<?FieldTypesStoreState>();", "originalCommit": "17fb73e61af2003564128d3972caec2f22dc5d94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5ODY1OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r411998659", "bodyText": "We should name this either DefaultFieldTypesProvider or StoreBackedFieldTypesProvider or something like this, so it's clear that it is actually a specific implementation for the provider and not just the \"interface\".", "author": "dennisoelkers", "createdAt": "2020-04-21T08:51:20Z", "path": "graylog2-web-interface/src/views/components/contexts/FieldTypesProvider.jsx", "diffHunk": "@@ -0,0 +1,26 @@\n+// @flow strict\n+import * as React from 'react';\n+import PropTypes from 'prop-types';\n+\n+import { useStore } from 'stores/connect';\n+import { FieldTypesStore } from 'views/stores/FieldTypesStore';\n+import FieldTypesContext from './FieldTypesContext';\n+\n+const FieldTypesProvider = ({ children }: { children: React.Node }) => {", "originalCommit": "17fb73e61af2003564128d3972caec2f22dc5d94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAwMTYxOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r412001618", "bodyText": "Now that the mixins are gone, can we turn this into a class-based or functional component?", "author": "dennisoelkers", "createdAt": "2020-04-21T08:55:21Z", "path": "graylog2-web-interface/src/views/components/sidebar/FieldList.jsx", "diffHunk": "@@ -18,16 +20,16 @@ const isReservedField = (fieldName) => MessageFieldsFilter.FILTERED_FIELDS.inclu\n \n const FieldList = createReactClass({", "originalCommit": "17fb73e61af2003564128d3972caec2f22dc5d94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5MjU3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7929#discussion_r412092579", "bodyText": "I thought about it as well, but I prefer doing this in another PR, otherwise reviewing the FieldList changes would have been more complicated.", "author": "linuspahl", "createdAt": "2020-04-21T11:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAwMTYxOA=="}], "type": "inlineReview"}, {"oid": "5da7e4b67a02cc73dac4ad938051b4b4c84fbe88", "url": "https://github.com/Graylog2/graylog2-server/commit/5da7e4b67a02cc73dac4ad938051b4b4c84fbe88", "message": "Remove not used CSVExportModal", "committedDate": "2020-05-15T15:22:01Z", "type": "forcePushed"}, {"oid": "3eb226ea31a6433aa7bf0f6def4d76e908793a4c", "url": "https://github.com/Graylog2/graylog2-server/commit/3eb226ea31a6433aa7bf0f6def4d76e908793a4c", "message": "Remove not used CSVExportModal", "committedDate": "2020-06-04T10:44:41Z", "type": "forcePushed"}, {"oid": "6df60c49fd9b37041114d656d4a3fd814142cddf", "url": "https://github.com/Graylog2/graylog2-server/commit/6df60c49fd9b37041114d656d4a3fd814142cddf", "message": "Change position of DefaultFieldTypesProvider involvement", "committedDate": "2020-06-15T11:00:33Z", "type": "forcePushed"}, {"oid": "7bfce15f0bebb2fcae80de6de2b4cb181487a61b", "url": "https://github.com/Graylog2/graylog2-server/commit/7bfce15f0bebb2fcae80de6de2b4cb181487a61b", "message": "Add FieldTypesContext and FieldTypesProvider", "committedDate": "2020-06-19T08:00:29Z", "type": "commit"}, {"oid": "86c4bf58a9b90c6861a6bd44b76bc504ab47e04f", "url": "https://github.com/Graylog2/graylog2-server/commit/86c4bf58a9b90c6861a6bd44b76bc504ab47e04f", "message": "Implement FieldTypesProvider for ExtendedSearchPage and FieldTypesContext for FieldList", "committedDate": "2020-06-19T08:39:49Z", "type": "commit"}, {"oid": "85ef0a5adfb3aa79080f38988d35b123c5d02248", "url": "https://github.com/Graylog2/graylog2-server/commit/85ef0a5adfb3aa79080f38988d35b123c5d02248", "message": "Create fields fixtures and implement them in FieldList test", "committedDate": "2020-06-19T08:56:55Z", "type": "commit"}, {"oid": "e7711f8ac625406e5d70203666e4d1ae47344fd5", "url": "https://github.com/Graylog2/graylog2-server/commit/e7711f8ac625406e5d70203666e4d1ae47344fd5", "message": "Implement FieldTypesContext for SearchResult component", "committedDate": "2020-06-19T08:56:55Z", "type": "commit"}, {"oid": "0a7b005fcc07db6b32b6aeba05fbfa4e627ce0df", "url": "https://github.com/Graylog2/graylog2-server/commit/0a7b005fcc07db6b32b6aeba05fbfa4e627ce0df", "message": "Implement FieldTypesContext for PivotSelect component", "committedDate": "2020-06-19T08:56:55Z", "type": "commit"}, {"oid": "3377d143a1c6d23b73831064b23a55cc157efe52", "url": "https://github.com/Graylog2/graylog2-server/commit/3377d143a1c6d23b73831064b23a55cc157efe52", "message": "Implement FieldTypesContext for CSVExportNodalt", "committedDate": "2020-06-19T08:56:55Z", "type": "commit"}, {"oid": "b8be25e216443b1ca9aa9f7a7c29ce38334be5a6", "url": "https://github.com/Graylog2/graylog2-server/commit/b8be25e216443b1ca9aa9f7a7c29ce38334be5a6", "message": "Improve handling of empty field types store", "committedDate": "2020-06-19T08:57:18Z", "type": "commit"}, {"oid": "7a3112f913e792fc1aecc35240a611c8c3827984", "url": "https://github.com/Graylog2/graylog2-server/commit/7a3112f913e792fc1aecc35240a611c8c3827984", "message": "Improve naming", "committedDate": "2020-06-19T08:58:10Z", "type": "commit"}, {"oid": "3c8c81799cecc19c8a1f407a94e0887e1c188df5", "url": "https://github.com/Graylog2/graylog2-server/commit/3c8c81799cecc19c8a1f407a94e0887e1c188df5", "message": "Improve handling of empty field types store for FieldList", "committedDate": "2020-06-19T08:58:55Z", "type": "commit"}, {"oid": "541ac1c4b1c79e671fe41013aaa76c68a7dd7392", "url": "https://github.com/Graylog2/graylog2-server/commit/541ac1c4b1c79e671fe41013aaa76c68a7dd7392", "message": "Unify tests for undefined field types context value", "committedDate": "2020-06-19T08:58:55Z", "type": "commit"}, {"oid": "f40388e3ee692c648b30e9ddaa8286f9689f5aeb", "url": "https://github.com/Graylog2/graylog2-server/commit/f40388e3ee692c648b30e9ddaa8286f9689f5aeb", "message": "Change react import structure for SearchResult component", "committedDate": "2020-06-19T08:58:55Z", "type": "commit"}, {"oid": "270c2b953b7d98236f62af503562b87ba8936628", "url": "https://github.com/Graylog2/graylog2-server/commit/270c2b953b7d98236f62af503562b87ba8936628", "message": "Create custom type definition for FieldTypeContextValue", "committedDate": "2020-06-19T08:58:55Z", "type": "commit"}, {"oid": "a366db43e75b4a31501893b66a21109b9be2206f", "url": "https://github.com/Graylog2/graylog2-server/commit/a366db43e75b4a31501893b66a21109b9be2206f", "message": "Rename FieldTypesProvider to DefaultFieldTypesProvider", "committedDate": "2020-06-19T08:59:29Z", "type": "commit"}, {"oid": "3e3ee03aaba9c2b1615cb45ac13da1275771a18b", "url": "https://github.com/Graylog2/graylog2-server/commit/3e3ee03aaba9c2b1615cb45ac13da1275771a18b", "message": "Use fields fixtures in DefaultFieldProvider test", "committedDate": "2020-06-19T08:59:48Z", "type": "commit"}, {"oid": "501c51eb516406cda3b2de4d96164f5b2981306a", "url": "https://github.com/Graylog2/graylog2-server/commit/501c51eb516406cda3b2de4d96164f5b2981306a", "message": "Change variable name in SearchResult test", "committedDate": "2020-06-19T08:59:48Z", "type": "commit"}, {"oid": "74decabbf7a6fd59a81e76a3193482971d60ddfe", "url": "https://github.com/Graylog2/graylog2-server/commit/74decabbf7a6fd59a81e76a3193482971d60ddfe", "message": "Change react import structure for PivotSelect, CSVExportModal and FieldList", "committedDate": "2020-06-19T08:59:58Z", "type": "commit"}, {"oid": "66d6bf8cb2c62bb8cb4f07b39ab276fc7226221e", "url": "https://github.com/Graylog2/graylog2-server/commit/66d6bf8cb2c62bb8cb4f07b39ab276fc7226221e", "message": "Remove not used CSVExportModal", "committedDate": "2020-06-19T08:59:58Z", "type": "commit"}, {"oid": "686f169599cbebc4463ac08a5cf699295800cbb3", "url": "https://github.com/Graylog2/graylog2-server/commit/686f169599cbebc4463ac08a5cf699295800cbb3", "message": "Change position of DefaultFieldTypesProvider involvement", "committedDate": "2020-06-19T08:59:58Z", "type": "commit"}, {"oid": "b7cba619121aa6f61da15170de41d3c12183582b", "url": "https://github.com/Graylog2/graylog2-server/commit/b7cba619121aa6f61da15170de41d3c12183582b", "message": "Update imports order based on new linting rule", "committedDate": "2020-06-19T09:02:41Z", "type": "commit"}, {"oid": "b7cba619121aa6f61da15170de41d3c12183582b", "url": "https://github.com/Graylog2/graylog2-server/commit/b7cba619121aa6f61da15170de41d3c12183582b", "message": "Update imports order based on new linting rule", "committedDate": "2020-06-19T09:02:41Z", "type": "forcePushed"}, {"oid": "cf38817bdb98312bc3d9d88868be044070296aee", "url": "https://github.com/Graylog2/graylog2-server/commit/cf38817bdb98312bc3d9d88868be044070296aee", "message": "Merge branch 'master' into fields-context", "committedDate": "2020-06-22T10:40:34Z", "type": "commit"}]}