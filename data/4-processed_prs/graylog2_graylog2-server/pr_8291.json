{"pr_number": 8291, "pr_title": "Prevent single number widget flickering", "pr_createdAt": "2020-06-05T15:06:44Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8291", "timeline": [{"oid": "8b42bf9a2fe249ef6a6145276b80bb13d8f10c38", "url": "https://github.com/Graylog2/graylog2-server/commit/8b42bf9a2fe249ef6a6145276b80bb13d8f10c38", "message": "Refactor AutoFontSizer code style", "committedDate": "2020-06-05T14:59:20Z", "type": "commit"}, {"oid": "d621ab592c12832f57a79d608297404fb7b08d79", "url": "https://github.com/Graylog2/graylog2-server/commit/d621ab592c12832f57a79d608297404fb7b08d79", "message": "Increase tolerance when calculating most appropriate font size", "committedDate": "2020-06-05T14:59:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDIyMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634220", "bodyText": "Instead of extracting a function for the update step, it would be more helpful to extract a predicate that checks if the new font size should be set, something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                _updateFontSize(setFontSize, fontSize, newFontSize);\n          \n          \n            \n                if (newFontSize !== fontSize && isValidFontSize(newFontSize)) {\n          \n          \n            \n                  setFontSize(newFontSize);\n          \n          \n            \n                }", "author": "dennisoelkers", "createdAt": "2020-06-08T11:43:56Z", "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container\n   const contentWidth = element.offsetWidth;\n   const contentHeight = element.offsetHeight;\n \n-  const widthMultiplier = (targetWidth * 0.8) / contentWidth;\n-  const heightMultiplier = (targetHeight * 0.8) / contentHeight;\n+  const widthMultiplier = (targetWidth * childSizeRatio) / contentWidth;\n+  const heightMultiplier = (targetHeight * childSizeRatio) / contentHeight;\n   return Math.min(widthMultiplier, heightMultiplier);\n };\n \n-const AutoFontSizer = ({ children, target, height, width }: Props) => {\n+const _updateFontSize = (setFontSize, currentSize, newSize) => {\n+  if (currentSize !== newSize && newSize !== 0 && Number.isFinite(newSize)) {\n+    setFontSize(newSize);\n+  }\n+};\n+\n+const useAutoFontSize = (target, _container, height, width) => {\n+  // This hook will update the font size based on the difference between the dimensions of the container and its child.\n+  // The font size is being recalculated, until the mentioned difference is within the tolerance.\n+  const tolerance = 0.05;\n   const [fontSize, setFontSize] = useState(20);\n-  const _container = useRef<?HTMLElement>();\n \n   useEffect(() => {\n     const container = target ? { current: { children: [target] } } : _container;\n-    if (!container.current) {\n-      return;\n-    }\n-\n-    const { children: containerChildren } = container.current;\n+    const containerChildren = container?.current?.children;\n \n-    if (containerChildren.length <= 0) {\n+    if (!containerChildren || containerChildren.length <= 0) {\n       return;\n     }\n \n     const contentElement = containerChildren[0];\n     const multiplier = _multiplierForElement(contentElement, width, height);\n-\n-    if (Math.abs(1 - multiplier) <= 0.01) {\n+    if (Math.abs(1 - multiplier) <= tolerance) {\n       return;\n     }\n \n-    const newFontsize = Math.floor(fontSize * multiplier);\n-\n-    if (fontSize !== newFontsize && newFontsize !== 0 && Number.isFinite(newFontsize)) {\n-      // eslint-disable-next-line react/no-did-update-set-state\n-      setFontSize(newFontsize);\n-    }\n+    const newFontSize = Math.floor(fontSize * multiplier);\n+    _updateFontSize(setFontSize, fontSize, newFontSize);", "originalCommit": "d621ab592c12832f57a79d608297404fb7b08d79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDYyMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634620", "bodyText": "This constant could be pulled out of the function scope and into the module scope. Also: Propotion -> Proportion", "author": "dennisoelkers", "createdAt": "2020-06-08T11:44:54Z", "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container", "originalCommit": "d621ab592c12832f57a79d608297404fb7b08d79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDc2Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634766", "bodyText": "This constant could be pulled out of the function scope and into the module scope.", "author": "dennisoelkers", "createdAt": "2020-06-08T11:45:13Z", "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container\n   const contentWidth = element.offsetWidth;\n   const contentHeight = element.offsetHeight;\n \n-  const widthMultiplier = (targetWidth * 0.8) / contentWidth;\n-  const heightMultiplier = (targetHeight * 0.8) / contentHeight;\n+  const widthMultiplier = (targetWidth * childSizeRatio) / contentWidth;\n+  const heightMultiplier = (targetHeight * childSizeRatio) / contentHeight;\n   return Math.min(widthMultiplier, heightMultiplier);\n };\n \n-const AutoFontSizer = ({ children, target, height, width }: Props) => {\n+const _updateFontSize = (setFontSize, currentSize, newSize) => {\n+  if (currentSize !== newSize && newSize !== 0 && Number.isFinite(newSize)) {\n+    setFontSize(newSize);\n+  }\n+};\n+\n+const useAutoFontSize = (target, _container, height, width) => {\n+  // This hook will update the font size based on the difference between the dimensions of the container and its child.\n+  // The font size is being recalculated, until the mentioned difference is within the tolerance.\n+  const tolerance = 0.05;", "originalCommit": "d621ab592c12832f57a79d608297404fb7b08d79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNDk5Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r436634993", "bodyText": "We should turn this into a JSDoc comment.", "author": "dennisoelkers", "createdAt": "2020-06-08T11:45:42Z", "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -16,45 +16,51 @@ type Props = {\n };\n \n const _multiplierForElement = (element, targetWidth, targetHeight) => {\n+  const childSizeRatio = 0.8; // Propotion of the child size in relation to the container\n   const contentWidth = element.offsetWidth;\n   const contentHeight = element.offsetHeight;\n \n-  const widthMultiplier = (targetWidth * 0.8) / contentWidth;\n-  const heightMultiplier = (targetHeight * 0.8) / contentHeight;\n+  const widthMultiplier = (targetWidth * childSizeRatio) / contentWidth;\n+  const heightMultiplier = (targetHeight * childSizeRatio) / contentHeight;\n   return Math.min(widthMultiplier, heightMultiplier);\n };\n \n-const AutoFontSizer = ({ children, target, height, width }: Props) => {\n+const _updateFontSize = (setFontSize, currentSize, newSize) => {\n+  if (currentSize !== newSize && newSize !== 0 && Number.isFinite(newSize)) {\n+    setFontSize(newSize);\n+  }\n+};\n+\n+const useAutoFontSize = (target, _container, height, width) => {\n+  // This hook will update the font size based on the difference between the dimensions of the container and its child.", "originalCommit": "d621ab592c12832f57a79d608297404fb7b08d79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8307f63253cb7af55d31ee9369a313020c3c0ba9", "url": "https://github.com/Graylog2/graylog2-server/commit/8307f63253cb7af55d31ee9369a313020c3c0ba9", "message": "Refactor AutoFontSizer code style\n\n* Move module constants tolerance and child size ratio to module scope\n* Create separate function to check if a font size is valid\n* Add JSDoc comment for the component\n* Fixing typo", "committedDate": "2020-06-09T12:36:00Z", "type": "commit"}, {"oid": "8307f63253cb7af55d31ee9369a313020c3c0ba9", "url": "https://github.com/Graylog2/graylog2-server/commit/8307f63253cb7af55d31ee9369a313020c3c0ba9", "message": "Refactor AutoFontSizer code style\n\n* Move module constants tolerance and child size ratio to module scope\n* Create separate function to check if a font size is valid\n* Add JSDoc comment for the component\n* Fixing typo", "committedDate": "2020-06-09T12:36:00Z", "type": "forcePushed"}, {"oid": "c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1", "url": "https://github.com/Graylog2/graylog2-server/commit/c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1", "message": "Update AutoFontSizer JSDoc comment", "committedDate": "2020-06-09T12:41:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM5NzcwMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r437397700", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The calculation is based the difference between the dimensions of the container and its child.\n          \n          \n            \n             * The calculation is based on the ratio of the current dimensions of the child and the dimensions of its container.", "author": "dennisoelkers", "createdAt": "2020-06-09T13:03:49Z", "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -2,6 +2,15 @@\n import React, { type Element, type ElementRef, useEffect, useRef, useState } from 'react';\n import styled, { type StyledComponent } from 'styled-components';\n \n+/**\n+ * This component will calculate the largest possible font size for the provided child.\n+ * The calculation is based the difference between the dimensions of the container and its child.", "originalCommit": "c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwMDExNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8291#discussion_r437400116", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The font size is being recalculated, until the mentioned difference is within the defined tolerance.\n          \n          \n            \n             * The font size is being multiplied by this ratio, unless it has a difference to 1 that is smaller than the defined tolerance.", "author": "dennisoelkers", "createdAt": "2020-06-09T13:06:28Z", "path": "graylog2-web-interface/src/views/components/visualizations/number/AutoFontSizer.jsx", "diffHunk": "@@ -2,6 +2,15 @@\n import React, { type Element, type ElementRef, useEffect, useRef, useState } from 'react';\n import styled, { type StyledComponent } from 'styled-components';\n \n+/**\n+ * This component will calculate the largest possible font size for the provided child.\n+ * The calculation is based the difference between the dimensions of the container and its child.\n+ * The font size is being recalculated, until the mentioned difference is within the defined tolerance.", "originalCommit": "c9e3cabba30ccab88741bd49b9a7a7458cc8f5a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a42c245f87d21538b1c0ed9612c8e8ffaa3c564", "url": "https://github.com/Graylog2/graylog2-server/commit/8a42c245f87d21538b1c0ed9612c8e8ffaa3c564", "message": "Improve AutoFontSizer JSDoc comment", "committedDate": "2020-06-09T14:35:35Z", "type": "commit"}]}