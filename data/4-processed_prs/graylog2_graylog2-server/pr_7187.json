{"pr_number": 7187, "pr_title": "Add \"gl2_accounted_message_size\" field to indexed messages", "pr_createdAt": "2020-01-15T13:56:35Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7187", "timeline": [{"oid": "cf8cafc34e9fdaaa308db14bbdd6976a17bbd30a", "url": "https://github.com/Graylog2/graylog2-server/commit/cf8cafc34e9fdaaa308db14bbdd6976a17bbd30a", "message": "Add \"gl2_accounted_message_size\" field to indexed messages\n\nThat field contains the message size that will be accouted for\nEnterprise license checks. It can be used to analyze traffic per stream\nor similar use cases.\n\nThis change adds the new field to all message index templates and writes\nthe field to indexed messages.\n\nCloses #6838", "committedDate": "2020-01-15T13:54:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk3MjI1OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7187#discussion_r366972258", "bodyText": "FWIW, I used:\nfor index in `curl -s localhost:9200/_cat/aliases/*_deflector?h=index`; do    curl -s -X PUT --data '{\"properties\":{\"gl2_accounted_message_size\":{\"type\": \"long\"}}}' -H Content-Type:application/json localhost:9200/$index/_mapping/message ; done\nShould we add that?", "author": "mpfz0r", "createdAt": "2020-01-15T16:22:40Z", "path": "UPGRADING.rst", "diffHunk": "@@ -26,6 +26,25 @@ Indexing Requests use HTTP Expect: 100-Continue Header\n Messages indexing requests to Elasticsearch are now executed with a HTTP Expect-Continue header.\n For the unlikely case that this is creating problems, it can be disabled using the newly introduced ``elasticsearch_use_expect_continue`` setting.\n \n+Accounted Message Size Field\n+============================\n+\n+Every message now includes the ``gl2_accounted_message_size`` field. To make sure this field will be created with the correct data type in all active write indices, the mapping of these indices needs to be updated. New indices created by index rotation will automatically have the correct mapping because the index template got updated automatically.\n+\n+.. warning:: The following steps need to be executed **before** starting the server with the 3.2.0 version!\n+\n+All of the following commands need to be executed against one of the Elasticsearch servers in the cluster.\n+\n+First, a list of all active write indices is needed::\n+\n+  curl -s localhost:9200/_cat/aliases/*_deflector?h=index\n+\n+For each of the index names returned by the previous command, the following command needs to be executed (``<active-write-index-name>`` in the URL needs to be replaced with the actual index name)::\n+\n+  curl -s -X PUT --data '{\"properties\":{\"gl2_accounted_message_size\":{\"type\": \"long\"}}}' -H Content-Type:application/json localhost:9200/<active-write-index-name>/_mapping/message\n+", "originalCommit": "cf8cafc34e9fdaaa308db14bbdd6976a17bbd30a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4NTA0NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7187#discussion_r366985044", "bodyText": "I added it. \ud83d\udc4d", "author": "bernd", "createdAt": "2020-01-15T16:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk3MjI1OA=="}], "type": "inlineReview"}, {"oid": "ac12a4beb670852c2dd31673e45dfef111d7c97f", "url": "https://github.com/Graylog2/graylog2-server/commit/ac12a4beb670852c2dd31673e45dfef111d7c97f", "message": "Fix IndexFieldTypePollerIT test", "committedDate": "2020-01-15T16:42:32Z", "type": "commit"}, {"oid": "408285adf4b68bdd0d66d93408b1d288b09cc74a", "url": "https://github.com/Graylog2/graylog2-server/commit/408285adf4b68bdd0d66d93408b1d288b09cc74a", "message": "Extend upgrade notes", "committedDate": "2020-01-15T16:44:30Z", "type": "commit"}, {"oid": "18cf0aab6c0651e30aea78cc7bf2c1f45a0072b6", "url": "https://github.com/Graylog2/graylog2-server/commit/18cf0aab6c0651e30aea78cc7bf2c1f45a0072b6", "message": "Update reserved fields in MessageFieldsFilter.js", "committedDate": "2020-01-16T11:19:42Z", "type": "commit"}]}