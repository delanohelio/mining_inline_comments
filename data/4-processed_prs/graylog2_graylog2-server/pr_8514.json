{"pr_number": 8514, "pr_title": "Implementing `IndexToolsAdapter` for ES7.", "pr_createdAt": "2020-07-09T12:09:26Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8514", "timeline": [{"oid": "c29908067729f62d91b728c08ef8e9ad69143092", "url": "https://github.com/Graylog2/graylog2-server/commit/c29908067729f62d91b728c08ef8e9ad69143092", "message": "Streamlining and reusing search creation.", "committedDate": "2020-07-16T08:32:59Z", "type": "commit"}, {"oid": "a455f5a16b321ae03b221fa3b109dda4d3d6b748", "url": "https://github.com/Graylog2/graylog2-server/commit/a455f5a16b321ae03b221fa3b109dda4d3d6b748", "message": "Adding `IndexToolsAdapter` for ES7.", "committedDate": "2020-07-16T08:33:01Z", "type": "commit"}, {"oid": "daff881b50db323a3120e116fef2e3a3a7b0a205", "url": "https://github.com/Graylog2/graylog2-server/commit/daff881b50db323a3120e116fef2e3a3a7b0a205", "message": "Do not set limit on scroll command if it is `-1` (disabled).", "committedDate": "2020-07-16T08:33:01Z", "type": "commit"}, {"oid": "556f7fe3c629ddc4249ab56f585b330d0c5f9634", "url": "https://github.com/Graylog2/graylog2-server/commit/556f7fe3c629ddc4249ab56f585b330d0c5f9634", "message": "Adjusting to class renaming.", "committedDate": "2020-07-16T08:34:57Z", "type": "commit"}, {"oid": "556f7fe3c629ddc4249ab56f585b330d0c5f9634", "url": "https://github.com/Graylog2/graylog2-server/commit/556f7fe3c629ddc4249ab56f585b330d0c5f9634", "message": "Adjusting to class renaming.", "committedDate": "2020-07-16T08:34:57Z", "type": "forcePushed"}, {"oid": "49d362a81920a3d08e7ec0128608cd7655fd4106", "url": "https://github.com/Graylog2/graylog2-server/commit/49d362a81920a3d08e7ec0128608cd7655fd4106", "message": "Reusing constants for disabling limit/batch size.", "committedDate": "2020-07-16T09:27:58Z", "type": "commit"}, {"oid": "bc219cddfd218a9875df2ef2ab30d97ddfe42fad", "url": "https://github.com/Graylog2/graylog2-server/commit/bc219cddfd218a9875df2ef2ab30d97ddfe42fad", "message": "Removing unused method.", "committedDate": "2020-07-16T09:30:31Z", "type": "commit"}, {"oid": "2777cbdba6430c6ba3c53933e8ea4070f8d19228", "url": "https://github.com/Graylog2/graylog2-server/commit/2777cbdba6430c6ba3c53933e8ea4070f8d19228", "message": "Pulling inner class out.", "committedDate": "2020-07-16T09:32:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2ODIwMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#discussion_r455668202", "bodyText": "DateHistogramAggregationBuilder#interval is deprecated. I think we should use fixedInterval instead.", "author": "alex-konn", "createdAt": "2020-07-16T09:55:33Z", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/IndexToolsAdapterES7.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.support.IndicesOptions;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.core.CountRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.client.core.CountResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.AggregationBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.filter.Filter;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.filter.FilterAggregationBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.histogram.ParsedDateHistogram;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.bucket.terms.Terms;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog2.indexer.IndexToolsAdapter;\n+import org.graylog2.plugin.Message;\n+import org.graylog2.plugin.streams.Stream;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeZone;\n+\n+import javax.inject.Inject;\n+import java.time.ZonedDateTime;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.boolQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.existsQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.termsQuery;\n+\n+public class IndexToolsAdapterES7 implements IndexToolsAdapter {\n+    private static final String AGG_DATE_HISTOGRAM = \"source_date_histogram\";\n+    private static final String AGG_MESSAGE_FIELD = \"message_field\";\n+    private static final String AGG_FILTER = \"message_filter\";\n+    private final ElasticsearchClient client;\n+\n+    @Inject\n+    public IndexToolsAdapterES7(ElasticsearchClient client) {\n+        this.client = client;\n+    }\n+\n+    @Override\n+    public Map<DateTime, Map<String, Long>> fieldHistogram(String fieldName, Set<String> indices, Optional<Set<String>> includedStreams, long interval) {\n+        final BoolQueryBuilder queryBuilder = buildStreamIdFilter(includedStreams);\n+\n+        final FilterAggregationBuilder the_filter = AggregationBuilders.filter(AGG_FILTER, queryBuilder)\n+                .subAggregation(AggregationBuilders.dateHistogram(AGG_DATE_HISTOGRAM)\n+                        .field(\"timestamp\")\n+                        .subAggregation(AggregationBuilders.terms(AGG_MESSAGE_FIELD).field(fieldName))\n+                        .interval(interval)", "originalCommit": "2777cbdba6430c6ba3c53933e8ea4070f8d19228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0MTc2OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#discussion_r455741768", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-07-16T12:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2ODIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4NDY5MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#discussion_r455684690", "bodyText": "I think we should centralize this logic somewhere. Equivalent methods are also contained in IndexToolsAdapterES6, indexToolsAdapterES7, and SearchesAdapterES6.", "author": "alex-konn", "createdAt": "2020-07-16T10:25:10Z", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/SearchRequestFactory.java", "diffHunk": "@@ -73,27 +88,51 @@ public SearchSourceBuilder create(SearchesConfig config) {\n                     .numOfFragments(0);\n             searchSourceBuilder.highlighter(highlightBuilder);\n         }\n+    }\n \n-        return searchSourceBuilder;\n+    private void applyPaginationIfPresent(SearchSourceBuilder searchSourceBuilder, SearchCommand command) {\n+        command.offset().ifPresent(searchSourceBuilder::from);\n+        command.limit().ifPresent(searchSourceBuilder::size);\n     }\n \n-    @Nullable\n-    private QueryBuilder standardFilters(TimeRange range, String filter) {\n-        BoolQueryBuilder bfb = null;\n \n-        if (range != null) {\n-            bfb = QueryBuilders.boolQuery()\n-                    .must(TimeRangeQueryFactory.create(range));\n-        }\n+    private void applyStreamsFilter(BoolQueryBuilder filteredQueryBuilder, SearchCommand command) {\n+        command.streams()\n+                .map(this::buildStreamIdFilter)\n+                .ifPresent(filteredQueryBuilder::filter);\n+    }\n+\n+    private BoolQueryBuilder buildStreamIdFilter(Set<String> streams) {", "originalCommit": "2777cbdba6430c6ba3c53933e8ea4070f8d19228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0MjAyNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#discussion_r455742024", "bodyText": "Same here. I would prefer to do this in a separate PR though, as it is non-trivial to make it usable across multiple storage driver modules.", "author": "dennisoelkers", "createdAt": "2020-07-16T12:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4NDY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3NDI1MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8514#discussion_r455774250", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-07-16T13:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4NDY5MA=="}], "type": "inlineReview"}, {"oid": "4b6eabdc2fec900e8f8bcd615acbd485fa4b0b2f", "url": "https://github.com/Graylog2/graylog2-server/commit/4b6eabdc2fec900e8f8bcd615acbd485fa4b0b2f", "message": "Replacing deprecated `interval` with `fixedInterval`.", "committedDate": "2020-07-16T12:16:27Z", "type": "commit"}]}