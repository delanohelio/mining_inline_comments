{"pr_number": 9472, "pr_title": "Update UPGRADING for 4.0", "pr_createdAt": "2020-11-12T14:09:38Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9472", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEzOTA1Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9472#discussion_r522139057", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Additionally, due to the fact that Elasticsearch supports only indices created by the last two major versions (i.e. ES6.8.0+ reads indices created by ES5 & ES6, ES7 reads indices created by ES6 & ES7), you can change to Graylog v4.0 with an Elasticsearch update without reindexing only if you have been on at least Elasticsearch v6.0.0 before.\n          \n          \n            \n            Additionally, due to the fact that Elasticsearch supports only indices created by the last two major versions (i.e. ES6.8.0+ reads indices created by ES5 & ES6, while ES7 reads indices created by ES6 & ES7), you can change to Graylog v4.0 with an Elasticsearch update without reindexing only if you have been on at least Elasticsearch v6.0.0 before.\n          \n      \n    \n    \n  \n\nI find it easier to read that way", "author": "mpfz0r", "createdAt": "2020-11-12T14:18:30Z", "path": "UPGRADING.rst", "diffHunk": "@@ -4,79 +4,156 @@ Upgrading to Graylog 4.0.x\n \n .. _upgrade-from-33-to-40:\n \n-Deprecation of cluster stats endpoints\n-======================================\n+.. contents:: Overview\n+   :depth: 3\n+   :backlinks: top\n \n-Starting with v4.0, the cluster stats endpoints are deprecated and will be removed in a future version. Those include:\n+Breaking Changes\n+================\n+\n+Changes to the Elasticsearch Support\n+------------------------------------\n+\n+Starting with Graylog v4.0, bigger changes to the Elasticsearch versions supported are happening:\n+\n+  - Support for Elasticsearch versions prior to v6.8.0 are dropped.\n+  - Support for Elasticsearch v7.x is now included.\n+\n+This means that you can upgrade to Graylog v4.0 without an Elasticsearch update only if you have been on at least Elasticsearch v6.8.0 before.\n+Additionally, due to the fact that Elasticsearch supports only indices created by the last two major versions (i.e. ES6.8.0+ reads indices created by ES5 & ES6, ES7 reads indices created by ES6 & ES7), you can change to Graylog v4.0 with an Elasticsearch update without reindexing only if you have been on at least Elasticsearch v6.0.0 before.", "originalCommit": "3a54c1635975ffab1aa787468d01e20244536e60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE0OTgxNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9472#discussion_r522149814", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - ``/system/cluster/stats`\n          \n          \n            \n            - ``/system/cluster/stats``\n          \n      \n    \n    \n  \n\nI guess that needs two backticks as well", "author": "mpfz0r", "createdAt": "2020-11-12T14:32:33Z", "path": "UPGRADING.rst", "diffHunk": "@@ -4,79 +4,156 @@ Upgrading to Graylog 4.0.x\n \n .. _upgrade-from-33-to-40:\n \n-Deprecation of cluster stats endpoints\n-======================================\n+.. contents:: Overview\n+   :depth: 3\n+   :backlinks: top\n \n-Starting with v4.0, the cluster stats endpoints are deprecated and will be removed in a future version. Those include:\n+Breaking Changes\n+================\n+\n+Changes to the Elasticsearch Support\n+------------------------------------\n+\n+Starting with Graylog v4.0, bigger changes to the Elasticsearch versions supported are happening:\n+\n+  - Support for Elasticsearch versions prior to v6.8.0 are dropped.\n+  - Support for Elasticsearch v7.x is now included.\n+\n+This means that you can upgrade to Graylog v4.0 without an Elasticsearch update only if you have been on at least Elasticsearch v6.8.0 before.\n+Additionally, due to the fact that Elasticsearch supports only indices created by the last two major versions (i.e. ES6.8.0+ reads indices created by ES5 & ES6, while ES7 reads indices created by ES6 & ES7), you can change to Graylog v4.0 with an Elasticsearch update without reindexing only if you have been on at least Elasticsearch v6.0.0 before.\n+If you have been on any older Elasticsearch version you need to reindex every index you want to keep once for every two major versions of Elasticsearch up to at least ES6.\n+\n+When upgrading Elasticsearch from one major version to another, please read the upgrade guides provided by elastic:\n+\n+  - `To 6.8.0 <https://www.elastic.co/guide/en/elasticsearch/reference/6.8/setup-upgrade.html>`_\n+  - `To 7.9.0 <https://www.elastic.co/guide/en/elasticsearch/reference/7.9/setup-upgrade.html>`_\n \n-  - '/system/cluster/stats'\n-  - '/system/cluster/stats/elasticsearch'\n-  - '/system/cluster/stats/mongo'\n+as well as our :ref:`Elasticsearch Upgrade Notes <upgrading-elasticsearch>`.\n \n-[BREAKING] Fixing certificate validation for LDAP servers used for authentication\n-=================================================================================\n+Please do notice that Graylog does not support rolling upgrades between major versions, while Elasticsearch does. If you are upgrading from one major version of Elasticsearch to another, you need to restart Graylog in order to reinitialize the storage module. A procedure which allows a rolling upgrade of Elasticsearch between two major versions of a multi-node Graylog cluster is outlined :ref:`here <es_rolling_upgrade>`.\n+\n+Fixing certificate validation for LDAP servers used for authentication\n+----------------------------------------------------------------------\n \n Prior to v3.3.3, the certificates of LDAP servers which are connected to using a secure connection (SSL or TLS) were not validated, even if the \"Allow self-signed certificates\" option was unchecked. Starting with v3.3.3, certificates are validated against the local default keystore. This might introduce a breaking change, depending on your local LDAP settings and the validity of the certificates used (if any). Please ensure that all certificates used are valid, their common name matches the host part of your configured LDAP server and your local keystore contains all CA/intermediate certs required for validation.\n \n A `CVE <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15813>`_ is tracked for this issue.\n \n Change of API endpoint for user retrieval and modification\n-==========================================================\n+----------------------------------------------------------\n+\n+In 4.0 we changed the following user API endpoints to expect a user ID parameter instead of the username:\n+\n++-----------------------------------------------------------------------------+\n+| Endpoint                                      | Description                 |\n++=============================================================================+\n+| ``PUT /users/{userId}``                       | Update user account         |\n++-----------------------------------------------------------------------------+\n+| ``PUT /users/{userId}/password``              | Update user password        |\n++-----------------------------------------------------------------------------+\n+| ``GET /users/{userId}/tokens``                | Get user tokens             |\n++-----------------------------------------------------------------------------+\n+| ``POST /users/{userId}/tokens/{name}``        | Generate new user API token |\n++-----------------------------------------------------------------------------+\n+| ``DELETE /users/{userId}/tokens/{idOrToken}`` | Delete user API token       |\n++-----------------------------------------------------------------------------+\n+\n+Disabled Cross-Origin Requests by Default\n+-----------------------------------------\n+\n+For improved security, Cross-Origin requests towards the API server are now disallowed by default.\n+In the rare case, that your setup is serving the frontend assets from a different\n+origin than the server, you can re-enable this with ``http_enable_cors = true`` in ``graylog.conf``.\n+\n+Removal of pluggable authentication realm Java APIs\n+---------------------------------------------------\n+\n+The Java API to implement custom authentication realms has been removed and got replaced with with the ``AuthServiceBackend`` Java API.\n+\n+SSO Authentication Plugin\n+-------------------------\n+\n+Due to the aforementioned removal of the pluggable authentication realm Java APIS, the `SSO Authentication Plugin <https://github.com/Graylog2/graylog-plugin-auth-sso>`_ doesn't work with Graylog 4.0 anymore.\n \n-In 4.0 we changed most of the user API endpoint `/users` to expect user IDs instead of names.\n+The core feature of the old SSO plugin (trusted HTTP header authentication) got integrated in the server.\n+\n+The old SSO plugin **must be removed** from the plugin folder before starting a Graylog 4.0 server.\n+\n+\n+API Endpoint Deprecations\n+=========================\n+\n+The following API endpoints are deprecated beginning with 4.0.\n+\n+Deprecation of cluster stats endpoints\n+--------------------------------------\n+\n+Starting with v4.0, the cluster stats endpoints are deprecated and will be removed in a future version. Those include:\n+\n+- ``/system/cluster/stats`", "originalCommit": "c16773242af886f88e7cf706ca886e13f0113748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE2MzYyNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9472#discussion_r522163624", "bodyText": "I know I am correcting myself, but it should be is dropped, not are dropped :)", "author": "dennisoelkers", "createdAt": "2020-11-12T14:50:21Z", "path": "UPGRADING.rst", "diffHunk": "@@ -4,79 +4,156 @@ Upgrading to Graylog 4.0.x\n \n .. _upgrade-from-33-to-40:\n \n-Deprecation of cluster stats endpoints\n-======================================\n+.. contents:: Overview\n+   :depth: 3\n+   :backlinks: top\n \n-Starting with v4.0, the cluster stats endpoints are deprecated and will be removed in a future version. Those include:\n+Breaking Changes\n+================\n+\n+Changes to the Elasticsearch Support\n+------------------------------------\n+\n+Starting with Graylog v4.0, bigger changes to the Elasticsearch versions supported are happening:\n+\n+  - Support for Elasticsearch versions prior to v6.8.0 are dropped.", "originalCommit": "185465613b60880d1b46bf96188a7e85fcdf7cec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE3Nzc4NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9472#discussion_r522177785", "bodyText": "@dennisoelkers Thanks, I pushed a fix!", "author": "bernd", "createdAt": "2020-11-12T15:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE2MzYyNA=="}], "type": "inlineReview"}, {"oid": "0817659d7438554ad9d0afdc31707193ff0a31da", "url": "https://github.com/Graylog2/graylog2-server/commit/0817659d7438554ad9d0afdc31707193ff0a31da", "message": "Update UPGRADING for 4.0\n\nCo-authored-by: Marco Pfatschbacher <marco@graylog.com>", "committedDate": "2020-11-17T14:16:05Z", "type": "forcePushed"}, {"oid": "7f5db1ccc66b54b07d39c76a105819f1bb110e69", "url": "https://github.com/Graylog2/graylog2-server/commit/7f5db1ccc66b54b07d39c76a105819f1bb110e69", "message": "Update UPGRADING for 4.0\n\nCo-authored-by: Marco Pfatschbacher <marco@graylog.com>", "committedDate": "2020-11-17T14:21:46Z", "type": "commit"}, {"oid": "7f5db1ccc66b54b07d39c76a105819f1bb110e69", "url": "https://github.com/Graylog2/graylog2-server/commit/7f5db1ccc66b54b07d39c76a105819f1bb110e69", "message": "Update UPGRADING for 4.0\n\nCo-authored-by: Marco Pfatschbacher <marco@graylog.com>", "committedDate": "2020-11-17T14:21:46Z", "type": "forcePushed"}]}