{"pr_number": 9374, "pr_title": "Implement and enforce user account status", "pr_createdAt": "2020-11-05T16:22:15Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9374", "timeline": [{"oid": "9b2e1fd1802acb85b5dbc9f1c6428711974a282d", "url": "https://github.com/Graylog2/graylog2-server/commit/9b2e1fd1802acb85b5dbc9f1c6428711974a282d", "message": "Add AccountStatus field to User", "committedDate": "2020-11-05T15:24:59Z", "type": "commit"}, {"oid": "fee5799aee02356386d73ee76473400046caf7d4", "url": "https://github.com/Graylog2/graylog2-server/commit/fee5799aee02356386d73ee76473400046caf7d4", "message": "Add UserAccountControl and status to LdapEntry and UserDetails", "committedDate": "2020-11-05T15:24:59Z", "type": "commit"}, {"oid": "92e37f8b3a8290d35f8847b86c28a6d71cd7c0e8", "url": "https://github.com/Graylog2/graylog2-server/commit/92e37f8b3a8290d35f8847b86c28a6d71cd7c0e8", "message": "Try to cope with incomplete LDAP user entries.\n\n - If we can't get the userNameAttribute, simply use the username\n - Fill in dummy email address if none can't be found", "committedDate": "2020-11-05T15:24:59Z", "type": "commit"}, {"oid": "317a9be9c3167aa3252700365d2dac1915b735be", "url": "https://github.com/Graylog2/graylog2-server/commit/317a9be9c3167aa3252700365d2dac1915b735be", "message": "Also provision accounts that failed to login\n\nReverse the order: First provision, then try to login.\nThis is needed, because we otherwise can't update the disabled status\nflag for accounts.", "committedDate": "2020-11-05T15:24:59Z", "type": "commit"}, {"oid": "74d53f713d617be3fcb44ca538061576d96177e4", "url": "https://github.com/Graylog2/graylog2-server/commit/74d53f713d617be3fcb44ca538061576d96177e4", "message": "Prevent user logins for disabled accounts", "committedDate": "2020-11-05T15:25:00Z", "type": "commit"}, {"oid": "92dfa0e9d9695192d67071798f6fe3c96c4c700b", "url": "https://github.com/Graylog2/graylog2-server/commit/92dfa0e9d9695192d67071798f6fe3c96c4c700b", "message": "Add account_status to UserSummary", "committedDate": "2020-11-05T15:25:00Z", "type": "commit"}, {"oid": "5b45e210a07290ad39559298a943813488589985", "url": "https://github.com/Graylog2/graylog2-server/commit/5b45e210a07290ad39559298a943813488589985", "message": "Add endpoint to modify user acount status", "committedDate": "2020-11-05T16:19:23Z", "type": "commit"}, {"oid": "71425e8349ab1a35349124229861a06d02c375fb", "url": "https://github.com/Graylog2/graylog2-server/commit/71425e8349ab1a35349124229861a06d02c375fb", "message": "Add auditevent", "committedDate": "2020-11-05T16:33:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNDQyNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518224424", "bodyText": "See comment in LDAPUser.", "author": "bernd", "createdAt": "2020-11-05T17:23:03Z", "path": "graylog2-server/src/main/java/org/graylog/security/authservice/ldap/LDAPEntry.java", "diffHunk": "@@ -35,6 +35,8 @@\n \n     public abstract String base64UniqueId();\n \n+    public abstract ADUserAccountControl userAccountControl();", "originalCommit": "71425e8349ab1a35349124229861a06d02c375fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNTc3Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518225773", "bodyText": "I don't think we should put AD specific code into the LDAPEntry and LDAPUser objects. How about using the AccountStatus instead? That makes it independent from AD. We could extract the AccountStatus into a separate enum out of the User interface to make it a bit more generic.\nWhat do you think?\nI also think we should only have an accountStatus() method in LDAPUser instead of also putting it into the LDAPEntry object. The LDAPEntry object is supposed to be generic. We can move the userAccountControl parsing into the createLDAPUser() method in UnboundLDAPConnector.", "author": "bernd", "createdAt": "2020-11-05T17:25:03Z", "path": "graylog2-server/src/main/java/org/graylog/security/authservice/ldap/LDAPUser.java", "diffHunk": "@@ -22,6 +22,8 @@\n public abstract class LDAPUser {\n     public abstract String base64UniqueId();\n \n+    public abstract ADUserAccountControl userAccountControl();", "originalCommit": "71425e8349ab1a35349124229861a06d02c375fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYyMTQyNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518621425", "bodyText": "I could remove it from LDAPEntry, because it would be still accessible within the attributes map.\nBut I'm not sure about using AccountStatus for that. A simple enum cannot reflect the userAccountControl flags.", "author": "mpfz0r", "createdAt": "2020-11-06T09:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNTc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYyNTgzNw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518625837", "bodyText": "Ah, right. But do we need all the flags? We are only interested in the the account status here, no?", "author": "bernd", "createdAt": "2020-11-06T09:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNTc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NDU0OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518644548", "bodyText": "If we want to display them in the test result.\nI don't see any other way right now :-/", "author": "mpfz0r", "createdAt": "2020-11-06T10:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNTc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0OTE4NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518649184", "bodyText": "Okay, if it's just for the test result I am fine with leaving the flags out. \ud83d\ude04 We can still show if a user is enabled/disabled in the test result.", "author": "bernd", "createdAt": "2020-11-06T10:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNTc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY2MjMyNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518662326", "bodyText": "ok. \ud83d\uddd1\ufe0f", "author": "mpfz0r", "createdAt": "2020-11-06T10:33:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIyNTc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MjUyMQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518242521", "bodyText": "How about only putting in the userAccountControl attribute as key and then all values as named flags?\n\"userAccountControl\": \"ACCOUNTDISABLED|NORMAL_ACCOUNT|PASSWORD_EXPIRED\"\n\nI think that would make it a bit clearer to AD admins. account_disabled, normal_user_account and password_expired are not really AD attributes.", "author": "bernd", "createdAt": "2020-11-05T17:45:52Z", "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java", "diffHunk": "@@ -257,13 +258,17 @@ private ADAuthServiceBackendConfig buildTestConfig(@Nullable AuthServiceBackendD\n                 .put(\"login_success\", loginSuccess);\n \n         if (user != null) {\n-            userDetails.put(\"user_details\", ImmutableMap.of(\n-                    \"dn\", user.dn(),\n-                    AD_OBJECT_GUID, user.base64UniqueId(),\n-                    config.userNameAttribute(), user.username(),\n-                    config.userFullNameAttribute(), user.fullName(),\n-                    \"email\", user.email()\n-            ));\n+            userDetails.put(\"user_details\", ImmutableMap.<String, String>builder()\n+                    .put(\"dn\", user.dn())\n+                    .put(\"account_disabled\", String.valueOf(user.userAccountControl().accountIsDisabled()))\n+                    .put(\"normal_user_account\", String.valueOf(user.userAccountControl().isUserAccount()))\n+                    .put(\"password_expired\", String.valueOf(user.userAccountControl().passwordExpired()))", "originalCommit": "71425e8349ab1a35349124229861a06d02c375fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYyMTU4MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518621581", "bodyText": "sure, I can do that.", "author": "mpfz0r", "createdAt": "2020-11-06T09:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MjUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MzkzNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518243936", "bodyText": "Can you please add a comment about why we first provision and then authenticate?", "author": "bernd", "createdAt": "2020-11-05T17:47:55Z", "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/LDAPAuthServiceBackend.java", "diffHunk": "@@ -77,23 +77,24 @@ public LDAPAuthServiceBackend(UnboundLDAPConnector ldapConnector,\n \n             final LDAPUser userEntry = optionalUser.get();\n \n-            if (!authCredentials.isAuthenticated()) {\n-                if (!isAuthenticated(connection, userEntry, authCredentials)) {\n-                    LOG.debug(\"Invalid credentials for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n-                    return Optional.empty();\n-                }\n-            }\n-\n             final UserDetails userDetails = provisionerService.provision(provisionerService.newDetails(this)\n                     .authServiceType(backendType())\n                     .authServiceId(backendId())\n+                    .accountIsEnabled(true)\n                     .base64AuthServiceUid(userEntry.base64UniqueId())\n                     .username(userEntry.username())\n                     .fullName(userEntry.fullName())\n                     .email(userEntry.email())\n                     .defaultRoles(backend.defaultRoles())\n                     .build());\n \n+            if (!authCredentials.isAuthenticated()) {", "originalCommit": "71425e8349ab1a35349124229861a06d02c375fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY4NzI3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518687279", "bodyText": "I've changed my mind about changing this. We'll have to refactor this at some point anyhow.\nI'm leaving this untouched, as this is too close to release", "author": "mpfz0r", "createdAt": "2020-11-06T11:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MzkzNg=="}], "type": "inlineReview"}, {"oid": "016b21e5a0dd517d182bed4778561589379ab605", "url": "https://github.com/Graylog2/graylog2-server/commit/016b21e5a0dd517d182bed4778561589379ab605", "message": "Print userAccountControl as flags", "committedDate": "2020-11-06T09:46:45Z", "type": "commit"}, {"oid": "6927c63711fd221c813d9279be14cf123d2e2042", "url": "https://github.com/Graylog2/graylog2-server/commit/6927c63711fd221c813d9279be14cf123d2e2042", "message": "Remove ADUserAccountControl from LDAPUser and LDAPEntry.\n\nThis means the test result can only show whether an account is\nenabled/disabled.", "committedDate": "2020-11-06T10:50:58Z", "type": "commit"}, {"oid": "ca3d16472c92abd5b5e66b53ff48417f2dae1ae9", "url": "https://github.com/Graylog2/graylog2-server/commit/ca3d16472c92abd5b5e66b53ff48417f2dae1ae9", "message": "Restore original authenticateAndProvision order", "committedDate": "2020-11-06T11:16:05Z", "type": "commit"}, {"oid": "9adb2b849a8553115d9918c7ba56c12f7c19bb27", "url": "https://github.com/Graylog2/graylog2-server/commit/9adb2b849a8553115d9918c7ba56c12f7c19bb27", "message": "Double check that an account is enabled in AD\n\nThis deliberately ignores the pre-auth flag set by the\nHTTPHeaderAuthRealm.", "committedDate": "2020-11-06T12:08:19Z", "type": "commit"}, {"oid": "7c8448581cf7fb291c812841461a24ecbd729d58", "url": "https://github.com/Graylog2/graylog2-server/commit/7c8448581cf7fb291c812841461a24ecbd729d58", "message": "Merge remote-tracking branch 'origin/master' into issue-9077", "committedDate": "2020-11-06T12:39:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkwOTY4Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518909682", "bodyText": "Let's add a @NonBlank annotation here to make sure we always have a non-empty string.", "author": "bernd", "createdAt": "2020-11-06T17:50:30Z", "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/users/UsersResource.java", "diffHunk": "@@ -546,6 +547,28 @@ public void changePassword(\n         }\n     }\n \n+    @PUT\n+    @Path(\"{userId}/status/{newStatus}\")\n+    @Consumes(MediaType.WILDCARD)\n+    @ApiOperation(\"Update the account status for a user\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    public Response updateAccountStatus(\n+            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true) @PathParam(\"userId\") String userId,\n+            @ApiParam(name = \"newStatus\", value = \"The account status to be set\", required = true,\n+                    defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n+            @PathParam(\"newStatus\") String newStatus) throws ValidationException {", "originalCommit": "7c8448581cf7fb291c812841461a24ecbd729d58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkxMDQwNw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518910407", "bodyText": "How about moving the save() here? That way to don't touch the database object if nothing would change. (and prevent potential race conditions)", "author": "bernd", "createdAt": "2020-11-06T17:51:46Z", "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/users/UsersResource.java", "diffHunk": "@@ -546,6 +547,28 @@ public void changePassword(\n         }\n     }\n \n+    @PUT\n+    @Path(\"{userId}/status/{newStatus}\")\n+    @Consumes(MediaType.WILDCARD)\n+    @ApiOperation(\"Update the account status for a user\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    public Response updateAccountStatus(\n+            @ApiParam(name = \"userId\", value = \"The id of the user whose status to change.\", required = true) @PathParam(\"userId\") String userId,\n+            @ApiParam(name = \"newStatus\", value = \"The account status to be set\", required = true,\n+                    defaultValue = \"enabled\", allowableValues = \"enabled,disabled,deleted\")\n+            @PathParam(\"newStatus\") String newStatus) throws ValidationException {\n+\n+        final User user = loadUserById(userId);\n+        final User.AccountStatus oldStatus = user.getAccountStatus();\n+        user.setAccountStatus(User.AccountStatus.valueOf(newStatus.toUpperCase(Locale.US)));\n+        userService.save(user);\n+\n+        if (oldStatus.equals(user.getAccountStatus())) {\n+            return Response.notModified().build();\n+        }\n+        return Response.ok().build();", "originalCommit": "7c8448581cf7fb291c812841461a24ecbd729d58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyMTg3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r518921879", "bodyText": "How about moving this up in front of the if (!authCredentials.isAuthenticated()) { line? That way we get the warning when a disabled user tries to log in. Otherwise we will never see the warning because the authentication doesn't work.\ndiff --git graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java\nindex 17ac8a96a0..71a44266c5 100644\n--- graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java\n+++ graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java\n@@ -92,16 +92,16 @@ public class ADAuthServiceBackend implements AuthServiceBackend {\n \n             final LDAPUser userEntry = optionalUser.get();\n \n+            if (!userEntry.accountIsEnabled()) {\n+                LOG.warn(\"Account disabled within Active Directory for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n+                return Optional.empty();\n+            }\n             if (!authCredentials.isAuthenticated()) {\n                 if (!isAuthenticated(connection, userEntry, authCredentials)) {\n                     LOG.debug(\"Invalid credentials for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n                     return Optional.empty();\n                 }\n             }\n-            if (!userEntry.accountIsEnabled()) {\n-                LOG.warn(\"Account disabled within Active Directory for user <{}> (DN: {})\", authCredentials.username(), userEntry.dn());\n-                return Optional.empty();\n-            }\n \n             final UserDetails userDetails = provisionerService.provision(provisionerService.newDetails(this)\n                     .authServiceType(backendType())", "author": "bernd", "createdAt": "2020-11-06T18:13:51Z", "path": "graylog2-server/src/main/java/org/graylog/security/authservice/backend/ADAuthServiceBackend.java", "diffHunk": "@@ -98,12 +98,17 @@ public ADAuthServiceBackend(UnboundLDAPConnector ldapConnector,\n                     return Optional.empty();\n                 }\n             }\n+            if (!userEntry.accountIsEnabled()) {", "originalCommit": "7c8448581cf7fb291c812841461a24ecbd729d58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODMwMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9374#discussion_r519668300", "bodyText": "sure. makes sense", "author": "mpfz0r", "createdAt": "2020-11-09T09:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyMTg3OQ=="}], "type": "inlineReview"}, {"oid": "fa57c4c787ea6eb2684807236f58c021d70e6223", "url": "https://github.com/Graylog2/graylog2-server/commit/fa57c4c787ea6eb2684807236f58c021d70e6223", "message": "Fix review comments", "committedDate": "2020-11-09T09:37:52Z", "type": "commit"}]}