{"pr_number": 8885, "pr_title": "Prevent to remove last owner", "pr_createdAt": "2020-08-28T09:44:30Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8885", "timeline": [{"oid": "a5b3b526785b32a574510f93ba5a69022686739b", "url": "https://github.com/Graylog2/graylog2-server/commit/a5b3b526785b32a574510f93ba5a69022686739b", "message": "Bring back falsly deleted test", "committedDate": "2020-09-01T09:28:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjM0OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8885#discussion_r481142349", "bodyText": "console.log", "author": "linuspahl", "createdAt": "2020-09-01T13:36:16Z", "path": "graylog2-web-interface/src/logic/permissions/EntityShareState.js", "diffHunk": "@@ -156,10 +168,12 @@ export default class EntityShareState {\n       active_shares: activeShares,\n       selected_grantee_capabilities: selectedGranteeCapabilities,\n       missing_permissions_on_dependencies: missingDependencies,\n+      validation_result: validationResults,\n     };\n   }\n \n   static fromJSON(value: EntityShareStateJson): EntityShareState {\n+    console.log('entity share state: fromJson', value);", "originalCommit": "a5b3b526785b32a574510f93ba5a69022686739b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NzY5Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8885#discussion_r481147692", "bodyText": "This results in an eslint warning regarding the empty line between import statements + another one for the quotes.", "author": "linuspahl", "createdAt": "2020-09-01T13:43:35Z", "path": "graylog2-web-interface/test/fixtures/entityShareState.js", "diffHunk": "@@ -6,6 +6,7 @@ import Grantee from 'logic/permissions/Grantee';\n import Capability from 'logic/permissions/Capability';\n import SharedEntity from 'logic/permissions/SharedEntity';\n import ActiveShare from 'logic/permissions/ActiveShare';\n+import ValidationResult from \"../../src/logic/permissions/ValidationResult\";", "originalCommit": "a5b3b526785b32a574510f93ba5a69022686739b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0OTQ5Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8885#discussion_r481149492", "bodyText": "All four eslint-disable-next-line no-undef comments are not necessary in for these cases.", "author": "linuspahl", "createdAt": "2020-09-01T13:46:10Z", "path": "graylog2-web-interface/src/logic/permissions/ValidationResult.js", "diffHunk": "@@ -0,0 +1,145 @@\n+// @flow strict\n+import * as Immutable from 'immutable';\n+\n+import type { GRN } from './types';\n+\n+type Errors = {\n+  selectedGranteeCapabilities: Immutable.List<string>,\n+};\n+\n+type ErrorContext = {\n+  selectedGranteeCapabilities: Immutable.List<GRN>,\n+};\n+\n+type InternalState = {\n+  errors: Errors,\n+  errorContext: ErrorContext,\n+  failed: boolean,\n+};\n+\n+export type ValidationResultJSON = {\n+  errors: {\n+    selected_grantee_capabilities: string[],\n+  },\n+  error_context: {\n+    selected_grantee_capabilities: string[],\n+  },\n+  failed: boolean,\n+};\n+\n+export default class ValidationResult {\n+  _value: InternalState;\n+\n+  // eslint-disable-next-line no-undef\n+  constructor(\n+    errors: $PropertyType<InternalState, 'errors'>,\n+    errorContext: $PropertyType<InternalState, 'errorContext'>,\n+    failed: $PropertyType<InternalState, 'failed'>,\n+  ) {\n+    this._value = {\n+      errors,\n+      errorContext,\n+      failed,\n+    };\n+  }\n+\n+  get errors() {\n+    return this._value.errors;\n+  }\n+\n+  get errorContext() {\n+    return this._value.errorContext;\n+  }\n+\n+  get failed() {\n+    return this._value.failed;\n+  }\n+\n+  toBuilder() {\n+    const {\n+      errors,\n+      errorContext,\n+      failed,\n+    } = this._value;\n+\n+    // eslint-disable-next-line no-use-before-define\n+    return new Builder(Immutable.Map({\n+      errors,\n+      errorContext,\n+      failed,\n+    }));\n+  }\n+\n+  // eslint-disable-next-line no-undef\n+  static create(\n+    errors: $PropertyType<InternalState, 'errors'>,\n+    errorContext: $PropertyType<InternalState, 'errorContext'>,\n+    failed: $PropertyType<InternalState, 'failed'>,\n+  ) {\n+    return new ValidationResult(errors, errorContext, failed);\n+  }\n+\n+  toJSON() {\n+    const { errors, errorContext, failed } = this._value;\n+\n+    return {\n+      errors: {\n+        selected_grantee_capabilities: errors.selectedGranteeCapabilities,\n+      },\n+      error_context: {\n+        selected_grantee_capabilities: errorContext.selectedGranteeCapabilities,\n+      },\n+      failed,\n+    };\n+  }\n+\n+  static fromJSON(value: ValidationResultJSON = {}) {\n+    // eslint-disable-next-line camelcase\n+    const { errors: errorsJson = {}, error_context = {}, failed } = value;\n+    const errors = {\n+      selectedGranteeCapabilities: Immutable.List(errorsJson.selected_grantee_capabilities),\n+    };\n+\n+    const errorContext = {\n+      selectedGranteeCapabilities: Immutable.List(error_context.selected_grantee_capabilities),\n+    };\n+\n+    return ValidationResult.create(errors, errorContext, failed);\n+  }\n+\n+  static builder() {\n+    // eslint-disable-next-line no-use-before-define\n+    return new Builder();\n+  }\n+}\n+\n+type BuilderState = Immutable.Map<string, any>;\n+\n+class Builder {\n+  value: BuilderState;\n+\n+  constructor(value: BuilderState = Immutable.Map()) {\n+    this.value = value;\n+  }\n+\n+  // eslint-disable-next-line no-undef", "originalCommit": "a5b3b526785b32a574510f93ba5a69022686739b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE2NzMxOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8885#discussion_r481167319", "bodyText": "We could structure this message similar to the dependency warning:\n<li>\n  Removing the following owners will leave the entity ownerless:</br>\n  {pastOwners.map((owner, key) => (\n    <span key={owner.id}>\n      {_cap(owner.type)} <i>{owner.title}</i>\n      {key !== pasOwners.size - 1 && ', '}\n    </span>\n  ))}\n</li>\n\npastOwners is an array of Grantees in this case.\nThis way the message is still readable, even if there are many previous owners, the owner names can be identified easier, because of the <i> and it is consistent compared with the dependency warning.", "author": "linuspahl", "createdAt": "2020-09-01T14:11:21Z", "path": "graylog2-web-interface/src/components/permissions/ValidationError.jsx", "diffHunk": "@@ -0,0 +1,44 @@\n+// @flow strict\n+import * as React from 'react';\n+import styled, { type StyledComponent } from 'styled-components';\n+\n+import { Alert } from 'components/graylog';\n+import { type ThemeInterface } from 'theme';\n+import { type GranteesList } from 'logic/permissions/EntityShareState';\n+import ValidationResult from 'logic/permissions/ValidationResult';\n+\n+const Container: StyledComponent<{}, ThemeInterface, Alert> = styled(Alert)`\n+  margin-top: 20px;\n+  max-height: 240px;\n+  overflow: auto;\n+`;\n+\n+const List = styled.ul`\n+  list-style: initial;\n+  padding-left: 20px;\n+\n+  ul {\n+    list-style: circle;\n+  }\n+`;\n+\n+type Props = {\n+  validationResult: ValidationResult,\n+  availableGrantees: GranteesList,\n+};\n+\n+const ValidationError = ({ validationResult, availableGrantees }: Props) => {\n+  const pastOwners = validationResult.errorContext.selectedGranteeCapabilities.toJS().map(\n+    (grn) => availableGrantees.find((grantee) => grantee.id === grn)?.title,\n+  ).join(', ');\n+\n+  return (\n+    <Container bsStyle=\"danger\">\n+      <List>\n+        <li>{`Removing the following owners ${pastOwners} will leave the entity ownerless.`}</li>", "originalCommit": "a5b3b526785b32a574510f93ba5a69022686739b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE2ODQyNw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8885#discussion_r481168427", "bodyText": ".toJS() is not necessary in this case.", "author": "linuspahl", "createdAt": "2020-09-01T14:12:54Z", "path": "graylog2-web-interface/src/components/permissions/ValidationError.jsx", "diffHunk": "@@ -0,0 +1,44 @@\n+// @flow strict\n+import * as React from 'react';\n+import styled, { type StyledComponent } from 'styled-components';\n+\n+import { Alert } from 'components/graylog';\n+import { type ThemeInterface } from 'theme';\n+import { type GranteesList } from 'logic/permissions/EntityShareState';\n+import ValidationResult from 'logic/permissions/ValidationResult';\n+\n+const Container: StyledComponent<{}, ThemeInterface, Alert> = styled(Alert)`\n+  margin-top: 20px;\n+  max-height: 240px;\n+  overflow: auto;\n+`;\n+\n+const List = styled.ul`\n+  list-style: initial;\n+  padding-left: 20px;\n+\n+  ul {\n+    list-style: circle;\n+  }\n+`;\n+\n+type Props = {\n+  validationResult: ValidationResult,\n+  availableGrantees: GranteesList,\n+};\n+\n+const ValidationError = ({ validationResult, availableGrantees }: Props) => {\n+  const pastOwners = validationResult.errorContext.selectedGranteeCapabilities.toJS().map(", "originalCommit": "a5b3b526785b32a574510f93ba5a69022686739b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE2OTQ3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8885#discussion_r481169479", "bodyText": "{validationResults?.failed && ( would be suitable as well.", "author": "linuspahl", "createdAt": "2020-09-01T14:14:23Z", "path": "graylog2-web-interface/src/components/permissions/EntityShareSettings.jsx", "diffHunk": "@@ -111,14 +116,20 @@ const EntityShareSettings = ({\n                       selectedGrantees={selectedGrantees}\n                       title=\"Current collaborators\" />\n       </Section>\n+      {validationResults && validationResults.failed && (", "originalCommit": "a5b3b526785b32a574510f93ba5a69022686739b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7890010051d95362c4f0c520b594dc05aafcd28", "url": "https://github.com/Graylog2/graylog2-server/commit/b7890010051d95362c4f0c520b594dc05aafcd28", "message": "Add new SelectedGranteeValidation\n\n## Motivation\nPrior to this change, we could not check if the\nSelectedGranteeCapabilities were valid. But it is not allowed to remove\nthe last owner.\n\n## Description\nThis change adds a function to validate the SelectedGranteeCapabilities.", "committedDate": "2020-09-02T07:53:23Z", "type": "commit"}, {"oid": "35f170b73d2964963fae2c094de5a1348679068b", "url": "https://github.com/Graylog2/graylog2-server/commit/35f170b73d2964963fae2c094de5a1348679068b", "message": "Add Validations to EntityShareSettings", "committedDate": "2020-09-02T07:53:27Z", "type": "commit"}, {"oid": "4f8dc72cabeda1ad141f623e22297a88a97df26f", "url": "https://github.com/Graylog2/graylog2-server/commit/4f8dc72cabeda1ad141f623e22297a88a97df26f", "message": "Use backend validation instead of creating on in frontend", "committedDate": "2020-09-02T07:53:27Z", "type": "commit"}, {"oid": "f84e3d0203564f21e4dfe862a46cec11f9f9dd3a", "url": "https://github.com/Graylog2/graylog2-server/commit/f84e3d0203564f21e4dfe862a46cec11f9f9dd3a", "message": "Disable Submit button and add test", "committedDate": "2020-09-02T07:53:54Z", "type": "commit"}, {"oid": "05505be53fcfd6b9b5df00deadf8e23ed4d51217", "url": "https://github.com/Graylog2/graylog2-server/commit/05505be53fcfd6b9b5df00deadf8e23ed4d51217", "message": "Bring back falsly deleted test", "committedDate": "2020-09-02T07:53:56Z", "type": "commit"}, {"oid": "271b8c17167f0b3dc543d4ea79ee18af8cf8aa2c", "url": "https://github.com/Graylog2/graylog2-server/commit/271b8c17167f0b3dc543d4ea79ee18af8cf8aa2c", "message": "Fix annotations from @linuspahl", "committedDate": "2020-09-02T08:23:41Z", "type": "commit"}, {"oid": "271b8c17167f0b3dc543d4ea79ee18af8cf8aa2c", "url": "https://github.com/Graylog2/graylog2-server/commit/271b8c17167f0b3dc543d4ea79ee18af8cf8aa2c", "message": "Fix annotations from @linuspahl", "committedDate": "2020-09-02T08:23:41Z", "type": "forcePushed"}, {"oid": "033932cf28a8fe05743d0c3ec1db1f2f430ef773", "url": "https://github.com/Graylog2/graylog2-server/commit/033932cf28a8fe05743d0c3ec1db1f2f430ef773", "message": "fix test", "committedDate": "2020-09-02T08:38:04Z", "type": "commit"}, {"oid": "970681153225302a3aef6806d6f11cdee6bf6674", "url": "https://github.com/Graylog2/graylog2-server/commit/970681153225302a3aef6806d6f11cdee6bf6674", "message": "Fix build errors", "committedDate": "2020-09-02T08:52:36Z", "type": "commit"}]}