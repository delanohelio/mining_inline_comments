{"pr_number": 7908, "pr_title": "Show meaningful error message on missing permissions instead of redirecting to not found page", "pr_createdAt": "2020-04-17T17:01:18Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7908", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE3ODkwNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411178904", "bodyText": "Typo: UnauthoriedErrorType -> `UnauthorizedErrorType", "author": "dennisoelkers", "createdAt": "2020-04-20T08:10:24Z", "path": "graylog2-web-interface/src/logic/errors/ReportedError.js", "diffHunk": "@@ -0,0 +1,30 @@\n+// @flow strict\n+// eslint-disable-next-line import/no-cycle\n+import { FetchError } from 'logic/rest/FetchProvider';\n+\n+export const ReactErrorType = 'ReactError';\n+export const UnauthoriedErrorType = 'UnauthorizedError';", "originalCommit": "b826ed69f93b305e05e70826ddd3e21626fd63c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE3OTQ0OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411179448", "bodyText": "We can improve the naming a bit by turning this into ReactError and rename the function used to create one to createReactError, same for UnauthorizedErrorInternal.", "author": "dennisoelkers", "createdAt": "2020-04-20T08:11:18Z", "path": "graylog2-web-interface/src/logic/errors/ReportedError.js", "diffHunk": "@@ -0,0 +1,30 @@\n+// @flow strict\n+// eslint-disable-next-line import/no-cycle\n+import { FetchError } from 'logic/rest/FetchProvider';\n+\n+export const ReactErrorType = 'ReactError';\n+export const UnauthoriedErrorType = 'UnauthorizedError';\n+\n+type ReactErrorInternal = {", "originalCommit": "b826ed69f93b305e05e70826ddd3e21626fd63c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE4NjA4Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411186082", "bodyText": "Although it is not checked yet, we should use the same semicolon-rule for flow code and append one at the end of a statement.", "author": "dennisoelkers", "createdAt": "2020-04-20T08:21:36Z", "path": "graylog2-web-interface/src/logic/errors/ReportedError.js", "diffHunk": "@@ -0,0 +1,30 @@\n+// @flow strict\n+// eslint-disable-next-line import/no-cycle\n+import { FetchError } from 'logic/rest/FetchProvider';\n+\n+export const ReactErrorType = 'ReactError';\n+export const UnauthoriedErrorType = 'UnauthorizedError';\n+\n+type ReactErrorInternal = {\n+  error: Error,\n+  info: { componentStack: string },\n+  type: 'ReactError'\n+}\n+\n+type UnauthorizedErrorInternal = {\n+  error: FetchError,\n+  type: 'UnauthorizedError'\n+}\n+\n+export type ReportedError = ReactErrorInternal | UnauthorizedErrorInternal", "originalCommit": "b826ed69f93b305e05e70826ddd3e21626fd63c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzMDI1OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411330259", "bodyText": "Typo: tying -> trying", "author": "dennisoelkers", "createdAt": "2020-04-20T12:17:55Z", "path": "graylog2-web-interface/src/pages/UnauthorizedErrorPage.jsx", "diffHunk": "@@ -0,0 +1,62 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import { withRouter } from 'react-router';\n+\n+import { FetchError } from 'logic/rest/FetchProvider';\n+\n+import { Icon, ClipboardButton } from 'components/common';\n+import ErrorPage from 'components/errors/ErrorPage';\n+\n+type Props = {\n+  error: FetchError,\n+  location: {\n+    pathname: string\n+  }\n+}\n+\n+const UnauthorizedErrorPage = ({ error, location: { pathname } }: Props) => {\n+  const errorMessage = error?.message || JSON.stringify(error);\n+  const pageDetails = `The permissions check for the following request failed,\\nwhile tying to access ${pathname}.`;", "originalCommit": "0bfd7800e947e03ba46df7f143c4d41587d0c93a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzMDQ3Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411330476", "bodyText": "Typo: ressource -> resource", "author": "dennisoelkers", "createdAt": "2020-04-20T12:18:18Z", "path": "graylog2-web-interface/src/pages/UnauthorizedErrorPage.jsx", "diffHunk": "@@ -0,0 +1,62 @@\n+// @flow strict\n+import React from 'react';\n+import PropTypes from 'prop-types';\n+import { withRouter } from 'react-router';\n+\n+import { FetchError } from 'logic/rest/FetchProvider';\n+\n+import { Icon, ClipboardButton } from 'components/common';\n+import ErrorPage from 'components/errors/ErrorPage';\n+\n+type Props = {\n+  error: FetchError,\n+  location: {\n+    pathname: string\n+  }\n+}\n+\n+const UnauthorizedErrorPage = ({ error, location: { pathname } }: Props) => {\n+  const errorMessage = error?.message || JSON.stringify(error);\n+  const pageDetails = `The permissions check for the following request failed,\\nwhile tying to access ${pathname}.`;\n+  const description = (\n+    <>\n+      <p>You do not have the required permissions to view this ressource.</p>", "originalCommit": "0bfd7800e947e03ba46df7f143c4d41587d0c93a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzNjA1Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411336052", "bodyText": "suppressConsole should wrap the smallest possible scope to prevent suppressing valid console output, so maybe we can narrow it down? Why do we need it here anyway, I think there is not exception raised in here?", "author": "dennisoelkers", "createdAt": "2020-04-20T12:27:32Z", "path": "graylog2-web-interface/src/components/errors/ReportedError.test.jsx", "diffHunk": "@@ -0,0 +1,95 @@\n+// @flow strict\n+import React from 'react';\n+import { render, cleanup, waitForElement, waitForElementToBeRemoved } from 'wrappedTestingLibrary';\n+\n+import suppressConsole from 'helpers/suppressConsole';\n+import ErrorsActions from 'actions/errors/ErrorsActions';\n+import { createReactError, createUnauthorizedError } from 'logic/errors/ReportedErrors';\n+import { FetchError } from 'logic/rest/FetchProvider';\n+import ReportedError from './ReportedError';\n+\n+jest.unmock('logic/rest/FetchProvider');\n+jest.mock('react-router', () => ({ withRouter: (x) => x }));\n+\n+const router = {\n+  listen: () => jest.fn(),\n+};\n+\n+describe('ReportedError', () => {\n+  afterEach(() => {\n+    cleanup();\n+  });\n+\n+  it('registers to router upon mount', () => {\n+    const mockRouter = {\n+      listen: jest.fn(() => jest.fn()),\n+    };\n+    render(<ReportedError router={mockRouter}>Hello World!</ReportedError>);\n+\n+    expect(mockRouter.listen).toHaveBeenCalledTimes(1);\n+  });\n+\n+  it('unregisters from router upon unmount', () => {\n+    const unlisten = jest.fn();\n+    const mockRouter = {\n+      listen: () => unlisten,\n+    };\n+    const { unmount } = render(<ReportedError router={mockRouter}>Hello World!</ReportedError>);\n+\n+    unmount();\n+\n+    expect(unlisten).toHaveBeenCalled();\n+  });\n+\n+\n+  it('displays child component if there is no error', () => {\n+    const { getByText } = render(<ReportedError router={router}>Hello World!</ReportedError>);\n+\n+    expect(getByText('Hello World!')).not.toBeNull();\n+  });\n+\n+  it('displays runtime error page when react error got reported', () => {\n+    suppressConsole(async () => {", "originalCommit": "0bfd7800e947e03ba46df7f143c4d41587d0c93a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQwNTUwMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411405500", "bodyText": "Good point. I removed the not needed suppressConsoles and adjusted the scope of the remaining ones, which revealed a broken test.", "author": "linuspahl", "createdAt": "2020-04-20T14:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzNjA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODIzNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411338236", "bodyText": "Maybe we could create a factory (createFromFetchError?) in the ReportedErrors module which just takes the error and returns a proper subtype? It could look at the status field to find out which type to return. No need to do it in this PR though.\nOptional: too many parentheses.", "author": "dennisoelkers", "createdAt": "2020-04-20T12:31:02Z", "path": "graylog2-web-interface/src/logic/rest/FetchProvider.js", "diffHunk": "@@ -76,7 +78,7 @@ export class Builder {\n \n         // Redirect to the start page if a user is logged in but not allowed to access a certain HTTP API.\n         if (SessionStore.isLoggedIn() && error.status === 403) {\n-          history.replace(Routes.NOTFOUND);\n+          ErrorsActions.report((createUnauthorizedError(error)));", "originalCommit": "0bfd7800e947e03ba46df7f143c4d41587d0c93a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQwNjk2NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7908#discussion_r411406964", "bodyText": "For now i removed the parentheses. I will add the factory when I take care of the MissingStreamPermissions case.", "author": "linuspahl", "createdAt": "2020-04-20T14:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODIzNg=="}], "type": "inlineReview"}, {"oid": "ce2357b26a5456dc81f3b9a7c4b4f4c08aaac0a0", "url": "https://github.com/Graylog2/graylog2-server/commit/ce2357b26a5456dc81f3b9a7c4b4f4c08aaac0a0", "message": "Fix linter warnings", "committedDate": "2020-04-20T14:33:56Z", "type": "forcePushed"}, {"oid": "18e3d6e5e15c8984d2ad453984ab03a256c26035", "url": "https://github.com/Graylog2/graylog2-server/commit/18e3d6e5e15c8984d2ad453984ab03a256c26035", "message": "Add displayError action to handle global errors\n\n- Add class for app errors\n- Create separate component to display errors\n- Rename ErrorBoundary to RuntineErrorBoundary", "committedDate": "2020-04-21T08:48:09Z", "type": "commit"}, {"oid": "8802f6e63dd99e9a5f5a8c6f149e43c0e10ddebc", "url": "https://github.com/Graylog2/graylog2-server/commit/8802f6e63dd99e9a5f5a8c6f149e43c0e10ddebc", "message": "Do not redirect to not found page on unauthorized api requests and display global error instead", "committedDate": "2020-04-21T08:48:09Z", "type": "commit"}, {"oid": "4f62226a471bf4f9e118258d31b6133daf18d69e", "url": "https://github.com/Graylog2/graylog2-server/commit/4f62226a471bf4f9e118258d31b6133daf18d69e", "message": "Rename ErrorsAction displayError to report", "committedDate": "2020-04-21T08:48:09Z", "type": "commit"}, {"oid": "a8ec99df9f440190bdf08c9e65ed0144be7849a6", "url": "https://github.com/Graylog2/graylog2-server/commit/a8ec99df9f440190bdf08c9e65ed0144be7849a6", "message": "Include ScretchPad and ScrollToHint component in app runtime error boundary", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "e44c7c49c7d7a81b6411f064f55de8f6d63ab414", "url": "https://github.com/Graylog2/graylog2-server/commit/e44c7c49c7d7a81b6411f064f55de8f6d63ab414", "message": "Use styled components for RuntimeErrorPage", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "e0e27c743bbe1334032a06b820e35571d5d75053", "url": "https://github.com/Graylog2/graylog2-server/commit/e0e27c743bbe1334032a06b820e35571d5d75053", "message": "Unify runtime and unauthorized error page layout", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "9d4392e047bf61e7643375b0520cc9af5c6f25c0", "url": "https://github.com/Graylog2/graylog2-server/commit/9d4392e047bf61e7643375b0520cc9af5c6f25c0", "message": "Fix RuntimeErrorBoundary test", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "32143ccb12772664c38a967c03b10a84fdc0dd9f", "url": "https://github.com/Graylog2/graylog2-server/commit/32143ccb12772664c38a967c03b10a84fdc0dd9f", "message": "Rename AppError component to ReportedError", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "a62dc7fa00ba69891e9c90291c8df43de3e24726", "url": "https://github.com/Graylog2/graylog2-server/commit/a62dc7fa00ba69891e9c90291c8df43de3e24726", "message": "Add separate error boundary for routing", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "d2d96b28f94d0d025266953752241d5b3154eedc", "url": "https://github.com/Graylog2/graylog2-server/commit/d2d96b28f94d0d025266953752241d5b3154eedc", "message": "Rename AppError in ReportedError and use objects instad of a class", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "c60f1ce030da338cd3a2e32457a1957bdce7e9ca", "url": "https://github.com/Graylog2/graylog2-server/commit/c60f1ce030da338cd3a2e32457a1957bdce7e9ca", "message": "Fix linting errors", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "4201602998247f3b97757a30b74e2cff9aca21bf", "url": "https://github.com/Graylog2/graylog2-server/commit/4201602998247f3b97757a30b74e2cff9aca21bf", "message": "ADjust ReportedError creation and fix flow error", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "d2a5515be9d79f47f5b66c1e3065c18fafc0e5c7", "url": "https://github.com/Graylog2/graylog2-server/commit/d2a5515be9d79f47f5b66c1e3065c18fafc0e5c7", "message": "Only reset reported error on route change when reported error is being displayed", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "6b576436d1e349fee13f3c08078e522772d52394", "url": "https://github.com/Graylog2/graylog2-server/commit/6b576436d1e349fee13f3c08078e522772d52394", "message": "Fix RuntimeErrorBoundary test", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "44817981afecffe3a91a1b2291a2f662c67eacd7", "url": "https://github.com/Graylog2/graylog2-server/commit/44817981afecffe3a91a1b2291a2f662c67eacd7", "message": "Remove not needed prop in RouterErrorBoundary test", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "3628f8b9f9bb5dfb9e857bb4b027924bd59fcde2", "url": "https://github.com/Graylog2/graylog2-server/commit/3628f8b9f9bb5dfb9e857bb4b027924bd59fcde2", "message": "Unsubscribe from report error action when unmounting ReportedError component", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "c44f03477c84b8b65c970ea15f54f28797937bb9", "url": "https://github.com/Graylog2/graylog2-server/commit/c44f03477c84b8b65c970ea15f54f28797937bb9", "message": "Add test for ReportedError", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "0fcf8a44381ab5612b68fd9d3f81d3460006e5af", "url": "https://github.com/Graylog2/graylog2-server/commit/0fcf8a44381ab5612b68fd9d3f81d3460006e5af", "message": "Create own components directory for error handling related components\n\n* Rename ReportedErrorDetails to ErrorPage", "committedDate": "2020-04-21T08:48:10Z", "type": "commit"}, {"oid": "45f43a2834c419bf80da18c6032441c4212febed", "url": "https://github.com/Graylog2/graylog2-server/commit/45f43a2834c419bf80da18c6032441c4212febed", "message": "Imolement ErrorPage layout for PageErrorOverview", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "2a52299598d2ff829852040ccd6da8694fe25f20", "url": "https://github.com/Graylog2/graylog2-server/commit/2a52299598d2ff829852040ccd6da8694fe25f20", "message": "Fix linter warning", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "32573dec46ea8de622166a4aba9ca07e6cb07a3b", "url": "https://github.com/Graylog2/graylog2-server/commit/32573dec46ea8de622166a4aba9ca07e6cb07a3b", "message": "Revert not working linter fix and add missing import", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "4b97d6f6172134b18e01e47ff386f6e7ea70079d", "url": "https://github.com/Graylog2/graylog2-server/commit/4b97d6f6172134b18e01e47ff386f6e7ea70079d", "message": "Fix reported error reset on route change", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "d354b4bd616a076deb9b8cc3900dffdfef04c0d3", "url": "https://github.com/Graylog2/graylog2-server/commit/d354b4bd616a076deb9b8cc3900dffdfef04c0d3", "message": "Display ErrorPage title inside ErrorJumbotron", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "bc251a21e64176c096ea0c0318385feb28cd43c6", "url": "https://github.com/Graylog2/graylog2-server/commit/bc251a21e64176c096ea0c0318385feb28cd43c6", "message": "Add test for RuntimeErrorPage and UnauthorizedErrorPage", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "933c9ce6cf2d0a7332f5e82a985a1d496de38c72", "url": "https://github.com/Graylog2/graylog2-server/commit/933c9ce6cf2d0a7332f5e82a985a1d496de38c72", "message": "Rename ReportedError.js file in ReportedErrors.js and rename functions to create reported errors", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "d9c240318addf5069ba2bec191671bb32d64a2c6", "url": "https://github.com/Graylog2/graylog2-server/commit/d9c240318addf5069ba2bec191671bb32d64a2c6", "message": "Fix typos", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "b326e06c9ac8360ee9f96318aae0f4d9a7fe411d", "url": "https://github.com/Graylog2/graylog2-server/commit/b326e06c9ac8360ee9f96318aae0f4d9a7fe411d", "message": "Use not found background image by default for ErrorPage component", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "2585f4269cd3ca7b22a441e2aa7ac022b2d21b6f", "url": "https://github.com/Graylog2/graylog2-server/commit/2585f4269cd3ca7b22a441e2aa7ac022b2d21b6f", "message": "Remove not needed suppressConsole from tests and restrict scope of remaining", "committedDate": "2020-04-21T08:48:11Z", "type": "commit"}, {"oid": "d98bb6398bf869de7bbb4a288f95bc1e64bfbf96", "url": "https://github.com/Graylog2/graylog2-server/commit/d98bb6398bf869de7bbb4a288f95bc1e64bfbf96", "message": "Remove not needed parentheses", "committedDate": "2020-04-21T08:48:12Z", "type": "commit"}, {"oid": "66b7ef35805e74d33501da2e52b237f5ea2d4f73", "url": "https://github.com/Graylog2/graylog2-server/commit/66b7ef35805e74d33501da2e52b237f5ea2d4f73", "message": "Remove not needed async keyword", "committedDate": "2020-04-21T08:48:12Z", "type": "commit"}, {"oid": "d3994404f682eb82e427e20c6fe24e6755bdd8cf", "url": "https://github.com/Graylog2/graylog2-server/commit/d3994404f682eb82e427e20c6fe24e6755bdd8cf", "message": "Use wait instead of waitForElement inside tests", "committedDate": "2020-04-21T08:48:12Z", "type": "commit"}, {"oid": "f684b4206ac5a79b39e7df0bc2269d49a3c97498", "url": "https://github.com/Graylog2/graylog2-server/commit/f684b4206ac5a79b39e7df0bc2269d49a3c97498", "message": "Decrease ErrorJumbotron background opacity to improve readability", "committedDate": "2020-04-21T08:48:12Z", "type": "commit"}, {"oid": "df6abfe77df082ce4ba8640692e312a95ffbb0bb", "url": "https://github.com/Graylog2/graylog2-server/commit/df6abfe77df082ce4ba8640692e312a95ffbb0bb", "message": "Fix linter warnings", "committedDate": "2020-04-21T08:48:12Z", "type": "commit"}, {"oid": "df6abfe77df082ce4ba8640692e312a95ffbb0bb", "url": "https://github.com/Graylog2/graylog2-server/commit/df6abfe77df082ce4ba8640692e312a95ffbb0bb", "message": "Fix linter warnings", "committedDate": "2020-04-21T08:48:12Z", "type": "forcePushed"}]}