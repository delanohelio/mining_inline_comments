{"pr_number": 9841, "pr_title": "Provide default position in case the widget isn't found in positions map", "pr_createdAt": "2020-12-22T08:54:59Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/9841", "timeline": [{"oid": "cf261b24718a53d8a101470766c201922a85d34b", "url": "https://github.com/Graylog2/graylog2-server/commit/cf261b24718a53d8a101470766c201922a85d34b", "message": "Provide default position in case the widget isn't found in positions map\n\n## Motivation\nPrior to this change, a widget copied from a search was unable to be\ncopied to a different page since the position was missing in\nthe positions map.\n\n## Description\nThis change will add a safty net in case the position is missing we\nprovide the widgets default size.", "committedDate": "2020-12-22T09:12:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyMzc2MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r553823761", "bodyText": "The naming is off here: This is more of a widgetPositionBuilder or similar.", "author": "dennisoelkers", "createdAt": "2021-01-08T09:08:49Z", "path": "graylog2-web-interface/src/views/logic/views/GetPositionForNewWidget.ts", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+import { widgetDefinition } from 'views/logic/Widgets';\n+import WidgetPosition from 'views/logic/widgets/WidgetPosition';\n+import Widget from 'views/logic/widgets/Widget';\n+import View from 'views/logic/views/View';\n+\n+const GetPositionForNewWidget = (widget: Widget, queryId: string, view: View) => {\n+  const widgetDef = widgetDefinition(widget.type);\n+\n+  const widgetBuilder = view.state.get(queryId).widgetPositions[widget.id]?.toBuilder()", "originalCommit": "57d29d7de57b5bdef4e84a7f92bb4c143c160b87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyNDE1NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r553824155", "bodyText": "Why is the position of the widget overriden to 1,1, even if a position for the widget existed before?", "author": "dennisoelkers", "createdAt": "2021-01-08T09:09:40Z", "path": "graylog2-web-interface/src/views/logic/views/GetPositionForNewWidget.ts", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+import { widgetDefinition } from 'views/logic/Widgets';\n+import WidgetPosition from 'views/logic/widgets/WidgetPosition';\n+import Widget from 'views/logic/widgets/Widget';\n+import View from 'views/logic/views/View';\n+\n+const GetPositionForNewWidget = (widget: Widget, queryId: string, view: View) => {\n+  const widgetDef = widgetDefinition(widget.type);\n+\n+  const widgetBuilder = view.state.get(queryId).widgetPositions[widget.id]?.toBuilder()\n+    || WidgetPosition.builder().width(widgetDef.defaultWidth).height(widgetDef.defaultHeight);\n+\n+  return widgetBuilder.col(1).row(1).build();", "originalCommit": "57d29d7de57b5bdef4e84a7f92bb4c143c160b87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDg4Njg0MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r554886840", "bodyText": "Because it is the position for a new widget, and right now we place the new widgets on top.", "author": "kmerz", "createdAt": "2021-01-11T08:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyNDE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEwODI0Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r555108247", "bodyText": "widgetBuilder is either:\n\na previously existing widget position (retrieved through view.state.get(queryId).widgetPositions[widget.id]?.toBuilder())\na newly created widget position with default dimensions (created through WidgetPosition.builder().width(widgetDef.defaultWidth).height(widgetDef.defaultHeight))\n\nIn the first case the widget position should not be overridden IMO.", "author": "dennisoelkers", "createdAt": "2021-01-11T15:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyNDE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyNDU1MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r553824550", "bodyText": "This logic is contained in AddNewWidgetsToPositions as well. Can we consolidate it?", "author": "dennisoelkers", "createdAt": "2021-01-08T09:10:24Z", "path": "graylog2-web-interface/src/views/logic/views/GetPositionForNewWidget.ts", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright (C) 2020 Graylog, Inc.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the Server Side Public License, version 1,\n+ * as published by MongoDB, Inc.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * Server Side Public License for more details.\n+ *\n+ * You should have received a copy of the Server Side Public License\n+ * along with this program. If not, see\n+ * <http://www.mongodb.com/licensing/server-side-public-license>.\n+ */\n+import { widgetDefinition } from 'views/logic/Widgets';\n+import WidgetPosition from 'views/logic/widgets/WidgetPosition';\n+import Widget from 'views/logic/widgets/Widget';\n+import View from 'views/logic/views/View';\n+\n+const GetPositionForNewWidget = (widget: Widget, queryId: string, view: View) => {\n+  const widgetDef = widgetDefinition(widget.type);", "originalCommit": "57d29d7de57b5bdef4e84a7f92bb4c143c160b87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDg5Mzg2NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r554893865", "bodyText": "I do not really see how it would it improve the code. \ud83d\ude15", "author": "kmerz", "createdAt": "2021-01-11T08:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyNDU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyNjA5Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r553826097", "bodyText": "Isn't this an indication that the code has an issue? IMO it should not generate a NaN value for the row.", "author": "dennisoelkers", "createdAt": "2021-01-08T09:13:41Z", "path": "graylog2-web-interface/src/views/logic/views/__snapshots__/CopyWidgetToDashboard.test.js.snap", "diffHunk": "@@ -17,27 +17,33 @@ Object {\n         \"546b13fe-eae7-4fb8-abb9-e0e3a907c3e6\": Object {\n           \"col\": 1,\n           \"height\": 3,\n-          \"row\": 5,\n+          \"row\": NaN,", "originalCommit": "57d29d7de57b5bdef4e84a7f92bb4c143c160b87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyNjQ0OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r553826449", "bodyText": "Is this correct? height & width are undefined.", "author": "dennisoelkers", "createdAt": "2021-01-08T09:14:24Z", "path": "graylog2-web-interface/src/views/logic/views/__snapshots__/MoveWidgetToTab.test.ts.snap", "diffHunk": "@@ -194,7 +194,85 @@ Object {\n }\n `;\n \n-exports[`MoveWidgetToTab should work when titles are empty 1`] = `\n+exports['MoveWidgetToTab should provide a default position in case the widgets position cannot be found 1'] = `\n+Object {\n+  \"created_at\": \"2020-05-27T12:32:49.786Z\",\n+  \"description\": \"move widget to tab\",\n+  \"id\": \"5ece5e1b74ff709b0b0dc69b\",\n+  \"owner\": \"admin\",\n+  \"properties\": Immutable.List [],\n+  \"search_id\": \"new-search-id\",\n+  \"state\": Immutable.Map {\n+    \"fa247d8f-7afa-45b7-b57e-3cdef4ee53be\": Object {\n+      \"formatting\": Object {\n+        \"highlighting\": Array [],\n+      },\n+      \"positions\": Immutable.Map {},\n+      \"selected_fields\": undefined,\n+      \"titles\": Immutable.Map {\n+        \"widget\": Immutable.Map {},\n+      },\n+      \"widget_mapping\": Immutable.Map {},\n+      \"widgets\": Immutable.List [],\n+    },\n+    \"5faea09b-4187-4eda-9d59-7a86d4774c73\": Object {\n+      \"formatting\": Object {\n+        \"highlighting\": Array [],\n+      },\n+      \"positions\": Immutable.Map {\n+        \"dead-beef\": Object {\n+          \"col\": 1,\n+          \"height\": undefined,", "originalCommit": "57d29d7de57b5bdef4e84a7f92bb4c143c160b87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTExMTQ1MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r555111450", "bodyText": "The import and the name of the test need to be renamed too.", "author": "dennisoelkers", "createdAt": "2021-01-11T15:06:54Z", "path": "graylog2-web-interface/src/views/logic/views/AddNewWidgetsToPositions.test.ts", "diffHunk": "@@ -20,7 +20,7 @@ import { PluginStore } from 'graylog-web-plugin/plugin';\n import Widget from 'views/logic/widgets/Widget';\n import WidgetPosition from 'views/logic/widgets/WidgetPosition';\n \n-import AddNewWidgetsToPositions from './AddNewWidgetsToPositions';\n+import AddNewWidgetsToPositions from './GenerateNextPosition';", "originalCommit": "51f0424bfbe1f069dc7ab38200d13b0b31b10b43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzUxNTQ2MQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/9841#discussion_r557515461", "bodyText": "The import name should be changed.", "author": "dennisoelkers", "createdAt": "2021-01-14T16:15:38Z", "path": "graylog2-web-interface/src/views/stores/CurrentViewStateStore.ts", "diffHunk": "@@ -22,7 +22,7 @@ import type { RefluxActions, Store } from 'stores/StoreTypes';\n import FormattingSettings from 'views/logic/views/formatting/FormattingSettings';\n import Widget from 'views/logic/widgets/Widget';\n import { singletonActions, singletonStore } from 'views/logic/singleton';\n-import AddNewWidgetsToPositions from 'views/logic/views/AddNewWidgetsToPositions';\n+import AddNewWidgetsToPositions from 'views/logic/views/GenerateNextPosition';", "originalCommit": "e51cd2bb6073225394c3c24a4d14acf14c065726", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b6a2c0f1709c168f7a6286a137d83ef0b1117a54", "url": "https://github.com/Graylog2/graylog2-server/commit/b6a2c0f1709c168f7a6286a137d83ef0b1117a54", "message": "Provide default position in case the widget isn't found in positions map\n\n## Motivation\nPrior to this change, a widget copied from a search was unable to be\ncopied to a different page since the position was missing in\nthe positions map.\n\n## Description\nThis change will add a safty net in case the position is missing we\nprovide the widgets default size.", "committedDate": "2021-01-18T12:36:09Z", "type": "commit"}, {"oid": "41708d518b9df4cfed26fe8c3742a218d5e4d720", "url": "https://github.com/Graylog2/graylog2-server/commit/41708d518b9df4cfed26fe8c3742a218d5e4d720", "message": "Use AddNewWidgetsToPosition for CopyWidgetToDashboard\n\nThat way we can saftly assume that future copied widgets will not have a missing position\n\nThe NaN values in the test can be ignored, since the widgets are not\nexisting anymore.", "committedDate": "2021-01-18T12:36:18Z", "type": "commit"}, {"oid": "03bcd550441a61bf74cda3cd100fcd39ca5c75ae", "url": "https://github.com/Graylog2/graylog2-server/commit/03bcd550441a61bf74cda3cd100fcd39ca5c75ae", "message": "Fix linter warning", "committedDate": "2021-01-18T12:36:18Z", "type": "commit"}, {"oid": "25081e9a5cccacafdbd41925f9e481d7cd231a23", "url": "https://github.com/Graylog2/graylog2-server/commit/25081e9a5cccacafdbd41925f9e481d7cd231a23", "message": "Fix license header", "committedDate": "2021-01-18T12:36:18Z", "type": "commit"}, {"oid": "50d4620c360b5132b3ed320492c75598064e4261", "url": "https://github.com/Graylog2/graylog2-server/commit/50d4620c360b5132b3ed320492c75598064e4261", "message": "Clear positions from stale entries", "committedDate": "2021-01-18T12:36:19Z", "type": "commit"}, {"oid": "fcc0e4a6c2765798aab68a1492c98b441cb828e7", "url": "https://github.com/Graylog2/graylog2-server/commit/fcc0e4a6c2765798aab68a1492c98b441cb828e7", "message": "Provide defaultHeight/Width to test", "committedDate": "2021-01-18T12:36:19Z", "type": "commit"}, {"oid": "28c216231a86bbd133d4ce7a9b4fb59a51944c2c", "url": "https://github.com/Graylog2/graylog2-server/commit/28c216231a86bbd133d4ce7a9b4fb59a51944c2c", "message": "Update snapshots", "committedDate": "2021-01-18T12:36:19Z", "type": "commit"}, {"oid": "9c0e825b521161307ebba5ad193174c2b146161f", "url": "https://github.com/Graylog2/graylog2-server/commit/9c0e825b521161307ebba5ad193174c2b146161f", "message": "Refactor position calculation for new widgets", "committedDate": "2021-01-18T12:36:19Z", "type": "commit"}, {"oid": "f2c706cd5d34a3c09ef3663bf9fe5ca24fb69001", "url": "https://github.com/Graylog2/graylog2-server/commit/f2c706cd5d34a3c09ef3663bf9fe5ca24fb69001", "message": "Fix linter warnings", "committedDate": "2021-01-18T12:36:19Z", "type": "commit"}, {"oid": "284362b8e18ff4e2621eeb4b3fd91d20748544d1", "url": "https://github.com/Graylog2/graylog2-server/commit/284362b8e18ff4e2621eeb4b3fd91d20748544d1", "message": "Create new id when copying a widget", "committedDate": "2021-01-18T15:01:21Z", "type": "commit"}, {"oid": "4399e3f7a0647a2ffb7dbbe040ac7ba9653b8f2f", "url": "https://github.com/Graylog2/graylog2-server/commit/4399e3f7a0647a2ffb7dbbe040ac7ba9653b8f2f", "message": "Reuse old sizes if possible", "committedDate": "2021-01-19T09:37:46Z", "type": "commit"}, {"oid": "4399e3f7a0647a2ffb7dbbe040ac7ba9653b8f2f", "url": "https://github.com/Graylog2/graylog2-server/commit/4399e3f7a0647a2ffb7dbbe040ac7ba9653b8f2f", "message": "Reuse old sizes if possible", "committedDate": "2021-01-19T09:37:46Z", "type": "forcePushed"}, {"oid": "691b7468652f407f97bcb23ac9238c3003e70d32", "url": "https://github.com/Graylog2/graylog2-server/commit/691b7468652f407f97bcb23ac9238c3003e70d32", "message": "Rename last leftover import", "committedDate": "2021-01-19T10:05:15Z", "type": "commit"}, {"oid": "4350f5e672faffdaeca546ec5afc670aad71473e", "url": "https://github.com/Graylog2/graylog2-server/commit/4350f5e672faffdaeca546ec5afc670aad71473e", "message": "Fix linter", "committedDate": "2021-01-19T10:06:39Z", "type": "commit"}, {"oid": "e8908a8faf3778d3b9f099f924551ce4a87a0231", "url": "https://github.com/Graylog2/graylog2-server/commit/e8908a8faf3778d3b9f099f924551ce4a87a0231", "message": "Don't mix responsibilities", "committedDate": "2021-02-01T12:20:57Z", "type": "commit"}, {"oid": "649fd9854185677b731ebbea38cc3cec0dde43e7", "url": "https://github.com/Graylog2/graylog2-server/commit/649fd9854185677b731ebbea38cc3cec0dde43e7", "message": "Update snapshots", "committedDate": "2021-02-01T12:35:24Z", "type": "commit"}]}