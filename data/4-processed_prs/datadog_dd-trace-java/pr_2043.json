{"pr_number": 2043, "pr_title": "MongoDB 4 driver instrumentation", "pr_createdAt": "2020-10-30T13:35:45Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2043", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwMjM2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r515202360", "bodyText": "I know we do this elsewhere, but I know from experience with this driver  thatBsonDocument (having maintained a private fork) is quite heavy - every value is wrapped in a BsonValue. What we could be doing here is piping the document into a BsonWriter which writes the scrubbed value into a StringBuilder:\nScrubbingBsonWriter scrubber = new ScrubbingBsonWriter(new StringBuilder()); // implements org.bson.BsonWriter\nscrubber.pipe(new BsonDocumentReader(statement));\nCharSequence scrubbed = scrubber.getOutput()\nI have an example of how to do this sort of thing (which just prints out the attributed weight of a BSON document) here. This will be quite handy for getting the overhead of this instrumentation down.", "author": "richardstartin", "createdAt": "2020-10-30T15:55:26Z", "path": "dd-java-agent/instrumentation/mongo/driver-4/src/main/java/datadog/trace/instrumentation/mongo4/Mongo4ClientDecorator.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package datadog.trace.instrumentation.mongo4;\n+\n+import com.mongodb.connection.ConnectionDescription;\n+import com.mongodb.event.CommandStartedEvent;\n+import datadog.trace.api.DDSpanTypes;\n+import datadog.trace.api.DDTags;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+import datadog.trace.bootstrap.instrumentation.decorator.DBTypeProcessingDatabaseClientDecorator;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import org.bson.BsonArray;\n+import org.bson.BsonDocument;\n+import org.bson.BsonString;\n+import org.bson.BsonValue;\n+\n+public class Mongo4ClientDecorator\n+    extends DBTypeProcessingDatabaseClientDecorator<CommandStartedEvent> {\n+\n+  public static final UTF8BytesString MONGO_QUERY = UTF8BytesString.createConstant(\"mongo.query\");\n+\n+  public static final Mongo4ClientDecorator DECORATE = new Mongo4ClientDecorator();\n+\n+  @Override\n+  protected String[] instrumentationNames() {\n+    return new String[] {\"mongo\"};\n+  }\n+\n+  @Override\n+  protected String service() {\n+    return \"mongo\";\n+  }\n+\n+  @Override\n+  protected CharSequence component() {\n+    return \"java-mongo\";\n+  }\n+\n+  @Override\n+  protected CharSequence spanType() {\n+    return DDSpanTypes.MONGO;\n+  }\n+\n+  @Override\n+  protected String dbType() {\n+    return \"mongo\";\n+  }\n+\n+  @Override\n+  protected String dbUser(final CommandStartedEvent event) {\n+    return null;\n+  }\n+\n+  @Override\n+  protected String dbInstance(final CommandStartedEvent event) {\n+    return event.getDatabaseName();\n+  }\n+\n+  @Override\n+  protected String dbHostname(CommandStartedEvent event) {\n+    final ConnectionDescription connectionDescription = event.getConnectionDescription();\n+    if (connectionDescription != null) {\n+      return connectionDescription.getServerAddress().getHost();\n+    }\n+\n+    return null;\n+  }\n+\n+  public AgentSpan onStatement(final AgentSpan span, final BsonDocument statement) {\n+\n+    // scrub the Mongo command so that parameters are removed from the string\n+    final BsonDocument scrubbed = scrub(statement);\n+    final String mongoCmd = scrubbed.toString();\n+\n+    span.setTag(DDTags.RESOURCE_NAME, mongoCmd);\n+    return onStatement(span, mongoCmd);\n+  }\n+\n+  /**\n+   * The values of these mongo fields will not be scrubbed out. This allows the non-sensitive\n+   * collection names to be captured.\n+   */\n+  private static final List<String> UNSCRUBBED_FIELDS =\n+      Arrays.asList(\"ordered\", \"insert\", \"count\", \"find\", \"create\");\n+\n+  private static final BsonValue HIDDEN_CHAR = new BsonString(\"?\");\n+\n+  private static BsonDocument scrub(final BsonDocument origin) {\n+    final BsonDocument scrub = new BsonDocument();", "originalCommit": "1f53b31723cf1d70bec9966330955d63bb06ec09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwMzUwOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r515203508", "bodyText": "cool - yes, this approach comes from the old MongoDB 3 instrumentation - thanks for the link", "author": "mcculls", "createdAt": "2020-10-30T15:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIwMjM2MA=="}], "type": "inlineReview"}, {"oid": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "url": "https://github.com/DataDog/dd-trace-java/commit/0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "message": "MongoDB 4 driver instrumentation\n\nCovers both sync and reactivestreams clients", "committedDate": "2020-10-30T16:23:57Z", "type": "commit"}, {"oid": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "url": "https://github.com/DataDog/dd-trace-java/commit/0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "message": "MongoDB 4 driver instrumentation\n\nCovers both sync and reactivestreams clients", "committedDate": "2020-10-30T16:23:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1MzE4MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r515253181", "bodyText": "This version number ideally should align with the project name.  Any reason for the mismatch?", "author": "tylerbenson", "createdAt": "2020-10-30T17:16:04Z", "path": "dd-java-agent/instrumentation/mongo/driver-4/driver-4.gradle", "diffHunk": "@@ -0,0 +1,36 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  // Mongo4 driver requires Java 8 minimum\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+muzzle {\n+  pass {\n+    group = \"org.mongodb\"\n+    module = \"mongodb-driver-core\"\n+    versions = \"[3.7,)\"", "originalCommit": "0f4f768654ad23eaf6ebd5bb448440d1f47e5007", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI2MDY2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r515260667", "bodyText": "Comes down to how MongoDB evolved MongoClientOptions into MongoClientSettings - the v3 instrumentation works with early v3 drivers and the latest legacy drivers (both v3 and v4) that use MongoClientOptions. Whereas the v4 instrumentation works with the newer sync and reactivestreams drivers that use MongoClientSettings - but is also compatible with early releases of those drivers back to 3.7.\nSince v3 based applications tend to use the legacy driver, and v4 based applications typically use the sync or reactivestreams drivers I decided it was simpler to mark the new instrumentation as v4, but declare in the muzzle spec that this will also work with earlier releases (when using the newer client API that uses MongoClientSettings).\nAlso because no Mongo client uses both MongoClientOptions and MongoClientSettings there's no risk of double instrumentation.", "author": "mcculls", "createdAt": "2020-10-30T17:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1MzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk5NTQ2Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r515995463", "bodyText": "@mcculls would you mind adding a comment in the gradle file describing your reasoning here?", "author": "tylerbenson", "createdAt": "2020-11-02T14:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1MzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgyOTc0NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2043#discussion_r516829744", "bodyText": "#2048", "author": "mcculls", "createdAt": "2020-11-03T17:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI1MzE4MQ=="}], "type": "inlineReview"}]}