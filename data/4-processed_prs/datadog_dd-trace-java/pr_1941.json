{"pr_number": 1941, "pr_title": "Don't treat dispatch servlet spans as top level", "pr_createdAt": "2020-10-01T19:16:55Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1941", "timeline": [{"oid": "5e1b292632c2b847a4c48c9e722066ddd5556860", "url": "https://github.com/DataDog/dd-trace-java/commit/5e1b292632c2b847a4c48c9e722066ddd5556860", "message": "Have dispatched servlet spans belong to the same chunk", "committedDate": "2020-09-30T19:25:21Z", "type": "commit"}, {"oid": "77a067974519219702e269b90ead187a2d77ef72", "url": "https://github.com/DataDog/dd-trace-java/commit/77a067974519219702e269b90ead187a2d77ef72", "message": "adjust tests\n\nFix tests", "committedDate": "2020-10-01T19:04:47Z", "type": "commit"}, {"oid": "5cda215725cb453547176de2a7bec4bf2bf56efb", "url": "https://github.com/DataDog/dd-trace-java/commit/5cda215725cb453547176de2a7bec4bf2bf56efb", "message": "Codenarc", "committedDate": "2020-10-01T19:36:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwNjc2OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r498706769", "bodyText": "Just as a case in point, this is one of the reasons I think inheritance hierarchies aren't suitable for tests.", "author": "richardstartin", "createdAt": "2020-10-02T09:12:36Z", "path": "dd-java-agent/instrumentation/servlet/request-3/src/test/groovy/AbstractServlet3Test.groovy", "diffHunk": "@@ -74,8 +87,52 @@ abstract class AbstractServlet3Test<SERVER, CONTEXT> extends HttpServerTest<SERV\n     super.request(uri, method, body)\n   }\n \n+  // Almost identical to serverSpan()\n+  @Override\n+  void handlerSpan(TraceAssert trace, Object parent, ServerEndpoint endpoint = SUCCESS) {\n+    if (!isDispatch()) {", "originalCommit": "5cda215725cb453547176de2a7bec4bf2bf56efb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwNzI4Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r498707287", "bodyText": "Can we uncomment this and @Ignore it instead?", "author": "richardstartin", "createdAt": "2020-10-02T09:13:43Z", "path": "dd-java-agent/instrumentation/servlet/request-3/src/test/groovy/JettyServlet3Test.groovy", "diffHunk": "@@ -124,12 +115,15 @@ class JettyServlet3TestFakeAsync extends JettyServlet3Test {\n }\n \n // FIXME: not working right now...\n-//class JettyServlet3TestForward extends JettyDispatchTest {", "originalCommit": "5cda215725cb453547176de2a7bec4bf2bf56efb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc4MzI0Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r499783247", "bodyText": "Going to merge this for now.  I have another branch that fixes all of these tests", "author": "randomanderson", "createdAt": "2020-10-05T18:14:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwNzI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2MTI1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r498961256", "bodyText": "I don't think we still need to inject anymore, right?", "author": "tylerbenson", "createdAt": "2020-10-02T17:42:59Z", "path": "dd-java-agent/instrumentation/servlet/request-3/src/main/java/datadog/trace/instrumentation/servlet3/AsyncContextInstrumentation.java", "diffHunk": "@@ -78,6 +79,8 @@ public static boolean enter(\n         if (request instanceof HttpServletRequest) {\n           propagate().inject(span, (HttpServletRequest) request, SETTER);", "originalCommit": "5cda215725cb453547176de2a7bec4bf2bf56efb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2OTAyMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1941#discussion_r499069022", "bodyText": "I wasn't sure.  The servlet code has a lot of\n\nInject headers in case we lose context\n\ncomments so I left this as is", "author": "randomanderson", "createdAt": "2020-10-02T22:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk2MTI1Ng=="}], "type": "inlineReview"}]}