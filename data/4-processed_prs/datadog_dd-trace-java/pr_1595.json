{"pr_number": 1595, "pr_title": "Fix Spring handler mapping affecting character encoding", "pr_createdAt": "2020-06-16T17:15:17Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1595", "timeline": [{"oid": "f8715f04513e4f142ec5339b268ef595d7608e92", "url": "https://github.com/DataDog/dd-trace-java/commit/f8715f04513e4f142ec5339b268ef595d7608e92", "message": "Add failing test", "committedDate": "2020-06-16T16:48:42Z", "type": "commit"}, {"oid": "fe5c4674d56f1322ba467606b6a3c6aadcae26db", "url": "https://github.com/DataDog/dd-trace-java/commit/fe5c4674d56f1322ba467606b6a3c6aadcae26db", "message": "Inject HandlerMappingResourceNameFilter as a real filter", "committedDate": "2020-06-16T16:48:42Z", "type": "commit"}, {"oid": "22c9c8d97f651166099c0b2f4d03c176b425ab7f", "url": "https://github.com/DataDog/dd-trace-java/commit/22c9c8d97f651166099c0b2f4d03c176b425ab7f", "message": "Exclude context from ignores", "committedDate": "2020-06-16T16:48:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MTc0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#discussion_r441071746", "bodyText": "Can we put the equals matchers into a set and replace the conditions with set.contains(name) when they grow long like this??", "author": "richardstartin", "createdAt": "2020-06-16T18:51:59Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -100,7 +100,11 @@ public boolean matches(final T target) {\n             || name.startsWith(\n                 \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer$\")\n             || name.equals(\n-                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")) {\n+                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")", "originalCommit": "22c9c8d97f651166099c0b2f4d03c176b425ab7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDU3Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#discussion_r441074573", "bodyText": "safeHasSuperType(namedOneOf(\"org.springframework.context.support.AbstractApplicationContext\", \"org.springframework.web.context.WebApplicationContext\"))?", "author": "richardstartin", "createdAt": "2020-06-16T18:57:21Z", "path": "dd-java-agent/instrumentation/spring-webmvc-3.1/src/main/java/datadog/trace/instrumentation/springweb/WebApplicationContextInstrumentation.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package datadog.trace.instrumentation.springweb;\n+\n+import static datadog.trace.agent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.extendsClass;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.implementsInterface;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;\n+\n+@AutoService(Instrumenter.class)\n+public class WebApplicationContextInstrumentation extends Instrumenter.Default {\n+  public WebApplicationContextInstrumentation() {\n+    super(\"spring-web\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    // Optimization for expensive typeMatcher.\n+    return hasClassesNamed(\n+        \"org.springframework.context.support.AbstractApplicationContext\",\n+        \"org.springframework.web.context.WebApplicationContext\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return extendsClass(named(\"org.springframework.context.support.AbstractApplicationContext\"))", "originalCommit": "22c9c8d97f651166099c0b2f4d03c176b425ab7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0MzMwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1595#discussion_r441743307", "bodyText": "It needs to match both, not one.  Extends AbstractApplicationContext AND has the WebApplicationContext interface.", "author": "randomanderson", "createdAt": "2020-06-17T18:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDU3Mw=="}], "type": "inlineReview"}, {"oid": "043b87d1e72b6146f63bd0e6a429b4b1ccb30ff3", "url": "https://github.com/DataDog/dd-trace-java/commit/043b87d1e72b6146f63bd0e6a429b4b1ccb30ff3", "message": "Check for existence of the filter because getBean() throws", "committedDate": "2020-06-17T18:17:59Z", "type": "commit"}, {"oid": "83ac439581fed6d6e612dd01d4f8dad8c6e6cb07", "url": "https://github.com/DataDog/dd-trace-java/commit/83ac439581fed6d6e612dd01d4f8dad8c6e6cb07", "message": "Add helper classes to injection", "committedDate": "2020-06-17T18:18:19Z", "type": "commit"}, {"oid": "5e693c4ecc2ea069c77f780db1388ac91e45fac4", "url": "https://github.com/DataDog/dd-trace-java/commit/5e693c4ecc2ea069c77f780db1388ac91e45fac4", "message": "Register HMRNF via bean definition instead of singleton bean", "committedDate": "2020-06-18T21:09:11Z", "type": "commit"}]}