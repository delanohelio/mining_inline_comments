{"pr_number": 1285, "pr_title": "Avoid temporary Jar file collisions", "pr_createdAt": "2020-03-03T21:51:23Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1285", "timeline": [{"oid": "3417fd8940e1bc03da6570d77710e1db03522673", "url": "https://github.com/DataDog/dd-trace-java/commit/3417fd8940e1bc03da6570d77710e1db03522673", "message": "Improving debuggability by requestingName\n\nThis change adds a requestingName field to help in diagnosing the source of any injection failures.\n\nUsually, the requestingName is the simple class name of the Instrumenter; however, this change doesn't propagate the Instumeneter named through FieldBackedProvider.", "committedDate": "2020-03-03T21:08:09Z", "type": "commit"}, {"oid": "c50899f1845643cab256d7f380c699d35356f627", "url": "https://github.com/DataDog/dd-trace-java/commit/c50899f1845643cab256d7f380c699d35356f627", "message": "Creating helper methods for injection\n\nCreate helper methods injectBootstrapClassLoader & injectClassLoader.\n\nThe directory creation and retry logic that will be added to the handling of the bootstrap will complicated the code.\n\nTo keep the code readable, I broke the bootstrap handling into its own method.  To keep the level abstraction consistent, I did the same with injectClassLoader.", "committedDate": "2020-03-03T21:08:19Z", "type": "commit"}, {"oid": "d2ecce477e0d3ce497b6e3379a543dc6b447d223", "url": "https://github.com/DataDog/dd-trace-java/commit/d2ecce477e0d3ce497b6e3379a543dc6b447d223", "message": "Switching to per-process temp dir\n\nSwitching to create a per-process temp dir as protection against file name collisions.  This is done by introduced TEMP_DIR which is calculated during class initialization.\n\nThe current selection process generates a random directory name and sees if that name is availabe in java.io.tmpdir.  If it is that name is selected; otherwise, another name is generated.\n\nIf no unique name is found after 10 rounds of generation, the code falls back to the old behavior of writing directly to java.io.tmpdir.", "committedDate": "2020-03-03T21:08:29Z", "type": "commit"}, {"oid": "4ad51dd9fa91c4d306be3d581132456c03b92933", "url": "https://github.com/DataDog/dd-trace-java/commit/4ad51dd9fa91c4d306be3d581132456c03b92933", "message": "Introducing TempDir helper\n\nIntroduces a TempDir helper class\n\nThis was done to help handle an oversight in the prior per-process temp dir change.  The fallback mode is to use the shared java.io.tmpdir directly.\n\nWhen using java.io.tmpdir, we don't want to be creating and destorying, since it may be shared.\n\nThe new TempDir object is constructed knowing whether the TempDir is per-process or shared -- and the behavior of its prepare and cleanup method change accordingly.\n\nWhen using a per-process temp dir, the dir is creating and deleted regularly.  When using a shared temp dir, those methods become nops.\n\nCreating TempDir also made it easy to avoid repeatedly calling deleteOnExit in the event that delete fails, so I made that change as well.", "committedDate": "2020-03-03T21:08:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNTk3Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387315976", "bodyText": "This field was added to improved our ability to debug problems when failures occur.", "author": "dougqh", "createdAt": "2020-03-03T21:52:26Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -25,14 +25,19 @@\n import net.bytebuddy.dynamic.DynamicType;\n import net.bytebuddy.dynamic.loading.ClassInjector;\n import net.bytebuddy.utility.JavaModule;\n+import net.bytebuddy.utility.RandomString;\n \n /** Injects instrumentation helper classes into the user's classloader. */\n @Slf4j\n public class HelperInjector implements Transformer {\n+  private static final TempDir TEMP_DIR = computeTempDir();\n+\n   // Need this because we can't put null into the injectedClassLoaders map.\n   private static final ClassLoader BOOTSTRAP_CLASSLOADER_PLACEHOLDER =\n       new SecureClassLoader(null) {};\n \n+  private final String requestingName;", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNjQwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387316409", "bodyText": "This logic was pulled out into helper methods to make things more readable.\nAlthough, now that most of the preparation and cleanup has been moved to the TempDir class, this might be overkill.", "author": "dougqh", "createdAt": "2020-03-03T21:53:17Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -101,14 +111,9 @@ public static HelperInjector forDynamicTypes(final Collection<DynamicType.Unload\n           final Map<String, byte[]> classnameToBytes = getHelperMap();\n           final Map<String, Class<?>> classes;\n           if (classLoader == BOOTSTRAP_CLASSLOADER_PLACEHOLDER) {\n-            classes =", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODAwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387318007", "bodyText": "This is probably the most debatable part.\nTo avoid leaving around vestigial dirs, this checks if the dir is empty and deletes it.\nOn some level, this does actually open a possibility for collisions, since another process might find that a directory by the name doesn't exist and then assume it has exclusive access to that name.", "author": "dougqh", "createdAt": "2020-03-03T21:56:29Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -162,4 +187,82 @@ private void ensureModuleCanReadHelperModules(final JavaModule target) {\n       }\n     }\n   }\n+\n+  /*\n+   * Tries to temp file naming collisions by creating a unique directory per\n+   * process.  Generates up to random names.  If a no file exists with a\n+   * generated name, settles on using that name.  If name can be found falls\n+   * back using java.io.tmpdir directly.\n+   */\n+  private static final TempDir computeTempDir() {\n+    File rootTempDir = new File(System.getProperty(\"java.io.tmpdir\"));\n+    rootTempDir.mkdir();\n+\n+    RandomString randString = new RandomString(16);\n+    for (int i = 0; i < 10; ++i) {\n+      String dirName = \"datadog-temp-jars-\" + randString.nextString();\n+      File processTempDir = new File(rootTempDir, dirName);\n+      if (!processTempDir.exists()) {\n+        return TempDir.makePerProcess(processTempDir);\n+      }\n+    }\n+    return TempDir.makeShared(rootTempDir);\n+  }\n+\n+  static final class TempDir {\n+    static final TempDir makePerProcess(final File dir) {\n+      return new TempDir(dir, true);\n+    }\n+\n+    static final TempDir makeShared(final File dir) {\n+      return new TempDir(dir, false);\n+    }\n+\n+    public final File dir;\n+    private final boolean perProcess;\n+    private volatile boolean scheduledDelete = false;\n+\n+    TempDir(final File dir, final boolean perProcess) {\n+      this.dir = dir;\n+      this.perProcess = perProcess;\n+    }\n+\n+    void prepare() {\n+      // If shared, we're using java.io.tmpdir which should already exist\n+      if (!perProcess) {\n+        return;\n+      }\n+\n+      // If per process, need to create directory for this process\n+      dir.mkdirs();\n+    }\n+\n+    void cleanup() {\n+      // If not per process, no directory clean-up\n+      if (!perProcess) {\n+        return;\n+      }\n+\n+      // If per process, clean-up the directory -- if it is empty", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2MDQ2Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387660466", "bodyText": "I'm not sure I quite follow the exact problem you are solving here...\nIf the problem is that BB's logic to create tmp files sometimes gives you collisions then why don't you just pass it result of new call tojava.nio.file.Files#createTempDirectory() every time (and then remove the directory)? Creating dir seems to be cheap enough operation - considering that we also write a file into it. And this would guarantee no races and collisions. And also it feels like it would be simpler.", "author": "mar-kolya", "createdAt": "2020-03-04T13:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyNzAwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387727006", "bodyText": "Yes, using createTempDirectory repeatedly might be a good option.  I'll look into how it works and see if switching seems reasonable.\nHowever, I would caution about assuming file system operations are cheap.  I'd actually like us to remove them if possible to avoid a source of variability during start-up.", "author": "dougqh", "createdAt": "2020-03-04T15:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MjY4Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387952687", "bodyText": "Switched to createTempDirectory per injection as discussed outside GitHub", "author": "dougqh", "createdAt": "2020-03-04T21:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxOTk2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387319967", "bodyText": "As a further level of defense, we could do couple things here.\nThe ClassInjector internally constructs a RandomString which in turn uses a Random.\nFrom inspection, two threads injecting at the same time are unlikely to conflict because the Random objects should have different seeds.\nJava seeds Random objects not just with time, but also with another value that is changed for each Random object created.\nIf wanted to provide a stronger guarantee, we could reuse the UsingInstrumentation object from injection to the next which would also reuse the underlying RandomString and Random objects.  However, before doing that, we need to double check that all the classes involved are thread-safe.", "author": "dougqh", "createdAt": "2020-03-03T22:00:26Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -141,6 +147,25 @@ public static HelperInjector forDynamicTypes(final Collection<DynamicType.Unload\n     return builder;\n   }\n \n+  private Map<String, Class<?>> injectBootstrapClassLoader(\n+      final Map<String, byte[]> classnameToBytes) {\n+    TEMP_DIR.prepare();\n+    try {\n+      return ClassInjector.UsingInstrumentation.of(", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0MzgzNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387343837", "bodyText": "Why is it ok to run cleanup right after injecting the classes?  Does this assume the JVM now has the file open and deleting it will have no negative impact?", "author": "tylerbenson", "createdAt": "2020-03-03T22:53:16Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -141,6 +147,25 @@ public static HelperInjector forDynamicTypes(final Collection<DynamicType.Unload\n     return builder;\n   }\n \n+  private Map<String, Class<?>> injectBootstrapClassLoader(\n+      final Map<String, byte[]> classnameToBytes) {\n+    TEMP_DIR.prepare();\n+    try {\n+      return ClassInjector.UsingInstrumentation.of(\n+              TEMP_DIR.dir,\n+              ClassInjector.UsingInstrumentation.Target.BOOTSTRAP,\n+              AgentInstaller.getInstrumentation())\n+          .injectRaw(classnameToBytes);\n+    } finally {\n+      TEMP_DIR.cleanup();", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQxMDY0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387410645", "bodyText": "In part, I was modeling after what ByteBuddy is already doing.  It deletes the JAR immediately after using it.  I do think this is potentially a bit dangerous, but ByteBuddy immediately loads all the classes in the temporary JAR -- so it works.", "author": "dougqh", "createdAt": "2020-03-04T02:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0MzgzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1NDA5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387954092", "bodyText": "Revised code still follows this approach but with a temp dir per injection", "author": "dougqh", "createdAt": "2020-03-04T21:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0MzgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0NTIxMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387345211", "bodyText": "Did you consider using java.io.File#createTempFile(...)?  I think that is supposed to guarantee a unique file.", "author": "tylerbenson", "createdAt": "2020-03-03T22:56:29Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -162,4 +187,82 @@ private void ensureModuleCanReadHelperModules(final JavaModule target) {\n       }\n     }\n   }\n+\n+  /*\n+   * Tries to temp file naming collisions by creating a unique directory per\n+   * process.  Generates up to random names.  If a no file exists with a\n+   * generated name, settles on using that name.  If name can be found falls\n+   * back using java.io.tmpdir directly.\n+   */\n+  private static final TempDir computeTempDir() {\n+    File rootTempDir = new File(System.getProperty(\"java.io.tmpdir\"));\n+    rootTempDir.mkdir();\n+\n+    RandomString randString = new RandomString(16);\n+    for (int i = 0; i < 10; ++i) {\n+      String dirName = \"datadog-temp-jars-\" + randString.nextString();\n+      File processTempDir = new File(rootTempDir, dirName);\n+      if (!processTempDir.exists()) {\n+        return TempDir.makePerProcess(processTempDir);\n+      }\n+    }\n+    return TempDir.makeShared(rootTempDir);", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQxMTAyNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387411024", "bodyText": "I suppose I could do that instead.  Although, it creates a file not a directory, so I'd then need to delete it which would create a different race.", "author": "dougqh", "createdAt": "2020-03-04T02:09:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0NTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MTI5NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387951295", "bodyText": "Latest version uses createTempDirectory which was apparently added in Java 7.", "author": "dougqh", "createdAt": "2020-03-04T21:42:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM0NTIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY0NzExMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387647110", "bodyText": "is the a point in making statics final?", "author": "mar-kolya", "createdAt": "2020-03-04T12:54:26Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -162,4 +187,82 @@ private void ensureModuleCanReadHelperModules(final JavaModule target) {\n       }\n     }\n   }\n+\n+  /*\n+   * Tries to temp file naming collisions by creating a unique directory per\n+   * process.  Generates up to random names.  If a no file exists with a\n+   * generated name, settles on using that name.  If name can be found falls\n+   * back using java.io.tmpdir directly.\n+   */\n+  private static final TempDir computeTempDir() {\n+    File rootTempDir = new File(System.getProperty(\"java.io.tmpdir\"));\n+    rootTempDir.mkdir();\n+\n+    RandomString randString = new RandomString(16);\n+    for (int i = 0; i < 10; ++i) {\n+      String dirName = \"datadog-temp-jars-\" + randString.nextString();\n+      File processTempDir = new File(rootTempDir, dirName);\n+      if (!processTempDir.exists()) {\n+        return TempDir.makePerProcess(processTempDir);\n+      }\n+    }\n+    return TempDir.makeShared(rootTempDir);\n+  }\n+\n+  static final class TempDir {\n+    static final TempDir makePerProcess(final File dir) {", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyMTE1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387721156", "bodyText": "Strictly speaking no.\nI tend to think lots of overriding is confusing even for non-statics, so I tend to make things final by default.  Theoretically, there are some tiny perf benefits to making non-statics final, but my main reason is code hygiene.", "author": "dougqh", "createdAt": "2020-03-04T14:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY0NzExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY0NzY0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387647646", "bodyText": "Generates up to random names.\n\nmissing a number?", "author": "mar-kolya", "createdAt": "2020-03-04T12:55:32Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -162,4 +187,82 @@ private void ensureModuleCanReadHelperModules(final JavaModule target) {\n       }\n     }\n   }\n+\n+  /*\n+   * Tries to temp file naming collisions by creating a unique directory per\n+   * process.  Generates up to random names.  If a no file exists with a", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1NDg0OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387854848", "bodyText": "Yes, I have a tendency to leave out words.  I'll fix that.", "author": "dougqh", "createdAt": "2020-03-04T18:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY0NzY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MTY0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387951642", "bodyText": "Since I switched to using createTempDirectory, I just deleted this comment.", "author": "dougqh", "createdAt": "2020-03-04T21:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY0NzY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1MTI1OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387651258", "bodyText": "Wouldn't it make sense to generate TMP name right before creating a dir - not at start up and then creating a dir potentially quite a bit later?", "author": "mar-kolya", "createdAt": "2020-03-04T13:02:12Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -25,14 +25,19 @@\n import net.bytebuddy.dynamic.DynamicType;\n import net.bytebuddy.dynamic.loading.ClassInjector;\n import net.bytebuddy.utility.JavaModule;\n+import net.bytebuddy.utility.RandomString;\n \n /** Injects instrumentation helper classes into the user's classloader. */\n @Slf4j\n public class HelperInjector implements Transformer {\n+  private static final TempDir TEMP_DIR = computeTempDir();", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwMzcwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387703704", "bodyText": "That would incur slightly more runtime overhead, but I could do that.", "author": "dougqh", "createdAt": "2020-03-04T14:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1MTI1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1NTY0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387855646", "bodyText": "After some discussion outside GitHub, we identified a race.\nSo we need to either remove the proactive clean-up or create a temp dir per injection.\nI think I'm going to do the later.", "author": "dougqh", "createdAt": "2020-03-04T18:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1MTI1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1NDM3MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387954371", "bodyText": "Done -- using temp dir per injection", "author": "dougqh", "createdAt": "2020-03-04T21:48:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1MTI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1ODg4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387658886", "bodyText": "Have you considered using java.nio.file.Files#createTempDirectory(java.nio.file.Path, java.lang.String, java.nio.file.attribute.FileAttribute<?>...) instead? Looks like it's part of jdk since java7, does pretty much similar thing and doesn't require reimplementing...", "author": "mar-kolya", "createdAt": "2020-03-04T13:16:52Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/HelperInjector.java", "diffHunk": "@@ -162,4 +187,82 @@ private void ensureModuleCanReadHelperModules(final JavaModule target) {\n       }\n     }\n   }\n+\n+  /*\n+   * Tries to temp file naming collisions by creating a unique directory per\n+   * process.  Generates up to random names.  If a no file exists with a\n+   * generated name, settles on using that name.  If name can be found falls\n+   * back using java.io.tmpdir directly.\n+   */\n+  private static final TempDir computeTempDir() {", "originalCommit": "4ad51dd9fa91c4d306be3d581132456c03b92933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwMjk1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387702954", "bodyText": "No, I'll take a look it.  Mostly, I was modeling after ByteBuddy.\nI'm also not entirely sure I want createTempDirectory, since I'd prefer to lazily create the dir, destroy it, and recreate the dir.", "author": "dougqh", "createdAt": "2020-03-04T14:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1ODg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcwNTY1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387705650", "bodyText": "You can create dir right before you need it - you do not have to do this in static call... :)", "author": "mar-kolya", "createdAt": "2020-03-04T14:35:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1ODg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk1MTkzMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1285#discussion_r387951931", "bodyText": "Switch to using createTempDirectory as suggested", "author": "dougqh", "createdAt": "2020-03-04T21:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1ODg4Ng=="}], "type": "inlineReview"}, {"oid": "7a183e755e31029c7ec7a1feed148fbf0503526f", "url": "https://github.com/DataDog/dd-trace-java/commit/7a183e755e31029c7ec7a1feed148fbf0503526f", "message": "Switching to per-injection temp dir to avoid race\n\nUpon review, we realized that there was a race not just between processes but also with multiple threads in the same process.\n\nThis race happens because of the effort to proactively clean-up directories.\n\nThis left two choices...\n- assume per-process exclusivity -- and resolve the race with reference counting\n- move to a temp dir per injection\n\nThis change uses the later strategy which is potentially more expensive but safest.", "committedDate": "2020-03-04T20:14:07Z", "type": "commit"}]}