{"pr_number": 2014, "pr_title": "Miscellaneous agent thread cleanup", "pr_createdAt": "2020-10-20T14:31:58Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2014", "timeline": [{"oid": "559776387bed9af39aff73c231be74e1e515f12c", "url": "https://github.com/DataDog/dd-trace-java/commit/559776387bed9af39aff73c231be74e1e515f12c", "message": "Rename DaemonThreadFactory to AgentThreadFactory", "committedDate": "2020-10-20T12:23:58Z", "type": "commit"}, {"oid": "99b85a665ae9359ffe68ed79d4a393e5df39c263", "url": "https://github.com/DataDog/dd-trace-java/commit/99b85a665ae9359ffe68ed79d4a393e5df39c263", "message": "Remove unused feature to simplify task creation", "committedDate": "2020-10-20T12:27:14Z", "type": "commit"}, {"oid": "f6b9ba2a2ee4afb42ee6c38522a8455bd65ca977", "url": "https://github.com/DataDog/dd-trace-java/commit/f6b9ba2a2ee4afb42ee6c38522a8455bd65ca977", "message": "Give each thread from the factory a unique name, and allow single threads to be created without needing a factory", "committedDate": "2020-10-20T12:55:33Z", "type": "commit"}, {"oid": "f7e3151cd640405f6e292bfe2e9b50e6a02b5eaa", "url": "https://github.com/DataDog/dd-trace-java/commit/f7e3151cd640405f6e292bfe2e9b50e6a02b5eaa", "message": "Reorder arguments", "committedDate": "2020-10-20T12:58:58Z", "type": "commit"}, {"oid": "173853aba0427d16b49746703f042a1b408eda1b", "url": "https://github.com/DataDog/dd-trace-java/commit/173853aba0427d16b49746703f042a1b408eda1b", "message": "Create startup and JMX threads as agent threads", "committedDate": "2020-10-20T13:07:12Z", "type": "commit"}, {"oid": "dc91288f4f74f957ad1c12a13335d9e088f5aebe", "url": "https://github.com/DataDog/dd-trace-java/commit/dc91288f4f74f957ad1c12a13335d9e088f5aebe", "message": "Replace ProfilingThreadFactory with AgentThreadFactory", "committedDate": "2020-10-20T13:10:47Z", "type": "commit"}, {"oid": "25e2111e8f243678ec3d6a37fb53681b35368d26", "url": "https://github.com/DataDog/dd-trace-java/commit/25e2111e8f243678ec3d6a37fb53681b35368d26", "message": "Avoid creating a thread factory just for single threads", "committedDate": "2020-10-20T13:14:27Z", "type": "commit"}, {"oid": "20e7ac1385786a01caf35227da05588879f86e3f", "url": "https://github.com/DataDog/dd-trace-java/commit/20e7ac1385786a01caf35227da05588879f86e3f", "message": "Cleanup javadoc", "committedDate": "2020-10-20T13:17:31Z", "type": "commit"}, {"oid": "5c6c459d15ec3239846bb1134f1e8538f25a9de6", "url": "https://github.com/DataDog/dd-trace-java/commit/5c6c459d15ec3239846bb1134f1e8538f25a9de6", "message": "Avoid creating a thread factory just for our single thread scheduler", "committedDate": "2020-10-20T13:27:16Z", "type": "commit"}, {"oid": "64537a4ef7a6c4cdb0468fd68c5debbd92f8e62a", "url": "https://github.com/DataDog/dd-trace-java/commit/64537a4ef7a6c4cdb0468fd68c5debbd92f8e62a", "message": "Add support for simple delayed one-shot agent threads", "committedDate": "2020-10-20T13:35:42Z", "type": "commit"}, {"oid": "c03c6e5992de32af078ec363c3bc560523c8be3f", "url": "https://github.com/DataDog/dd-trace-java/commit/c03c6e5992de32af078ec363c3bc560523c8be3f", "message": "Place agent shutdown hooks under the same agent thread group", "committedDate": "2020-10-20T13:56:29Z", "type": "commit"}, {"oid": "c1ef57dbd294d1393f18eeec8f1df4898bebd439", "url": "https://github.com/DataDog/dd-trace-java/commit/c1ef57dbd294d1393f18eeec8f1df4898bebd439", "message": "Remove use of @SneakyThrows", "committedDate": "2020-10-20T13:58:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2ODkxMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508568913", "bodyText": "I think there is value in having all the expected threads enumerated in a single place...", "author": "tylerbenson", "createdAt": "2020-10-20T14:41:51Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/TraceProcessingWorker.java", "diffHunk": "@@ -74,7 +74,7 @@ public TraceProcessingWorker(\n             dispatcher,\n             flushInterval,\n             timeUnit);\n-    this.serializerThread = DaemonThreadFactory.TRACE_PROCESSOR.newThread(serializingHandler);\n+    this.serializerThread = newAgentThread(\"dd-trace-processor\", serializingHandler);", "originalCommit": "c1ef57dbd294d1393f18eeec8f1df4898bebd439", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3NjgzNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508576835", "bodyText": "sure, I can add string constants for them", "author": "mcculls", "createdAt": "2020-10-20T14:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2ODkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU4ODA2Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508588062", "bodyText": "How bout an enum with a strongly typed argument for the method?", "author": "tylerbenson", "createdAt": "2020-10-20T15:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2ODkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYxODE2Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508618163", "bodyText": "There are a couple of places like ClassLoadCallBack which use a computed thread name (ie. prefix plus class name) - but I think that's still doable because we only allow callbacks for specific classes. I'll see what it looks like with an enum.", "author": "mcculls", "createdAt": "2020-10-20T15:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2ODkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5OTY1OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508699659", "bodyText": "@tylerbenson 388f95d - WDYT?", "author": "mcculls", "createdAt": "2020-10-20T17:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2ODkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcyNjA5Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508726096", "bodyText": "I like it.", "author": "tylerbenson", "createdAt": "2020-10-20T17:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2ODkxMw=="}], "type": "inlineReview"}, {"oid": "388f95dad0036eaaaaf533ec2094a320e6eaa312", "url": "https://github.com/DataDog/dd-trace-java/commit/388f95dad0036eaaaaf533ec2094a320e6eaa312", "message": "Use enum to list known agent threads", "committedDate": "2020-10-20T17:10:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcyNjQ4Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508726487", "bodyText": "Does this result in any new/different thread names from previous releases?", "author": "tylerbenson", "createdAt": "2020-10-20T17:54:51Z", "path": "internal-api/src/main/java/datadog/trace/util/AgentThreadFactory.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package datadog.trace.util;\n+\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.TimeUnit;\n+\n+/** A {@link ThreadFactory} implementation that starts all agent {@link Thread}s as daemons. */\n+public final class AgentThreadFactory implements ThreadFactory {\n+  public static final ThreadGroup AGENT_THREAD_GROUP = new ThreadGroup(\"dd-trace-java\");\n+\n+  // known agent threads\n+  public enum AgentThread {\n+    TASK_SCHEDULER,\n+    TRACE_STARTUP,\n+    TRACE_MONITOR,\n+    TRACE_PROCESSOR,\n+    TRACE_CASSANDRA_ASYNC_SESSION,\n+    JMX_STARTUP,\n+    JMX_COLLECTOR,\n+    PROFILER_STARTUP,\n+    PROFILER_RECORDING_STARTUP,\n+    PROFILER_RECORDING_SCHEDULER,\n+    PROFILER_HTTP_DISPATCHER;\n+\n+    public String threadName() {\n+      return \"dd-\" + name().toLowerCase().replace('_', '-');", "originalCommit": "388f95dad0036eaaaaf533ec2094a320e6eaa312", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczMjU0OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2014#discussion_r508732549", "bodyText": "Yes, fixing that atm", "author": "mcculls", "createdAt": "2020-10-20T18:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcyNjQ4Nw=="}], "type": "inlineReview"}, {"oid": "311be2177d12836410e65b7b32b34dc9c76acfac", "url": "https://github.com/DataDog/dd-trace-java/commit/311be2177d12836410e65b7b32b34dc9c76acfac", "message": "Maintain previous agent thread names", "committedDate": "2020-10-20T18:34:33Z", "type": "commit"}, {"oid": "8e13ae0706cf91ef309a446ba9cd844f9b748bac", "url": "https://github.com/DataDog/dd-trace-java/commit/8e13ae0706cf91ef309a446ba9cd844f9b748bac", "message": "Update excludedClassesCoverage", "committedDate": "2020-10-20T21:03:45Z", "type": "commit"}, {"oid": "5d66461c9ec63434a0476cf169f1a181a93d1aae", "url": "https://github.com/DataDog/dd-trace-java/commit/5d66461c9ec63434a0476cf169f1a181a93d1aae", "message": "Revert \"Add support for simple delayed one-shot agent threads\"\n\n(moving this to a follow-up PR to rework the profiler scheduler)", "committedDate": "2020-10-20T21:19:58Z", "type": "commit"}, {"oid": "345306ee71a3c81f78444df4aa4db434fd37c519", "url": "https://github.com/DataDog/dd-trace-java/commit/345306ee71a3c81f78444df4aa4db434fd37c519", "message": "Update excludedClassesCoverage", "committedDate": "2020-10-20T22:40:45Z", "type": "commit"}]}