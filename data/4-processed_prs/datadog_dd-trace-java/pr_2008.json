{"pr_number": 2008, "pr_title": "Change `asyncPropagating` default to true", "pr_createdAt": "2020-10-19T19:43:29Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2008", "timeline": [{"oid": "7e8807c870813e88b74c910550254a30f7897acf", "url": "https://github.com/DataDog/dd-trace-java/commit/7e8807c870813e88b74c910550254a30f7897acf", "message": "Cleanup and fix tests\n\nDisable netty request retry and update the host... This helps reduce extra spans that we aren't expecting.\n\nAdd test instrumentation to break propagation to the embedded test Elasticsearch instance.", "committedDate": "2020-10-19T20:40:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzMTkwNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508231905", "bodyText": "Could you add a comment to explain why this is necessary?", "author": "richardstartin", "createdAt": "2020-10-20T06:09:42Z", "path": "dd-java-agent/instrumentation/elasticsearch/transport-2/src/latestDepTest/groovy/ElasticsearchBreakTraceInstrumentation.java", "diffHunk": "@@ -0,0 +1,35 @@\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.noopSpan;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import net.bytebuddy.agent.builder.AgentBuilder;\n+import net.bytebuddy.asm.Advice;\n+\n+@AutoService(Instrumenter.class)\n+public class ElasticsearchBreakTraceInstrumentation implements Instrumenter {", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzMjEwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508232109", "bodyText": "Could you add a comment to explain how this differs from the other ElasticsearchBreakTraceInstrumentation?", "author": "richardstartin", "createdAt": "2020-10-20T06:10:17Z", "path": "dd-java-agent/instrumentation/elasticsearch/transport-2/src/test/groovy/ElasticsearchBreakTraceInstrumentation.java", "diffHunk": "@@ -0,0 +1,35 @@\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.noopSpan;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import net.bytebuddy.agent.builder.AgentBuilder;\n+import net.bytebuddy.asm.Advice;\n+\n+@AutoService(Instrumenter.class)\n+public class ElasticsearchBreakTraceInstrumentation implements Instrumenter {", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzMjI1Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508232253", "bodyText": "Could you add a comment to explain how this differs from the other ElasticsearchBreakTraceInstrumentation?", "author": "richardstartin", "createdAt": "2020-10-20T06:10:39Z", "path": "dd-java-agent/instrumentation/elasticsearch/transport-5.3/src/test/groovy/ElasticsearchBreakTraceInstrumentation.java", "diffHunk": "@@ -0,0 +1,35 @@\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.noopSpan;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import net.bytebuddy.agent.builder.AgentBuilder;\n+import net.bytebuddy.asm.Advice;\n+\n+@AutoService(Instrumenter.class)\n+public class ElasticsearchBreakTraceInstrumentation implements Instrumenter {", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzMjM0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508232341", "bodyText": "Could you add a comment to explain how this differs from the other ElasticsearchBreakTraceInstrumentation?", "author": "richardstartin", "createdAt": "2020-10-20T06:10:53Z", "path": "dd-java-agent/instrumentation/elasticsearch/transport-5/src/test/groovy/ElasticsearchBreakTraceInstrumentation.java", "diffHunk": "@@ -0,0 +1,35 @@\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.noopSpan;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import net.bytebuddy.agent.builder.AgentBuilder;\n+import net.bytebuddy.asm.Advice;\n+\n+@AutoService(Instrumenter.class)\n+public class ElasticsearchBreakTraceInstrumentation implements Instrumenter {", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzMjQ2OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508232469", "bodyText": "Could you add a comment to explain how this differs from the other ElasticsearchBreakTraceInstrumentation?", "author": "richardstartin", "createdAt": "2020-10-20T06:11:15Z", "path": "dd-java-agent/instrumentation/elasticsearch/transport-6/src/test/groovy/ElasticsearchBreakTraceInstrumentation.java", "diffHunk": "@@ -0,0 +1,35 @@\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activateSpan;\n+import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.noopSpan;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentScope;\n+import net.bytebuddy.agent.builder.AgentBuilder;\n+import net.bytebuddy.asm.Advice;\n+\n+@AutoService(Instrumenter.class)\n+public class ElasticsearchBreakTraceInstrumentation implements Instrumenter {", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzODc3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508238770", "bodyText": "How do we avoid diffs like this? One option is for you to uninstall the plugin which edits code unrelated to the change you've made when you save files as I believe you are now in a minority in using it. If we want consistent formatting of test files, note that I run ./gradlew spotlessApply before I commit every time I commit, but reformatting of test files is disabled; I think it should have been enabled. The status quo is unsustainable.", "author": "richardstartin", "createdAt": "2020-10-20T06:27:45Z", "path": "dd-java-agent/instrumentation/java-concurrent/src/test/groovy/NettyExecutorInstrumentationTest.groovy", "diffHunk": "@@ -14,7 +14,6 @@ import java.util.concurrent.Future\n import java.util.concurrent.RejectedExecutionException\n import java.util.concurrent.TimeUnit\n \n-import static datadog.trace.bootstrap.instrumentation.api.AgentTracer.activeScope\n import static org.junit.Assume.assumeTrue\n \n class NettyExecutorInstrumentationTest extends AgentTestRunner {", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzOTYyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508239628", "bodyText": "Hmm. Why is this necessary? Is this a new gotcha? This definitely needs a comment now.", "author": "richardstartin", "createdAt": "2020-10-20T06:29:44Z", "path": "dd-java-agent/instrumentation/opentracing/api-0.31/src/test/groovy/OpenTracing31Test.groovy", "diffHunk": "@@ -131,6 +131,7 @@ class OpenTracing31Test extends AgentTestRunner {\n     setup:\n     def span = tracer.buildSpan(\"some name\").start()\n     def scope = tracer.scopeManager().activate(span, finishSpan)\n+    (scope as TraceScope).setAsyncPropagation(false)", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MzgzMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508673832", "bodyText": "This was not a new gotcha... it was returning the state to false so the rest of the test could remain the same.  I could just as easily invert the test.", "author": "tylerbenson", "createdAt": "2020-10-20T16:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzOTYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1Njk4Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r509156983", "bodyText": "I'm picking up on why it's necessary to make this change at all - won't this break a lot of manually traced applications if it's strictly necessary to invert the flag?", "author": "richardstartin", "createdAt": "2020-10-21T10:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzOTYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2ODk4OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r509268988", "bodyText": "Previously we were relying on the implicit default state. In the expect block below, we are explicitly asserting:\n    !(scope as TraceScope).isAsyncPropagating()\n    (scope as TraceScope).capture() == null\n\nThis is not something a customer would likely be doing.\nChanging the default requires this test to change.  Would you prefer continuing to rely on the default and change the asserts or make the expected state implicit up front?", "author": "tylerbenson", "createdAt": "2020-10-21T13:16:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzOTYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUzMTk4Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508531987", "bodyText": "I wasn't expected the set to true blocks to be removed in this first step.\nI was assuming we just set async propagation will to true and that's it.", "author": "dougqh", "createdAt": "2020-10-20T14:00:03Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/java/concurrent/AdviceUtils.java", "diffHunk": "@@ -22,9 +22,7 @@\n     if (state != null) {\n       final TraceScope.Continuation continuation = state.getAndResetContinuation();\n       if (continuation != null) {\n-        final TraceScope scope = continuation.activate();", "originalCommit": "7e8807c870813e88b74c910550254a30f7897acf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNzg3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2008#discussion_r508827870", "bodyText": "I've reverted those changes and added a flag we can flip to change the default again.", "author": "tylerbenson", "createdAt": "2020-10-20T20:45:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUzMTk4Nw=="}], "type": "inlineReview"}, {"oid": "318a904c8514c4bcb2e0d7375bd3fc8a72b4498e", "url": "https://github.com/DataDog/dd-trace-java/commit/318a904c8514c4bcb2e0d7375bd3fc8a72b4498e", "message": "Cleanup and fix tests\n\nDisable netty request retry and update the host... This helps reduce extra spans that we aren't expecting.\n\nAdd test instrumentation to break propagation to the embedded test Elasticsearch instance.", "committedDate": "2020-10-20T19:10:40Z", "type": "forcePushed"}, {"oid": "287496522aefa71f1e03dabe458cef0192270929", "url": "https://github.com/DataDog/dd-trace-java/commit/287496522aefa71f1e03dabe458cef0192270929", "message": "Change `asyncPropagating` default to true", "committedDate": "2020-10-21T14:46:10Z", "type": "commit"}, {"oid": "9d6ae3aef977be0a4d32fb05998b62437a2a6f14", "url": "https://github.com/DataDog/dd-trace-java/commit/9d6ae3aef977be0a4d32fb05998b62437a2a6f14", "message": "Remove unnecessary usage of `setAsyncPropagation(true)`", "committedDate": "2020-10-21T14:46:11Z", "type": "commit"}, {"oid": "24b5714df9a98b24dab1118c44584002ac2c14a8", "url": "https://github.com/DataDog/dd-trace-java/commit/24b5714df9a98b24dab1118c44584002ac2c14a8", "message": "Revert \"Remove unnecessary usage of `setAsyncPropagation(true)`\"\n\nThis reverts commit b437fe7d41cc9699d217e0e30515a66aeb736342.", "committedDate": "2020-10-21T14:46:11Z", "type": "commit"}, {"oid": "fccc64c407aa777f2eafb4b2e903180f8dab1ce8", "url": "https://github.com/DataDog/dd-trace-java/commit/fccc64c407aa777f2eafb4b2e903180f8dab1ce8", "message": "Cleanup and fix tests\n\nDisable netty request retry and update the host... This helps reduce extra spans that we aren't expecting.\n\nAdd test instrumentation to break propagation to the embedded test Elasticsearch instance.", "committedDate": "2020-10-21T14:46:11Z", "type": "commit"}, {"oid": "e1e9b760b857b02502167bb2b4a1d54528d01419", "url": "https://github.com/DataDog/dd-trace-java/commit/e1e9b760b857b02502167bb2b4a1d54528d01419", "message": "Add constant to enable quick switching of default", "committedDate": "2020-10-21T14:46:11Z", "type": "commit"}, {"oid": "7da80368213cb94146efff88ccda27a84472c7a1", "url": "https://github.com/DataDog/dd-trace-java/commit/7da80368213cb94146efff88ccda27a84472c7a1", "message": "Add simple logging", "committedDate": "2020-10-21T14:46:11Z", "type": "commit"}, {"oid": "7da80368213cb94146efff88ccda27a84472c7a1", "url": "https://github.com/DataDog/dd-trace-java/commit/7da80368213cb94146efff88ccda27a84472c7a1", "message": "Add simple logging", "committedDate": "2020-10-21T14:46:11Z", "type": "forcePushed"}, {"oid": "0f216e5b92b24e78b070a5166d2c99deb5179104", "url": "https://github.com/DataDog/dd-trace-java/commit/0f216e5b92b24e78b070a5166d2c99deb5179104", "message": "Merge branch 'master' into tyler/async-default\n\n# Conflicts:\n#\tdd-trace-core/src/main/java/datadog/trace/core/CoreTracer.java", "committedDate": "2020-10-22T18:19:10Z", "type": "commit"}]}