{"pr_number": 1575, "pr_title": "Prevent re-entering throwable instrumentation handler", "pr_createdAt": "2020-06-11T15:55:13Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1575", "timeline": [{"oid": "1b0cec072b208ea219bc9574c6e5d9db0648e51b", "url": "https://github.com/DataDog/dd-trace-java/commit/1b0cec072b208ea219bc9574c6e5d9db0648e51b", "message": "Make profiling smoke test use the agent jar (instead of shadowed classes)", "committedDate": "2020-06-11T15:50:16Z", "type": "commit"}, {"oid": "9ee3f35ff662898d6553def1fca5214575d529c0", "url": "https://github.com/DataDog/dd-trace-java/commit/9ee3f35ff662898d6553def1fca5214575d529c0", "message": "Add log file contents assertion to profiling smoke tests", "committedDate": "2020-06-11T15:50:41Z", "type": "commit"}, {"oid": "862cb5ed16828fa2fc3104728c445c3d5f9c9509", "url": "https://github.com/DataDog/dd-trace-java/commit/862cb5ed16828fa2fc3104728c445c3d5f9c9509", "message": "Prevent infinite recursion in throwable instance instrumentation", "committedDate": "2020-06-11T15:51:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNTQ5OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438905498", "bodyText": "Imho this is a good idea but you may want to make it available for all AbstractSmokeTest - they all use same approach to write logs", "author": "mar-kolya", "createdAt": "2020-06-11T16:11:08Z", "path": "dd-smoke-tests/profiling-integration-tests/src/test/groovy/datadog/smoketest/AbstractProfilingIntegrationTest.groovy", "diffHunk": "@@ -39,4 +43,18 @@ abstract class AbstractProfilingIntegrationTest extends AbstractSmokeTest {\n   def getExitDelay() {\n     return -1\n   }\n+\n+  def checkLog(Closure checker) {\n+    new File(\"${buildDirectory}/reports/testProcess.${this.getClass().getName()}.log\").eachLine {\n+      if (it.contains(\"ERROR\") || it.contains(\"WARN\") || it.contains(\"ASSERTION FAILED\")) {\n+        println it\n+        logHasErrors = true\n+      }\n+      checker(it)\n+    }\n+  }\n+\n+  def checkLog() {\n+    checkLog {}\n+  }", "originalCommit": "862cb5ed16828fa2fc3104728c445c3d5f9c9509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNzQ5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438907493", "bodyText": "I also think you can drop version with custom Closure unless you have uses for it...", "author": "mar-kolya", "createdAt": "2020-06-11T16:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNTQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxMTMxMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438911310", "bodyText": "Yeah, I have a usage for it in MLT branch - so if I drop it now I will have to re-introduce it later.", "author": "jbachorik", "createdAt": "2020-06-11T16:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNTQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzODM3Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438938377", "bodyText": "sure, if you have a use for it", "author": "mar-kolya", "createdAt": "2020-06-11T17:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNTQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNTgxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438905815", "bodyText": "Could you please explain what this does?", "author": "mar-kolya", "createdAt": "2020-06-11T16:11:37Z", "path": "dd-smoke-tests/profiling-integration-tests/profiling-integration-tests.gradle", "diffHunk": "@@ -34,3 +34,9 @@ tasks.withType(Test).configureEach {\n \n   jvmArgs \"-Ddatadog.smoketest.profiling.shadowJar.path=${tasks.shadowJar.archivePath}\"\n }\n+\n+shadowJar {\n+  dependencies {\n+    include(dependency('org.slf4j::'))\n+  }\n+}", "originalCommit": "862cb5ed16828fa2fc3104728c445c3d5f9c9509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxMDkxOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438910919", "bodyText": "It is leaving out all the tracing and agent classes which are otherwise referenced through dependencies. If we keep these classes in the shadow jar they will mess up the class path in a way that makes detecting class loading issues in the agent jar impossible.", "author": "jbachorik", "createdAt": "2020-06-11T16:19:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNTgxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTM3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438941374", "bodyText": "Looks like this is not really necessary and the real 'fix' was parsing and asserting the test app log contents.", "author": "jbachorik", "createdAt": "2020-06-11T17:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNTgxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNjgxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438906818", "bodyText": "Would be great to have a comment explaining what this protects against in detail... this is useful info since it is very non trivial", "author": "mar-kolya", "createdAt": "2020-06-11T16:13:06Z", "path": "dd-java-agent/instrumentation/exception-profiling/src/main/java11/datadog/exceptions/instrumentation/ThrowableInstanceAdvice.java", "diffHunk": "@@ -7,21 +7,27 @@\n public class ThrowableInstanceAdvice {\n   @Advice.OnMethodExit(suppress = Throwable.class)\n   public static void onExit(@Advice.This final Throwable t) {\n-    /*\n-     * We may get into a situation when this is called before ExceptionProfiling had a chance\n-     * to fully initialize. So despite the fact that this returns static singleton this may\n-     * return null sometimes.\n-     */\n-    if (ExceptionProfiling.getInstance() == null) {\n-      return;\n-    }\n-    /*\n-     * JFR will assign the stacktrace depending on the place where the event is committed.\n-     * Therefore we need to commit the event here, right in the 'Exception' constructor\n-     */\n-    final ExceptionSampleEvent event = ExceptionProfiling.getInstance().process(t);\n-    if (event != null && event.shouldCommit()) {\n-      event.commit();\n+    if (ThrowableInstanceAdviceHelper.enterHandler()) {", "originalCommit": "862cb5ed16828fa2fc3104728c445c3d5f9c9509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTA2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438941060", "bodyText": "Done", "author": "jbachorik", "createdAt": "2020-06-11T17:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNjgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNzE3MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438907171", "bodyText": "Maybe a comment here explaining what it guards against (as described in the PR comment).", "author": "bantonsson", "createdAt": "2020-06-11T16:13:42Z", "path": "dd-java-agent/instrumentation/exception-profiling/src/main/java11/datadog/exceptions/instrumentation/ThrowableInstanceAdvice.java", "diffHunk": "@@ -7,21 +7,27 @@\n public class ThrowableInstanceAdvice {\n   @Advice.OnMethodExit(suppress = Throwable.class)\n   public static void onExit(@Advice.This final Throwable t) {\n-    /*\n-     * We may get into a situation when this is called before ExceptionProfiling had a chance\n-     * to fully initialize. So despite the fact that this returns static singleton this may\n-     * return null sometimes.\n-     */\n-    if (ExceptionProfiling.getInstance() == null) {\n-      return;\n-    }\n-    /*\n-     * JFR will assign the stacktrace depending on the place where the event is committed.\n-     * Therefore we need to commit the event here, right in the 'Exception' constructor\n-     */\n-    final ExceptionSampleEvent event = ExceptionProfiling.getInstance().process(t);\n-    if (event != null && event.shouldCommit()) {\n-      event.commit();\n+    if (ThrowableInstanceAdviceHelper.enterHandler()) {", "originalCommit": "862cb5ed16828fa2fc3104728c445c3d5f9c9509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MDk3OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438940978", "bodyText": "Done", "author": "jbachorik", "createdAt": "2020-06-11T17:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNzE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzMzMzMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438933333", "bodyText": "you you please add a print out something like 'See full run logs in {filename}` if there are errors?", "author": "mar-kolya", "createdAt": "2020-06-11T16:57:03Z", "path": "dd-smoke-tests/profiling-integration-tests/src/test/groovy/datadog/smoketest/AbstractProfilingIntegrationTest.groovy", "diffHunk": "@@ -39,4 +43,18 @@ abstract class AbstractProfilingIntegrationTest extends AbstractSmokeTest {\n   def getExitDelay() {\n     return -1\n   }\n+\n+  def checkLog(Closure checker) {\n+    new File(\"${buildDirectory}/reports/testProcess.${this.getClass().getName()}.log\").eachLine {", "originalCommit": "862cb5ed16828fa2fc3104728c445c3d5f9c9509", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzOTI0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438939242", "bodyText": "FWIW: if you move the reentrace check into ExceptionProfiling.getInstance().process you would actually be able to unit test this since you can call process with some special exception that calls process again...", "author": "mar-kolya", "createdAt": "2020-06-11T17:07:40Z", "path": "dd-java-agent/instrumentation/exception-profiling/src/main/java11/datadog/exceptions/instrumentation/ThrowableInstanceAdvice.java", "diffHunk": "@@ -7,21 +7,27 @@\n public class ThrowableInstanceAdvice {\n   @Advice.OnMethodExit(suppress = Throwable.class)\n   public static void onExit(@Advice.This final Throwable t) {\n-    /*\n-     * We may get into a situation when this is called before ExceptionProfiling had a chance\n-     * to fully initialize. So despite the fact that this returns static singleton this may\n-     * return null sometimes.\n-     */\n-    if (ExceptionProfiling.getInstance() == null) {\n-      return;\n-    }\n-    /*\n-     * JFR will assign the stacktrace depending on the place where the event is committed.\n-     * Therefore we need to commit the event here, right in the 'Exception' constructor\n-     */\n-    final ExceptionSampleEvent event = ExceptionProfiling.getInstance().process(t);\n-    if (event != null && event.shouldCommit()) {\n-      event.commit();\n+    if (ThrowableInstanceAdviceHelper.enterHandler()) {\n+      try {\n+        /*\n+         * We may get into a situation when this is called before ExceptionProfiling had a chance\n+         * to fully initialize. So despite the fact that this returns static singleton this may\n+         * return null sometimes.\n+         */\n+        if (ExceptionProfiling.getInstance() == null) {\n+          return;\n+        }\n+        /*\n+         * JFR will assign the stacktrace depending on the place where the event is committed.\n+         * Therefore we need to commit the event here, right in the 'Exception' constructor\n+         */\n+        final ExceptionSampleEvent event = ExceptionProfiling.getInstance().process(t);", "originalCommit": "862cb5ed16828fa2fc3104728c445c3d5f9c9509", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MDczMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1575#discussion_r438940733", "bodyText": "Yes, I was thinking about this. But - this logic seems to be really related to the advice handler and not ExceptionProfiling.\nBut I can unit test ThrowableInstanceAdviceHelper quite easily and it will give the same level of confidence since it is that class doing the heavy lifting.", "author": "jbachorik", "createdAt": "2020-06-11T17:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzOTI0Mg=="}], "type": "inlineReview"}, {"oid": "b28676c1d5285167cdfd70e795ceb83bf59bf7d2", "url": "https://github.com/DataDog/dd-trace-java/commit/b28676c1d5285167cdfd70e795ceb83bf59bf7d2", "message": "Add comments and improve tests", "committedDate": "2020-06-11T17:08:22Z", "type": "commit"}]}