{"pr_number": 1958, "pr_title": "Delay starting JMXFetch when there's a custom JMX builder", "pr_createdAt": "2020-10-07T11:58:25Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1958", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1MTQ5Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1958#discussion_r501051497", "bodyText": "Is this late enough?  By the time this class is loaded, are you sure the custom server is defined?  Since this is the builder class, it seems when this is loaded the custom server is being initialized, but not fully defined.\nWith log manager we picked the activating class that ensured a correct state (where the static field with the log manager is initialized).", "author": "tylerbenson", "createdAt": "2020-10-07T14:19:27Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -114,6 +123,18 @@ private static void registerLogManagerCallback(final ClassLoadCallBack callback)\n     }\n   }\n \n+  private static void registerMBeanServerBuilderCallback(final ClassLoadCallBack callback) {\n+    try {\n+      final Class<?> agentInstallerClass =\n+          AGENT_CLASSLOADER.loadClass(\"datadog.trace.agent.tooling.AgentInstaller\");\n+      final Method registerCallbackMethod =\n+          agentInstallerClass.getMethod(\"registerClassLoadCallback\", String.class, Runnable.class);\n+      registerCallbackMethod.invoke(null, \"javax.management.MBeanServerBuilder\", callback);", "originalCommit": "7a17c064bfa69ee55479574fff9406ca733e03a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4ODgyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1958#discussion_r501088828", "bodyText": "MBeanServerBuilder is the base class of any custom JMX builder, like LogManager is for the custom log manager case. It should only be touched as part of the JMX bootstrap and at that point it should be far enough in that everything is in place to find the custom builder.", "author": "mcculls", "createdAt": "2020-10-07T15:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1MTQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExNjIwMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1958#discussion_r501116201", "bodyText": "There is of course a chance that someone could attempt to load MBeanServerBuilder or a subclass of it directly, but that would be unusual because JMX won't let you pass in an instance. It only lets you set that property and JMX will create the instance for you.\nApart from internal (com.sun) JMX bootstrap classes, the only other JDK class that refers to this and could trigger a load is javax.management.MBeanServerFactory and so far I've only found it referred to at the point when the platform request comes in - ie. when everything should be setup for the custom loader.\nUnlike the log manager case there isn't a static block in the activating class, but this is the next best option. The alternatives would be to look for the custom class itself (but if something changed that then we'd never start JMX) or the internal JDK classes (but then we'd need to cover different vendor implementations.)", "author": "mcculls", "createdAt": "2020-10-07T15:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1MTQ5Nw=="}], "type": "inlineReview"}, {"oid": "1e07b3d42b6b2ee8fcce8b39ac20a4ee606f9592", "url": "https://github.com/DataDog/dd-trace-java/commit/1e07b3d42b6b2ee8fcce8b39ac20a4ee606f9592", "message": "Delay starting JMXFetch when there's a custom JMX builder that's not on the system classpath (ie. it will be provisioned later)", "committedDate": "2020-10-09T11:10:47Z", "type": "commit"}, {"oid": "42ea301689d1a32b05535aa0e15bf5b5bf9c52d5", "url": "https://github.com/DataDog/dd-trace-java/commit/42ea301689d1a32b05535aa0e15bf5b5bf9c52d5", "message": "Make sure we load core JMX using the deferred callback's inherited thread-context-classloader (TCCL)\n\nThis handles a situation where the app thread triggering JMX has a special thread-context-classloader\nset that can see the custom JMX builder class. The callback thread inherits this TCCL so we just need\nto make sure to load core JMX using this before starting JMXFetch (which needs a different TCCL set.)", "committedDate": "2020-10-09T11:10:47Z", "type": "commit"}, {"oid": "f919ffd130c9af489a834b0741cb3bd5020861ef", "url": "https://github.com/DataDog/dd-trace-java/commit/f919ffd130c9af489a834b0741cb3bd5020861ef", "message": "Run test with profiling on", "committedDate": "2020-10-09T11:10:47Z", "type": "commit"}, {"oid": "f919ffd130c9af489a834b0741cb3bd5020861ef", "url": "https://github.com/DataDog/dd-trace-java/commit/f919ffd130c9af489a834b0741cb3bd5020861ef", "message": "Run test with profiling on", "committedDate": "2020-10-09T11:10:47Z", "type": "forcePushed"}]}