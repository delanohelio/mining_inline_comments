{"pr_number": 2204, "pr_title": "Make PendingTrace lighter-weight", "pr_createdAt": "2020-12-15T11:46:05Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2204", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3Nzc2Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543277766", "bodyText": "I'm not really sure why this isn't just a final field required for construction. No doubt it's motivated by code reuse.", "author": "richardstartin", "createdAt": "2020-12-15T11:50:15Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -143,8 +140,12 @@ public void registerSpan(final DDSpan span) {\n       return;\n     }\n \n-    if (!rootSpanWritten.get()) {\n-      rootSpan.compareAndSet(null, new WeakReference<>(span));\n+    if (null == rootSpan) {", "originalCommit": "927380c394f6b61177f760e03e3cb592b09c3f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5MDMwMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543290300", "bodyText": "The comment above about Use a weak ref because... can also be removed now", "author": "mcculls", "createdAt": "2020-12-15T12:11:25Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -85,9 +82,9 @@ PendingTrace create(final DDId traceId) {\n    * <p>The root span will be available in non-buggy cases because it has either finished and\n    * strongly ref'd in this queue or is unfinished and ref'd in a ContinuableScope.\n    */\n-  private final AtomicReference<WeakReference<DDSpan>> rootSpan = new AtomicReference<>();", "originalCommit": "927380c394f6b61177f760e03e3cb592b09c3f5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5MjU0Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543292547", "bodyText": "Yeah, SpanCleaner no longer exists either, so I think most of this comment can go.", "author": "richardstartin", "createdAt": "2020-12-15T12:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5MDMwMA=="}], "type": "inlineReview"}, {"oid": "b2affd1ef3a2f616c4d05b853464c495f1a42558", "url": "https://github.com/DataDog/dd-trace-java/commit/b2affd1ef3a2f616c4d05b853464c495f1a42558", "message": "use volatiles instead of atomics in PendingTrace, hold direct reference to root span", "committedDate": "2020-12-15T12:13:21Z", "type": "commit"}, {"oid": "b2affd1ef3a2f616c4d05b853464c495f1a42558", "url": "https://github.com/DataDog/dd-trace-java/commit/b2affd1ef3a2f616c4d05b853464c495f1a42558", "message": "use volatiles instead of atomics in PendingTrace, hold direct reference to root span", "committedDate": "2020-12-15T12:13:21Z", "type": "forcePushed"}, {"oid": "4fed89b91665313d6d3f7fb2adc6e430fab5683b", "url": "https://github.com/DataDog/dd-trace-java/commit/4fed89b91665313d6d3f7fb2adc6e430fab5683b", "message": "align PendingTrace comments with present reality", "committedDate": "2020-12-15T12:17:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI5NzIyNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543297224", "bodyText": "I think this should be inside the synchronized block and I don't understand how\nif (!rootSpanWritten.get()) {\n      rootSpan.compareAndSet(null, new WeakReference<>(span));\n}\n...\nrootSpanWritten.set(true);\nweren't just racing anyway.", "author": "richardstartin", "createdAt": "2020-12-15T12:22:36Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -247,7 +234,7 @@ private void partialFlush() {\n \n   /** Important to note: may be called multiple times. */\n   void write() {\n-    rootSpanWritten.set(true);\n+    rootSpanWritten = true;", "originalCommit": "4fed89b91665313d6d3f7fb2adc6e430fab5683b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwMjQ0MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543302440", "bodyText": "previously this was only set on a full write, now it is set on partial and full writes - is this ok?\nie. does any write end up writing the root span?", "author": "mcculls", "createdAt": "2020-12-15T12:31:22Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -259,6 +245,7 @@ private int write(boolean isPartial) {\n       try (Recording recording = tracer.writeTimer()) {\n         // Only one writer at a time\n         synchronized (this) {\n+          rootSpanWritten = true;", "originalCommit": "d168b9f3595a67fe6ac3fe523baa91c1b724e858", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxOTAzNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543319036", "bodyText": "good point, I hadn't noticed that.", "author": "richardstartin", "createdAt": "2020-12-15T12:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwMjQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMDIzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543320230", "bodyText": "the motivation was to move this inside the synchronized block so it doesn't race. I check for !isPartialWrite now.", "author": "richardstartin", "createdAt": "2020-12-15T12:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwMjQ0MA=="}], "type": "inlineReview"}, {"oid": "e5c91f2a1e8cedfa337091880fd4879972f73e78", "url": "https://github.com/DataDog/dd-trace-java/commit/e5c91f2a1e8cedfa337091880fd4879972f73e78", "message": "move setting rootSpanWritten into synchronized block in write()", "committedDate": "2020-12-15T12:58:08Z", "type": "commit"}, {"oid": "e5c91f2a1e8cedfa337091880fd4879972f73e78", "url": "https://github.com/DataDog/dd-trace-java/commit/e5c91f2a1e8cedfa337091880fd4879972f73e78", "message": "move setting rootSpanWritten into synchronized block in write()", "committedDate": "2020-12-15T12:58:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NTIwMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543565201", "bodyText": "Thanks for removing that.  We should probably should have done that during the prior round of PendingTraces.", "author": "dougqh", "createdAt": "2020-12-15T18:00:27Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -61,33 +58,20 @@ PendingTrace create(final DDId traceId) {\n   /** Nano second ticks value at trace start */\n   private final long startNanoTicks;\n \n-  private final ConcurrentLinkedDeque<DDSpan> finishedSpans = new ConcurrentLinkedDeque();\n+  private final ConcurrentLinkedDeque<DDSpan> finishedSpans = new ConcurrentLinkedDeque<>();\n \n   // We must maintain a separate count because ConcurrentLinkedDeque.size() is a linear operation.\n   private final AtomicInteger completedSpanCount = new AtomicInteger(0);\n \n   private final AtomicInteger pendingReferenceCount = new AtomicInteger(0);\n \n-  // FIXME: In async frameworks we may have situations where traces do not report due to references", "originalCommit": "e5c91f2a1e8cedfa337091880fd4879972f73e78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NTkzOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2204#discussion_r543565938", "bodyText": "Yes, we seemed to have used Atomic* in a lot places where its overkill.  Thanks for cleaning this up.", "author": "dougqh", "createdAt": "2020-12-15T18:01:28Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/PendingTrace.java", "diffHunk": "@@ -61,33 +58,20 @@ PendingTrace create(final DDId traceId) {\n   /** Nano second ticks value at trace start */\n   private final long startNanoTicks;\n \n-  private final ConcurrentLinkedDeque<DDSpan> finishedSpans = new ConcurrentLinkedDeque();\n+  private final ConcurrentLinkedDeque<DDSpan> finishedSpans = new ConcurrentLinkedDeque<>();\n \n   // We must maintain a separate count because ConcurrentLinkedDeque.size() is a linear operation.\n   private final AtomicInteger completedSpanCount = new AtomicInteger(0);\n \n   private final AtomicInteger pendingReferenceCount = new AtomicInteger(0);\n \n-  // FIXME: In async frameworks we may have situations where traces do not report due to references\n-  //  being held by async operators. In order to support testing in these cases we should have a way\n-  //  to keep track of the fact that this trace is ready to report but is still pending. This would\n-  //  likely require a change to the writer interface to allow signaling this intent. This could\n-  //  also give us the benefit of being able to recover for reporting traces that get stuck due to\n-  //  references being held for long periods of time.\n-\n   /**\n    * During a trace there are cases where the root span must be accessed (e.g. priority sampling and\n-   * trace-search tags).\n-   *\n-   * <p>Use a weak ref because we still need to handle buggy cases where the root span is not\n-   * correctly closed (see SpanCleaner).\n-   *\n-   * <p>The root span will be available in non-buggy cases because it has either finished and\n-   * strongly ref'd in this queue or is unfinished and ref'd in a ContinuableScope.\n+   * trace-search tags). These use cases are an obstacle to span-streaming.\n    */\n-  private final AtomicReference<WeakReference<DDSpan>> rootSpan = new AtomicReference<>();\n+  private volatile DDSpan rootSpan = null;\n \n-  private final AtomicBoolean rootSpanWritten = new AtomicBoolean(false);\n+  private volatile boolean rootSpanWritten = false;", "originalCommit": "e5c91f2a1e8cedfa337091880fd4879972f73e78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}