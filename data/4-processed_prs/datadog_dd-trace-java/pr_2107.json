{"pr_number": 2107, "pr_title": "add latency metrics", "pr_createdAt": "2020-11-23T10:27:02Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2107", "timeline": [{"oid": "78a74467f0e5eef2a1ad331923767ea03a0d0943", "url": "https://github.com/DataDog/dd-trace-java/commit/78a74467f0e5eef2a1ad331923767ea03a0d0943", "message": "add latency metrics", "committedDate": "2020-11-23T12:30:11Z", "type": "forcePushed"}, {"oid": "83a354e2a94ce06ac6dc0c0d06b800021ae9d374", "url": "https://github.com/DataDog/dd-trace-java/commit/83a354e2a94ce06ac6dc0c0d06b800021ae9d374", "message": "add latency metrics", "committedDate": "2020-11-23T12:41:02Z", "type": "forcePushed"}, {"oid": "f6b4afd4db2ce4a9a5009103b0e425ea604afeb1", "url": "https://github.com/DataDog/dd-trace-java/commit/f6b4afd4db2ce4a9a5009103b0e425ea604afeb1", "message": "add latency metrics", "committedDate": "2020-11-23T13:06:46Z", "type": "forcePushed"}, {"oid": "34a8de4de21c04814f2e0764d1610d907028bcca", "url": "https://github.com/DataDog/dd-trace-java/commit/34a8de4de21c04814f2e0764d1610d907028bcca", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-23T13:39:33Z", "type": "forcePushed"}, {"oid": "12cdb42a8b0ebcde4d8d9d814ea5baf9473102d4", "url": "https://github.com/DataDog/dd-trace-java/commit/12cdb42a8b0ebcde4d8d9d814ea5baf9473102d4", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-23T13:50:30Z", "type": "forcePushed"}, {"oid": "b1829ce95683bf7d109fcd5343f6e721e91703d2", "url": "https://github.com/DataDog/dd-trace-java/commit/b1829ce95683bf7d109fcd5343f6e721e91703d2", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-23T15:11:21Z", "type": "forcePushed"}, {"oid": "13b914765b90797e20c30cba36d98a49b89116d3", "url": "https://github.com/DataDog/dd-trace-java/commit/13b914765b90797e20c30cba36d98a49b89116d3", "message": "remove minJavaVersionForTests", "committedDate": "2020-11-23T16:48:58Z", "type": "forcePushed"}, {"oid": "0ff526a2d32c533d02104e92ad029d8a8feab1aa", "url": "https://github.com/DataDog/dd-trace-java/commit/0ff526a2d32c533d02104e92ad029d8a8feab1aa", "message": "another way", "committedDate": "2020-11-23T18:29:23Z", "type": "forcePushed"}, {"oid": "b1829ce95683bf7d109fcd5343f6e721e91703d2", "url": "https://github.com/DataDog/dd-trace-java/commit/b1829ce95683bf7d109fcd5343f6e721e91703d2", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-23T15:11:21Z", "type": "forcePushed"}, {"oid": "4d8060f14209635631b1f2d57d7dd572df1ef2d8", "url": "https://github.com/DataDog/dd-trace-java/commit/4d8060f14209635631b1f2d57d7dd572df1ef2d8", "message": "another attempt", "committedDate": "2020-11-23T19:49:00Z", "type": "forcePushed"}, {"oid": "b01bfc3e28cf7fafe33b03b8e09258a3905c8fa8", "url": "https://github.com/DataDog/dd-trace-java/commit/b01bfc3e28cf7fafe33b03b8e09258a3905c8fa8", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-23T21:38:55Z", "type": "forcePushed"}, {"oid": "a580cdaae95c9574e694fe173317268bae96105c", "url": "https://github.com/DataDog/dd-trace-java/commit/a580cdaae95c9574e694fe173317268bae96105c", "message": "Only add versioned output as dependency if source exists", "committedDate": "2020-11-24T09:51:29Z", "type": "forcePushed"}, {"oid": "eaaf7a226a68312c5cbad9c0d68eaa1f24580b7f", "url": "https://github.com/DataDog/dd-trace-java/commit/eaaf7a226a68312c5cbad9c0d68eaa1f24580b7f", "message": "don't run tests for JDK7", "committedDate": "2020-11-24T10:15:56Z", "type": "forcePushed"}, {"oid": "bd889984c016132d86d963c69964df09358c357e", "url": "https://github.com/DataDog/dd-trace-java/commit/bd889984c016132d86d963c69964df09358c357e", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-24T14:18:00Z", "type": "forcePushed"}, {"oid": "f3a6ec43bae5e94d74e47df76cccf1f113fef4b2", "url": "https://github.com/DataDog/dd-trace-java/commit/f3a6ec43bae5e94d74e47df76cccf1f113fef4b2", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-24T14:40:13Z", "type": "forcePushed"}, {"oid": "a63740b9c7fd0b9be8b47f35dddb0c2ccce275d7", "url": "https://github.com/DataDog/dd-trace-java/commit/a63740b9c7fd0b9be8b47f35dddb0c2ccce275d7", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-24T16:58:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0ODkwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529748909", "bodyText": "Maybe \u2018hitLatencies\u2019 ?", "author": "lpriima", "createdAt": "2020-11-24T17:22:49Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/metrics/AggregateMetric.java", "diffHunk": "@@ -1,11 +1,25 @@\n package datadog.trace.common.metrics;\n \n+import datadog.trace.core.histogram.Histogram;\n+import datadog.trace.core.histogram.HistogramFactory;\n+import datadog.trace.core.histogram.Histograms;\n+\n /** Not thread-safe. Accumulates counts and durations. */\n public final class AggregateMetric {\n+\n+  private static final HistogramFactory HISTOGRAM_FACTORY = Histograms.newHistogramFactory();\n+\n+  private Histogram latencies;", "originalCommit": "a63740b9c7fd0b9be8b47f35dddb0c2ccce275d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc1NjU4OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529756588", "bodyText": "I thought you spent some time ago to cleanup all serialization APIs based on java array length. And now it\u2019s back", "author": "lpriima", "createdAt": "2020-11-24T17:34:17Z", "path": "utils/histograms/src/main/java/datadog/trace/core/histogram/Histogram.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package datadog.trace.core.histogram;\n+\n+public interface Histogram {\n+\n+  void accept(long value);\n+\n+  byte[] serialize();", "originalCommit": "a63740b9c7fd0b9be8b47f35dddb0c2ccce275d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2MjczMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529762733", "bodyText": "I'm less concerned here because there will be at most 1000 of these once every 10 seconds, but once this is finished I will be able to get rid of this and serialise into the output buffer.", "author": "richardstartin", "createdAt": "2020-11-24T17:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc1NjU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc1NzkwMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529757901", "bodyText": "I thought you spent some time ago to cleanup all serialization APIs based on java array length(mostly to reuse the buffers). And now this API is back", "author": "lpriima", "createdAt": "2020-11-24T17:36:19Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/serialization/Writable.java", "diffHunk": "@@ -21,6 +21,8 @@\n \n   void writeUTF8(UTF8BytesString string);\n \n+  void writeBinary(byte[] binary);", "originalCommit": "a63740b9c7fd0b9be8b47f35dddb0c2ccce275d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc1OTIwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529759203", "bodyText": "Is there a way to keep running existing tests on java7 as well?", "author": "lpriima", "createdAt": "2020-11-24T17:38:21Z", "path": "dd-trace-core/src/test/groovy/datadog/trace/common/metrics/AgentIntegrationTest.groovy", "diffHunk": "@@ -5,10 +5,11 @@ import datadog.trace.test.util.DDSpecification\n import spock.lang.Ignore\n import spock.lang.Requires\n \n+import static datadog.trace.api.Platform.isJavaVersionAtLeast\n import static java.util.concurrent.TimeUnit.SECONDS\n \n @Ignore(\"requires an upgrade to an as yet unreleased agent to run\")\n-@Requires({ \"true\" == System.getenv(\"CI\") })\n+@Requires({ \"true\" == System.getenv(\"CI\") && isJavaVersionAtLeast(8) })", "originalCommit": "a63740b9c7fd0b9be8b47f35dddb0c2ccce275d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc2MTgwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529761807", "bodyText": "No - the feature is completely disabled on JDK7", "author": "richardstartin", "createdAt": "2020-11-24T17:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc1OTIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4ODg0Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529788847", "bodyText": "do we want to bundle these in the dd-trace-ot jar or leave them as external dependencies?", "author": "mcculls", "createdAt": "2020-11-24T18:24:50Z", "path": "utils/histograms/histograms.gradle", "diffHunk": "@@ -0,0 +1,21 @@\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+apply from: \"$rootDir/gradle/java.gradle\"\n+\n+minimumBranchCoverage = 0.7\n+minimumInstructionCoverage = 0.7\n+\n+sourceCompatibility = JavaVersion.VERSION_1_8\n+targetCompatibility = JavaVersion.VERSION_1_8\n+\n+dependencies {\n+  compile deps.slf4j\n+  compile project(':internal-api')\n+\n+  // currently required to serialize DDSketch\n+  compile group: 'com.google.protobuf', name: 'protobuf-java', version: '3.14.0'\n+  compile group: 'com.datadoghq', name: 'sketches-java', version: '0.4.1'", "originalCommit": "a63740b9c7fd0b9be8b47f35dddb0c2ccce275d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMDU0Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2107#discussion_r529800546", "bodyText": "could you elaborate?", "author": "richardstartin", "createdAt": "2020-11-24T18:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4ODg0Nw=="}], "type": "inlineReview"}, {"oid": "65d8e3d2eb73972bfa88e793271422b6c50abd98", "url": "https://github.com/DataDog/dd-trace-java/commit/65d8e3d2eb73972bfa88e793271422b6c50abd98", "message": "add latency metrics", "committedDate": "2020-11-25T14:32:01Z", "type": "commit"}, {"oid": "1bf6545f1c9a7074c989b69f040d55ec92a3a923", "url": "https://github.com/DataDog/dd-trace-java/commit/1bf6545f1c9a7074c989b69f040d55ec92a3a923", "message": "increase jar size to allow temporary protobuf dependency", "committedDate": "2020-11-25T14:32:01Z", "type": "forcePushed"}, {"oid": "65d8e3d2eb73972bfa88e793271422b6c50abd98", "url": "https://github.com/DataDog/dd-trace-java/commit/65d8e3d2eb73972bfa88e793271422b6c50abd98", "message": "add latency metrics", "committedDate": "2020-11-25T14:32:01Z", "type": "forcePushed"}]}