{"pr_number": 1273, "pr_title": "Add an option to force profiling right in the beginning of premain", "pr_createdAt": "2020-02-28T22:11:22Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1273", "timeline": [{"oid": "0a4b5236ba8cfaf5ccaef3bbc9c5cb60c6bd85a0", "url": "https://github.com/DataDog/dd-trace-java/commit/0a4b5236ba8cfaf5ccaef3bbc9c5cb60c6bd85a0", "message": "Add an option to force profiling right in the beginning of premain\n\nCurrently this blows up JVMs before 14", "committedDate": "2020-02-28T23:08:10Z", "type": "forcePushed"}, {"oid": "2c33f0ace768a0d0a5eee61f7a104cc493879602", "url": "https://github.com/DataDog/dd-trace-java/commit/2c33f0ace768a0d0a5eee61f7a104cc493879602", "message": "Add an option to force profiling right in the beginning of premain\n\nCurrently this blows up JVMs before 14", "committedDate": "2020-02-28T23:36:50Z", "type": "commit"}, {"oid": "2c33f0ace768a0d0a5eee61f7a104cc493879602", "url": "https://github.com/DataDog/dd-trace-java/commit/2c33f0ace768a0d0a5eee61f7a104cc493879602", "message": "Add an option to force profiling right in the beginning of premain\n\nCurrently this blows up JVMs before 14", "committedDate": "2020-02-28T23:36:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUxODY5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1273#discussion_r386518699", "bodyText": "Please add some comments here why this is ok to initialize \"first\" then retry again later.", "author": "tylerbenson", "createdAt": "2020-03-02T16:55:08Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -46,6 +46,9 @@\n \n   public static void start(final Instrumentation inst, final URL bootstrapURL) {\n     createParentClassloader(bootstrapURL);\n+\n+    startProfilingAgent(bootstrapURL, true);", "originalCommit": "2c33f0ace768a0d0a5eee61f7a104cc493879602", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNTk5MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1273#discussion_r386535990", "bodyText": "Updated", "author": "mar-kolya", "createdAt": "2020-03-02T17:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUxODY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUyMDI4NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1273#discussion_r386520285", "bodyText": "early isn't very descriptive... maybe isBeforeTracing?", "author": "tylerbenson", "createdAt": "2020-03-02T16:57:33Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/Agent.java", "diffHunk": "@@ -275,29 +278,29 @@ private static synchronized void startJmxFetch(final URL bootstrapURL) {\n     }\n   }\n \n-  private static synchronized void startProfilingAgent(final URL bootstrapURL) {\n-    if (PROFILING_CLASSLOADER == null) {\n-      final ClassLoader contextLoader = Thread.currentThread().getContextClassLoader();\n-      try {\n-        final ClassLoader profilingClassLoader =\n+  private static synchronized void startProfilingAgent(\n+      final URL bootstrapURL, final boolean early) {", "originalCommit": "2c33f0ace768a0d0a5eee61f7a104cc493879602", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUyMDc3NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1273#discussion_r386520774", "bodyText": "perhaps startProfilingBeforeTracing?", "author": "tylerbenson", "createdAt": "2020-03-02T16:58:18Z", "path": "dd-java-agent/agent-profiling/profiling-controller/src/main/java/com/datadog/profiling/controller/ProfilingSystem.java", "diffHunk": "@@ -38,6 +38,7 @@\n \n   private final Duration startupDelay;\n   private final Duration uploadPeriod;\n+  private final boolean forceEarly;", "originalCommit": "2c33f0ace768a0d0a5eee61f7a104cc493879602", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6ff723e19171ebaa7522e2d5b6aadc1b3014953a", "url": "https://github.com/DataDog/dd-trace-java/commit/6ff723e19171ebaa7522e2d5b6aadc1b3014953a", "message": "CR changes", "committedDate": "2020-03-02T17:25:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYyMzA2MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1273#discussion_r386623061", "bodyText": "debug?", "author": "tylerbenson", "createdAt": "2020-03-02T20:10:30Z", "path": "dd-java-agent/agent-profiling/src/main/java/com/datadog/profiling/agent/ProfilingAgent.java", "diffHunk": "@@ -19,13 +19,14 @@\n \n   /**\n    * Main entry point into profiling Note: this must be reentrant because we may want to start\n-   * profiling early, and then attempt to start it again at normal time\n+   * profiling before any other tool, and then attempt to start it again at normal time\n    */\n-  public static synchronized void run(final boolean early) throws IllegalArgumentException {\n+  public static synchronized void run(final boolean isStartingFirst)\n+      throws IllegalArgumentException {\n     if (PROFILER == null) {\n       final Config config = Config.get();\n-      if (early && !config.isProfilingStartForceEarly()) {\n-        log.info(\"Profiling: not starting early\");\n+      if (isStartingFirst && !config.isProfilingStartForceFirst()) {\n+        log.info(\"Profiling: not starting first\");", "originalCommit": "6ff723e19171ebaa7522e2d5b6aadc1b3014953a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY0MjczMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1273#discussion_r386642732", "bodyText": "fixed", "author": "mar-kolya", "createdAt": "2020-03-02T20:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYyMzA2MQ=="}], "type": "inlineReview"}, {"oid": "d46a3be12368555cafcc023b1f2c662834896278", "url": "https://github.com/DataDog/dd-trace-java/commit/d46a3be12368555cafcc023b1f2c662834896278", "message": "Reduce log verbocity", "committedDate": "2020-03-02T20:26:04Z", "type": "commit"}]}