{"pr_number": 1867, "pr_title": "[PROF-2002] Change error logging strategy for Uploader", "pr_createdAt": "2020-09-15T16:30:47Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1867", "timeline": [{"oid": "ba0ecc7ad63005e21d906513e0f619c09516ddbc", "url": "https://github.com/DataDog/dd-trace-java/commit/ba0ecc7ad63005e21d906513e0f619c09516ddbc", "message": "Change error logging strategy for Uploader\n\nProfileUploader was logging error as warning with stacktraces.\nNow we log the stacktraces in debug mode and log only the exception\nmessage once every 5 minutes minimum in one line.", "committedDate": "2020-09-15T16:26:21Z", "type": "commit"}, {"oid": "ce15d5fa9b16b20c6ab99252b842ba7ad31e272c", "url": "https://github.com/DataDog/dd-trace-java/commit/ce15d5fa9b16b20c6ab99252b842ba7ad31e272c", "message": "increase code coverage", "committedDate": "2020-09-16T11:58:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ0NzQwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489447406", "bodyText": "This is somewhat unclear:\n\nWhat's the problem with having logback dependency in test dependencies?\nThe failure mode here is odd: if I understand this correctly it will not change the log level which will not fail test but will fail coverage reports. Whoever sees this in the future will be puzzled.", "author": "mar-kolya", "createdAt": "2020-09-16T13:42:36Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -493,6 +497,37 @@ public void testShutdown() throws IOException, InterruptedException {\n     verify(recording).release();\n   }\n \n+  @Test\n+  public void testLogLevelInfoFailedUpload() throws IOException, InterruptedException {\n+    changeLogLevel(\"INFO\");\n+    test500Response();\n+  }\n+\n+  private static void changeLogLevel(String logLevel) {\n+    Logger logger = LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME);\n+    try {\n+      // Use of reflection to avoid relying statically on the logback\n+      // implementation as dependency", "originalCommit": "ce15d5fa9b16b20c6ab99252b842ba7ad31e272c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzMzAyMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489533023", "bodyText": "Reference directly logback to change log level now", "author": "jpbempel", "createdAt": "2020-09-16T15:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ0NzQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ0NzYxMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489447613", "bodyText": "Should there be test for debug branch?", "author": "mar-kolya", "createdAt": "2020-09-16T13:42:55Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -493,6 +497,37 @@ public void testShutdown() throws IOException, InterruptedException {\n     verify(recording).release();\n   }\n \n+  @Test\n+  public void testLogLevelInfoFailedUpload() throws IOException, InterruptedException {\n+    changeLogLevel(\"INFO\");", "originalCommit": "ce15d5fa9b16b20c6ab99252b842ba7ad31e272c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzMjQ2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489532467", "bodyText": "by default, logging is DEBUG", "author": "jpbempel", "createdAt": "2020-09-16T15:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ0NzYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ0OTM5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489449399", "bodyText": "It would be nice to actually check expected behaviour, at least some of it. Maybe using custom appender would be helpful: https://stackoverflow.com/questions/29076981/how-to-intercept-slf4j-with-logback-logging-via-a-junit-test", "author": "mar-kolya", "createdAt": "2020-09-16T13:45:17Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -493,6 +497,37 @@ public void testShutdown() throws IOException, InterruptedException {\n     verify(recording).release();\n   }\n \n+  @Test\n+  public void testLogLevelInfoFailedUpload() throws IOException, InterruptedException {\n+    changeLogLevel(\"INFO\");\n+    test500Response();", "originalCommit": "ce15d5fa9b16b20c6ab99252b842ba7ad31e272c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzMjE5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489532199", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-09-16T15:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ0OTM5OQ=="}], "type": "inlineReview"}, {"oid": "8028cea732292351dca1eaff296f335b045cc9ad", "url": "https://github.com/DataDog/dd-trace-java/commit/8028cea732292351dca1eaff296f335b045cc9ad", "message": "assert logging", "committedDate": "2020-09-16T15:31:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzODMzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489538330", "bodyText": "Generally speaking this is not a good style - if this is not run then there will be no failure... so this test will not fail if appander is not applied or if things a logged with wrong level...\nInstead would you consider saving message in a variable and then assering later in the test? Also maybe mocks could be used for this.", "author": "mar-kolya", "createdAt": "2020-09-16T15:41:58Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -493,6 +499,58 @@ public void testShutdown() throws IOException, InterruptedException {\n     verify(recording).release();\n   }\n \n+  @Test\n+  public void testLogLevelInfoFailedUpload() throws IOException, InterruptedException {\n+    AssertingAppender appender =\n+        new AssertingAppender(\n+            loggingEvent -> {\n+              if (loggingEvent.getLevel() == Level.WARN) {\n+                assertEquals(", "originalCommit": "8028cea732292351dca1eaff296f335b045cc9ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4Njk4OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r490186989", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-09-17T11:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzODMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzOTMwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r489539307", "bodyText": "Maybe you would consider making setupLogger return current log level and using that instead of hardcoding debug here...", "author": "mar-kolya", "createdAt": "2020-09-16T15:43:22Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/test/java/com/datadog/profiling/uploader/ProfileUploaderTest.java", "diffHunk": "@@ -493,6 +499,58 @@ public void testShutdown() throws IOException, InterruptedException {\n     verify(recording).release();\n   }\n \n+  @Test\n+  public void testLogLevelInfoFailedUpload() throws IOException, InterruptedException {\n+    AssertingAppender appender =\n+        new AssertingAppender(\n+            loggingEvent -> {\n+              if (loggingEvent.getLevel() == Level.WARN) {\n+                assertEquals(\n+                    \"Failed to upload profile: unexpected response code Server Error 500\",\n+                    loggingEvent.getFormattedMessage());\n+              }\n+            });\n+    setupLogger(\"INFO\", appender);\n+    try {\n+      test500Response();\n+    } finally {\n+      cleanupLogger(\"DEBUG\", appender);\n+    }\n+  }\n+\n+  private static ch.qos.logback.classic.Logger getLogBackLogger() {\n+    Logger logger = LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME);\n+    return (ch.qos.logback.classic.Logger) logger;\n+  }\n+\n+  private static void setupLogger(String logLevel, AppenderBase<ILoggingEvent> appender) {\n+    ch.qos.logback.classic.Logger logBackLogger = getLogBackLogger();\n+    appender.start();\n+    logBackLogger.addAppender(appender);\n+    logBackLogger.setLevel(Level.toLevel(logLevel));\n+  }\n+\n+  private static void cleanupLogger(String logLevel, AppenderBase<ILoggingEvent> appender) {\n+    ch.qos.logback.classic.Logger logBackLogger = getLogBackLogger();\n+    appender.stop();\n+    logBackLogger.detachAppender(appender);\n+    logBackLogger.setLevel(Level.toLevel(logLevel));", "originalCommit": "8028cea732292351dca1eaff296f335b045cc9ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE4NjkwNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r490186905", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-09-17T11:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzOTMwNw=="}], "type": "inlineReview"}, {"oid": "a415793e385d0d53325c41879e6adfe63e45a047", "url": "https://github.com/DataDog/dd-trace-java/commit/a415793e385d0d53325c41879e6adfe63e45a047", "message": "fix loglevel and asserts", "committedDate": "2020-09-16T16:21:42Z", "type": "commit"}, {"oid": "fe9ba5b017ab902735b5702c9b6911506e180b00", "url": "https://github.com/DataDog/dd-trace-java/commit/fe9ba5b017ab902735b5702c9b6911506e180b00", "message": "fix test", "committedDate": "2020-09-17T07:36:04Z", "type": "commit"}, {"oid": "3bf39c1839da481d8e0828767ae2b7330143bb22", "url": "https://github.com/DataDog/dd-trace-java/commit/3bf39c1839da481d8e0828767ae2b7330143bb22", "message": "Pull out rate limited logger into a separate class", "committedDate": "2020-09-17T13:50:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2NDk2NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r490264965", "bodyText": "Please consider this: 3bf39c1\nit splits logger logic into separate class which makes upload simpler and allows for simpler testing", "author": "mar-kolya", "createdAt": "2020-09-17T13:54:33Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/profiling-uploader.gradle", "diffHunk": "@@ -5,7 +5,7 @@ ext {\n \n apply from: \"$rootDir/gradle/java.gradle\"\n \n-minimumBranchCoverage = 0.8\n+minimumBranchCoverage = 0.75", "originalCommit": "fe9ba5b017ab902735b5702c9b6911506e180b00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM0NTIxOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r490345219", "bodyText": "ok thanks", "author": "jpbempel", "createdAt": "2020-09-17T15:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI2NDk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2MDc1Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r490460757", "bodyText": "+1.  I suggest moving this and sharing it with tracing's DDAgentApi class which has similar logging behavior.", "author": "tylerbenson", "createdAt": "2020-09-17T18:12:55Z", "path": "dd-java-agent/agent-profiling/profiling-uploader/src/main/java/com/datadog/profiling/uploader/util/RatelimitedLogger.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.datadog.profiling.uploader.util;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Supplier;\n+import org.slf4j.Logger;\n+\n+/**\n+ * Logger that logs message once per given delay if debugging is disabled. If debugging is enabled\n+ * then it logs every time.\n+ */\n+// FIXME: move this to a place where it can be reused", "originalCommit": "3bf39c1839da481d8e0828767ae2b7330143bb22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxMDk2OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r491010968", "bodyText": "done", "author": "jpbempel", "createdAt": "2020-09-18T15:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2MDc1Nw=="}], "type": "inlineReview"}, {"oid": "e710b5d316214aa7e2cce4c0e055c012eba35a2c", "url": "https://github.com/DataDog/dd-trace-java/commit/e710b5d316214aa7e2cce4c0e055c012eba35a2c", "message": "Move RateLimitedLogger to internal-api\n\nReplace existing rate limited in DDAgentApi by this new class\nMigrate & Improve testing", "committedDate": "2020-09-18T14:57:20Z", "type": "commit"}, {"oid": "97f033b994fda1984c024b4ab32b48f9fa7503bf", "url": "https://github.com/DataDog/dd-trace-java/commit/97f033b994fda1984c024b4ab32b48f9fa7503bf", "message": "increase test coverage", "committedDate": "2020-09-18T16:48:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0OTIxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1867#discussion_r492649218", "bodyText": "I think this can be removed", "author": "mar-kolya", "createdAt": "2020-09-22T11:06:06Z", "path": "internal-api/src/main/java/datadog/trace/api/RatelimitedLogger.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package datadog.trace.api;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+import org.slf4j.Logger;\n+\n+/**\n+ * Logger that logs message once per given delay if debugging is disabled. If debugging is enabled\n+ * then it logs every time.\n+ */\n+// FIXME: move this to a place where it can be reused", "originalCommit": "97f033b994fda1984c024b4ab32b48f9fa7503bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "051fb6bb147991870f93e720e69139dfec84d18b", "url": "https://github.com/DataDog/dd-trace-java/commit/051fb6bb147991870f93e720e69139dfec84d18b", "message": "remove FIX ME", "committedDate": "2020-09-22T11:16:17Z", "type": "commit"}]}