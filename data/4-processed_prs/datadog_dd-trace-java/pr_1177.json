{"pr_number": 1177, "pr_title": "Add limit to trace scope depth", "pr_createdAt": "2020-01-15T19:53:50Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1177", "timeline": [{"oid": "bcf81823b3110c6a6e83baede7f570d7595ddacd", "url": "https://github.com/DataDog/dd-trace-java/commit/bcf81823b3110c6a6e83baede7f570d7595ddacd", "message": "Add limit to trace scope depth\n\nWhen limit is exceeded, a NoopScope is returned.\nAllow custom ScopeManager to be provided, with the plan to remove `ScopeContext` customization in the future.", "committedDate": "2020-01-15T19:51:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4Mzc3Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r367083777", "bodyText": "Why do we need to cast?\nI assuming because the Nop variant doesn't have addScopeListener.\nI think it would be cleaner to addScopeListener to the Nop variant.", "author": "dougqh", "createdAt": "2020-01-15T20:12:16Z", "path": "dd-trace-ot/src/main/java/datadog/opentracing/DDTracer.java", "diffHunk": "@@ -510,7 +516,9 @@ public boolean addTraceInterceptor(final TraceInterceptor interceptor) {\n \n   @Override\n   public void addScopeListener(final ScopeListener listener) {\n-    scopeManager.addScopeListener(listener);\n+    if (scopeManager instanceof ContextualScopeManager) {", "originalCommit": "bcf81823b3110c6a6e83baede7f570d7595ddacd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzMDkwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r367130909", "bodyText": "no, this is because ScopeListener is purely something we added, not part of OpenTracing.  If we accept any OpenTracing ScopeManager, we can't support this.", "author": "tylerbenson", "createdAt": "2020-01-15T22:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4Mzc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcxNDMxMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r369714311", "bodyText": "That makes sense.  Although, we could address that by having our own Nop with addScopeListener.\nBut for now, I think it is fine.  We can address it after we split from OpenTracing.", "author": "dougqh", "createdAt": "2020-01-22T17:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4Mzc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4NDczOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r367084739", "bodyText": "Should this be debug or error?", "author": "dougqh", "createdAt": "2020-01-15T20:14:25Z", "path": "dd-trace-ot/src/main/java/datadog/opentracing/scopemanager/ContextualScopeManager.java", "diffHunk": "@@ -5,18 +5,35 @@\n import io.opentracing.Scope;\n import io.opentracing.ScopeManager;\n import io.opentracing.Span;\n+import io.opentracing.noop.NoopScopeManager;\n import java.util.Deque;\n import java.util.List;\n import java.util.concurrent.ConcurrentLinkedDeque;\n import java.util.concurrent.CopyOnWriteArrayList;\n+import lombok.extern.slf4j.Slf4j;\n \n+@Slf4j\n public class ContextualScopeManager implements ScopeManager {\n   static final ThreadLocal<DDScope> tlsScope = new ThreadLocal<>();\n   final Deque<ScopeContext> scopeContexts = new ConcurrentLinkedDeque<>();\n   final List<ScopeListener> scopeListeners = new CopyOnWriteArrayList<>();\n \n+  private final int depthLimit;\n+\n+  public ContextualScopeManager(final int depthLimit) {\n+    this.depthLimit = depthLimit;\n+  }\n+\n   @Override\n   public Scope activate(final Span span, final boolean finishOnClose) {\n+    final Scope active = active();\n+    if (active instanceof DDScope) {\n+      final int currentDepth = ((DDScope) active).depth();\n+      if (depthLimit <= currentDepth) {\n+        log.debug(\"Scope depth limit exceeded ({}).  Returning NoopScope.\", currentDepth);", "originalCommit": "bcf81823b3110c6a6e83baede7f570d7595ddacd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4NDkzNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r367084936", "bodyText": "It would also be nice to have a health metric, but we haven't made getting to the statsd object easy yet.", "author": "dougqh", "createdAt": "2020-01-15T20:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4NDczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzMDMxNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r367130316", "bodyText": "Ideally it would be a rate limited warning, but this can be very high throughput, so I kept it at debug.", "author": "tylerbenson", "createdAt": "2020-01-15T22:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4NDczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0MjEzOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r367142139", "bodyText": "Yeah I agree a health metric would make sense.  Should that work be in this PR or a separate one?", "author": "tylerbenson", "createdAt": "2020-01-15T22:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4NDczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcxNDcwMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1177#discussion_r369714702", "bodyText": "It can wait for now.  I need to finish my PR where I make health metrics more accessible, but other things took priority.", "author": "dougqh", "createdAt": "2020-01-22T17:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4NDczOQ=="}], "type": "inlineReview"}]}