{"pr_number": 1342, "pr_title": "Add copy_artifact script", "pr_createdAt": "2020-03-26T09:59:46Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1342", "timeline": [{"oid": "b63d0c68261e23610275041b58aba22e03b0401e", "url": "https://github.com/DataDog/dd-trace-java/commit/b63d0c68261e23610275041b58aba22e03b0401e", "message": "Add copy_artifact script", "committedDate": "2020-03-26T09:58:48Z", "type": "commit"}, {"oid": "4a30faa8ffbacc916d2909af7c8b53ae5c25f32d", "url": "https://github.com/DataDog/dd-trace-java/commit/4a30faa8ffbacc916d2909af7c8b53ae5c25f32d", "message": "Add copy_artifact script to config", "committedDate": "2020-03-26T10:18:30Z", "type": "commit"}, {"oid": "4083212814b3bf2b85aeeae6dbb821fc5f39c643", "url": "https://github.com/DataDog/dd-trace-java/commit/4083212814b3bf2b85aeeae6dbb821fc5f39c643", "message": "Apply copy artifact to only master and *-reliability", "committedDate": "2020-03-26T12:44:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0NDA2NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1342#discussion_r398644065", "bodyText": "Just checking that we want to completely overwrite this file everytime", "author": "devinsba", "createdAt": "2020-03-26T15:03:57Z", "path": ".circleci/copy_artifact_s3.py", "diffHunk": "@@ -0,0 +1,23 @@\n+import boto3\n+import re\n+import os\n+import tempfile\n+\n+LIBS_PATH = './workspace/dd-java-agent/build/libs'\n+p = re.compile(r\"dd-java-agent.*jar$\")\n+\n+S3_BUCKET_NAME = 'datadog-reliability-env'\n+client = boto3.client('s3', aws_access_key_id=os.getenv('AWS_ACCESS_KEY_ID'),aws_secret_access_key=os.getenv('AWS_SECRET_ACCESS_KEY'))\n+transfer = boto3.s3.transfer.S3Transfer(client)\n+\n+for path, sub_dirs, files in os.walk(LIBS_PATH):\n+    for name in files:\n+      if p.match(name):\n+        # Write the artifact to S3\n+        transfer.upload_file(os.path.join(path, name), S3_BUCKET_NAME, f'java/{name}')\n+        # write additional information used by the build\n+        with tempfile.NamedTemporaryFile(mode='w') as fp:\n+          for line in [os.getenv('CIRCLE_BRANCH'), os.getenv('CIRCLE_SHA1'), name, os.getenv('CIRCLE_USERNAME')]:\n+            fp.write(f'{line}\\n')\n+          fp.seek(0)\n+          transfer.upload_file(fp.name, S3_BUCKET_NAME, 'java/index.txt')", "originalCommit": "4083212814b3bf2b85aeeae6dbb821fc5f39c643", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxMTMzNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1342#discussion_r398711336", "bodyText": "Yes I confirm, the purpose is to write the last version built with a set of information we want to propagate to the build", "author": "3as-DD", "createdAt": "2020-03-26T16:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0NDA2NQ=="}], "type": "inlineReview"}]}