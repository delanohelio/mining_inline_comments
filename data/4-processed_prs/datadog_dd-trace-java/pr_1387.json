{"pr_number": 1387, "pr_title": "Rework servlet 2 to not wrap HttpServletResponse objects", "pr_createdAt": "2020-04-20T17:50:31Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1387", "timeline": [{"oid": "9849dd7aea39839c289798c8ea376b9f221b4550", "url": "https://github.com/DataDog/dd-trace-java/commit/9849dd7aea39839c289798c8ea376b9f221b4550", "message": "Rework servlet 2 to not wrap HttpServletResponse objects", "committedDate": "2020-04-20T17:49:18Z", "type": "forcePushed"}, {"oid": "88b9efe64f03efa202affe24b9743eed2811d40d", "url": "https://github.com/DataDog/dd-trace-java/commit/88b9efe64f03efa202affe24b9743eed2811d40d", "message": "Rework servlet 2 to not wrap HttpServletResponse objects", "committedDate": "2020-04-20T18:29:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411632913", "bodyText": "Since you don't want to wrap it, can you instead instrument HttpServletResponse.setStatus (and other relevant methods) to capture the status in the contextStore directly instead of putting it into the request?", "author": "tylerbenson", "createdAt": "2020-04-20T19:26:42Z", "path": "dd-java-agent/instrumentation/servlet/request-2/src/main/java/datadog/trace/instrumentation/servlet2/Servlet2ResponseStatusInstrumentation.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package datadog.trace.instrumentation.servlet2;\n+\n+import static datadog.trace.agent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static datadog.trace.agent.tooling.bytebuddy.matcher.DDElementMatchers.safeHasSuperType;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import java.util.HashMap;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Servlet2ResponseStatusInstrumentation extends Instrumenter.Default {\n+  public Servlet2ResponseStatusInstrumentation() {\n+    super(\"servlet\", \"servlet-2\");\n+  }\n+\n+  // this is required to make sure servlet 2 instrumentation won't apply to servlet 3\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"javax.servlet.AsyncEvent\", \"javax.servlet.AsyncListener\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return safeHasSuperType(named(\"javax.servlet.http.HttpServletResponse\"));\n+  }\n+\n+  @Override\n+  public Map<String, String> contextStore() {\n+    return singletonMap(\n+        \"javax.servlet.http.HttpServletResponse\", \"javax.servlet.http.HttpServletRequest\");", "originalCommit": "5a6f455168c8beeb46dfa102514dbec87ad67e58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzNzk5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411637999", "bodyText": "What class do you think I should use as a ContextStore? Given that this is a map, I can't use HttpServletResponse for a second type from these instrumentations", "author": "devinsba", "createdAt": "2020-04-20T19:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2MTE2NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411661164", "bodyText": "Sorry I should expound on this more, because the Servlet2Advice class also has to interact with this context store, It would result in a duplicate key entry. I could create a wrapper object. I could probably find a way to trick things into supporting both", "author": "devinsba", "createdAt": "2020-04-20T20:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcxNTM4Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411715387", "bodyText": "I don't think there's a problem in using a single key with two different values in contextStore.  Under the hood, they should be stored in distinct fields based off the value type.  (In other words, you should be able to use <HttpServletResponse, Integer> based on my understanding.)", "author": "tylerbenson", "createdAt": "2020-04-20T21:48:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcxNjUyMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411716523", "bodyText": "Right, what I mean is, in Servlet2Instrumentation I can't add both, which is needed as Servlet2Advice uses both", "author": "devinsba", "createdAt": "2020-04-20T21:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcyMzM5MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411723391", "bodyText": "ah, I see.  What about using ServletResponse for one and HttpServletResponse for the other?", "author": "tylerbenson", "createdAt": "2020-04-20T22:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcyOTUwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411729509", "bodyText": "Yeah, I did that but it felt worse than a wrapper would be. I'll commit and we can discuss", "author": "devinsba", "createdAt": "2020-04-20T22:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzMjkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzNDY3OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411634679", "bodyText": "with the other change, this would likely need to be changed to just Integer and pass in the status code.", "author": "tylerbenson", "createdAt": "2020-04-20T19:29:38Z", "path": "dd-java-agent/instrumentation/servlet/request-2/src/main/java/datadog/trace/instrumentation/servlet2/Servlet2Decorator.java", "diffHunk": "@@ -50,11 +49,10 @@ protected Integer peerPort(final HttpServletRequest httpServletRequest) {\n   }\n \n   @Override\n-  protected Integer status(final ServletResponse httpServletResponse) {\n-    if (httpServletResponse instanceof StatusSavingHttpServletResponseWrapper) {\n-      return ((StatusSavingHttpServletResponseWrapper) httpServletResponse).status;\n+  protected Integer status(final HttpServletRequest httpServletRequest) {", "originalCommit": "5a6f455168c8beeb46dfa102514dbec87ad67e58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY5MzgzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411693830", "bodyText": "I'm assuming HttpServletResponse.SC_OK is typed as int, but this did look strange at first.\nLittle known Java detail starting in Java 7, you can cast from Object directly to int.  That might make this a bit more clear.\nif ( (int)request.getAttribute(\"dd.http-status\") == HttpServletResponse.SC_OK ) { ... }", "author": "dougqh", "createdAt": "2020-04-20T21:09:15Z", "path": "dd-java-agent/instrumentation/servlet/request-2/src/main/java/datadog/trace/instrumentation/servlet2/Servlet2Advice.java", "diffHunk": "@@ -89,11 +87,11 @@ public static void stopSpan(\n       return;\n     }\n     final AgentSpan span = scope.span();\n-    DECORATE.onResponse(span, response);\n+    if (request instanceof HttpServletRequest) {\n+      DECORATE.onResponse(span, (HttpServletRequest) request);\n+    }\n     if (throwable != null) {\n-      if (response instanceof StatusSavingHttpServletResponseWrapper\n-          && ((StatusSavingHttpServletResponseWrapper) response).status\n-              == HttpServletResponse.SC_OK) {\n+      if ((Integer) request.getAttribute(\"dd.http-status\") == HttpServletResponse.SC_OK) {", "originalCommit": "5a6f455168c8beeb46dfa102514dbec87ad67e58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczMDc1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1387#discussion_r411730756", "bodyText": "The cast is now gone, but thanks for the heads up!", "author": "devinsba", "createdAt": "2020-04-20T22:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY5MzgzMA=="}], "type": "inlineReview"}, {"oid": "94750a83c9b164d9b787c2358209e12f9392ae18", "url": "https://github.com/DataDog/dd-trace-java/commit/94750a83c9b164d9b787c2358209e12f9392ae18", "message": "Rework servlet 2 to not wrap HttpServletResponse objects", "committedDate": "2020-04-21T13:59:12Z", "type": "commit"}, {"oid": "dc43f3f54c5b0ed2f074d2052549f87047bd3b7a", "url": "https://github.com/DataDog/dd-trace-java/commit/dc43f3f54c5b0ed2f074d2052549f87047bd3b7a", "message": "We don't depend on a 2.3 type anymore", "committedDate": "2020-04-21T13:59:12Z", "type": "commit"}, {"oid": "aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "url": "https://github.com/DataDog/dd-trace-java/commit/aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "message": "Use the parent interface", "committedDate": "2020-04-21T13:59:12Z", "type": "commit"}, {"oid": "aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "url": "https://github.com/DataDog/dd-trace-java/commit/aec2fad9db6f78775f7e10ed17d96b87bcd7ce67", "message": "Use the parent interface", "committedDate": "2020-04-21T13:59:12Z", "type": "forcePushed"}]}