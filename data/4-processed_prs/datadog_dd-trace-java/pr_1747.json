{"pr_number": 1747, "pr_title": "Move some things around", "pr_createdAt": "2020-08-04T20:30:31Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1747", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxMjc4Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465312783", "bodyText": "@richardstartin I wrote this test before your latest set of changes.  I tried to update it but I may have missed something.", "author": "tylerbenson", "createdAt": "2020-08-04T20:31:33Z", "path": "dd-trace-core/src/test/groovy/datadog/trace/common/writer/TraceProcessingDisruptorTest.groovy", "diffHunk": "@@ -0,0 +1,300 @@\n+package datadog.trace.common.writer\n+\n+import datadog.trace.common.writer.ddagent.DDAgentApi\n+import datadog.trace.common.writer.ddagent.Payload\n+import datadog.trace.common.writer.ddagent.TraceMapper\n+import datadog.trace.common.writer.ddagent.TraceMapperV0_4\n+import datadog.trace.common.writer.ddagent.TraceProcessingDisruptor\n+import datadog.trace.core.DDSpan\n+import datadog.trace.core.monitor.Monitor\n+import datadog.trace.core.serialization.msgpack.ByteBufferConsumer\n+import datadog.trace.core.serialization.msgpack.Packer\n+import datadog.trace.util.test.DDSpecification\n+import spock.lang.Ignore\n+import spock.lang.Retry\n+\n+import java.nio.ByteBuffer\n+import java.util.concurrent.Phaser\n+import java.util.concurrent.atomic.AtomicInteger\n+\n+import static datadog.trace.common.writer.DDAgentWriter.DISRUPTOR_BUFFER_SIZE\n+import static datadog.trace.core.SpanFactory.newSpanOf\n+import static java.util.concurrent.TimeUnit.SECONDS\n+\n+@Retry\n+// TODO: these tests should be reworked with the latest \"Payload\" changes.", "originalCommit": "5237d4d3c47252947c99b84bb7de1747ce6426f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxMzIwNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465313207", "bodyText": "Since we're not returning a response here, I think 0.3 api is more appropriate.", "author": "tylerbenson", "createdAt": "2020-08-04T20:32:24Z", "path": "dd-smoke-tests/src/main/groovy/datadog/smoketest/AbstractSmokeTest.groovy", "diffHunk": "@@ -48,20 +48,11 @@ abstract class AbstractSmokeTest extends Specification {\n   @AutoCleanup\n   protected TestHttpServer server = httpServer {\n     handlers {\n-      prefix(\"/v0.4/traces\") {\n+      prefix(\"/v0.3/traces\") {", "originalCommit": "5237d4d3c47252947c99b84bb7de1747ce6426f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxMzg5MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465313891", "bodyText": "Allow mocking of TraceProcessingDisruptor.  With Dagger, this would be an @Inject annotated method.", "author": "tylerbenson", "createdAt": "2020-08-04T20:33:49Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/DDAgentWriter.java", "diffHunk": "@@ -81,6 +81,15 @@ private DDAgentWriter(\n             flushFrequencySeconds > 0);\n   }\n \n+  private DDAgentWriter(\n+      final DDAgentApi agentApi,\n+      final Monitor monitor,\n+      final TraceProcessingDisruptor traceProcessingDisruptor) {", "originalCommit": "5237d4d3c47252947c99b84bb7de1747ce6426f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNDIyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465314228", "bodyText": "I moved these since it's only relevant to the ddagent api.", "author": "tylerbenson", "createdAt": "2020-08-04T20:34:29Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/unixdomainsockets/TunnelingUnixSocket.java", "diffHunk": "@@ -1,4 +1,4 @@\n-package datadog.trace.common.writer.unixdomainsockets;\n+package datadog.trace.common.writer.ddagent.unixdomainsockets;", "originalCommit": "5237d4d3c47252947c99b84bb7de1747ce6426f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNTQ2Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465315463", "bodyText": "I wrote this test because the previous test was very large and was exercising behavior of the dependencies which seemed better handled in tests specific to those dependencies.", "author": "tylerbenson", "createdAt": "2020-08-04T20:37:02Z", "path": "dd-trace-core/src/test/groovy/datadog/trace/common/writer/DDAgentWriterTest.groovy", "diffHunk": "@@ -0,0 +1,127 @@\n+package datadog.trace.common.writer\n+\n+import datadog.trace.common.writer.ddagent.DDAgentApi\n+import datadog.trace.common.writer.ddagent.TraceProcessingDisruptor\n+import datadog.trace.core.monitor.Monitor\n+import datadog.trace.util.test.DDSpecification\n+import spock.lang.Subject\n+\n+import java.util.concurrent.TimeUnit\n+\n+import static datadog.trace.core.SpanFactory.newSpanOf\n+\n+class DDAgentWriterTest extends DDSpecification {", "originalCommit": "5237d4d3c47252947c99b84bb7de1747ce6426f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjg5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465316892", "bodyText": "I tried to incorporate many of the test cases from the old DDAgentWriterTest without being concerned with the behavior of the dependencies.", "author": "tylerbenson", "createdAt": "2020-08-04T20:39:55Z", "path": "dd-trace-core/src/test/groovy/datadog/trace/common/writer/TraceProcessingDisruptorTest.groovy", "diffHunk": "@@ -0,0 +1,300 @@\n+package datadog.trace.common.writer\n+\n+import datadog.trace.common.writer.ddagent.DDAgentApi\n+import datadog.trace.common.writer.ddagent.Payload\n+import datadog.trace.common.writer.ddagent.TraceMapper\n+import datadog.trace.common.writer.ddagent.TraceMapperV0_4\n+import datadog.trace.common.writer.ddagent.TraceProcessingDisruptor\n+import datadog.trace.core.DDSpan\n+import datadog.trace.core.monitor.Monitor\n+import datadog.trace.core.serialization.msgpack.ByteBufferConsumer\n+import datadog.trace.core.serialization.msgpack.Packer\n+import datadog.trace.util.test.DDSpecification\n+import spock.lang.Ignore\n+import spock.lang.Retry\n+\n+import java.nio.ByteBuffer\n+import java.util.concurrent.Phaser\n+import java.util.concurrent.atomic.AtomicInteger\n+\n+import static datadog.trace.common.writer.DDAgentWriter.DISRUPTOR_BUFFER_SIZE\n+import static datadog.trace.core.SpanFactory.newSpanOf\n+import static java.util.concurrent.TimeUnit.SECONDS\n+\n+@Retry\n+// TODO: these tests should be reworked with the latest \"Payload\" changes.\n+class TraceProcessingDisruptorTest extends DDSpecification {", "originalCommit": "5237d4d3c47252947c99b84bb7de1747ce6426f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNzQwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465317406", "bodyText": "Monitor previously had no direct unit tests.", "author": "tylerbenson", "createdAt": "2020-08-04T20:40:54Z", "path": "dd-trace-core/src/test/groovy/datadog/trace/core/monitor/MonitorTest.groovy", "diffHunk": "@@ -0,0 +1,159 @@\n+package datadog.trace.core.monitor\n+\n+import com.timgroup.statsd.StatsDClient\n+import datadog.trace.common.writer.DDAgentWriter\n+import datadog.trace.common.writer.ddagent.DDAgentApi\n+import datadog.trace.util.test.DDSpecification\n+import spock.lang.Ignore\n+import spock.lang.Subject\n+\n+import java.util.concurrent.ThreadLocalRandom\n+\n+class MonitorTest extends DDSpecification {", "originalCommit": "5237d4d3c47252947c99b84bb7de1747ce6426f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5cce2ed741b1d6d6a4c68ebdd6d467eaf93a6832", "url": "https://github.com/DataDog/dd-trace-java/commit/5cce2ed741b1d6d6a4c68ebdd6d467eaf93a6832", "message": "cleanup imports\n\nupdate ignores", "committedDate": "2020-08-04T21:27:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1MTI1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465351256", "bodyText": "I don't think tests like this are helpful. They inhibit change and it's not clear what's being asserted here except that the current implementation is the current implementation.", "author": "richardstartin", "createdAt": "2020-08-04T21:52:34Z", "path": "dd-trace-core/src/test/groovy/datadog/trace/common/writer/TraceProcessingDisruptorTest.groovy", "diffHunk": "@@ -0,0 +1,300 @@\n+package datadog.trace.common.writer\n+\n+import datadog.trace.common.writer.ddagent.DDAgentApi\n+import datadog.trace.common.writer.ddagent.Payload\n+import datadog.trace.common.writer.ddagent.TraceMapper\n+import datadog.trace.common.writer.ddagent.TraceMapperV0_4\n+import datadog.trace.common.writer.ddagent.TraceProcessingDisruptor\n+import datadog.trace.core.DDSpan\n+import datadog.trace.core.monitor.Monitor\n+import datadog.trace.core.serialization.msgpack.ByteBufferConsumer\n+import datadog.trace.core.serialization.msgpack.Packer\n+import datadog.trace.util.test.DDSpecification\n+import spock.lang.Ignore\n+import spock.lang.Retry\n+\n+import java.nio.ByteBuffer\n+import java.util.concurrent.Phaser\n+import java.util.concurrent.atomic.AtomicInteger\n+\n+import static datadog.trace.common.writer.DDAgentWriter.DISRUPTOR_BUFFER_SIZE\n+import static datadog.trace.core.SpanFactory.newSpanOf\n+import static java.util.concurrent.TimeUnit.SECONDS\n+\n+@Retry\n+// TODO: these tests should be reworked with the latest \"Payload\" changes.\n+class TraceProcessingDisruptorTest extends DDSpecification {\n+\n+  def phaser = new Phaser()\n+  def api = Mock(DDAgentApi) {\n+    sendSerializedTraces(_, _, _) >> DDAgentApi.Response.success(200)\n+  }\n+  def traceMapper = Mock(TraceMapper)\n+  def payload = Mock(Payload)\n+  def monitor = Mock(Monitor)\n+\n+  def setup() {\n+    // Register for two threads.\n+    phaser.register()\n+    phaser.register()\n+  }\n+\n+  def \"test happy path\"() {\n+    setup:\n+    def disruptor = new TraceProcessingDisruptor(\n+      2,\n+      monitor,\n+      api,\n+      -1,\n+      SECONDS,\n+      false)\n+    disruptor.start()\n+\n+    when:\n+    disruptor.flush(1, SECONDS)\n+\n+    then:\n+    0 * _\n+\n+    when:\n+    assert disruptor.publish(trace, 1)\n+    assert disruptor.publish(trace, 1)\n+    assert disruptor.flush(1, SECONDS)\n+\n+    then:", "originalCommit": "5cce2ed741b1d6d6a4c68ebdd6d467eaf93a6832", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NDk5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1747#discussion_r465744993", "bodyText": "To me this highlights that revapi isn't giving us any benefit at the moment. These classes aren't part of the API and should never have been used by consumers anyway", "author": "devinsba", "createdAt": "2020-08-05T13:56:19Z", "path": ".palantir/revapi.yml", "diffHunk": "@@ -532,6 +532,12 @@ acceptedBreaks:\n       justification: \"internal api\"\n   \"0.58.0\":\n     com.datadoghq:dd-trace-ot:\n+    - code: \"java.class.removed\"\n+      old: \"class datadog.trace.common.writer.ddagent.Monitor\"\n+      justification: \"moving classes around\"\n+    - code: \"java.class.removed\"\n+      old: \"class datadog.trace.common.writer.unixdomainsockets.UnixDomainSocketFactory\"\n+      justification: \"moving classes around\"", "originalCommit": "5cce2ed741b1d6d6a4c68ebdd6d467eaf93a6832", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7b0979406e1590746eaf17d758b6cceb43cda1e", "url": "https://github.com/DataDog/dd-trace-java/commit/b7b0979406e1590746eaf17d758b6cceb43cda1e", "message": "Move some things around\n\nAlso split up and added some tests.", "committedDate": "2020-08-05T17:54:26Z", "type": "commit"}, {"oid": "be40842a2f9b09df7c3fc9f2cb22cbecc0209174", "url": "https://github.com/DataDog/dd-trace-java/commit/be40842a2f9b09df7c3fc9f2cb22cbecc0209174", "message": "cleanup imports\n\nupdate ignores", "committedDate": "2020-08-05T17:54:26Z", "type": "commit"}, {"oid": "43d4a652ae7aea592164a40e4f14372d43e8f541", "url": "https://github.com/DataDog/dd-trace-java/commit/43d4a652ae7aea592164a40e4f14372d43e8f541", "message": "fix haystack test", "committedDate": "2020-08-05T18:03:00Z", "type": "commit"}, {"oid": "43d4a652ae7aea592164a40e4f14372d43e8f541", "url": "https://github.com/DataDog/dd-trace-java/commit/43d4a652ae7aea592164a40e4f14372d43e8f541", "message": "fix haystack test", "committedDate": "2020-08-05T18:03:00Z", "type": "forcePushed"}]}