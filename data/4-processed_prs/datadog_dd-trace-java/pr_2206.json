{"pr_number": 2206, "pr_title": "Remove `HttpServletResponse` InstrumentationContext", "pr_createdAt": "2020-12-15T16:05:59Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2206", "timeline": [{"oid": "057152277e1b6b2aed39c8f128ee87c2fa16126a", "url": "https://github.com/DataDog/dd-trace-java/commit/057152277e1b6b2aed39c8f128ee87c2fa16126a", "message": "Remove `HttpServletResponse` InstrumentationContext\n\nIt isn't really needed since the advice already has a call depth check.", "committedDate": "2020-12-15T16:05:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5ODkxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2206#discussion_r543498918", "bodyText": "@richardstartin removing this is what helped make things pass locally for me, but I also only ran the servlet tests.  It may still fail on other tests.", "author": "tylerbenson", "createdAt": "2020-12-15T16:34:20Z", "path": "dd-java-agent/instrumentation/servlet/request-3/src/test/groovy/TomcatServlet3Test.groovy", "diffHunk": "@@ -318,11 +318,6 @@ class TomcatServlet3TestInclude extends TomcatServlet3Test {\n     return false\n   }\n \n-  boolean hasResponseSpan(ServerEndpoint endpoint) {\n-    // No response spans for include because response spans are only for the dispatching servlet\n-    return false\n-  }", "originalCommit": "057152277e1b6b2aed39c8f128ee87c2fa16126a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUwNzQxNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2206#discussion_r543507417", "bodyText": "I'm not sure I understand how changing an implementation detail should change what the instrumentation does, but if this is a case of removing a workaround in the tests then maybe it's ok?", "author": "richardstartin", "createdAt": "2020-12-15T16:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5ODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU4MzY2NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2206#discussion_r543583664", "bodyText": "Yes, it is worrying to me that we don't seem to understand why this helped.", "author": "dougqh", "createdAt": "2020-12-15T18:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5ODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYwMDAwMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2206#discussion_r543600002", "bodyText": "I think it's understood why this helps - the context store check suppressed the response span. When it's removed, the response span is no longer suppressed, so the tests fail. What I'm confused about is whether this is acceptable - was the response span supposed to be suppressed and is this a breaking change? Or was not testing the response span a workaround, and is this improving the instrumentation? It's not possible to infer from the code base.", "author": "richardstartin", "createdAt": "2020-12-15T18:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5ODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NDMxMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2206#discussion_r543684310", "bodyText": "Thinking about it logically, I also think it makes sense that the response spans would be generated and connected to the trace, so I would say the test was previously working around an instrumentation problem rather than representing what should be the actual result.", "author": "tylerbenson", "createdAt": "2020-12-15T21:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5ODkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTAwNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2206#discussion_r543511005", "bodyText": "Shouldn't the context store definition also be removed?", "author": "richardstartin", "createdAt": "2020-12-15T16:49:07Z", "path": "dd-java-agent/instrumentation/servlet/src/main/java/datadog/trace/instrumentation/servlet/http/HttpServletResponseInstrumentation.java", "diffHunk": "@@ -73,14 +71,6 @@ public static AgentScope start(\n         // Don't want to generate a new top-level span\n         return null;\n       }\n-      ContextStore<HttpServletResponse, Boolean> contextStore =", "originalCommit": "057152277e1b6b2aed39c8f128ee87c2fa16126a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUyOTc1OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2206#discussion_r543529758", "bodyText": "good catch.", "author": "tylerbenson", "createdAt": "2020-12-15T17:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTAwNQ=="}], "type": "inlineReview"}, {"oid": "76013236b3029fb2142f483a23f131d289fce25d", "url": "https://github.com/DataDog/dd-trace-java/commit/76013236b3029fb2142f483a23f131d289fce25d", "message": "Remove relevant contextStores that are no longer used.", "committedDate": "2020-12-15T17:12:13Z", "type": "commit"}]}