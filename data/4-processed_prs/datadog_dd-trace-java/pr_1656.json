{"pr_number": 1656, "pr_title": "attempt to base64 decode invalid DDIds ", "pr_createdAt": "2020-07-06T11:07:34Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1656", "timeline": [{"oid": "6fb3f2962785124b8b4055d9361dfb80a4c550d9", "url": "https://github.com/DataDog/dd-trace-java/commit/6fb3f2962785124b8b4055d9361dfb80a4c550d9", "message": "attempt to base64 decode invalid DDIds to help users diagnose problems with their infrastructure and avoid breaking the trace lineage", "committedDate": "2020-07-06T11:56:19Z", "type": "commit"}, {"oid": "6fb3f2962785124b8b4055d9361dfb80a4c550d9", "url": "https://github.com/DataDog/dd-trace-java/commit/6fb3f2962785124b8b4055d9361dfb80a4c550d9", "message": "attempt to base64 decode invalid DDIds to help users diagnose problems with their infrastructure and avoid breaking the trace lineage", "committedDate": "2020-07-06T11:56:19Z", "type": "forcePushed"}, {"oid": "20f65b4e9cd3ee8ce9d2cb2a52f9c073d304dbc0", "url": "https://github.com/DataDog/dd-trace-java/commit/20f65b4e9cd3ee8ce9d2cb2a52f9c073d304dbc0", "message": "avoid guava causing problems", "committedDate": "2020-07-06T13:10:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3MDMwMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1656#discussion_r450270300", "bodyText": "I'm just wondering if considering this is a special case, we should add this catch block to the place that extracts the  headers into a context, perhaps by creating a second TextMapExtractAdapter to handle the failure case", "author": "devinsba", "createdAt": "2020-07-06T14:42:29Z", "path": "dd-trace-api/src/main/java/datadog/trace/api/DDId.java", "diffHunk": "@@ -54,7 +60,26 @@ public static DDId from(long id) {\n    * @throws NumberFormatException\n    */\n   public static DDId from(String s) throws NumberFormatException {\n-    return DDId.create(parseUnsignedLong(s), s);\n+    try {\n+      return DDId.create(parseUnsignedLong(s), s);\n+    } catch (NumberFormatException e) {\n+      // we have reports of Kakfa mirror maker base64 encoding record headers\n+      // attempting to base64 decode the ids here rather than in the Kafka instrumentation\n+      // helps users understand they have a problem without making other users pay for it\n+      if (null != s) {\n+        try {\n+          String decoded = new String(BASE64.decode(s), StandardCharsets.ISO_8859_1);\n+          log.debug(\n+              \"id {} was base 64 encoded to {}, it was decoded but this indicates there is a problem elsewhere in your system\",\n+              decoded,\n+              s);\n+          return DDId.create(parseUnsignedLong(decoded), decoded);\n+        } catch (Exception ignored) {\n+\n+        }\n+      }", "originalCommit": "20f65b4e9cd3ee8ce9d2cb2a52f9c073d304dbc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NDMxNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1656#discussion_r450274317", "bodyText": "I addressed that in the description of the PR.", "author": "richardstartin", "createdAt": "2020-07-06T14:48:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3MDMwMA=="}], "type": "inlineReview"}, {"oid": "914c76196fc451114de67af0d3d02cc2ec972081", "url": "https://github.com/DataDog/dd-trace-java/commit/914c76196fc451114de67af0d3d02cc2ec972081", "message": "avoid guava causing problems", "committedDate": "2020-07-06T17:47:14Z", "type": "commit"}, {"oid": "914c76196fc451114de67af0d3d02cc2ec972081", "url": "https://github.com/DataDog/dd-trace-java/commit/914c76196fc451114de67af0d3d02cc2ec972081", "message": "avoid guava causing problems", "committedDate": "2020-07-06T17:47:14Z", "type": "forcePushed"}]}