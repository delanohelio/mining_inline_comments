{"pr_number": 1779, "pr_title": "Replace SLF4J SimpleLogger with own compatible implementation", "pr_createdAt": "2020-08-17T14:38:19Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1779", "timeline": [{"oid": "c6fa7ebbd090cc522138603c41c756dfca6f9c44", "url": "https://github.com/DataDog/dd-trace-java/commit/c6fa7ebbd090cc522138603c41c756dfca6f9c44", "message": "Replace SLF4J SimpleLogger with own compatible implementation", "committedDate": "2020-08-17T14:33:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyNjExMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1779#discussion_r471526110", "bodyText": "Just to confirm this supports markers?", "author": "richardstartin", "createdAt": "2020-08-17T14:40:38Z", "path": "dd-java-agent/agent-logging/src/main/java/datadog/trace/logging/DDLogger.java", "diffHunk": "@@ -0,0 +1,362 @@\n+package datadog.trace.logging;", "originalCommit": "c6fa7ebbd090cc522138603c41c756dfca6f9c44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyODQzNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1779#discussion_r471528435", "bodyText": "Not yet, as per the comment.", "author": "bantonsson", "createdAt": "2020-08-17T14:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyNjExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5OTUxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1779#discussion_r471599518", "bodyText": "What's the worst case of making this threadlocal? Or perhaps trying to use java.time through method handles, falling back to the legacy API?", "author": "richardstartin", "createdAt": "2020-08-17T16:34:08Z", "path": "dd-java-agent/agent-logging/src/main/java/datadog/trace/logging/simplelogger/SLCompatHelper.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package datadog.trace.logging.simplelogger;\n+\n+import datadog.trace.logging.LogLevel;\n+import datadog.trace.logging.LoggerHelper;\n+import java.util.Date;\n+import org.slf4j.Marker;\n+\n+/**\n+ * A {@link LoggerHelper} that logs in a way compatible with the {@code SimpleLogger} from SLF4J.\n+ */\n+class SLCompatHelper extends LoggerHelper {\n+  private final String logName;\n+  private final LogLevel logLevel;\n+  private final SLCompatSettings settings;\n+\n+  SLCompatHelper(String name, SLCompatSettings settings) {\n+    this(settings.logNameForName(name), settings.logLevelForName(name), settings);\n+  }\n+\n+  SLCompatHelper(String logName, LogLevel logLevel, SLCompatSettings settings) {\n+    this.logName = logName;\n+    this.logLevel = logLevel;\n+    this.settings = settings;\n+  }\n+\n+  private void appendFormattedDate(StringBuilder builder, long timeMillis, long startTimeMillis) {\n+    if (settings.dateTimeFormatter != null) {\n+      Date date = new Date(timeMillis);\n+      String dateString;\n+      synchronized (settings.dateTimeFormatter) {", "originalCommit": "c6fa7ebbd090cc522138603c41c756dfca6f9c44", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMDM1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1779#discussion_r471600350", "bodyText": "try with resources?", "author": "richardstartin", "createdAt": "2020-08-17T16:35:32Z", "path": "dd-java-agent/agent-logging/src/main/java/datadog/trace/logging/simplelogger/SLCompatSettings.java", "diffHunk": "@@ -0,0 +1,243 @@\n+package datadog.trace.logging.simplelogger;\n+\n+import datadog.trace.logging.LogLevel;\n+import java.io.FileNotFoundException;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.PrintStream;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Properties;\n+\n+/** Settings that provide the same configurable options as {@code SimpleLogger} from SLF4J. */\n+public class SLCompatSettings {\n+\n+  public static final class Keys {\n+    // This is the package name that the shaded SimpleLogger had before. Use that for compatibility.\n+    private static final String PREFIX = \"datadog.slf4j.simpleLogger.\";\n+\n+    public static final String LOG_KEY_PREFIX = PREFIX + \"log.\";\n+    // This setting does not change anything in the behavior as of slf4j 1.7.30 so we ignore it\n+    // public static final String CACHE_OUTPUT_STREAM = PREFIX + \"cacheOutputStream\";\n+    public static final String WARN_LEVEL_STRING = PREFIX + \"warnLevelString\";\n+    public static final String LEVEL_IN_BRACKETS = PREFIX + \"levelInBrackets\";\n+    public static final String LOG_FILE = PREFIX + \"logFile\";\n+    public static final String SHOW_SHORT_LOG_NAME = PREFIX + \"showShortLogName\";\n+    public static final String SHOW_LOG_NAME = PREFIX + \"showLogName\";\n+    public static final String SHOW_THREAD_NAME = PREFIX + \"showThreadName\";\n+    public static final String DATE_TIME_FORMAT = PREFIX + \"dateTimeFormat\";\n+    public static final String SHOW_DATE_TIME = PREFIX + \"showDateTime\";\n+    public static final String DEFAULT_LOG_LEVEL = PREFIX + \"defaultLogLevel\";\n+\n+    // This is not available in SimpleLogger, but added here to simplify testing.\n+    static final String CONFIGURATION_FILE = PREFIX + \"configurationFile\";\n+  }\n+\n+  public static final class Defaults {\n+    // This setting does not change anything in the behavior as of slf4j 1.7.30 so we ignore it\n+    // static final boolean CACHE_OUTPUT_STREAM = false;\n+    public static final boolean LEVEL_IN_BRACKETS = false;\n+    public static final String LOG_FILE = \"System.err\";\n+    public static final boolean SHOW_SHORT_LOG_NAME = false;\n+    public static final boolean SHOW_LOG_NAME = true;\n+    public static final boolean SHOW_THREAD_NAME = true;\n+    public static final String DATE_TIME_FORMAT = null;\n+    public static final boolean SHOW_DATE_TIME = false;\n+    public static final String DEFAULT_LOG_LEVEL = \"INFO\";\n+\n+    public static final String CONFIGURATION_FILE = \"simplelogger.properties\";\n+  }\n+\n+  static PrintStream getPrintStream(String logFile) {\n+    switch (logFile.toLowerCase()) {\n+      case \"system.err\":\n+        return System.err;\n+      case \"system.out\":\n+        return System.out;\n+      default:\n+        try {\n+          FileOutputStream outputStream = new FileOutputStream(logFile);\n+          PrintStream printStream = new PrintStream(outputStream);\n+          return printStream;\n+        } catch (FileNotFoundException | SecurityException e) {\n+          // TODO maybe have support for delayed logging of early failures?\n+          return System.err;\n+        }\n+    }\n+  }\n+\n+  private static final class ResourceStreamPrivilegedAction\n+      implements PrivilegedAction<InputStream> {\n+    private final String fileName;\n+\n+    public ResourceStreamPrivilegedAction(String fileName) {\n+      this.fileName = fileName;\n+    }\n+\n+    @Override\n+    public InputStream run() {\n+      ClassLoader threadCL = Thread.currentThread().getContextClassLoader();\n+      if (threadCL != null) {\n+        return threadCL.getResourceAsStream(fileName);\n+      } else {\n+        return ClassLoader.getSystemResourceAsStream(fileName);\n+      }\n+    }\n+  }\n+\n+  static Properties loadProperties(final String fileName) {\n+    Properties fileProperties = null;\n+    // Load properties in the same way that SimpleLogger does\n+    InputStream inputStream =", "originalCommit": "c6fa7ebbd090cc522138603c41c756dfca6f9c44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk3ODgxNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1779#discussion_r471978814", "bodyText": "Absolutely", "author": "bantonsson", "createdAt": "2020-08-18T07:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMDM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMTQ1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1779#discussion_r471601450", "bodyText": "Is this ever closed? E.g. when the program shuts down? Does it need closing? It would be hard to know whose responsibility it is to close the stream if it could by System.err or System.out.", "author": "richardstartin", "createdAt": "2020-08-17T16:37:27Z", "path": "dd-java-agent/agent-logging/src/main/java/datadog/trace/logging/simplelogger/SLCompatSettings.java", "diffHunk": "@@ -0,0 +1,243 @@\n+package datadog.trace.logging.simplelogger;\n+\n+import datadog.trace.logging.LogLevel;\n+import java.io.FileNotFoundException;\n+import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.PrintStream;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Properties;\n+\n+/** Settings that provide the same configurable options as {@code SimpleLogger} from SLF4J. */\n+public class SLCompatSettings {\n+\n+  public static final class Keys {\n+    // This is the package name that the shaded SimpleLogger had before. Use that for compatibility.\n+    private static final String PREFIX = \"datadog.slf4j.simpleLogger.\";\n+\n+    public static final String LOG_KEY_PREFIX = PREFIX + \"log.\";\n+    // This setting does not change anything in the behavior as of slf4j 1.7.30 so we ignore it\n+    // public static final String CACHE_OUTPUT_STREAM = PREFIX + \"cacheOutputStream\";\n+    public static final String WARN_LEVEL_STRING = PREFIX + \"warnLevelString\";\n+    public static final String LEVEL_IN_BRACKETS = PREFIX + \"levelInBrackets\";\n+    public static final String LOG_FILE = PREFIX + \"logFile\";\n+    public static final String SHOW_SHORT_LOG_NAME = PREFIX + \"showShortLogName\";\n+    public static final String SHOW_LOG_NAME = PREFIX + \"showLogName\";\n+    public static final String SHOW_THREAD_NAME = PREFIX + \"showThreadName\";\n+    public static final String DATE_TIME_FORMAT = PREFIX + \"dateTimeFormat\";\n+    public static final String SHOW_DATE_TIME = PREFIX + \"showDateTime\";\n+    public static final String DEFAULT_LOG_LEVEL = PREFIX + \"defaultLogLevel\";\n+\n+    // This is not available in SimpleLogger, but added here to simplify testing.\n+    static final String CONFIGURATION_FILE = PREFIX + \"configurationFile\";\n+  }\n+\n+  public static final class Defaults {\n+    // This setting does not change anything in the behavior as of slf4j 1.7.30 so we ignore it\n+    // static final boolean CACHE_OUTPUT_STREAM = false;\n+    public static final boolean LEVEL_IN_BRACKETS = false;\n+    public static final String LOG_FILE = \"System.err\";\n+    public static final boolean SHOW_SHORT_LOG_NAME = false;\n+    public static final boolean SHOW_LOG_NAME = true;\n+    public static final boolean SHOW_THREAD_NAME = true;\n+    public static final String DATE_TIME_FORMAT = null;\n+    public static final boolean SHOW_DATE_TIME = false;\n+    public static final String DEFAULT_LOG_LEVEL = \"INFO\";\n+\n+    public static final String CONFIGURATION_FILE = \"simplelogger.properties\";\n+  }\n+\n+  static PrintStream getPrintStream(String logFile) {\n+    switch (logFile.toLowerCase()) {\n+      case \"system.err\":\n+        return System.err;\n+      case \"system.out\":\n+        return System.out;\n+      default:\n+        try {\n+          FileOutputStream outputStream = new FileOutputStream(logFile);\n+          PrintStream printStream = new PrintStream(outputStream);\n+          return printStream;", "originalCommit": "c6fa7ebbd090cc522138603c41c756dfca6f9c44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk2OTg0MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1779#discussion_r471969840", "bodyText": "I don't think there is a problem with not closing the stream, since there is usually only one of them, and it will be closed when the JVM exits. Worst case is that something isn't flushed properly.", "author": "bantonsson", "createdAt": "2020-08-18T07:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMTQ1MA=="}], "type": "inlineReview"}, {"oid": "14319a3810bd45c1d6956c76eef647c558594123", "url": "https://github.com/DataDog/dd-trace-java/commit/14319a3810bd45c1d6956c76eef647c558594123", "message": "Use java.time via MethodHandles when possible", "committedDate": "2020-08-18T12:05:57Z", "type": "commit"}]}