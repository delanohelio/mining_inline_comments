{"pr_number": 1990, "pr_title": "RejectedExecutionHandlerInstrumentation tests and fixes", "pr_createdAt": "2020-10-14T16:42:38Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1990", "timeline": [{"oid": "c635e25578adc871075085d00c98e86a4a9aa8bb", "url": "https://github.com/DataDog/dd-trace-java/commit/c635e25578adc871075085d00c98e86a4a9aa8bb", "message": "add cancel ForkJoinTask variant to test", "committedDate": "2020-10-14T16:35:59Z", "type": "commit"}, {"oid": "93dd207b772f3b302fcd8d7add94cb2505fbdbba", "url": "https://github.com/DataDog/dd-trace-java/commit/93dd207b772f3b302fcd8d7add94cb2505fbdbba", "message": "only field-inject state into RunnableFuture in leaf level constructor", "committedDate": "2020-10-14T19:36:05Z", "type": "forcePushed"}, {"oid": "e8b07b43e2e53a9457e9200e417fa7317dd941e4", "url": "https://github.com/DataDog/dd-trace-java/commit/e8b07b43e2e53a9457e9200e417fa7317dd941e4", "message": "only field-inject state into RunnableFuture in leaf level constructor", "committedDate": "2020-10-14T19:39:01Z", "type": "forcePushed"}, {"oid": "2ec43c7bd76c760d15ac397fcbb0b024b4be691d", "url": "https://github.com/DataDog/dd-trace-java/commit/2ec43c7bd76c760d15ac397fcbb0b024b4be691d", "message": "only field-inject state into RunnableFuture in leaf level constructor", "committedDate": "2020-10-14T19:41:09Z", "type": "forcePushed"}, {"oid": "0ec80b7f172b0f7b761275c3ad530783b0b48e2e", "url": "https://github.com/DataDog/dd-trace-java/commit/0ec80b7f172b0f7b761275c3ad530783b0b48e2e", "message": "make sure ThreadPoolExecutor rejection policies are matched, which fixes ThreadPoolExecutor related test flakiness", "committedDate": "2020-10-14T21:56:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3NzUwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505177506", "bodyText": "Not something to change in this PR, but a broader question. This is fine for an interface but would block a class from getting the fields injected by loading the class afaics. Should we try to use String consistently throughout the code?", "author": "bantonsson", "createdAt": "2020-10-15T05:44:14Z", "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/RejectedExecutionHandlerInstrumentation.java", "diffHunk": "@@ -28,25 +29,27 @@ public RejectedExecutionHandlerInstrumentation() {\n \n   @Override\n   public ElementMatcher<? super TypeDescription> typeMatcher() {\n-    return implementsInterface(named(\"java.util.concurrent.RejectedExecutionHandler\"));\n+    return NameMatchers.<TypeDescription>namedOneOf(\n+            \"java.util.concurrent.ThreadPoolExecutor$AbortPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$DiscardPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy\")\n+        .or(implementsInterface(named(RejectedExecutionHandler.class.getName())));\n   }\n \n   @Override\n   public Map<String, String> contextStore() {\n     Map<String, String> contextStore = new HashMap<>(4);\n-    contextStore.put(\"java.util.concurrent.RunnableFuture\", State.class.getName());\n+    contextStore.put(RunnableFuture.class.getName(), State.class.getName());", "originalCommit": "0ec80b7f172b0f7b761275c3ad530783b0b48e2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0MTk3OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505241978", "bodyText": "I changed this to be more consistent, but you raise a good point. If we standardise on this we don't get field injection.", "author": "richardstartin", "createdAt": "2020-10-15T07:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3NzUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3OTgwNg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505179806", "bodyText": "So they all implement RejectedExecutionHandler. Why do we need to name them separately?", "author": "bantonsson", "createdAt": "2020-10-15T05:51:36Z", "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/RejectedExecutionHandlerInstrumentation.java", "diffHunk": "@@ -28,25 +29,27 @@ public RejectedExecutionHandlerInstrumentation() {\n \n   @Override\n   public ElementMatcher<? super TypeDescription> typeMatcher() {\n-    return implementsInterface(named(\"java.util.concurrent.RejectedExecutionHandler\"));\n+    return NameMatchers.<TypeDescription>namedOneOf(\n+            \"java.util.concurrent.ThreadPoolExecutor$AbortPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$DiscardPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy\")\n+        .or(implementsInterface(named(RejectedExecutionHandler.class.getName())));", "originalCommit": "0ec80b7f172b0f7b761275c3ad530783b0b48e2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIzOTgyNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505239824", "bodyText": "I actually don't know why this was necessary but inner classes of types we transform seem not to be ignored.", "author": "richardstartin", "createdAt": "2020-10-15T07:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3OTgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0MzU0OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505243549", "bodyText": "I'm confused. You said \" inner classes of types we transform seem not to be ignored\", does that mean we want to ignore them or match them?", "author": "bantonsson", "createdAt": "2020-10-15T07:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3OTgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI1OTUyNw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505259527", "bodyText": "We want to include them. They weren't being included by the implementsInterface check, even though others were. If it's a hack it's benign or positive because it short circuits a type hierarchy walk.", "author": "richardstartin", "createdAt": "2020-10-15T07:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3OTgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMyNTk1Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505325956", "bodyText": "It's scary that they were missed. I wonder why that happened? I'll \ud83d\udc4d this workaround.", "author": "bantonsson", "createdAt": "2020-10-15T08:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3OTgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQwNDk5MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505404990", "bodyText": "Actually this wasn't necessary, there was a mistake in the type name in the argument matcher. I'll keep this so we short circuit the check for the only four implementations which will ever load in lots of applications.", "author": "richardstartin", "createdAt": "2020-10-15T09:42:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3OTgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQxOTcxOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505419719", "bodyText": "Ah, stringly typed programming...", "author": "bantonsson", "createdAt": "2020-10-15T10:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3OTgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MTAyOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505181029", "bodyText": "The first argument is still a Runnable.", "author": "bantonsson", "createdAt": "2020-10-15T05:55:05Z", "path": "dd-java-agent/instrumentation/java-concurrent/src/main/java/datadog/trace/instrumentation/java/concurrent/RejectedExecutionHandlerInstrumentation.java", "diffHunk": "@@ -28,25 +29,27 @@ public RejectedExecutionHandlerInstrumentation() {\n \n   @Override\n   public ElementMatcher<? super TypeDescription> typeMatcher() {\n-    return implementsInterface(named(\"java.util.concurrent.RejectedExecutionHandler\"));\n+    return NameMatchers.<TypeDescription>namedOneOf(\n+            \"java.util.concurrent.ThreadPoolExecutor$AbortPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$DiscardPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy\",\n+            \"java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy\")\n+        .or(implementsInterface(named(RejectedExecutionHandler.class.getName())));\n   }\n \n   @Override\n   public Map<String, String> contextStore() {\n     Map<String, String> contextStore = new HashMap<>(4);\n-    contextStore.put(\"java.util.concurrent.RunnableFuture\", State.class.getName());\n+    contextStore.put(RunnableFuture.class.getName(), State.class.getName());\n     // TODO get rid of this\n-    contextStore.put(\"java.util.concurrent.Runnable\", State.class.getName());\n+    contextStore.put(Runnable.class.getName(), State.class.getName());\n     return Collections.unmodifiableMap(contextStore);\n   }\n \n   @Override\n   public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n     return Collections.singletonMap(\n-        isMethod()\n-            .and(named(\"rejectedExecution\"))\n-            .and(takesArgument(0, named(\"java.util.concurrent.Runnable\"))),\n-        getClass().getName() + \"$Reject\");\n+        isMethod().and(named(\"rejectedExecution\")), getClass().getName() + \"$Reject\");", "originalCommit": "0ec80b7f172b0f7b761275c3ad530783b0b48e2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0MzU4Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505243582", "bodyText": "It just seemed like wasted cycles", "author": "richardstartin", "createdAt": "2020-10-15T07:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MTAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI1OTQ2Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505259467", "bodyText": "I'm just afraid of someone naming a method the wrong thing an us picking it up by mistake.", "author": "bantonsson", "createdAt": "2020-10-15T07:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MTAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM0MDAzMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1990#discussion_r505340033", "bodyText": "I'll change it back", "author": "richardstartin", "createdAt": "2020-10-15T08:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MTAyOQ=="}], "type": "inlineReview"}, {"oid": "7d147d588382dcc7a03573bd9d6a8e17a3d7b36e", "url": "https://github.com/DataDog/dd-trace-java/commit/7d147d588382dcc7a03573bd9d6a8e17a3d7b36e", "message": "make sure ThreadPoolExecutor rejection policies are matched, which fixes ThreadPoolExecutor related test flakiness", "committedDate": "2020-10-15T09:35:59Z", "type": "commit"}, {"oid": "fef1bf28c4afc0d406bc075ebf0c7c16433b1f6a", "url": "https://github.com/DataDog/dd-trace-java/commit/fef1bf28c4afc0d406bc075ebf0c7c16433b1f6a", "message": "disable cancellation tests for executors we can't reliably handle rejection from yet", "committedDate": "2020-10-15T09:35:59Z", "type": "commit"}, {"oid": "a76e545064a05c795d4bdcd751bd05fa507e40a1", "url": "https://github.com/DataDog/dd-trace-java/commit/a76e545064a05c795d4bdcd751bd05fa507e40a1", "message": "more detailed task rejection tests", "committedDate": "2020-10-15T09:35:59Z", "type": "forcePushed"}, {"oid": "5b23cc9d1f62e82de10a0797e2f915e1031702da", "url": "https://github.com/DataDog/dd-trace-java/commit/5b23cc9d1f62e82de10a0797e2f915e1031702da", "message": "more detailed task rejection tests", "committedDate": "2020-10-15T09:54:13Z", "type": "forcePushed"}, {"oid": "5aa3c6e16de4a191f595d36b5ffc662c43ce6c74", "url": "https://github.com/DataDog/dd-trace-java/commit/5aa3c6e16de4a191f595d36b5ffc662c43ce6c74", "message": "more detailed task rejection tests", "committedDate": "2020-10-15T09:57:25Z", "type": "forcePushed"}, {"oid": "88e644d65e6c7fa47d8551afb39fb1974bb4a1ab", "url": "https://github.com/DataDog/dd-trace-java/commit/88e644d65e6c7fa47d8551afb39fb1974bb4a1ab", "message": "more detailed task rejection tests", "committedDate": "2020-10-15T10:09:21Z", "type": "forcePushed"}, {"oid": "9fc5cd3f71ccacebe32c2b7e8ca230bd6af2f5aa", "url": "https://github.com/DataDog/dd-trace-java/commit/9fc5cd3f71ccacebe32c2b7e8ca230bd6af2f5aa", "message": "more detailed task rejection tests", "committedDate": "2020-10-15T10:11:42Z", "type": "commit"}, {"oid": "9fc5cd3f71ccacebe32c2b7e8ca230bd6af2f5aa", "url": "https://github.com/DataDog/dd-trace-java/commit/9fc5cd3f71ccacebe32c2b7e8ca230bd6af2f5aa", "message": "more detailed task rejection tests", "committedDate": "2020-10-15T10:11:42Z", "type": "forcePushed"}]}