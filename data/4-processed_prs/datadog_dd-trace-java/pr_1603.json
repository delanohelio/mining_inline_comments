{"pr_number": 1603, "pr_title": "Cache Strings in DBTypeTagInterceptor", "pr_createdAt": "2020-06-18T15:58:00Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1603", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNTAyMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#discussion_r442335023", "bodyText": "I think a data structure of this complexity needs a different testing strategy - PBT or similar.", "author": "richardstartin", "createdAt": "2020-06-18T15:59:56Z", "path": "dd-trace-core/src/test/groovy/datadog/trace/core/util/FixedSizeCacheTest.groovy", "diffHunk": "@@ -0,0 +1,79 @@\n+package datadog.trace.core.util\n+\n+import datadog.trace.util.test.DDSpecification\n+\n+import java.util.concurrent.atomic.AtomicInteger\n+\n+class FixedSizeCacheTest extends DDSpecification {", "originalCommit": "3fd20e4cffadcf300d010996b9d41b6cab5663de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4MTk5Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#discussion_r443481997", "bodyText": "I added a concurrent usage test below that has 5 threads inserting 100000 random elements each and assert that they get back the correct thing.", "author": "bantonsson", "createdAt": "2020-06-22T11:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNTAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODE5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1603#discussion_r442338199", "bodyText": "Agreed.", "author": "richardstartin", "createdAt": "2020-06-18T16:04:48Z", "path": "dd-trace-core/src/main/java/datadog/trace/core/util/FixedSizeCache.java", "diffHunk": "@@ -0,0 +1,115 @@\n+package datadog.trace.core.util;\n+\n+/**\n+ * This is a fixed size cache that only has one operation <code>computeIfAbsent</code>, that is used\n+ * to retrieve, or store and compute the cached value.\n+ *\n+ * <p>If there is a hash collision, the cache uses double hashing two more times to try to find a\n+ * match or an unused slot.\n+ *\n+ * <p>The cache is thread safe, and assumes that the <code>Creator</code> passed into <code>\n+ * computeIfAbsent</code> is idempotent or otherwise you might not get back the value you expect\n+ * from a cache lookup.\n+ *\n+ * @param <K> key type\n+ * @param <V> value type\n+ */\n+public class FixedSizeCache<K, V> {\n+\n+  public interface Creator<K, V> {\n+    V create(K key);\n+  }\n+\n+  static final int MAXIMUM_CAPACITY = 1 << 30;\n+\n+  private static final class Node<K, V> {\n+    private final K key;\n+    private final V value;\n+\n+    private Node(K key, V value) {\n+      this.key = key;\n+      this.value = value;\n+    }\n+  }\n+\n+  private final int mask;\n+  // This is a cache, so there is no need for volatile, atomics or synchronized.", "originalCommit": "3fd20e4cffadcf300d010996b9d41b6cab5663de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "72d1275bc003a0a5ca75447e66222c25f7dd8cdd", "url": "https://github.com/DataDog/dd-trace-java/commit/72d1275bc003a0a5ca75447e66222c25f7dd8cdd", "message": "Cache Strings in DBTypeTagInterceptor", "committedDate": "2020-06-22T10:45:41Z", "type": "forcePushed"}, {"oid": "150898683d8e4fe1b4249ffd85cdfb469fbb61ff", "url": "https://github.com/DataDog/dd-trace-java/commit/150898683d8e4fe1b4249ffd85cdfb469fbb61ff", "message": "Cache Strings in DBTypeTagInterceptor", "committedDate": "2020-06-22T11:00:17Z", "type": "forcePushed"}, {"oid": "96f4007acdd4042cde6043f81c8ba7eb257705b2", "url": "https://github.com/DataDog/dd-trace-java/commit/96f4007acdd4042cde6043f81c8ba7eb257705b2", "message": "Create a FixedSizeCache that uses double hashing on collisions", "committedDate": "2020-06-22T11:23:13Z", "type": "commit"}, {"oid": "d56c563db0218d10743644aba53f2326df5a9acb", "url": "https://github.com/DataDog/dd-trace-java/commit/d56c563db0218d10743644aba53f2326df5a9acb", "message": "Cache Strings in DBTypeTagInterceptor", "committedDate": "2020-06-22T11:23:23Z", "type": "commit"}, {"oid": "d56c563db0218d10743644aba53f2326df5a9acb", "url": "https://github.com/DataDog/dd-trace-java/commit/d56c563db0218d10743644aba53f2326df5a9acb", "message": "Cache Strings in DBTypeTagInterceptor", "committedDate": "2020-06-22T11:23:23Z", "type": "forcePushed"}]}