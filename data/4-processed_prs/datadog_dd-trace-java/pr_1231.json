{"pr_number": 1231, "pr_title": "Create AgentBuilder with logging listeners only if in debug mode", "pr_createdAt": "2020-02-19T21:42:58Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1231", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU3NTM5OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1231#discussion_r381575398", "bodyText": "This should be applied even if debug is not enabled, otherwise previously loaded classes won't be retransformed.", "author": "tylerbenson", "createdAt": "2020-02-19T22:11:12Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/AgentInstaller.java", "diffHunk": "@@ -139,6 +136,14 @@ public static ResettableClassFileTransformer installBytebuddyAgent(\n             .or(isAnnotatedWith(named(\"javax.decorator.Decorator\")))\n             .or(matchesConfiguredExcludes());\n \n+    if (log.isDebugEnabled()) {\n+      agentBuilder =\n+          agentBuilder\n+              .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)", "originalCommit": "aa546a444aa30b0dd619886ae744cb22c1412895", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1be2f2398b70834f22a5ae4599aee27097de8733", "url": "https://github.com/DataDog/dd-trace-java/commit/1be2f2398b70834f22a5ae4599aee27097de8733", "message": "create AgentBuilder instance with logging listeners only if debug mode is enabled", "committedDate": "2020-02-20T15:11:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEzMjAwMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1231#discussion_r382132000", "bodyText": "You should remove this line from here now that it is back in the other builder", "author": "devinsba", "createdAt": "2020-02-20T16:59:50Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/AgentInstaller.java", "diffHunk": "@@ -139,6 +137,14 @@ public static ResettableClassFileTransformer installBytebuddyAgent(\n             .or(isAnnotatedWith(named(\"javax.decorator.Decorator\")))\n             .or(matchesConfiguredExcludes());\n \n+    if (log.isDebugEnabled()) {\n+      agentBuilder =\n+          agentBuilder\n+              .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)", "originalCommit": "1be2f2398b70834f22a5ae4599aee27097de8733", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEzODY0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1231#discussion_r382138642", "bodyText": "That line is required to add the RedefinitionLoggingListener because .with(new RedefinitionLoggingListener()) can only be applied to an instance of type RedefinitionListenable.  .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION) returns an instance of that type. I'm a bit confused as to why this is necessary though because the agentBuilder should already be of type RedefinitionListenable.", "author": "heathkd", "createdAt": "2020-02-20T17:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEzMjAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE2ODk0Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1231#discussion_r382168947", "bodyText": "Got it, makes sense!\nI pulled the code up, its that the with method changes the return type depending on the input type, and RedefinitionListenable extends AgentBuilder which allows all the normal methods to work and adds on the ones you need.", "author": "devinsba", "createdAt": "2020-02-20T18:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEzMjAwMA=="}], "type": "inlineReview"}, {"oid": "b7b46caaa8dd2b09ada22b85728766161cae2900", "url": "https://github.com/DataDog/dd-trace-java/commit/b7b46caaa8dd2b09ada22b85728766161cae2900", "message": "create AgentBuilder instance with logging listeners only if debug mode is enabled", "committedDate": "2020-02-20T21:29:27Z", "type": "commit"}, {"oid": "b7b46caaa8dd2b09ada22b85728766161cae2900", "url": "https://github.com/DataDog/dd-trace-java/commit/b7b46caaa8dd2b09ada22b85728766161cae2900", "message": "create AgentBuilder instance with logging listeners only if debug mode is enabled", "committedDate": "2020-02-20T21:29:27Z", "type": "forcePushed"}]}