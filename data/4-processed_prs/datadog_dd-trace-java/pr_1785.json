{"pr_number": 1785, "pr_title": "Don't instrument well behaved spring class loaders", "pr_createdAt": "2020-08-19T12:51:44Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1785", "timeline": [{"oid": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "url": "https://github.com/DataDog/dd-trace-java/commit/d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "message": "Don't instrument well behaved spring class loaders", "committedDate": "2020-08-19T15:35:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NjMwMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473146303", "bodyText": "Nice.", "author": "richardstartin", "createdAt": "2020-08-19T16:11:41Z", "path": "dd-java-agent/instrumentation/classloading/src/main/java/datadog/trace/instrumentation/classloading/ClassloadingInstrumentation.java", "diffHunk": "@@ -45,7 +45,12 @@ public ClassloadingInstrumentation() {\n     return namedNoneOf(\n             \"java.lang.ClassLoader\",\n             \"com.ibm.oti.vm.BootstrapClassLoader\",\n-            \"datadog.trace.bootstrap.AgentClassLoader\")\n+            \"datadog.trace.bootstrap.AgentClassLoader\",", "originalCommit": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NjU3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473146570", "bodyText": "It's not new but this bugs me, I think we could implement a trie without much effort and probably do better here.", "author": "richardstartin", "createdAt": "2020-08-19T16:12:08Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -122,27 +122,20 @@ public boolean matches(final T target) {\n \n       if (name.startsWith(\"org.springframework.context.\")) {\n         // More runnables to deal with\n-        if (name.startsWith(\"org.springframework.context.support.AbstractApplicationContext$\")\n-            || name.equals(\"org.springframework.context.support.ContextTypeMatchClassLoader\")) {\n+        if (name.startsWith(\"org.springframework.context.support.AbstractApplicationContext$\")) {\n           return false;\n         }\n         return true;\n       }\n \n       if (name.startsWith(\"org.springframework.core.\")) {\n-        if (name.startsWith(\"org.springframework.core.task.\")\n-            || name.equals(\"org.springframework.core.DecoratingClassLoader\")\n-            || name.equals(\"org.springframework.core.OverridingClassLoader\")) {\n+        if (name.startsWith(\"org.springframework.core.task.\")) {", "originalCommit": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2Mzg0NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473663844", "bodyText": "Yes I completely agree.", "author": "bantonsson", "createdAt": "2020-08-20T06:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0NjU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473154558", "bodyText": "datadog.trace.bootstrap.AgentClassLoader no longer exists. I wonder how long this has been like this for?", "author": "richardstartin", "createdAt": "2020-08-19T16:22:24Z", "path": "dd-java-agent/instrumentation/classloading/src/main/java/datadog/trace/instrumentation/classloading/ClassloadingInstrumentation.java", "diffHunk": "@@ -45,7 +45,12 @@ public ClassloadingInstrumentation() {\n     return namedNoneOf(\n             \"java.lang.ClassLoader\",\n             \"com.ibm.oti.vm.BootstrapClassLoader\",\n-            \"datadog.trace.bootstrap.AgentClassLoader\")\n+            \"datadog.trace.bootstrap.AgentClassLoader\",", "originalCommit": "d2bfb3a6820bbeea790b6bb13a585e87b6c4788a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2OTM1NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473169354", "bodyText": "I think it should be updated to this: datadog.trace.bootstrap.DatadogClassLoader", "author": "tylerbenson", "createdAt": "2020-08-19T16:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5OTY4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473199686", "bodyText": "Also datadog.trace.bootstrap.DatadogClassLoader$DelegateClassLoader", "author": "richardstartin", "createdAt": "2020-08-19T17:20:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2NDA4OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473664089", "bodyText": "Wonderful", "author": "bantonsson", "createdAt": "2020-08-20T06:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc0NDg0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473744841", "bodyText": "Can we change this before merging?", "author": "richardstartin", "createdAt": "2020-08-20T08:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgzODQwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473838404", "bodyText": "Absolutely", "author": "bantonsson", "createdAt": "2020-08-20T10:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyMTA1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473921050", "bodyText": "Turns out that they are already taken care of by datadog.trace.agent.tooling.ClassLoaderMatcher.SkipClassLoaderMatcher.canSkipClassLoaderByName.", "author": "bantonsson", "createdAt": "2020-08-20T12:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzMjI0Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473932247", "bodyText": "Do we need to rationalise this logic? We seem to match classloaders in so many places.", "author": "richardstartin", "createdAt": "2020-08-20T12:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk2MjA5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r473962099", "bodyText": "I only count to 3 right now \ud83d\ude09", "author": "bantonsson", "createdAt": "2020-08-20T13:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE1NDU1OA=="}], "type": "inlineReview"}, {"oid": "fdb54828d60a5a4cc7dc3add17f29c343b857317", "url": "https://github.com/DataDog/dd-trace-java/commit/fdb54828d60a5a4cc7dc3add17f29c343b857317", "message": "Don't instrument well behaved spring class loaders", "committedDate": "2020-08-20T13:31:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNjYzMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474006631", "bodyText": "Isn't it generally more efficient to ignore the class before it's loaded by byte buddy?", "author": "tylerbenson", "createdAt": "2020-08-20T14:01:22Z", "path": "dd-java-agent/instrumentation/classloading/src/main/java/datadog/trace/instrumentation/classloading/ClassloadingInstrumentation.java", "diffHunk": "@@ -45,7 +45,11 @@ public ClassloadingInstrumentation() {\n     return namedNoneOf(\n             \"java.lang.ClassLoader\",\n             \"com.ibm.oti.vm.BootstrapClassLoader\",\n-            \"datadog.trace.bootstrap.AgentClassLoader\")\n+            \"org.springframework.context.support.ContextTypeMatchClassLoader\",\n+            \"org.springframework.core.OverridingClassLoader\",\n+            \"org.springframework.core.DecoratingClassLoader\",\n+            \"org.springframework.instrument.classloading.SimpleThrowawayClassLoader\",\n+            \"org.springframework.instrument.classloading.ShadowingClassLoader\")", "originalCommit": "fdb54828d60a5a4cc7dc3add17f29c343b857317", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAxMTE2OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474011169", "bodyText": "I bet it is. So should these be added to the global ignores matcher instead?", "author": "bantonsson", "createdAt": "2020-08-20T14:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNjYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyMjUzMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474022533", "bodyText": "Probably, unless we want to apply other instrumentation to them.  I was just surprised that you moved them as that seems like it would be less efficient.", "author": "tylerbenson", "createdAt": "2020-08-20T14:23:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNjYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMzEzOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474033138", "bodyText": "So the whole weird dance that happens is that they were not in the GlobalIgnoresMatcher, but explicitly enabled for instrumentation in the weird AdditionalLibraryIgnoresMatcher, which I changed. So far so good. The thing is that the AdditionalLibraryIgnoresMatcher is disabled during tests, so they end up being instrumented in tests, and the tests fail, since we check the instrumented classes against the AdditionalLibraryIgnoresMatcher, so even though they won't be instrumented during normal execution, we need to disable them from being instrumented somewhere else for the tests to pass.", "author": "bantonsson", "createdAt": "2020-08-20T14:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNjYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzNzMwNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474037305", "bodyText": "ah, ok.  so maybe put them in both places is best?", "author": "tylerbenson", "createdAt": "2020-08-20T14:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNjYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA0OTIxMQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474049211", "bodyText": "I've moved the Spring classloader checks to the GlobalIgnoresMatcher", "author": "bantonsson", "createdAt": "2020-08-20T14:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwNjYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwNDU1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474104550", "bodyText": "Can we not do this just because we'll want to take the entire strings and build a trie from them at some point, and the painstaking deconstruction will make that migration harder.\n(I actually tried it before and didn't observe a positive effect)", "author": "richardstartin", "createdAt": "2020-08-20T16:14:09Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/GlobalIgnoresMatcher.java", "diffHunk": "@@ -143,19 +147,39 @@ public boolean matches(final T target) {\n         break;\n       case 'o' - 'a':\n         if (name.startsWith(\"org.\")) {\n-          if (name.startsWith(\"org.aspectj.\") || name.startsWith(\"org.jinspired.\")) {\n+          int oOffset = \"org.\".length();\n+          if (name.startsWith(\"aspectj.\", oOffset) || name.startsWith(\"jinspired.\", oOffset)) {\n             return true;\n           }\n           // groovy\n-          if (name.startsWith(\"org.groovy.\") || name.startsWith(\"org.apache.groovy.\")) {\n+          if (name.startsWith(\"groovy.\", oOffset) || name.startsWith(\"apache.groovy.\", oOffset)) {", "originalCommit": "6c6b7b51a1356b8d7be2ef68ccf753d873e84865", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExOTA5MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474119091", "bodyText": "To be clear, this made no effect on negative matches (I was trying to improve a clojure application which wouldn't ever have got inside this block).", "author": "richardstartin", "createdAt": "2020-08-20T16:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwNDU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0MjM5OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1785#discussion_r474442399", "bodyText": "Interesting that it didn't make an effect. I agree with the trie comment. I'll change this back.", "author": "bantonsson", "createdAt": "2020-08-21T06:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwNDU1MA=="}], "type": "inlineReview"}, {"oid": "84b006f131c7f5bb7e55d2f61aeead68a5e08c36", "url": "https://github.com/DataDog/dd-trace-java/commit/84b006f131c7f5bb7e55d2f61aeead68a5e08c36", "message": "Don't instrument well behaved spring class loaders", "committedDate": "2020-08-24T08:19:33Z", "type": "commit"}, {"oid": "d46d7accccfce362efba67e6c361a2435bdd5725", "url": "https://github.com/DataDog/dd-trace-java/commit/d46d7accccfce362efba67e6c361a2435bdd5725", "message": "Move spring classloader checks to GlobalIgnoresMatcher", "committedDate": "2020-08-24T08:19:33Z", "type": "commit"}, {"oid": "d46d7accccfce362efba67e6c361a2435bdd5725", "url": "https://github.com/DataDog/dd-trace-java/commit/d46d7accccfce362efba67e6c361a2435bdd5725", "message": "Move spring classloader checks to GlobalIgnoresMatcher", "committedDate": "2020-08-24T08:19:33Z", "type": "forcePushed"}]}