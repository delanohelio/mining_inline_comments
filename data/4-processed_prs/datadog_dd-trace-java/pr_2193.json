{"pr_number": 2193, "pr_title": "Update server span's resource name after Zuul forward", "pr_createdAt": "2020-12-11T15:10:42Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2193", "timeline": [{"oid": "8f0e548508cbd550b7d2208f5b071205868a0b33", "url": "https://github.com/DataDog/dd-trace-java/commit/8f0e548508cbd550b7d2208f5b071205868a0b33", "message": "Update server span's resource name after Zuul forward\n\nOtherwise the resource name is very generic (`GET /**`).", "committedDate": "2020-12-11T16:11:03Z", "type": "commit"}, {"oid": "8f0e548508cbd550b7d2208f5b071205868a0b33", "url": "https://github.com/DataDog/dd-trace-java/commit/8f0e548508cbd550b7d2208f5b071205868a0b33", "message": "Update server span's resource name after Zuul forward\n\nOtherwise the resource name is very generic (`GET /**`).", "committedDate": "2020-12-11T16:11:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4ODY2OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541088668", "bodyText": "Adding check against status 0?  Why?", "author": "dougqh", "createdAt": "2020-12-11T16:56:20Z", "path": "dd-java-agent/instrumentation/servlet/src/main/java/datadog/trace/instrumentation/servlet/dispatcher/RequestDispatcherDecorator.java", "diffHunk": "@@ -70,19 +70,19 @@ public AgentSpan onResponse(\n     if (response instanceof HttpServletResponse && STATUS_CODE_METHOD != null) {\n       try {\n         int status = (int) STATUS_CODE_METHOD.invokeExact((HttpServletResponse) response);\n-\n-        if (throwable != null && status == HttpServletResponse.SC_OK) {\n-          span.setTag(Tags.HTTP_STATUS, SERVER_ERROR);\n-          span.setError(true);\n-        } else {\n-          span.setTag(Tags.HTTP_STATUS, HTTP_STATUSES.get(status));\n-          if (SERVER_ERROR_STATUSES.get(status)) {\n+        if (status > 0) {", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MTQ2NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541091465", "bodyText": "I believe 0 is used to represent null by a lot of servlet implementations. Not sure if this is specified though.", "author": "richardstartin", "createdAt": "2020-12-11T17:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MTU5Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541091592", "bodyText": "The servlet.forward span generated in the zuul test was reporting an http status of 0.  Elsewhere we do a similar check before adding the tag, so I figured it would be better to make this consistent than apply an odd tag to the test.  (Also what Richard said... didn't see his reply before submitting my own.)", "author": "tylerbenson", "createdAt": "2020-12-11T17:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMTU2Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541121563", "bodyText": "Okay, that makes sense.  It just wasn't clear why that needed to be added.\nIf we're repeating this same logic elsewhere we might want to think about ways to avoid it.", "author": "dougqh", "createdAt": "2020-12-11T17:49:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2MzIxNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r542463214", "bodyText": "add a comment to explain why zero :)", "author": "clutchski", "createdAt": "2020-12-14T15:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4ODY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3MTIyMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r542471223", "bodyText": "I'll replace with a static final instead.", "author": "tylerbenson", "createdAt": "2020-12-14T15:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4ODY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDk0OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541090949", "bodyText": "Why are these ignores necessary?\nI think this needs more commenting.", "author": "dougqh", "createdAt": "2020-12-11T16:59:37Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -103,14 +103,21 @@ public boolean matches(final T target) {\n         if (name.startsWith(\"org.springframework.boot.autoconfigure.BackgroundPreinitializer$\")\n             || name.startsWith(\"org.springframework.boot.autoconfigure.condition.OnClassCondition$\")\n             || name.startsWith(\"org.springframework.boot.web.embedded.netty.NettyWebServer$\")\n+            || name.startsWith(\"org.springframework.boot.web.embedded.tomcat.TomcatWebServer$1\")", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwNDU0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541104545", "bodyText": "Is this sufficient? #2193 (comment)", "author": "tylerbenson", "createdAt": "2020-12-11T17:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzMjg2NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541332864", "bodyText": "Yes, although, now I'm wondering why we failed to catch the Spring Boot 2 problem sooner.", "author": "dougqh", "createdAt": "2020-12-11T21:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQxNzA2Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541417066", "bodyText": "I'm also now wondering if we've covered all the various servers that you can embed in Spring Boot.", "author": "dougqh", "createdAt": "2020-12-11T23:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3MjE3Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r542472173", "bodyText": "Probably not.  Likely worth spending some time extending/improving our Spring Boot test matrix.", "author": "tylerbenson", "createdAt": "2020-12-14T15:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjExNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541092115", "bodyText": "We take request as a parameter and then ignore it?\nSame question for parentSpan?\nThis whole method doesn't appear to really be doing anything.  Am I missing something?", "author": "dougqh", "createdAt": "2020-12-11T17:01:30Z", "path": "dd-java-agent/instrumentation/spring-cloud-zuul-2/src/main/java/datadog/trace/instrumentation/springcloudzuul2/ZuulSendForwardFilterInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package datadog.trace.instrumentation.springcloudzuul2;\n+\n+import static datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator.DD_SPAN_ATTRIBUTE;\n+import static datadog.trace.instrumentation.springcloudzuul2.ResourceNameCache.RESOURCE_NAME_CACHE;\n+import static datadog.trace.instrumentation.springcloudzuul2.ResourceNameCache.RESOURCE_NAME_JOINER;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesNoArguments;\n+\n+import com.google.auto.service.AutoService;\n+import com.netflix.zuul.context.RequestContext;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Pair;\n+import java.util.Map;\n+import javax.servlet.http.HttpServletRequest;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public class ZuulSendForwardFilterInstrumentation extends Instrumenter.Default {\n+  public ZuulSendForwardFilterInstrumentation() {\n+    super(\"spring-cloud-zuul\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"org.springframework.cloud.netflix.zuul.filters.route.SendForwardFilter\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      packageName + \".ResourceNameCache\", packageName + \".ResourceNameCache$1\",\n+    };\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+\n+    return singletonMap(\n+        isMethod().and(named(\"run\")).and(takesNoArguments()),\n+        ZuulSendForwardFilterInstrumentation.class.getName() + \"$FilterInjectingAdvice\");\n+  }\n+\n+  /**\n+   * Using the zuul proxy results in the Spring \"HandlerMapping.bestMatchingPattern\" value being\n+   * very generic. In the case where zuul forwards the request to a more specific Spring controller,\n+   * a better pattern will be updated on the request after the call returns, so we want to update\n+   * the resource name with that.\n+   */\n+  public static class FilterInjectingAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static void onEnter(\n+        @Advice.Local(\"request\") HttpServletRequest request,\n+        @Advice.Local(\"parentSpan\") AgentSpan parentSpan) {\n+      RequestContext ctx = RequestContext.getCurrentContext();\n+      request = ctx.getRequest();", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwODkwMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541108900", "bodyText": "The request and parent span are captured here, but used in onExit. They are passed between via @Advice.Local parameters.", "author": "tylerbenson", "createdAt": "2020-12-11T17:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMyOTg0OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541329849", "bodyText": "So ByteBuddy requires taking a dummy parameter, so it can be shared with the MethodExit Advice?\nI guess there's no better way to express that, but ugh.  I suppose that's my lack of first hand experiencing writing instrumentation.", "author": "dougqh", "createdAt": "2020-12-11T21:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ2NDExOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r543464119", "bodyText": "yes, it's how byte-buddy represents sharing between the static advice (which will get applied to the same method) - note when you're only sharing one thing you can return it from the onEnter and consume it using @Advice.Enter in the onExit, which is a bit better.", "author": "mcculls", "createdAt": "2020-12-15T15:51:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ2OTYxOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r543469618", "bodyText": "Yes, I guess I'd only seen the sharing a single value case.\nI think I would have chosen to handle locals differently,  but if that's what bytebuddy requires so be it.", "author": "dougqh", "createdAt": "2020-12-15T15:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjU1Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541092553", "bodyText": "These were added because the tests now exercises Spring Boot 2.x, which has different package names.", "author": "tylerbenson", "createdAt": "2020-12-11T17:02:10Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/bytebuddy/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -103,14 +103,21 @@ public boolean matches(final T target) {\n         if (name.startsWith(\"org.springframework.boot.autoconfigure.BackgroundPreinitializer$\")\n             || name.startsWith(\"org.springframework.boot.autoconfigure.condition.OnClassCondition$\")\n             || name.startsWith(\"org.springframework.boot.web.embedded.netty.NettyWebServer$\")\n+            || name.startsWith(\"org.springframework.boot.web.embedded.tomcat.TomcatWebServer$1\")\n             || name.startsWith(\n                 \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer$\")\n             || name.equals(\n                 \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")\n+            || name.equals(\n+                \"org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")\n             || name.equals(\n                 \"org.springframework.boot.context.embedded.EmbeddedWebApplicationContext\")\n             || name.equals(\n-                \"org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext\")) {\n+                \"org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext\")\n+            || name.equals(\n+                \"org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext\")\n+            || name.equals(\n+                \"org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext\")) {", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE2NTc4Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541165786", "bodyText": "I see, so we also also had a previously undetected problem with support Spring Boot 2?", "author": "dougqh", "createdAt": "2020-12-11T19:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1MTk3OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541451978", "bodyText": "yes, though possibly benign.  This is part of the reason I was hoping to get some time to improve the spring tests.", "author": "tylerbenson", "createdAt": "2020-12-12T00:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MjU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NzAzMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541097033", "bodyText": "I think that's fine.", "author": "dougqh", "createdAt": "2020-12-11T17:09:34Z", "path": "dd-java-agent/instrumentation/spring-cloud-zuul-2/src/main/java/datadog/trace/instrumentation/springcloudzuul2/ZuulSendForwardFilterInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package datadog.trace.instrumentation.springcloudzuul2;\n+\n+import static datadog.trace.bootstrap.instrumentation.decorator.HttpServerDecorator.DD_SPAN_ATTRIBUTE;\n+import static datadog.trace.instrumentation.springcloudzuul2.ResourceNameCache.RESOURCE_NAME_CACHE;\n+import static datadog.trace.instrumentation.springcloudzuul2.ResourceNameCache.RESOURCE_NAME_JOINER;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesNoArguments;\n+\n+import com.google.auto.service.AutoService;\n+import com.netflix.zuul.context.RequestContext;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import datadog.trace.bootstrap.instrumentation.api.AgentSpan;\n+import datadog.trace.bootstrap.instrumentation.api.Pair;\n+import java.util.Map;\n+import javax.servlet.http.HttpServletRequest;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public class ZuulSendForwardFilterInstrumentation extends Instrumenter.Default {\n+  public ZuulSendForwardFilterInstrumentation() {\n+    super(\"spring-cloud-zuul\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return named(\"org.springframework.cloud.netflix.zuul.filters.route.SendForwardFilter\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      packageName + \".ResourceNameCache\", packageName + \".ResourceNameCache$1\",\n+    };\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+\n+    return singletonMap(\n+        isMethod().and(named(\"run\")).and(takesNoArguments()),\n+        ZuulSendForwardFilterInstrumentation.class.getName() + \"$FilterInjectingAdvice\");\n+  }\n+\n+  /**\n+   * Using the zuul proxy results in the Spring \"HandlerMapping.bestMatchingPattern\" value being\n+   * very generic. In the case where zuul forwards the request to a more specific Spring controller,\n+   * a better pattern will be updated on the request after the call returns, so we want to update\n+   * the resource name with that.\n+   */\n+  public static class FilterInjectingAdvice {\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static void onEnter(\n+        @Advice.Local(\"request\") HttpServletRequest request,\n+        @Advice.Local(\"parentSpan\") AgentSpan parentSpan) {\n+      RequestContext ctx = RequestContext.getCurrentContext();\n+      request = ctx.getRequest();\n+      if (request != null) {\n+        // Capture the span from the request before forwarding.\n+        Object span = request.getAttribute(DD_SPAN_ATTRIBUTE);\n+        if (span instanceof AgentSpan) {\n+          parentSpan = (AgentSpan) span;\n+        }\n+      }\n+    }\n+\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static void onExit(\n+        @Advice.Local(\"request\") HttpServletRequest request,\n+        @Advice.Local(\"parentSpan\") AgentSpan parentSpan) {\n+      if (request != null && parentSpan != null) {\n+        final String method = request.getMethod();\n+        // Get the updated route pattern.\n+        // Opted for static string here to avoid an additional spring dependency.\n+        final Object bestMatchingPattern =", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwMDUzMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541100530", "bodyText": "I presume we already generate similar resource names elsewhere.\nWhy does this require its own cache?\nUnable to share across instrumentation boundaries?\nOr because there's a performance benefit to separate caches?\nI'm not saying this either good or bad, but I want to understand our motivation.", "author": "dougqh", "createdAt": "2020-12-11T17:15:12Z", "path": "dd-java-agent/instrumentation/spring-cloud-zuul-2/src/main/java/datadog/trace/instrumentation/springcloudzuul2/ResourceNameCache.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package datadog.trace.instrumentation.springcloudzuul2;\n+\n+import datadog.trace.api.Function;\n+import datadog.trace.api.cache.DDCache;\n+import datadog.trace.api.cache.DDCaches;\n+import datadog.trace.bootstrap.instrumentation.api.Pair;\n+import datadog.trace.bootstrap.instrumentation.api.UTF8BytesString;\n+\n+public class ResourceNameCache {\n+  public static final Function<Pair<String, Object>, CharSequence> RESOURCE_NAME_JOINER =\n+      new Function<Pair<String, Object>, CharSequence>() {\n+        @Override\n+        public CharSequence apply(Pair<String, Object> input) {\n+          return UTF8BytesString.create(input.getLeft() + \" \" + input.getRight());\n+        }\n+      };\n+\n+  public static final DDCache<Pair<String, Object>, CharSequence> RESOURCE_NAME_CACHE =", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwNjI2OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541106269", "bodyText": "I expect there would be some benefit to consolidating these but sharing across instrumentation boundaries is difficult.", "author": "richardstartin", "createdAt": "2020-12-11T17:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwMDUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMjA5Mw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541112093", "bodyText": "I could potentially reference the one in SpringWebHttpServerDecorator, but didn't think there was much benefit in that.  If you want I can restructure it to do so.\nThis cache is relatively tied to the instrumentation and structure of the resource name, so it wouldn't make sense to extract out generically.", "author": "tylerbenson", "createdAt": "2020-12-11T17:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwMDUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE2NTA0Mg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541165042", "bodyText": "Yes, I could easily believe that a larger number of smaller focused caches is better than a bigger shared cache.\nhttp resources seem like one of the potentially shareable cases -- that's why I asked.\nI'm fine with this for now.", "author": "dougqh", "createdAt": "2020-12-11T19:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwMDUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMjA5Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541122097", "bodyText": "I think this implicitly setting tags is problematic, but I realize that's pre-existing.\nWe'll have to address that in some of the other server work.", "author": "dougqh", "createdAt": "2020-12-11T17:50:40Z", "path": "dd-java-agent/instrumentation/servlet/src/main/java/datadog/trace/instrumentation/servlet/dispatcher/RequestDispatcherDecorator.java", "diffHunk": "@@ -70,19 +70,19 @@ public AgentSpan onResponse(\n     if (response instanceof HttpServletResponse && STATUS_CODE_METHOD != null) {\n       try {\n         int status = (int) STATUS_CODE_METHOD.invokeExact((HttpServletResponse) response);\n-\n-        if (throwable != null && status == HttpServletResponse.SC_OK) {\n-          span.setTag(Tags.HTTP_STATUS, SERVER_ERROR);\n-          span.setError(true);\n-        } else {\n-          span.setTag(Tags.HTTP_STATUS, HTTP_STATUSES.get(status));\n-          if (SERVER_ERROR_STATUSES.get(status)) {\n+        if (status > 0) {\n+          if (throwable != null && status == HttpServletResponse.SC_OK) {\n+            span.setTag(Tags.HTTP_STATUS, SERVER_ERROR);", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzMTA4OQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541331089", "bodyText": "We need extra instrumentation just in the test?  Why?", "author": "dougqh", "createdAt": "2020-12-11T21:50:45Z", "path": "dd-java-agent/instrumentation/spring-cloud-zuul-2/src/test/groovy/ServletTestInstrumentation.java", "diffHunk": "@@ -0,0 +1,20 @@\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import datadog.trace.agent.test.base.HttpServerTestAdvice;\n+import datadog.trace.agent.tooling.Instrumenter;\n+import net.bytebuddy.agent.builder.AgentBuilder;\n+\n+@AutoService(Instrumenter.class)\n+public class ServletTestInstrumentation implements Instrumenter {", "originalCommit": "8f0e548508cbd550b7d2208f5b071205868a0b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1Mjg5NA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r541452894", "bodyText": "This is an artifact of extending our HttpServerTest which expects an extra span before the start of the actual span to verify it correctly ignores the parent.", "author": "tylerbenson", "createdAt": "2020-12-12T00:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzMTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1ODA3Nw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r543458077", "bodyText": "Is there a plan to rework the HTTP/servlet tests to not require this? Ideally we should only test the instrumentations we're actually shipping :)", "author": "mcculls", "createdAt": "2020-12-15T15:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzMTA4OQ=="}], "type": "inlineReview"}, {"oid": "c4e2305e43e513a73faaecb706bb7d3365f98817", "url": "https://github.com/DataDog/dd-trace-java/commit/c4e2305e43e513a73faaecb706bb7d3365f98817", "message": "Add a static final representing an unset status.", "committedDate": "2020-12-14T15:33:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3ODYwNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r542478605", "bodyText": "@richardstartin any concerns with adding 0 into the default cache? How should I update the comment?  Should I apply a similar change for PORTS below?", "author": "tylerbenson", "createdAt": "2020-12-14T15:34:09Z", "path": "internal-api/src/main/java/datadog/trace/api/cache/RadixTreeCache.java", "diffHunk": "@@ -14,11 +14,13 @@ public Integer apply(int value) {\n         }\n       };\n \n+  public static final int UNSET_STATUS = 0;\n   // should cover range [0, 512) to cover all standard HTTP statuses\n   // 16 pages of 32 should keep the tree sparse with typical pages\n   // covering ranges [192, 224), [288, 320), [384, 416), [480, 512)\n   public static final RadixTreeCache<Integer> HTTP_STATUSES =\n-      new RadixTreeCache<>(16, 32, AUTOBOX, 200, 201, 301, 307, 400, 401, 403, 404, 500, 502, 503);\n+      new RadixTreeCache<>(\n+          16, 32, AUTOBOX, UNSET_STATUS, 200, 201, 301, 307, 400, 401, 403, 404, 500, 502, 503);", "originalCommit": "c4e2305e43e513a73faaecb706bb7d3365f98817", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ4MTU0NQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2193#discussion_r542481545", "bodyText": "Actually, I just realized the unset value is never added to the cache, so I'll remove it.", "author": "tylerbenson", "createdAt": "2020-12-14T15:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3ODYwNQ=="}], "type": "inlineReview"}, {"oid": "ebfc4a75be47b8d90f231772bc874cfeddc9000b", "url": "https://github.com/DataDog/dd-trace-java/commit/ebfc4a75be47b8d90f231772bc874cfeddc9000b", "message": "Add a static final representing an unset status/port.", "committedDate": "2020-12-14T15:40:27Z", "type": "commit"}, {"oid": "ebfc4a75be47b8d90f231772bc874cfeddc9000b", "url": "https://github.com/DataDog/dd-trace-java/commit/ebfc4a75be47b8d90f231772bc874cfeddc9000b", "message": "Add a static final representing an unset status/port.", "committedDate": "2020-12-14T15:40:27Z", "type": "forcePushed"}, {"oid": "2c927a5a248d9433438d2afcde2856c4ca81e067", "url": "https://github.com/DataDog/dd-trace-java/commit/2c927a5a248d9433438d2afcde2856c4ca81e067", "message": "Merge branch 'master' into tyler/zuul", "committedDate": "2020-12-14T17:34:55Z", "type": "commit"}, {"oid": "2c927a5a248d9433438d2afcde2856c4ca81e067", "url": "https://github.com/DataDog/dd-trace-java/commit/2c927a5a248d9433438d2afcde2856c4ca81e067", "message": "Merge branch 'master' into tyler/zuul", "committedDate": "2020-12-14T17:34:55Z", "type": "forcePushed"}]}