{"pr_number": 1740, "pr_title": "Reduce string concat in hibernate instrumentation", "pr_createdAt": "2020-08-03T20:27:22Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1740", "timeline": [{"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5", "url": "https://github.com/DataDog/dd-trace-java/commit/ffc8d87c2413fcbd971b78692bc2134205bad1c5", "message": "Reduce string concat in hibernate instrumentation", "committedDate": "2020-08-03T21:11:45Z", "type": "commit"}, {"oid": "ffc8d87c2413fcbd971b78692bc2134205bad1c5", "url": "https://github.com/DataDog/dd-trace-java/commit/ffc8d87c2413fcbd971b78692bc2134205bad1c5", "message": "Reduce string concat in hibernate instrumentation", "committedDate": "2020-08-03T21:11:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjUzOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464886538", "bodyText": "Any particular reason to pass along this, even though it's not used?", "author": "bantonsson", "createdAt": "2020-08-04T08:28:20Z", "path": "dd-java-agent/instrumentation/hibernate/src/main/java/datadog/trace/instrumentation/hibernate/SessionMethodUtils.java", "diffHunk": "@@ -24,6 +25,7 @@\n   public static <TARGET, ENTITY> SessionState startScopeFrom(\n       final ContextStore<TARGET, SessionState> contextStore,\n       final TARGET spanKey,\n+      final Method origin,", "originalCommit": "ffc8d87c2413fcbd971b78692bc2134205bad1c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MjM3MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465062370", "bodyText": "This is related to another PR I'm working on... which inspired this change.", "author": "tylerbenson", "createdAt": "2020-08-04T13:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjkxMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464886912", "bodyText": "This seems unrelated to the change.", "author": "bantonsson", "createdAt": "2020-08-04T08:28:56Z", "path": "dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/instrumentation/api/Pair.java", "diffHunk": "@@ -1,5 +1,8 @@\n package datadog.trace.bootstrap.instrumentation.api;\n \n+import lombok.EqualsAndHashCode;\n+\n+@EqualsAndHashCode", "originalCommit": "ffc8d87c2413fcbd971b78692bc2134205bad1c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MzUwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465063509", "bodyText": "yeah, unrelated now.  I originally was caching with a pair as the key, but then I figured out the call site caching option and decided to do that instead.  I left this in here because it seemed like an oversight that might be missed later.  Would you prefer I pull it out?", "author": "tylerbenson", "createdAt": "2020-08-04T13:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA4MDgzMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465080833", "bodyText": "Not sure it's an oversight, do we have any Pairs as keys in maps where this would be relevant? Not opposed to adding it though.", "author": "richardstartin", "createdAt": "2020-08-04T14:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NjkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464887320", "bodyText": "Ah, nice. I assume that this is cached at the call site.", "author": "bantonsson", "createdAt": "2020-08-04T08:29:36Z", "path": "dd-java-agent/instrumentation/hibernate/core-3.3/src/main/java/datadog/trace/instrumentation/hibernate/core/v3_3/CriteriaInstrumentation.java", "diffHunk": "@@ -44,13 +45,15 @@\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SessionState startMethod(\n-        @Advice.This final Criteria criteria, @Advice.Origin(\"#m\") final String name) {\n+        @Advice.This final Criteria criteria,\n+        @Advice.Origin(\"hibernate.criteria.#m\") final String operationName,", "originalCommit": "ffc8d87c2413fcbd971b78692bc2134205bad1c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg5MjM0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r464892341", "bodyText": "Is 16 a good guess for the size of the hash map? That would imply an expected cardinality of operationName of about 8. It might be reasonable, but I'd want to know why.", "author": "richardstartin", "createdAt": "2020-08-04T08:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2NTQyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465065428", "bodyText": "I'm assuming that this avoids repeat concatenation by creating a constant in the byte code.  I didn't actually verify that though.", "author": "tylerbenson", "createdAt": "2020-08-04T13:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3OTk1MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465079950", "bodyText": "But the question was why the guess of the size of 16? What's the rationale for choosing 16?", "author": "richardstartin", "createdAt": "2020-08-04T14:11:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA5MTcxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1740#discussion_r465091715", "bodyText": "Ok, I ran it in a debugger and verified that the object instance is reused, where on master it creates a new one each time.", "author": "tylerbenson", "createdAt": "2020-08-04T14:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg4NzMyMA=="}], "type": "inlineReview"}]}