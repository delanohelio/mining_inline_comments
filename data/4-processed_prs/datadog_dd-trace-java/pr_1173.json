{"pr_number": 1173, "pr_title": "Synchronized audit: WeakMap computeIfAbsent", "pr_createdAt": "2020-01-14T21:28:32Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1173", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk2OTYzMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#discussion_r366969632", "bodyText": "What is the benefit in having this class (and others in this PR) implement the ValueSupplier interface when they didn't previously?  Not really understanding the motivation for this change.", "author": "tylerbenson", "createdAt": "2020-01-15T16:18:09Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/DDCachingPoolStrategy.java", "diffHunk": "@@ -28,7 +29,13 @@\n  *\n  * <p>See eviction policy below.\n  */\n-public class DDCachingPoolStrategy implements PoolStrategy {\n+public class DDCachingPoolStrategy\n+    implements PoolStrategy, WeakMap.ValueSupplier<ClassLoader, TypePool.CacheProvider> {", "originalCommit": "9bbe9de320b68dbba663644d4a2744fdf70785f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNDM1OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#discussion_r367004358", "bodyText": "Simplicity:\nThe interface for users of WeakMap is much simpler.  See the difference in ReferenceMatcher: the 3 levels of nesting go away.  If/when we switch to Java 8, the interface can be replace by a method reference or lambda.\nConsistency:\nDDCachingPoolStrategy was doing something slightly different: it synchronized on the classloader instead of on the cache.  This is something we know may cause issues (#1126).  The point of the synchronized audit was to catch things like this.  By removing the external synchronization need, this bug class is eliminated.\nCentralizing for easier changes:\nIf we later decide to use a different implementation (read/write locks, Unsafe, etc), there's only one place to change.", "author": "randomanderson", "createdAt": "2020-01-15T17:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk2OTYzMg=="}], "type": "inlineReview"}, {"oid": "a0b1cd4a75c8c6448a75a582f1dec48354ff7510", "url": "https://github.com/DataDog/dd-trace-java/commit/a0b1cd4a75c8c6448a75a582f1dec48354ff7510", "message": "WeakMap computeIfAbsent", "committedDate": "2020-01-15T17:26:15Z", "type": "commit"}, {"oid": "68ed1da9c61f7c457bd42182b86c7ca92a161be4", "url": "https://github.com/DataDog/dd-trace-java/commit/68ed1da9c61f7c457bd42182b86c7ca92a161be4", "message": "Don't call `map.get()` in the `put(..)` case", "committedDate": "2020-01-15T17:41:01Z", "type": "commit"}, {"oid": "68ed1da9c61f7c457bd42182b86c7ca92a161be4", "url": "https://github.com/DataDog/dd-trace-java/commit/68ed1da9c61f7c457bd42182b86c7ca92a161be4", "message": "Don't call `map.get()` in the `put(..)` case", "committedDate": "2020-01-15T17:41:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA2ODA4OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1173#discussion_r367068088", "bodyText": "These are what we had to use before muzzle...  I assume they're no longer used anywhere?", "author": "tylerbenson", "createdAt": "2020-01-15T19:37:20Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/ClassLoaderMatcher.java", "diffHunk": "@@ -30,18 +30,9 @@ private ClassLoaderMatcher() {\n     return new ClassLoaderHasClassMatcher(names);\n   }\n \n-  public static ElementMatcher.Junction.AbstractBase<ClassLoader> classLoaderHasClassWithField(\n-      final String className, final String fieldName) {\n-    return new ClassLoaderHasClassWithFieldMatcher(className, fieldName);\n-  }\n-\n-  public static ElementMatcher.Junction.AbstractBase<ClassLoader> classLoaderHasClassWithMethod(\n-      final String className, final String methodName, final String... methodArgs) {\n-    return new ClassLoaderHasClassWithMethodMatcher(className, methodName, methodArgs);", "originalCommit": "68ed1da9c61f7c457bd42182b86c7ca92a161be4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}