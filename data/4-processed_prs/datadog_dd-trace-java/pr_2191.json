{"pr_number": 2191, "pr_title": "Enable instrumentation when only profiling is active", "pr_createdAt": "2020-12-11T11:38:54Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2191", "timeline": [{"oid": "d7064a2cff0b717ff09586c4ba9df3ddccccafc3", "url": "https://github.com/DataDog/dd-trace-java/commit/d7064a2cff0b717ff09586c4ba9df3ddccccafc3", "message": "Enable instrumentation when only profiling is active", "committedDate": "2020-12-11T11:32:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r540913204", "bodyText": "So this can be and is overridden in some instrumentations, e.g. datadog.trace.instrumentation.slf4j.mdc.MDCInjectionInstrumentation, meaning that they could be installed even though the tracing is off. It feels like there should be a separate flag for profiling, and some more logic where the enabled field is being set.", "author": "bantonsson", "createdAt": "2020-12-11T12:29:20Z", "path": "dd-java-agent/agent-tooling/src/main/java/datadog/trace/agent/tooling/Instrumenter.java", "diffHunk": "@@ -294,7 +294,9 @@ public void postMatch(\n     }\n \n     protected boolean defaultEnabled() {\n-      return Config.get().isIntegrationsEnabled();\n+      // by default an instrumentation is guarded by both tracing and the particular integration\n+      // being active\n+      return Config.get().isTraceEnabled() && Config.get().isIntegrationsEnabled();", "originalCommit": "d7064a2cff0b717ff09586c4ba9df3ddccccafc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk3MjQ3Ng==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r540972476", "bodyText": "And I thought it was easy :(\nThere is a separate flag for profiling - so, in theory each instrumentation should check whether its target system is enabled. Argh, I really don't want to redo all the instrumentation to introduce the concept of the 'system' (eg. profiling, tracing) but might have to do it, unless someone has a better idea ...", "author": "jbachorik", "createdAt": "2020-12-11T14:09:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAwMzc3OA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r541003778", "bodyText": "I think that the default should be that the instrumentations shouldn't care if they don't know that they explicitly want to be enabled with profiling only.\nI would  add a separate interface that you could add to the instrumentations that should be enabled with only the profiler enabled, and then only call the instrument method for instrumentations with that interface in installBytebuddyAgent method when we're in the profiler only state. (What I wouldn't give for default methods on interfaces)", "author": "bantonsson", "createdAt": "2020-12-11T14:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAxMTY5MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r541011691", "bodyText": "@bantonsson The problem here is the other way around - I want non-profiler instrumentations disabled when only profiling is enabled.\nIMO, it makes sense for tracing specific instrumentations to check whether tracing is enabled before they announce themselves as enabled-by-default.\nActually, this seems to be the same problem for jmxfetch - as it is now you can not enable jmxfetch without enabling tracing. And if we would change things to initialize the agent when only jmxfetch is enabled we would also load a bunch of integrations the user really don't care for.", "author": "jbachorik", "createdAt": "2020-12-11T15:05:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAxNTMyMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r541015323", "bodyText": "@jbachorik Yes, that's what I said. That you should only activate the instrumentations that specifically says that they want to be enabled in the profiler only mode, e.g. by implementing a specific marker interface and adding a check in datadog/trace/agent/tooling/AgentInstaller.java:114.", "author": "bantonsson", "createdAt": "2020-12-11T15:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MDUwOQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r541040509", "bodyText": "IMO, it should be the instrumentation which knows for which system it is targeted - and by the marker interface we are adding that exact information only we are externalizing the enablement logic to AgentInstaller. Also, I am really not fond of using instanceof to signal something which is inherently a property of the instance. But hey, if that makes this PR pass ... \ud83e\udd37\nWhat about extending Instrumentor.Default with something like targetSystem() and then use that information to load that integration in AgentInstaller as suggested? Could make Instrumentor.Tracing and Instrumentor.Profiling subclasses to serve as parents for respectively targeted instrumentations.", "author": "jbachorik", "createdAt": "2020-12-11T15:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA1MDIxMw==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r541050213", "bodyText": "I think it is messy the way it is right now, with some logic hidden away in Instrumenter.Default at line 74, but you're right, there's no need to make it even messier.\nIt's probably better to add something like targetSystem, or how you would like to call it, as you said, but it should end up on the Instrumentation interface (there are only very few direct implementers of it), so it can be checked from the outside by the agent installer.", "author": "bantonsson", "createdAt": "2020-12-11T15:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MTYzMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2191#discussion_r541091632", "bodyText": "Ok, I have updated the impl based on the previous conversation.", "author": "jbachorik", "createdAt": "2020-12-11T17:00:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkxMzIwNA=="}], "type": "inlineReview"}, {"oid": "82aff75dbbdb887a28bd0c8d6d73e6f927934241", "url": "https://github.com/DataDog/dd-trace-java/commit/82aff75dbbdb887a28bd0c8d6d73e6f927934241", "message": "Make sure tracing instrumentation does not get enabled in profiling-only mode", "committedDate": "2020-12-11T16:59:22Z", "type": "commit"}, {"oid": "a4cc6e1cb4fb8dd687d1a1f401d0c5beea302c28", "url": "https://github.com/DataDog/dd-trace-java/commit/a4cc6e1cb4fb8dd687d1a1f401d0c5beea302c28", "message": "Fix test instrumenters", "committedDate": "2020-12-11T17:11:12Z", "type": "commit"}, {"oid": "e09b40ba970b5b0fe8f3d23683310aed8b9b3c89", "url": "https://github.com/DataDog/dd-trace-java/commit/e09b40ba970b5b0fe8f3d23683310aed8b9b3c89", "message": "Merge branch 'master' into jb/exceptions_wo_tracing", "committedDate": "2020-12-11T17:29:28Z", "type": "commit"}, {"oid": "6491ba2e9b913c09737d3d82550b82ca2505ff88", "url": "https://github.com/DataDog/dd-trace-java/commit/6491ba2e9b913c09737d3d82550b82ca2505ff88", "message": "Merge and fix a newly added test instrumenter", "committedDate": "2020-12-14T08:40:31Z", "type": "forcePushed"}, {"oid": "782452c5802145e9a6dcf660460dc071dbede034", "url": "https://github.com/DataDog/dd-trace-java/commit/782452c5802145e9a6dcf660460dc071dbede034", "message": "Merge and fix a newly added test instrumenter", "committedDate": "2020-12-14T09:06:43Z", "type": "commit"}, {"oid": "782452c5802145e9a6dcf660460dc071dbede034", "url": "https://github.com/DataDog/dd-trace-java/commit/782452c5802145e9a6dcf660460dc071dbede034", "message": "Merge and fix a newly added test instrumenter", "committedDate": "2020-12-14T09:06:43Z", "type": "forcePushed"}, {"oid": "7a16cca309811bce84a94208402a1cf1d7e2ef3d", "url": "https://github.com/DataDog/dd-trace-java/commit/7a16cca309811bce84a94208402a1cf1d7e2ef3d", "message": "Fix a strange spock failure", "committedDate": "2020-12-14T09:44:05Z", "type": "commit"}, {"oid": "0a408291f3c0a108c88ca3ee7e4fb507e4752d05", "url": "https://github.com/DataDog/dd-trace-java/commit/0a408291f3c0a108c88ca3ee7e4fb507e4752d05", "message": "Spotless!", "committedDate": "2020-12-14T10:01:26Z", "type": "commit"}]}