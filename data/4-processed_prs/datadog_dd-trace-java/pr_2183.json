{"pr_number": 2183, "pr_title": "Extend JMS Integration to support Time Spent in Queue", "pr_createdAt": "2020-12-09T21:52:14Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/2183", "timeline": [{"oid": "2c7b68aaefea3a18942e45b5773e95689c3e5639", "url": "https://github.com/DataDog/dd-trace-java/commit/2c7b68aaefea3a18942e45b5773e95689c3e5639", "message": "add jmsdecorator change and jms1 change", "committedDate": "2020-12-09T21:49:11Z", "type": "commit"}, {"oid": "094a542874c0248d800f5900442650ec3eae9f8f", "url": "https://github.com/DataDog/dd-trace-java/commit/094a542874c0248d800f5900442650ec3eae9f8f", "message": "extend JMS2Test", "committedDate": "2020-12-09T21:49:33Z", "type": "commit"}, {"oid": "fa7f94d0fbca575d20ee64443d07fdf8666ea44f", "url": "https://github.com/DataDog/dd-trace-java/commit/fa7f94d0fbca575d20ee64443d07fdf8666ea44f", "message": "add support for SpringSAListener test", "committedDate": "2020-12-09T21:50:56Z", "type": "commit"}, {"oid": "894014650d6eed82c35d4a1aa9ee3300aa0b75b1", "url": "https://github.com/DataDog/dd-trace-java/commit/894014650d6eed82c35d4a1aa9ee3300aa0b75b1", "message": "spotlessapply", "committedDate": "2020-12-10T02:11:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA1ODQ2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2183#discussion_r540058460", "bodyText": "This assertion doesn't appear to check much - it doesn't check the time exists when we expect it to, or check that it doesn't exist when we don't expect it to. What do you think about adding a parameter to say when we expect there to be a time?\nWhen I do this I usually provide a default value to avoid having to update all the calls to the method: http://groovy-lang.org/objectorientation.html#_default_arguments - ie. only the calls that need the extra check then need to set the flag.", "author": "mcculls", "createdAt": "2020-12-10T10:36:06Z", "path": "dd-java-agent/instrumentation/jms/src/latestDepTest/groovy/JMS2Test.groovy", "diffHunk": "@@ -253,6 +275,9 @@ class JMS2Test extends AgentTestRunner {\n         tags {\n           \"${Tags.COMPONENT}\" \"jms\"\n           \"${Tags.SPAN_KIND}\" \"consumer\"\n+          if (!messageListener && \"$InstrumentationTags.RECORD_QUEUE_TIME_MS\") {", "originalCommit": "894014650d6eed82c35d4a1aa9ee3300aa0b75b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb3fbd82b453f23f6a845109a71cf8a0c5a27ce1", "url": "https://github.com/DataDog/dd-trace-java/commit/fb3fbd82b453f23f6a845109a71cf8a0c5a27ce1", "message": "modify tests have explicit expectations when timestamp is missing", "committedDate": "2020-12-10T16:06:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5ODkzMg==", "url": "https://github.com/DataDog/dd-trace-java/pull/2183#discussion_r540398932", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      } else if (isTimestampDisabled){\n          \n          \n            \n                        \"$InstrumentationTags.RECORD_QUEUE_TIME_MS\" {it == null }\n          \n      \n    \n    \n  \n\nI think these two lines are unnecessary since it will automatically verify such.", "author": "tylerbenson", "createdAt": "2020-12-10T18:26:23Z", "path": "dd-java-agent/instrumentation/jms/src/latestDepTest/groovy/JMS2Test.groovy", "diffHunk": "@@ -253,6 +277,11 @@ class JMS2Test extends AgentTestRunner {\n         tags {\n           \"${Tags.COMPONENT}\" \"jms\"\n           \"${Tags.SPAN_KIND}\" \"consumer\"\n+          if (!messageListener && !isTimestampDisabled) {\n+            \"$InstrumentationTags.RECORD_QUEUE_TIME_MS\" {it >= 0 }\n+          } else if (isTimestampDisabled){\n+            \"$InstrumentationTags.RECORD_QUEUE_TIME_MS\" {it == null }", "originalCommit": "fb3fbd82b453f23f6a845109a71cf8a0c5a27ce1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5OTQxNQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/2183#discussion_r540399415", "bodyText": "?", "author": "tylerbenson", "createdAt": "2020-12-10T18:27:08Z", "path": "dd-java-agent/instrumentation/jms/src/test/groovy/JMS1Test.groovy", "diffHunk": "@@ -34,6 +35,8 @@ class JMS1Test extends AgentTestRunner {\n     final Connection connection = connectionFactory.createConnection()\n     connection.start()\n     session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE)\n+\n+//    final Connection connectionDisabledTimestamp = connectionFactory.createConnection()", "originalCommit": "fb3fbd82b453f23f6a845109a71cf8a0c5a27ce1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5OTc2MA==", "url": "https://github.com/DataDog/dd-trace-java/pull/2183#discussion_r540399760", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      } else if (isTimestampDisabled) {\n          \n          \n            \n                        \"$InstrumentationTags.RECORD_QUEUE_TIME_MS\" {it == null}\n          \n      \n    \n    \n  \n\nSame here.", "author": "tylerbenson", "createdAt": "2020-12-10T18:27:39Z", "path": "dd-java-agent/instrumentation/jms/src/test/groovy/JMS1Test.groovy", "diffHunk": "@@ -269,6 +296,11 @@ class JMS1Test extends AgentTestRunner {\n         tags {\n           \"$Tags.COMPONENT\" \"jms\"\n           \"$Tags.SPAN_KIND\" Tags.SPAN_KIND_CONSUMER\n+          if (!messageListener && !isTimestampDisabled) {\n+            \"$InstrumentationTags.RECORD_QUEUE_TIME_MS\" {it >= 0 }\n+          } else if (isTimestampDisabled) {\n+            \"$InstrumentationTags.RECORD_QUEUE_TIME_MS\" {it == null}", "originalCommit": "fb3fbd82b453f23f6a845109a71cf8a0c5a27ce1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e7a83653a201b3915da8558353e84e9d290e6936", "url": "https://github.com/DataDog/dd-trace-java/commit/e7a83653a201b3915da8558353e84e9d290e6936", "message": "modify tests based on feedback", "committedDate": "2020-12-10T19:51:22Z", "type": "commit"}]}