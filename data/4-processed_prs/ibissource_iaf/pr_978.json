{"pr_number": 978, "pr_title": "Add default JDBC realm", "pr_createdAt": "2020-07-31T14:47:48Z", "pr_url": "https://github.com/ibissource/iaf/pull/978", "timeline": [{"oid": "ce32aa183363deaa16691270a336de984337128e", "url": "https://github.com/ibissource/iaf/commit/ce32aa183363deaa16691270a336de984337128e", "message": "Add default JDBC realm", "committedDate": "2020-07-31T14:47:27Z", "type": "commit"}, {"oid": "2d1609ec433ac58151344baec2dd5f028cf95a12", "url": "https://github.com/ibissource/iaf/commit/2d1609ec433ac58151344baec2dd5f028cf95a12", "message": "Move stuff around", "committedDate": "2020-08-03T07:52:36Z", "type": "commit"}, {"oid": "b8eb85827bd4d9aa53a3c94bdd42b16765487c81", "url": "https://github.com/ibissource/iaf/commit/b8eb85827bd4d9aa53a3c94bdd42b16765487c81", "message": "Cleanup code", "committedDate": "2020-08-03T07:56:33Z", "type": "commit"}, {"oid": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "url": "https://github.com/ibissource/iaf/commit/6f35eb6b15f503173f1e7a0ee2595cae222c759e", "message": "Change jms to datasource", "committedDate": "2020-08-04T12:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE0NTI4NQ==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465145285", "bodyText": "Ik snap niet waarom een Jobdef aan z'n locker naar z'n datasource moet vragen, maar dat was dus al zo", "author": "gvanbrakel", "createdAt": "2020-08-04T15:40:21Z", "path": "core/src/main/java/nl/nn/adapterframework/scheduler/JobDef.java", "diffHunk": "@@ -623,17 +625,19 @@ protected void runJob(IbisManager ibisManager) {\n \t\tstatsKeeper.addValue(endTime - startTime);\n \t}\n \n-\tprivate void cleanupDatabase(IbisManager ibisManager) {\n-\t\tDate date = new Date();\n-\n-\t\tList<String> jmsRealmNames = new ArrayList<String>();\n+\t/**\n+\t * Locate all Lockers, and find out which datasources are used.\n+\t * @return distinct list of all datasourceNames used by lockers\n+\t */\n+\tprivate List<String> getAllLockerDatasourceNames(IbisManager ibisManager) {\n+\t\tList<String> datasourceNames = new ArrayList<>();\n \n \t\tfor (Configuration configuration : ibisManager.getConfigurations()) {\n \t\t\tfor (JobDef jobdef : configuration.getScheduledJobs()) {\n \t\t\t\tif (jobdef.getLocker()!=null) {\n-\t\t\t\t\tString jmsRealmName = jobdef.getLocker().getJmsRealName();\n-\t\t\t\t\tif (!jmsRealmNames.contains(jmsRealmName)) {\n-\t\t\t\t\t\tjmsRealmNames.add(jmsRealmName);\n+\t\t\t\t\tString datasourceName = jobdef.getLocker().getDatasourceName();", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxODU0Ng==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465818546", "bodyText": "Tja, schijnbaar wilt hij een lijst met alle lockers die mogelijk verschillende datasources kunnen hebben.", "author": "nielsm5", "createdAt": "2020-08-05T15:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE0NTI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1MDY4Mg==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465150682", "bodyText": "Moet dit? Waarom dan?", "author": "gvanbrakel", "createdAt": "2020-08-04T15:48:12Z", "path": "core/src/main/java/nl/nn/adapterframework/extensions/test/IbisTester.java", "diffHunk": "@@ -142,6 +144,10 @@ public void initTest() {\n \t\tSystem.setProperty(\"flow.create.url\", \"\");\n \t\tdebug(\"***start***\");\n \t\tibisContext = null;\n+\n+\t\tJmsRealmFactory realmFactory = JmsRealmFactory.getInstance();\n+\t\trealmFactory.clear();\n+\t\trealmFactory.registerJmsRealm(JmsRealm.defaultRealm());", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1MTE5MQ==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465151191", "bodyText": "Dit moet er al 100 jaar zo in zitten. Onbegrijpelijk.\nOf toch niet. Ik zie dat het alleen de getter is waarvan de naam verkeerd gespeld is.", "author": "gvanbrakel", "createdAt": "2020-08-04T15:49:01Z", "path": "core/src/main/java/nl/nn/adapterframework/jms/JMSFacade.java", "diffHunk": "@@ -454,11 +454,11 @@ public String getPhysicalDestinationName() {\n \t\t\tresult+=\" selector [\"+getMessageSelector()+\"]\";\n \t\t}\n \t\tJmsRealm jmsRealm=null;\n-\t\tif (getJmsRealName()!=null) {\n-\t\t\tjmsRealm=JmsRealmFactory.getInstance().getJmsRealm(getJmsRealName());\n+\t\tif (getJmsRealmName()!=null) {\n+\t\t\tjmsRealm=JmsRealmFactory.getInstance().getJmsRealm(getJmsRealmName());\n \t\t}\n \t    if (jmsRealm==null) {\n-\t    \tlog.warn(\"Could not find jmsRealm [\"+getJmsRealName()+\"]\");\n+\t    \tlog.warn(\"Could not find jmsRealm [\"+getJmsRealmName()+\"]\");", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxODE4Mw==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465818183", "bodyText": "Ja leuk he, ik snapte er ook al niets van", "author": "nielsm5", "createdAt": "2020-08-05T15:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1MTE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1MzMzOA==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465153338", "bodyText": "Moet dit? Als je een default datasource wil hebben, dan kan je toch gewoon ${jdbc.datasource.default} gebruiken?", "author": "gvanbrakel", "createdAt": "2020-08-04T15:52:08Z", "path": "core/src/main/java/nl/nn/adapterframework/jms/JmsRealm.java", "diffHunk": "@@ -65,6 +66,14 @@ public JmsRealm() {\n \t\tsuper();\n \t}\n \n+\tpublic static JmsRealm defaultRealm() {\n+\t\tJmsRealm defaultJmsRealm = new JmsRealm();\n+\t\tdefaultJmsRealm.setRealmName(\"jdbc\");\n+\t\tString defaultDatasource = AppConstants.getInstance().getResolvedProperty(\"jdbc.datasource.default\");\n+\t\tdefaultJmsRealm.setDatasourceName(defaultDatasource);\n+\t\treturn defaultJmsRealm;\n+\t}", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1NDU5OA==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465154598", "bodyText": "Ik snap niet waarom getLocker() een member is van IExtendedPipe, maar dat was dus al zo.", "author": "gvanbrakel", "createdAt": "2020-08-04T15:54:05Z", "path": "core/src/main/java/nl/nn/adapterframework/scheduler/JobDef.java", "diffHunk": "@@ -647,9 +651,9 @@ private void cleanupDatabase(IbisManager ibisManager) {\n \t\t\t\t\t\tif (pipe instanceof IExtendedPipe) {\n \t\t\t\t\t\t\tIExtendedPipe extendedPipe = (IExtendedPipe)pipe;\n \t\t\t\t\t\t\tif (extendedPipe.getLocker() != null) {\n-\t\t\t\t\t\t\t\tString jmsRealmName = extendedPipe.getLocker().getJmsRealName();\n-\t\t\t\t\t\t\t\tif (!jmsRealmNames.contains(jmsRealmName)) {\n-\t\t\t\t\t\t\t\t\tjmsRealmNames.add(jmsRealmName);\n+\t\t\t\t\t\t\t\tString datasourceName = extendedPipe.getLocker().getDatasourceName();\n+\t\t\t\t\t\t\t\tif(StringUtils.isNotEmpty(datasourceName) && !datasourceNames.contains(datasourceName)) {\n+\t\t\t\t\t\t\t\t\tdatasourceNames.add(datasourceName);", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1NzE0NA==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465157144", "bodyText": "Krijg hier toch een beetje baron van Munchhausen gevoel, die zichzelf aan z'n haren uit het moeras trekt, maar ja, dat was dus al.", "author": "gvanbrakel", "createdAt": "2020-08-04T15:57:43Z", "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "diffHunk": "@@ -1013,13 +1013,13 @@ public static void executeStatement(Connection connection, String query, int par\n \n \tpublic static synchronized Properties retrieveJdbcPropertiesFromDatabase() {", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1ODIzMQ==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465158231", "bodyText": "Dus hier zeg je volgens mij: Als er een realm is met een datasource, dan krijgt die realm prioriteit over jdbc.datasource.default, vanwege compatibiliteit met bestaande configuraties.\nHet lijkt me goed om dat hier te documenteren.", "author": "gvanbrakel", "createdAt": "2020-08-04T15:59:18Z", "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "diffHunk": "@@ -1013,13 +1013,13 @@ public static void executeStatement(Connection connection, String query, int par\n \n \tpublic static synchronized Properties retrieveJdbcPropertiesFromDatabase() {\n \t\tif (jdbcProperties == null) {\n-\t\t\tString jmsRealm = JmsRealmFactory.getInstance()\n-\t\t\t\t\t.getFirstDatasourceJmsRealm();\n+\t\t\tString jmsRealm = JmsRealmFactory.getInstance().getFirstDatasourceJmsRealm();\n \t\t\tif (jmsRealm != null) {", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1ODk2OA==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465158968", "bodyText": "Ik snap dit commentaar niet. Is het niet genoeg om een datasource te hebben?\nVolgens mij klopt de logica niet, volgt het niet mijn commentaar bij regel 1017, maar zou het dat wel moeten doen.\nZoiets als\nif (jmsRealm != null) {\n  ibisProp.setJmsRealm(jmsRealm)\n} else {\n  ibisProp.setDatasource(appConstants.getProperty(\"jdbc.datasource.default\")\n}", "author": "gvanbrakel", "createdAt": "2020-08-04T16:00:21Z", "path": "core/src/main/java/nl/nn/adapterframework/util/JdbcUtil.java", "diffHunk": "@@ -1013,13 +1013,13 @@ public static void executeStatement(Connection connection, String query, int par\n \n \tpublic static synchronized Properties retrieveJdbcPropertiesFromDatabase() {\n \t\tif (jdbcProperties == null) {\n-\t\t\tString jmsRealm = JmsRealmFactory.getInstance()\n-\t\t\t\t\t.getFirstDatasourceJmsRealm();\n+\t\t\tString jmsRealm = JmsRealmFactory.getInstance().getFirstDatasourceJmsRealm();\n \t\t\tif (jmsRealm != null) {\n \t\t\t\tjdbcProperties = new Properties();\n \t\t\t\tJdbcFacade ibisProp = new JdbcFacade();\n-\t\t\t\tibisProp.setJmsRealm(jmsRealm);\n-\t\t\t\t\n+\t\t\t\tibisProp.setJmsRealm(jmsRealm); //Use a realm here so it copies over proxied datasources", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxOTc0Nw==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465819747", "bodyText": "Ja eigenlijk wel, maar dit ding moet helemaal niets met een realm doen toch? ipv daarvan met een datasource oid? ik vond het te veel om er vanalles mee te doen dus heb het maar gelaten.", "author": "nielsm5", "createdAt": "2020-08-05T15:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE1ODk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE2ODk3OQ==", "url": "https://github.com/ibissource/iaf/pull/978#discussion_r465168979", "bodyText": "Hier moet niet een specifieke test op Dbms.MSSQL zijn, maar moet er gebruik gemaakt worden van generieke functies in dbmsSupport. Zal ik wel doen na mijn vakantie.\nIk wil dat wat nu (geloof ik) heet prepareSessionForDirtyRead() hernoemen in prepareSessionForNonLockingRead(), en de method prepareQueryForWorkqueuePeeking() in prepareQueryForNonLockingRead().\nDie moeten dan hier ook gebruikt worden.", "author": "gvanbrakel", "createdAt": "2020-08-04T16:15:28Z", "path": "core/src/main/java/nl/nn/adapterframework/scheduler/JobDef.java", "diffHunk": "@@ -696,26 +692,75 @@ private void cleanupDatabase(IbisManager ibisManager) {\n \t\t\t\t}\n \t\t\t}\n \t\t}\n+\t\treturn messageLogs;\n+\t}\n \n-\t\tfor (MessageLogObject mlo: messageLogs) {\n-\t\t\tsetJmsRealm(mlo.getJmsRealmName());\n-\t\t\tDirectQuerySender qs;\n-\t\t\tqs = (DirectQuerySender)ibisManager.getIbisContext().createBeanAutowireByName(DirectQuerySender.class);\n-\t\t\tqs.setJmsRealm(mlo.getJmsRealmName());\n-\t\t\tString deleteQuery;\n-\t\t\tif (qs.getDatabaseType() == Dbms.MSSQL) {\n-\t\t\t\tdeleteQuery = \"DELETE FROM \" + mlo.getTableName() + \" WHERE \" + mlo.getKeyField() + \" IN (SELECT \" + mlo.getKeyField() + \" FROM \" + mlo.getTableName()\n-\t\t\t\t\t\t+ \" WITH (readpast) WHERE \" + mlo.getTypeField() + \" IN ('\" + IMessageBrowser.StorageType.MESSAGELOG_PIPE.getCode() + \"','\" + IMessageBrowser.StorageType.MESSAGELOG_RECEIVER.getCode()\n-\t\t\t\t\t\t+ \"') AND \" + mlo.getExpiryDateField() + \" < \"+qs.getDbmsSupport().getDatetimeLiteral(date)+\")\";\n+\tprivate void cleanupDatabase(IbisManager ibisManager) {\n+\t\tDate date = new Date();\n+\n+\t\tList<String> datasourceNames = getAllLockerDatasourceNames(ibisManager);\n+\n+\t\tfor (Iterator<String> iter = datasourceNames.iterator(); iter.hasNext();) {\n+\t\t\tString datasourceName = iter.next();\n+\t\t\tDirectQuerySender qs = null;\n+\t\t\tString deleteQuery = null;\n+\t\t\ttry {\n+\t\t\t\tqs = ibisManager.getIbisContext().createBeanAutowireByName(DirectQuerySender.class);\n+\t\t\t\tqs.setDatasourceName(datasourceName);\n+\t\t\t\tqs.setName(\"executeQueryJob\");\n+\t\t\t\tqs.setQueryType(\"other\");\n+\t\t\t\tqs.setTimeout(getQueryTimeout());\n+\t\t\t\tqs.configure(true);\n+\t\t\t\tqs.open();\n+\n+\t\t\t\tdeleteQuery = \"DELETE FROM IBISLOCK WHERE EXPIRYDATE < \"+qs.getDbmsSupport().getDatetimeLiteral(date);\n+\t\t\t\tMessage result = qs.sendMessage(new Message(deleteQuery), null);\n+\t\t\t\tlog.info(\"result [\" + result + \"]\");\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tString msg = \"error while executing query [\"+deleteQuery+\"] (as part of scheduled job execution): \" + e.getMessage();\n+\t\t\t\tgetMessageKeeper().add(msg, MessageKeeperLevel.ERROR);\n+\t\t\t\tlog.error(getLogPrefix()+msg);\n+\t\t\t} finally {\n+\t\t\t\tif(qs != null) {\n+\t\t\t\t\tqs.close();\n+\t\t\t\t}\n \t\t\t}\n-\t\t\telse {\n-\t\t\t\tdeleteQuery = \"DELETE FROM \" + mlo.getTableName() \n-\t\t\t\t\t+ \" WHERE \" + mlo.getTypeField() + \" IN ('\" + IMessageBrowser.StorageType.MESSAGELOG_PIPE.getCode() + \"','\" + IMessageBrowser.StorageType.MESSAGELOG_RECEIVER.getCode() + \"') AND \" + mlo.getExpiryDateField() + \" < \"+qs.getDbmsSupport().getDatetimeLiteral(date);\n+\t\t}\n+\n+\t\tList<MessageLogObject> messageLogs = getAllMessageLogsAndErrorstorages(ibisManager);\n+\n+\t\tfor (MessageLogObject mlo: messageLogs) {\n+\t\t\tDirectQuerySender qs = null;\n+\t\t\tString deleteQuery = null;\n+\t\t\ttry {\n+\t\t\t\tqs = ibisManager.getIbisContext().createBeanAutowireByName(DirectQuerySender.class);\n+\t\t\t\tqs.setDatasourceName(mlo.getDatasourceName());\n+\t\t\t\tqs.setName(\"executeQueryJob\");\n+\t\t\t\tqs.setQueryType(\"other\");\n+\t\t\t\tqs.setTimeout(getQueryTimeout());\n+\t\t\t\tqs.configure(true);\n+\t\t\t\tqs.open();\n+\n+\t\t\t\tif (qs.getDatabaseType() == Dbms.MSSQL) {", "originalCommit": "6f35eb6b15f503173f1e7a0ee2595cae222c759e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e4fb32bfeffc139b7e334e786d0695e3350b46bb", "url": "https://github.com/ibissource/iaf/commit/e4fb32bfeffc139b7e334e786d0695e3350b46bb", "message": "Remove default realm thing", "committedDate": "2020-08-05T09:31:06Z", "type": "commit"}, {"oid": "e055799ce305db9ee555fdadaed625fe0239b36d", "url": "https://github.com/ibissource/iaf/commit/e055799ce305db9ee555fdadaed625fe0239b36d", "message": "Cleanup unused import", "committedDate": "2020-08-05T11:41:55Z", "type": "commit"}]}