{"pr_number": 1278, "pr_title": "Fix NPE and preserve message object", "pr_createdAt": "2020-11-19T14:08:25Z", "pr_url": "https://github.com/ibissource/iaf/pull/1278", "timeline": [{"oid": "56bd2d6b4bbdf29755392209cb4cd575cd2eb3c3", "url": "https://github.com/ibissource/iaf/commit/56bd2d6b4bbdf29755392209cb4cd575cd2eb3c3", "message": "Fix NPE and preserve message object", "committedDate": "2020-11-19T14:05:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA0MjY2OQ==", "url": "https://github.com/ibissource/iaf/pull/1278#discussion_r527042669", "bodyText": "Dit vraagt om een Message.isEmpty(result)", "author": "gvanbrakel", "createdAt": "2020-11-19T16:53:49Z", "path": "core/src/main/java/nl/nn/adapterframework/receivers/Receiver.java", "diffHunk": "@@ -1256,33 +1256,37 @@ private Message processMessageInAdapter(Object rawMessageOrWrapper, Message mess\n \t\t\t\t\tpipeLineResult = adapter.processMessageWithExceptions(businessCorrelationId, pipelineMessage, pipelineSession);\n \t\t\t\t\tsetExitState(threadContext, pipeLineResult.getState(), pipeLineResult.getExitCode());\n \t\t\t\t\tpipelineSession.put(\"exitcode\", \"\"+ pipeLineResult.getExitCode());\n-\t\t\t\t\tresult=pipeLineResult.getResult().asString();\n-\t\t\t\t\tif(result != null && result.length() > ITransactionalStorage.MAXCOMMENTLEN) {\n-\t\t\t\t\t\terrorMessage = \"exitState [\"+pipeLineResult.getState()+\"], result [\"+result.substring(0, ITransactionalStorage.MAXCOMMENTLEN)+\"]\";\n-\t\t\t\t\t}else {\n-\t\t\t\t\t\terrorMessage = \"exitState [\"+pipeLineResult.getState()+\"], result [\"+result+\"]\";\n+\t\t\t\t\tresult=pipeLineResult.getResult();\n+\n+\t\t\t\t\terrorMessage = \"exitState [\"+pipeLineResult.getState()+\"], result [\";\n+\t\t\t\t\tif(result != null && !result.isEmpty() && result.size() > ITransactionalStorage.MAXCOMMENTLEN) { //Since we can determine the size, assume the message is preservable\n+\t\t\t\t\t\terrorMessage += result.asString().substring(0, ITransactionalStorage.MAXCOMMENTLEN);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\terrorMessage += result;\n \t\t\t\t\t}\n+\t\t\t\t\terrorMessage += \"]\";\n+\n \t\t\t\t\tint status = pipeLineResult.getExitCode();\n \t\t\t\t\tif(status > 0) {\n \t\t\t\t\t\terrorMessage += \", exitcode [\"+status+\"]\";\n \t\t\t\t\t}\n+\n \t\t\t\t\tif (log.isDebugEnabled()) { log.debug(getLogPrefix()+\"received result: \"+errorMessage); }\n \t\t\t\t\tmessageInError=txStatus.isRollbackOnly();\n \t\t\t\t} finally {\n \t\t\t\t\tlog.debug(getLogPrefix()+\"canceling TimeoutGuard, isInterrupted [\"+Thread.currentThread().isInterrupted()+\"]\");\n \t\t\t\t\tif (tg.cancel()) {\n \t\t\t\t\t\terrorMessage = \"timeout exceeded\";\n-\t\t\t\t\t\tif (StringUtils.isEmpty(result)) {\n-\t\t\t\t\t\t\tresult=\"<timeout/>\";\n+\t\t\t\t\t\tif (result == null || result.isEmpty()) {", "originalCommit": "56bd2d6b4bbdf29755392209cb4cd575cd2eb3c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b4a1a20af7fd1b65f302572909ad1fac8e0fa2c0", "url": "https://github.com/ibissource/iaf/commit/b4a1a20af7fd1b65f302572909ad1fac8e0fa2c0", "message": "Add Message.isEmpty method", "committedDate": "2020-11-23T09:04:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU2NDQ3MQ==", "url": "https://github.com/ibissource/iaf/pull/1278#discussion_r528564471", "bodyText": "Hier wil je niet dat Message.size() zo smart is om de lengte van een file te weten, en dan hier eerst een hele file van zeg 1GB in geheugen te lezen om er maar een klein stukje van af te drukken.\nEr moet dus naar mijn idee ook nog een test bij op result.asObject() instanceof String", "author": "gvanbrakel", "createdAt": "2020-11-23T09:26:33Z", "path": "core/src/main/java/nl/nn/adapterframework/receivers/Receiver.java", "diffHunk": "@@ -1256,33 +1256,37 @@ private Message processMessageInAdapter(Object rawMessageOrWrapper, Message mess\n \t\t\t\t\tpipeLineResult = adapter.processMessageWithExceptions(businessCorrelationId, pipelineMessage, pipelineSession);\n \t\t\t\t\tsetExitState(threadContext, pipeLineResult.getState(), pipeLineResult.getExitCode());\n \t\t\t\t\tpipelineSession.put(\"exitcode\", \"\"+ pipeLineResult.getExitCode());\n-\t\t\t\t\tresult=pipeLineResult.getResult().asString();\n-\t\t\t\t\tif(result != null && result.length() > ITransactionalStorage.MAXCOMMENTLEN) {\n-\t\t\t\t\t\terrorMessage = \"exitState [\"+pipeLineResult.getState()+\"], result [\"+result.substring(0, ITransactionalStorage.MAXCOMMENTLEN)+\"]\";\n-\t\t\t\t\t}else {\n-\t\t\t\t\t\terrorMessage = \"exitState [\"+pipeLineResult.getState()+\"], result [\"+result+\"]\";\n+\t\t\t\t\tresult=pipeLineResult.getResult();\n+\n+\t\t\t\t\terrorMessage = \"exitState [\"+pipeLineResult.getState()+\"], result [\";\n+\t\t\t\t\tif(!Message.isEmpty(result) && result.size() > ITransactionalStorage.MAXCOMMENTLEN) { //Since we can determine the size, assume the message is preservable\n+\t\t\t\t\t\terrorMessage += result.asString().substring(0, ITransactionalStorage.MAXCOMMENTLEN);", "originalCommit": "b4a1a20af7fd1b65f302572909ad1fac8e0fa2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}