{"pr_number": 766, "pr_title": "Api listener duplicate check", "pr_createdAt": "2020-05-27T19:45:05Z", "pr_url": "https://github.com/ibissource/iaf/pull/766", "timeline": [{"oid": "82971b06cc11c636e17eb916e02188acc853389a", "url": "https://github.com/ibissource/iaf/commit/82971b06cc11c636e17eb916e02188acc853389a", "message": "Set MessageId in IPipelineSession", "committedDate": "2020-05-27T19:23:30Z", "type": "commit"}, {"oid": "426873b4e2c35fcbd9294e1e34bd734ee77cc1ed", "url": "https://github.com/ibissource/iaf/commit/426873b4e2c35fcbd9294e1e34bd734ee77cc1ed", "message": "allow setting the header via apilistener", "committedDate": "2020-05-27T19:44:36Z", "type": "commit"}, {"oid": "01b40c4dc693795bac4ccb345435d1f38fef3b85", "url": "https://github.com/ibissource/iaf/commit/01b40c4dc693795bac4ccb345435d1f38fef3b85", "message": "Add larva tests", "committedDate": "2020-05-28T10:38:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3NDc0MQ==", "url": "https://github.com/ibissource/iaf/pull/766#discussion_r432274741", "bodyText": "Dit moet m.i. niet hier, maar in ApiListener.getIdFromRawMessage()", "author": "gvanbrakel", "createdAt": "2020-05-29T06:11:23Z", "path": "core/src/main/java/nl/nn/adapterframework/http/rest/ApiListenerServlet.java", "diffHunk": "@@ -444,7 +445,15 @@ else if(segment.startsWith(\"{\") && segment.endsWith(\"}\")) {\n \t\t\tif (!ServletFileUpload.isMultipartContent(request)) {\n \t\t\t\tbody = Misc.streamToString(request.getInputStream(),\"\\n\",false);\n \t\t\t}\n-\t\t\t//TODO: String correlationId = request.getHeader(\"message-id\");\n+\n+\t\t\tString messageId = null;\n+\t\t\tif(StringUtils.isNotEmpty(listener.getMessageIdHeader())) {\n+\t\t\t\tString messageIdHeader = request.getHeader(listener.getMessageIdHeader());\n+\t\t\t\tif(StringUtils.isNotEmpty(messageIdHeader)) {\n+\t\t\t\t\tmessageId = messageIdHeader;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tPipeLineSessionBase.setListenerParameters(messageContext, messageId, null, null, null); //We're only using this method to keep setting id/cid/tcid uniform", "originalCommit": "01b40c4dc693795bac4ccb345435d1f38fef3b85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzOTQzOA==", "url": "https://github.com/ibissource/iaf/pull/766#discussion_r432339438", "bodyText": "Ik heb hier issue #769 voor aangemaakt", "author": "nielsm5", "createdAt": "2020-05-29T08:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3NDc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3NTU2MA==", "url": "https://github.com/ibissource/iaf/pull/766#discussion_r432275560", "bodyText": "Kunnen we dat niet op een nette manier fixen?", "author": "gvanbrakel", "createdAt": "2020-05-29T06:14:05Z", "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "diffHunk": "@@ -894,15 +894,26 @@ public String processRequest(IListener origin, String correlationId, String mess\n \t\tDate tsReceived = null;\n \t\tDate tsSent = null;\n \t\tif (context!=null) {\n-\t\t\t//TODO ClassCasting Exceptions occur when using PipeLineSessionBase.setListenerParameters\n-\t\t\ttsReceived = (Date)context.get(IPipeLineSession.tsReceivedKey);\n-\t\t\ttsSent = (Date)context.get(IPipeLineSession.tsSentKey);\n+\t\t\t//ClassCasting Exceptions occur when using PipeLineSessionBase.setListenerParameters, hence these silly instanceof's", "originalCommit": "01b40c4dc693795bac4ccb345435d1f38fef3b85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzOTUxMw==", "url": "https://github.com/ibissource/iaf/pull/766#discussion_r432339513", "bodyText": "Ik heb hier issue #770 voor aangemaakt", "author": "nielsm5", "createdAt": "2020-05-29T08:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3NTU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM2MDYyNw==", "url": "https://github.com/ibissource/iaf/pull/766#discussion_r432360627", "bodyText": "Het lijkt me zinvol om de message-id niet alleen uit een Http Header te kunnen halen, maar ook uit een request-parameter.", "author": "gvanbrakel", "createdAt": "2020-05-29T09:18:17Z", "path": "core/src/main/java/nl/nn/adapterframework/http/rest/ApiListener.java", "diffHunk": "@@ -237,6 +241,15 @@ public String getMultipartBodyName() {\n \t\treturn null;\n \t}\n \n+\t@IbisDoc({\"8\", \"name of the header which contains the message-id\", \"message-id\"})\n+\tpublic void setMessageIdHeader(String messageIdHeader) {\n+\t\tthis.messageIdHeader = messageIdHeader;\n+\t}\n+\n+\tpublic String getMessageIdHeader() {\n+\t\treturn messageIdHeader;\n+\t}\n+", "originalCommit": "01b40c4dc693795bac4ccb345435d1f38fef3b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}