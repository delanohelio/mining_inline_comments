{"pr_number": 914, "pr_title": "Expand IAF API testset", "pr_createdAt": "2020-07-07T14:02:09Z", "pr_url": "https://github.com/ibissource/iaf/pull/914", "timeline": [{"oid": "bfbdd4f30362ceeaec302809f6eb3878f907ee97", "url": "https://github.com/ibissource/iaf/commit/bfbdd4f30362ceeaec302809f6eb3878f907ee97", "message": "Expand IAF API testset", "committedDate": "2020-07-07T14:01:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDkyMzE5Mw==", "url": "https://github.com/ibissource/iaf/pull/914#discussion_r450923193", "bodyText": "Wil je hier niet wat meer testen? Als in asserten wat er allemaal in de response zit?", "author": "gvanbrakel", "createdAt": "2020-07-07T14:48:20Z", "path": "core/src/test/java/nl/nn/adapterframework/webcontrol/api/ServerStatisticsTest.java", "diffHunk": "@@ -37,6 +46,7 @@ public void testServerInfo() {\n \t\tassertEquals(MediaType.APPLICATION_JSON, response.getMediaType().toString());\n \n \t\t//TODO: validate response.getEntity()\n+\t\tassertNotNull(response.getEntity());", "originalCommit": "bfbdd4f30362ceeaec302809f6eb3878f907ee97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ0MjA3Mg==", "url": "https://github.com/ibissource/iaf/pull/914#discussion_r451442072", "bodyText": "Tja het is erg lastig.. ik zou alleen de json 'keys' kunnen testen, aangezien de values mijn computernaam, jvm geheugen, etc bevatten", "author": "nielsm5", "createdAt": "2020-07-08T10:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDkyMzE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0MjAxNw==", "url": "https://github.com/ibissource/iaf/pull/914#discussion_r451542017", "bodyText": "Maar je zou wel kunnen testen dat bepaalde keys er in zitten, zonder op de waarde zelf te testen", "author": "gvanbrakel", "createdAt": "2020-07-08T13:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDkyMzE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDkyODIxMw==", "url": "https://github.com/ibissource/iaf/pull/914#discussion_r450928213", "bodyText": "Dit is een key method, waarvan niet direct duidelijk is dat dat zo is.\nHet zou prettig zijn als er javadoc was die vertelt wat hij doet, en er op strategische punten in de code vertelt wordt hoe het daar gedaan wordt.", "author": "gvanbrakel", "createdAt": "2020-07-07T14:54:57Z", "path": "core/src/test/java/nl/nn/adapterframework/webcontrol/api/ApiTestBase.java", "diffHunk": "@@ -117,43 +123,205 @@ public void register(M jaxRsResource) {\n \n \t\t//Uppercase method, make sure url begins with a /\n \t\tpublic String compileKey(String method, String path) {\n-\t\t\tString url = path; //May contain QueryParameters\n+\t\t\tString url = getRawUrl(path); //May contain QueryParameters\n+\n+\t\t\treturn String.format(\"%S:%s\", method, url);\n+\t\t}\n+\n+\t\tprivate String getRawUrl(String path) { //String QueryParams off path\n+\t\t\tString url = path;\n \t\t\tif(!url.startsWith(\"/\")) {\n \t\t\t\turl = \"/\"+url;\n \t\t\t}\n \t\t\tint questionMark = url.indexOf(\"?\");\n \t\t\tif(questionMark != -1) {\n \t\t\t\turl = url.substring(0, questionMark);\n \t\t\t}\n+\t\t\treturn url;\n+\t\t}\n \n-\t\t\treturn String.format(\"%S:%s\", method, url);\n+\t\tprivate Method findRequest(String rsResourceKey) {\n+\t\t\tString uriSegments[] = rsResourceKey.split(\"/\");\n+\n+\t\t\tfor (Iterator<String> it = rsRequests.keySet().iterator(); it.hasNext();) {\n+\t\t\t\tString pattern = it.next();\n+\t\t\t\tString patternSegments[] = pattern.split(\"/\");\n+\n+\t\t\t\tif (patternSegments.length != uriSegments.length || patternSegments.length < uriSegments.length) {\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n+\n+\t\t\t\tint matches = 0;\n+\t\t\t\tfor (int i = 0; i < uriSegments.length; i++) {\n+\t\t\t\t\tif(patternSegments[i].equals(uriSegments[i]) || (patternSegments[i].startsWith(\"{\") && patternSegments[i].endsWith(\"}\"))) {\n+\t\t\t\t\t\tmatches++;\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif(matches == uriSegments.length) {\n+\t\t\t\t\treturn rsRequests.get(pattern);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\treturn null;\n \t\t}\n \n \t\tpublic Response dispatchRequest(String httpMethod, String url) {\n+\t\t\treturn dispatchRequest(httpMethod, url, null);\n+\t\t}\n+\n+\t\tpublic Response dispatchRequest(String httpMethod, String url, Object jsonOrFormdata) {", "originalCommit": "bfbdd4f30362ceeaec302809f6eb3878f907ee97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "910f60c588bf90916612f1c5536aaa0dc9e3aeef", "url": "https://github.com/ibissource/iaf/commit/910f60c588bf90916612f1c5536aaa0dc9e3aeef", "message": "Fix authorization", "committedDate": "2020-07-08T13:19:34Z", "type": "commit"}, {"oid": "17ae578c0b77e58134e39b5fddd392cbcf8f6f85", "url": "https://github.com/ibissource/iaf/commit/17ae578c0b77e58134e39b5fddd392cbcf8f6f85", "message": "Add comments to ApiTestBase", "committedDate": "2020-07-08T13:19:46Z", "type": "commit"}, {"oid": "f52c51ac7e0332d92bb5448999ab226c9e767fe9", "url": "https://github.com/ibissource/iaf/commit/f52c51ac7e0332d92bb5448999ab226c9e767fe9", "message": "Fix tests", "committedDate": "2020-07-08T13:33:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0Mzk4MA==", "url": "https://github.com/ibissource/iaf/pull/914#discussion_r451543980", "bodyText": "Dit is niet 'verify username and password', toch?", "author": "gvanbrakel", "createdAt": "2020-07-08T13:28:30Z", "path": "core/src/main/java/nl/nn/adapterframework/webcontrol/api/AuthorizationFilter.java", "diffHunk": "@@ -93,13 +94,13 @@ public void filter(ContainerRequestContext requestContext) throws IOException {\n \t\t\t\t\trequestContext.abortWith(UNAUTHORIZED);\n \t\t\t\t\treturn;\n \t\t\t\t} else {\n-\t\t\t\t\tSystem.out.println(\"manually logged in user [\" + securityContext.getUserPrincipal().getName()+\"]\");\n+\t\t\t\t\tlog.info(\"manually logged in user [\" + securityContext.getUserPrincipal().getName()+\"]\");\n \t\t\t\t}\n \t\t\t}\n \n \t\t\tRolesAllowed rolesAnnotation = method.getAnnotation(RolesAllowed.class);\n \t\t\tSet<String> rolesSet = new HashSet<String>(Arrays.asList(rolesAnnotation.value()));\n-\t\t\tSystem.out.println(\"Checking authentication for user [\"+securityContext.getUserPrincipal().getName()+\"] uri [\"+method.getAnnotation(javax.ws.rs.Path.class).value()+\"] roles \" + rolesSet.toString());\n+\t\t\tlog.info(\"checking authentication for user [\"+securityContext.getUserPrincipal().getName()+\"] on uri [\"+method.getAnnotation(javax.ws.rs.Path.class).value()+\"] required roles \" + rolesSet.toString());\n \n \t\t\t//Verifying username and password", "originalCommit": "17ae578c0b77e58134e39b5fddd392cbcf8f6f85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0NDUxMQ==", "url": "https://github.com/ibissource/iaf/pull/914#discussion_r451544511", "bodyText": "En dit is checking authorisation, niet authentication", "author": "gvanbrakel", "createdAt": "2020-07-08T13:29:13Z", "path": "core/src/main/java/nl/nn/adapterframework/webcontrol/api/AuthorizationFilter.java", "diffHunk": "@@ -93,13 +94,13 @@ public void filter(ContainerRequestContext requestContext) throws IOException {\n \t\t\t\t\trequestContext.abortWith(UNAUTHORIZED);\n \t\t\t\t\treturn;\n \t\t\t\t} else {\n-\t\t\t\t\tSystem.out.println(\"manually logged in user [\" + securityContext.getUserPrincipal().getName()+\"]\");\n+\t\t\t\t\tlog.info(\"manually logged in user [\" + securityContext.getUserPrincipal().getName()+\"]\");\n \t\t\t\t}\n \t\t\t}\n \n \t\t\tRolesAllowed rolesAnnotation = method.getAnnotation(RolesAllowed.class);\n \t\t\tSet<String> rolesSet = new HashSet<String>(Arrays.asList(rolesAnnotation.value()));\n-\t\t\tSystem.out.println(\"Checking authentication for user [\"+securityContext.getUserPrincipal().getName()+\"] uri [\"+method.getAnnotation(javax.ws.rs.Path.class).value()+\"] roles \" + rolesSet.toString());\n+\t\t\tlog.info(\"checking authentication for user [\"+securityContext.getUserPrincipal().getName()+\"] on uri [\"+method.getAnnotation(javax.ws.rs.Path.class).value()+\"] required roles \" + rolesSet.toString());", "originalCommit": "17ae578c0b77e58134e39b5fddd392cbcf8f6f85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8283df2b05ba2a32a847624cbf392ee05de886fc", "url": "https://github.com/ibissource/iaf/commit/8283df2b05ba2a32a847624cbf392ee05de886fc", "message": "Add test assertions", "committedDate": "2020-07-08T15:12:43Z", "type": "commit"}]}