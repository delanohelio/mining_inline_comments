{"pr_number": 529, "pr_title": "Add ability to run the framework without a database", "pr_createdAt": "2020-03-23T08:46:34Z", "pr_url": "https://github.com/ibissource/iaf/pull/529", "timeline": [{"oid": "ab33af1eec3db0476767ece366ee1bc67162221b", "url": "https://github.com/ibissource/iaf/commit/ab33af1eec3db0476767ece366ee1bc67162221b", "message": "Remove IAF_Util dependency from main configuration", "committedDate": "2020-03-17T18:56:58Z", "type": "commit"}, {"oid": "5555be225e3a7382d21decff009c09b5974c792a", "url": "https://github.com/ibissource/iaf/commit/5555be225e3a7382d21decff009c09b5974c792a", "message": "Remove database requirement on startup", "committedDate": "2020-03-19T11:15:08Z", "type": "commit"}, {"oid": "95195212f4519f385deb95bb790aec6f927e537a", "url": "https://github.com/ibissource/iaf/commit/95195212f4519f385deb95bb790aec6f927e537a", "message": "Add is-database-present check", "committedDate": "2020-03-19T14:54:14Z", "type": "commit"}, {"oid": "ca67dcc6789cd688d9009adb8e4e4d55735bd7f5", "url": "https://github.com/ibissource/iaf/commit/ca67dcc6789cd688d9009adb8e4e4d55735bd7f5", "message": "Change order of elements", "committedDate": "2020-03-23T09:46:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5ODk0MA==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396498940", "bodyText": "Ik denk dat als connection!=null, dat je hem dan moet close()en.", "author": "gvanbrakel", "createdAt": "2020-03-23T14:37:59Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/JdbcSenderBase.java", "diffHunk": "@@ -81,14 +80,19 @@ public void configure() throws ConfigurationException {\n \n \t@Override\n \tpublic void open() throws SenderException {\n-\t\tif (!isConnectionsArePooled()) {\n-\t\t\ttry {\n-\t\t\t\tconnection = getConnection();\n-\t\t\t} catch (JdbcException e) {\n-\t\t\t\tthrow new SenderException(e);\n-\t\t\t}\n+\t\ttry {\n+\t\t\tconnection = getConnection();\n+\t\t\tconnection.getMetaData(); //We have to perform some DB action, it could be stale or not present (yet)\n+\t\t} catch (Throwable t) {\n+\t\t\tconnection = null;", "originalCommit": "ca67dcc6789cd688d9009adb8e4e4d55735bd7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxODk1MQ==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396518951", "bodyText": "Ja klopt, voorheen riep ik al de close aan, maar heb daar een if statement omheen gebouwd waardoor die niet altijd geraakt wordt.... zal het aanpassen!", "author": "nielsm5", "createdAt": "2020-03-23T15:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5ODk0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5OTY5OA==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396499698", "bodyText": "Van waar deze bazooka?", "author": "gvanbrakel", "createdAt": "2020-03-23T14:38:57Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/migration/Migrator.java", "diffHunk": "@@ -74,15 +73,15 @@ public synchronized void configure(String configurationName, ClassLoader classLo\n \t\t\t\tJdbcConnection connection = new JdbcConnection(getConnection());\n \t\t\t\tinstance = new LiquibaseImpl(ibisContext, cl, connection, configurationName, changeLogFile);\n \t\t\t}\n-\t\t\tcatch (JdbcException e) {\n-\t\t\t\tthrow new ConfigurationException(\"migrator error connecting to database [\"+dataSource+\"]\", e);\n-\t\t\t}\n \t\t\tcatch (ValidationFailedException e) {\n \t\t\t\tthrow new ConfigurationException(\"liquibase validation failed\", e);\n \t\t\t}\n \t\t\tcatch (LiquibaseException e) {\n \t\t\t\tthrow new ConfigurationException(\"liquibase failed to initialize\", e);\n \t\t\t}\n+\t\t\tcatch (Throwable e) {", "originalCommit": "ca67dcc6789cd688d9009adb8e4e4d55735bd7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNDY1Ng==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396524656", "bodyText": "Ergens diep onderwater gooit Liquibase een RuntimeException. Ik dacht voor de zekerheid als het niet lukt, vang ik deze excepties, anders laad de configuratie niet in.", "author": "nielsm5", "createdAt": "2020-03-23T15:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5OTY5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMDU4Mw==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396500583", "bodyText": "waarom deze twee hier toegevoegd, en uit de config verwijderd?", "author": "gvanbrakel", "createdAt": "2020-03-23T14:40:06Z", "path": "core/src/main/java/nl/nn/adapterframework/scheduler/SchedulerFactoryBean.java", "diffHunk": "@@ -35,4 +39,13 @@ public void afterPropertiesSet() throws Exception {\n \t\t\tthrow e;\n \t\t}\n \t}\n+\n+\t@Override\n+\tpublic void setDataSource(DataSource dataSource) {\n+\t\t//Make sure this isn't autowired by Spring\n+\t}\n+\t@Override\n+\tpublic void setTransactionManager(PlatformTransactionManager transactionManager) {\n+\t\t//Make sure this isn't autowired by Spring\n+\t}", "originalCommit": "ca67dcc6789cd688d9009adb8e4e4d55735bd7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyODYzOQ==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396528639", "bodyText": "Het zomaar zou kunnen dat iemand custom code oid heeft, en dan alles kapot maakt. Het is ook een voorzorgsmaatregel, als wij Spring autowire ooit aan gaan zetten, dat deze properties niet gezet worden.", "author": "nielsm5", "createdAt": "2020-03-23T15:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMDU4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMTcwMg==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396501702", "bodyText": "requiresDatabase hoeft niet te betekenen dat er ook een transactiemanager moet zijn.", "author": "gvanbrakel", "createdAt": "2020-03-23T14:41:36Z", "path": "core/src/main/java/nl/nn/adapterframework/unmanaged/DefaultIbisManager.java", "diffHunk": "@@ -462,4 +465,13 @@ public void setApplicationEventPublisher(ApplicationEventPublisher applicationEv\n \tpublic ApplicationEventPublisher getApplicationEventPublisher() {\n \t\treturn applicationEventPublisher;\n \t}\n+\n+\t@Override\n+\tpublic void afterPropertiesSet() throws Exception {\n+\t\tboolean requiresDatabase = AppConstants.getInstance().getBoolean(\"jdbc.required\", true);\n+\t\tif(requiresDatabase) {", "originalCommit": "ca67dcc6789cd688d9009adb8e4e4d55735bd7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNTc1OA==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396525758", "bodyText": "Nee klopt maar die is er standaard vanwege Spring, de IbisManager heeft geen datasource maar wel een transactiemanager.\nDeze zelfde check werd eerst door de scheduler gedaan om te controlleren of er een database was.", "author": "nielsm5", "createdAt": "2020-03-23T15:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMTcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMjE0NQ==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396502145", "bodyText": "Waarom moet dit, en hoefde het eerst niet?", "author": "gvanbrakel", "createdAt": "2020-03-23T14:42:11Z", "path": "core/src/main/resources/AppConstants.properties", "diffHunk": "@@ -29,9 +29,8 @@ instance.timestamp=\n #Deprecated should be automatically determined by the instance.version and instance.timestamp properties (typically automatically generated and stored in BuildInfo.properties)\n instance.build_id=not-used\n \n-configurations.names.application=IAF_WebControl,${configurations.names},IAF_Util\n+configurations.names.application=IAF_WebControl,IAF_Util,${configurations.names}", "originalCommit": "ca67dcc6789cd688d9009adb8e4e4d55735bd7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNjY4MA==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r396526680", "bodyText": "Vroeger moest eerst de 'main/hoofd' configuratie (die op het classpath staat) ingeladen worden met een jmsRealm er in. Nu hoeft dat niet meer. Ik vind dat het mooier is als de IAF configuraties eerst inladen.", "author": "nielsm5", "createdAt": "2020-03-23T15:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNjgxOQ==", "url": "https://github.com/ibissource/iaf/pull/529#discussion_r397026819", "bodyText": "Ah, zie nu wat er gebeurt is. Is alleen volgorde verandering. Ik had verkeerd gekeken, en dacht dat ${configurations.names} erbij was gekomen, maar dus alleen maar verplaatst.", "author": "gvanbrakel", "createdAt": "2020-03-24T09:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMjE0NQ=="}], "type": "inlineReview"}, {"oid": "17958a3c50715c5ad948833222a532c6b1c2fe0c", "url": "https://github.com/ibissource/iaf/commit/17958a3c50715c5ad948833222a532c6b1c2fe0c", "message": "Close connection", "committedDate": "2020-03-23T15:15:04Z", "type": "commit"}]}