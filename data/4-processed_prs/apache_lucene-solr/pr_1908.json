{"pr_number": 1908, "pr_title": "LUCENE-9539: Use more compact datastructures for sorting doc-values", "pr_createdAt": "2020-09-22T08:52:16Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1908", "timeline": [{"oid": "a1a40c8426a26c2b0ffbfc756306c23c6d603cc9", "url": "https://github.com/apache/lucene-solr/commit/a1a40c8426a26c2b0ffbfc756306c23c6d603cc9", "message": "LUCENE-9539: Use more compact datastructures for sorting doc-values", "committedDate": "2020-09-22T08:50:30Z", "type": "commit"}, {"oid": "9480aca9637c910f21a5e8e20be3ba75861e4916", "url": "https://github.com/apache/lucene-solr/commit/9480aca9637c910f21a5e8e20be3ba75861e4916", "message": "fix imports", "committedDate": "2020-09-22T09:41:53Z", "type": "commit"}, {"oid": "2f571593b2721e46d45f4a2b53e0771c3e21ad8e", "url": "https://github.com/apache/lucene-solr/commit/2f571593b2721e46d45f4a2b53e0771c3e21ad8e", "message": "fix some style issues'", "committedDate": "2020-09-22T09:44:10Z", "type": "commit"}, {"oid": "adb99b54d3f7241072be87c65f76420d04af904e", "url": "https://github.com/apache/lucene-solr/commit/adb99b54d3f7241072be87c65f76420d04af904e", "message": "improve loop readablility", "committedDate": "2020-09-22T09:52:14Z", "type": "commit"}, {"oid": "dab213768c76533f7935f2371b8e452c2ff30d64", "url": "https://github.com/apache/lucene-solr/commit/dab213768c76533f7935f2371b8e452c2ff30d64", "message": "remove imports", "committedDate": "2020-09-22T09:54:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0ODg4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1908#discussion_r492648887", "bodyText": "Technically you could also have a sign switch as boundary (~value marks first value) but I don't think it'd result in any savings and would only complicate the value stream.", "author": "dweiss", "createdAt": "2020-09-22T11:05:26Z", "path": "lucene/core/src/java/org/apache/lucene/index/SortedSetDocValuesWriter.java", "diffHunk": "@@ -379,4 +352,31 @@ public long getValueCount() {\n       return in.getValueCount();\n     }\n   }\n+\n+  static final class DocOrds {\n+    final long[] offsets;\n+    final PackedLongValues ords;\n+\n+    DocOrds(int maxDoc, Sorter.DocMap sortMap, SortedSetDocValues oldValues, float acceptableOverheadRatio) throws IOException {\n+      offsets = new long[maxDoc];\n+      PackedLongValues.Builder builder = PackedLongValues.packedBuilder(acceptableOverheadRatio);\n+      long ordOffset = 1; // 0 marks docs with no values\n+      int docID;\n+      while ((docID = oldValues.nextDoc()) != NO_MORE_DOCS) {\n+        int newDocID = sortMap.oldToNew(docID);\n+        long startOffset = ordOffset;\n+        long ord;\n+        while ((ord = oldValues.nextOrd()) != NO_MORE_ORDS) {\n+          builder.add(ord + 1);\n+          ordOffset++;\n+        }\n+        if (startOffset != ordOffset) { // do we have any values?\n+          offsets[newDocID] = startOffset;\n+          builder.add(0); // 0 ord marks next value", "originalCommit": "dab213768c76533f7935f2371b8e452c2ff30d64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxOTk2OA==", "url": "https://github.com/apache/lucene-solr/pull/1908#discussion_r492719968", "bodyText": "agreed, I didn't do it since it would have impacted readability too much IMO", "author": "s1monw", "createdAt": "2020-09-22T13:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0ODg4Nw=="}], "type": "inlineReview"}, {"oid": "bb93c1276c39709fb670d39f72bf99695c4069fd", "url": "https://github.com/apache/lucene-solr/commit/bb93c1276c39709fb670d39f72bf99695c4069fd", "message": "add changes", "committedDate": "2020-09-22T13:08:09Z", "type": "commit"}, {"oid": "890dc2266e2d92778a288ef2f9a7d19fd63425c3", "url": "https://github.com/apache/lucene-solr/commit/890dc2266e2d92778a288ef2f9a7d19fd63425c3", "message": "Merge branch 'master' into LUCENE-9539", "committedDate": "2020-09-22T13:09:47Z", "type": "commit"}]}