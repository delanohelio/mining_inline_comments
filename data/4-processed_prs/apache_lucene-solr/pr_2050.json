{"pr_number": 2050, "pr_title": "SOLR-14926: Modernize and clean up search results clustering contrib.", "pr_createdAt": "2020-10-30T12:36:09Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2050", "timeline": [{"oid": "f0143287d5d7d9f678370dbabf2925882bae6c85", "url": "https://github.com/apache/lucene-solr/commit/f0143287d5d7d9f678370dbabf2925882bae6c85", "message": "SOLR-14926: Modernize and clean up search results clustering contrib.\n\nThis issue upgrades the clustering contrib to the new Carrot2 4.x line,\ndropping several CVE-prone dependencies along the way.\n\nThe parameters and configuration of the contrib extensions have changed.\nThe documentation in Solr ref guide has been rewritten from scratch to be up to date.\n\nClustering code has been rewritten from scratch to work properly regardless\nof the mode (standalone, distributed).\n\nThe API has been stripped of ancient, unused, interfaces and simplified.", "committedDate": "2020-10-30T12:34:18Z", "type": "commit"}, {"oid": "30563ea214a80126f5b7043e263b705356fad70a", "url": "https://github.com/apache/lucene-solr/commit/30563ea214a80126f5b7043e263b705356fad70a", "message": "Merging against master.", "committedDate": "2020-10-30T12:40:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEyNDI2Nw==", "url": "https://github.com/apache/lucene-solr/pull/2050#discussion_r515124267", "bodyText": "NULL_DEREFERENCE:  object returned by params.getBool(\"clustering.includeOtherTopics\") could be null and is dereferenced at line 178.", "author": "sonatype-lift", "createdAt": "2020-10-30T14:07:48Z", "path": "solr/contrib/clustering/src/java/org/apache/solr/handler/clustering/EngineParameters.java", "diffHunk": "@@ -0,0 +1,353 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.handler.clustering;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.solr.common.params.SolrParams;\n+\n+import java.util.Arrays;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * {@link Engine} configuration parameters (and other parameters that\n+ * may tweak clustering algorithms on a per-request basis).\n+ *\n+ * @lucene.experimental\n+ */\n+public final class EngineParameters implements Cloneable {\n+  /**\n+   * Common prefix for configuration of engine settings.\n+   */\n+  private static final String PARAM_PREFIX = \"clustering.\";\n+\n+  /**\n+   * @see #algorithmName()\n+   */\n+  public static final String PARAM_ALGORITHM = PARAM_PREFIX + \"algorithm\";\n+\n+  /**\n+   * @see #maxLabels()\n+   */\n+  public static final String PARAM_MAX_LABELS = PARAM_PREFIX + \"maxLabels\";\n+\n+  /**\n+   * @see #includeSubclusters()\n+   */\n+  public static final String PARAM_INCLUDE_SUBCLUSTERS = PARAM_PREFIX + \"includeSubclusters\";\n+\n+  /**\n+   * @see #includeOtherTopics()\n+   */\n+  public static final String PARAM_INCLUDE_OTHER_TOPICS = PARAM_PREFIX + \"includeOtherTopics\";\n+\n+  /**\n+   * @see #language()\n+   */\n+  public static final String PARAM_LANGUAGE = PARAM_PREFIX + \"language\";\n+\n+  /**\n+   * @see #languageField()\n+   */\n+  public static final String PARAM_LANGUAGE_FIELD = PARAM_PREFIX + \"languageField\";\n+\n+  /**\n+   * @see #resources()\n+   */\n+  public static final String PARAM_RESOURCES = PARAM_PREFIX + \"resources\";\n+\n+  /**\n+   * @see #fields()\n+   */\n+  public static final String PARAM_FIELDS = PARAM_PREFIX + \"fields\";\n+\n+  /**\n+   * @see #preferQueryContext()\n+   */\n+  public static final String PARAM_PREFER_QUERY_CONTEXT = PARAM_PREFIX + \"preferQueryContext\";\n+\n+  /**\n+   * @see #contextSize()\n+   */\n+  public static final String PARAM_CONTEXT_SIZE = PARAM_PREFIX + \"contextSize\";\n+\n+  /**\n+   * @see #contextCount()\n+   */\n+  public static final String PARAM_CONTEXT_COUNT = PARAM_PREFIX + \"contextCount\";\n+\n+  /**\n+   * @see #PARAM_MAX_LABELS\n+   */\n+  private int maxLabels = Integer.MAX_VALUE;\n+\n+  /**\n+   * @see #PARAM_INCLUDE_SUBCLUSTERS\n+   */\n+  private boolean includeSubclusters = true;\n+\n+  /**\n+   * @see #PARAM_INCLUDE_OTHER_TOPICS\n+   */\n+  private boolean includeOtherTopics = true;\n+\n+  /**\n+   * @see #PARAM_ALGORITHM\n+   */\n+  private String algorithmName;\n+\n+  /**\n+   * @see #PARAM_RESOURCES\n+   */\n+  private String resources;\n+\n+  /**\n+   * @see #PARAM_LANGUAGE\n+   */\n+  private String language = \"English\";\n+\n+  /**\n+   * @see #PARAM_LANGUAGE_FIELD\n+   */\n+  private String languageField;\n+\n+  /**\n+   * @see #PARAM_PREFER_QUERY_CONTEXT\n+   */\n+  private boolean preferQueryContext;\n+\n+  /**\n+   * @see #PARAM_CONTEXT_SIZE\n+   */\n+  private int contextSize = 80 * 4;\n+\n+  /**\n+   * @see #PARAM_CONTEXT_COUNT\n+   */\n+  private int contextCount = 3;\n+\n+  /**\n+   * @see #PARAM_FIELDS\n+   */\n+  private LinkedHashSet<String> fields = new LinkedHashSet<>();\n+\n+  /**\n+   * Non-engine configuration parameters (algorithm parameters).\n+   */\n+  private LinkedHashMap<String, String> otherParameters = new LinkedHashMap<>();\n+\n+  /**\n+   * Unique-value document identifier field. This is required for clustering since clusters\n+   * only reference documents by their ID field's value.\n+   */\n+  private String docIdField;\n+\n+  EngineParameters(SolrParams params) {\n+    extractFrom(params);\n+  }\n+\n+  /**\n+   * Extract parameter values from the given {@link SolrParams}.\n+   */\n+  private EngineParameters extractFrom(SolrParams params) {\n+    params.stream().forEachOrdered(e -> {\n+      switch (e.getKey()) {\n+        case PARAM_MAX_LABELS:\n+          maxLabels = params.getInt(PARAM_MAX_LABELS);\n+          break;\n+        case PARAM_INCLUDE_SUBCLUSTERS:\n+          includeSubclusters = params.getBool(PARAM_INCLUDE_SUBCLUSTERS);\n+          break;\n+        case PARAM_INCLUDE_OTHER_TOPICS:\n+          includeOtherTopics = params.getBool(PARAM_INCLUDE_OTHER_TOPICS);", "originalCommit": "30563ea214a80126f5b7043e263b705356fad70a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEyNDI4MQ==", "url": "https://github.com/apache/lucene-solr/pull/2050#discussion_r515124281", "bodyText": "NULL_DEREFERENCE:  object returned by params.getBool(\"clustering.includeSubclusters\") could be null and is dereferenced at line 175.", "author": "sonatype-lift", "createdAt": "2020-10-30T14:07:49Z", "path": "solr/contrib/clustering/src/java/org/apache/solr/handler/clustering/EngineParameters.java", "diffHunk": "@@ -0,0 +1,353 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.handler.clustering;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.solr.common.params.SolrParams;\n+\n+import java.util.Arrays;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * {@link Engine} configuration parameters (and other parameters that\n+ * may tweak clustering algorithms on a per-request basis).\n+ *\n+ * @lucene.experimental\n+ */\n+public final class EngineParameters implements Cloneable {\n+  /**\n+   * Common prefix for configuration of engine settings.\n+   */\n+  private static final String PARAM_PREFIX = \"clustering.\";\n+\n+  /**\n+   * @see #algorithmName()\n+   */\n+  public static final String PARAM_ALGORITHM = PARAM_PREFIX + \"algorithm\";\n+\n+  /**\n+   * @see #maxLabels()\n+   */\n+  public static final String PARAM_MAX_LABELS = PARAM_PREFIX + \"maxLabels\";\n+\n+  /**\n+   * @see #includeSubclusters()\n+   */\n+  public static final String PARAM_INCLUDE_SUBCLUSTERS = PARAM_PREFIX + \"includeSubclusters\";\n+\n+  /**\n+   * @see #includeOtherTopics()\n+   */\n+  public static final String PARAM_INCLUDE_OTHER_TOPICS = PARAM_PREFIX + \"includeOtherTopics\";\n+\n+  /**\n+   * @see #language()\n+   */\n+  public static final String PARAM_LANGUAGE = PARAM_PREFIX + \"language\";\n+\n+  /**\n+   * @see #languageField()\n+   */\n+  public static final String PARAM_LANGUAGE_FIELD = PARAM_PREFIX + \"languageField\";\n+\n+  /**\n+   * @see #resources()\n+   */\n+  public static final String PARAM_RESOURCES = PARAM_PREFIX + \"resources\";\n+\n+  /**\n+   * @see #fields()\n+   */\n+  public static final String PARAM_FIELDS = PARAM_PREFIX + \"fields\";\n+\n+  /**\n+   * @see #preferQueryContext()\n+   */\n+  public static final String PARAM_PREFER_QUERY_CONTEXT = PARAM_PREFIX + \"preferQueryContext\";\n+\n+  /**\n+   * @see #contextSize()\n+   */\n+  public static final String PARAM_CONTEXT_SIZE = PARAM_PREFIX + \"contextSize\";\n+\n+  /**\n+   * @see #contextCount()\n+   */\n+  public static final String PARAM_CONTEXT_COUNT = PARAM_PREFIX + \"contextCount\";\n+\n+  /**\n+   * @see #PARAM_MAX_LABELS\n+   */\n+  private int maxLabels = Integer.MAX_VALUE;\n+\n+  /**\n+   * @see #PARAM_INCLUDE_SUBCLUSTERS\n+   */\n+  private boolean includeSubclusters = true;\n+\n+  /**\n+   * @see #PARAM_INCLUDE_OTHER_TOPICS\n+   */\n+  private boolean includeOtherTopics = true;\n+\n+  /**\n+   * @see #PARAM_ALGORITHM\n+   */\n+  private String algorithmName;\n+\n+  /**\n+   * @see #PARAM_RESOURCES\n+   */\n+  private String resources;\n+\n+  /**\n+   * @see #PARAM_LANGUAGE\n+   */\n+  private String language = \"English\";\n+\n+  /**\n+   * @see #PARAM_LANGUAGE_FIELD\n+   */\n+  private String languageField;\n+\n+  /**\n+   * @see #PARAM_PREFER_QUERY_CONTEXT\n+   */\n+  private boolean preferQueryContext;\n+\n+  /**\n+   * @see #PARAM_CONTEXT_SIZE\n+   */\n+  private int contextSize = 80 * 4;\n+\n+  /**\n+   * @see #PARAM_CONTEXT_COUNT\n+   */\n+  private int contextCount = 3;\n+\n+  /**\n+   * @see #PARAM_FIELDS\n+   */\n+  private LinkedHashSet<String> fields = new LinkedHashSet<>();\n+\n+  /**\n+   * Non-engine configuration parameters (algorithm parameters).\n+   */\n+  private LinkedHashMap<String, String> otherParameters = new LinkedHashMap<>();\n+\n+  /**\n+   * Unique-value document identifier field. This is required for clustering since clusters\n+   * only reference documents by their ID field's value.\n+   */\n+  private String docIdField;\n+\n+  EngineParameters(SolrParams params) {\n+    extractFrom(params);\n+  }\n+\n+  /**\n+   * Extract parameter values from the given {@link SolrParams}.\n+   */\n+  private EngineParameters extractFrom(SolrParams params) {\n+    params.stream().forEachOrdered(e -> {\n+      switch (e.getKey()) {\n+        case PARAM_MAX_LABELS:\n+          maxLabels = params.getInt(PARAM_MAX_LABELS);\n+          break;\n+        case PARAM_INCLUDE_SUBCLUSTERS:\n+          includeSubclusters = params.getBool(PARAM_INCLUDE_SUBCLUSTERS);", "originalCommit": "30563ea214a80126f5b7043e263b705356fad70a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEyNDMxMA==", "url": "https://github.com/apache/lucene-solr/pull/2050#discussion_r515124310", "bodyText": "PATH_TRAVERSAL_IN:  This API (java/nio/file/Paths.get(Ljava/lang/String;[Ljava/lang/String;)Ljava/nio/file/Path;) reads a file whose location might be specified by user input (details)", "author": "sonatype-lift", "createdAt": "2020-10-30T14:07:52Z", "path": "solr/contrib/clustering/src/java/org/apache/solr/handler/clustering/EngineContext.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.handler.clustering;\n+\n+import org.apache.solr.core.SolrCore;\n+import org.carrot2.clustering.ClusteringAlgorithm;\n+import org.carrot2.clustering.ClusteringAlgorithmProvider;\n+import org.carrot2.clustering.kmeans.BisectingKMeansClusteringAlgorithm;\n+import org.carrot2.clustering.lingo.LingoClusteringAlgorithm;\n+import org.carrot2.clustering.stc.STCClusteringAlgorithm;\n+import org.carrot2.language.LanguageComponents;\n+import org.carrot2.language.LanguageComponentsLoader;\n+import org.carrot2.language.LoadedLanguages;\n+import org.carrot2.util.ChainedResourceLookup;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.ServiceLoader;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Clustering engine context: algorithms, preloaded language\n+ * resources and initial validation.\n+ */\n+final class EngineContext {\n+  private static final Logger log = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  private final LinkedHashMap<String, LanguageComponents> languages;\n+  private final Map<String, ClusteringAlgorithmProvider> algorithmProviders;\n+\n+  private final static Map<String, String> aliasedNames;\n+\n+  static {\n+    aliasedNames = new HashMap<>();\n+    aliasedNames.put(LingoClusteringAlgorithm.class.getName(), LingoClusteringAlgorithm.NAME);\n+    aliasedNames.put(STCClusteringAlgorithm.class.getName(), STCClusteringAlgorithm.NAME);\n+    aliasedNames.put(BisectingKMeansClusteringAlgorithm.class.getName(), BisectingKMeansClusteringAlgorithm.NAME);\n+  }\n+\n+  EngineContext(String resourcesPath, SolrCore core) {\n+    LanguageComponentsLoader loader = LanguageComponents.loader();\n+\n+    List<Path> resourceLocations = new ArrayList<>();\n+\n+    Path configDir = Paths.get(core.getResourceLoader().getConfigDir());", "originalCommit": "30563ea214a80126f5b7043e263b705356fad70a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4e3c7acc7adda647c636eadc00ced5eebbb3c8f0", "url": "https://github.com/apache/lucene-solr/commit/4e3c7acc7adda647c636eadc00ced5eebbb3c8f0", "message": "SOLR-14926: Moving changes entry to master since backport is non-trivial (Java 11 requirement).", "committedDate": "2020-10-30T14:32:08Z", "type": "commit"}, {"oid": "0acbd240b250f8981f982c7a6080b22ad8da0a00", "url": "https://github.com/apache/lucene-solr/commit/0acbd240b250f8981f982c7a6080b22ad8da0a00", "message": "Change API version change to 9.0.", "committedDate": "2020-10-30T14:35:22Z", "type": "commit"}, {"oid": "fc8ddb89844591fcb41967404f2f61ca6bb667e6", "url": "https://github.com/apache/lucene-solr/commit/fc8ddb89844591fcb41967404f2f61ca6bb667e6", "message": "Merge remote-tracking branch 'origin/master' into SOLR-14926", "committedDate": "2020-11-03T08:31:00Z", "type": "commit"}]}