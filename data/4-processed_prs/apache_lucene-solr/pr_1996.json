{"pr_number": 1996, "pr_title": "SOLR-14907: Adding V2 API for ConfigSet Upload.", "pr_createdAt": "2020-10-16T17:31:47Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1996", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r507004619", "bodyText": "Let's use a proper REST mechanism here\npath =\"/cluster/configs/{configname}/*", "author": "noblepaul", "createdAt": "2020-10-18T01:49:59Z", "path": "solr/core/src/java/org/apache/solr/handler/ClusterAPI.java", "diffHunk": "@@ -133,6 +134,62 @@ public void create(PayloadObj<CreateConfigInfo> obj) throws Exception {\n \n   }\n \n+  @EndPoint(method = POST,\n+      path =   \"/cluster/configs/{name}\",\n+      permission = CONFIG_EDIT_PERM\n+  )\n+  public void uploadConfigSet(SolrQueryRequest req, SolrQueryResponse rsp) throws Exception {\n+    req = wrapParams(req,\n+            \"action\", ConfigSetParams.ConfigSetAction.UPLOAD.toString(),\n+            CommonParams.NAME, req.getPathTemplateValues().get(\"name\"));\n+    configSetsHandler.handleRequestBody(req, rsp);\n+  }\n+\n+  @EndPoint(method = PUT,\n+      path =   \"/cluster/configs/{name}\",\n+      permission = CONFIG_EDIT_PERM\n+  )\n+  public void uploadConfigSetWithOverwrite(SolrQueryRequest req, SolrQueryResponse rsp) throws Exception {\n+    req = wrapParams(req,\n+            \"action\", ConfigSetParams.ConfigSetAction.UPLOAD.toString(),\n+            CommonParams.NAME, req.getPathTemplateValues().get(\"name\"),\n+            ConfigSetParams.OVERWRITE, true,\n+            ConfigSetParams.CLEANUP, req.getParams().getBool(ConfigSetParams.CLEANUP, false));\n+    configSetsHandler.handleRequestBody(req, rsp);\n+  }\n+\n+  @EndPoint(method = POST,", "originalCommit": "37c2a5f63b88111fdffc28ce361045346760f4c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxNDA5MQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r507814091", "bodyText": "Would you be ok with /cluster/configs/{configname}/files/*? That's very restful, since it would be updating the * file under the {configname} config", "author": "HoustonPutman", "createdAt": "2020-10-19T14:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNzIwOQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r507907209", "bodyText": "I've updated the PR to reflect this new API.", "author": "HoustonPutman", "createdAt": "2020-10-19T16:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODExNjU4Mw==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r508116583", "bodyText": "I'm Ok with both\n/cluster/configs/{configname}/files/*\nand\n/cluster/configs/{configname}/*\n@janhoy @dsmiley @sigram  WDYT?", "author": "noblepaul", "createdAt": "2020-10-19T23:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE4NjYxNw==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r508186617", "bodyText": "I don't see the point of the \"/files/\" component of the path.  The files within the configSet are directly in it, so I think it should be that way.  I think of this very much like a file in a folder, where the folder is the configSet.\nJust checking that we support nested structure within the configSet?", "author": "dsmiley", "createdAt": "2020-10-20T03:25:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIwMzQzMA==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r508203430", "bodyText": "We do support the nested structure.\nThe /files/ part defines what the * after it is, and allows us to extend in the future. For example possible adding a /cluster/configs/{configname}/properties PUT action to update the properties for that config. It fits pretty well in the guidelines.\nIt's not that important to me though if y'all agree with taking it out.", "author": "HoustonPutman", "createdAt": "2020-10-20T04:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIwODU2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r508208566", "bodyText": "Just checking that we support nested structure within the configSet?\n\nWe could. But, I'm OK to add support for that later", "author": "noblepaul", "createdAt": "2020-10-20T04:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ3NTE4NQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r508475185", "bodyText": "To support properties manipulation in the future, I think that could be done via a POST to the particular path to the properties file in the configSet (I forget if it exists already or maybe should be exactly params.json) with commands in the JSON to delete/set/update etc.", "author": "dsmiley", "createdAt": "2020-10-20T12:53:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwOTUxMg==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r508509512", "bodyText": "Ok sounds good, that would certainly work. I'll take out the /files/ part of the path, and update the PR and Jira.", "author": "HoustonPutman", "createdAt": "2020-10-20T13:37:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0NTM5MQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r509145391", "bodyText": "I'm not a REST specialist but I think I would prefer to leave the files component of the path in. Wouldn't this allow changing other things in the future and make the API more self describing?\nWould it really be easy to add it later?\nIf we wanted to add properties for example, how to tell if /cluster/configs/{configname}/properties/whatever is a property whatever or if properties/whatever is actually a file?", "author": "murblanc", "createdAt": "2020-10-21T09:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0NjcxMA==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r509146710", "bodyText": "Also \"file\" is a pretty generic abstraction that can represent many things (a schema, properties, synonyms etc). We might eventually want to address such ressources by what they actually are (schema, properties, synonyms) rather than by the way in which they are stored (files).", "author": "murblanc", "createdAt": "2020-10-21T09:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzNjkwMQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r509536901", "bodyText": "I agree @murblanc, it lets us future-proof the API even if we don't have current plans on expanding beyond files.", "author": "HoustonPutman", "createdAt": "2020-10-21T18:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTU2MjkwMQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r509562901", "bodyText": "All very debatable of course.  Removing \"/files/\" doesn't prevent expanding beyond files, it's just that, for example, if we add a POST to say /configsetname/properties then we can't have a file named simply \"properties\".  I will shed no tear  over this loss :-).  I like the simplicity of not having the needless \"/files/\".", "author": "dsmiley", "createdAt": "2020-10-21T18:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyOTc0MQ==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r509629741", "bodyText": "@dsmiley, can users of Solr pick random names for some ConfigSet files? I believe code will be easier to understand/maintain if we don't have to parse file names to detect if they are files or some other form of separator (and then the API would be inconsistent: files will not have its /files segment in the path whereas properties will be defined after /properties).\nExamples in https://restfulapi.net/resource-naming/ would be a vote for keeping /files in the path IMO.", "author": "murblanc", "createdAt": "2020-10-21T19:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY2NzA1Mw==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r509667053", "bodyText": "People can add basically whatever named files they want and reference them from the primary config files (e.g. solrconfig.xml).  This discussion is similar to field naming in our schema.  Some names are special, like _version_.  If you try to have your own field named as such, then you're asking for trouble.  Likewise, we might suggest that users avoid file names with a leading underscore.  Simple enough and keeps the \"/files\" verbosity out.  Also there is a difference in HTTP verbs... in this issue here we're using PUT to put a file.  But for an interactive editing of config elements, that would use POST.", "author": "dsmiley", "createdAt": "2020-10-21T20:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNDY1Ng==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r507004656", "bodyText": "same as above", "author": "noblepaul", "createdAt": "2020-10-18T01:50:12Z", "path": "solr/core/src/java/org/apache/solr/handler/ClusterAPI.java", "diffHunk": "@@ -133,6 +134,62 @@ public void create(PayloadObj<CreateConfigInfo> obj) throws Exception {\n \n   }\n \n+  @EndPoint(method = POST,\n+      path =   \"/cluster/configs/{name}\",\n+      permission = CONFIG_EDIT_PERM\n+  )\n+  public void uploadConfigSet(SolrQueryRequest req, SolrQueryResponse rsp) throws Exception {\n+    req = wrapParams(req,\n+            \"action\", ConfigSetParams.ConfigSetAction.UPLOAD.toString(),\n+            CommonParams.NAME, req.getPathTemplateValues().get(\"name\"));\n+    configSetsHandler.handleRequestBody(req, rsp);\n+  }\n+\n+  @EndPoint(method = PUT,\n+      path =   \"/cluster/configs/{name}\",\n+      permission = CONFIG_EDIT_PERM\n+  )\n+  public void uploadConfigSetWithOverwrite(SolrQueryRequest req, SolrQueryResponse rsp) throws Exception {\n+    req = wrapParams(req,\n+            \"action\", ConfigSetParams.ConfigSetAction.UPLOAD.toString(),\n+            CommonParams.NAME, req.getPathTemplateValues().get(\"name\"),\n+            ConfigSetParams.OVERWRITE, true,\n+            ConfigSetParams.CLEANUP, req.getParams().getBool(ConfigSetParams.CLEANUP, false));\n+    configSetsHandler.handleRequestBody(req, rsp);\n+  }\n+\n+  @EndPoint(method = POST,\n+      path =   \"/cluster/configs/{name}/file\",\n+      permission = CONFIG_EDIT_PERM\n+  )\n+  public void insertIntoConfigSet(SolrQueryRequest req, SolrQueryResponse rsp) throws Exception {\n+    String path = req.getParams().get(ConfigSetParams.PATH);\n+    if (path == null || path.isBlank()) {\n+      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST, \"In order to insert a file into a configSet, a valid 'path' parameter must be provided.\");\n+    }\n+    req = wrapParams(req,\n+            \"action\", ConfigSetParams.ConfigSetAction.UPLOAD.toString(),\n+            CommonParams.NAME, req.getPathTemplateValues().get(\"name\"));\n+    configSetsHandler.handleRequestBody(req, rsp);\n+  }\n+\n+  @EndPoint(method = PUT,\n+      path =   \"/cluster/configs/{name}/file\",", "originalCommit": "37c2a5f63b88111fdffc28ce361045346760f4c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "828cdfcedc18831508ca5f917b659629c3962f6b", "url": "https://github.com/apache/lucene-solr/commit/828cdfcedc18831508ca5f917b659629c3962f6b", "message": "Adding V2 API for ConfigSet Upload.", "committedDate": "2020-11-02T17:10:35Z", "type": "commit"}, {"oid": "75915c66eeca91ba01eae0092404e83a451dff77", "url": "https://github.com/apache/lucene-solr/commit/75915c66eeca91ba01eae0092404e83a451dff77", "message": "Adding tests for v1 and v2", "committedDate": "2020-11-02T17:10:35Z", "type": "commit"}, {"oid": "bb6c3c10b12c3d2c89599451474f5b109e9ad714", "url": "https://github.com/apache/lucene-solr/commit/bb6c3c10b12c3d2c89599451474f5b109e9ad714", "message": "Throw error for empty configSet upload.", "committedDate": "2020-11-02T17:10:35Z", "type": "commit"}, {"oid": "f9b86cea42b8ad9080a4fe42a1817989dd34bc8f", "url": "https://github.com/apache/lucene-solr/commit/f9b86cea42b8ad9080a4fe42a1817989dd34bc8f", "message": "Putting filePath in path for v2 API.", "committedDate": "2020-11-02T17:10:35Z", "type": "commit"}, {"oid": "0d86fd04d14ba28f8cca3d74e43c6c6e04218d84", "url": "https://github.com/apache/lucene-solr/commit/0d86fd04d14ba28f8cca3d74e43c6c6e04218d84", "message": "Making v2 upload commands only accept HTTP PUT.", "committedDate": "2020-11-02T17:10:35Z", "type": "commit"}, {"oid": "46c1ead8246b074db636db106de7312b78b9540b", "url": "https://github.com/apache/lucene-solr/commit/46c1ead8246b074db636db106de7312b78b9540b", "message": "Remove /files/ from singleFile path", "committedDate": "2020-11-02T17:10:35Z", "type": "commit"}, {"oid": "0f76fce0b0dee2d9ff81b6358f2d612acd30ace9", "url": "https://github.com/apache/lucene-solr/commit/0f76fce0b0dee2d9ff81b6358f2d612acd30ace9", "message": "Moving CHANGES.txt section to 8.8.0", "committedDate": "2020-11-02T17:12:15Z", "type": "commit"}, {"oid": "0f76fce0b0dee2d9ff81b6358f2d612acd30ace9", "url": "https://github.com/apache/lucene-solr/commit/0f76fce0b0dee2d9ff81b6358f2d612acd30ace9", "message": "Moving CHANGES.txt section to 8.8.0", "committedDate": "2020-11-02T17:12:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY4MDIxMg==", "url": "https://github.com/apache/lucene-solr/pull/1996#discussion_r508680212", "bodyText": "Can we just use a boolean here?", "author": "anshumg", "createdAt": "2020-10-20T16:41:09Z", "path": "solr/core/src/java/org/apache/solr/handler/admin/ConfigSetsHandler.java", "diffHunk": "@@ -230,7 +231,9 @@ private void handleConfigUploadRequest(SolrQueryRequest req, SolrQueryResponse r\n \n     ZipInputStream zis = new ZipInputStream(inputStream, StandardCharsets.UTF_8);\n     ZipEntry zipEntry = null;\n+    int entryCount = 0;", "originalCommit": "7750043e74cbc51284eb336edc4759487f07cff8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c660aea3c71711bbfb65b026626dc8493fa1fab", "url": "https://github.com/apache/lucene-solr/commit/1c660aea3c71711bbfb65b026626dc8493fa1fab", "message": "Changing from int to boolean.", "committedDate": "2020-11-02T17:39:26Z", "type": "commit"}]}