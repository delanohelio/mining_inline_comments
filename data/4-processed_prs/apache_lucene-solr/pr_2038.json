{"pr_number": 2038, "pr_title": "SOLR-14955: Add env var options to Prometheus Export scripts.", "pr_createdAt": "2020-10-26T19:02:30Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2038", "timeline": [{"oid": "52d211b82e577b1478151d5561d0390b63a4c128", "url": "https://github.com/apache/lucene-solr/commit/52d211b82e577b1478151d5561d0390b63a4c128", "message": "SOLR-14955: Add env var options to Prometheus Export scripts.", "committedDate": "2020-10-26T18:17:22Z", "type": "commit"}, {"oid": "a68028462826958ff19391ea6e5b9b9dbc5e381b", "url": "https://github.com/apache/lucene-solr/commit/a68028462826958ff19391ea6e5b9b9dbc5e381b", "message": "First pass for exporter.cmd, need to test still.", "committedDate": "2020-10-26T18:17:22Z", "type": "commit"}, {"oid": "75ae05c683f3c5b37ef7283b4c6f9e16d4322be1", "url": "https://github.com/apache/lucene-solr/commit/75ae05c683f3c5b37ef7283b4c6f9e16d4322be1", "message": "Changes.txt", "committedDate": "2020-10-26T18:29:42Z", "type": "commit"}, {"oid": "9fe41cc2e803fb766663e70065bd93d85b5cb290", "url": "https://github.com/apache/lucene-solr/commit/9fe41cc2e803fb766663e70065bd93d85b5cb290", "message": "Fix command line args for windows", "committedDate": "2020-10-26T19:01:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NjU0OA==", "url": "https://github.com/apache/lucene-solr/pull/2038#discussion_r514156548", "bodyText": "I find it puzzling that default port is the same as the default port for embedded Zookeeper, i.e. if you start bin/solr -c and then start exporter on same host, you'll have a port collision.", "author": "janhoy", "createdAt": "2020-10-29T10:32:24Z", "path": "solr/solr-ref-guide/src/monitoring-solr-with-prometheus-and-grafana.adoc", "diffHunk": "@@ -81,34 +81,44 @@ $ ./bin/solr-exporter -p 9854 -z localhost:2181/solr -f ./conf/solr-exporter-con\n \n === Command Line Parameters\n \n-The parameters in the example start commands shown above:\n+The list of available parameters for the Prometheus Exporter.\n+All parameters can be provided via an environment variable, instead of through the command line.\n \n `h`, `--help`::\n Displays command line help and usage.\n \n-`-p`, `--port`::\n-The port where Prometheus will listen for new data. This port will be used to configure Prometheus. It can be any port not already in use on your server. The default is `9983`.\n+`-p`, `--port`, `$PORT`::\n+The port where Prometheus will listen for new data. This port will be used to configure Prometheus.\n+It can be any port not already in use on your server. The default is `9983`.", "originalCommit": "9fe41cc2e803fb766663e70065bd93d85b5cb290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0MzQ0OA==", "url": "https://github.com/apache/lucene-solr/pull/2038#discussion_r514543448", "bodyText": "That is very fair, and something we could certainly change in a major version, such as 9.0.\nIt should probably be done separately, since these changes are not backwards-incompatible.", "author": "HoustonPutman", "createdAt": "2020-10-29T20:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NjU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU2MzQ5Nw==", "url": "https://github.com/apache/lucene-solr/pull/2038#discussion_r514563497", "bodyText": "https://issues.apache.org/jira/browse/SOLR-14972", "author": "janhoy", "createdAt": "2020-10-29T21:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NjU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1ODYwNg==", "url": "https://github.com/apache/lucene-solr/pull/2038#discussion_r514158606", "bodyText": "I like the simplicity of PORT, but is there a risk that such generic naming could lead to conflict, i.e. that a user hast this env set for some other app, and then the exporter will use it?", "author": "janhoy", "createdAt": "2020-10-29T10:35:51Z", "path": "solr/contrib/prometheus-exporter/bin/solr-exporter", "diffHunk": "@@ -135,15 +134,42 @@ if $cygwin; then\n   [ -n \"$REPO\" ] && REPO=`cygpath --path --windows \"$REPO\"`\n fi\n \n+# Convert Environment Variables to Command Line Options\n+EXPORTER_ARGS=()\n+\n+if [[ -n \"$CONFIG_FILE\" ]]; then\n+  EXPORTER_ARGS+=(-f \"$CONFIG_FILE\")\n+fi\n+\n+if [[ -n \"$PORT\" ]]; then", "originalCommit": "9fe41cc2e803fb766663e70065bd93d85b5cb290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NTk2OQ==", "url": "https://github.com/apache/lucene-solr/pull/2038#discussion_r514545969", "bodyText": "Yeah, that could certainly happen. EXPORTER_PORT would work perfectly fine. I went the direction decided in #887 on variable naming. I don't have a strong opinion either way.", "author": "HoustonPutman", "createdAt": "2020-10-29T20:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1ODYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU1OTY1MQ==", "url": "https://github.com/apache/lucene-solr/pull/2038#discussion_r514559651", "bodyText": "For a docker env it's not a problem, and for most servers you'll have a separate service user with clean shell. Developers could unintentionally have the PORT var set on their laptop, but I don't think we should make design decisions from that.\nOn a side note, I tested what would happen if you have both env $PORT=1111 and arg -p 2222, and the last arg will win, thus you can override any env with explicit command arg, which I guess is a good thing.", "author": "janhoy", "createdAt": "2020-10-29T20:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1ODYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5MTUzOQ==", "url": "https://github.com/apache/lucene-solr/pull/2038#discussion_r514591539", "bodyText": "That is good to know. In that case we should probably stick with $PORT, as there's an easy fix in the case where someone is affected by it.", "author": "HoustonPutman", "createdAt": "2020-10-29T21:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1ODYwNg=="}], "type": "inlineReview"}, {"oid": "36d876910cf176f897aafde8e4c950635f6c6106", "url": "https://github.com/apache/lucene-solr/commit/36d876910cf176f897aafde8e4c950635f6c6106", "message": "Update solr-exporter.cmd\n\nFixed windows usage.", "committedDate": "2020-10-29T23:19:58Z", "type": "commit"}]}