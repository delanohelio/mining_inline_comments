{"pr_number": 2068, "pr_title": "LUCENE-8982: Separate out native code to another module to allow cpp build with gradle", "pr_createdAt": "2020-11-07T06:52:46Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2068", "timeline": [{"oid": "56cfaf6a391dba407c92c6480700fd9399d99f4a", "url": "https://github.com/apache/lucene-solr/commit/56cfaf6a391dba407c92c6480700fd9399d99f4a", "message": "LUCENE-8982: Separate out native code to another module to allow cpp build with gradle", "committedDate": "2020-11-07T06:47:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMxNTc4OA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519315788", "bodyText": "this should be resolved relative to the JVM we compile against, not gradle's JVM. See alternative-jdk-support.gradle and use root project's property:\n// Set up root project's property.\nrootProject.ext.runtimeJava = altJvm", "author": "dweiss", "createdAt": "2020-11-08T09:27:39Z", "path": "lucene/native/build.gradle", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+apply plugin: 'cpp-library'\n+\n+description = 'Module for native code'\n+\n+library {\n+    baseName = 'NativePosixUtil'\n+\n+    privateHeaders.from file(System.getProperty('java.home') + '/include')", "originalCommit": "56cfaf6a391dba407c92c6480700fd9399d99f4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwNTYzNA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519505634", "bodyText": "Done.", "author": "zacharymorn", "createdAt": "2020-11-09T01:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMxNTc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMxODMyNQ==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519318325", "bodyText": "Maybe we should check for existence of these folders and add them only if they exist? Seems strange to add includes for all of them.", "author": "dweiss", "createdAt": "2020-11-08T09:33:55Z", "path": "lucene/native/build.gradle", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+apply plugin: 'cpp-library'\n+\n+description = 'Module for native code'\n+\n+library {\n+    baseName = 'NativePosixUtil'\n+\n+    privateHeaders.from file(System.getProperty('java.home') + '/include')\n+    privateHeaders.from file(System.getProperty('java.home') + '/include/darwin')", "originalCommit": "56cfaf6a391dba407c92c6480700fd9399d99f4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwMTE2NQ==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519501165", "bodyText": "Done. In the newer commit I checked for platform as well as the folder exists before using.", "author": "zacharymorn", "createdAt": "2020-11-09T00:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMxODMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMyMDY0Ng==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519320646", "bodyText": "Are these really a folder up from java.home? On my linux (java 11-15) they seem to be right under JDK's home (although I install Java manually, not via distribution-specific package manager).", "author": "dweiss", "createdAt": "2020-11-08T09:39:37Z", "path": "lucene/native/build.gradle", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+apply plugin: 'cpp-library'\n+\n+description = 'Module for native code'\n+\n+library {\n+    baseName = 'NativePosixUtil'\n+\n+    privateHeaders.from file(System.getProperty('java.home') + '/include')\n+    privateHeaders.from file(System.getProperty('java.home') + '/include/darwin')\n+    privateHeaders.from file(System.getProperty('java.home') + '/../include/solaris')", "originalCommit": "56cfaf6a391dba407c92c6480700fd9399d99f4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwMDk4OA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519500988", "bodyText": "These paths were ported based on the original ant target definition below :\n\n  \n    \n      lucene-solr/lucene/contrib/misc/build.xml\n    \n    \n        Lines 44 to 45\n      in\n      005fec5\n    \n    \n    \n    \n\n        \n          \n           <pathelement location=\"${java.home}/../include/linux\"/> \n        \n\n        \n          \n           <pathelement location=\"${java.home}/../include/solaris\"/> \n        \n    \n  \n\n\nMy guess is these paths might now be deprecated in newer JDK installations.\nDo you think this native build feature should be back ported to prior versions? If so, I think it might be safer to have those paths as well.", "author": "zacharymorn", "createdAt": "2020-11-09T00:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMyMDY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYxODE2MA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519618160", "bodyText": "These paths are wrong, I think. I don't know where they came from but they should correspond to the layout of newer JDK distributions (openjdk).\nI'm not sure Solaris is still needed - I can't test it on Solaris.", "author": "dweiss", "createdAt": "2020-11-09T08:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMyMDY0Ng=="}], "type": "inlineReview"}, {"oid": "55212151aa81d745ff8fef7276dae523abea0e0d", "url": "https://github.com/apache/lucene-solr/commit/55212151aa81d745ff8fef7276dae523abea0e0d", "message": "Condition native build by using -Pbuild.native=true attribute", "committedDate": "2020-11-09T00:07:31Z", "type": "commit"}, {"oid": "b6c16c00faaad2c626a93495f9dfbf878d62968b", "url": "https://github.com/apache/lucene-solr/commit/b6c16c00faaad2c626a93495f9dfbf878d62968b", "message": "Use rootProject.ext.runtimeJava instead of plain vanilla java.home", "committedDate": "2020-11-09T01:02:33Z", "type": "commit"}, {"oid": "31f10be6219e4a745aaae0ec29b75202e391d234", "url": "https://github.com/apache/lucene-solr/commit/31f10be6219e4a745aaae0ec29b75202e391d234", "message": "Check include folder exist before using", "committedDate": "2020-11-09T03:46:07Z", "type": "commit"}, {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe", "url": "https://github.com/apache/lucene-solr/commit/085c71c384442ceb7b2a0ca371429321e7b1b4fe", "message": "Windows build. Cleanups.", "committedDate": "2020-11-09T21:10:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEyNTUzMg==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520125532", "bodyText": "I wonder if we should rename the resulting native library something more specific...", "author": "dweiss", "createdAt": "2020-11-09T21:17:19Z", "path": "lucene/misc/native/build.gradle", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+import org.apache.tools.ant.taskdefs.condition.Os\n+\n+description = 'Module for native code'\n+\n+apply plugin: 'cpp-library'\n+\n+library {\n+  baseName = 'NativePosixUtil'", "originalCommit": "085c71c384442ceb7b2a0ca371429321e7b1b4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MDU2Mw==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520270563", "bodyText": "Given this now also includes the Windows one, and the cpp code focus on doing file IO, I'm guessing something like NativeIOUtil might work ?", "author": "zacharymorn", "createdAt": "2020-11-10T03:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEyNTUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NDQ2Nw==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520384467", "bodyText": "Sure. Maybe LuceneNativeIO though so that it's clear what dll it is?", "author": "dweiss", "createdAt": "2020-11-10T08:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEyNTUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2ODgwNw==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521068807", "bodyText": "Done.", "author": "zacharymorn", "createdAt": "2020-11-11T03:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEyNTUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzM2OA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520273368", "bodyText": "Just curious, shall we also modify the compiler args when it\u2019s on Windows, to be the same with what's used before?\n\n  \n    \n      lucene-solr/lucene/misc/src/java/org/apache/lucene/store/WindowsDirectory.java\n    \n    \n        Lines 31 to 35\n      in\n      ec9a659\n    \n    \n    \n    \n\n        \n          \n            * c:\\mingw\\bin\\g++ -Wall -D_JNI_IMPLEMENTATION_ -Wl,--kill-at  \n        \n\n        \n          \n            * -I\"%JAVA_HOME%\\include\" -I\"%JAVA_HOME%\\include\\win32\" -static-libgcc  \n        \n\n        \n          \n            * -static-libstdc++ -shared WindowsDirectory.cpp -o WindowsDirectory.dll \n        \n\n        \n          \n            *       </blockquote>  \n        \n\n        \n          \n            *       For 64-bit JREs, use mingw64, with the -m64 option.  \n        \n    \n  \n\n\nA quick search shows that some of these flags might be specific to MinGW compiler though, so I'm not sure if these flags are still relevant.", "author": "zacharymorn", "createdAt": "2020-11-10T04:07:10Z", "path": "lucene/misc/native/build.gradle", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+import org.apache.tools.ant.taskdefs.condition.Os\n+\n+description = 'Module for native code'\n+\n+apply plugin: 'cpp-library'\n+\n+library {\n+  baseName = 'NativePosixUtil'\n+\n+  // Native build for Windows platform will be added in later stage\n+  targetMachines = [\n+      machines.linux.x86_64,\n+      machines.macOS.x86_64,\n+      machines.windows.x86_64\n+  ]\n+\n+  // Point at platform-specific sources. Other platforms will be ignored\n+  // (plugin won't find the toolchain).\n+  if (Os.isFamily(Os.FAMILY_WINDOWS)) {\n+    source.from file(\"${projectDir}/src/main/windows\")\n+  } else if (Os.isFamily(Os.FAMILY_UNIX) || Os.isFamily(Os.FAMILY_MAC)) {\n+    source.from file(\"${projectDir}/src/main/posix\")\n+  }\n+}\n+\n+tasks.withType(CppCompile).configureEach {\n+  def javaHome = rootProject.ext.runtimeJava.getInstallationDirectory().getAsFile().getPath()\n+\n+  // Assume standard openjdk layout. This means only one architecture-specific include folder\n+  // is present.\n+  systemIncludes.from file(\"${javaHome}/include\")\n+\n+  for (def path : [\n+      file(\"${javaHome}/include/win32\"),\n+      file(\"${javaHome}/include/darwin\"),\n+      file(\"${javaHome}/include/linux\"),\n+      file(\"${javaHome}/include/solaris\")]) {\n+    if (path.exists()) {\n+      systemIncludes.from path\n+    }\n+  }\n+\n+  compilerArgs.add '-fPIC'", "originalCommit": "085c71c384442ceb7b2a0ca371429321e7b1b4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NTA5MA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520385090", "bodyText": "I wouldn't add anything if it works (and it currently does for me). There are compiler toolchain-specific ways of adding options but like I said - if it's not required, I wouldn't worry about it.", "author": "dweiss", "createdAt": "2020-11-10T08:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2ODMyNA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521068324", "bodyText": "Ok cool. I've updated the comment here to reflect the new way of building the code.", "author": "zacharymorn", "createdAt": "2020-11-11T03:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NTU5Ng==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520385596", "bodyText": "I removed the flag and forgot to update the docs here.", "author": "dweiss", "createdAt": "2020-11-10T08:46:04Z", "path": "lucene/misc/src/java/org/apache/lucene/store/NativeUnixDirectory.java", "diffHunk": "@@ -47,10 +47,10 @@\n  *\n  * <p>To use this you must compile\n  * NativePosixUtil.cpp (exposes Linux-specific APIs through\n- * JNI) for your platform, by running <code>ant\n- * build-native-unix</code>, and then putting the resulting\n- * <code>libNativePosixUtil.so</code> (from\n- * <code>lucene/build/native</code>) onto your dynamic\n+ * JNI) for your platform, by running <code>\n+ * ./gradlew build -Pbuild.native=true</code>, and then putting the resulting", "originalCommit": "085c71c384442ceb7b2a0ca371429321e7b1b4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2ODU0NA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521068544", "bodyText": "Updated.", "author": "zacharymorn", "createdAt": "2020-11-11T03:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NTU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NjAxMA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520386010", "bodyText": "This reference needs an updated path - it'll probably fail when building the whole project.", "author": "dweiss", "createdAt": "2020-11-10T08:46:43Z", "path": "lucene/packaging/build.gradle", "diffHunk": "@@ -32,7 +32,9 @@ def includeInBinaries = project(\":lucene\").subprojects.findAll {subproject ->\n         \":lucene:packaging\",\n         \":lucene:documentation\",\n         // Exclude parent container project of analysis modules (no artifacts).\n-        \":lucene:analysis\"\n+        \":lucene:analysis\",\n+        // Exclude native module, which requires manual copying and enabling\n+        \":lucene:native\"", "originalCommit": "085c71c384442ceb7b2a0ca371429321e7b1b4fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2ODY3NA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521068674", "bodyText": "It did fail, I've updated the reference here and confirmed it's able to build from directory root.", "author": "zacharymorn", "createdAt": "2020-11-11T03:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NjAxMA=="}], "type": "inlineReview"}, {"oid": "ac440fa1ee5b901130d1ee712c1af7880a508a35", "url": "https://github.com/apache/lucene-solr/commit/ac440fa1ee5b901130d1ee712c1af7880a508a35", "message": "Update naming, references and documentation", "committedDate": "2020-11-11T03:07:39Z", "type": "commit"}, {"oid": "6557a17fedcb31b933d7cba1b85e6e0d455e7751", "url": "https://github.com/apache/lucene-solr/commit/6557a17fedcb31b933d7cba1b85e6e0d455e7751", "message": "Merge branch 'master' into LUCENE-8982-NativeBuild", "committedDate": "2020-11-11T03:17:54Z", "type": "commit"}, {"oid": "d7322ef0a4e0dafa12e2f24034fbdea68fdb2f4b", "url": "https://github.com/apache/lucene-solr/commit/d7322ef0a4e0dafa12e2f24034fbdea68fdb2f4b", "message": "Remove outdated files created during merge conflict resolution, this would cause git to think there's a move for the 2 files", "committedDate": "2020-11-11T04:05:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIzODA5Nw==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521238097", "bodyText": "Hmm... how come you have intellij's old-style files and not the folder-based layout? :)", "author": "dweiss", "createdAt": "2020-11-11T09:47:55Z", "path": ".gitignore", "diffHunk": "@@ -8,6 +8,10 @@ build/\n /.idea/\n #    IntelliJ creates this folder, ignore.\n /dev-tools/missing-doclet/out/\n+*.iml", "originalCommit": "d7322ef0a4e0dafa12e2f24034fbdea68fdb2f4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgwMTAxNg==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521801016", "bodyText": "Hmm I seems to recall these files were generated after running ./gradlew idea, but I removed them in the latest commit anyway.", "author": "zacharymorn", "createdAt": "2020-11-12T03:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIzODA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxMTQxNw==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521911417", "bodyText": "Right... gradlew idea is a plugin - it does generate those files. IntelliJ has native gradle support nowadays. See help/IDEs.txt; perhaps it should be clarified there.", "author": "dweiss", "createdAt": "2020-11-12T08:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIzODA5Nw=="}], "type": "inlineReview"}, {"oid": "90763e71290986160f1cfc7fb7ac8bb11d317a41", "url": "https://github.com/apache/lucene-solr/commit/90763e71290986160f1cfc7fb7ac8bb11d317a41", "message": "Add 'build.native' kill switch.", "committedDate": "2020-11-11T20:34:23Z", "type": "commit"}, {"oid": "1a27baf8ff39e5240635de9cccbe93a6b67aa87f", "url": "https://github.com/apache/lucene-solr/commit/1a27baf8ff39e5240635de9cccbe93a6b67aa87f", "message": "Merge branch 'master' into LUCENE-8982-NativeBuild", "committedDate": "2020-11-12T03:28:30Z", "type": "commit"}, {"oid": "948f873ba59315d4d79b72d0010b01cb75f72054", "url": "https://github.com/apache/lucene-solr/commit/948f873ba59315d4d79b72d0010b01cb75f72054", "message": "Update native code and overview.html to reflect the new locations / way of buildling native code", "committedDate": "2020-11-12T03:28:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgwMjgxNw==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521802817", "bodyText": "These paths need to be adjusted as the native code has been moved in d111039", "author": "zacharymorn", "createdAt": "2020-11-12T03:32:43Z", "path": "lucene/misc/native/src/main/posix/NativePosixUtil.cpp", "diffHunk": "@@ -38,12 +38,12 @@\n \n #ifdef LINUX\n /*\n- * Class:     org_apache_lucene_store_NativePosixUtil\n+ * Class:     org_apache_lucene_misc_store_NativePosixUtil\n  * Method:    posix_fadvise\n  * Signature: (Ljava/io/FileDescriptor;JJI)V\n  */\n extern \"C\"\n-JNIEXPORT jint JNICALL Java_org_apache_lucene_store_NativePosixUtil_posix_1fadvise(JNIEnv *env, jclass _ignore, jobject fileDescriptor, jlong offset, jlong len, jint advice)\n+JNIEXPORT jint JNICALL Java_org_apache_lucene_misc_store_NativePosixUtil_posix_1fadvise(JNIEnv *env, jclass _ignore, jobject fileDescriptor, jlong offset, jlong len, jint advice)", "originalCommit": "948f873ba59315d4d79b72d0010b01cb75f72054", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxMjE0MA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521912140", "bodyText": "Yeah. We really should try to add a test that tries to run with these libs. I don't know how to handle this yet - can be a follow-up issue.", "author": "dweiss", "createdAt": "2020-11-12T08:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgwMjgxNw=="}], "type": "inlineReview"}, {"oid": "e4dac53d510bcdce5056cd68073ba5dc4c7a187c", "url": "https://github.com/apache/lucene-solr/commit/e4dac53d510bcdce5056cd68073ba5dc4c7a187c", "message": "Add test and fix WindowsDirectory library name", "committedDate": "2020-11-12T05:37:55Z", "type": "commit"}, {"oid": "9b60b0c0988dcd437fc3076c530fd4ee1d3f4718", "url": "https://github.com/apache/lucene-solr/commit/9b60b0c0988dcd437fc3076c530fd4ee1d3f4718", "message": "Clean up the overview a bit.", "committedDate": "2020-11-13T08:16:10Z", "type": "commit"}, {"oid": "22a1bdcabe62c4eaa08093e13a8b5e73c0346a7f", "url": "https://github.com/apache/lucene-solr/commit/22a1bdcabe62c4eaa08093e13a8b5e73c0346a7f", "message": "Run or ignore native tests on multiple platforms.", "committedDate": "2020-11-13T10:03:09Z", "type": "commit"}, {"oid": "a635b564a1d4701ec26e8adf927c030c639c3ecb", "url": "https://github.com/apache/lucene-solr/commit/a635b564a1d4701ec26e8adf927c030c639c3ecb", "message": "Add require permission on linux.", "committedDate": "2020-11-13T10:08:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523355315", "bodyText": "This configuration block seems very auto-magical to me in that it somehow gets linked to :lucene:misc:native/build folder (no reference to nativeProjects here),  and the copyNativeDeps task below copies only the needed library artifact without all the nested folder structure (nor does it seems to copy any other random file I created in :lucene:misc:native/build folder to test thing out). Is this some convention trigged by the two attribute settings below?", "author": "zacharymorn", "createdAt": "2020-11-14T02:28:02Z", "path": "gradle/native/disable-native.gradle", "diffHunk": "@@ -17,20 +17,65 @@\n \n // This is the master switch to disable all tasks that compile\n // native (cpp) code.\n-def buildNative = propertyOrDefault(\"build.native\", true).toBoolean()\n+rootProject.ext {\n+  buildNative = propertyOrDefault(\"build.native\", true).toBoolean()\n+}\n+\n+// Explicitly list all projects that should be configured for native extensions.\n+// We could scan for projects with a the cpp-library plugin but this is faster.\n+def nativeProjects = allprojects.findAll {it.path in [\n+    \":lucene:misc:native\"\n+]}\n+\n+def javaProjectsWithNativeDeps = allprojects.findAll {it.path in [\n+    \":lucene:misc\"\n+]}\n+\n+// Set up defaults for projects with native dependencies.\n+configure(javaProjectsWithNativeDeps, {\n+  configurations {", "originalCommit": "22a1bdcabe62c4eaa08093e13a8b5e73c0346a7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQwNjE5Mw==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523406193", "bodyText": "Right. This is gradle deep-waters but not too complicated once you get the hang of it. I am personally fond of simple and straightforward code, coming from assembly myself, but these days it's hard to avoid higher-level constructs. Sorry about this!\nSo, the code you asked about essentially applies ('configure') a code block (secont argument to configure - the closure) to all objects that are in the collection that is the first argument to configure. When you look at that patch we create two such collections - nativeProjects and javaProjectsWithNativeDeps, each one with Project instances that match a corresponding path. This is very much as if you copy-pasted the same code in each gradle.build of each corresponding project - avoids repetition, centralises common configuration.\nThe inside of this closure block is where things get more interesting and more gradle-sque. The \"configurations\" block is a project property that declares the project's configurations to which artifacts (or dependencies) can be added. You should understand how this works because this is the core of how it works. See here, for example (gradle documentation is very good, if sometimes scattered across multiple documents):\nhttps://docs.gradle.org/current/userguide/dependency_management.html#declaring-dependencies\nSo, for any project in javaProjectsWithNativeDeps we declare a configuration called \"nativeDeps\". To this configuration we will attach a dependency to a \"native\" project - our cpp-library modules. In case of :lucene:misc we attach it inside build.gradle:\nnativeDeps project(\":lucene:misc:native\")\n\nThen the code declares two project \"extra (ext) properties - testOptions and nativeDepsDir. The testOptions is a an array we use to collect various test attributes from bits and pieces of configuration scattered around other files. To make the evaluation work in the right order (ensure the array is there) we put everything in a deferred-execution block (this is why plugins.withType(JavaPlugin) stuff is needed...).\nFinally, we apply a code closure configuring any of the project's tasks that have the type \"Test\", adding java.library.path system property pointing at the nativeDepsDir property location and a dependency on a task that will copy all dependencies (artifacts produced by dependencies attached to the nativeDeps configuration) to that folder. These two steps are only needed if we indeed plan to run with native libraries so they're wrapped in an 'if'.\n\nand the copyNativeDeps task below copies only the needed library artifact without all the nested folder structure\n\nIt actually synchronizes the state of the target folder with source files. Note that the \"source\" files are pointed to by the configuration (artifacts produced by this configuration dependencies). The cpp-library produces multiple configuration variants (debug, release - with possibly multiple artifacts). This is where it gets tricky and this is why we declared the nativeDeps configuration with some \"attributes\" that allow gradle to pick just one of the produced configurations out of multiple choices. In most Java projects you'd never have to use this but you combined cpp and java. Try removing those attributes from configuration definition and see what happens. Then see this:\nhttps://docs.gradle.org/current/userguide/variant_model.html\nSorry for throwing so much on you but you asked for it! :)", "author": "dweiss", "createdAt": "2020-11-14T10:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2ODQ1MA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523468450", "bodyText": "Wow thanks Dawid so much for the detailed and thorough explanations and pointers! I did come across some of these documentations individually before, but it's just that the combination of configuration + variant + sync + cpp confuses me quite a bit. But it's pretty clear now. Thanks again for your patience and guidance here!\nI do have a final question though. It seems at this point we should also be able to easily support packaging the compiled native code into misc jar package (and change to use the optimized variant of the build), to remove the final manual step to copy around the native library artifact for production usage of WindowsDirectory or NativeUnixDirectory? Do you think this is a good direction to be taken ?", "author": "zacharymorn", "createdAt": "2020-11-14T22:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyMjEwNA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523722104", "bodyText": "This is something I considered but eventually left out. Technically, it's trivial to do but my concern is that then the content of the \"lucene distribution\" depends on the machine you build it on - native libraries will vary and you can't (?) easily compile all libraries for the most common platforms to include all of them in the distribution... I don't know how to solve it.\nUnless those native extensions offer super performance boosts I'd rather treat them as \"sandbox\", expert-level stuff and not include them in the distribution by default? You can bring this issue up on the dev list, perhaps other people have an opinion here - I have never used those extensions myself.", "author": "dweiss", "createdAt": "2020-11-15T07:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc5ODczMg==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523798732", "bodyText": "Unless those native extensions offer super performance boosts I'd rather treat them as \"sandbox\", expert-level stuff and not include them in the distribution by default?\n\nMakes sense. I think as part of https://issues.apache.org/jira/browse/LUCENE-8982 some performance measurement utility may come out, so by then this can be more objectively measured to help further discussions.\nI guess this PR is ready for merge then? Please let me know if there's any other improvement you would like me to make. Thanks again for your help on this!", "author": "zacharymorn", "createdAt": "2020-11-15T19:03:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgwNDMyMQ==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523804321", "bodyText": "Yep, I think it's ready! Please monitor jenkins so that we know should something go wrong - if it does we can just turn native builds off (by default).", "author": "dweiss", "createdAt": "2020-11-15T19:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkxODAzMA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523918030", "bodyText": "Sure will do. Just to confirm these are all the jobs right https://ci-builds.apache.org/job/Lucene/, and I guess job Lucene-Artifacts-master requires the most attention / monitoring?", "author": "zacharymorn", "createdAt": "2020-11-16T06:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0OTYwNA==", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523949604", "bodyText": "I think the build mailing list is the easiest to spot problems - builds@lucene.apache.org. There will be some builds there from branches (these can be ignored) but otherwise these are worth taking an occasional look at.", "author": "dweiss", "createdAt": "2020-11-16T07:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ=="}], "type": "inlineReview"}, {"oid": "e959967fd587874af7eb4efb1e92dbe402415f2f", "url": "https://github.com/apache/lucene-solr/commit/e959967fd587874af7eb4efb1e92dbe402415f2f", "message": "Merge remote-tracking branch 'origin/master' into LUCENE-8982-NativeBuild", "committedDate": "2020-11-16T07:58:30Z", "type": "commit"}, {"oid": "3eb8faf6fc1977d9d6b0431ab6f9a2e199371089", "url": "https://github.com/apache/lucene-solr/commit/3eb8faf6fc1977d9d6b0431ab6f9a2e199371089", "message": "Added changes entry.", "committedDate": "2020-11-16T08:08:49Z", "type": "commit"}]}