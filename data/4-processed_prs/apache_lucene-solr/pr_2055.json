{"pr_number": 2055, "pr_title": "SOLR-14978 OOM Killer in Foreground", "pr_createdAt": "2020-11-02T17:07:46Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2055", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwNzUzOA==", "url": "https://github.com/apache/lucene-solr/pull/2055#discussion_r516807538", "bodyText": "Should this also be moved to bin/solr?", "author": "HoustonPutman", "createdAt": "2020-11-03T16:43:39Z", "path": "solr/docker/include/scripts/solr-fg", "diffHunk": "@@ -15,21 +15,19 @@ if [[ -z \"${OOM:-}\" ]]; then\n   OOM='none'\n fi\n case \"$OOM\" in", "originalCommit": "63d5bcf27f5fea419503537172e3602ed80a2060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3NDU5Mw==", "url": "https://github.com/apache/lucene-solr/pull/2055#discussion_r516974593", "bodyText": "I don't think so. It might make sense to remove it entirely, but in bin/solr these options can be specified directly instead.", "author": "madrob", "createdAt": "2020-11-03T21:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwNzUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3NjUwMA==", "url": "https://github.com/apache/lucene-solr/pull/2055#discussion_r516976500", "bodyText": "I wonder what effect these even have if we are going to run the oom_script by default, which will kill the solr process", "author": "HoustonPutman", "createdAt": "2020-11-03T21:51:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwNzUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4NTE1OQ==", "url": "https://github.com/apache/lucene-solr/pull/2055#discussion_r517585159", "bodyText": "After some experimentation, I don't think these do anything.", "author": "madrob", "createdAt": "2020-11-04T19:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwNzUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwOTk0NA==", "url": "https://github.com/apache/lucene-solr/pull/2055#discussion_r516809944", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n            # If a heap dump directory is specified, enable it in SOLR_OPTS\n          \n          \n            \n            if [[ -z \"$SOLR_HEAP_DUMP_DIR\" ]] && [[ \"$SOLR_HEAP_DUMP\" == \"true\" ]]; then\n          \n          \n            \n              SOLR_HEAP_DUMP_DIR=\"${SOLR_LOGS_DIR}/dumps\"\n          \n          \n            \n            fi\n          \n          \n            \n            \n          \n      \n    \n    \n  \n\nI like the idea of having a boolean flag that lets you say that you want a heap dump at the default location of heap dumps. Not a necessity, just a thought.", "author": "HoustonPutman", "createdAt": "2020-11-03T16:46:48Z", "path": "solr/bin/solr", "diffHunk": "@@ -2172,6 +2172,12 @@ function start_solr() {\n     SOLR_OPTS+=($AUTHC_OPTS)\n   fi\n ", "originalCommit": "63d5bcf27f5fea419503537172e3602ed80a2060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a0c7f04089bcf3964369c7b1b281cfbc045c653f", "url": "https://github.com/apache/lucene-solr/commit/a0c7f04089bcf3964369c7b1b281cfbc045c653f", "message": "SOLR-14978 OOM Killer in Foreground", "committedDate": "2020-11-03T21:43:51Z", "type": "commit"}, {"oid": "a928e78e4aa772c39bc9602d7fc014e2cc82e9a5", "url": "https://github.com/apache/lucene-solr/commit/a928e78e4aa772c39bc9602d7fc014e2cc82e9a5", "message": "Update solr/bin/solr\n\nCo-authored-by: Houston Putman <houstonputman@gmail.com>", "committedDate": "2020-11-03T21:43:52Z", "type": "commit"}, {"oid": "3b76f058a935da8b1bfd369ad09dec590062eb56", "url": "https://github.com/apache/lucene-solr/commit/3b76f058a935da8b1bfd369ad09dec590062eb56", "message": "Add documentation", "committedDate": "2020-11-03T21:43:53Z", "type": "commit"}, {"oid": "3b76f058a935da8b1bfd369ad09dec590062eb56", "url": "https://github.com/apache/lucene-solr/commit/3b76f058a935da8b1bfd369ad09dec590062eb56", "message": "Add documentation", "committedDate": "2020-11-03T21:43:53Z", "type": "forcePushed"}, {"oid": "8f75d6ff4f0d981136f64a28c173b5ac4a7263ec", "url": "https://github.com/apache/lucene-solr/commit/8f75d6ff4f0d981136f64a28c173b5ac4a7263ec", "message": "Remove redundant options", "committedDate": "2020-11-04T19:55:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMDMyOA==", "url": "https://github.com/apache/lucene-solr/pull/2055#discussion_r517610328", "bodyText": "Why are you piping the errors here? mkdir -p should be safe right?", "author": "HoustonPutman", "createdAt": "2020-11-04T20:24:58Z", "path": "solr/bin/solr", "diffHunk": "@@ -2172,6 +2172,16 @@ function start_solr() {\n     SOLR_OPTS+=($AUTHC_OPTS)\n   fi\n \n+  # If a heap dump directory is specified, enable it in SOLR_OPTS\n+  if [[ -z \"$SOLR_HEAP_DUMP_DIR\" ]] && [[ \"$SOLR_HEAP_DUMP\" == \"true\" ]]; then\n+    SOLR_HEAP_DUMP_DIR=\"${SOLR_LOGS_DIR}/dumps\"\n+  fi\n+  if [[ -n \"$SOLR_HEAP_DUMP_DIR\" ]]; then\n+    SOLR_OPTS+=(\"-XX:+HeapDumpOnOutOfMemoryError\")\n+    SOLR_OPTS+=(\"-XX:HeapDumpPath=$SOLR_HEAP_DUMP_DIR/solr-$(date +%s)-pid$$.hprof\")\n+    mkdir -p \"$SOLR_HEAP_DUMP_DIR\" 2>/dev/null", "originalCommit": "8f75d6ff4f0d981136f64a28c173b5ac4a7263ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0ODkyMg==", "url": "https://github.com/apache/lucene-solr/pull/2055#discussion_r517648922", "bodyText": "I was doing it to match the call at \n  \n    \n      lucene-solr/solr/bin/solr\n    \n    \n         Line 2243\n      in\n      8f75d6f\n    \n    \n    \n    \n\n        \n          \n           mkdir -p \"$SOLR_LOGS_DIR\" 2>/dev/null \n        \n    \n  \n\n but that also had additional checks afterwards. I extracted the commonality here and call that function instead.\nmkdir can fail if you don't have permissions to that directory path, which would also indicate that the process won't have permissions later to write the log files.", "author": "madrob", "createdAt": "2020-11-04T21:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMDMyOA=="}], "type": "inlineReview"}, {"oid": "14ab2b031d7f7ec3e7bf80ee262daff61f89b4b7", "url": "https://github.com/apache/lucene-solr/commit/14ab2b031d7f7ec3e7bf80ee262daff61f89b4b7", "message": "Refactor dir creation logic", "committedDate": "2020-11-04T21:41:42Z", "type": "commit"}, {"oid": "a750acdd0cd518346250a77cf2d0eab135801ab6", "url": "https://github.com/apache/lucene-solr/commit/a750acdd0cd518346250a77cf2d0eab135801ab6", "message": "pipe mkdir error to dev/null", "committedDate": "2020-11-04T21:42:46Z", "type": "commit"}, {"oid": "285c8c98225840ba9c0775f9e23708ca05433c04", "url": "https://github.com/apache/lucene-solr/commit/285c8c98225840ba9c0775f9e23708ca05433c04", "message": "check for unset dir", "committedDate": "2020-11-04T22:41:58Z", "type": "commit"}]}