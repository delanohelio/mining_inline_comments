{"pr_number": 1726, "pr_title": "SOLR-14722: timeAllowed should track from req creation", "pr_createdAt": "2020-08-07T20:31:27Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1726", "timeline": [{"oid": "ef9dbc9bd78aaf0a97a03fceb916e8ae71996b63", "url": "https://github.com/apache/lucene-solr/commit/ef9dbc9bd78aaf0a97a03fceb916e8ae71996b63", "message": "SOLR-14722: timeAllowed should track from req creation", "committedDate": "2020-08-07T20:28:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1NTc5MA==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r467255790", "bodyText": "For back-compat sake, on 8x I could retain the former method as Deprecated... but I'm unsure if anyone calls it.", "author": "dsmiley", "createdAt": "2020-08-07T20:32:41Z", "path": "solr/core/src/java/org/apache/solr/search/SolrQueryTimeoutImpl.java", "diffHunk": "@@ -42,23 +44,23 @@ public static SolrQueryTimeoutImpl getInstance() {\n   }\n \n   /**\n-   * Get the current value of timeoutAt.\n+   * The time (nanoseconds) at which the request should be considered timed out.\n    */\n-  public static Long get() {\n+  public static Long getTimeoutAtNs() {", "originalCommit": "ef9dbc9bd78aaf0a97a03fceb916e8ae71996b63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNTc3OA==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r468315778", "bodyText": "should this be a primitive instead of a boxed type?", "author": "madrob", "createdAt": "2020-08-11T04:13:04Z", "path": "solr/core/src/java/org/apache/solr/search/SolrQueryTimeoutImpl.java", "diffHunk": "@@ -67,8 +69,21 @@ public boolean shouldExit() {\n   }\n \n   /**\n-   * Method to set the time at which the timeOut should happen.\n-   * @param timeAllowed set the time at which this thread should timeout.\n+   * Sets or clears the time allowed based on how much time remains from the start of the request plus the configured\n+   * {@link CommonParams#TIME_ALLOWED}.\n+   */\n+  public static void set(SolrQueryRequest req) {\n+    long timeAllowed = req.getParams().getLong(CommonParams.TIME_ALLOWED, -1L);\n+    if (timeAllowed >= 0L) {\n+      set(timeAllowed - (long)req.getRequestTimer().getTime()); // reduce by time already spent\n+    } else {\n+      reset();\n+    }\n+  }\n+\n+  /**\n+   * Sets the time allowed (milliseconds), assuming we start a timer immediately.\n+   * You should probably invoke {@link #set(SolrQueryRequest)} instead.\n    */\n   public static void set(Long timeAllowed) {", "originalCommit": "ef9dbc9bd78aaf0a97a03fceb916e8ae71996b63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwOTAwMw==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r468709003", "bodyText": "Oh yeah; I forgot that -- indeed a primitive.  It's weird it was boxed.", "author": "dsmiley", "createdAt": "2020-08-11T16:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNTc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNjY2NA==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r468316664", "bodyText": "Should be >, not >=. Doc on time allowed state that zero is no timeout, not immediate timeout. Looks like we were previously inconsistent about this.", "author": "madrob", "createdAt": "2020-08-11T04:16:48Z", "path": "solr/core/src/java/org/apache/solr/search/SolrQueryTimeoutImpl.java", "diffHunk": "@@ -67,8 +69,21 @@ public boolean shouldExit() {\n   }\n \n   /**\n-   * Method to set the time at which the timeOut should happen.\n-   * @param timeAllowed set the time at which this thread should timeout.\n+   * Sets or clears the time allowed based on how much time remains from the start of the request plus the configured\n+   * {@link CommonParams#TIME_ALLOWED}.\n+   */\n+  public static void set(SolrQueryRequest req) {\n+    long timeAllowed = req.getParams().getLong(CommonParams.TIME_ALLOWED, -1L);\n+    if (timeAllowed >= 0L) {", "originalCommit": "ef9dbc9bd78aaf0a97a03fceb916e8ae71996b63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwOTk1OA==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r468709958", "bodyText": "This seems inconsistent -- should we not be marking no timeout as -1?", "author": "atris", "createdAt": "2020-08-11T16:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNjY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxMDU1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r468710559", "bodyText": "> vs >= is debatable; there's an argument both ways.  I suspect there's a test for it this way but moreover, I don't think we should change it.  It's fine.", "author": "dsmiley", "createdAt": "2020-08-11T16:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNjY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MjI0NQ==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r468762245", "bodyText": "https://github.com/apache/lucene-solr/pull/1726/files#diff-d8beef800870f194d61993d701fd9cc2L77 has >=\nhttps://github.com/apache/lucene-solr/pull/1726/files#diff-65e9f3712efc1ec962ea82a04a1d7aa1L104 has >\nEither way, please update the docs at https://github.com/apache/lucene-solr/blob/master/solr/solrj/src/java/org/apache/solr/common/params/CommonParams.java#L162 because they are absolutely wrong (>= 0 means no timeout???)", "author": "madrob", "createdAt": "2020-08-11T17:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNjY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI2ODIzMQ==", "url": "https://github.com/apache/lucene-solr/pull/1726#discussion_r469268231", "bodyText": "MLT Handler was the exception it's used way less often than SearchHandler and so I ignored that.  I agree that the docs are wrong; I will update them.", "author": "dsmiley", "createdAt": "2020-08-12T13:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNjY2NA=="}], "type": "inlineReview"}, {"oid": "7173f2bc002f9c3d49bc3911e4a46224678b215f", "url": "https://github.com/apache/lucene-solr/commit/7173f2bc002f9c3d49bc3911e4a46224678b215f", "message": "set(long) instead of set(Long).\nAnd other minor warnings.", "committedDate": "2020-08-11T16:44:57Z", "type": "commit"}, {"oid": "7f2c070f5ee356a074e3491fd0a2b4857b68a727", "url": "https://github.com/apache/lucene-solr/commit/7f2c070f5ee356a074e3491fd0a2b4857b68a727", "message": "Fix javadocs CommonParams.TIME_ALLOWED", "committedDate": "2020-08-12T14:14:49Z", "type": "commit"}, {"oid": "9181f44ee319018a8cfb0ab3d38f01fc58ff7dfe", "url": "https://github.com/apache/lucene-solr/commit/9181f44ee319018a8cfb0ab3d38f01fc58ff7dfe", "message": "Merge branch 'master' into solr14722_solrQueryTimeout", "committedDate": "2020-08-14T21:27:51Z", "type": "commit"}, {"oid": "9b28dbfee09c17b6220241193a6587adab454e9c", "url": "https://github.com/apache/lucene-solr/commit/9b28dbfee09c17b6220241193a6587adab454e9c", "message": "changes.txt", "committedDate": "2020-08-14T21:30:03Z", "type": "commit"}]}