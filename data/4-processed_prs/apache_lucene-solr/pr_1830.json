{"pr_number": 1830, "pr_title": "LUCENE-9506: Gradle: split validateSourcePatterns into per-project an\u2026", "pr_createdAt": "2020-09-04T09:33:51Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1830", "timeline": [{"oid": "bb1afca9686b621ffb763675e514b48fd66670a7", "url": "https://github.com/apache/lucene-solr/commit/bb1afca9686b621ffb763675e514b48fd66670a7", "message": "LUCENE-9506: Gradle: split validateSourcePatterns into per-project and root-specific tasks (allow parallelism)", "committedDate": "2020-09-04T09:33:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MzY2MA==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483773660", "bodyText": "should the excludes be an input property so that we don't have to repeat them later on root project?", "author": "madrob", "createdAt": "2020-09-04T17:59:17Z", "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,117 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"*.${it}\"\n+      }\n+\n+      // default excludes.", "originalCommit": "bb1afca9686b621ffb763675e514b48fd66670a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc5MzcyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483793729", "bodyText": "It could be. I didn't have time to clean up everything. The speedup was significant for me anyway (order of magnitude).", "author": "dweiss", "createdAt": "2020-09-04T18:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MzY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDIwMg==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944202", "bodyText": "I agree with this. Maybe make a closure out of it, so it can be applied everywhere. I can do this, if you like.", "author": "uschindler", "createdAt": "2020-09-05T11:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MzY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NzY1NA==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483947654", "bodyText": "Please, go ahead and take over!", "author": "dweiss", "createdAt": "2020-09-05T12:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MzY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDI1OA==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944258", "bodyText": "this wont work in per directory setting -> remove\nsame for solr a bit down.", "author": "uschindler", "createdAt": "2020-09-05T11:59:13Z", "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,117 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"*.${it}\"\n+      }\n+\n+      // default excludes.\n+      exclude \"$buildDir/**\"\n+      exclude '**/dist/**'\n+      exclude 'dev-tools/missing-doclet/src/**/*.java' // <-- TODO: remove once we allow \"var\" on master\n+      exclude 'lucene/benchmark/work/**'", "originalCommit": "bb1afca9686b621ffb763675e514b48fd66670a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDM5MQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944391", "bodyText": "But if the code does not fail, mabe remove the exclude (outdated?).", "author": "uschindler", "createdAt": "2020-09-05T12:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDI1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NzY3Ng==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483947676", "bodyText": "Yup.", "author": "dweiss", "createdAt": "2020-09-05T12:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDQ4MQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944481", "bodyText": "Cool!", "author": "uschindler", "createdAt": "2020-09-05T12:01:23Z", "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -181,8 +252,13 @@ class ValidateSourcePatternsTask extends DefaultTask {\n       }\n     }\n \n+    ProgressLogger progress = progressLoggerFactory.newOperation(this.class)\n+    progress.start(this.name, this.name)\n+\n     sourceFiles.each{ f ->\n-      logger.debug('Scanning source file: {}', f);\n+      progress.progress(\"Scanning ${f.name}\")", "originalCommit": "bb1afca9686b621ffb763675e514b48fd66670a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944607", "bodyText": "I would keep this as debug or remove after adding the progress meter.\nI often try to run gradlew with --info, but theis is way too much information.\nDo you know how to silence the palantir version-lock checker? I hate that it prints so much information during configuration phase to info.\nI'd like to enable --info on jenkins, but that's way to much.", "author": "uschindler", "createdAt": "2020-09-05T12:03:05Z", "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -181,8 +252,13 @@ class ValidateSourcePatternsTask extends DefaultTask {\n       }\n     }\n \n+    ProgressLogger progress = progressLoggerFactory.newOperation(this.class)\n+    progress.start(this.name, this.name)\n+\n     sourceFiles.each{ f ->\n-      logger.debug('Scanning source file: {}', f);\n+      progress.progress(\"Scanning ${f.name}\")\n+      logger.info('Scanning source file: {}', f);", "originalCommit": "bb1afca9686b621ffb763675e514b48fd66670a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NzcyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483947729", "bodyText": "The --info switch is verbose. I don't think there's much you can do about it. I was thinking about it myself - perhaps we should devise our own internal logging verbosity level (and log to lifecycle when it's enabled).", "author": "dweiss", "createdAt": "2020-09-05T12:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0ODY4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483948687", "bodyText": "Info is like ant always was. Except the shitty palantir logging. Can we suppress this? I have all Gradle builds with info logging in jenkins, except Lucene.", "author": "uschindler", "createdAt": "2020-09-05T12:55:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0ODc4Mg==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483948782", "bodyText": "I don't know how to do that, Uwe.", "author": "dweiss", "createdAt": "2020-09-05T12:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk1MDU4OQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483950589", "bodyText": "Nevertheless, I'd change ours back to debug (it's really only for debugging). If a violation happens, filename is printed anyways.\nBut we should change this now to not use relative paths anymore, because it's hard to figure out where file is located. I can take care of that.", "author": "uschindler", "createdAt": "2020-09-05T13:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk1MTgyNA==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483951824", "bodyText": "Hmm... What do you mean by \"not use relative paths\"?", "author": "dweiss", "createdAt": "2020-09-05T13:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk1MzAyNw==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483953027", "bodyText": "When it reports a violation it's relative to basedir of file collection. This was ok with root level task, but should be changed now to just print full path.", "author": "uschindler", "createdAt": "2020-09-05T13:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk2OTY1MA==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483969650", "bodyText": "Doesn't the logger carry the information which project this is? This should be sufficient to locate the file in question? I don't mind changing it to an absolute path, but I think project + path should be enough to locate something?", "author": "dweiss", "createdAt": "2020-09-05T17:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwOTYwOQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484709609", "bodyText": "I just wanted to add this to this dicsussion: gradle/gradle#1010\nI am working on that!\n(I also figured out that we miss our lockfactory integration test in :lucene:core, in ANT it's still there (many JVMs hammering a single directory with lockfactories). We need a task in gradle for this, too. I will open another issue)", "author": "uschindler", "createdAt": "2020-09-08T07:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw=="}], "type": "inlineReview"}, {"oid": "58c6c15c8cade9d15bbac611d1f9d88838132762", "url": "https://github.com/apache/lucene-solr/commit/58c6c15c8cade9d15bbac611d1f9d88838132762", "message": "cleanup excludes, fix file extension pattern", "committedDate": "2020-09-07T09:36:40Z", "type": "commit"}, {"oid": "99e571d1d7d1b87ee7c38a8f8c52d4fd5bccb5f4", "url": "https://github.com/apache/lucene-solr/commit/99e571d1d7d1b87ee7c38a8f8c52d4fd5bccb5f4", "message": "Don't go into subprojects while scanning for files", "committedDate": "2020-09-07T21:23:24Z", "type": "commit"}, {"oid": "987a6a593fcee9f0d6a80ae2103c7045bc74fd32", "url": "https://github.com/apache/lucene-solr/commit/987a6a593fcee9f0d6a80ae2103c7045bc74fd32", "message": "Cleanup some excludes no longer needed with Gradle", "committedDate": "2020-09-07T21:30:09Z", "type": "commit"}, {"oid": "affe2c6c7b002e9b421092bd67f2c23481549117", "url": "https://github.com/apache/lucene-solr/commit/affe2c6c7b002e9b421092bd67f2c23481549117", "message": "Merge branch 'master' of https://gitbox.apache.org/repos/asf/lucene-solr into LUCENE-9506", "committedDate": "2020-09-07T21:54:24Z", "type": "commit"}, {"oid": "6ce69d368ae762b448aff163d54b466c907e1278", "url": "https://github.com/apache/lucene-solr/commit/6ce69d368ae762b448aff163d54b466c907e1278", "message": "Ensure that *.md files are scanned everywhere", "committedDate": "2020-09-07T21:57:04Z", "type": "commit"}, {"oid": "9e46266785f165cbe9e85b658757797b179c7358", "url": "https://github.com/apache/lucene-solr/commit/9e46266785f165cbe9e85b658757797b179c7358", "message": "Move project-specific excludes to a separate project configuration", "committedDate": "2020-09-07T22:07:24Z", "type": "commit"}, {"oid": "43866c75a6e84431e66e495453eddd5ce150cecc", "url": "https://github.com/apache/lucene-solr/commit/43866c75a6e84431e66e495453eddd5ce150cecc", "message": "subproject -> child project", "committedDate": "2020-09-07T22:18:21Z", "type": "commit"}, {"oid": "c555db52b1284ee2b81c5548512476f5358a272e", "url": "https://github.com/apache/lucene-solr/commit/c555db52b1284ee2b81c5548512476f5358a272e", "message": "Make per project check depend on \"validateLogCalls\" for consistency", "committedDate": "2020-09-07T22:24:33Z", "type": "commit"}, {"oid": "ba0b265cca69f010fc940f9801209d2753c06a43", "url": "https://github.com/apache/lucene-solr/commit/ba0b265cca69f010fc940f9801209d2753c06a43", "message": "We have no xml-templates anymore", "committedDate": "2020-09-07T23:20:44Z", "type": "commit"}, {"oid": "83aaa7def25e4bda9cffebc6a92e7ce08e2c0348", "url": "https://github.com/apache/lucene-solr/commit/83aaa7def25e4bda9cffebc6a92e7ce08e2c0348", "message": "Set precommit dependency for each subproject", "committedDate": "2020-09-07T23:25:16Z", "type": "commit"}, {"oid": "39d3e8fe7caecf82e81b53e024c38614b8af30fa", "url": "https://github.com/apache/lucene-solr/commit/39d3e8fe7caecf82e81b53e024c38614b8af30fa", "message": "Remove obsolete precommit dependency", "committedDate": "2020-09-07T23:26:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3NDg3Mw==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484674873", "bodyText": "Yep, that should do it.", "author": "dweiss", "createdAt": "2020-09-08T06:18:20Z", "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,127 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'md',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n-        include \"*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"**/*.${it}\"\n       }\n-      // TODO: For now we don't scan txt / md files, so we\n-      // check licenses in top-level folders separately:\n-      include '*.txt'\n-      include '*/*.txt'\n-      include '*.md'\n-      include '*/*.md'\n-      // excludes:\n+      \n+      // Don't go into child projects (scanned separately).", "originalCommit": "39d3e8fe7caecf82e81b53e024c38614b8af30fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODc1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484678759", "bodyText": "I think we can leave the dependency on the root task as it depends on other source pattern validations. Or remove the snippet that connects them later.", "author": "dweiss", "createdAt": "2020-09-08T06:28:07Z", "path": "gradle/validation/precommit.gradle", "diffHunk": "@@ -26,7 +26,6 @@ configure(rootProject) {\n     dependsOn \":verifyLocks\"\n     dependsOn \":versionsPropsAreSorted\"\n     dependsOn \":checkWorkingCopyClean\"\n-    dependsOn \":validateSourcePatterns\"", "originalCommit": "39d3e8fe7caecf82e81b53e024c38614b8af30fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5MDU3Nw==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484690577", "bodyText": "I wanted to make it consistent with the others. Now all are handled the same.", "author": "uschindler", "createdAt": "2020-09-08T06:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5MTIwMQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484691201", "bodyText": "Removing the connection in subprojects is not good, as now I can run gradlew check in a subproject and it does everything right.", "author": "uschindler", "createdAt": "2020-09-08T06:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5MTQ5Nw==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484691497", "bodyText": "Fair enough. But then the top-level one doesn't need to depend on children?", "author": "dweiss", "createdAt": "2020-09-08T06:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5MTk5OA==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484691998", "bodyText": "Ah, ok. See it now.", "author": "dweiss", "createdAt": "2020-09-08T06:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODg1NQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484678855", "bodyText": "(here).", "author": "dweiss", "createdAt": "2020-09-08T06:28:21Z", "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,127 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'md',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n-        include \"*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"**/*.${it}\"\n       }\n-      // TODO: For now we don't scan txt / md files, so we\n-      // check licenses in top-level folders separately:\n-      include '*.txt'\n-      include '*/*.txt'\n-      include '*.md'\n-      include '*/*.md'\n-      // excludes:\n+      \n+      // Don't go into child projects (scanned separately).\n+      childProjects.keySet().each{\n+        exclude \"${it}/**\"\n+      }\n+\n+      // default excludes.\n+      exclude 'build/**'\n+    }\n+  }\n+\n+  // Add source validation to per-project checks as well.\n+  check.dependsOn validateSourcePatterns\n+}\n+\n+configure(project(':lucene:benchmark')) {\n+  project.tasks.withType(ValidateSourcePatternsTask) {\n+    sourceFiles.exclude 'temp/**'\n+    sourceFiles.exclude 'work/**'\n+  }\n+}\n+\n+configure(project(':solr:core')) {\n+  project.tasks.withType(ValidateSourcePatternsTask) {\n+    sourceFiles.exclude 'src/**/CheckLoggingConfiguration.java'\n+    sourceFiles.exclude 'src/test/org/apache/hadoop/**'\n+  }\n+}\n+\n+configure(rootProject) {\n+  task validateRootAndOtherFiles(type: ValidateSourcePatternsTask) { task ->\n+    // This task has no proper outputs.\n+    setupDummyOutputs(task)\n+\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"**/*.${it}\"\n+      }\n+\n+      // We do not scan for *.txt by default (broken files in subprojects),\n+      // but in root we can do this).\n+      include '**/*.txt'\n+\n+      // Don't go into child projects (scanned separately).\n+      childProjects.keySet().each{\n+        exclude \"${it}/**\"\n+      }\n+\n+      // default excludes.\n       exclude '**/build/**'\n-      exclude '**/dist/**'\n       exclude 'dev-tools/missing-doclet/src/**/*.java' // <-- TODO: remove once we allow \"var\" on master\n-      exclude 'lucene/benchmark/work/**'\n-      exclude 'lucene/benchmark/temp/**'\n-      exclude '**/CheckLoggingConfiguration.java'\n-      exclude 'solr/core/src/test/org/apache/hadoop/**'\n-      exclude '**/validate-source-patterns.gradle' // ourselves :-)\n+\n+      // ourselves :-)\n+      exclude 'gradle/validation/validate-source-patterns.gradle'\n     }\n   }\n+\n+  task validateSourcePatterns() {\n+    group = 'Verification'\n+    description = 'Validate Source Patterns'\n+\n+    // Make it depend on all so-named tasks from subprojects.", "originalCommit": "39d3e8fe7caecf82e81b53e024c38614b8af30fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5MjA2OQ==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484692069", "bodyText": "I also want this to be able to run it from root separately. If that's not needed and works automatically, remove it here.\nI just made it consistent with other validation tasks", "author": "uschindler", "createdAt": "2020-09-08T06:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5NTc2Nw==", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484695767", "bodyText": "Yes, it does work. Like I said - a task without a project qualifier is in fact an invocation of any such task in any subproject. So:\n> gradlew -p lucene/analysis validateSourcePatterns  --console=plain\n...\n> Task :lucene:analysis:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:phonetic:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:opennlp:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:stempel:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:morfologik:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:smartcn:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:nori:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:kuromoji:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:icu:validateSourcePatterns UP-TO-DATE\n> Task :lucene:analysis:common:validateSourcePatterns UP-TO-DATE", "author": "dweiss", "createdAt": "2020-09-08T07:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODg1NQ=="}], "type": "inlineReview"}, {"oid": "26a6fb786ba9b5a8ebc667af2695aa3f8fc47b4d", "url": "https://github.com/apache/lucene-solr/commit/26a6fb786ba9b5a8ebc667af2695aa3f8fc47b4d", "message": "Simplify task dependencies.", "committedDate": "2020-09-08T07:04:19Z", "type": "commit"}, {"oid": "e7a3f519f46177718ea53143888fc5e2732468c7", "url": "https://github.com/apache/lucene-solr/commit/e7a3f519f46177718ea53143888fc5e2732468c7", "message": "Move to more general type (we no longer need the basedir of the filetree)", "committedDate": "2020-09-08T07:50:05Z", "type": "commit"}]}