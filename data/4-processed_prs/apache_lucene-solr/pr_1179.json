{"pr_number": 1179, "pr_title": "LUCENE-9147: Move the stored fields index off-heap.", "pr_createdAt": "2020-01-17T09:28:25Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1179", "timeline": [{"oid": "042c0872e93f9ae786431e5e9b556ac50d8c8eed", "url": "https://github.com/apache/lucene-solr/commit/042c0872e93f9ae786431e5e9b556ac50d8c8eed", "message": "LUCENE-9147: Move the stored fields index off-heap.\n\nThis replaces the index of stored fields and term vectors with two\n`DirectMonotonic` arrays. `DirectMonotonicWriter` requires to know the number\nof values to write up-front, so incoming doc IDs and file pointers are buffered\non disk using temporary files that never get fsynced, but have index headers\nand footers to make sure any corruption in these files wouldn't propagate to the\nindex.\n\n`DirectMonotonicReader` gets a specialized `binarySearch` implementation that\nleverages the metadata in order to avoid going to the IndexInput as often as\npossible. Actually in the common case, it would only go to a single\nsub `DirectReader` which, combined with the size of blocks of 1k values, helps\nbound the number of page faults to 2.", "committedDate": "2020-01-17T09:19:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk1NTMxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1179#discussion_r367955319", "bodyText": "Do we know this incoming long index is small enough not to overflow int after right shift?  Should we use Math.toIntExact instead to confirm?", "author": "mikemccand", "createdAt": "2020-01-17T14:15:01Z", "path": "lucene/core/src/java/org/apache/lucene/util/packed/DirectMonotonicReader.java", "diffHunk": "@@ -101,20 +104,99 @@ public static LongValues getInstance(Meta meta, RandomAccessInput data) throws I\n         readers[i] = DirectReader.getInstance(data, meta.bpvs[i], meta.offsets[i]);\n       }\n     }\n-    final int blockShift = meta.blockShift;\n-\n-    final long[] mins = meta.mins;\n-    final float[] avgs = meta.avgs;\n-    return new LongValues() {\n-\n-      @Override\n-      public long get(long index) {\n-        final int block = (int) (index >>> blockShift);\n-        final long blockIndex = index & ((1 << blockShift) - 1);\n-        final long delta = readers[block].get(blockIndex);\n-        return mins[block] + (long) (avgs[block] * blockIndex) + delta;\n+\n+    return new DirectMonotonicReader(meta.blockShift, readers, meta.mins, meta.avgs, meta.bpvs);\n+  }\n+\n+  private final int blockShift;\n+  private final LongValues[] readers;\n+  private final long[] mins;\n+  private final float[] avgs;\n+  private final byte[] bpvs;\n+  private final int nonZeroBpvs;\n+\n+  private DirectMonotonicReader(int blockShift, LongValues[] readers, long[] mins, float[] avgs, byte[] bpvs) {\n+    this.blockShift = blockShift;\n+    this.readers = readers;\n+    this.mins = mins;\n+    this.avgs = avgs;\n+    this.bpvs = bpvs;\n+    if (readers.length != mins.length || readers.length != avgs.length || readers.length != bpvs.length) {\n+      throw new IllegalArgumentException();\n+    }\n+    int nonZeroBpvs = 0;\n+    for (byte b : bpvs) {\n+      if (b != 0) {\n+        nonZeroBpvs++;\n+      }\n+    }\n+    this.nonZeroBpvs = nonZeroBpvs;\n+  }\n+\n+  @Override\n+  public long get(long index) {\n+    final int block = (int) (index >>> blockShift);\n+    final long blockIndex = index & ((1 << blockShift) - 1);\n+    final long delta = readers[block].get(blockIndex);\n+    return mins[block] + (long) (avgs[block] * blockIndex) + delta;\n+  }\n+\n+  /** Get lower/upper bounds for the value at a given index without hitting the direct reader. */\n+  private long[] getBounds(long index) {\n+    final int block = (int) (index >>> blockShift);", "originalCommit": "042c0872e93f9ae786431e5e9b556ac50d8c8eed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6abda837c932de1af4883de76c0334ea113e2189", "url": "https://github.com/apache/lucene-solr/commit/6abda837c932de1af4883de76c0334ea113e2189", "message": "Merge branch 'master' into offhead_stored_fields_index", "committedDate": "2020-01-21T17:18:08Z", "type": "commit"}, {"oid": "938662038ef24ce4ba90232b59339ee79abe5d12", "url": "https://github.com/apache/lucene-solr/commit/938662038ef24ce4ba90232b59339ee79abe5d12", "message": "iter", "committedDate": "2020-01-21T17:58:03Z", "type": "commit"}, {"oid": "8695fa7d9abdda142e504d624e840a1ff75e2395", "url": "https://github.com/apache/lucene-solr/commit/8695fa7d9abdda142e504d624e840a1ff75e2395", "message": "Merge branch 'master' into offhead_stored_fields_index", "committedDate": "2020-01-22T08:04:26Z", "type": "commit"}, {"oid": "f857af02ecae43ee760f5792fb1cddc6ef5965a3", "url": "https://github.com/apache/lucene-solr/commit/f857af02ecae43ee760f5792fb1cddc6ef5965a3", "message": "Merge branch 'master' into offhead_stored_fields_index", "committedDate": "2020-02-05T15:47:02Z", "type": "commit"}, {"oid": "6b04bc6ed6776882f54b7dc0cb43ed4a379844e1", "url": "https://github.com/apache/lucene-solr/commit/6b04bc6ed6776882f54b7dc0cb43ed4a379844e1", "message": "iter", "committedDate": "2020-02-05T16:45:29Z", "type": "commit"}, {"oid": "768c70967a688aaa4a67b593f0e3e199884cc06e", "url": "https://github.com/apache/lucene-solr/commit/768c70967a688aaa4a67b593f0e3e199884cc06e", "message": "iter", "committedDate": "2020-02-05T17:34:44Z", "type": "commit"}]}