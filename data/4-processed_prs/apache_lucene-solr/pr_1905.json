{"pr_number": 1905, "pr_title": "LUCENE-9488 Release with Gradle Part 2", "pr_createdAt": "2020-09-21T23:13:43Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1905", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzAxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r492507019", "bodyText": "Yes, please move it to :lucene:packaging. It makes things much cleaner in the long run.", "author": "dweiss", "createdAt": "2020-09-22T06:48:38Z", "path": "lucene/build.gradle", "diffHunk": "@@ -15,8 +15,56 @@\n  * limitations under the License.\n  */\n \n+// Should we do this as :lucene:packaging similar to how Solr does it?", "originalCommit": "6e4d365c50edb003967a85418b4d02e307a24d1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzUwMw==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r492507503", "bodyText": "This is wrong. It should rely on published artifacts from other subprojects (set up proper dependencies) and assemble them in the right way into the distribution layout.", "author": "dweiss", "createdAt": "2020-09-22T06:49:49Z", "path": "lucene/build.gradle", "diffHunk": "@@ -15,8 +15,56 @@\n  * limitations under the License.\n  */\n \n+// Should we do this as :lucene:packaging similar to how Solr does it?\n+// Or is this fine here?\n+\n+plugins {\n+  id 'distribution'\n+}\n+\n description = 'Parent project for Apache Lucene Core'\n \n subprojects {\n   group \"org.apache.lucene\"\n-}\n\\ No newline at end of file\n+}\n+\n+distributions {\n+  main {\n+      // This is empirically wrong, but it is mostly a copy from `ant package-zip`", "originalCommit": "6e4d365c50edb003967a85418b4d02e307a24d1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkzNzkzMA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r492937930", "bodyText": "I tried looking at the solr packaging for figuring this out, but kept getting duplicate entries in the archive. I left the TODOs for what still remains to be added to the zip, can you give me a little more direction on what the implementation would look like?", "author": "madrob", "createdAt": "2020-09-22T18:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2MjEzNw==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r492962137", "bodyText": "Sure but you'll have to be patient - can't do it right away.", "author": "dweiss", "createdAt": "2020-09-22T18:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1MzEzNQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r493853135", "bodyText": "Haven't forgotten about it, just busy with work. Those release scripts will have to be adjusted to Solr and Lucene released independently in the future. Which requires independent builds, which requires repo split. Will have to get to it, eventually. Sigh.", "author": "dweiss", "createdAt": "2020-09-23T19:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4NDk0OQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r493884949", "bodyText": "My goal here with getting things releasable is to also turn the smoke tester back on so that we can hopefully catch issues before we actually go to do the release. I understand there\u2019s going to be more split related work, but that shouldn\u2019t stop us from working on the pieces that we can work on before that.", "author": "madrob", "createdAt": "2020-09-23T20:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDExNjA2OA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r494116068", "bodyText": "Ok, fair enough. But I wouldn't want to add things to gradle that are not right - these are hard to get rid of later on. I'm really busy this week but I will correct those assembly bits and commit them to this PR. Please give me some time to work on this, thank you.", "author": "dweiss", "createdAt": "2020-09-24T08:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUwNzUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzNTAyNA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r498535024", "bodyText": "@dweiss this is still a problem, not sure why it comes up or how to resolve it.", "author": "madrob", "createdAt": "2020-10-01T22:02:43Z", "path": "lucene/packaging/build.gradle", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+// This project puts together a \"distribution\", assembling dependencies from\n+// various other projects.\n+\n+plugins {\n+    id 'distribution'\n+}\n+\n+description = 'Lucene distribution packaging'\n+\n+// Declare all subprojects that should be included in binary distribution.\n+// By default everything is included, unless explicitly excluded.\n+def includeInBinaries = project(\":lucene\").subprojects.findAll {subproject ->\n+    return !(subproject.path in [\n+        \":lucene:packaging\",\n+        \":lucene:analysis\",\n+        \":lucene:luke\", // nocommit - Encountered duplicate path \"luke/lib/log4j-core-2.13.2.jar\"", "originalCommit": "574961ee42826df168eae54ba442a6c124638377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NjEyMA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r498666120", "bodyText": "This wasn't obvious. Here's what happened.\nWe create a configuration with dependency on \"full project\", it looked like this:\nhandler.add(confFull, project(path: includedProject.path), {...\n\nThis in fact is a dependency on the configuration aptly named 'default', which includes all of project binaries and transitive dependencies (archives in general).\nLuke declared a separate configuration for dependencies called 'standalone' which added a few non-project dependencies (the 'implementation' extended from it so they were visible on runtime classpath). The core of the problem was in that luke also exported an extra artifact that belonged to this 'standalone' configuration  - this was a set of JARs assembled under a folder. So when the packaging process was collecting files for inclusion, it encountered log4j twice: a copy in that 'standalone' folder and a copy from transitive project dependencies.\nI recall you asked why this 'fail' on double archive entries is needed. Well, it's useful to catch pearls like this one above...", "author": "dweiss", "createdAt": "2020-10-02T07:50:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzNTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NjI4Mg==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r498666282", "bodyText": "I've verified that it collects Luke properly and the launch script starts it fine (on Windows).", "author": "dweiss", "createdAt": "2020-10-02T07:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzNTAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcwOTUwMg==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499709502", "bodyText": "Use charset here. File.text = ... uses default charset. Use File.setText(..., 'UTF-8')", "author": "uschindler", "createdAt": "2020-10-05T16:04:01Z", "path": "gradle/releasing.gradle", "diffHunk": "@@ -0,0 +1,58 @@\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import org.apache.commons.codec.digest.DigestUtils\n+import org.apache.commons.codec.digest.MessageDigestAlgorithms\n+\n+// We're using commons-codec for computing checksums.\n+buildscript {\n+    repositories {\n+        mavenCentral()\n+    }\n+\n+    dependencies {\n+        classpath 'commons-codec:commons-codec:1.13'\n+    }\n+}\n+\n+allprojects {\n+    plugins.withType(DistributionPlugin) {\n+        def checksum = {\n+            outputs.files.each { File file ->\n+                new File(file.parent, file.name + \".sha512\").text = new DigestUtils(MessageDigestAlgorithms.SHA_512).digestAsHex(file).trim() + \"  \" + file.name", "originalCommit": "6ac41c82be3c22ecdee72816351a80fd355e27f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1OTUzNw==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499759537", "bodyText": "minor comment but there is an unnecessary blank line :)", "author": "danmuzi", "createdAt": "2020-10-05T17:29:50Z", "path": "gradle/releasing.gradle", "diffHunk": "@@ -0,0 +1,58 @@\n+", "originalCommit": "130de247f6adb55e6fa6248f9d69a5e810acba26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2c02688274f6c70c84462020c6825ee72cf5ace", "url": "https://github.com/apache/lucene-solr/commit/f2c02688274f6c70c84462020c6825ee72cf5ace", "message": "LUCENE-9488 Release with Gradle Part 2", "committedDate": "2020-10-05T18:11:07Z", "type": "commit"}, {"oid": "d73f23a4ffb9dadfde0dfd74545eb03cc3e8663e", "url": "https://github.com/apache/lucene-solr/commit/d73f23a4ffb9dadfde0dfd74545eb03cc3e8663e", "message": "Add lucene packaging to zip+tgz", "committedDate": "2020-10-05T18:11:07Z", "type": "commit"}, {"oid": "9e4dbd1ac76bc442c31c3a0d2c1ed5f69de5a091", "url": "https://github.com/apache/lucene-solr/commit/9e4dbd1ac76bc442c31c3a0d2c1ed5f69de5a091", "message": "use version.release because gradle does not like naked version", "committedDate": "2020-10-05T18:11:07Z", "type": "commit"}, {"oid": "7c343074b4a7061edd8f1eb846de37b2c72a74bd", "url": "https://github.com/apache/lucene-solr/commit/7c343074b4a7061edd8f1eb846de37b2c72a74bd", "message": "lucene packaging", "committedDate": "2020-10-05T18:11:07Z", "type": "commit"}, {"oid": "9cd112be4d132c3fe5e1322c4fb621767b330211", "url": "https://github.com/apache/lucene-solr/commit/9cd112be4d132c3fe5e1322c4fb621767b330211", "message": "Move lucene packaging to new module", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "efcab8f03a4adab63302607d67aaf8a45341b40b", "url": "https://github.com/apache/lucene-solr/commit/efcab8f03a4adab63302607d67aaf8a45341b40b", "message": "Update lucene dist directory", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "1d6e7f2eb9c69e887e4bf86fd21bed7cdda63a64", "url": "https://github.com/apache/lucene-solr/commit/1d6e7f2eb9c69e887e4bf86fd21bed7cdda63a64", "message": "Use top-level assembleDist", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "75682d4dc4e7a2838fb9ff405c49741f126ffa00", "url": "https://github.com/apache/lucene-solr/commit/75682d4dc4e7a2838fb9ff405c49741f126ffa00", "message": "Binary distribution assembly.", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "ea079d6266398d78e34661cdb766c3db41649d7b", "url": "https://github.com/apache/lucene-solr/commit/ea079d6266398d78e34661cdb766c3db41649d7b", "message": "Add luke launch scripts.", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "8c6049a6714cefd1f962c57655cf438fe052a13c", "url": "https://github.com/apache/lucene-solr/commit/8c6049a6714cefd1f962c57655cf438fe052a13c", "message": "include docs in assembly", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "47c85d0e36d55ee7c787948ef37a32cb2d3e64d9", "url": "https://github.com/apache/lucene-solr/commit/47c85d0e36d55ee7c787948ef37a32cb2d3e64d9", "message": "cleaner assemble depends on docs", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "2afeed2f8c05773c4fa9fbb4d6b6d609ea522e17", "url": "https://github.com/apache/lucene-solr/commit/2afeed2f8c05773c4fa9fbb4d6b6d609ea522e17", "message": "back to a for loop", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "5b7d795db3c46a91f68e8b96c73a8410263bca31", "url": "https://github.com/apache/lucene-solr/commit/5b7d795db3c46a91f68e8b96c73a8410263bca31", "message": "Use proper configuration paths for docs", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "924dda50d43eeb4f7455fb5d00f2592f199e5310", "url": "https://github.com/apache/lucene-solr/commit/924dda50d43eeb4f7455fb5d00f2592f199e5310", "message": "Checksum assembly artifacts", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "dee73998d6261cc38e8244c2bdc116cc8676491b", "url": "https://github.com/apache/lucene-solr/commit/dee73998d6261cc38e8244c2bdc116cc8676491b", "message": "Fix double jar in luke.", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "52eabaf02389c84ae433930ecd34a7e3ce401833", "url": "https://github.com/apache/lucene-solr/commit/52eabaf02389c84ae433930ecd34a7e3ce401833", "message": "Use commons-codec for checksums", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "9b01f8aed51230256d54edd8f72195041d69d87a", "url": "https://github.com/apache/lucene-solr/commit/9b01f8aed51230256d54edd8f72195041d69d87a", "message": "use utf-8 charset", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "9dcfdd4526e70c4fb8e7fd18a0f8bae723a647ab", "url": "https://github.com/apache/lucene-solr/commit/9dcfdd4526e70c4fb8e7fd18a0f8bae723a647ab", "message": "comment cleanup", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "afb9ecdfd28c8ea5e6664fa322ce7c7ab4d66907", "url": "https://github.com/apache/lucene-solr/commit/afb9ecdfd28c8ea5e6664fa322ce7c7ab4d66907", "message": "Use correct task for maven build", "committedDate": "2020-10-05T18:11:08Z", "type": "commit"}, {"oid": "afb9ecdfd28c8ea5e6664fa322ce7c7ab4d66907", "url": "https://github.com/apache/lucene-solr/commit/afb9ecdfd28c8ea5e6664fa322ce7c7ab4d66907", "message": "Use correct task for maven build", "committedDate": "2020-10-05T18:11:08Z", "type": "forcePushed"}, {"oid": "a7c2553892faba6120417e44ef6b07e74cbe2e92", "url": "https://github.com/apache/lucene-solr/commit/a7c2553892faba6120417e44ef6b07e74cbe2e92", "message": "blank line", "committedDate": "2020-10-05T18:13:18Z", "type": "commit"}, {"oid": "52dc9b86b37d666ec73cc443d835e1c6d4a31004", "url": "https://github.com/apache/lucene-solr/commit/52dc9b86b37d666ec73cc443d835e1c6d4a31004", "message": "queryparser docs", "committedDate": "2020-10-05T19:08:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMTAyNg==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499901026", "bodyText": "I don't think so. Documentation in Solr's Artifacts on Jenkins already contain everything perfectly. If its the same for Lucene, we're fine. Should land in the ZIP's docs folder.", "author": "uschindler", "createdAt": "2020-10-05T22:12:44Z", "path": "solr/packaging/build.gradle", "diffHunk": "@@ -115,15 +121,15 @@ distributions {\n         into \"server\"\n       })\n \n+      from(configurations.docs, {\n+        into \"docs\"\n+      })\n       // docs/   - TODO: this is assembled via XSLT... leaving out for now.\n+      // -- Is there more to do here?", "originalCommit": "52dc9b86b37d666ec73cc443d835e1c6d4a31004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMjUxMQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499902511", "bodyText": "Oh, I am not sure if this works. At least in current master, I see NO 'docs/' foder in the binary releaese!", "author": "uschindler", "createdAt": "2020-10-05T22:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNTgyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499905829", "bodyText": "See comments below.", "author": "uschindler", "createdAt": "2020-10-05T22:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMTAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0MjQ3Mw==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500042473", "bodyText": "I think we can create a separate issue for collecting Solr docs? This patch is mostly about Lucene and it's pretty big already.", "author": "dweiss", "createdAt": "2020-10-06T06:50:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMjkzMg==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499902932", "bodyText": "where is this coming from?", "author": "uschindler", "createdAt": "2020-10-05T22:18:05Z", "path": "lucene/packaging/build.gradle", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+// This project puts together a \"distribution\", assembling dependencies from\n+// various other projects.\n+\n+plugins {\n+    id 'distribution'\n+}\n+\n+description = 'Lucene distribution packaging'\n+\n+// Declare all subprojects that should be included in binary distribution.\n+// By default everything is included, unless explicitly excluded.\n+def includeInBinaries = project(\":lucene\").subprojects.findAll {subproject ->\n+    return !(subproject.path in [\n+        // Exclude packaging, not relevant to binary distribution.\n+        \":lucene:packaging\",\n+        // Exclude parent container project of analysis modules (no artifacts).\n+        \":lucene:analysis\"\n+    ])\n+}\n+\n+// Create a configuration to each subproject and add dependency.\n+def binaryArtifactsConf = { Project prj ->\n+    \"dep-binary\" + prj.path.replace(':', '-')\n+}\n+\n+def allDepsConf = { Project prj ->\n+    \"dep-full\" + prj.path.replace(':', '-')\n+}\n+\n+configurations {\n+    docs\n+}\n+\n+for (Project includedProject : includeInBinaries) {\n+    def confBinaries = binaryArtifactsConf(includedProject)\n+    def confFull = allDepsConf(includedProject)\n+    configurations.create(confBinaries)\n+    configurations.create(confFull)\n+    dependencies { DependencyHandler handler ->\n+        // Just project binaries.\n+        handler.add(confBinaries, project(path: includedProject.path, configuration: \"packaging\"))\n+        // All project dependencies, including transitive dependencies from the runtime configuration.\n+        handler.add(confFull, project(path: includedProject.path, configuration: \"runtimeElements\"), {\n+            exclude group: \"org.apache.lucene\"\n+\n+            // Exclude these from all projects.\n+            exclude group: \"commons-logging\"\n+            exclude group: \"org.slf4j\"\n+        })\n+    }\n+}\n+\n+dependencies {\n+    docs project(path: ':lucene', configuration: 'docs')\n+}\n+\n+distributions {\n+    // The \"main\" distribution is the binary distribution.\n+    // We should also add 'source' distribution at some point\n+    // (we can't do it now as the build itself is tangled with Solr).\n+    main {\n+        distributionBaseName = 'lucene'\n+\n+        contents {\n+            // Manually correct posix permissions (matters when packaging on Windows).\n+            filesMatching([\"**/*.sh\", \"**/*.bat\"]) { copy ->\n+                copy.setMode(0755)\n+            }\n+\n+            // Root distribution files; these are cherry-picked manually.\n+            from(project(':lucene').projectDir, {\n+                include \"CHANGES.txt\"\n+                include \"JRE_VERSION_MIGRATION.md\"\n+                include \"LICENSE.txt\"\n+                include \"licenses/*\"\n+                include \"MIGRATE.md\"\n+                include \"NOTICE.txt\"\n+                include \"README.md\"\n+                include \"SYSTEM_REQUIREMENTS.md\"\n+            })\n+\n+            // A couple more missing README files\n+            from(project(':lucene:analysis').projectDir) {\n+                include \"README.txt\"\n+                into 'analysis'\n+            }\n+\n+            // Copy files from documentation output to 'docs'\n+            from(configurations.docs, {", "originalCommit": "52dc9b86b37d666ec73cc443d835e1c6d4a31004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0MTU1MA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500041550", "bodyText": "This is part of the PR, Uwe - here.\nhttps://github.com/apache/lucene-solr/pull/1905/files#diff-d55d7b9fe9d94d4e2e5554e3c1108943R60-R63\nI suggested using configuration-based copying instead of pointing at an explicit folder because it has several advantages. First, an artifact exported via configuration is configurable in the place where it logically belongs to. So you can put together a set of documentation artifacts in documentation configuration snippet and just depend on it when you're assembling something that uses those artifacts.\nThe second benefit is that dependencies on tasks assembling those artifacts are automatically resolved - you don't need to know anything beyond the name of the project and configuration from which you're coping. The rest is done by gradle.\nI think Mike's patch is fine here.", "author": "dweiss", "createdAt": "2020-10-06T06:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMjkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMDIwNQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r501210205", "bodyText": "I fixed it to shipthe correct documentation. There were also some usless dependencies that I removed.", "author": "uschindler", "createdAt": "2020-10-07T18:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMjkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMzAzMA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499903030", "bodyText": "where is this coming from?", "author": "uschindler", "createdAt": "2020-10-05T22:18:20Z", "path": "solr/packaging/build.gradle", "diffHunk": "@@ -115,15 +121,15 @@ distributions {\n         into \"server\"\n       })\n \n+      from(configurations.docs, {", "originalCommit": "52dc9b86b37d666ec73cc443d835e1c6d4a31004", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499904208", "bodyText": "I have no idea where this configuration is defined. The :solr project only has a task called documentation that needs to be executed before, but the outputs are not defined as config. So how should this work (same for Lucene)?", "author": "uschindler", "createdAt": "2020-10-05T22:21:41Z", "path": "solr/packaging/build.gradle", "diffHunk": "@@ -62,12 +63,17 @@ dependencies {\n \n   example project(path: \":solr:example\", configuration: \"packaging\")\n   server project(path: \":solr:server\", configuration: \"packaging\")\n+\n+  // Copy files from documentation output\n+  docs project(path: ':solr', configuration: 'docs')", "originalCommit": "52dc9b86b37d666ec73cc443d835e1c6d4a31004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNTQ4Nw==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r499905487", "bodyText": "There are some ext properties prointing to the documentation after it's generated. For the Solr ZIP/TGZ its just some minimal folder: project(':solr').docrootOnline (packaged in ZIP)\nFor full lucene/solr docs, refer to project(':lucene').docroot (packaged in TGZ) and project(':solr').docroot (not packaged, only published on website).", "author": "uschindler", "createdAt": "2020-10-05T22:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0MTk1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500041959", "bodyText": "I explained this above, I hope. I think artifact/configuration based approach to collecting packaging dependencies is superior to explicit properties and task-dependencies.", "author": "dweiss", "createdAt": "2020-10-06T06:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4NzA2Mw==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500087063", "bodyText": "But where is the documentation config defined. I did not find it anywhere else. I understand and I like it, but this is incomplete. And currently it does not work (I see no docs in ZIP files).", "author": "uschindler", "createdAt": "2020-10-06T08:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4ODM3Mg==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500088372", "bodyText": "So as far as I understand: In the documentation.gradle file I would add a \"configuration docs\" for :solr and :lucene and then use builtBy 'documentation' there. That's what I am missing here. I was about to set this up yesterday, but was not sure if I miss something.", "author": "uschindler", "createdAt": "2020-10-06T08:15:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA5MjE5MQ==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500092191", "bodyText": "Ah, sorry - yes, you are correct. It should declare artifacts, the configuration to attach them to and the outputs. An example is in solr/example/build.gradle:\nartifacts {\n  packaging packagingDir, {\n    builtBy assemblePackaging\n  }\n}", "author": "dweiss", "createdAt": "2020-10-06T08:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA5NjEyNA==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500096124", "bodyText": "Ah cool. That is what I was missing. I will add this after lunch. I was not sure how to define the artifacts. The Gradle documentation was not very helpful to me.\nThanks and sorry for stupid questions. \ud83e\udd23", "author": "uschindler", "createdAt": "2020-10-06T08:27:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEwMDQzNw==", "url": "https://github.com/apache/lucene-solr/pull/1905#discussion_r500100437", "bodyText": "There are no stupid questions. This is the relevant documentation bit here, I believe.\nhttps://docs.gradle.org/current/userguide/cross_project_publications.html", "author": "dweiss", "createdAt": "2020-10-06T08:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNDIwOA=="}], "type": "inlineReview"}, {"oid": "e841393324d0f69cb26d4070d3c57d922cc0012d", "url": "https://github.com/apache/lucene-solr/commit/e841393324d0f69cb26d4070d3c57d922cc0012d", "message": "Merge branch 'master' of https://gitbox.apache.org/repos/asf/lucene-solr into gradle-release", "committedDate": "2020-10-07T17:32:40Z", "type": "commit"}, {"oid": "17bc35e0ba8a22d3ec6754ffa274d8b73be5489a", "url": "https://github.com/apache/lucene-solr/commit/17bc35e0ba8a22d3ec6754ffa274d8b73be5489a", "message": "Make documentation packaging correct:\n- Lucene depends on the whole Javadocs (config \"docs\", built by documentation) and ships it\n- Solr only depends on the docsOnline configuration containing a stub, pointing to web page\n- Remove useless dependency", "committedDate": "2020-10-07T18:05:32Z", "type": "commit"}, {"oid": "9f0a0be8817a768865b583a7ba58c322e63107b6", "url": "https://github.com/apache/lucene-solr/commit/9f0a0be8817a768865b583a7ba58c322e63107b6", "message": "Clenup relics from Ant in documentation. Also add formatted changes to Solr's TGZ.", "committedDate": "2020-10-07T21:45:08Z", "type": "commit"}]}