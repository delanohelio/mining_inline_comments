{"pr_number": 1928, "pr_title": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels", "pr_createdAt": "2020-09-28T23:45:01Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1928", "timeline": [{"oid": "bf8eaf98901cbe83f23067bea90dfb2f3102603a", "url": "https://github.com/apache/lucene-solr/commit/bf8eaf98901cbe83f23067bea90dfb2f3102603a", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit.", "committedDate": "2020-09-19T01:17:44Z", "type": "commit"}, {"oid": "75ff251ebac9034c93edbb43dcf5d8dd0f1058ae", "url": "https://github.com/apache/lucene-solr/commit/75ff251ebac9034c93edbb43dcf5d8dd0f1058ae", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit.", "committedDate": "2020-09-23T04:23:23Z", "type": "commit"}, {"oid": "71222c288a83e4a05d0be6020f6903ad340d959d", "url": "https://github.com/apache/lucene-solr/commit/71222c288a83e4a05d0be6020f6903ad340d959d", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit.", "committedDate": "2020-09-23T17:19:13Z", "type": "commit"}, {"oid": "2600be2694de92f7eb881a7f4e65de77f2175e8d", "url": "https://github.com/apache/lucene-solr/commit/2600be2694de92f7eb881a7f4e65de77f2175e8d", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit.", "committedDate": "2020-09-25T00:21:04Z", "type": "commit"}, {"oid": "e3c992c4bae6f98d65d8f42ef752a583bd1e8f4d", "url": "https://github.com/apache/lucene-solr/commit/e3c992c4bae6f98d65d8f42ef752a583bd1e8f4d", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit.", "committedDate": "2020-09-26T00:22:33Z", "type": "commit"}, {"oid": "a87e115e867f56a46323827d184cd65661feb870", "url": "https://github.com/apache/lucene-solr/commit/a87e115e867f56a46323827d184cd65661feb870", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit.", "committedDate": "2020-09-28T22:45:13Z", "type": "commit"}, {"oid": "ef061a5d53f4de81fb7e846bf3eca77595711856", "url": "https://github.com/apache/lucene-solr/commit/ef061a5d53f4de81fb7e846bf3eca77595711856", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit.", "committedDate": "2020-09-28T22:59:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MjUyNQ==", "url": "https://github.com/apache/lucene-solr/pull/1928#discussion_r496742525", "bodyText": "Missing space before {?", "author": "mikemccand", "createdAt": "2020-09-29T14:01:22Z", "path": "lucene/facet/src/test/org/apache/lucene/facet/FacetTestCase.java", "diffHunk": "@@ -70,32 +70,51 @@ public Facets getTaxonomyFacetCounts(TaxonomyReader taxoReader, FacetsConfig con\n    *\n    * @param taxoReader {@link TaxonomyReader} used to read taxonomy during search. This instance is expected to be open for reading.\n    * @param fc         {@link FacetsCollector} A collector with matching hits.\n-   * @return {@code List<List<FacetLabel>} where outer list has one non-null entry per document\n+   * @param dimension  facet dimension for which labels are requested. A null value fetches labels for all dimensions.\n+   * @return {@code List<List<FacetLabel>} where outer list has one non-null entry per document.\n    * and inner list contain all {@link FacetLabel} entries that belong to a document.\n    * @throws IOException when a low-level IO issue occurs.\n    */\n-  public List<List<FacetLabel>> getAllTaxonomyFacetLabels(TaxonomyReader taxoReader, FacetsCollector fc) throws IOException {\n+  public List<List<FacetLabel>> getAllTaxonomyFacetLabels(String dimension, TaxonomyReader taxoReader, FacetsCollector fc) throws IOException {\n     List<List<FacetLabel>> actualLabels = new ArrayList<>();\n     TaxonomyFacetLabels taxoLabels = new TaxonomyFacetLabels(taxoReader, FacetsConfig.DEFAULT_INDEX_FIELD_NAME);\n-\n     for (MatchingDocs m : fc.getMatchingDocs()) {\n       FacetLabelReader facetLabelReader = taxoLabels.getFacetLabelReader(m.context);\n-\n       DocIdSetIterator disi = m.bits.iterator();\n       while (disi.nextDoc() != DocIdSetIterator.NO_MORE_DOCS) {\n-        List<FacetLabel> facetLabels = new ArrayList<>();\n-        int docId = disi.docID();\n-        FacetLabel facetLabel = facetLabelReader.nextFacetLabel(docId);\n-        while (facetLabel != null) {\n-          facetLabels.add(facetLabel);\n-          facetLabel = facetLabelReader.nextFacetLabel(docId);\n-        }\n-        actualLabels.add(facetLabels);\n+        actualLabels.add(allFacetLabels(disi.docID(), dimension, facetLabelReader));\n       }\n     }\n     return actualLabels;\n   }\n \n+  /**\n+   * Utility method to get all facet labels for an input docId and dimension using the supplied\n+   * {@link FacetLabelReader}.\n+   *\n+   * @param docId docId for which facet labels are needed.\n+   * @param dimension Retain facet labels for supplied dimension only. A null value fetches all facet labels.\n+   * @param facetLabelReader {@FacetLabelReader} instance use to get facet labels for input docId.\n+   * @return {@code List<FacetLabel>} containing matching facet labels.\n+   * @throws IOException when a low-level IO issue occurs while reading facet labels.\n+   */\n+  List<FacetLabel> allFacetLabels(int docId, String dimension, FacetLabelReader facetLabelReader) throws IOException {\n+    List<FacetLabel> facetLabels = new ArrayList<>();\n+    FacetLabel facetLabel;\n+    if (dimension != null) {\n+      for (facetLabel = facetLabelReader.nextFacetLabel(docId, dimension); facetLabel != null; ){", "originalCommit": "cc03488bc67178c6d182263a2100ef05e5acb945", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2NjA2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1928#discussion_r496966066", "bodyText": "Thanks @mikemccand.  This is fixed.", "author": "goankur", "createdAt": "2020-09-29T18:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MjUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MzU1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1928#discussion_r496743559", "bodyText": "Hmm remove this added space?", "author": "mikemccand", "createdAt": "2020-09-29T14:02:47Z", "path": "lucene/facet/src/test/org/apache/lucene/facet/taxonomy/TestTaxonomyFacetCounts.java", "diffHunk": "@@ -696,10 +696,9 @@ public void testRandom() throws Exception {\n               } else {\n                 expectedCounts[j].put(doc.dims[j], v.intValue() + 1);\n               }\n-\n               // Add document facet labels\n               facetLabels.add(new FacetLabel(\"dim\" + j, doc.dims[j]));\n-            }\n+             }", "originalCommit": "cc03488bc67178c6d182263a2100ef05e5acb945", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2NjE5NQ==", "url": "https://github.com/apache/lucene-solr/pull/1928#discussion_r496966195", "bodyText": "Fixed.", "author": "goankur", "createdAt": "2020-09-29T18:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MzU1OQ=="}], "type": "inlineReview"}, {"oid": "cc03488bc67178c6d182263a2100ef05e5acb945", "url": "https://github.com/apache/lucene-solr/commit/cc03488bc67178c6d182263a2100ef05e5acb945", "message": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels", "committedDate": "2020-09-28T23:58:41Z", "type": "forcePushed"}, {"oid": "789747255e4a7a3db6a84eb638f6b3f0a581c74e", "url": "https://github.com/apache/lucene-solr/commit/789747255e4a7a3db6a84eb638f6b3f0a581c74e", "message": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels", "committedDate": "2020-09-29T18:53:59Z", "type": "commit"}, {"oid": "789747255e4a7a3db6a84eb638f6b3f0a581c74e", "url": "https://github.com/apache/lucene-solr/commit/789747255e4a7a3db6a84eb638f6b3f0a581c74e", "message": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels", "committedDate": "2020-09-29T18:53:59Z", "type": "forcePushed"}]}