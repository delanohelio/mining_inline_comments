{"pr_number": 1262, "pr_title": "LUCENE-9220: regenerate all stemmers/stopwords/test data from snowball 2.0", "pr_createdAt": "2020-02-16T00:19:11Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1262", "timeline": [{"oid": "fc229b170197e37ffcbdb330e7657939979a7def", "url": "https://github.com/apache/lucene-solr/commit/fc229b170197e37ffcbdb330e7657939979a7def", "message": "LUCENE-9220 regenerate all stemmers from snowball 2.0\n\nInstead of patching them after-the-fact (both manually and\nautomatically over the years) we patch the generator.\n\nThis is easier to maintain than patches/changes against generated code.\nSee LUCENE-9220 for more information.\n\nThere is a remaining nocommit, test data. Also need to hook in and test\nthe new languages that are added here.", "committedDate": "2020-02-15T23:58:45Z", "type": "commit"}, {"oid": "d9a285c857e632a32f7762c49d2ab8363ae8c876", "url": "https://github.com/apache/lucene-solr/commit/d9a285c857e632a32f7762c49d2ab8363ae8c876", "message": "LUCENE-9220: automate generation of (bsd license-only, sampled) test data", "committedDate": "2020-02-16T04:17:38Z", "type": "commit"}, {"oid": "03aebecf98acab31c608dbcdbf8b5c038c3c02f7", "url": "https://github.com/apache/lucene-solr/commit/03aebecf98acab31c608dbcdbf8b5c038c3c02f7", "message": "LUCENE-9220: regenerate all snowball stopfiles", "committedDate": "2020-02-16T05:36:15Z", "type": "commit"}, {"oid": "8ced733fc3a2b7db61b6d96e5399ae2a2918d3ba", "url": "https://github.com/apache/lucene-solr/commit/8ced733fc3a2b7db61b6d96e5399ae2a2918d3ba", "message": "LUCENE-9220: teach gradle the new snowball-generated boilerplate, too", "committedDate": "2020-02-16T05:54:23Z", "type": "commit"}, {"oid": "8a9fd22e167f7982117db366ae6f27b82ffd77c1", "url": "https://github.com/apache/lucene-solr/commit/8a9fd22e167f7982117db366ae6f27b82ffd77c1", "message": "LUCENE-9220: add snowball regeneration task to gradle", "committedDate": "2020-02-16T14:33:55Z", "type": "commit"}, {"oid": "affb5966838692348e129121bcef928b77af21d6", "url": "https://github.com/apache/lucene-solr/commit/affb5966838692348e129121bcef928b77af21d6", "message": "LUCENE-9220: just fixup tabs/indentation rather than slow reformatting", "committedDate": "2020-02-16T15:49:10Z", "type": "commit"}, {"oid": "39746be9370e8e98bb8826d6376b86f2cbe7508b", "url": "https://github.com/apache/lucene-solr/commit/39746be9370e8e98bb8826d6376b86f2cbe7508b", "message": "LUCENE-9220: tone down debugging now that this works", "committedDate": "2020-02-16T15:56:20Z", "type": "commit"}, {"oid": "7502f591010699ba7bcb486e0e16fdb5574c6c38", "url": "https://github.com/apache/lucene-solr/commit/7502f591010699ba7bcb486e0e16fdb5574c6c38", "message": "LUCENE-9220: add license header", "committedDate": "2020-02-16T16:01:23Z", "type": "commit"}, {"oid": "37ec6d0c8279512a75995273d961877f740c9e2b", "url": "https://github.com/apache/lucene-solr/commit/37ec6d0c8279512a75995273d961877f740c9e2b", "message": "LUCENE-9220: ensure all languages are tested via TestSnowball and TestRandomChains", "committedDate": "2020-02-16T16:31:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNzM4MQ==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380137381", "bodyText": "the latter could be defined relative to snowballWorkDir (${snowballWorkDir}/stemmers)?", "author": "dweiss", "createdAt": "2020-02-17T11:50:01Z", "path": "gradle/generation/snowball.gradle", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: \"de.undercouch.download\"\n+\n+configure(rootProject) {\n+  ext {\n+    snowballWorkDir    = file(\"${buildDir}/snowball\")\n+    snowballStemmerDir = file(\"${buildDir}/snowball/stemmers\")", "originalCommit": "37ec6d0c8279512a75995273d961877f740c9e2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NDAyNA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380144024", "bodyText": "Yes, duh. I'll fix!", "author": "rmuir", "createdAt": "2020-02-17T12:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNzM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODEwNA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380138104", "bodyText": "The \"cleanXXX\" is a rule in gradle... don't know if it's not going to clash with something. Perhaps rename to \"recompileSnowballCheckout\" or something like this?", "author": "dweiss", "createdAt": "2020-02-17T11:51:45Z", "path": "gradle/generation/snowball.gradle", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: \"de.undercouch.download\"\n+\n+configure(rootProject) {\n+  ext {\n+    snowballWorkDir    = file(\"${buildDir}/snowball\")\n+    snowballStemmerDir = file(\"${buildDir}/snowball/stemmers\")\n+    snowballPatchedDir = file(\"${buildDir}/snowball/patched\")\n+    snowballWebsiteDir = file(\"${buildDir}/snowball/website\")\n+    snowballDataDir    = file(\"${buildDir}/snowball/data\")\n+  }\n+\n+  task snowball()  {\n+    description \"Regenerate snowball-based sources, stopwords, and tests for ...lucene/analysis.\"\n+    group \"generation\"\n+\n+    dependsOn \":lucene:analysis:common:snowballGen\"\n+  }\n+\n+  task downloadSnowballStemmers(type: Download) {\n+    def stemmerZip = file(\"${snowballWorkDir}/stemmers.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball/archive/53739a805cfa6c77ff8496dc711dc1c106d987c1.zip\"\n+    dest stemmerZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/stemmers.json\")\n+\n+    doLast {\n+      ant.unzip(src: stemmerZip, dest: snowballStemmerDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task downloadSnowballWebsite(type: Download) {\n+    def websiteZip = file(\"${snowballWorkDir}/website.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball-website/archive/ff891e74f08e7315523ee3c0cad55bb1b7831b9d.zip\"\n+    dest websiteZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/website.json\")\n+\n+    doLast {\n+      ant.unzip(src: websiteZip, dest: snowballWebsiteDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task downloadSnowballData(type: Download) {\n+    def dataZip = file(\"${snowballWorkDir}/data.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball-data/archive/9145f8732ec952c8a3d1066be251da198a8bc792.zip\"\n+    dest dataZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/data.json\")\n+\n+    doLast {\n+      ant.unzip(src: dataZip, dest: snowballDataDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task cleanSnowballCheckout(type: Delete) {", "originalCommit": "37ec6d0c8279512a75995273d961877f740c9e2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODU1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380138559", "bodyText": "Oh. Could also be a doFirst { project.delete snowballPatchedDir } on the downloadSnowballStemmers?", "author": "dweiss", "createdAt": "2020-02-17T11:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0MzE5Mw==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380143193", "bodyText": "yeah mainly i'm after two things:\n\ndon't download stuff if you have downloaded it before (uses ETag check). Some files are quite large.\nbefore patching, make a clean copy of checkout. This way we don't ever try to apply patch twice and don't force downloading again.\n\nWe can change to a doFirst I think. Lemme try.", "author": "rmuir", "createdAt": "2020-02-17T12:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NDgxOA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380144818", "bodyText": "At first hand the doFirst trick should be equivalent to the task dependencies the way you defined them. Let me know if this turns into a problem though.\nA way to properly \"download once\" would be to define a configuration dependency with a custom resolver and let gradle cache the artifact... but it's too much of work for a small gain I think. What you did is already an improvement and we regenerate that stuff infrequently.", "author": "dweiss", "createdAt": "2020-02-17T12:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1ODg2MQ==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380158861", "bodyText": "It worked fine as a doFirst. Here is the issue: it is nice that gradlew snowball is fast and not downloading 30MB files (!) every time you run it, if you are trying to iterate locally, for example to actually upgrade it.\nSo while it may be infrequent, I wanted to make it more pleasant for running this over and over until you get it right, because you will be dealing with plenty of other unpleasant stuff...", "author": "rmuir", "createdAt": "2020-02-17T12:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380138880", "bodyText": "ant.patch just redirects to local filesystem patch command (doesn't work on Windows). Sigh. Fine with me though.", "author": "dweiss", "createdAt": "2020-02-17T11:53:23Z", "path": "gradle/generation/snowball.gradle", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: \"de.undercouch.download\"\n+\n+configure(rootProject) {\n+  ext {\n+    snowballWorkDir    = file(\"${buildDir}/snowball\")\n+    snowballStemmerDir = file(\"${buildDir}/snowball/stemmers\")\n+    snowballPatchedDir = file(\"${buildDir}/snowball/patched\")\n+    snowballWebsiteDir = file(\"${buildDir}/snowball/website\")\n+    snowballDataDir    = file(\"${buildDir}/snowball/data\")\n+  }\n+\n+  task snowball()  {\n+    description \"Regenerate snowball-based sources, stopwords, and tests for ...lucene/analysis.\"\n+    group \"generation\"\n+\n+    dependsOn \":lucene:analysis:common:snowballGen\"\n+  }\n+\n+  task downloadSnowballStemmers(type: Download) {\n+    def stemmerZip = file(\"${snowballWorkDir}/stemmers.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball/archive/53739a805cfa6c77ff8496dc711dc1c106d987c1.zip\"\n+    dest stemmerZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/stemmers.json\")\n+\n+    doLast {\n+      ant.unzip(src: stemmerZip, dest: snowballStemmerDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task downloadSnowballWebsite(type: Download) {\n+    def websiteZip = file(\"${snowballWorkDir}/website.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball-website/archive/ff891e74f08e7315523ee3c0cad55bb1b7831b9d.zip\"\n+    dest websiteZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/website.json\")\n+\n+    doLast {\n+      ant.unzip(src: websiteZip, dest: snowballWebsiteDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task downloadSnowballData(type: Download) {\n+    def dataZip = file(\"${snowballWorkDir}/data.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball-data/archive/9145f8732ec952c8a3d1066be251da198a8bc792.zip\"\n+    dest dataZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/data.json\")\n+\n+    doLast {\n+      ant.unzip(src: dataZip, dest: snowballDataDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task cleanSnowballCheckout(type: Delete) {\n+    dependsOn downloadSnowballStemmers\n+    delete snowballPatchedDir\n+  }\n+\n+  task patchSnowball(type: Copy) {\n+    dependsOn cleanSnowballCheckout\n+\n+    from fileTree(snowballStemmerDir) {\n+      include '**/*'\n+    }\n+    into snowballPatchedDir\n+\n+    doLast {\n+      ant.patch(patchfile: rootProject.file(\"gradle/generation/snowball.patch\"), dir: snowballPatchedDir, strip: \"1\")", "originalCommit": "37ec6d0c8279512a75995273d961877f740c9e2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NDUxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380144519", "bodyText": "I think if you have patch.exe on windows then this part will work?", "author": "rmuir", "createdAt": "2020-02-17T12:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NjA2Mw==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380146063", "bodyText": "Not many people do (I don't). You'd need to run under cygwin or have msys tools installed (which are recompiled for Windows). I don't think this is a problem. I don't think there is a single Windows developer who isn't fluent on other environments. If a regeneration task does not work on Windows so be it (I'd make it complain gracefully but this can come later).", "author": "dweiss", "createdAt": "2020-02-17T12:10:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NjYwNA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380146604", "bodyText": "I looked into platform-independent patch command implementation but I didn't find any (jgit's is inherently broken; @kojisekig wrote something for jenkins but I didn't look into that - maybe he'll have some more insight).", "author": "dweiss", "createdAt": "2020-02-17T12:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2MDc5Mg==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380160792", "bodyText": "Maybe we can focus on trying to remove the patch completely (try to package up some PRs for snowball team) and it gets fixed even before their Makefile supports windows :)\nI guess I optimistically hope the patch solution is a temporary one. If you look deeper into shell script and snowball GNUMakefile, it may be obvious that we have other issues to fix for windows first.", "author": "rmuir", "createdAt": "2020-02-17T12:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2OTY2MA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380169660", "bodyText": "That download task is broken in that it still executes actions even if the artifact is up to date... You can just delete the unpacked stuff and not the downloaded zip; then it'll wipe and unzip but not download again?", "author": "dweiss", "createdAt": "2020-02-17T13:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3MzY1OQ==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380173659", "bodyText": "@dweiss I can assure you it does not download again. Please look at the PR, maybe the names are confusing and we can clean it up? I think logic is correct.\nHere is what happens (first run):\n\ndownload github.com/snowball/xyz.zip to snowball.zip. It extracts this to stemmers/. It saves Etag to stemmers.json.\ncreate a clean copy of stemmers/ named patched/.\napply patch to patched/.\n\nSecond run:\n\nTries to download, but sends request with If-None-Match: a4gk4k4.... Remote server returns a HTTP 304 (Not Modified). This would not be the case if, e.g. someone bumped the snowball commit hash locally.\ncreate a clean copy of stemmers/ named patched/.\napply patch to patched/.", "author": "rmuir", "createdAt": "2020-02-17T13:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3NTM4Ng==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380175386", "bodyText": "I know it doesn't download twice but if it declared inputs/ outputs or upToDateWhen correctly then it shouldn't run any actions attached to the task (doFirst/ doLast) and it does it now, regardless of whether it downloaded the artifact or not, right (that was my impression from other sections of the code, no this patch).\nAnyway, if it's working then fine. As for different versions of patch -- throw git/ jgit's implementation in the mix... they all seem to be behaving differently in corner cases.", "author": "dweiss", "createdAt": "2020-02-17T13:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3NTYwNA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380175604", "bodyText": "note this same trick (HTTP cache revalidation) cannot be used for moman, because its server disables caching completely and doesn't send such headers. In fact the server does not even respond correctly to requests with curl (unless you modify User-Agent header) so it is clear they are not excited about lots of automated requests, so it should be improved some other way...", "author": "rmuir", "createdAt": "2020-02-17T13:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3ODMwOA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380178308", "bodyText": "@dweiss ok, I will look at inputs/outputs/upToDateWhen. Maybe a simpler way is for these tools to download to a file with commit's hash in the name and declare such stuff? We'd be able to fix moman to not download over and over too (cache headers cannot work over there).", "author": "rmuir", "createdAt": "2020-02-17T13:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE4MjYwMw==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380182603", "bodyText": "This isn't something you have to look into, Rob. I'm just adding some comments, that's it. The patch is fine.\nThe simplest way of making the task not download the file again would be to declare an inputs.file(path-to-zip) I think. But it's really a marginal issue, I wouldn't spend any special time on this if it works.", "author": "dweiss", "createdAt": "2020-02-17T13:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE4NTYzNA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380185634", "bodyText": "@dweiss So we can add these dependencies, but I just don't want it to patch twice :) That's kinda why their is an explicit \"clean\" here to create patched/ work area.\nI think behavior is fast enough for a first go and we can followup? It takes 26s the first time and 4s the second time for me.\nI am worried about making it too smart and declaring such dependencies incorrectly. I want to make sure it does the right thing if you e.g. update commit hash/patch file, or change script, so that its easier to upgrade snowball.", "author": "rmuir", "createdAt": "2020-02-17T13:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE4OTM5NQ==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380189395", "bodyText": "It wasn't my intention to change the patch - these were my random musings about gradle, the download task, etc. It's definitely fine for committing in and can be improved later (or never if we can convince people from snowball to generate better code).", "author": "dweiss", "createdAt": "2020-02-17T13:44:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5MDcyMg==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380190722", "bodyText": "Yes but if you teach a man to fish... I will look into it. Its just tricky, for example patching task in my mind depends on \"cleanCheckoutOfCurrentlySpecifiedCommitHash + input patch file itself\". and maybe we must \"touch\" an output file indicating patch was applied. This way it doesn't try to apply it twice. At least this is how i would do it with something like make", "author": "rmuir", "createdAt": "2020-02-17T13:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNTg2Mg==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380205862", "bodyText": "Declare inputs on the zip and move applying the patch to inside the download task action (you don't even have to copy the unpacked folder then), execute patching in doLast; if it fails the entire task won't be up-to-date (will be re-run)? Just a thought.", "author": "dweiss", "createdAt": "2020-02-17T14:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzODg4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTM3Nw==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380139377", "bodyText": "Why not move all these tasks into lucene:analysis:common configuration? Are they reused anywhere else? If not then it'd make everything local to the project.", "author": "dweiss", "createdAt": "2020-02-17T11:54:33Z", "path": "gradle/generation/snowball.gradle", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: \"de.undercouch.download\"\n+\n+configure(rootProject) {\n+  ext {\n+    snowballWorkDir    = file(\"${buildDir}/snowball\")\n+    snowballStemmerDir = file(\"${buildDir}/snowball/stemmers\")\n+    snowballPatchedDir = file(\"${buildDir}/snowball/patched\")\n+    snowballWebsiteDir = file(\"${buildDir}/snowball/website\")\n+    snowballDataDir    = file(\"${buildDir}/snowball/data\")\n+  }\n+\n+  task snowball()  {\n+    description \"Regenerate snowball-based sources, stopwords, and tests for ...lucene/analysis.\"\n+    group \"generation\"\n+\n+    dependsOn \":lucene:analysis:common:snowballGen\"\n+  }\n+\n+  task downloadSnowballStemmers(type: Download) {\n+    def stemmerZip = file(\"${snowballWorkDir}/stemmers.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball/archive/53739a805cfa6c77ff8496dc711dc1c106d987c1.zip\"\n+    dest stemmerZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/stemmers.json\")\n+\n+    doLast {\n+      ant.unzip(src: stemmerZip, dest: snowballStemmerDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task downloadSnowballWebsite(type: Download) {\n+    def websiteZip = file(\"${snowballWorkDir}/website.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball-website/archive/ff891e74f08e7315523ee3c0cad55bb1b7831b9d.zip\"\n+    dest websiteZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/website.json\")\n+\n+    doLast {\n+      ant.unzip(src: websiteZip, dest: snowballWebsiteDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task downloadSnowballData(type: Download) {\n+    def dataZip = file(\"${snowballWorkDir}/data.zip\")\n+\n+    src \"https://github.com/snowballstem/snowball-data/archive/9145f8732ec952c8a3d1066be251da198a8bc792.zip\"\n+    dest dataZip\n+    onlyIfModified true\n+    useETag \"all\"\n+    cachedETagsFile file(\"${snowballWorkDir}/data.json\")\n+\n+    doLast {\n+      ant.unzip(src: dataZip, dest: snowballDataDir, overwrite: \"true\") {\n+        ant.cutdirsmapper(dirs: \"1\")\n+      }\n+    }\n+  }\n+\n+  task cleanSnowballCheckout(type: Delete) {\n+    dependsOn downloadSnowballStemmers\n+    delete snowballPatchedDir\n+  }\n+\n+  task patchSnowball(type: Copy) {\n+    dependsOn cleanSnowballCheckout\n+\n+    from fileTree(snowballStemmerDir) {\n+      include '**/*'\n+    }\n+    into snowballPatchedDir\n+\n+    doLast {\n+      ant.patch(patchfile: rootProject.file(\"gradle/generation/snowball.patch\"), dir: snowballPatchedDir, strip: \"1\")\n+    }\n+  }\n+}\n+\n+configure(project(\":lucene:analysis:common\")) {\n+  task snowballGen() {\n+    description \"Patch and Regenerate snowball sources, stopwords, and tests\"\n+    group \"generation\"\n+    dependsOn rootProject.patchSnowball", "originalCommit": "37ec6d0c8279512a75995273d961877f740c9e2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NTA5OA==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380145098", "bodyText": "I can look into it. I am pretty clueless on gradle, I based this on the moman regeneration that is located in gradle/generation/util.gradle. Because it is doing similar stuff (downloading zip and running commands).", "author": "rmuir", "createdAt": "2020-02-17T12:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NTI4MQ==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380145281", "bodyText": "Commit it in, I'll correct it afterwards, no worries.", "author": "dweiss", "createdAt": "2020-02-17T12:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1MjQwMg==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380152402", "bodyText": "ok I think this is now better. Now tasks are under analysis common, downloads stuff to lucene/analysis/common/build instead of build/ and all tasks are under that project, except a single top-level one with the description that depends on it.", "author": "rmuir", "createdAt": "2020-02-17T12:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1NTIwNw==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380155207", "bodyText": "Thanks Robert. FYI: the moman build could be modified the same way. There is a root project dependency section in javacc.gradle but the rationale behind it is that it's a configuration dependency then shared by different subprojects (and a task that requires javacc).", "author": "dweiss", "createdAt": "2020-02-17T12:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzOTc2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380139766", "bodyText": "Love the old school (sed). :)", "author": "dweiss", "createdAt": "2020-02-17T11:55:26Z", "path": "gradle/generation/snowball.sh", "diffHunk": "@@ -0,0 +1,122 @@\n+#!/usr/bin/env bash\n+\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# remove this script when problems are fixed\n+SRCDIR=$1\n+WWWSRCDIR=$2\n+TESTSRCDIR=$3\n+PROJECTDIR=$4\n+DESTDIR=\"${PROJECTDIR}/src/java/org/tartarus/snowball\"\n+WWWDSTDIR=\"${PROJECTDIR}/src/resources/org/apache/lucene/analysis/snowball\"\n+TESTDSTDIR=\"${PROJECTDIR}/src/test/org/apache/lucene/analysis/snowball\"\n+\n+trap 'echo \"usage: ./snowball.sh <snowball> <snowball-website> <snowball-data> <analysis-common>\" && exit 2' ERR\n+test $# -eq 4\n+\n+trap 'echo \"*** BUILD FAILED ***\" $BASH_SOURCE:$LINENO: error: \"$BASH_COMMAND\" returned $?' ERR\n+set -eEuo pipefail\n+\n+# reformats file indentation to kill the crazy space/tabs mix.\n+# prevents early blindness !\n+function reformat_java() {\n+  # convert tabs to 8 spaces, then reduce indent from 4 space to 2 space\n+  sed --in-place -e 's/\\t/        /g' -e 's/    /  /g' $1", "originalCommit": "37ec6d0c8279512a75995273d961877f740c9e2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0MDE4Mg==", "url": "https://github.com/apache/lucene-solr/pull/1262#discussion_r380140182", "bodyText": "Thanks for cleaning these up from ant.", "author": "dweiss", "createdAt": "2020-02-17T11:56:24Z", "path": "lucene/analysis/common/build.xml", "diffHunk": "@@ -124,14 +122,4 @@\n \n   <target name=\"regenerate\" depends=\"jflex,unicode-data\"/>\n \n-  <target name=\"patch-snowball\" description=\"Patches all snowball programs in '${snowball.programs.dir}' to make them work with MethodHandles\">", "originalCommit": "37ec6d0c8279512a75995273d961877f740c9e2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "600bb7e5d7764f5e1346d411a6928246be01258b", "url": "https://github.com/apache/lucene-solr/commit/600bb7e5d7764f5e1346d411a6928246be01258b", "message": "LUCENE-9220: move all this stuff to lucene/analysis/common, leaving just one task at the root that depends on it", "committedDate": "2020-02-17T12:23:33Z", "type": "commit"}, {"oid": "9f43c5a3322feb2a6391da83c5ad34e2b4fa2a03", "url": "https://github.com/apache/lucene-solr/commit/9f43c5a3322feb2a6391da83c5ad34e2b4fa2a03", "message": "LUCENE-9220: remove confusingly-named gradle task and replace with a doFirst", "committedDate": "2020-02-17T12:37:09Z", "type": "commit"}, {"oid": "d1d8745b3efbb6584de42a7140aa21ea60030f75", "url": "https://github.com/apache/lucene-solr/commit/d1d8745b3efbb6584de42a7140aa21ea60030f75", "message": "LUCENE-9220: make generation of test data reproducible across different OS", "committedDate": "2020-02-17T14:14:49Z", "type": "commit"}, {"oid": "a250c4c7198c3ce7138f8ef50a0f7dcf90877f6d", "url": "https://github.com/apache/lucene-solr/commit/a250c4c7198c3ce7138f8ef50a0f7dcf90877f6d", "message": "LUCENE-9220: use perl (snowball Makefile already requires it) instead of sed, to avoid system differences", "committedDate": "2020-02-17T14:31:02Z", "type": "commit"}, {"oid": "b38a876f5b3a1accd50c1a4d76361729747cb1bb", "url": "https://github.com/apache/lucene-solr/commit/b38a876f5b3a1accd50c1a4d76361729747cb1bb", "message": "LUCENE-9220: simplify by naming directories by commit hash, adding input dependency of patch file, etc.", "committedDate": "2020-02-17T15:23:54Z", "type": "commit"}, {"oid": "86e2c8311c1255779c6c0b29c4c25488738088c0", "url": "https://github.com/apache/lucene-solr/commit/86e2c8311c1255779c6c0b29c4c25488738088c0", "message": "LUCENE-9220: use more robust download (in case of kill -9 or jvm crash)", "committedDate": "2020-02-17T15:47:38Z", "type": "commit"}, {"oid": "76ed7d2cc3a4ed0681b262385d59127b2377a75f", "url": "https://github.com/apache/lucene-solr/commit/76ed7d2cc3a4ed0681b262385d59127b2377a75f", "message": "LUCENE-9220: simplify regeneration logic, handle if language gets deleted, etc", "committedDate": "2020-02-17T16:13:44Z", "type": "commit"}, {"oid": "6dfa1cd3a643ce559a223b89c206e178b64691f4", "url": "https://github.com/apache/lucene-solr/commit/6dfa1cd3a643ce559a223b89c206e178b64691f4", "message": "LUCENE-9220: add CHANGES.txt entry", "committedDate": "2020-02-17T16:29:05Z", "type": "commit"}]}