{"pr_number": 1675, "pr_title": "SOLR-14652: SolrCore should hold its own CoreDescriptor", "pr_createdAt": "2020-07-16T04:39:06Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1675", "timeline": [{"oid": "d3dcb6238c199ef9865c4ae0ca2b9e99c28558cf", "url": "https://github.com/apache/lucene-solr/commit/d3dcb6238c199ef9865c4ae0ca2b9e99c28558cf", "message": "SOLR-14652: SolrCore should hold its own CoreDescriptor\n(minor refactoring)\nAlso:\n* SolrCore's constructors don't need a \"name\" since it's guaranteed to always be the name in the coreDescriptor.\u00a0 I checked.\n* SolrCore's constructor shouldn't call coreContainer.solrCores.addCoreDescriptor(cd); because it's the container's responsibility to manage such things.\u00a0 I made SolrCores.putCore ensure the descriptor is added, and this is called by CoreContainer.registerCore which is called after new SolrCore instances are created.\n* solrCore.setName should only be called when we expect the name to change.\u00a0 Furthermore that shouldn't ever happen in SolrCloud so I added checks.\n* solrCore.setName calls coreMetricManager.afterCoreSetName() which is something that is really only related to a rename, not name initialization\u00a0(from the constructor).\u00a0 I renamed that method and further only call it if the name did change from non-null.\u00a0\u00a0", "committedDate": "2020-07-16T04:34:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyNzczMg==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r456527732", "bodyText": "Should it call apiAssumeStandalone()?", "author": "bruno-roustant", "createdAt": "2020-07-17T15:51:16Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -487,10 +488,13 @@ public String getName() {\n   }\n \n   public void setName(String v) {\n+    Objects.requireNonNull(v);\n+    boolean renamed = this.name != null && !this.name.equals(v);\n+    assert !renamed || coreDescriptor.getCloudDescriptor() == null : \"Cores are not renamed in SolrCloud\";", "originalCommit": "d3dcb6238c199ef9865c4ae0ca2b9e99c28558cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4NDI1Mg==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r456684252", "bodyText": "I chose to name \"apiAssumeStandalone\" that because it's intended for primary service/API methods (likely coming from a user) yielding a BAD_REQUEST instead of SERVER_ERROR.  SolrCore.setName is more of an internal detail method where an assertion seemed best.  Perhaps I should add a method on SolrCore \"isSolrCloud\" or \"isStandalone\" and/or assumeStandalone or assumeSolrCloud and use these more pervasively?  I feel that could be its own issue since there are many places that could be enhanced/clarified to use this.  Across Solr there are various techniques like checking the subclass of the core's SolrResourceLoader or checking if the CoreContainer has a ZkController.  A consistent approach would be nicer; perhaps separate for CoreContainer level vs SolrCore level", "author": "dsmiley", "createdAt": "2020-07-17T21:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyNzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE3NDkwNQ==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r457174905", "bodyText": "+1 to have a consistent and more pervasive approach. It would first make the code clearer to use, and would probably avoid bugs.", "author": "bruno-roustant", "createdAt": "2020-07-20T08:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyNzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0NTIxNw==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r457845217", "bodyText": "I'll file a new issue for that.", "author": "dsmiley", "createdAt": "2020-07-21T05:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyNzczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUzMDU2Nw==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r456530567", "bodyText": "Should it call apiAssumeStandalone()?", "author": "bruno-roustant", "createdAt": "2020-07-17T15:56:30Z", "path": "solr/core/src/java/org/apache/solr/metrics/SolrCoreMetricManager.java", "diffHunk": "@@ -92,10 +92,10 @@ public void loadReporters() {\n    * are carried over and will be used under the new core name.\n    * This method also reloads reporters so that they use the new core name.\n    */\n-  public void afterCoreSetName() {\n+  public void afterCoreRename() {\n+    assert core.getCoreDescriptor().getCloudDescriptor() == null;", "originalCommit": "d3dcb6238c199ef9865c4ae0ca2b9e99c28558cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83142f21ad75f477e9e38c67921c94f3d6d52dc1", "url": "https://github.com/apache/lucene-solr/commit/83142f21ad75f477e9e38c67921c94f3d6d52dc1", "message": "Merge branch 'master' into solr-14652\n\n# Conflicts:\n#\tsolr/core/src/java/org/apache/solr/core/SolrCore.java", "committedDate": "2020-07-21T05:34:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODExNzUwNw==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r458117507", "bodyText": "change java doc reflecting this change", "author": "juanka588", "createdAt": "2020-07-21T13:57:45Z", "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -1788,6 +1786,7 @@ public void unload(String name, boolean deleteIndexDir, boolean deleteDataDir, b\n   }\n \n   public void rename(String name, String toName) {\n+    apiAssumeStandalone();", "originalCommit": "83142f21ad75f477e9e38c67921c94f3d6d52dc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NjI4NA==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r460366284", "bodyText": "I think it'd be more pertinent to update the Solr Ref Guide, which is what users would see.  This method here is very internal.  At least if a user tries it, it'll now not work with an error telling them so, as opposed to before, bad things would probably happen.", "author": "dsmiley", "createdAt": "2020-07-25T05:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODExNzUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4ODYxMw==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r460288613", "bodyText": "More clear as !v.equals(this.name) I think?", "author": "madrob", "createdAt": "2020-07-24T21:07:33Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -497,10 +498,13 @@ public String getName() {\n   }\n \n   public void setName(String v) {\n+    Objects.requireNonNull(v);\n+    boolean renamed = this.name != null && !this.name.equals(v);", "originalCommit": "83142f21ad75f477e9e38c67921c94f3d6d52dc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2NTg4NA==", "url": "https://github.com/apache/lucene-solr/pull/1675#discussion_r460365884", "bodyText": "I must check if this.name != null because I don't want to consider an initial population (from constructor) a rename even though in some sense one could argue it is.\nI'll follow up this PR with removal of the existence of logid which will have the effect of simplifying setName which will in turn make it clearer to have the constructor simply set the name without calling setName.  At that point I might also rename setName to rename and ensure it's only called to actually do a rename.   Right now the constructor deserves to be calling setName because it populates logid and I wouldn't want that logic duplicated.", "author": "dsmiley", "createdAt": "2020-07-25T05:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4ODYxMw=="}], "type": "inlineReview"}]}