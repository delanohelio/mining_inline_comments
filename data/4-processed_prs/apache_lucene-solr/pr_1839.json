{"pr_number": 1839, "pr_title": "LUCENE-9511: Include StoredFieldsWriter in DWPT accounting", "pr_createdAt": "2020-09-07T20:19:10Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1839", "timeline": [{"oid": "50a7881e94acd048f6da3f5a400998aba2646d86", "url": "https://github.com/apache/lucene-solr/commit/50a7881e94acd048f6da3f5a400998aba2646d86", "message": "LUCENE-9511: Include StoredFieldsWriter in DWPT accounting\n\nStoredFieldsWriter might consume some heap space memory that\ncan have a significant impact on decisions made in the IW if\nwriters should be stalled or DWPTs should be flushed if memory\nsettings are small in IWC and flushes are frequent. This change adds\nRAM accounting to the StoredFieldsWriter since it's part of the\nDWPT lifecycle and not just present during flush.", "committedDate": "2020-09-07T20:16:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTA2NA==", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484909064", "bodyText": "Whoa, this was a latent (over-counting) bug?  Maybe grep for other places we are possibly incorrectly using Integer.SIZE!\nThough, I think this array is typically tiny (usually 0 length), since it holds docs that hit non-aborting exception during indexing?", "author": "mikemccand", "createdAt": "2020-09-08T13:20:09Z", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -351,7 +354,7 @@ FlushedSegment flush(DocumentsWriter.FlushNotifications flushNotifications) thro\n         flushState.liveDocs.clear(deleteDocIDs[i]);\n       }\n       flushState.delCountOnFlush = numDeletedDocIds;\n-      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.SIZE));\n+      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.BYTES));", "originalCommit": "50a7881e94acd048f6da3f5a400998aba2646d86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzMDQzNw==", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r485030437", "bodyText": "yeah I checked all instanced in our codebase after I found this.", "author": "s1monw", "createdAt": "2020-09-08T15:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTM0MQ==", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484909341", "bodyText": "Also a latent over-counting bug?", "author": "mikemccand", "createdAt": "2020-09-08T13:20:22Z", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -292,7 +295,7 @@ private void deleteLastDocs(int docCount) {\n     for (int docId = from; docId < to; docId++) {\n       deleteDocIDs[numDeletedDocIds++] = docId;\n     }\n-    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.SIZE);\n+    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.BYTES);", "originalCommit": "50a7881e94acd048f6da3f5a400998aba2646d86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzMDU5MQ==", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r485030591", "bodyText": "yeah same thing", "author": "s1monw", "createdAt": "2020-09-08T15:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkxNzYzMw==", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484917633", "bodyText": "So we are breaking out a separate Counter for DefaultIndexingChain, from DWPT, when previously they shared the same counter?", "author": "mikemccand", "createdAt": "2020-09-08T13:27:24Z", "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -52,7 +52,7 @@\n /** Default general purpose indexing chain, which handles\n  *  indexing all types of fields. */\n final class DefaultIndexingChain extends DocConsumer {\n-  final Counter bytesUsed;\n+  final Counter bytesUsed = Counter.newCounter();", "originalCommit": "50a7881e94acd048f6da3f5a400998aba2646d86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzMTAxNw==", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r485031017", "bodyText": "exactly that's the main change here otherwise we need to do back and forth accounting inside the StoredFieldsWriter", "author": "s1monw", "createdAt": "2020-09-08T15:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkxNzYzMw=="}], "type": "inlineReview"}, {"oid": "2ee61746783edaac079926e706fb4de4db9b1213", "url": "https://github.com/apache/lucene-solr/commit/2ee61746783edaac079926e706fb4de4db9b1213", "message": "add changes", "committedDate": "2020-09-08T16:17:40Z", "type": "commit"}]}