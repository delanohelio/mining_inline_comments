{"pr_number": 1917, "pr_title": "LUCENE-9535: Make ByteBuffersDataOutput#ramBytesUsed run in constant-time.", "pr_createdAt": "2020-09-23T16:38:41Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1917", "timeline": [{"oid": "5107216320bf6db2180b0df5a9d5a2aed4b7a220", "url": "https://github.com/apache/lucene-solr/commit/5107216320bf6db2180b0df5a9d5a2aed4b7a220", "message": "LUCENE-9535: Make ByteBuffersDataOutput#ramBytesUsed run in constant-time.", "committedDate": "2020-09-23T16:05:24Z", "type": "commit"}, {"oid": "d44d01f523c773dc5de74f6188470dfd7ac30c16", "url": "https://github.com/apache/lucene-solr/commit/d44d01f523c773dc5de74f6188470dfd7ac30c16", "message": "iter", "committedDate": "2020-09-23T16:47:54Z", "type": "commit"}, {"oid": "db41ed8b6a2677115de9ace99959e3a8bdd5df56", "url": "https://github.com/apache/lucene-solr/commit/db41ed8b6a2677115de9ace99959e3a8bdd5df56", "message": "iter", "committedDate": "2020-09-23T17:02:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMTAwOA==", "url": "https://github.com/apache/lucene-solr/pull/1917#discussion_r494311008", "bodyText": "Hmmm... Do they? I don't think this is the case, in general, since you can plug in an arbitrary block provider/ recycler?", "author": "dweiss", "createdAt": "2020-09-24T13:21:05Z", "path": "lucene/core/src/java/org/apache/lucene/store/ByteBuffersDataOutput.java", "diffHunk": "@@ -400,8 +400,13 @@ public void writeSetOfStrings(Set<String> set) {\n   public long ramBytesUsed() {\n     // Return a rough estimation for allocated blocks. Note that we do not make\n     // any special distinction for direct memory buffers.\n-    return RamUsageEstimator.NUM_BYTES_OBJECT_REF * blocks.size() + \n-           blocks.stream().mapToLong(buf -> buf.capacity()).sum();\n+    ByteBuffer first = blocks.peek();\n+    if (first == null) {\n+      return 0L;\n+    } else {\n+      // All blocks have the same capacity.", "originalCommit": "db41ed8b6a2677115de9ace99959e3a8bdd5df56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNDAyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1917#discussion_r494314029", "bodyText": "I'm not sure I like this assumption (that all blocks are equal). Maybe we could maintain a separate ram usage on block addition/ removal and thus make the sum-time constant but also accurate?", "author": "dweiss", "createdAt": "2020-09-24T13:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMTAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNzE4Mw==", "url": "https://github.com/apache/lucene-solr/pull/1917#discussion_r494317183", "bodyText": "Oops thanks for catching. I thought they did because we make the assumption that all buffers have the same length in toDataInput, which is different from capacity.", "author": "jpountz", "createdAt": "2020-09-24T13:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMTAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNzQ0MQ==", "url": "https://github.com/apache/lucene-solr/pull/1917#discussion_r494317441", "bodyText": "Yep, I'll do that.", "author": "jpountz", "createdAt": "2020-09-24T13:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMTAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1Mjk1Ng==", "url": "https://github.com/apache/lucene-solr/pull/1917#discussion_r494352956", "bodyText": "Thanks Adrien!", "author": "dweiss", "createdAt": "2020-09-24T14:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMTAwOA=="}], "type": "inlineReview"}]}