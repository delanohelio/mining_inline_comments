{"pr_number": 1394, "pr_title": "LUCENE-9300: Fix field infos update on doc values update", "pr_createdAt": "2020-04-01T11:05:01Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1394", "timeline": [{"oid": "0619658b363cf911d2f2916eb1f3efa5514b34c7", "url": "https://github.com/apache/lucene-solr/commit/0619658b363cf911d2f2916eb1f3efa5514b34c7", "message": "LUCENE-9300: Fix field infos update on doc values update\n\nToday a doc values update creates a new field infos file that contains the original field infos updated for the new generation as well as the new fields created by the doc values update.\n\nHowever existing fields are cloned through the global fields (shared in the index writer) instead of the local ones (present in the segment).\nIn practice this is not an issue since field numbers are shared between segments created by the same index writer.\nBut this assumption doesn't hold for segments created by different writers and added through IndexWriter#addIndexes(Directory).\nIn this case, the field number of the same field can differ between segments so any doc values update can corrupt the index\nby assigning the wrong field number to an existing field in the next generation.\n\nWhen this happens, queries and merges can access wrong fields without throwing any error, leading to a silent corruption in the index.\n\nThis change ensures that we preserve local field numbers when creating\na new field infos generation.", "committedDate": "2020-04-01T11:02:54Z", "type": "commit"}, {"oid": "a5084d15c0137d113b81a66eb27738a7b5dd2f32", "url": "https://github.com/apache/lucene-solr/commit/a5084d15c0137d113b81a66eb27738a7b5dd2f32", "message": "fix precommit", "committedDate": "2020-04-01T11:16:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1OTk1NQ==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401559955", "bodyText": "after?", "author": "juanka588", "createdAt": "2020-04-01T11:58:18Z", "path": "lucene/core/src/test/org/apache/lucene/index/TestNumericDocValuesUpdates.java", "diffHunk": "@@ -1483,6 +1484,81 @@ public void testAddIndexes() throws Exception {\n     IOUtils.close(dir1, dir2);\n   }\n \n+  public void testUpdatesAterAddIndexes() throws Exception {", "originalCommit": "a5084d15c0137d113b81a66eb27738a7b5dd2f32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3MjUyNA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401672524", "bodyText": "thanks, abd5e08", "author": "jimczi", "createdAt": "2020-04-01T14:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1OTk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxOTAwMA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401619000", "bodyText": "Had a quick discussion about this line with Jim. This isn't good enough as this might return a field number that already exists in the reader if the field exists in the writer with a number that it less than the number of fields in the reader.", "author": "jpountz", "createdAt": "2020-04-01T13:34:46Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,30 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = new FieldInfo(fi);\n+          newFields.put(clone.name, clone);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo fi = newFields.get(update.field);\n+          if (fi == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            fi = builder.getOrAdd(update.field);", "originalCommit": "a5084d15c0137d113b81a66eb27738a7b5dd2f32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY3MjQzNQ==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401672435", "bodyText": "How to introduce the same bug but the other way around :(. Thanks for catching this Adrien. I pushed abd5e08 to handle this case properly.", "author": "jimczi", "createdAt": "2020-04-01T14:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxOTAwMA=="}], "type": "inlineReview"}, {"oid": "abd5e08170cc8b7963c0aff3d58afa5766afcb32", "url": "https://github.com/apache/lucene-solr/commit/abd5e08170cc8b7963c0aff3d58afa5766afcb32", "message": "address comment", "committedDate": "2020-04-01T14:45:02Z", "type": "commit"}, {"oid": "387a7c30eaee45771491b4ff9e8afeff3dac63a8", "url": "https://github.com/apache/lucene-solr/commit/387a7c30eaee45771491b4ff9e8afeff3dac63a8", "message": "unused import", "committedDate": "2020-04-01T14:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxOTMyMA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401719320", "bodyText": "Do we need to set the doc-value type before cloning to make sure the doc-value type is set on the writer? I also wonder if we should use FieldInfos.Builder since this logic you implemented looks similar to FieldInfos.Builder#add.", "author": "jpountz", "createdAt": "2020-04-01T15:48:01Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,36 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo fi = newFields.get(update.field);\n+          if (fi == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            fi = builder.getOrAdd(update.field);\n+            if (fi.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              fi = cloneFieldInfo(fi, ++maxFieldNumber);", "originalCommit": "387a7c30eaee45771491b4ff9e8afeff3dac63a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc0OTc5OQ==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401749799", "bodyText": "I also wonder if we should use FieldInfos.Builder since this logic you implemented looks similar to FieldInfos.Builder#add.\n\nI don't think it works since the logic there is to use the global field number if the field already exists in another segment. In the logic above we try to re-assign the global field number locally since it clashes with a local one.", "author": "jimczi", "createdAt": "2020-04-01T16:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxOTMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc1MDE1NA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401750154", "bodyText": "Do we need to set the doc-value type before cloning to make sure the doc-value type is set on the writer?\n\nthanks, I pushed 090ef78", "author": "jimczi", "createdAt": "2020-04-01T16:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxOTMyMA=="}], "type": "inlineReview"}, {"oid": "090ef78171dfe671b0fb1ab238951fdd617bd65c", "url": "https://github.com/apache/lucene-solr/commit/090ef78171dfe671b0fb1ab238951fdd617bd65c", "message": "set the dv types of the field info before cloning", "committedDate": "2020-04-01T16:21:35Z", "type": "commit"}, {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "url": "https://github.com/apache/lucene-solr/commit/8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "message": "also update dv type globally", "committedDate": "2020-04-01T19:31:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyNTkzOA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402225938", "bodyText": "Sorry I wasn't sure how that worked when doing previous reviews, but the field infos of the writer should be updated when the doc-value update is performed. So the FieldInfo should always exist at this point and the doc-value type should always be correct. So we should be able to assert here instead of calling setDocValuesType.", "author": "jpountz", "createdAt": "2020-04-02T10:56:58Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMjkzOQ==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402402939", "bodyText": "I added an assertion to check the dv type of the global field but we still need to set the dv type on the cloned field since it is not preserved by the getOrAdd call.", "author": "jimczi", "createdAt": "2020-04-02T15:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyNTkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyODA2NQ==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402228065", "bodyText": "Sorry I suggested this on the previous review, but the doc-value type is actually supposed to be set on the updateDocValue call, so we should even be able to assert that the doc-value type is correct at this stage instead of setting it.", "author": "jpountz", "createdAt": "2020-04-02T11:01:02Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMzkzNw==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402233937", "bodyText": "maybe add a comment on the above getOrAdd call to mention that it never needs to add the field?", "author": "jpountz", "createdAt": "2020-04-02T11:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyODA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMzA2NQ==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402403065", "bodyText": "++, 0b5c6c8", "author": "jimczi", "createdAt": "2020-04-02T15:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyODA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMTc5Mw==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402231793", "bodyText": "I think we should either have an else branch that updates the maxFieldNumber to avoid conflicts (in case dv updates introduce multiple fields) or always clone the FieldInfo to update the number. I have a preference for the latter since it requires fewer branches and makes the code easier to reason about?", "author": "jpountz", "createdAt": "2020-04-02T11:08:28Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);\n+          FieldInfo segmentFieldInfo = newFields.get(update.field);\n+          if (segmentFieldInfo == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            if (globalFieldInfo.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              globalFieldInfo = cloneFieldInfo(globalFieldInfo, ++maxFieldNumber);\n+            }", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMzU1Mw==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402403553", "bodyText": "Thanks, I reworked the logic to always clone and reassign the field number.", "author": "jimczi", "createdAt": "2020-04-02T15:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMTc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMTk0Ng==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402231946", "bodyText": "this put call should be unnecessary since the field is already in the map?", "author": "jpountz", "createdAt": "2020-04-02T11:08:47Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);\n+          FieldInfo segmentFieldInfo = newFields.get(update.field);\n+          if (segmentFieldInfo == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            if (globalFieldInfo.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              globalFieldInfo = cloneFieldInfo(globalFieldInfo, ++maxFieldNumber);\n+            }\n+            newFields.put(update.field, globalFieldInfo);\n+          } else {\n+            segmentFieldInfo.setDocValuesType(update.type);\n+            newFields.put(update.field, segmentFieldInfo);", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMzYzNA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402403634", "bodyText": "++, removed", "author": "jimczi", "createdAt": "2020-04-02T15:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMTk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzNDExNA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402234114", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n          \n          \n            \n                      // if the segment was created externally (and added to this index with IndexWriter#addIndexes(Directory)).", "author": "jpountz", "createdAt": "2020-04-02T11:13:20Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMzczOA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402403738", "bodyText": "++", "author": "jimczi", "createdAt": "2020-04-02T15:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzNDExNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzNzA2Mg==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402237062", "bodyText": "It might be better to split into one unit test for the addIndexes case when the updated field already exists in the segment, and another one for the case when the updated field doesn't exist in the segment yet?", "author": "jpountz", "createdAt": "2020-04-02T11:19:15Z", "path": "lucene/core/src/test/org/apache/lucene/index/TestNumericDocValuesUpdates.java", "diffHunk": "@@ -1483,6 +1484,83 @@ public void testAddIndexes() throws Exception {\n     IOUtils.close(dir1, dir2);\n   }\n \n+  public void testUpdatesAfterAddIndexes() throws Exception {", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDE0MA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402394140", "bodyText": "++, I pushed 00d7558", "author": "jimczi", "createdAt": "2020-04-02T15:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzNzA2Mg=="}], "type": "inlineReview"}, {"oid": "fa08579e41a041e41d07a9ae91120ccbf396c4bf", "url": "https://github.com/apache/lucene-solr/commit/fa08579e41a041e41d07a9ae91120ccbf396c4bf", "message": "Revert \"also update dv type globally\"\n\nThis reverts commit 8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8.", "committedDate": "2020-04-02T12:16:21Z", "type": "commit"}, {"oid": "347c5e960263c366588c486f2939a2f40c311afa", "url": "https://github.com/apache/lucene-solr/commit/347c5e960263c366588c486f2939a2f40c311afa", "message": "Revert \"set the dv types of the field info before cloning\"\n\nThis reverts commit 090ef78171dfe671b0fb1ab238951fdd617bd65c.", "committedDate": "2020-04-02T12:16:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMzOTIxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402339219", "bodyText": "extra newline", "author": "s1monw", "createdAt": "2020-04-02T14:04:48Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -644,6 +656,13 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n     return true;\n   }\n \n+  private FieldInfo cloneFieldInfo(FieldInfo fi, int fieldNumber) {\n+    return new FieldInfo(fi.name, fieldNumber, fi.hasVectors(), fi.omitsNorms(), fi.hasPayloads(),\n+        fi.getIndexOptions(), fi.getDocValuesType(), fi.getDocValuesGen(), new HashMap<>(fi.attributes()),\n+        fi.getPointDimensionCount(), fi.getPointIndexDimensionCount(), fi.getPointNumBytes(), fi.isSoftDeletesField());\n+", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDAwOA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402394008", "bodyText": "++, 34718cb", "author": "jimczi", "createdAt": "2020-04-02T15:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMzOTIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM0MTk2Mg==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402341962", "bodyText": "we should set the DV type here too no?", "author": "s1monw", "createdAt": "2020-04-02T14:08:37Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);\n+          FieldInfo segmentFieldInfo = newFields.get(update.field);\n+          if (segmentFieldInfo == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            if (globalFieldInfo.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              globalFieldInfo = cloneFieldInfo(globalFieldInfo, ++maxFieldNumber);", "originalCommit": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwNDczMA==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402404730", "bodyText": "we should, thanks. I rewrote the logic in my last commits. I thought that addOrGet would preserve the dv type but it doesn't.", "author": "jimczi", "createdAt": "2020-04-02T15:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM0MTk2Mg=="}], "type": "inlineReview"}, {"oid": "00d755888d4744ff6a1beba17e20580f43841f12", "url": "https://github.com/apache/lucene-solr/commit/00d755888d4744ff6a1beba17e20580f43841f12", "message": "simplify cloning and fields", "committedDate": "2020-04-02T15:09:01Z", "type": "commit"}, {"oid": "ede44994c0fe72b8ef26c9b5a80819aa526039a9", "url": "https://github.com/apache/lucene-solr/commit/ede44994c0fe72b8ef26c9b5a80819aa526039a9", "message": "add assert to check dv type update", "committedDate": "2020-04-02T15:11:58Z", "type": "commit"}, {"oid": "34718cb64e747e56ebc5341f9180d2f12aace029", "url": "https://github.com/apache/lucene-solr/commit/34718cb64e747e56ebc5341f9180d2f12aace029", "message": "extra line", "committedDate": "2020-04-02T15:14:21Z", "type": "commit"}, {"oid": "01cf8d21e2dbdf4434d5bcad5f65481ee65a8738", "url": "https://github.com/apache/lucene-solr/commit/01cf8d21e2dbdf4434d5bcad5f65481ee65a8738", "message": "restore comment", "committedDate": "2020-04-02T15:18:28Z", "type": "commit"}, {"oid": "0b5c6c896bcc67f8ec6d9206d5dc9caa5cc5ee81", "url": "https://github.com/apache/lucene-solr/commit/0b5c6c896bcc67f8ec6d9206d5dc9caa5cc5ee81", "message": "add more comments and assertion", "committedDate": "2020-04-02T15:24:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2ODgxMw==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402468813", "bodyText": "nit: we call it byNameelsewhere", "author": "jpountz", "createdAt": "2020-04-02T17:01:59Z", "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,37 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> perName = new HashMap<>();", "originalCommit": "0b5c6c896bcc67f8ec6d9206d5dc9caa5cc5ee81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkzNjk1Mg==", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402936952", "bodyText": "9fed431", "author": "jimczi", "createdAt": "2020-04-03T11:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2ODgxMw=="}], "type": "inlineReview"}, {"oid": "9fed4319409a4d6c3a70e500cc51a58766116e21", "url": "https://github.com/apache/lucene-solr/commit/9fed4319409a4d6c3a70e500cc51a58766116e21", "message": "perName -> byName", "committedDate": "2020-04-03T09:53:56Z", "type": "commit"}, {"oid": "52dcc9034100fa932566e2003fa48eeba8a6859d", "url": "https://github.com/apache/lucene-solr/commit/52dcc9034100fa932566e2003fa48eeba8a6859d", "message": "add entry to changes.txt", "committedDate": "2020-04-03T11:10:28Z", "type": "commit"}, {"oid": "f72cab5a2b05f042ec900920775e50fd59183da7", "url": "https://github.com/apache/lucene-solr/commit/f72cab5a2b05f042ec900920775e50fd59183da7", "message": "Merge branch 'master' into doc_values_update_field_infos_gen", "committedDate": "2020-04-03T11:10:49Z", "type": "commit"}]}