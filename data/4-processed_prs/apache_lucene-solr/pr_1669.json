{"pr_number": 1669, "pr_title": "SOLR-14151 Make schema components load from packages", "pr_createdAt": "2020-07-13T15:32:21Z", "pr_url": "https://github.com/apache/lucene-solr/pull/1669", "timeline": [{"oid": "59053416fcf2115305c768e12f7db45fce042565", "url": "https://github.com/apache/lucene-solr/commit/59053416fcf2115305c768e12f7db45fce042565", "message": "SOLR-14155: Load all other SolrCore plugins from packages", "committedDate": "2020-07-11T07:51:03Z", "type": "commit"}, {"oid": "ae2dfc69303191a0d030770eaa39a0a6f4b62f13", "url": "https://github.com/apache/lucene-solr/commit/ae2dfc69303191a0d030770eaa39a0a6f4b62f13", "message": "more review commnets incorporated", "committedDate": "2020-07-12T10:01:37Z", "type": "commit"}, {"oid": "fc3599b15ad1545a8801c12ed13b2c8480f99fb3", "url": "https://github.com/apache/lucene-solr/commit/fc3599b15ad1545a8801c12ed13b2c8480f99fb3", "message": "precommit errs", "committedDate": "2020-07-12T12:04:22Z", "type": "commit"}, {"oid": "90516874d8e5621c032a779b7d0a853bf13ee2c4", "url": "https://github.com/apache/lucene-solr/commit/90516874d8e5621c032a779b7d0a853bf13ee2c4", "message": "use proper generics", "committedDate": "2020-07-12T12:14:26Z", "type": "commit"}, {"oid": "9bc2221d59e328068586486d70ef6604ee994864", "url": "https://github.com/apache/lucene-solr/commit/9bc2221d59e328068586486d70ef6604ee994864", "message": "use Long instead of UUID", "committedDate": "2020-07-12T12:21:54Z", "type": "commit"}, {"oid": "f5398927056efb4308c0408d578ed9de47bc9bec", "url": "https://github.com/apache/lucene-solr/commit/f5398927056efb4308c0408d578ed9de47bc9bec", "message": "precommit errs", "committedDate": "2020-07-13T01:47:54Z", "type": "commit"}, {"oid": "3f764ca9af0fd1b98c059db5b13467517b2d4848", "url": "https://github.com/apache/lucene-solr/commit/3f764ca9af0fd1b98c059db5b13467517b2d4848", "message": "cleanup", "committedDate": "2020-07-13T01:58:19Z", "type": "commit"}, {"oid": "a874bfc5e517234b66b6a0630b6e898bbfb9969d", "url": "https://github.com/apache/lucene-solr/commit/a874bfc5e517234b66b6a0630b6e898bbfb9969d", "message": "cleanup", "committedDate": "2020-07-13T02:06:19Z", "type": "commit"}, {"oid": "c1284e1f2ca7cd370304ca484046d8f5f5249129", "url": "https://github.com/apache/lucene-solr/commit/c1284e1f2ca7cd370304ca484046d8f5f5249129", "message": "SOLR-14151: Make schema components load from packages", "committedDate": "2020-07-13T15:27:40Z", "type": "commit"}, {"oid": "8d964ae3cc2e327a9451c257689207ca8903a1dc", "url": "https://github.com/apache/lucene-solr/commit/8d964ae3cc2e327a9451c257689207ca8903a1dc", "message": "ASL headers", "committedDate": "2020-07-13T15:29:16Z", "type": "commit"}, {"oid": "b113c9f42a291e915693f0d65cadd76a50a10518", "url": "https://github.com/apache/lucene-solr/commit/b113c9f42a291e915693f0d65cadd76a50a10518", "message": "formatting", "committedDate": "2020-07-13T15:31:40Z", "type": "commit"}, {"oid": "08d26db8f39df9452f9dad298269cf7840a93e45", "url": "https://github.com/apache/lucene-solr/commit/08d26db8f39df9452f9dad298269cf7840a93e45", "message": "precommit", "committedDate": "2020-07-13T15:57:02Z", "type": "commit"}, {"oid": "78f40aef7ac48322762ab1250d22b8c3ee59bf1d", "url": "https://github.com/apache/lucene-solr/commit/78f40aef7ac48322762ab1250d22b8c3ee59bf1d", "message": "precommit", "committedDate": "2020-07-13T15:59:20Z", "type": "commit"}, {"oid": "f46030ac0b85926b1c865db57c07722d63140177", "url": "https://github.com/apache/lucene-solr/commit/f46030ac0b85926b1c865db57c07722d63140177", "message": "precommit", "committedDate": "2020-07-13T16:00:51Z", "type": "commit"}, {"oid": "d9c73f2918024d9f35102ce2d42ed4143babbccd", "url": "https://github.com/apache/lucene-solr/commit/d9c73f2918024d9f35102ce2d42ed4143babbccd", "message": "precommit", "committedDate": "2020-07-13T16:02:09Z", "type": "commit"}, {"oid": "55595b8fcf109917b7ff5d9313c3fbd9b605b258", "url": "https://github.com/apache/lucene-solr/commit/55595b8fcf109917b7ff5d9313c3fbd9b605b258", "message": "precommit", "committedDate": "2020-07-13T16:02:49Z", "type": "commit"}, {"oid": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "url": "https://github.com/apache/lucene-solr/commit/ec5d0b216690016af9e25689001aa1fa2e0f21d0", "message": "more javadocs and removed some unnecessary code", "committedDate": "2020-07-14T05:38:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MDg1Ng==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454390856", "bodyText": "this is not used?", "author": "dsmiley", "createdAt": "2020-07-14T14:18:39Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -752,6 +765,9 @@ public void close() throws IOException {\n   }\n \n \n+  public CoreContainer getCoreContainer(){", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMDU2Nw==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454700567", "bodyText": "This is necessary for #1666", "author": "noblepaul", "createdAt": "2020-07-14T23:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MDg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NTQwMQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454855401", "bodyText": "I may remove it altogether now", "author": "noblepaul", "createdAt": "2020-07-15T07:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MDg1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjM2OA==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454392368", "bodyText": "I don't think we need UUID because AFAICT the usage is entirely within the node.  Instead, just use a static AtomicLong counter like, for example, SearchHandler.ridCounter and then declare this instance field here as a simple primitive long.", "author": "dsmiley", "createdAt": "2020-07-14T14:20:49Z", "path": "solr/core/src/java/org/apache/solr/core/SolrCore.java", "diffHunk": "@@ -191,6 +191,11 @@\n \n   private String name;\n   private String logid; // used to show what name is set\n+  /**\n+   * A unique id to differentiate multiple instances of the same core\n+   * If we reload a core, the name remains same , but the id will be new\n+   */\n+  public final UUID uniqueId = UUID.randomUUID();", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMjcwMg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454702702", "bodyText": "AtomicLong is mutable. We need an immutable object", "author": "noblepaul", "createdAt": "2020-07-14T23:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1NjY0MA==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454756640", "bodyText": "The primitive long instance field would be final (immutable).  A static final AtomicLong (which is mutable) would only be used to generate a new core UID.", "author": "dsmiley", "createdAt": "2020-07-15T02:42:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ3NjgyMQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r455476821", "bodyText": "UUID is cheap and there is no advantage in using something else. Cores are not created so frequently that we should care too much about it", "author": "noblepaul", "createdAt": "2020-07-16T02:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUxMDA2NQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r455510065", "bodyText": "Okay... but the AtomicLong incrementAndGet technique is very common for for an internal-id use case (I could list others in Lucene/Solr).  I have not seen a UUID used yet for this.  Up to you.", "author": "dsmiley", "createdAt": "2020-07-16T04:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwNDM0Mw==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454404343", "bodyText": "This is not used?", "author": "dsmiley", "createdAt": "2020-07-14T14:36:19Z", "path": "solr/core/src/java/org/apache/solr/core/SolrResourceLoader.java", "diffHunk": "@@ -198,6 +206,11 @@ synchronized void reloadLuceneSPI() {\n     TokenizerFactory.reloadTokenizers(this.classLoader);\n   }\n \n+  public SolrCore getCore(){", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMjc4Mw==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454702783", "bodyText": "This is used in #1666", "author": "noblepaul", "createdAt": "2020-07-14T23:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwNDM0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwNTI2Ng==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454405266", "bodyText": "nitpick: auto-format this code to be consistent with spaces", "author": "dsmiley", "createdAt": "2020-07-14T14:37:25Z", "path": "solr/core/src/java/org/apache/solr/handler/SchemaHandler.java", "diffHunk": "@@ -202,6 +202,38 @@ private void handleGET(SolrQueryRequest req, SolrQueryResponse rsp) {\n     }\n   }\n \n+  /**If a plugin is loaded from a package, the version of the package being used should be added\n+   * to the response\n+   *\n+   */\n+  @SuppressWarnings(\"rawtypes\")\n+  private  void insertPackageInfo(Object o, SolrQueryRequest req) {\n+    if(!req.getParams().getBool(\"meta\",false)) return;", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwODM5Ng==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454408396", "bodyText": "This code here returns a class and not an instance.  This seems wrong?", "author": "dsmiley", "createdAt": "2020-07-14T14:41:30Z", "path": "solr/core/src/java/org/apache/solr/handler/StreamHandler.java", "diffHunk": "@@ -158,8 +158,8 @@ public Class getClazz() {\n     }\n \n     @Override\n-    protected void initNewInstance(PackageLoader.Package.Version newest) {\n-      clazz = newest.getLoader().findClass(pluginInfo.className, Expressible.class);\n+    protected Object initNewInstance(PackageLoader.Package.Version newest) {\n+      return clazz = newest.getLoader().findClass(pluginInfo.className, Expressible.class);", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMDk4Mw==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454700983", "bodyText": "Actually no. it can be anything what the listener wants it to be. In this case it's a class", "author": "noblepaul", "createdAt": "2020-07-14T23:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwODM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwOTgwMw==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454409803", "bodyText": "nit: you re-ordered the imports in a way not consistent with most classes.  java package should come first.", "author": "dsmiley", "createdAt": "2020-07-14T14:43:33Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageAPI.java", "diffHunk": "@@ -52,6 +42,11 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.io.IOException;", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMTQ5Mg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454411492", "bodyText": "nit: please auto-format for space consistency", "author": "dsmiley", "createdAt": "2020-07-14T14:45:37Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeners.java", "diffHunk": "@@ -96,15 +97,42 @@ private synchronized void invokeListeners(PackageLoader.Package pkg) {\n \n \n   public interface Listener {\n-    /**Name of the package or null to loisten to all package changes\n+    /**Name of the package or null to listen to all package changes\n      */\n     String packageName();\n \n     PluginInfo pluginInfo();\n \n-    void changed(PackageLoader.Package pkg);\n+    void changed(PackageLoader.Package pkg, Ctx ctx);\n \n     PackageLoader.Package.Version getPackageVersion();\n+    class Ctx {\n+      private Map<String, Runnable > runLater;\n+\n+      /** If there are multiple packages to be updated and there are multiple listeners,\n+       * This is executed after all of the {@link Listener#changed(PackageLoader.Package, Ctx)}\n+       * calls are invoked. The name is a unique identifier that can be used by consumers to avoid duplicate\n+       * If no deduplication is required, use null\n+       * runnable objects\n+       */\n+      public void runLater(String name,  Runnable runnable  ) {\n+        if(runLater == null) runLater = new LinkedHashMap<>();", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxOTExMA==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454419110", "bodyText": "nit:\nSingle-line javadocs can entirely be in one line:\n/** Name of the package or null to listen to all package changes */\n\nMulti-line are formatted like this:\n/**\n * Summary sentence.\n * More info.\n */\n\nI see this formatting inconsistency in lots of your javadocs.  I know it's not a big deal yet it's still gives code not adhering to this a sloppy feel.  I find https://google.github.io/styleguide/javaguide.html#s7-javadoc useful to refer to, and it's perhaps the most popular Java style guide.\nYou might try Opt-Cmd-L if you use IntelliJ on a Mac to reformat selected text.", "author": "dsmiley", "createdAt": "2020-07-14T14:55:27Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeners.java", "diffHunk": "@@ -96,15 +97,42 @@ private synchronized void invokeListeners(PackageLoader.Package pkg) {\n \n \n   public interface Listener {\n-    /**Name of the package or null to loisten to all package changes\n+    /**Name of the package or null to listen to all package changes", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyMTgxMQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454421811", "bodyText": "I think you mean, use null for the name and not for the Runnable object.  The runnable is required.", "author": "dsmiley", "createdAt": "2020-07-14T14:58:55Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeners.java", "diffHunk": "@@ -96,15 +97,42 @@ private synchronized void invokeListeners(PackageLoader.Package pkg) {\n \n \n   public interface Listener {\n-    /**Name of the package or null to loisten to all package changes\n+    /**Name of the package or null to listen to all package changes\n      */\n     String packageName();\n \n     PluginInfo pluginInfo();\n \n-    void changed(PackageLoader.Package pkg);\n+    void changed(PackageLoader.Package pkg, Ctx ctx);\n \n     PackageLoader.Package.Version getPackageVersion();\n+    class Ctx {\n+      private Map<String, Runnable > runLater;\n+\n+      /** If there are multiple packages to be updated and there are multiple listeners,\n+       * This is executed after all of the {@link Listener#changed(PackageLoader.Package, Ctx)}\n+       * calls are invoked. The name is a unique identifier that can be used by consumers to avoid duplicate\n+       * If no deduplication is required, use null\n+       * runnable objects", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyNTM0MQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454425341", "bodyText": "Could use find a Solr based ExecutorService for this instead?  It sets up MDC and we ensure it gets shut down.", "author": "dsmiley", "createdAt": "2020-07-14T15:03:28Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeners.java", "diffHunk": "@@ -96,15 +97,42 @@ private synchronized void invokeListeners(PackageLoader.Package pkg) {\n \n \n   public interface Listener {\n-    /**Name of the package or null to loisten to all package changes\n+    /**Name of the package or null to listen to all package changes\n      */\n     String packageName();\n \n     PluginInfo pluginInfo();\n \n-    void changed(PackageLoader.Package pkg);\n+    void changed(PackageLoader.Package pkg, Ctx ctx);\n \n     PackageLoader.Package.Version getPackageVersion();\n+    class Ctx {\n+      private Map<String, Runnable > runLater;\n+\n+      /** If there are multiple packages to be updated and there are multiple listeners,\n+       * This is executed after all of the {@link Listener#changed(PackageLoader.Package, Ctx)}\n+       * calls are invoked. The name is a unique identifier that can be used by consumers to avoid duplicate\n+       * If no deduplication is required, use null\n+       * runnable objects\n+       */\n+      public void runLater(String name,  Runnable runnable  ) {\n+        if(runLater == null) runLater = new LinkedHashMap<>();\n+        if(name == null) {\n+          name = runnable.getClass().getSimpleName() + \"@\" + runnable.hashCode();\n+        }\n+        runLater.put(name, runnable);\n+      }\n+      private void runLaterTasks(){\n+        if(runLater == null) return;\n+        new Thread(() -> runLater.forEach((s, runnable) -> {", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwMTM0Mg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454701342", "bodyText": "True. This needs to be done more gracefully.", "author": "noblepaul", "createdAt": "2020-07-14T23:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyNTM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyODYwMg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454428602", "bodyText": "nit: spacing issue.\nAlso, please use 'final' for all fields that are final and not just some.  Likewise for 'private' for fields than can be private.", "author": "dsmiley", "createdAt": "2020-07-14T15:08:00Z", "path": "solr/core/src/java/org/apache/solr/pkg/SchemaPluginsLoader.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.pkg;\n+\n+import org.apache.lucene.analysis.util.ResourceLoaderAware;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.SolrException;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.core.PluginInfo;\n+import org.apache.solr.core.SolrClassLoader;\n+import org.apache.solr.core.SolrResourceLoader;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+/**\n+ * A {@link SolrClassLoader} that is specifically designed to load schema plugins from packages.\n+ * This class would register a listener for any package that is used in a schema and reload the schema\n+ * if any of those packages are updated\n+ * */\n+public class SchemaPluginsLoader implements SolrClassLoader {\n+    final CoreContainer coreContainer;\n+    final SolrResourceLoader loader;\n+    final Function<String, String> pkgVersionSupplier;\n+    private Map<String ,PackageAPI.PkgVersion> packageVersions =  new HashMap<>(1);", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzMzkyMg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454433922", "bodyText": "nit: see my longer comment on formatting javadoc.  This case right here really gets to me.", "author": "dsmiley", "createdAt": "2020-07-14T15:15:15Z", "path": "solr/core/src/java/org/apache/solr/core/SolrClassLoader.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.core;\n+\n+\n+/**A generic interface to load plugin classes", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MTczMA==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454441730", "bodyText": "This seems problematic.  The code involved in index schema loading has access to two fields that both implement SolrClassLoader:  loader and solrClassLoader which you just added.  And then you changed many lines to use SolrClassLoader which just as well could have been as it was before -- loader (SRL).  I can see that you're doing this so that a new SchemaPluginsLoader thing could be used.  What if SchemaPluginsLoader was an SRL itself, and delegated the resource-loading methods to the \"real\" SRL?\nPut differently, we could create a synthetic SRL whose methods delegate to an appropriate plugin enabled ClassLoader and a real SRL for the configSet to find resources.  WDYT?", "author": "dsmiley", "createdAt": "2020-07-14T15:25:51Z", "path": "solr/core/src/java/org/apache/solr/schema/IndexSchema.java", "diffHunk": "@@ -188,6 +190,7 @@ public IndexSchema(String name, InputSource is, Version luceneVersion, SolrResou\n   protected IndexSchema(Version luceneVersion, SolrResourceLoader loader, Properties substitutableProperties) {\n     this.luceneVersion = Objects.requireNonNull(luceneVersion);\n     this.loader = loader;\n+    this.solrClassLoader = loader.getCore() == null? loader: loader.getCore().getSchemaPluginsLoader();", "originalCommit": "ec5d0b216690016af9e25689001aa1fa2e0f21d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ1MDcxMg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454450712", "bodyText": "Continuing my idea... Imagine a \"ZkConfigSetResourceProvider\" and \"FileSystemConfigSetResourceProvider\" pair of classes implementing an interface ConfigSetResourceProvider that is only for serving a resource (InputStream), not a class.  Just method openResource ideally.  Then imagine a SRL that demands a ConfigSetResourceProvider, and a ClassLoader (or SolrClassLoader as you prefer).  See where this is going?", "author": "dsmiley", "createdAt": "2020-07-14T15:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MTczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ1NjQ4OA==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454456488", "bodyText": "With that idea, there would only need to be one SRL class (no subclasses), and it'd be easy to create new instances based on those two primary components.\nI'm sure there is some tech debt entanglements in SRL relating to tracking instancePath (there's a TODO I added in there, initLibs() to remove that one) and harder are waitingForCore, infoMBeans, waitingForResources, and of course managedResourceRegistry.  If those get moved off somehow, then I hope the picture I propose becomes more clear.", "author": "dsmiley", "createdAt": "2020-07-14T15:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MTczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNDkyNg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454704926", "bodyText": "What if SchemaPluginsLoader was an SRL itself, and delegated the resource-loading methods to the \"real\" SRL?\n\nWell, technically it's possible. The current SRL is a mess. At some point in the future we may end up making it clean and usable. Today it's not. We should clearly differentiate between places where we need to load resources and places where we need to load classes. A Minimal interface should be enough for loading classes. SRL is a heavy concrete class.", "author": "noblepaul", "createdAt": "2020-07-14T23:36:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MTczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2MzEzNw==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454763137", "bodyText": "In the design I propose here, all the debt I mentioned in SRL except instancePath/getConfigDir could move to the new SolrClassLoader because they are class-loading related and not resource-loading related.  InstancePath/getConfigDir is debt I could erase quickly.  Then I think we're in good shape to move forward with a debt-free SRL that is a simple combination of it's two components.  If that sounds nice to you, I could work on a POC immediately.", "author": "dsmiley", "createdAt": "2020-07-15T03:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MTczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NDU3MA==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454854570", "bodyText": "At this point I want this to get out of my way. I would fix this one instead of spending more time on SRL refactoring.\nI believe this is in a reasonably good shape. We can do more refactoring later.\nLet's do things that add value to users\nTBH, I don't care about any particular class here. If possible, I would just nuke SRL altogether. It's just a kitchen sink and reeks of bad designs all over\nI wish to use SRL minimally. We should have a less heavy interface in most places. I would say most places are happy to just have a SolrClassLoader", "author": "noblepaul", "createdAt": "2020-07-15T07:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MTczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4NjkyMg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r455386922", "bodyText": "Okay; lets get this done.", "author": "dsmiley", "createdAt": "2020-07-15T21:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0MTczMA=="}], "type": "inlineReview"}, {"oid": "09cb96c3c274c6f9ed7ea2f7f439cab07a73c30c", "url": "https://github.com/apache/lucene-solr/commit/09cb96c3c274c6f9ed7ea2f7f439cab07a73c30c", "message": "implement review comments", "committedDate": "2020-07-14T23:38:10Z", "type": "commit"}, {"oid": "73a6354cc301eeb19ed5f34dbea0991385e0c4d6", "url": "https://github.com/apache/lucene-solr/commit/73a6354cc301eeb19ed5f34dbea0991385e0c4d6", "message": "implement review comments", "committedDate": "2020-07-14T23:42:25Z", "type": "commit"}, {"oid": "dfe650b194e5a55d4cff2042bac551ab38b30cf6", "url": "https://github.com/apache/lucene-solr/commit/dfe650b194e5a55d4cff2042bac551ab38b30cf6", "message": "more cleanup", "committedDate": "2020-07-15T00:00:58Z", "type": "commit"}, {"oid": "b815339f58698d047605d803166c7925bd8c71a3", "url": "https://github.com/apache/lucene-solr/commit/b815339f58698d047605d803166c7925bd8c71a3", "message": "refactoring", "committedDate": "2020-07-15T00:53:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2Mzc2Mw==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454763763", "bodyText": "I think using the generic interface Function here is pushing the bounds of readability/intuitiveness.  Lets just provide an interface/class instead.  Perhaps get() and getForce() with no boolean arg needed.", "author": "dsmiley", "createdAt": "2020-07-15T03:09:46Z", "path": "solr/core/src/java/org/apache/solr/core/ConfigSet.java", "diffHunk": "@@ -30,15 +32,18 @@\n \n   private final SolrConfig solrconfig;\n \n-  private final IndexSchema indexSchema;\n+  /**Provide a Schema object on demand\n+   * The first Boolean is to signify a a forcefetch\n+   */\n+  private final Function<Boolean, IndexSchema> indexSchema;", "originalCommit": "b815339f58698d047605d803166c7925bd8c71a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2NTAyNg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454765026", "bodyText": "plus mention it's optional, and then if it's specified and the coreId doesn't match, then the reload is a no-op.  Maybe rename coreId to ifCoreIdMatches to reflect not only what it is but how it's used.", "author": "dsmiley", "createdAt": "2020-07-15T03:15:03Z", "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -1588,20 +1590,32 @@ private CoreDescriptor reloadCoreDescriptor(CoreDescriptor oldDesc) {\n     return ret;\n   }\n \n+  /**\n+   * reloads a core\n+   * refer {@link CoreContainer#reload(String, UUID)} for details\n+   */\n+  public void reload(String name) {\n+    reload(name, null);\n+  }\n   /**\n    * Recreates a SolrCore.\n    * While the new core is loading, requests will continue to be dispatched to\n    * and processed by the old core\n    *\n    * @param name the name of the SolrCore to reload\n+   * @param coreId The unique Id of the core", "originalCommit": "b815339f58698d047605d803166c7925bd8c71a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2NjAyOQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454766029", "bodyText": "nit: another example of oddly formatted javadoc.", "author": "dsmiley", "createdAt": "2020-07-15T03:18:49Z", "path": "solr/core/src/java/org/apache/solr/handler/SchemaHandler.java", "diffHunk": "@@ -202,6 +202,38 @@ private void handleGET(SolrQueryRequest req, SolrQueryResponse rsp) {\n     }\n   }\n \n+  /**If a plugin is loaded from a package, the version of the package being used should be added", "originalCommit": "b815339f58698d047605d803166c7925bd8c71a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2NjUyMg==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454766522", "bodyText": "I find this confusing... it could just be the name.  Something that implements SolrClassLoader should probably have a name that makes that aspect more pronounced and less so the listener aspect.", "author": "dsmiley", "createdAt": "2020-07-15T03:20:36Z", "path": "solr/core/src/java/org/apache/solr/pkg/MultiPackageListener.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.pkg;\n+\n+import org.apache.lucene.analysis.util.ResourceLoaderAware;\n+import org.apache.solr.common.MapWriter;\n+import org.apache.solr.common.SolrException;\n+import org.apache.solr.core.CoreContainer;\n+import org.apache.solr.core.PluginInfo;\n+import org.apache.solr.core.SolrClassLoader;\n+import org.apache.solr.core.SolrResourceLoader;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+/**\n+ * A {@link SolrClassLoader} that is designed to listen to a set of packages.\n+ * This class would register a listener each package that is loaded through this\n+ * if any of those packages are updated , the onReload runnable is executed\n+ * */\n+public class MultiPackageListener implements SolrClassLoader , PackageListeners.Listener {", "originalCommit": "b815339f58698d047605d803166c7925bd8c71a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1MDU3Ng==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454850576", "bodyText": "name suggestions are welcome", "author": "noblepaul", "createdAt": "2020-07-15T07:33:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2NjUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2NzQxOQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r454767419", "bodyText": "BTW I do like these sorts of changes where you've found SRL used where the caller really just needs a class loader.", "author": "dsmiley", "createdAt": "2020-07-15T03:24:28Z", "path": "solr/core/src/java/org/apache/solr/util/plugin/AbstractPluginLoader.java", "diffHunk": "@@ -86,7 +86,7 @@ public AbstractPluginLoader(String type, Class<T> pluginClassType)\n    * @param node - the XML node defining this plugin\n    */\n   @SuppressWarnings(\"unchecked\")\n-  protected T create( SolrResourceLoader loader, String name, String className, Node node ) throws Exception\n+  protected T create(SolrClassLoader loader, String name, String className, Node node ) throws Exception", "originalCommit": "b815339f58698d047605d803166c7925bd8c71a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "502ac3e8e80881df833673a467de125fdf218f90", "url": "https://github.com/apache/lucene-solr/commit/502ac3e8e80881df833673a467de125fdf218f90", "message": "more cleanup", "committedDate": "2020-07-16T02:29:39Z", "type": "commit"}, {"oid": "76b62c23024594189c4f874275a152326f703bea", "url": "https://github.com/apache/lucene-solr/commit/76b62c23024594189c4f874275a152326f703bea", "message": "more cleanup", "committedDate": "2020-07-16T02:35:34Z", "type": "commit"}, {"oid": "ec769dc71095f0468aba070bdd7a86d19e62130c", "url": "https://github.com/apache/lucene-solr/commit/ec769dc71095f0468aba070bdd7a86d19e62130c", "message": "more cleanup", "committedDate": "2020-07-16T02:43:29Z", "type": "commit"}, {"oid": "bd6974b7b0525a63da52e0ad1e4f4c864a31bd8c", "url": "https://github.com/apache/lucene-solr/commit/bd6974b7b0525a63da52e0ad1e4f4c864a31bd8c", "message": "more cleanup", "committedDate": "2020-07-16T02:43:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUxMTQ1NQ==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r455511455", "bodyText": "https://google.github.io/styleguide/javaguide.html#s7-javadoc\nGlad to see this supplier though.", "author": "dsmiley", "createdAt": "2020-07-16T05:02:49Z", "path": "solr/core/src/java/org/apache/solr/core/ConfigSet.java", "diffHunk": "@@ -79,4 +75,14 @@ public NamedList getProperties() {\n   public boolean isTrusted() {\n     return trusted;\n   }\n+\n+  /**Provide a Schema object on demand", "originalCommit": "bd6974b7b0525a63da52e0ad1e4f4c864a31bd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUxMTkzOA==", "url": "https://github.com/apache/lucene-solr/pull/1669#discussion_r455511938", "bodyText": "Good name.", "author": "dsmiley", "createdAt": "2020-07-16T05:04:53Z", "path": "solr/core/src/java/org/apache/solr/pkg/PackageListeningClassLoader.java", "diffHunk": "@@ -35,7 +35,7 @@\n  * This class would register a listener each package that is loaded through this\n  * if any of those packages are updated , the onReload runnable is executed\n  * */\n-public class MultiPackageListener implements SolrClassLoader , PackageListeners.Listener {\n+public class PackageListeningClassLoader implements SolrClassLoader , PackageListeners.Listener {", "originalCommit": "bd6974b7b0525a63da52e0ad1e4f4c864a31bd8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "947229d1517c89593e9994d8ae7fb92cc1d7d1f2", "url": "https://github.com/apache/lucene-solr/commit/947229d1517c89593e9994d8ae7fb92cc1d7d1f2", "message": "CHANGES.txt", "committedDate": "2020-07-16T06:02:28Z", "type": "commit"}, {"oid": "aca3f92d9659049e305245a99b0a40a440f6755c", "url": "https://github.com/apache/lucene-solr/commit/aca3f92d9659049e305245a99b0a40a440f6755c", "message": "javadocs", "committedDate": "2020-07-16T06:05:01Z", "type": "commit"}]}