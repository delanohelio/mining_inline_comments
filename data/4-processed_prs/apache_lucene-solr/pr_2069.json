{"pr_number": 2069, "pr_title": "LUCENE-9378: Make it possible to configure how to trade speed for compression on doc values.", "pr_createdAt": "2020-11-09T17:57:35Z", "pr_url": "https://github.com/apache/lucene-solr/pull/2069", "timeline": [{"oid": "47252e5a01f20537582e4d2775761aa0ebf50db5", "url": "https://github.com/apache/lucene-solr/commit/47252e5a01f20537582e4d2775761aa0ebf50db5", "message": "LUCENE-9378: Make it possible to configure how to trade speed for compression on doc values.\n\nThis adds a switch to `Lucene80DocValuesFormat` which allows to\nconfigure whether to prioritize retrieval speed over compression ratio\nor the other way around. When prioritizing retrieval speed, binary doc\nvalues are written using the exact same format as before more aggressive\ncompression got introduced.", "committedDate": "2020-11-09T17:48:51Z", "type": "commit"}, {"oid": "c54f2ce667bfeee72b2d5b386b7f50557dcf8564", "url": "https://github.com/apache/lucene-solr/commit/c54f2ce667bfeee72b2d5b386b7f50557dcf8564", "message": "CHANGES", "committedDate": "2020-11-09T17:58:24Z", "type": "commit"}, {"oid": "0a30f4b5e4d58065d99e380085862ddf4032fd6f", "url": "https://github.com/apache/lucene-solr/commit/0a30f4b5e4d58065d99e380085862ddf4032fd6f", "message": "iter", "committedDate": "2020-11-09T18:31:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyMzIyNw==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520023227", "bodyText": "Nice!  So we roll up the tradeoffs to Codec level which will then tell each format how to tradeoff.", "author": "mikemccand", "createdAt": "2020-11-09T18:22:26Z", "path": "lucene/backward-codecs/src/java/org/apache/lucene/backward_codecs/lucene87/Lucene87Codec.java", "diffHunk": "@@ -56,6 +57,23 @@\n  * @lucene.experimental\n  */\n public class Lucene87Codec extends Codec {\n+\n+  /** Configuration option for the codec. */\n+  public static enum Mode {\n+    /** Trade compression ratio for retrieval speed. */\n+    BEST_SPEED(Lucene87StoredFieldsFormat.Mode.BEST_SPEED, Lucene80DocValuesFormat.Mode.BEST_SPEED),\n+    /** Trade retrieval speed for compression ratio. */\n+    BEST_COMPRESSION(Lucene87StoredFieldsFormat.Mode.BEST_COMPRESSION, Lucene80DocValuesFormat.Mode.BEST_COMPRESSION);\n+\n+    private final Lucene87StoredFieldsFormat.Mode storedMode;\n+    private final Lucene80DocValuesFormat.Mode dvMode;\n+\n+    private Mode(Lucene87StoredFieldsFormat.Mode storedMode, Lucene80DocValuesFormat.Mode dvMode) {", "originalCommit": "c54f2ce667bfeee72b2d5b386b7f50557dcf8564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNTQzMg==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520035432", "bodyText": "Right. It's still possible to made different choices for stored fields and doc values given that we allow configuration of doc values on a per-field basis, but this should at least keep simple use simple with one switch that configures stored fields and doc values at the same time.", "author": "jpountz", "createdAt": "2020-11-09T18:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyMzIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1NTM0MQ==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520055341", "bodyText": "Great!  Simple for common use cases (\"I want best compression\" or \"I want fastest search\"), and complex for complex use cases (I want separate control for each part of the index).", "author": "mikemccand", "createdAt": "2020-11-09T19:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyMzIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNDYzNA==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520024634", "bodyText": "Will this randomize between the different Mode tradeoffs?", "author": "mikemccand", "createdAt": "2020-11-09T18:24:51Z", "path": "lucene/core/src/test/org/apache/lucene/codecs/lucene80/BaseLucene80DocValuesFormatTestCase.java", "diffHunk": "@@ -286,7 +278,7 @@ private void doTestTermsEnumRandom(int numDocs, Supplier<String> valuesProducer)\n     conf.setMergeScheduler(new SerialMergeScheduler());\n     // set to duel against a codec which has ordinals:\n     final PostingsFormat pf = TestUtil.getPostingsFormatWithOrds(random());\n-    final DocValuesFormat dv = new Lucene80DocValuesFormat();\n+    final DocValuesFormat dv = getCodec().docValuesFormat();", "originalCommit": "c54f2ce667bfeee72b2d5b386b7f50557dcf8564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNDc1Nw==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520034757", "bodyText": "It's not randomizing, we are testing both modes explicitly via TestBestSpeedLucene80DocValuesFormat on one hand and TestBestCompressionLucene80DocValuesFormat on the other hand.", "author": "jpountz", "createdAt": "2020-11-09T18:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNDYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNTAyMQ==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520025021", "bodyText": "Do we also have a dedicated TestBestCompressedLucene80DocValuesFormat?", "author": "mikemccand", "createdAt": "2020-11-09T18:25:27Z", "path": "lucene/core/src/test/org/apache/lucene/codecs/lucene80/TestBestSpeedLucene80DocValuesFormat.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.lucene.codecs.lucene80;\n+\n+import org.apache.lucene.codecs.Codec;\n+import org.apache.lucene.util.TestUtil;\n+\n+/**\n+ * Tests Lucene80DocValuesFormat\n+ */\n+public class TestBestSpeedLucene80DocValuesFormat extends BaseLucene80DocValuesFormatTestCase {", "originalCommit": "c54f2ce667bfeee72b2d5b386b7f50557dcf8564", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzMTI2NA==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520031264", "bodyText": "Oh nevermind I see you opened followon issue for this: https://issues.apache.org/jira/browse/LUCENE-9602", "author": "mikemccand", "createdAt": "2020-11-09T18:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNTAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzMzY1Mg==", "url": "https://github.com/apache/lucene-solr/pull/2069#discussion_r520033652", "bodyText": "You should see a TestBestCompressedLucene80DocValuesFormat file as well in this PR. I opened LUCENE-9602 specifically for backward compatibility and make sure we check in indices created by BEST_COMPRESSION in our source tree after every release to make sure we have good bw compatibility coverage.", "author": "jpountz", "createdAt": "2020-11-09T18:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNTAyMQ=="}], "type": "inlineReview"}, {"oid": "94b45406b0f2648e2fcee37b2a6bf3be19be36c2", "url": "https://github.com/apache/lucene-solr/commit/94b45406b0f2648e2fcee37b2a6bf3be19be36c2", "message": "Merge branch 'master' into lucene9378", "committedDate": "2020-11-10T09:50:26Z", "type": "commit"}, {"oid": "8cdd7a1ada1ea787df0e1b3551abf6e43e6c9657", "url": "https://github.com/apache/lucene-solr/commit/8cdd7a1ada1ea787df0e1b3551abf6e43e6c9657", "message": "Improve codec randomization.", "committedDate": "2020-11-10T16:10:44Z", "type": "commit"}, {"oid": "65bb945cff0d2e9731c277a9c13f3824bbebd037", "url": "https://github.com/apache/lucene-solr/commit/65bb945cff0d2e9731c277a9c13f3824bbebd037", "message": "iter", "committedDate": "2020-11-10T16:23:32Z", "type": "commit"}, {"oid": "6aca71f04669d285ac400cf466188980c20fa1b4", "url": "https://github.com/apache/lucene-solr/commit/6aca71f04669d285ac400cf466188980c20fa1b4", "message": "iter", "committedDate": "2020-11-12T08:11:45Z", "type": "commit"}]}