{"pr_number": 2517, "pr_title": "Adding support to autoconfigure Cloud SQL ipTypes", "pr_createdAt": "2020-09-10T21:09:27Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517", "timeline": [{"oid": "c0a3770379dfda9264f37c2ee49d000355591a13", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/c0a3770379dfda9264f37c2ee49d000355591a13", "message": "Adding support to autoconfigure Cloud SQL ipTypes", "committedDate": "2020-09-09T10:32:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMTkxMg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r486731912", "bodyText": "Have you considered putting this logic into DefaultCloudSqlJdbcInfoProvider instead?\nThat class is specifically designed for creating the JDBC URL string.", "author": "meltsufin", "createdAt": "2020-09-11T02:10:42Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/sql/GcpCloudSqlAutoConfiguration.java", "diffHunk": "@@ -161,7 +162,11 @@ public DataSourceProperties cloudSqlDataSourceProperties(\n \t\t\t\tLOGGER.warn(\"Ignoring provided spring.datasource.url. Overwriting it based on the \" +\n \t\t\t\t\t\t\"spring.cloud.gcp.sql.instance-connection-name.\");\n \t\t\t}\n-\t\t\tproperties.setUrl(cloudSqlJdbcInfoProvider.getJdbcUrl());\n+\t\t\tString jdbcUrl = cloudSqlJdbcInfoProvider.getJdbcUrl();\n+\t\t\tif (StringUtils.hasText(gcpCloudSqlProperties.getIpTypes())) {\n+\t\t\t\tjdbcUrl = String.format(jdbcUrl + \"&ipTypes=%s\", gcpCloudSqlProperties.getIpTypes());", "originalCommit": "c0a3770379dfda9264f37c2ee49d000355591a13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyMDU0OQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r486820549", "bodyText": "No. I remember that I looked at patching the jdbcUrlTemplate in DatabaseType, but I didn't have the GcpCloudSqlProperties there. I must have overlooked DefaultCloudSqlJdbcInfoProvider.\nCode moved.", "author": "ohardeng", "createdAt": "2020-09-11T07:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMTkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMjg3Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r486732873", "bodyText": "Can you mention the default PUBLIC,PRIVATE here?", "author": "meltsufin", "createdAt": "2020-09-11T02:14:21Z", "path": "docs/src/main/asciidoc/sql.adoc", "diffHunk": "@@ -64,6 +64,7 @@ There is also some configuration specific to Google Cloud SQL:\n | `spring.cloud.gcp.sql.database-name` | Name of the database to connect to. |\n | `spring.cloud.gcp.sql.instance-connection-name` | A string containing a Google Cloud SQL instance's project ID, region and name, each separated by a colon.\n For example, `my-project-id:my-region:my-instance-name`. |\n+| `spring.cloud.gcp.sql.ip-types` | Allows you to specify a comma delimited list of preferred IP types for connecting to a Cloud SQL instance. See https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory#specifying-ip-types[Cloud SQL Socket Factory - Specifying IP Types] |", "originalCommit": "c0a3770379dfda9264f37c2ee49d000355591a13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyMDU4NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r486820585", "bodyText": "Done", "author": "ohardeng", "createdAt": "2020-09-11T07:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMjg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDYyNA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r487060624", "bodyText": "If you look at the preview, there is also a \"Default value\" column you can populate.", "author": "meltsufin", "createdAt": "2020-09-11T13:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMjg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1OTA0Ng==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r487159046", "bodyText": "Yes, I saw the \"Default value\" column, but felt that populating that would signify that spring-cloud-gcp was setting thoose default values. I now see that spring.cloud.gcp.sql.credentials.location specifies that it's Spring GCP Boot starter that supplying the defaults.\nSuggested rewrite:\n| spring.cloud.gcp.sql.ip-types | Allows you to specify a comma delimited list of preferred IP types for connecting to a Cloud SQL instance. See https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory#specifying-ip-types[Cloud SQL Socket Factory - Specifying IP Types] |  Default values (PUBLIC,PRIVATE) provided by Cloud SQL Socket Factory", "author": "ohardeng", "createdAt": "2020-09-11T16:33:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMjg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyODU1OA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r487228558", "bodyText": "The default doesn't have to be provided by this project. The column is there to make it more clear what would be the default.", "author": "meltsufin", "createdAt": "2020-09-11T18:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjczMjg3Mw=="}], "type": "inlineReview"}, {"oid": "234b8e1faf6db2ac38a7ce9101fa58ac9a28c188", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/234b8e1faf6db2ac38a7ce9101fa58ac9a28c188", "message": "Fixing PR comments ...\n\n* Moving implementation to DefaultCloudSqlJdbcInfoProvider\n* Adding Cloud SQL Socket Factory default ipTypes to documentation", "committedDate": "2020-09-11T07:10:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyODk1Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2517#discussion_r487228957", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            | `spring.cloud.gcp.sql.ip-types` | Allows you to specify a comma delimited list of preferred IP types for connecting to a Cloud SQL instance. Left unconfigured Cloud SQL Socket Factory will default it to `PUBLIC,PRIVATE`. See https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory#specifying-ip-types[Cloud SQL Socket Factory - Specifying IP Types] |\n          \n          \n            \n            | `spring.cloud.gcp.sql.ip-types` | Allows you to specify a comma delimited list of preferred IP types for connecting to a Cloud SQL instance. Left unconfigured Cloud SQL Socket Factory will default it to `PUBLIC,PRIVATE`. See https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory#specifying-ip-types[Cloud SQL Socket Factory - Specifying IP Types] | `PUBLIC,PRIVATE`", "author": "meltsufin", "createdAt": "2020-09-11T18:52:50Z", "path": "docs/src/main/asciidoc/sql.adoc", "diffHunk": "@@ -64,6 +64,7 @@ There is also some configuration specific to Google Cloud SQL:\n | `spring.cloud.gcp.sql.database-name` | Name of the database to connect to. |\n | `spring.cloud.gcp.sql.instance-connection-name` | A string containing a Google Cloud SQL instance's project ID, region and name, each separated by a colon.\n For example, `my-project-id:my-region:my-instance-name`. |\n+| `spring.cloud.gcp.sql.ip-types` | Allows you to specify a comma delimited list of preferred IP types for connecting to a Cloud SQL instance. Left unconfigured Cloud SQL Socket Factory will default it to `PUBLIC,PRIVATE`. See https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory#specifying-ip-types[Cloud SQL Socket Factory - Specifying IP Types] |", "originalCommit": "234b8e1faf6db2ac38a7ce9101fa58ac9a28c188", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f310696ae509dbc2b32d3811eaabe7812f645ca", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/4f310696ae509dbc2b32d3811eaabe7812f645ca", "message": "Update docs/src/main/asciidoc/sql.adoc", "committedDate": "2020-09-11T18:53:18Z", "type": "commit"}]}