{"pr_number": 2290, "pr_title": "Support Extra Propagation Fields with Trace", "pr_createdAt": "2020-03-27T15:30:47Z", "pr_url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290", "timeline": [{"oid": "6f555df412e9a6895c990926e29f0fd184e44854", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/6f555df412e9a6895c990926e29f0fd184e44854", "message": "Support Extra Propagation Fields with Trace\n\nProviding a Trace Propagation Factory Builder instead of just the Factory,\nwhile allows us to rely on the `TraceAutoConfiguration.sleuthPropagation()`\nrather than completely skipping it.\n\nFixes: #2268.", "committedDate": "2020-03-27T15:25:23Z", "type": "commit"}, {"oid": "11ae661d1be236db89c8170e8b7f3ab1f0582506", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/11ae661d1be236db89c8170e8b7f3ab1f0582506", "message": "Update dependencies", "committedDate": "2020-05-12T20:21:31Z", "type": "commit"}, {"oid": "b8df1343d2b6c7911a3eb6111f49bcf922623e6d", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/b8df1343d2b6c7911a3eb6111f49bcf922623e6d", "message": "Merge branch 'master' into trace-extra-fields", "committedDate": "2020-05-12T20:24:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxNzA1Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r424017052", "bodyText": "Does it make sense to move the version updates to a separate PR?", "author": "elefeint", "createdAt": "2020-05-12T20:35:10Z", "path": "spring-cloud-gcp-dependencies/pom.xml", "diffHunk": "@@ -16,8 +16,8 @@\n \t<packaging>pom</packaging>\n \n \t<properties>\n-\t\t<gcp-libraries-bom.version>4.4.1</gcp-libraries-bom.version>\n-\t\t<cloud-sql-socket-factory.version>1.0.15</cloud-sql-socket-factory.version>\n+\t\t<gcp-libraries-bom.version>5.3.0</gcp-libraries-bom.version>", "originalCommit": "b8df1343d2b6c7911a3eb6111f49bcf922623e6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43908d85e8edf01ca36dce415e0fbdf4c93b7b11", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/43908d85e8edf01ca36dce415e0fbdf4c93b7b11", "message": "undo unrelated version updates", "committedDate": "2020-05-12T21:01:38Z", "type": "commit"}, {"oid": "81302d56765f4a85f8477ee5b8a561e3f8d20305", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/81302d56765f4a85f8477ee5b8a561e3f8d20305", "message": "Remove sampler auto-config", "committedDate": "2020-05-18T22:11:58Z", "type": "commit"}, {"oid": "90e2f9f800d918f16326a3c2ee27e22ade116b94", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/90e2f9f800d918f16326a3c2ee27e22ade116b94", "message": "temporarily add HexCodec", "committedDate": "2020-05-18T22:12:28Z", "type": "commit"}, {"oid": "1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "message": "switch to BaggagePropagation", "committedDate": "2020-05-18T22:24:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDQwOA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r426970408", "bodyText": "right here will change with 0.17 we should use the correct brave.propagation package and add a comment that the underlying B3Propagation.Factory needs to be configured differently for sleuth 3.0\nThis can be a TODO I suppose as 3.0 isn't final anyway", "author": "codefromthecrypt", "createdAt": "2020-05-19T00:57:27Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java", "diffHunk": "@@ -221,8 +218,8 @@ public Sender stackdriverSender(GcpTraceProperties traceProperties,\n \n \t@Bean\n \t@ConditionalOnMissingBean\n-\tpublic Propagation.Factory stackdriverPropagation() {\n-\t\treturn StackdriverTracePropagation.FACTORY;\n+\tpublic BaggagePropagation.FactoryBuilder baggagePropagationFactoryBuilder() {\n+\t\treturn BaggagePropagation.newFactoryBuilder(StackdriverTracePropagation.FACTORY);", "originalCommit": "1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMxMzQ3Mg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427313472", "bodyText": "Do you mean that the B3Propagation.Factory would be configured differently in zipkin-gcp, because we're not configuring it here?", "author": "meltsufin", "createdAt": "2020-05-19T13:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2NTE3NQ==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427665175", "bodyText": "I mean what we are overriding will be different configuration 2.2.x vs 3.0.x. Until we some annotation or otherwise to indicate the \"real trace format\" factory vs the wrapped one, this project will have to build differently for 2.2.x vs 3.0 or have some logic etc. @spencergibb mentioned maybe we can change 3.0 to use the @Primary annotation. Will think about it. Anyway, this is fine for 2.2.x", "author": "codefromthecrypt", "createdAt": "2020-05-19T23:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDcxMg==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r426970712", "bodyText": "as this is src/test ... maybe just use Long.whatever? HexCodec is mostly for performance", "author": "codefromthecrypt", "createdAt": "2020-05-19T00:58:37Z", "path": "spring-cloud-gcp-samples/spring-cloud-gcp-trace-sample/src/test/java/brave/internal/HexCodec.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2013-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package brave.internal;\n+\n+// code originally imported from zipkin.Util\n+public final class HexCodec {", "originalCommit": "1fd018d20a145ed6b42ed876836a8b1f1e3c78a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMxMjQ4Ng==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427312486", "bodyText": "I will remove this class altogether, since you've added it in 0.17.0.", "author": "meltsufin", "createdAt": "2020-05-19T13:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3MDcxMg=="}], "type": "inlineReview"}, {"oid": "5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "message": "upgrade to zipkin-gcp 0.17.0", "committedDate": "2020-05-19T14:00:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMyNjM4NA==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427326384", "bodyText": "@adriancole I'm not sure if I have to pass in this B3Propagation, or it will be auto-configured like before.", "author": "meltsufin", "createdAt": "2020-05-19T14:03:00Z", "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/trace/StackdriverTraceAutoConfiguration.java", "diffHunk": "@@ -221,8 +219,9 @@ public Sender stackdriverSender(GcpTraceProperties traceProperties,\n \n \t@Bean\n \t@ConditionalOnMissingBean\n-\tpublic Propagation.Factory stackdriverPropagation() {\n-\t\treturn StackdriverTracePropagation.FACTORY;\n+\tpublic BaggagePropagation.FactoryBuilder baggagePropagationFactoryBuilder() {\n+\t\treturn BaggagePropagation.newFactoryBuilder(StackdriverTracePropagation.newFactory(\n+\t\t\t\tB3Propagation.newFactoryBuilder().injectFormat(B3Propagation.Format.MULTI).build()));", "originalCommit": "5ad71b86d9467e4b172053cbe9c6a3a9dd392ea6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2NTU5Nw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427665597", "bodyText": "we don't have a way to pass this yet. so this is good enough for 2.2.x", "author": "codefromthecrypt", "createdAt": "2020-05-19T23:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMyNjM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MTc1Mw==", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2290#discussion_r427681753", "bodyText": "Thanks!", "author": "meltsufin", "createdAt": "2020-05-20T00:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMyNjM4NA=="}], "type": "inlineReview"}]}