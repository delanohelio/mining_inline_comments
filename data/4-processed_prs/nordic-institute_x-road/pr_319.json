{"pr_number": 319, "pr_title": "XRDDEV-843 unregister auth cert bug", "pr_createdAt": "2020-01-15T08:02:32Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/319", "timeline": [{"oid": "1edddc82929ca67f923a660b30c02397b2d5b48e", "url": "https://github.com/nordic-institute/X-Road/commit/1edddc82929ca67f923a660b30c02397b2d5b48e", "message": "XRDDEV-843 Unregister auth cert or mark for deletion\n\n* added a new endpoint: /token-certificates/{hash}/mark-for-deletion\n* unregisterCertificate -> unregisterAuthCertificate\n* new service method\n* checkstyle fixes", "committedDate": "2020-01-14T14:52:59Z", "type": "commit"}, {"oid": "5f4181abc3d9f9d6981a8ce5ec661bf4fa45d09c", "url": "https://github.com/nordic-institute/X-Road/commit/5f4181abc3d9f9d6981a8ce5ec661bf4fa45d09c", "message": "XRDDEV-843 Unregister auth cert or mark for deletion // tests", "committedDate": "2020-01-15T07:56:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg3NDc4NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r366874785", "bodyText": "Frontend could handle this situation so that when unregisterAuthCertificate endpoint returns anything else than http 204 -> a popup will be offered to mark the cert for deletion.\nNow I would suggest getting rid of the CodedException error handling here (and let our ExceptionTranslator handle it as a 500) because we are sending an actual X-Road message and there are a lot of different errors that might occur.\nOne option would also be to translate all CodedExceptions caught here to something like XroadMessageException which would be translated into e.g. a ConflictException in the controller layer with the original error code provided by core.", "author": "carohauta", "createdAt": "2020-01-15T13:30:06Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java", "diffHunk": "@@ -556,29 +561,82 @@ public void registerAuthCert(String hash, String securityServerAddress) throws C\n     }\n \n     /**\n-     * Send the authentication certificate deletion request to central server\n+     * Send the authentication certificate deletion request to central server and set the cert status to\n+     * {@link CertificateInfo#STATUS_DELINPROG}\n      * @param hash certificate hash\n-     * @throws CertificateNotFoundException\n+     * @param skipUnregister whether to skip the actual delete request and only change cert status\n+     * @throws SignCertificateNotSupportedException\n+     * @throws ActionNotPossibleException\n      * @throws GlobalConfService.GlobalConfOutdatedException\n+     * @throws InvalidCertificateException\n+     * @throws KeyNotFoundException\n+     * @throws CertificateNotFoundException\n+     * @throws NoValidAuthCertificateException\n      */\n-    public void unregisterAuthCert(String hash) throws CertificateNotFoundException,\n-            GlobalConfService.GlobalConfOutdatedException, InvalidCertificateException,\n-            SignCertificateNotSupportedException, KeyNotFoundException, ActionNotPossibleException {\n+    private void unregisterAuthCertAndMarkForDeletion(String hash, boolean skipUnregister)\n+            throws CertificateNotFoundException, GlobalConfService.GlobalConfOutdatedException,\n+            InvalidCertificateException, SignCertificateNotSupportedException, KeyNotFoundException,\n+            ActionNotPossibleException, NoValidAuthCertificateException {\n         CertificateInfo certificateInfo = getCertificateInfo(hash);\n         verifyAuthCert(certificateInfo);\n         verifyCertAction(PossibleActionEnum.UNREGISTER, certificateInfo, hash);\n         SecurityServerId securityServerId = serverConfService.getSecurityServerId();\n         try {\n-            managementRequestSenderService.sendAuthCertDeletionRequest(securityServerId,\n-                    certificateInfo.getCertificateBytes());\n+            if (!skipUnregister) {\n+                managementRequestSenderService.sendAuthCertDeletionRequest(securityServerId,\n+                        certificateInfo.getCertificateBytes());\n+            }\n             signerProxyFacade.setCertStatus(certificateInfo.getId(), CertificateInfo.STATUS_DELINPROG);\n-        } catch (GlobalConfService.GlobalConfOutdatedException | CodedException e) {\n+        } catch (CodedException ce) {\n+            if (isCausedBySslAuthFailure(ce)) {\n+                throw new NoValidAuthCertificateException(ce);\n+            }\n+            throw ce;", "originalCommit": "5f4181abc3d9f9d6981a8ce5ec661bf4fa45d09c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxODM0OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367418349", "bodyText": "Yeah. Maybe the last suggestion, about XroadMessageException, would be good to make our implementation work the same way as old implementation. More about this in slack discussion.", "author": "jansu76", "createdAt": "2020-01-16T13:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg3NDc4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkxMDcwNA==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367910704", "bodyText": "There are now separate try-catch-blocks for both sendAuthCertDeletionRequest and setCertStatus and they provide different exceptions:\nsendAuthCertDeletionRequest -> ManagementRequestSendingFailedException -> InternalServerErrorException\nsetCertStatus -> RuntimeException", "author": "carohauta", "createdAt": "2020-01-17T12:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg3NDc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxNzYxNw==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367417617", "bodyText": "Not a change request about this PR, but a thought. Are we misusing http 400 bad request? Like \"global conf outdated\" is not a client error, it is not result of a bad API call? Perhaps some other catches here as well.\nBut it is a widely used pattern in our implementation, so not directly related to this PR.", "author": "jansu76", "createdAt": "2020-01-16T13:31:57Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/TokenCertificatesApiController.java", "diffHunk": "@@ -203,14 +203,31 @@ public TokenCertificatesApiController(TokenCertificateService tokenCertificateSe\n \n     @Override\n     @PreAuthorize(\"hasAuthority('SEND_AUTH_CERT_DEL_REQ')\")\n-    public ResponseEntity<Void> unregisterCertificate(String hash) {\n+    public ResponseEntity<Void> unregisterAuthCertificate(String hash) {\n         try {\n             tokenCertificateService.unregisterAuthCert(hash);\n         } catch (CertificateNotFoundException e) {\n             throw new ResourceNotFoundException(e);\n         } catch (GlobalConfService.GlobalConfOutdatedException | TokenCertificateService.InvalidCertificateException\n                 | TokenCertificateService.SignCertificateNotSupportedException e) {\n             throw new BadRequestException(e);\n+        } catch (ActionNotPossibleException | KeyNotFoundException\n+                | TokenCertificateService.NoValidAuthCertificateException e) {\n+            throw new ConflictException(e);\n+        }\n+        return new ResponseEntity<>(HttpStatus.NO_CONTENT);\n+    }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('SEND_AUTH_CERT_DEL_REQ')\")\n+    public ResponseEntity<Void> markAuthCertForDeletion(String hash) {\n+        try {\n+            tokenCertificateService.markAuthCertForDeletion(hash);\n+        } catch (CertificateNotFoundException e) {\n+            throw new ResourceNotFoundException(e);\n+        } catch (GlobalConfService.GlobalConfOutdatedException | TokenCertificateService.InvalidCertificateException", "originalCommit": "5f4181abc3d9f9d6981a8ce5ec661bf4fa45d09c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyNDAyNA==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367924024", "bodyText": "That is a good point. I think that 400 Bad Request is being misused pretty widely in the Internet and it is sometimes considered a general exception even though it should be on the client.", "author": "carohauta", "createdAt": "2020-01-17T13:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxNzYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxODkxMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367418911", "bodyText": "This is a duplicate of CERT_NOT_FOUND_FAULT_CODE, on purpose or not? Anyways probably deprecated if unregisterAuthCertAndMarkForDeletion exception handling is refactored.", "author": "jansu76", "createdAt": "2020-01-16T13:34:40Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java", "diffHunk": "@@ -642,11 +700,16 @@ static boolean isCausedByCertNotFound(CodedException e) {\n         return CERT_NOT_FOUND_FAULT_CODE.equals(e.getFaultCode());\n     }\n \n+    static boolean isCausedBySslAuthFailure(CodedException e) {\n+        return SSL_AUTH_FAULT_CODE.equals(e.getFaultCode());\n+    }\n+\n     static final String DUPLICATE_CERT_FAULT_CODE = signerFaultCode(X_CERT_EXISTS);\n     static final String INCORRECT_CERT_FAULT_CODE = signerFaultCode(X_INCORRECT_CERTIFICATE);\n     static final String CERT_WRONG_USAGE_FAULT_CODE = signerFaultCode(X_WRONG_CERT_USAGE);\n     static final String CSR_NOT_FOUND_FAULT_CODE = signerFaultCode(X_CSR_NOT_FOUND);\n     static final String CERT_NOT_FOUND_FAULT_CODE = signerFaultCode(X_CERT_NOT_FOUND);\n+    static final String SSL_AUTH_FAULT_CODE = clientProxyFaultCode(X_CERT_NOT_FOUND);", "originalCommit": "5f4181abc3d9f9d6981a8ce5ec661bf4fa45d09c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyMjI3MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367422271", "bodyText": "Sorry, no. Did not see the clientProxy vs signer part initially.", "author": "jansu76", "createdAt": "2020-01-16T13:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxODkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyMDUzNA==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367420534", "bodyText": "I think silent catches should still be avoided always, even if we know that exception is impossible currently. Throwing runtime exception is better since at least it protects against mistakes done in future, when e.g. someone modifies unregisterAuthCertAndMarkForDeletion and impossible becomes possible. Also throw new RuntimeException(e); is easy to add.", "author": "jansu76", "createdAt": "2020-01-16T13:38:01Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java", "diffHunk": "@@ -556,29 +561,82 @@ public void registerAuthCert(String hash, String securityServerAddress) throws C\n     }\n \n     /**\n-     * Send the authentication certificate deletion request to central server\n+     * Send the authentication certificate deletion request to central server and set the cert status to\n+     * {@link CertificateInfo#STATUS_DELINPROG}\n      * @param hash certificate hash\n-     * @throws CertificateNotFoundException\n+     * @param skipUnregister whether to skip the actual delete request and only change cert status\n+     * @throws SignCertificateNotSupportedException\n+     * @throws ActionNotPossibleException\n      * @throws GlobalConfService.GlobalConfOutdatedException\n+     * @throws InvalidCertificateException\n+     * @throws KeyNotFoundException\n+     * @throws CertificateNotFoundException\n+     * @throws NoValidAuthCertificateException\n      */\n-    public void unregisterAuthCert(String hash) throws CertificateNotFoundException,\n-            GlobalConfService.GlobalConfOutdatedException, InvalidCertificateException,\n-            SignCertificateNotSupportedException, KeyNotFoundException, ActionNotPossibleException {\n+    private void unregisterAuthCertAndMarkForDeletion(String hash, boolean skipUnregister)\n+            throws CertificateNotFoundException, GlobalConfService.GlobalConfOutdatedException,\n+            InvalidCertificateException, SignCertificateNotSupportedException, KeyNotFoundException,\n+            ActionNotPossibleException, NoValidAuthCertificateException {\n         CertificateInfo certificateInfo = getCertificateInfo(hash);\n         verifyAuthCert(certificateInfo);\n         verifyCertAction(PossibleActionEnum.UNREGISTER, certificateInfo, hash);\n         SecurityServerId securityServerId = serverConfService.getSecurityServerId();\n         try {\n-            managementRequestSenderService.sendAuthCertDeletionRequest(securityServerId,\n-                    certificateInfo.getCertificateBytes());\n+            if (!skipUnregister) {\n+                managementRequestSenderService.sendAuthCertDeletionRequest(securityServerId,\n+                        certificateInfo.getCertificateBytes());\n+            }\n             signerProxyFacade.setCertStatus(certificateInfo.getId(), CertificateInfo.STATUS_DELINPROG);\n-        } catch (GlobalConfService.GlobalConfOutdatedException | CodedException e) {\n+        } catch (CodedException ce) {\n+            if (isCausedBySslAuthFailure(ce)) {\n+                throw new NoValidAuthCertificateException(ce);\n+            }\n+            throw ce;\n+        } catch (GlobalConfService.GlobalConfOutdatedException e) {\n             throw e;\n         } catch (Exception e) {\n             throw new RuntimeException(\"Could not unregister auth cert\", e);\n         }\n     }\n \n+    /**\n+     * Send the authentication certificate deletion request to central server and set cert status to\n+     * {@link CertificateInfo#STATUS_DELINPROG}\n+     * @param hash certificate hash\n+     * @throws SignCertificateNotSupportedException\n+     * @throws ActionNotPossibleException\n+     * @throws GlobalConfService.GlobalConfOutdatedException\n+     * @throws InvalidCertificateException\n+     * @throws KeyNotFoundException\n+     * @throws CertificateNotFoundException\n+     * @throws NoValidAuthCertificateException\n+     */\n+    public void unregisterAuthCert(String hash) throws SignCertificateNotSupportedException,\n+            ActionNotPossibleException, GlobalConfService.GlobalConfOutdatedException, InvalidCertificateException,\n+            KeyNotFoundException, CertificateNotFoundException, NoValidAuthCertificateException {\n+        unregisterAuthCertAndMarkForDeletion(hash, false);\n+    }\n+\n+    /**\n+     * Set the authentication certificate status to {@link CertificateInfo#STATUS_DELINPROG}\n+     * @param hash certificate hash\n+     * @throws SignCertificateNotSupportedException\n+     * @throws ActionNotPossibleException\n+     * @throws GlobalConfService.GlobalConfOutdatedException\n+     * @throws InvalidCertificateException\n+     * @throws KeyNotFoundException\n+     * @throws CertificateNotFoundException\n+     */\n+    public void markAuthCertForDeletion(String hash) throws SignCertificateNotSupportedException,\n+            ActionNotPossibleException, GlobalConfService.GlobalConfOutdatedException, InvalidCertificateException,\n+            KeyNotFoundException, CertificateNotFoundException {\n+        try {\n+            unregisterAuthCertAndMarkForDeletion(hash, true);\n+        } catch (NoValidAuthCertificateException e) {\n+            // Not a possible exception because the unregister request was never sent", "originalCommit": "5f4181abc3d9f9d6981a8ce5ec661bf4fa45d09c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzMTI1Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367431252", "bodyText": "I agree that normally they should be avoided but this is somewhat the exception that proves the rule (pardon the pun); I was thinking that skipping the NoValidAuthCertificateException is exactly what we want to do here (since this is the skipUnregister method). This also hides a redundant exception from the controller layer", "author": "carohauta", "createdAt": "2020-01-16T13:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyMDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2MjAzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367462038", "bodyText": "I am not sure I understand. catch (NoValidAuthCertificateException e) should never happen currently, right? We know that by reasoning, but the poor compiler does not know it.\nSince it never happens, adding a throw new RuntimeException(e); after the comment (I think the comment should stay, it is good to have) does not do anything.\nIf instead our reasoning was wrong, or someone later modifies unregisterAuthCertAndMarkForDeletion so that it does throw NoValidAuthCertificateException for some reason (stranger things have happened), we get a RuntimeException instead of http 200 OK.\nNoValidAuthCertificateException is still hidden from the controller layer.\nI am guessing Sonar would also complain about current implementation.\nSo I am suggesting this:\n        try {\n            unregisterAuthCertAndMarkForDeletion(hash, true);\n        } catch (NoValidAuthCertificateException e) {\n            // Not a possible exception because the unregister request was never sent\n            throw new RuntimeException(e);\n        }", "author": "jansu76", "createdAt": "2020-01-16T14:54:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyMDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ4ODY2Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r367488667", "bodyText": "It is now ManagementRequestSendingFailedException and it is also thrown to the controller layer, where it is wrapped inside InternalServerErrorException, because in case of e.g. IOException we still want to see the error message in frontend.\nBut to elaborate more on the previous subject: I was thinking something along the lines that the user is deliberately using an API and a method that is supposed to only mark the cert as DELETE_IN_PROGRESS and not send any requests at all -> there is no reason to stop code execution in the case of NoValidAuthCertificateException because the cert has been, in fact, successfully marked as DELETE_IN_PROGRESS. Of course this probably indicates a flaw in design over anything else and like you said it is probably not ok for SonarQube. <- this is not true because the cert status wouldn't have changed after all\nI'll finish the rest of the task and ask for more comments", "author": "carohauta", "createdAt": "2020-01-16T15:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyMDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU0MjgwNA==", "url": "https://github.com/nordic-institute/X-Road/pull/319#discussion_r368542804", "bodyText": "TokenCertificateService.markAuthCertForDeletion could still remove one exception type which should never happen (but should still result in RuntimeException, for safety):\n    public void markAuthCertForDeletion(String hash) throws SignCertificateNotSupportedException,\n            ActionNotPossibleException, GlobalConfService.GlobalConfOutdatedException, InvalidCertificateException,\n            KeyNotFoundException, CertificateNotFoundException {\n        try {\n            unregisterAuthCertAndMarkForDeletion(hash, true);\n        } catch (ManagementRequestSenderService.ManagementRequestSendingFailedException e) {\n            // should never happen since we're not sending management requests\n            throw new RuntimeException(e);\n        }\n    }", "author": "jansu76", "createdAt": "2020-01-20T13:19:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyMDUzNA=="}], "type": "inlineReview"}, {"oid": "5a63dac8a8c550990220ff157d4edebcec89ba2a", "url": "https://github.com/nordic-institute/X-Road/commit/5a63dac8a8c550990220ff157d4edebcec89ba2a", "message": "XRDDEV-843 Unregister auth cert or mark for deletion // PR fix\n\n* refactor exceptions", "committedDate": "2020-01-16T14:17:21Z", "type": "commit"}, {"oid": "9e621396d50a7d7e974407165385ccca7f6c8fc5", "url": "https://github.com/nordic-institute/X-Road/commit/9e621396d50a7d7e974407165385ccca7f6c8fc5", "message": "XRDDEV-843 Unregister auth cert or mark for deletion // PR fix 1\n\n* better exception handling with ManagementRequestSendingFailedException", "committedDate": "2020-01-17T11:48:40Z", "type": "commit"}, {"oid": "d780af7fcd054edfb3becb567ea1eece51499597", "url": "https://github.com/nordic-institute/X-Road/commit/d780af7fcd054edfb3becb567ea1eece51499597", "message": "Merge branch 'develop' into XRDDEV-843-unregister-auth-cert-bug\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java", "committedDate": "2020-01-17T11:55:10Z", "type": "commit"}, {"oid": "10999f1bb377c73468b672abf8ab3b0f8f8559c5", "url": "https://github.com/nordic-institute/X-Road/commit/10999f1bb377c73468b672abf8ab3b0f8f8559c5", "message": "XRDDEV-843 Unregister auth cert or mark for deletion // SonarQ fix", "committedDate": "2020-01-17T13:05:58Z", "type": "commit"}, {"oid": "862c79e93c22786f1677955a17463a9e28836010", "url": "https://github.com/nordic-institute/X-Road/commit/862c79e93c22786f1677955a17463a9e28836010", "message": "XRDDEV-843 Unregister auth cert or mark for deletion // PR fix 2", "committedDate": "2020-01-20T13:49:46Z", "type": "commit"}]}