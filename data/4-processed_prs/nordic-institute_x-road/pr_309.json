{"pr_number": 309, "pr_title": "XRDDEV-794", "pr_createdAt": "2020-01-08T12:49:05Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/309", "timeline": [{"oid": "c97e16840ca7cf267f8d28b81c3bcb02d672d88d", "url": "https://github.com/nordic-institute/X-Road/commit/c97e16840ca7cf267f8d28b81c3bcb02d672d88d", "message": "XRDDEV-794: Copy OpenapiParser from proxy-ui to proxy-ui-api", "committedDate": "2019-12-30T20:00:15Z", "type": "commit"}, {"oid": "82b4895297e7342c84e91aece6ba388452d2cc28", "url": "https://github.com/nordic-institute/X-Road/commit/82b4895297e7342c84e91aece6ba388452d2cc28", "message": "XRDDEV-794: Added initial implementation for adding service description of type REST", "committedDate": "2020-01-02T14:57:06Z", "type": "commit"}, {"oid": "f0a8ea41d2130d2038f94ba990a5baee2db9e146", "url": "https://github.com/nordic-institute/X-Road/commit/f0a8ea41d2130d2038f94ba990a5baee2db9e146", "message": "XRDDEV-794: Add initial implementation for adding REST api using openapi3 description URL", "committedDate": "2020-01-07T08:07:32Z", "type": "commit"}, {"oid": "495cf89bba9254c24a6d7b726ffa33532e39beb7", "url": "https://github.com/nordic-institute/X-Road/commit/495cf89bba9254c24a6d7b726ffa33532e39beb7", "message": "XRDDEV-794: Refactoring & add integration tests", "committedDate": "2020-01-08T12:31:48Z", "type": "commit"}, {"oid": "0918e47f01e1e94d51f6b20ff15b564e13759736", "url": "https://github.com/nordic-institute/X-Road/commit/0918e47f01e1e94d51f6b20ff15b564e13759736", "message": "XRDDEV-794: Remove unused import", "committedDate": "2020-01-09T10:36:37Z", "type": "commit"}, {"oid": "6d97662cb3a0dc35e69d9cf5914b787a079f4330", "url": "https://github.com/nordic-institute/X-Road/commit/6d97662cb3a0dc35e69d9cf5914b787a079f4330", "message": "XRDDEV-794: Refactoring according to sonarqube issues", "committedDate": "2020-01-09T11:29:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcxNDI1OA==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r364714258", "bodyText": "Try-catch not needed here because the exception is already added to method signature", "author": "carohauta", "createdAt": "2020-01-09T12:32:07Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -235,55 +251,210 @@ public ServiceDescriptionType addWsdlServiceDescription(ClientId clientId, Strin\n     /**\n      * Create a new {@link EndpointType} for all Services in the provided {@link ServiceDescriptionType}.\n      * If an equal EndpointType already exists for the provided {@link ClientType} it will not be returned\n+     *\n      * @param client\n      * @param newServiceDescription\n      * @return Only the newly created EndpointTypes\n      */\n     private Collection<EndpointType> resolveNewEndpoints(ClientType client,\n-            ServiceDescriptionType newServiceDescription) {\n+                                                         ServiceDescriptionType newServiceDescription) {\n         Map<String, EndpointType> endpointMap = new HashMap<>();\n \n         // add all new endpoints into a hashmap with a combination key\n         newServiceDescription.getService().forEach(serviceType -> {\n             EndpointType endpointType = new EndpointType(serviceType.getServiceCode(), EndpointType.ANY_METHOD,\n                     EndpointType.ANY_PATH, true);\n-            String endpointKey = endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n-                    + endpointType.isGenerated();\n+            String endpointKey = createEndpointKey(endpointType);\n             endpointMap.put(endpointKey, endpointType);\n         });\n \n         // remove all existing endpoints with an equal combination key from the map\n         client.getEndpoint().forEach(endpointType -> {\n-            String endpointKey = endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n-                    + endpointType.isGenerated();\n+            String endpointKey = createEndpointKey(endpointType);\n             endpointMap.remove(endpointKey);\n         });\n \n         return endpointMap.values();\n     }\n \n+    private String createEndpointKey(EndpointType endpointType) {\n+        return endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n+                + endpointType.isGenerated();\n+    }\n+\n+    public ServiceDescriptionType addOpenapi3ServiceDescription(ClientId clientId, String url,\n+                                                                String serviceCode, boolean ignoreWarnings)\n+            throws OpenApiParser.ParsingException, ClientNotFoundException,\n+            UnhandledWarningsException,\n+            UrlAlreadyExistsException,\n+            ServiceCodeAlreadyExistsException {\n+        verifyAuthority(\"ADD_OPENAPI3\");\n+\n+        // Parse openapi definition\n+        OpenApiParser.Result result = null;\n+        try {", "originalCommit": "6d97662cb3a0dc35e69d9cf5914b787a079f4330", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcxNTgwMw==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r364715803", "bodyText": "Try-catch not needed here because the exceptions are already added to method signature", "author": "carohauta", "createdAt": "2020-01-09T12:36:21Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -235,55 +251,210 @@ public ServiceDescriptionType addWsdlServiceDescription(ClientId clientId, Strin\n     /**\n      * Create a new {@link EndpointType} for all Services in the provided {@link ServiceDescriptionType}.\n      * If an equal EndpointType already exists for the provided {@link ClientType} it will not be returned\n+     *\n      * @param client\n      * @param newServiceDescription\n      * @return Only the newly created EndpointTypes\n      */\n     private Collection<EndpointType> resolveNewEndpoints(ClientType client,\n-            ServiceDescriptionType newServiceDescription) {\n+                                                         ServiceDescriptionType newServiceDescription) {\n         Map<String, EndpointType> endpointMap = new HashMap<>();\n \n         // add all new endpoints into a hashmap with a combination key\n         newServiceDescription.getService().forEach(serviceType -> {\n             EndpointType endpointType = new EndpointType(serviceType.getServiceCode(), EndpointType.ANY_METHOD,\n                     EndpointType.ANY_PATH, true);\n-            String endpointKey = endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n-                    + endpointType.isGenerated();\n+            String endpointKey = createEndpointKey(endpointType);\n             endpointMap.put(endpointKey, endpointType);\n         });\n \n         // remove all existing endpoints with an equal combination key from the map\n         client.getEndpoint().forEach(endpointType -> {\n-            String endpointKey = endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n-                    + endpointType.isGenerated();\n+            String endpointKey = createEndpointKey(endpointType);\n             endpointMap.remove(endpointKey);\n         });\n \n         return endpointMap.values();\n     }\n \n+    private String createEndpointKey(EndpointType endpointType) {\n+        return endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n+                + endpointType.isGenerated();\n+    }\n+\n+    public ServiceDescriptionType addOpenapi3ServiceDescription(ClientId clientId, String url,\n+                                                                String serviceCode, boolean ignoreWarnings)\n+            throws OpenApiParser.ParsingException, ClientNotFoundException,\n+            UnhandledWarningsException,\n+            UrlAlreadyExistsException,\n+            ServiceCodeAlreadyExistsException {\n+        verifyAuthority(\"ADD_OPENAPI3\");\n+\n+        // Parse openapi definition\n+        OpenApiParser.Result result = null;\n+        try {\n+            result = openApiParser.parse(url);\n+        } catch (OpenApiParser.ParsingException e) {\n+            throw e;\n+        }\n+\n+        if (!ignoreWarnings && result.hasWarnings()) {\n+            WarningDeviation openapiParserWarnings = new WarningDeviation(\"OpenapiParserWarnings\",\n+                    result.getWarnings());\n+            throw new UnhandledWarningsException(Arrays.asList(openapiParserWarnings));\n+        }\n+\n+        ClientType client = clientService.getClient(clientId);\n+        if (client == null) {\n+            throw new ClientNotFoundException(CLIENT_WITH_ID + \" \" + clientId.toShortString() + \" not found\");\n+        }\n+\n+        ServiceDescriptionType serviceDescriptionType = getServiceDescriptionOfType(client, url,\n+                DescriptionType.OPENAPI3);\n+\n+        // Initiate default service\n+        ServiceType serviceType = new ServiceType();\n+        serviceType.setServiceCode(serviceCode);\n+        serviceType.setTimeout(DEFAULT_SERVICE_TIMEOUT);\n+        serviceType.setUrl(url);\n+        serviceType.setServiceDescription(serviceDescriptionType);\n+\n+        // Populate ServiceDescription\n+        serviceDescriptionType.getService().add(serviceType);\n+\n+        // Create endpoints\n+        List<EndpointType> endpoints = result.getOperations().stream()\n+                .map(operation -> new EndpointType(serviceCode, operation.getMethod(), operation.getPath(), true))\n+                .collect(Collectors.toList());\n+\n+        try {", "originalCommit": "6d97662cb3a0dc35e69d9cf5914b787a079f4330", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyOTc4NA==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r364729784", "bodyText": "restServiceCode might be null here which causes problems later. Needs a null check and proper exception (BadRequestException)", "author": "carohauta", "createdAt": "2020-01-09T13:12:08Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -336,9 +341,25 @@ private ClientType getClientType(String encodedId) {\n                 // deviation data (errorcode + warnings) copied\n                 throw new ConflictException(e);\n             }\n-\n         } else if (serviceDescription.getType() == ServiceType.OPENAPI3) {\n-            return new ResponseEntity<>(HttpStatus.NOT_IMPLEMENTED);\n+            try {\n+                addedServiceDescriptionType = serviceDescriptionService.addOpenapi3ServiceDescription(clientId, url,\n+                        restServiceCode, ignoreWarnings);", "originalCommit": "6d97662cb3a0dc35e69d9cf5914b787a079f4330", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczMDUwNQ==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r364730505", "bodyText": "serviceDescription.getRestServiceCode() might return null here which causes problems later. Needs a null check and proper exception (BadRequestException). Could also use the above introduced restServiceCode variable.", "author": "carohauta", "createdAt": "2020-01-09T13:13:45Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -336,9 +341,25 @@ private ClientType getClientType(String encodedId) {\n                 // deviation data (errorcode + warnings) copied\n                 throw new ConflictException(e);\n             }\n-\n         } else if (serviceDescription.getType() == ServiceType.OPENAPI3) {\n-            return new ResponseEntity<>(HttpStatus.NOT_IMPLEMENTED);\n+            try {\n+                addedServiceDescriptionType = serviceDescriptionService.addOpenapi3ServiceDescription(clientId, url,\n+                        restServiceCode, ignoreWarnings);\n+            } catch (OpenApiParser.ParsingException | UnhandledWarningsException e) {\n+                throw new BadRequestException(e);\n+            } catch (ClientNotFoundException e) {\n+                throw new ResourceNotFoundException(e);\n+            } catch (ServiceDescriptionService.UrlAlreadyExistsException\n+                    | ServiceDescriptionService.ServiceCodeAlreadyExistsException e) {\n+                throw new ConflictException(e);\n+            }\n+        } else if (serviceDescription.getType() == ServiceType.REST) {\n+            try {\n+                addedServiceDescriptionType = serviceDescriptionService.addRestEndpointServiceDescription(clientId,\n+                        url, serviceDescription.getRestServiceCode());", "originalCommit": "6d97662cb3a0dc35e69d9cf5914b787a079f4330", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczNDE1OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r364734159", "bodyText": "Could also be simplified with Stream#anyMatch\nBoolean hasDuplicates = serviceDescription.getClient().getServiceDescription().stream()\n                .anyMatch(other -> !serviceDescription.equals(other) && serviceDescription.getUrl().equals(other.getUrl()));", "author": "carohauta", "createdAt": "2020-01-09T13:22:01Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -235,55 +251,210 @@ public ServiceDescriptionType addWsdlServiceDescription(ClientId clientId, Strin\n     /**\n      * Create a new {@link EndpointType} for all Services in the provided {@link ServiceDescriptionType}.\n      * If an equal EndpointType already exists for the provided {@link ClientType} it will not be returned\n+     *\n      * @param client\n      * @param newServiceDescription\n      * @return Only the newly created EndpointTypes\n      */\n     private Collection<EndpointType> resolveNewEndpoints(ClientType client,\n-            ServiceDescriptionType newServiceDescription) {\n+                                                         ServiceDescriptionType newServiceDescription) {\n         Map<String, EndpointType> endpointMap = new HashMap<>();\n \n         // add all new endpoints into a hashmap with a combination key\n         newServiceDescription.getService().forEach(serviceType -> {\n             EndpointType endpointType = new EndpointType(serviceType.getServiceCode(), EndpointType.ANY_METHOD,\n                     EndpointType.ANY_PATH, true);\n-            String endpointKey = endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n-                    + endpointType.isGenerated();\n+            String endpointKey = createEndpointKey(endpointType);\n             endpointMap.put(endpointKey, endpointType);\n         });\n \n         // remove all existing endpoints with an equal combination key from the map\n         client.getEndpoint().forEach(endpointType -> {\n-            String endpointKey = endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n-                    + endpointType.isGenerated();\n+            String endpointKey = createEndpointKey(endpointType);\n             endpointMap.remove(endpointKey);\n         });\n \n         return endpointMap.values();\n     }\n \n+    private String createEndpointKey(EndpointType endpointType) {\n+        return endpointType.getServiceCode() + endpointType.getMethod() + endpointType.getPath()\n+                + endpointType.isGenerated();\n+    }\n+\n+    public ServiceDescriptionType addOpenapi3ServiceDescription(ClientId clientId, String url,\n+                                                                String serviceCode, boolean ignoreWarnings)\n+            throws OpenApiParser.ParsingException, ClientNotFoundException,\n+            UnhandledWarningsException,\n+            UrlAlreadyExistsException,\n+            ServiceCodeAlreadyExistsException {\n+        verifyAuthority(\"ADD_OPENAPI3\");\n+\n+        // Parse openapi definition\n+        OpenApiParser.Result result = null;\n+        try {\n+            result = openApiParser.parse(url);\n+        } catch (OpenApiParser.ParsingException e) {\n+            throw e;\n+        }\n+\n+        if (!ignoreWarnings && result.hasWarnings()) {\n+            WarningDeviation openapiParserWarnings = new WarningDeviation(\"OpenapiParserWarnings\",\n+                    result.getWarnings());\n+            throw new UnhandledWarningsException(Arrays.asList(openapiParserWarnings));\n+        }\n+\n+        ClientType client = clientService.getClient(clientId);\n+        if (client == null) {\n+            throw new ClientNotFoundException(CLIENT_WITH_ID + \" \" + clientId.toShortString() + \" not found\");\n+        }\n+\n+        ServiceDescriptionType serviceDescriptionType = getServiceDescriptionOfType(client, url,\n+                DescriptionType.OPENAPI3);\n+\n+        // Initiate default service\n+        ServiceType serviceType = new ServiceType();\n+        serviceType.setServiceCode(serviceCode);\n+        serviceType.setTimeout(DEFAULT_SERVICE_TIMEOUT);\n+        serviceType.setUrl(url);\n+        serviceType.setServiceDescription(serviceDescriptionType);\n+\n+        // Populate ServiceDescription\n+        serviceDescriptionType.getService().add(serviceType);\n+\n+        // Create endpoints\n+        List<EndpointType> endpoints = result.getOperations().stream()\n+                .map(operation -> new EndpointType(serviceCode, operation.getMethod(), operation.getPath(), true))\n+                .collect(Collectors.toList());\n+\n+        try {\n+            checkDuplicateUrl(serviceDescriptionType);\n+            checkDuplicateServiceCodes(serviceDescriptionType);\n+        } catch (UrlAlreadyExistsException | ServiceCodeAlreadyExistsException e) {\n+            throw e;\n+        }\n+\n+        // Populate client with new servicedescription and endpoints\n+        client.getEndpoint().addAll(endpoints);\n+        client.getServiceDescription().add(serviceDescriptionType);\n+        clientRepository.saveOrUpdateAndFlush(client);\n+\n+        return serviceDescriptionType;\n+    }\n+\n+    /**\n+     * Check whether the ServiceDescriptions url already exists in the linked Client\n+     *\n+     * @param serviceDescription\n+     * @throws UrlAlreadyExistsException\n+     */\n+    private void checkDuplicateUrl(ServiceDescriptionType serviceDescription) throws UrlAlreadyExistsException {\n+        Boolean hasDuplicates = serviceDescription.getClient().getServiceDescription().stream()\n+                .map(other -> !serviceDescription.equals(other) && serviceDescription.getUrl().equals(other.getUrl()))\n+                .reduce(false, (prev, curr) -> prev || curr);", "originalCommit": "6d97662cb3a0dc35e69d9cf5914b787a079f4330", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6ac518dbfb9a83dd12384cc9b3192012a662ae7b", "url": "https://github.com/nordic-institute/X-Road/commit/6ac518dbfb9a83dd12384cc9b3192012a662ae7b", "message": "XRDDEV-794: Fixes according to review comments", "committedDate": "2020-01-09T21:18:11Z", "type": "commit"}, {"oid": "518a6baa36d3566bc99f9fe304a20306364ba0d8", "url": "https://github.com/nordic-institute/X-Road/commit/518a6baa36d3566bc99f9fe304a20306364ba0d8", "message": "XRDDEV-794: Fix checkstyle error", "committedDate": "2020-01-10T07:24:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwNjE2Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r365106167", "bodyText": "The BadRequestException should be moved into the controller.\nThis particular case is somewhat unusual because the serviceCode param should actually be validated already in the API layer but we can't do that because we have a shared endpoint for adding WSDL's and OPENAPI/REST types.", "author": "carohauta", "createdAt": "2020-01-10T07:46:37Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -290,14 +291,13 @@ public ServiceDescriptionType addOpenapi3ServiceDescription(ClientId clientId, S\n             ServiceCodeAlreadyExistsException {\n         verifyAuthority(\"ADD_OPENAPI3\");\n \n-        // Parse openapi definition\n-        OpenApiParser.Result result = null;\n-        try {\n-            result = openApiParser.parse(url);\n-        } catch (OpenApiParser.ParsingException e) {\n-            throw e;\n+        if (serviceCode == null) {\n+            throw new BadRequestException(\"Missing ServiceCode\");", "originalCommit": "518a6baa36d3566bc99f9fe304a20306364ba0d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwNjM3MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r365106371", "bodyText": "There is also another one here", "author": "carohauta", "createdAt": "2020-01-10T07:47:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwNjE2Nw=="}], "type": "inlineReview"}, {"oid": "35973b33dce6a5160d9152e669e18c56fdaf1867", "url": "https://github.com/nordic-institute/X-Road/commit/35973b33dce6a5160d9152e669e18c56fdaf1867", "message": "XRDDEV-794: Throw MissingParameterException from service layer and change it to BadRequestException in the controller", "committedDate": "2020-01-10T08:50:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEzNzQ3Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r365137477", "bodyText": "Redundant catch", "author": "carohauta", "createdAt": "2020-01-10T09:19:17Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -336,9 +342,27 @@ private ClientType getClientType(String encodedId) {\n                 // deviation data (errorcode + warnings) copied\n                 throw new ConflictException(e);\n             }\n-\n         } else if (serviceDescription.getType() == ServiceType.OPENAPI3) {\n-            return new ResponseEntity<>(HttpStatus.NOT_IMPLEMENTED);\n+            try {\n+                addedServiceDescriptionType = serviceDescriptionService.addOpenapi3ServiceDescription(clientId, url,\n+                        restServiceCode, ignoreWarnings);\n+            } catch (OpenApiParser.ParsingException | UnhandledWarningsException | MissingParameterException e) {\n+                throw new BadRequestException(e);\n+            } catch (ClientNotFoundException e) {\n+                throw new ResourceNotFoundException(e);\n+            } catch (ServiceDescriptionService.UrlAlreadyExistsException\n+                    | ServiceDescriptionService.ServiceCodeAlreadyExistsException e) {\n+                throw new ConflictException(e);\n+            }\n+        } else if (serviceDescription.getType() == ServiceType.REST) {\n+            try {\n+                addedServiceDescriptionType = serviceDescriptionService.addRestEndpointServiceDescription(clientId,\n+                        url, restServiceCode);\n+            } catch (ClientNotFoundException e) {\n+                throw new ResourceNotFoundException(e);\n+            } catch (MissingParameterException e) {\n+                throw new BadRequestException(e);\n+            }", "originalCommit": "35973b33dce6a5160d9152e669e18c56fdaf1867", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEzNzg1Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/309#discussion_r365137852", "bodyText": "Ignore this. This is fine", "author": "carohauta", "createdAt": "2020-01-10T09:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEzNzQ3Nw=="}], "type": "inlineReview"}]}