{"pr_number": 351, "pr_title": "XRDDEV-810 refresh OPENAPI3/REST Service Description", "pr_createdAt": "2020-02-04T20:26:01Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/351", "timeline": [{"oid": "c73ca40f95da7727cc7ebb66942d03cbc2015b2f", "url": "https://github.com/nordic-institute/X-Road/commit/c73ca40f95da7727cc7ebb66942d03cbc2015b2f", "message": "XRDDEV-810: Added implementation for refreshing REST and OPENAPI3 type of Service Description", "committedDate": "2020-01-31T08:46:51Z", "type": "commit"}, {"oid": "b125f248720fe4446b3b95f062dcb73c7bab2942", "url": "https://github.com/nordic-institute/X-Road/commit/b125f248720fe4446b3b95f062dcb73c7bab2942", "message": "XRDDEV-810: Add URL validation and updating refreshedDate-values on refreshing and adding ServiceDescriptions", "committedDate": "2020-01-31T09:50:07Z", "type": "commit"}, {"oid": "c26f76a16d1fc15f7c1cc8f2443730c6ed595b4e", "url": "https://github.com/nordic-institute/X-Road/commit/c26f76a16d1fc15f7c1cc8f2443730c6ed595b4e", "message": "Merge branch 'develop' into XRDDEV-810", "committedDate": "2020-02-03T09:57:50Z", "type": "commit"}, {"oid": "93bab99a5fa678aff1a7035f06291e07817d4386", "url": "https://github.com/nordic-institute/X-Road/commit/93bab99a5fa678aff1a7035f06291e07817d4386", "message": "XRDDEV-810: Add refresh functionality for REST and OPENAPI3 service descriptions", "committedDate": "2020-02-04T07:33:15Z", "type": "commit"}, {"oid": "0912543819e378a89cf165d7902b3b3acdd72dc5", "url": "https://github.com/nordic-institute/X-Road/commit/0912543819e378a89cf165d7902b3b3acdd72dc5", "message": "XRDDEV-810: Fix refresh-button spinners to work separately", "committedDate": "2020-02-04T12:41:54Z", "type": "commit"}, {"oid": "a2beb45f99fa7f8ed4725a92a6ae505d2ab3f322", "url": "https://github.com/nordic-institute/X-Road/commit/a2beb45f99fa7f8ed4725a92a6ae505d2ab3f322", "message": "XRDDEV-810: Fix failing test", "committedDate": "2020-02-04T20:12:06Z", "type": "commit"}, {"oid": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "url": "https://github.com/nordic-institute/X-Road/commit/01cdf6b663a524e2dd9f7190552c538c0f026fd3", "message": "XRDDEV-810: Fix style error", "committedDate": "2020-02-05T07:19:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxMDEzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375210138", "bodyText": "Would be nice to add comment about what the permission is or where it's used. Helps to keep track on these and in the end it's easier to see if we have some unused permissions.", "author": "Riippi", "createdAt": "2020-02-05T11:48:11Z", "path": "src/proxy-ui-api/frontend/src/global.ts", "diffHunk": "@@ -78,7 +78,9 @@ export enum Permissions {\n   IMPORT_INTERNAL_SSL_CERT = 'IMPORT_INTERNAL_SSL_CERT', // Security server TLS certificate\n   IMPORT_SIGN_CERT = 'IMPORT_SIGN_CERT',\n   INIT_CONFIG = 'INIT_CONFIG',\n-  REFRESH_WSDL = 'REFRESH_WSDL', // client > services > refresh WSDL\n+  REFRESH_WSDL = 'REFRESH_WSDL', // client > services > refresh\n+  REFRESH_REST = 'REFRESH_REST',", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY4MjQ4NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375682485", "bodyText": "Added comments", "author": "TJaakkola", "createdAt": "2020-02-06T07:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxMDEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwNjMyMg==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375206322", "bodyText": "Why is this permission not in old UI already? Was there some reason behind it, and what permission did old UI require for \"refresh rest\" operation?", "author": "jansu76", "createdAt": "2020-02-05T11:39:08Z", "path": "src/proxy-ui-api/src/main/resources/permissions.yml", "diffHunk": "@@ -33,6 +33,7 @@\n -       edit_openapi3_endpoint: [XROAD_SERVICE_ADMINISTRATOR]\n -       refresh_wsdl: [XROAD_SERVICE_ADMINISTRATOR]\n -       refresh_openapi3: [XROAD_SERVICE_ADMINISTRATOR]\n+        refresh_rest: [XROAD_SERVICE_ADMINISTRATOR]", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5ODU3NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375498575", "bodyText": "I think there was no detailed reasoning for not creating refresh_rest & refresh_openapi3 (actually there is refresh_openapi3 -permission but it is required in editing openapi3 in the old ui - yes, this is a bit confusing). Old ui requires refresh_wsdl for refreshing all 3 types of servicedescriptions.", "author": "TJaakkola", "createdAt": "2020-02-05T20:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwNjMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwNzc1NA==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375207754", "bodyText": "Should this already include the \"testability identifiers\"? At least definition of done already mentions it.\nhttps://confluence.niis.org/display/XRDDEV/Testability", "author": "jansu76", "createdAt": "2020-02-05T11:42:41Z", "path": "src/proxy-ui-api/frontend/src/views/Clients/Services/Services.vue", "diffHunk": "@@ -24,7 +24,7 @@\n         <v-btn\n           v-if=\"showAddButton\"\n           color=\"primary\"", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwNDY0NA==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375504644", "bodyText": "Ach good point. I completely forgot those...", "author": "TJaakkola", "createdAt": "2020-02-05T20:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwNzc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY4MjU1NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375682555", "bodyText": "data-test attributes added.", "author": "TJaakkola", "createdAt": "2020-02-06T07:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwNzc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxOTAzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375219031", "bodyText": "ServiceDescriptionException is not really a HTTP 404 resource not found. API URL defines what the resource is, in this case /service-descriptions/{id}/refresh, and that does exist. If the processing of this request fails then error is something else, like for example http 500 internal server error, http 409 conflict, or something else.\nI am not 100% sure if ServiceNotFoundException is correct exception class to be used in this case altogether. refreshRESTServiceDescription does not throw it even though it claims to. refreshOPENAPI3ServiceDescription throws it if we had for some reason a service description without any services. So it is more a problem with a service description, not a problem of not finding one specific service. It could have a different exception type, or just be a (DeviationAware)RuntimeException.\nOr keep it as a ServiceNotFoundException (which is not 100% accurate IMO) but at least map it to http 500 internal server error? Isn't that what it is, something weird has happened for it to be possible, and it is not anything that client request has caused, so it cannot be http 4xx?", "author": "jansu76", "createdAt": "2020-02-05T12:09:29Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ServiceDescriptionsApiController.java", "diffHunk": "@@ -191,12 +191,13 @@ public ServiceDescriptionsApiController(ServiceDescriptionService serviceDescrip\n                             ignoreWarnings.getIgnoreWarnings()));\n         } catch (WsdlParser.WsdlNotFoundException | UnhandledWarningsException\n                 | InvalidUrlException | InvalidWsdlException\n-                | ServiceDescriptionService.WrongServiceDescriptionTypeException e) {\n+                | ServiceDescriptionService.WrongServiceDescriptionTypeException\n+                | OpenApiParser.ParsingException e) {\n             throw new BadRequestException(e);\n         } catch (ServiceDescriptionService.ServiceAlreadyExistsException\n                 | ServiceDescriptionService.WsdlUrlAlreadyExistsException e) {\n             throw new ConflictException(e);\n-        } catch (ServiceDescriptionNotFoundException e) {\n+        } catch (ServiceNotFoundException | ServiceDescriptionNotFoundException e) {", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUzNjY0Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r377536646", "bodyText": "Pushed a commit changing the exception to DeviationAwareRuntimeException in a few places related to this.", "author": "TJaakkola", "createdAt": "2020-02-11T10:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxOTAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMDU3Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375220573", "bodyText": "Does not throw ServiceNotFoundException", "author": "jansu76", "createdAt": "2020-02-05T12:13:14Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -534,6 +581,71 @@ public ServiceDescriptionType refreshServiceDescription(Long id, boolean ignoreW\n         throw new NotImplementedException(\"REST ServiceDescription refresh not implemented yet\");\n     }\n \n+    /**\n+     * Refresh REST service description\n+     *\n+     * @param serviceDescriptionType\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not REST\n+     * @throws ServiceNotFoundException             if there is no service linked to service description\n+     * @throws InvalidUrlException                  if url is invalid\n+     */\n+    private ServiceDescriptionType refreshRESTServiceDescription(ServiceDescriptionType serviceDescriptionType)\n+            throws WrongServiceDescriptionTypeException, ServiceNotFoundException, InvalidUrlException {", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU1NTIwNg==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r377555206", "bodyText": "Fixed.", "author": "TJaakkola", "createdAt": "2020-02-11T10:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMDU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMDgwMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375220801", "bodyText": "Why does this method / functionality actually exist? Doesn't it only update refreshedDate?", "author": "jansu76", "createdAt": "2020-02-05T12:13:50Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -534,6 +581,71 @@ public ServiceDescriptionType refreshServiceDescription(Long id, boolean ignoreW\n         throw new NotImplementedException(\"REST ServiceDescription refresh not implemented yet\");\n     }\n \n+    /**\n+     * Refresh REST service description\n+     *\n+     * @param serviceDescriptionType\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not REST\n+     * @throws ServiceNotFoundException             if there is no service linked to service description\n+     * @throws InvalidUrlException                  if url is invalid\n+     */\n+    private ServiceDescriptionType refreshRESTServiceDescription(ServiceDescriptionType serviceDescriptionType)", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwMzI4Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375503286", "bodyText": "It checks the url syntax (which shouldn't be incorrect on refresh) but this is what I though too, but this was clearly stated in the task description.\n'when REST API URL type is \"REST API base path\" => \"REST\":\nvalidating that the URL is syntactically correct'\nMaybe this whole refresh-feature for REST -type of service descriptions should discussed.", "author": "TJaakkola", "createdAt": "2020-02-05T20:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMDgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MjgxMg==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r377562812", "bodyText": "Also this is what old ui does.", "author": "TJaakkola", "createdAt": "2020-02-11T10:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMDgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMjQwMw==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375222403", "bodyText": "This handles warnings pretty differently from what refreshWSDLServiceDescription does. WSDL side gives warnings if new services were added or removed, this does not do it AFAIK?\n\nI think this is how old UI works too, right? Old UI does not warn about adding / removing openapi services either?\nis this by design or accidental?", "author": "jansu76", "createdAt": "2020-02-05T12:17:48Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -534,6 +581,71 @@ public ServiceDescriptionType refreshServiceDescription(Long id, boolean ignoreW\n         throw new NotImplementedException(\"REST ServiceDescription refresh not implemented yet\");\n     }\n \n+    /**\n+     * Refresh REST service description\n+     *\n+     * @param serviceDescriptionType\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not REST\n+     * @throws ServiceNotFoundException             if there is no service linked to service description\n+     * @throws InvalidUrlException                  if url is invalid\n+     */\n+    private ServiceDescriptionType refreshRESTServiceDescription(ServiceDescriptionType serviceDescriptionType)\n+            throws WrongServiceDescriptionTypeException, ServiceNotFoundException, InvalidUrlException {\n+        verifyAuthority(\"REFRESH_REST\");\n+\n+        if (!serviceDescriptionType.getType().equals(DescriptionType.REST)) {\n+            throw new WrongServiceDescriptionTypeException(\"Expected description type REST\");\n+        }\n+\n+        validateUrl(serviceDescriptionType.getUrl());\n+\n+        serviceDescriptionType.setRefreshedDate(new Date());\n+\n+        return serviceDescriptionType;\n+    }\n+\n+    /**\n+     * Refresh OPENAPI3 ServiceDescription\n+     *\n+     * @param serviceDescriptionType\n+     * @param ignoreWarnings\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not openapi3\n+     * @throws ServiceNotFoundException             if there is no service linked to given service description\n+     * @throws UnhandledWarningsException           if unhandled warnings are found and ignoreWarnings if false\n+     * @throws OpenApiParser.ParsingException       if parsing openapi3 description fails\n+     * @throws InvalidUrlException                  if url is invalid\n+     */\n+    private ServiceDescriptionType refreshOPENAPI3ServiceDescription(ServiceDescriptionType serviceDescriptionType,\n+            boolean ignoreWarnings) throws WrongServiceDescriptionTypeException, ServiceNotFoundException,\n+            UnhandledWarningsException, OpenApiParser.ParsingException, InvalidUrlException {\n+\n+        verifyAuthority(\"REFRESH_OPENAPI3\");\n+\n+        if (!serviceDescriptionType.getType().equals(DescriptionType.OPENAPI3)) {\n+            throw new WrongServiceDescriptionTypeException(\"Expected description type OPENAPI3\");\n+        }\n+\n+        if (serviceDescriptionType.getService().get(0) == null) {\n+            throw new ServiceNotFoundException(\"Service not found from servicedescription with id \"\n+                    + serviceDescriptionType.getId());\n+        }\n+\n+        validateUrl(serviceDescriptionType.getUrl());\n+\n+        serviceDescriptionType.setRefreshedDate(new Date());\n+\n+        parseOpenapi3ToServiceDescription(serviceDescriptionType.getUrl(),\n+                serviceDescriptionType.getService().get(0).getServiceCode(),\n+                ignoreWarnings,\n+                serviceDescriptionType);\n+\n+        clientRepository.saveOrUpdateAndFlush(serviceDescriptionType.getClient());\n+\n+        return serviceDescriptionType;", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwMDczOA==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r377600738", "bodyText": "Yes, old UI doesn't tell if endpoints are changed (refresh doesn't have effect on services).", "author": "TJaakkola", "createdAt": "2020-02-11T12:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMjQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIyNTk1Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r378225953", "bodyText": "Warnings will be implemented in a separate ticket https://jira.niis.org/browse/XRDDEV-918", "author": "jansu76", "createdAt": "2020-02-12T12:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyMjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyNTQwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375225407", "bodyText": "services.rb does these checks\n      check_duplicate_url(item)\n      check_duplicate_service_codes(item)\n\nrefreshWSDLServiceDescription throws WsdlUrlAlreadyExistsException and ServiceAlreadyExistsException if this kind of checks fail. Are these missing from refreshOPENAPI3ServiceDescription?", "author": "jansu76", "createdAt": "2020-02-05T12:25:02Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -534,6 +581,71 @@ public ServiceDescriptionType refreshServiceDescription(Long id, boolean ignoreW\n         throw new NotImplementedException(\"REST ServiceDescription refresh not implemented yet\");\n     }\n \n+    /**\n+     * Refresh REST service description\n+     *\n+     * @param serviceDescriptionType\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not REST\n+     * @throws ServiceNotFoundException             if there is no service linked to service description\n+     * @throws InvalidUrlException                  if url is invalid\n+     */\n+    private ServiceDescriptionType refreshRESTServiceDescription(ServiceDescriptionType serviceDescriptionType)\n+            throws WrongServiceDescriptionTypeException, ServiceNotFoundException, InvalidUrlException {\n+        verifyAuthority(\"REFRESH_REST\");\n+\n+        if (!serviceDescriptionType.getType().equals(DescriptionType.REST)) {\n+            throw new WrongServiceDescriptionTypeException(\"Expected description type REST\");\n+        }\n+\n+        validateUrl(serviceDescriptionType.getUrl());\n+\n+        serviceDescriptionType.setRefreshedDate(new Date());\n+\n+        return serviceDescriptionType;\n+    }\n+\n+    /**\n+     * Refresh OPENAPI3 ServiceDescription\n+     *\n+     * @param serviceDescriptionType\n+     * @param ignoreWarnings\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not openapi3\n+     * @throws ServiceNotFoundException             if there is no service linked to given service description\n+     * @throws UnhandledWarningsException           if unhandled warnings are found and ignoreWarnings if false\n+     * @throws OpenApiParser.ParsingException       if parsing openapi3 description fails\n+     * @throws InvalidUrlException                  if url is invalid", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU5MTM4Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r377591383", "bodyText": "I think these checks are unnecessary for refreshOPENAPI3ServiceDescription as Service Description of type OPENAPI3 always contains just one service (servicecode and url) which won't change on refresh.", "author": "TJaakkola", "createdAt": "2020-02-11T11:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyNTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyNzExMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375227111", "bodyText": "refreshOPENAPI3ServiceDescription differs from convention used elsewhere, should probably be refreshOpenApi3ServiceDescription? There is also variant parseOpenapi3ToServiceDescription in use in several places.", "author": "jansu76", "createdAt": "2020-02-05T12:29:23Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -534,6 +581,71 @@ public ServiceDescriptionType refreshServiceDescription(Long id, boolean ignoreW\n         throw new NotImplementedException(\"REST ServiceDescription refresh not implemented yet\");\n     }\n \n+    /**\n+     * Refresh REST service description\n+     *\n+     * @param serviceDescriptionType\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not REST\n+     * @throws ServiceNotFoundException             if there is no service linked to service description\n+     * @throws InvalidUrlException                  if url is invalid\n+     */\n+    private ServiceDescriptionType refreshRESTServiceDescription(ServiceDescriptionType serviceDescriptionType)\n+            throws WrongServiceDescriptionTypeException, ServiceNotFoundException, InvalidUrlException {\n+        verifyAuthority(\"REFRESH_REST\");\n+\n+        if (!serviceDescriptionType.getType().equals(DescriptionType.REST)) {\n+            throw new WrongServiceDescriptionTypeException(\"Expected description type REST\");\n+        }\n+\n+        validateUrl(serviceDescriptionType.getUrl());\n+\n+        serviceDescriptionType.setRefreshedDate(new Date());\n+\n+        return serviceDescriptionType;\n+    }\n+\n+    /**\n+     * Refresh OPENAPI3 ServiceDescription\n+     *\n+     * @param serviceDescriptionType\n+     * @param ignoreWarnings\n+     * @return {@link ServiceDescriptionType}\n+     * @throws WrongServiceDescriptionTypeException if service type is not openapi3\n+     * @throws ServiceNotFoundException             if there is no service linked to given service description\n+     * @throws UnhandledWarningsException           if unhandled warnings are found and ignoreWarnings if false\n+     * @throws OpenApiParser.ParsingException       if parsing openapi3 description fails\n+     * @throws InvalidUrlException                  if url is invalid\n+     */\n+    private ServiceDescriptionType refreshOPENAPI3ServiceDescription(ServiceDescriptionType serviceDescriptionType,", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUzNDU4OQ==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r377534589", "bodyText": "Added fixes to align convention", "author": "TJaakkola", "createdAt": "2020-02-11T09:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyNzExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIyOTQ3NA==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r378229474", "bodyText": "There seems to be one more still: ServiceDescriptionService.addOpenapi3ServiceDescription\nThen some in tests, but those are not so important.", "author": "jansu76", "createdAt": "2020-02-12T12:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIyNzExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMzE1Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375233157", "bodyText": "I kind of get the feeling that more tests for refreshOpenApi3Description could be good (here and in ServiceDescriptionServiceIntegrationTest)? Now ServiceDescriptionsApiControllerIntegrationTest tests only WSDL related operations?\nMaybe \"ignore warnings\" feature would be good to test in ServiceDescriptionServiceIntegrationTest? Especially if we would add \"add/remove services\" warnings.", "author": "jansu76", "createdAt": "2020-02-05T12:43:28Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/ServiceDescriptionsApiControllerIntegrationTest.java", "diffHunk": "@@ -39,7 +39,7 @@\n import org.niis.xroad.restapi.openapi.model.ServiceDescriptionDisabledNotice;", "originalCommit": "01cdf6b663a524e2dd9f7190552c538c0f026fd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwMTQ2Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r375501462", "bodyText": "Yeah, I guess I could write some more tests. The reason for writing just one test for making sure refreshing works correctly is that these test would be near to identical to those for testing updating service description. Update is tested more carefully and I felt writing the same tests twice wouldn't be necessary. But it's true the implementations aren't identical and I'll write some tests.", "author": "TJaakkola", "createdAt": "2020-02-05T20:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMzE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE5NTQzMg==", "url": "https://github.com/nordic-institute/X-Road/pull/351#discussion_r378195432", "bodyText": "Added a couple of tests.", "author": "TJaakkola", "createdAt": "2020-02-12T11:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMzE1Nw=="}], "type": "inlineReview"}, {"oid": "05f0eea59e2e242fb8bdb59e6c1f9594f9fb035a", "url": "https://github.com/nordic-institute/X-Road/commit/05f0eea59e2e242fb8bdb59e6c1f9594f9fb035a", "message": "XRDDEV-810: Fix sonarqube error", "committedDate": "2020-02-05T20:26:59Z", "type": "commit"}, {"oid": "2a3947b5aa9a0ba919daeab15a4a5e9143ac78fa", "url": "https://github.com/nordic-institute/X-Road/commit/2a3947b5aa9a0ba919daeab15a4a5e9143ac78fa", "message": "XRDDEV-810: Add comment to permission changes and data-test attributes to html markup", "committedDate": "2020-02-06T07:52:07Z", "type": "commit"}, {"oid": "2cbfb063a588ec70f628add8bdb5a521a7dfbf31", "url": "https://github.com/nordic-institute/X-Road/commit/2cbfb063a588ec70f628add8bdb5a521a7dfbf31", "message": "XRDDEV-810: Use DeviationAwareRuntimeException instead of checked ServiceException", "committedDate": "2020-02-11T09:26:32Z", "type": "commit"}, {"oid": "1c19a830581dc27e9522c3a77a52a8ac96247d2b", "url": "https://github.com/nordic-institute/X-Road/commit/1c19a830581dc27e9522c3a77a52a8ac96247d2b", "message": "XRDDEV-810: Align naming convention", "committedDate": "2020-02-11T09:57:02Z", "type": "commit"}, {"oid": "e04f9dd52489069cbbc03806ec25e1297b61424b", "url": "https://github.com/nordic-institute/X-Road/commit/e04f9dd52489069cbbc03806ec25e1297b61424b", "message": "XRDDEV-810: Add tests to refresh Service Description functionality", "committedDate": "2020-02-11T14:18:20Z", "type": "commit"}, {"oid": "47fc36b08c8dad8f3c2e382acbbfcd52802c3027", "url": "https://github.com/nordic-institute/X-Road/commit/47fc36b08c8dad8f3c2e382acbbfcd52802c3027", "message": "Merge branch 'develop' into XRDDEV-810", "committedDate": "2020-02-12T06:35:42Z", "type": "commit"}, {"oid": "4662522cd817980611eee6431cffe6f6e21bd4ea", "url": "https://github.com/nordic-institute/X-Road/commit/4662522cd817980611eee6431cffe6f6e21bd4ea", "message": "XRDDEV-810: Fix method naming conventions", "committedDate": "2020-02-13T08:55:36Z", "type": "commit"}, {"oid": "338972c10093c69ef6b366a53ad4dde75af3904d", "url": "https://github.com/nordic-institute/X-Road/commit/338972c10093c69ef6b366a53ad4dde75af3904d", "message": "Merge branch 'XRDDEV-810' of github.com:nordic-institute/X-Road into XRDDEV-810", "committedDate": "2020-02-13T08:57:15Z", "type": "commit"}, {"oid": "1eb51f2d5fb51488c26c51863b9876656f5fe388", "url": "https://github.com/nordic-institute/X-Road/commit/1eb51f2d5fb51488c26c51863b9876656f5fe388", "message": "Merge branch 'develop' into XRDDEV-810", "committedDate": "2020-02-14T09:21:47Z", "type": "commit"}]}