{"pr_number": 472, "pr_title": "XRDDEV-17 certificate validate", "pr_createdAt": "2020-04-22T12:50:12Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/472", "timeline": [{"oid": "538fba270af88ee5400207ee36fbe242b5773909", "url": "https://github.com/nordic-institute/X-Road/commit/538fba270af88ee5400207ee36fbe242b5773909", "message": "XRDDEV-17 validate cert", "committedDate": "2020-04-22T12:21:05Z", "type": "commit"}, {"oid": "be9f7a97a340d3d1bfd41083083ce86c4c65a4f4", "url": "https://github.com/nordic-institute/X-Road/commit/be9f7a97a340d3d1bfd41083083ce86c4c65a4f4", "message": "validation of cert", "committedDate": "2020-04-22T12:43:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNDk0Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414324946", "bodyText": "Since the original isCerts.contains(auth.getCert()) already verifies that the cert is one of the IS certs, iterating the list is unnecessary. One could after that test safely check the validity of the received certificate (auth.getCert().checkValidity()).\nI'd also argue that it would be more readable (and perhaps a bit more efficient) than using a stream.", "author": "jhyoty", "createdAt": "2020-04-24T06:23:50Z", "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -90,10 +93,18 @@ public static void verifyClientAuthentication(ClientId client,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n \n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);\n+            X509Certificate isCert = isCerts.stream()\n+                    .filter(c -> Objects.equals(c, auth.getCert()))\n+                    .findFirst()\n+                    .orElseThrow(() -> new CodedException(X_SSL_AUTH_FAILED,\n+                    \"Client (%s) TLS certificate does not match any\"\n+                                    + \" IS certificates\", client));\n+            try {\n+                isCert.checkValidity();", "originalCommit": "be9f7a97a340d3d1bfd41083083ce86c4c65a4f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyOTQzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414429438", "bodyText": "Done", "author": "martensoo", "createdAt": "2020-04-24T09:24:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNDk0Ng=="}], "type": "inlineReview"}, {"oid": "101740ce8655ec75b8932dab9d55fe5b3f78f337", "url": "https://github.com/nordic-institute/X-Road/commit/101740ce8655ec75b8932dab9d55fe5b3f78f337", "message": "XRDDEV-17 refactor", "committedDate": "2020-04-24T08:51:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MjExNw==", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414472117", "bodyText": "The \"does the cert exist\" check is missing.", "author": "jhyoty", "createdAt": "2020-04-24T10:33:08Z", "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -89,11 +92,13 @@ public static void verifyClientAuthentication(ClientId client,\n                 throw new CodedException(X_SSL_AUTH_FAILED,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n-\n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);", "originalCommit": "101740ce8655ec75b8932dab9d55fe5b3f78f337", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODM1NA==", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414748354", "bodyText": "Should be back now", "author": "martensoo", "createdAt": "2020-04-24T17:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MjExNw=="}], "type": "inlineReview"}, {"oid": "6214e12c3f2e04bc48aaf8b77700e198516e1ac5", "url": "https://github.com/nordic-institute/X-Road/commit/6214e12c3f2e04bc48aaf8b77700e198516e1ac5", "message": "add missing check", "committedDate": "2020-04-24T10:51:08Z", "type": "commit"}, {"oid": "0727759577db1d7144afd9f6136d16b3de395d09", "url": "https://github.com/nordic-institute/X-Road/commit/0727759577db1d7144afd9f6136d16b3de395d09", "message": "cleanup", "committedDate": "2020-04-24T12:48:59Z", "type": "commit"}, {"oid": "6e6e50878953e132108c16e6cbfb1952cb062318", "url": "https://github.com/nordic-institute/X-Road/commit/6e6e50878953e132108c16e6cbfb1952cb062318", "message": "Checkstyle modifications", "committedDate": "2020-04-24T14:44:23Z", "type": "commit"}, {"oid": "0c80acd17c220d2812350473bafccdabd9fea912", "url": "https://github.com/nordic-institute/X-Road/commit/0c80acd17c220d2812350473bafccdabd9fea912", "message": "XRDDEV-17: Add integration tests", "committedDate": "2020-04-27T04:54:47Z", "type": "commit"}, {"oid": "f1ba909fb99a47e104f3aca6c58aedb03919d035", "url": "https://github.com/nordic-institute/X-Road/commit/f1ba909fb99a47e104f3aca6c58aedb03919d035", "message": "* XRDDEV-17: Add integration test for the expired cert", "committedDate": "2020-04-29T10:40:58Z", "type": "commit"}, {"oid": "9fcf8511ecba0b781d57fc66c6eb077d2f27bd34", "url": "https://github.com/nordic-institute/X-Road/commit/9fcf8511ecba0b781d57fc66c6eb077d2f27bd34", "message": "XRDDEV-17: Make certificate validity errors configurable", "committedDate": "2020-04-29T20:25:00Z", "type": "commit"}, {"oid": "cffca1fcd9ef42e6874a2360d960245df073c193", "url": "https://github.com/nordic-institute/X-Road/commit/cffca1fcd9ef42e6874a2360d960245df073c193", "message": "XRDDEV-17: expired certificate check depends on the configuration parameter", "committedDate": "2020-04-30T05:11:53Z", "type": "commit"}, {"oid": "a04af6fad603a1a291d8006e4cac1411b29464b0", "url": "https://github.com/nordic-institute/X-Road/commit/a04af6fad603a1a291d8006e4cac1411b29464b0", "message": "Documenting the field", "committedDate": "2020-04-30T05:59:14Z", "type": "commit"}, {"oid": "731d1330bc776fede1cfcf9282ca22d71b83d104", "url": "https://github.com/nordic-institute/X-Road/commit/731d1330bc776fede1cfcf9282ca22d71b83d104", "message": "Merge branch 'develop' into XRDDEV-17-certificate-validate", "committedDate": "2020-05-04T08:02:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzODIwMA==", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r419338200", "bodyText": "Perhaps the parameter name should be ~ enforce-client-is-certificate-validity-period because there are also other certificates this setting does not control. The explanation could also be a bit more abstract, something like whether to reject a request when client information system certificate is expired or not yet valid; throwing and exception is an implementation detail.", "author": "jhyoty", "createdAt": "2020-05-04T10:18:34Z", "path": "doc/Manuals/ug-syspar_x-road_v6_system_parameters.md", "diffHunk": "@@ -262,7 +263,7 @@ This chapter describes the system parameters used by the components of the X-Roa\n | server-conf-client-cache-size                    | 100                                        |   |   | Maximum number of local clients to keep cached |\n | server-conf-service-cache-size                   | 1000                                       |   |   | Maximum number of services to keep cached |\n | server-conf-acl-cache-size                       | 100000                                     |   |   | Maximum number of access rights to keep cached in memory. |\n-\n+| enforce-certificate-validity-period-check        | false                                      |   |   | Whether to throw an exception about expired or not yet valid certificates. |", "originalCommit": "731d1330bc776fede1cfcf9282ca22d71b83d104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg3NjkyNw==", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r419876927", "bodyText": "Changed the name", "author": "martensoo", "createdAt": "2020-05-05T05:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzODIwMA=="}], "type": "inlineReview"}, {"oid": "239517ef270eca7c68b95925cc822bf3ed967a61", "url": "https://github.com/nordic-institute/X-Road/commit/239517ef270eca7c68b95925cc822bf3ed967a61", "message": "XRDDEV-17 Change parameter name", "committedDate": "2020-05-04T16:14:46Z", "type": "commit"}, {"oid": "6e9e5b5a0377a59111eba4e9196f4da2170a974f", "url": "https://github.com/nordic-institute/X-Road/commit/6e9e5b5a0377a59111eba4e9196f4da2170a974f", "message": "Merge branch 'develop' into XRDDEV-17-certificate-validate", "committedDate": "2020-05-04T20:18:49Z", "type": "commit"}, {"oid": "f70e0d33432da00984f114ea60c87a3960721fed", "url": "https://github.com/nordic-institute/X-Road/commit/f70e0d33432da00984f114ea60c87a3960721fed", "message": "XRDDEV-17 Improve the code", "committedDate": "2020-05-05T05:49:14Z", "type": "commit"}]}