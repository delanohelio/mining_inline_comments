{"pr_number": 404, "pr_title": "XRDDEV-900 API for uploading backup files", "pr_createdAt": "2020-03-05T10:47:26Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/404", "timeline": [{"oid": "d2a29599e847b6c5b2de2f17a7768ef22454b657", "url": "https://github.com/nordic-institute/X-Road/commit/d2a29599e847b6c5b2de2f17a7768ef22454b657", "message": "XRDDEV-900 API for uploading backup files\n\n- Implement API for uploading backup files.\n- Update API design.\n- Add unit tests.", "committedDate": "2020-03-05T10:46:09Z", "type": "commit"}, {"oid": "3b732ced32cf4b153d55b54e990bb5ed70cf7555", "url": "https://github.com/nordic-institute/X-Road/commit/3b732ced32cf4b153d55b54e990bb5ed70cf7555", "message": "XRDDEV-900 Updates based on SonarQube findings", "committedDate": "2020-03-05T11:47:04Z", "type": "commit"}, {"oid": "b495cb73ed75a03068b41f62dcd77a156513e6d2", "url": "https://github.com/nordic-institute/X-Road/commit/b495cb73ed75a03068b41f62dcd77a156513e6d2", "message": "XRDDEV-900 Updates based on SonarQube findings", "committedDate": "2020-03-05T13:02:32Z", "type": "commit"}, {"oid": "01301c0391dff8ee074f49dcb4e2644af08702c1", "url": "https://github.com/nordic-institute/X-Road/commit/01301c0391dff8ee074f49dcb4e2644af08702c1", "message": "XRDDEV-900 Update error handling when backup file already exists\n\n- Refactor implementation to use existing warnings mechanism.\n- Update unit tests.", "committedDate": "2020-03-07T06:42:54Z", "type": "commit"}, {"oid": "d8df001249c7e51d2e090cfcf6f8990ebdfba994", "url": "https://github.com/nordic-institute/X-Road/commit/d8df001249c7e51d2e090cfcf6f8990ebdfba994", "message": "Merge branch 'develop' into XRDDEV-900", "committedDate": "2020-03-12T03:29:22Z", "type": "commit"}, {"oid": "ad516931b117411202ee569441477df7dce6ed4b", "url": "https://github.com/nordic-institute/X-Road/commit/ad516931b117411202ee569441477df7dce6ed4b", "message": "Merge branch 'develop' into XRDDEV-900", "committedDate": "2020-03-13T05:38:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI1NDQwNA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396254404", "bodyText": "InvalidFilenameException and InvalidBackupFileException seem to have their metadata fields populated in the service layer (here and here) but they are overridden in the controller method by setting a new ErrorDeviation without metadata. The ErrorDeviation (errorCode) will actually already be set to the response without passing it to the BadRequestException separately. Meaning that all of these catch clauses could be collapsed into a single block:\n} catch (InvalidFilenameException | UnhandledWarningsException | InvalidBackupFileException e) {\n    throw new BadRequestException(e);\n}\nThe metadata shown to the end user in this case is a string \"uploading backup file failed because of invalid filename (\"+ filename + \")\". Is this metadata supposed to be shown to the end user or is it only meant for logging purposes? If it is only meant for logging purposes then this constructor should be changed to\nsuper(msg, new ErrorDeviation(ERROR_INVALID_FILENAME));\nand same for the InvalidBackupFileException constructor also", "author": "carohauta", "createdAt": "2020-03-23T07:33:26Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/BackupsApiController.java", "diffHunk": "@@ -103,4 +108,19 @@ public BackupsApiController(BackupService backupService, BackupConverter backupC\n             throw new InternalServerErrorException(new ErrorDeviation(GENERATE_BACKUP_INTERRUPTED));\n         }\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('BACKUP_CONFIGURATION')\")\n+    public ResponseEntity<Backup> uploadBackup(Boolean ignoreWarnings, MultipartFile file) {\n+        try {\n+            BackupFile backupFile = backupService.uploadBackup(ignoreWarnings, file);\n+            return new ResponseEntity<>(backupConverter.convert(backupFile), HttpStatus.CREATED);\n+        } catch (InvalidFilenameException e) {\n+            throw new BadRequestException(e, new ErrorDeviation(ERROR_INVALID_FILENAME));\n+        } catch (UnhandledWarningsException e) {\n+            throw new BadRequestException(e);\n+        } catch (InvalidBackupFileException e) {\n+            throw new BadRequestException(e, new ErrorDeviation(ERROR_INVALID_BACKUP_FILE));", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MTYzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396581638", "bodyText": "The metadata is meant for logging purposes only. Updated the exceptions according to the suggestions.", "author": "petkivim", "createdAt": "2020-03-23T16:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI1NDQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396265531", "bodyText": "I'm not sure if this sort of validation should actually exist in the repository layer which should be all about transactions and CRUD operations (also documented here). The isFilenameValid method would probably be a better fit in an already existing utility class such as FormatUtils or in the BackupService class.", "author": "carohauta", "createdAt": "2020-03-23T08:01:08Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java", "diffHunk": "@@ -51,7 +51,7 @@\n \n     private static final String CONFIGURATION_BACKUP_PATH = SystemProperties.getConfBackupPath();\n     // Criteria for valid backup file names:\n-    // 1) cannot start with \".\", 2) must contain one or more word characters ([a-zA-Z_0-9]), 3) must end with \".tar\"\n+    // 1) cannot start with \".\", 2) must contain one or more word characters ([a-zA-Z_0-9.-]), 3) must end with \".tar\"\n     private static final String BACKUP_FILENAME_PATTERN = \"^(?!\\\\.)[\\\\w\\\\.\\\\-]+\\\\.tar$\";", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4NjAxNw==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396586017", "bodyText": "I would leave the validation in the repository layer for security reasons. In case the repository layer is accessed from multiple classes, each class must implement its own validation. When the validation is implemented on the repository layer, the validation is always guaranteed and it's done using the same rules. Since the filename comes from the client, it's extremely important that it's validated properly before it's used.", "author": "petkivim", "createdAt": "2020-03-23T16:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkyNzUzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396927531", "bodyText": "Happened to see this in the github stream and got curious, so had a look. My two cents:\n\nvalidation should in general follow the layer design @carohauta linked - one reason is, that we should follow principle of least astonishment and not confuse maintainers.\nif there is a special case, where we are concerned of security, and are afraid that someone will add a service method that forgets the validation, I think that is a valid reason to have the validation also on repository layer. But I think it should not be missing from service layer. I was happy to see it is not!\nOf course, if we are scared of someone adding a new service method and forgetting validation, we should be scared of someone adding a new repository method and forgetting validation, too. Putting the validation on repository layer is not bulletproof (but maybe it is safer than service layer since repository layer has less modifications typically)\nI like @carohauta 's suggestion of putting the validation logic into somewhere else than the repository. I would still keep both validation checks (service and repository), just move the actual logic elsewhere. It would make the repository class a bit more consistent with other repository classes in what kind of logic it contains.\nrepository level validation (if there is any, we should try to keep it limited) should be considered as a safety net like a database constraint is. Failing validation should be comparable to a programming error and can just throw some dirty RuntimeException, result in http 500, not care about nice error messages etc.", "author": "jansu76", "createdAt": "2020-03-24T06:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTYwOQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396959609", "bodyText": "Based on the comments, the validation logic is now moved to FormatUtils class, and both BackupRepository and BackupService use it from there. In addition, filename validation was added to all the methods in the repository class that read, create or delete backup files.", "author": "petkivim", "createdAt": "2020-03-24T07:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5ODQ1OA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396298458", "bodyText": "This method could take String fileName and byte[] fileBytes as parameters instead of a MultipartFile. I think that would create better separation between the controller and service layer and make this method more universal. What do you think?", "author": "carohauta", "createdAt": "2020-03-23T09:03:42Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java", "diffHunk": "@@ -147,6 +155,44 @@ public BackupFile generateBackup() throws InterruptedException {\n         return backupFile.get();\n     }\n \n+    /**\n+     * Write uploaded backup file to disk. If ignoreWarnings=false, an exception is thrown when a file with\n+     * the same name already exists. If ignoreWarnings=true, the existing file is overwritten.\n+     * @param ignoreWarnings\n+     * @param file\n+     * @return\n+     * @throws InvalidFilenameException if backup file's name is invalid and does not pass validation\n+     * @throws UnhandledWarningsException if backup file with the same name already exists\n+     * and ignoreWarnings is false\n+     * @throws InvalidBackupFileException if backup file is not a valid tar file or the first entry of the tar file\n+     * does not match to the first entry if the Security Server generated backup tar files\n+     */\n+    public BackupFile uploadBackup(Boolean ignoreWarnings, MultipartFile file)", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MjUxNw==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396582517", "bodyText": "Passing String fileName and byte[] fileBytes as parameters instead of MultipartFile is a good idea. Updated the implementation.", "author": "petkivim", "createdAt": "2020-03-23T16:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5ODQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwMTc4NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396301785", "bodyText": "Could also assert the warning here", "author": "carohauta", "createdAt": "2020-03-23T09:09:48Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/BackupServiceTest.java", "diffHunk": "@@ -180,4 +190,84 @@ public void addBackupFails() throws ProcessNotExecutableException, ProcessFailed\n             // success\n         }\n     }\n+\n+    @Test\n+    public void uploadBackup() throws UnhandledWarningsException, InvalidBackupFileException, IOException,\n+            InvalidFilenameException {\n+        MultipartFile multipartFile = createMultipartFileWithTar(BACKUP_FILE_1_NAME, VALID_TAR_LABEL);\n+\n+        when(backupRepository.isFilenameValid(BACKUP_FILE_1_NAME)).thenReturn(true);\n+        when(backupRepository.fileExists(BACKUP_FILE_1_NAME)).thenReturn(false);\n+        when(backupRepository.writeBackupFile(BACKUP_FILE_1_NAME, multipartFile.getBytes())).thenReturn(\n+                new Date(BACKUP_FILE_1_CREATED_AT_MILLIS).toInstant().atOffset(ZoneOffset.UTC));\n+\n+        BackupFile backupFile = backupService.uploadBackup(true, multipartFile);\n+\n+        assertEquals(BACKUP_FILE_1_NAME, backupFile.getFilename());\n+        assertEquals(BACKUP_FILE_1_CREATED_AT, backupFile.getCreatedAt().toString());\n+    }\n+\n+    @Test\n+    public void uploadBackupInvalidTarLabel() throws UnhandledWarningsException, IOException,\n+            InvalidFilenameException {\n+        MultipartFile multipartFile = createMultipartFileWithTar(BACKUP_FILE_1_NAME, \"invalid_label\");\n+\n+        when(backupRepository.isFilenameValid(BACKUP_FILE_1_NAME)).thenReturn(true);\n+        when(backupRepository.fileExists(BACKUP_FILE_1_NAME)).thenReturn(false);\n+\n+        try {\n+            backupService.uploadBackup(true, multipartFile);\n+            fail(\"should throw InvalidBackupFileException\");\n+        } catch (InvalidBackupFileException expected) {\n+            // success\n+        }\n+    }\n+\n+    @Test\n+    public void uploadBackupWithInvalidFilename() throws UnhandledWarningsException, InvalidBackupFileException {\n+        try {\n+            backupService.uploadBackup(true, mockMultipartFile);\n+            fail(\"should throw InvalidFilenameException\");\n+        } catch (InvalidFilenameException expected) {\n+            // success\n+        }\n+    }\n+\n+    @Test\n+    public void uploadBackupFileAlreadyExistsNoOverwrite() throws InvalidFilenameException,\n+            InvalidBackupFileException {\n+        when(backupRepository.isFilenameValid(any(String.class))).thenReturn(true);\n+        when(backupRepository.fileExists(any(String.class))).thenReturn(true);\n+        try {\n+            backupService.uploadBackup(false, mockMultipartFile);\n+            fail(\"should throw UnhandledWarningsException\");\n+        } catch (UnhandledWarningsException expected) {\n+            // success", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MjgwNQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396582805", "bodyText": "Fixed.", "author": "petkivim", "createdAt": "2020-03-23T16:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwMTc4NQ=="}], "type": "inlineReview"}, {"oid": "9080061c793c99bb3372d6eaea237f2300a9a32c", "url": "https://github.com/nordic-institute/X-Road/commit/9080061c793c99bb3372d6eaea237f2300a9a32c", "message": "XRDDEV-900 Minor changes based on review comments", "committedDate": "2020-03-23T15:51:22Z", "type": "commit"}, {"oid": "3d637b707b5790111a490508b8f33d16e805953a", "url": "https://github.com/nordic-institute/X-Road/commit/3d637b707b5790111a490508b8f33d16e805953a", "message": "Merge branch 'develop' into XRDDEV-900", "committedDate": "2020-03-23T16:23:13Z", "type": "commit"}, {"oid": "9c8f0dc17338e50e1c52e289a80fbf26f002f9e6", "url": "https://github.com/nordic-institute/X-Road/commit/9c8f0dc17338e50e1c52e289a80fbf26f002f9e6", "message": "XRDDEV-900 Refactor backup filename validation\n\n- Move filename validation logic from repository class to utils class.\n- Add filename validation to all repository methods that read, create or delete backup files.", "committedDate": "2020-03-24T07:55:42Z", "type": "commit"}, {"oid": "d64827bc42009a906ffdea588cb02bff31eed9e5", "url": "https://github.com/nordic-institute/X-Road/commit/d64827bc42009a906ffdea588cb02bff31eed9e5", "message": "XRDDEV-900 Remove unused lines from unit tests", "committedDate": "2020-03-24T08:11:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwODE1Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r397008152", "bodyText": "SonarQube requires \"invalid backup filename\" to be in a constant because it occurs at least 3 times in this class.", "author": "carohauta", "createdAt": "2020-03-24T09:24:37Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java", "diffHunk": "@@ -90,6 +87,9 @@ public OffsetDateTime getCreatedAt(String filename) {\n      * @param filename\n      */\n     public void deleteBackupFile(String filename) {\n+        if (!FormatUtils.isValidBackupFilename(filename)) {\n+            throw new RuntimeException(\"invalid backup filename\");", "originalCommit": "d64827bc42009a906ffdea588cb02bff31eed9e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAxMjY2MA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r397012660", "bodyText": "Fixed", "author": "petkivim", "createdAt": "2020-03-24T09:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwODE1Mg=="}], "type": "inlineReview"}, {"oid": "2e7b3a9a7464b48075739c04312c9f3c5eb3b4f4", "url": "https://github.com/nordic-institute/X-Road/commit/2e7b3a9a7464b48075739c04312c9f3c5eb3b4f4", "message": "XRDDEV-900 Fix critical SonarQube issues", "committedDate": "2020-03-24T09:28:52Z", "type": "commit"}]}