{"pr_number": 482, "pr_title": "XRDDEV-828", "pr_createdAt": "2020-04-29T17:04:39Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/482", "timeline": [{"oid": "423a2ec49a9e86b7db71528876cfb6e8e9be6660", "url": "https://github.com/nordic-institute/X-Road/commit/423a2ec49a9e86b7db71528876cfb6e8e9be6660", "message": "XRDDEV-828 support azure style usernames", "committedDate": "2020-04-23T13:49:57Z", "type": "commit"}, {"oid": "a70fae70d965ad40ccf7a34f39c580a1d2faeff8", "url": "https://github.com/nordic-institute/X-Road/commit/a70fae70d965ad40ccf7a34f39c580a1d2faeff8", "message": "XRDDEV-828 apply previous to dbuser connection too", "committedDate": "2020-04-23T14:59:41Z", "type": "commit"}, {"oid": "3846dba279e3c94a562035edcb571c0ba371e240", "url": "https://github.com/nordic-institute/X-Road/commit/3846dba279e3c94a562035edcb571c0ba371e240", "message": "XRDDEV-828 update liquibase commands", "committedDate": "2020-04-24T05:40:42Z", "type": "commit"}, {"oid": "23dac51b3f748a81c64b061ad7f9da2991a56028", "url": "https://github.com/nordic-institute/X-Road/commit/23dac51b3f748a81c64b061ad7f9da2991a56028", "message": "XRDDEV-828 changes to messagelog installation scripts", "committedDate": "2020-04-24T06:38:19Z", "type": "commit"}, {"oid": "6a922a359054b0eb80e7a771473f43d6b30b4f32", "url": "https://github.com/nordic-institute/X-Road/commit/6a922a359054b0eb80e7a771473f43d6b30b4f32", "message": "XRDDEV-828 fix syntax", "committedDate": "2020-04-24T08:24:53Z", "type": "commit"}, {"oid": "b0dd4b8c59c46c60b7f08ac17784049461a61db1", "url": "https://github.com/nordic-institute/X-Road/commit/b0dd4b8c59c46c60b7f08ac17784049461a61db1", "message": "XRDDEV-828 jdbc url handling", "committedDate": "2020-04-24T11:16:47Z", "type": "commit"}, {"oid": "5ff7003676b4867697123314ca50cb54ce9893e5", "url": "https://github.com/nordic-institute/X-Road/commit/5ff7003676b4867697123314ca50cb54ce9893e5", "message": "XRDDEV-828 update opmonitor installation scripts", "committedDate": "2020-04-24T13:08:24Z", "type": "commit"}, {"oid": "a9c91c888518d62a6cee4fdbb193b3d30d7a2a5c", "url": "https://github.com/nordic-institute/X-Road/commit/a9c91c888518d62a6cee4fdbb193b3d30d7a2a5c", "message": "XRDDEV-828 fix messagelog installation", "committedDate": "2020-04-24T13:26:48Z", "type": "commit"}, {"oid": "b607516c30136b62aaf2c5d749ea3d15d6fc8b14", "url": "https://github.com/nordic-institute/X-Road/commit/b607516c30136b62aaf2c5d749ea3d15d6fc8b14", "message": "XRDDEV-828 fix messagelog installation", "committedDate": "2020-04-24T14:23:57Z", "type": "commit"}, {"oid": "265be3465df551bd3e9c6221ce328a4583604d0d", "url": "https://github.com/nordic-institute/X-Road/commit/265be3465df551bd3e9c6221ce328a4583604d0d", "message": "XRDDEV-828 drop unneeded db extensions", "committedDate": "2020-04-27T07:29:18Z", "type": "commit"}, {"oid": "55f58bd8b5d4755b3a216e1ba1c80cd9257974dc", "url": "https://github.com/nordic-institute/X-Road/commit/55f58bd8b5d4755b3a216e1ba1c80cd9257974dc", "message": "XRDDEV-828 separate compile and building packages steps", "committedDate": "2020-04-27T08:20:01Z", "type": "commit"}, {"oid": "bc084f949839ea3b95f3ad28189455f25a2ac8cf", "url": "https://github.com/nordic-institute/X-Road/commit/bc084f949839ea3b95f3ad28189455f25a2ac8cf", "message": "XRDDEV-828 fix syntax", "committedDate": "2020-04-27T08:20:13Z", "type": "commit"}, {"oid": "33bf66014809d5a77fa4f760e34665d20077a940", "url": "https://github.com/nordic-institute/X-Road/commit/33bf66014809d5a77fa4f760e34665d20077a940", "message": "XRDDEV-828 drop extensions if they exist", "committedDate": "2020-04-27T08:38:39Z", "type": "commit"}, {"oid": "19bc4e1d25a2427cf01cd4592c4b9c6fb5257ecc", "url": "https://github.com/nordic-institute/X-Road/commit/19bc4e1d25a2427cf01cd4592c4b9c6fb5257ecc", "message": "XRDDEV-828 refactoring", "committedDate": "2020-04-27T09:03:37Z", "type": "commit"}, {"oid": "78172f9511736034d1fa91fd1580557a66454a66", "url": "https://github.com/nordic-institute/X-Road/commit/78172f9511736034d1fa91fd1580557a66454a66", "message": "XRDDEV-828 fix typo", "committedDate": "2020-04-27T09:20:42Z", "type": "commit"}, {"oid": "e9600a263bbed89138b78e107524cebd1777e306", "url": "https://github.com/nordic-institute/X-Road/commit/e9600a263bbed89138b78e107524cebd1777e306", "message": "XRDDEV-828 refactor", "committedDate": "2020-04-27T09:38:32Z", "type": "commit"}, {"oid": "adb9b2743a6c84a263ea57a4bb9803d5ef32ec20", "url": "https://github.com/nordic-institute/X-Road/commit/adb9b2743a6c84a263ea57a4bb9803d5ef32ec20", "message": "XRDDEV-828 work on CS", "committedDate": "2020-04-27T14:13:40Z", "type": "commit"}, {"oid": "37c21621cdff8a228b0e713530d3a5153557b82a", "url": "https://github.com/nordic-institute/X-Road/commit/37c21621cdff8a228b0e713530d3a5153557b82a", "message": "XRDDEV-828 write suffix into db.propertees", "committedDate": "2020-04-28T06:16:48Z", "type": "commit"}, {"oid": "ba30e8b07039752af2b16124e593b0bd640ea6fa", "url": "https://github.com/nordic-institute/X-Road/commit/ba30e8b07039752af2b16124e593b0bd640ea6fa", "message": "XRDDEV-828 add debug", "committedDate": "2020-04-28T06:46:04Z", "type": "commit"}, {"oid": "35b1309ee01ba6e29d1b060539caaff7f1f2046c", "url": "https://github.com/nordic-institute/X-Road/commit/35b1309ee01ba6e29d1b060539caaff7f1f2046c", "message": "XRDDEV-828 fix missing database", "committedDate": "2020-04-28T06:55:13Z", "type": "commit"}, {"oid": "ccc8876fa31d4d8d48e7fc5a98558912f0449e96", "url": "https://github.com/nordic-institute/X-Road/commit/ccc8876fa31d4d8d48e7fc5a98558912f0449e96", "message": "XRDDEV-828 fix typos", "committedDate": "2020-04-28T07:51:57Z", "type": "commit"}, {"oid": "a047fbb9a0ceae3bfc14aecb4d5a54845536844b", "url": "https://github.com/nordic-institute/X-Road/commit/a047fbb9a0ceae3bfc14aecb4d5a54845536844b", "message": "XRDDEV-828 set username", "committedDate": "2020-04-28T09:35:50Z", "type": "commit"}, {"oid": "31e8601a45845f1fdd221548da91b9f6aa3da93b", "url": "https://github.com/nordic-institute/X-Road/commit/31e8601a45845f1fdd221548da91b9f6aa3da93b", "message": "XRDDEV-828 switch on debug", "committedDate": "2020-04-28T10:41:29Z", "type": "commit"}, {"oid": "03e4538427851d9af7a4e2d6e8671c1d36e6779b", "url": "https://github.com/nordic-institute/X-Road/commit/03e4538427851d9af7a4e2d6e8671c1d36e6779b", "message": "XRDDEV-828 refactoring", "committedDate": "2020-04-28T14:00:53Z", "type": "commit"}, {"oid": "a6d73d6b066775adaaf3c9e54fb86857beca8505", "url": "https://github.com/nordic-institute/X-Road/commit/a6d73d6b066775adaaf3c9e54fb86857beca8505", "message": "Merge branch 'develop' into XRDDEV-828", "committedDate": "2020-04-29T05:35:57Z", "type": "commit"}, {"oid": "ee0cbd40a6bfefd25c71e737ac9965c8f3e7fc41", "url": "https://github.com/nordic-institute/X-Road/commit/ee0cbd40a6bfefd25c71e737ac9965c8f3e7fc41", "message": "XRDDEV-828 remove jdbc suffix", "committedDate": "2020-04-29T06:11:46Z", "type": "commit"}, {"oid": "84bb86b3c52b2d9a47f172778a938b45c0276535", "url": "https://github.com/nordic-institute/X-Road/commit/84bb86b3c52b2d9a47f172778a938b45c0276535", "message": "XRDDEV-828 apply Jarkko's patch", "committedDate": "2020-04-29T06:40:53Z", "type": "commit"}, {"oid": "f11fb547429d5b907c516fe11273ff4abdfe4298", "url": "https://github.com/nordic-institute/X-Road/commit/f11fb547429d5b907c516fe11273ff4abdfe4298", "message": "XRDDEV-828 use login suffix on CS", "committedDate": "2020-04-29T08:18:19Z", "type": "commit"}, {"oid": "4d3ea06c181b585e64c7023b84568519a63126f2", "url": "https://github.com/nordic-institute/X-Road/commit/4d3ea06c181b585e64c7023b84568519a63126f2", "message": "XRDDEV-828 fix db master user", "committedDate": "2020-04-29T08:47:28Z", "type": "commit"}, {"oid": "7644d55121ebe11c4a6df536a18ce88c5e9c4a6a", "url": "https://github.com/nordic-institute/X-Road/commit/7644d55121ebe11c4a6df536a18ce88c5e9c4a6a", "message": "XRDDEV-828 fix db_user", "committedDate": "2020-04-29T13:10:13Z", "type": "commit"}, {"oid": "22711be80a3760fa1986ebcf1984262e33fb1727", "url": "https://github.com/nordic-institute/X-Road/commit/22711be80a3760fa1986ebcf1984262e33fb1727", "message": "XRDDEV-828 write back db_user with suffix", "committedDate": "2020-04-29T13:31:26Z", "type": "commit"}, {"oid": "2810ee3b41a66d415145889098c180ecbac3782a", "url": "https://github.com/nordic-institute/X-Road/commit/2810ee3b41a66d415145889098c180ecbac3782a", "message": "XRDDEV-828 fix condition", "committedDate": "2020-04-29T13:43:36Z", "type": "commit"}, {"oid": "f7b8be14f10ab33888d2fdb57b7febbbbd69e470", "url": "https://github.com/nordic-institute/X-Road/commit/f7b8be14f10ab33888d2fdb57b7febbbbd69e470", "message": "XRDDEV-828 refactor SS isntall", "committedDate": "2020-04-29T13:58:00Z", "type": "commit"}, {"oid": "f80c32a6f1c2c25c3d50977ae40c31769b31c8e3", "url": "https://github.com/nordic-institute/X-Road/commit/f80c32a6f1c2c25c3d50977ae40c31769b31c8e3", "message": "XRDDEV-828 make suffix uniform with CS", "committedDate": "2020-04-29T14:03:54Z", "type": "commit"}, {"oid": "6a83b1547c2d387b050cf00b7f4bd09560467243", "url": "https://github.com/nordic-institute/X-Road/commit/6a83b1547c2d387b050cf00b7f4bd09560467243", "message": "XRDDDEV-828 messagelog and opmonitor refactor", "committedDate": "2020-04-29T14:12:05Z", "type": "commit"}, {"oid": "8dced8242918070ff51ddd04932d82bb57524e7c", "url": "https://github.com/nordic-institute/X-Road/commit/8dced8242918070ff51ddd04932d82bb57524e7c", "message": "XRDDEV-828 fix", "committedDate": "2020-04-29T14:22:09Z", "type": "commit"}, {"oid": "07d1e22fc12e6687196832fbb1d0d7166627e7bf", "url": "https://github.com/nordic-institute/X-Road/commit/07d1e22fc12e6687196832fbb1d0d7166627e7bf", "message": "XRDDEV-828 fix missing double quote", "committedDate": "2020-04-29T14:45:44Z", "type": "commit"}, {"oid": "776d596e7edb6a080c490cccfebc3dd2c9894a0e", "url": "https://github.com/nordic-institute/X-Road/commit/776d596e7edb6a080c490cccfebc3dd2c9894a0e", "message": "XRDDEV-828 fix typo", "committedDate": "2020-04-29T15:00:06Z", "type": "commit"}, {"oid": "a8959654efd19dfd842d93071e11f08a1e70d7e0", "url": "https://github.com/nordic-institute/X-Road/commit/a8959654efd19dfd842d93071e11f08a1e70d7e0", "message": "XRDDEV-828 fix db.properties usernames", "committedDate": "2020-04-29T15:27:39Z", "type": "commit"}, {"oid": "5e0b0e17072bfd66b116553e07ee27ad2276d0b2", "url": "https://github.com/nordic-institute/X-Road/commit/5e0b0e17072bfd66b116553e07ee27ad2276d0b2", "message": "XRDDEV-828 update documentation", "committedDate": "2020-04-29T16:17:30Z", "type": "commit"}, {"oid": "43c1a99f43aa36960694abaf3bd48ba51fbf985c", "url": "https://github.com/nordic-institute/X-Road/commit/43c1a99f43aa36960694abaf3bd48ba51fbf985c", "message": "XRDDEV-828 Red Hat SS scripts to support Azure", "committedDate": "2020-04-29T17:43:27Z", "type": "commit"}, {"oid": "9eee842badc1eb3607cd8263f5e2c141cb630990", "url": "https://github.com/nordic-institute/X-Road/commit/9eee842badc1eb3607cd8263f5e2c141cb630990", "message": "XRDDEV-828 add possibility to skip deb package building", "committedDate": "2020-04-29T18:44:47Z", "type": "commit"}, {"oid": "47c917fb0239f74c701c55f1b3f3ae2de20709be", "url": "https://github.com/nordic-institute/X-Road/commit/47c917fb0239f74c701c55f1b3f3ae2de20709be", "message": "XRDDEV-828 fix bug in settng username", "committedDate": "2020-04-29T18:45:08Z", "type": "commit"}, {"oid": "0de4cab182827997cf0bacc72b4fdb2562636e23", "url": "https://github.com/nordic-institute/X-Road/commit/0de4cab182827997cf0bacc72b4fdb2562636e23", "message": "XRDDEV-828 fix user", "committedDate": "2020-04-29T19:28:56Z", "type": "commit"}, {"oid": "874189d1f9e7e40a601b44e1523e54a7fc898768", "url": "https://github.com/nordic-institute/X-Road/commit/874189d1f9e7e40a601b44e1523e54a7fc898768", "message": "XRDDEV-828 fix user bug", "committedDate": "2020-04-29T19:47:16Z", "type": "commit"}, {"oid": "dd053b560afb3e5c518ab49fe4dff991457ee6ed", "url": "https://github.com/nordic-institute/X-Road/commit/dd053b560afb3e5c518ab49fe4dff991457ee6ed", "message": "XRDDEV-828 fix messagelog install", "committedDate": "2020-04-29T20:02:09Z", "type": "commit"}, {"oid": "0c24bd510a323acf84df57c7a04c9fcf577794be", "url": "https://github.com/nordic-institute/X-Road/commit/0c24bd510a323acf84df57c7a04c9fcf577794be", "message": "XRDDEV-828 update rhel ss installation manual", "committedDate": "2020-04-30T04:55:37Z", "type": "commit"}, {"oid": "eda8e6e21cafb9938ab77119644cd3965e0b192c", "url": "https://github.com/nordic-institute/X-Road/commit/eda8e6e21cafb9938ab77119644cd3965e0b192c", "message": "XRDDEV-828 work on backup and restore scripts", "committedDate": "2020-04-30T12:15:14Z", "type": "commit"}, {"oid": "f616e68f7f6680133c36cc459e55c48fcef06cd8", "url": "https://github.com/nordic-institute/X-Road/commit/f616e68f7f6680133c36cc459e55c48fcef06cd8", "message": "XRDDEV-828 update cs backup and restore", "committedDate": "2020-04-30T13:43:30Z", "type": "commit"}, {"oid": "dd0cdf775e9488e8fe04bb6397cf17958d381361", "url": "https://github.com/nordic-institute/X-Road/commit/dd0cdf775e9488e8fe04bb6397cf17958d381361", "message": "XRDDEV-828 remove debug logging", "committedDate": "2020-04-30T14:24:13Z", "type": "commit"}, {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "url": "https://github.com/nordic-institute/X-Road/commit/6e35d45dce58b618b95fe35b86cce8f0bba792d0", "message": "XRDDEV-828 fix documentation", "committedDate": "2020-05-04T06:44:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2ODY2MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419968661", "bodyText": "hard-coded schema serverconf, but the db setup uses configurable schema name (same as username)", "author": "jhyoty", "createdAt": "2020-05-05T09:12:35Z", "path": "src/packages/src/xroad/common/proxy/usr/share/xroad/scripts/backup_db.sh", "diffHunk": "@@ -6,7 +6,7 @@ dump_file=\"$1\"\n db_properties=/etc/xroad/db.properties\n db_host=\"127.0.0.1:5432\"\n db_user=\"$(get_prop ${db_properties} 'serverconf.hibernate.connection.username' 'serverconf')\"\n-db_schema=\"$db_user\"\n+db_schema=serverconf", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2ODg1Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419968852", "bodyText": "hard-coded schema serverconf, but the db setup uses configurable schema name (same as username).", "author": "jhyoty", "createdAt": "2020-05-05T09:12:58Z", "path": "src/packages/src/xroad/common/proxy/usr/share/xroad/scripts/restore_db.sh", "diffHunk": "@@ -6,7 +6,7 @@ dump_file=\"$1\"\n db_properties=/etc/xroad/db.properties\n db_host=\"127.0.0.1:5432\"\n db_user=\"$(get_prop ${db_properties} 'serverconf.hibernate.connection.username' 'serverconf')\"\n-db_schema=\"$db_user\"\n+db_schema=serverconf", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2OTQyMg==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419969422", "bodyText": "why is the default schema name hardcoded to centerui?", "author": "jhyoty", "createdAt": "2020-05-05T09:13:56Z", "path": "src/packages/src/xroad/common/center/usr/share/xroad/scripts/restore_db.sh", "diffHunk": "@@ -9,7 +9,7 @@ abort() { local rc=$?; echo -e \"FATAL: $*\" >&2; exit $rc; }\n \n DUMP_FILE=$1\n USER=$(get_db_prop 'username' 'centerui')\n-SCHEMA=$(get_db_prop 'schema' \"$USER\")\n+SCHEMA=$(get_db_prop 'schema' 'centerui')", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3MjU4MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419972581", "bodyText": "On line 139, the username is (potentially) written as user@suffix. During subsequent upgrade, the username is read from properties (line 61), and here the suffix would be re-applied (user@suffix@suffix). And so on.\nI think it would be better to read the username from the properties file, assume that it has the suffix if it is required, and then remove the suffix to get a \"plain\" username which is used where required.", "author": "jhyoty", "createdAt": "2020-05-05T09:19:47Z", "path": "src/packages/src/xroad/redhat/SOURCES/proxy/xroad-proxy-setup.sh", "diffHunk": "@@ -85,24 +86,30 @@ setup_database() {\n     local_psql() { su -l -c \"psql -qtA -p ${db_port:-5432} $*\" postgres; }\n     remote_psql() { psql -h \"${db_addr:-127.0.0.1}\" -p \"${db_port:-5432}\" -qtA \"$@\"; }\n \n-    psql_dbuser() {\n-        PGDATABASE=\"$db_database\" PGUSER=\"$db_user\" PGPASSWORD=\"$db_password\" remote_psql \"$@\"\n-    }\n-\n     if [[ -f ${root_properties} && $(get_prop ${root_properties} postgres.connection.password) != \"\" ]]; then\n         local db_master_passwd=$(get_prop ${root_properties} postgres.connection.password)\n         db_master_user=$(get_prop ${root_properties} postgres.connection.user 'postgres')\n+        db_conn_master_user=\"${db_master_user}\"\n+        if [[ $(get_prop ${root_properties} postgres.connection.login_suffix) != \"\" ]]; then\n+            suffix=$(get_prop ${root_properties} postgres.connection.login_suffix)\n+            db_conn_master_user=\"${db_master_user}${suffix}\"\n+            db_conn_user=\"${db_user}${suffix}\"", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3NDA0MQ==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419974041", "bodyText": "duplicates the suffix if the db_user is already in format user@suffix (as written on line 151)", "author": "jhyoty", "createdAt": "2020-05-05T09:22:26Z", "path": "src/packages/src/xroad/redhat/SOURCES/opmonitor/xroad-opmonitor-initdb.sh", "diffHunk": "@@ -73,6 +81,7 @@ then\n \n   db_url=$(get_prop ${db_properties} op-monitor.hibernate.connection.url)\n   db_user=$(get_prop ${db_properties} op-monitor.hibernate.connection.username \"$db_user\")\n+  db_conn_user=\"${db_user}${suffix}\"", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3NjE2Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419976162", "bodyText": "can duplicate the suffix if db_user is already in that format.", "author": "jhyoty", "createdAt": "2020-05-05T09:26:09Z", "path": "src/packages/src/xroad/redhat/SPECS/xroad-addon-messagelog.spec", "diffHunk": "@@ -66,12 +66,19 @@ rm -rf %{buildroot}\n \n %post\n \n+db_properties=/etc/xroad/db.properties\n+root_properties=/etc/xroad.properties\n db_name=messagelog\n db_url=jdbc:postgresql://127.0.0.1:5432/${db_name}\n db_user=messagelog\n+db_conn_user=\"${db_user}\"\n+if  [[ -f ${root_properties}  && `crudini --get ${root_properties} '' postgres.connection.login_suffix` != \"\" ]]\n+then\n+    suffix=`crudini --get ${root_properties} '' postgres.connection.login_suffix`\n+    db_conn_user=\"${db_user}${suffix}\"", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3NjkwMA==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419976900", "bodyText": "the suffix should only be applied if the username does not already contain one.", "author": "jhyoty", "createdAt": "2020-05-05T09:27:29Z", "path": "src/packages/src/xroad/ubuntu/generic/xroad-center.postinst", "diffHunk": "@@ -46,11 +46,12 @@ setup_database() {\n     crudini --set \"${db_properties}\" '' host \"${db_addr}\"\n     crudini --set \"${db_properties}\" '' port \"${db_port}\"\n \n-    local db_user=$(get_prop ${db_properties} 'username' 'centerui')\n-    local db_schema=$(get_prop ${db_properties} 'schema' \"$db_user\")\n+    local suffix=$(get_prop ${root_properties} postgres.connection.login_suffix \"\")\n+    local db_user=$(get_prop ${db_properties} 'username' 'centerui')\"${suffix}\"", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MTM3MA==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419991370", "bodyText": "if db_user already has the suffix (line 134), the schema name will be invalid", "author": "jhyoty", "createdAt": "2020-05-05T09:53:33Z", "path": "src/packages/src/xroad/ubuntu/generic/xroad-proxy.postinst", "diffHunk": "@@ -53,7 +53,8 @@ setup_database() {\n \n     local tmp_password=\"$(head -c 24 /dev/urandom | base64 | tr \"/+\" \"_-\")\"\n     local db_user=$(get_prop ${db_properties} 'serverconf.hibernate.connection.username' 'serverconf')\n-    local db_schema=\"$db_user\"\n+    local db_conn_user=\"${db_user}\"\n+    local db_schema=\"${db_user}\"", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MTU1Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419991556", "bodyText": "suffix potentially duplicated", "author": "jhyoty", "createdAt": "2020-05-05T09:53:52Z", "path": "src/packages/src/xroad/ubuntu/generic/xroad-proxy.postinst", "diffHunk": "@@ -80,24 +81,30 @@ setup_database() {\n     local_psql() { su -l -c \"psql -qtA -p ${db_port:-5432} ${*@Q}\" postgres; }\n     remote_psql() { psql -h \"${db_addr:-127.0.0.1}\" -p \"${db_port:-5432}\" -qtA \"$@\"; }\n \n-    psql_dbuser() {\n-        PGDATABASE=\"$db_database\" PGUSER=\"$db_user\" PGPASSWORD=\"$db_password\" remote_psql \"$@\"\n-    }\n-\n     if [[ -f ${root_properties} && $(get_prop ${root_properties} postgres.connection.password) != \"\" ]]; then\n         local db_master_passwd=$(get_prop ${root_properties} postgres.connection.password)\n         db_master_user=$(get_prop ${root_properties} postgres.connection.user 'postgres')\n+        db_conn_master_user=\"${db_master_user}\"\n+        if [[ $(get_prop ${root_properties} postgres.connection.login_suffix) != \"\" ]]; then\n+            suffix=$(get_prop ${root_properties} postgres.connection.login_suffix)\n+            db_conn_master_user=\"${db_master_user}${suffix}\"\n+            db_conn_user=\"${db_user}${suffix}\"", "originalCommit": "6e35d45dce58b618b95fe35b86cce8f0bba792d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df804e23c605895372c2d22c40dac0aa54e67713", "url": "https://github.com/nordic-institute/X-Road/commit/df804e23c605895372c2d22c40dac0aa54e67713", "message": "XRDDEV-828 revert hard-coded schema from backup/restore", "committedDate": "2020-05-06T07:35:24Z", "type": "commit"}, {"oid": "df81df824ba3b6718f4b17707e98502cb2eb0bb5", "url": "https://github.com/nordic-institute/X-Road/commit/df81df824ba3b6718f4b17707e98502cb2eb0bb5", "message": "XRDDEV-828 add debug logging", "committedDate": "2020-05-06T07:45:08Z", "type": "commit"}, {"oid": "a317a50fde2205ca672c94cf9c64b1bd8e643527", "url": "https://github.com/nordic-institute/X-Road/commit/a317a50fde2205ca672c94cf9c64b1bd8e643527", "message": "Revert \"XRDDEV-828 remove debug logging\"\n\nThis reverts commit dd0cdf775e9488e8fe04bb6397cf17958d381361.", "committedDate": "2020-05-06T08:24:20Z", "type": "commit"}, {"oid": "051894f48fc07c3373bb7ae8416ef6474569a221", "url": "https://github.com/nordic-institute/X-Road/commit/051894f48fc07c3373bb7ae8416ef6474569a221", "message": "XRDDEV-828 restore", "committedDate": "2020-05-06T11:59:08Z", "type": "commit"}, {"oid": "d8e5f4fc9656f1bb9cca2d611383194d05bb8888", "url": "https://github.com/nordic-institute/X-Road/commit/d8e5f4fc9656f1bb9cca2d611383194d05bb8888", "message": "XRDDEV-828 update cs install guide", "committedDate": "2020-05-06T13:35:25Z", "type": "commit"}, {"oid": "a4339293c6442eae9f4abdfe3c00aedc96df79fb", "url": "https://github.com/nordic-institute/X-Road/commit/a4339293c6442eae9f4abdfe3c00aedc96df79fb", "message": "XRDDEV-828 fix cs docs", "committedDate": "2020-05-06T13:53:26Z", "type": "commit"}, {"oid": "b46a09e0aeee92e1d56e35735645b8cc8ee0d8ee", "url": "https://github.com/nordic-institute/X-Road/commit/b46a09e0aeee92e1d56e35735645b8cc8ee0d8ee", "message": "XRDDEV-828 refactor ubuntu ss installation", "committedDate": "2020-05-06T14:50:23Z", "type": "commit"}, {"oid": "e7742f91054993c61c9969ed8fa46759a05221c5", "url": "https://github.com/nordic-institute/X-Road/commit/e7742f91054993c61c9969ed8fa46759a05221c5", "message": "XRDDEV-828 test with serverconf schema", "committedDate": "2020-05-06T15:21:54Z", "type": "commit"}, {"oid": "ce18dcabd9b9ef226c4cd0441d5def191c76f242", "url": "https://github.com/nordic-institute/X-Road/commit/ce18dcabd9b9ef226c4cd0441d5def191c76f242", "message": "XRDDEV-828 fixes", "committedDate": "2020-05-06T15:44:50Z", "type": "commit"}, {"oid": "d3259e6eeeae42ee2cc675131f594d4437a1d5d7", "url": "https://github.com/nordic-institute/X-Road/commit/d3259e6eeeae42ee2cc675131f594d4437a1d5d7", "message": "XRDDEV-828 fix", "committedDate": "2020-05-06T16:01:19Z", "type": "commit"}, {"oid": "97bdec5e6a10c5547578f1db92fcac5283709612", "url": "https://github.com/nordic-institute/X-Road/commit/97bdec5e6a10c5547578f1db92fcac5283709612", "message": "XRDDEV-828 refactor red hat installation scripts", "committedDate": "2020-05-06T18:54:58Z", "type": "commit"}, {"oid": "3b84b3d0d41ac94171b6cc55fc5a802a735c6f14", "url": "https://github.com/nordic-institute/X-Road/commit/3b84b3d0d41ac94171b6cc55fc5a802a735c6f14", "message": "XRDDEV-828 fixes and doc updates", "committedDate": "2020-05-06T19:26:11Z", "type": "commit"}, {"oid": "bd52ba957672a89c6eaa25672fcade252e328af6", "url": "https://github.com/nordic-institute/X-Road/commit/bd52ba957672a89c6eaa25672fcade252e328af6", "message": "XRDDEV-828 remove suffix", "committedDate": "2020-05-06T19:42:51Z", "type": "commit"}, {"oid": "119228da003dd8c12224759192ed991db070bec4", "url": "https://github.com/nordic-institute/X-Road/commit/119228da003dd8c12224759192ed991db070bec4", "message": "XRDDEV-828 ss backup/restore schema", "committedDate": "2020-05-07T06:18:54Z", "type": "commit"}, {"oid": "9e68121262f6186586b8b92c02032d633979f9e3", "url": "https://github.com/nordic-institute/X-Road/commit/9e68121262f6186586b8b92c02032d633979f9e3", "message": "XRDDEV-828 update cs manual", "committedDate": "2020-05-07T07:24:01Z", "type": "commit"}, {"oid": "83053872a0d9ad8e244b862383c1df9e059097b1", "url": "https://github.com/nordic-institute/X-Road/commit/83053872a0d9ad8e244b862383c1df9e059097b1", "message": "XRDDEV-828 fix messagelog local install", "committedDate": "2020-05-07T08:44:14Z", "type": "commit"}, {"oid": "61f44b1394468946d5eb9b7f0269122dfbddd43e", "url": "https://github.com/nordic-institute/X-Road/commit/61f44b1394468946d5eb9b7f0269122dfbddd43e", "message": "XRDDEV-828 remove debug logging", "committedDate": "2020-05-07T09:36:18Z", "type": "commit"}]}