{"pr_number": 435, "pr_title": "XRDDEV-941", "pr_createdAt": "2020-03-26T11:15:53Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/435", "timeline": [{"oid": "d1576431a34ed8ba794620619e76dedda912c0ff", "url": "https://github.com/nordic-institute/X-Road/commit/d1576431a34ed8ba794620619e76dedda912c0ff", "message": "XRDDEV-941 API for updating existing API key\n\n- Add API for updating existing API key.\n- Add tests.\n- Update documentation.", "committedDate": "2020-03-26T11:07:21Z", "type": "commit"}, {"oid": "35a6abee0f156d558706b51f80b5db3c16f5e039", "url": "https://github.com/nordic-institute/X-Road/commit/35a6abee0f156d558706b51f80b5db3c16f5e039", "message": "XRDDEV-941 Update documentation", "committedDate": "2020-03-26T11:09:45Z", "type": "commit"}, {"oid": "a28d5e8d8d63ba2b2576081a09a84c6b75a10f95", "url": "https://github.com/nordic-institute/X-Road/commit/a28d5e8d8d63ba2b2576081a09a84c6b75a10f95", "message": "XRDDEV-941 Update documentation", "committedDate": "2020-03-26T11:11:28Z", "type": "commit"}, {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb", "url": "https://github.com/nordic-institute/X-Road/commit/735e853ba2b24871b82606d8df77478ba2283ecb", "message": "XRDDEV-941 Update documentation", "committedDate": "2020-03-26T11:13:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMDA3Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399220077", "bodyText": "Feels like this ApiKeyRepository is a bit different from the conventions used in other repositories. Other repositories mostly\n\nhave a saveOrUpdate method which is used for both creating and updating\ndo not deletegate simple update / delete operations to DAO, but instead just use direct calls with persistenceUtils, e.g. \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/LocalGroupRepository.java\n    \n    \n        Lines 104 to 106\n      in\n      735e853\n    \n    \n    \n    \n\n        \n          \n           public void delete(LocalGroupType localGroupType) { \n        \n\n        \n          \n               persistenceUtils.getCurrentSession().delete(localGroupType); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\n\nBut this is earlier legacy than this ticket so nothing has to be done here. I think I will add a few lines to confluence to offer some conventions for future repository implementations.\nI think I will pick an API key related ticket next, so I might refactor this part there. Or, if you get the inspiration, you can do it also.", "author": "jansu76", "createdAt": "2020-03-27T12:10:50Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/ApiKeyRepository.java", "diffHunk": "@@ -108,6 +108,44 @@ private String createApiKey() {\n         return entry;\n     }\n \n+    /**\n+     * update api key with one role by key id\n+     * @param id\n+     * @param roleName\n+     * @throws InvalidRoleNameException if roleNames was empty or contained invalid roles\n+     * @throws ApiKeyNotFoundException if api key was not found\n+     */\n+    @CacheEvict(allEntries = true, cacheNames = { LIST_ALL_KEYS_CACHE, GET_KEY_CACHE })\n+    public PersistentApiKeyType update(long id, String roleName)\n+            throws InvalidRoleNameException, ApiKeyNotFoundException {\n+        return update(id, Collections.singletonList(roleName));\n+    }\n+\n+    /**\n+     * update api key with collection of roles by key id\n+     * @param id\n+     * @param roleNames\n+     * @return\n+     * @throws InvalidRoleNameException if roleNames was empty or contained invalid roles\n+     * @throws ApiKeyNotFoundException if api key was not found\n+     */\n+    @CacheEvict(allEntries = true, cacheNames = { LIST_ALL_KEYS_CACHE, GET_KEY_CACHE })\n+    public PersistentApiKeyType update(long id, Collection<String> roleNames)", "originalCommit": "735e853ba2b24871b82606d8df77478ba2283ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNDU0Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399224547", "bodyText": "Confluence updated: https://confluence.niis.org/display/XRDDEV/API+backend+conventions#APIbackendconventions-Repositories", "author": "jansu76", "createdAt": "2020-03-27T12:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMDA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NTMxMw==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399765313", "bodyText": "I got inspired and did some refactoring. As a result the implementation now follows the same structure with other endpoints. Repository and service layers are separated, and business logic is implemented in the service layer.", "author": "petkivim", "createdAt": "2020-03-29T08:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMDA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI3NjEwMA==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r402276100", "bodyText": "That's great! Looks good. Very nice to have this consistent with the rest of the app now.", "author": "jansu76", "createdAt": "2020-04-02T12:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMDA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyODI4Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399228287", "bodyText": "Looks like update targets key 60 but returns 61, is it a mistake?", "author": "jansu76", "createdAt": "2020-03-27T12:27:08Z", "path": "doc/Manuals/ug-ss_x-road_6_security_server_user_guide.md", "diffHunk": "@@ -2025,7 +2027,24 @@ curl -X GET -u <user>:<password> https://localhost:4000/api/api-key -k\n \n ```\n \n-#### 19.1.3 Revoking API keys\n+#### 19.1.3 Updating API keys\n+\n+An existing API key is updated with a `PUT` request to `/api/api-key/{id}`. Message body must contain the roles to be\n+associated with the key. Server responds with data that contains the key id and roles associated with the key.\n+\n+```\n+curl -X PUT -u <user>:<password> https://localhost:4000/api/api-key/60 --data '[\"XROAD_SECURITYSERVER_OBSERVER\",\"XROAD_REGISTRATION_OFFICER\"]' --header \"Content-Type: application/json\" -k\n+{\n+  \"id\": 61,", "originalCommit": "735e853ba2b24871b82606d8df77478ba2283ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3Mjk0Nw==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399672947", "bodyText": "This was a mistake. It's fixed now.", "author": "petkivim", "createdAt": "2020-03-28T15:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyODI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzNDk4Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399234983", "bodyText": "Should the use case documentation also be updated, as it contains other API key related operations? https://github.com/nordic-institute/X-Road/blob/735e853ba2b24871b82606d8df77478ba2283ecb/doc/UseCases/uc-ss_x-road_use_case_model_for_security_server_management_1.4_Y-883-4.md#344-uc-ss_43-create-a-new-api-key", "author": "jansu76", "createdAt": "2020-03-27T12:40:06Z", "path": "doc/Manuals/ug-ss_x-road_6_security_server_user_guide.md", "diffHunk": "@@ -6,7 +6,7 @@\n \n **X-ROAD 6**\n \n-Version: 2.36\n+Version: 2.38", "originalCommit": "735e853ba2b24871b82606d8df77478ba2283ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3MzA2OA==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399673068", "bodyText": "Yes, it should be updated too. Editing an API key is now added to the use case document.", "author": "petkivim", "createdAt": "2020-03-28T15:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzNDk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MTgzNA==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399241834", "bodyText": "ApiKeyNotFoundException should probably result in ResourceNotFoundException instead (see revoke)", "author": "jansu76", "createdAt": "2020-03-27T12:52:41Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/controller/ApiKeyController.java", "diffHunk": "@@ -82,6 +82,20 @@\n         return result;\n     }\n \n+    /**\n+     * update an existing api key\n+     */\n+    @RequestMapping(value = \"/{id}\", method = RequestMethod.PUT, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)\n+    public ResponseEntity<PublicKeyData> updateKey(@PathVariable(\"id\") long id,\n+                                                          @RequestBody List<String> roles) {\n+        try {\n+            PersistentApiKeyType key = apiKeyRepository.update(id, roles);\n+            return new ResponseEntity<>(new PublicKeyData(key.getId(), key.getRoles()), HttpStatus.OK);\n+        } catch (InvalidRoleNameException | ApiKeyRepository.ApiKeyNotFoundException e) {", "originalCommit": "735e853ba2b24871b82606d8df77478ba2283ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3Mzc5Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399673792", "bodyText": "Fixed.", "author": "petkivim", "createdAt": "2020-03-28T15:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MTgzNA=="}], "type": "inlineReview"}, {"oid": "2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "url": "https://github.com/nordic-institute/X-Road/commit/2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "message": "XRDDEV-941 Update documentation\n\n- Update Security Server user guide.\n- Update Security Server use case document.", "committedDate": "2020-03-28T15:08:03Z", "type": "commit"}, {"oid": "2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "url": "https://github.com/nordic-institute/X-Road/commit/2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "message": "XRDDEV-941 Update documentation\n\n- Update Security Server user guide.\n- Update Security Server use case document.", "committedDate": "2020-03-28T15:08:03Z", "type": "forcePushed"}, {"oid": "bc20188fb9ac5602ae11c4f6ebb881ecb88d8e1c", "url": "https://github.com/nordic-institute/X-Road/commit/bc20188fb9ac5602ae11c4f6ebb881ecb88d8e1c", "message": "XRDDEV-941 Update Security Server use case document", "committedDate": "2020-03-28T15:11:07Z", "type": "commit"}, {"oid": "a53bd0a095b78eff5549a8b0b3a11a02d1990672", "url": "https://github.com/nordic-institute/X-Road/commit/a53bd0a095b78eff5549a8b0b3a11a02d1990672", "message": "XRDDEV-941 Minor update on API key controller based on review comments", "committedDate": "2020-03-28T15:20:51Z", "type": "commit"}, {"oid": "fdd72f685ac2cceb1a47eeb78398999deb1b2759", "url": "https://github.com/nordic-institute/X-Road/commit/fdd72f685ac2cceb1a47eeb78398999deb1b2759", "message": "XRDDEV-941 Refactor repository implementation\n\n- Add new ApiKeyService class that contains business logic.\n- Refactor ApiKeyRepository so that in contains only DB operations.\n- Update tests.", "committedDate": "2020-03-29T06:48:25Z", "type": "commit"}, {"oid": "20b48bd6a6be2f667f09cf70918e13d16a09bea1", "url": "https://github.com/nordic-institute/X-Road/commit/20b48bd6a6be2f667f09cf70918e13d16a09bea1", "message": "XRDDEV-941 Separate service and API layer data models\n\n- Implement new data model for API layer.\n- Add converter.\n- Add tests.", "committedDate": "2020-03-29T07:55:26Z", "type": "commit"}, {"oid": "da8edfeccb4be9e731d4fdd13c33461145235ab2", "url": "https://github.com/nordic-institute/X-Road/commit/da8edfeccb4be9e731d4fdd13c33461145235ab2", "message": "XRDDEV-941  Fix failing tests", "committedDate": "2020-03-29T08:32:44Z", "type": "commit"}, {"oid": "eaeac8ef91345319456a82dd63c31e96f92ccd13", "url": "https://github.com/nordic-institute/X-Road/commit/eaeac8ef91345319456a82dd63c31e96f92ccd13", "message": "XRDDEV-941  Fix failing tests", "committedDate": "2020-03-29T09:04:04Z", "type": "commit"}, {"oid": "13059996338a1f1d6c3daa13785d6d78b57a35e7", "url": "https://github.com/nordic-institute/X-Road/commit/13059996338a1f1d6c3daa13785d6d78b57a35e7", "message": "XRDDEV-941 Fix checkstyle issues", "committedDate": "2020-03-29T09:05:46Z", "type": "commit"}, {"oid": "25bfef4167b9f6be63bf333fefdde1b197957ced", "url": "https://github.com/nordic-institute/X-Road/commit/25bfef4167b9f6be63bf333fefdde1b197957ced", "message": "XRDDEV-941 Fix SonarQube findings", "committedDate": "2020-03-29T12:42:13Z", "type": "commit"}, {"oid": "22d66e32f5cf071bef800e028d21f34033320935", "url": "https://github.com/nordic-institute/X-Road/commit/22d66e32f5cf071bef800e028d21f34033320935", "message": "Merge branch 'develop' into XRDDEV-941", "committedDate": "2020-04-02T04:45:05Z", "type": "commit"}]}