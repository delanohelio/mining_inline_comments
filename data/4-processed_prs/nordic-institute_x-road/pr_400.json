{"pr_number": 400, "pr_title": "XRDDEV-866 delete client", "pr_createdAt": "2020-03-02T14:27:39Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/400", "timeline": [{"oid": "239e9ae2079e775739e3393ecb7a9fa0ba4cb92b", "url": "https://github.com/nordic-institute/X-Road/commit/239e9ae2079e775739e3393ecb7a9fa0ba4cb92b", "message": "XRDDEV-866 add service skeletons", "committedDate": "2020-02-19T20:24:09Z", "type": "commit"}, {"oid": "54ebcec4e3ef07a20d8a878ab1a7ee4cc02e6a9a", "url": "https://github.com/nordic-institute/X-Road/commit/54ebcec4e3ef07a20d8a878ab1a7ee4cc02e6a9a", "message": "XRDDEV-866 api design and implement failing (ignored) tests for deleteClient", "committedDate": "2020-02-20T14:53:14Z", "type": "commit"}, {"oid": "e3e14603719b3837fde5933268ef1afab331c262", "url": "https://github.com/nordic-institute/X-Road/commit/e3e14603719b3837fde5933268ef1afab331c262", "message": "XRDDEV-866 implement clientService.deleteLocalClient", "committedDate": "2020-02-20T20:19:53Z", "type": "commit"}, {"oid": "70b31094b1d5ab1178a29509b1635e229cb17f66", "url": "https://github.com/nordic-institute/X-Road/commit/70b31094b1d5ab1178a29509b1635e229cb17f66", "message": "XRDDEV-866 add tests and impementation for orphansExists", "committedDate": "2020-02-21T07:06:37Z", "type": "commit"}, {"oid": "02a2bfe723c6bdeb4085afa405029b6f2af0f675", "url": "https://github.com/nordic-institute/X-Road/commit/02a2bfe723c6bdeb4085afa405029b6f2af0f675", "message": "XRDDEV-866 fix typo", "committedDate": "2020-02-21T07:09:26Z", "type": "commit"}, {"oid": "5f7ed5b972995b2fb0e5fa2197979402aab06902", "url": "https://github.com/nordic-institute/X-Road/commit/5f7ed5b972995b2fb0e5fa2197979402aab06902", "message": "XRDDEV-866 implement deleteOrphans, make tests pass", "committedDate": "2020-02-24T11:15:06Z", "type": "commit"}, {"oid": "fc3752af4423f5b37a1a2802d456ae2c9eaa3410", "url": "https://github.com/nordic-institute/X-Road/commit/fc3752af4423f5b37a1a2802d456ae2c9eaa3410", "message": "XRDDEV-866 mock signerFacade instead of tokenService, fix mockito verifications", "committedDate": "2020-02-24T11:47:14Z", "type": "commit"}, {"oid": "fa06ff713063d0e89c5c9b342083582dc1b60115", "url": "https://github.com/nordic-institute/X-Road/commit/fa06ff713063d0e89c5c9b342083582dc1b60115", "message": "XRDDEV-866 add controller method and test", "committedDate": "2020-03-02T07:27:07Z", "type": "commit"}, {"oid": "f571efac67a803d41249d095c159f37bc43f260d", "url": "https://github.com/nordic-institute/X-Road/commit/f571efac67a803d41249d095c159f37bc43f260d", "message": "XRDDEV-866 add orphan controller endpoints and tests", "committedDate": "2020-03-02T13:39:49Z", "type": "commit"}, {"oid": "6e08499c342bb5879dc849b073e850cf4d9ceea3", "url": "https://github.com/nordic-institute/X-Road/commit/6e08499c342bb5879dc849b073e850cf4d9ceea3", "message": "Merge branch 'XRDDEV-860-add-client' into XRDDEV-866-delete-client\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/ClientServiceIntegrationTest.java", "committedDate": "2020-03-02T14:24:30Z", "type": "commit"}, {"oid": "89d0d9b66625dc45e5e0a7f5aede8eade2029627", "url": "https://github.com/nordic-institute/X-Road/commit/89d0d9b66625dc45e5e0a7f5aede8eade2029627", "message": "Merge branch 'develop' into XRDDEV-866-delete-client", "committedDate": "2020-03-09T09:50:04Z", "type": "commit"}, {"oid": "05947f12d36847cecbd4d6bf239262019c8ed6bb", "url": "https://github.com/nordic-institute/X-Road/commit/05947f12d36847cecbd4d6bf239262019c8ed6bb", "message": "Merge branch 'develop' into XRDDEV-866-delete-client", "committedDate": "2020-03-09T13:51:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2MTE5Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/400#discussion_r390161193", "bodyText": "Javadocs missing ClientNotFoundException", "author": "carohauta", "createdAt": "2020-03-10T08:41:54Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -560,6 +565,43 @@ private ClientId getPossiblyManagedEntity(ClientId transientClientId) {\n         }\n     }\n \n+    /**\n+     * Delete a local client.\n+     * @param clientId\n+     * @throws ActionNotPossibleException if client status did not allow delete\n+     * @throws CannotDeleteOwnerException if attempted to delete the owner\n+     */\n+    public void deleteLocalClient(ClientId clientId) throws ActionNotPossibleException,", "originalCommit": "05947f12d36847cecbd4d6bf239262019c8ed6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwMjg5OA==", "url": "https://github.com/nordic-institute/X-Road/pull/400#discussion_r390302898", "bodyText": "added", "author": "jansu76", "createdAt": "2020-03-10T13:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2MTE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI0Mjg2Ng==", "url": "https://github.com/nordic-institute/X-Road/pull/400#discussion_r390242866", "bodyText": "This is probably intentionally a non-atomic operation? Just wondering what happens in a case where some certs are deleted and some are not because in the middle of the deletion process a wild CertificateNotFoundException appears?\nIn the case of removing orphans that shouldn't happen since the certs are not actually provided by the user. This is probably something to be looked more into if we ever need an API endpoint supporting the deletion of multiple certificates.", "author": "carohauta", "createdAt": "2020-03-10T11:12:44Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java", "diffHunk": "@@ -744,6 +746,35 @@ static boolean isCausedByCertNotFound(CodedException e) {\n         return possibleActions;\n     }\n \n+    /**\n+     * Deletes a collection of certificates\n+     * @throws CertificateNotFoundException if certificate with given hash was not found\n+     * @throws ActionNotPossibleException if delete was not possible due to cert/key/token states\n+     */\n+    public void deleteCertificates(List<CertificateInfo> certificateInfos)\n+            throws CertificateNotFoundException, ActionNotPossibleException {\n+        List<TokenInfo> tokenInfos = tokenService.getAllTokens();\n+        for (CertificateInfo certificateInfo: certificateInfos) {\n+            deleteCertificate(certificateInfo.getId(), tokenInfos);\n+        }\n+    }", "originalCommit": "05947f12d36847cecbd4d6bf239262019c8ed6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwMTc5Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/400#discussion_r390301793", "bodyText": "Yeah, it is - kind of - intentional. If some of the certs have been deleted, and an error occurs midway, end result will be partly removed collection of certs.\nI believe the same thing would happen with the old UI implementation: \n  \n    \n      X-Road/src/proxy-ui/app/controllers/clients_controller.rb\n    \n    \n        Lines 407 to 426\n      in\n      05e6443\n    \n    \n    \n    \n\n        \n          \n           SignerProxy::getTokens.each do |token| \n        \n\n        \n          \n             token.keyInfo.each do |key| \n        \n\n        \n          \n               key.certs.each do |cert| \n        \n\n        \n          \n                 if client_id.memberEquals(cert.memberId) \n        \n\n        \n          \n                   audit_log_data[:certHashes] << \n        \n\n        \n          \n                     CommonUi::CertUtils.cert_hash(cert.certificateBytes) \n        \n\n        \n          \n            \n        \n\n        \n          \n                   SignerProxy::deleteCert(cert.id) \n        \n\n        \n          \n                 end \n        \n\n        \n          \n               end \n        \n\n        \n          \n            \n        \n\n        \n          \n               key.certRequests.each do |cert_request| \n        \n\n        \n          \n                 if client_id.memberEquals(cert_request.memberId) \n        \n\n        \n          \n                   audit_log_data[:certRequestIds] << cert_request.id \n        \n\n        \n          \n            \n        \n\n        \n          \n                   SignerProxy::deleteCertRequest(cert_request.id) \n        \n\n        \n          \n                 end \n        \n\n        \n          \n               end \n        \n\n        \n          \n             end \n        \n\n        \n          \n           end \n        \n    \n  \n\n\nI believe atomic deletion would be close to impossible since delete cert is a signer operation and core classes such as TokenManager, SoftwareTokenWorker and HardwareTokenWorker do not have concepts similar to rollbackable transactions?", "author": "jansu76", "createdAt": "2020-03-10T13:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI0Mjg2Ng=="}], "type": "inlineReview"}, {"oid": "331a4e6875eb2591ee1183f25c8b5fc50a525e74", "url": "https://github.com/nordic-institute/X-Road/commit/331a4e6875eb2591ee1183f25c8b5fc50a525e74", "message": "XRDDEV-866 update javadocs based on PR comments", "committedDate": "2020-03-10T13:14:18Z", "type": "commit"}, {"oid": "b38404afe9cba108dd6dcbe875026dc669158131", "url": "https://github.com/nordic-institute/X-Road/commit/b38404afe9cba108dd6dcbe875026dc669158131", "message": "Merge branch 'develop' into XRDDEV-866-delete-client", "committedDate": "2020-03-11T10:19:35Z", "type": "commit"}]}