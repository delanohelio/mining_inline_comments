{"pr_number": 2034, "pr_title": "Backport \"HBASE-24625 AsyncFSWAL.getLogFileSizeIfBeingWritten does not return the expected synced file length. (#1970)\" to branch-2", "pr_createdAt": "2020-07-07T13:19:28Z", "pr_url": "https://github.com/apache/hbase/pull/2034", "timeline": [{"oid": "992e4c13191fcc909d6421ed96dd534b0041acf2", "url": "https://github.com/apache/hbase/commit/992e4c13191fcc909d6421ed96dd534b0041acf2", "message": "HBASE-24625", "committedDate": "2020-07-07T13:15:56Z", "type": "commit"}, {"oid": "b00cf398e22badbc287acac076dad00f808eb6cd", "url": "https://github.com/apache/hbase/commit/b00cf398e22badbc287acac076dad00f808eb6cd", "message": "make closeWriter consistent with master.", "committedDate": "2020-07-07T14:45:04Z", "type": "commit"}, {"oid": "2d0de8ab89792b5018fdc1d93ea2a5fc7ec5eb61", "url": "https://github.com/apache/hbase/commit/2d0de8ab89792b5018fdc1d93ea2a5fc7ec5eb61", "message": "Merge remote-tracking branch 'upstream/branch-2' into branch-2", "committedDate": "2020-07-08T03:18:28Z", "type": "commit"}, {"oid": "7c54c7262b300918a5b7da32a167781c1a21cb19", "url": "https://github.com/apache/hbase/commit/7c54c7262b300918a5b7da32a167781c1a21cb19", "message": "Merge remote-tracking branch 'upstream/branch-2' into branch-2", "committedDate": "2020-07-09T03:11:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUyOTg2OQ==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r452529869", "bodyText": "I had asked in #1970 if this can be implemented with an AtomicLong instead. @Apache9 responded with an analysis and alternative suggestion. Following his suggestion, it would be nice to add a comment on WrapperAsyncFSOutput stating that we expect an instance to be used only from a single thread, foregoing synchronization for the sake of performance.", "author": "ndimiduk", "createdAt": "2020-07-09T22:44:55Z", "path": "hbase-asyncfs/src/main/java/org/apache/hadoop/hbase/io/asyncfs/WrapperAsyncFSOutput.java", "diffHunk": "@@ -91,7 +93,11 @@ private void flush0(CompletableFuture<Long> future, ByteArrayOutputStream buffer\n           out.hflush();\n         }\n       }\n-      future.complete(out.getPos());\n+      long pos = out.getPos();\n+      if(pos > this.syncedLength) {", "originalCommit": "7c54c7262b300918a5b7da32a167781c1a21cb19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYyMDU2Ng==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r452620566", "bodyText": "Yes, I agree with you, and even the 'if(pos > this.syncedLength) {' could be removed as @Apache9  suggested, but the current PR is backport ,so we'd better keep it in sync with the one applied to master.After this PR is applied to 2.x, I would open another addnum PR for both master and 2.x to incorporate your suggestions.", "author": "comnetwork", "createdAt": "2020-07-10T04:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUyOTg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzMDI4Ng==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r452530286", "bodyText": "nit: this is unnecessary.", "author": "ndimiduk", "createdAt": "2020-07-09T22:46:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -231,4 +231,9 @@ protected long writeWALTrailerAndMagic(WALTrailer trailer, byte[] magic) throws\n   protected OutputStream getOutputStreamForCellEncoder() {\n     return asyncOutputWrapper;\n   }\n+\n+  @Override\n+  public long getSyncedLength() {\n+    return this.output.getSyncedLength();", "originalCommit": "7c54c7262b300918a5b7da32a167781c1a21cb19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYyMDk0OA==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r452620948", "bodyText": "Just as above mentioned, because  current PR is backport, after this PR is applied to 2.x, I would open another addnum PR for both master and 2.x to incorporate your suggestions.", "author": "comnetwork", "createdAt": "2020-07-10T04:52:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzMDI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5NDg3MQ==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r452994871", "bodyText": "Yep, understood. Thanks.", "author": "ndimiduk", "createdAt": "2020-07-10T18:05:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzMDI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzMTE3NA==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r452531174", "bodyText": "I believe I mentioned elsewhere that I think AtomicUtils.updateMax can be replaced with AtomicLong.getAndAccumulate, something like\nsyncedLength.getAndAccumulate(fsdos.getPos(), Math::max)", "author": "ndimiduk", "createdAt": "2020-07-09T22:49:04Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/ProtobufLogWriter.java", "diffHunk": "@@ -85,6 +90,12 @@ public void sync(boolean forceSync) throws IOException {\n     } else {\n       fsdos.hflush();\n     }\n+    AtomicUtils.updateMax(this.syncedLength, fsdos.getPos());", "originalCommit": "7c54c7262b300918a5b7da32a167781c1a21cb19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwMjkwMA==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r452602900", "bodyText": "Good. Anyway I think this could be another issue to just remove the AtomicUtils class? The current PR is backport so we'd better keep it in sync with the one applied to master.", "author": "Apache9", "createdAt": "2020-07-10T03:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzMTE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0NzEzOA==", "url": "https://github.com/apache/hbase/pull/2034#discussion_r459047138", "bodyText": "@Apache9 I read your later comments about keeping AtomicUtils because the built-in AtomicLong does not provide the short-circuit semantics you have implemented there. Sorry, I cannot find that thread to reply there. I dug around and don't see any intrinsics in the JVM that would implement this for us, so I agree with keeping our implementation.", "author": "ndimiduk", "createdAt": "2020-07-22T19:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzMTE3NA=="}], "type": "inlineReview"}]}