{"pr_number": 1379, "pr_title": "HBASE-24077 When encounter RowTooBigException, log the row info.", "pr_createdAt": "2020-03-30T07:35:00Z", "pr_url": "https://github.com/apache/hbase/pull/1379", "timeline": [{"oid": "78123a18bfa74fb42cbab60d8d530eb5623ea3df", "url": "https://github.com/apache/hbase/commit/78123a18bfa74fb42cbab60d8d530eb5623ea3df", "message": "HBASE-24077 When encounter RowTooBigException, log the row info.", "committedDate": "2020-03-30T07:34:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r399991972", "bodyText": "Should we use LOG.warn or error here? Also, with variable params replacing + var + with {} and argument?", "author": "virajjasani", "createdAt": "2020-03-30T07:53:08Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java", "diffHunk": "@@ -635,8 +635,12 @@ public boolean next(List<Cell> outResult, ScannerContext scannerContext) throws\n             scannerContext.incrementBatchProgress(1);\n \n             if (matcher.isUserScan() && totalBytesRead > maxRowSize) {\n-              throw new RowTooBigException(\n-                  \"Max row size allowed: \" + maxRowSize + \", but the row is bigger than that.\");\n+              LOG.info(\"Max row size allowed: \" + maxRowSize\n+                + \", but the row is bigger than that, the row info: \" + CellUtil\n+                .toString(cell, true) + \", already have process row cells = \" + outResult.size());", "originalCommit": "78123a18bfa74fb42cbab60d8d530eb5623ea3df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5NDkwMg==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r399994902", "bodyText": "Is it necessary that we write out the log and throw the exception? With that we potentially have the same log entry twice.  Better would be to only have the exception with the full log message.", "author": "HorizonNet", "createdAt": "2020-03-30T07:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDExNzA4Mw==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400117083", "bodyText": "@virajjasani  Done.", "author": "binlijin", "createdAt": "2020-03-30T11:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyNjQ0MA==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400126440", "bodyText": "For region name, we might need this log. Log is worth for getRegionInfo().getRegionNameAsString(). WDYT @HorizonNet ?", "author": "virajjasani", "createdAt": "2020-03-30T11:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyOTA2MA==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400129060", "bodyText": "@HorizonNet  regionserver log level default is INFO level and do not log the exception, the exception only return to client.", "author": "binlijin", "createdAt": "2020-03-30T11:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEzMDM1Nw==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400130357", "bodyText": "@virajjasani  Yes, already log the regionname in the latest commit.", "author": "binlijin", "createdAt": "2020-03-30T11:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwNjQ5MA==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r402106490", "bodyText": "The exception is not automatically logged?", "author": "HorizonNet", "createdAt": "2020-04-02T07:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExOTcyMQ==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r402119721", "bodyText": "No, the exception is log only when RegionServer change log level to DEBUG/TRACE.", "author": "binlijin", "createdAt": "2020-04-02T07:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcxOTI0NQ==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r403719245", "bodyText": "Ok. Go ahead.", "author": "HorizonNet", "createdAt": "2020-04-05T15:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5MTk3Mg=="}], "type": "inlineReview"}, {"oid": "33ca253cd8f39d29b52e3f2bcc0b39ce4ad12d5d", "url": "https://github.com/apache/hbase/commit/33ca253cd8f39d29b52e3f2bcc0b39ce4ad12d5d", "message": "fix comment", "committedDate": "2020-03-30T11:25:07Z", "type": "commit"}, {"oid": "58c325fbfe4e605e82cf995efa357f59dee4ada4", "url": "https://github.com/apache/hbase/commit/58c325fbfe4e605e82cf995efa357f59dee4ada4", "message": "add region info", "committedDate": "2020-03-30T11:45:49Z", "type": "commit"}, {"oid": "58c325fbfe4e605e82cf995efa357f59dee4ada4", "url": "https://github.com/apache/hbase/commit/58c325fbfe4e605e82cf995efa357f59dee4ada4", "message": "add region info", "committedDate": "2020-03-30T11:45:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTMyMQ==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400269321", "bodyText": "I think the variable substitution ({}) here won't work. Didn't we had a better way for this in exceptions?", "author": "HorizonNet", "createdAt": "2020-03-30T15:10:25Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java", "diffHunk": "@@ -635,8 +635,14 @@ public boolean next(List<Cell> outResult, ScannerContext scannerContext) throws\n             scannerContext.incrementBatchProgress(1);\n \n             if (matcher.isUserScan() && totalBytesRead > maxRowSize) {\n-              throw new RowTooBigException(\n-                  \"Max row size allowed: \" + maxRowSize + \", but the row is bigger than that.\");\n+              LOG.warn(\"Max row size allowed: {}, but the row is bigger than that, the row info: \"\n+                  + \"{}, already have process row cells = {}, it belong to region = {}\",\n+                maxRowSize, CellUtil.toString(cell, true), outResult.size(),\n+                store.getHRegion().getRegionInfo().getRegionNameAsString());\n+              throw new RowTooBigException(\"Max row size allowed: \" + maxRowSize\n+                + \", but the row is bigger than that, the row info: \" + CellUtil\n+                .toString(cell, true) + \", it belong to region = {}\" + store.getHRegion()", "originalCommit": "58c325fbfe4e605e82cf995efa357f59dee4ada4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI3NTI2NQ==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400275265", "bodyText": "Oh yes, it would not work here. It works only for LOG. Looks like recent commit change @binlijin", "author": "virajjasani", "createdAt": "2020-03-30T15:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU4MjIyMA==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400582220", "bodyText": "ok, fix it.", "author": "binlijin", "createdAt": "2020-03-31T01:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTMyMQ=="}], "type": "inlineReview"}, {"oid": "9bc65e1115867289d317891995d7b1ed56bd7b65", "url": "https://github.com/apache/hbase/commit/9bc65e1115867289d317891995d7b1ed56bd7b65", "message": "fix comment", "committedDate": "2020-03-31T01:00:28Z", "type": "commit"}, {"oid": "3364da9b42b5610cb18e28730d452fbc085212a1", "url": "https://github.com/apache/hbase/commit/3364da9b42b5610cb18e28730d452fbc085212a1", "message": "refactor", "committedDate": "2020-04-01T07:30:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQyMjg2Nw==", "url": "https://github.com/apache/hbase/pull/1379#discussion_r400422867", "bodyText": "IMO client data shouldn't be logged at sever side. We can throw RowTooBigException with rowKey.", "author": "pankaj72981", "createdAt": "2020-03-30T18:59:21Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/StoreScanner.java", "diffHunk": "@@ -635,8 +635,14 @@ public boolean next(List<Cell> outResult, ScannerContext scannerContext) throws\n             scannerContext.incrementBatchProgress(1);\n \n             if (matcher.isUserScan() && totalBytesRead > maxRowSize) {\n-              throw new RowTooBigException(\n-                  \"Max row size allowed: \" + maxRowSize + \", but the row is bigger than that.\");\n+              LOG.warn(\"Max row size allowed: {}, but the row is bigger than that, the row info: \"\n+                  + \"{}, already have process row cells = {}, it belong to region = {}\",\n+                maxRowSize, CellUtil.toString(cell, true), outResult.size(),", "originalCommit": "58c325fbfe4e605e82cf995efa357f59dee4ada4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}