{"pr_number": 2268, "pr_title": "HBASE-24874 Fix hbase-shell access to ModifiableTableDescriptor methods", "pr_createdAt": "2020-08-17T18:40:25Z", "pr_url": "https://github.com/apache/hbase/pull/2268", "timeline": [{"oid": "323d598ed2184cb16cb604ee6547c51bc3a625e8", "url": "https://github.com/apache/hbase/commit/323d598ed2184cb16cb604ee6547c51bc3a625e8", "message": "HBASE-24874 Fix hbase-shell access to ModifiableTableDescriptor methods\n\n- Fix hbase-shell access in JDK 11 for calls to\n  TableDescriptorBuilder.toCoprocessorDescriptor and\n  ModifiableTableDescriptor.toStringTableAttributes.\n- Allow coprocessors to be specified using a Ruby hash in the hbase-shell alter\n  command and replace usage in the help text. The previous String overload of\n  the alter command will continue to work and is still covered by a unit test,\n  but will no longer be suggested in the alter command help.", "committedDate": "2020-08-17T18:36:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc2NDMxMg==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r471764312", "bodyText": "If you want to do this, please place a fat warning in the docs over on the TableDescriptorBuilder.toCoprocessorDescriptor method.", "author": "ndimiduk", "createdAt": "2020-08-17T20:43:26Z", "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -664,6 +668,40 @@ def alter_status(table_name)\n       puts 'Done.'\n     end\n \n+    #----------------------------------------------------------------------------------------------\n+    # Use our internal logic to convert from \"spec string\" format to a coprocessor descriptor\n+    #\n+    # Provided for backwards shell compatibility\n+    #\n+    # @param [String] spec_str\n+    # @return [ColumnDescriptor]\n+    def coprocessor_descriptor_from_spec_str(spec_str)", "originalCommit": "323d598ed2184cb16cb604ee6547c51bc3a625e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyNTQ3Mw==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r472225473", "bodyText": "Done", "author": "bitoffdev", "createdAt": "2020-08-18T14:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc2NDMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc2NDY3Mw==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r471764673", "bodyText": "should these 'CLASSPATH', 'JAR_PATH', &c. be defined from hbase_constants.rb ?", "author": "ndimiduk", "createdAt": "2020-08-17T20:44:11Z", "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -664,6 +668,40 @@ def alter_status(table_name)\n       puts 'Done.'\n     end\n \n+    #----------------------------------------------------------------------------------------------\n+    # Use our internal logic to convert from \"spec string\" format to a coprocessor descriptor\n+    #\n+    # Provided for backwards shell compatibility\n+    #\n+    # @param [String] spec_str\n+    # @return [ColumnDescriptor]\n+    def coprocessor_descriptor_from_spec_str(spec_str)\n+      method = TableDescriptorBuilder.java_class.declared_method_smart :toCoprocessorDescriptor\n+      method.accessible = true\n+      result = method.invoke(nil, spec_str).to_java\n+      # unpack java's Optional to be more rubonic\n+      return result.isPresent ? result.get : nil\n+    end\n+\n+    #----------------------------------------------------------------------------------------------\n+    # Use CoprocessorDescriptorBuilder to convert a Hash to CoprocessorDescriptor\n+    #\n+    # @param [Hash] spec column descriptor specification\n+    # @return [ColumnDescriptor]\n+    def coprocessor_descriptor_from_hash(spec)\n+      classname = spec['CLASSNAME']", "originalCommit": "323d598ed2184cb16cb604ee6547c51bc3a625e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyMTMyMA==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r472221320", "bodyText": "Makes sense, done", "author": "bitoffdev", "createdAt": "2020-08-18T14:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc2NDY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwNzczNA==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r471907734", "bodyText": "Do you want to say in comment why you are doing this access setting?", "author": "saintstack", "createdAt": "2020-08-18T04:33:08Z", "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -587,7 +588,10 @@ def get_column_families(table_name)\n \n     def get_table_attributes(table_name)\n       tableExists(table_name)\n-      @admin.getDescriptor(TableName.valueOf(table_name)).toStringTableAttributes\n+      td = @admin.getDescriptor TableName.valueOf(table_name)\n+      method = td.java_class.declared_method :toStringTableAttributes\n+      method.accessible = true", "originalCommit": "323d598ed2184cb16cb604ee6547c51bc3a625e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyMTAxOQ==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r472221019", "bodyText": "Added a note... I also left a TODO in case someone else comes along with an idea to makes this better.", "author": "bitoffdev", "createdAt": "2020-08-18T14:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkwNzczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNDIxNQ==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r471914215", "bodyText": "Its ok not checking for nil classname?", "author": "saintstack", "createdAt": "2020-08-18T04:57:52Z", "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -664,6 +668,40 @@ def alter_status(table_name)\n       puts 'Done.'\n     end\n \n+    #----------------------------------------------------------------------------------------------\n+    # Use our internal logic to convert from \"spec string\" format to a coprocessor descriptor\n+    #\n+    # Provided for backwards shell compatibility\n+    #\n+    # @param [String] spec_str\n+    # @return [ColumnDescriptor]\n+    def coprocessor_descriptor_from_spec_str(spec_str)\n+      method = TableDescriptorBuilder.java_class.declared_method_smart :toCoprocessorDescriptor\n+      method.accessible = true\n+      result = method.invoke(nil, spec_str).to_java\n+      # unpack java's Optional to be more rubonic\n+      return result.isPresent ? result.get : nil\n+    end\n+\n+    #----------------------------------------------------------------------------------------------\n+    # Use CoprocessorDescriptorBuilder to convert a Hash to CoprocessorDescriptor\n+    #\n+    # @param [Hash] spec column descriptor specification\n+    # @return [ColumnDescriptor]\n+    def coprocessor_descriptor_from_hash(spec)\n+      classname = spec['CLASSNAME']\n+      jar_path = spec['JAR_PATH']\n+      priority = spec['PRIORITY']\n+      properties = spec['PROPERTIES']\n+\n+      builder = CoprocessorDescriptorBuilder.newBuilder classname", "originalCommit": "323d598ed2184cb16cb604ee6547c51bc3a625e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIyMDMzMw==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r472220333", "bodyText": "Good call, the current NullPointerException isn't super user friendly. I just updated the patch to handle this more user-friendly.", "author": "bitoffdev", "createdAt": "2020-08-18T14:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNDIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNDY1MQ==", "url": "https://github.com/apache/hbase/pull/2268#discussion_r471914651", "bodyText": "nice", "author": "saintstack", "createdAt": "2020-08-18T04:59:40Z", "path": "hbase-shell/src/main/ruby/shell/commands/alter.rb", "diffHunk": "@@ -53,19 +53,19 @@ def help\n \n   hbase> alter 't1', MAX_FILESIZE => '134217728'\n \n-You can add a table coprocessor by setting a table coprocessor attribute:\n+You can add a table coprocessor by setting a table coprocessor attribute. Only the CLASSNAME is\n+required in the coprocessor specification.\n \n-  hbase> alter 't1',\n-    'coprocessor'=>'hdfs:///foo.jar|com.foo.FooRegionObserver|1001|arg1=1,arg2=2'\n+  hbase> alter 't1', 'coprocessor' => {\n+           'CLASSNAME' => 'org.apache.hadoop.hbase.coprocessor.SimpleRegionObserver',\n+           'JAR_PATH' => 'hdfs:///foo.jar'\n+           'PRIORITY' => 12,\n+           'PROPERTIES' => {'a' => '17' }", "originalCommit": "323d598ed2184cb16cb604ee6547c51bc3a625e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0b68b727178e34f76268ca93f19e8fc0c0e755b", "url": "https://github.com/apache/hbase/commit/b0b68b727178e34f76268ca93f19e8fc0c0e755b", "message": "Update patch\n\n- Add warning over toCoprocessorDescriptor noting the usage by hbase-shell\n- Add constants to hbase_constants for coprocessor specification\n- Document usage of ModifiableTableDescriptor.toStringTableAttributes", "committedDate": "2020-08-18T13:55:38Z", "type": "commit"}, {"oid": "e82fa5b4fa0a05f91314721b218abe960abecd9a", "url": "https://github.com/apache/hbase/commit/e82fa5b4fa0a05f91314721b218abe960abecd9a", "message": "Convert comment over toCoprocessorDescriptor into docstring", "committedDate": "2020-08-18T14:07:55Z", "type": "commit"}]}