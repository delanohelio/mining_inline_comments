{"pr_number": 1986, "pr_title": "HBASE-24581 Skip compaction request/check for replica regions at the \u2026", "pr_createdAt": "2020-06-26T18:41:13Z", "pr_url": "https://github.com/apache/hbase/pull/1986", "timeline": [{"oid": "168102f3c09d85cba441ac8247de427626d8954d", "url": "https://github.com/apache/hbase/commit/168102f3c09d85cba441ac8247de427626d8954d", "message": "HBASE-24581 Skip compaction request/check for replica regions at the early stage.", "committedDate": "2020-06-27T15:05:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r446586506", "bodyText": "Why this change?", "author": "infraio", "createdAt": "2020-06-28T01:20:21Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,7 +109,7 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "originalCommit": "168102f3c09d85cba441ac8247de427626d8954d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMTQ0MA==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r447101440", "bodyText": "Splitting with key \"1\" does not split hfiles. With \"d\", hfiles will be split as well.", "author": "huaxiangsun", "createdAt": "2020-06-29T16:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMTk0NQ==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r448111945", "bodyText": "can we add some assertions that the hfile split has happened?", "author": "busbey", "createdAt": "2020-07-01T04:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5NDM5NA==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r448694394", "bodyText": "The latest patch addresses it, it now makes sure that every region has some hfiles (including the split daughter regions).", "author": "huaxiangsun", "createdAt": "2020-07-02T01:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg=="}], "type": "inlineReview"}, {"oid": "518c97bfff2f9d582c7a9907bda5da9ee61fe102", "url": "https://github.com/apache/hbase/commit/518c97bfff2f9d582c7a9907bda5da9ee61fe102", "message": "HBASE-24581 Skip compaction request/check for replica regions at the early stage.", "committedDate": "2020-07-02T01:10:25Z", "type": "commit"}, {"oid": "518c97bfff2f9d582c7a9907bda5da9ee61fe102", "url": "https://github.com/apache/hbase/commit/518c97bfff2f9d582c7a9907bda5da9ee61fe102", "message": "HBASE-24581 Skip compaction request/check for replica regions at the early stage.", "committedDate": "2020-07-02T01:10:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MjY1Ng==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r451072656", "bodyText": "Can we have a test to verify we don't split meta/read-only region?", "author": "clarax", "createdAt": "2020-07-07T18:48:44Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,11 +112,16 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "originalCommit": "518c97bfff2f9d582c7a9907bda5da9ee61fe102", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTc1Ng==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r451179756", "bodyText": "Thanks Clara. Meta region is not supposed to be split (as split meta support yet). As for normal table replica/read-only regions, once the primary region is split, the read-only regions are supposed to be split as well. Do you mean something else?", "author": "huaxiangsun", "createdAt": "2020-07-07T22:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MjY1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2Mzc1OQ==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r452463759", "bodyText": "I was referring to the check you put in and a test to validate. Thank you for the explanation.", "author": "clarax", "createdAt": "2020-07-09T20:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MjY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1NzY1OQ==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r452557659", "bodyText": "Why do you expect there to be data in all stores?", "author": "ndimiduk", "createdAt": "2020-07-10T00:17:57Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,11 +112,16 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));\n       int count = 0;\n       while (true) {\n         for (RegionServerThread rs : HTU.getMiniHBaseCluster().getRegionServerThreads()) {\n           for (Region r : rs.getRegionServer().getRegions(table.getName())) {\n+            // Make sure that every region has some data (even for split daughter regions).\n+            if (RegionReplicaUtil.isDefaultReplica(r.getRegionInfo())) {\n+              assertTrue(r.getStore(f).hasReferences() ||", "originalCommit": "518c97bfff2f9d582c7a9907bda5da9ee61fe102", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2Nzc1Nw==", "url": "https://github.com/apache/hbase/pull/1986#discussion_r453767757", "bodyText": "That is per @busbey 's comments regarding with updating the split point, I think it is ok to make sure that after the split point change, every daughter region has some data, so coming up the assert. Since replica regions has some delay to map the data, the assert only makes sure that the primary(default) region gets data.", "author": "huaxiangsun", "createdAt": "2020-07-13T16:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1NzY1OQ=="}], "type": "inlineReview"}]}