{"pr_number": 1511, "pr_title": "HBASE-24139 : Balancer should avoid leaving idle region servers", "pr_createdAt": "2020-04-14T15:21:39Z", "pr_url": "https://github.com/apache/hbase/pull/1511", "timeline": [{"oid": "be746692ce33ad1e655d7c898717b0c84a7a4c34", "url": "https://github.com/apache/hbase/commit/be746692ce33ad1e655d7c898717b0c84a7a4c34", "message": "first try at HBASE-24139", "committedDate": "2020-04-14T13:26:30Z", "type": "commit"}, {"oid": "9792db7c8aee0c7246f970971d9b58aadc822462", "url": "https://github.com/apache/hbase/commit/9792db7c8aee0c7246f970971d9b58aadc822462", "message": "second try", "committedDate": "2020-04-14T14:54:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MzQ4MA==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r408283480", "bodyText": "How about putting this method in BaseLoadBalancer as protected final ?", "author": "virajjasani", "createdAt": "2020-04-14T16:45:28Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/StochasticLoadBalancer.java", "diffHunk": "@@ -310,6 +310,19 @@ protected synchronized boolean areSomeRegionReplicasColocated(Cluster c) {\n     return false;\n   }\n \n+  private synchronized boolean areThereIdleRegions(Cluster c){", "originalCommit": "9792db7c8aee0c7246f970971d9b58aadc822462", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4NDAyMA==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r408284020", "bodyText": "Also, idleRegionsExist() might be better name", "author": "virajjasani", "createdAt": "2020-04-14T16:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxNTIyMQ==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r408615221", "bodyText": "Here it checks the status of RS.  The name areThereIdleRegions not making good meaning", "author": "anoopsjohn", "createdAt": "2020-04-15T06:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY0MTAxNw==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r408641017", "bodyText": "Yeah, it could be something similar to idleRSPresent() maybe", "author": "virajjasani", "createdAt": "2020-04-15T07:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1MTk3NQ==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r408751975", "bodyText": "thanks!", "author": "bea0113", "createdAt": "2020-04-15T10:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MzQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxNzAxMw==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r408617013", "bodyText": "This is iterating over many data structures and complex. Why cant we just iterate over the regionsPerServer data structure alone and populate the booleans as needed?", "author": "anoopsjohn", "createdAt": "2020-04-15T06:49:57Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/StochasticLoadBalancer.java", "diffHunk": "@@ -310,6 +310,19 @@ protected synchronized boolean areSomeRegionReplicasColocated(Cluster c) {\n     return false;\n   }\n \n+  private synchronized boolean areThereIdleRegions(Cluster c){\n+    boolean isServerExistsWithMoreRegions=false;\n+    boolean isServerExistsWithZeroRegions=false;\n+    for (ServerName server:c.servers){", "originalCommit": "9792db7c8aee0c7246f970971d9b58aadc822462", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1MTQzMw==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r408751433", "bodyText": "thanks, that was an idea as well, but I wasn't sure about it, I'll fix it", "author": "bea0113", "createdAt": "2020-04-15T10:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxNzAxMw=="}], "type": "inlineReview"}, {"oid": "0676cb7452ec22a2eba8e94581daf263d955d99b", "url": "https://github.com/apache/hbase/commit/0676cb7452ec22a2eba8e94581daf263d955d99b", "message": "addressing comments on PR", "committedDate": "2020-04-15T07:36:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA3MjMzOA==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r409072338", "bodyText": "please use {} around the body of if blocks.", "author": "busbey", "createdAt": "2020-04-15T19:10:18Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/StochasticLoadBalancer.java", "diffHunk": "@@ -310,6 +310,18 @@ protected synchronized boolean areSomeRegionReplicasColocated(Cluster c) {\n     return false;\n   }\n \n+  protected final synchronized boolean idleRegionExist(Cluster c){\n+    boolean isServerExistsWithMoreRegions = false;\n+    boolean isServerExistsWithZeroRegions = false;\n+    for (int[] serverList: c.regionsPerServer){\n+      if (serverList.length > 1)", "originalCommit": "0676cb7452ec22a2eba8e94581daf263d955d99b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "181015d5793362acbfd4a134c6653d032ed2e902", "url": "https://github.com/apache/hbase/commit/181015d5793362acbfd4a134c6653d032ed2e902", "message": "Addressing PR comments 2", "committedDate": "2020-04-16T13:43:44Z", "type": "commit"}, {"oid": "2ab34695307087966bd4e6c14b1c2adf69c86f0a", "url": "https://github.com/apache/hbase/commit/2ab34695307087966bd4e6c14b1c2adf69c86f0a", "message": "modified unit test", "committedDate": "2020-04-16T13:51:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzMDE0MQ==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r409630141", "bodyText": "please use { } for the statement.", "author": "virajjasani", "createdAt": "2020-04-16T15:04:04Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1192,6 +1192,8 @@ protected boolean needsBalance(TableName tableName, Cluster c) {\n       return false;\n     }\n     if(areSomeRegionReplicasColocated(c)) return true;\n+    if(idleRegionExist(c)) return true;", "originalCommit": "2ab34695307087966bd4e6c14b1c2adf69c86f0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzMDg2OQ==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r409630869", "bodyText": "nit: this can be serverList.length == 0", "author": "virajjasani", "createdAt": "2020-04-16T15:05:01Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1223,6 +1225,20 @@ protected boolean areSomeRegionReplicasColocated(Cluster c) {\n     return false;\n   }\n \n+  protected final synchronized boolean idleRegionExist(Cluster c){\n+    boolean isServerExistsWithMoreRegions = false;\n+    boolean isServerExistsWithZeroRegions = false;\n+    for (int[] serverList: c.regionsPerServer){\n+      if (serverList.length > 1) {\n+        isServerExistsWithMoreRegions = true;\n+      }\n+      if (serverList.length < 1) {", "originalCommit": "2ab34695307087966bd4e6c14b1c2adf69c86f0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxODg1OA==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r409718858", "bodyText": "Thank you!", "author": "bea0113", "createdAt": "2020-04-16T17:14:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzMDg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzMTQ0Mg==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r409631442", "bodyText": "please remove these extra lines", "author": "virajjasani", "createdAt": "2020-04-16T15:05:50Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/StochasticLoadBalancer.java", "diffHunk": "@@ -310,6 +310,8 @@ protected synchronized boolean areSomeRegionReplicasColocated(Cluster c) {\n     return false;\n   }\n \n+\n+", "originalCommit": "2ab34695307087966bd4e6c14b1c2adf69c86f0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c17130127ea23e22382198908b0760b3b372101", "url": "https://github.com/apache/hbase/commit/7c17130127ea23e22382198908b0760b3b372101", "message": "fixing nits", "committedDate": "2020-04-16T17:13:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc1NDk0OQ==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r409754949", "bodyText": "idleRegionExist => idleRegionServerExist would be a better fit since we are checking if any RS is idle (without regions).", "author": "virajjasani", "createdAt": "2020-04-16T18:13:17Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1223,6 +1227,20 @@ protected boolean areSomeRegionReplicasColocated(Cluster c) {\n     return false;\n   }\n \n+  protected final synchronized boolean idleRegionExist(Cluster c){", "originalCommit": "7c17130127ea23e22382198908b0760b3b372101", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MzY0NA==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r409793644", "bodyText": "why is this synchronized?", "author": "busbey", "createdAt": "2020-04-16T19:21:27Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1223,6 +1227,20 @@ protected boolean areSomeRegionReplicasColocated(Cluster c) {\n     return false;\n   }\n \n+  protected final synchronized boolean idleRegionExist(Cluster c){", "originalCommit": "7c17130127ea23e22382198908b0760b3b372101", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MTk3NA==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r411561974", "bodyText": "Hmm, as part of HBASE-12559, many methods that are overridden in StochasticLoadBalancer are made synchronized due to findbugs warnings. I was surprised to see all these methods non-synchronized in parent and synchronized in child class.", "author": "virajjasani", "createdAt": "2020-04-20T17:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MzY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE3ODU2Ng==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r412178566", "bodyText": "Yes, I've got a bit confused about this, and as I've originally put this in StochasticLoadBalancer, I thought it it would work there as well.\nShould I remove the synchronised?", "author": "bea0113", "createdAt": "2020-04-21T13:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MzY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM2NTkwOA==", "url": "https://github.com/apache/hbase/pull/1511#discussion_r412365908", "bodyText": "You have already removed synchronized and it's fine to do so, anyways method is now in BaseLoadBalancer.", "author": "virajjasani", "createdAt": "2020-04-21T17:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MzY0NA=="}], "type": "inlineReview"}, {"oid": "b764536c35e857cd1ea636ce224e71ce3988d8c6", "url": "https://github.com/apache/hbase/commit/b764536c35e857cd1ea636ce224e71ce3988d8c6", "message": "fixes addressing the comments on PR", "committedDate": "2020-04-20T07:00:29Z", "type": "commit"}]}