{"pr_number": 1222, "pr_title": "HBASE-23868 : Replace usages of HColumnDescriptor(byte [] familyName)\u2026", "pr_createdAt": "2020-02-28T10:53:14Z", "pr_url": "https://github.com/apache/hbase/pull/1222", "timeline": [{"oid": "e95ed0a7a910f5ac3d50b0fd5f2cb0185cfada37", "url": "https://github.com/apache/hbase/commit/e95ed0a7a910f5ac3d50b0fd5f2cb0185cfada37", "message": "HBASE-23868 : Replace usages of HColumnDescriptor(byte [] familyName) with builder pattern", "committedDate": "2020-02-28T10:48:03Z", "type": "commit"}, {"oid": "de3df6e89f214dd71d2936c9cf7f0a1f09fc092d", "url": "https://github.com/apache/hbase/commit/de3df6e89f214dd71d2936c9cf7f0a1f09fc092d", "message": "Merge branch 'master' of github.com:apache/hbase into HBASE-23868-master", "committedDate": "2020-02-28T15:40:25Z", "type": "commit"}, {"oid": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "url": "https://github.com/apache/hbase/commit/45c9e1d6ae69614ffab24384dfe1b20793355ef2", "message": "checkstyle and unit test fix", "committedDate": "2020-02-28T16:18:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2MjQzMQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385962431", "bodyText": "Why do you remove the empty lines? Because of the method length? I think they help increase the readability.", "author": "HorizonNet", "createdAt": "2020-02-28T23:06:13Z", "path": "hbase-backup/src/test/java/org/apache/hadoop/hbase/backup/TestIncrementalBackup.java", "diffHunk": "@@ -105,15 +107,13 @@ public void TestIncBackupRestore() throws Exception {\n       Assert.assertEquals(HBaseTestingUtility.countRows(t1),\n               NB_ROWS_IN_BATCH + ADD_ROWS + NB_ROWS_FAM3);\n       LOG.debug(\"written \" + ADD_ROWS + \" rows to \" + table1);\n-", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwNTUzMQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r386005531", "bodyText": "Oh this is because, checkstyle complained about >150 lines in this method. I didn't want to remove it :)", "author": "virajjasani", "createdAt": "2020-02-29T06:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2MjQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjExODc0MA==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r386118740", "bodyText": "Is this fine?", "author": "virajjasani", "createdAt": "2020-03-01T15:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2MjQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2MzYzNQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385963635", "bodyText": "Better would be to use the fluent API, also for other occurrences in this test class.", "author": "HorizonNet", "createdAt": "2020-02-28T23:11:29Z", "path": "hbase-client/src/test/java/org/apache/hadoop/hbase/TestHTableDescriptor.java", "diffHunk": "@@ -309,41 +312,52 @@ public void testClassMethodsAreBuilderStyle() {\n \n   @Test\n   public void testModifyFamily() {\n-    HTableDescriptor htd = new HTableDescriptor(TableName.valueOf(name.getMethodName()));\n+    TableDescriptorBuilder.ModifyableTableDescriptor tableDescriptor =\n+      new TableDescriptorBuilder.ModifyableTableDescriptor(\n+        TableName.valueOf(name.getMethodName()));\n     byte[] familyName = Bytes.toBytes(\"cf\");\n-    HColumnDescriptor hcd = new HColumnDescriptor(familyName);\n-    hcd.setBlocksize(1000);\n-    hcd.setDFSReplication((short) 3);\n-    htd.addFamily(hcd);\n-    assertEquals(1000, htd.getFamily(familyName).getBlocksize());\n-    assertEquals(3, htd.getFamily(familyName).getDFSReplication());\n-    hcd = new HColumnDescriptor(familyName);\n-    hcd.setBlocksize(2000);\n-    hcd.setDFSReplication((short) 1);\n-    htd.modifyFamily(hcd);\n-    assertEquals(2000, htd.getFamily(familyName).getBlocksize());\n-    assertEquals(1, htd.getFamily(familyName).getDFSReplication());\n+    ColumnFamilyDescriptorBuilder.ModifyableColumnFamilyDescriptor familyDescriptor =\n+      new ColumnFamilyDescriptorBuilder.ModifyableColumnFamilyDescriptor(familyName);\n+    familyDescriptor.setBlocksize(1000);", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3NzE1OA==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385977158", "bodyText": "Use a Javadoc link for TableDescriptorBuilder.ModifyableTableDescriptor.", "author": "HorizonNet", "createdAt": "2020-02-29T00:12:23Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/constraint/Constraints.java", "diffHunk": "@@ -203,6 +230,38 @@ public static void add(HTableDescriptor desc,\n     updateLatestPriority(desc, priority);\n   }\n \n+  /**\n+   * Add configuration-less constraints to the table.\n+   * <p>\n+   * This will overwrite any configuration associated with the previous\n+   * constraint of the same class.\n+   * <p>\n+   * Each constraint, when added to the table, will have a specific priority,\n+   * dictating the order in which the {@link Constraint} will be run. A\n+   * {@link Constraint} earlier in the list will be run before those later in\n+   * the list. The same logic applies between two Constraints over time (earlier\n+   * added is run first on the regionserver).\n+   *\n+   * @param tableDescriptor TableDescriptorBuilder.ModifyableTableDescriptor", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwNjA0MQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r386006041", "bodyText": "Unfortunately, it's not working somehow. This is the error I get: warning - Tag @link: reference not found: TableDescriptorBuilder.ModifyableTableDescriptor\nFYI https://builds.apache.org/job/HBase-PreCommit-GitHub-PR/job/PR-1222/1/artifact/out/diff-javadoc-javadoc-hbase-server.txt", "author": "virajjasani", "createdAt": "2020-02-29T06:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3NzE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI1NzIyMQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r386257221", "bodyText": "Ah, then we're running into the Javadoc bug we had a few times already.", "author": "HorizonNet", "createdAt": "2020-03-02T08:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3NzE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3NzIzMg==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385977232", "bodyText": "Contains a link to Constraints twice.", "author": "HorizonNet", "createdAt": "2020-02-29T00:12:43Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/constraint/Constraints.java", "diffHunk": "@@ -203,6 +230,38 @@ public static void add(HTableDescriptor desc,\n     updateLatestPriority(desc, priority);\n   }\n \n+  /**\n+   * Add configuration-less constraints to the table.\n+   * <p>\n+   * This will overwrite any configuration associated with the previous\n+   * constraint of the same class.\n+   * <p>\n+   * Each constraint, when added to the table, will have a specific priority,\n+   * dictating the order in which the {@link Constraint} will be run. A\n+   * {@link Constraint} earlier in the list will be run before those later in\n+   * the list. The same logic applies between two Constraints over time (earlier\n+   * added is run first on the regionserver).\n+   *\n+   * @param tableDescriptor TableDescriptorBuilder.ModifyableTableDescriptor\n+   *   to add {@link Constraint Constraints}", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3NzI2MQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385977261", "bodyText": "Ditto.", "author": "HorizonNet", "createdAt": "2020-02-29T00:12:51Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/constraint/Constraints.java", "diffHunk": "@@ -203,6 +230,38 @@ public static void add(HTableDescriptor desc,\n     updateLatestPriority(desc, priority);\n   }\n \n+  /**\n+   * Add configuration-less constraints to the table.\n+   * <p>\n+   * This will overwrite any configuration associated with the previous\n+   * constraint of the same class.\n+   * <p>\n+   * Each constraint, when added to the table, will have a specific priority,\n+   * dictating the order in which the {@link Constraint} will be run. A\n+   * {@link Constraint} earlier in the list will be run before those later in\n+   * the list. The same logic applies between two Constraints over time (earlier\n+   * added is run first on the regionserver).\n+   *\n+   * @param tableDescriptor TableDescriptorBuilder.ModifyableTableDescriptor\n+   *   to add {@link Constraint Constraints}\n+   * @param constraints {@link Constraint Constraints} to add. All constraints are", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk3NzM2NA==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385977364", "bodyText": "NIT: Should have the same indentation as the line before.", "author": "HorizonNet", "createdAt": "2020-02-29T00:13:27Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/constraint/Constraints.java", "diffHunk": "@@ -337,6 +396,13 @@ private static void writeConstraint(HTableDescriptor desc, String key,\n     desc.setValue(key, serializeConfiguration(conf));\n   }\n \n+  private static void writeConstraint(\n+      TableDescriptorBuilder.ModifyableTableDescriptor tableDescriptor, String key,\n+    Configuration conf) throws IOException {", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4Mjg5Nw==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385982897", "bodyText": "The comment should be above the line with setting the cache.", "author": "HorizonNet", "createdAt": "2020-02-29T00:47:22Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/security/visibility/VisibilityController.java", "diffHunk": "@@ -210,18 +211,21 @@ public void stop(CoprocessorEnvironment env) throws IOException {\n   public void postStartMaster(ObserverContext<MasterCoprocessorEnvironment> ctx) throws IOException {\n     // Need to create the new system table for labels here\n     if (!MetaTableAccessor.tableExists(ctx.getEnvironment().getConnection(), LABELS_TABLE_NAME)) {\n-      HTableDescriptor labelsTable = new HTableDescriptor(LABELS_TABLE_NAME);\n-      HColumnDescriptor labelsColumn = new HColumnDescriptor(LABELS_TABLE_FAMILY);\n-      labelsColumn.setBloomFilterType(BloomType.NONE);\n-      labelsColumn.setBlockCacheEnabled(false); // We will cache all the labels. No need of normal\n-                                                 // table block cache.\n-      labelsTable.addFamily(labelsColumn);\n+      TableDescriptorBuilder.ModifyableTableDescriptor tableDescriptor =\n+        new TableDescriptorBuilder.ModifyableTableDescriptor(LABELS_TABLE_NAME);\n+      ColumnFamilyDescriptorBuilder.ModifyableColumnFamilyDescriptor familyDescriptor =\n+        new ColumnFamilyDescriptorBuilder.ModifyableColumnFamilyDescriptor(LABELS_TABLE_FAMILY);\n+      familyDescriptor.setBloomFilterType(BloomType.NONE);\n+      familyDescriptor.setBlockCacheEnabled(false);\n+      // We will cache all the labels. No need of normal", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjExODg5OA==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r386118898", "bodyText": "Done", "author": "virajjasani", "createdAt": "2020-03-01T15:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4Mjg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4Mjk5NA==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385982994", "bodyText": "Use a link for createNewHRegion.", "author": "HorizonNet", "createdAt": "2020-02-29T00:48:04Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestCase.java", "diffHunk": "@@ -151,23 +154,23 @@ protected Path getUnitTestdir(String testName) {\n   /**\n    * You must call close on the returned region and then close on the log file it created. Do\n    * {@link HBaseTestingUtility#closeRegionAndWAL(HRegion)} to close both the region and the WAL.\n-   * @param desc\n-   * @param startKey\n-   * @param endKey\n+   * @param tableDescriptor TableDescriptor\n+   * @param startKey Start Key\n+   * @param endKey End Key\n    * @return An {@link HRegion}\n-   * @throws IOException\n+   * @throws IOException If thrown by createNewHRegion", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4NzcxNQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385987715", "bodyText": "Why admin2 as the parameter name?", "author": "HorizonNet", "createdAt": "2020-02-29T01:26:02Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/mob/TestMobCompactionOptRegionBatchMode.java", "diffHunk": "@@ -76,6 +76,13 @@ protected void initConf() {\n     conf.setLong(MobConstants.MOB_COMPACTION_MAX_FILE_SIZE_KEY, 1000000);\n   }\n \n+  @Override\n+  protected void mobCompact(Admin admin2, TableDescriptor tableDescriptor,", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4NzczOA==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385987738", "bodyText": "Ditto.", "author": "HorizonNet", "createdAt": "2020-02-29T01:26:19Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/mob/TestMobCompactionRegularMode.java", "diffHunk": "@@ -57,6 +57,13 @@\n   public TestMobCompactionRegularMode() {\n   }\n \n+  @Override\n+  protected void mobCompact(Admin admin2, TableDescriptor tableDescriptor,", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4OTgyNQ==", "url": "https://github.com/apache/hbase/pull/1222#discussion_r385989825", "bodyText": "Also remove the commented out lines when already on it?", "author": "HorizonNet", "createdAt": "2020-02-29T01:46:39Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestTags.java", "diffHunk": "@@ -184,14 +186,16 @@ public void testFlushAndCompactionWithoutTags() throws Exception {\n \n       byte[] row2 = Bytes.toBytes(\"rowc\");\n \n-      HTableDescriptor desc = new HTableDescriptor(tableName);\n-      HColumnDescriptor colDesc = new HColumnDescriptor(fam);\n-      colDesc.setBlockCacheEnabled(true);\n+      TableDescriptorBuilder.ModifyableTableDescriptor tableDescriptor =\n+        new TableDescriptorBuilder.ModifyableTableDescriptor(tableName);\n+      ColumnFamilyDescriptorBuilder.ModifyableColumnFamilyDescriptor familyDescriptor =\n+        new ColumnFamilyDescriptorBuilder.ModifyableColumnFamilyDescriptor(fam);\n+      familyDescriptor.setBlockCacheEnabled(true);\n       // colDesc.setDataBlockEncoding(DataBlockEncoding.NONE);", "originalCommit": "45c9e1d6ae69614ffab24384dfe1b20793355ef2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0623b9d30e44866779529c2a60384d360eb69b3", "url": "https://github.com/apache/hbase/commit/d0623b9d30e44866779529c2a60384d360eb69b3", "message": "Merge branch 'master' of github.com:apache/hbase into HBASE-23868-master", "committedDate": "2020-02-29T06:10:03Z", "type": "commit"}, {"oid": "70dfaf87b658ad68a7c60422b2ddcc89988519bd", "url": "https://github.com/apache/hbase/commit/70dfaf87b658ad68a7c60422b2ddcc89988519bd", "message": "review changes", "committedDate": "2020-02-29T07:15:12Z", "type": "commit"}, {"oid": "f5e6619d0b44bad654b9e4ccf42adc70e519ddc6", "url": "https://github.com/apache/hbase/commit/f5e6619d0b44bad654b9e4ccf42adc70e519ddc6", "message": "Merge branch 'master' of github.com:apache/hbase into HBASE-23868-master", "committedDate": "2020-03-01T12:26:28Z", "type": "commit"}]}