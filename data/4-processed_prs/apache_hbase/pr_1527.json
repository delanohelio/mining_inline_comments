{"pr_number": 1527, "pr_title": "HBASE-24143 [JDK11] Switch default garbage collector from CMS", "pr_createdAt": "2020-04-15T23:33:54Z", "pr_url": "https://github.com/apache/hbase/pull/1527", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTA4Ng==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r409309086", "bodyText": "This in jdk8 too?", "author": "saintstack", "createdAt": "2020-04-16T06:23:05Z", "path": "bin/hbase-config.sh", "diffHunk": "@@ -168,3 +168,27 @@ if [ -z \"$JAVA_HOME\" ]; then\n EOF\n     exit 1\n fi\n+\n+function read_java_version() {\n+  properties=\"$(\"${JAVA_HOME}/bin/java\" -XshowSettings:properties -version 2>&1)\"", "originalCommit": "0fde2bfc66d2e6572939381af292fabbacd1d631", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY3NjkzNQ==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r409676935", "bodyText": "It's there for everything I have installed. Granted they're all openjdk variants, and mostly adopt-openjdk packages.\n$ JAVA_HOME=/Library/Java/JavaVirtualMachines/zulu-7.jdk/Contents/Home java -XshowSettings:properties -version 2>&1 | grep java.runtime.version\n    java.runtime.version = 1.7.0_232-b6\n$ JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home java -XshowSettings:properties -version 2>&1 | grep java.runtime.version\n    java.runtime.version = 1.8.0_222-b10\n$ JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-9.jdk/Contents/Home java -XshowSettings:properties -version 2>&1 | grep java.runtime.version\n    java.runtime.version = 9+181\n$ JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-10.jdk/Contents/Home java -XshowSettings:properties -version 2>&1 | grep java.runtime.version\n    java.runtime.version = 10.0.2+13\n$ JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-11.jdk/Contents/Home java -XshowSettings:properties -version 2>&1 | grep java.runtime.version\n    java.runtime.version = 11.0.4+11\n$ JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-12.jdk/Contents/Home java -XshowSettings:properties -version 2>&1 | grep java.runtime.version\n    java.runtime.version = 12.0.2+10\n$ JAVA_HOME=/usr/local/Cellar/openjdk/13.0.2+8_2 java -XshowSettings:properties -version 2>&1 | grep java.runtime.version\n    java.runtime.version = 13.0.2+8", "author": "ndimiduk", "createdAt": "2020-04-16T16:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r409804666", "bodyText": "G1GC is the default, why aren't we just leaving this out?", "author": "busbey", "createdAt": "2020-04-16T19:41:59Z", "path": "bin/hbase", "diffHunk": "@@ -136,6 +136,21 @@ if [ -f \"$HBASE_HOME/conf/hbase-env-$COMMAND.sh\" ]; then\n   . \"$HBASE_HOME/conf/hbase-env-$COMMAND.sh\"\n fi\n \n+# establish a default value for HBASE_OPTS if it's not already set. For now,\n+# all we set is the garbage collector.\n+if [ -z \"${HBASE_OPTS}\" ] ; then\n+  major_version_number=\"$(parse_java_major_version \"$(read_java_version)\")\"\n+  case \"$major_version_number\" in\n+  8|9|10)\n+    HBASE_OPTS=\"-XX:+UseConcMarkSweepGC\"\n+    ;;\n+  11|*)\n+    HBASE_OPTS=\"-XX:+UseG1GC\"", "originalCommit": "0fde2bfc66d2e6572939381af292fabbacd1d631", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMTkzMw==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r409811933", "bodyText": "The idea is to be explicit with the collector selection.", "author": "ndimiduk", "createdAt": "2020-04-16T19:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MzQ2OA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410373468", "bodyText": "I wonder if we should move GC selection into the GC_OPTS family of variables.", "author": "ndimiduk", "createdAt": "2020-04-17T17:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3OTM3Ng==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410379376", "bodyText": "I guess that would mean when a newer JDK release changes the default collector we'll stick with the G1GC we currently know. That's consistent with how we handled CMS before. Makes sense.\n\nI wonder if we should move GC selection into the GC_OPTS family of variables.\n\nThat is a really good point I had not thought of. Probably?\nShould we even be setting a collector for the CLIENT_GC_OPTS?", "author": "busbey", "createdAt": "2020-04-17T17:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MTc3Mg==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410381772", "bodyText": "The benefit of setting it in HBASE_OPTS is that it gets picked up by all of our launch contexts. Moving it out to the *_GC_OPTS variables is probably a larger refactor effort.\nAlso not discussed here is the API compatibility around these variables. Moving GC selection out of HBASE_OPTS is definitely a conceptual change. Even changing the behavior from always-appends-the collector-selection to only-sets-when-HBASE_OPTS-is-empty is also compatibility change.", "author": "ndimiduk", "createdAt": "2020-04-17T17:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4NjQzOA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410386438", "bodyText": "Also not discussed here is the API compatibility around these variables. Moving GC selection out of HBASE_OPTS is definitely a conceptual change. Even changing the behavior from always-appends-the collector-selection to only-sets-when-HBASE_OPTS-is-empty is also compatibility change.\n\nThose are all operational compatibility, imho, so we're fine as long as we don't put it into a maintenance release and we include a good note.", "author": "busbey", "createdAt": "2020-04-17T18:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4Njk5Ng==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410386996", "bodyText": "The benefit of setting it in HBASE_OPTS is that it gets picked up by all of our launch contexts. Moving it out to the *_GC_OPTS variables is probably a larger refactor effort.\n\nWhat do you mean by launch contexts here? I thought the intention of i.e. SERVER_GC_OPTS was that it would get included for the launching of any of our services?", "author": "busbey", "createdAt": "2020-04-17T18:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4ODExMA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410388110", "bodyText": "I like the idea of just leaving it out.\nGC_OPTS would be new? Lets not if we can avoid it?", "author": "saintstack", "createdAt": "2020-04-17T18:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5MTQ0OQ==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410391449", "bodyText": "GC_OPTS would be new? Lets not if we can avoid it?\n\nI believe Nick is referring to SERVER_GC_OPTS and CLIENT_GC_OPTS which we already define in hbase-env.sh and use in the main hbase launching script.", "author": "busbey", "createdAt": "2020-04-17T18:15:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5Nzk1OA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410397958", "bodyText": "Yes, there are at least these two that are exposed in https://github.com/apache/hbase/blob/master/conf/hbase-env.sh#L47-L71\nPerhaps I'm proposing adding a new GC_OPTS or HBASE_GC_OPTS or COMMON_GC_OPTS where this collector specification is placed, and onto which SERVER_GC_OPTS and CLIENT_GC_OPTS are built.", "author": "ndimiduk", "createdAt": "2020-04-17T18:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwMzcyNA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410403724", "bodyText": "What do you mean by launch contexts here?\n\nI mean any of the various classes that are eventually launched by bin/hbase. Some paths append server-specific settings, client-specific, shell-specific, and others append nothing. From what I can tell, all of these start with HBASE_OPTS.", "author": "ndimiduk", "createdAt": "2020-04-17T18:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwNTk2Mg==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410405962", "bodyText": "Yes that is true. I don't know how wise it is for us to be setting the collector on the shell or the client, but /shrug not something we need to answer here.", "author": "busbey", "createdAt": "2020-04-17T18:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMjYwMw==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410412603", "bodyText": "Just suggesting we not introduce new variables for operator to figure if we can avoid it.", "author": "saintstack", "createdAt": "2020-04-17T18:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ0OTg0MA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410449840", "bodyText": "Leaving this as is for now. Will add a release note that we're no longer prescriptive of the collector if the user specified HBASE_OPTS.", "author": "ndimiduk", "createdAt": "2020-04-17T20:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNjQ5OA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r409806498", "bodyText": "nit, but this usually means we didn't tell shellcheck how to source some file we presume is present in the environment. in this case hbase-env. it'd be nice if we fixed that, but I don't think it needs to be your problem in this PR.", "author": "busbey", "createdAt": "2020-04-16T19:45:21Z", "path": "bin/hbase-config.sh", "diffHunk": "@@ -168,3 +168,27 @@ if [ -z \"$JAVA_HOME\" ]; then\n EOF\n     exit 1\n fi\n+\n+function read_java_version() {\n+  properties=\"$(\"${JAVA_HOME}/bin/java\" -XshowSettings:properties -version 2>&1)\"\n+  #shellcheck disable=SC2016 # shellcheck cannot see through \"${AWK}\"", "originalCommit": "0fde2bfc66d2e6572939381af292fabbacd1d631", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNTUzMg==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r409815532", "bodyText": "Oh really?\nI think there's more to it than that. I added on this patch but I still get the SC2016 warning.\nmodified   bin/hbase-config.sh\n@@ -130,6 +130,7 @@ fi\n # Source the hbase-env.sh.  Will have JAVA_HOME defined.\n # HBASE-7817 - Source the hbase-env.sh only if it has not already been done. HBASE_ENV_INIT keeps track of it.\n if [ -z \"$HBASE_ENV_INIT\" ] && [ -f \"${HBASE_CONF_DIR}/hbase-env.sh\" ]; then\n+  # shellcheck source=../conf/hbase-env.sh\n   . \"${HBASE_CONF_DIR}/hbase-env.sh\"\n   export HBASE_ENV_INIT=\"true\"\n fi\n@@ -171,7 +172,6 @@ fi\n \n function read_java_version() {\n   properties=\"$(\"${JAVA_HOME}/bin/java\" -XshowSettings:properties -version 2>&1)\"\n-  #shellcheck disable=SC2016 # shellcheck cannot see through \"${AWK}\"\n   echo \"${properties}\" | \"${GREP}\" java.runtime.version | head -1 | \"${AWK}\" 'BEGIN {FS = \" = \"} ; {print $NF}'\n }", "author": "ndimiduk", "createdAt": "2020-04-16T20:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5MDU2MA==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410390560", "bodyText": "Oh I should read closer. SC2016 isn't about being able to turn \"${AWK}\" into the contents of that variable. it's about the expression being passed to awk. Specifically the \"print $NF\" that we want AWK to handle and not the shell.\nIf we want to stick with AWK I think it's fine to disable the check. I'd find the comment easier to understand if it was phrased like \"we mean to have AWK handle the variable resolution inside the passed awk script\"\nOtherwise you could get the same output using sed without anything that could be mistaken for a bash variable\n   echo \"${properties}\" | \"${GREP}\" java.runtime.version | head -1 | \"${SED}\" -E -e 's/.* = ([^ ]*)/\\1/'", "author": "busbey", "createdAt": "2020-04-17T18:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5ODY3NQ==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410398675", "bodyText": "I'm fine with using sed, it would be \"${SED}\". Is -E portable enough for our needs?", "author": "ndimiduk", "createdAt": "2020-04-17T18:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwNTA5MQ==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410405091", "bodyText": "I don't know off hand how portable -E is. In the example I only used it to avoid escaping the parentheses, so you can drop it and change the expression to 's/.* = \\([^ ]*\\) */\\1/' (I forgot to strip trialing spaces in the original example)", "author": "busbey", "createdAt": "2020-04-17T18:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ0OTkxNQ==", "url": "https://github.com/apache/hbase/pull/1527#discussion_r410449915", "bodyText": "Switching to sed.", "author": "ndimiduk", "createdAt": "2020-04-17T20:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNjQ5OA=="}], "type": "inlineReview"}, {"oid": "efd0cbb9696cc41db4038dd14c450deecb1f6228", "url": "https://github.com/apache/hbase/commit/efd0cbb9696cc41db4038dd14c450deecb1f6228", "message": "HBASE-24143 [JDK11] Switch default garbage collector from CMS\n\nPer comments in Jira, be explicit about what collector we\nuse. Existing code simply hard-codes HBASE_OPTS in\n`conf/hbase-env.sh`. We now need to be a little more clever than this,\nso moves the definition into `bin/hbase`. Also consolidates logic\naround JVM version detection into a reusable function.\n\nThis change also changes how we set `HBASE_OPTS`. Before, we would\naccept an operator's value, but always append our GC\nprescription. After this change, we defer entirely to the operator's\nchoice, only applying our values when they've not specified their\nintentions.\n\nSigned-off-by: stack <stack@apache.org>\nSigned-off-by: Sean Busbey <busbey@apache.org>", "committedDate": "2020-04-17T20:19:46Z", "type": "commit"}, {"oid": "efd0cbb9696cc41db4038dd14c450deecb1f6228", "url": "https://github.com/apache/hbase/commit/efd0cbb9696cc41db4038dd14c450deecb1f6228", "message": "HBASE-24143 [JDK11] Switch default garbage collector from CMS\n\nPer comments in Jira, be explicit about what collector we\nuse. Existing code simply hard-codes HBASE_OPTS in\n`conf/hbase-env.sh`. We now need to be a little more clever than this,\nso moves the definition into `bin/hbase`. Also consolidates logic\naround JVM version detection into a reusable function.\n\nThis change also changes how we set `HBASE_OPTS`. Before, we would\naccept an operator's value, but always append our GC\nprescription. After this change, we defer entirely to the operator's\nchoice, only applying our values when they've not specified their\nintentions.\n\nSigned-off-by: stack <stack@apache.org>\nSigned-off-by: Sean Busbey <busbey@apache.org>", "committedDate": "2020-04-17T20:19:46Z", "type": "forcePushed"}]}