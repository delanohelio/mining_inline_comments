{"pr_number": 2364, "pr_title": "HBASE-24998 Introduce a ReplicationSourceController interface \u2026", "pr_createdAt": "2020-09-08T09:46:32Z", "pr_url": "https://github.com/apache/hbase/pull/2364", "timeline": [{"oid": "860c55f3df65056d4b847ea31e488860d3a10ca7", "url": "https://github.com/apache/hbase/commit/860c55f3df65056d4b847ea31e488860d3a10ca7", "message": "HBASE-24998 Introduce a ReplicationSourceOverallController interface and decouple ReplicationSourceManager and ReplicationSource", "committedDate": "2020-09-08T09:48:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNTg3OA==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485115878", "bodyText": "Only used in ReplicationSourceManager so define these there?", "author": "saintstack", "createdAt": "2020-09-08T18:28:47Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -979,6 +979,8 @@\n   /*\n    * cluster replication constants.\n    */\n+  public static final String REPLICATION_OFFLOAD_ENABLE_KEY = \"hbase.replication.offload.enabled\";\n+  public static final boolean REPLICATION_OFFLOAD_ENABLE_DEFAULT = false;", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMwMjYxOA==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485302618", "bodyText": "In the next patches, this may be used in other place, too.", "author": "infraio", "createdAt": "2020-09-09T02:37:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNTg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNjMyNA==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485116324", "bodyText": "License", "author": "saintstack", "createdAt": "2020-09-08T18:29:30Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationSourceOverallController.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.apache.hadoop.hbase.replication;", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNzE0MQ==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485117141", "bodyText": "Can it just be ReplicationSoruceController? Drop the 'Overall'?", "author": "saintstack", "createdAt": "2020-09-08T18:31:02Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationSourceOverallController.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.apache.hadoop.hbase.replication;\n+\n+import org.apache.hadoop.hbase.replication.regionserver.MetricsReplicationGlobalSourceSource;\n+import org.apache.hadoop.hbase.replication.regionserver.RecoveredReplicationSource;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Used to control all replication sources inside one RegionServer or ReplicationServer.\n+ * Used by {@link ReplicationSource} or {@link RecoveredReplicationSource}.\n+ */\n+@InterfaceAudience.Private\n+public interface ReplicationSourceOverallController {", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNzYzOQ==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485117639", "bodyText": "Is this a 'size' rather than a 'limit'? It is count of how many bytes are currently accumulated in replication source memory?", "author": "saintstack", "createdAt": "2020-09-08T18:32:01Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationSourceOverallController.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.apache.hadoop.hbase.replication;\n+\n+import org.apache.hadoop.hbase.replication.regionserver.MetricsReplicationGlobalSourceSource;\n+import org.apache.hadoop.hbase.replication.regionserver.RecoveredReplicationSource;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Used to control all replication sources inside one RegionServer or ReplicationServer.\n+ * Used by {@link ReplicationSource} or {@link RecoveredReplicationSource}.\n+ */\n+@InterfaceAudience.Private\n+public interface ReplicationSourceOverallController {\n+\n+  /**\n+   * Returns the maximum size in bytes of edits held in memory which are pending replication\n+   * across all sources inside this RegionServer or ReplicationServer.\n+   */\n+  long getTotalBufferLimit();", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNzg5Mg==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485117892", "bodyText": "Maybe the comment is just in the wrong place.. should be on the next data member?", "author": "saintstack", "createdAt": "2020-09-08T18:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNzYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMwMzExNA==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485303114", "bodyText": "This was copied from the ReplicationSourceManager. And it is the total limit, not the currently size.", "author": "infraio", "createdAt": "2020-09-09T02:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExNzYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExODE4OQ==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485118189", "bodyText": "What sort of 'global' metrics? This is metrics for all replication sources?", "author": "saintstack", "createdAt": "2020-09-08T18:33:06Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationSourceOverallController.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.apache.hadoop.hbase.replication;\n+\n+import org.apache.hadoop.hbase.replication.regionserver.MetricsReplicationGlobalSourceSource;\n+import org.apache.hadoop.hbase.replication.regionserver.RecoveredReplicationSource;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Used to control all replication sources inside one RegionServer or ReplicationServer.\n+ * Used by {@link ReplicationSource} or {@link RecoveredReplicationSource}.\n+ */\n+@InterfaceAudience.Private\n+public interface ReplicationSourceOverallController {\n+\n+  /**\n+   * Returns the maximum size in bytes of edits held in memory which are pending replication\n+   * across all sources inside this RegionServer or ReplicationServer.\n+   */\n+  long getTotalBufferLimit();\n+\n+  AtomicLong getTotalBufferUsed();\n+\n+  MetricsReplicationGlobalSourceSource getGlobalMetrics();", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMwMzE0OQ==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485303149", "bodyText": "Yes.", "author": "infraio", "createdAt": "2020-09-09T02:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExODE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExODc5Ng==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485118796", "bodyText": "Remove '@param src'. s/Called/Call/", "author": "saintstack", "createdAt": "2020-09-08T18:34:05Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/ReplicationSourceOverallController.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.apache.hadoop.hbase.replication;\n+\n+import org.apache.hadoop.hbase.replication.regionserver.MetricsReplicationGlobalSourceSource;\n+import org.apache.hadoop.hbase.replication.regionserver.RecoveredReplicationSource;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Used to control all replication sources inside one RegionServer or ReplicationServer.\n+ * Used by {@link ReplicationSource} or {@link RecoveredReplicationSource}.\n+ */\n+@InterfaceAudience.Private\n+public interface ReplicationSourceOverallController {\n+\n+  /**\n+   * Returns the maximum size in bytes of edits held in memory which are pending replication\n+   * across all sources inside this RegionServer or ReplicationServer.\n+   */\n+  long getTotalBufferLimit();\n+\n+  AtomicLong getTotalBufferUsed();\n+\n+  MetricsReplicationGlobalSourceSource getGlobalMetrics();\n+\n+  /**\n+   * Called this when the recovered replication source replicated all WALs.\n+   * @param src", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExOTMxNg==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485119316", "bodyText": "There is only one ReplicationSourceManager instance in a RS? If so, can it carry the Controller rather than as here where it is another param on this init method?", "author": "saintstack", "createdAt": "2020-09-08T18:35:04Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/RecoveredReplicationSource.java", "diffHunk": "@@ -45,18 +46,15 @@\n \n   private static final Logger LOG = LoggerFactory.getLogger(RecoveredReplicationSource.class);\n \n-  private Path walDir;\n-\n   private String actualPeerId;\n \n   @Override\n-  public void init(Configuration conf, FileSystem fs, Path walDir, ReplicationSourceManager manager,\n-    ReplicationQueueStorage queueStorage, ReplicationPeer replicationPeer, Server server,\n-    String peerClusterZnode, UUID clusterId, WALFileLengthProvider walFileLengthProvider,\n-    MetricsSource metrics) throws IOException {\n-    super.init(conf, fs, walDir, manager, queueStorage, replicationPeer, server, peerClusterZnode,\n-      clusterId, walFileLengthProvider, metrics);\n-    this.walDir = walDir;\n+  public void init(Configuration conf, FileSystem fs, Path walDir,\n+    ReplicationSourceOverallController overallController, ReplicationQueueStorage queueStorage,", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMwMzYzMA==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485303630", "bodyText": "Yes. Only one ReplicationSourceManager and only one Controller, too. Only pass Controller to ReplicationSource. Then decouple ReplicationSourceManager and ReplicationSource.", "author": "infraio", "createdAt": "2020-09-09T02:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExOTMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMDQ0NQ==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485120445", "bodyText": "Yeah, if this implements Controller, you have to pass it in to ReplicationSource #Init as a distinct arg?", "author": "saintstack", "createdAt": "2020-09-08T18:37:16Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -92,7 +93,8 @@\n  * </ul>\n  */\n @InterfaceAudience.Private\n-public class ReplicationSourceManager implements ReplicationListener {\n+public class ReplicationSourceManager implements ReplicationListener,\n+  ReplicationSourceOverallController {", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTA5OA==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485121098", "bodyText": "I should go back to the design but we can't just have the offload be a ReplicationSource implementation? Because you need to span all ReplicationSources?", "author": "saintstack", "createdAt": "2020-09-08T18:38:39Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -186,12 +188,11 @@ public ReplicationSourceManager(ReplicationQueueStorage queueStorage,\n     this.latestPaths = new HashMap<>();\n     this.replicationForBulkLoadDataEnabled = conf.getBoolean(\n       HConstants.REPLICATION_BULKLOAD_ENABLE_KEY, HConstants.REPLICATION_BULKLOAD_ENABLE_DEFAULT);\n-    this.sleepForRetries = this.conf.getLong(\"replication.source.sync.sleepforretries\", 1000);\n-    this.maxRetriesMultiplier =\n-      this.conf.getInt(\"replication.source.sync.maxretriesmultiplier\", 60);\n     this.totalBufferLimit = conf.getLong(HConstants.REPLICATION_SOURCE_TOTAL_BUFFER_KEY,\n         HConstants.REPLICATION_SOURCE_TOTAL_BUFFER_DFAULT);\n     this.globalMetrics = globalMetrics;\n+    this.replicationOffload = conf.getBoolean(HConstants.REPLICATION_OFFLOAD_ENABLE_KEY,", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1MzQ5Ng==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r490653496", "bodyText": "In the design, the RegionServer not need to start all ReplicationSources. It only need to store its WAL path to the ReplicationQueueStorage. And the ReplicationServer will fetch the WAL paths and start all ReplicationSources.", "author": "infraio", "createdAt": "2020-09-18T01:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzIxNw==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485123217", "bodyText": "Funny, I want it to stay public in my current work (meta region replicas). Can move it back in my patch.", "author": "saintstack", "createdAt": "2020-09-08T18:42:43Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -244,7 +286,7 @@ private void adoptAbandonedQueues() {\n    * </ol>\n    * @param peerId the id of replication peer\n    */\n-  public void addPeer(String peerId) throws IOException {\n+  void addPeer(String peerId) throws IOException {", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDUxNg==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485124516", "bodyText": "I want to call it on Region open. Let me see if I can move where I make the call.", "author": "saintstack", "createdAt": "2020-09-08T18:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzI5OQ==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485123299", "bodyText": "Ditto", "author": "saintstack", "createdAt": "2020-09-08T18:42:51Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -268,7 +310,7 @@ public void addPeer(String peerId) throws IOException {\n    * </ol>\n    * @param peerId the id of the replication peer\n    */\n-  public void removePeer(String peerId) {\n+  void removePeer(String peerId) {", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDc0Nw==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485124747", "bodyText": "I see, you are just moving existing methods.", "author": "saintstack", "createdAt": "2020-09-08T18:45:29Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -849,19 +874,6 @@ int getSizeOfLatestPath() {\n     }\n   }\n \n-  @VisibleForTesting\n-  public AtomicLong getTotalBufferUsed() {", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTExNw==", "url": "https://github.com/apache/hbase/pull/2364#discussion_r485125117", "bodyText": "Yeah, if the Controller is in the ReplicationSourceManager, then the 'overall' will be redundant?", "author": "saintstack", "createdAt": "2020-09-08T18:46:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceWALReader.java", "diffHunk": "@@ -267,10 +267,11 @@ public Path getCurrentPath() {\n   //returns false if we've already exceeded the global quota\n   private boolean checkQuota() {\n     // try not to go over total quota\n-    if (source.manager.getTotalBufferUsed().get() > source.manager.getTotalBufferLimit()) {\n+    if (source.overallController.getTotalBufferUsed().get() > source.overallController", "originalCommit": "860c55f3df65056d4b847ea31e488860d3a10ca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccbd2e8ad0241f9e2ba3f33f9fbca037088f4ef0", "url": "https://github.com/apache/hbase/commit/ccbd2e8ad0241f9e2ba3f33f9fbca037088f4ef0", "message": "HBASE-24998 Introduce a ReplicationSourceOverallController interface and decouple ReplicationSourceManager and ReplicationSource", "committedDate": "2020-09-09T03:02:15Z", "type": "forcePushed"}, {"oid": "0c7bcf5484ea444e1c2dca7dc8904feb75d79dee", "url": "https://github.com/apache/hbase/commit/0c7bcf5484ea444e1c2dca7dc8904feb75d79dee", "message": "HBASE-24998 Introduce a ReplicationSourceOverallController interface and decouple ReplicationSourceManager and ReplicationSource", "committedDate": "2020-09-09T04:12:33Z", "type": "forcePushed"}, {"oid": "99503d16a469f75891edf028ce1e214820874ec6", "url": "https://github.com/apache/hbase/commit/99503d16a469f75891edf028ce1e214820874ec6", "message": "HBASE-24998 Introduce a ReplicationSourceOverallController interface and decouple ReplicationSourceManager and ReplicationSource", "committedDate": "2020-09-09T06:59:09Z", "type": "forcePushed"}, {"oid": "ac62e966d4b1d91a147e8194bdf9ab0436b8fcf9", "url": "https://github.com/apache/hbase/commit/ac62e966d4b1d91a147e8194bdf9ab0436b8fcf9", "message": "HBASE-24998 Introduce a ReplicationSourceOverallController interface and decouple ReplicationSourceManager and ReplicationSource", "committedDate": "2020-09-09T07:01:48Z", "type": "forcePushed"}, {"oid": "069ed71de4d054f1e2d56bf60a6a084c161118d7", "url": "https://github.com/apache/hbase/commit/069ed71de4d054f1e2d56bf60a6a084c161118d7", "message": "HBASE-24998 Introduce a ReplicationSourceOverallController interface and decouple ReplicationSourceManager and ReplicationSource", "committedDate": "2020-09-14T07:05:43Z", "type": "commit"}, {"oid": "069ed71de4d054f1e2d56bf60a6a084c161118d7", "url": "https://github.com/apache/hbase/commit/069ed71de4d054f1e2d56bf60a6a084c161118d7", "message": "HBASE-24998 Introduce a ReplicationSourceOverallController interface and decouple ReplicationSourceManager and ReplicationSource", "committedDate": "2020-09-14T07:05:43Z", "type": "forcePushed"}]}