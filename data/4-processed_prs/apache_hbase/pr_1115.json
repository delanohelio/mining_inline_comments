{"pr_number": 1115, "pr_title": "HBASE-23782 We still reference the hard coded meta descriptor in some\u2026", "pr_createdAt": "2020-02-02T13:42:32Z", "pr_url": "https://github.com/apache/hbase/pull/1115", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg2NDczMA==", "url": "https://github.com/apache/hbase/pull/1115#discussion_r373864730", "bodyText": "Looks like this constructor can have just these initializations:\n    this.fs = fs;\n    this.rootdir = rootdir;\n    this.fsreadonly = fsreadonly;\n    this.usecache = usecache;", "author": "virajjasani", "createdAt": "2020-02-02T18:16:33Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java", "diffHunk": "@@ -153,7 +148,6 @@ public FSTableDescriptors(final Configuration conf, final FileSystem fs,\n         updateTableDescriptor(td);\n       }\n     }\n-    this.metaTableDescriptor = td;", "originalCommit": "3e6964b3360593b805f2010814b066461e3481bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea986e5c04c96dc6284a03f9aa6d04b6a426465a", "url": "https://github.com/apache/hbase/commit/ea986e5c04c96dc6284a03f9aa6d04b6a426465a", "message": "HBASE-23782 We still reference the hard coded meta descriptor in some places when listing table descriptors", "committedDate": "2020-02-03T00:59:07Z", "type": "commit"}, {"oid": "ea986e5c04c96dc6284a03f9aa6d04b6a426465a", "url": "https://github.com/apache/hbase/commit/ea986e5c04c96dc6284a03f9aa6d04b6a426465a", "message": "HBASE-23782 We still reference the hard coded meta descriptor in some places when listing table descriptors", "committedDate": "2020-02-03T00:59:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIzMzQwMQ==", "url": "https://github.com/apache/hbase/pull/1115#discussion_r374233401", "bodyText": "Nice test", "author": "saintstack", "createdAt": "2020-02-03T17:22:42Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/TestHBaseMetaEdit.java", "diffHunk": "@@ -63,6 +63,23 @@ public void after() throws Exception {\n     UTIL.shutdownMiniCluster();\n   }\n \n+  // make sure that with every possible way, we get the same meta table descriptor.\n+  private TableDescriptor getMetaDescriptor() throws TableNotFoundException, IOException {\n+    Admin admin = UTIL.getAdmin();\n+    TableDescriptor get = admin.getDescriptor(TableName.META_TABLE_NAME);\n+    TableDescriptor list =\n+      admin.listTableDescriptors(true).stream().filter(td -> td.isMetaTable()).findAny().get();\n+    TableDescriptor listByName =\n+      admin.listTableDescriptors(Collections.singletonList(TableName.META_TABLE_NAME)).get(0);\n+    TableDescriptor listByNs =\n+      admin.listTableDescriptorsByNamespace(NamespaceDescriptor.SYSTEM_NAMESPACE_NAME).stream()\n+        .filter(td -> td.isMetaTable()).findAny().get();\n+    assertEquals(get, list);\n+    assertEquals(get, listByName);\n+    assertEquals(get, listByNs);\n+    return get;\n+  }\n+", "originalCommit": "ea986e5c04c96dc6284a03f9aa6d04b6a426465a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNzY3Nw==", "url": "https://github.com/apache/hbase/pull/1115#discussion_r374407677", "bodyText": "Just FYI, this change broke the error prone build.\nhttps://builds.apache.org/job/HBase%20Nightly/job/master/1618/artifact/output-general/patch-compile-root.txt\n[ERROR] /home/jenkins/jenkins-slave/workspace/HBase_Nightly_master@2/component/hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java:[147,28] error: [ReturnValueIgnored] Return value of this method must be used\n(see https://errorprone.info/bugpattern/ReturnValueIgnored)\nDid you mean to remove this line?\n[INFO] 1 error\nYou can reproduce with \"mvn clean compile -DskipTests -PerrorProne\"", "author": "bharathv", "createdAt": "2020-02-03T23:53:55Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/util/FSTableDescriptors.java", "diffHunk": "@@ -135,33 +130,30 @@ public FSTableDescriptors(final Configuration conf, final FileSystem fs,\n    *                     see HMaster#finishActiveMasterInitialization\n    *                     TODO: This is a workaround. Should remove this ugly code...\n    */\n-  public FSTableDescriptors(final Configuration conf, final FileSystem fs,\n-       final Path rootdir, final boolean fsreadonly, final boolean usecache,\n-       Function<TableDescriptorBuilder, TableDescriptorBuilder> metaObserver) throws IOException {\n+  public FSTableDescriptors(final Configuration conf, final FileSystem fs, final Path rootdir,\n+    final boolean fsreadonly, final boolean usecache,\n+    Function<TableDescriptorBuilder, TableDescriptorBuilder> metaObserver) throws IOException {\n     this.fs = fs;\n     this.rootdir = rootdir;\n     this.fsreadonly = fsreadonly;\n     this.usecache = usecache;\n-    TableDescriptor td = null;\n-    try {\n-      td = getTableDescriptorFromFs(fs, rootdir, TableName.META_TABLE_NAME);\n-    } catch (TableInfoMissingException e) {\n-      td = metaObserver == null? createMetaTableDescriptor(conf):\n-        metaObserver.apply(createMetaTableDescriptorBuilder(conf)).build();\n-      if (!fsreadonly) {\n+    if (!fsreadonly) {\n+      // see if we already have meta descriptor on fs. Write one if not.\n+      try {\n+        getTableDescriptorFromFs(fs, rootdir, TableName.META_TABLE_NAME);\n+      } catch (TableInfoMissingException e) {\n+        TableDescriptorBuilder builder = createMetaTableDescriptorBuilder(conf);\n+        if (metaObserver != null) {\n+          metaObserver.apply(builder);", "originalCommit": "ea986e5c04c96dc6284a03f9aa6d04b6a426465a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}