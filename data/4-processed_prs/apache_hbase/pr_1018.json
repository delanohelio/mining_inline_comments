{"pr_number": 1018, "pr_title": "HBASE-23652 Move the unsupported procedure type check before migratin\u2026", "pr_createdAt": "2020-01-10T14:38:33Z", "pr_url": "https://github.com/apache/hbase/pull/1018", "timeline": [{"oid": "bf753ae8a3bf098f542c05cf410b8d273836e7bf", "url": "https://github.com/apache/hbase/commit/bf753ae8a3bf098f542c05cf410b8d273836e7bf", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore", "committedDate": "2020-01-11T01:07:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3Nzk1NQ==", "url": "https://github.com/apache/hbase/pull/1018#discussion_r366577955", "bodyText": "nit: \"Migrated {} existing procedures from the old storage format.\"", "author": "ndimiduk", "createdAt": "2020-01-14T21:20:33Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -347,6 +393,22 @@ public void handleCorrupted(ProcedureIterator procIter) throws IOException {\n         }\n       }\n     });\n+\n+    // check whether there are unsupported procedures, this could happen when we are migrating from\n+    // 2.1-. We used to do this in HMaster, after loading all the procedures from procedure store,\n+    // but here we have to do it before migrating, otherwise, if we find some unsupported\n+    // procedures, the users can not go back to 2.1 to finish them any more, as all the data are now\n+    // in the new region based procedure store, which is not supported in 2.1-.\n+    checkUnsupportedProcedure(activeProcsByType);\n+\n+    MutableLong maxProcIdFromProcs = new MutableLong(-1);\n+    for (Procedure<?> proc : procs) {\n+      update(proc);\n+      if (proc.getProcId() > maxProcIdFromProcs.longValue()) {\n+        maxProcIdFromProcs.setValue(proc.getProcId());\n+      }\n+    }\n+    LOG.info(\"Migrated {} procedures\", procs.size());", "originalCommit": "bf753ae8a3bf098f542c05cf410b8d273836e7bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3ODgxNQ==", "url": "https://github.com/apache/hbase/pull/1018#discussion_r366578815", "bodyText": "Both of these error messages should include a link to https://hbase.apache.org/book.html#upgrade2.2", "author": "ndimiduk", "createdAt": "2020-01-14T21:22:34Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -298,6 +307,45 @@ private HRegion open(Configuration conf, FileSystem fs, Path rootDir) throws IOE\n       null);\n   }\n \n+  @SuppressWarnings(\"deprecation\")\n+  private static final ImmutableSet<Class<?>> UNSUPPORTED_PROCEDURES =\n+    ImmutableSet.of(RecoverMetaProcedure.class, AssignProcedure.class, UnassignProcedure.class,\n+      MoveRegionProcedure.class);\n+\n+  /**\n+   * In HBASE-20811, we have introduced a new TRSP to assign/unassign/move regions, and it is\n+   * incompatible with the old AssignProcedure/UnassignProcedure/MoveRegionProcedure. So we need to\n+   * make sure that there are none these procedures when upgrading. If there are, the master will\n+   * quit, you need to go back to the old version to finish these procedures first before upgrading.\n+   */\n+  private void checkUnsupportedProcedure(Map<Class<?>, List<Procedure<?>>> procsByType)\n+    throws HBaseIOException {\n+    // Confirm that we do not have unfinished assign/unassign related procedures. It is not easy to\n+    // support both the old assign/unassign procedures and the new TransitRegionStateProcedure as\n+    // there will be conflict in the code for AM. We should finish all these procedures before\n+    // upgrading.\n+    for (Class<?> clazz : UNSUPPORTED_PROCEDURES) {\n+      List<Procedure<?>> procs = procsByType.get(clazz);\n+      if (procs != null) {\n+        LOG.error(\n+          \"Unsupported procedure type {} found, please rollback your master to the old\" +", "originalCommit": "bf753ae8a3bf098f542c05cf410b8d273836e7bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3OTQ0Mg==", "url": "https://github.com/apache/hbase/pull/1018#discussion_r366579442", "bodyText": "nit: this if check reads a bit easier with some newlines\nif (procsByType.getOrDefault(ServerCrashProcedure.class, Collections.emptyList())\n       .stream()\n       .map(p -> (ServerCrashProcedure) p)\n       .anyMatch(ServerCrashProcedure::isInRecoverMetaState)) {", "author": "ndimiduk", "createdAt": "2020-01-14T21:24:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -298,6 +307,45 @@ private HRegion open(Configuration conf, FileSystem fs, Path rootDir) throws IOE\n       null);\n   }\n \n+  @SuppressWarnings(\"deprecation\")\n+  private static final ImmutableSet<Class<?>> UNSUPPORTED_PROCEDURES =\n+    ImmutableSet.of(RecoverMetaProcedure.class, AssignProcedure.class, UnassignProcedure.class,\n+      MoveRegionProcedure.class);\n+\n+  /**\n+   * In HBASE-20811, we have introduced a new TRSP to assign/unassign/move regions, and it is\n+   * incompatible with the old AssignProcedure/UnassignProcedure/MoveRegionProcedure. So we need to\n+   * make sure that there are none these procedures when upgrading. If there are, the master will\n+   * quit, you need to go back to the old version to finish these procedures first before upgrading.\n+   */\n+  private void checkUnsupportedProcedure(Map<Class<?>, List<Procedure<?>>> procsByType)\n+    throws HBaseIOException {\n+    // Confirm that we do not have unfinished assign/unassign related procedures. It is not easy to\n+    // support both the old assign/unassign procedures and the new TransitRegionStateProcedure as\n+    // there will be conflict in the code for AM. We should finish all these procedures before\n+    // upgrading.\n+    for (Class<?> clazz : UNSUPPORTED_PROCEDURES) {\n+      List<Procedure<?>> procs = procsByType.get(clazz);\n+      if (procs != null) {\n+        LOG.error(\n+          \"Unsupported procedure type {} found, please rollback your master to the old\" +\n+            \" version to finish them, and then try to upgrade again. The full procedure list: {}\",\n+          clazz, procs);\n+        throw new HBaseIOException(\"Unsupported procedure type \" + clazz + \" found\");\n+      }\n+    }\n+    // A special check for SCP, as we do not support RecoverMetaProcedure any more so we need to\n+    // make sure that no one will try to schedule it but SCP does have a state which will schedule\n+    // it.\n+    if (procsByType.getOrDefault(ServerCrashProcedure.class, Collections.emptyList()).stream()", "originalCommit": "bf753ae8a3bf098f542c05cf410b8d273836e7bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI1OTEyNA==", "url": "https://github.com/apache/hbase/pull/1018#discussion_r367259124", "bodyText": "Just use eclipse formatter and it will make them in the same line if possible...", "author": "Apache9", "createdAt": "2020-01-16T07:04:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3OTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNzI0NQ==", "url": "https://github.com/apache/hbase/pull/1018#discussion_r367527245", "bodyText": "::nod::\nI disagree with eclipse formatter. I don't think it's been updated since java8.", "author": "ndimiduk", "createdAt": "2020-01-16T16:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3OTQ0Mg=="}], "type": "inlineReview"}, {"oid": "3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "url": "https://github.com/apache/hbase/commit/3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore", "committedDate": "2020-01-16T06:56:15Z", "type": "commit"}, {"oid": "3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "url": "https://github.com/apache/hbase/commit/3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore", "committedDate": "2020-01-16T06:56:15Z", "type": "forcePushed"}]}