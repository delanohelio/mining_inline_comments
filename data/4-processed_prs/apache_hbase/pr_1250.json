{"pr_number": 1250, "pr_title": "HBASE-23945 Dockerfiles showing hadolint check failures", "pr_createdAt": "2020-03-07T20:13:44Z", "pr_url": "https://github.com/apache/hbase/pull/1250", "timeline": [{"oid": "8d706d93eec3e275c6c6a15b8f33177a29a8d894", "url": "https://github.com/apache/hbase/commit/8d706d93eec3e275c6c6a15b8f33177a29a8d894", "message": "HBASE-23945 Dockerfiles showing hadolint check failures\n\nSigned-off-by: stack <stack@apache.org>", "committedDate": "2020-03-07T20:14:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwOTA4OA==", "url": "https://github.com/apache/hbase/pull/1250#discussion_r389309088", "bodyText": "This one has a new dependency on python-setuptools, so that's added.", "author": "ndimiduk", "createdAt": "2020-03-07T20:15:35Z", "path": "dev-support/Dockerfile", "diffHunk": "@@ -22,8 +22,14 @@\n # dev-support/flaky-tests/flaky-reporting.Jenkinsfile\n FROM ubuntu:18.04\n \n-ADD . /hbase/dev-support\n+COPY . /hbase/dev-support\n \n-RUN apt-get -y update \\\n-    && apt-get -y install curl python-pip \\\n-    && pip install -r /hbase/dev-support/python-requirements.txt\n+RUN DEBIAN_FRONTEND=noninteractive apt-get -qq -y update \\\n+    && DEBIAN_FRONTEND=noninteractive apt-get -qq -y install --no-install-recommends \\\n+      curl=7.58.0-2ubuntu3.8 \\\n+      python2.7=2.7.17-1~18.04 \\\n+      python-pip=9.0.1-2.3~ubuntu1.18.04.1 \\\n+      python-setuptools=39.0.1-2 \\", "originalCommit": "8d706d93eec3e275c6c6a15b8f33177a29a8d894", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3MzQwNw==", "url": "https://github.com/apache/hbase/pull/1250#discussion_r389873407", "bodyText": "nod", "author": "saintstack", "createdAt": "2020-03-09T18:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwOTA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwOTE5NQ==", "url": "https://github.com/apache/hbase/pull/1250#discussion_r389309195", "bodyText": "rebuilt this one following the multi-stage pattern from the Dockerfile use in CI jobs.", "author": "ndimiduk", "createdAt": "2020-03-07T20:17:07Z", "path": "dev-support/hbase_docker/Dockerfile", "diffHunk": "@@ -14,37 +14,73 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n \n-FROM ubuntu:14.04\n+FROM ubuntu:18.04 AS BASE_IMAGE", "originalCommit": "8d706d93eec3e275c6c6a15b8f33177a29a8d894", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwOTI4OQ==", "url": "https://github.com/apache/hbase/pull/1250#discussion_r389309289", "bodyText": "this image clearly hasn't been built recently. hbase-assembly/target contained two tarballs: one of HBase and one of the client. This command isn't designed to handle multiple files, so I rewrote it using find instead. The new version is probably also not resilient to the presence of yet another tarball, but should do better than what was here.", "author": "ndimiduk", "createdAt": "2020-03-07T20:18:38Z", "path": "dev-support/hbase_docker/Dockerfile", "diffHunk": "@@ -14,37 +14,73 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n \n-FROM ubuntu:14.04\n+FROM ubuntu:18.04 AS BASE_IMAGE\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n \n-# Install Git, which is missing from the Ubuntu base images.\n-RUN apt-get update && apt-get install -y git\n+# hadolint ignore=DL3009\n+RUN DEBIAN_FRONTEND=noninteractive apt-get -qq update && \\\n+  DEBIAN_FRONTEND=noninteractive apt-get -qq install --no-install-recommends -y \\\n+    ca-certificates=20180409 \\\n+    curl=7.58.0-2ubuntu3.8 \\\n+    locales=2.27-3ubuntu1\n \n-# Add the dependencies from the hbase_docker folder and delete ones we don't need.\n-WORKDIR /root\n-ADD . /root\n-RUN find . -not -name \"*tar.gz\" -delete\n+RUN locale-gen en_US.UTF-8\n+ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8\n+\n+FROM BASE_IMAGE AS MAVEN_DOWNLOAD_IMAGE\n+ENV MAVEN_VERSION='3.5.4'\n+ENV MAVEN_URL \"https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz\"\n+ENV MAVEN_SHA256 'ce50b1c91364cb77efe3776f756a6d92b76d9038b0a0782f7d53acf1e997a14d'\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n+RUN curl --location --fail --silent --show-error --output /tmp/maven.tar.gz \"${MAVEN_URL}\" && \\\n+  echo \"${MAVEN_SHA256} */tmp/maven.tar.gz\" | sha256sum -c -\n+\n+FROM BASE_IMAGE AS OPENJDK8_DOWNLOAD_IMAGE\n+ENV OPENJDK8_URL 'https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u232-b09/OpenJDK8U-jdk_x64_linux_hotspot_8u232b09.tar.gz'\n+ENV OPENJDK8_SHA256 '7b7884f2eb2ba2d47f4c0bf3bb1a2a95b73a3a7734bd47ebf9798483a7bcc423'\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n+RUN curl --location --fail --silent --show-error --output /tmp/adoptopenjdk8.tar.gz \"${OPENJDK8_URL}\" && \\\n+  echo \"${OPENJDK8_SHA256} */tmp/adoptopenjdk8.tar.gz\" | sha256sum -c -\n \n-# Install Java.\n-RUN mkdir -p /usr/java\n-RUN tar xzf *jdk* --strip-components 1 -C /usr/java\n-ENV JAVA_HOME /usr/java\n+FROM BASE_IMAGE\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n \n-# Install Maven.\n-RUN mkdir -p /usr/local/apache-maven\n-RUN tar xzf *maven* --strip-components 1 -C /usr/local/apache-maven\n-ENV MAVEN_HOME /usr/local/apache-maven\n+RUN DEBIAN_FRONTEND=noninteractive apt-get -qq install --no-install-recommends -y \\\n+  git=1:2.17.1-1ubuntu0.5 \\\n+  && \\\n+  apt-get clean && \\\n+  rm -rf /var/lib/apt/lists/*\n \n-# Add Java and Maven to the path.\n-ENV PATH /usr/java/bin:/usr/local/apache-maven/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n+# hadolint ignore=DL3010\n+COPY --from=MAVEN_DOWNLOAD_IMAGE /tmp/maven.tar.gz /tmp/maven.tar.gz\n+RUN tar xzf /tmp/maven.tar.gz -C /opt && \\\n+  ln -s \"/opt/$(dirname \"$(tar -tf /tmp/maven.tar.gz | head -n1)\")\" /opt/maven && \\\n+  rm /tmp/maven.tar.gz\n+\n+# hadolint ignore=DL3010\n+COPY --from=OPENJDK8_DOWNLOAD_IMAGE /tmp/adoptopenjdk8.tar.gz /tmp/adoptopenjdk8.tar.gz\n+RUN mkdir -p /usr/lib/jvm && \\\n+  tar xzf /tmp/adoptopenjdk8.tar.gz -C /usr/lib/jvm && \\\n+  ln -s \"/usr/lib/jvm/$(basename \"$(tar -tf /tmp/adoptopenjdk8.tar.gz | head -n1)\")\" /usr/lib/jvm/java-8-adoptopenjdk && \\\n+  ln -s /usr/lib/jvm/java-8-adoptopenjdk /usr/lib/jvm/java-8 && \\\n+  rm /tmp/adoptopenjdk8.tar.gz\n+\n+ENV MAVEN_HOME '/opt/maven'\n+ENV JAVA_HOME '/usr/lib/jvm/java-8'\n+ENV PATH '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\n+ENV PATH \"${JAVA_HOME}/bin:${MAVEN_HOME}/bin:${PATH}\"\n \n # Pull down HBase and build it into /root/hbase-bin.\n+WORKDIR /root\n RUN git clone https://gitbox.apache.org/repos/asf/hbase.git -b master\n RUN mvn clean install -DskipTests assembly:single -f ./hbase/pom.xml\n RUN mkdir -p hbase-bin\n-RUN tar xzf /root/hbase/hbase-assembly/target/*tar.gz --strip-components 1 -C /root/hbase-bin", "originalCommit": "8d706d93eec3e275c6c6a15b8f33177a29a8d894", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwOTMzMA==", "url": "https://github.com/apache/hbase/pull/1250#discussion_r389309330", "bodyText": "rather than having the user bring their own maven, java, I just download them here. We'll want to keep this up to date as we update the core CI Dockerfile.", "author": "ndimiduk", "createdAt": "2020-03-07T20:19:25Z", "path": "dev-support/hbase_docker/Dockerfile", "diffHunk": "@@ -14,37 +14,73 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n \n-FROM ubuntu:14.04\n+FROM ubuntu:18.04 AS BASE_IMAGE\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n \n-# Install Git, which is missing from the Ubuntu base images.\n-RUN apt-get update && apt-get install -y git\n+# hadolint ignore=DL3009\n+RUN DEBIAN_FRONTEND=noninteractive apt-get -qq update && \\\n+  DEBIAN_FRONTEND=noninteractive apt-get -qq install --no-install-recommends -y \\\n+    ca-certificates=20180409 \\\n+    curl=7.58.0-2ubuntu3.8 \\\n+    locales=2.27-3ubuntu1\n \n-# Add the dependencies from the hbase_docker folder and delete ones we don't need.\n-WORKDIR /root\n-ADD . /root\n-RUN find . -not -name \"*tar.gz\" -delete\n+RUN locale-gen en_US.UTF-8\n+ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8\n+\n+FROM BASE_IMAGE AS MAVEN_DOWNLOAD_IMAGE\n+ENV MAVEN_VERSION='3.5.4'\n+ENV MAVEN_URL \"https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz\"\n+ENV MAVEN_SHA256 'ce50b1c91364cb77efe3776f756a6d92b76d9038b0a0782f7d53acf1e997a14d'\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n+RUN curl --location --fail --silent --show-error --output /tmp/maven.tar.gz \"${MAVEN_URL}\" && \\\n+  echo \"${MAVEN_SHA256} */tmp/maven.tar.gz\" | sha256sum -c -\n+\n+FROM BASE_IMAGE AS OPENJDK8_DOWNLOAD_IMAGE\n+ENV OPENJDK8_URL 'https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u232-b09/OpenJDK8U-jdk_x64_linux_hotspot_8u232b09.tar.gz'\n+ENV OPENJDK8_SHA256 '7b7884f2eb2ba2d47f4c0bf3bb1a2a95b73a3a7734bd47ebf9798483a7bcc423'\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n+RUN curl --location --fail --silent --show-error --output /tmp/adoptopenjdk8.tar.gz \"${OPENJDK8_URL}\" && \\\n+  echo \"${OPENJDK8_SHA256} */tmp/adoptopenjdk8.tar.gz\" | sha256sum -c -\n \n-# Install Java.\n-RUN mkdir -p /usr/java\n-RUN tar xzf *jdk* --strip-components 1 -C /usr/java\n-ENV JAVA_HOME /usr/java\n+FROM BASE_IMAGE\n+SHELL [\"/bin/bash\", \"-o\", \"pipefail\", \"-c\"]\n \n-# Install Maven.\n-RUN mkdir -p /usr/local/apache-maven\n-RUN tar xzf *maven* --strip-components 1 -C /usr/local/apache-maven\n-ENV MAVEN_HOME /usr/local/apache-maven\n+RUN DEBIAN_FRONTEND=noninteractive apt-get -qq install --no-install-recommends -y \\\n+  git=1:2.17.1-1ubuntu0.5 \\\n+  && \\\n+  apt-get clean && \\\n+  rm -rf /var/lib/apt/lists/*\n \n-# Add Java and Maven to the path.\n-ENV PATH /usr/java/bin:/usr/local/apache-maven/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n+# hadolint ignore=DL3010\n+COPY --from=MAVEN_DOWNLOAD_IMAGE /tmp/maven.tar.gz /tmp/maven.tar.gz", "originalCommit": "8d706d93eec3e275c6c6a15b8f33177a29a8d894", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NDgzNA==", "url": "https://github.com/apache/hbase/pull/1250#discussion_r389874834", "bodyText": "Add this in as a comment into the DOckerfile?", "author": "saintstack", "createdAt": "2020-03-09T18:17:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwOTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODQ3Mg==", "url": "https://github.com/apache/hbase/pull/1250#discussion_r390458472", "bodyText": "Sure, I'll do that. Looking good otherwise?", "author": "ndimiduk", "createdAt": "2020-03-10T16:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMwOTMzMA=="}], "type": "inlineReview"}, {"oid": "a4d8e44030d3c2109938e06eab3522556a8971d7", "url": "https://github.com/apache/hbase/commit/a4d8e44030d3c2109938e06eab3522556a8971d7", "message": "HBASE-23945 Dockerfiles showing hadolint check failures\n\nSigned-off-by: stack <stack@apache.org>", "committedDate": "2020-03-10T19:15:26Z", "type": "commit"}, {"oid": "a4d8e44030d3c2109938e06eab3522556a8971d7", "url": "https://github.com/apache/hbase/commit/a4d8e44030d3c2109938e06eab3522556a8971d7", "message": "HBASE-23945 Dockerfiles showing hadolint check failures\n\nSigned-off-by: stack <stack@apache.org>", "committedDate": "2020-03-10T19:15:26Z", "type": "forcePushed"}]}