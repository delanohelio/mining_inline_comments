{"pr_number": 2753, "pr_title": "HBASE-25368 Filter out more invalid encoded name in isEncodedRegionNa\u2026", "pr_createdAt": "2020-12-08T18:59:03Z", "pr_url": "https://github.com/apache/hbase/pull/2753", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MDI4Ng==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538780286", "bodyText": "What are we protecting against? Could we be passed a tablename? If so, why can't we have a tablename that is an MD5? Or 32 bytes in size?  Should we check it is all hex at least? I suppose if someone passes a tablename that is an md5, then they are asking for trouble?", "author": "saintstack", "createdAt": "2020-12-08T20:23:15Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RegionInfo.java", "diffHunk": "@@ -363,7 +363,23 @@ static TableName getTable(final byte [] regionName) {\n   @InterfaceAudience.Private // For use by internals only.\n   public static boolean isEncodedRegionName(byte[] regionName) {\n     // If not parseable as region name, presume encoded. TODO: add stringency; e.g. if hex.\n-    return parseRegionNameOrReturnNull(regionName) == null && regionName.length <= MD5_HEX_LENGTH;\n+    if (parseRegionNameOrReturnNull(regionName) == null) {\n+      if (regionName.length > MD5_HEX_LENGTH) {\n+        return false;\n+      } else if (regionName.length == MD5_HEX_LENGTH) {\n+        return true;", "originalCommit": "d4167a7292c7d249056fc7a1b721dca7f92ff12a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NTA1Mw==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538795053", "bodyText": "Thanks @saintstack. Two issues are addressed.\nFor compact/flush/split with the tableName,\n`    # Requests a table or region or column family major compaction\ndef major_compact(table_or_region_name, family = nil, type = 'NORMAL')\nfamily_bytes = nil\nfamily_bytes = family.to_java_bytes unless family.nil?\ncompact_type = nil\nif type == 'NORMAL'\ncompact_type = org.apache.hadoop.hbase.client.CompactType::NORMAL\nelsif type == 'MOB'\ncompact_type = org.apache.hadoop.hbase.client.CompactType::MOB\nelse\nraise ArgumentError, 'only NORMAL or MOB accepted for type!'\nend\n  begin\n    if family_bytes.nil?\n      @admin.majorCompactRegion(table_or_region_name.to_java_bytes)\n    else\n      @admin.majorCompactRegion(table_or_region_name.to_java_bytes, family_bytes)\n    end\n  rescue java.lang.IllegalArgumentException, org.apache.hadoop.hbase.UnknownRegionException\n    if family_bytes.nil?\n      @admin.majorCompact(TableName.valueOf(table_or_region_name), compact_type)\n    else\n      @admin.majorCompact(TableName.valueOf(table_or_region_name), family_bytes, compact_type)\n    end\n  end\nend\n\n`\nit first calls majorCompactRegion() with tableName as input. It expects an IllegalArgumentException or UnknownRegionException to call majorCompact().\nThis normally involves a registry query to get this UnknownRegionException, this is an expensive path.\nIf it knows that the input string is not an encodedRegionName or regionName, it can throw out IllegalArgumentException without registry query.\nFor the case that a md5 hex being used as tableName, it has to go through expensive path to find out that this is not an encodedRegionName, it will still work, just optimization wont be applied in this case.\nIt also fixes a bug for a table name length over 32 bytes, currently, compact/flush/split this tableName from shell will fail.", "author": "huaxiangsun", "createdAt": "2020-12-08T20:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MDI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1OTYxMw==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r539859613", "bodyText": "THanks for explanation. Shove this up in the JIRA description? Its good. Thanks.", "author": "saintstack", "createdAt": "2020-12-10T05:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MDI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTI0NA==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538781244", "bodyText": "We know the hbase:meta int. It does not change. Compare it? When meta splits, it will have md5 for new regions.", "author": "saintstack", "createdAt": "2020-12-08T20:24:45Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RegionInfo.java", "diffHunk": "@@ -363,7 +363,23 @@ static TableName getTable(final byte [] regionName) {\n   @InterfaceAudience.Private // For use by internals only.\n   public static boolean isEncodedRegionName(byte[] regionName) {\n     // If not parseable as region name, presume encoded. TODO: add stringency; e.g. if hex.\n-    return parseRegionNameOrReturnNull(regionName) == null && regionName.length <= MD5_HEX_LENGTH;\n+    if (parseRegionNameOrReturnNull(regionName) == null) {\n+      if (regionName.length > MD5_HEX_LENGTH) {\n+        return false;\n+      } else if (regionName.length == MD5_HEX_LENGTH) {\n+        return true;\n+      } else {\n+        String encodedName = Bytes.toString(regionName);\n+        try {\n+          Integer.parseInt(encodedName);\n+          // If this is a valid integer, it could be hbase:meta's encoded region name.\n+          return true;", "originalCommit": "d4167a7292c7d249056fc7a1b721dca7f92ff12a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5ODYwMg==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538798602", "bodyText": "It needs to have meta regionname to compare (another query). This will defeat the purpose of optimization, so instead, it just check if it is an integer. If it is an integer, then this is a possible encoded region name.", "author": "huaxiangsun", "createdAt": "2020-12-08T20:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTU2Nw==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538781567", "bodyText": "How about some tests for this change in this method?", "author": "saintstack", "createdAt": "2020-12-08T20:25:19Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RegionInfo.java", "diffHunk": "@@ -363,7 +363,23 @@ static TableName getTable(final byte [] regionName) {\n   @InterfaceAudience.Private // For use by internals only.\n   public static boolean isEncodedRegionName(byte[] regionName) {\n     // If not parseable as region name, presume encoded. TODO: add stringency; e.g. if hex.\n-    return parseRegionNameOrReturnNull(regionName) == null && regionName.length <= MD5_HEX_LENGTH;\n+    if (parseRegionNameOrReturnNull(regionName) == null) {\n+      if (regionName.length > MD5_HEX_LENGTH) {\n+        return false;\n+      } else if (regionName.length == MD5_HEX_LENGTH) {\n+        return true;\n+      } else {\n+        String encodedName = Bytes.toString(regionName);\n+        try {\n+          Integer.parseInt(encodedName);\n+          // If this is a valid integer, it could be hbase:meta's encoded region name.\n+          return true;\n+        } catch(NumberFormatException er) {\n+          return false;\n+        }\n+      }\n+    }\n+    return false;", "originalCommit": "d4167a7292c7d249056fc7a1b721dca7f92ff12a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwMjIxNw==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538802217", "bodyText": "The new test case testCompactATableWithSuperLongTableName() is for this purpose.\nIt calls majorCompactRegion() for tableName with length over 32 bytes and tested a short-length table name, expecting it throw out the expected exception.", "author": "huaxiangsun", "createdAt": "2020-12-08T20:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzMTg1OQ==", "url": "https://github.com/apache/hbase/pull/2753#discussion_r539631859", "bodyText": "Will remove these two lines, they are used for testing before the new test case.", "author": "huaxiangsun", "createdAt": "2020-12-09T20:40:50Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin1.java", "diffHunk": "@@ -116,6 +130,8 @@ public void testCompactionTimestamps() throws Exception {\n     assertEquals(0, ts);\n \n     ADMIN.flush(tableName);\n+    //ADMIN.majorCompactRegion(Bytes.toBytes(\"abcdefghijklmnopqrstuvwxyzabcdedgeghijklmnopqrs\"));\n+    ADMIN.majorCompactRegion(Bytes.toBytes(\"abcd\"));", "originalCommit": "d4167a7292c7d249056fc7a1b721dca7f92ff12a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2bf1fdefe5d47285833a96d7aa5ef778d5272483", "url": "https://github.com/apache/hbase/commit/2bf1fdefe5d47285833a96d7aa5ef778d5272483", "message": "HBASE-25368 Filter out more invalid encoded name in isEncodedRegionName(byte[] regionName)", "committedDate": "2020-12-10T17:34:54Z", "type": "commit"}, {"oid": "2bf1fdefe5d47285833a96d7aa5ef778d5272483", "url": "https://github.com/apache/hbase/commit/2bf1fdefe5d47285833a96d7aa5ef778d5272483", "message": "HBASE-25368 Filter out more invalid encoded name in isEncodedRegionName(byte[] regionName)", "committedDate": "2020-12-10T17:34:54Z", "type": "forcePushed"}]}