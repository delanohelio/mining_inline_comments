{"pr_number": 1742, "pr_title": "HBASE-24401 Cell size limit check on append should consider 0 or less\u2026", "pr_createdAt": "2020-05-20T03:57:53Z", "pr_url": "https://github.com/apache/hbase/pull/1742", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkxNzQ1MA==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r427917450", "bodyText": "Can we also add debug message for when max cell size check is disabled?", "author": "wchevreuil", "createdAt": "2020-05-20T10:52:05Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -8265,14 +8265,16 @@ private WALEdit reckonDeltas(Operation op, Mutation mutation, Durability effecti\n           break;\n         default: throw new UnsupportedOperationException(op.toString());\n       }\n-      int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n-      if (newCellSize > this.maxCellSize) {\n-        String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n-          + \" bytes in region \" + this;\n-        if (LOG.isDebugEnabled()) {\n-          LOG.debug(msg);\n+      if (this.maxCellSize > 0) {\n+        int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n+        if (newCellSize > this.maxCellSize) {\n+          String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n+            + \" bytes in region \" + this;\n+          if (LOG.isDebugEnabled()) {\n+            LOG.debug(msg);\n+          }\n+          throw new DoNotRetryIOException(msg);\n         }", "originalCommit": "69a3875cecee4dbe189a936b1a9da9efcf03d804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk5OTQxMQ==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r427999411", "bodyText": "I will add debug msg.", "author": "wenbang", "createdAt": "2020-05-20T13:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkxNzQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkxOTY2NA==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r427919664", "bodyText": "NIT: For clarity, can we use HRegion.DEFAULT_MAX_CELL_SIZE + 1, instead?", "author": "wchevreuil", "createdAt": "2020-05-20T10:56:12Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestFromClientSide5.java", "diffHunk": "@@ -2274,6 +2274,20 @@ public void testCellSizeLimit() throws IOException {\n         // expected\n       }\n     }\n+    //test cell size no limit\n+    final TableName noLimitTable = TableName.valueOf(\"testCellSizeNoLimit\");\n+    TableDescriptorBuilder.ModifyableTableDescriptor noLimitTableDescriptor =\n+      new TableDescriptorBuilder.ModifyableTableDescriptor(noLimitTable)\n+        .setValue(HRegion.HBASE_MAX_CELL_SIZE_KEY, Integer.toString(0));\n+    noLimitTableDescriptor.setColumnFamily(familyDescriptor);\n+    try (Admin admin = TEST_UTIL.getAdmin()) {\n+      admin.createTable(noLimitTableDescriptor);\n+    }\n+    // Will succeed\n+    try (Table nt = TEST_UTIL.getConnection().getTable(noLimitTable)) {\n+      nt.put(new Put(ROW).addColumn(FAMILY, QUALIFIER,  new byte[9 * 1024 * 1024]));", "originalCommit": "69a3875cecee4dbe189a936b1a9da9efcf03d804", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAwMjg3MQ==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428002871", "bodyText": "Since the client will also check hbase.client.keyvalue.maxsize, i use HRegion.DEFAULT_MAX_CELL_SIZE - 1024 and 1024 + 1, instead.", "author": "wenbang", "createdAt": "2020-05-20T13:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkxOTY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0ODExNg==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428048116", "bodyText": "We should use log4j parameterized messages feature, that way we don't need the concatenation logic, nor the if statement.", "author": "wchevreuil", "createdAt": "2020-05-20T14:15:53Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -8265,14 +8265,22 @@ private WALEdit reckonDeltas(Operation op, Mutation mutation, Durability effecti\n           break;\n         default: throw new UnsupportedOperationException(op.toString());\n       }\n-      int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n-      if (newCellSize > this.maxCellSize) {\n-        String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n-          + \" bytes in region \" + this;\n+      if (this.maxCellSize > 0) {\n+        int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n+        if (newCellSize > this.maxCellSize) {\n+          String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n+            + \" bytes in region \" + this;\n+          if (LOG.isDebugEnabled()) {\n+            LOG.debug(msg);\n+          }\n+          throw new DoNotRetryIOException(msg);\n+        }\n+      } else {\n+        String msg = \"Cell size check is disabled because of maxCellSize is set to\" +\n+          this.maxCellSize;\n         if (LOG.isDebugEnabled()) {\n           LOG.debug(msg);", "originalCommit": "fd0585e7af058971209f2626a9efbfbe385a1aa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5MTkxMw==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428091913", "bodyText": "ok", "author": "wenbang", "createdAt": "2020-05-20T15:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0ODExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0ODI1Mw==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428048253", "bodyText": "We should use log4j parameterized messages feature, that way we don't need the concatenation logic, nor the if statement.", "author": "wchevreuil", "createdAt": "2020-05-20T14:16:03Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java", "diffHunk": "@@ -983,6 +983,11 @@ private void checkCellSizeLimit(final HRegion r, final Mutation m) throws IOExce\n           throw new DoNotRetryIOException(msg);\n         }\n       }\n+    } else {\n+      String msg = \"Cell size check is disabled because of maxCellSize is set to\" + r.maxCellSize;\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(msg);\n+      }", "originalCommit": "fd0585e7af058971209f2626a9efbfbe385a1aa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5MjAwMQ==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428092001", "bodyText": "ok", "author": "wenbang", "createdAt": "2020-05-20T15:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0ODI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0ODkyOQ==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428048929", "bodyText": "We should use log4j parameterized messages feature, that way we don't need the concatenation logic, nor the if (LOG.isDebugEnabled()) check.", "author": "wchevreuil", "createdAt": "2020-05-20T14:16:55Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -8265,14 +8265,22 @@ private WALEdit reckonDeltas(Operation op, Mutation mutation, Durability effecti\n           break;\n         default: throw new UnsupportedOperationException(op.toString());\n       }\n-      int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n-      if (newCellSize > this.maxCellSize) {\n-        String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n-          + \" bytes in region \" + this;\n+      if (this.maxCellSize > 0) {\n+        int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n+        if (newCellSize > this.maxCellSize) {\n+          String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n+            + \" bytes in region \" + this;\n+          if (LOG.isDebugEnabled()) {\n+            LOG.debug(msg);", "originalCommit": "fd0585e7af058971209f2626a9efbfbe385a1aa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NjI5Ng==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428096296", "bodyText": "I only removed the if (LOG.isDebugEnabled()) check, because msg is also used for DoNotRetryIOException.", "author": "wenbang", "createdAt": "2020-05-20T15:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0ODkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIwODY2OQ==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428208669", "bodyText": "Use the @Rule provided in this class instead of a String for the table name, such as name.getMethodName().", "author": "HorizonNet", "createdAt": "2020-05-20T18:07:44Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestFromClientSide5.java", "diffHunk": "@@ -2274,6 +2274,21 @@ public void testCellSizeLimit() throws IOException {\n         // expected\n       }\n     }\n+    //test cell size no limit\n+    final TableName noLimitTable = TableName.valueOf(\"testCellSizeNoLimit\");", "originalCommit": "85d18707ea15a750d96ec7226f01697d87ffe5a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNTA5NA==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428415094", "bodyText": "Good suggestion, done.", "author": "wenbang", "createdAt": "2020-05-21T02:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIwODY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428394963", "bodyText": "Don't need to log this everytime? Only log once is enough when regionserver start.", "author": "infraio", "createdAt": "2020-05-21T01:22:20Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -8265,14 +8265,17 @@ private WALEdit reckonDeltas(Operation op, Mutation mutation, Durability effecti\n           break;\n         default: throw new UnsupportedOperationException(op.toString());\n       }\n-      int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n-      if (newCellSize > this.maxCellSize) {\n-        String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n-          + \" bytes in region \" + this;\n-        if (LOG.isDebugEnabled()) {\n+      if (this.maxCellSize > 0) {\n+        int newCellSize = PrivateCellUtil.estimatedSerializedSizeOf(newCell);\n+        if (newCellSize > this.maxCellSize) {\n+          String msg = \"Cell with size \" + newCellSize + \" exceeds limit of \" + this.maxCellSize\n+            + \" bytes in region \" + this;\n           LOG.debug(msg);\n+          throw new DoNotRetryIOException(msg);\n         }\n-        throw new DoNotRetryIOException(msg);\n+      } else {\n+        LOG.debug(\"Cell size check is disabled because of maxCellSize is set to {}.\",", "originalCommit": "85d18707ea15a750d96ec7226f01697d87ffe5a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQwNzA4Ng==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428407086", "bodyText": "This parameter can be configured to the column family of the table, different tables can have different values.", "author": "wenbang", "createdAt": "2020-05-21T02:11:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5MjAwMw==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428492003", "bodyText": "ok. I thought this log is not needed. If log this everytime, there are too many logs.", "author": "infraio", "createdAt": "2020-05-21T07:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5ODY1Mg==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428498652", "bodyText": "This log may be not very helpful, @wchevreuil  what do you think ?", "author": "wenbang", "createdAt": "2020-05-21T07:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU0NDg1NA==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428544854", "bodyText": "I removed this log,  because there may be too many logs and not very helpful.", "author": "wenbang", "createdAt": "2020-05-21T09:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3ODc5Ng==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428778796", "bodyText": "I removed this log, because there may be too many logs and not very helpful.\n\nWell, that's why I suggested it to be DEBUG. Logging it only once may not be sufficient in cases where log rolls too quickly.", "author": "wchevreuil", "createdAt": "2020-05-21T16:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA3NjMxOQ==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r429076319", "bodyText": "Well, that's why I suggested it to be DEBUG. Logging it only once may not be sufficient in cases where log rolls too quickly.\n\nWe could check it in the regionserver configuration and table desc. It \u2019s OK to remove this log?", "author": "wenbang", "createdAt": "2020-05-22T07:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE3NDcxOA==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r429174718", "bodyText": "Many users and even experienced developers may not be aware of this changed behaviour. When things don't seem to work as expected, and one doesn't have an idea about why, decreasing the log level to gather as much info as possible is a common practice. I know it would be verbose, but that's why we should make it either a DEBUG or a TRACE level message. The message then would give a clear clue for those who didn't even know about the config property or table attribute.", "author": "wchevreuil", "createdAt": "2020-05-22T10:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NDk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5MjA0OA==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428492048", "bodyText": "Ditto.", "author": "infraio", "createdAt": "2020-05-21T07:31:10Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java", "diffHunk": "@@ -977,12 +977,12 @@ private void checkCellSizeLimit(final HRegion r, final Mutation m) throws IOExce\n         int size = PrivateCellUtil.estimatedSerializedSizeOf(cells.current());\n         if (size > r.maxCellSize) {\n           String msg = \"Cell with size \" + size + \" exceeds limit of \" + r.maxCellSize + \" bytes\";\n-          if (LOG.isDebugEnabled()) {\n-            LOG.debug(msg);\n-          }\n+          LOG.debug(msg);\n           throw new DoNotRetryIOException(msg);\n         }\n       }\n+    } else {\n+      LOG.debug(\"Cell size check is disabled because of maxCellSize is set to {}.\", r.maxCellSize);", "originalCommit": "fc8e993bf9cee199b77b92eda5242e337f161e86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU0NTQxMA==", "url": "https://github.com/apache/hbase/pull/1742#discussion_r428545410", "bodyText": "Removed this log.", "author": "wenbang", "createdAt": "2020-05-21T09:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5MjA0OA=="}], "type": "inlineReview"}, {"oid": "37440aa97ffa08c4cd68cf112bcfceafc094d6a6", "url": "https://github.com/apache/hbase/commit/37440aa97ffa08c4cd68cf112bcfceafc094d6a6", "message": "HBASE-24401 Cell size limit check on append should consider 0\n or less value to disable the check", "committedDate": "2020-05-21T09:14:39Z", "type": "commit"}]}