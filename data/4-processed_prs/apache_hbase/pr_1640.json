{"pr_number": 1640, "pr_title": "HBASE-24309 Avoid introducing log4j and slf4j-log4j dependencies for modules other than hbase-assembly", "pr_createdAt": "2020-05-04T14:01:35Z", "pr_url": "https://github.com/apache/hbase/pull/1640", "timeline": [{"oid": "e3d32a7fe51b0c2eb05fd63d63568a6ba5f15546", "url": "https://github.com/apache/hbase/commit/e3d32a7fe51b0c2eb05fd63d63568a6ba5f15546", "message": "HBASE-24309 Avoid introducing log4j and slf4j-log4j dependencies for modules other than hbase-assembly", "committedDate": "2020-05-06T12:30:42Z", "type": "forcePushed"}, {"oid": "b270f9a5f0a95666fb4887c8e0e374e068623e62", "url": "https://github.com/apache/hbase/commit/b270f9a5f0a95666fb4887c8e0e374e068623e62", "message": "HBASE-24309 Avoid introducing log4j and slf4j-log4j dependencies for modules other than hbase-assembly", "committedDate": "2020-05-08T03:49:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzMzUyNw==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421933527", "bodyText": "Good", "author": "saintstack", "createdAt": "2020-05-08T04:39:25Z", "path": "hbase-archetypes/hbase-client-project/pom.xml", "diffHunk": "@@ -43,31 +43,35 @@\n     <dependency>\n       <groupId>org.apache.hbase</groupId>\n       <artifactId>hbase-testing-util</artifactId>\n-      <version>${project.version}</version>\n       <scope>test</scope>\n     </dependency>\n     <dependency>\n       <groupId>org.apache.hbase</groupId>\n       <artifactId>hbase-common</artifactId>\n-      <version>${project.version}</version>", "originalCommit": "b270f9a5f0a95666fb4887c8e0e374e068623e62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNjcwNw==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421936707", "bodyText": "This is a good note. Should it go elsewhere, in the top-level pom for instance? (Maybe it is there already...  Let me keep going)", "author": "saintstack", "createdAt": "2020-05-08T04:52:33Z", "path": "hbase-assembly/pom.xml", "diffHunk": "@@ -318,5 +318,18 @@\n       <artifactId>jaxws-ri</artifactId>\n       <type>pom</type>\n     </dependency>\n+    <!--\n+      Include the log framework here.\n+      For other sub modules, we only declare slf4j-api as a compile dependency,\n+      so here we must pull in the real logging framework to actually log to log4j.\n+    -->", "originalCommit": "b270f9a5f0a95666fb4887c8e0e374e068623e62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNzA2NA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421937064", "bodyText": "What happens when we run in-situ... i.e. build and then do ./bin/start-hbase.sh? Does it produce logs?", "author": "saintstack", "createdAt": "2020-05-08T04:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NjQ1OA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421986458", "bodyText": "If the tarball is built by running assembly, we will include the slf4j and log4j jars, and also the log4j.properties under conf directory, so it will produce logs.", "author": "Apache9", "createdAt": "2020-05-08T07:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2OTQ0OQ==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r422369449", "bodyText": "I'm asking about running an hbase instance from built checkout, not from an assembly. Currently it works. It looks like it will no longer work if this patch goes in?", "author": "saintstack", "createdAt": "2020-05-08T20:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDgxNQ==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r422440815", "bodyText": "We could do this? I'v never tried this before. How does the start-hbase.sh script find all the dependencies? We do not have a lib directory in the checkout directory...", "author": "Apache9", "createdAt": "2020-05-09T02:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNjcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMzAyNg==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423103026", "bodyText": "Check it out. It has always worked. Good for dev. We build up classpath and cache it.", "author": "saintstack", "createdAt": "2020-05-11T14:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNjcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNzUwMQ==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421937501", "bodyText": "Fixed?", "author": "saintstack", "createdAt": "2020-05-08T04:55:40Z", "path": "hbase-server/pom.xml", "diffHunk": "@@ -481,15 +473,6 @@\n       <artifactId>httpcore</artifactId>\n       <scope>test</scope>\n     </dependency>\n-    <!-- commons-logging is used by HBTU to monkey with log levels\n-         have to put it at compile scope because Hadoop's IOUtils uses it\n-         both for hadoop 2.7 and 3.0, so we'll fail at compile if it's at test scope.\n-      -->\n-    <dependency>\n-      <groupId>commons-logging</groupId>\n-      <artifactId>commons-logging</artifactId>\n-      <scope>compile</scope>\n-    </dependency>", "originalCommit": "b270f9a5f0a95666fb4887c8e0e374e068623e62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNzg2Mg==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421937862", "bodyText": "This is targeted at hbase2 which is to run against hadoop2? This comment that it can't be non-optional is fixed now? Not needed?", "author": "saintstack", "createdAt": "2020-05-08T04:57:08Z", "path": "hbase-shaded/pom.xml", "diffHunk": "@@ -51,15 +51,14 @@\n       <dependency>\n          <groupId>org.apache.hbase</groupId>\n          <artifactId>hbase-resource-bundle</artifactId>\n-         <version>${project.version}</version>\n          <optional>true</optional>\n       </dependency>\n-      <!-- log4j has to be non-optional for Hadoop 2 atleast -->\n+      <!-- put the log implementations to optional -->", "originalCommit": "b270f9a5f0a95666fb4887c8e0e374e068623e62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NTA4OQ==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421985089", "bodyText": "At least for hadoop 2.8+, they have already moved to slf4j.", "author": "Apache9", "createdAt": "2020-05-08T07:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNzg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MTIzNw==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r422441237", "bodyText": "After trying HBASE-19577, some hadoop classes do have dependencies on log4j directly, for example the FSNamesystem class. But usually we do not need to touch this class unless in UT. Anyway, since we are still on log4j after this patch so I think it is fine for now. When switching to log4j2, we need to more testing to find out the direct dependencies on log4j from hadoop and try to fix them.", "author": "Apache9", "createdAt": "2020-05-09T02:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNzg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzODE0NA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r421938144", "bodyText": "Painful.", "author": "saintstack", "createdAt": "2020-05-08T04:58:23Z", "path": "pom.xml", "diffHunk": "@@ -2861,6 +2917,14 @@\n                <groupId>org.codehause.jackson</groupId>\n                <artifactId>jackson-mapper-asl</artifactId>\n              </exclusion>\n+             <exclusion>\n+               <groupId>org.slf4j</groupId>\n+               <artifactId>slf4j-log4j12</artifactId>\n+             </exclusion>\n+             <exclusion>\n+               <groupId>log4j</groupId>\n+               <artifactId>log4j</artifactId>\n+             </exclusion>", "originalCommit": "b270f9a5f0a95666fb4887c8e0e374e068623e62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f468fe1f1a2c4474b6ca0ac33a4e1094cfb9b1f", "url": "https://github.com/apache/hbase/commit/6f468fe1f1a2c4474b6ca0ac33a4e1094cfb9b1f", "message": "HBASE-24309 Avoid introducing log4j and slf4j-log4j dependencies for modules other than hbase-assembly", "committedDate": "2020-05-08T08:19:50Z", "type": "forcePushed"}, {"oid": "b8d41f4a324e41b79efaafa51f5313e2bbe5faa5", "url": "https://github.com/apache/hbase/commit/b8d41f4a324e41b79efaafa51f5313e2bbe5faa5", "message": "HBASE-24309 Avoid introducing log4j and slf4j-log4j dependencies for modules other than hbase-assembly", "committedDate": "2020-05-10T15:20:34Z", "type": "commit"}, {"oid": "b8d41f4a324e41b79efaafa51f5313e2bbe5faa5", "url": "https://github.com/apache/hbase/commit/b8d41f4a324e41b79efaafa51f5313e2bbe5faa5", "message": "HBASE-24309 Avoid introducing log4j and slf4j-log4j dependencies for modules other than hbase-assembly", "committedDate": "2020-05-10T15:20:34Z", "type": "forcePushed"}, {"oid": "1820f20711d8ec87e33f8f0e35628028e84a1106", "url": "https://github.com/apache/hbase/commit/1820f20711d8ec87e33f8f0e35628028e84a1106", "message": "fix checkstyle error", "committedDate": "2020-05-11T01:58:40Z", "type": "commit"}, {"oid": "d0d1d81ac46ad5d46fbda26a7d7965939f13115d", "url": "https://github.com/apache/hbase/commit/d0d1d81ac46ad5d46fbda26a7d7965939f13115d", "message": "ban commons-logging dependencies and ban commons-logging and log4j dependencies from non test code\nadd jcl-over-slf4j and jul-to-slf4j dependencies", "committedDate": "2020-05-11T09:12:24Z", "type": "commit"}, {"oid": "4047141c751bffb5da8d8a2309c9900d115c0558", "url": "https://github.com/apache/hbase/commit/4047141c751bffb5da8d8a2309c9900d115c0558", "message": "remove log4j.properties", "committedDate": "2020-05-11T09:15:31Z", "type": "commit"}, {"oid": "5634becf77927fffa2878a66aa49184f184ab84d", "url": "https://github.com/apache/hbase/commit/5634becf77927fffa2878a66aa49184f184ab84d", "message": "do not exclude log4j.properties in test jar, exclude it in source jar", "committedDate": "2020-05-11T09:49:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMzg3MA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423103870", "bodyText": "There are a few extras here. Thats ok?", "author": "saintstack", "createdAt": "2020-05-11T15:00:20Z", "path": "hbase-assembly/src/main/assembly/client.xml", "diffHunk": "@@ -50,20 +52,22 @@\n               <exclude>com.sun.jersey:*</exclude>\n               <exclude>com.sun.jersey.contribs:*</exclude>\n               <exclude>jline:jline</exclude>\n-        <exclude>com.github.stephenc.findbugs:findbugs-annotations</exclude>\n-        <exclude>commons-logging:commons-logging</exclude>\n-        <exclude>log4j:log4j</exclude>\n-        <exclude>org.apache.hbase:hbase-shaded-client</exclude>\n-        <exclude>org.apache.hbase:hbase-shaded-client-byo-hadoop</exclude>\n-        <exclude>org.apache.hbase:hbase-shaded-mapreduce</exclude>\n-        <exclude>org.apache.htrace:htrace-core4</exclude>\n-        <exclude>org.apache.htrace:htrace-core</exclude>\n-        <exclude>org.apache.yetus:audience-annotations</exclude>\n-        <exclude>org.slf4j:slf4j-api</exclude>\n-        <exclude>org.slf4j:slf4j-log4j12</exclude>\n+              <exclude>com.github.stephenc.findbugs:findbugs-annotations</exclude>\n+              <exclude>commons-logging:commons-logging</exclude>\n+              <exclude>log4j:log4j</exclude>\n+              <exclude>org.apache.hbase:hbase-shaded-client</exclude>\n+              <exclude>org.apache.hbase:hbase-shaded-client-byo-hadoop</exclude>\n+              <exclude>org.apache.hbase:hbase-shaded-mapreduce</exclude>\n+              <exclude>org.apache.htrace:htrace-core4</exclude>\n+              <exclude>org.apache.htrace:htrace-core</exclude>\n+              <exclude>org.apache.yetus:audience-annotations</exclude>\n+              <exclude>org.slf4j:slf4j-api</exclude>\n+              <exclude>org.slf4j:jcl-over-slf4j</exclude>", "originalCommit": "5634becf77927fffa2878a66aa49184f184ab84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEyODAzMA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423128030", "bodyText": "I introduced jcl-over-slf4j and jul-to-slf4j which should also be excluded.", "author": "Apache9", "createdAt": "2020-05-11T15:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwMzg3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNDQ2OA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423104468", "bodyText": "Interesting", "author": "saintstack", "createdAt": "2020-05-11T15:01:04Z", "path": "hbase-asyncfs/pom.xml", "diffHunk": "@@ -72,6 +72,12 @@\n       <type>test-jar</type>\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.hbase</groupId>\n+      <artifactId>hbase-logging</artifactId>", "originalCommit": "5634becf77927fffa2878a66aa49184f184ab84d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNzE0MA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423107140", "bodyText": "Whats jcl and jul?", "author": "saintstack", "createdAt": "2020-05-11T15:04:40Z", "path": "hbase-common/pom.xml", "diffHunk": "@@ -212,9 +221,24 @@\n       <scope>test</scope>\n     </dependency>\n     <dependency>\n-      <!--For Hadoop-->\n+      <groupId>org.slf4j</groupId>\n+      <artifactId>jcl-over-slf4j</artifactId>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.slf4j</groupId>\n+      <artifactId>jul-to-slf4j</artifactId>", "originalCommit": "5634becf77927fffa2878a66aa49184f184ab84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEyNTM0NA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423125344", "bodyText": "Some of our code uses these?", "author": "saintstack", "createdAt": "2020-05-11T15:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNzE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEyOTQ4Nw==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423129487", "bodyText": "java commons-logging and java.util.logging, at least when I tried to ban all the dependencies to commons-logging it was failed, as there are some libraries we use depend on commons-logging, so redirecting the jcl and jul to slf4j could help us to get more log messages from depended libraries, no harm.", "author": "Apache9", "createdAt": "2020-05-11T15:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEwNzE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzExOTE1OA==", "url": "https://github.com/apache/hbase/pull/1640#discussion_r423119158", "bodyText": "Good", "author": "saintstack", "createdAt": "2020-05-11T15:21:29Z", "path": "hbase-logging/src/main/java/org/apache/hadoop/hbase/logging/InternalLog4jUtils.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.logging;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Enumeration;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+/**\n+ * The actual class for operating on log4j.\n+ * <p/>\n+ * This class will depend on log4j directly, so callers should not use this class directly to avoid\n+ * introducing log4j dependencies to downstream users. Please call the methods in\n+ * {@link Log4jUtils}, as they will call the methods here through reflection.", "originalCommit": "5634becf77927fffa2878a66aa49184f184ab84d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}