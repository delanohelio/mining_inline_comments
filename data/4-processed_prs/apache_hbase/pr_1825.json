{"pr_number": 1825, "pr_title": "HBASE-24189 WALSplit recreates region dirs for deleted table with rec\u2026", "pr_createdAt": "2020-06-01T17:36:18Z", "pr_url": "https://github.com/apache/hbase/pull/1825", "timeline": [{"oid": "2120340a4515b6205ce05c945fbd33678748f6a9", "url": "https://github.com/apache/hbase/commit/2120340a4515b6205ce05c945fbd33678748f6a9", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data.", "committedDate": "2020-06-01T17:35:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNTM4OQ==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r433525389", "bodyText": "Should hbase-common know about region dirs? Seems like it knows about table dirs so I suppose this ok.", "author": "saintstack", "createdAt": "2020-06-01T22:35:20Z", "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/util/CommonFSUtils.java", "diffHunk": "@@ -423,6 +423,19 @@ public static Path getTableDir(Path rootdir, final TableName tableName) {\n         tableName.getQualifierAsString());\n   }\n \n+  /**\n+   * Returns the {@link org.apache.hadoop.fs.Path} object representing the region directory under\n+   * path rootdir\n+   *\n+   * @param rootdir qualified path of HBase root directory\n+   * @param tableName name of table\n+   * @param regionName The encoded region name\n+   * @return {@link org.apache.hadoop.fs.Path} for region\n+   */\n+  public static Path getRegionDir(Path rootdir, TableName tableName, String regionName) {", "originalCommit": "2120340a4515b6205ce05c945fbd33678748f6a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNjAyNg==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r433526026", "bodyText": "Is it WAL FS dir or the data/hfile FS?", "author": "saintstack", "createdAt": "2020-06-01T22:37:20Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {\n+            // The region directory itself is not present in the WAL FS. This indicates that", "originalCommit": "2120340a4515b6205ce05c945fbd33678748f6a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwMTcxNg==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r433601716", "bodyText": "Oh ya..  Wrong comments.. I need to change..  We check the data FS only to know whether this is still a valid region or not.  WAL fs might not have the dir unless a wal split happened (in 1.x). From 2.x the WAL FS will always have the region dir once it is 1st opened.", "author": "anoopsjohn", "createdAt": "2020-06-02T03:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNjAyNg=="}], "type": "inlineReview"}, {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8", "url": "https://github.com/apache/hbase/commit/8f2c3b247b0611520771146660ec81ed0d24f8b8", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data.", "committedDate": "2020-06-02T08:38:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Nzk0OA==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434067948", "bodyText": "Is this the right test to do? Should we rather ask the Master if this is an active Region? Asking the FS could be racy?  E.g. something like maser.getAM.getRegionStates().isRegionInRegionStates... It takes HRI which you might not have so you might need to add a version that takes encoded region name?", "author": "saintstack", "createdAt": "2020-06-02T17:59:39Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {", "originalCommit": "8f2c3b247b0611520771146660ec81ed0d24f8b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA4MTM5OQ==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434081399", "bodyText": "Actually thought abt that and even I suggested as an option. Thought that will be bit more risky. Specially in case when the split/merge like ops happening. I feel race chances are more there. At FS level, when the region is created, we will have the region dir in place.\nOn asking, HM my idea was to use a special return value when we ask HM abt the max flushed seqId of the region. Now we return -1 when HM dont know this value for this region. so if we return -2 or so, we can treat it as invalid region.\nBut I felt that is more risky!", "author": "anoopsjohn", "createdAt": "2020-06-02T18:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Nzk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0Mzk0OQ==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434743949", "bodyText": "Master is the authority on state. Reading the FS is reading tea leaves. Let me look at the patch again.", "author": "saintstack", "createdAt": "2020-06-03T17:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Nzk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTEwMg==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434751102", "bodyText": "If the Region no longer exists, should we even be adding state for it in here other than perhaps local state to save having to do expensive lookups again?\nThe comment here exposes some of the soft logic this change depends upon; we are looking at FS and whether a dir is present or not, we then suppose Region present or not.\nI think we should be asking the Master. If it is racy around split/merge, then its a bug given Master transitions are meant to be locked down--not racy. What you think Anoop?", "author": "saintstack", "createdAt": "2020-06-03T17:54:54Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {\n+            // The region directory itself is not present in the FS. This indicates that\n+            // the region/table is already removed. We can just skip all the edits for this\n+            // region. Setting lastFlushedSequenceId as Long.MAX_VALUE so that all edits\n+            // will get skipped by the seqId check below.\n+            // See more details at https://issues.apache.org/jira/browse/HBASE-24189\n+            LOG.debug(\n+                \"Region {} seems not available in the FS. Just skipping all edits for this region\",\n+                encodedRegionNameAsStr);\n+            lastFlushedSequenceId = Long.MAX_VALUE;", "originalCommit": "8f2c3b247b0611520771146660ec81ed0d24f8b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc2MTgwNg==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434761806", "bodyText": "But....ouch.. ouch... ouch. This stuff runs on the RegionServer? You can't ask the Master.. dang.\nSo we are splitting arbitrary WALs.", "author": "saintstack", "createdAt": "2020-06-03T18:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0Mzc1Mw==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r435043753", "bodyText": "Just say, it is a bit strange for me that we dont want to ask master but not mind to ask namenode.  : )", "author": "bsglz", "createdAt": "2020-06-04T07:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYxNzg4NA==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r435617884", "bodyText": "You have a point @bsglz", "author": "saintstack", "createdAt": "2020-06-04T23:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc2Mzc1Mg==", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434763752", "bodyText": "Don't say 'seems'.  LOG this at info level I think. You don't need the word 'region' in the log... it is plain from context.... {} is not on the FS; skipping all edits.", "author": "saintstack", "createdAt": "2020-06-03T18:17:04Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {\n+            // The region directory itself is not present in the FS. This indicates that\n+            // the region/table is already removed. We can just skip all the edits for this\n+            // region. Setting lastFlushedSequenceId as Long.MAX_VALUE so that all edits\n+            // will get skipped by the seqId check below.\n+            // See more details at https://issues.apache.org/jira/browse/HBASE-24189\n+            LOG.debug(\n+                \"Region {} seems not available in the FS. Just skipping all edits for this region\",", "originalCommit": "8f2c3b247b0611520771146660ec81ed0d24f8b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ed7c0f56afcdc3b24e89f4598abca3735434f454", "url": "https://github.com/apache/hbase/commit/ed7c0f56afcdc3b24e89f4598abca3735434f454", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data.", "committedDate": "2020-06-09T06:47:09Z", "type": "commit"}, {"oid": "313967d540a75f6f03cf96cba7f163c46a8a0296", "url": "https://github.com/apache/hbase/commit/313967d540a75f6f03cf96cba7f163c46a8a0296", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data.", "committedDate": "2020-06-11T15:14:13Z", "type": "commit"}]}