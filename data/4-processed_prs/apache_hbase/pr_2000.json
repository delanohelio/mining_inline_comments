{"pr_number": 2000, "pr_title": "HBASE-24658 Update PolicyBasedChaosMonkey to handle uncaught exceptions", "pr_createdAt": "2020-06-29T23:38:03Z", "pr_url": "https://github.com/apache/hbase/pull/2000", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxNTExNQ==", "url": "https://github.com/apache/hbase/pull/2000#discussion_r452815115", "bodyText": "nit: redundant", "author": "virajjasani", "createdAt": "2020-07-10T12:35:29Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/monkies/PolicyBasedChaosMonkey.java", "diffHunk": "@@ -38,14 +42,16 @@\n \n   private static final Logger LOG = LoggerFactory.getLogger(PolicyBasedChaosMonkey.class);", "originalCommit": "0883e6d239eb7bfda6fc29f159a20c43bfcd3154", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMTcxNg==", "url": "https://github.com/apache/hbase/pull/2000#discussion_r452821716", "bodyText": "Would you prefer using our internal\nThreads.newDaemonThreadFactory(String prefix, UncaughtExceptionHandler handler) ?", "author": "virajjasani", "createdAt": "2020-07-10T12:49:04Z", "path": "hbase-it/src/test/java/org/apache/hadoop/hbase/chaos/monkies/PolicyBasedChaosMonkey.java", "diffHunk": "@@ -60,19 +66,30 @@ public PolicyBasedChaosMonkey(IntegrationTestingUtility util, Collection<Policy>\n   }\n \n   public PolicyBasedChaosMonkey(Properties monkeyProps, IntegrationTestingUtility util,\n-    Policy... policies) {\n-    this.monkeyProps = monkeyProps;\n-    this.util = util;\n-    this.policies = policies;\n+    Collection<Policy> policies) {\n+    this(monkeyProps, util, policies.toArray(new Policy[0]));\n   }\n \n   public PolicyBasedChaosMonkey(Properties monkeyProps, IntegrationTestingUtility util,\n-    Collection<Policy> policies) {\n+    Policy... policies) {\n     this.monkeyProps = monkeyProps;\n-    this.util = util;\n-    this.policies = policies.toArray(new Policy[policies.size()]);\n+    this.util = Objects.requireNonNull(util);\n+    this.policies = Objects.requireNonNull(policies);\n+    if (policies.length == 0) {\n+      throw new IllegalArgumentException(\"policies may not be empty\");\n+    }\n+    this.monkeyThreadPool = buildMonkeyThreadPool(policies.length);\n   }\n \n+  private static ExecutorService buildMonkeyThreadPool(final int size) {\n+    return Executors.newFixedThreadPool(size, new ThreadFactoryBuilder()", "originalCommit": "0883e6d239eb7bfda6fc29f159a20c43bfcd3154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzNjQ3NQ==", "url": "https://github.com/apache/hbase/pull/2000#discussion_r452936475", "bodyText": "This one actually sets daemon to true, we don't want that so maybe we can have separate method for setting daemon to false.\nHowever, this work could be separate Jira and if we have majority, maybe we can make all Executor pool in HBase use our internal ThreadFactory and not from guava.", "author": "virajjasani", "createdAt": "2020-07-10T16:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMTcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc1NTYzOQ==", "url": "https://github.com/apache/hbase/pull/2000#discussion_r457755639", "bodyText": "It would be nice if we could either get away from using Guava helpers or get away from providing our own. Having both in the code keeps us guessing :)", "author": "ndimiduk", "createdAt": "2020-07-20T23:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMTcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2MzEyNA==", "url": "https://github.com/apache/hbase/pull/2000#discussion_r458263124", "bodyText": "That's true, we should use only one of them, filed: https://issues.apache.org/jira/browse/HBASE-24750", "author": "virajjasani", "createdAt": "2020-07-21T17:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMTcxNg=="}], "type": "inlineReview"}, {"oid": "429bef788d706aba216536597ceb89d282b27231", "url": "https://github.com/apache/hbase/commit/429bef788d706aba216536597ceb89d282b27231", "message": "HBASE-24658 Update PolicyBasedChaosMonkey to handle uncaught exceptions\n\nRunning `ServerKillingChaosMonkey` via `RESTApiClusterManager` for any\nduration of time slowly leaks region servers. I see failures on the\nRESTApi side go unreported on the ChaosMonkey side. It seems like\n`RuntimeException`s are being thrown and lost.\n\n`PolicyBasedChaosMonkey` uses a primitive means of thread management\nanyway. Update to use a thread pool, thread groups, and an\nuncaughtExceptionHandler.\n\nSigned-off-by: Bharath Vissapragada <bharathv@apache.org>", "committedDate": "2020-07-20T23:50:42Z", "type": "forcePushed"}, {"oid": "9318c2e309027f04853f491d8f8721ecc078f80b", "url": "https://github.com/apache/hbase/commit/9318c2e309027f04853f491d8f8721ecc078f80b", "message": "HBASE-24658 Update PolicyBasedChaosMonkey to handle uncaught exceptions\n\nRunning `ServerKillingChaosMonkey` via `RESTApiClusterManager` for any\nduration of time slowly leaks region servers. I see failures on the\nRESTApi side go unreported on the ChaosMonkey side. It seems like\n`RuntimeException`s are being thrown and lost.\n\n`PolicyBasedChaosMonkey` uses a primitive means of thread management\nanyway. Update to use a thread pool, thread groups, and an\nuncaughtExceptionHandler.\n\nSigned-off-by: Bharath Vissapragada <bharathv@apache.org>\nSigned-off-by: Viraj Jasani <vjasani@apache.org>", "committedDate": "2020-07-20T23:54:46Z", "type": "commit"}, {"oid": "9318c2e309027f04853f491d8f8721ecc078f80b", "url": "https://github.com/apache/hbase/commit/9318c2e309027f04853f491d8f8721ecc078f80b", "message": "HBASE-24658 Update PolicyBasedChaosMonkey to handle uncaught exceptions\n\nRunning `ServerKillingChaosMonkey` via `RESTApiClusterManager` for any\nduration of time slowly leaks region servers. I see failures on the\nRESTApi side go unreported on the ChaosMonkey side. It seems like\n`RuntimeException`s are being thrown and lost.\n\n`PolicyBasedChaosMonkey` uses a primitive means of thread management\nanyway. Update to use a thread pool, thread groups, and an\nuncaughtExceptionHandler.\n\nSigned-off-by: Bharath Vissapragada <bharathv@apache.org>\nSigned-off-by: Viraj Jasani <vjasani@apache.org>", "committedDate": "2020-07-20T23:54:46Z", "type": "forcePushed"}]}