{"pr_number": 2056, "pr_title": "HBASE-24710 Incorrect checksum calculation in saveVersion.sh", "pr_createdAt": "2020-07-13T12:35:56Z", "pr_url": "https://github.com/apache/hbase/pull/2056", "timeline": [{"oid": "686e04177674de657c5ee8aca6580c65a5a58166", "url": "https://github.com/apache/hbase/commit/686e04177674de657c5ee8aca6580c65a5a58166", "message": "HBASE-24710 Incorrect checksum calculation in saveVersion.sh", "committedDate": "2020-07-13T12:34:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2ODMwMA==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r455168300", "bodyText": "I think dropping the | between sort and xargs is a bug. I believe this calculates the sha512 of the sort error message, not the sha512 of the sha512s of the contents of all the files.\nOn a mac anyway, I get\n$ find hbase-common/src/main/ | grep -e \"\\.java\" | LC_ALL=C sort xargs gpg --print-md sha512\nsort: unrecognized option `--print-md'\nUsage: sort [-bcCdfigMmnrsuz] [-kPOS1[,POS2] ... ] [+POS1 [-POS2]] [-S memsize] [-T tmpdir] [-t separator] [-o outfile] [--batch-size size] [--files0-from file] [--heapsort] [--mergesort] [--radixsort] [--qsort] [--mmap] [--parallel thread_no] [--human-numeric-sort] [--version-sort] [--random-sort [--random-source file]] [--compress-program program] [file ...]\n$ find hbase-common/src/main/ | grep -e \"\\.java\" | LC_ALL=C sort xargs openssl dgst -sha512\nsort: invalid option -- a\nUsage: sort [-bcCdfigMmnrsuz] [-kPOS1[,POS2] ... ] [+POS1 [-POS2]] [-S memsize] [-T tmpdir] [-t separator] [-o outfile] [--batch-size size] [--files0-from file] [--heapsort] [--mergesort] [--radixsort] [--qsort] [--mmap] [--parallel thread_no] [--human-numeric-sort] [--version-sort] [--random-sort [--random-source file]] [--compress-program program] [file ...]", "author": "ndimiduk", "createdAt": "2020-07-15T16:13:01Z", "path": "hbase-common/src/saveVersion.sh", "diffHunk": "@@ -30,34 +30,34 @@ nativeOutputDirectory=\"$2/native/utils/\"\n pushd .\n cd ..\n \n-user=`whoami | sed -n -e 's/\\\\\\/\\\\\\\\\\\\\\\\/p'`\n+user=$(whoami | sed -n -e \"s/\\\\\\/\\\\\\\\\\\\\\\\/p\")\n if [ \"$user\" == \"\" ]\n then\n-  user=`whoami`\n+  user=$(whoami)\n fi\n-date=`date`\n-cwd=`pwd`\n+date=$(date)\n+cwd=$(pwd)\n if [ -d .svn ]; then\n-  revision=`(svn info | sed -n -e 's/Last Changed Rev: \\(.*\\)/\\1/p') || true`\n-  url=`(svn info | sed -n -e 's/^URL: \\(.*\\)/\\1/p') || true`\n+  revision=$( (svn info | sed -n -e \"s/Last Changed Rev: \\(.*\\)/\\1/p\") || true)\n+  url=$( (svn info | sed -n -e 's/^URL: \\(.*\\)/\\1/p') || true)\n elif [ -d .git ]; then\n-  revision=`git log -1 --no-show-signature --pretty=format:\"%H\" || true`\n-  hostname=`hostname`\n+  revision=$(git log -1 --no-show-signature --pretty=format:\"%H\" || true)\n+  hostname=$(hostname)\n   url=\"git://${hostname}${cwd}\"\n fi\n if [ -z \"${revision}\" ]; then\n   echo \"[WARN] revision info is empty! either we're not in VCS or VCS commands failed.\" >&2\n   revision=\"Unknown\"\n   url=\"file://$cwd\"\n fi\n-if ! [  -x \"$(command -v openssl)\" ]; then\n+if ! [ -x \"$(command -v openssl)\" ]; then\n   if ! [ -x \"$(command -v gpg)\" ]; then\n     srcChecksum=\"Unknown\"\n   else\n-    srcChecksum=`find hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort | xargs gpg --print-md sha512 | gpg --print-md sha512 | cut -d ' ' -f 1`\n+    srcChecksum=$(find hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort xargs gpg --print-md sha512 | gpg --print-md sha512 | tr '\\n' ' ' | sed 's/[[:space:]]*//g')", "originalCommit": "686e04177674de657c5ee8aca6580c65a5a58166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzE2Mg==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r455187162", "bodyText": "Yes, dropping | is a bug, let me fix it.", "author": "petersomogyi", "createdAt": "2020-07-15T16:44:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2ODMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3NzcxNQ==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r455177715", "bodyText": "Previous use of cut here at the end is surprising. It took only the first block...", "author": "ndimiduk", "createdAt": "2020-07-15T16:28:38Z", "path": "hbase-common/src/saveVersion.sh", "diffHunk": "@@ -30,34 +30,34 @@ nativeOutputDirectory=\"$2/native/utils/\"\n pushd .\n cd ..\n \n-user=`whoami | sed -n -e 's/\\\\\\/\\\\\\\\\\\\\\\\/p'`\n+user=$(whoami | sed -n -e \"s/\\\\\\/\\\\\\\\\\\\\\\\/p\")\n if [ \"$user\" == \"\" ]\n then\n-  user=`whoami`\n+  user=$(whoami)\n fi\n-date=`date`\n-cwd=`pwd`\n+date=$(date)\n+cwd=$(pwd)\n if [ -d .svn ]; then\n-  revision=`(svn info | sed -n -e 's/Last Changed Rev: \\(.*\\)/\\1/p') || true`\n-  url=`(svn info | sed -n -e 's/^URL: \\(.*\\)/\\1/p') || true`\n+  revision=$( (svn info | sed -n -e \"s/Last Changed Rev: \\(.*\\)/\\1/p\") || true)\n+  url=$( (svn info | sed -n -e 's/^URL: \\(.*\\)/\\1/p') || true)\n elif [ -d .git ]; then\n-  revision=`git log -1 --no-show-signature --pretty=format:\"%H\" || true`\n-  hostname=`hostname`\n+  revision=$(git log -1 --no-show-signature --pretty=format:\"%H\" || true)\n+  hostname=$(hostname)\n   url=\"git://${hostname}${cwd}\"\n fi\n if [ -z \"${revision}\" ]; then\n   echo \"[WARN] revision info is empty! either we're not in VCS or VCS commands failed.\" >&2\n   revision=\"Unknown\"\n   url=\"file://$cwd\"\n fi\n-if ! [  -x \"$(command -v openssl)\" ]; then\n+if ! [ -x \"$(command -v openssl)\" ]; then\n   if ! [ -x \"$(command -v gpg)\" ]; then\n     srcChecksum=\"Unknown\"\n   else\n-    srcChecksum=`find hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort | xargs gpg --print-md sha512 | gpg --print-md sha512 | cut -d ' ' -f 1`", "originalCommit": "686e04177674de657c5ee8aca6580c65a5a58166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4OTEzMw==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r455189133", "bodyText": "Based on history it was used for md5 and md5sum commands but it wasn't removed when SHA512 was introduced in saveVersion.sh.\nroot@8224f4c69e6f:/# echo \"foo\" | md5sum\nd3b07384d113edec49eaa6238ad5ff00  -", "author": "petersomogyi", "createdAt": "2020-07-15T16:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3NzcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3NDcxMg==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r456574712", "bodyText": "Does tr -d '[:space:]' work? It's simpler and shorter than tr '\\n' ' ' | sed 's/[[:space:]]*//g'", "author": "liuml07", "createdAt": "2020-07-17T17:23:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3NzcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM5MDYwNw==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r457390607", "bodyText": "I get a different output from your command, an extra %.\nfind hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort | xargs gpg --print-md sha512 | gpg --print-md sha512 | tr -d '[:space:]'\n3BF4CCC275112769C7AB0EDC302793FB81005BDC9681E1604BD965918363FC93311FC60B24000563DD4D3EFDA10685F549721A28428F23487813A7397FBC9BD0%\nind hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort | xargs gpg --print-md sha512 | gpg --print-md sha512 | tr '\\n' ' ' | sed 's/[[:space:]]*//g'\n3BF4CCC275112769C7AB0EDC302793FB81005BDC9681E1604BD965918363FC93311FC60B24000563DD4D3EFDA10685F549721A28428F23487813A7397FBC9BD0", "author": "petersomogyi", "createdAt": "2020-07-20T13:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3NzcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczOTQ3Mg==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r457739472", "bodyText": "That's weird. I did not see in my macOS and Ubuntu Linux. But since this is not reliable, I guess we can stay with your script tr and sed - which works for me on both macOS and Ubuntu.", "author": "liuml07", "createdAt": "2020-07-20T23:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3NzcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3OTg2OA==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r455179868", "bodyText": "what is the purpose of the final sed? I see no difference.\n$ echo \"foo\" | openssl dgst -sha512 | sed 's/^.* //'\n0cf9180a764aba863a67b6d72f0918bc131c6772642cb2dce5a34f0a702f9470ddc2bf125c12198b1995c233c34b4afd346c54a2334c350a948a51b6e8b4e6b6\n$ echo \"foo\" | openssl dgst -sha512\n0cf9180a764aba863a67b6d72f0918bc131c6772642cb2dce5a34f0a702f9470ddc2bf125c12198b1995c233c34b4afd346c54a2334c350a948a51b6e8b4e6b6", "author": "ndimiduk", "createdAt": "2020-07-15T16:32:01Z", "path": "hbase-common/src/saveVersion.sh", "diffHunk": "@@ -30,34 +30,34 @@ nativeOutputDirectory=\"$2/native/utils/\"\n pushd .\n cd ..\n \n-user=`whoami | sed -n -e 's/\\\\\\/\\\\\\\\\\\\\\\\/p'`\n+user=$(whoami | sed -n -e \"s/\\\\\\/\\\\\\\\\\\\\\\\/p\")\n if [ \"$user\" == \"\" ]\n then\n-  user=`whoami`\n+  user=$(whoami)\n fi\n-date=`date`\n-cwd=`pwd`\n+date=$(date)\n+cwd=$(pwd)\n if [ -d .svn ]; then\n-  revision=`(svn info | sed -n -e 's/Last Changed Rev: \\(.*\\)/\\1/p') || true`\n-  url=`(svn info | sed -n -e 's/^URL: \\(.*\\)/\\1/p') || true`\n+  revision=$( (svn info | sed -n -e \"s/Last Changed Rev: \\(.*\\)/\\1/p\") || true)\n+  url=$( (svn info | sed -n -e 's/^URL: \\(.*\\)/\\1/p') || true)\n elif [ -d .git ]; then\n-  revision=`git log -1 --no-show-signature --pretty=format:\"%H\" || true`\n-  hostname=`hostname`\n+  revision=$(git log -1 --no-show-signature --pretty=format:\"%H\" || true)\n+  hostname=$(hostname)\n   url=\"git://${hostname}${cwd}\"\n fi\n if [ -z \"${revision}\" ]; then\n   echo \"[WARN] revision info is empty! either we're not in VCS or VCS commands failed.\" >&2\n   revision=\"Unknown\"\n   url=\"file://$cwd\"\n fi\n-if ! [  -x \"$(command -v openssl)\" ]; then\n+if ! [ -x \"$(command -v openssl)\" ]; then\n   if ! [ -x \"$(command -v gpg)\" ]; then\n     srcChecksum=\"Unknown\"\n   else\n-    srcChecksum=`find hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort | xargs gpg --print-md sha512 | gpg --print-md sha512 | cut -d ' ' -f 1`\n+    srcChecksum=$(find hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort xargs gpg --print-md sha512 | gpg --print-md sha512 | tr '\\n' ' ' | sed 's/[[:space:]]*//g')\n   fi\n else\n-  srcChecksum=`find hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort | xargs openssl dgst -sha512 | openssl dgst -sha512 | cut -d ' ' -f 1`\n+  srcChecksum=$(find hbase-*/src/main/ | grep -e \"\\.java\" -e \"\\.proto\" | LC_ALL=C sort xargs openssl dgst -sha512 | openssl dgst -sha512 | sed 's/^.* //')", "originalCommit": "686e04177674de657c5ee8aca6580c65a5a58166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4MTYxMg==", "url": "https://github.com/apache/hbase/pull/2056#discussion_r455181612", "bodyText": "Oh, this is the example from your comment on JIRA, a difference between the mac and linux versions of openssl dgst. Disregard.", "author": "ndimiduk", "createdAt": "2020-07-15T16:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE3OTg2OA=="}], "type": "inlineReview"}, {"oid": "73f809afd0569d6b696d54ea2724f8568c98ce67", "url": "https://github.com/apache/hbase/commit/73f809afd0569d6b696d54ea2724f8568c98ce67", "message": "Add missing pipe", "committedDate": "2020-07-15T17:01:52Z", "type": "commit"}]}