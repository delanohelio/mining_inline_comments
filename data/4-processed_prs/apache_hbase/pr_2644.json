{"pr_number": 2644, "pr_title": "HBASE-25127 Enhance PerformanceEvaluation to profile meta replica performance.", "pr_createdAt": "2020-11-11T00:39:35Z", "pr_url": "https://github.com/apache/hbase/pull/2644", "timeline": [{"oid": "f3040056543b02a9126f815eca1fa13f32c36e5b", "url": "https://github.com/apache/hbase/commit/f3040056543b02a9126f815eca1fa13f32c36e5b", "message": "HBASE-25006 Make the cost functions optional for StochastoicBalancer", "committedDate": "2020-09-11T18:14:37Z", "type": "commit"}, {"oid": "4a9cec9154a0a9cc67b9f4207e0de09aadd00206", "url": "https://github.com/apache/hbase/commit/4a9cec9154a0a9cc67b9f4207e0de09aadd00206", "message": "Revert \"HBASE-25006 Make the cost functions optional for StochastoicBalancer\"\n\nThis reverts commit f3040056543b02a9126f815eca1fa13f32c36e5b.", "committedDate": "2020-11-11T00:34:18Z", "type": "commit"}, {"oid": "c07a388612f2a9ac759f4698859e35acff9ec341", "url": "https://github.com/apache/hbase/commit/c07a388612f2a9ac759f4698859e35acff9ec341", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-11-11T00:35:07Z", "type": "commit"}, {"oid": "29a3d0dab81097c8e56cfe6003028b9753100349", "url": "https://github.com/apache/hbase/commit/29a3d0dab81097c8e56cfe6003028b9753100349", "message": "HBASE-25127 add meta write and read tests", "committedDate": "2020-11-11T00:37:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521010199", "bodyText": "the return value is not used?", "author": "Apache9", "createdAt": "2020-11-11T01:50:49Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1998,6 +2006,41 @@ protected void testTakedown() throws IOException {\n       super.testTakedown();\n     }\n   }\n+  static class MetaRandomReadTest extends TableTest {\n+    private Random rd = new Random();\n+    private RegionLocator regionLocator;\n+\n+    MetaRandomReadTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+      LOG.info(\"call getRegionLocation\");\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+      this.table = connection.getTable(TableName.valueOf(\"hbase:meta\"));\n+      this.regionLocator = connection.getRegionLocator(TableName.valueOf(\"hbase:meta\"));\n+    }\n+\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException, InterruptedException {\n+      if (opts.randomSleep > 0) {\n+        Thread.sleep(rd.nextInt(opts.randomSleep));\n+      }\n+      HRegionLocation hRegionLocation = regionLocator.getRegionLocation(Bytes.toBytes(Integer.toString(rd.nextInt(100) + 1)), true);", "originalCommit": "29a3d0dab81097c8e56cfe6003028b9753100349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyOTY0NA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521129644", "bodyText": "Right. I was thinking to add trace in the case of troubleshooting but not sure.", "author": "clarax", "createdAt": "2020-11-11T05:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEyOTgwOA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521129808", "bodyText": "MetaWriteTest should be executed before MetaReadTest to populate the table.", "author": "clarax", "createdAt": "2020-11-11T05:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODk0NA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521598944", "bodyText": "Can we generate a correct key, let's say 'aaabc' and get the location, and make sure that the key falls in the boundary of [region.startKey, region.endKey), it will be great.", "author": "huaxiangsun", "createdAt": "2020-11-11T19:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYwMDAzMg==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521600032", "bodyText": "For PE meta read testing, at the end of the test, can we get the read/write count for all meta regions? This will help us to see if read load is distributed among all meta replica regions.", "author": "huaxiangsun", "createdAt": "2020-11-11T19:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEyMjIyOQ==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r522122229", "bodyText": "Right. I was thinking to add trace in the case of troubleshooting but not sure.\n\nThen lt's remove it? Otherwise there will be a checkstyle warning.", "author": "Apache9", "createdAt": "2020-11-12T13:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwMDQ3Ng==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523200476", "bodyText": "added logging", "author": "clarax", "createdAt": "2020-11-13T20:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwMTIzOQ==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523201239", "bodyText": "Added split key generation so write, read and clean up will work with regions with continuous range of start key and end key.", "author": "clarax", "createdAt": "2020-11-13T20:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDc2Mg==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521010762", "bodyText": "This will be a bit confusing that we add \"hbase:meta\" to hbase:meta?", "author": "Apache9", "createdAt": "2020-11-11T01:51:36Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2276,7 +2319,38 @@ boolean testRow(final int i, final long startTime) throws IOException {\n       return true;\n     }\n   }\n+  static class MetaWriteTest extends Test {\n+\n+    MetaWriteTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+    }\n \n+    @Override\n+    void onTakedown() throws IOException {\n+    }\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException {\n+      List<RegionInfo> regionInfos = new ArrayList<RegionInfo>();\n+\n+      for (int index = 0; index < i; index++) {\n+        regionInfos.add(RegionInfoBuilder.newBuilder(TableName.valueOf(\"hbase:meta\"))", "originalCommit": "29a3d0dab81097c8e56cfe6003028b9753100349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwMDMyNg==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523200326", "bodyText": "Thanks. changed to the default test table.", "author": "clarax", "createdAt": "2020-11-13T20:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NjI0OA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521596248", "bodyText": "We do not need to set region id, builder will fill it internally, same for offline(), repilcaId, split bit.\nWe do need to set the startKey and endKey correctly to make sure that there is no overlay for regions. I think it is only one region if startKey and endKey are same.\nWe need to use the following as an example, it will insert about 11m entries to metatable, which has the continuous key space.\nbyte[5] startKey, endKey;\nfor (byte b1 = 'a'; b1 <= 'z'; b1++) {\nstartKey[0] = b1;\nendKey[0] = b1;\nfor (byte b2 = 'a'; b2 <= 'z'; b2++) {\nstartKey[1] = b2;\nendKey[1] = b2;\nfor (byte b3 = 'a'; b3 <= 'z'; b3++) {\nstartKey[2] = b3;\nendKey[2] = b3;\nfor (byte b4 = 'a'; b4 <= 'z'; b4++) {\nstartKey[3] = b4;\nendKey[3] = b4;\nfor (byte b5 = 'a'; b5 <= 'z'; b5++) {\nendKey[4] = b5;\nif (b5 == 'a') {\nstartKey[4] = '';\n}\n// TODO: add to Meta\nstartKey[4] = endKey[4];\n}\n}\n}\n}", "author": "huaxiangsun", "createdAt": "2020-11-11T19:42:59Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2276,7 +2319,38 @@ boolean testRow(final int i, final long startTime) throws IOException {\n       return true;\n     }\n   }\n+  static class MetaWriteTest extends Test {\n+\n+    MetaWriteTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+    }\n \n+    @Override\n+    void onTakedown() throws IOException {\n+    }\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException {\n+      List<RegionInfo> regionInfos = new ArrayList<RegionInfo>();\n+\n+      for (int index = 0; index < i; index++) {\n+        regionInfos.add(RegionInfoBuilder.newBuilder(TableName.valueOf(\"hbase:meta\"))\n+          .setRegionId(this.rand.nextLong())", "originalCommit": "29a3d0dab81097c8e56cfe6003028b9753100349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYwNjk5OA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521606998", "bodyText": "Just found out that there is no info family. Can we populate this info to meta table as well? Sample code as below, we can populate the same server info here.\n`ServerName sn = ServerName.valueOf(\"bar\", 0, 0);\ntry (Table meta = MetaTableAccessor.getMetaHTable(UTIL.getConnection())) {\nList regionInfos = Lists.newArrayList(regionInfoA, regionInfoB);\nMetaTableAccessor.addRegionsToMeta(UTIL.getConnection(), regionInfos, 1);\n  // write the serverName column with a big current time, but set the masters time as even\n  // bigger. When region merge deletes the rows for regionA and regionB, the serverName columns\n  // should not be seen by the following get\n  long serverNameTime = EnvironmentEdgeManager.currentTime() + 100000000;\n  long masterSystemTime = EnvironmentEdgeManager.currentTime() + 123456789;\n\n  // write the serverName columns\n  MetaTableAccessor.updateRegionLocation(UTIL.getConnection(), regionInfoA, sn, 1,\n    serverNameTime);`", "author": "huaxiangsun", "createdAt": "2020-11-11T20:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NjI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwMTM5Ng==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523201396", "bodyText": "added both. Thank you.", "author": "clarax", "createdAt": "2020-11-13T20:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NjI0OA=="}], "type": "inlineReview"}, {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab", "url": "https://github.com/apache/hbase/commit/6d01acd7833bcebaa817c883020edab99c7a7bab", "message": "PR review feedback", "committedDate": "2020-11-13T22:40:08Z", "type": "commit"}, {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab", "url": "https://github.com/apache/hbase/commit/6d01acd7833bcebaa817c883020edab99c7a7bab", "message": "PR review feedback", "committedDate": "2020-11-13T22:40:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMzIyMQ==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523303221", "bodyText": "Do we want to tie this to the new cleanMeta? i.e. in the help text here say cleanMeta cleans up the writes done by this test run?", "author": "saintstack", "createdAt": "2020-11-14T00:48:40Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -187,11 +192,12 @@\n       \"Run sequential read test\");\n     addCommandDescriptor(SequentialWriteTest.class, \"sequentialWrite\",\n       \"Run sequential write test\");\n-    addCommandDescriptor(ScanTest.class, \"scan\",\n-      \"Run scan test (read every row)\");\n+    addCommandDescriptor(MetaWriteTest.class, \"metaWrite\",\n+      \"Run addRegion test to populate meta table; used with 1 thread\");", "originalCommit": "6d01acd7833bcebaa817c883020edab99c7a7bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMzI1MQ==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523303251", "bodyText": "No harm in a class comment?", "author": "saintstack", "createdAt": "2020-11-14T00:48:54Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1481,6 +1489,28 @@ void onTakedown() throws IOException {\n     }\n   }\n \n+  static abstract class MetaTest extends TableTest {", "originalCommit": "6d01acd7833bcebaa817c883020edab99c7a7bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMzUwOQ==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523303509", "bodyText": "Add empty line above? Class comment on what this does?", "author": "saintstack", "createdAt": "2020-11-14T00:49:57Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1998,6 +2028,45 @@ protected void testTakedown() throws IOException {\n       super.testTakedown();\n     }\n   }\n+  static class MetaRandomReadTest extends MetaTest {", "originalCommit": "6d01acd7833bcebaa817c883020edab99c7a7bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDM0Ng==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304346", "bodyText": "No need of the if debug test... use parameterized logging... \"Get location for {}\", hRegionLocation.... no need of 'region' in log message.", "author": "saintstack", "createdAt": "2020-11-14T00:54:47Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1998,6 +2028,45 @@ protected void testTakedown() throws IOException {\n       super.testTakedown();\n     }\n   }\n+  static class MetaRandomReadTest extends MetaTest {\n+    private Random rd = new Random();\n+    private RegionLocator regionLocator;\n+\n+    MetaRandomReadTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+      LOG.info(\"call getRegionLocation\");\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+      super.onStartup();\n+      this.regionLocator = connection.getRegionLocator(table.getName());\n+    }\n+\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException, InterruptedException {\n+      if (opts.randomSleep > 0) {\n+        Thread.sleep(rd.nextInt(opts.randomSleep));\n+      }\n+      HRegionLocation hRegionLocation = regionLocator.getRegionLocation(\n+        getSplitKey(rd.nextInt(opts.perClientRunRows)), true);\n+      if (LOG.isDebugEnabled()) {", "originalCommit": "6d01acd7833bcebaa817c883020edab99c7a7bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDQyNA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304424", "bodyText": "No harm in class comment on what this does.", "author": "saintstack", "createdAt": "2020-11-14T00:55:11Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2188,6 +2257,32 @@ boolean testRow(final int i, final long startTime) throws IOException {\n     }\n   }\n \n+  static class CleanMetaTest extends MetaTest {", "originalCommit": "6d01acd7833bcebaa817c883020edab99c7a7bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDU2NA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304564", "bodyText": "No need of test for isdebug if parameterized logging.", "author": "saintstack", "createdAt": "2020-11-14T00:55:58Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2188,6 +2257,32 @@ boolean testRow(final int i, final long startTime) throws IOException {\n     }\n   }\n \n+  static class CleanMetaTest extends MetaTest {\n+    CleanMetaTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+    }\n+\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException {\n+      try {\n+        RegionInfo regionInfo = connection.getRegionLocator(table.getName())\n+          .getRegionLocation(getSplitKey(i), false).getRegion();\n+        if (LOG.isDebugEnabled()) {", "originalCommit": "6d01acd7833bcebaa817c883020edab99c7a7bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDY0MA==", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304640", "bodyText": "Add empty line above and class comment.", "author": "saintstack", "createdAt": "2020-11-14T00:56:25Z", "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2276,7 +2371,29 @@ boolean testRow(final int i, final long startTime) throws IOException {\n       return true;\n     }\n   }\n+  static class MetaWriteTest extends MetaTest {", "originalCommit": "6d01acd7833bcebaa817c883020edab99c7a7bab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db5db84827c2284df8e778e9f24e9d993155eb95", "url": "https://github.com/apache/hbase/commit/db5db84827c2284df8e778e9f24e9d993155eb95", "message": "style update", "committedDate": "2020-11-14T01:11:48Z", "type": "commit"}]}