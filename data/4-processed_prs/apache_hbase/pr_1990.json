{"pr_number": 1990, "pr_title": "HBASE-24648 Remove the legacy 'forceSplit' related code at region ser\u2026", "pr_createdAt": "2020-06-27T15:36:26Z", "pr_url": "https://github.com/apache/hbase/pull/1990", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxOTYxOQ==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446619619", "bodyText": "Seems unintentional change?", "author": "virajjasani", "createdAt": "2020-06-28T08:31:32Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/SplitTableRegionProcedure.java", "diffHunk": "@@ -167,12 +167,15 @@ public RegionInfo getDaughterTwoRI() {\n     return daughterTwoRI;\n   }\n \n+  private boolean hasBestSplitRow() {\n+    return bestSplitRow != null && bestSplitRow.length > 0;\n+  }\n+\n   /**\n    * Check whether the region is splittable\n    * @param env MasterProcedureEnv\n    * @param regionToSplit parent Region to be split\n    * @param splitRow if splitRow is not specified, will first try to get bestSplitRow from RS\n-   * @throws IOException", "originalCommit": "4f9abeeba9d17bdd1d417513ac3010ed40241b83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY2MzgxMQ==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446663811", "bodyText": "Empty throws will lead to a checkstyle warning.", "author": "Apache9", "createdAt": "2020-06-28T15:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc5NzIwOQ==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446797209", "bodyText": "Oh ok, then we can write description of IOException as thrown if region is not splittable?\nI thought spotbugs would give warning if we remove @throws from javadoc but method actually throws Exception.\nAnyways, this is minor comment.", "author": "virajjasani", "createdAt": "2020-06-29T06:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwOTgwNQ==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446809805", "bodyText": "This is just javadoc, we do not have rules to enforce javadoc for a method?", "author": "Apache9", "createdAt": "2020-06-29T06:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzNDAzNg==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446834036", "bodyText": "Ok, as far as current checkstyle is fine, we are good.", "author": "virajjasani", "createdAt": "2020-06-29T07:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxOTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMDI0MQ==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446620241", "bodyText": "Good to log node.getRegionInfo().getRegionNameAsString() as well as node.getRegionLocation() with this line?", "author": "virajjasani", "createdAt": "2020-06-28T08:37:41Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/SplitTableRegionProcedure.java", "diffHunk": "@@ -187,19 +190,19 @@ private void checkSplittable(final MasterProcedureEnv env,\n     boolean splittable = false;\n     if (node != null) {\n       try {\n-        if (bestSplitRow == null || bestSplitRow.length == 0) {\n+        GetRegionInfoResponse response;\n+        if (!hasBestSplitRow()) {\n           LOG\n             .info(\"splitKey isn't explicitly specified, will try to find a best split key from RS\");", "originalCommit": "4f9abeeba9d17bdd1d417513ac3010ed40241b83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMDc3MA==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446620770", "bodyText": "Better to return Optional.empty()", "author": "virajjasani", "createdAt": "2020-06-28T08:42:29Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -8537,49 +8535,25 @@ public void run(Message message) {\n     return responseBuilder.build();\n   }\n \n-  boolean shouldForceSplit() {\n-    return this.splitRequest;\n-  }\n-\n-  byte[] getExplicitSplitPoint() {\n-    return this.explicitSplitPoint;\n-  }\n-\n-  void forceSplit(byte[] sp) {\n-    // This HRegion will go away after the forced split is successful\n-    // But if a forced split fails, we need to clear forced split.\n-    this.splitRequest = true;\n-    if (sp != null) {\n-      this.explicitSplitPoint = sp;\n-    }\n-  }\n-\n-  void clearSplit() {\n-    this.splitRequest = false;\n-    this.explicitSplitPoint = null;\n+  public Optional<byte[]> checkSplit() {\n+    return checkSplit(false);\n   }\n \n   /**\n-   * Return the splitpoint. null indicates the region isn't splittable\n-   * If the splitpoint isn't explicitly specified, it will go over the stores\n-   * to find the best splitpoint. Currently the criteria of best splitpoint\n-   * is based on the size of the store.\n+   * Return the split point. An empty result indicates the region isn't splittable.\n    */\n-  public byte[] checkSplit() {\n+  public Optional<byte[]> checkSplit(boolean force) {\n     // Can't split META\n     if (this.getRegionInfo().isMetaRegion()) {\n-      if (shouldForceSplit()) {\n-        LOG.warn(\"Cannot split meta region in HBase 0.20 and above\");\n-      }\n-      return null;\n+      return Optional.empty();\n     }\n \n     // Can't split a region that is closing.\n     if (this.isClosing()) {\n-      return null;\n+      return Optional.empty();\n     }\n \n-    if (!splitPolicy.shouldSplit()) {\n+    if (!force && !splitPolicy.shouldSplit()) {\n       return null;", "originalCommit": "4f9abeeba9d17bdd1d417513ac3010ed40241b83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzU0NQ==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446623545", "bodyText": "After this change, region.getSplitPolicy() is no longer read by source code, only test code. If test code can get splitPolicy using reflection, maybe we can remove getSplitPolicy() from HRegion. Anyways, not a strong preference w.r.t this PR, we are good.", "author": "virajjasani", "createdAt": "2020-06-28T09:04:34Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java", "diffHunk": "@@ -1837,35 +1837,30 @@ public GetOnlineRegionResponse getOnlineRegion(final RpcController controller,\n   @Override\n   @QosPriority(priority=HConstants.ADMIN_QOS)\n   public GetRegionInfoResponse getRegionInfo(final RpcController controller,\n-      final GetRegionInfoRequest request) throws ServiceException {\n+    final GetRegionInfoRequest request) throws ServiceException {\n     try {\n       checkOpen();\n       requestCount.increment();\n       HRegion region = getRegion(request.getRegion());\n       RegionInfo info = region.getRegionInfo();\n-      byte[] bestSplitRow = null;\n-      boolean shouldSplit = true;\n+      byte[] bestSplitRow;\n       if (request.hasBestSplitRow() && request.getBestSplitRow()) {\n-        HRegion r = region;\n-        region.startRegionOperation(Operation.SPLIT_REGION);\n-        r.forceSplit(null);\n-        // Even after setting force split if split policy says no to split then we should not split.\n-        shouldSplit = region.getSplitPolicy().shouldSplit() && !info.isMetaRegion();", "originalCommit": "4f9abeeba9d17bdd1d417513ac3010ed40241b83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgxMDA5OQ==", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446810099", "bodyText": "Changed getSplitPolicy to package private and added a VisibleForTesting annotation.", "author": "Apache9", "createdAt": "2020-06-29T06:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzU0NQ=="}], "type": "inlineReview"}, {"oid": "1445121616f5242041889cf18d2e530a6fdc57ea", "url": "https://github.com/apache/hbase/commit/1445121616f5242041889cf18d2e530a6fdc57ea", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side", "committedDate": "2020-06-28T16:17:41Z", "type": "forcePushed"}, {"oid": "78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "url": "https://github.com/apache/hbase/commit/78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side", "committedDate": "2020-06-29T02:09:34Z", "type": "commit"}, {"oid": "78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "url": "https://github.com/apache/hbase/commit/78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side", "committedDate": "2020-06-29T02:09:34Z", "type": "forcePushed"}, {"oid": "d9fc06f9ae0747b7f4e97b567c68214a6978b4d2", "url": "https://github.com/apache/hbase/commit/d9fc06f9ae0747b7f4e97b567c68214a6978b4d2", "message": "fix checkstyle warning", "committedDate": "2020-06-29T03:11:46Z", "type": "commit"}]}