{"pr_number": 2569, "pr_title": "HBASE-25206 Data loss can happen if a cloned table loses original spl\u2026", "pr_createdAt": "2020-10-20T13:28:18Z", "pr_url": "https://github.com/apache/hbase/pull/2569", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3NzQ1OQ==", "url": "https://github.com/apache/hbase/pull/2569#discussion_r508577459", "bodyText": "I think here we could just get all the regions of the table.\nAnd look at the code of getRegionsOfTable(TableName, boolean), I'm afraid the implementation of the include method has something wrong?\n    if (node.isInState(State.SPLIT) || hri.isSplit()) {\n      return false;\n    }\n    if ((node.isInState(State.OFFLINE) || hri.isOffline()) && !offline) {\n      return false;\n    }\n    return (!hri.isOffline() && !hri.isSplit()) ||\n        ((hri.isOffline() || hri.isSplit()) && offline);\n\nI do not think we need the two extra if conditions? Especially the first one, it will make us always exclude split parent?", "author": "Apache9", "createdAt": "2020-10-20T14:51:44Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/DeleteTableProcedure.java", "diffHunk": "@@ -100,6 +101,12 @@ protected Flow executeFromState(final MasterProcedureEnv env, DeleteTableState s\n           // TODO: Move out... in the acquireLock()\n           LOG.debug(\"Waiting for RIT for {}\", this);\n           regions = env.getAssignmentManager().getRegionStates().getRegionsOfTable(getTableName());\n+          // We need to archive SPLIT regions as well, so add the SPLIT regions to the region list\n+          List<RegionInfo> splitRegions = env.getAssignmentManager().getRegionStates()", "originalCommit": "75a5feaceaef64a5fdcf9d108d6071584ef88e3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIwMjA3NA==", "url": "https://github.com/apache/hbase/pull/2569#discussion_r510202074", "bodyText": "I think here, we could add a method in RegionStates to get regions of table for disabling, so we do not need to interate on the region state nodes of this table again.", "author": "Apache9", "createdAt": "2020-10-22T14:21:01Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/DeleteTableProcedure.java", "diffHunk": "@@ -100,6 +101,12 @@ protected Flow executeFromState(final MasterProcedureEnv env, DeleteTableState s\n           // TODO: Move out... in the acquireLock()\n           LOG.debug(\"Waiting for RIT for {}\", this);\n           regions = env.getAssignmentManager().getRegionStates().getRegionsOfTable(getTableName());", "originalCommit": "75a5feaceaef64a5fdcf9d108d6071584ef88e3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6eeaeb06f1080f6476c8cd3b5b6e29459c6a0c32", "url": "https://github.com/apache/hbase/commit/6eeaeb06f1080f6476c8cd3b5b6e29459c6a0c32", "message": "HBASE-25206 Data loss can happen if a cloned table loses original split region(delete table)", "committedDate": "2020-10-23T02:49:27Z", "type": "forcePushed"}, {"oid": "c0c4cecc8bf5cb0dc46205eb73db96cafca710cc", "url": "https://github.com/apache/hbase/commit/c0c4cecc8bf5cb0dc46205eb73db96cafca710cc", "message": "HBASE-25206 Data loss can happen if a cloned table loses original split region(delete table)", "committedDate": "2020-10-23T03:22:30Z", "type": "forcePushed"}, {"oid": "74e4d524ebe14d1413b7b2120f98d005ba195f9c", "url": "https://github.com/apache/hbase/commit/74e4d524ebe14d1413b7b2120f98d005ba195f9c", "message": "HBASE-25206 Data loss can happen if a cloned table loses original split region(delete table)", "committedDate": "2020-10-23T07:24:34Z", "type": "commit"}, {"oid": "74e4d524ebe14d1413b7b2120f98d005ba195f9c", "url": "https://github.com/apache/hbase/commit/74e4d524ebe14d1413b7b2120f98d005ba195f9c", "message": "HBASE-25206 Data loss can happen if a cloned table loses original split region(delete table)", "committedDate": "2020-10-23T07:24:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM3NzQ0Mw==", "url": "https://github.com/apache/hbase/pull/2569#discussion_r516377443", "bodyText": "This is a good catch, moving the region out of RIT.", "author": "huaxiangsun", "createdAt": "2020-11-03T01:05:39Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/TransitRegionStateProcedure.java", "diffHunk": "@@ -348,6 +348,7 @@ protected Flow executeFromState(MasterProcedureEnv env, RegionStateTransitionSta\n               LOG.error(\n                 \"Cannot assign replica region {} because its primary region {} does not exist.\",\n                 regionNode.getRegionInfo(), defaultRI);\n+              regionNode.unsetProcedure(this);", "originalCommit": "74e4d524ebe14d1413b7b2120f98d005ba195f9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}