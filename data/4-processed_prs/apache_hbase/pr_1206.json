{"pr_number": 1206, "pr_title": "HBASE-23890 Update the rsgroup section in our ref guide", "pr_createdAt": "2020-02-25T13:39:07Z", "pr_url": "https://github.com/apache/hbase/pull/1206", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNDkzOQ==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383904939", "bodyText": "Does the DoNotRetryIOException make clear that the feature is off? or does it talk about some other thing that we can give an example of here to distinguish from some coincidental failure?", "author": "busbey", "createdAt": "2020-02-25T14:16:57Z", "path": "src/main/asciidoc/_chapters/ops_mgt.adoc", "diffHunk": "@@ -3347,20 +3346,9 @@ Here is example using a few of the rsgroup  commands. To add a group, do as foll\n .RegionServer Groups must be Enabled\n [NOTE]\n ====\n-If you have not enabled the rsgroup Coprocessor Endpoint in the master and\n-you run the any of the rsgroup shell commands, you will see an error message\n-like the below:\n-\n-[source,java]\n-----\n-ERROR: org.apache.hadoop.hbase.exceptions.UnknownProtocolException: No registered master coprocessor service found for name RSGroupAdminService\n-    at org.apache.hadoop.hbase.master.MasterRpcServices.execMasterService(MasterRpcServices.java:604)\n-    at org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos$MasterService$2.callBlockingMethod(MasterProtos.java)\n-    at org.apache.hadoop.hbase.ipc.RpcServer.call(RpcServer.java:1140)\n-    at org.apache.hadoop.hbase.ipc.CallRunner.run(CallRunner.java:133)\n-    at org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:277)\n-    at org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:257)\n-----\n+If you have not enabled the rsgroup in the master and you call the any of\n+rsgroup admin methods, or run the any of the rsgroup shell commands, you may\n+see a `DoNotRetryIOException` which tells that 'RSGroup is disabled'", "originalCommit": "44bd9592093ba8c20f204b109a1a19e72792eb77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkyMDQyNA==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383920424", "bodyText": "I think the message \"RSGroup is disabled\" is clear enough? You mean add a \"set 'hbase.balancer.rsgroup.enabled' to true if you want to use RSGroup\"?", "author": "Apache9", "createdAt": "2020-02-25T14:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNDkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkyOTQ0NQ==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383929445", "bodyText": "that message would be great! instructions on how to turn it on would be even better, but I'd be happy with a clear statement that the feature is off as the cause.\nI see now why I misunderstood. I took \"see a X which tells that Y\" to mean \"you will see X and you should interpret it to mean Y\" rather than the intended \"you will see X and it will contain details that Y\".\nsuggested edit for this sentence:\n\nIf you have not enabled the rsgroup feature and you call any of the rsgroup admin methods or shell commands the call will fail with a DoNotRetryIOException with a detail message that says the rsgroup feature is disabled.\n\nwdyt?", "author": "busbey", "createdAt": "2020-02-25T14:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNDkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM5NzU4NQ==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r384397585", "bodyText": "Thanks. Let me change the words.", "author": "Apache9", "createdAt": "2020-02-26T10:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNDkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNTc5NA==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383905794", "bodyText": "the section on Upgrade Paths needs a call out that points down here.", "author": "busbey", "createdAt": "2020-02-25T14:18:22Z", "path": "src/main/asciidoc/_chapters/ops_mgt.adoc", "diffHunk": "@@ -3479,6 +3478,27 @@ To enable ACL, add the following to your hbase-site.xml and restart your Master:\n <property>\n ----\n \n+=== Migrating From Old Implementation", "originalCommit": "44bd9592093ba8c20f204b109a1a19e72792eb77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383906368", "bodyText": "if they're relying on this side effect of configuring the coprocessor, do they also have to be sure to set the custom balancer (as in the old implementation) or does the flag flipping to true take care of that?", "author": "busbey", "createdAt": "2020-02-25T14:19:16Z", "path": "src/main/asciidoc/_chapters/ops_mgt.adoc", "diffHunk": "@@ -3479,6 +3478,27 @@ To enable ACL, add the following to your hbase-site.xml and restart your Master:\n <property>\n ----\n \n+=== Migrating From Old Implementation\n+The coprocessor `org.apache.hadoop.hbase.rsgroup.RSGroupAdminEndpoint` is\n+deprected, but for compatible, if you want the pre 3.0.0 hbase client/shell\n+to communicate with the new hbase cluster, you still need to add this\n+coprocessor to master. And if this coprocessor is specified, the\n+`hbase.balancer.rsgroup.enabled` flag will be set to true automatically to", "originalCommit": "44bd9592093ba8c20f204b109a1a19e72792eb77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxOTUxNg==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383919516", "bodyText": "No they don't. Actually I think there are two requirements. One is for communicating with pre 3.0.0 hbase client/shell, then you have to set the coprocessor. Another is that you upgrade from pre 3.0.0 to 3.0.0, then we will set the flag to true automatically for you if you have already enabled rs group by the old way.", "author": "Apache9", "createdAt": "2020-02-25T14:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkzMDk0NA==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383930944", "bodyText": "okay good. Presuming there's no harm in still having the balancer customized I think this is fine. If having the balancer customized still is a problem, then we should include a sentence that says \"you should remove the custom balancer config\"", "author": "busbey", "createdAt": "2020-02-25T14:57:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQwNjc2MQ==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r384406761", "bodyText": "Let me confirm. Now the top level balancer will always be RSGroupBasedBalancer, and this option is for the balancer used within a rsgroup. So typically it is not allowed to configured RSGroupBasedBalancer again. But I think a warning here is enough.\nAnd maybe we should also add something in the balancer section to mention that RSGroupBasedBalancer is now the only top level balancer?", "author": "Apache9", "createdAt": "2020-02-26T10:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyODc5OA==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r384428798", "bodyText": "OK, we have this in RSGroupBasedLoadBalancer.initialize\n    // Create the balancer\n    Class<? extends LoadBalancer> balancerClass;\n    String balancerClassName = config.get(HBASE_RSGROUP_LOADBALANCER_CLASS);\n    if (balancerClassName == null) {\n      balancerClass = config.getClass(HConstants.HBASE_MASTER_LOADBALANCER_CLASS,\n        LoadBalancerFactory.getDefaultLoadBalancerClass(), LoadBalancer.class);\n    } else {\n      try {\n        balancerClass = Class.forName(balancerClassName).asSubclass(LoadBalancer.class);\n      } catch (ClassNotFoundException e) {\n        throw new IOException(e);\n      }\n    }\n    // avoid infinite nesting\n    if (getClass().isAssignableFrom(balancerClass)) {\n      balancerClass = LoadBalancerFactory.getDefaultLoadBalancerClass();\n    }\n    internalBalancer = ReflectionUtils.newInstance(balancerClass);", "author": "Apache9", "createdAt": "2020-02-26T11:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NDcxMg==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r384454712", "bodyText": "Checked the ref guide, we haven't mentioned much about the balancer class I think making the top level balancer to be RSGroupBasedLoadBalancer can be considered as an 'implementation detail' so do not mention it in ref guide is fine I think.", "author": "Apache9", "createdAt": "2020-02-26T12:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3Njc1OA==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r384476758", "bodyText": "I would agree in general, but the instructions for using the rsgroup feature expressly called out configuring the balancer. So in this paragraph about migrating we need to call out that they should no longer be doing this.", "author": "busbey", "createdAt": "2020-02-26T13:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MDg2NA==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r384880864", "bodyText": "Done.", "author": "Apache9", "createdAt": "2020-02-27T02:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNjM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNzcyMQ==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383907721", "bodyText": "what happens wrt group enforcement during the migration? Will regions for grouped tables/namespaces go outside their assigned servers? Will rsgroup administrative commands I run wait to handle moving things in or out of a rsgroup until the migration is done?", "author": "busbey", "createdAt": "2020-02-25T14:21:20Z", "path": "src/main/asciidoc/_chapters/ops_mgt.adoc", "diffHunk": "@@ -3479,6 +3478,27 @@ To enable ACL, add the following to your hbase-site.xml and restart your Master:\n <property>\n ----\n \n+=== Migrating From Old Implementation\n+The coprocessor `org.apache.hadoop.hbase.rsgroup.RSGroupAdminEndpoint` is\n+deprected, but for compatible, if you want the pre 3.0.0 hbase client/shell\n+to communicate with the new hbase cluster, you still need to add this\n+coprocessor to master. And if this coprocessor is specified, the\n+`hbase.balancer.rsgroup.enabled` flag will be set to true automatically to\n+enable rs group feature.\n+\n+The main difference comparing to the old implementation is that, now the\n+rsgroup for a table is stored in TableDescriptor, instead of in RSGroupInfo,\n+so the getTables method of RSGroupInfo has been deprecated. And if you use the\n+Admin methods to get the RSGroupInfo, its getTables method will always return\n+empty. Of course the behavior for the old RSGroupAdminEndpoint is not changed,\n+we will fill the tables field of the RSGroupInfo before returning, to make it\n+compatible with old hbase client/shell.\n+\n+When upgrading, the migration between the RSGroupInfo and TableDescriptor will", "originalCommit": "44bd9592093ba8c20f204b109a1a19e72792eb77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxNzgyNw==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383917827", "bodyText": "Just update the table descriptor, no other effect, you can see the comment in RSGroupInfoManagerImpl.migrate method for more details why this could work.", "author": "Apache9", "createdAt": "2020-02-25T14:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNzcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkzMjQxNw==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383932417", "bodyText": "excellent. please add a sentence here that expressly calls out that enforcement will keep working during the migration and running new admin commands is fine.\nprobably I will get folks asking me how to tell when the migration is complete, so if there's an easy answer to that we should include it.", "author": "busbey", "createdAt": "2020-02-25T14:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwODU0Mw==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383908543", "bodyText": "is there an implementation reason we don't fill in the tables for RSGroupInfo in this case?", "author": "busbey", "createdAt": "2020-02-25T14:22:43Z", "path": "src/main/asciidoc/_chapters/ops_mgt.adoc", "diffHunk": "@@ -3479,6 +3478,27 @@ To enable ACL, add the following to your hbase-site.xml and restart your Master:\n <property>\n ----\n \n+=== Migrating From Old Implementation\n+The coprocessor `org.apache.hadoop.hbase.rsgroup.RSGroupAdminEndpoint` is\n+deprected, but for compatible, if you want the pre 3.0.0 hbase client/shell\n+to communicate with the new hbase cluster, you still need to add this\n+coprocessor to master. And if this coprocessor is specified, the\n+`hbase.balancer.rsgroup.enabled` flag will be set to true automatically to\n+enable rs group feature.\n+\n+The main difference comparing to the old implementation is that, now the", "originalCommit": "44bd9592093ba8c20f204b109a1a19e72792eb77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxNjUzMw==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383916533", "bodyText": "The old implementation is a bit broken, as we can set rsgroup for a namespace, and you can never get this information from the RSGroupInfo. In the new implementation there are two Admin methods for getting the information.", "author": "Apache9", "createdAt": "2020-02-25T14:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwODU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkzMTUyMw==", "url": "https://github.com/apache/hbase/pull/1206#discussion_r383931523", "bodyText": "please include that information in this paragraph.", "author": "busbey", "createdAt": "2020-02-25T14:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwODU0Mw=="}], "type": "inlineReview"}, {"oid": "6c08afde78796762a118dd4e5abe2a0a63463214", "url": "https://github.com/apache/hbase/commit/6c08afde78796762a118dd4e5abe2a0a63463214", "message": "HBASE-23890 Update the rsgroup section in our ref guide", "committedDate": "2020-02-26T12:11:53Z", "type": "forcePushed"}, {"oid": "69d8992f151c05cb19d56246194ee9fc3df38c3a", "url": "https://github.com/apache/hbase/commit/69d8992f151c05cb19d56246194ee9fc3df38c3a", "message": "HBASE-23890 Update the rsgroup section in our ref guide", "committedDate": "2020-02-26T12:21:18Z", "type": "forcePushed"}, {"oid": "384190a516479b211814b34c5416dda5a91c9386", "url": "https://github.com/apache/hbase/commit/384190a516479b211814b34c5416dda5a91c9386", "message": "HBASE-23890 Update the rsgroup section in our ref guide", "committedDate": "2020-02-27T02:25:37Z", "type": "commit"}, {"oid": "384190a516479b211814b34c5416dda5a91c9386", "url": "https://github.com/apache/hbase/commit/384190a516479b211814b34c5416dda5a91c9386", "message": "HBASE-23890 Update the rsgroup section in our ref guide", "committedDate": "2020-02-27T02:25:37Z", "type": "forcePushed"}]}