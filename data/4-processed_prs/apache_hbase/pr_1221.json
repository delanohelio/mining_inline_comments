{"pr_number": 1221, "pr_title": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedur\u2026", "pr_createdAt": "2020-02-28T04:07:34Z", "pr_url": "https://github.com/apache/hbase/pull/1221", "timeline": [{"oid": "7c14ac5f4f520d024a331f9e408ca18aebd8107c", "url": "https://github.com/apache/hbase/commit/7c14ac5f4f520d024a331f9e408ca18aebd8107c", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-02-28T07:25:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU3MTA4Nw==", "url": "https://github.com/apache/hbase/pull/1221#discussion_r386571087", "bodyText": "Will this work?\nWe still might get another's rpc when the RpcServer is called because the row key clashes?", "author": "saintstack", "createdAt": "2020-03-02T18:31:47Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -552,11 +586,12 @@ public void insert(Procedure<?> proc, Procedure<?>[] subProcs) {\n       for (Procedure<?> subProc : subProcs) {\n         serializePut(subProc, mutations, rowsToLock);\n       }\n-      region.mutateRowsWithLocks(mutations, rowsToLock, NO_NONCE, NO_NONCE);\n+      executeInsert(mutations, rowsToLock);", "originalCommit": "7c14ac5f4f520d024a331f9e408ca18aebd8107c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgyNDUwMw==", "url": "https://github.com/apache/hbase/pull/1221#discussion_r386824503", "bodyText": "Let me write a ut to verify this.", "author": "infraio", "createdAt": "2020-03-03T06:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU3MTA4Nw=="}], "type": "inlineReview"}, {"oid": "69d5fc6650f7cc1797244d54cb46d22753d71a86", "url": "https://github.com/apache/hbase/commit/69d5fc6650f7cc1797244d54cb46d22753d71a86", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-03T08:09:26Z", "type": "forcePushed"}, {"oid": "6bf63547f8127bb02cd3ff5d76c8b47e5dfb2728", "url": "https://github.com/apache/hbase/commit/6bf63547f8127bb02cd3ff5d76c8b47e5dfb2728", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-03T09:29:15Z", "type": "forcePushed"}, {"oid": "88d24dff09b64e3bf3fe01822cda14ea204ffd0a", "url": "https://github.com/apache/hbase/commit/88d24dff09b64e3bf3fe01822cda14ea204ffd0a", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-03T09:31:09Z", "type": "forcePushed"}, {"oid": "a8fbd1d13e38040b1cac32e16dd7989d97743ea7", "url": "https://github.com/apache/hbase/commit/a8fbd1d13e38040b1cac32e16dd7989d97743ea7", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-03T10:40:55Z", "type": "forcePushed"}, {"oid": "592dfe77969ea5632454c0fae2d0d040a623bf13", "url": "https://github.com/apache/hbase/commit/592dfe77969ea5632454c0fae2d0d040a623bf13", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-05T04:16:13Z", "type": "forcePushed"}, {"oid": "e51bf582d3099877aad6be483065096699147719", "url": "https://github.com/apache/hbase/commit/e51bf582d3099877aad6be483065096699147719", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-05T04:19:51Z", "type": "forcePushed"}, {"oid": "8d79960bec990d549e85a5a259f8c970ad1763d9", "url": "https://github.com/apache/hbase/commit/8d79960bec990d549e85a5a259f8c970ad1763d9", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-05T06:41:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc4NDQ3MQ==", "url": "https://github.com/apache/hbase/pull/1221#discussion_r388784471", "bodyText": "Pity we have to write the comment three times...\nCan be a follow on, to abstract a method for this logic...", "author": "Apache9", "createdAt": "2020-03-06T09:04:41Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -547,6 +551,10 @@ public void insert(Procedure<?> proc, Procedure<?>[] subProcs) {\n     }\n     List<Mutation> mutations = new ArrayList<>(subProcs.length + 1);\n     List<byte[]> rowsToLock = new ArrayList<>(subProcs.length + 1);\n+    // Insert procedure may be called by master's rpc call. There are some check about the rpc call\n+    // when mutate region. Here unset the current rpc call and set it back in finally block.\n+    // See HBASE-23895 for more details.\n+    Optional<RpcCall> rpcCall = RpcServer.unsetCurrentCall();", "originalCommit": "8d79960bec990d549e85a5a259f8c970ad1763d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "984942eaaee962af70a821d2de01733fcaf16e17", "url": "https://github.com/apache/hbase/commit/984942eaaee962af70a821d2de01733fcaf16e17", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-06T10:39:40Z", "type": "forcePushed"}, {"oid": "d02956d553e38534c60c459a6cfe08a2929cc80f", "url": "https://github.com/apache/hbase/commit/d02956d553e38534c60c459a6cfe08a2929cc80f", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-07T04:10:33Z", "type": "commit"}, {"oid": "d02956d553e38534c60c459a6cfe08a2929cc80f", "url": "https://github.com/apache/hbase/commit/d02956d553e38534c60c459a6cfe08a2929cc80f", "message": "HBASE-23895 STUCK Region-In-Transition when failed to insert procedure to procedure store", "committedDate": "2020-03-07T04:10:33Z", "type": "forcePushed"}]}