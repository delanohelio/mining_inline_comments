{"pr_number": 369, "pr_title": " (CCS-3550) Publishing or republishing an assembly", "pr_createdAt": "2020-08-12T14:53:54Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/369", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2MjE5NA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469462194", "bodyText": "urlFragment is an optional field", "author": "xdavidson", "createdAt": "2020-08-12T18:36:13Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -114,46 +129,145 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+\n+            // if request constitues of Assembly, publish Assembly\n+            if (request.getRequestParameter(PantheonConstants.TYPE).getString().equals(PantheonConstants.ASSEMBLY))\n+                publishAssembly(request, response, changes, serviceResourceResolver);\n+            // else publish it as module\n+            else\n+               publishModule(request, response, changes, serviceResourceResolver);\n+\n+            if (serviceResourceResolver.hasChanges()) {\n+                serviceResourceResolver.commit();\n+            }\n+\n+        }catch (Exception ex){\n+            logger.error(\"Error occured, rolled back last changes\", ex.getMessage());\n+        }\n+\n+    }\n+\n+    /**\n+     * Method to check if request contains a Module and it needs to get published\n+     *\n+     * @param request\n+     * @param response\n+     * @param changes\n+     * @param serviceResourceResolver\n+     * @throws PersistenceException\n+     */\n+    private void publishModule(SlingHttpServletRequest request, PostResponse response, List<Modification> changes, ResourceResolver serviceResourceResolver) throws PersistenceException {\n+        Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+        Locale locale = getLocale(request);\n+        String variant = getVariant(request);\n+        // Get the draft version, there should be one\n+        Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n+        if (!versionToRelease.isPresent()) {\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The module doesn't have a draft version to be released\");\n+            return ;\n+        } else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n+                || versionToRelease.get().metadata().getOrCreate().productVersion().get().isEmpty()) {\n+            // Check if productVersion is set\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The version to be released doesn't have productVersion metadata\");\n+            return ;\n+        } else if (versionToRelease.get().metadata().getOrCreate().urlFragment().get() == null\n+                || versionToRelease.get().metadata().getOrCreate().urlFragment().get().isEmpty()) {\n+            // Check if urlFragment is set\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The version to be released doesn't have urlFragment metadata\");", "originalCommit": "d792a4ef456809dfed794a464305bd29ef4c0831", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MDQ4MQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469960481", "bodyText": "+1", "author": "benradey", "createdAt": "2020-08-13T13:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2MjE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2MjkyOA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469462928", "bodyText": "urlFragment is an optional field", "author": "xdavidson", "createdAt": "2020-08-12T18:37:34Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -114,46 +129,145 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+\n+            // if request constitues of Assembly, publish Assembly\n+            if (request.getRequestParameter(PantheonConstants.TYPE).getString().equals(PantheonConstants.ASSEMBLY))\n+                publishAssembly(request, response, changes, serviceResourceResolver);\n+            // else publish it as module\n+            else\n+               publishModule(request, response, changes, serviceResourceResolver);\n+\n+            if (serviceResourceResolver.hasChanges()) {\n+                serviceResourceResolver.commit();\n+            }\n+\n+        }catch (Exception ex){\n+            logger.error(\"Error occured, rolled back last changes\", ex.getMessage());\n+        }\n+\n+    }\n+\n+    /**\n+     * Method to check if request contains a Module and it needs to get published\n+     *\n+     * @param request\n+     * @param response\n+     * @param changes\n+     * @param serviceResourceResolver\n+     * @throws PersistenceException\n+     */\n+    private void publishModule(SlingHttpServletRequest request, PostResponse response, List<Modification> changes, ResourceResolver serviceResourceResolver) throws PersistenceException {\n+        Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+        Locale locale = getLocale(request);\n+        String variant = getVariant(request);\n+        // Get the draft version, there should be one\n+        Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n+        if (!versionToRelease.isPresent()) {\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The module doesn't have a draft version to be released\");\n+            return ;\n+        } else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n+                || versionToRelease.get().metadata().getOrCreate().productVersion().get().isEmpty()) {\n+            // Check if productVersion is set\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The version to be released doesn't have productVersion metadata\");\n+            return ;\n+        } else if (versionToRelease.get().metadata().getOrCreate().urlFragment().get() == null\n+                || versionToRelease.get().metadata().getOrCreate().urlFragment().get().isEmpty()) {\n+            // Check if urlFragment is set\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The version to be released doesn't have urlFragment metadata\");\n+            return ;\n+        }\n+        // Draft becomes the new released version\n+        ModuleVariant moduleVariant = traverseFrom(module)\n+                .toChild(m -> module.locale(locale))\n+                .toChild(ModuleLocale::variants)\n+                .toChild(variants -> variants.variant(variant))\n+                .get();\n+        moduleVariant.releaseDraft();\n+        changes.add(Modification.onModified(module.getPath()));\n+        // source/draft becomes source/released\n+        FileResource draftSource = traverseFrom(module)\n+                .toChild(m -> module.locale(locale))\n+                .toChild(ModuleLocale::source)\n+                .toChild(sourceContent -> sourceContent.draft())\n+                .get();\n+        // Check for released version\n+        Optional<HashableFileResource> releasedSource = traverseFrom(module)\n+                .toChild(m -> module.locale(locale))\n+                .toChild(ModuleLocale::source)\n+                .toChild(sourceContent -> sourceContent.released())\n+                .getAsOptional();\n+        if (draftSource != null) {\n+            if (releasedSource.isPresent()) {\n+                try {\n+                    releasedSource.get().delete();\n+                } catch (PersistenceException e) {\n+                    throw new RuntimeException(\"Failed to remove source/released: \" + releasedSource.get().getPath());\n+                }\n+            }\n+            try {\n+                rename(draftSource, \"released\");\n+            } catch (RepositoryException e) {\n+                throw new RuntimeException(\"Cannot find source/draft: \" + draftSource.getPath());\n+            }\n+\n+    }\n+    }\n+\n+    /**\n+     *  Method to check if request contains an assembly and it needs to get published\n+     *\n+     * @param request\n+     * @param response\n+     * @param changes\n+     * @param serviceResourceResolver\n+     * @return\n+     * @throws PersistenceException\n+     */\n+    private void publishAssembly(SlingHttpServletRequest request, PostResponse response, List<Modification> changes, ResourceResolver serviceResourceResolver) throws PersistenceException {\n+            Assembly assembly = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Assembly.class);\n             Locale locale = getLocale(request);\n             String variant = getVariant(request);\n             // Get the draft version, there should be one\n-            Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n+            Optional<AssemblyVersion> versionToRelease = assembly.getDraftVersion(locale, variant);\n             if (!versionToRelease.isPresent()) {\n                 response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n                         \"The module doesn't have a draft version to be released\");\n-                return;\n-            } else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n+                return ;\n+            }\n+            else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n                     || versionToRelease.get().metadata().getOrCreate().productVersion().get().isEmpty()) {\n                 // Check if productVersion is set\n                 response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n                         \"The version to be released doesn't have productVersion metadata\");\n-                return;\n+                return ;\n             } else if (versionToRelease.get().metadata().getOrCreate().urlFragment().get() == null\n                     || versionToRelease.get().metadata().getOrCreate().urlFragment().get().isEmpty()) {\n                 // Check if urlFragment is set\n                 response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n                         \"The version to be released doesn't have urlFragment metadata\");", "originalCommit": "d792a4ef456809dfed794a464305bd29ef4c0831", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0ODY5Nw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469748697", "bodyText": "@xdavidson, urlFragment is not a part of this ticket.", "author": "rednitish", "createdAt": "2020-08-13T07:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2MjkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MjkyMg==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469962922", "bodyText": "No, Lisa has a good point. Vanity URL has not been required in the Edit Metadata screen for some time, and we should not be checking for it during a publish operation. It would be trivial for you to remove this check; please do so.", "author": "benradey", "createdAt": "2020-08-13T13:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2MjkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3MjU4NA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469972584", "bodyText": "Agreed. But it would be super awesome if you can remove the validation on requiring urlFragment.", "author": "xdavidson", "createdAt": "2020-08-13T13:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2MjkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3MDYwOA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469470608", "bodyText": "please create an entry for assembly in pantheon-bundle/frontend/src/app/Constants.tsx", "author": "xdavidson", "createdAt": "2020-08-12T18:51:16Z", "path": "pantheon-bundle/frontend/src/app/assemblyDisplay.tsx", "diffHunk": "@@ -143,6 +144,7 @@ class AssemblyDisplay extends Component<any, any, any> {\n                         <Card>\n                             <Versions\n                                 modulePath={this.state.modulePath}\n+                                type=\"assembly\"", "originalCommit": "d792a4ef456809dfed794a464305bd29ef4c0831", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3MDgwOQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469470809", "bodyText": "please create an entry for module in pantheon-bundle/frontend/src/app/Constants.tsx", "author": "xdavidson", "createdAt": "2020-08-12T18:51:35Z", "path": "pantheon-bundle/frontend/src/app/moduleDisplay.tsx", "diffHunk": "@@ -143,6 +144,7 @@ class ModuleDisplay extends Component<any, any, any> {\n                         <Card>\n                             <Versions\n                                 modulePath={this.state.modulePath}\n+                                type=\"module\"", "originalCommit": "d792a4ef456809dfed794a464305bd29ef4c0831", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1MDI1Mw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469950253", "bodyText": "I don't think this comment is accurate.", "author": "benradey", "createdAt": "2020-08-13T13:28:00Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/HydraIntegration.java", "diffHunk": "@@ -96,7 +93,7 @@ public boolean canProcessEvent(Event event) {\n     }\n \n     /**\n-     * Process ModuleVersionPublishedEvent. It sends a simple text message to the Message Broker.\n+     * Process AssemblyVersionPublishedEvent. It sends a simple text message to the Message Broker.", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI0NTMyNQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471245325", "bodyText": "@benradey please check below answer", "author": "rednitish", "createdAt": "2020-08-17T05:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1MDI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1MTIyOQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469951229", "bodyText": "Why do you have these method/variable names using the word 'module' when this is for assemblies?", "author": "benradey", "createdAt": "2020-08-13T13:29:27Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/events/assembly/AssemblyVersionPublishStateEvent.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package com.redhat.pantheon.extension.events.assembly;\n+\n+import com.redhat.pantheon.extension.Event;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.model.module.ModuleVersion;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Event fired when a module version has been published.\n+ * Includes the module version path so it can be re-fetched in the\n+ * handlers if necessary.\n+ */\n+public class AssemblyVersionPublishStateEvent implements Event {\n+\n+    private final String moduleVersionPath;\n+\n+    protected AssemblyVersionPublishStateEvent(@Nonnull AssemblyVersion assemblyVersion) {\n+        this.moduleVersionPath = assemblyVersion.getPath();\n+    }\n+\n+    public String getModuleVersionPath() {\n+        return moduleVersionPath;\n+    }", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI0NTI1MQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471245251", "bodyText": "@benradey  There is a separate ticket to handle hydra messaging part, I added this class, as it had a dependency on changes.", "author": "rednitish", "createdAt": "2020-08-17T05:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1MTIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMDM5OA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471710398", "bodyText": "Ok, I am not sure I understand. Can you please explain why the field names we use in Java has an impact on the JSON payload that we product for Hydra to consume? Theoretically we should be able to rename this variable to private final String bigYellowBanana and Hydra should not care... am I mistaken?", "author": "benradey", "createdAt": "2020-08-17T18:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1MTIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1MjE1OA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469952158", "bodyText": "-module +assembly", "author": "benradey", "createdAt": "2020-08-13T13:30:41Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/events/assembly/AssemblyVersionUnpublishedEvent.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.redhat.pantheon.extension.events.assembly;\n+\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.model.module.ModuleVersion;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Event fired when a module version has been published.\n+ * Includes the module version path so it can be re-fetched in the", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NjY2Mg==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469956662", "bodyText": "There are a couple problems with this block.\n\nDo not rely on the client to tell you whether this is a module or assembly. You have direct access to the document, inspect its type to get the answer.\nDon't copy and paste code. In these two blocks, only lines 97 and 106 are substantially different, because you need to know which type of event to fire. The rest of the logic can be made generic by using Document classes, and then this if/else can be collapsed. Please refactor this.", "author": "benradey", "createdAt": "2020-08-13T13:36:59Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -80,16 +86,25 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n         if (response.getError() == null) {\n             // call the extension point\n             Locale locale = getLocale(request);\n-            Module module = getModule(request);\n             String variant = getVariant(request);\n-            ModuleVersion moduleVersion = module.locale(locale).get()\n-                    .variants().get()\n-                    .variant(variant).get()\n-                    .released().get();\n-\n-            // Regenerate the module once more\n-            asciidoctorService.getModuleHtml(module, locale, variant, false, new HashMap(), true);\n-            events.fireEvent(new ModuleVersionPublishedEvent(moduleVersion), 15);\n+            if(request.getRequestParameter(\"type\").equals(\"assembly\")) {\n+                AssemblyVersion assemblyVersion = getAssembly(request).locale(locale).get()\n+                        .variants().get()\n+                        .variant(variant).get()\n+                        .released().get();\n+                // Regenerate the module once more\n+                asciidoctorService.getModuleHtml(getAssembly(request), locale, variant, false, new HashMap(), true);\n+                events.fireEvent(new AssemblyVersionPublishedEvent(assemblyVersion), 15);\n+\n+            }\n+            else {\n+                ModuleVersion moduleVersion =  getModule(request).locale(locale).get()\n+                        .variants().get()\n+                        .variant(variant).get()\n+                        .released().get();\n+                asciidoctorService.getModuleHtml(getModule(request), locale, variant, false, new HashMap(), true);\n+                events.fireEvent(new ModuleVersionPublishedEvent(moduleVersion), 15);\n+            }", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1Njk2Nw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469956967", "bodyText": "Same thing here, don't rely on the client to tell you what document type you're working with.", "author": "benradey", "createdAt": "2020-08-13T13:37:25Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -114,46 +129,145 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+\n+            // if request constitues of Assembly, publish Assembly\n+            if (request.getRequestParameter(PantheonConstants.TYPE).getString().equals(PantheonConstants.ASSEMBLY))", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1OTYzOA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469959638", "bodyText": "I'm going to put this comment on this method definition but it applies to the entire publishModule and publishAssembly block of code. Don't copy/paste code. Just like above, I'm betting you could make at least 90% of this generic by using Document classes and then you'll have a single publishDocument method that works for anything. There might be a few lines where you need to take special action for module/assembly but then just surround those few special lines with an if/else. You shouldn't duplicate the entire method like this.", "author": "benradey", "createdAt": "2020-08-13T13:41:27Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -114,46 +129,145 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+\n+            // if request constitues of Assembly, publish Assembly\n+            if (request.getRequestParameter(PantheonConstants.TYPE).getString().equals(PantheonConstants.ASSEMBLY))\n+                publishAssembly(request, response, changes, serviceResourceResolver);\n+            // else publish it as module\n+            else\n+               publishModule(request, response, changes, serviceResourceResolver);\n+\n+            if (serviceResourceResolver.hasChanges()) {\n+                serviceResourceResolver.commit();\n+            }\n+\n+        }catch (Exception ex){\n+            logger.error(\"Error occured, rolled back last changes\", ex.getMessage());\n+        }\n+\n+    }\n+\n+    /**\n+     * Method to check if request contains a Module and it needs to get published\n+     *\n+     * @param request\n+     * @param response\n+     * @param changes\n+     * @param serviceResourceResolver\n+     * @throws PersistenceException\n+     */\n+    private void publishModule(SlingHttpServletRequest request, PostResponse response, List<Modification> changes, ResourceResolver serviceResourceResolver) throws PersistenceException {", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MTY1Ng==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469961656", "bodyText": "Not a big deal, but please be careful not to introduce meaningless whitespace.", "author": "benradey", "createdAt": "2020-08-13T13:44:20Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -114,46 +129,145 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+\n+            // if request constitues of Assembly, publish Assembly\n+            if (request.getRequestParameter(PantheonConstants.TYPE).getString().equals(PantheonConstants.ASSEMBLY))\n+                publishAssembly(request, response, changes, serviceResourceResolver);\n+            // else publish it as module\n+            else\n+               publishModule(request, response, changes, serviceResourceResolver);\n+\n+            if (serviceResourceResolver.hasChanges()) {\n+                serviceResourceResolver.commit();\n+            }\n+\n+        }catch (Exception ex){\n+            logger.error(\"Error occured, rolled back last changes\", ex.getMessage());\n+        }\n+\n+    }\n+\n+    /**\n+     * Method to check if request contains a Module and it needs to get published\n+     *\n+     * @param request\n+     * @param response\n+     * @param changes\n+     * @param serviceResourceResolver\n+     * @throws PersistenceException\n+     */\n+    private void publishModule(SlingHttpServletRequest request, PostResponse response, List<Modification> changes, ResourceResolver serviceResourceResolver) throws PersistenceException {\n+        Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+        Locale locale = getLocale(request);\n+        String variant = getVariant(request);\n+        // Get the draft version, there should be one\n+        Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n+        if (!versionToRelease.isPresent()) {\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The module doesn't have a draft version to be released\");\n+            return ;\n+        } else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n+                || versionToRelease.get().metadata().getOrCreate().productVersion().get().isEmpty()) {\n+            // Check if productVersion is set\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The version to be released doesn't have productVersion metadata\");\n+            return ;\n+        } else if (versionToRelease.get().metadata().getOrCreate().urlFragment().get() == null\n+                || versionToRelease.get().metadata().getOrCreate().urlFragment().get().isEmpty()) {\n+            // Check if urlFragment is set\n+            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                    \"The version to be released doesn't have urlFragment metadata\");\n+            return ;\n+        }\n+        // Draft becomes the new released version\n+        ModuleVariant moduleVariant = traverseFrom(module)\n+                .toChild(m -> module.locale(locale))\n+                .toChild(ModuleLocale::variants)\n+                .toChild(variants -> variants.variant(variant))\n+                .get();\n+        moduleVariant.releaseDraft();\n+        changes.add(Modification.onModified(module.getPath()));\n+        // source/draft becomes source/released\n+        FileResource draftSource = traverseFrom(module)\n+                .toChild(m -> module.locale(locale))\n+                .toChild(ModuleLocale::source)\n+                .toChild(sourceContent -> sourceContent.draft())\n+                .get();\n+        // Check for released version\n+        Optional<HashableFileResource> releasedSource = traverseFrom(module)\n+                .toChild(m -> module.locale(locale))\n+                .toChild(ModuleLocale::source)\n+                .toChild(sourceContent -> sourceContent.released())\n+                .getAsOptional();\n+        if (draftSource != null) {\n+            if (releasedSource.isPresent()) {\n+                try {\n+                    releasedSource.get().delete();\n+                } catch (PersistenceException e) {\n+                    throw new RuntimeException(\"Failed to remove source/released: \" + releasedSource.get().getPath());\n+                }\n+            }\n+            try {\n+                rename(draftSource, \"released\");\n+            } catch (RepositoryException e) {\n+                throw new RuntimeException(\"Cannot find source/draft: \" + draftSource.getPath());\n+            }\n+\n+    }\n+    }\n+\n+    /**\n+     *  Method to check if request contains an assembly and it needs to get published\n+     *\n+     * @param request\n+     * @param response\n+     * @param changes\n+     * @param serviceResourceResolver\n+     * @return\n+     * @throws PersistenceException\n+     */\n+    private void publishAssembly(SlingHttpServletRequest request, PostResponse response, List<Modification> changes, ResourceResolver serviceResourceResolver) throws PersistenceException {\n+            Assembly assembly = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Assembly.class);\n             Locale locale = getLocale(request);\n             String variant = getVariant(request);\n             // Get the draft version, there should be one\n-            Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n+            Optional<AssemblyVersion> versionToRelease = assembly.getDraftVersion(locale, variant);\n             if (!versionToRelease.isPresent()) {\n                 response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n                         \"The module doesn't have a draft version to be released\");\n-                return;\n-            } else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n+                return ;\n+            }\n+            else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n                     || versionToRelease.get().metadata().getOrCreate().productVersion().get().isEmpty()) {\n                 // Check if productVersion is set\n                 response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n                         \"The version to be released doesn't have productVersion metadata\");\n-                return;\n+                return ;", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NTkzNg==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469965936", "bodyText": "Two things here:\n\nI see how you're using these constants elsewhere in the application - and I'm requesting changes there, so that should render these entries unnecessary\nNotwithstanding #1, if you were to introduce constants like these, please be more descriptive and follow any existing patterns. For example, you can see we have PARAM_VARIANT above, so you could have followed that pattern for PARAM_TYPE. There is no existing pattern for ASSEMBLY, but you could have gone with DOCUMENT_TYPE_ASSEMBLY, for example.\n\nAnyway, unless these constants have further purpose, please remove them.", "author": "benradey", "createdAt": "2020-08-13T13:50:29Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/helper/PantheonConstants.java", "diffHunk": "@@ -11,4 +11,8 @@\n     public static final String PARAM_VARIANT = \"variant\";\n \n     public static final String PANTHEON_PUBLISHERS = \"pantheon-publishers\";\n+\n+    public static final String TYPE = \"type\";\n+\n+    public static final String ASSEMBLY = \"assembly\";", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NzU1NA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469967554", "bodyText": "Same thing here as before. No reason for these two methods to be copy/pasted. They appear to be identical. Please collapse them into a single method that handles Documents.", "author": "benradey", "createdAt": "2020-08-13T13:52:43Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/UnpublishVersion.java", "diffHunk": "@@ -121,32 +123,49 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canUnPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            // if request constitues of Assembly, unpublish Assembly\n+            if (request.getRequestParameter(PantheonConstants.TYPE).getString().equals(PantheonConstants.ASSEMBLY))\n+                unpublishAssembly(request, response, changes, serviceResourceResolver);\n+            else\n+                // else unpublish it as module\n+                unPublishModule(request, response, changes, serviceResourceResolver);", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2ODcwMQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469968701", "bodyText": "Minor code style point, but please be consistent with brackets. Although if/else brackets are optional if you only have one line, people generally agree that the code is more readable if you include them. The fact that this if/else without brackets is immediately followed up by an if statement that does have brackets makes the inconsistency even more glaring.", "author": "benradey", "createdAt": "2020-08-13T13:54:21Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/UnpublishVersion.java", "diffHunk": "@@ -121,32 +123,49 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canUnPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            // if request constitues of Assembly, unpublish Assembly\n+            if (request.getRequestParameter(PantheonConstants.TYPE).getString().equals(PantheonConstants.ASSEMBLY))\n+                unpublishAssembly(request, response, changes, serviceResourceResolver);\n+            else\n+                // else unpublish it as module\n+                unPublishModule(request, response, changes, serviceResourceResolver);\n+\n+            if (serviceResourceResolver.hasChanges()) {\n+                serviceResourceResolver.commit();\n+            }", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2OTM2NA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469969364", "bodyText": "Please remember to remove these 'type' parameters after you update the servlet to not need them.", "author": "benradey", "createdAt": "2020-08-13T13:55:12Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/PublishDraftVersionTest.java", "diffHunk": "@@ -56,6 +53,9 @@ void doRun() throws Exception {\n                         \"jcr:data\", \"The draft content\")\n                 .commit();\n         registerMockAdapter(Module.class, slingContext);\n+        Map<String, Object> map = new HashMap<>();\n+        map.put(\"type\",\"module\");", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2OTQ1NA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469969454", "bodyText": "Same", "author": "benradey", "createdAt": "2020-08-13T13:55:18Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/PublishDraftVersionTest.java", "diffHunk": "@@ -98,6 +98,9 @@ void doRunNoDraftVersion() throws Exception {\n                 .resource(\"/content/repositories/repo/module/en_US/source/released/jcr:content\",\n                         \"jcr:data\", \"The released content\")\n                 .commit();\n+        Map<String, Object> map = new HashMap<>();\n+        map.put(\"type\",\"module\");", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2OTc3Nw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469969777", "bodyText": "Same", "author": "benradey", "createdAt": "2020-08-13T13:55:40Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/PublishDraftVersionTest.java", "diffHunk": "@@ -118,4 +121,80 @@ void doRunNoDraftVersion() throws Exception {\n         assertEquals(HttpServletResponse.SC_PRECONDITION_FAILED, postResponse.getStatusCode());\n \n     }\n+    @Test\n+    void doRunForAssembly() throws Exception {\n+        // Given\n+        slingContext.build()\n+                .resource(\"/content/repositories/repo/assembly/en_US/variants/DEFAULT/draft/metadata\",\n+                        \"jcr:title\", \"A draft title\",\n+                        \"productVersion\", \"123456\",\n+                        \"urlFragment\", \"/test\")\n+                .resource(\"/content/repositories/repo/assembly/en_US/source/draft/jcr:content\",\n+                        \"jcr:data\", \"The draft content\")\n+                .commit();\n+        Map<String, Object> map = new HashMap<>();\n+        map.put(\"type\",\"assembly\");", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3MTY1OQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469971659", "bodyText": "Same (There are more after this one but I'll stop commenting)", "author": "benradey", "createdAt": "2020-08-13T13:58:04Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/UnpublishVersionTest.java", "diffHunk": "@@ -0,0 +1,313 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.extension.Events;\n+import com.redhat.pantheon.helper.PantheonConstants;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.model.module.Module;\n+import com.redhat.pantheon.model.module.ModuleVersion;\n+import com.redhat.pantheon.servlet.UnpublishVersion;\n+import com.redhat.pantheon.sling.ServiceResourceResolverProvider;\n+import org.apache.sling.api.resource.ResourceResolver;\n+import org.apache.sling.servlets.post.HtmlResponse;\n+import org.apache.sling.servlets.post.Modification;\n+import org.apache.sling.servlets.post.ModificationType;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+\n+import javax.jcr.Session;\n+import javax.jcr.SimpleCredentials;\n+import javax.servlet.http.HttpServletResponse;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.google.common.collect.Lists.newArrayList;\n+import static com.redhat.pantheon.util.TestUtils.registerMockAdapter;\n+import static org.junit.jupiter.api.Assertions.*;\n+import static org.mockito.Mockito.*;\n+\n+@ExtendWith({SlingContextExtension.class})\n+class UnpublishVersionTest {\n+\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+    String testHTML = \"<!DOCTYPE html> <html lang=\\\"en\\\"> <head><title>test title</title></head> <body \" +\n+            \"class=\\\"article\\\"><h1>test title</h1> </header> </body> </html>\";\n+\n+    @Test\n+    @DisplayName(\"doRun for module with only released version\")\n+    void doRun() throws Exception {\n+        // Given\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/released\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/released/metadata\",\n+                        \"jcr:title\", \"A published title\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/released/cached_html/jcr:content\",\n+                        \"jcr:data\", \"Released content\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/source/released/jcr:content\",\n+                        \"jcr:data\", \"Released content\");\n+        Map<String, Object> map = new HashMap<>();\n+        map.put(\"type\",\"module\");", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3MjY2Mw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r469972663", "bodyText": "Typo in method name", "author": "benradey", "createdAt": "2020-08-13T13:59:32Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/UnpublishVersionTest.java", "diffHunk": "@@ -0,0 +1,313 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.extension.Events;\n+import com.redhat.pantheon.helper.PantheonConstants;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.model.module.Module;\n+import com.redhat.pantheon.model.module.ModuleVersion;\n+import com.redhat.pantheon.servlet.UnpublishVersion;\n+import com.redhat.pantheon.sling.ServiceResourceResolverProvider;\n+import org.apache.sling.api.resource.ResourceResolver;\n+import org.apache.sling.servlets.post.HtmlResponse;\n+import org.apache.sling.servlets.post.Modification;\n+import org.apache.sling.servlets.post.ModificationType;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+\n+import javax.jcr.Session;\n+import javax.jcr.SimpleCredentials;\n+import javax.servlet.http.HttpServletResponse;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.google.common.collect.Lists.newArrayList;\n+import static com.redhat.pantheon.util.TestUtils.registerMockAdapter;\n+import static org.junit.jupiter.api.Assertions.*;\n+import static org.mockito.Mockito.*;\n+\n+@ExtendWith({SlingContextExtension.class})\n+class UnpublishVersionTest {\n+\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+    String testHTML = \"<!DOCTYPE html> <html lang=\\\"en\\\"> <head><title>test title</title></head> <body \" +\n+            \"class=\\\"article\\\"><h1>test title</h1> </header> </body> </html>\";\n+\n+    @Test\n+    @DisplayName(\"doRun for module with only released version\")\n+    void doRun() throws Exception {\n+        // Given\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/released\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/released/metadata\",\n+                        \"jcr:title\", \"A published title\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/released/cached_html/jcr:content\",\n+                        \"jcr:data\", \"Released content\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/source/released/jcr:content\",\n+                        \"jcr:data\", \"Released content\");\n+        Map<String, Object> map = new HashMap<>();\n+        map.put(\"type\",\"module\");\n+        slingContext.request().setParameterMap(map);\n+        registerMockAdapter(Module.class, slingContext);\n+        registerMockAdapter(ModuleVersion.class, slingContext);\n+        ServiceResourceResolverProvider serviceResourceResolverProvider = Mockito.mock(ServiceResourceResolverProvider.class);\n+        ResourceResolver resourceResolver = slingContext.request().getResourceResolver();\n+        Module module = slingContext.request().adaptTo(Module.class);\n+        lenient().doReturn(resourceResolver)\n+                .when(serviceResourceResolverProvider).getServiceResourceResolver();\n+        Events events = mock(Events.class);\n+        HtmlResponse postResponse = new HtmlResponse();\n+        List<Modification> changes = newArrayList();\n+        slingContext.request().setResource( slingContext.resourceResolver().getResource(\"/content/repositories/repo/module\") );\n+        UnpublishVersion operation = new UnpublishVersion(events, serviceResourceResolverProvider);\n+\n+        // When\n+        operation.doRun(slingContext.request(), postResponse, changes);\n+\n+        // Then\n+        assertEquals(1, changes.size());\n+        assertEquals(ModificationType.MODIFY, changes.get(0).getType());\n+        assertEquals(\"/content/repositories/repo/module\", changes.get(0).getSource());\n+        assertEquals(HttpServletResponse.SC_OK, postResponse.getStatusCode());\n+        assertNull(slingContext.resourceResolver().getResource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/released\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/content/repositories/repo/module/en_US/variants/DEFAULT/draft\"));\n+        assertNull(slingContext.resourceResolver().getResource(\"/content/repositories/repo/module/en_US/source/released\"));\n+\n+    }\n+\n+    @Test\n+    @DisplayName(\"doRun for module with both released and draft version\")\n+    void doRunWithDraftVersoin() throws Exception {", "originalCommit": "f225302faffea8ee453da6ff97e65662238ed077", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "154a747b51d8389241af8fbcbfee9519eb9222e0", "url": "https://github.com/redhataccess/pantheon/commit/154a747b51d8389241af8fbcbfee9519eb9222e0", "message": "CCS-3550) Publishing or republishing an assembly", "committedDate": "2020-08-17T14:33:25Z", "type": "commit"}, {"oid": "154a747b51d8389241af8fbcbfee9519eb9222e0", "url": "https://github.com/redhataccess/pantheon/commit/154a747b51d8389241af8fbcbfee9519eb9222e0", "message": "CCS-3550) Publishing or republishing an assembly", "committedDate": "2020-08-17T14:33:25Z", "type": "forcePushed"}, {"oid": "67493422ea791c56642c224704867c6a692c1974", "url": "https://github.com/redhataccess/pantheon/commit/67493422ea791c56642c224704867c6a692c1974", "message": "CCS-3550) Publishing or republishing an assembly", "committedDate": "2020-08-17T14:40:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NzgyNw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471667827", "bodyText": "Still need to rename this to Assembly (vs module)\nEdit: Keeping this comment, but you mentioned renaming this might impact Hydra somehow.", "author": "benradey", "createdAt": "2020-08-17T18:05:40Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/events/assembly/AssemblyVersionPublishStateEvent.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.redhat.pantheon.extension.events.assembly;\n+\n+import com.redhat.pantheon.extension.Event;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Event fired when a assembly version has been published.\n+ * Includes the assembly version path so it can be re-fetched in the\n+ * handlers if necessary.\n+ */\n+public class AssemblyVersionPublishStateEvent implements Event {\n+\n+    private final String moduleVersionPath;", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY3NjU3MQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471676571", "bodyText": "@rednitish I realize you did not write this code originally, but now that I'm looking at it, I see that the variable m here is just unused. That has me wondering if the initial call to traverseFrom is unnecessary, or if this technique isn't being used in the wrong way.\n@carlosmunoz Since you're the mastermind behind most of the model api, can you comment on whether this is the best way to get from Document down to ultimately DocumentVariant? Am I right in thinking that the discarding of m is a code smell? And what's the difference between using ResourceTraversal vs using the model api directly, such as document.get().locale(whatever).get().variants().get().variant(\"variant\").get()?", "author": "benradey", "createdAt": "2020-08-17T18:21:37Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -114,46 +120,40 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            Optional<? extends Document> document = getDocument(request, serviceResourceResolver);\n             Locale locale = getLocale(request);\n             String variant = getVariant(request);\n             // Get the draft version, there should be one\n-            Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n+            Optional<? extends DocumentVersion> versionToRelease = document.get().getDraftVersion(locale, variant);\n             if (!versionToRelease.isPresent()) {\n                 response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n-                        \"The module doesn't have a draft version to be released\");\n+                        \"The document doesn't have a draft version to be released\");\n                 return;\n             } else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n                     || versionToRelease.get().metadata().getOrCreate().productVersion().get().isEmpty()) {\n                 // Check if productVersion is set\n                 response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n                         \"The version to be released doesn't have productVersion metadata\");\n                 return;\n-            } else if (versionToRelease.get().metadata().getOrCreate().urlFragment().get() == null\n-                    || versionToRelease.get().metadata().getOrCreate().urlFragment().get().isEmpty()) {\n-                // Check if urlFragment is set\n-                response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n-                        \"The version to be released doesn't have urlFragment metadata\");\n-                return;\n             } else {\n                 // Draft becomes the new released version\n-                ModuleVariant moduleVariant = traverseFrom(module)\n-                        .toChild(m -> module.locale(locale))\n-                        .toChild(ModuleLocale::variants)\n+                DocumentVariant docVariant = traverseFrom(document.get())\n+                        .toChild(m -> document.get().locale(locale))", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY4NjIxOQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471686219", "bodyText": "You shouldn't need a call to a new getDocument() method here, you should just be able to use the original line and just replace Module with Document.", "author": "benradey", "createdAt": "2020-08-17T18:30:08Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -114,46 +120,40 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            Optional<? extends Document> document = getDocument(request, serviceResourceResolver);", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwNDQwMg==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471704402", "bodyText": "I have a bunch of thoughts about this method.\n\nIt doesn't make a whole lot of sense to use both @NotNull and the Optional construct together. The whole point of Optional is to wrap something that may be null, so if your method returns an Optional, then of course the reference to the Optional itself is never going to be null (even if the thing that it wraps might be). Having said that, Sling makes sure that your servlet is only called when your Resource actually exists, so we don't need to worry about a null check. If I weren't about to recommend that you just remove this method, then I would recommend that you just drop both constructs because it's not worth worrying about.\nThe if () statement here is a bit long. If I were writing this method, here's how I'd do it instead:\n\nResource r = serviceResourceResolver.getResource(request.getResource().getPath());\nif (\"pantheon/assembly\".equals(r.getResourceType()) {\n    return r.adaptTo(Assembly.class);\n} else {\n    return r.adaptTo(Module.class);\n}\n\n\nHowever, you really don't need the method at all. Just call .adaptTo(Document.class) on line 123 and use that for the entire servlet. Since you need to know what type of event to fire on line 97, just check the resource type there. The rest of the servlet can be completely generic.\nIf you get rid of the unnecessary Optional construct, you don't need .get() cluttering up the code.", "author": "benradey", "createdAt": "2020-08-17T18:43:13Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -179,4 +179,14 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             throw new RepositoryException(ex.getMessage());\n         }\n     }\n+\n+    @NotNull\n+    private Optional<? extends Document> getDocument(SlingHttpServletRequest request, ResourceResolver serviceResourceResolver) {\n+        if(serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Document.class).getResourceType().equalsIgnoreCase(\"pantheon/assembly\")){\n+            Assembly assembly = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Assembly.class);\n+            return Optional.ofNullable(assembly);\n+        }\n+            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            return Optional.ofNullable(module);\n+    }", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwNjY2Nw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471706667", "bodyText": "This is the only place where you need to know whether it's assembly vs module. I would not use instanceof here - rather, I would just use if (\"pantheon/assemblyVersion\".equals(documentVersion.getResourceType()) or something similar. Let me know if you don't understand why, we can talk about the difference on chat.", "author": "benradey", "createdAt": "2020-08-17T18:46:01Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -80,16 +81,21 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n         if (response.getError() == null) {\n             // call the extension point\n             Locale locale = getLocale(request);\n-            Module module = getModule(request);\n+            Optional<? extends Document> document = getDocument(request, request.getResourceResolver());\n             String variant = getVariant(request);\n-            ModuleVersion moduleVersion = module.locale(locale).get()\n+            Optional<? extends DocumentVersion> documentVersion = Optional.of(document.get().locale(locale).get()\n                     .variants().get()\n                     .variant(variant).get()\n-                    .released().get();\n+                    .released().get());\n+\n+            // Regenerate the document once more\n+            asciidoctorService.getModuleHtml(document.get(), locale, variant, false, new HashMap(), true);\n \n-            // Regenerate the module once more\n-            asciidoctorService.getModuleHtml(module, locale, variant, false, new HashMap(), true);\n-            events.fireEvent(new ModuleVersionPublishedEvent(moduleVersion), 15);\n+            if(documentVersion.get() instanceof AssemblyVersion){\n+                events.fireEvent(new AssemblyVersionPublishedEvent((AssemblyVersion) documentVersion.get()), 15);\n+            }else{\n+                events.fireEvent(new ModuleVersionPublishedEvent((ModuleVersion)documentVersion.get()), 15);\n+            }", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwNzA1NQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471707055", "bodyText": "Same comment here as publish servlet.", "author": "benradey", "createdAt": "2020-08-17T18:46:50Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/UnpublishVersion.java", "diffHunk": "@@ -88,15 +91,19 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n         if (response.getError() == null) {\n             // call the extension point\n             Locale locale = getLocale(request);\n-            Module module = getModule(request);\n+            Optional<? extends Document> document = getDocument(request, request.getResourceResolver());\n             String variant = getVariant(request);\n-            ModuleVersion moduleVersion = module.locale(locale).get()\n+            Optional<? extends DocumentVersion> documentVersion = Optional.of(document.get().locale(locale).get()\n                     .variants().get()\n                     .variant(variant).get()\n-                    .draft().get();\n+                    .draft().get());\n \n             // TODO We need to change the event so that the right variant is processed\n-            events.fireEvent(new ModuleVersionUnpublishedEvent(moduleVersion), 15);\n+            if(documentVersion.get() instanceof AssemblyVersion){\n+                events.fireEvent(new AssemblyVersionPublishedEvent((AssemblyVersion) documentVersion.get()), 15);\n+            }else{\n+                events.fireEvent(new ModuleVersionPublishedEvent((ModuleVersion)documentVersion.get()), 15);\n+            }", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwNzM1NQ==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471707355", "bodyText": "Same comments here, I am betting this Optional construct is unnecessary.", "author": "benradey", "createdAt": "2020-08-17T18:47:26Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/UnpublishVersion.java", "diffHunk": "@@ -88,15 +91,19 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n         if (response.getError() == null) {\n             // call the extension point\n             Locale locale = getLocale(request);\n-            Module module = getModule(request);\n+            Optional<? extends Document> document = getDocument(request, request.getResourceResolver());\n             String variant = getVariant(request);\n-            ModuleVersion moduleVersion = module.locale(locale).get()\n+            Optional<? extends DocumentVersion> documentVersion = Optional.of(document.get().locale(locale).get()", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwODA0Mw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471708043", "bodyText": "Again, unnecessary, you should just be able to .adaptTo(Document.class) and the code should still function.", "author": "benradey", "createdAt": "2020-08-17T18:48:48Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/UnpublishVersion.java", "diffHunk": "@@ -121,32 +128,41 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             if(canUnPublish) {\n                 serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n             }\n-            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            Optional<? extends Document> document;\n+            if(serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Document.class).getResourceType().equalsIgnoreCase(\"pantheon/assembly\")){\n+                Assembly assembly = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Assembly.class);\n+                document = Optional.ofNullable(assembly);\n+            }\n+            else{\n+                Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+                document = Optional.ofNullable(module);\n+\n+            }", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwODE0OA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r471708148", "bodyText": "Same comment as publish servlet, please remove this method.", "author": "benradey", "createdAt": "2020-08-17T18:49:02Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/UnpublishVersion.java", "diffHunk": "@@ -173,4 +189,13 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             throw new RepositoryException(ex.getMessage());\n         }\n     }\n+    @NotNull\n+    private Optional<? extends Document> getDocument(SlingHttpServletRequest request, ResourceResolver serviceResourceResolver) {\n+        if(serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Document.class).getResourceType().equalsIgnoreCase(\"pantheon/assembly\")){\n+            Assembly assembly = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Assembly.class);\n+            return Optional.ofNullable(assembly);\n+        }\n+        Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+        return Optional.ofNullable(module);\n+    }", "originalCommit": "67493422ea791c56642c224704867c6a692c1974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8d7123aaa654a86e58a87d71d842ea607e5549a", "url": "https://github.com/redhataccess/pantheon/commit/d8d7123aaa654a86e58a87d71d842ea607e5549a", "message": "CCS-3550) Publishing or republishing an assembly (Ben's review fixes", "committedDate": "2020-08-18T07:58:51Z", "type": "commit"}, {"oid": "f8010e9940b64683f8551daa1e4c69378d42f7ff", "url": "https://github.com/redhataccess/pantheon/commit/f8010e9940b64683f8551daa1e4c69378d42f7ff", "message": "CCS-3550) Publishing or republishing an assembly (Ben's review fixes)", "committedDate": "2020-08-18T08:16:32Z", "type": "commit"}, {"oid": "6250ccd62f56d2b55f4425ad652e169d182cf779", "url": "https://github.com/redhataccess/pantheon/commit/6250ccd62f56d2b55f4425ad652e169d182cf779", "message": "CCS-3550) Publishing or republishing an assembly (Ben's review fixes)", "committedDate": "2020-08-18T08:28:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2NjQ1OA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r473266458", "bodyText": "This is interesting. It looks like we're putting effort into figuring out whether the resource is a module or an assembly, but then we're ultimately discarding the answer and just casting to a generic document class for the rest of the method. I bet this could be removed.\nI know you didn't write this originally, but since it looks like you have a conflict to resolve anyway, bonus points for taking care of this at the same time. :)", "author": "benradey", "createdAt": "2020-08-19T19:23:59Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/asciidoctor/AsciidoctorService.java", "diffHunk": "@@ -176,10 +177,10 @@ private String buildDocument(@Nonnull Document base, @Nonnull Locale locale, @No\n                     + \",variant: \" + variantName + \", draft: \" + isDraft);\n         }\n \n-        // Use a service-level resource resolver to build the module as it will require write access to the resources\n+        // Use a service-level resource resolver to build the module or assemblies as it will require write access to the resources\n         try (ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver()) {\n \n-            Class cls = base instanceof Module ? Module.class : Assembly.class;\n+            Class cls = base.getResourceType().equals(PantheonConstants.RESOURCETYPE_ASSEMBLY) ? Assembly.class : Module.class;\n             Document serviceDocument = (Document) SlingModels.getModel(serviceResourceResolver, base.getPath(), cls);", "originalCommit": "6250ccd62f56d2b55f4425ad652e169d182cf779", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzNjY0MA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r474036640", "bodyText": "@benradey  I have created a separate ticket, to track this code quality issue, we can work on it separately.\nhttps://projects.engineering.redhat.com/browse/CCS-3772", "author": "rednitish", "createdAt": "2020-08-20T14:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2NjQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2OTgyMg==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r473269822", "bodyText": "Not your code, but I worry that we have a bug here, so also tagging @carlosmunoz @xdavidson @aprajshekhar.\nI don't think it's appropriate to assume that if the caller doesn't specify a variant parameter for publishing, that we assume DEFAULT_VARIANT_NAME.\nBetter options:\n\nAssume document.getWorkspace().getCanonicalVariantName()\nThrow an exception, because if the caller is publishing something, they should be explicit about which variant they want rather than us potentially guessing wrong.\n\nThoughts / other opinions?", "author": "benradey", "createdAt": "2020-08-19T19:30:34Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/PublishDraftVersion.java", "diffHunk": "@@ -60,16 +63,16 @@ public PublishDraftVersion(@Reference Events events,\n         this.serviceResourceResolverProvider = serviceResourceResolverProvider;\n     }\n \n-    private Module getModule(SlingHttpServletRequest request) {\n-        return request.getResource().adaptTo(Module.class);\n+    private Document getDocument(SlingHttpServletRequest request) {\n+        return request.getResource().adaptTo(Document.class);\n     }\n \n     private Locale getLocale(SlingHttpServletRequest request) {\n         return paramValueAsLocale(request, \"locale\", GlobalConfig.DEFAULT_MODULE_LOCALE);\n     }\n \n     private String getVariant(SlingHttpServletRequest request) {\n-        return paramValue(request, \"variant\", ModuleVariant.DEFAULT_VARIANT_NAME);\n+        return paramValue(request, \"variant\", DocumentVariant.DEFAULT_VARIANT_NAME);\n     }", "originalCommit": "6250ccd62f56d2b55f4425ad652e169d182cf779", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NTE4Nw==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r473275187", "bodyText": "For the record, the same method appears in UnpublishVersion.java as well.", "author": "benradey", "createdAt": "2020-08-19T19:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2OTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzczOTE3OA==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r473739178", "bodyText": "@benradey since this logic appears at multiple files, I would say let's table it till MS3 is done. Creating a JIRA to track this is what I would suggest and lets discuss the options there. Discussing it here would need updating the JIRA and that would be a overhead. Just my two cents.", "author": "aprajshekhar", "createdAt": "2020-08-20T08:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2OTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzNjg1Mg==", "url": "https://github.com/redhataccess/pantheon/pull/369#discussion_r474036852", "bodyText": "@benradey  please check my comment above", "author": "rednitish", "createdAt": "2020-08-20T14:42:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2OTgyMg=="}], "type": "inlineReview"}, {"oid": "144654b01232b35903cfc312d70df21c6138f849", "url": "https://github.com/redhataccess/pantheon/commit/144654b01232b35903cfc312d70df21c6138f849", "message": "Merge remote-tracking branch 'refs/remotes/upstream/master'", "committedDate": "2020-08-20T14:55:03Z", "type": "commit"}]}