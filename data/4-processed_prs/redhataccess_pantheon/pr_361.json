{"pr_number": 361, "pr_title": "CCS-3683) unable to publish module when logged in as a demo user", "pr_createdAt": "2020-08-05T12:20:56Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/361", "timeline": [{"oid": "65d0b1b5d241b4b5846b82d50cc1a761cf8a653e", "url": "https://github.com/redhataccess/pantheon/commit/65d0b1b5d241b4b5846b82d50cc1a761cf8a653e", "message": "PnT JIRA (CCS-3683) unable to publish module when logged in as a demo user", "committedDate": "2020-07-29T16:56:47Z", "type": "commit"}, {"oid": "0995302e7f46cbf30523ddc222649c38ba3d66f4", "url": "https://github.com/redhataccess/pantheon/commit/0995302e7f46cbf30523ddc222649c38ba3d66f4", "message": "Fix: resoure resolver closed with try with resource block", "committedDate": "2020-07-30T10:38:10Z", "type": "commit"}, {"oid": "a44de84898cf20f93ad8ad518cd5507b285893dc", "url": "https://github.com/redhataccess/pantheon/commit/a44de84898cf20f93ad8ad518cd5507b285893dc", "message": "Fix: resoure resolver closed with try with resource block : review comments from AP", "committedDate": "2020-07-30T10:55:45Z", "type": "commit"}, {"oid": "f19c98d18b0c32d126f8468c70d1ec20261f86bc", "url": "https://github.com/redhataccess/pantheon/commit/f19c98d18b0c32d126f8468c70d1ec20261f86bc", "message": "Merge remote-tracking branch 'refs/remotes/upstream/master'", "committedDate": "2020-08-04T11:24:52Z", "type": "commit"}, {"oid": "e53a109270b7b7be55c6ab3eba329802165ecb92", "url": "https://github.com/redhataccess/pantheon/commit/e53a109270b7b7be55c6ab3eba329802165ecb92", "message": "demo user publish allowed by other users", "committedDate": "2020-08-05T11:50:15Z", "type": "commit"}, {"oid": "b2bce6698660c7eb41eb86efd892d9d4ceb5aa22", "url": "https://github.com/redhataccess/pantheon/commit/b2bce6698660c7eb41eb86efd892d9d4ceb5aa22", "message": "unpublish by user other than publishers should not be allowed", "committedDate": "2020-08-05T12:17:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY4NjgzNw==", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465686837", "bodyText": "Why Boolean and not boolean is being used?", "author": "aprajshekhar", "createdAt": "2020-08-05T12:23:09Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "diffHunk": "@@ -92,11 +99,23 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws  RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            Boolean canPublish = false;", "originalCommit": "b2bce6698660c7eb41eb86efd892d9d4ceb5aa22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY4NzMwNg==", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465687306", "bodyText": "Same as above.", "author": "aprajshekhar", "createdAt": "2020-08-05T12:24:04Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/UnpublishVersion.java", "diffHunk": "@@ -99,7 +106,20 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            Boolean canUnPublish = false;", "originalCommit": "b2bce6698660c7eb41eb86efd892d9d4ceb5aa22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3cdcbad34964e4a5388fa8e1d010475baf17b615", "url": "https://github.com/redhataccess/pantheon/commit/3cdcbad34964e4a5388fa8e1d010475baf17b615", "message": "unpublish by user other than publishers should not be allowed", "committedDate": "2020-08-05T12:36:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5ODMxOQ==", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465698319", "bodyText": "It will be better to break once you set canPublish", "author": "aprajshekhar", "createdAt": "2020-08-05T12:43:50Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "diffHunk": "@@ -92,11 +99,23 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws  RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            boolean canPublish = false;\n+            Session session = request.getResourceResolver().adaptTo(Session.class);\n+            UserManager userManager = AccessControlUtil.getUserManager(session);\n+            Iterator<Group> groupIterator = userManager.getAuthorizable(session.getUserID()).memberOf();\n+            while (groupIterator.hasNext()) {\n+                Authorizable group = groupIterator.next();\n+                if (group.isGroup() && PantheonConstants.PANTHEON_PUBLISHERS.equalsIgnoreCase(group.getID())) {\n+                    canPublish = true;", "originalCommit": "3cdcbad34964e4a5388fa8e1d010475baf17b615", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5ODc0MQ==", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465698741", "bodyText": "It will be better to break once you set canPublish as check is done and we have the required state.", "author": "aprajshekhar", "createdAt": "2020-08-05T12:44:33Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/UnpublishVersion.java", "diffHunk": "@@ -99,7 +106,20 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            boolean canUnPublish = false;\n+            Session session = request.getResourceResolver().adaptTo(Session.class);\n+            UserManager userManager = AccessControlUtil.getUserManager(session);\n+            Iterator<Group> groupIterator = userManager.getAuthorizable(session.getUserID()).memberOf();\n+            while (groupIterator.hasNext()) {\n+                Authorizable group = groupIterator.next();\n+                if (group.isGroup() && PantheonConstants.PANTHEON_PUBLISHERS.equalsIgnoreCase(group.getID())) {\n+                    canUnPublish = true;", "originalCommit": "3cdcbad34964e4a5388fa8e1d010475baf17b615", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea7456d0a9f47a6a2290144c2be69baf0c9628b1", "url": "https://github.com/redhataccess/pantheon/commit/ea7456d0a9f47a6a2290144c2be69baf0c9628b1", "message": "unpublish by user other than publishers should not be allowed", "committedDate": "2020-08-05T13:19:57Z", "type": "commit"}]}