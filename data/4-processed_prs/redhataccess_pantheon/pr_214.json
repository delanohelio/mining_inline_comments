{"pr_number": 214, "pr_title": "Module query modifications", "pr_createdAt": "2020-01-23T19:52:27Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/214", "timeline": [{"oid": "127484d3a45532df0ac17d43e55bd2e231c2b8b4", "url": "https://github.com/redhataccess/pantheon/commit/127484d3a45532df0ac17d43e55bd2e231c2b8b4", "message": "modify the module query to avoid unnecessary query filters\n\nalso use direct types vs querying over nt:base", "committedDate": "2020-01-23T02:06:52Z", "type": "commit"}, {"oid": "2066675bc31225b2a563fd4ebb3d9b138613d997", "url": "https://github.com/redhataccess/pantheon/commit/2066675bc31225b2a563fd4ebb3d9b138613d997", "message": "Remove modules oak:index", "committedDate": "2020-01-23T18:33:31Z", "type": "commit"}, {"oid": "71d270b24a1d3acf36ebdf91561a55c0df012af5", "url": "https://github.com/redhataccess/pantheon/commit/71d270b24a1d3acf36ebdf91561a55c0df012af5", "message": "add a query index specifically for the module query", "committedDate": "2020-01-24T15:52:14Z", "type": "commit"}, {"oid": "5941029ed502735d3fb21a43aa43b19868867cb6", "url": "https://github.com/redhataccess/pantheon/commit/5941029ed502735d3fb21a43aa43b19868867cb6", "message": "Revert \"add a query index specifically for the module query\"\n\nThis reverts commit 71d270b24a1d3acf36ebdf91561a55c0df012af5.", "committedDate": "2020-01-24T20:15:32Z", "type": "commit"}, {"oid": "2224b0df47f569232fad4a03999866fd227c72a5", "url": "https://github.com/redhataccess/pantheon/commit/2224b0df47f569232fad4a03999866fd227c72a5", "message": "restrict the module query by path", "committedDate": "2020-01-24T20:55:55Z", "type": "commit"}, {"oid": "2d92292390cb24e1c1c27c5d0240d902695052a0", "url": "https://github.com/redhataccess/pantheon/commit/2d92292390cb24e1c1c27c5d0240d902695052a0", "message": "switch the module listing query to XPATH\n\nalso shorten the product queries now that the offending index has been eliminated", "committedDate": "2020-01-25T19:14:06Z", "type": "commit"}, {"oid": "f53dfc4b55f6a7c1a8966da3583b767ed8aaa846", "url": "https://github.com/redhataccess/pantheon/commit/f53dfc4b55f6a7c1a8966da3583b767ed8aaa846", "message": "fix failing tests", "committedDate": "2020-01-25T19:22:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMzg5OQ==", "url": "https://github.com/redhataccess/pantheon/pull/214#discussion_r371523899", "bodyText": "We still have this inner join - is it worth eliminating? We could probably easily use deep attribute inspection here.", "author": "benradey", "createdAt": "2020-01-27T22:41:43Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/ModuleListingServlet.java", "diffHunk": "@@ -148,10 +163,9 @@ protected String getQuery(SlingHttpServletRequest request) {\n         productCondition = \"AND (\" + StringUtils.join(conditions, \" OR \") + \") \";\n \n         StringBuilder query = new StringBuilder()\n-                .append(\"SELECT pv.* from [nt:base] AS pv \")\n-                .append(\"INNER JOIN [nt:base] AS product ON ISDESCENDANTNODE(pv, product) \")\n-                .append(\"WHERE pv.[jcr:primaryType] = 'pant:productVersion' \")\n-                .append(\"AND product.[jcr:primaryType] = 'pant:product' \")\n+                .append(\"SELECT pv.* from [pant:productVersion] AS pv \")\n+                .append(\"INNER JOIN [pant:product] AS product ON ISDESCENDANTNODE(pv, product) \")", "originalCommit": "f53dfc4b55f6a7c1a8966da3583b767ed8aaa846", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU4MjA4Mg==", "url": "https://github.com/redhataccess/pantheon/pull/214#discussion_r371582082", "bodyText": "This one is trickier to turn into XPATH, as we are actually filtering on a parent node's properties from the child. A single join doesn't seem to be as costly also. In addition, this one is only being executed when the product filters are used, so any additional cost is limited to those scenarios.", "author": "carlosmunoz", "createdAt": "2020-01-28T02:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMzg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwNjgwNQ==", "url": "https://github.com/redhataccess/pantheon/pull/214#discussion_r371806805", "bodyText": "Ooof. Good point. Alright, we can save this one for later/never.", "author": "benradey", "createdAt": "2020-01-28T13:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMzg5OQ=="}], "type": "inlineReview"}]}