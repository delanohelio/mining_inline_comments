{"pr_number": 218, "pr_title": "[CCS-2965] update unpublish event message", "pr_createdAt": "2020-01-28T20:45:17Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/218", "timeline": [{"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2", "url": "https://github.com/redhataccess/pantheon/commit/7090f9c5cde9399814e2ae3921a403397fad3ab2", "message": "[CCS-2965] update unpublish event message", "committedDate": "2020-01-28T19:17:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0OTcyMw==", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372049723", "bodyText": "what  happens if the portal URL is not defined? seems like it would still seek to publish an empty id.\nShould we abort the message in that case?", "author": "carlosmunoz", "createdAt": "2020-01-28T20:53:45Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/HydraIntegration.java", "diffHunk": "@@ -104,11 +113,26 @@ public void processEvent(Event event) throws Exception {\n         MessageProducer producer = session.createProducer(session.createTopic(HYDRA_TOPIC));\n         String moduleUUID = module.getValueMap().get(UUID_FIELD, String.class);\n         String eventValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? EVENT_PUBLISH_VALUE : EVENT_UNPUBLISH_VALUE;\n-        String msg = \"{\\\"\"\n-                + ID_KEY + \"\\\":\" + \"\\\"\" + this.getPantheonHost() + PANTHEON_MODULE_API_PATH + moduleUUID +\"\\\",\"\n-                + \"\\\"\" + EVENT_KEY + \"\\\":\" + \"\\\"\" + eventValue + \"\\\"}\";\n+        String idValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? this.getPantheonHost() + PANTHEON_MODULE_API_PATH\n+                + moduleUUID : \"\";\n+        String uriValue = \"\";\n+        String msg = \"\";\n+        if (System.getenv(PORTAL_URL) != null) {", "originalCommit": "7090f9c5cde9399814e2ae3921a403397fad3ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzODg2Mw==", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372538863", "bodyText": "good catch. i've refactored the code.", "author": "xdavidson", "createdAt": "2020-01-29T17:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0OTcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MDY1OA==", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372050658", "bodyText": "So, this will NOT be appearing in the API anymore?\nJust confirming...", "author": "carlosmunoz", "createdAt": "2020-01-28T20:55:50Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/ModuleJsonServlet.java", "diffHunk": "@@ -158,12 +158,6 @@ protected boolean isValidResource(@Nonnull SlingHttpServletRequest request, @Non\n             moduleMap.put(VIEW_URI, view_uri);\n         }\n \n-        // Process view_uri\n-        if (System.getenv(\"PORTAL_URL\") != null) {", "originalCommit": "7090f9c5cde9399814e2ae3921a403397fad3ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNTYzNA==", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372425634", "bodyText": "line 161 is a duplicated code block.", "author": "xdavidson", "createdAt": "2020-01-29T14:48:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MDY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MjAyNQ==", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372052025", "bodyText": "I'm having a bit of trouble following these event types. Could you explain what the difference is between ModuleVersionPublishStateEvent and ModuleVerisonPublishedEvent? they seem to be the same thing", "author": "carlosmunoz", "createdAt": "2020-01-28T20:58:47Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/HydraIntegration.java", "diffHunk": "@@ -23,19 +22,27 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.redhat.pantheon.extension.events.ModuleVersionPublishStateEvent;\n import com.redhat.pantheon.extension.events.ModuleVersionPublishedEvent;", "originalCommit": "7090f9c5cde9399814e2ae3921a403397fad3ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ5NjgzNQ==", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372496835", "bodyText": "line 25 is a result of Eclipse reorganizing its import statements. It used to be on line 15.\nI think ModuleVersionPublishStateEvent can be a ModuleVersionPublishedEvent or ModuleVersionUnpublishedEvent", "author": "xdavidson", "createdAt": "2020-01-29T16:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MjAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUwODk1NQ==", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372508955", "bodyText": "Ok, I think I understand now.... in this case I would turn this into an else if for the specific implementation class, and have the else statement log some sort of warning. It will help us identify when we have an event type that is not being handled by the code.", "author": "carlosmunoz", "createdAt": "2020-01-29T16:59:41Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/HydraIntegration.java", "diffHunk": "@@ -104,11 +113,26 @@ public void processEvent(Event event) throws Exception {\n         MessageProducer producer = session.createProducer(session.createTopic(HYDRA_TOPIC));\n         String moduleUUID = module.getValueMap().get(UUID_FIELD, String.class);\n         String eventValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? EVENT_PUBLISH_VALUE : EVENT_UNPUBLISH_VALUE;\n-        String msg = \"{\\\"\"\n-                + ID_KEY + \"\\\":\" + \"\\\"\" + this.getPantheonHost() + PANTHEON_MODULE_API_PATH + moduleUUID +\"\\\",\"\n-                + \"\\\"\" + EVENT_KEY + \"\\\":\" + \"\\\"\" + eventValue + \"\\\"}\";\n+        String idValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? this.getPantheonHost() + PANTHEON_MODULE_API_PATH\n+                + moduleUUID : \"\";\n+        String uriValue = \"\";\n+        String msg = \"\";\n+        if (System.getenv(PORTAL_URL) != null) {\n+            uriValue = System.getenv(PORTAL_URL) + \"/topics/\" + ServletUtils.toLanguageTag(DEFAULT_MODULE_LOCALE) + \"/\" + moduleUUID;\n+        }\n+        if (ModuleVersionPublishedEvent.class.equals(event.getClass())) {\n+            msg = \"{\\\"\"\n+                    + ID_KEY + \"\\\":\" + \"\\\"\" + idValue +\"\\\",\"\n+                    + \"\\\"\" + EVENT_KEY + \"\\\":\" + \"\\\"\" + eventValue + \"\\\"}\";\n+        } else {", "originalCommit": "7090f9c5cde9399814e2ae3921a403397fad3ab2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67dfb817c65a5a09bb037d725adbabefb495fc0a", "url": "https://github.com/redhataccess/pantheon/commit/67dfb817c65a5a09bb037d725adbabefb495fc0a", "message": "refactor code for unpublish event", "committedDate": "2020-01-29T17:54:56Z", "type": "commit"}, {"oid": "6e38360359f89d7c59fc03bb2a41084130e7bcae", "url": "https://github.com/redhataccess/pantheon/commit/6e38360359f89d7c59fc03bb2a41084130e7bcae", "message": "add warning message for unhandled event type", "committedDate": "2020-01-29T20:44:12Z", "type": "commit"}]}