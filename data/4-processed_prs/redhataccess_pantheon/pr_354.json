{"pr_number": 354, "pr_title": "CCS-3717: Updates to frontend build", "pr_createdAt": "2020-07-27T18:11:28Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/354", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3MzAzMA==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r461773030", "bodyText": "Thanks, invisible whitespace bugs me. :)", "author": "benradey", "createdAt": "2020-07-28T18:05:17Z", "path": "README.md", "diffHunk": "@@ -22,9 +22,9 @@ and built on top of Apache sling.\n \n ### Prerequisites\n \n-* You must have an account on GitHub.  \n+* You must have an account on GitHub.", "originalCommit": "74aad66fcb8c70829b9f9b8c634ca8b40293cf9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDQ1Nw==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r461884457", "bodyText": "Agree!! I just realized my editor hadn't been removing trailing white space for me this week.\nThanks!", "author": "wesruv", "createdAt": "2020-07-28T21:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3MzAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3MzMzNA==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r461773334", "bodyText": "Glad you got rid of this, it always felt like a hack.", "author": "benradey", "createdAt": "2020-07-28T18:05:53Z", "path": "README.md", "diffHunk": "@@ -182,27 +182,26 @@ This will install the code in this project on the running Sling instance, where\n be previewed and modified.\n ### Developing the frontend code\n \n-If making modifications that are entirely contained within the frontend, it is not necessary to use maven to rebuild and redeploy the package on every change.\n-\n-These instructions provide an imperfect-but-workable shortcut that can accelerate development.\n+If making modifications that are entirely contained within the frontend, follow the instructions to build the application in this README, then\n \n ```sh\n-cd pantheon/frontend\n+cd pantheon-bundle/frontend\n+# Install/update node deps\n+yarn\n+# Build the app\n+yarn build\n+# Run React dev server/process\n yarn start\n ```\n \n+See the pantheon-bundle/frontend/README.md for more information on the development server\n+\n NOTE: It will likely be necessary to increase your inotify limit to ensure that yarn is able to detect changes in every project file.\n If you are running into issues with yarn not automatically detecting saved changes, run the following command (its effects are permenent):\n ```sh\n echo fs.inotify.max_user_watches=65535 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p\n ```\n \n-```sh\n-chromium-browser --disable-web-security --user-data-dir=/home/user/anywhere/chromeDev/ &\n-```\n-\n-This works because there is code in app.tsx that preempts all fetch() calls and checks if the app is being served from localhost. If so, it modifies the request to point to localhost:8080 specifically, rather than localhost:9000 which is where webpack-dev-server serves the frontend code from.\n-", "originalCommit": "74aad66fcb8c70829b9f9b8c634ca8b40293cf9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3NzU3Ng==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r461777576", "bodyText": "I do not recall why we originally needed this... are you sure it is still necessary? Did you try and remove it completely?\n(I'm the one who wrote this method in the first place... I don't recall if it was for a frontend development workaround, or if it was so that our yarn tests would pass... if only I had included some comments about this...)", "author": "benradey", "createdAt": "2020-07-28T18:13:36Z", "path": "pantheon-bundle/frontend/src/app/app.tsx", "diffHunk": "@@ -27,12 +27,16 @@ class App extends Component<any, IAppState> {\n \n     const realFetch = self.fetch\n     self.fetch = (input: RequestInfo, init?: RequestInit | undefined) => {\n-      let newInput = input.toString()\n-      if (window.location.host.startsWith('localhost') && input.toString().startsWith('/')) {\n+      let newInput = input.toString();\n+      if (\n+        window.location.host.startsWith('localhost')\n+        // Only changing requests Sling's old port\n+        && parseInt(window.location.port) === 8080\n+        && input.toString().startsWith('/')) {", "originalCommit": "74aad66fcb8c70829b9f9b8c634ca8b40293cf9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NTgyMQ==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r461885821", "bodyText": "It's required if you want it to work inside of Karaf. I'm not sure how all that stuff works, so I thought it'd be fine to leave it.\nWhat's really weird is that the code is trying to reach :8080 in Karaf, when it should be :8181, if we fix that then we can definitely get rid of this code. No idea what's causing it.", "author": "wesruv", "createdAt": "2020-07-28T21:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3NzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3MTU1NA==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r462371554", "bodyText": "I did some quick testing without the code and it doesn't look like it makes any difference anymore - so please take this opportunity to get rid of it.", "author": "benradey", "createdAt": "2020-07-29T15:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3NzU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3Nzk4NA==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r461777984", "bodyText": "\ud83e\udd2f", "author": "benradey", "createdAt": "2020-07-28T18:14:18Z", "path": "pantheon-bundle/frontend/src/app/app.tsx", "diffHunk": "@@ -27,12 +27,16 @@ class App extends Component<any, IAppState> {\n \n     const realFetch = self.fetch\n     self.fetch = (input: RequestInfo, init?: RequestInit | undefined) => {\n-      let newInput = input.toString()\n-      if (window.location.host.startsWith('localhost') && input.toString().startsWith('/')) {\n+      let newInput = input.toString();\n+      if (\n+        window.location.host.startsWith('localhost')\n+        // Only changing requests Sling's old port\n+        && parseInt(window.location.port) === 8080\n+        && input.toString().startsWith('/')) {\n         newInput = 'http://localhost:8181' + input.toString()\n       }\n       console.log('Development fetch', input, '=>', newInput)\n-      return realFetch(newInput, init)\n+      return realFetch(newInput, init);", "originalCommit": "74aad66fcb8c70829b9f9b8c634ca8b40293cf9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NTcwNA==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r461885704", "bodyText": "All this JS without colons makes me itchy \ud83d\ude02", "author": "wesruv", "createdAt": "2020-07-28T21:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3Nzk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3NDEwMg==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r462374102", "bodyText": "One thing I noticed while I was playing with this is this - while the application 99% works in \"hot frontend\" mode, the login screen does not. The login request results in a 404. I'm wondering if we need to add an additional route here to account for the login api endpoint?\nHere's a screenshot that might help:", "author": "benradey", "createdAt": "2020-07-29T15:09:05Z", "path": "pantheon-bundle/frontend/spandx.config.js", "diffHunk": "@@ -0,0 +1,47 @@\n+require(\"dotenv\").config();\n+\n+// If we have a .env file respect the HOST and PORT settings\n+// If not default to localhost\n+const HOST = process.env.HOST || 'localhost';\n+// If not default to 9595\n+const PORT = process.env.PORT || 9595;\n+\n+module.exports = {\n+  host: {\n+    local: HOST\n+  },\n+  port: PORT,\n+  open: true,\n+  startPath: \"/\",\n+  verbose: true,\n+  routes: {\n+    // Here are some routing examples to get started.\n+    \"/\": {\n+      host: {\n+          local: \"http://localhost:9000\"\n+      },\n+      path: \"/\"\n+    },\n+\n+    \"/content\": {\n+      host: {\n+        local: \"http://localhost:8181\"\n+      }\n+    },\n+    \"/system\": {\n+      host: {\n+        local: \"http://localhost:8181\"\n+      }\n+    },\n+    \"/pantheon\": {\n+      host: {\n+        local: \"http://localhost:8181\"\n+      }\n+    }", "originalCommit": "74aad66fcb8c70829b9f9b8c634ca8b40293cf9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQzMTA5NA==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r462431094", "bodyText": "Ahh, yes! I can capture that login request to make sure it goes to Karaf.\nGood catch!", "author": "wesruv", "createdAt": "2020-07-29T16:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3NDEwMg=="}], "type": "inlineReview"}, {"oid": "9175ee13e4bed7aa92241571bdc2a717be935cf5", "url": "https://github.com/redhataccess/pantheon/commit/9175ee13e4bed7aa92241571bdc2a717be935cf5", "message": "CCS-3717: Fixing errors in yarn build script", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "1a747f77c98a8f2366ba38f462b061e288b5c2a7", "url": "https://github.com/redhataccess/pantheon/commit/1a747f77c98a8f2366ba38f462b061e288b5c2a7", "message": "CCS-3717: Fixing issues that prevented mvn-free react development", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "0aa0ac5a8de75fe2fa6868ab9d953da8c0941f2c", "url": "https://github.com/redhataccess/pantheon/commit/0aa0ac5a8de75fe2fa6868ab9d953da8c0941f2c", "message": "CCS-3717: Updating README to be accurate for this project", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "25f330f60453df1f03f43b50f854ed0dc641115b", "url": "https://github.com/redhataccess/pantheon/commit/25f330f60453df1f03f43b50f854ed0dc641115b", "message": "CCS-3717: Reworking front end build to work with Karaf via proxies\n\nAdded small gulpfile to run webpack and spandx in parallel\nAdded spandx and config to proxy Karaf endpoints and react app so they think they're on the same host to avoid CORS errors\nAdded ability to set user's hostname and port for spandx interface\nCommented out code that was addressing proxy issues\nMade yarn.lock files binaries so Git won't show diffs", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "587539ebd1ed58a16bc276d574dc397f19f88108", "url": "https://github.com/redhataccess/pantheon/commit/587539ebd1ed58a16bc276d574dc397f19f88108", "message": "CCS-3717: Updating README in gitroot to have correct front-end guidance", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "2c261fc6676b780b281d311baf64164d4697731d", "url": "https://github.com/redhataccess/pantheon/commit/2c261fc6676b780b281d311baf64164d4697731d", "message": "CCS-3717: Updating docs and removing accidentally committed text change", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "446181ee712d53555297d8ce6c749d61dada534e", "url": "https://github.com/redhataccess/pantheon/commit/446181ee712d53555297d8ce6c749d61dada534e", "message": "Progress", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "8dab2813e76ee583e6211a4416e3d0a1c85086aa", "url": "https://github.com/redhataccess/pantheon/commit/8dab2813e76ee583e6211a4416e3d0a1c85086aa", "message": "CCS-3717: Fixing React Error, can't nest a tags\n\nPF's PageHeader adds an a tag around the logo, the custom brand component was also adding one\nUsing PF's Brand component and providing the props necessary to give the logo a link", "committedDate": "2020-08-10T15:50:01Z", "type": "commit"}, {"oid": "68b637f77151dfc9decf3872ac297e5ee1d259c1", "url": "https://github.com/redhataccess/pantheon/commit/68b637f77151dfc9decf3872ac297e5ee1d259c1", "message": "CCS-3717: Fixing some test errors, commenting out some tests\n\nJest can't handle a page reload or navigation because it will break Jest\nFixing the tests I was able to address not sure the solution is the best one\nCommented out some tests I wasn't able to figure out how to address", "committedDate": "2020-08-10T15:55:41Z", "type": "commit"}, {"oid": "b2e686dfa25a3ee42126782e0c3b18841ceae66e", "url": "https://github.com/redhataccess/pantheon/commit/b2e686dfa25a3ee42126782e0c3b18841ceae66e", "message": "CCS-3717: Removing unnecessary fetch rewrite", "committedDate": "2020-08-10T15:55:41Z", "type": "commit"}, {"oid": "b2e686dfa25a3ee42126782e0c3b18841ceae66e", "url": "https://github.com/redhataccess/pantheon/commit/b2e686dfa25a3ee42126782e0c3b18841ceae66e", "message": "CCS-3717: Removing unnecessary fetch rewrite", "committedDate": "2020-08-10T15:55:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODExNzc0Mg==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r468117742", "bodyText": "@wesruv what is the thought behind this change? I believe this causes the user to be unable to actually navigate into product details page. I'm not sure why - I just noticed that clicking the 'product details' widget just takes you nowhere now.", "author": "benradey", "createdAt": "2020-08-10T19:07:47Z", "path": "pantheon-bundle/frontend/src/app/productDetails.tsx", "diffHunk": "@@ -28,17 +28,17 @@ class ProductDetails extends Component<IProps, IState> {\n         }\n     }\n \n-    public componentWillReceiveProps(nextProps) {\n+    public componentDidUpdate() {\n         // allow page load from productDetails to products listing\n-        if (nextProps.productName !== undefined && nextProps.productName.trim() !== '') {\n+        if (this.props.productName !== undefined && this.props.productName.trim() !== '') {", "originalCommit": "b2e686dfa25a3ee42126782e0c3b18841ceae66e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEyMTIzNw==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r468121237", "bodyText": "BLARG.\ncomponentWillReceiveProps  is deprecated, I think it might have caused one of the test failures, but maybe I was mistaken. I'll try and revert it and rerun the tests.\nSee: https://github.com/redhataccess/pantheon/pull/354/files/b2e686dfa25a3ee42126782e0c3b18841ceae66e#diff-275ba574586207026ee0741897867bdbR117\nIt's definitely something we'll have to address at some point.", "author": "wesruv", "createdAt": "2020-08-10T19:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODExNzc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEyNDIyOQ==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r468124229", "bodyText": "Looks like it wasn't breaking the tests, but it does throw an error.", "author": "wesruv", "createdAt": "2020-08-10T19:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODExNzc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEzMjMzOA==", "url": "https://github.com/redhataccess/pantheon/pull/354#discussion_r468132338", "bodyText": "Yeah, it's been awhile, but I vaguely recall being the person who wrote that and needing to specifically hunt down just the right method to make the logic work. Sucks that it's going away, I guess we'll cross that bridge when we come to it.", "author": "benradey", "createdAt": "2020-08-10T19:28:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODExNzc0Mg=="}], "type": "inlineReview"}, {"oid": "2963f08074a16e39a2e32eb17d3d2096ba0b61b2", "url": "https://github.com/redhataccess/pantheon/commit/2963f08074a16e39a2e32eb17d3d2096ba0b61b2", "message": "CCS-3717: Reverting update to ProductDetails since it broke the feature", "committedDate": "2020-08-10T19:19:39Z", "type": "commit"}]}