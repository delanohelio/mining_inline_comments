{"pr_number": 235, "pr_title": "Ccs 3384 backend fixes2", "pr_createdAt": "2020-02-19T20:14:58Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/235", "timeline": [{"oid": "024ae8a5f68b721b0404234c6617e1518d5f3817", "url": "https://github.com/redhataccess/pantheon/commit/024ae8a5f68b721b0404234c6617e1518d5f3817", "message": "fix attribute names", "committedDate": "2020-02-14T18:55:47Z", "type": "commit"}, {"oid": "83a8e08da080130c739587bfc39ddce2485d8491", "url": "https://github.com/redhataccess/pantheon/commit/83a8e08da080130c739587bfc39ddce2485d8491", "message": "populate product/version/update/publish info from metadata", "committedDate": "2020-02-18T21:06:31Z", "type": "commit"}, {"oid": "c057abfb4124d7e2bc9362b7bc7269f34f60f1f1", "url": "https://github.com/redhataccess/pantheon/commit/c057abfb4124d7e2bc9362b7bc7269f34f60f1f1", "message": "inject metadata to the new variable", "committedDate": "2020-02-19T18:24:16Z", "type": "commit"}, {"oid": "ff2a8feefafa124762ba223b93dfcdcb12690ae3", "url": "https://github.com/redhataccess/pantheon/commit/ff2a8feefafa124762ba223b93dfcdcb12690ae3", "message": "remove debugging messages", "committedDate": "2020-02-19T19:24:30Z", "type": "commit"}, {"oid": "a77552a500b3ec7663a7fd2d0072f32ee2ecddea", "url": "https://github.com/redhataccess/pantheon/commit/a77552a500b3ec7663a7fd2d0072f32ee2ecddea", "message": "resolve merge confilcts", "committedDate": "2020-02-19T19:26:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUzNDE2Mw==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r381534163", "bodyText": "massive import order change \ud83d\ude1e\nWe should align all of our editors... somehow, as these changes obfuscate things", "author": "carlosmunoz", "createdAt": "2020-02-19T20:46:07Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/asciidoctor/AsciidoctorService.java", "diffHunk": "@@ -27,10 +25,21 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import javax.annotation.Nonnull;\n-import java.util.Map;\n-\n-import static java.util.stream.Collectors.toMap;\n+import com.google.common.base.Charsets;\n+import com.google.common.hash.HashCode;\n+import com.google.common.hash.Hashing;\n+import com.ibm.icu.text.DateFormat;\n+import com.redhat.pantheon.asciidoctor.extension.HtmlModulePostprocessor;\n+import com.redhat.pantheon.asciidoctor.extension.MetadataExtractorTreeProcessor;\n+import com.redhat.pantheon.asciidoctor.extension.SlingResourceIncludeProcessor;\n+import com.redhat.pantheon.conf.GlobalConfig;\n+import com.redhat.pantheon.extension.HydraIntegration;\n+import com.redhat.pantheon.model.ProductVersion;\n+import com.redhat.pantheon.model.module.Content;\n+import com.redhat.pantheon.model.module.Metadata;\n+import com.redhat.pantheon.model.module.Module;\n+import com.redhat.pantheon.model.module.ModuleVersion;\n+import com.redhat.pantheon.sling.ServiceResourceResolverProvider;", "originalCommit": "a77552a500b3ec7663a7fd2d0072f32ee2ecddea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU2MTc4Ng==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r381561786", "bodyText": "yes! I need start using IntelliJ.", "author": "xdavidson", "createdAt": "2020-02-19T21:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUzNDE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUzNTUzMA==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r381535530", "bodyText": "you should use the new method here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            productName = productVersion.getProduct().getValueMap().get(\"name\").toString();\n          \n          \n            \n                            productName = productVersion.getProduct().name().get();", "author": "carlosmunoz", "createdAt": "2020-02-19T20:48:58Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/asciidoctor/AsciidoctorService.java", "diffHunk": "@@ -142,25 +151,55 @@ private String buildModule(Module base, ModuleVersion moduleVersion, Map<String,\n         try (ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver()) {\n             moduleVersion = serviceResourceResolver.getResource(moduleVersion.getPath()).adaptTo(ModuleVersion.class);\n \n+            // process product and version.\n+            ProductVersion productVersion = null;\n+            productVersion = moduleVersion.metadata().map(Metadata::productVersion)\n+                    .map(t -> {\n+                        try {\n+                            return t.getReference();\n+                        } catch (RepositoryException e) {\n+                            return null;\n+                        }\n+                    })\n+                    .get();\n+            String productName = null;\n+            if (productVersion != null) {\n+                productName = productVersion.getProduct().getValueMap().get(\"name\").toString();", "originalCommit": "a77552a500b3ec7663a7fd2d0072f32ee2ecddea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5OTk5OA==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r382099998", "bodyText": "done", "author": "xdavidson", "createdAt": "2020-02-20T16:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUzNTUzMA=="}], "type": "inlineReview"}, {"oid": "f712ffeee39abe99fc2e5caaf374d34aae31d09d", "url": "https://github.com/redhataccess/pantheon/commit/f712ffeee39abe99fc2e5caaf374d34aae31d09d", "message": "fix exceptions when productVersion is not set or module is not published", "committedDate": "2020-02-19T23:32:44Z", "type": "commit"}, {"oid": "45bf00bb62625fec5d151f6ef70cd2c898b3c138", "url": "https://github.com/redhataccess/pantheon/commit/45bf00bb62625fec5d151f6ef70cd2c898b3c138", "message": "fix test failure", "committedDate": "2020-02-20T01:22:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY4MTk4OA==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r381681988", "bodyText": "I think this can be simplified. The map calls are supposed to provide null-safety, but from your changes I suspect they aren\u2019t at the end. The last get() call will throw a NoSuchElementException if the updated date is not present, so I suggest the following:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (moduleVersion.metadata().get().getValueMap().containsKey(\"dateUploaded\")) {\n          \n          \n            \n                        Optional<Calendar> updatedDate = moduleVersion.metadata()\n          \n          \n            \n                                .map(Metadata::dataUploaded)\n          \n          \n            \n                                .map(Supplier::get);\n          \n      \n    \n    \n  \n\nAnd then in line 179 you should be able to do:\n            if(updatedDate.isPresent()) {\n                arts.attribute(\u201cpantheonupdateddate\u201d,  dateFormat.format(updatedDate.get().getTime()));\n            }", "author": "carlosmunoz", "createdAt": "2020-02-20T02:31:37Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/asciidoctor/AsciidoctorService.java", "diffHunk": "@@ -153,30 +151,38 @@ private String buildModule(Module base, ModuleVersion moduleVersion, Map<String,\n \n             // process product and version.\n             ProductVersion productVersion = null;\n-            productVersion = moduleVersion.metadata().map(Metadata::productVersion)\n-                    .map(t -> {\n-                        try {\n-                            return t.getReference();\n-                        } catch (RepositoryException e) {\n-                            return null;\n-                        }\n-                    })\n-                    .get();\n+            if (moduleVersion.metadata().get().getValueMap().containsKey(\"productVersion\")) {\n+                productVersion = moduleVersion.metadata().map(Metadata::productVersion)\n+                        .map(t -> {\n+                            try {\n+                                return t.getReference();\n+                            } catch (RepositoryException e) {\n+                                return null;\n+                            }\n+                        })\n+                        .get();\n+            }\n+\n             String productName = null;\n             if (productVersion != null) {\n-                productName = productVersion.getProduct().getValueMap().get(\"name\").toString();\n+                productName = productVersion.getProduct().name().get();\n+            }\n+            Calendar updatedDate = null;\n+            if (moduleVersion.metadata().get().getValueMap().containsKey(\"dateUploaded\")) {", "originalCommit": "45bf00bb62625fec5d151f6ef70cd2c898b3c138", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE3Mzg2MQ==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r382173861", "bodyText": "updated!", "author": "xdavidson", "createdAt": "2020-02-20T18:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY4MTk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE2ODMyMw==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r382168323", "bodyText": "\ud83d\udc4d I guess this was never changed, but I wonder why it's presenting problems only now \ud83e\udd14", "author": "carlosmunoz", "createdAt": "2020-02-20T18:07:38Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/asciidoctor/AsciidoctorServiceTest.java", "diffHunk": "@@ -75,16 +76,16 @@ public void testGetModuleHtmlWhenCached() throws Exception {\n \n         // Given\n         slingContext.build()\n-                .resource(\"/module/locales/en_US/released/metadata\")\n-                .resource(\"/module/locales/en_US/released/content/asciidoc/jcr:content\",\n+                .resource(\"/module/en_US/released/metadata\")\n+                .resource(\"/module/en_US/released/content/asciidoc/jcr:content\",", "originalCommit": "45bf00bb62625fec5d151f6ef70cd2c898b3c138", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE2OTc4Nw==", "url": "https://github.com/redhataccess/pantheon/pull/235#discussion_r382169787", "bodyText": "Line 60 failed on NoSuchElementException. Line 79-84 didn't fail. I changed it so that they are consistent.", "author": "xdavidson", "createdAt": "2020-02-20T18:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE2ODMyMw=="}], "type": "inlineReview"}, {"oid": "7be85216c8c132cce459953b01b754d1448d9f86", "url": "https://github.com/redhataccess/pantheon/commit/7be85216c8c132cce459953b01b754d1448d9f86", "message": "code review fixes", "committedDate": "2020-02-20T18:17:51Z", "type": "commit"}]}