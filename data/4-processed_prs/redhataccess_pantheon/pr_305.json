{"pr_number": 305, "pr_title": "CCS-3634: Update the container creation files to use the karaf based distribution", "pr_createdAt": "2020-06-02T11:52:39Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/305", "timeline": [{"oid": "55e803e76185ecd724f16735ddf61dfd34830666", "url": "https://github.com/redhataccess/pantheon/commit/55e803e76185ecd724f16735ddf61dfd34830666", "message": "CCS-3634: Update the container creation files to use the karaf based distribution", "committedDate": "2020-06-02T11:47:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3Njk4Nw==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r433876987", "bodyText": "Is it a docker image ?", "author": "rednitish", "createdAt": "2020-06-02T13:32:21Z", "path": "README.md", "diffHunk": "@@ -48,6 +48,51 @@ For sling's management UI, you can head to http://localhost:8181/starter/index.h\n - To list all bundles and view their status: bundle:list\n - Find out why a bundle is in waiting state: diag _[bundle-id]_\n \n+### Run the application using Podman\n+First, install [podman](https://podman.io).\n+\n+Then, create a pod:\n+\n+```sh\n+podman pod create --name pantheon-karaf -p 8181 -p 5005\n+```\n+\n+This will create a `pantheon-karaf` pod with ports 8181 (for web access) and 5005 (for\n+remote Java debugging) open.\n+\n+Run a mongo database container in the pod.\n+\n+```sh\n+podman run --pod pantheon-karaf --name slingmongo -d mongo\n+```\n+\n+Build the pantheon docker image", "originalCommit": "55e803e76185ecd724f16735ddf61dfd34830666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwOTk5Mw==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r434009993", "bodyText": "Yes.", "author": "aprajshekhar", "createdAt": "2020-06-02T16:24:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3Njk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3OTkwNA==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r433879904", "bodyText": "Correct me if, i am wrong, should it be  \" run the sling container in the pod.\"?", "author": "rednitish", "createdAt": "2020-06-02T13:36:30Z", "path": "README.md", "diffHunk": "@@ -48,6 +48,51 @@ For sling's management UI, you can head to http://localhost:8181/starter/index.h\n - To list all bundles and view their status: bundle:list\n - Find out why a bundle is in waiting state: diag _[bundle-id]_\n \n+### Run the application using Podman\n+First, install [podman](https://podman.io).\n+\n+Then, create a pod:\n+\n+```sh\n+podman pod create --name pantheon-karaf -p 8181 -p 5005\n+```\n+\n+This will create a `pantheon-karaf` pod with ports 8181 (for web access) and 5005 (for\n+remote Java debugging) open.\n+\n+Run a mongo database container in the pod.\n+\n+```sh\n+podman run --pod pantheon-karaf --name slingmongo -d mongo\n+```\n+\n+Build the pantheon docker image\n+\n+```sh\n+buildah bud --layers -f container/Dockerfile -t pantheon-karaf-app .\n+```\n+\n+Run the sling container pod in the pod.", "originalCommit": "55e803e76185ecd724f16735ddf61dfd34830666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMDQ4Mw==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r434010483", "bodyText": "You are correct. However, this mistake exists in the current README as well :). I will update this.", "author": "aprajshekhar", "createdAt": "2020-06-02T16:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg3OTkwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4MTU4Mw==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r433881583", "bodyText": "I am  not sure, if it's an issue at my end, but this step is throwing error message on my local.\nError: Transaction failed\nerror building at STEP \"RUN yum -y install java-1.8.0-openjdk\": error while running runtime: exit status 1\nERRO exit status 1", "author": "rednitish", "createdAt": "2020-06-02T13:38:40Z", "path": "README.md", "diffHunk": "@@ -48,6 +48,51 @@ For sling's management UI, you can head to http://localhost:8181/starter/index.h\n - To list all bundles and view their status: bundle:list\n - Find out why a bundle is in waiting state: diag _[bundle-id]_\n \n+### Run the application using Podman\n+First, install [podman](https://podman.io).\n+\n+Then, create a pod:\n+\n+```sh\n+podman pod create --name pantheon-karaf -p 8181 -p 5005\n+```\n+\n+This will create a `pantheon-karaf` pod with ports 8181 (for web access) and 5005 (for\n+remote Java debugging) open.\n+\n+Run a mongo database container in the pod.\n+\n+```sh\n+podman run --pod pantheon-karaf --name slingmongo -d mongo\n+```\n+\n+Build the pantheon docker image\n+\n+```sh\n+buildah bud --layers -f container/Dockerfile -t pantheon-karaf-app .", "originalCommit": "55e803e76185ecd724f16735ddf61dfd34830666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMTA0NA==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r434011044", "bodyText": "It works fine at my end. I used to receive that error if the network was wonky.", "author": "aprajshekhar", "createdAt": "2020-06-02T16:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4MTU4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4NTQ0Nw==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r433885447", "bodyText": "Why are we exposing  ports : 1099 and 44444 ?", "author": "rednitish", "createdAt": "2020-06-02T13:43:49Z", "path": "container/Dockerfile", "diffHunk": "@@ -1,15 +1,21 @@\n FROM registry.access.redhat.com/ubi8/ubi\n RUN yum -y install java-1.8.0-openjdk\n \n-RUN mkdir -p /opt/sling\n+ENV MONGO_DB=\"sling\"\n+ENV REPOSITORY=\"sling/repository\"\n \n-COPY ../pantheon-slingstart/target/pantheon-slingstart-*.jar /opt/sling/pantheon.jar\n+RUN mkdir -p /opt/pantheon-karaf-dist\n+RUN mkdir /tmp/archive\n+WORKDIR /tmp/archive\n \n-WORKDIR /opt/sling/\n-EXPOSE 8080\n-EXPOSE 5005\n+COPY ../pantheon-karaf-dist/target/pantheon-karaf-dist-*.tar.gz /tmp/archive/pantheon-karaf-dist.tar.gz\n \n-ENV JAVA_OPTS -Xmx1024m -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005\n-ENV SLING_OPS ''\n+RUN tar --strip-components=1 -C /opt/pantheon-karaf-dist -xzf pantheon-karaf-dist.tar.gz; \\\n+    rm -rf /tmp/*\n \n-CMD export COMMIT_HASH=$(cat /opt/sling/commit_hash); java $JAVA_OPTS -jar pantheon.jar $SLING_OPTS\n+RUN chmod 755 /opt; \n+    #sed -i \"21s/out/stdout/\" /opt/pantheon-karaf-dist/etc/org.ops4j.pax.logging.cfg;\n+\n+EXPOSE 1099 8181 44444", "originalCommit": "55e803e76185ecd724f16735ddf61dfd34830666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMTU4NQ==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r434011585", "bodyText": "They are JMX ports. I will check if there is a different single port of debug and jmx.", "author": "aprajshekhar", "createdAt": "2020-06-02T16:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4NTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4Njk2OQ==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r433886969", "bodyText": "Is it required ?\nwon't it get automatically created ?", "author": "rednitish", "createdAt": "2020-06-02T13:45:49Z", "path": "container/pantheon-karaf.yml", "diffHunk": "@@ -0,0 +1,91 @@\n+# Generation of Kubernetes YAML is still under development!\n+#\n+# Save the output of this file and use kubectl create -f to import\n+# it into Kubernetes.\n+#\n+# Created with podman-1.9.2\n+apiVersion: v1\n+kind: Pod\n+metadata:\n+  creationTimestamp: \"2020-06-02T11:45:11Z\"", "originalCommit": "55e803e76185ecd724f16735ddf61dfd34830666", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4ODU1OA==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r433888558", "bodyText": "Can we parameterize tags, so that we can deploy stable and latest images as well ?", "author": "rednitish", "createdAt": "2020-06-02T13:48:04Z", "path": "container/pantheon-karaf.yml", "diffHunk": "@@ -0,0 +1,91 @@\n+# Generation of Kubernetes YAML is still under development!\n+#\n+# Save the output of this file and use kubectl create -f to import\n+# it into Kubernetes.\n+#\n+# Created with podman-1.9.2\n+apiVersion: v1\n+kind: Pod\n+metadata:\n+  creationTimestamp: \"2020-06-02T11:45:11Z\"\n+  labels:\n+    app: pantheon-karaf\n+  name: pantheon-karaf\n+spec:\n+  containers:\n+  - command:\n+    - /opt/pantheon-karaf-dist/bin/karaf\n+    - run\n+    env:\n+    - name: PATH\n+      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n+    - name: TERM\n+      value: xterm\n+    - name: HOSTNAME\n+      value: pantheon-karaf\n+    - name: MONGO_DB\n+      value: sling\n+    - name: REPOSITORY\n+      value: sling/repository\n+    - name: MONGO_DB_REPLICA\n+      value: mongodb://localhost:27017\n+    - name: container\n+      value: oci\n+    image: localhost/pantheon-karaf-app:latest", "originalCommit": "55e803e76185ecd724f16735ddf61dfd34830666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMzMwMQ==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r434013301", "bodyText": "This file was generated using podman generate. I am not sure is this required. I have asked Lisa about it. I will remove this and regenerate if required. This is useful only if you are using kubectl, AFAIK.", "author": "aprajshekhar", "createdAt": "2020-06-02T16:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4ODU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5MDQ4NQ==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r433890485", "bodyText": "mongoDB as container, is it for testing purpose only ?", "author": "rednitish", "createdAt": "2020-06-02T13:50:41Z", "path": "container/pantheon-karaf.yml", "diffHunk": "@@ -0,0 +1,91 @@\n+# Generation of Kubernetes YAML is still under development!\n+#\n+# Save the output of this file and use kubectl create -f to import\n+# it into Kubernetes.\n+#\n+# Created with podman-1.9.2\n+apiVersion: v1\n+kind: Pod\n+metadata:\n+  creationTimestamp: \"2020-06-02T11:45:11Z\"\n+  labels:\n+    app: pantheon-karaf\n+  name: pantheon-karaf\n+spec:\n+  containers:\n+  - command:\n+    - /opt/pantheon-karaf-dist/bin/karaf\n+    - run\n+    env:\n+    - name: PATH\n+      value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n+    - name: TERM\n+      value: xterm\n+    - name: HOSTNAME\n+      value: pantheon-karaf\n+    - name: MONGO_DB\n+      value: sling\n+    - name: REPOSITORY\n+      value: sling/repository\n+    - name: MONGO_DB_REPLICA\n+      value: mongodb://localhost:27017\n+    - name: container\n+      value: oci\n+    image: localhost/pantheon-karaf-app:latest\n+    name: pantheon-karaf-app\n+    ports:\n+    - containerPort: 8181\n+      hostPort: 8181\n+      protocol: TCP\n+    - containerPort: 55555\n+      hostPort: 55555\n+      protocol: TCP\n+    - containerPort: 1099\n+      hostPort: 1099\n+      protocol: TCP\n+    resources: {}\n+    securityContext:\n+      allowPrivilegeEscalation: true\n+      capabilities: {}\n+      privileged: false\n+      readOnlyRootFilesystem: false\n+      seLinuxOptions: {}\n+    tty: true\n+    workingDir: /tmp/archive\n+  - command:", "originalCommit": "55e803e76185ecd724f16735ddf61dfd34830666", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMzc0Mg==", "url": "https://github.com/redhataccess/pantheon/pull/305#discussion_r434013742", "bodyText": "This file was generated using podman generate. I am not sure is this required. I have asked Lisa about it. I will remove this and regenerate if required. This is useful only if you are using kubectl, AFAIK. And this seems only for local.", "author": "aprajshekhar", "createdAt": "2020-06-02T16:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5MDQ4NQ=="}], "type": "inlineReview"}, {"oid": "08a95d79b76ef187075585688dbca33e023fc21a", "url": "https://github.com/redhataccess/pantheon/commit/08a95d79b76ef187075585688dbca33e023fc21a", "message": "CCS-3634: Update the container creation files to use the karaf based distribution. Code review changes", "committedDate": "2020-06-03T05:30:20Z", "type": "commit"}]}