{"pr_number": 6067, "pr_title": "Feature: fast pickup of specific items after crafting", "pr_createdAt": "2020-11-12T03:36:36Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/6067", "timeline": [{"oid": "f49528fee49f69e0544e6b5c3223e4f42ad9d760", "url": "https://github.com/ldtteam/minecolonies/commit/f49528fee49f69e0544e6b5c3223e4f42ad9d760", "message": "Add tracking support for fast pickup requests", "committedDate": "2020-11-12T03:30:02Z", "type": "commit"}, {"oid": "e2978ee13e76428c65e45ca0ea0cdbf65394ea95", "url": "https://github.com/ldtteam/minecolonies/commit/e2978ee13e76428c65e45ca0ea0cdbf65394ea95", "message": "make pickup requests able to track items", "committedDate": "2020-11-12T03:30:58Z", "type": "commit"}, {"oid": "0820c08e120e012cb8e7a2aa3b9543afc123aa0f", "url": "https://github.com/ldtteam/minecolonies/commit/0820c08e120e012cb8e7a2aa3b9543afc123aa0f", "message": "Deliveryman handles targetted/fast pickups", "committedDate": "2020-11-12T03:31:32Z", "type": "commit"}, {"oid": "ba215f3873ea2980dea6dca456adcfdd1f3f5312", "url": "https://github.com/ldtteam/minecolonies/commit/ba215f3873ea2980dea6dca456adcfdd1f3f5312", "message": "Make sure secondary outputs is always right", "committedDate": "2020-11-12T03:32:05Z", "type": "commit"}, {"oid": "1fbcc9e27cb514520b4a17e770fb8e1332c69519", "url": "https://github.com/ldtteam/minecolonies/commit/1fbcc9e27cb514520b4a17e770fb8e1332c69519", "message": "Set up baker to do fast pickup", "committedDate": "2020-11-12T03:32:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkyMDY2Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r521920663", "bodyText": "jdoc", "author": "Raycoms", "createdAt": "2020-11-12T08:25:30Z", "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAIBasic.java", "diffHunk": "@@ -1050,10 +1057,23 @@ else if (dumpOneMoreSlot())\n             // Note that this will not create a pickup request when another request is already in progress.\n             building.createPickupRequest(scaledPriority(building.getPickUpPriority()));\n             hasDumpedItems = false;\n+            fastPickup.clear();\n+        } \n+        else if (!fastPickup.isEmpty())\n+        {\n+            building.createPickupRequest(scaledPriority(building.getPickUpPriority()), fastPickup);\n+            fastPickup.clear();\n         }\n+\n+\n         return afterDump();\n     }\n \n+    public boolean addItemForFastPickup(ItemStack item)", "originalCommit": "1fbcc9e27cb514520b4a17e770fb8e1332c69519", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "110558bda775fb66dffa5436e2a70abd8828e8de", "url": "https://github.com/ldtteam/minecolonies/commit/110558bda775fb66dffa5436e2a70abd8828e8de", "message": "Merge branch 'version/1.15' into feature/fastpickup", "committedDate": "2020-11-16T03:20:45Z", "type": "commit"}, {"oid": "582570b7b86dce6fbb6dee8e98de85c0c9506134", "url": "https://github.com/ldtteam/minecolonies/commit/582570b7b86dce6fbb6dee8e98de85c0c9506134", "message": "Merge branch 'version/1.15' into feature/fastpickup", "committedDate": "2020-11-19T16:11:21Z", "type": "commit"}, {"oid": "55f60a43ec11ad6d7fda44135474f2a1d0709766", "url": "https://github.com/ldtteam/minecolonies/commit/55f60a43ec11ad6d7fda44135474f2a1d0709766", "message": "Merge branch 'version/1.15' into feature/fastpickup", "committedDate": "2020-11-28T16:39:52Z", "type": "commit"}, {"oid": "273545c93e3a03d4e755a2531cd257b9c4326b00", "url": "https://github.com/ldtteam/minecolonies/commit/273545c93e3a03d4e755a2531cd257b9c4326b00", "message": "Merge branch 'version/1.15' into feature/fastpickup", "committedDate": "2020-11-29T21:29:12Z", "type": "commit"}, {"oid": "2e97fb14d2766d05a034d55799fbaf66086824f6", "url": "https://github.com/ldtteam/minecolonies/commit/2e97fb14d2766d05a034d55799fbaf66086824f6", "message": "Revert \"Set up baker to do fast pickup\"\n\nThis reverts commit 1fbcc9e27cb514520b4a17e770fb8e1332c69519.", "committedDate": "2020-11-29T21:29:32Z", "type": "commit"}, {"oid": "36c0f318d33c315319a371b9d15636374be0d324", "url": "https://github.com/ldtteam/minecolonies/commit/36c0f318d33c315319a371b9d15636374be0d324", "message": "More reliabile getJobDisplayName", "committedDate": "2020-11-29T21:31:53Z", "type": "commit"}, {"oid": "4a3b282416a1ec6cce875d8c81f5a7e3490c1fc2", "url": "https://github.com/ldtteam/minecolonies/commit/4a3b282416a1ec6cce875d8c81f5a7e3490c1fc2", "message": "Revert \"Deliveryman handles targetted/fast pickups\"\n\nThis reverts commit 0820c08e120e012cb8e7a2aa3b9543afc123aa0f.", "committedDate": "2020-11-29T21:33:52Z", "type": "commit"}, {"oid": "06aebca37aa134904565cbef9f11604bc350b490", "url": "https://github.com/ldtteam/minecolonies/commit/06aebca37aa134904565cbef9f11604bc350b490", "message": "Revert \"make pickup requests able to track items\"\n\nThis reverts commit e2978ee13e76428c65e45ca0ea0cdbf65394ea95.", "committedDate": "2020-11-29T21:35:13Z", "type": "commit"}, {"oid": "7d36a48237cb02da3b516da4c4212f05823a7562", "url": "https://github.com/ldtteam/minecolonies/commit/7d36a48237cb02da3b516da4c4212f05823a7562", "message": "Revert \"Add tracking support for fast pickup requests\"\n\nThis reverts commit f49528fee49f69e0544e6b5c3223e4f42ad9d760.", "committedDate": "2020-11-29T21:41:33Z", "type": "commit"}, {"oid": "74b8bb5942edc4c113ff2c18e68c2d6f6965adf7", "url": "https://github.com/ldtteam/minecolonies/commit/74b8bb5942edc4c113ff2c18e68c2d6f6965adf7", "message": "Minor formatting cleanup", "committedDate": "2020-11-29T21:46:01Z", "type": "commit"}, {"oid": "8792a4e150452102e100dde469aa95ecb6238221", "url": "https://github.com/ldtteam/minecolonies/commit/8792a4e150452102e100dde469aa95ecb6238221", "message": "Add Minstock check during pickup.", "committedDate": "2020-11-29T22:56:56Z", "type": "commit"}, {"oid": "c66605284a62afd4019e6f2a9d08283f8e859e67", "url": "https://github.com/ldtteam/minecolonies/commit/c66605284a62afd4019e6f2a9d08283f8e859e67", "message": "Check Deliveries during Pickup", "committedDate": "2020-11-29T22:57:23Z", "type": "commit"}, {"oid": "e507f03aa9fab33e3a7cc9f9e9b4bae0a5392ea9", "url": "https://github.com/ldtteam/minecolonies/commit/e507f03aa9fab33e3a7cc9f9e9b4bae0a5392ea9", "message": "Make Baker always pickup", "committedDate": "2020-11-29T22:57:36Z", "type": "commit"}, {"oid": "b22d3974bba7ebe77cbc74fc43fdf535c28c844b", "url": "https://github.com/ldtteam/minecolonies/commit/b22d3974bba7ebe77cbc74fc43fdf535c28c844b", "message": "Move to AbstractBuilding", "committedDate": "2020-11-30T00:53:30Z", "type": "commit"}, {"oid": "28fee162b1cf2365d4c1eec8960c54cbb9e6f5fd", "url": "https://github.com/ldtteam/minecolonies/commit/28fee162b1cf2365d4c1eec8960c54cbb9e6f5fd", "message": "Call super.getRequiredItemsAndAmount", "committedDate": "2020-11-30T00:54:35Z", "type": "commit"}, {"oid": "7650b8fc8ae3fa78e65c08056e738b5dd9624df8", "url": "https://github.com/ldtteam/minecolonies/commit/7650b8fc8ae3fa78e65c08056e738b5dd9624df8", "message": "Fix bad call", "committedDate": "2020-11-30T01:18:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532602708", "bodyText": "Might this here cause issues? @someaddons", "author": "Raycoms", "createdAt": "2020-11-30T13:39:22Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingWorker.java", "diffHunk": "@@ -911,6 +912,13 @@ else if((forceReplace || newRecipe.getMustExist()) && duplicateFound != recipeTo\n      */\n     public String getJobDisplayName()\n     {\n+        if(jobDisplayName.isEmpty())\n+        {\n+            //This will only happen if getJobDisplayName is called before the first citizen is assigned. \n+            ICitizenData citizen = colony.getCitizenManager().createAndRegisterCivilianData();\n+            jobDisplayName = this.createJob(citizen).getName();\n+            colony.getCitizenManager().removeCivilian(citizen);", "originalCommit": "7650b8fc8ae3fa78e65c08056e738b5dd9624df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNzAyNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532607025", "bodyText": "hm not sure tbh, though this is a pretty weird solution to just get a name, seems like a hacky solution with a high overhead. Should be able to solve this much more smoothly", "author": "someaddons", "createdAt": "2020-11-30T13:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyMDEwMg==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532620102", "bodyText": "I just checked and it seems to be not used at all? so could just remove it", "author": "someaddons", "createdAt": "2020-11-30T14:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwMjA5Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532702096", "bodyText": "This is used, in both PublicWorkerCraftingProductionResolver and PublicWorkerCraftingRequestResolver. In both of those cases, it shouldn't go through this codepath. The codepath that might hit his is the one in WindowTownHall.java, and then only once.\nThis is the result of building.getJobName returning a non-localization key, and being needed by the crafting code. This is the only contact the building has today with the actual job, and to get the jobName localization key.", "author": "Mekle001", "createdAt": "2020-11-30T15:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwNTE3Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532705177", "bodyText": "Couldn't we return a \"not loaded\" or so then?", "author": "Raycoms", "createdAt": "2020-11-30T15:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwNzUyMg==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532707522", "bodyText": "This is serversided and the stuff you're talking about is clientside", "author": "someaddons", "createdAt": "2020-11-30T16:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwNzcxMg==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532707712", "bodyText": "We could, but then that would show to the user, and they won't know how to fix it (assign a worker to the building). This is specifically the list of job names in the town hall. Right now, the town hall will show 0/1 for a blank job name if the building has never been assigned a worker before this change.", "author": "Mekle001", "createdAt": "2020-11-30T16:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwOTQ0Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532709442", "bodyText": "This code is serverside, and is serialized to the window for display clientside.", "author": "Mekle001", "createdAt": "2020-11-30T16:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxMTc1Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532711753", "bodyText": "where is this used in serialization? Unless intelliJ is lying to me its a function that never gets called", "author": "someaddons", "createdAt": "2020-11-30T16:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyOTE2Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532729166", "bodyText": "Great point, I just looked at the serialization again, and it's referencing the field. It should be calling this function. Fixing.", "author": "Mekle001", "createdAt": "2020-11-30T16:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMjcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzgyNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532603825", "bodyText": "seems badly alinged", "author": "Raycoms", "createdAt": "2020-11-30T13:41:05Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingSmelterCrafter.java", "diffHunk": "@@ -94,26 +94,31 @@ public int getMaxBuildingLevel()\n                     final IRequest<? extends PublicCrafting> request = (IRequest<? extends PublicCrafting>) colony.getRequestManager().getRequestForToken(taskToken);\n                     if (request != null)\n                     {\n-                        final IRecipeStorage recipeStorage = getFirstFullFillableRecipe(request.getRequest().getStack(), false);\n+                        final IRecipeStorage recipeStorage = getFirstRecipe(request.getRequest().getStack());\n                         if (recipeStorage != null)\n                         {\n                             for (final ItemStorage itemStorage : recipeStorage.getCleanedInput())\n                             {\n                                 int amount = itemStorage.getAmount() * request.getRequest().getCount();\n-                                if (recipeOutputs.containsKey(itemStorage))\n+                                if (requiredItems.containsKey(itemStorage))\n                                 {\n-                                    amount += recipeOutputs.get(itemStorage).getA();\n+                                    amount += requiredItems.get(itemStorage).getA();\n                                 }\n-                                recipeOutputs.put(itemStorage, new Tuple<>(amount, false));\n+                                requiredItems.put(itemStorage, new Tuple<>(amount, false));\n                             }\n                         }\n-                    }\n+                        final ItemStorage output = new ItemStorage(recipeStorage.getPrimaryOutput());", "originalCommit": "7650b8fc8ae3fa78e65c08056e738b5dd9624df8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwMzk1NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r532703955", "bodyText": "The problem is actually line 115. Fixing.", "author": "Mekle001", "createdAt": "2020-11-30T15:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzgyNQ=="}], "type": "inlineReview"}, {"oid": "44238fdaeea060cf80e69ee420c9b4278c4a70f4", "url": "https://github.com/ldtteam/minecolonies/commit/44238fdaeea060cf80e69ee420c9b4278c4a70f4", "message": "Fix misplaced \"}\"", "committedDate": "2020-11-30T15:58:23Z", "type": "commit"}, {"oid": "26e8ae16ad99d4c6d53bf2414615fc0ec27e2bc0", "url": "https://github.com/ldtteam/minecolonies/commit/26e8ae16ad99d4c6d53bf2414615fc0ec27e2bc0", "message": "Fix serialization", "committedDate": "2020-11-30T16:30:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA0NDQ2Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r537044466", "bodyText": "Is this a good idea? I had the null check here on purpose.", "author": "Raycoms", "createdAt": "2020-12-06T13:58:16Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java", "diffHunk": "@@ -1474,8 +1503,7 @@ public boolean createPickupRequest(final int scaledPriority)\n         {\n             for (final IToken<?> req : reqs)\n             {\n-                final IRequest<?> request = colony.getRequestManager().getRequestForToken(req);\n-                if (request != null && request.getState() == RequestState.IN_PROGRESS)\n+                if (colony.getRequestManager().getRequestForToken(req).getState() == RequestState.IN_PROGRESS)", "originalCommit": "26e8ae16ad99d4c6d53bf2414615fc0ec27e2bc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA2Mjk1OQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r537062959", "bodyText": "I am pretty sure that null check is needed as well....\nIt threw exceptions previously but that was removed.", "author": "OrionDevelopment", "createdAt": "2020-12-06T15:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA0NDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA2NTE1NQ==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r537065155", "bodyText": "This is a bad merge/backout of the old code. Fixing.", "author": "Mekle001", "createdAt": "2020-12-06T15:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA0NDQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA0NDczMA==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r537044730", "bodyText": "I still don't like this since it's not side-effect free. I rather have it return empty for now, until we got a propper fix. (It's only a small UI error after all).", "author": "Raycoms", "createdAt": "2020-12-06T13:59:46Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingWorker.java", "diffHunk": "@@ -911,6 +912,13 @@ else if((forceReplace || newRecipe.getMustExist()) && duplicateFound != recipeTo\n      */\n     public String getJobDisplayName()\n     {\n+        if(jobDisplayName.isEmpty())\n+        {\n+            //This will only happen if getJobDisplayName is called before the first citizen is assigned. \n+            ICitizenData citizen = colony.getCitizenManager().createAndRegisterCivilianData();\n+            jobDisplayName = this.createJob(citizen).getName();\n+            colony.getCitizenManager().removeCivilian(citizen);", "originalCommit": "26e8ae16ad99d4c6d53bf2414615fc0ec27e2bc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA2NTE5Mw==", "url": "https://github.com/ldtteam/minecolonies/pull/6067#discussion_r537065193", "bodyText": "removing for now", "author": "Mekle001", "createdAt": "2020-12-06T15:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA0NDczMA=="}], "type": "inlineReview"}, {"oid": "afefa1ecd1104ca82037cf7764f496e08c463890", "url": "https://github.com/ldtteam/minecolonies/commit/afefa1ecd1104ca82037cf7764f496e08c463890", "message": "PR feedback", "committedDate": "2020-12-06T15:50:05Z", "type": "commit"}, {"oid": "d091d944ff4161503562fd8287ed8b294a84a74d", "url": "https://github.com/ldtteam/minecolonies/commit/d091d944ff4161503562fd8287ed8b294a84a74d", "message": "Merge branch 'version/1.15' into feature/fastpickup", "committedDate": "2020-12-06T15:50:18Z", "type": "commit"}, {"oid": "7940342335d8a47c6c4e1802cd6dcd616da1d654", "url": "https://github.com/ldtteam/minecolonies/commit/7940342335d8a47c6c4e1802cd6dcd616da1d654", "message": "Merge branch 'version/1.15' into feature/fastpickup", "committedDate": "2020-12-07T20:18:43Z", "type": "commit"}, {"oid": "2c05baa859aa6afd6567794c9dd673a79f5cbfd5", "url": "https://github.com/ldtteam/minecolonies/commit/2c05baa859aa6afd6567794c9dd673a79f5cbfd5", "message": "fix", "committedDate": "2020-12-07T20:43:32Z", "type": "commit"}]}