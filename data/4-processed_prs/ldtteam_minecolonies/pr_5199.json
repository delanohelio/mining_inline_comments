{"pr_number": 5199, "pr_title": "Improve spawner in raids, improve ticks", "pr_createdAt": "2020-06-11T11:33:06Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5199", "timeline": [{"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa", "url": "https://github.com/ldtteam/minecolonies/commit/62643a5b1cac239f0d08a76b48c4886f2f2a0afa", "message": "Improve spawner in raids, improve ticks\n\nTracks spawner position in raid event and regularly checks them\nAlso now uses the O(1) methods of racks better for the minimum stock ticks.", "committedDate": "2020-06-11T11:31:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMzc3Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r438723776", "bodyText": "is this int even still needed anymore? think you can remove it. Seems like it isnt getting data anymore aswell so logic on it might break", "author": "someaddons", "createdAt": "2020-06-11T11:42:16Z", "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/AbstractShipRaidEvent.java", "diffHunk": "@@ -117,6 +120,16 @@\n      */\n     private int shipRotation = 0;\n \n+    /**\n+     * List of all spawners.\n+     */\n+    private List<BlockPos> spawners = new ArrayList<>();\n+\n+    /**\n+     * Count of spawners.\n+     */\n+    private int spawnerCount;", "originalCommit": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyNDczMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r438724731", "bodyText": "Backwards compatibility. For ships that are still in some worlds.", "author": "Raycoms", "createdAt": "2020-06-11T11:44:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMzc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyNTc5OA==", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r438725798", "bodyText": "ah ok", "author": "someaddons", "createdAt": "2020-06-11T11:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMzc3Ng=="}], "type": "inlineReview"}, {"oid": "1b9bf4c2c36bcb0d1dae6937a7f1a0a3ee16f868", "url": "https://github.com/ldtteam/minecolonies/commit/1b9bf4c2c36bcb0d1dae6937a7f1a0a3ee16f868", "message": "init at 0", "committedDate": "2020-06-11T11:45:06Z", "type": "commit"}, {"oid": "dcc8f05259551c2bb11f504fe82e2fe04c47ff79", "url": "https://github.com/ldtteam/minecolonies/commit/dcc8f05259551c2bb11f504fe82e2fe04c47ff79", "message": "fix #5198", "committedDate": "2020-06-11T15:49:24Z", "type": "commit"}, {"oid": "0e6b8a60d079a0439e84244daf073e231fd44809", "url": "https://github.com/ldtteam/minecolonies/commit/0e6b8a60d079a0439e84244daf073e231fd44809", "message": "adjust for remaining cases", "committedDate": "2020-06-11T16:02:37Z", "type": "commit"}, {"oid": "f8d997f410b008d846c16dbcbdef331fec71f7c3", "url": "https://github.com/ldtteam/minecolonies/commit/f8d997f410b008d846c16dbcbdef331fec71f7c3", "message": "fix #5106", "committedDate": "2020-06-11T16:35:37Z", "type": "commit"}, {"oid": "ffd00f7cf8cfd2b0e20c7c7b62166721533a51f3", "url": "https://github.com/ldtteam/minecolonies/commit/ffd00f7cf8cfd2b0e20c7c7b62166721533a51f3", "message": "fix armor level ranges #5103", "committedDate": "2020-06-11T18:10:29Z", "type": "commit"}, {"oid": "bcc7454ffb7b8be7c4ec486a8701bee3d4d23a31", "url": "https://github.com/ldtteam/minecolonies/commit/bcc7454ffb7b8be7c4ec486a8701bee3d4d23a31", "message": "fix #5210", "committedDate": "2020-06-12T14:40:41Z", "type": "commit"}, {"oid": "fb859d7f22cf2af5e941df3bb0bf40335c26153a", "url": "https://github.com/ldtteam/minecolonies/commit/fb859d7f22cf2af5e941df3bb0bf40335c26153a", "message": "improve task switching", "committedDate": "2020-06-12T14:53:19Z", "type": "commit"}, {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7", "url": "https://github.com/ldtteam/minecolonies/commit/c7f45c2642f1e721cbce2d005057e3414de315e7", "message": "fix #5205", "committedDate": "2020-06-12T19:27:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDczMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440100731", "bodyText": "Pass in the delta here to do this properly. The Stack requestable can tract counts.", "author": "OrionDevelopment", "createdAt": "2020-06-15T11:10:01Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java", "diffHunk": "@@ -584,33 +585,43 @@ public void removeMinimumStock(final ItemStack itemStack)\n     public void onColonyTick(final IColony colony)\n     {\n         super.onColonyTick(colony);\n-        final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n \n-        for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n+        if (colony.getWorld().getChunkProvider().isChunkLoaded(new ChunkPos(getPosition().getX() >> 4, getPosition().getZ() >> 4)))\n         {\n-            final ItemStack itemStack = entry.getKey().getItemStack().copy();\n-            final int count = InventoryUtils.getItemCountInProvider(getTileEntity(), stack -> !stack.isEmpty() && stack.isItemEqual(itemStack));\n-            final int delta = entry.getValue() * itemStack.getMaxStackSize() - count;\n-            final IToken<?> request = getMatchingRequest(itemStack, list);\n-            if (delta > 0)\n+            final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n+\n+            for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n             {\n-                if (request == null)\n+                final ItemStack itemStack = entry.getKey().getItemStack().copy();\n+\n+                if (itemStack.isEmpty())\n                 {\n-                    itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n-                    final Stack stack = new Stack(itemStack);\n-                    if (getMainCitizen() != null)\n-                    {\n-                        getMainCitizen().createRequestAsync(stack);\n-                    }\n-                    else\n+                    continue;\n+                }\n+\n+                final int count = InventoryUtils.hasBuildingEnoughElseCount(this, new ItemStorage(itemStack), entry.getValue() * itemStack.getMaxStackSize());\n+                final int delta = (entry.getValue() * itemStack.getMaxStackSize()) - count;\n+                final IToken<?> request = getMatchingRequest(itemStack, list);\n+                if (delta > 0)\n+                {\n+                    if (request == null)\n                     {\n-                        createRequest(stack, false);\n+                        itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n+                        final Stack stack = new Stack(itemStack);", "originalCommit": "c7f45c2642f1e721cbce2d005057e3414de315e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExOTExMw==", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440119113", "bodyText": "I'm not doing this on purpose. I want to request 1 by 1", "author": "Raycoms", "createdAt": "2020-06-15T11:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMTA1Nw==", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440101057", "bodyText": "You will probably need to change that here then too if you adapt the AbstractBuilding to use the Delta in the request.", "author": "OrionDevelopment", "createdAt": "2020-06-15T11:10:42Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingCrafter.java", "diffHunk": "@@ -99,20 +99,21 @@ public boolean canBeGathered()\n                     {\n                         for (final ItemStorage itemStorage : recipeStorage.getCleanedInput())\n                         {\n-                            int amount = itemStorage.getAmount();\n+                            int amount = itemStorage.getAmount() * request.getRequest().getCount();", "originalCommit": "c7f45c2642f1e721cbce2d005057e3414de315e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f94f97294f2f904708965568e4c6130bb4a199e4", "url": "https://github.com/ldtteam/minecolonies/commit/f94f97294f2f904708965568e4c6130bb4a199e4", "message": "add null check", "committedDate": "2020-06-15T11:50:44Z", "type": "commit"}]}