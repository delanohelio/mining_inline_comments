{"pr_number": 4390, "pr_title": "exp fixes", "pr_createdAt": "2020-03-04T13:18:24Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/4390", "timeline": [{"oid": "bae8ef83cb9ace780309f25e4a788568dace5e9d", "url": "https://github.com/ldtteam/minecolonies/commit/bae8ef83cb9ace780309f25e4a788568dace5e9d", "message": "fixed loot tables\nadded tome to most mob drops", "committedDate": "2020-03-01T01:38:28Z", "type": "commit"}, {"oid": "8d8c79ac1526be294148c2f5450f5031277191a3", "url": "https://github.com/ldtteam/minecolonies/commit/8d8c79ac1526be294148c2f5450f5031277191a3", "message": "renamed loot files to match entity name", "committedDate": "2020-03-01T01:39:31Z", "type": "commit"}, {"oid": "42cb0162894440c2ce55224819f0df45d289fcc6", "url": "https://github.com/ldtteam/minecolonies/commit/42cb0162894440c2ce55224819f0df45d289fcc6", "message": "removed tome as rare loot", "committedDate": "2020-03-01T04:09:30Z", "type": "commit"}, {"oid": "aa11aae5566699946018d351c9e3f972fe1ea9bf", "url": "https://github.com/ldtteam/minecolonies/commit/aa11aae5566699946018d351c9e3f972fe1ea9bf", "message": "Merge branch 'version/1.15' into version/1.15", "committedDate": "2020-03-01T14:42:58Z", "type": "commit"}, {"oid": "219e3edf79312fa69d62ebe356cb7d0c8d41cd28", "url": "https://github.com/ldtteam/minecolonies/commit/219e3edf79312fa69d62ebe356cb7d0c8d41cd28", "message": "Merge https://github.com/ldtteam/minecolonies into version/1.15", "committedDate": "2020-03-03T21:55:00Z", "type": "commit"}, {"oid": "07ac798438e6319d1498a0b9fceac053f98eea8b", "url": "https://github.com/ldtteam/minecolonies/commit/07ac798438e6319d1498a0b9fceac053f98eea8b", "message": "Merge remote-tracking branch 'origin/version/1.15' into version/1.15", "committedDate": "2020-03-03T21:56:16Z", "type": "commit"}, {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea", "url": "https://github.com/ldtteam/minecolonies/commit/3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea", "message": "#   fixed infinite loop when citizen gets too much exp.\n#   removed particles when gaurd follows you\n#   fixed raid don't drop exp\n#   made raiders drop more exp\n#   made exp fly to citizens instead of instant collect to allow player to\ncollect some", "committedDate": "2020-03-04T03:36:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387685712", "bodyText": "Why is this needed?", "author": "Raycoms", "createdAt": "2020-03-04T14:04:22Z", "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "originalCommit": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk0ODE3MA==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r388948170", "bodyText": "it fixes a bug that when a guard collects too much exp it goes into infinite loop.", "author": "adoxentor", "createdAt": "2020-03-06T14:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1MjE0Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r388952146", "bodyText": "Where does this infinite loop come from?", "author": "Raycoms", "createdAt": "2020-03-06T15:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4MzM2Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r388983362", "bodyText": "minecolonies/src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenExperienceHandler.java\n    \n    \n        Lines 131 to 134\n      in\n      3f0ac63\n    \n    \n    \n    \n\n        \n          \n           while (ExperienceUtils.getXPNeededForNextLevel(citizen.getCitizenData().getLevel()) < citizen.getCitizenData().getExperience()) \n        \n\n        \n          \n           { \n        \n\n        \n          \n               citizen.getCitizenData().levelUp(); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nSo when level up fails the loop continues, my fix is deleting the excess exp. anther idea is make all of the call tree return bool value so the loop can stop and handle the issue in the top level.", "author": "adoxentor", "createdAt": "2020-03-06T15:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxMDcyMQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r389010721", "bodyText": "You added * returns true if level up succeeded, but no return value btw =D", "author": "Raycoms", "createdAt": "2020-03-06T16:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxNDk4NA==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r389014984", "bodyText": "this fix work indirectly though, the while's citizenData.getLevel queries the value and the while loop breaks", "author": "someaddons", "createdAt": "2020-03-06T16:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxODIzNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r389018235", "bodyText": "ahhh", "author": "Raycoms", "createdAt": "2020-03-06T16:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTg5Ng==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387685896", "bodyText": "Good catch, you can remove the comment here.", "author": "Raycoms", "createdAt": "2020-03-04T14:04:39Z", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingGuards.java", "diffHunk": "@@ -915,7 +915,7 @@ public void setPlayerToFollow(final PlayerEntity player)\n         if (this.getColony().getWorld() != null)\n         {\n             this.getColony().getWorld().getScoreboard().addPlayerToTeam(player.getScoreboardName(), new ScorePlayerTeam(this.getColony().getWorld().getScoreboard(), TEAM_COLONY_NAME + getColony().getID()));\n-            player.addPotionEffect(new EffectInstance(GLOW_EFFECT, GLOW_EFFECT_DURATION_TEAM, GLOW_EFFECT_MULTIPLIER));\n+            player.addPotionEffect(new EffectInstance(GLOW_EFFECT, GLOW_EFFECT_DURATION_TEAM, GLOW_EFFECT_MULTIPLIER,false,false));//no reason for particales\n ", "originalCommit": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NjIzNQ==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387686235", "bodyText": "Awesome", "author": "Raycoms", "createdAt": "2020-03-04T14:05:14Z", "path": "src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenExperienceHandler.java", "diffHunk": "@@ -210,8 +211,16 @@ public void gatherXp()\n     {\n         for (@NotNull final ExperienceOrbEntity orb : getXPOrbsOnGrid())\n         {\n-            addExperience(orb.getXpValue() / 2.0D);\n-            orb.remove();\n+            Vec3d vec3d = new Vec3d(citizen.posX - orb.getPosX(), citizen.posY + (double)this.citizen.getEyeHeight() / 2.0D - orb.getPosY(), citizen.getPosZ() - orb.getPosZ());\n+            double d1 = vec3d.lengthSquared();\n+\n+            if (d1 < 1.0D) {\n+                addExperience(orb.getXpValue() / 2.0D);\n+                orb.remove();\n+                return;\n+            }\n+            double d2 = 1.0D - Math.sqrt(d1) / 8.0D;\n+            orb.setMotion(orb.getMotion().add(vec3d.normalize().scale(d2 * d2 * 0.1D)));\n         }", "originalCommit": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NzA3Mg==", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387687072", "bodyText": "This is very old code, didn't know there was a new way around this. Good job", "author": "Raycoms", "createdAt": "2020-03-04T14:06:34Z", "path": "src/api/java/com/minecolonies/api/entity/mobs/AbstractEntityMinecoloniesMob.java", "diffHunk": "@@ -280,17 +281,6 @@ public ILivingEntityData onInitialSpawn(\n         return super.onInitialSpawn(worldIn, difficultyIn, reason, spawnDataIn, dataTag);\n     }\n \n-    @Override\n-    protected void onDeathUpdate()\n-    {\n-        if (!(this.getAttackingEntity() instanceof PlayerEntity) && (this.recentlyHit > 0 && this.canDropLoot() && world.getGameRules().getBoolean(GameRules.DO_MOB_LOOT)))\n-        {\n-            final int experience = ExperienceOrbEntity.getXPSplit(BARBARIAN_EXP_DROP);\n-            CompatibilityUtils.addEntity(world, new ExperienceOrbEntity(world, this.posX, this.posY, this.posZ, experience));\n-        }\n-        super.onDeathUpdate();\n-    }\n-", "originalCommit": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}