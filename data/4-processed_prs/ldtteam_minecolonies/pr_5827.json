{"pr_number": 5827, "pr_title": "Allocate builder to decorations", "pr_createdAt": "2020-09-25T10:12:35Z", "pr_url": "https://github.com/ldtteam/minecolonies/pull/5827", "timeline": [{"oid": "305957c0c3876f95e35a237aafdb35135466946f", "url": "https://github.com/ldtteam/minecolonies/commit/305957c0c3876f95e35a237aafdb35135466946f", "message": "Add new Build screen for decorations", "committedDate": "2020-09-25T05:44:43Z", "type": "commit"}, {"oid": "a516aca8c1c55e35282b978e1fcc7c0f9591a4a5", "url": "https://github.com/ldtteam/minecolonies/commit/a516aca8c1c55e35282b978e1fcc7c0f9591a4a5", "message": "Fix Null exception and add deco build message", "committedDate": "2020-09-25T07:05:33Z", "type": "commit"}, {"oid": "50f5d58d55a12a46895147410a918801af32a61c", "url": "https://github.com/ldtteam/minecolonies/commit/50f5d58d55a12a46895147410a918801af32a61c", "message": "Simplify decoration names to make them easier to read\n\nAnd in Town Hall, where the string was wasn't meaningful before cutting off.", "committedDate": "2020-09-25T09:40:53Z", "type": "commit"}, {"oid": "44a8a226e9da029385aee92c0333ece9ebc4e7a8", "url": "https://github.com/ldtteam/minecolonies/commit/44a8a226e9da029385aee92c0333ece9ebc4e7a8", "message": "Cut \"schematics\" off of infrastructure paths as well", "committedDate": "2020-09-26T04:47:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNDg2NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5827#discussion_r495434864", "bodyText": "can we get the parenthesis here?", "author": "Raycoms", "createdAt": "2020-09-26T08:58:20Z", "path": "src/main/java/com/minecolonies/coremod/network/messages/server/BuildToolPlaceMessage.java", "diffHunk": "@@ -301,7 +309,10 @@ private static void handleDecoration(\n                 }\n             }\n \n-            colony.getWorkManager().addWorkOrder(new WorkOrderBuildDecoration(schem, woName, rotation, buildPos, mirror), false);\n+            WorkOrderBuildDecoration woDeco = new WorkOrderBuildDecoration(schem, woName, rotation, buildPos, mirror);\n+            if (!builder.equals(BlockPos.ZERO)) woDeco.setClaimedBy(builder);", "originalCommit": "44a8a226e9da029385aee92c0333ece9ebc4e7a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNDg3OA==", "url": "https://github.com/ldtteam/minecolonies/pull/5827#discussion_r495434878", "bodyText": "potentially this properly formatted too", "author": "Raycoms", "createdAt": "2020-09-26T08:58:36Z", "path": "src/main/java/com/minecolonies/coremod/network/messages/server/BuildToolPlaceMessage.java", "diffHunk": "@@ -104,6 +105,8 @@ public BuildToolPlaceMessage(\n         this.state = state;\n     }\n \n+    public BlockPos getPos() { return pos; }", "originalCommit": "44a8a226e9da029385aee92c0333ece9ebc4e7a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNDk4NA==", "url": "https://github.com/ldtteam/minecolonies/pull/5827#discussion_r495434984", "bodyText": "To be fair. I think it is not a good idea to give the window the message. Properly better to just give the window all the data it needs in the constructor instead of giving it the message and adding a getter here.", "author": "Raycoms", "createdAt": "2020-09-26T08:59:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNDg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNjMzOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5827#discussion_r495436339", "bodyText": "Fair enough, I was tossing that one up anyway. Personally I prefer passing the object to save the long argument list, especially seeing that we still need to construct the message anyway. This way the message is being instantiated in a single place. I could also just pass in the builder BlockPos as a single extra argument to the Window?\nEDIT: although I did forget to lock access for the builder variable back to private. Oh nvm I needed that access.", "author": "ShadowProtocol", "createdAt": "2020-09-26T09:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNDg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNjUxOQ==", "url": "https://github.com/ldtteam/minecolonies/pull/5827#discussion_r495436519", "bodyText": "that also works", "author": "Raycoms", "createdAt": "2020-09-26T09:17:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNDg3OA=="}], "type": "inlineReview"}, {"oid": "408c9b7cf91a0d0d15ac5a34790fa2aaea701b10", "url": "https://github.com/ldtteam/minecolonies/commit/408c9b7cf91a0d0d15ac5a34790fa2aaea701b10", "message": "Fix formatting", "committedDate": "2020-09-26T09:39:33Z", "type": "commit"}, {"oid": "f7280f25815553db0a4d406199674a62435b3d37", "url": "https://github.com/ldtteam/minecolonies/commit/f7280f25815553db0a4d406199674a62435b3d37", "message": "Merge branch 'version/1.15' into feature/decorations", "committedDate": "2020-09-27T14:16:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4NzM3MA==", "url": "https://github.com/ldtteam/minecolonies/pull/5827#discussion_r495587370", "bodyText": "could you sort the builders by distance here? and also on the Buid Building GUI?", "author": "someaddons", "createdAt": "2020-09-27T16:02:10Z", "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowBuildDecoration.java", "diffHunk": "@@ -0,0 +1,310 @@\n+package com.minecolonies.coremod.client.gui;\n+\n+import com.ldtteam.blockout.Color;\n+import com.ldtteam.blockout.Pane;\n+import com.ldtteam.blockout.controls.Button;\n+import com.ldtteam.blockout.controls.ItemIcon;\n+import com.ldtteam.blockout.controls.Label;\n+import com.ldtteam.blockout.views.DropDownList;\n+import com.ldtteam.blockout.views.ScrollingList;\n+import com.ldtteam.structurize.management.StructureName;\n+import com.ldtteam.structurize.management.Structures;\n+import com.ldtteam.structurize.network.messages.SchematicRequestMessage;\n+import com.ldtteam.structurize.placement.BlockPlacementResult;\n+import com.ldtteam.structurize.placement.StructurePhasePlacementResult;\n+import com.ldtteam.structurize.placement.StructurePlacer;\n+import com.ldtteam.structurize.util.LanguageHandler;\n+import com.ldtteam.structurize.util.PlacementSettings;\n+import com.minecolonies.api.colony.IColonyManager;\n+import com.minecolonies.api.colony.IColonyView;\n+import com.minecolonies.api.crafting.ItemStorage;\n+import com.minecolonies.api.util.ItemStackUtils;\n+import com.minecolonies.api.util.LoadOnlyStructureHandler;\n+import com.minecolonies.api.util.Log;\n+import com.minecolonies.api.util.constant.Constants;\n+import com.minecolonies.api.util.constant.TranslationConstants;\n+import com.minecolonies.coremod.Network;\n+import com.minecolonies.coremod.colony.buildings.views.AbstractBuildingBuilderView;\n+import com.minecolonies.coremod.colony.buildings.workerbuildings.BuildingMiner;\n+import com.minecolonies.coremod.network.messages.server.BuildToolPlaceMessage;\n+import net.minecraft.client.Minecraft;\n+import net.minecraft.item.ItemStack;\n+import net.minecraft.util.Tuple;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.World;\n+import net.minecraftforge.fml.server.ServerLifecycleHooks;\n+import org.jetbrains.annotations.NotNull;\n+import org.jetbrains.annotations.Nullable;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.ldtteam.structurize.placement.BlueprintIterator.NULL_POS;\n+import static com.minecolonies.api.util.constant.WindowConstants.*;\n+\n+public class WindowBuildDecoration extends AbstractWindowSkeleton\n+{\n+    /**\n+     * Link to the xml file of the window.\n+     */\n+    private static final String BUILDING_NAME_RESOURCE_SUFFIX = \":gui/windowbuildbuilding.xml\";\n+\n+    /**\n+     * White color.\n+     */\n+    private static final int WHITE = Color.getByName(\"white\", 0);\n+\n+    /**\n+     * List of style for the section.\n+     */\n+    @NotNull\n+    private final List<Tuple<String, BlockPos>> builders = new ArrayList<>();\n+\n+    /**\n+     * Drop down list for builders.\n+     */\n+    private DropDownList buildersDropDownList;\n+\n+    /**\n+     * Contains all resources needed for a certain build.\n+     */\n+    private final Map<String, ItemStorage> resources = new HashMap<>();\n+\n+    /**\n+     * Stores the message to be transmitted upon completion\n+     */\n+    private final BuildToolPlaceMessage placementMessage;\n+\n+    /**\n+     * The name of the structure\n+     */\n+    private final StructureName structureName;\n+\n+    /**\n+     * The position of the decoration anchor\n+     */\n+    private final BlockPos structurePos;\n+\n+    /**\n+     * Constructs the decoration build confirmation dialog\n+     */\n+    public WindowBuildDecoration(BuildToolPlaceMessage msg, BlockPos pos, StructureName structure)\n+    {\n+        super(Constants.MOD_ID + BUILDING_NAME_RESOURCE_SUFFIX);\n+        placementMessage = msg;\n+        structureName = structure;\n+        structurePos = pos;\n+\n+        registerButton(BUTTON_BUILD, this::confirmedBuild);\n+        registerButton(BUTTON_CANCEL, this::close);\n+\n+        findPaneOfTypeByID(BUTTON_BUILD, Button.class)\n+                .setLabel(LanguageHandler.format(\"com.minecolonies.coremod.gui.workerhuts.build\"));\n+        findPaneOfTypeByID(BUTTON_MOVE_BUILDING, Button.class).hide();\n+        findPaneOfTypeByID(BUTTON_REPAIR, Button.class).hide();\n+        findPaneOfTypeByID(BUTTON_NEXT_STYLE_ID, Button.class).hide();\n+        findPaneOfTypeByID(BUTTON_PREVIOUS_STYLE_ID, Button.class).hide();\n+        findPaneOfTypeByID(DROPDOWN_STYLE_ID, DropDownList.class).disable();\n+    }\n+\n+    @Override\n+    public void onOpened()\n+    {\n+        updateBuilders();\n+        updateResources();\n+    }\n+\n+    /**\n+     * Update the builders list but try to keep the same one.\n+     */\n+    private void updateBuilders()\n+    {\n+        IColonyView colony = (IColonyView) IColonyManager.getInstance()\n+                .getIColony(Minecraft.getInstance().world, structurePos);\n+\n+        if (colony == null)\n+        {\n+            LanguageHandler.sendPlayerMessage(Minecraft.getInstance().player, TranslationConstants.OUT_OF_COLONY);\n+            close();\n+            return;\n+        }\n+\n+        builders.clear();\n+        builders.add(new Tuple<>(LanguageHandler.format(\"com.minecolonies.coremod.job.Builder\") + \":\", BlockPos.ZERO));\n+        builders.addAll(colony.getBuildings().stream()\n+                .filter(build -> build instanceof AbstractBuildingBuilderView && !((AbstractBuildingBuilderView) build).getWorkerName().isEmpty()\n+                        && !(build instanceof BuildingMiner.View))\n+                .map(build -> new Tuple<>(((AbstractBuildingBuilderView) build).getWorkerName(), build.getPosition()))\n+                .collect(Collectors.toList()));", "originalCommit": "f7280f25815553db0a4d406199674a62435b3d37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYzODMwNA==", "url": "https://github.com/ldtteam/minecolonies/pull/5827#discussion_r495638304", "bodyText": "I don't like doing that sort of thing simply because it is not immediately apparent when you look at the list, and the user would have to learn the order, rather than one they most likely know (the alphabet). And just IMO, the point is to allow them to select the builder, not have that choice calculated for them. That said I do understand why that would be neat and convenient, and does make sense. So I'm torn. Thoughts?", "author": "ShadowProtocol", "createdAt": "2020-09-28T00:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4NzM3MA=="}], "type": "inlineReview"}, {"oid": "72502096d246802fa9fdbe4e2aa9a0bf11868a36", "url": "https://github.com/ldtteam/minecolonies/commit/72502096d246802fa9fdbe4e2aa9a0bf11868a36", "message": "Sort builders by distance", "committedDate": "2020-09-29T02:03:45Z", "type": "commit"}, {"oid": "efb20da3cdb499d2db4f3e1c1b9bde2646ee6c58", "url": "https://github.com/ldtteam/minecolonies/commit/efb20da3cdb499d2db4f3e1c1b9bde2646ee6c58", "message": "Remove never used variable", "committedDate": "2020-09-29T02:05:35Z", "type": "commit"}]}