{"pr_number": 4982, "pr_title": "RM22812 Invoicing graphics involving revenue based both sales and refunds.", "pr_createdAt": "2020-02-25T14:42:16Z", "pr_url": "https://github.com/axelor/axelor-open-suite/pull/4982", "timeline": [{"oid": "6a58e7eb6c673049aa049099e1d61113c5e702ea", "url": "https://github.com/axelor/axelor-open-suite/commit/6a58e7eb6c673049aa049099e1d61113c5e702ea", "message": "Adding customer assets in the turnover calculation", "committedDate": "2020-02-24T10:42:27Z", "type": "commit"}, {"oid": "78d16468643fd5252f437053ee206fc6972bb994", "url": "https://github.com/axelor/axelor-open-suite/commit/78d16468643fd5252f437053ee206fc6972bb994", "message": "Correction for customer assets on revenue graphs", "committedDate": "2020-02-25T14:35:10Z", "type": "commit"}, {"oid": "689a7a99f3221965f7bcf0a1a099a93db9c25cc0", "url": "https://github.com/axelor/axelor-open-suite/commit/689a7a99f3221965f7bcf0a1a099a93db9c25cc0", "message": "spotlessApply", "committedDate": "2020-02-25T14:36:56Z", "type": "commit"}, {"oid": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "url": "https://github.com/axelor/axelor-open-suite/commit/2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "message": "Merge branch '5.2-dev' into dev-22812", "committedDate": "2020-02-26T11:11:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM5OTU1Ng==", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386399556", "bodyText": "Create a JPQL query using SUM instead of computing the sum in java", "author": "ale-axelor", "createdAt": "2020-03-02T13:44:15Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(\n+      ActionRequest request, ActionResponse response) {\n+    List<Map<String, Object>> dataList = new ArrayList<>();\n+    InvoiceRepository repo = Beans.get(InvoiceRepository.class);\n+    BigDecimal salesThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal salesLastYear =\n+        repo.all()", "originalCommit": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg3OTcwMw==", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386879703", "bodyText": "used SQL query instead for every charts", "author": "erg-axelor", "createdAt": "2020-03-03T09:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM5OTU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDIwNg==", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386400206", "bodyText": "Please refactor this controller to use a service", "author": "ale-axelor", "createdAt": "2020-03-02T13:45:36Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(", "originalCommit": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDM5OQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386400399", "bodyText": "use signum() to check if a big decimal is equal to 0", "author": "ale-axelor", "createdAt": "2020-03-02T13:45:58Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(\n+      ActionRequest request, ActionResponse response) {\n+    List<Map<String, Object>> dataList = new ArrayList<>();\n+    InvoiceRepository repo = Beans.get(InvoiceRepository.class);\n+    BigDecimal salesThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal salesLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal totalThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesThisYear);\n+    BigDecimal totalLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesLastYear);\n+    if (!totalLastYear.equals(BigDecimal.ZERO)) {", "originalCommit": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMTM0MA==", "url": "https://github.com/axelor/axelor-open-suite/pull/4982#discussion_r386401340", "bodyText": "please replace LocalDate.now() by appBaseService.getTodayDate()", "author": "ale-axelor", "createdAt": "2020-03-02T13:47:54Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/web/AccountChartController.java", "diffHunk": "@@ -58,4 +68,259 @@ public void installChart(ActionRequest request, ActionResponse response) throws\n \n     } else response.setFlash(I18n.get(IExceptionMessage.ACCOUNT_CHART_3));\n   }\n+\n+  public void chartInvoicedTurnoverThisYearVsLastyear(\n+      ActionRequest request, ActionResponse response) {\n+    List<Map<String, Object>> dataList = new ArrayList<>();\n+    InvoiceRepository repo = Beans.get(InvoiceRepository.class);\n+    BigDecimal salesThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal salesLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=3 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add);\n+    BigDecimal totalThisYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesThisYear);\n+    BigDecimal totalLastYear =\n+        repo.all()\n+            .filter(\n+                \"self.statusSelect != 1 and self.operationTypeSelect=4 and DATE_PART('year', self.invoiceDate) = DATE_PART('year',CURRENT_DATE) - 1 \")\n+            .fetchStream()\n+            .map(i -> i.getExTaxTotal())\n+            .reduce(BigDecimal.ZERO, BigDecimal::add)\n+            .negate()\n+            .add(salesLastYear);\n+    if (!totalLastYear.equals(BigDecimal.ZERO)) {\n+      Map<String, Object> dataMap = new HashMap<>();\n+      dataMap.put(\"_year\", LocalDate.now().getYear() - 1);", "originalCommit": "2bafb7efa750dc16bafe9a0bd1662142c4c2cb9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "824dff2b76b7e9a7c9d947da6c4a40603912a86a", "url": "https://github.com/axelor/axelor-open-suite/commit/824dff2b76b7e9a7c9d947da6c4a40603912a86a", "message": "Getting chart back from rpc dataset to sql", "committedDate": "2020-03-03T08:59:53Z", "type": "commit"}, {"oid": "70acfbfe444184f642b861434123243019d22271", "url": "https://github.com/axelor/axelor-open-suite/commit/70acfbfe444184f642b861434123243019d22271", "message": "Merge branch 'dev-22812' of github.com:erg-axelor/axelor-open-suite into dev-22812", "committedDate": "2020-03-03T09:00:17Z", "type": "commit"}, {"oid": "77b34725583347327465e7c543769b9e997d3ac9", "url": "https://github.com/axelor/axelor-open-suite/commit/77b34725583347327465e7c543769b9e997d3ac9", "message": "spotlessApply", "committedDate": "2020-03-03T09:02:54Z", "type": "commit"}, {"oid": "10629d9f6c009cb15180c7eec0c0c2f87f4d5d9d", "url": "https://github.com/axelor/axelor-open-suite/commit/10629d9f6c009cb15180c7eec0c0c2f87f4d5d9d", "message": "Merge branch '5.2-dev' into dev-22812", "committedDate": "2020-03-03T09:05:29Z", "type": "commit"}, {"oid": "158ec874292ca3a00cdfaec0b6c5d5a27cff1d99", "url": "https://github.com/axelor/axelor-open-suite/commit/158ec874292ca3a00cdfaec0b6c5d5a27cff1d99", "message": "Merge branch '5.2-dev' into dev-22812", "committedDate": "2020-03-03T15:11:38Z", "type": "commit"}]}