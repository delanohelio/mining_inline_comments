{"pr_number": 6039, "pr_title": "Anomaly #32387 Analytic Move Line : change project depending of the state of parent Order or Invoice", "pr_createdAt": "2020-10-30T13:30:54Z", "pr_url": "https://github.com/axelor/axelor-open-suite/pull/6039", "timeline": [{"oid": "451f7a0fefabff5537a99e13f0cd8558e339818a", "url": "https://github.com/axelor/axelor-open-suite/commit/451f7a0fefabff5537a99e13f0cd8558e339818a", "message": "First work on change requested", "committedDate": "2020-11-03T17:00:59Z", "type": "commit"}, {"oid": "25f4b0245d05b7400ebc6cc89cead86482110c17", "url": "https://github.com/axelor/axelor-open-suite/commit/25f4b0245d05b7400ebc6cc89cead86482110c17", "message": "Analytic Move Line : changing project now updates linked analytic move line\n\nAnomaly #32387", "committedDate": "2020-11-04T11:59:21Z", "type": "commit"}, {"oid": "25f4b0245d05b7400ebc6cc89cead86482110c17", "url": "https://github.com/axelor/axelor-open-suite/commit/25f4b0245d05b7400ebc6cc89cead86482110c17", "message": "Analytic Move Line : changing project now updates linked analytic move line\n\nAnomaly #32387", "committedDate": "2020-11-04T11:59:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExNjkwNg==", "url": "https://github.com/axelor/axelor-open-suite/pull/6039#discussion_r518116906", "bodyText": "Do not inject using beans.get in a loop, use injection in constructor to get AnalyticMoveLineRepository", "author": "ale-axelor", "createdAt": "2020-11-05T15:00:21Z", "path": "axelor-business-production/src/main/java/com/axelor/apps/businessproduction/service/SaleOrderWorkflowServiceBusinessProductionImpl.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.axelor.apps.businessproduction.service;\n+\n+import com.axelor.apps.account.db.AnalyticMoveLine;\n+import com.axelor.apps.account.db.repo.AnalyticMoveLineRepository;\n+import com.axelor.apps.base.db.CancelReason;\n+import com.axelor.apps.base.db.repo.PartnerRepository;\n+import com.axelor.apps.base.service.administration.SequenceService;\n+import com.axelor.apps.base.service.user.UserService;\n+import com.axelor.apps.production.service.SaleOrderWorkflowServiceProductionImpl;\n+import com.axelor.apps.production.service.app.AppProductionService;\n+import com.axelor.apps.production.service.productionorder.ProductionOrderSaleOrderService;\n+import com.axelor.apps.sale.db.SaleOrder;\n+import com.axelor.apps.sale.db.SaleOrderLine;\n+import com.axelor.apps.sale.db.repo.SaleOrderRepository;\n+import com.axelor.apps.sale.service.app.AppSaleService;\n+import com.axelor.apps.supplychain.service.AccountingSituationSupplychainService;\n+import com.axelor.apps.supplychain.service.SaleOrderPurchaseService;\n+import com.axelor.apps.supplychain.service.SaleOrderStockService;\n+import com.axelor.apps.supplychain.service.app.AppSupplychainService;\n+import com.axelor.inject.Beans;\n+import com.google.inject.Inject;\n+import com.google.inject.persist.Transactional;\n+\n+public class SaleOrderWorkflowServiceBusinessProductionImpl\n+    extends SaleOrderWorkflowServiceProductionImpl {\n+\n+  @Inject\n+  public SaleOrderWorkflowServiceBusinessProductionImpl(\n+      SequenceService sequenceService,\n+      PartnerRepository partnerRepo,\n+      SaleOrderRepository saleOrderRepo,\n+      AppSaleService appSaleService,\n+      UserService userService,\n+      SaleOrderStockService saleOrderStockService,\n+      SaleOrderPurchaseService saleOrderPurchaseService,\n+      AppSupplychainService appSupplychainService,\n+      AccountingSituationSupplychainService accountingSituationSupplychainService,\n+      ProductionOrderSaleOrderService productionOrderSaleOrderService,\n+      AppProductionService appProductionService) {\n+    super(\n+        sequenceService,\n+        partnerRepo,\n+        saleOrderRepo,\n+        appSaleService,\n+        userService,\n+        saleOrderStockService,\n+        saleOrderPurchaseService,\n+        appSupplychainService,\n+        accountingSituationSupplychainService,\n+        productionOrderSaleOrderService,\n+        appProductionService);\n+  }\n+\n+  @Override\n+  @Transactional(rollbackOn = Exception.class)\n+  public void cancelSaleOrder(\n+      SaleOrder saleOrder, CancelReason cancelReason, String cancelReasonStr) {\n+    super.cancelSaleOrder(saleOrder, cancelReason, cancelReasonStr);\n+    for (SaleOrderLine saleOrderLine : saleOrder.getSaleOrderLineList()) {\n+      for (AnalyticMoveLine analyticMoveLine : saleOrderLine.getAnalyticMoveLineList()) {\n+        analyticMoveLine.setProject(null);\n+        Beans.get(AnalyticMoveLineRepository.class).save(analyticMoveLine);", "originalCommit": "25f4b0245d05b7400ebc6cc89cead86482110c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE0MTA3Mw==", "url": "https://github.com/axelor/axelor-open-suite/pull/6039#discussion_r518141073", "bodyText": "surround everything in a try catch to trace any exception", "author": "ale-axelor", "createdAt": "2020-11-05T15:32:23Z", "path": "axelor-business-project/src/main/java/com/axelor/apps/businessproject/web/InvoiceController.java", "diffHunk": "@@ -322,10 +321,7 @@ public void exportAnnex(ActionRequest request, ActionResponse response) throws A\n   public void updateLines(ActionRequest request, ActionResponse response) throws AxelorException {", "originalCommit": "25f4b0245d05b7400ebc6cc89cead86482110c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE0MjA5Mw==", "url": "https://github.com/axelor/axelor-open-suite/pull/6039#discussion_r518142093", "bodyText": "Create a new interface InvoiceServiceProject that will be implemented by InvoiceServiceProjectImpl and inject it, in order to inject interface and not the implementation.", "author": "ale-axelor", "createdAt": "2020-11-05T15:33:28Z", "path": "axelor-business-project/src/main/java/com/axelor/apps/businessproject/web/InvoiceController.java", "diffHunk": "@@ -322,10 +321,7 @@ public void exportAnnex(ActionRequest request, ActionResponse response) throws A\n   public void updateLines(ActionRequest request, ActionResponse response) throws AxelorException {\n     Invoice invoice = request.getContext().asType(Invoice.class);\n     invoice = Beans.get(InvoiceRepository.class).find(invoice.getId());\n-\n-    for (InvoiceLine invoiceLine : invoice.getInvoiceLineList()) {\n-      invoiceLine.setProject(invoice.getProject());\n-    }\n+    invoice = Beans.get(InvoiceServiceProjectImpl.class).updateLines(invoice);", "originalCommit": "25f4b0245d05b7400ebc6cc89cead86482110c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1NDMxMQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/6039#discussion_r518154311", "bodyText": "surround everything in a try catch to trace any exception", "author": "ale-axelor", "createdAt": "2020-11-05T15:46:57Z", "path": "axelor-business-project/src/main/java/com/axelor/apps/businessproject/web/InvoiceLineProjectController.java", "diffHunk": "@@ -147,4 +149,15 @@ public void unsetSupplierInvoiceLineProject(ActionRequest request, ActionRespons\n       TraceBackService.trace(e);\n     }\n   }\n+\n+  public void setProjectToAnalyticDistribution(ActionRequest request, ActionResponse response) {", "originalCommit": "25f4b0245d05b7400ebc6cc89cead86482110c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1NDg3OQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/6039#discussion_r518154879", "bodyText": "surround everything in a try catch to trace any exception", "author": "ale-axelor", "createdAt": "2020-11-05T15:47:39Z", "path": "axelor-business-project/src/main/java/com/axelor/apps/businessproject/web/PurchaseOrderLineProjectController.java", "diffHunk": "@@ -113,4 +114,16 @@ public void updateToInvoice(ActionRequest request, ActionResponse response) {\n       TraceBackService.trace(response, e);\n     }\n   }\n+\n+  public void updateAnalyticDistributionWithProject(ActionRequest request, ActionResponse response)", "originalCommit": "25f4b0245d05b7400ebc6cc89cead86482110c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE1NTIxOA==", "url": "https://github.com/axelor/axelor-open-suite/pull/6039#discussion_r518155218", "bodyText": "surround everything in a try catch to trace any exception", "author": "ale-axelor", "createdAt": "2020-11-05T15:48:08Z", "path": "axelor-business-project/src/main/java/com/axelor/apps/businessproject/web/SaleOrderLineProjectController.java", "diffHunk": "@@ -110,4 +111,16 @@ public void updateToInvoice(ActionRequest request, ActionResponse response) {\n       TraceBackService.trace(response, e);\n     }\n   }\n+\n+  public void updateAnalyticDistributionWithProject(ActionRequest request, ActionResponse response)", "originalCommit": "25f4b0245d05b7400ebc6cc89cead86482110c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3c45d80c42be1c9487629b1859bbf6b29a6d36ab", "url": "https://github.com/axelor/axelor-open-suite/commit/3c45d80c42be1c9487629b1859bbf6b29a6d36ab", "message": "Merge branch '5.4-dev' of github.com:axelor/axelor-open-suite into 5.4-dev-32387", "committedDate": "2020-11-05T16:13:07Z", "type": "commit"}, {"oid": "0e18f14a1e2e61d887407913fedc600ff83c819c", "url": "https://github.com/axelor/axelor-open-suite/commit/0e18f14a1e2e61d887407913fedc600ff83c819c", "message": "Add change requested", "committedDate": "2020-11-05T16:31:10Z", "type": "commit"}]}