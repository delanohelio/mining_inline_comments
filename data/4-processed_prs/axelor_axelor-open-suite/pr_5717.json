{"pr_number": 5717, "pr_title": "Feature #23592: Pack (3)", "pr_createdAt": "2020-08-14T12:34:32Z", "pr_url": "https://github.com/axelor/axelor-open-suite/pull/5717", "timeline": [{"oid": "d69735e0f133e4a09134006d057e0596754e6160", "url": "https://github.com/axelor/axelor-open-suite/commit/d69735e0f133e4a09134006d057e0596754e6160", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-17T09:36:11Z", "type": "forcePushed"}, {"oid": "977b8dcb2afdc7ff22c2ba92d14066471b092591", "url": "https://github.com/axelor/axelor-open-suite/commit/977b8dcb2afdc7ff22c2ba92d14066471b092591", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-17T13:18:58Z", "type": "forcePushed"}, {"oid": "9f48c1d084524a569e503430394269fff44aa9db", "url": "https://github.com/axelor/axelor-open-suite/commit/9f48c1d084524a569e503430394269fff44aa9db", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-20T10:33:43Z", "type": "forcePushed"}, {"oid": "c5faa7d1b4e4eb66233ad852fa4f00ed9019d798", "url": "https://github.com/axelor/axelor-open-suite/commit/c5faa7d1b4e4eb66233ad852fa4f00ed9019d798", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-21T04:31:36Z", "type": "forcePushed"}, {"oid": "d47c6bcd95a19b3a18f1ea51715b5d7455f3a149", "url": "https://github.com/axelor/axelor-open-suite/commit/d47c6bcd95a19b3a18f1ea51715b5d7455f3a149", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-21T09:12:47Z", "type": "forcePushed"}, {"oid": "ef82a1420c10db424ba5b3173943082c2f913d13", "url": "https://github.com/axelor/axelor-open-suite/commit/ef82a1420c10db424ba5b3173943082c2f913d13", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-27T09:53:56Z", "type": "forcePushed"}, {"oid": "5541b0186f083e48bc6ae237077de61c388ec46e", "url": "https://github.com/axelor/axelor-open-suite/commit/5541b0186f083e48bc6ae237077de61c388ec46e", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-27T09:59:56Z", "type": "forcePushed"}, {"oid": "d31a3ab3b09ca6bbf8e87c0fc3be196c18643d02", "url": "https://github.com/axelor/axelor-open-suite/commit/d31a3ab3b09ca6bbf8e87c0fc3be196c18643d02", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-27T10:22:15Z", "type": "forcePushed"}, {"oid": "0cff926fa54c12d240549bb231316bea075bcc93", "url": "https://github.com/axelor/axelor-open-suite/commit/0cff926fa54c12d240549bb231316bea075bcc93", "message": "Feature #23592: Pack (3)", "committedDate": "2020-08-31T14:38:00Z", "type": "forcePushed"}, {"oid": "0270a6b1828345ffe07d9cac0fe7ec43b400fb8a", "url": "https://github.com/axelor/axelor-open-suite/commit/0270a6b1828345ffe07d9cac0fe7ec43b400fb8a", "message": "Feature #23592: Pack (3)", "committedDate": "2020-09-03T07:31:09Z", "type": "forcePushed"}, {"oid": "13a21c428913c2cc3d79ecf62e547293300d86c5", "url": "https://github.com/axelor/axelor-open-suite/commit/13a21c428913c2cc3d79ecf62e547293300d86c5", "message": "Feature #23592: Pack (3)", "committedDate": "2020-09-07T05:58:44Z", "type": "forcePushed"}, {"oid": "639449b9587bac4f850029e7d3ba2775ed5aa644", "url": "https://github.com/axelor/axelor-open-suite/commit/639449b9587bac4f850029e7d3ba2775ed5aa644", "message": "Feature #23592: Pack (3)", "committedDate": "2020-09-28T14:36:08Z", "type": "forcePushed"}, {"oid": "f096838aa218f2a7779138b7262ac69eea741cc2", "url": "https://github.com/axelor/axelor-open-suite/commit/f096838aa218f2a7779138b7262ac69eea741cc2", "message": "Feature #23592: Pack (3)", "committedDate": "2020-09-29T10:32:03Z", "type": "forcePushed"}, {"oid": "9f874e1365d2a725a586f9313e5c5a5fb1652044", "url": "https://github.com/axelor/axelor-open-suite/commit/9f874e1365d2a725a586f9313e5c5a5fb1652044", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-02T07:28:52Z", "type": "forcePushed"}, {"oid": "6ddefc8a6fb076a110c05bd20647643f1cbb5486", "url": "https://github.com/axelor/axelor-open-suite/commit/6ddefc8a6fb076a110c05bd20647643f1cbb5486", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-05T13:40:56Z", "type": "forcePushed"}, {"oid": "4757b6f333cbe9d7f665618224c3c377989105f9", "url": "https://github.com/axelor/axelor-open-suite/commit/4757b6f333cbe9d7f665618224c3c377989105f9", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-06T10:33:26Z", "type": "forcePushed"}, {"oid": "45fb712b9137fbce8ce6bee33665e5416185545f", "url": "https://github.com/axelor/axelor-open-suite/commit/45fb712b9137fbce8ce6bee33665e5416185545f", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-06T10:36:09Z", "type": "forcePushed"}, {"oid": "90eb59237ccec8eb197e4d27baade3a91c296264", "url": "https://github.com/axelor/axelor-open-suite/commit/90eb59237ccec8eb197e4d27baade3a91c296264", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-06T11:43:09Z", "type": "forcePushed"}, {"oid": "8c1012282bd095d8fa52df7df3bf8068b8e9a30c", "url": "https://github.com/axelor/axelor-open-suite/commit/8c1012282bd095d8fa52df7df3bf8068b8e9a30c", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-09T08:25:23Z", "type": "forcePushed"}, {"oid": "544341e61ee1e0e84619e7bd08a8bda814192ae5", "url": "https://github.com/axelor/axelor-open-suite/commit/544341e61ee1e0e84619e7bd08a8bda814192ae5", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-16T14:08:31Z", "type": "forcePushed"}, {"oid": "f908a1f3f232af471b6ee62324a8de484e4ab11c", "url": "https://github.com/axelor/axelor-open-suite/commit/f908a1f3f232af471b6ee62324a8de484e4ab11c", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-19T10:37:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNTMyMg==", "url": "https://github.com/axelor/axelor-open-suite/pull/5717#discussion_r508235322", "bodyText": "The second condition is removed", "author": "vbh-axelor", "createdAt": "2020-10-20T06:18:58Z", "path": "axelor-supplychain/src/main/java/com/axelor/apps/supplychain/service/invoice/generator/InvoiceLineGeneratorSupplyChain.java", "diffHunk": "@@ -196,22 +197,33 @@ protected InvoiceLine createInvoiceLine() throws AxelorException {\n \n     if (saleOrderLine != null) {\n \n-      if (saleOrderLine.getAnalyticDistributionTemplate() != null\n-          || !ObjectUtils.isEmpty(saleOrderLine.getAnalyticMoveLineList())) {\n-        invoiceLine.setAnalyticDistributionTemplate(\n-            saleOrderLine.getAnalyticDistributionTemplate());\n-        this.copyAnalyticMoveLines(saleOrderLine.getAnalyticMoveLineList(), invoiceLine);\n-        analyticMoveLineList = invoiceLineService.computeAnalyticDistribution(invoiceLine);\n-      } else {\n-        analyticMoveLineList =\n-            invoiceLineService.getAndComputeAnalyticDistribution(invoiceLine, invoice);\n-        analyticMoveLineList.stream().forEach(invoiceLine::addAnalyticMoveLineListItem);\n+      switch (saleOrderLine.getTypeSelect()) {\n+        case SaleOrderLineRepository.TYPE_END_OF_PACK:\n+          invoiceLine.setIsHideUnitAmounts(saleOrderLine.getIsHideUnitAmounts());\n+          invoiceLine.setIsShowTotal(saleOrderLine.getIsShowTotal());\n+          break;\n+\n+        case SaleOrderLineRepository.TYPE_NORMAL:\n+          if (saleOrderLine.getAnalyticDistributionTemplate() != null\n+              || !ObjectUtils.isEmpty(saleOrderLine.getAnalyticMoveLineList())) {\n+            invoiceLine.setAnalyticDistributionTemplate(\n+                saleOrderLine.getAnalyticDistributionTemplate());\n+            this.copyAnalyticMoveLines(saleOrderLine.getAnalyticMoveLineList(), invoiceLine);\n+            analyticMoveLineList = invoiceLineService.computeAnalyticDistribution(invoiceLine);\n+          } else {\n+            analyticMoveLineList =\n+                invoiceLineService.getAndComputeAnalyticDistribution(invoiceLine, invoice);\n+            analyticMoveLineList.stream().forEach(invoiceLine::addAnalyticMoveLineListItem);\n+          }\n+          break;\n+\n+        default:\n+          return invoiceLine;\n       }\n \n     } else if (purchaseOrderLine != null) {\n \n-      if (purchaseOrderLine.getAnalyticDistributionTemplate() != null\n-          || !ObjectUtils.isEmpty(purchaseOrderLine.getAnalyticMoveLineList())) {", "originalCommit": "f908a1f3f232af471b6ee62324a8de484e4ab11c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44b696acf9a256cb1fa8caa62a14132c2efa470b", "url": "https://github.com/axelor/axelor-open-suite/commit/44b696acf9a256cb1fa8caa62a14132c2efa470b", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-20T12:47:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0MTM2Mw==", "url": "https://github.com/axelor/axelor-open-suite/pull/5717#discussion_r509141363", "bodyText": "This condition seems to be incorrect. analyticMoveLineList is not updated when user change qty.", "author": "vbh-axelor", "createdAt": "2020-10-21T09:46:33Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/service/invoice/InvoiceLineServiceImpl.java", "diffHunk": "@@ -452,4 +458,82 @@ public Unit getUnit(Product product, boolean isPurchase) {\n \n     return productInformation;\n   }\n+\n+  @Override\n+  public boolean hasEndOfPackTypeLine(List<InvoiceLine> invoiceLineList) {\n+    return ObjectUtils.isEmpty(invoiceLineList)\n+        ? Boolean.FALSE\n+        : invoiceLineList.stream()\n+            .anyMatch(\n+                invoiceLine ->\n+                    invoiceLine.getTypeSelect() == InvoiceLineRepository.TYPE_END_OF_PACK);\n+  }\n+\n+  @Override\n+  public boolean isStartOfPackTypeLineQtyChanged(List<InvoiceLine> invoiceLineList) {\n+\n+    if (ObjectUtils.isEmpty(invoiceLineList)) {\n+      return false;\n+    }\n+    for (InvoiceLine invoiceLine : invoiceLineList) {\n+      if (invoiceLine.getTypeSelect() == InvoiceLineRepository.TYPE_START_OF_PACK\n+          && invoiceLine.getId() != null) {\n+        InvoiceLine oldInvoiceLine = invoiceLineRepo.find(invoiceLine.getId());\n+        if (oldInvoiceLine.getTypeSelect() == InvoiceLineRepository.TYPE_START_OF_PACK\n+            && invoiceLine.getQty().compareTo(oldInvoiceLine.getQty()) != 0) {\n+          return true;\n+        }\n+      }\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public InvoiceLine updateProductQty(\n+      InvoiceLine invoiceLine, Invoice invoice, BigDecimal oldQty, BigDecimal newQty, int scale) {\n+    BigDecimal qty =\n+        invoiceLine\n+            .getQty()\n+            .divide(oldQty, scale, RoundingMode.HALF_EVEN)\n+            .multiply(newQty)\n+            .setScale(scale, RoundingMode.HALF_EVEN);\n+    invoiceLine.setQty(qty);\n+    if (invoiceLine.getTypeSelect() != InvoiceLineRepository.TYPE_NORMAL\n+        || invoiceLine.getProduct() == null) {\n+      return invoiceLine;\n+    }\n+    try {\n+      BigDecimal exTaxTotal;\n+      BigDecimal inTaxTotal;\n+      BigDecimal taxRate = BigDecimal.ZERO;\n+      BigDecimal priceDiscounted = this.computeDiscount(invoiceLine, invoice.getInAti());\n+      if (invoiceLine.getTaxLine() != null) {\n+        taxRate = invoiceLine.getTaxLine().getValue();\n+      }\n+      if (Boolean.FALSE.equals(invoice.getInAti())) {\n+        exTaxTotal = InvoiceLineManagement.computeAmount(qty, priceDiscounted);\n+        inTaxTotal = exTaxTotal.add(exTaxTotal.multiply(taxRate));\n+      } else {\n+        inTaxTotal = InvoiceLineManagement.computeAmount(qty, priceDiscounted);\n+        exTaxTotal = inTaxTotal.divide(taxRate.add(BigDecimal.ONE), 2, BigDecimal.ROUND_HALF_UP);\n+      }\n+      invoiceLine.setExTaxTotal(exTaxTotal);\n+      invoiceLine.setCompanyExTaxTotal(this.getCompanyExTaxTotal(exTaxTotal, invoice));\n+      invoiceLine.setInTaxTotal(inTaxTotal);\n+      invoiceLine.setCompanyInTaxTotal(this.getCompanyExTaxTotal(inTaxTotal, invoice));\n+      invoiceLine.setPriceDiscounted(priceDiscounted);\n+      invoiceLine.setTaxRate(taxRate);\n+    } catch (Exception e) {\n+      TraceBackService.trace(e);\n+    }\n+    return this.computeAnalyticDistributionWithUpdatedQty(invoiceLine);\n+  }\n+\n+  private InvoiceLine computeAnalyticDistributionWithUpdatedQty(InvoiceLine invoiceLine) {\n+\n+    if (Boolean.FALSE.equals(appAccountService.getAppAccount().getManageAnalyticAccounting())) {", "originalCommit": "44b696acf9a256cb1fa8caa62a14132c2efa470b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0MzI0OQ==", "url": "https://github.com/axelor/axelor-open-suite/pull/5717#discussion_r509143249", "bodyText": "I think it would be better to remove scale from method argument and declare variable for it inside method.", "author": "vbh-axelor", "createdAt": "2020-10-21T09:49:30Z", "path": "axelor-account/src/main/java/com/axelor/apps/account/service/invoice/InvoiceLineServiceImpl.java", "diffHunk": "@@ -452,4 +458,82 @@ public Unit getUnit(Product product, boolean isPurchase) {\n \n     return productInformation;\n   }\n+\n+  @Override\n+  public boolean hasEndOfPackTypeLine(List<InvoiceLine> invoiceLineList) {\n+    return ObjectUtils.isEmpty(invoiceLineList)\n+        ? Boolean.FALSE\n+        : invoiceLineList.stream()\n+            .anyMatch(\n+                invoiceLine ->\n+                    invoiceLine.getTypeSelect() == InvoiceLineRepository.TYPE_END_OF_PACK);\n+  }\n+\n+  @Override\n+  public boolean isStartOfPackTypeLineQtyChanged(List<InvoiceLine> invoiceLineList) {\n+\n+    if (ObjectUtils.isEmpty(invoiceLineList)) {\n+      return false;\n+    }\n+    for (InvoiceLine invoiceLine : invoiceLineList) {\n+      if (invoiceLine.getTypeSelect() == InvoiceLineRepository.TYPE_START_OF_PACK\n+          && invoiceLine.getId() != null) {\n+        InvoiceLine oldInvoiceLine = invoiceLineRepo.find(invoiceLine.getId());\n+        if (oldInvoiceLine.getTypeSelect() == InvoiceLineRepository.TYPE_START_OF_PACK\n+            && invoiceLine.getQty().compareTo(oldInvoiceLine.getQty()) != 0) {\n+          return true;\n+        }\n+      }\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public InvoiceLine updateProductQty(\n+      InvoiceLine invoiceLine, Invoice invoice, BigDecimal oldQty, BigDecimal newQty, int scale) {", "originalCommit": "44b696acf9a256cb1fa8caa62a14132c2efa470b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a76e2880e47f34ef36bb2cd425c7bedde0fefd97", "url": "https://github.com/axelor/axelor-open-suite/commit/a76e2880e47f34ef36bb2cd425c7bedde0fefd97", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-22T10:33:32Z", "type": "forcePushed"}, {"oid": "a82f6e076e875fc6e4d206f5795f681ca4c2322e", "url": "https://github.com/axelor/axelor-open-suite/commit/a82f6e076e875fc6e4d206f5795f681ca4c2322e", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-23T09:40:15Z", "type": "forcePushed"}, {"oid": "a3170e611eb3cdc2ec78b6d0cf097e17a5cfef27", "url": "https://github.com/axelor/axelor-open-suite/commit/a3170e611eb3cdc2ec78b6d0cf097e17a5cfef27", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-26T11:51:15Z", "type": "forcePushed"}, {"oid": "7369631c6011ac0dde28801beedc9022ed4c7777", "url": "https://github.com/axelor/axelor-open-suite/commit/7369631c6011ac0dde28801beedc9022ed4c7777", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-27T12:49:39Z", "type": "forcePushed"}, {"oid": "29c9495df30fd98165dbd54b2330a762539067f4", "url": "https://github.com/axelor/axelor-open-suite/commit/29c9495df30fd98165dbd54b2330a762539067f4", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-28T11:16:19Z", "type": "forcePushed"}, {"oid": "5952969009d9a2e07ede6fb5af3dcd7808a75045", "url": "https://github.com/axelor/axelor-open-suite/commit/5952969009d9a2e07ede6fb5af3dcd7808a75045", "message": "Feature #23592: Pack (3)", "committedDate": "2020-10-29T06:40:42Z", "type": "forcePushed"}, {"oid": "f751626cfdb34a81f33c9bd0d284ff633a2b1d68", "url": "https://github.com/axelor/axelor-open-suite/commit/f751626cfdb34a81f33c9bd0d284ff633a2b1d68", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-02T11:47:00Z", "type": "forcePushed"}, {"oid": "15b8e735a566ff50749a62e50d97a6ba9a73a598", "url": "https://github.com/axelor/axelor-open-suite/commit/15b8e735a566ff50749a62e50d97a6ba9a73a598", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-03T05:16:47Z", "type": "forcePushed"}, {"oid": "5adc9fd84c67f4e3df6511bc0a95e357774b4324", "url": "https://github.com/axelor/axelor-open-suite/commit/5adc9fd84c67f4e3df6511bc0a95e357774b4324", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-05T06:30:57Z", "type": "forcePushed"}, {"oid": "d26fd0f85331176b63f8ea7cf86d104db69ef57e", "url": "https://github.com/axelor/axelor-open-suite/commit/d26fd0f85331176b63f8ea7cf86d104db69ef57e", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-06T06:16:08Z", "type": "forcePushed"}, {"oid": "9b61906812fda875a0879798b1d82265c466bed8", "url": "https://github.com/axelor/axelor-open-suite/commit/9b61906812fda875a0879798b1d82265c466bed8", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-10T05:55:27Z", "type": "forcePushed"}, {"oid": "f328790c83b18b87632b51e13c9e496c280bbb8a", "url": "https://github.com/axelor/axelor-open-suite/commit/f328790c83b18b87632b51e13c9e496c280bbb8a", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-10T11:24:19Z", "type": "forcePushed"}, {"oid": "cc4b23b9aaa3ba7636b4d10c39ed5d7d58f444d9", "url": "https://github.com/axelor/axelor-open-suite/commit/cc4b23b9aaa3ba7636b4d10c39ed5d7d58f444d9", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-12T06:33:03Z", "type": "forcePushed"}, {"oid": "2eb4103872a6ec4eae7b8133360d266c94902a0f", "url": "https://github.com/axelor/axelor-open-suite/commit/2eb4103872a6ec4eae7b8133360d266c94902a0f", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-24T09:30:01Z", "type": "forcePushed"}, {"oid": "3a93f9c9882a61e4bfb729a73c0e25af993c2e3a", "url": "https://github.com/axelor/axelor-open-suite/commit/3a93f9c9882a61e4bfb729a73c0e25af993c2e3a", "message": "Feature #23592: Pack (3)", "committedDate": "2020-11-30T12:13:13Z", "type": "forcePushed"}, {"oid": "0d20766010a3011feb0a373be687ad34c9253042", "url": "https://github.com/axelor/axelor-open-suite/commit/0d20766010a3011feb0a373be687ad34c9253042", "message": "Feature #23592: Pack (3)", "committedDate": "2020-12-03T13:37:17Z", "type": "commit"}, {"oid": "0d20766010a3011feb0a373be687ad34c9253042", "url": "https://github.com/axelor/axelor-open-suite/commit/0d20766010a3011feb0a373be687ad34c9253042", "message": "Feature #23592: Pack (3)", "committedDate": "2020-12-03T13:37:17Z", "type": "forcePushed"}]}