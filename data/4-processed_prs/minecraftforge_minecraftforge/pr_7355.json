{"pr_number": 7355, "pr_title": "[1.16.x] Add event for player changing game mode", "pr_createdAt": "2020-09-25T06:21:42Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355", "timeline": [{"oid": "067562c67ff60d530609e1373150bb610d4ed211", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/067562c67ff60d530609e1373150bb610d4ed211", "message": "Added PlayerChangeGameModeEvent to allow better detection of changes in game mode", "committedDate": "2020-09-25T05:48:12Z", "type": "commit"}, {"oid": "ebb014bb4bdec51c165415b8381a66be7015ec85", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ebb014bb4bdec51c165415b8381a66be7015ec85", "message": "Add test mod", "committedDate": "2020-09-25T05:48:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNzA0Mg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r494817042", "bodyText": "This \"via\" info makes no sense, the event docs are in need of changes and new events should not follow the existing guides.\nYou should describe when the event fires, not which method is responsible for it.", "author": "diesieben07", "createdAt": "2020-09-25T08:02:52Z", "path": "src/main/java/net/minecraftforge/event/entity/player/PlayerEvent.java", "diffHunk": "@@ -510,4 +511,30 @@ public PlayerChangedDimensionEvent(PlayerEntity player, RegistryKey<World> fromD\n             return this.toDim;\n         }\n     }\n+\n+    /**\n+     * On the server side fired when any player has their game mode changed via {@link net.minecraft.server.management.PlayerInteractionManager#setGameType(GameType)}.", "originalCommit": "ebb014bb4bdec51c165415b8381a66be7015ec85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNzEzMQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r494817131", "bodyText": "Formatting (braces on newlines)", "author": "diesieben07", "createdAt": "2020-09-25T08:03:03Z", "path": "src/main/java/net/minecraftforge/event/entity/player/PlayerEvent.java", "diffHunk": "@@ -510,4 +511,30 @@ public PlayerChangedDimensionEvent(PlayerEntity player, RegistryKey<World> fromD\n             return this.toDim;\n         }\n     }\n+\n+    /**\n+     * On the server side fired when any player has their game mode changed via {@link net.minecraft.server.management.PlayerInteractionManager#setGameType(GameType)}.\n+     * On the client side fired when only when the client player changes their game mode.\n+     */\n+    public static class PlayerChangeGameModeEvent extends PlayerEvent {", "originalCommit": "ebb014bb4bdec51c165415b8381a66be7015ec85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgyMDc5OQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r494820799", "bodyText": "Formatting (don't change indentation)\nExtract this logic into the ForgeHooks method, that's what its there for. You can have this be a much simpler patch by doing:\nthis.gameType = ForgeHooks.onClientChangeGameType(gameMode, this.gameType, ...)", "author": "diesieben07", "createdAt": "2020-09-25T08:09:58Z", "path": "patches/minecraft/net/minecraft/client/network/play/NetworkPlayerInfo.java.patch", "diffHunk": "@@ -0,0 +1,13 @@\n+--- a/net/minecraft/client/network/play/NetworkPlayerInfo.java\n++++ b/net/minecraft/client/network/play/NetworkPlayerInfo.java\n+@@ -50,7 +50,9 @@\n+    }\n+ \n+    protected void func_178839_a(GameType p_178839_1_) {\n+-      this.field_178866_b = p_178839_1_;\n++       GameType oldGameType = this.field_178866_b;\n++       this.field_178866_b = p_178839_1_;\n++       if(Minecraft.func_71410_x().field_71439_g != null && this.field_178867_a.getId().equals(Minecraft.func_71410_x().field_71439_g.func_110124_au())) net.minecraftforge.common.ForgeHooks.onChangeGameMode(Minecraft.func_71410_x().field_71439_g, p_178839_1_, oldGameType);", "originalCommit": "ebb014bb4bdec51c165415b8381a66be7015ec85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf0baabacc30394c0da61d2f157198e675d5b408", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/cf0baabacc30394c0da61d2f157198e675d5b408", "message": "Added client game mode event and made server event cancellable", "committedDate": "2020-09-25T20:34:55Z", "type": "commit"}, {"oid": "f68aa0807902497bfa3199aac56488c33ad55a5f", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/f68aa0807902497bfa3199aac56488c33ad55a5f", "message": "Update test mod", "committedDate": "2020-09-25T20:35:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjAyNQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495556025", "bodyText": "Indentation still wrong. Also missing space after if.\nAlso, my point of separating client and server event was so that you can fire the event on the client always, by not including the PlayerEntity.", "author": "diesieben07", "createdAt": "2020-09-27T10:13:46Z", "path": "patches/minecraft/net/minecraft/client/network/play/NetworkPlayerInfo.java.patch", "diffHunk": "@@ -0,0 +1,12 @@\n+--- a/net/minecraft/client/network/play/NetworkPlayerInfo.java\n++++ b/net/minecraft/client/network/play/NetworkPlayerInfo.java\n+@@ -50,7 +50,8 @@\n+    }\n+ \n+    protected void func_178839_a(GameType p_178839_1_) {\n+-      this.field_178866_b = p_178839_1_;\n++       if(Minecraft.func_71410_x().field_71439_g != null && this.field_178867_a.getId().equals(Minecraft.func_71410_x().field_71439_g.func_110124_au()) && this.field_178866_b != p_178839_1_) net.minecraftforge.common.ForgeHooks.onClientChangeGameMode(Minecraft.func_71410_x().field_71439_g, this.field_178866_b, p_178839_1_);\n++       this.field_178866_b = p_178839_1_;", "originalCommit": "f68aa0807902497bfa3199aac56488c33ad55a5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5OTg1NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495599854", "bodyText": "When the event is fired client side without the player check there are two problems:\n\nThe event is fired for all other tracked players of the local client. If a player is too far away it won't be fired.\nOut of the tracked players only the ones not in spectator are fired. If another player comes out of spectator mode the local client won't know about the change and the event is not fired.\nSometimes neither of these conditions are met and the event still fires.\nA reliable alternative is to just have the mod send a packet to the client about their mod specific status updates. Because the server knows about all players, the mod dev can control the scope of the event.\n\nBy adding the player, the goal is to add consistent results for when the event is fired.", "author": "Ocelot5836", "createdAt": "2020-09-27T18:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMDg3Nw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495600877", "bodyText": "That is not true. The packet is sent to all players.\nHave you actually verified these claims you are making?", "author": "diesieben07", "createdAt": "2020-09-27T18:28:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMzM4Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495603383", "bodyText": "I just redid me experiment and found different results. I think it may have been due to poor placement of one of the patches but my claims are not true. All players are always notified of all game mode changes, even for players they have never or currently cannot see.", "author": "Ocelot5836", "createdAt": "2020-09-27T18:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjAzOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495556039", "bodyText": "Formatting, space after if.", "author": "diesieben07", "createdAt": "2020-09-27T10:14:02Z", "path": "patches/minecraft/net/minecraft/entity/player/ServerPlayerEntity.java.patch", "diffHunk": "@@ -130,15 +130,23 @@\n     }\n  \n     protected void func_70670_a(EffectInstance p_70670_1_) {\n-@@ -1187,6 +1208,7 @@\n+@@ -1139,6 +1160,7 @@\n+    }\n+ \n+    public void func_71033_a(GameType p_71033_1_) {\n++      if(!net.minecraftforge.common.ForgeHooks.onChangeGameMode(this, this.field_71134_c.func_73081_b(), p_71033_1_)) return;", "originalCommit": "f68aa0807902497bfa3199aac56488c33ad55a5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU1NjE2Mg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r495556162", "bodyText": "I have no idea what you mean to say with this sentence. \"changed to a unique value\"? And what listeners are you talking about?\nYou also need to add a note about what happens when the event is cancelled.", "author": "diesieben07", "createdAt": "2020-09-27T10:15:06Z", "path": "src/main/java/net/minecraftforge/event/entity/player/PlayerEvent.java", "diffHunk": "@@ -510,4 +511,65 @@ public PlayerChangedDimensionEvent(PlayerEntity player, RegistryKey<World> fromD\n             return this.toDim;\n         }\n     }\n+\n+    /**\n+     * Fired when the game type of a server player is changed to a unique value before listeners are fired.", "originalCommit": "f68aa0807902497bfa3199aac56488c33ad55a5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "19a1e19fc6398f86a2665b965ecde97832d6f684", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/19a1e19fc6398f86a2665b965ecde97832d6f684", "message": "Fixed patch formatting", "committedDate": "2020-09-27T18:47:33Z", "type": "commit"}, {"oid": "0be573d6b18323acf2d2675bed9e738839a1f54b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/0be573d6b18323acf2d2675bed9e738839a1f54b", "message": "Updated documentation", "committedDate": "2020-09-27T18:47:40Z", "type": "commit"}, {"oid": "96949d8a3918acdcc20c3371c7b62d446fab72cf", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/96949d8a3918acdcc20c3371c7b62d446fab72cf", "message": "Client change game mode event now fires for all players", "committedDate": "2020-09-27T19:12:25Z", "type": "commit"}, {"oid": "cf1c50c10031a0fc5666b61f96b6a2306e1d13be", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/cf1c50c10031a0fc5666b61f96b6a2306e1d13be", "message": "Updated patches", "committedDate": "2020-09-27T19:13:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMzODI0Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7355#discussion_r497338243", "bodyText": "You have not fixed this.", "author": "diesieben07", "createdAt": "2020-09-30T08:36:45Z", "path": "patches/minecraft/net/minecraft/entity/player/ServerPlayerEntity.java.patch", "diffHunk": "@@ -130,15 +130,23 @@\n     }\n  \n     protected void func_70670_a(EffectInstance p_70670_1_) {\n-@@ -1187,6 +1208,7 @@\n+@@ -1139,6 +1160,7 @@\n+    }\n+ \n+    public void func_71033_a(GameType p_71033_1_) {\n++      if(!net.minecraftforge.common.ForgeHooks.onChangeGameMode(this, this.field_71134_c.func_73081_b(), p_71033_1_)) return;", "originalCommit": "cf1c50c10031a0fc5666b61f96b6a2306e1d13be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bce13f1e6bc2b6540e8896a330d67bc046fb4c18", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/bce13f1e6bc2b6540e8896a330d67bc046fb4c18", "message": "Learned how to press the space bar", "committedDate": "2020-10-01T04:22:01Z", "type": "commit"}, {"oid": "15d3aae444f4b5d8f9fea216445b1f3006fa4f5b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/15d3aae444f4b5d8f9fea216445b1f3006fa4f5b", "message": "Disabled test mod", "committedDate": "2020-10-15T05:11:34Z", "type": "commit"}, {"oid": "933c2d96888273444997de9b524085eaac362cb7", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/933c2d96888273444997de9b524085eaac362cb7", "message": "Merge branch '1.16.x' into change_gamemode_event", "committedDate": "2020-10-15T17:14:49Z", "type": "commit"}]}