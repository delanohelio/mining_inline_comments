{"pr_number": 6545, "pr_title": "Defer writing the server.properties file until after mods have loaded", "pr_createdAt": "2020-03-03T16:50:36Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545", "timeline": [{"oid": "34e86e089e261bc8504494c6a02666fa38820178", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/34e86e089e261bc8504494c6a02666fa38820178", "message": "Defers writing the server.properties to file until after mods have had a chance to load/register their world-types etc", "committedDate": "2020-03-03T15:59:07Z", "type": "commit"}, {"oid": "77a55ae3180a22ee698d7395ec800a9fd2a4d992", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/77a55ae3180a22ee698d7395ec800a9fd2a4d992", "message": "Also save after 'invalid world' to keep in-line with vanilla", "committedDate": "2020-03-03T16:47:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE1OTAxMw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387159013", "bodyText": "Import in patch file. It's not even used.", "author": "bl4ckscor3", "createdAt": "2020-03-03T16:56:31Z", "path": "patches/minecraft/net/minecraft/server/dedicated/DedicatedServer.java.patch", "diffHunk": "@@ -1,46 +1,56 @@\n --- a/net/minecraft/server/dedicated/DedicatedServer.java\n +++ b/net/minecraft/server/dedicated/DedicatedServer.java\n-@@ -97,6 +97,7 @@\n+@@ -15,6 +15,7 @@\n+ import java.net.InetAddress;\n+ import java.net.Proxy;\n+ import java.nio.charset.StandardCharsets;\n++import java.nio.file.Paths;", "originalCommit": "77a55ae3180a22ee698d7395ec800a9fd2a4d992", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Mzg2NQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387193865", "bodyText": "It's used on line 25", "author": "dags-", "createdAt": "2020-03-03T17:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE1OTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5NzE4Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387197186", "bodyText": "Sorry, I missed that. Either way, patches shouldn't contain imports. You should always directly reference a class in patches, if it's not already imported, to minimize patch size. So line 25 needs to be this.field_71340_o.func_219033_a(properties -> ServerProperties.func_218985_a(java.nio.file.Paths.get(\"server.properties\")));", "author": "bl4ckscor3", "createdAt": "2020-03-03T18:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE1OTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5NzUxOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387197519", "bodyText": "Regardless of if it\u2019s used or not, patch files should NEVER have imports, always use Fully Qualified Names instead.", "author": "DaemonUmbra", "createdAt": "2020-03-03T18:03:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE1OTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5ODYxMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387198610", "bodyText": "Okedoke, thanks for clarifying", "author": "dags-", "createdAt": "2020-03-03T18:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE1OTAxMw=="}], "type": "inlineReview"}, {"oid": "1949cb65184e721022295ad0f43fb9395c2e3a94", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1949cb65184e721022295ad0f43fb9395c2e3a94", "message": "use fully qualified class name instead of import", "committedDate": "2020-03-03T18:21:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1MTM4Mg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387251382", "bodyText": "Am I correct in thinking that this wipes any changes to the properties if you have forgotten to accept the EULA (which I always forget to do)?\nSorry, it's a bit hard to read patch files on my phone, so I could be wrong about it, but I would rather it didn't affect the file if the EULA hasn't been accepted. Otherwise there's a risk that you change some settings, run the server, accept the EULA then re-run expecting your changed settings to apply and they won't.", "author": "Alpvax", "createdAt": "2020-03-03T19:43:22Z", "path": "patches/minecraft/net/minecraft/server/MinecraftServer.java.patch", "diffHunk": "@@ -172,26 +172,45 @@\n  \n        try {\n           OptionSet optionset = optionparser.parse(p_main_0_);\n-@@ -910,6 +935,10 @@\n+@@ -888,15 +913,16 @@\n+ \n+          Path path = Paths.get(\"server.properties\");\n+          ServerPropertiesProvider serverpropertiesprovider = new ServerPropertiesProvider(path);\n+-         serverpropertiesprovider.func_219035_b();\n+          Path path1 = Paths.get(\"eula.txt\");\n+          ServerEula servereula = new ServerEula(path1);\n+          if (optionset.has(optionspec1)) {\n++            serverpropertiesprovider.func_219035_b();\n+             field_147145_h.info(\"Initialized '\" + path.toAbsolutePath().toString() + \"' and '\" + path1.toAbsolutePath().toString() + \"'\");\n+             return;\n+          }\n+ \n+          if (!servereula.func_154346_a()) {\n++            serverpropertiesprovider.func_219035_b();", "originalCommit": "1949cb65184e721022295ad0f43fb9395c2e3a94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2MjMzNg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387262336", "bodyText": "It'd behave the same as the unmodified code does now; reset the level-type property to default if it was set to anything non-vanilla.\nOther properties (providing they're valid) would remain as you configured them.", "author": "dags-", "createdAt": "2020-03-03T20:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1MTM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUwNzA3Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387507073", "bodyText": "Could we not leave this out?\nIt would decrease the patch size, leave user changes intact, and any invalid settings would be corrected next run.", "author": "Alpvax", "createdAt": "2020-03-04T08:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1MTM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUxNzk3NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387517974", "bodyText": "I'd assume that for most people's first run of a server there wouldn't be a server.properties file and they'd expect it to be generated. I realise that's technically what the init flag is for but this has been the behaviour since I can remember.\nA better solution would probably be to check if the file exists before deciding whether to write it or not, but would increase the patch size by a couple of lines rather than decrease it - not sure how much of a concern that would be.", "author": "dags-", "createdAt": "2020-03-04T08:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1MTM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU0ODc1Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387548756", "bodyText": "Yeah, wasn't really thinking about that, it probably should be generated even if the EULA hasn't been accepted. For some reason I was thinking that the file was already there, when in most cases it wouldn't be.", "author": "Alpvax", "createdAt": "2020-03-04T09:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1MTM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzODEwNA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387638104", "bodyText": "I think this should definitely not be here anymore, because if it didn't exist it would have been created by the line above, but if it didn't it shouldn't be overwritten just because the EULA isn't accepted.\nEDIT: Either I misread the patch or it didn't display correctly on my phone, I thought this line was still being added in addition to the if exist change.", "author": "Alpvax", "createdAt": "2020-03-04T12:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1MTM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczNTM0Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r387735343", "bodyText": "This is outdated, please see 2513a10.", "author": "dags-", "createdAt": "2020-03-04T15:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1MTM4Mg=="}], "type": "inlineReview"}, {"oid": "2513a10bc28a9c97814676832fa158cc5d68a9d9", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2513a10bc28a9c97814676832fa158cc5d68a9d9", "message": "Only do the early write to file if it doesn't already exist or the user has provided the initSettings flag", "committedDate": "2020-03-04T10:38:47Z", "type": "commit"}, {"oid": "e5ae1d7bca706b97decc8cce03c3025b2433beb8", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/e5ae1d7bca706b97decc8cce03c3025b2433beb8", "message": "Further reduce patch size by checking for the initSettings flag in the same line as File.exists, rather than adding a second properties.save call", "committedDate": "2020-03-16T10:58:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODEyOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r399578129", "bodyText": "Typically we just inject the IF above the line so the patch file doesn't have a removal line.", "author": "LexManos", "createdAt": "2020-03-27T23:13:14Z", "path": "patches/minecraft/net/minecraft/server/MinecraftServer.java.patch", "diffHunk": "@@ -172,6 +172,15 @@\n  \n        try {\n           OptionSet optionset = optionparser.parse(p_main_0_);\n+@@ -888,7 +913,7 @@\n+ \n+          Path path = Paths.get(\"server.properties\");\n+          ServerPropertiesProvider serverpropertiesprovider = new ServerPropertiesProvider(path);\n+-         serverpropertiesprovider.func_219035_b();\n++         if (optionset.has(optionspec1) || !Files.exists(path)) serverpropertiesprovider.func_219035_b();", "originalCommit": "e5ae1d7bca706b97decc8cce03c3025b2433beb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0MzkyOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6545#discussion_r399643929", "bodyText": "Noted, thanks", "author": "dags-", "createdAt": "2020-03-28T09:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU3ODEyOQ=="}], "type": "inlineReview"}]}