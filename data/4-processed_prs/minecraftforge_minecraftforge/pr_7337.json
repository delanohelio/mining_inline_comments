{"pr_number": 7337, "pr_title": "Fix modded EntityClassifications", "pr_createdAt": "2020-09-17T20:18:59Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337", "timeline": [{"oid": "23c438e15ed6e53a2154b3ce5edadf417d76af98", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/23c438e15ed6e53a2154b3ce5edadf417d76af98", "message": "Rebuilt entity classification map after init", "committedDate": "2020-09-17T20:12:06Z", "type": "commit"}, {"oid": "02f772d8dd8fc43bdc7cb55ac9b52e1844bab6d2", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/02f772d8dd8fc43bdc7cb55ac9b52e1844bab6d2", "message": "Improve implementation", "committedDate": "2020-09-17T21:16:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyOTE1MQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337#discussion_r493829151", "bodyText": "I have my doubts if this second line is actually needed as the Codec seems to reference Enum#values and not the cached VALUES_MAP.", "author": "pupnewfster", "createdAt": "2020-09-23T19:02:58Z", "path": "patches/minecraft/net/minecraft/entity/EntityClassification.java.patch", "diffHunk": "@@ -9,13 +9,20 @@\n     MONSTER(\"monster\", 70, false, false, 128),\n     CREATURE(\"creature\", 10, true, true, 128),\n     AMBIENT(\"ambient\", 15, true, false, 128),\n-@@ -57,6 +57,10 @@\n+@@ -57,6 +57,17 @@\n        return this.field_82707_i;\n     }\n  \n +   public static EntityClassification create(String name, String id, int maxNumberOfCreatureIn, boolean isPeacefulCreatureIn, boolean isAnimalIn, int despawnDistance) {\n +      throw new IllegalStateException(\"Enum not extended\");\n +   }\n++\n++   @Override\n++   @Deprecated\n++   public void init() {\n++      field_220364_f.put(this.field_220365_j, this);\n++      field_233667_g_ = IStringSerializable.func_233023_a_(EntityClassification::values, EntityClassification::func_233670_a_);", "originalCommit": "02f772d8dd8fc43bdc7cb55ac9b52e1844bab6d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgzMDk0NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337#discussion_r493830944", "bodyText": "yes but it caches it instantly. so a better way might be to change that simply (in IStringSerializable). remove the first line and do .get() on the function directly.", "author": "Cyborgmas", "createdAt": "2020-09-23T19:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyOTE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NTE2Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337#discussion_r493875163", "bodyText": "the latter would probably be the better solution as it would also resolve this for other extensible enums that use this (currently only net.minecraft.world.gen.feature.jigsaw.JigsawPattern.PlacementBehaviour though).\nBut it is more \"intrusive\", although I can't see any issues on first sight/test), I am not going to make that call", "author": "maxanier", "createdAt": "2020-09-23T20:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyOTE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3OTM3Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337#discussion_r493879373", "bodyText": "Makeing the codec a public non-final is a non-starter.\nPerhaps the better solution would be to introduce a new codec type for extensible enums?\nAnd then change the codec to use that instead of the default enum one.\nOr, we could change the default enum one {if its in MC code} to not cache the values.\nEither option is better then letting all modders change the entire codec object willy nilly.", "author": "LexManos", "createdAt": "2020-09-23T20:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyOTE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNjI5Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337#discussion_r493906293", "bodyText": "ok, removed the caching as Cybogmas suggested, but just for the two enums that are IExtensibleEnum", "author": "maxanier", "createdAt": "2020-09-23T21:29:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyOTE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyOTY1NQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337#discussion_r493829655", "bodyText": "For future reference (or if I am wrong about modifying the codec being wrong), when you modify the access transformer file you should run the checkATs task as it orders things alphabetically and entity should be way before world.", "author": "pupnewfster", "createdAt": "2020-09-23T19:03:55Z", "path": "src/main/resources/META-INF/accesstransformer.cfg", "diffHunk": "@@ -315,4 +315,5 @@ public net.minecraft.world.gen.layer.LayerUtil func_202829_a(JLnet/minecraft/wor\n private-f net.minecraft.world.raid.Raid$WaveMember field_221284_f # VALUES\n public net.minecraft.world.server.ServerChunkProvider field_186029_c # chunkGenerator\n public net.minecraft.world.server.ServerChunkProvider field_73251_h # worldObj\n-public net.minecraft.world.storage.FolderName <init>(Ljava/lang/String;)V # constructor\n\\ No newline at end of file\n+public net.minecraft.world.storage.FolderName <init>(Ljava/lang/String;)V # constructor\n+public-f net.minecraft.entity.EntityClassification field_233667_g_ # CODEC", "originalCommit": "02f772d8dd8fc43bdc7cb55ac9b52e1844bab6d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6af79388fb1689622ee63da18e16bda0b3f34d84", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/6af79388fb1689622ee63da18e16bda0b3f34d84", "message": "Reorder ATs", "committedDate": "2020-09-23T20:16:24Z", "type": "commit"}, {"oid": "874fe77c363f4f41b302f1712ff8105cb186be34", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/874fe77c363f4f41b302f1712ff8105cb186be34", "message": "Use non-caching setup for extended enum codec", "committedDate": "2020-09-23T21:27:19Z", "type": "commit"}, {"oid": "7b49624553a678fbb2413f8a7f0fe014a8bbf848", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7b49624553a678fbb2413f8a7f0fe014a8bbf848", "message": "Remove access transformer for codec", "committedDate": "2020-09-23T21:28:04Z", "type": "commit"}, {"oid": "9b04a184fddf2ee0a8012a5548a3f50859054414", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/9b04a184fddf2ee0a8012a5548a3f50859054414", "message": "Fix patch after AT change", "committedDate": "2020-09-23T21:34:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ5MjQ1Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7337#discussion_r497492453", "bodyText": "vanilla calls getName instead of using the raw field, we should mirror this (even though it shouldn't make a difference)", "author": "ichttt", "createdAt": "2020-09-30T13:04:37Z", "path": "patches/minecraft/net/minecraft/entity/EntityClassification.java.patch", "diffHunk": "@@ -9,13 +9,28 @@\n     MONSTER(\"monster\", 70, false, false, 128),\n     CREATURE(\"creature\", 10, true, true, 128),\n     AMBIENT(\"ambient\", 15, true, false, 128),\n-@@ -57,6 +57,10 @@\n+@@ -14,7 +14,7 @@\n+    WATER_AMBIENT(\"water_ambient\", 20, true, false, 64),\n+    MISC(\"misc\", -1, true, true, 128);\n+ \n+-   public static final Codec<EntityClassification> field_233667_g_ = IStringSerializable.func_233023_a_(EntityClassification::values, EntityClassification::func_233670_a_);\n++   public static final Codec<EntityClassification> field_233667_g_ = net.minecraftforge.common.IExtensibleEnum.createCodecForExtensibleEnum(EntityClassification::values, EntityClassification::func_233670_a_);\n+    private static final Map<String, EntityClassification> field_220364_f = Arrays.stream(values()).collect(Collectors.toMap(EntityClassification::func_220363_a, (p_220362_0_) -> {\n+       return p_220362_0_;\n+    }));\n+@@ -57,6 +57,16 @@\n        return this.field_82707_i;\n     }\n  \n +   public static EntityClassification create(String name, String id, int maxNumberOfCreatureIn, boolean isPeacefulCreatureIn, boolean isAnimalIn, int despawnDistance) {\n +      throw new IllegalStateException(\"Enum not extended\");\n +   }\n++\n++   @Override\n++   @Deprecated\n++   public void init() {\n++      field_220364_f.put(this.field_220365_j, this);", "originalCommit": "9b04a184fddf2ee0a8012a5548a3f50859054414", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2cb35101c3dfbb1b67bed5458af7c0d45062e812", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2cb35101c3dfbb1b67bed5458af7c0d45062e812", "message": "Use getter instead of direct field access", "committedDate": "2020-09-30T13:24:06Z", "type": "commit"}]}