{"pr_number": 6858, "pr_title": "[1.16] Replace EntityHeight event with EntitySize event", "pr_createdAt": "2020-06-27T13:56:12Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUyOTMzOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r446529339", "bodyText": "I am not sure about this part.\nThe old eyeHeight method was placed in the constructor as well, so I kept it here.\nHowever, I do not think this is ideal. If mods decide to change an entity's size/eyeHeight, they need something to base their decision upon. But at this point during entity construction neither capabilities nor held items nor anything else is available.\nThis means a) the event handler has to check if the entity is properly constructed and b) the mod has to trigger a size update anyway.\nOnly scenario this might be useful might be a mod which e.g. simply scales all cows to 200%. But that could also be done without the constructor patch, by just calling recalculateSize in EntityJoinWorld.\nTherefore, I would suggest removing this ugly patch, making it much easier to use.", "author": "maxanier", "createdAt": "2020-06-27T13:57:10Z", "path": "patches/minecraft/net/minecraft/entity/Entity.java.patch", "diffHunk": "@@ -31,18 +31,20 @@\n        this.field_200606_g = p_i48580_1_;\n        this.field_70170_p = p_i48580_2_;\n        this.field_213325_aI = p_i48580_1_.func_220334_j();\n-@@ -213,7 +216,9 @@\n+@@ -213,7 +216,11 @@\n        this.field_70180_af.func_187214_a(field_189655_aD, false);\n        this.field_70180_af.func_187214_a(field_213330_X, Pose.STANDING);\n        this.func_70088_a();\n -      this.field_213326_aJ = this.func_213316_a(Pose.STANDING, this.field_213325_aI);\n-+      this.field_213326_aJ = getEyeHeightForge(Pose.STANDING, this.field_213325_aI);\n++      net.minecraftforge.event.entity.EntityEvent.Size sizeEvent= getSizeForge(Pose.STANDING, this.field_213325_aI);", "originalCommit": "cc727280f8a6a966161d381f7747ea6c0f4ca08b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNDU0Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r447214546", "bodyText": "The issue is that we have to have SOME default value in the constructor or somewhere that is always called before any other methods in the entity is called because eyeHeight needs to be a sane value until the next time resize is called.", "author": "LexManos", "createdAt": "2020-06-29T19:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUyOTMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4Mjg2NQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r447282865", "bodyText": "I would simply use the vanilla methods for size and eyeHeight. Thereby they are at sane values, and if desired a mod can still force a size recalculation once the entity is fully constructed.", "author": "maxanier", "createdAt": "2020-06-29T22:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUyOTMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyNTcyNA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r446625724", "bodyText": "I think you can add a few newlines to make this patch more readable", "author": "ichttt", "createdAt": "2020-06-28T09:24:10Z", "path": "patches/minecraft/net/minecraft/entity/player/PlayerEntity.java.patch", "diffHunk": "@@ -43,23 +44,31 @@\n              this.func_225652_a_(false, true);\n           }\n        } else if (this.field_71076_b > 0) {\n-@@ -258,6 +262,7 @@\n+@@ -258,6 +263,7 @@\n        this.func_203041_m();\n        this.field_184832_bU.func_185144_a();\n        this.func_213832_dB();\n +      net.minecraftforge.fml.hooks.BasicEventHooks.onPlayerPostTick(this);\n     }\n  \n     public boolean func_226563_dT_() {\n-@@ -550,6 +555,7 @@\n+@@ -333,6 +339,7 @@\n+    }\n+ \n+    protected void func_213832_dB() {\n++      if(forcedPose!=null){this.func_213301_b(forcedPose);return;}", "originalCommit": "cc727280f8a6a966161d381f7747ea6c0f4ca08b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3NzU1Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r446677556", "bodyText": "Yeah. You should aim for conciseness in patches, but not to the degree of unreadability.", "author": "TheCurle", "createdAt": "2020-06-28T17:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyNTcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNjcwMw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r447216703", "bodyText": "honestly all of this should move to ForgeHooks/ForgeEvenntFadctory like all the other events instead of being special.", "author": "LexManos", "createdAt": "2020-06-29T19:55:31Z", "path": "patches/minecraft/net/minecraft/entity/Entity.java.patch", "diffHunk": "@@ -310,9 +316,9 @@\n +      this.reviveCaps();\n +   }\n +\n-+   private float getEyeHeightForge(Pose pose, EntitySize size) {\n-+      net.minecraftforge.event.entity.EntityEvent.EyeHeight evt = new net.minecraftforge.event.entity.EntityEvent.EyeHeight(this, pose, size, this.func_213316_a(pose, size));\n++   private net.minecraftforge.event.entity.EntityEvent.Size getSizeForge(Pose pose, EntitySize size) {", "originalCommit": "08c30d81f7e58d6404588fa299efc5f8d16ac188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4NDUzMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r447284530", "bodyText": "moved", "author": "maxanier", "createdAt": "2020-06-29T22:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNjcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNzI2MA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r447217260", "bodyText": "Why is this being forced at all? The data manager already syncs the pose, why add some backdoor to bypass it?", "author": "LexManos", "createdAt": "2020-06-29T19:56:32Z", "path": "patches/minecraft/net/minecraft/entity/player/PlayerEntity.java.patch", "diffHunk": "@@ -336,5 +348,9 @@\n +         else if (facing.func_176740_k().func_176722_c()) return playerEquipmentHandler.cast();\n +      }\n +      return super.getCapability(capability, facing);\n++   }\n++\n++   public void setForcedPose(@Nullable Pose pose) {", "originalCommit": "08c30d81f7e58d6404588fa299efc5f8d16ac188", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3OTcxOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r447279719", "bodyText": "Unfortunately, the player entity (re)determines the players pose every tick and thereby overrides any manually set pose.\nTo determine the current pose the PlayerEntity uses hardcoded sizes and therefore e.g. falls back to the swimming pose when the player is in a 1x1 space (where they fit because of actual entity size).\nIt is possible to override the value again right after that in the Post PlayerTickEvent, so the pose determined by vanilla does not affect rendering or game mechanics. However, every time the pose is changed notifyDataManagerChange calls recalculateSize causing an event to be posted.\nTherefore, without this \"backdoor\" the event would be posted twice every tick instead of not at all.\nIf you still prefer this, I can remove this patch.", "author": "maxanier", "createdAt": "2020-06-29T22:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNzI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2MjU2Nw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6858#discussion_r449462567", "bodyText": "You don't need to use fully qualified names here, just use EntityEvent.Size instead of net.minecraftforge.event.entity.EntityEvent.Size. Same in the line below", "author": "ichttt", "createdAt": "2020-07-03T08:52:07Z", "path": "src/main/java/net/minecraftforge/event/ForgeEventFactory.java", "diffHunk": "@@ -722,4 +724,11 @@ public static long onSleepFinished(ServerWorld world, long newTime, long minTime\n         MinecraftForge.EVENT_BUS.post(event);\n         return event.getNewTime();\n     }\n+\n+    public static net.minecraftforge.event.entity.EntityEvent.Size getEntitySizeForge(Entity player, Pose pose, EntitySize size, float eyeHeight)\n+    {\n+        net.minecraftforge.event.entity.EntityEvent.Size evt = new net.minecraftforge.event.entity.EntityEvent.Size(player, pose, size, eyeHeight);", "originalCommit": "78038dc78253a0f04e2389c7fb8c90fd4fff5915", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ca70e400198d83d221bc845b92b4cad26f24e77f", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ca70e400198d83d221bc845b92b4cad26f24e77f", "message": "Consider vanilla pose", "committedDate": "2020-08-02T11:55:42Z", "type": "forcePushed"}, {"oid": "7becd2416b6bb7878c79e07b78d1f20d29408790", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/7becd2416b6bb7878c79e07b78d1f20d29408790", "message": "Add patches", "committedDate": "2020-08-19T17:19:11Z", "type": "commit"}, {"oid": "4f4e32fac03bd63dbd5b8a88390d11c4998213ab", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4f4e32fac03bd63dbd5b8a88390d11c4998213ab", "message": "Add event", "committedDate": "2020-08-19T17:19:22Z", "type": "commit"}, {"oid": "4f4e32fac03bd63dbd5b8a88390d11c4998213ab", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4f4e32fac03bd63dbd5b8a88390d11c4998213ab", "message": "Add event", "committedDate": "2020-08-19T17:19:22Z", "type": "forcePushed"}]}