{"pr_number": 7428, "pr_title": "[1.16.x] Add loot table ID in Global Loot Modifiers", "pr_createdAt": "2020-10-22T14:35:02Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428", "timeline": [{"oid": "9d1fd6e310f3621103dc7e45554a7195d1e0d64b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/9d1fd6e310f3621103dc7e45554a7195d1e0d64b", "message": "Add working example of GLM that leverages ID\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2020-10-26T09:42:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NDM2MA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r511884360", "bodyText": "I would make this name a bit more unique perhaps, like forge:unknown or something", "author": "Cyborgmas", "createdAt": "2020-10-26T11:15:05Z", "path": "src/main/java/net/minecraftforge/common/loot/LootTableIdCondition.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Minecraft Forge\n+ * Copyright (c) 2016-2020.\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.common.loot;\n+\n+import com.google.gson.JsonDeserializationContext;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSerializationContext;\n+import net.minecraft.loot.ILootSerializer;\n+import net.minecraft.loot.LootConditionType;\n+import net.minecraft.loot.LootContext;\n+import net.minecraft.loot.conditions.ILootCondition;\n+import net.minecraft.loot.conditions.LootConditionManager;\n+import net.minecraft.util.JSONUtils;\n+import net.minecraft.util.ResourceLocation;\n+\n+public class LootTableIdCondition implements ILootCondition {\n+    public static final ResourceLocation UNKNOWN_LOOT_TABLE = new ResourceLocation(\"forge\", \"unknown\");", "originalCommit": "27e17823cc2256ec37739ffb47895d6e97c71340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NjUxNQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r511886515", "bodyText": "forge:unknown_loot_table?", "author": "TheSilkMiner", "createdAt": "2020-10-26T11:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NDM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NDk0Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r511884946", "bodyText": "braces { should be on new line for a forge class", "author": "Cyborgmas", "createdAt": "2020-10-26T11:16:11Z", "path": "src/main/java/net/minecraftforge/common/loot/LootTableIdCondition.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Minecraft Forge\n+ * Copyright (c) 2016-2020.\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.common.loot;\n+\n+import com.google.gson.JsonDeserializationContext;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSerializationContext;\n+import net.minecraft.loot.ILootSerializer;\n+import net.minecraft.loot.LootConditionType;\n+import net.minecraft.loot.LootContext;\n+import net.minecraft.loot.conditions.ILootCondition;\n+import net.minecraft.loot.conditions.LootConditionManager;\n+import net.minecraft.util.JSONUtils;\n+import net.minecraft.util.ResourceLocation;\n+\n+public class LootTableIdCondition implements ILootCondition {", "originalCommit": "27e17823cc2256ec37739ffb47895d6e97c71340", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NTUwNg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r511885506", "bodyText": "Not sure if this should be patched in? Probably better in ForgeMod or something no?", "author": "Cyborgmas", "createdAt": "2020-10-26T11:17:13Z", "path": "patches/minecraft/net/minecraft/loot/conditions/LootConditionManager.java.patch", "diffHunk": "@@ -0,0 +1,10 @@\n+--- a/net/minecraft/loot/conditions/LootConditionManager.java\n++++ b/net/minecraft/loot/conditions/LootConditionManager.java\n+@@ -24,6 +24,7 @@\n+    public static final LootConditionType field_237471_n_ = func_237475_a_(\"weather_check\", new WeatherCheck.Serializer());\n+    public static final LootConditionType field_237472_o_ = func_237475_a_(\"reference\", new Reference.Serializer());\n+    public static final LootConditionType field_237473_p_ = func_237475_a_(\"time_check\", new TimeCheck.Serializer());\n++   public static final LootConditionType LOOT_TABLE_ID = func_237475_a_(\"forge:loot_table_id\", new net.minecraftforge.common.loot.LootTableIdCondition.Serializer()); // FORGE", "originalCommit": "27e17823cc2256ec37739ffb47895d6e97c71340", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NzcyMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r511887720", "bodyText": "That could be an alternative solution, but since we don't have a registry for ILootConditions, when would be the best way to initialize it?\nMod constructor? In a new event for loot tables specifically?", "author": "TheSilkMiner", "createdAt": "2020-10-26T11:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NTUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg5ODE1OA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r511898158", "bodyText": "Oh right... well nvm then.", "author": "Cyborgmas", "createdAt": "2020-10-26T11:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NTUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwNDU4Ng==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r511904586", "bodyText": "I figured that vanilla registers them statically on bootup (-.-).\nI reworked the addition into an AT and I register the class statically when Forge is initialized. A nice side effect of this is that other mods can now register their own conditions without having to AT or reflect themselves.\nOf course, if an alternative ends up being available, like an event, the static init can be dropped in favor of the event.", "author": "TheSilkMiner", "createdAt": "2020-10-26T11:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4NTUwNg=="}], "type": "inlineReview"}, {"oid": "f3691f5215d62843a86b426db04a7f1de0a4b931", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/f3691f5215d62843a86b426db04a7f1de0a4b931", "message": "Expose ILootCondition registration and remove LCM patch\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2020-11-06T12:19:04Z", "type": "forcePushed"}, {"oid": "11c0572678ca6401e4b107a8aa913f06b460ac0c", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/11c0572678ca6401e4b107a8aa913f06b460ac0c", "message": "Expose ILootCondition registration and remove LCM patch\n\nThe loot condition type gets statically initialized only when\nregistering it, which in turn means it should work properly just fine in\nregards to registration order.\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2020-11-30T10:36:25Z", "type": "forcePushed"}, {"oid": "06c3ac4229e0e639710e176fcb777152738936e1", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/06c3ac4229e0e639710e176fcb777152738936e1", "message": "Expose ILootCondition registration and remove LCM patch\n\nThe loot condition type gets statically initialized only when\nregistering it, which in turn means it should work properly just fine in\nregards to registration order.\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2020-12-30T14:25:44Z", "type": "forcePushed"}, {"oid": "616b25e40ba7c4b6064041ae075c97a6b697a73d", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/616b25e40ba7c4b6064041ae075c97a6b697a73d", "message": "Expose ILootCondition registration and remove LCM patch\n\nThe loot condition type gets statically initialized only when\nregistering it, which in turn means it should work properly just fine in\nregards to registration order.\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2021-01-16T10:49:52Z", "type": "forcePushed"}, {"oid": "dfa91c1d0cc718325ff0deb3c7568c3e674514b8", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/dfa91c1d0cc718325ff0deb3c7568c3e674514b8", "message": "Allow loot table ID to be queried in GLMs\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2021-01-20T21:52:12Z", "type": "commit"}, {"oid": "4dded3f7b0dbd557bfb30da770fcafb9ffbeb524", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4dded3f7b0dbd557bfb30da770fcafb9ffbeb524", "message": "Add working example of GLM that leverages ID\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2021-01-20T21:52:27Z", "type": "commit"}, {"oid": "3d86194742f0ca55bd9bfa562a3d17c9d6a333f6", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/3d86194742f0ca55bd9bfa562a3d17c9d6a333f6", "message": "Expose ILootCondition registration and remove LCM patch\n\nThe loot condition type gets statically initialized only when\nregistering it, which in turn means it should work properly just fine in\nregards to registration order.\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2021-01-20T21:53:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODI3MzY5OQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r568273699", "bodyText": "Is this condition necessary?", "author": "gigaherz", "createdAt": "2021-02-02T02:11:44Z", "path": "patches/minecraft/net/minecraft/loot/LootTable.java.patch", "diffHunk": "@@ -59,6 +59,12 @@\n +         throw new RuntimeException(\"Attempted to modify LootTable after being finalized!\");\n +   }\n +\n++   private ResourceLocation lootTableId;\n++   public void setLootTableId(final ResourceLocation id) {\n++      if (this.lootTableId == null && id != null) this.lootTableId = id;", "originalCommit": "3d86194742f0ca55bd9bfa562a3d17c9d6a333f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQ3NDk5NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r568474994", "bodyText": "Not necessary, but more so as a failsafe. This way a malicious mod cannot alter the name of the loot table after it has been loaded, preventing weird and hard to track down issues with desyncs between what vanilla thinks and what loot modifiers perceive.", "author": "TheSilkMiner", "createdAt": "2021-02-02T10:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODI3MzY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODUwMjY4OA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r568502688", "bodyText": "I'm wondering then, if we should instead have a proper check.\n    if (this.lootTableId != null) throw new IllegalStateException(\"Loot table ID can not be set more than once.\");\n    this.lootTableId = Objects.requireNonNull(id);", "author": "gigaherz", "createdAt": "2021-02-02T10:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODI3MzY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODI3NjcxNQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r568276715", "bodyText": "This method feels out of place here. It should either be at the top after the constants, or below right before the Builder.", "author": "gigaherz", "createdAt": "2021-02-02T02:20:50Z", "path": "src/main/java/net/minecraftforge/common/loot/LootTableIdCondition.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Minecraft Forge\n+ * Copyright (c) 2016-2020.\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.common.loot;\n+\n+import com.google.gson.JsonDeserializationContext;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSerializationContext;\n+import net.minecraft.loot.ILootSerializer;\n+import net.minecraft.loot.LootConditionType;\n+import net.minecraft.loot.LootContext;\n+import net.minecraft.loot.conditions.ILootCondition;\n+import net.minecraft.util.JSONUtils;\n+import net.minecraft.util.ResourceLocation;\n+\n+public class LootTableIdCondition implements ILootCondition\n+{\n+    // TODO Forge Registry at some point?\n+    public static final LootConditionType LOOT_TABLE_ID = new LootConditionType(new LootTableIdCondition.Serializer());\n+    public static final ResourceLocation UNKNOWN_LOOT_TABLE = new ResourceLocation(\"forge\", \"unknown_loot_table\");\n+\n+    private final ResourceLocation targetLootTableId;\n+\n+    private LootTableIdCondition(final ResourceLocation targetLootTableId)\n+    {\n+        this.targetLootTableId = targetLootTableId;\n+    }\n+\n+    public static Builder builder(final ResourceLocation targetLootTableId)", "originalCommit": "3d86194742f0ca55bd9bfa562a3d17c9d6a333f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83bc838af322fecdf2db7469c27cc1517f181b84", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/83bc838af322fecdf2db7469c27cc1517f181b84", "message": "Expose ILootCondition registration and remove LCM patch\n\nThe loot condition type gets statically initialized only when\nregistering it, which in turn means it should work properly just fine in\nregards to registration order.\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2021-02-02T10:06:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODUxMzQ4Nw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7428#discussion_r568513487", "bodyText": "I guess after rebasing, it left an unintended change in this file?", "author": "gigaherz", "createdAt": "2021-02-02T11:03:46Z", "path": "src/main/resources/META-INF/accesstransformer.cfg", "diffHunk": "@@ -327,4 +327,4 @@ public net.minecraft.world.gen.treedecorator.TreeDecoratorType <init>(Lcom/mojan\n private-f net.minecraft.world.raid.Raid$WaveMember field_221284_f # VALUES\n public net.minecraft.world.server.ServerChunkProvider field_186029_c # chunkGenerator\n public net.minecraft.world.server.ServerChunkProvider field_73251_h # worldObj\n-public net.minecraft.world.storage.FolderName <init>(Ljava/lang/String;)V # constructor\n\\ No newline at end of file\n+public net.minecraft.world.storage.FolderName <init>(Ljava/lang/String;)V # constructor", "originalCommit": "83bc838af322fecdf2db7469c27cc1517f181b84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "061aa30cccda153c7002dc76710f74b611cf9697", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/061aa30cccda153c7002dc76710f74b611cf9697", "message": "Expose ILootCondition registration and remove LCM patch\n\nThe loot condition type gets statically initialized only when\nregistering it, which in turn means it should work properly just fine in\nregards to registration order.\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2021-02-02T12:15:05Z", "type": "commit"}, {"oid": "061aa30cccda153c7002dc76710f74b611cf9697", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/061aa30cccda153c7002dc76710f74b611cf9697", "message": "Expose ILootCondition registration and remove LCM patch\n\nThe loot condition type gets statically initialized only when\nregistering it, which in turn means it should work properly just fine in\nregards to registration order.\n\nSigned-off-by: TheSilkMiner <thesilkminer@outlook.com>", "committedDate": "2021-02-02T12:15:05Z", "type": "forcePushed"}]}