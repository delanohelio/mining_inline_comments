{"pr_number": 6515, "pr_title": "Add system for dimensions to be marked for deletion", "pr_createdAt": "2020-02-11T22:39:30Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515", "timeline": [{"oid": "6dc4453a696eed5c385c65facfa77db0dd6bd22d", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/6dc4453a696eed5c385c65facfa77db0dd6bd22d", "message": "Add system for dimensions to be marked for deletion, which will not remove them and their save-data from the save upon reload", "committedDate": "2020-02-11T22:36:09Z", "type": "commit"}, {"oid": "eb30f067f31b7d8588c6127617c6469b66cac848", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/eb30f067f31b7d8588c6127617c6469b66cac848", "message": "add debug mod", "committedDate": "2020-02-12T18:00:51Z", "type": "commit"}, {"oid": "8917dcf2de1b057d4f4326f3e1003e83108668b8", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/8917dcf2de1b057d4f4326f3e1003e83108668b8", "message": "fix testmod", "committedDate": "2020-02-12T19:36:40Z", "type": "commit"}, {"oid": "f8d0e0572d0e785ad3cedc9f34a6eed38853c3e4", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/f8d0e0572d0e785ad3cedc9f34a6eed38853c3e4", "message": "fix testmod and formatting", "committedDate": "2020-02-12T20:31:00Z", "type": "commit"}, {"oid": "6ed45d5c50accd93daafdd2fac21bd4377cd17e6", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/6ed45d5c50accd93daafdd2fac21bd4377cd17e6", "message": "clear folders to remove on load", "committedDate": "2020-02-12T20:32:01Z", "type": "commit"}, {"oid": "b7a62f39a431175e3c0f4d5ba88194be65e551ee", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/b7a62f39a431175e3c0f4d5ba88194be65e551ee", "message": "Remove unneeded method", "committedDate": "2020-02-12T20:32:22Z", "type": "commit"}, {"oid": "f8b0ed583235d3ab3250e81a44ad34f0e1c39134", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/f8b0ed583235d3ab3250e81a44ad34f0e1c39134", "message": "undo build.gradle update", "committedDate": "2020-02-12T20:33:26Z", "type": "commit"}, {"oid": "775c0caedb7d45683e1edeb8222cdb4009cca6c7", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/775c0caedb7d45683e1edeb8222cdb4009cca6c7", "message": "undo import changes", "committedDate": "2020-02-12T20:34:50Z", "type": "commit"}, {"oid": "23d7e8ed3a161835d2aec33b5aeaa5f2dfc1ae6e", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/23d7e8ed3a161835d2aec33b5aeaa5f2dfc1ae6e", "message": "undo testmod change", "committedDate": "2020-02-12T20:36:14Z", "type": "commit"}, {"oid": "ccbda2c8c3d5dc255c0f9383bbab9396dd184a11", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ccbda2c8c3d5dc255c0f9383bbab9396dd184a11", "message": "small testmod improvement", "committedDate": "2020-02-12T20:39:33Z", "type": "commit"}, {"oid": "634af8b0d945d3fb8dbc80be6acc3db0fbb58654", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/634af8b0d945d3fb8dbc80be6acc3db0fbb58654", "message": "Improve documentation", "committedDate": "2020-02-12T20:41:53Z", "type": "commit"}, {"oid": "3ec3d453589ba5369d4c6713e82d8548a1199e00", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/3ec3d453589ba5369d4c6713e82d8548a1199e00", "message": "improve testmod", "committedDate": "2020-02-12T22:42:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzU0OA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r379633548", "bodyText": "This is now how you get the current directory, we have FMLPaths which should have the supplied --gamedir paths.\nNothing in Minecrat should rely on the current execution directory directly. {Server's should set the gamedir to CWD if none is supplied}", "author": "LexManos", "createdAt": "2020-02-14T20:37:33Z", "path": "src/main/java/net/minecraftforge/common/DimensionManager.java", "diffHunk": "@@ -199,14 +209,49 @@ public static ServerWorld getWorld(MinecraftServer server, DimensionType dim, bo\n         return ret;\n     }\n \n+    /**\n+     * Marks the given dimension for deletion upon next reload of the save.\n+     * The corresponding data directory will be deleted as well.\n+     *\n+     * Note that the dimension need not be currently unloaded. The dimension will stay functioning as normal\n+     * until the save is reloaded.\n+     *\n+     * Vanilla dimensions are not supported and will throw an exception.\n+     *\n+     * @param dim the dimension to delete\n+     */\n+    public static void markForDeletion(DimensionType dim)\n+    {\n+        if (dim.isVanilla())\n+        {\n+            throw new IllegalArgumentException(\"Cannot delete vanilla dimensions.\");\n+        }\n+        getData(dim).markedForDeletion = true;\n+\n+        Path base = Paths.get(\".\").toAbsolutePath().normalize();", "originalCommit": "3ec3d453589ba5369d4c6713e82d8548a1199e00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1MjA2Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r379652063", "bodyText": "It doesn't matter what the path is. This is simply to check that the dimension returns a proper path, and get that path relative to the save root.\nI could use Paths.get(\"foobar\") as well.", "author": "diesieben07", "createdAt": "2020-02-14T21:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1MjMwNg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r379652306", "bodyText": "In fact --gamedir would be just as \"wrong\" here, it would have to be the save path, which is not available at this point, as far as I can tell.", "author": "diesieben07", "createdAt": "2020-02-14T21:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNDM1NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r379634354", "bodyText": "Is there a way we can add a confirmation screen similiar to the registry issues one?\nI don't like the idea of deleting files in bulk without atleast a confirmation.\nAlso, should filter this list with a folder.exists() so we don't warn we're deleting folders that are already gone.", "author": "LexManos", "createdAt": "2020-02-14T20:39:48Z", "path": "src/main/java/net/minecraftforge/common/DimensionManager.java", "diffHunk": "@@ -408,6 +457,31 @@ public static void readRegistry(CompoundNBT data)\n                 registerDimensionInternal(entry.id, entry.name, mod, entry.data == null ? null : new PacketBuffer(Unpooled.wrappedBuffer(entry.data)), entry.skyLight());\n             }\n         }\n+\n+        foldersScheduledForDeletion.clear();\n+\n+        ListNBT folderList = data.getList(\"delete_dirs\", Constants.NBT.TAG_STRING);\n+        folderList.stream()\n+                .map(INBT::getString)\n+                .forEach(foldersScheduledForDeletion::add);\n+    }\n+\n+    public static void processScheduledDeletions(SaveHandler saveHandler)", "originalCommit": "3ec3d453589ba5369d4c6713e82d8548a1199e00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNjMyNg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r379636326", "bodyText": "If that gets added then i'd want an option to opt out. The dimensions in my mod are supposed to be treated as scrappable timed items, not like registries. Would be very annoying to have that dialog every time you start the game again.\nI specifically warn players not to build in those dimensions and that they are timed.\nMaybe the markForDeletition() could by default add the warning but have another same method with a boolean overload?", "author": "RobertSkalko", "createdAt": "2020-02-14T20:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzODA2NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r379638064", "bodyText": "Then your mod setup is bad, Dimensions are large objects filled with user data. And should not be treated as lightweight trash objects.\nYou should rethink your design and see if its possible to get away with reusing the dimensions and just resetting the changes users do.", "author": "LexManos", "createdAt": "2020-02-14T20:49:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0MjE1NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r379642154", "bodyText": "I didn't mean treated as lightweight, i meant as something that shouldn't be saved.\nLike instances of dungeons in mmorpgs. And yes i did use workarounds while the system wasn't there in 1.13 but it wasn't as good as fresh dimensions. But i don't want to discuss workarounds in this PR, i can do that in discord if you need.", "author": "RobertSkalko", "createdAt": "2020-02-14T21:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU1NDg2Mg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6515#discussion_r393554862", "bodyText": "Pretty sure we talked about this on Discord, Your usecase is a bad one. Throwing away entire dimensions is not a good system.", "author": "LexManos", "createdAt": "2020-03-17T09:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNDM1NA=="}], "type": "inlineReview"}, {"oid": "99762bda50a586e81cf32301ef3d708f9b179877", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/99762bda50a586e81cf32301ef3d708f9b179877", "message": "Merge branch '1.15.x' into mark-dimension-for-deletion\n\n# Conflicts:\n#\tsrc/main/java/net/minecraftforge/common/DimensionManager.java", "committedDate": "2020-05-15T17:33:00Z", "type": "commit"}, {"oid": "9e6746b4d5abf6f6abcd275b524249a39155f0b4", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/9e6746b4d5abf6f6abcd275b524249a39155f0b4", "message": "Add startupquery before deleting dimensions", "committedDate": "2020-05-15T19:08:30Z", "type": "commit"}]}