{"pr_number": 6960, "pr_title": "Add dataprovider for Global Loot Modifiers", "pr_createdAt": "2020-07-12T03:05:09Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/6960", "timeline": [{"oid": "05738d659366d5b0bdf6f44a95df25b6a9dc112a", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/05738d659366d5b0bdf6f44a95df25b6a9dc112a", "message": "add datagen for GLM", "committedDate": "2020-07-12T02:37:44Z", "type": "commit"}, {"oid": "8d536760c5a9dd7c803a8999c5e6c6d6db327519", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/8d536760c5a9dd7c803a8999c5e6c6d6db327519", "message": "small fix", "committedDate": "2020-07-12T03:00:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI4ODYxMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6960#discussion_r453288610", "bodyText": "You should add a space after \"Modifiers\" because \"modid\" would stick on it.", "author": "MelanX", "createdAt": "2020-07-12T08:52:15Z", "path": "src/main/java/net/minecraftforge/common/data/GlobalLootModifierProvider.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package net.minecraftforge.common.data;\n+\n+import com.google.common.collect.Lists;\n+import com.google.gson.*;\n+import cpw.mods.modlauncher.api.LamdbaExceptionUtils;\n+import net.minecraft.data.DataGenerator;\n+import net.minecraft.data.DirectoryCache;\n+import net.minecraft.data.IDataProvider;\n+import net.minecraft.loot.conditions.ILootCondition;\n+import net.minecraft.loot.conditions.LootConditionManager;\n+import net.minecraft.loot.functions.ILootFunction;\n+import net.minecraft.loot.functions.LootFunctionManager;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.Tuple;\n+import net.minecraftforge.common.loot.GlobalLootModifierSerializer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+public abstract class GlobalLootModifierProvider implements IDataProvider\n+{\n+   private static final Logger LOGGER = LogManager.getLogger();\n+   private static final Gson GSON = (new GsonBuilder()).registerTypeHierarchyAdapter(ILootFunction.class, LootFunctionManager.func_237450_a_()).registerTypeHierarchyAdapter(ILootCondition.class, LootConditionManager.func_237474_a_()).setPrettyPrinting().create();\n+   private final DataGenerator gen;\n+   private final String modid;\n+   private final Map<String, Tuple<GlobalLootModifierSerializer<?>, List<ILootCondition>>> modifiers = new HashMap<>();\n+   private final Map<String, Consumer<JsonObject>> extraProperties = new HashMap<>();\n+   private boolean replace = false;\n+\n+   public GlobalLootModifierProvider(DataGenerator gen, String modid)\n+   {\n+      this.gen = gen;\n+      this.modid = modid;\n+   }\n+\n+   protected void replacing()\n+   {\n+      this.replace = true;\n+   }\n+\n+   /**\n+    * Call {@link #addModifier} here\n+    */\n+   protected abstract void start();\n+\n+   @Override\n+   public void act(DirectoryCache cache) throws IOException\n+   {\n+      start();\n+\n+      Path forge = gen.getOutputFolder().resolve(\"data/forge/loot_modifiers/global_loot_modifiers.json\");\n+      String modpath = \"data/\" + modid + \"/loot_modifiers/\";\n+      List<ResourceLocation> entries = new ArrayList<>();\n+\n+      modifiers.forEach(LamdbaExceptionUtils.rethrowBiConsumer((name, pair) ->\n+      {\n+         entries.add(new ResourceLocation(modid, name));\n+         Path modifierPath = gen.getOutputFolder().resolve(modpath + name + \".json\");\n+\n+         JsonObject json = new JsonObject();\n+         json.addProperty(\"type\", pair.getA().getRegistryName().toString());\n+         JsonArray conditions = new JsonArray();\n+         pair.getB().forEach(cond -> conditions.add(GSON.toJsonTree(cond)));\n+         json.add(\"conditions\", conditions);\n+\n+         Consumer<JsonObject> properties = extraProperties.get(name);\n+         if(properties != null)\n+            properties.accept(json);\n+\n+         IDataProvider.save(GSON, cache, json, modifierPath);\n+      }));\n+\n+      JsonObject forgeJson = new JsonObject();\n+      forgeJson.addProperty(\"replace\", this.replace);\n+      JsonArray modifiersArray = new JsonArray();\n+      entries.forEach(loc -> modifiersArray.add(loc.toString()));\n+      forgeJson.add(\"entries\", modifiersArray);\n+\n+      IDataProvider.save(GSON, cache, forgeJson, forge);\n+   }\n+\n+   public void addModifier(String modifier, GlobalLootModifierSerializer<?> serializer, List<ILootCondition> conditions)\n+   {\n+      addModifier(modifier, serializer, conditions, null);\n+   }\n+\n+   public void addModifier(String modifier, GlobalLootModifierSerializer<?> serializer, List<ILootCondition> conditions, @Nullable Consumer<JsonObject> extraProperties)\n+   {\n+      this.modifiers.put(modifier, new Tuple<>(serializer, conditions));\n+      this.extraProperties.put(modifier, extraProperties);\n+   }\n+\n+   @Override\n+   public String getName()\n+   {\n+      return \"Global Loot Modifiers\" + modid;", "originalCommit": "8d536760c5a9dd7c803a8999c5e6c6d6db327519", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8804ffce61c93cf4bca5635a14b74c3aaf4483c7", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/8804ffce61c93cf4bca5635a14b74c3aaf4483c7", "message": "Fix getName", "committedDate": "2020-07-12T11:25:58Z", "type": "commit"}, {"oid": "419f0e7f6aa704d98220cd6354e46fd2d3c16186", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/419f0e7f6aa704d98220cd6354e46fd2d3c16186", "message": "Use the new ConditionArraySerializer for conditions array instead", "committedDate": "2020-07-12T14:07:31Z", "type": "commit"}, {"oid": "d01e9dcd4b43722cf43f511ad60eb090c26e1514", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/d01e9dcd4b43722cf43f511ad60eb090c26e1514", "message": "cleaner json", "committedDate": "2020-07-12T14:17:51Z", "type": "commit"}, {"oid": "36450bd43eb092fc75fa76098a6de6d7b8f6b73b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/36450bd43eb092fc75fa76098a6de6d7b8f6b73b", "message": "Merge remote-tracking branch 'origin/GLM-datagen' into GLM-datagen", "committedDate": "2020-07-12T14:18:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyNjQwNg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6960#discussion_r457226406", "bodyText": "In Forge code we use 4 spaces for indentation, not 3", "author": "ichttt", "createdAt": "2020-07-20T09:39:27Z", "path": "src/main/java/net/minecraftforge/common/data/GlobalLootModifierProvider.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package net.minecraftforge.common.data;\n+\n+import com.google.common.collect.Lists;\n+import com.google.gson.*;\n+import cpw.mods.modlauncher.api.LamdbaExceptionUtils;\n+import net.minecraft.data.DataGenerator;\n+import net.minecraft.data.DirectoryCache;\n+import net.minecraft.data.IDataProvider;\n+import net.minecraft.loot.ConditionArraySerializer;\n+import net.minecraft.loot.conditions.ILootCondition;\n+import net.minecraft.loot.conditions.LootConditionManager;\n+import net.minecraft.loot.functions.ILootFunction;\n+import net.minecraft.loot.functions.LootFunctionManager;\n+import net.minecraft.util.ResourceLocation;\n+import net.minecraft.util.Tuple;\n+import net.minecraftforge.common.loot.GlobalLootModifierSerializer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public abstract class GlobalLootModifierProvider implements IDataProvider\n+{\n+   private static final Logger LOGGER = LogManager.getLogger();", "originalCommit": "36450bd43eb092fc75fa76098a6de6d7b8f6b73b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15f6bb292e6f29599c47780df0528a491af90ca5", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/15f6bb292e6f29599c47780df0528a491af90ca5", "message": "proper indent", "committedDate": "2020-07-20T12:55:56Z", "type": "commit"}, {"oid": "ed678991d97e71ac7338917a06e37938c2b57a6a", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ed678991d97e71ac7338917a06e37938c2b57a6a", "message": "Update GlobalLootModifierProvider.java", "committedDate": "2020-07-27T20:27:53Z", "type": "commit"}, {"oid": "1e467cd608b430cd240198a8984639214cf9641b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1e467cd608b430cd240198a8984639214cf9641b", "message": "add javadocs.", "committedDate": "2020-07-27T22:59:59Z", "type": "commit"}, {"oid": "8a909d053a03a48f0c46db522e62c852b12bec56", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/8a909d053a03a48f0c46db522e62c852b12bec56", "message": "Disabled the test mod.", "committedDate": "2020-07-27T23:05:21Z", "type": "commit"}, {"oid": "ff76450fc236b530ad158df56024eb2ec69e21a6", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/ff76450fc236b530ad158df56024eb2ec69e21a6", "message": "Add a write function to the serializer.", "committedDate": "2020-08-17T00:44:38Z", "type": "commit"}, {"oid": "64ab373225587fc7eefcdfdb8980997c123eb08a", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/64ab373225587fc7eefcdfdb8980997c123eb08a", "message": "new gen", "committedDate": "2020-08-17T00:55:45Z", "type": "commit"}]}