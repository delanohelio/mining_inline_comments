{"pr_number": 7532, "pr_title": "Fix Deadlock when adding Entities during Chunk Load (#7519)", "pr_createdAt": "2020-12-03T12:45:01Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTkwNA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#discussion_r535315904", "bodyText": "If you don't change the indentation of this inner stuff the patch will be a lot cleaner/smaller.", "author": "pupnewfster", "createdAt": "2020-12-03T15:10:30Z", "path": "patches/minecraft/net/minecraft/world/server/ChunkManager.java.patch", "diffHunk": "@@ -8,23 +8,58 @@\n                 }\n  \n                 this.func_219229_a(p_219185_5_);\n-@@ -601,6 +602,7 @@\n-                if (list != null) {\n-                   list.forEach(chunk::func_76622_b);\n-                }\n-+               net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.world.ChunkEvent.Load(chunk));\n+@@ -582,25 +583,28 @@\n+             if (this.field_219254_h.add(chunkpos.func_201841_a())) {\n+                chunk.func_177417_c(true);\n+                this.field_219255_i.func_147448_a(chunk.func_177434_r().values());\n+-               List<Entity> list = null;\n+-               ClassInheritanceMultiMap<Entity>[] aclassinheritancemultimap = chunk.func_177429_s();\n+-               int i = aclassinheritancemultimap.length;\n++               p_219200_1_.func_219276_a(ChunkStatus.field_222617_m, this).thenRun(() -> { //Forge: Delay EntityJoinWorld events until chunk is available to prevent deadlocks\n++                  List<Entity> list = null;\n++                  ClassInheritanceMultiMap<Entity>[] aclassinheritancemultimap = chunk.func_177429_s();\n++                  int i = aclassinheritancemultimap.length;\n+ \n+-               for(int j = 0; j < i; ++j) {\n+-                  for(Entity entity : aclassinheritancemultimap[j]) {\n+-                     if (!(entity instanceof PlayerEntity) && !this.field_219255_i.func_217440_f(entity)) {\n+-                        if (list == null) {\n+-                           list = Lists.newArrayList(entity);\n+-                        } else {\n+-                           list.add(entity);\n++                  for(int j = 0; j < i; ++j) {\n++                     for(Entity entity : aclassinheritancemultimap[j]) {\n++                        if (!(entity instanceof PlayerEntity) && !this.field_219255_i.func_217440_f(entity)) {\n++                           if (list == null) {\n++                              list = Lists.newArrayList(entity);\n++                           } else {\n++                              list.add(entity);\n++                           }\n+                         }\n+                      }\n+                   }\n+-               }\n+ \n+-               if (list != null) {\n+-                  list.forEach(chunk::func_76622_b);\n+-               }\n++                  if (list != null) {\n++                     list.forEach(chunk::func_76622_b);\n++                  }", "originalCommit": "9487ac35043c4b9e9b6693e77fa67cd0b4cd677d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM0MzE5OA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#discussion_r535343198", "bodyText": "Changed and pushed", "author": "AterAnimAvis", "createdAt": "2020-12-03T15:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM0OTIxMg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#discussion_r535349212", "bodyText": "I think your change of this might have lost something? The description of the PR says you moved the load event, but it seems you are only adding a new one now, instead of also removing the old one.", "author": "pupnewfster", "createdAt": "2020-12-03T15:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM1NzUwMw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#discussion_r535357503", "bodyText": "I think your reading the patch wrong. There's only one post of ChunkEvent.Load?", "author": "AterAnimAvis", "createdAt": "2020-12-03T15:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2MDI0Mw==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#discussion_r535360243", "bodyText": "Ya nevermind I was reading it wrong, because there was an extra line I think just because of all the lines earlier that I think was showing removed.", "author": "pupnewfster", "createdAt": "2020-12-03T15:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc4NzcyOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/7532#discussion_r535787729", "bodyText": "Literally woke up in the middle of the night and realised I missed a line from my fix. I\u2019ll fix this in the morning (If I\u2019m actually right) - Thankfully the current patch doesn't need the fix (Prevents CME on iterating the entities for removal) which was necessary for a previous version.", "author": "AterAnimAvis", "createdAt": "2020-12-04T02:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNTkwNA=="}], "type": "inlineReview"}, {"oid": "e3fba1c2723bc0fc83541cb0f84ba191e0b87de3", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/e3fba1c2723bc0fc83541cb0f84ba191e0b87de3", "message": "Fix Deadlock when adding Entities during Chunk Load (#7519)\n---\n\nDelays the firing of EntityJoinWorldEvent during chunk load until after the chunk is available.\nThis prevent deadlocks if a listener of the event tries to add an entity to the chunk being loaded.", "committedDate": "2020-12-03T15:36:02Z", "type": "forcePushed"}, {"oid": "a9f44c991fdaaeda6849cee354592fe71036e37f", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/a9f44c991fdaaeda6849cee354592fe71036e37f", "message": "Fix Deadlock when adding Entities during Chunk Load (#7519)\n---\n\nDelays the firing of EntityJoinWorldEvent during chunk load until after the chunk is available.\nThis prevent deadlocks if a listener of the event tries to add an entity to the chunk being loaded.", "committedDate": "2021-03-10T15:52:42Z", "type": "commit"}, {"oid": "90ac3233a4d3bc71429e0a7fc9969aa552136361", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/90ac3233a4d3bc71429e0a7fc9969aa552136361", "message": "fix: also move tile-entities loading to the delayed execution\n---\n\nSigned-off-by: AterAnimAvis <AterAnimAvis@gmail.com>", "committedDate": "2021-03-10T15:54:27Z", "type": "commit"}, {"oid": "90ac3233a4d3bc71429e0a7fc9969aa552136361", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/90ac3233a4d3bc71429e0a7fc9969aa552136361", "message": "fix: also move tile-entities loading to the delayed execution\n---\n\nSigned-off-by: AterAnimAvis <AterAnimAvis@gmail.com>", "committedDate": "2021-03-10T15:54:27Z", "type": "forcePushed"}, {"oid": "666a416415d2310fd780563151a295904341903c", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/666a416415d2310fd780563151a295904341903c", "message": "Migrate to only fix the issue in ForgeInternalHandler#onEntityJoinWorld + add warning to relevant events.\n---\n\nSigned-off-by: AterAnimAvis <AterAnimAvis@gmail.com>", "committedDate": "2021-03-12T16:20:50Z", "type": "commit"}]}