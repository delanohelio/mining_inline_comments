{"pr_number": 6849, "pr_title": "Fix and tweak how resource reload listeners are added", "pr_createdAt": "2020-06-27T02:34:56Z", "pr_url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849", "timeline": [{"oid": "6029e67c24fcbfc5d048ca801ca9422a2405c2d6", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/6029e67c24fcbfc5d048ca801ca9422a2405c2d6", "message": "Fix adding reload listeners", "committedDate": "2020-06-27T02:26:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5NjMzMA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446496330", "bodyText": "Because this is in an interface, this is public, it should not be.", "author": "covers1624", "createdAt": "2020-06-27T07:23:03Z", "path": "src/main/java/net/minecraftforge/resource/IForgeDataPackRegistries.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package net.minecraftforge.resource;\n+\n+import net.minecraft.resources.IFutureReloadListener;\n+import net.minecraftforge.common.loot.LootModifierManager;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+public interface IForgeDataPackRegistries {\n+   List<IFutureReloadListener> resources = new ArrayList<>();", "originalCommit": "6029e67c24fcbfc5d048ca801ca9422a2405c2d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2631f08bc2826ba6cd7d316d910d606fb58117ec", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2631f08bc2826ba6cd7d316d910d606fb58117ec", "message": "Event way", "committedDate": "2020-06-27T13:03:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzNjc5NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446536794", "bodyText": "Wasn't this getter used by Global Loot Modifiers ? I think they are broken right now though.", "author": "Nukeologist", "createdAt": "2020-06-27T15:20:08Z", "path": "patches/minecraft/net/minecraft/resources/DataPackRegistries.java.patch", "diffHunk": "@@ -1,28 +1,10 @@\n --- a/net/minecraft/resources/DataPackRegistries.java\n +++ b/net/minecraft/resources/DataPackRegistries.java\n-@@ -22,6 +22,8 @@\n-    private final AdvancementManager field_240958_h_ = new AdvancementManager(this.field_240956_f_);\n-    private final FunctionReloader field_240959_i_;\n- \n-+   private final net.minecraftforge.common.loot.LootModifierManager lootManager = new net.minecraftforge.common.loot.LootModifierManager();\n-+\n-    public DataPackRegistries(Commands.EnvironmentType p_i232598_1_, int p_i232598_2_) {\n-       this.field_240953_c_ = new Commands(p_i232598_1_);\n-       this.field_240959_i_ = new FunctionReloader(p_i232598_2_, this.field_240953_c_.func_197054_a());\n-@@ -31,6 +33,7 @@\n+@@ -31,6 +31,7 @@\n        this.field_240952_b_.func_219534_a(this.field_240957_g_);\n        this.field_240952_b_.func_219534_a(this.field_240959_i_);\n        this.field_240952_b_.func_219534_a(this.field_240958_h_);\n-+      this.field_240952_b_.func_219534_a(this.lootManager);\n++      net.minecraftforge.event.ForgeEventFactory.onResourceReload().forEach(field_240952_b_::func_219534_a);\n     }\n  \n     public FunctionReloader func_240960_a_() {\n-@@ -85,4 +88,8 @@\n-    public void close() {\n-       this.field_240952_b_.close();\n-    }\n-+\n-+   public net.minecraftforge.common.loot.LootModifierManager getLootModifierManager() {\n-+      return lootManager;\n-+   }", "originalCommit": "2631f08bc2826ba6cd7d316d910d606fb58117ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzNjkzMg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446536932", "bodyText": "woops ill re add a getter", "author": "Cyborgmas", "createdAt": "2020-06-27T15:21:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzNjc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NDcyOQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446554729", "bodyText": "Why are the imports in this file changing?", "author": "pupnewfster", "createdAt": "2020-06-27T18:39:58Z", "path": "src/main/java/net/minecraftforge/common/ForgeMod.java", "diffHunk": "@@ -23,8 +23,8 @@\n import net.minecraft.entity.ai.attributes.RangedAttribute;\n import net.minecraft.util.SoundEvent;\n import net.minecraft.world.storage.IServerConfiguration;\n-import net.minecraft.world.storage.IWorldInfo;", "originalCommit": "2631f08bc2826ba6cd7d316d910d606fb58117ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a601fc93bc52ca56b10c688b8d3f0b764762ddc", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/1a601fc93bc52ca56b10c688b8d3f0b764762ddc", "message": "Add docs + fixes", "committedDate": "2020-06-27T23:08:59Z", "type": "commit"}, {"oid": "a4ee329e63b986ddfdb583faf8e6ff95a146d93e", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/a4ee329e63b986ddfdb583faf8e6ff95a146d93e", "message": "damn imports", "committedDate": "2020-06-27T23:14:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MzY1NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r446583654", "bodyText": "Might want to emphasize this is for server reload listeners. Only clue in the javadoc is the link to data pack registries, but I could see someone getting confused and trying to use this for the client side resource pack reload listeners.", "author": "KnightMiner", "createdAt": "2020-06-28T00:38:33Z", "path": "src/main/java/net/minecraftforge/event/AddReloadListenerEvent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package net.minecraftforge.event;\n+\n+import com.google.common.collect.ImmutableList;\n+import net.minecraft.resources.DataPackRegistries;\n+import net.minecraft.resources.IFutureReloadListener;\n+import net.minecraftforge.common.MinecraftForge;\n+import net.minecraftforge.eventbus.api.Event;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The main ResourceManager is recreated on each reload, through {@link DataPackRegistries}'s creation.\n+ *\n+ * The event is fired on each reload and lets modders add their own ReloadListeners.\n+ * The event is fired on the {@link MinecraftForge#EVENT_BUS}\n+ */\n+public class AddReloadListenerEvent extends Event", "originalCommit": "a4ee329e63b986ddfdb583faf8e6ff95a146d93e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4950447c05e29dbed1ba0bf273dc28073810ad77", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/4950447c05e29dbed1ba0bf273dc28073810ad77", "message": "specify only server ride", "committedDate": "2020-06-28T01:28:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MTU1NA==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r447941554", "bodyText": "Forge has its own internal handler, so this shouldn't have this weird meta instance thing...\nWhat is the point of people having access to the instance?", "author": "LexManos", "createdAt": "2020-06-30T19:54:32Z", "path": "src/main/java/net/minecraftforge/common/loot/LootModifierManager.java", "diffHunk": "@@ -154,4 +161,17 @@ private IGlobalLootModifier deserializeModifier(ResourceLocation location, JsonE\n         return registeredLootModifiers.values();\n     }\n \n+    @SubscribeEvent\n+    public static void onResourceReload(AddReloadListenerEvent event)", "originalCommit": "4950447c05e29dbed1ba0bf273dc28073810ad77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1ODg5NQ==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r447958895", "bodyText": "used here https://github.com/MinecraftForge/MinecraftForge/blob/1.16.x/src/main/java/net/minecraftforge/common/ForgeHooks.java#L1169 but commented for now. I can put this in the InternalHandler if its better suited.", "author": "Cyborgmas", "createdAt": "2020-06-30T20:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk3MzUxNg==", "url": "https://github.com/MinecraftForge/MinecraftForge/pull/6849#discussion_r447973516", "bodyText": "Yes this should be moved to the internal handler as there is no sense in exposing a modder facing API if we can avoid it when it comes to internal instances of things.", "author": "pupnewfster", "createdAt": "2020-06-30T20:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MTU1NA=="}], "type": "inlineReview"}, {"oid": "2eb51f8089d330db58173203d9b69e683719400b", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/2eb51f8089d330db58173203d9b69e683719400b", "message": "move LootModifierManager instance, getter & reloader", "committedDate": "2020-06-30T21:08:07Z", "type": "commit"}, {"oid": "c2105ad3ed918f1c368145fa91d5db2add395eec", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/c2105ad3ed918f1c368145fa91d5db2add395eec", "message": "diff", "committedDate": "2020-06-30T21:11:38Z", "type": "commit"}, {"oid": "82a999f1baffbd41eab2beb745c73b25ade45f59", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/82a999f1baffbd41eab2beb745c73b25ade45f59", "message": "ugh", "committedDate": "2020-06-30T21:13:01Z", "type": "commit"}, {"oid": "dac6d23d5fdcf4f15f2dfee44a5a524586ae3814", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/dac6d23d5fdcf4f15f2dfee44a5a524586ae3814", "message": "ugh v2", "committedDate": "2020-06-30T21:13:45Z", "type": "commit"}, {"oid": "63420ca9910314f51df51fe5fb7b237d11df7a90", "url": "https://github.com/MinecraftForge/MinecraftForge/commit/63420ca9910314f51df51fe5fb7b237d11df7a90", "message": "re enable global loot modifiers", "committedDate": "2020-06-30T22:36:52Z", "type": "commit"}]}