{"pr_number": 986, "pr_title": "Resolves #985: Get rid of finalizer", "pr_createdAt": "2020-07-01T18:12:44Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/986", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTAyNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448669025", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param warnAndCloseOpenContextsAfterSeconds  number of seconds after which a context and be closed and a warning logged\n          \n          \n            \n                 * @param warnAndCloseOpenContextsAfterSeconds number of seconds after which a context and be closed and a warning logged", "author": "alecgrieser", "createdAt": "2020-07-01T23:35:23Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseFactory.java", "diffHunk": "@@ -480,6 +482,22 @@ public void setTransactionIsTracedSupplier(Supplier<Boolean> transactionIsTraced\n         return transactionIsTracedSupplier;\n     }\n \n+    /**\n+     * Get whether to warn and close record contexts open for too long.\n+     * @return number of seconds after which a context and be closed and a warning logged\n+     */\n+    public long getWarnAndCloseOpenContextsAfterSeconds() {\n+        return warnAndCloseOpenContextsAfterSeconds;\n+    }\n+\n+    /**\n+     * Set whether to warn and close record contexts open for too long.\n+     * @param warnAndCloseOpenContextsAfterSeconds  number of seconds after which a context and be closed and a warning logged", "originalCommit": "0b138786b7b9081a2177614df40b86282fcdb172", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2OTMyNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448669324", "bodyText": "I guess I'm not 100% clear on this, but can we deprecate them now (according to our rules)? If this is stable, I suppose we can't remove them until version 3, but I thought deprecating \"should\" be okay at any time.", "author": "alecgrieser", "createdAt": "2020-07-01T23:36:24Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseFactory.java", "diffHunk": "@@ -463,14 +464,15 @@ public long getReverseDirectoryMaxMillisPerTransaction() {\n         return reverseDirectoryMaxMillisPerTransaction;\n     }\n \n+    // TODO: Demote these to UNSTABLE and deprecate at some point.", "originalCommit": "0b138786b7b9081a2177614df40b86282fcdb172", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MDI2Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448670262", "bodyText": "I think if this used pollFirstEntry, then this wouldn't need to catch an exception (but would have to check for null). I suppose that could then be combined with the check to see if the data structure is empty.", "author": "alecgrieser", "createdAt": "2020-07-01T23:39:43Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -1120,6 +1134,55 @@ protected RuntimeException mapAsyncToSyncException(@Nonnull Throwable ex) {\n         return future.get();\n     }\n \n+    /**\n+     * Log warning and close tracked contexts that have been open for too long.\n+     * @param minAgeSeconds number of seconds above which to warn\n+     * @return number of such contexts found\n+     */\n+    public int warnAndCloseOldTrackedOpenContexts(long minAgeSeconds) {\n+        long nanoTime = System.nanoTime() - TimeUnit.SECONDS.toNanos(minAgeSeconds);\n+        if (trackedOpenContexts.isEmpty()) {\n+            return 0;\n+        }\n+        try {\n+            if (trackedOpenContexts.firstKey() > nanoTime) {", "originalCommit": "0b138786b7b9081a2177614df40b86282fcdb172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyMTg1OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r449021859", "bodyText": "You mean firstEntry? We don't want to remove it from the map. I assume that the most common case is that the map is not empty but all entries are younger than the threshold. firstEntry conses. I suppose it'll probably be on the stack, so maybe this isn't a real issue.", "author": "MMcM", "createdAt": "2020-07-02T13:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MDI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTExNzY2NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r449117665", "bodyText": "Yeah, whoops, firstEntry rather than pollFirstEntry. I suppose that's right, that the firstKey is probably not absent, in any case (if we've already checked emptiness), so this is probably fine, then", "author": "alecgrieser", "createdAt": "2020-07-02T15:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MDI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MjcyMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448672720", "bodyText": "Is this public so that a consumer might decide that they want to run this more often (or I suppose in their own tests)? It seems that in general, this should be package private, but I could also see the argument that either of those would be useful features.", "author": "alecgrieser", "createdAt": "2020-07-01T23:48:17Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -1120,6 +1134,55 @@ protected RuntimeException mapAsyncToSyncException(@Nonnull Throwable ex) {\n         return future.get();\n     }\n \n+    /**\n+     * Log warning and close tracked contexts that have been open for too long.\n+     * @param minAgeSeconds number of seconds above which to warn\n+     * @return number of such contexts found\n+     */\n+    public int warnAndCloseOldTrackedOpenContexts(long minAgeSeconds) {", "originalCommit": "0b138786b7b9081a2177614df40b86282fcdb172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0OTU3MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448949571", "bodyText": "Yeah, it seems useful to me for this to be public, so you could, say, hook it into some metric publishing system to track the number of leaky transactions you have over time.", "author": "scgray", "createdAt": "2020-07-02T11:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MjcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTExNjQ2NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r449116465", "bodyText": "Hm, I'm not sure how making this method public helps with hooking this into metric publishing (other than making it overridable by child classes of FDBDatabase, I suppose). I could see an argument that we'd want to add a store timer KPI on the count here (which I suppose means making this take an FDBStoreTimer as well) (though there can be some double counting due to having multiple concurrent accessors)", "author": "alecgrieser", "createdAt": "2020-07-02T15:57:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MjcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEzODQwMw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r449138403", "bodyText": "It needs to be public so that testing frameworks can call it when shutting down and find leaks, for instance. I added an annotation.\nI added a KPI for when something is closed because it was open for too long.", "author": "MMcM", "createdAt": "2020-07-02T16:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MjcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MzA0Mw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448673043", "bodyText": "This doesn't feel like it should be public. I think I can get behind the others, though they also seem more package-private (unless they're supposed to be visible for testing, or something like that).", "author": "alecgrieser", "createdAt": "2020-07-01T23:49:25Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordContext.java", "diffHunk": "@@ -337,6 +340,34 @@ public boolean isLogged() {\n         return logged;\n     }\n \n+    /**\n+     * Get the nanosecond time at which this context was opened.\n+     * @return time opened\n+     */\n+    @API(API.Status.INTERNAL)\n+    public long getTrackOpenTimeNanos() {\n+        return trackOpenTimeNanos;\n+    }\n+\n+    /**\n+     * Set the nanosecond time at which this context was opened.\n+     * @param trackOpenTimeNanos  time opened\n+     */\n+    @API(API.Status.INTERNAL)\n+    public void setTrackOpenTimeNanos(final long trackOpenTimeNanos) {", "originalCommit": "0b138786b7b9081a2177614df40b86282fcdb172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2NzgzMQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r449067831", "bodyText": "This one does not need to be public; the getter does, for tests, as you say.", "author": "MMcM", "createdAt": "2020-07-02T15:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MzA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3Mzk5NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448673995", "bodyText": "Seems like the throwable here should have a message here about how it's not thrown (or equivalently that this is created only for the stack trace).", "author": "alecgrieser", "createdAt": "2020-07-01T23:52:38Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordContext.java", "diffHunk": "@@ -152,22 +154,23 @@\n     private final Map<String, PostCommit> postCommits = new LinkedHashMap<>();\n     private boolean dirtyStoreState;\n     private boolean dirtyMetaDataVersionStamp;\n+    private long trackOpenTimeNanos;\n \n     protected FDBRecordContext(@Nonnull FDBDatabase fdb,\n                                @Nonnull Transaction transaction,\n-                               @Nonnull FDBRecordContextConfig config,\n-                               boolean transactionIsTraced) {\n+                               @Nonnull FDBRecordContextConfig config) {\n         super(fdb, transaction, config.getTimer());\n         this.transactionCreateTime = System.currentTimeMillis();\n         this.localVersion = new AtomicInteger(0);\n         this.localVersionCache = new ConcurrentSkipListMap<>(ByteArrayUtil::compareUnsigned);\n         this.versionMutationCache = new ConcurrentSkipListMap<>(ByteArrayUtil::compareUnsigned);\n         this.transactionId = getSanitizedId(config);\n+        this.openStackTrace = config.isSaveOpenStackTrace() ? new Throwable() : null;", "originalCommit": "0b138786b7b9081a2177614df40b86282fcdb172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2ODU5OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r449068599", "bodyText": "Added.", "author": "MMcM", "createdAt": "2020-07-02T15:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3Mzk5NQ=="}], "type": "inlineReview"}, {"oid": "82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "message": "Resolves #985: Get rid of finalizer", "committedDate": "2020-07-02T01:24:56Z", "type": "commit"}, {"oid": "82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "message": "Resolves #985: Get rid of finalizer", "committedDate": "2020-07-02T01:24:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2Mjg3NA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/986#discussion_r448962874", "bodyText": "Just an observation: I wasn't aware that nanoTime() could return 0. That's useful to be aware of.", "author": "scgray", "createdAt": "2020-07-02T12:24:45Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabase.java", "diffHunk": "@@ -1118,6 +1132,55 @@ protected RuntimeException mapAsyncToSyncException(@Nonnull Throwable ex) {\n         return future.get();\n     }\n \n+    /**\n+     * Log warning and close tracked contexts that have been open for too long.\n+     * @param minAgeSeconds number of seconds above which to warn\n+     * @return number of such contexts found\n+     */\n+    public int warnAndCloseOldTrackedOpenContexts(long minAgeSeconds) {\n+        long nanoTime = System.nanoTime() - TimeUnit.SECONDS.toNanos(minAgeSeconds);\n+        if (trackedOpenContexts.isEmpty()) {\n+            return 0;\n+        }\n+        try {\n+            if (trackedOpenContexts.firstKey() > nanoTime) {\n+                return 0;\n+            }\n+        } catch (NoSuchElementException ex) {\n+            return 0;\n+        }\n+        int count = 0;\n+        for (FDBRecordContext context : trackedOpenContexts.headMap(nanoTime, true).values()) {\n+            KeyValueLogMessage msg = KeyValueLogMessage.build(\"context not closed\",\n+                    LogMessageKeys.AGE_SECONDS, TimeUnit.NANOSECONDS.toSeconds(nanoTime - context.getTrackOpenTimeNanos()),\n+                    LogMessageKeys.TRANSACTION_ID, context.getTransactionId());\n+            if (context.getOpenStackTrace() != null) {\n+                LOGGER.warn(msg.toString(), context.getOpenStackTrace());\n+            } else {\n+                LOGGER.warn(msg.toString());\n+            }\n+            context.close();\n+            count++;\n+        }\n+        return count;\n+    }\n+\n+    protected void trackOpenContext(FDBRecordContext context) {\n+        long key = System.nanoTime();\n+        while (key == 0 || trackedOpenContexts.putIfAbsent(key, context) != null) {\n+            key++;  // Might not have nanosecond resolution and need something non-zero and unique.", "originalCommit": "82b71ef4efb1f85b6073c6fea7f4cc1915ee52f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8542010f501e6c253eb9896023946576ec11df59", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/8542010f501e6c253eb9896023946576ec11df59", "message": "Update fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBDatabaseFactory.java\n\nCo-authored-by: Alec Grieser <alloc@apple.com>", "committedDate": "2020-07-02T13:51:49Z", "type": "commit"}, {"oid": "e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "message": "Adjust some visibility", "committedDate": "2020-07-02T15:05:14Z", "type": "commit"}, {"oid": "e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/e3c58c017ca17808c127f0fe4e9394f2c4b95a1e", "message": "Adjust some visibility", "committedDate": "2020-07-02T15:05:14Z", "type": "forcePushed"}, {"oid": "cad029f303b1602bbc8ab750469eba1694f932a5", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/cad029f303b1602bbc8ab750469eba1694f932a5", "message": "Add a KPI for warnAndCloseOldTrackedOpenContexts", "committedDate": "2020-07-02T16:33:02Z", "type": "commit"}]}