{"pr_number": 955, "pr_title": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace", "pr_createdAt": "2020-05-22T00:53:44Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/955", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzg1MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#discussion_r429303851", "bodyText": "Wait, this is wrong", "author": "alecgrieser", "createdAt": "2020-05-22T15:09:23Z", "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/VersionIndexTest.java", "diffHunk": "@@ -1059,13 +1295,13 @@ public void maxEverVersionWithinTransaction(int testFormatVersion, boolean testS\n         try (FDBRecordContext context = openContext(maxEverVersionHook)) {\n             MySimpleRecord record3 = MySimpleRecord.newBuilder().setRecNo(1066L).build();\n             MySimpleRecord record4 = MySimpleRecord.newBuilder().setRecNo(1415L).build();\n-            recordStore.saveRecord(record3);\n+            FDBRecordVersion version3 = recordStore.saveRecord(record3).getVersion();\n+            assertNotNull(version3);\n             FDBRecordVersion version4 = getBiggerVersion(expectedMaxVersion);\n-            recordStore.saveRecord(record4, version4);\n+            FDBStoredRecord<?> storedRecord4 = recordStore.saveRecord(record4, version4);\n \n             context.commit();\n             assertNotNull(context.getVersionStamp());\n-            FDBRecordVersion version3 = FDBRecordVersion.complete(context.getVersionStamp(), context.getLocalVersion(Tuple.from(record3.getRecNo())).get());", "originalCommit": "83b9903d263e09b6f4af7ed4577165f15c70767e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwODg1MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#discussion_r429308850", "bodyText": "A previous version of this had some confusion as to which versions were complete and which were incomplete. The newer version I think doesn't have that any more.", "author": "alecgrieser", "createdAt": "2020-05-22T15:18:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzk1NA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#discussion_r429303954", "bodyText": "as is this", "author": "alecgrieser", "createdAt": "2020-05-22T15:09:33Z", "path": "fdb-record-layer-core/src/test/java/com/apple/foundationdb/record/provider/foundationdb/VersionIndexTest.java", "diffHunk": "@@ -1077,11 +1313,11 @@ public void maxEverVersionWithinTransaction(int testFormatVersion, boolean testS\n             MySimpleRecord record6 = MySimpleRecord.newBuilder().setRecNo(1455L).build();\n             FDBRecordVersion version5 = getBiggerVersion(expectedMaxVersion);\n             recordStore.saveRecord(record5, version5);\n-            recordStore.saveRecord(record6);\n+            FDBRecordVersion version6 = recordStore.saveRecord(record6).getVersion();\n+            assertNotNull(version6);\n \n             context.commit();\n             assertNotNull(context.getVersionStamp());\n-            FDBRecordVersion version6 = FDBRecordVersion.complete(context.getVersionStamp(), context.getLocalVersion(Tuple.from(record6.getRecNo())).get());", "originalCommit": "83b9903d263e09b6f4af7ed4577165f15c70767e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwODkyMg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/955#discussion_r429308922", "bodyText": "Same as the other comment.", "author": "alecgrieser", "createdAt": "2020-05-22T15:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzk1NA=="}], "type": "inlineReview"}, {"oid": "bdb5dd92156e1d08bb441787ca0bf0d92881762c", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/bdb5dd92156e1d08bb441787ca0bf0d92881762c", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't.", "committedDate": "2020-05-22T15:15:08Z", "type": "forcePushed"}, {"oid": "200702fff640eba3c07a121bd4d934ffa1b6f956", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/200702fff640eba3c07a121bd4d934ffa1b6f956", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't.", "committedDate": "2020-05-28T20:16:51Z", "type": "commit"}, {"oid": "200702fff640eba3c07a121bd4d934ffa1b6f956", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/200702fff640eba3c07a121bd4d934ffa1b6f956", "message": "Fixes #952: Local version cache is keyed only by Tuple (i.e., primary key) not subspace\n\nThis changes the local version cache to be keyed by `byte[]` rather than by `Tuple`. Then the exact key (in the database) is used to represent the cache entry rather than the record's primary key. This allows multiple stores to be opened in the same transaction and for them to interact with versioned records with the same primary key in each store without having cache entries from one store pollute the cache entries of the other.\n\nThis meant changing the API. The previous API was just wrong, in that there was absolutely no way to protect oneself from the bug identified in #952, so it has just been removed (despite the fact that this violates are claims of API stability). These APIs probably should have been marked INTERNAL anyway, but I believe they pre-date the API stability annotations, which is why they weren't.", "committedDate": "2020-05-28T20:16:51Z", "type": "forcePushed"}]}