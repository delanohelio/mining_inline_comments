{"pr_number": 8796, "pr_title": "[Issue 8751] Update Dockerfile for Pulsar and Dashboard to Create and Use pulsar User (nonroot user)", "pr_createdAt": "2020-12-02T20:03:02Z", "pr_url": "https://github.com/apache/pulsar/pull/8796", "timeline": [{"oid": "37f5787181ead262447a1b6a4019cbdec48cfd84", "url": "https://github.com/apache/pulsar/commit/37f5787181ead262447a1b6a4019cbdec48cfd84", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)", "committedDate": "2020-12-02T20:09:06Z", "type": "forcePushed"}, {"oid": "8fa7d02afb01abb8b0f8484188750f415f5af04d", "url": "https://github.com/apache/pulsar/commit/8fa7d02afb01abb8b0f8484188750f415f5af04d", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)", "committedDate": "2020-12-03T05:43:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMzYxOA==", "url": "https://github.com/apache/pulsar/pull/8796#discussion_r539033618", "bodyText": "@michaeljmarshall when the docker image is used in Kubernetes, the helm chart will mount the disks to /pulsar/data. Does it change the permission?", "author": "sijie", "createdAt": "2020-12-09T06:04:24Z", "path": "docker/pulsar/Dockerfile", "diffHunk": "@@ -53,21 +55,25 @@ RUN python3.7 get-pip.py\n \n RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 10\n \n-ADD target/python-client/ /pulsar/pulsar-client\n-ADD target/cpp-client/ /pulsar/cpp-client\n+ADD --chown=pulsar:pulsar target/python-client/ /pulsar/pulsar-client\n+ADD --chown=pulsar:pulsar target/cpp-client/ /pulsar/cpp-client\n RUN echo networkaddress.cache.ttl=1 >> $JAVA_HOME/jre/lib/security/java.security\n RUN apt-get update \\\n      && apt install -y /pulsar/cpp-client/*.deb \\\n      && apt-get clean \\\n+     && chown -R pulsar:pulsar /pulsar/cpp-client/\n      && rm -rf /var/lib/apt/lists/*\n \n+# Start using the pulsar user to ensure container defaults to run as non root user\n+USER pulsar\n+\n+# Directories will have correct permission because we switched to the pulsar user\n+RUN mkdir /pulsar/conf /pulsar/data", "originalCommit": "a2df5ea955da6086ad6668e7313c1968ba3c8e11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2OTI2MA==", "url": "https://github.com/apache/pulsar/pull/8796#discussion_r539069260", "bodyText": "Kubernetes will not change the file system permissions by default. If the volume is owned by root, the container will also view the mounted volume as owned by root, which would be a problem for the container produced from this docker image.\nIn Linux, the mounted volume will need to be writable by user 1000. I'm not certain how Docker users map to host users in other operating systems.\nHere is the Kubernetes documentation on permissions and pods. It looks like there has been active development in the mounted volume permission domain.\nI'm not sure how the pulsar project handles this type of change. Given that administrators of pulsar clusters should have access to the nodes running pulsar, it seems reasonable to me that those administrators could change the ownership of the relevant directories before upgrading to the next version of pulsar. The current containers would have root permissions, and would be able to write to directories/files owned by user 1000, so a rolling upgrade could still be achieved.\nIs there any precedent for this type of change? I would really like to get this into the 2.8.0 release, so that we can increase the security of pulsar containers and I can stop maintaining my own fork of the project. However, I also recognize the importance of carefully releasing major changes to a project.\nAs I mentioned in my initial PR description, it might be relevant to provide migration documentation, but I'm not sure where to put it.", "author": "michaeljmarshall", "createdAt": "2020-12-09T07:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMzYxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcwNzIxNg==", "url": "https://github.com/apache/pulsar/pull/8796#discussion_r551707216", "bodyText": "@sijie - after thinking about this, I think it might be helpful, and possibly necessary, to make a corresponding update to the helm chart to allow end users to choose how the container is run in kubernetes. Because docker allows an end user to choose the user that a container runs with, it is trivial for end users to run the container as root until they're able to update the host file system to have the appropriate permissions for the /puslar/conf and /pulsar/data directories. Let me know what you think.", "author": "michaeljmarshall", "createdAt": "2021-01-05T04:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMzYxOA=="}], "type": "inlineReview"}, {"oid": "f4019a1bdb7e89c53a1e8ae3d9d928cbabd16efd", "url": "https://github.com/apache/pulsar/commit/f4019a1bdb7e89c53a1e8ae3d9d928cbabd16efd", "message": "Fix latest-version-test Dockerfile; Optimize use of chown in Dockerfile", "committedDate": "2020-12-09T06:46:14Z", "type": "forcePushed"}, {"oid": "077a95edfd51223b301411870424525c7dfe1548", "url": "https://github.com/apache/pulsar/commit/077a95edfd51223b301411870424525c7dfe1548", "message": "Run pip install as root user to make dependencies available to root and pulsar users", "committedDate": "2021-01-01T21:57:04Z", "type": "forcePushed"}, {"oid": "8c95f6beff6347254971ce57aae0f1e78b070c34", "url": "https://github.com/apache/pulsar/commit/8c95f6beff6347254971ce57aae0f1e78b070c34", "message": "Add some documentation; use user 10000 and group 10001", "committedDate": "2021-01-08T04:42:10Z", "type": "forcePushed"}, {"oid": "c324cef45eff1c38d42fe78fa34b0bf64a58a7a6", "url": "https://github.com/apache/pulsar/commit/c324cef45eff1c38d42fe78fa34b0bf64a58a7a6", "message": "Rebase and make compatible for OpenShift", "committedDate": "2021-02-06T07:51:36Z", "type": "forcePushed"}, {"oid": "cbc013062fbe847cd88159fd79953b9212d491a7", "url": "https://github.com/apache/pulsar/commit/cbc013062fbe847cd88159fd79953b9212d491a7", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "cc7ac1b498dcf87922b845f22999bd5fb1a165d9", "url": "https://github.com/apache/pulsar/commit/cc7ac1b498dcf87922b845f22999bd5fb1a165d9", "message": "Fix latest-version-test Dockerfile; Optimize use of chown in Dockerfile", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "d9eec32a06dd39c4d4a49d7434435e90130c712f", "url": "https://github.com/apache/pulsar/commit/d9eec32a06dd39c4d4a49d7434435e90130c712f", "message": "Fix missed backslash; explicitly create and chown pulsar directory", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "31a5c0efb9d20c4d0e222f673bd3aaffa25a9d1a", "url": "https://github.com/apache/pulsar/commit/31a5c0efb9d20c4d0e222f673bd3aaffa25a9d1a", "message": "Configure supervisord to spawn components with pulsar user", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "25fcc33b3a6d5883fba93fc30893730ff8a6e004", "url": "https://github.com/apache/pulsar/commit/25fcc33b3a6d5883fba93fc30893730ff8a6e004", "message": "Run pip install as root user to make dependencies available to root and pulsar users", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "8ba1865e914a7ecab8569be1194671f068e47039", "url": "https://github.com/apache/pulsar/commit/8ba1865e914a7ecab8569be1194671f068e47039", "message": "Add some documentation; use user 10000 and group 10001", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "cb7da0d3c17ca27470c1e932ef28e677542e2fbc", "url": "https://github.com/apache/pulsar/commit/cb7da0d3c17ca27470c1e932ef28e677542e2fbc", "message": "Rebase and make compatible for OpenShift", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "d7830466d3d96342546d2f2007e28c76958bf8a1", "url": "https://github.com/apache/pulsar/commit/d7830466d3d96342546d2f2007e28c76958bf8a1", "message": "Fix documentation", "committedDate": "2021-02-11T05:12:14Z", "type": "commit"}, {"oid": "d7830466d3d96342546d2f2007e28c76958bf8a1", "url": "https://github.com/apache/pulsar/commit/d7830466d3d96342546d2f2007e28c76958bf8a1", "message": "Fix documentation", "committedDate": "2021-02-11T05:12:14Z", "type": "forcePushed"}, {"oid": "47b8e84bda5003301e04a1f6205e9c4395f2140a", "url": "https://github.com/apache/pulsar/commit/47b8e84bda5003301e04a1f6205e9c4395f2140a", "message": "Fix typo; improve getting started documentation", "committedDate": "2021-02-11T05:34:04Z", "type": "commit"}]}