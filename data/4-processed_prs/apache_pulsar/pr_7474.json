{"pr_number": 7474, "pr_title": "Log scheduler stats for Pulsar Functions", "pr_createdAt": "2020-07-08T00:48:53Z", "pr_url": "https://github.com/apache/pulsar/pull/7474", "timeline": [{"oid": "2e385f228ffd58284e1214c4845c01c10de49644", "url": "https://github.com/apache/pulsar/commit/2e385f228ffd58284e1214c4845c01c10de49644", "message": "Log scheduler stats for Pulsar Functions", "committedDate": "2020-07-08T00:44:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMDk5NQ==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451230995", "bodyText": "Can we also report this stats to prometheus?", "author": "merlimat", "createdAt": "2020-07-08T01:28:38Z", "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/SchedulerManager.java", "diffHunk": "@@ -368,8 +390,13 @@ private void invokeRebalance() {\n             functionRuntimeManager.processAssignment(assignment);\n             // update message id associated with current view of assignments map\n             lastMessageProduced = messageId;\n+            // update stats\n+            schedulerStats.newAssignment(assignment);\n         }\n-        log.info(\"Rebalance - Total number of new assignments computed: {}\", rebalancedAssignments.size());\n+\n+        log.info(\"Rebalance summary - execution time: {} sec | stats: {}\\n{}\",", "originalCommit": "2e385f228ffd58284e1214c4845c01c10de49644", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwODMwNQ==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451308305", "bodyText": "Yes I was going to work on that in the near future.  Stats like scheduler execution time can be in prometheus.  However, a breakdown of what how many instances moved grouped by worker is not suitable to be put into prometheus", "author": "jerrypeng", "createdAt": "2020-07-08T06:20:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMDk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDc2NA==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451254764", "bodyText": "Maybe a better wording here?", "author": "srkukarni", "createdAt": "2020-07-08T03:02:00Z", "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/MembershipManager.java", "diffHunk": "@@ -225,7 +232,8 @@ public void checkFailures(FunctionMetaDataManager functionMetaDataManager,\n             functionRuntimeManager.removeAssignments(needRemove);\n         }\n         if (triggerScheduler) {\n-            log.info(\"Functions that need scheduling/rescheduling: {}\", needSchedule);\n+            log.info(\"Failure check - Total number of instances that need to be scheduled/rescheduled: {} | Number of unassigned instances that need to be scheduled: {} | Number of instances on dead workers that need to be reassigned {}\",", "originalCommit": "2e385f228ffd58284e1214c4845c01c10de49644", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxMDk2NQ==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451310965", "bodyText": "Do you have a suggestion?", "author": "jerrypeng", "createdAt": "2020-07-08T06:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5NTAyNw==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451695027", "bodyText": "I actually liked the old message. What was the reason for the change?", "author": "srkukarni", "createdAt": "2020-07-08T17:02:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc1MzMwMA==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451753300", "bodyText": "Added \"Failure check\" in the beginning so it will be easier to search for", "author": "jerrypeng", "createdAt": "2020-07-08T18:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NDc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NTMzOA==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451255338", "bodyText": "Is this exported somewhere?", "author": "srkukarni", "createdAt": "2020-07-08T03:04:29Z", "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/SchedulerManager.java", "diffHunk": "@@ -526,4 +553,118 @@ static String checkHeartBeatFunction(Instance funInstance) {\n \n     public static class RebalanceInProgressException extends RuntimeException {\n     }\n+\n+    @Data", "originalCommit": "2e385f228ffd58284e1214c4845c01c10de49644", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwODU5OQ==", "url": "https://github.com/apache/pulsar/pull/7474#discussion_r451308599", "bodyText": "I will remove", "author": "jerrypeng", "createdAt": "2020-07-08T06:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1NTMzOA=="}], "type": "inlineReview"}, {"oid": "f546598740d4b4990b652c0bb29c3a9217cbb574", "url": "https://github.com/apache/pulsar/commit/f546598740d4b4990b652c0bb29c3a9217cbb574", "message": "addressing comments", "committedDate": "2020-07-08T06:28:12Z", "type": "commit"}]}