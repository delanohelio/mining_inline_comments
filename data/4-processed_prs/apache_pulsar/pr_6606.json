{"pr_number": 6606, "pr_title": "Fix non-atomic volatile update", "pr_createdAt": "2020-03-26T01:41:53Z", "pr_url": "https://github.com/apache/pulsar/pull/6606", "timeline": [{"oid": "4ba16aa34aa3b21439c3080761c1a43cadf2a29f", "url": "https://github.com/apache/pulsar/commit/4ba16aa34aa3b21439c3080761c1a43cadf2a29f", "message": "fix non-atomic update", "committedDate": "2020-03-26T01:26:51Z", "type": "commit"}, {"oid": "acfae2d3542b63b217344efeca58c3e8af681387", "url": "https://github.com/apache/pulsar/commit/acfae2d3542b63b217344efeca58c3e8af681387", "message": "fix", "committedDate": "2020-03-26T01:37:00Z", "type": "commit"}, {"oid": "87bc3619121df2ab9d004eead544162d03a04633", "url": "https://github.com/apache/pulsar/commit/87bc3619121df2ab9d004eead544162d03a04633", "message": "fix", "committedDate": "2020-03-26T01:40:00Z", "type": "commit"}, {"oid": "43699877ef70fab10132fca7cfbd35c210dfb318", "url": "https://github.com/apache/pulsar/commit/43699877ef70fab10132fca7cfbd35c210dfb318", "message": "fix seq", "committedDate": "2020-03-26T07:35:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMzE1NQ==", "url": "https://github.com/apache/pulsar/pull/6606#discussion_r405703155", "bodyText": "This is already protected by a write lock. No need to use updater. The volatile is only used to ensure readers are reading the last value of the size.", "author": "merlimat", "createdAt": "2020-04-08T17:46:22Z", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/GrowablePriorityLongPairQueue.java", "diffHunk": "@@ -204,7 +207,7 @@ private LongPair removeAtWithoutLock(int index) {\n             LongPair item = new LongPair(data[index], data[index + 1]);\n             data[index] = EmptyItem;\n             data[index + 1] = EmptyItem;\n-            --this.size;", "originalCommit": "43699877ef70fab10132fca7cfbd35c210dfb318", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMzc2Nw==", "url": "https://github.com/apache/pulsar/pull/6606#discussion_r405703767", "bodyText": "All operations on a connection are happening on same thread", "author": "merlimat", "createdAt": "2020-04-08T17:47:29Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1759,7 +1762,7 @@ public boolean isWritable() {\n     }\n \n     public void startSendOperation(Producer producer, int msgSize) {\n-        messagePublishBufferSize += msgSize;", "originalCommit": "43699877ef70fab10132fca7cfbd35c210dfb318", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}