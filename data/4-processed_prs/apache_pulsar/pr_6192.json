{"pr_number": 6192, "pr_title": "[deployement] make kubernetes yamls for aws operational", "pr_createdAt": "2020-02-03T15:08:24Z", "pr_url": "https://github.com/apache/pulsar/pull/6192", "timeline": [{"oid": "4e3d5a3f6d8a7acd9354a9b1bf0a036c61bbc1f4", "url": "https://github.com/apache/pulsar/commit/4e3d5a3f6d8a7acd9354a9b1bf0a036c61bbc1f4", "message": "make kubernetes yamls for aws operational", "committedDate": "2020-02-03T13:52:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0ODM3MA==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374248370", "bodyText": "I think you can just use the headless service name for zookeeperServers and configurationStoreServers. You don't need to write down all the pods here. because this will not work if people deploy a zookeeper with less than 3 pods.", "author": "sijie", "createdAt": "2020-02-03T17:52:58Z", "path": "deployment/kubernetes/aws/proxy.yaml", "diffHunk": "@@ -23,10 +23,11 @@ metadata:\n   name: pulsar-proxy-config\n data:\n   PULSAR_MEM: \"\\\" -Xms4g -Xmx4g -XX:MaxDirectMemorySize=4g\\\"\"\n-  PULSAR_PREFIX_brokerServiceURL: pulsar://broker:6650\n-  PULSAR_PREFIX_brokerWebServiceURL: http://broker:8080\n-  PULSAR_PREFIX_clusterName: pulsar-eks\n-\n+  brokerServiceURL: pulsar://broker:6650\n+  brokerWebServiceURL: http://broker:8080\n+  clusterName: us-east\n+  zookeeperServers: zk-0.zookeeper,zk-1.zookeeper,zk-2.zookeeper", "originalCommit": "4e3d5a3f6d8a7acd9354a9b1bf0a036c61bbc1f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1Mjk4MA==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374352980", "bodyText": "@sijie I just copied this from the bookkeeper.yaml, so I guess this should be modified in all of the other yaml's, right?", "author": "trexinc", "createdAt": "2020-02-03T21:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0ODM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyOTY2Mw==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374429663", "bodyText": "yes correct", "author": "sijie", "createdAt": "2020-02-04T01:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0ODM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MzA0MA==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374643040", "bodyText": "I don't feel comfortable doing this change. All the other yaml examples including the helm charts list all the ZK servers and not just the headless service name.\nI'm not familiar enough with Pulsar, ZK and k8s to be sure this is the right change.\nLet me commit my change, which adheres to the existing \"standard\" and corrects the usability of the yaml (which didn't work before at all).", "author": "trexinc", "createdAt": "2020-02-04T12:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0ODM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMjk3Nw==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374822977", "bodyText": "sure. that can be done in a separate change.", "author": "sijie", "createdAt": "2020-02-04T17:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0ODM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NjM0Mg==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374256342", "bodyText": "You should also take out the garbage collector settings and put them into BOOKIE_GC. You would also need to add bin/apply-config-from-env.py conf/bkenv.sh && in the command section if you want these changes to take effect.", "author": "roman-popenov", "createdAt": "2020-02-03T18:10:11Z", "path": "deployment/kubernetes/aws/bookkeeper.yaml", "diffHunk": "@@ -55,13 +53,14 @@ metadata:\n   name: bookie-config\n data:\n   PULSAR_MEM: \"\\\"-Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=32 -XX:ConcGCThreads=32 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintHeapAtGC -verbosegc -XX:G1LogLevel=finest -Xms28g -Xmx28g -XX:MaxDirectMemorySize=28g\\\"\"\n-  PULSAR_PREFIX_dbStorage_writeCacheMaxSizeMb: \"2048\" # Write cache size (direct memory)\n-  PULSAR_PREFIX_dbStorage_readAheadCacheMaxSizeMb: \"2048\" # Read cache size (direct memory)\n-  PULSAR_PREFIX_dbStorage_rocksDB_blockCacheSize: \"4294967296\"\n-  PULSAR_PREFIX_journalMaxSizeMB: \"2048\"\n-  PULSAR_PREFIX_zkServers: zk-0.zookeeper,zk-1.zookeeper,zk-2.zookeeper\n-  PULSAR_PREFIX_statsProviderClass: org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider\n-  PULSAR_PREFIX_useHostNameAsBookieID: \"true\"\n+  BOOKIE_MEM: \"\\\"-Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=32 -XX:ConcGCThreads=32 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintHeapAtGC -verbosegc -XX:G1LogLevel=finest -Xms28g -Xmx28g -XX:MaxDirectMemorySize=28g\\\"\"", "originalCommit": "4e3d5a3f6d8a7acd9354a9b1bf0a036c61bbc1f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1NTQ3OA==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374355478", "bodyText": "@roman-popenov What should the BOKKIE_GC be set to? I just copied BOOKIE_MEM from PULSAR_MEM in this file.\nAnd, are you sure that bkenv.sh is needed, as just setting BOOKIE_MEM worked fine for me (bookie didn't start before I set it)? If it is needed should it be the first one called?\nIn addition, do you think that for the bookie-autorecovery in the same yaml the PULSAR_MEM and PULSAR_GC should be changed to BOOKIE_* as well?", "author": "trexinc", "createdAt": "2020-02-03T21:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NjM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3Mjg0Mg==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r374872842", "bodyText": "You simply would be taking out -XX:+UseG1GC -XX:MaxGCPauseMillis=10 of the BOOKIE_MEM and putting it into BOOKIE_GC like so:\nBOOKIE_MEM: \"\\\"-Xms15g -Xmx15g -XX:MaxDirectMemorySize=15g -Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=32 -XX:ConcGCThreads=32 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintHeapAtGC -verbosegc -XX:G1LogLevel=finest\\\"\"\nBOOKIE_GC: \"\\\"-XX:+UseG1GC -XX:MaxGCPauseMillis=10\\\"\"\nbookie-autorecovery does run bin/apply-config-from-env.py conf/bookkeeper.conf so you would need to check which settings it takes and which config file it populates, but I suspect you might be right about this one as well. @sijie can you confirm?", "author": "roman-popenov", "createdAt": "2020-02-04T19:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NjM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE5MTk1OQ==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r375191959", "bodyText": "I will update soon after I test it.\nIn any case, \"bin/apply-config-from-env.py conf/bkenv.sh\" is definitely not needed (more so even bin/apply-config-from-env.py conf/pulsar_env.sh is not needed) as apply-config-from-env.py always updates the two sh files.\n# Always apply env config to env scripts as well\nconf_files = ['conf/pulsar_env.sh', 'conf/bkenv.sh'] + sys.argv[1:]\nPF_ENV_PREFIX = 'PULSAR_PREFIX_'\nfor conf_filename in conf_files:", "author": "trexinc", "createdAt": "2020-02-05T11:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NjM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxMDA1Mw==", "url": "https://github.com/apache/pulsar/pull/6192#discussion_r375210053", "bodyText": "@roman-popenov updated the file to set BOOKIE_MEM and BOOKIE_GC correctly both for bookie and for the autorecovery (validated that they are applied with jinfo)", "author": "trexinc", "createdAt": "2020-02-05T11:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NjM0Mg=="}], "type": "inlineReview"}, {"oid": "e443182dfc9e2f770e9656899345969b9a9f6a13", "url": "https://github.com/apache/pulsar/commit/e443182dfc9e2f770e9656899345969b9a9f6a13", "message": "use correct bookie env variables to set memory and gc", "committedDate": "2020-02-05T11:45:23Z", "type": "commit"}]}