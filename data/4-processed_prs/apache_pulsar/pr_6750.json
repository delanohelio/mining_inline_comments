{"pr_number": 6750, "pr_title": "[broker] Increase timeout for loading topics", "pr_createdAt": "2020-04-17T04:52:41Z", "pr_url": "https://github.com/apache/pulsar/pull/6750", "timeline": [{"oid": "b3940709e509d84dfad3fa939b4d4ca4f05c14d0", "url": "https://github.com/apache/pulsar/commit/b3940709e509d84dfad3fa939b4d4ca4f05c14d0", "message": "[broker] Increase timeout for loading topics\n\nIn #6489, a timeout was introduced to make sure calls into the\nBrokerService finish or error out. However, this timeout is too low by\ndefault when loading topics that have many replicated clusters.\n\nLoading replicated topics is quite an expensive operation, involve\nglobal ZK lookups and the start of many sub-processes. While we would\nhope it finishes in 60 seconds we want to safe.\n\nLong term, it may make sense to break out this operation into more\nsteps where each step can have it's own timeout", "committedDate": "2020-04-17T05:00:11Z", "type": "forcePushed"}, {"oid": "ed1a9ec2de6538d3c3e24b3f2fb5bc32e9a252e1", "url": "https://github.com/apache/pulsar/commit/ed1a9ec2de6538d3c3e24b3f2fb5bc32e9a252e1", "message": "[broker] Increase timeout for loading topics\n\nIn #6489, a timeout was introduced to make sure calls into the\nBrokerService finish or error out. However, this timeout is too low by\ndefault when loading topics that have many replicated clusters.\n\nLoading replicated topics is quite an expensive operation, involve\nglobal ZK lookups and the start of many sub-processes. While we would\nhope it finishes in 60 seconds we want to safe.\n\nLong term, it may make sense to break out this operation into more\nsteps where each step can have it's own timeout", "committedDate": "2020-04-17T05:03:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyNzU4NA==", "url": "https://github.com/apache/pulsar/pull/6750#discussion_r410027584", "bodyText": "It's better to make the timeout of the topic loading configurable in the broker.conf", "author": "codelipenghui", "createdAt": "2020-04-17T06:57:52Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -861,7 +861,8 @@ public PulsarAdmin getClusterPulsarAdmin(String cluster) {\n     protected CompletableFuture<Optional<Topic>> loadOrCreatePersistentTopic(final String topic,\n             boolean createIfMissing) throws RuntimeException {\n         checkTopicNsOwnership(topic);\n-        final CompletableFuture<Optional<Topic>> topicFuture = futureWithDeadline();\n+        // this timeout needs to be extra long in the case of topics with many replication clusters\n+        final CompletableFuture<Optional<Topic>> topicFuture = futureWithDeadline(5L, TimeUnit.MINUTES, new TimeoutException(\"Failed to load topic within timeout\"));", "originalCommit": "ed1a9ec2de6538d3c3e24b3f2fb5bc32e9a252e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1NjAwMA==", "url": "https://github.com/apache/pulsar/pull/6750#discussion_r412456000", "bodyText": "+1 we should make this setting configurable.", "author": "sijie", "createdAt": "2020-04-21T20:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyNzU4NA=="}], "type": "inlineReview"}, {"oid": "209e6d0fb512eb22634e6de79171ba6db355e100", "url": "https://github.com/apache/pulsar/commit/209e6d0fb512eb22634e6de79171ba6db355e100", "message": "[broker] Increase timeout for loading topics\n\nIn #6489, a timeout was introduced to make sure calls into the\nBrokerService finish or error out. However, this timeout is too low by\ndefault when loading topics that have many replicated clusters.\n\nLoading replicated topics is quite an expensive operation, involve\nglobal ZK lookups and the start of many sub-processes. While we would\nhope it finishes in 60 seconds we want to safe.\n\nLong term, it may make sense to break out this operation into more\nsteps where each step can have it's own timeout", "committedDate": "2020-05-05T20:41:58Z", "type": "commit"}, {"oid": "209e6d0fb512eb22634e6de79171ba6db355e100", "url": "https://github.com/apache/pulsar/commit/209e6d0fb512eb22634e6de79171ba6db355e100", "message": "[broker] Increase timeout for loading topics\n\nIn #6489, a timeout was introduced to make sure calls into the\nBrokerService finish or error out. However, this timeout is too low by\ndefault when loading topics that have many replicated clusters.\n\nLoading replicated topics is quite an expensive operation, involve\nglobal ZK lookups and the start of many sub-processes. While we would\nhope it finishes in 60 seconds we want to safe.\n\nLong term, it may make sense to break out this operation into more\nsteps where each step can have it's own timeout", "committedDate": "2020-05-05T20:41:58Z", "type": "forcePushed"}]}