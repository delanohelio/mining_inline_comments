{"pr_number": 8422, "pr_title": "[PIP-71][SQL]Pulsar SQL migrate SchemaHandle to presto decoder", "pr_createdAt": "2020-11-02T05:49:40Z", "pr_url": "https://github.com/apache/pulsar/pull/8422", "timeline": [{"oid": "86fb725301e014bd7b3f8a9068a975e7ebcacb6d", "url": "https://github.com/apache/pulsar/commit/86fb725301e014bd7b3f8a9068a975e7ebcacb6d", "message": "[SQL] migrate SchemaHandle to decoder", "committedDate": "2020-11-02T05:40:39Z", "type": "commit"}, {"oid": "703c15cc3de7ae73ac331593d1509f5182c89fe7", "url": "https://github.com/apache/pulsar/commit/703c15cc3de7ae73ac331593d1509f5182c89fe7", "message": "Merge branch 'master' of https://github.com/apache/pulsar into sql_migrate_decoder", "committedDate": "2020-11-09T03:23:22Z", "type": "commit"}, {"oid": "f94e77072a9ea25c521a1daf31780862f5c4bd12", "url": "https://github.com/apache/pulsar/commit/f94e77072a9ea25c521a1daf31780862f5c4bd12", "message": "commit unit-tests", "committedDate": "2020-11-09T06:41:28Z", "type": "commit"}, {"oid": "4d2755b254bb3e3f0e5759d726ee2a4fe2d68e08", "url": "https://github.com/apache/pulsar/commit/4d2755b254bb3e3f0e5759d726ee2a4fe2d68e08", "message": "fix Pair bug", "committedDate": "2020-11-09T11:40:03Z", "type": "commit"}, {"oid": "98d5ea3970e6cd32525bfd22b9723826808ec595", "url": "https://github.com/apache/pulsar/commit/98d5ea3970e6cd32525bfd22b9723826808ec595", "message": "codestyle fix", "committedDate": "2020-11-10T12:37:16Z", "type": "commit"}, {"oid": "9dd57e0288f3e11b4e3d314737b54b57b4f319e1", "url": "https://github.com/apache/pulsar/commit/9dd57e0288f3e11b4e3d314737b54b57b4f319e1", "message": "codestyle fix v2", "committedDate": "2020-11-10T13:31:50Z", "type": "commit"}, {"oid": "66be5b29d66ef73384a525cb36f6792e72926513", "url": "https://github.com/apache/pulsar/commit/66be5b29d66ef73384a525cb36f6792e72926513", "message": "codestyle fix v3", "committedDate": "2020-11-10T14:25:13Z", "type": "commit"}, {"oid": "e61a37d292f6d67b1613cf943c00e162ac9f6601", "url": "https://github.com/apache/pulsar/commit/e61a37d292f6d67b1613cf943c00e162ac9f6601", "message": "codestyle fix v4", "committedDate": "2020-11-10T14:36:44Z", "type": "commit"}, {"oid": "8f9360003a2972b6b009b45a29eaaddbae42acc1", "url": "https://github.com/apache/pulsar/commit/8f9360003a2972b6b009b45a29eaaddbae42acc1", "message": "codestyle fix v5", "committedDate": "2020-11-10T15:20:46Z", "type": "commit"}, {"oid": "203dc3646426973a354d8ff35eab35cfecf5664a", "url": "https://github.com/apache/pulsar/commit/203dc3646426973a354d8ff35eab35cfecf5664a", "message": "codeStyle fix v6", "committedDate": "2020-11-11T02:56:26Z", "type": "commit"}, {"oid": "aa636b9bd30cfefbff43ae65c02a3cdcccb1c7fe", "url": "https://github.com/apache/pulsar/commit/aa636b9bd30cfefbff43ae65c02a3cdcccb1c7fe", "message": "codeStyle fix v7", "committedDate": "2020-11-11T07:21:05Z", "type": "commit"}, {"oid": "6cfe40eef12dfba3350f9982dc61d547328db896", "url": "https://github.com/apache/pulsar/commit/6cfe40eef12dfba3350f9982dc61d547328db896", "message": "add License", "committedDate": "2020-11-11T08:18:08Z", "type": "commit"}, {"oid": "592130b1635f1eba8e83c90825d7b326e16534ad", "url": "https://github.com/apache/pulsar/commit/592130b1635f1eba8e83c90825d7b326e16534ad", "message": "add snappy license", "committedDate": "2020-11-12T06:08:52Z", "type": "commit"}, {"oid": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "url": "https://github.com/apache/pulsar/commit/7c5f93ce2e89894e985c5d986982dd34b54ba228", "message": "codeStyle fix", "committedDate": "2020-11-16T06:49:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU4MDExNg==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532580116", "bodyText": "Does this dependency is necessary?", "author": "gaoran10", "createdAt": "2020-11-30T13:02:16Z", "path": "pulsar-sql/presto-pulsar/pom.xml", "diffHunk": "@@ -109,6 +109,32 @@\n           <version>${joda.version}</version>\n         </dependency>\n \n+        <dependency>\n+            <groupId>io.prestosql</groupId>\n+            <artifactId>presto-record-decoder</artifactId>\n+            <version>${presto.version}</version>\n+        </dependency>\n+\n+        <dependency>\n+            <groupId>${project.groupId}</groupId>\n+            <artifactId>pulsar-client-original</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc1MjU2Ng==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547752566", "bodyText": "Yes , PulsarRowDecoder.decodeRow() call GenericXXXSchema.decode(ByteBuf byteBuf)  for GenericRecord.", "author": "hnail", "createdAt": "2020-12-23T07:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU4MDExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTA2ODI1Nw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r559068257", "bodyText": "It seems that the dependency pulsar-client-original is already in the pulsar-client-admin-original.", "author": "gaoran10", "createdAt": "2021-01-17T02:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU4MDExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNDY0NA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532604644", "bodyText": "Does the DecoderExtraInfo need to be printed?", "author": "gaoran10", "createdAt": "2020-11-30T13:42:19Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarColumnMetadata.java", "diffHunk": "@@ -88,8 +85,6 @@ public String toString() {\n         return \"PulsarColumnMetadata{\"\n             + \"isInternal=\" + isInternal\n             + \", nameWithCase='\" + nameWithCase + '\\''\n-            + \", fieldNames=\" + Arrays.toString(fieldNames)\n-            + \", positionIndices=\" + Arrays.toString(positionIndices)", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc1NDc1Mg==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547754752", "bodyText": "@gaoran10 thanks for the remind,  fixed as suggestion.", "author": "hnail", "createdAt": "2020-12-23T07:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNDY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNTMxNw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532605317", "bodyText": "Is it necessary to compare the DecoderExtraInfo?", "author": "gaoran10", "createdAt": "2020-11-30T13:43:27Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarColumnMetadata.java", "diffHunk": "@@ -114,12 +109,6 @@ public boolean equals(Object o) {\n         if (nameWithCase != null ? !nameWithCase.equals(that.nameWithCase) : that.nameWithCase != null) {\n             return false;\n         }\n-        if (!Arrays.deepEquals(fieldNames, that.fieldNames)) {\n-            return false;\n-        }\n-        if (!Arrays.deepEquals(positionIndices, that.positionIndices)) {\n-            return false;\n-        }", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc1NTAyMg==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547755022", "bodyText": "thanks for the remind, fixed as suggestion.", "author": "hnail", "createdAt": "2020-12-23T07:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNTMxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNTYyOQ==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532605629", "bodyText": "Is it necessary to compute the DecoderExtraInfo?", "author": "gaoran10", "createdAt": "2020-11-30T13:43:57Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarColumnMetadata.java", "diffHunk": "@@ -128,9 +117,91 @@ public int hashCode() {\n         int result = super.hashCode();\n         result = 31 * result + (isInternal ? 1 : 0);\n         result = 31 * result + (nameWithCase != null ? nameWithCase.hashCode() : 0);\n-        result = 31 * result + Arrays.hashCode(fieldNames);\n-        result = 31 * result + Arrays.hashCode(positionIndices);", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc1NjU0Ng==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547756546", "bodyText": "thanks for the remind, fixed as suggestion.", "author": "hnail", "createdAt": "2020-12-23T07:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwNTYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyODQ0OA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532628448", "bodyText": "The various decoder factories could be initialized at the Pulsar SQL beginning, one time is enough and they could be reused.", "author": "gaoran10", "createdAt": "2020-11-30T14:17:12Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarDispatchingRowDecoderFactory.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.sql.presto;\n+\n+import static java.lang.String.format;\n+\n+import com.google.inject.Inject;\n+\n+import io.airlift.log.Logger;\n+\n+import io.prestosql.decoder.DecoderColumnHandle;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.type.TypeManager;\n+\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.pulsar.common.naming.TopicName;\n+import org.apache.pulsar.common.schema.SchemaInfo;\n+import org.apache.pulsar.common.schema.SchemaType;\n+import org.apache.pulsar.sql.presto.decoder.avro.PulsarAvroRowDecoderFactory;\n+import org.apache.pulsar.sql.presto.decoder.json.PulsarJsonRowDecoderFactory;\n+import org.apache.pulsar.sql.presto.decoder.primitive.PulsarPrimitiveRowDecoderFactory;\n+\n+/**\n+ * dispatcher RowDecoderFactory for {@link org.apache.pulsar.common.schema.SchemaType}.\n+ */\n+public class PulsarDispatchingRowDecoderFactory {\n+\n+    private static final Logger log = Logger.get(PulsarDispatchingRowDecoderFactory.class);\n+\n+    private TypeManager typeManager;\n+\n+    @Inject\n+    public PulsarDispatchingRowDecoderFactory(TypeManager typeManager) {\n+        this.typeManager = typeManager;\n+    }\n+\n+    public PulsarRowDecoder createRowDecoder(TopicName topicName, SchemaInfo schemaInfo,\n+                                             Set<DecoderColumnHandle> columns) {\n+        PulsarRowDecoderFactory rowDecoderFactory = createDecoderFactory(schemaInfo);\n+        return rowDecoderFactory.createRowDecoder(topicName, schemaInfo, columns);\n+    }\n+\n+    public List<ColumnMetadata> extractColumnMetadata(TopicName topicName, SchemaInfo schemaInfo,\n+                                                      PulsarColumnHandle.HandleKeyValueType handleKeyValueType) {\n+        PulsarRowDecoderFactory rowDecoderFactory = createDecoderFactory(schemaInfo);\n+        return rowDecoderFactory.extractColumnMetadata(topicName, schemaInfo, handleKeyValueType);\n+    }\n+\n+    private PulsarRowDecoderFactory createDecoderFactory(SchemaInfo schemaInfo) {", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2MzA2OA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547763068", "bodyText": "@gaoran10 Agreed, That sounds like a good ieda to me. But i proposal can add another individual PR to optimize this , in current state, Make PR-8422 more simpler for friendly review is a good choice?", "author": "hnail", "createdAt": "2020-12-23T07:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyODQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY2MDEyMw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532660123", "bodyText": "It seems that the multi-version schema decoder cache could be added and the decoders could be reused.", "author": "gaoran10", "createdAt": "2020-11-30T14:59:50Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarRecordCursor.java", "diffHunk": "@@ -420,17 +435,92 @@ public boolean advanceNextPosition() {\n         //start time for deseralizing record\n         metricsTracker.start_RECORD_DESERIALIZE_TIME();\n \n-        if (this.schemaHandler instanceof KeyValueSchemaHandler) {\n-            ByteBuf keyByteBuf = null;\n+        SchemaInfo schemaInfo;\n+        try {\n+            schemaInfo =  schemaInfoProvider.getSchemaByVersion(this.currentMessage.getSchemaVersion()).get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        Map<ColumnHandle, FieldValueProvider> currentRowValuesMap = new HashMap<>();\n+\n+        if (schemaInfo.getType().equals(SchemaType.KEY_VALUE)) {\n+\n+            PulsarRowDecoder keyDecoder = decoderFactory.createRowDecoder(topicName,", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2MzQ0OQ==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547763449", "bodyText": "same as above. I proposal add another individual PR to optimize this.", "author": "hnail", "createdAt": "2020-12-23T07:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY2MDEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY2MDgyNw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532660827", "bodyText": "same as above.", "author": "gaoran10", "createdAt": "2020-11-30T15:00:42Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarRecordCursor.java", "diffHunk": "@@ -420,17 +435,92 @@ public boolean advanceNextPosition() {\n         //start time for deseralizing record\n         metricsTracker.start_RECORD_DESERIALIZE_TIME();\n \n-        if (this.schemaHandler instanceof KeyValueSchemaHandler) {\n-            ByteBuf keyByteBuf = null;\n+        SchemaInfo schemaInfo;\n+        try {\n+            schemaInfo =  schemaInfoProvider.getSchemaByVersion(this.currentMessage.getSchemaVersion()).get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        Map<ColumnHandle, FieldValueProvider> currentRowValuesMap = new HashMap<>();\n+\n+        if (schemaInfo.getType().equals(SchemaType.KEY_VALUE)) {\n+\n+            PulsarRowDecoder keyDecoder = decoderFactory.createRowDecoder(topicName,\n+                    schemaInfo,\n+                    columnHandles.stream()\n+                            .filter(col -> !col.isInternal())\n+                            .filter(col -> PulsarColumnHandle.HandleKeyValueType.KEY\n+                                    .equals(col.getHandleKeyValueType()))\n+                            .collect(toImmutableSet()));\n+\n+            PulsarRowDecoder messageDecoder = decoderFactory.createRowDecoder(topicName,", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2Mzc5Nw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547763797", "bodyText": "same as above. I proposal add another individual PR to optimize this.", "author": "hnail", "createdAt": "2020-12-23T07:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY2MDgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY3MDg4Ng==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532670886", "bodyText": "The switch is more efficient and the PulsarInternalColumn could be changed to an enum.", "author": "gaoran10", "createdAt": "2020-11-30T15:14:30Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarRecordCursor.java", "diffHunk": "@@ -420,17 +435,92 @@ public boolean advanceNextPosition() {\n         //start time for deseralizing record\n         metricsTracker.start_RECORD_DESERIALIZE_TIME();\n \n-        if (this.schemaHandler instanceof KeyValueSchemaHandler) {\n-            ByteBuf keyByteBuf = null;\n+        SchemaInfo schemaInfo;\n+        try {\n+            schemaInfo =  schemaInfoProvider.getSchemaByVersion(this.currentMessage.getSchemaVersion()).get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        Map<ColumnHandle, FieldValueProvider> currentRowValuesMap = new HashMap<>();\n+\n+        if (schemaInfo.getType().equals(SchemaType.KEY_VALUE)) {\n+\n+            PulsarRowDecoder keyDecoder = decoderFactory.createRowDecoder(topicName,\n+                    schemaInfo,\n+                    columnHandles.stream()\n+                            .filter(col -> !col.isInternal())\n+                            .filter(col -> PulsarColumnHandle.HandleKeyValueType.KEY\n+                                    .equals(col.getHandleKeyValueType()))\n+                            .collect(toImmutableSet()));\n+\n+            PulsarRowDecoder messageDecoder = decoderFactory.createRowDecoder(topicName,\n+                    schemaInfo,\n+                    columnHandles.stream()\n+                            .filter(col -> !col.isInternal())\n+                            .filter(col -> PulsarColumnHandle.HandleKeyValueType.VALUE\n+                                    .equals(col.getHandleKeyValueType()))\n+                            .collect(toImmutableSet()));\n+\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedKey;\n             if (this.currentMessage.getKeyBytes().isPresent()) {\n-                keyByteBuf = this.currentMessage.getKeyBytes().get();\n+                decodedKey = keyDecoder.decodeRow(this.currentMessage.getKeyBytes().get());\n+                decodedKey.ifPresent(currentRowValuesMap::putAll);\n             }\n-            currentRecord = this.schemaHandler.deserialize(keyByteBuf,\n-                    this.currentMessage.getData(), this.currentMessage.getSchemaVersion());\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue =\n+                    messageDecoder.decodeRow(this.currentMessage.getData());\n+            decodedValue.ifPresent(currentRowValuesMap::putAll);\n         } else {\n-            currentRecord = this.schemaHandler.deserialize(this.currentMessage.getData(),\n-                    this.currentMessage.getSchemaVersion());\n+            PulsarRowDecoder messageDecoder = decoderFactory.createRowDecoder(topicName,\n+                    schemaInfo,\n+                    columnHandles.stream()\n+                            .filter(col -> !col.isInternal())\n+                            .filter(col -> PulsarColumnHandle.HandleKeyValueType.NONE\n+                                    .equals(col.getHandleKeyValueType()))\n+                            .collect(toImmutableSet()));\n+            Optional<Map<DecoderColumnHandle, FieldValueProvider>> decodedValue =\n+                    messageDecoder.decodeRow(this.currentMessage.getData());\n+            decodedValue.ifPresent(currentRowValuesMap::putAll);\n+        }\n+\n+        for (DecoderColumnHandle columnHandle : columnHandles) {\n+            if (columnHandle.isInternal()) {\n+                if (PulsarInternalColumn.PARTITION.getName().equals(columnHandle.getName())) {", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc2NzUyNQ==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547767525", "bodyText": "thanks for the suggest, PulsarInternalColumn is static & final field, maybe this improvement is relatively small ? If we want optimize this, i suggest add another individual PR.", "author": "hnail", "createdAt": "2020-12-23T07:48:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY3MDg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NjcwNw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532686707", "bodyText": "Does this problem is fixed?", "author": "gaoran10", "createdAt": "2020-11-30T15:34:45Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/decoder/avro/PulsarAvroRowDecoderFactory.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.sql.presto.decoder.avro;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.VarcharType.createUnboundedVarcharType;\n+import static java.lang.String.format;\n+import static java.util.stream.Collectors.toList;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.decoder.DecoderColumnHandle;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.type.ArrayType;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.spi.type.BooleanType;\n+import io.prestosql.spi.type.DoubleType;\n+import io.prestosql.spi.type.IntegerType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.RowType;\n+import io.prestosql.spi.type.StandardTypes;\n+import io.prestosql.spi.type.TimestampType;\n+import io.prestosql.spi.type.Type;\n+import io.prestosql.spi.type.TypeManager;\n+import io.prestosql.spi.type.TypeSignature;\n+import io.prestosql.spi.type.TypeSignatureParameter;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.apache.avro.LogicalType;\n+import org.apache.avro.LogicalTypes;\n+import org.apache.avro.Schema;\n+import org.apache.avro.SchemaParseException;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.pulsar.client.impl.schema.generic.GenericAvroSchema;\n+import org.apache.pulsar.client.impl.schema.generic.GenericJsonSchema;\n+import org.apache.pulsar.common.naming.TopicName;\n+import org.apache.pulsar.common.schema.SchemaInfo;\n+import org.apache.pulsar.sql.presto.PulsarColumnHandle;\n+import org.apache.pulsar.sql.presto.PulsarColumnMetadata;\n+import org.apache.pulsar.sql.presto.PulsarRowDecoder;\n+import org.apache.pulsar.sql.presto.PulsarRowDecoderFactory;\n+\n+/**\n+ * PulsarRowDecoderFactory for {@link org.apache.pulsar.common.schema.SchemaType#AVRO}.\n+ */\n+public class PulsarAvroRowDecoderFactory implements PulsarRowDecoderFactory {\n+\n+    private TypeManager typeManager;\n+\n+    public PulsarAvroRowDecoderFactory(TypeManager typeManager) {\n+        this.typeManager = typeManager;\n+    }\n+\n+    @Override\n+    public PulsarRowDecoder createRowDecoder(TopicName topicName, SchemaInfo schemaInfo,\n+                                             Set<DecoderColumnHandle> columns) {\n+        return new PulsarAvroRowDecoder((GenericAvroSchema) GenericAvroSchema.of(schemaInfo), columns);\n+    }\n+\n+    @Override\n+    public List<ColumnMetadata> extractColumnMetadata(TopicName topicName, SchemaInfo schemaInfo,\n+                                                      PulsarColumnHandle.HandleKeyValueType handleKeyValueType) {\n+        String schemaJson = new String(schemaInfo.getSchema());\n+        if (StringUtils.isBlank(schemaJson)) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+        Schema schema;\n+        try {\n+            schema = GenericJsonSchema.of(schemaInfo).getAvroSchema();\n+        } catch (SchemaParseException ex) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+\n+        //TODO : check schema cyclic definitions which may case java.lang.StackOverflowError", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4MzA5NQ==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547783095", "bodyText": "I wanted to leave it to the future before, As your suggest, fix it in this PR may be fine choice.\nCircular reference is bad schema in relational database. ( e.g. spark https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/JavaTypeInference.scala#142).\nAt current code position, Cyclic definition will case java.lang.StackOverflowError instead of OOM, so this only cause current query failed instead of JVM crash. (so i wanted to leave it to the future before)\nAs your suggest , i add StackOverflowError check (TestAvroDecoder/TestJsonDecoder.testCyclicDefinitionDetect) as a simple solution, if we need complex solution, we can add a separate PR ( based graph traversals: https://www.geeksforgeeks.org/detect-cycle-in-a-graph/) to optimize it.", "author": "hnail", "createdAt": "2020-12-23T08:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NjcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4ODE5NA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532688194", "bodyText": "This feature will be added in the future, right?", "author": "gaoran10", "createdAt": "2020-11-30T15:36:38Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/decoder/avro/PulsarAvroRowDecoderFactory.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.sql.presto.decoder.avro;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.VarcharType.createUnboundedVarcharType;\n+import static java.lang.String.format;\n+import static java.util.stream.Collectors.toList;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.decoder.DecoderColumnHandle;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.type.ArrayType;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.spi.type.BooleanType;\n+import io.prestosql.spi.type.DoubleType;\n+import io.prestosql.spi.type.IntegerType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.RowType;\n+import io.prestosql.spi.type.StandardTypes;\n+import io.prestosql.spi.type.TimestampType;\n+import io.prestosql.spi.type.Type;\n+import io.prestosql.spi.type.TypeManager;\n+import io.prestosql.spi.type.TypeSignature;\n+import io.prestosql.spi.type.TypeSignatureParameter;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.apache.avro.LogicalType;\n+import org.apache.avro.LogicalTypes;\n+import org.apache.avro.Schema;\n+import org.apache.avro.SchemaParseException;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.pulsar.client.impl.schema.generic.GenericAvroSchema;\n+import org.apache.pulsar.client.impl.schema.generic.GenericJsonSchema;\n+import org.apache.pulsar.common.naming.TopicName;\n+import org.apache.pulsar.common.schema.SchemaInfo;\n+import org.apache.pulsar.sql.presto.PulsarColumnHandle;\n+import org.apache.pulsar.sql.presto.PulsarColumnMetadata;\n+import org.apache.pulsar.sql.presto.PulsarRowDecoder;\n+import org.apache.pulsar.sql.presto.PulsarRowDecoderFactory;\n+\n+/**\n+ * PulsarRowDecoderFactory for {@link org.apache.pulsar.common.schema.SchemaType#AVRO}.\n+ */\n+public class PulsarAvroRowDecoderFactory implements PulsarRowDecoderFactory {\n+\n+    private TypeManager typeManager;\n+\n+    public PulsarAvroRowDecoderFactory(TypeManager typeManager) {\n+        this.typeManager = typeManager;\n+    }\n+\n+    @Override\n+    public PulsarRowDecoder createRowDecoder(TopicName topicName, SchemaInfo schemaInfo,\n+                                             Set<DecoderColumnHandle> columns) {\n+        return new PulsarAvroRowDecoder((GenericAvroSchema) GenericAvroSchema.of(schemaInfo), columns);\n+    }\n+\n+    @Override\n+    public List<ColumnMetadata> extractColumnMetadata(TopicName topicName, SchemaInfo schemaInfo,\n+                                                      PulsarColumnHandle.HandleKeyValueType handleKeyValueType) {\n+        String schemaJson = new String(schemaInfo.getSchema());\n+        if (StringUtils.isBlank(schemaJson)) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+        Schema schema;\n+        try {\n+            schema = GenericJsonSchema.of(schemaInfo).getAvroSchema();\n+        } catch (SchemaParseException ex) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+\n+        //TODO : check schema cyclic definitions which may case java.lang.StackOverflowError\n+\n+        return schema.getFields().stream()\n+                .map(field ->\n+                        new PulsarColumnMetadata(field.name(), parseAvroPrestoType(\n+                                field.name(), field.schema()), field.schema().toString(), null, false, false,\n+                                handleKeyValueType, new PulsarColumnMetadata.DecoderExtraInfo(field.name(),\n+                                null, null))\n+\n+                ).collect(toList());\n+    }\n+\n+    private Type parseAvroPrestoType(String fieldname, Schema schema) {\n+        Schema.Type type = schema.getType();\n+        LogicalType logicalType  = schema.getLogicalType();\n+        switch (type) {\n+            case STRING:\n+            case ENUM:\n+                return createUnboundedVarcharType();\n+            case NULL:\n+                throw new UnsupportedOperationException(\n+                        format(\"field '%s' NULL type code should not be reached,\"\n+                                + \"please check the schema or report the bug.\", fieldname));\n+            case FIXED:\n+            case BYTES:\n+                //TODO: support decimal logicalType", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4NjUyNw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547786527", "bodyText": "Yes,presto kafka and spark haven't support it also :\n\nkafka https://prestosql.io/docs/current/connector/kafka.html#avro-encoder\nspark https://github.com/databricks/spark-avro/blob/branch-4.0/README-for-old-spark-versions.md", "author": "hnail", "createdAt": "2020-12-23T08:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4ODE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4ODc2Ng==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532688766", "bodyText": "same as above.", "author": "gaoran10", "createdAt": "2020-11-30T15:37:22Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/decoder/avro/PulsarAvroRowDecoderFactory.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.sql.presto.decoder.avro;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.VarcharType.createUnboundedVarcharType;\n+import static java.lang.String.format;\n+import static java.util.stream.Collectors.toList;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.decoder.DecoderColumnHandle;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.type.ArrayType;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.spi.type.BooleanType;\n+import io.prestosql.spi.type.DoubleType;\n+import io.prestosql.spi.type.IntegerType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.RowType;\n+import io.prestosql.spi.type.StandardTypes;\n+import io.prestosql.spi.type.TimestampType;\n+import io.prestosql.spi.type.Type;\n+import io.prestosql.spi.type.TypeManager;\n+import io.prestosql.spi.type.TypeSignature;\n+import io.prestosql.spi.type.TypeSignatureParameter;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.apache.avro.LogicalType;\n+import org.apache.avro.LogicalTypes;\n+import org.apache.avro.Schema;\n+import org.apache.avro.SchemaParseException;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.pulsar.client.impl.schema.generic.GenericAvroSchema;\n+import org.apache.pulsar.client.impl.schema.generic.GenericJsonSchema;\n+import org.apache.pulsar.common.naming.TopicName;\n+import org.apache.pulsar.common.schema.SchemaInfo;\n+import org.apache.pulsar.sql.presto.PulsarColumnHandle;\n+import org.apache.pulsar.sql.presto.PulsarColumnMetadata;\n+import org.apache.pulsar.sql.presto.PulsarRowDecoder;\n+import org.apache.pulsar.sql.presto.PulsarRowDecoderFactory;\n+\n+/**\n+ * PulsarRowDecoderFactory for {@link org.apache.pulsar.common.schema.SchemaType#AVRO}.\n+ */\n+public class PulsarAvroRowDecoderFactory implements PulsarRowDecoderFactory {\n+\n+    private TypeManager typeManager;\n+\n+    public PulsarAvroRowDecoderFactory(TypeManager typeManager) {\n+        this.typeManager = typeManager;\n+    }\n+\n+    @Override\n+    public PulsarRowDecoder createRowDecoder(TopicName topicName, SchemaInfo schemaInfo,\n+                                             Set<DecoderColumnHandle> columns) {\n+        return new PulsarAvroRowDecoder((GenericAvroSchema) GenericAvroSchema.of(schemaInfo), columns);\n+    }\n+\n+    @Override\n+    public List<ColumnMetadata> extractColumnMetadata(TopicName topicName, SchemaInfo schemaInfo,\n+                                                      PulsarColumnHandle.HandleKeyValueType handleKeyValueType) {\n+        String schemaJson = new String(schemaInfo.getSchema());\n+        if (StringUtils.isBlank(schemaJson)) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+        Schema schema;\n+        try {\n+            schema = GenericJsonSchema.of(schemaInfo).getAvroSchema();\n+        } catch (SchemaParseException ex) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+\n+        //TODO : check schema cyclic definitions which may case java.lang.StackOverflowError\n+\n+        return schema.getFields().stream()\n+                .map(field ->\n+                        new PulsarColumnMetadata(field.name(), parseAvroPrestoType(\n+                                field.name(), field.schema()), field.schema().toString(), null, false, false,\n+                                handleKeyValueType, new PulsarColumnMetadata.DecoderExtraInfo(field.name(),\n+                                null, null))\n+\n+                ).collect(toList());\n+    }\n+\n+    private Type parseAvroPrestoType(String fieldname, Schema schema) {\n+        Schema.Type type = schema.getType();\n+        LogicalType logicalType  = schema.getLogicalType();\n+        switch (type) {\n+            case STRING:\n+            case ENUM:\n+                return createUnboundedVarcharType();\n+            case NULL:\n+                throw new UnsupportedOperationException(\n+                        format(\"field '%s' NULL type code should not be reached,\"\n+                                + \"please check the schema or report the bug.\", fieldname));\n+            case FIXED:\n+            case BYTES:\n+                //TODO: support decimal logicalType\n+                return VarbinaryType.VARBINARY;\n+            case INT:\n+                if (logicalType == LogicalTypes.timeMillis()) {\n+                    return TIME;\n+                } else if (logicalType == LogicalTypes.date()) {\n+                    return DATE;\n+                }\n+                return IntegerType.INTEGER;\n+            case LONG:\n+                if (logicalType == LogicalTypes.timestampMillis()) {\n+                    return TimestampType.TIMESTAMP;\n+                }\n+                //TODO:  support timestamp_microseconds logicalType : https://github.com/prestosql/presto/issues/1284", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY5NDY1Nw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532694657", "bodyText": "Does this problem is fixed?", "author": "gaoran10", "createdAt": "2020-11-30T15:45:10Z", "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/decoder/json/PulsarJsonRowDecoderFactory.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.sql.presto.decoder.json;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static io.prestosql.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static io.prestosql.spi.type.DateType.DATE;\n+import static io.prestosql.spi.type.TimeType.TIME;\n+import static io.prestosql.spi.type.VarcharType.createUnboundedVarcharType;\n+import static java.lang.String.format;\n+import static java.util.stream.Collectors.toList;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.prestosql.decoder.DecoderColumnHandle;\n+import io.prestosql.spi.PrestoException;\n+import io.prestosql.spi.connector.ColumnMetadata;\n+import io.prestosql.spi.type.ArrayType;\n+import io.prestosql.spi.type.BigintType;\n+import io.prestosql.spi.type.BooleanType;\n+import io.prestosql.spi.type.DoubleType;\n+import io.prestosql.spi.type.IntegerType;\n+import io.prestosql.spi.type.RealType;\n+import io.prestosql.spi.type.RowType;\n+import io.prestosql.spi.type.StandardTypes;\n+import io.prestosql.spi.type.TimestampType;\n+import io.prestosql.spi.type.Type;\n+import io.prestosql.spi.type.TypeManager;\n+import io.prestosql.spi.type.TypeSignature;\n+import io.prestosql.spi.type.TypeSignatureParameter;\n+import io.prestosql.spi.type.VarbinaryType;\n+import io.prestosql.spi.type.VarcharType;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import org.apache.avro.LogicalType;\n+import org.apache.avro.LogicalTypes;\n+import org.apache.avro.Schema;\n+import org.apache.avro.SchemaParseException;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.pulsar.client.impl.schema.generic.GenericJsonSchema;\n+import org.apache.pulsar.common.naming.TopicName;\n+import org.apache.pulsar.common.schema.SchemaInfo;\n+import org.apache.pulsar.sql.presto.PulsarColumnHandle;\n+import org.apache.pulsar.sql.presto.PulsarColumnMetadata;\n+import org.apache.pulsar.sql.presto.PulsarRowDecoderFactory;\n+\n+/**\n+ * PulsarRowDecoderFactory for {@link org.apache.pulsar.common.schema.SchemaType#JSON}.\n+ */\n+public class PulsarJsonRowDecoderFactory implements PulsarRowDecoderFactory {\n+\n+    private TypeManager typeManager;\n+\n+    public PulsarJsonRowDecoderFactory(TypeManager typeManager) {\n+        this.typeManager = typeManager;\n+    }\n+\n+    @Override\n+    public PulsarJsonRowDecoder createRowDecoder(TopicName topicName, SchemaInfo schemaInfo,\n+                                                 Set<DecoderColumnHandle> columns) {\n+        return new PulsarJsonRowDecoder((GenericJsonSchema) GenericJsonSchema.of(schemaInfo), columns);\n+    }\n+\n+    @Override\n+    public List<ColumnMetadata> extractColumnMetadata(TopicName topicName, SchemaInfo schemaInfo,\n+                                                      PulsarColumnHandle.HandleKeyValueType handleKeyValueType) {\n+        String schemaJson = new String(schemaInfo.getSchema());\n+        if (StringUtils.isBlank(schemaJson)) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+        Schema schema;\n+        try {\n+            schema = GenericJsonSchema.of(schemaInfo).getAvroSchema();\n+        } catch (SchemaParseException ex) {\n+            throw new PrestoException(NOT_SUPPORTED, \"Topic \"\n+                    + topicName.toString() + \" does not have a valid schema\");\n+        }\n+\n+        //TODO : check schema cyclic definitions which may case java.lang.StackOverflowError", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzQ2Mw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532717463", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static List<TopicName>  topicNames;\n          \n          \n            \n                protected static List<TopicName> topicNames;", "author": "gaoran10", "createdAt": "2020-11-30T16:14:41Z", "path": "pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarConnector.java", "diffHunk": "@@ -110,16 +81,20 @@\n \n     protected Map<TopicName, PulsarRecordCursor> pulsarRecordCursors = new HashMap<>();\n \n+    protected static PulsarDispatchingRowDecoderFactory dispatchingRowDecoderFactory;\n+\n     protected final static PulsarConnectorId pulsarConnectorId = new PulsarConnectorId(\"test-connector\");\n \n-    protected static List<TopicName> topicNames;\n-    protected static List<TopicName> partitionedTopicNames;\n+    protected static List<TopicName>  topicNames;", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcwOA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532717708", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static List<TopicName>  partitionedTopicNames;\n          \n          \n            \n                protected static List<TopicName> partitionedTopicNames;", "author": "gaoran10", "createdAt": "2020-11-30T16:15:00Z", "path": "pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarConnector.java", "diffHunk": "@@ -110,16 +81,20 @@\n \n     protected Map<TopicName, PulsarRecordCursor> pulsarRecordCursors = new HashMap<>();\n \n+    protected static PulsarDispatchingRowDecoderFactory dispatchingRowDecoderFactory;\n+\n     protected final static PulsarConnectorId pulsarConnectorId = new PulsarConnectorId(\"test-connector\");\n \n-    protected static List<TopicName> topicNames;\n-    protected static List<TopicName> partitionedTopicNames;\n+    protected static List<TopicName>  topicNames;\n+    protected static List<TopicName>  partitionedTopicNames;", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxODAyNg==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532718026", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static List<String> fooFieldNames =  new ArrayList<>();\n          \n          \n            \n                protected static List<String> fooFieldNames = new ArrayList<>();", "author": "gaoran10", "createdAt": "2020-11-30T16:15:24Z", "path": "pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarConnector.java", "diffHunk": "@@ -110,16 +81,20 @@\n \n     protected Map<TopicName, PulsarRecordCursor> pulsarRecordCursors = new HashMap<>();\n \n+    protected static PulsarDispatchingRowDecoderFactory dispatchingRowDecoderFactory;\n+\n     protected final static PulsarConnectorId pulsarConnectorId = new PulsarConnectorId(\"test-connector\");\n \n-    protected static List<TopicName> topicNames;\n-    protected static List<TopicName> partitionedTopicNames;\n+    protected static List<TopicName>  topicNames;\n+    protected static List<TopicName>  partitionedTopicNames;\n     protected static Map<String, Integer> partitionedTopicsToPartitions;\n     protected static Map<String, SchemaInfo> topicsToSchemas;\n     protected static Map<String, Long> topicsToNumEntries;\n \n     private final static ObjectMapper objectMapper = new ObjectMapper();\n \n+    protected static List<String> fooFieldNames =  new ArrayList<>();", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMDA2NA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532720064", "bodyText": "Is there any test to test the nest object query?", "author": "gaoran10", "createdAt": "2020-11-30T16:18:19Z", "path": "pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarConnector.java", "diffHunk": "@@ -179,28 +150,13 @@\n     public static class Bar {\n         public Integer field1;\n         public String field2;\n-        public Boo test;", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4OTE4OA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547789188", "bodyText": "Yes, Foo.bar tested in main modules, and TestAvroDecoder\\TestJsonDecoder has also test nest object in Decoder.", "author": "hnail", "createdAt": "2020-12-23T08:14:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMDA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDE1NQ==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532730155", "bodyText": "Could you add a test for PulsarPrimitiveRowDecoder?", "author": "gaoran10", "createdAt": "2020-11-30T16:31:44Z", "path": "pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarPrimitiveSchemaHandler.java", "diffHunk": "@@ -1,164 +0,0 @@\n-/**\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.pulsar.sql.presto;\n-\n-import io.netty.buffer.ByteBufAllocator;\n-import io.prestosql.spi.connector.ColumnMetadata;\n-import lombok.extern.slf4j.Slf4j;\n-\n-import org.apache.pulsar.client.impl.schema.BooleanSchema;\n-import org.apache.pulsar.client.impl.schema.ByteSchema;\n-import org.apache.pulsar.client.impl.schema.BytesSchema;\n-import org.apache.pulsar.client.impl.schema.DateSchema;\n-import org.apache.pulsar.client.impl.schema.DoubleSchema;\n-import org.apache.pulsar.client.impl.schema.FloatSchema;\n-import org.apache.pulsar.client.impl.schema.IntSchema;\n-import org.apache.pulsar.client.impl.schema.LongSchema;\n-import org.apache.pulsar.client.impl.schema.ShortSchema;\n-import org.apache.pulsar.client.impl.schema.StringSchema;\n-import org.apache.pulsar.client.impl.schema.TimeSchema;\n-import org.apache.pulsar.client.impl.schema.TimestampSchema;\n-import org.apache.pulsar.common.api.raw.RawMessage;\n-import org.apache.pulsar.common.naming.TopicName;\n-import org.apache.pulsar.common.schema.SchemaInfo;\n-import org.apache.pulsar.common.schema.SchemaType;\n-import org.testng.Assert;\n-import org.testng.annotations.Test;\n-\n-import java.sql.Time;\n-import java.sql.Timestamp;\n-import java.util.Date;\n-import java.util.List;\n-\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.when;\n-\n-@Slf4j\n-public class TestPulsarPrimitiveSchemaHandler {", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc4OTk5MA==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547789990", "bodyText": "thanks for the remind, added TestPrimitiveDecoder", "author": "hnail", "createdAt": "2020-12-23T08:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMTI1Nw==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r532731257", "bodyText": "Could you add a test for KeyValueSchema datas?", "author": "gaoran10", "createdAt": "2020-11-30T16:33:15Z", "path": "pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarKeyValueSchemaHandler.java", "diffHunk": "@@ -1,353 +0,0 @@\n-/**\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.pulsar.sql.presto;\n-\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.Unpooled;\n-import io.prestosql.spi.connector.ColumnMetadata;\n-import java.io.IOException;\n-import java.util.LinkedList;\n-import java.util.List;\n-import java.util.Objects;\n-import java.util.Optional;\n-import lombok.Data;\n-import lombok.extern.slf4j.Slf4j;\n-import org.apache.pulsar.client.api.Schema;\n-import org.apache.pulsar.client.impl.schema.KeyValueSchema;\n-import org.apache.pulsar.client.impl.schema.KeyValueSchemaInfo;\n-import org.apache.pulsar.common.api.raw.RawMessage;\n-import org.apache.pulsar.common.api.raw.RawMessageImpl;\n-import org.apache.pulsar.common.naming.TopicName;\n-import org.apache.pulsar.common.schema.KeyValue;\n-import org.apache.pulsar.common.schema.KeyValueEncodingType;\n-import org.apache.pulsar.common.schema.SchemaInfo;\n-import org.mockito.Mockito;\n-import org.testng.Assert;\n-import org.testng.annotations.Test;\n-\n-import static org.mockito.Mockito.mock;\n-\n-\n-/**\n- * Unit test for KeyValueSchemaHandler\n- */\n-@Slf4j\n-public class TestPulsarKeyValueSchemaHandler {", "originalCommit": "7c5f93ce2e89894e985c5d986982dd34b54ba228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzc5NzA4MQ==", "url": "https://github.com/apache/pulsar/pull/8422#discussion_r547797081", "bodyText": "Thanks for the remind, added TestPulsarRecordCursor.TestKeyValueXXXSchema. In current version, KeyValue is a single-layer container schema without separate decoder, this Keep the codeStyle similar with presto-kafka.", "author": "hnail", "createdAt": "2020-12-23T08:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMTI1Nw=="}], "type": "inlineReview"}, {"oid": "f0a0c610fddc055075aec310a4f3f0e09b59e7fb", "url": "https://github.com/apache/pulsar/commit/f0a0c610fddc055075aec310a4f3f0e09b59e7fb", "message": "Update pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarConnector.java\n\nCo-authored-by: ran <gaoran_10@126.com>", "committedDate": "2020-12-01T06:00:13Z", "type": "commit"}, {"oid": "bf98970ad442e6d36728b6ec4600642d9dfa6b5c", "url": "https://github.com/apache/pulsar/commit/bf98970ad442e6d36728b6ec4600642d9dfa6b5c", "message": "Update pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarConnector.java\n\nCo-authored-by: ran <gaoran_10@126.com>", "committedDate": "2020-12-01T06:01:17Z", "type": "commit"}, {"oid": "dbcf5cd2c43eabbafda3decdd3625690697bd109", "url": "https://github.com/apache/pulsar/commit/dbcf5cd2c43eabbafda3decdd3625690697bd109", "message": "Update pulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestPulsarConnector.java\n\nCo-authored-by: ran <gaoran_10@126.com>", "committedDate": "2020-12-01T06:01:30Z", "type": "commit"}, {"oid": "25631991c24f4e6505236e5c2e92f08616900efb", "url": "https://github.com/apache/pulsar/commit/25631991c24f4e6505236e5c2e92f08616900efb", "message": "Merge branch 'master' of https://github.com/apache/pulsar into sql_migrate_decoder\n\n# Conflicts:\n#\tpulsar-sql/presto-distribution/LICENSE\n#\tpulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/AvroSchemaHandler.java\n#\tpulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarInternalColumn.java\n#\tpulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarMetadata.java\n#\tpulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarPrimitiveSchemaHandler.java\n#\tpulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarRecordCursor.java\n#\tpulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarSchemaHandlers.java\n#\tpulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarSqlSchemaInfoProvider.java\n#\tpulsar-sql/presto-pulsar/src/test/java/org/apache/pulsar/sql/presto/TestAvroSchemaHandler.java", "committedDate": "2020-12-17T10:05:14Z", "type": "commit"}, {"oid": "8cc673b615f76a29965b68b6445a76321e26d18b", "url": "https://github.com/apache/pulsar/commit/8cc673b615f76a29965b68b6445a76321e26d18b", "message": "Merge branch 'master' of https://github.com/apache/pulsar into sql_migrate_decoder", "committedDate": "2020-12-20T07:18:59Z", "type": "commit"}, {"oid": "11c0cefd4162a906986ecb89c4b7975395147b31", "url": "https://github.com/apache/pulsar/commit/11c0cefd4162a906986ecb89c4b7975395147b31", "message": "add keyValue\\Primitive schema test && add schema cyclic definition detect", "committedDate": "2020-12-23T07:24:03Z", "type": "commit"}, {"oid": "7f20d17657b51f8864519794c45d20709417756d", "url": "https://github.com/apache/pulsar/commit/7f20d17657b51f8864519794c45d20709417756d", "message": "Merge branch 'master' of https://github.com/apache/pulsar into sql_migrate_decoder", "committedDate": "2020-12-23T07:25:52Z", "type": "commit"}, {"oid": "6091b22dc1be7956a3017ef6e9471673b54796c6", "url": "https://github.com/apache/pulsar/commit/6091b22dc1be7956a3017ef6e9471673b54796c6", "message": "Merge branch 'master' into sql_migrate_decoder", "committedDate": "2021-01-18T08:04:52Z", "type": "commit"}, {"oid": "b91a0e4c221965fc9d43e4f10a2006f3281c07f7", "url": "https://github.com/apache/pulsar/commit/b91a0e4c221965fc9d43e4f10a2006f3281c07f7", "message": "Merge branch 'sql_migrate_decoder' of github.com:hnail/pulsar into sql_migrate_decoder", "committedDate": "2021-01-18T08:05:14Z", "type": "commit"}, {"oid": "c54c1d00fe35cc67e0356d0bddf6fc7cb89b19d3", "url": "https://github.com/apache/pulsar/commit/c54c1d00fe35cc67e0356d0bddf6fc7cb89b19d3", "message": "merge master", "committedDate": "2021-01-19T02:39:29Z", "type": "commit"}, {"oid": "16626f2c2071bf4159c42c79b4416080a1c0ebbf", "url": "https://github.com/apache/pulsar/commit/16626f2c2071bf4159c42c79b4416080a1c0ebbf", "message": "Merge branch 'master' of https://github.com/apache/pulsar into sql_migrate_decoder", "committedDate": "2021-01-29T06:04:01Z", "type": "commit"}, {"oid": "73dadc6b99d32ef958e584c791eb910e24cd90d6", "url": "https://github.com/apache/pulsar/commit/73dadc6b99d32ef958e584c791eb910e24cd90d6", "message": "merge master", "committedDate": "2021-01-31T07:46:26Z", "type": "commit"}]}