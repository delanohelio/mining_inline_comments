{"pr_number": 9091, "pr_title": "fix BKIncorrectParameterException", "pr_createdAt": "2020-12-30T06:26:48Z", "pr_url": "https://github.com/apache/pulsar/pull/9091", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk1NDE1Mw==", "url": "https://github.com/apache/pulsar/pull/9091#discussion_r549954153", "bodyText": "Using instanceof is a bad practice, not Object oriented.\nIt is not in the scope of this PR but it would be better to have a more OO approach, using polymorphism", "author": "eolivelli", "createdAt": "2020-12-30T06:45:36Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/intercept/ManagedLedgerInterceptorImpl.java", "diffHunk": "@@ -83,9 +83,9 @@ public void onManagedLedgerPropertiesInitialize(Map<String, String> propertiesMa\n     public void onManagedLedgerLastLedgerInitialize(String name, LedgerHandle lh) {\n         try {\n             for (BrokerEntryMetadataInterceptor interceptor : brokerEntryMetadataInterceptors) {\n-                if (interceptor instanceof AppendIndexMetadataInterceptor) {\n+                if (interceptor instanceof AppendIndexMetadataInterceptor && lh.getLastAddConfirmed() >= 0) {", "originalCommit": "80bec8fc924b49f749fb098e1a10cf42edec8bf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDAxMDU1OQ==", "url": "https://github.com/apache/pulsar/pull/9091#discussion_r550010559", "bodyText": "Agree with you that instanceof is not a good practice if we have a better choice.\nThere are two class AppendIndexMetadataInterceptor and AppendBrokerTimestampMetadataInterceptor implement BrokerEntryMetadataInterceptor.\nIf using polymorphism, for  AppendBrokerTimestampMetadataInterceptor, its recoveryIndexGenerator method do nothing like\npublic void recoveryIndexGenerator(long index) {\n       // do nothing.\n    }\nAnd the new onManagedLedgerLastLedgerInitialize would be like\n  @Override\n    public void onManagedLedgerLastLedgerInitialize(String name, LedgerHandle lh) {\n        try {\n            for (BrokerEntryMetadataInterceptor interceptor : brokerEntryMetadataInterceptors) {\n                if (lh.getLastAddConfirmed() >= 0) {\n                    LedgerEntries ledgerEntries =\n                            lh.read(lh.getLastAddConfirmed(), lh.getLastAddConfirmed());\n                    for (LedgerEntry entry : ledgerEntries) {\n                        PulsarApi.BrokerEntryMetadata brokerEntryMetadata =\n                                Commands.parseBrokerEntryMetadataIfExist(entry.getEntryBuffer());\n                        if (brokerEntryMetadata != null && brokerEntryMetadata.hasIndex()) {\n                                    interceptor.recoveryIndexGenerator(brokerEntryMetadata.getIndex());\n                        }\n                    }\n\n                }\n            }\n        } catch (org.apache.bookkeeper.client.api.BKException | InterruptedException e) {\n            log.error(\"[{}] Read last entry error.\", name, e);\n        }\n    }\nSo , even if interceptor is a AppendBrokerTimestampMetadataInterceptor, we still need to read the last entry from BookKeeper and  deserialize BrokerEntryMetadata  from the entry.\nhttps://github.com/aloyszhang/pulsar/blob/recovery-index/pulsar-broker/src/main/java/org/apache/pulsar/broker/intercept/ManagedLedgerInterceptorImpl.java#L87~L92\nLedgerEntries ledgerEntries =\n                            lh.read(lh.getLastAddConfirmed(), lh.getLastAddConfirmed());\n                    for (LedgerEntry entry : ledgerEntries) {\n                        PulsarApi.BrokerEntryMetadata brokerEntryMetadata =\n                                Commands.parseBrokerEntryMetadataIfExist(entry.getEntryBuffer());\n                        if (brokerEntryMetadata != null && brokerEntryMetadata.hasIndex()) {", "author": "aloyszhang", "createdAt": "2020-12-30T08:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk1NDE1Mw=="}], "type": "inlineReview"}, {"oid": "3d3ab5ba0968e0817bdeb218465647dc494ebccc", "url": "https://github.com/apache/pulsar/commit/3d3ab5ba0968e0817bdeb218465647dc494ebccc", "message": "fix BKIncorrectParameterException", "committedDate": "2021-01-04T01:19:02Z", "type": "commit"}, {"oid": "3d3ab5ba0968e0817bdeb218465647dc494ebccc", "url": "https://github.com/apache/pulsar/commit/3d3ab5ba0968e0817bdeb218465647dc494ebccc", "message": "fix BKIncorrectParameterException", "committedDate": "2021-01-04T01:19:02Z", "type": "forcePushed"}]}