{"pr_number": 7764, "pr_title": "Allow the option to make producers thread local", "pr_createdAt": "2020-08-05T23:30:18Z", "pr_url": "https://github.com/apache/pulsar/pull/7764", "timeline": [{"oid": "b053706ce8af8942d0038f8537bc696a1ceb5412", "url": "https://github.com/apache/pulsar/commit/b053706ce8af8942d0038f8537bc696a1ceb5412", "message": "Allow the option to make producers thread local", "committedDate": "2020-08-05T23:27:54Z", "type": "commit"}, {"oid": "30885f5a62eefc0b4cd6eb7287417b170229fc6b", "url": "https://github.com/apache/pulsar/commit/30885f5a62eefc0b4cd6eb7287417b170229fc6b", "message": "Fix tests", "committedDate": "2020-08-05T23:57:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5OTA5MA==", "url": "https://github.com/apache/pulsar/pull/7764#discussion_r466299090", "bodyText": "This would cause a NullPointerException if useThreadLocalProducers is not set.", "author": "sijie", "createdAt": "2020-08-06T09:52:07Z", "path": "pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/ContextImpl.java", "diffHunk": "@@ -102,19 +103,25 @@ public ContextImpl(InstanceConfig config, Logger logger, PulsarClient client,\n         this.config = config;\n         this.logger = logger;\n         this.client = client;\n-        this.publishProducers = new HashMap<>();\n         this.topicSchema = new TopicSchema(client);\n         this.statsManager = statsManager;\n \n         this.producerBuilder = (ProducerBuilderImpl<?>) client.newProducer().blockIfQueueFull(true).enableBatching(true)\n                 .batchingMaxPublishDelay(1, TimeUnit.MILLISECONDS);\n+        boolean useThreadLocalProducers = false;\n         if (config.getFunctionDetails().getSink().getProducerSpec() != null) {\n             if (config.getFunctionDetails().getSink().getProducerSpec().getMaxPendingMessages() != 0) {\n                 this.producerBuilder.maxPendingMessages(config.getFunctionDetails().getSink().getProducerSpec().getMaxPendingMessages());\n             }\n             if (config.getFunctionDetails().getSink().getProducerSpec().getMaxPendingMessagesAcrossPartitions() != 0) {\n                 this.producerBuilder.maxPendingMessagesAcrossPartitions(config.getFunctionDetails().getSink().getProducerSpec().getMaxPendingMessagesAcrossPartitions());\n             }\n+            useThreadLocalProducers = config.getFunctionDetails().getSink().getProducerSpec().getUseThreadLocalProducers();", "originalCommit": "30885f5a62eefc0b4cd6eb7287417b170229fc6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUzNDM4MA==", "url": "https://github.com/apache/pulsar/pull/7764#discussion_r466534380", "bodyText": "useThreadLocalProducers is a bool in protobuf. Its a primitive value which is always going to be present with a default value", "author": "srkukarni", "createdAt": "2020-08-06T16:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5OTA5MA=="}], "type": "inlineReview"}]}