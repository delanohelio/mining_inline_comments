{"pr_number": 7968, "pr_title": "[Issue 7759] Support set Max Consumer on topic level.", "pr_createdAt": "2020-09-03T11:36:51Z", "pr_url": "https://github.com/apache/pulsar/pull/7968", "timeline": [{"oid": "2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "url": "https://github.com/apache/pulsar/commit/2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "message": "Merge pull request #1 from apache/master\n\nmerge", "committedDate": "2020-08-28T02:05:01Z", "type": "commit"}, {"oid": "a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "url": "https://github.com/apache/pulsar/commit/a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "message": "Merge pull request #2 from apache/master\n\nmerge", "committedDate": "2020-08-31T01:04:34Z", "type": "commit"}, {"oid": "13df37f3e29e3c4f1696ed92405940c2405aab85", "url": "https://github.com/apache/pulsar/commit/13df37f3e29e3c4f1696ed92405940c2405aab85", "message": "Merge pull request #3 from apache/master\n\nmerge", "committedDate": "2020-09-03T00:03:30Z", "type": "commit"}, {"oid": "c535605d9355fcfe96cdcc9f5c0aa8575fff4489", "url": "https://github.com/apache/pulsar/commit/c535605d9355fcfe96cdcc9f5c0aa8575fff4489", "message": "Merge pull request #4 from apache/master\n\nmerge", "committedDate": "2020-09-03T09:07:18Z", "type": "commit"}, {"oid": "550963be7652a6c428b80e17b11e99184adf8233", "url": "https://github.com/apache/pulsar/commit/550963be7652a6c428b80e17b11e99184adf8233", "message": "[ISSUE 7759] Support set Max Consumer on topic level.", "committedDate": "2020-09-03T11:33:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483567506", "bodyText": "It is not recommended to use AsyncResponse, just return the value directly.\nmore info to see #7884", "author": "jianyun8023", "createdAt": "2020-09-04T11:51:18Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2417,6 +2417,53 @@ protected void internalGetMaxProducers(AsyncResponse asyncResponse) {\n         return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies.get());\n     }\n \n+    protected void internalGetMaxConsumers(AsyncResponse asyncResponse) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        Optional<Integer> maxConsumers = getTopicPolicies(topicName)\n+                .map(TopicPolicies::getMaxConsumerPerTopic);\n+        if (!maxConsumers.isPresent()) {\n+            asyncResponse.resume(Response.noContent().build());\n+        } else {\n+            asyncResponse.resume(maxConsumers.get());\n+        }\n+    }", "originalCommit": "550963be7652a6c428b80e17b11e99184adf8233", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU5ODE1Nw==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483598157", "bodyText": "How about making a new PR to resolve them all?", "author": "zhanghaou", "createdAt": "2020-09-04T12:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODkyMw==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484028923", "bodyText": "I think the new code can comply with this rule.", "author": "jianyun8023", "createdAt": "2020-09-06T06:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMzNTY0OQ==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484335649", "bodyText": "Done.", "author": "zhanghaou", "createdAt": "2020-09-07T10:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2ODgyMg==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483568822", "bodyText": "remove admin.topics().deletePartitionedTopic(testTopic, true);", "author": "jianyun8023", "createdAt": "2020-09-04T11:54:21Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicPoliciesTest.java", "diffHunk": "@@ -590,4 +591,121 @@ public void testRemovePublishRate() throws Exception {\n \n         admin.topics().deletePartitionedTopic(testTopic, true);\n     }\n+\n+    @Test\n+    public void testCheckMaxConsumers() throws Exception {\n+        Integer maxProducers = new Integer(-1);\n+        log.info(\"MaxConsumers: {} will set to the topic: {}\", maxProducers, testTopic);\n+        try {\n+            admin.topics().setMaxConsumers(testTopic, maxProducers);\n+            Assert.fail();\n+        } catch (PulsarAdminException e) {\n+            Assert.assertEquals(e.getStatusCode(), 412);\n+        }\n+\n+        admin.topics().deletePartitionedTopic(testTopic, true);\n+    }\n+\n+    @Test\n+    public void testSetMaxConsumers() throws Exception {\n+        admin.namespaces().setMaxConsumersPerTopic(myNamespace, 1);\n+        log.info(\"MaxConsumers: {} will set to the namespace: {}\", 1, myNamespace);\n+        Integer maxConsumers = 2;\n+        log.info(\"MaxConsumers: {} will set to the topic: {}\", maxConsumers, persistenceTopic);\n+        admin.topics().setMaxConsumers(persistenceTopic, maxConsumers);\n+        Thread.sleep(3000);\n+\n+        admin.topics().createPartitionedTopic(persistenceTopic, 2);\n+        Consumer consumer1 = null;\n+        Consumer consumer2 = null;\n+        Consumer consumer3 = null;\n+        try {\n+            consumer1 = pulsarClient.newConsumer().subscriptionName(\"sub1\").topic(persistenceTopic).subscribe();\n+        } catch (PulsarClientException e) {\n+            Assert.fail();\n+        }\n+        try {\n+            consumer2 = pulsarClient.newConsumer().subscriptionName(\"sub2\").topic(persistenceTopic).subscribe();\n+        } catch (PulsarClientException e) {\n+            Assert.fail();\n+        }\n+        try {\n+            consumer3 = pulsarClient.newConsumer().subscriptionName(\"sub3\").topic(persistenceTopic).subscribe();\n+            Assert.fail();\n+        } catch (PulsarClientException e) {\n+            log.info(\"Topic reached max consumers limit\");\n+        }\n+        Assert.assertNotNull(consumer1);\n+        Assert.assertNotNull(consumer2);\n+        Assert.assertNull(consumer3);\n+        consumer1.close();\n+        consumer2.close();\n+\n+        Integer getMaxConsumers = admin.topics().getMaxConsumers(persistenceTopic);\n+        log.info(\"MaxConsumers {} get on topic: {}\", getMaxConsumers, persistenceTopic);\n+        Assert.assertEquals(getMaxConsumers, maxConsumers);\n+\n+        admin.topics().deletePartitionedTopic(persistenceTopic, true);\n+        admin.topics().deletePartitionedTopic(testTopic, true);", "originalCommit": "550963be7652a6c428b80e17b11e99184adf8233", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU4NzY2OA==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483587668", "bodyText": "'testTopic' was created in BeforeMethod.", "author": "zhanghaou", "createdAt": "2020-09-04T12:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2ODgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODk3OA==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484028978", "bodyText": "Okay.", "author": "jianyun8023", "createdAt": "2020-09-06T06:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2ODgyMg=="}], "type": "inlineReview"}, {"oid": "80bbe5a82cfbfc0136b300099bb7352d4fcec583", "url": "https://github.com/apache/pulsar/commit/80bbe5a82cfbfc0136b300099bb7352d4fcec583", "message": "Merge pull request #5 from apache/master\n\nmerge", "committedDate": "2020-09-07T07:11:33Z", "type": "commit"}, {"oid": "bd91059134454ea67fe0ae66903b98ca71ea20a5", "url": "https://github.com/apache/pulsar/commit/bd91059134454ea67fe0ae66903b98ca71ea20a5", "message": "Merge remote-tracking branch 'origin/master' into set-max-consumer\n\n# Conflicts:\n#\tpulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "committedDate": "2020-09-07T07:24:29Z", "type": "commit"}, {"oid": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "url": "https://github.com/apache/pulsar/commit/f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "message": "bug fix.", "committedDate": "2020-09-07T07:48:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484378476", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    jcommander.addCommand(\"get-maxConsumers\", new GetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"set-maxConsumers\", new SetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"remove-maxConsumers\", new RemoveMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"get-max-consumers\", new GetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"set-max-consumers\", new SetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"remove-max-consumers\", new RemoveMaxConsumers());", "author": "codelipenghui", "createdAt": "2020-09-07T11:40:39Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -153,6 +153,9 @@ public CmdTopics(PulsarAdmin admin) {\n         jcommander.addCommand(\"get-inactive-topic-policies\", new GetInactiveTopicPolicies());\n         jcommander.addCommand(\"set-inactive-topic-policies\", new SetInactiveTopicPolicies());\n         jcommander.addCommand(\"remove-inactive-topic-policies\", new RemoveInactiveTopicPolicies());\n+        jcommander.addCommand(\"get-maxConsumers\", new GetMaxConsumers());\n+        jcommander.addCommand(\"set-maxConsumers\", new SetMaxConsumers());\n+        jcommander.addCommand(\"remove-maxConsumers\", new RemoveMaxConsumers());", "originalCommit": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODkzNA==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484378934", "bodyText": "And please also update the max producers as the above pattern.", "author": "codelipenghui", "createdAt": "2020-09-07T11:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQwOTA0MQ==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484409041", "bodyText": "Done.", "author": "zhanghaou", "createdAt": "2020-09-07T12:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng=="}], "type": "inlineReview"}, {"oid": "a45400dfdfb56734a055db309815bde216ef3e1d", "url": "https://github.com/apache/pulsar/commit/a45400dfdfb56734a055db309815bde216ef3e1d", "message": "rename command name.", "committedDate": "2020-09-07T12:41:21Z", "type": "commit"}]}