{"pr_number": 6732, "pr_title": "[C++] Auto update topic partitions", "pr_createdAt": "2020-04-13T15:07:23Z", "pr_url": "https://github.com/apache/pulsar/pull/6732", "timeline": [{"oid": "506f0809fdb61a810d882917caac511de5b43b54", "url": "https://github.com/apache/pulsar/commit/506f0809fdb61a810d882917caac511de5b43b54", "message": "auto update topic partitions extend for consumer and producer in c++ client", "committedDate": "2020-04-09T13:27:35Z", "type": "commit"}, {"oid": "09451aec81e7c56393ed23b518d199a7edbb53b9", "url": "https://github.com/apache/pulsar/commit/09451aec81e7c56393ed23b518d199a7edbb53b9", "message": "add c++ unit test for partitions update", "committedDate": "2020-04-13T14:51:27Z", "type": "commit"}, {"oid": "1748bb61f163bf41aebee6070532eebadbac678d", "url": "https://github.com/apache/pulsar/commit/1748bb61f163bf41aebee6070532eebadbac678d", "message": "format code with clang-format-5.0", "committedDate": "2020-04-14T03:09:16Z", "type": "commit"}, {"oid": "b4d2a92939197bbf1fa6319eb578135de3006cb1", "url": "https://github.com/apache/pulsar/commit/b4d2a92939197bbf1fa6319eb578135de3006cb1", "message": "stop partitions update timer after producer/consumer called closeAsync()", "committedDate": "2020-04-15T06:35:19Z", "type": "commit"}, {"oid": "89ba47132685846f59cceeeb510868069392638e", "url": "https://github.com/apache/pulsar/commit/89ba47132685846f59cceeeb510868069392638e", "message": "fix bugs when running gtest-parallel", "committedDate": "2020-04-15T16:32:19Z", "type": "commit"}, {"oid": "89ba47132685846f59cceeeb510868069392638e", "url": "https://github.com/apache/pulsar/commit/89ba47132685846f59cceeeb510868069392638e", "message": "fix bugs when running gtest-parallel", "committedDate": "2020-04-15T16:32:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1ODgyMQ==", "url": "https://github.com/apache/pulsar/pull/6732#discussion_r409658821", "bodyText": "Could this change be avoid? Seems brings in lot of un-needed changes, also a little confusing to made numPartitions_ and numPartitions mix-used together in this file.", "author": "jiazhai", "createdAt": "2020-04-16T15:42:58Z", "path": "pulsar-client-cpp/lib/PartitionedConsumerImpl.cc", "diffHunk": "@@ -162,14 +174,17 @@ void PartitionedConsumerImpl::handleUnsubscribeAsync(Result result, unsigned int\n         callback(ResultUnknownError);\n         return;\n     }\n-    assert(unsubscribedSoFar_ <= numPartitions_);\n-    assert(consumerIndex <= numPartitions_);\n+    Lock consumersLock(consumersMutex_);\n+    const auto numPartitions = numPartitions_;", "originalCommit": "6b2e55ef9d074a86a9ff619b71ae0ca24b187dd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4MDYwNg==", "url": "https://github.com/apache/pulsar/pull/6732#discussion_r409680606", "bodyText": "I'll change soon, here I should've called method like getNumPartitionsWithLock() (like I did in PartitionedConsumerImpl.\nBecause producers_/consumers_ may be modified in timer's callback, the code that accessed producers_/consumers_ and some other members (see comments in headers) should be protected by lock()/unlock(), except in start().", "author": "BewareMyPower", "createdAt": "2020-04-16T16:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1ODgyMQ=="}], "type": "inlineReview"}, {"oid": "9de457a44fdf4c3369069b1f81fd01a9d5978c48", "url": "https://github.com/apache/pulsar/commit/9de457a44fdf4c3369069b1f81fd01a9d5978c48", "message": "fix bug: Producer::flush() may cause deadlock", "committedDate": "2020-04-17T14:23:16Z", "type": "commit"}, {"oid": "657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "url": "https://github.com/apache/pulsar/commit/657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "message": "use getters to read `numPartitions` with or without lock", "committedDate": "2020-04-17T17:58:02Z", "type": "commit"}, {"oid": "657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "url": "https://github.com/apache/pulsar/commit/657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "message": "use getters to read `numPartitions` with or without lock", "committedDate": "2020-04-17T17:58:02Z", "type": "forcePushed"}, {"oid": "9de457a44fdf4c3369069b1f81fd01a9d5978c48", "url": "https://github.com/apache/pulsar/commit/9de457a44fdf4c3369069b1f81fd01a9d5978c48", "message": "fix bug: Producer::flush() may cause deadlock", "committedDate": "2020-04-17T14:23:16Z", "type": "forcePushed"}, {"oid": "89ba47132685846f59cceeeb510868069392638e", "url": "https://github.com/apache/pulsar/commit/89ba47132685846f59cceeeb510868069392638e", "message": "fix bugs when running gtest-parallel", "committedDate": "2020-04-15T16:32:19Z", "type": "forcePushed"}]}