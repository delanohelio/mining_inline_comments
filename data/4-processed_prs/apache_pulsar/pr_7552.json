{"pr_number": 7552, "pr_title": "[Transaction] Produce transaction messages and commit", "pr_createdAt": "2020-07-16T02:52:26Z", "pr_url": "https://github.com/apache/pulsar/pull/7552", "timeline": [{"oid": "23a279bfad160b0d300aff46cc995e71b1d791c2", "url": "https://github.com/apache/pulsar/commit/23a279bfad160b0d300aff46cc995e71b1d791c2", "message": "handle transactionSendFuture", "committedDate": "2020-07-17T04:02:16Z", "type": "forcePushed"}, {"oid": "cc99b42bb503a96ff268c5a911f33028bdb564e6", "url": "https://github.com/apache/pulsar/commit/cc99b42bb503a96ff268c5a911f33028bdb564e6", "message": "sync pom files with master", "committedDate": "2020-07-21T02:43:07Z", "type": "forcePushed"}, {"oid": "13ffd285a9e62485879b1ce819d2e4638b4179c9", "url": "https://github.com/apache/pulsar/commit/13ffd285a9e62485879b1ce819d2e4638b4179c9", "message": "fix test", "committedDate": "2020-07-23T15:42:49Z", "type": "forcePushed"}, {"oid": "8fbcf1248f7b11219511ec38d8233bf52cea2320", "url": "https://github.com/apache/pulsar/commit/8fbcf1248f7b11219511ec38d8233bf52cea2320", "message": "test", "committedDate": "2020-07-27T02:41:53Z", "type": "forcePushed"}, {"oid": "ce460c90dddd9da8b4aa44ea03a700de0e27fa82", "url": "https://github.com/apache/pulsar/commit/ce460c90dddd9da8b4aa44ea03a700de0e27fa82", "message": "test", "committedDate": "2020-07-27T14:47:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAwODU4MA==", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r457008580", "bodyText": "It's better to config in the broker.conf.", "author": "codelipenghui", "createdAt": "2020-07-20T03:12:46Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -549,6 +552,9 @@ public Boolean get() {\n                 transactionMetadataStoreService = new TransactionMetadataStoreService(TransactionMetadataStoreProvider\n                         .newProvider(config.getTransactionMetadataStoreProviderClassName()), this);\n                 transactionMetadataStoreService.start();\n+\n+                transactionBufferProvider = TransactionBufferProvider.newProvider(\n+                        PersistentTransactionBufferProvider.class.getName());", "originalCommit": "cd4bdb16433a3c4a44da08387b773cb867a99e3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMjk3MQ==", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r461812971", "bodyText": "Ok, I'll fix it.", "author": "gaoran10", "createdAt": "2020-07-28T19:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAwODU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwMzM0OQ==", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r461603349", "bodyText": "It's better to handle the transaction message in the topic, not the server cnx.", "author": "codelipenghui", "createdAt": "2020-07-28T14:01:11Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1212,6 +1221,33 @@ protected void handleSend(CommandSend send, ByteBuf headersAndPayload) {\n \n         startSendOperation(producer, headersAndPayload.readableBytes(), send.getNumMessages());\n \n+        final long produceId = producer.getProducerId();", "originalCommit": "ce460c90dddd9da8b4aa44ea03a700de0e27fa82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMzk5Mw==", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r461813993", "bodyText": "Yes, that's more reasonable.", "author": "gaoran10", "createdAt": "2020-07-28T19:17:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwMzM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5OTU0Mg==", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r462299542", "bodyText": "We should handle it in the TC and TC should retry to make sure the TB can handle success.", "author": "codelipenghui", "createdAt": "2020-07-29T13:30:53Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1674,40 +1687,134 @@ protected void handleAddPartitionToTxn(PulsarApi.CommandAddPartitionToTxn comman\n \n     @Override\n     protected void handleEndTxn(PulsarApi.CommandEndTxn command) {\n-        TxnStatus newStatus = null;\n+        TxnID txnID = new TxnID(command.getTxnidMostBits(), command.getTxnidLeastBits());\n+        final TxnStatus newStatus;\n         switch (command.getTxnAction()) {\n             case COMMIT:\n                 newStatus = TxnStatus.COMMITTING;\n                 break;\n             case ABORT:\n                 newStatus = TxnStatus.ABORTING;\n                 break;\n+            default:\n+                UnsupportedTxnActionException exception =\n+                        new UnsupportedTxnActionException(txnID, command.getTxnAction());\n+                log.error(exception.getMessage());\n+                ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(), txnID.getMostSigBits(),\n+                        BrokerServiceException.getClientErrorCode(exception), exception.getMessage()));\n+                return;\n         }\n-        TxnID txnID = new TxnID(command.getTxnidMostBits(), command.getTxnidLeastBits());\n         if (log.isDebugEnabled()) {\n             log.debug(\"Receive end txn by {} request {} from {} with txnId {}\", newStatus, command.getRequestId(), remoteAddress, txnID);\n         }\n+        final long requestId = command.getRequestId();\n         service.pulsar().getTransactionMetadataStoreService().updateTxnStatus(txnID, newStatus, TxnStatus.OPEN)\n-            .whenComplete((v, ex) -> {\n-                if (ex == null) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(\"Send response success for end txn request {}\", command.getRequestId());\n-                    }\n-                    ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(),\n+            .thenRun(() -> {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Send response success for end txn request {}\", command.getRequestId());\n+                }\n+                updateTBStatus(txnID, newStatus).thenRun(() -> {\n+                    service.pulsar().getTransactionMetadataStoreService()\n+                            .updateTxnStatus(txnID, TxnStatus.COMMITTED, TxnStatus.COMMITTING);\n+                    ctx.writeAndFlush(Commands.newEndTxnResponse(requestId,\n                             txnID.getLeastSigBits(), txnID.getMostSigBits()));\n+                }).exceptionally(throwable -> {\n+                    log.error(\"Failed to get txn `\" + txnID + \"` txnMeta.\", throwable);\n+                    ctx.writeAndFlush(Commands.newEndTxnResponse(requestId, txnID.getMostSigBits(),\n+                            BrokerServiceException.getClientErrorCode(throwable), throwable.getMessage()));\n+                    return null;\n+                });\n+            }).exceptionally(throwable -> {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Send response error for end txn request {}\", command.getRequestId());\n+                }\n+                ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(), txnID.getMostSigBits(),\n+                        BrokerServiceException.getClientErrorCode(throwable), throwable.getMessage()));\n+                return null;\n+        });", "originalCommit": "00ea5fbc17e40a98f459d820998c608b3540c895", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1NzA1MQ==", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r462457051", "bodyText": "Yes, I'll fix this.", "author": "gaoran10", "createdAt": "2020-07-29T17:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5OTU0Mg=="}], "type": "inlineReview"}, {"oid": "70eb13b4767188e00202e5dfd5f1f06f98d7e400", "url": "https://github.com/apache/pulsar/commit/70eb13b4767188e00202e5dfd5f1f06f98d7e400", "message": "fix test", "committedDate": "2020-08-05T18:07:03Z", "type": "forcePushed"}, {"oid": "b732702ef2ced2d462433bc0ae8d48f7b88bb831", "url": "https://github.com/apache/pulsar/commit/b732702ef2ced2d462433bc0ae8d48f7b88bb831", "message": "transaction integration", "committedDate": "2020-08-07T07:53:17Z", "type": "commit"}, {"oid": "791136099f300ebdb891037afaff351de6777dcd", "url": "https://github.com/apache/pulsar/commit/791136099f300ebdb891037afaff351de6777dcd", "message": "produce messages transaction integration", "committedDate": "2020-08-07T07:53:17Z", "type": "commit"}, {"oid": "20eda3237cc48406d3d9b466a04fcca7616065e8", "url": "https://github.com/apache/pulsar/commit/20eda3237cc48406d3d9b466a04fcca7616065e8", "message": "handle transactionSendFuture", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "0ed5f3a78f3ee43874d7f1b8a7acefe845eb7547", "url": "https://github.com/apache/pulsar/commit/0ed5f3a78f3ee43874d7f1b8a7acefe845eb7547", "message": "fix", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "dd11f1f2d388e7c95de693d94955117ec2529627", "url": "https://github.com/apache/pulsar/commit/dd11f1f2d388e7c95de693d94955117ec2529627", "message": "fix", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "e13a8c238b4fed1224188f5c632ff66076d32fa7", "url": "https://github.com/apache/pulsar/commit/e13a8c238b4fed1224188f5c632ff66076d32fa7", "message": "fix", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "17c70ece4f56944e1eac0f4c7a051801b16ab1b3", "url": "https://github.com/apache/pulsar/commit/17c70ece4f56944e1eac0f4c7a051801b16ab1b3", "message": "fix checkstyle", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "f59e5e4805f17ce6a87fe032b2589998bcd5c0c3", "url": "https://github.com/apache/pulsar/commit/f59e5e4805f17ce6a87fe032b2589998bcd5c0c3", "message": "fix", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "a5c01c1a5e996b929199efe2c3dd545a398b30b6", "url": "https://github.com/apache/pulsar/commit/a5c01c1a5e996b929199efe2c3dd545a398b30b6", "message": "Add a lock for the `transactionBuffer` of the `AbstractTopic.java` to avoid multi threads create transactionBuffer.", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "7e597a8b12d34ff16d7496d09968d1198f0e0836", "url": "https://github.com/apache/pulsar/commit/7e597a8b12d34ff16d7496d09968d1198f0e0836", "message": "revert pom files", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "eb64e08db11e4554ba62fc5032e17ff85d7cbb42", "url": "https://github.com/apache/pulsar/commit/eb64e08db11e4554ba62fc5032e17ff85d7cbb42", "message": "fix default value of the `txnid_least_bits` and `txnid_most_bits` in `PulsarApi.proto`.", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "bdb045a30205b5bc612814c1437c0a80970ddd8c", "url": "https://github.com/apache/pulsar/commit/bdb045a30205b5bc612814c1437c0a80970ddd8c", "message": "Add pulsar client config `enableTransaction` to start transactionCoordinatorClient.", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "228d2e085d903eaf01949ea013458179b010f1c3", "url": "https://github.com/apache/pulsar/commit/228d2e085d903eaf01949ea013458179b010f1c3", "message": "test", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "df58778d22c487e0ba10a3eeaef9367219383cf5", "url": "https://github.com/apache/pulsar/commit/df58778d22c487e0ba10a3eeaef9367219383cf5", "message": "sync pom files with master", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "9609c7d716140b80d40605ad397fc32b37ae2815", "url": "https://github.com/apache/pulsar/commit/9609c7d716140b80d40605ad397fc32b37ae2815", "message": "fix test", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "393ce74e8e2e6e60b572a3c868471ba3ea0321d7", "url": "https://github.com/apache/pulsar/commit/393ce74e8e2e6e60b572a3c868471ba3ea0321d7", "message": "fix test", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "b1f77f0384dde71bd5fe2d05c28a46d84c4d7b54", "url": "https://github.com/apache/pulsar/commit/b1f77f0384dde71bd5fe2d05c28a46d84c4d7b54", "message": "test", "committedDate": "2020-08-07T07:55:31Z", "type": "commit"}, {"oid": "cb89cfda04be771d736f8e9f842e9f6ae086847d", "url": "https://github.com/apache/pulsar/commit/cb89cfda04be771d736f8e9f842e9f6ae086847d", "message": "1. Add transactionBufferProviderClassName in ServiceConfiguration;\n2. Adjust publish transaction message logic;\n2. Integrate with TransactionBufferClientImpl;\n3. Update unit test, support multi brokers.", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "169b79603ec1000dd5cf9e2daaa56fcdae2d46f1", "url": "https://github.com/apache/pulsar/commit/169b79603ec1000dd5cf9e2daaa56fcdae2d46f1", "message": "fix", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "2eaf608bee4ea4e050a5bc22369c53647af0f858", "url": "https://github.com/apache/pulsar/commit/2eaf608bee4ea4e050a5bc22369c53647af0f858", "message": "fix license check", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "99da075273fd114453cdb863ce55e96222273016", "url": "https://github.com/apache/pulsar/commit/99da075273fd114453cdb863ce55e96222273016", "message": "fix", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "beca4d2353fc109426b1d4719aaddf3a71cdb2ad", "url": "https://github.com/apache/pulsar/commit/beca4d2353fc109426b1d4719aaddf3a71cdb2ad", "message": "fix", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "5c1ba345d30bf8577b297c69cf09b4ccd7a1ea4f", "url": "https://github.com/apache/pulsar/commit/5c1ba345d30bf8577b297c69cf09b4ccd7a1ea4f", "message": "fix test", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "d5745431c4c4c7eeba4ab4d1a680110460906585", "url": "https://github.com/apache/pulsar/commit/d5745431c4c4c7eeba4ab4d1a680110460906585", "message": "fix test", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "f9ec47ac4b75ca037d49ed275a2dd056784f110e", "url": "https://github.com/apache/pulsar/commit/f9ec47ac4b75ca037d49ed275a2dd056784f110e", "message": "adjust commit logic", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "df2ee264d784864f58c3abc9472a1bd1c956a337", "url": "https://github.com/apache/pulsar/commit/df2ee264d784864f58c3abc9472a1bd1c956a337", "message": "adjust endTxnOnPartition command process", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "f60fc38cdb447af5a9670d6947103f8336fc03b3", "url": "https://github.com/apache/pulsar/commit/f60fc38cdb447af5a9670d6947103f8336fc03b3", "message": "fix", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "7fb06a8cbfcefc90ef851f524a5b6b05b2b01584", "url": "https://github.com/apache/pulsar/commit/7fb06a8cbfcefc90ef851f524a5b6b05b2b01584", "message": "fix test", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "ee591c8ff6eaf1a078c9e42f701fa2fbad0432c2", "url": "https://github.com/apache/pulsar/commit/ee591c8ff6eaf1a078c9e42f701fa2fbad0432c2", "message": "fix test", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "a1f5490612b9cc1242a4d963e2ae59d67a41eddd", "url": "https://github.com/apache/pulsar/commit/a1f5490612b9cc1242a4d963e2ae59d67a41eddd", "message": "fix test", "committedDate": "2020-08-07T07:55:32Z", "type": "commit"}, {"oid": "a1f5490612b9cc1242a4d963e2ae59d67a41eddd", "url": "https://github.com/apache/pulsar/commit/a1f5490612b9cc1242a4d963e2ae59d67a41eddd", "message": "fix test", "committedDate": "2020-08-07T07:55:32Z", "type": "forcePushed"}]}