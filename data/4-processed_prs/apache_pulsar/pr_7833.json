{"pr_number": 7833, "pr_title": "[Transaction] Consume transaction message logic optimized", "pr_createdAt": "2020-08-18T03:03:51Z", "pr_url": "https://github.com/apache/pulsar/pull/7833", "timeline": [{"oid": "010d77540cac885b8af814b1552a2dc5aa82163e", "url": "https://github.com/apache/pulsar/commit/010d77540cac885b8af814b1552a2dc5aa82163e", "message": "fix test", "committedDate": "2020-08-20T14:00:35Z", "type": "forcePushed"}, {"oid": "ea9bbafe5dedcc51e0ebeb5560690f133c3313d4", "url": "https://github.com/apache/pulsar/commit/ea9bbafe5dedcc51e0ebeb5560690f133c3313d4", "message": "fix test", "committedDate": "2020-08-21T02:04:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMjYzNw==", "url": "https://github.com/apache/pulsar/pull/7833#discussion_r478232637", "bodyText": "batchDeletedIndexes.computeIfAbsent().", "author": "codelipenghui", "createdAt": "2020-08-27T08:04:14Z", "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorImpl.java", "diffHunk": "@@ -2857,5 +2857,14 @@ private int applyMaxSizeCap(int maxEntries, long maxSizeBytes) {\n \n         return Math.min(maxEntriesBasedOnSize, maxEntries);\n     }\n+\n+    public void internalInitBatchDeletedIndex(PositionImpl position, int totalNumMessageInBatch) {\n+        if (!batchDeletedIndexes.containsKey(position)) {\n+            BitSetRecyclable bitSetRecyclable = BitSetRecyclable.create();\n+            bitSetRecyclable.set(0, totalNumMessageInBatch);\n+            batchDeletedIndexes.put(position, bitSetRecyclable);\n+        }", "originalCommit": "b19df42411233d9717160a6e6024a4d29382f0e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU0OTU5NQ==", "url": "https://github.com/apache/pulsar/pull/7833#discussion_r478549595", "bodyText": "I'll use this method instead.", "author": "gaoran10", "createdAt": "2020-08-27T16:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMjYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI0MzkzOQ==", "url": "https://github.com/apache/pulsar/pull/7833#discussion_r478243939", "bodyText": "Shall we need this change?", "author": "codelipenghui", "createdAt": "2020-08-27T08:23:38Z", "path": ".github/workflows/ci-unit-broker-broker-gp1.yaml", "diffHunk": "@@ -65,13 +65,13 @@ jobs:\n         if: steps.docs.outputs.changed_only == 'no'\n         run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='**/AdminApiOffloadTest.java' -DtestForkCount=1 -DtestReuseFork=true\n \n-      - name: run flaky test '**/TransactionProduceTest.java'\n+      - name: run transaction test\n         if: steps.docs.outputs.changed_only == 'no'\n-        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='**/TransactionProduceTest.java' -DtestForkCount=1 -DtestReuseFork=true\n+        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='org/apache/pulsar/broker/transaction/**/*.java,org/apache/pulsar/client/transaction/**/*.java' -DfailIfNoTests=false -DtestForkCount=1 -DtestReuseFork=true\n \n       - name: run unit tests for pulsar-broker\n         if: steps.docs.outputs.changed_only == 'no'\n-        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='org/apache/pulsar/broker/**/*.java' -Dexclude='org/apache/pulsar/broker/zookeeper/**/*.java,org/apache/pulsar/broker/loadbalance/**/*.java,org/apache/pulsar/broker/service/**/*.java,**/AdminApiOffloadTest.java,**/TransactionProduceTest.java'\n+        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='org/apache/pulsar/broker/**/*.java' -Dexclude='org/apache/pulsar/broker/zookeeper/**/*.java,org/apache/pulsar/broker/loadbalance/**/*.java,org/apache/pulsar/broker/service/**/*.java,**/AdminApiOffloadTest.java,org/apache/pulsar/broker/transaction/**/*.java,org/apache/pulsar/client/transaction/**/*.java'", "originalCommit": "b19df42411233d9717160a6e6024a4d29382f0e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d7f05a7c877af57de78b6122f2fd4aea87e38f64", "url": "https://github.com/apache/pulsar/commit/d7f05a7c877af57de78b6122f2fd4aea87e38f64", "message": "adjust consume transaction message logic", "committedDate": "2020-08-27T12:14:54Z", "type": "commit"}, {"oid": "61696baa027baebb8623d104154e3f6a910994e5", "url": "https://github.com/apache/pulsar/commit/61696baa027baebb8623d104154e3f6a910994e5", "message": "change the way to get the Entry startBatchIndex", "committedDate": "2020-08-27T12:14:55Z", "type": "commit"}, {"oid": "36c1a2ac9751742f14718e86b14670329a04bfc1", "url": "https://github.com/apache/pulsar/commit/36c1a2ac9751742f14718e86b14670329a04bfc1", "message": "fix", "committedDate": "2020-08-27T12:14:55Z", "type": "commit"}, {"oid": "d211a07ec5bc0cdd7ee5ba4c14d604cf72a72bb7", "url": "https://github.com/apache/pulsar/commit/d211a07ec5bc0cdd7ee5ba4c14d604cf72a72bb7", "message": "fix test", "committedDate": "2020-08-27T12:14:55Z", "type": "commit"}, {"oid": "19daadbd89e8f771e15fd85456bec016e80218de", "url": "https://github.com/apache/pulsar/commit/19daadbd89e8f771e15fd85456bec016e80218de", "message": "fix test", "committedDate": "2020-08-27T12:14:55Z", "type": "commit"}, {"oid": "889c920501bcef60617b714dfbbffec2c5af7784", "url": "https://github.com/apache/pulsar/commit/889c920501bcef60617b714dfbbffec2c5af7784", "message": "make the TransactionEntry extends Entry", "committedDate": "2020-08-27T12:14:55Z", "type": "commit"}, {"oid": "7fd58bdaa0a4d8218c7919bb99aed4e83163415b", "url": "https://github.com/apache/pulsar/commit/7fd58bdaa0a4d8218c7919bb99aed4e83163415b", "message": "fix test", "committedDate": "2020-08-27T12:14:55Z", "type": "commit"}, {"oid": "65a305a9a69221d54b786b3d867f807a6ee4e39d", "url": "https://github.com/apache/pulsar/commit/65a305a9a69221d54b786b3d867f807a6ee4e39d", "message": "fix test", "committedDate": "2020-08-27T12:14:55Z", "type": "commit"}, {"oid": "fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "url": "https://github.com/apache/pulsar/commit/fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "message": "fix", "committedDate": "2020-08-27T13:46:10Z", "type": "commit"}, {"oid": "fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "url": "https://github.com/apache/pulsar/commit/fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "message": "fix", "committedDate": "2020-08-27T13:46:10Z", "type": "forcePushed"}, {"oid": "8bd33d0b87b23f4f56361fb433b8e3093660c0da", "url": "https://github.com/apache/pulsar/commit/8bd33d0b87b23f4f56361fb433b8e3093660c0da", "message": "fix", "committedDate": "2020-08-27T17:51:58Z", "type": "commit"}, {"oid": "e28fe9a9af353ceb4cf8ade92000d78b6cba93d1", "url": "https://github.com/apache/pulsar/commit/e28fe9a9af353ceb4cf8ade92000d78b6cba93d1", "message": "fix", "committedDate": "2020-08-27T17:55:17Z", "type": "commit"}, {"oid": "322656d020f66fe4d6df67b5b4868e49fc76162e", "url": "https://github.com/apache/pulsar/commit/322656d020f66fe4d6df67b5b4868e49fc76162e", "message": "fix", "committedDate": "2020-08-27T17:57:35Z", "type": "commit"}, {"oid": "9438a53aae5e14df58c0534bc61d83c44794c95e", "url": "https://github.com/apache/pulsar/commit/9438a53aae5e14df58c0534bc61d83c44794c95e", "message": "fix", "committedDate": "2020-08-27T18:04:45Z", "type": "commit"}]}