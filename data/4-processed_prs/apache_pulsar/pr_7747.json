{"pr_number": 7747, "pr_title": "[Issue 2688]Support set retention on topic level.", "pr_createdAt": "2020-08-04T15:56:44Z", "pr_url": "https://github.com/apache/pulsar/pull/7747", "timeline": [{"oid": "e2246077e093065a806fb8549c9710ce8cbbad0a", "url": "https://github.com/apache/pulsar/commit/e2246077e093065a806fb8549c9710ce8cbbad0a", "message": "Fix and rename to `TopicPoliciesTest`", "committedDate": "2020-08-05T02:10:42Z", "type": "forcePushed"}, {"oid": "e64936a09ceef15e7f5121b498e8fc9bae3a644d", "url": "https://github.com/apache/pulsar/commit/e64936a09ceef15e7f5121b498e8fc9bae3a644d", "message": "Fix and rename to `TopicPoliciesTest`", "committedDate": "2020-08-05T14:20:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0ODgxMQ==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466148811", "bodyText": "minor: for specified topic", "author": "MarvinCai", "createdAt": "2020-08-06T05:07:16Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java", "diffHunk": "@@ -1032,6 +1033,72 @@ public void removeBacklogQuota(@Suspended final AsyncResponse asyncResponse, @Pa\n         internalRemoveBacklogQuota(asyncResponse, backlogQuotaType);\n     }\n \n+    @GET\n+    @Path(\"/{tenant}/{namespace}/{topic}/retention\")\n+    @ApiOperation(value = \"Get retention config on a topic.\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405, message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\") })\n+    public void getRetention(@Suspended final AsyncResponse asyncResponse,\n+            @PathParam(\"tenant\") String tenant,\n+            @PathParam(\"namespace\") String namespace,\n+            @PathParam(\"topic\") @Encoded String encodedTopic) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        try {\n+            internalGetRetention(asyncResponse);\n+        } catch (RestException e) {\n+            asyncResponse.resume(e);\n+        } catch (Exception e) {\n+            asyncResponse.resume(new RestException(e));\n+        }\n+    }\n+\n+    @POST\n+    @Path(\"/{tenant}/{namespace}/{topic}/retention\")\n+    @ApiOperation(value = \"Set retention configuration on a topic.\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405, message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\"),\n+            @ApiResponse(code = 412, message = \"Retention Quota must exceed backlog quota\") })\n+    public void setRetention(@Suspended final AsyncResponse asyncResponse,\n+            @PathParam(\"tenant\") String tenant,\n+            @PathParam(\"namespace\") String namespace,\n+            @PathParam(\"topic\") @Encoded String encodedTopic,\n+            @ApiParam(value = \"Retention policies for the specified namespace\") RetentionPolicies retention) {", "originalCommit": "e64936a09ceef15e7f5121b498e8fc9bae3a644d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMwMjEyOQ==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466302129", "bodyText": "ok", "author": "jianyun8023", "createdAt": "2020-08-06T09:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0ODgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0ODg0Nw==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466148847", "bodyText": "minor: should remove this.", "author": "MarvinCai", "createdAt": "2020-08-06T05:07:26Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java", "diffHunk": "@@ -1032,6 +1033,72 @@ public void removeBacklogQuota(@Suspended final AsyncResponse asyncResponse, @Pa\n         internalRemoveBacklogQuota(asyncResponse, backlogQuotaType);\n     }\n \n+    @GET\n+    @Path(\"/{tenant}/{namespace}/{topic}/retention\")\n+    @ApiOperation(value = \"Get retention config on a topic.\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405, message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\") })\n+    public void getRetention(@Suspended final AsyncResponse asyncResponse,\n+            @PathParam(\"tenant\") String tenant,\n+            @PathParam(\"namespace\") String namespace,\n+            @PathParam(\"topic\") @Encoded String encodedTopic) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        try {\n+            internalGetRetention(asyncResponse);\n+        } catch (RestException e) {\n+            asyncResponse.resume(e);\n+        } catch (Exception e) {\n+            asyncResponse.resume(new RestException(e));\n+        }\n+    }\n+\n+    @POST\n+    @Path(\"/{tenant}/{namespace}/{topic}/retention\")\n+    @ApiOperation(value = \"Set retention configuration on a topic.\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405, message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\"),\n+            @ApiResponse(code = 412, message = \"Retention Quota must exceed backlog quota\") })\n+    public void setRetention(@Suspended final AsyncResponse asyncResponse,\n+            @PathParam(\"tenant\") String tenant,\n+            @PathParam(\"namespace\") String namespace,\n+            @PathParam(\"topic\") @Encoded String encodedTopic,\n+            @ApiParam(value = \"Retention policies for the specified namespace\") RetentionPolicies retention) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        try {\n+            internalSetRetention(asyncResponse, retention);\n+        } catch (RestException e) {\n+            asyncResponse.resume(e);\n+        } catch (Exception e) {\n+            asyncResponse.resume(new RestException(e));\n+        }\n+    }\n+\n+    @DELETE\n+    @Path(\"/{tenant}/{namespace}/{topic}/retention\")\n+    @ApiOperation(value = \"Remove retention configuration on a topic.\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405, message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\"),\n+            @ApiResponse(code = 412, message = \"Retention Quota must exceed backlog quota\") })", "originalCommit": "e64936a09ceef15e7f5121b498e8fc9bae3a644d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0OTAyMg==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466149022", "bodyText": "Is this backlog quota added by mistake.", "author": "MarvinCai", "createdAt": "2020-08-06T05:08:12Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicPoliciesTest.java", "diffHunk": "@@ -86,123 +71,172 @@ public void cleanup() throws Exception {\n     public void testSetBacklogQuota() throws Exception {\n \n         BacklogQuota backlogQuota = new BacklogQuota(1024, BacklogQuota.RetentionPolicy.consumer_backlog_eviction);\n-        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, backlogQuotaTopic);\n+        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, testTopic);\n \n-        admin.topics().setBacklogQuota(backlogQuotaTopic, backlogQuota);\n-        log.info(\"Backlog quota set success on topic: {}\", backlogQuotaTopic);\n+        admin.topics().setBacklogQuota(testTopic, backlogQuota);\n+        log.info(\"Backlog quota set success on topic: {}\", testTopic);\n \n         Thread.sleep(3000);\n-        BacklogQuota getBacklogQuota = admin.topics().getBacklogQuotaMap(backlogQuotaTopic)\n+        BacklogQuota getBacklogQuota = admin.topics().getBacklogQuotaMap(testTopic)\n                 .get(BacklogQuota.BacklogQuotaType.destination_storage);\n-        log.info(\"Backlog quota {} get on topic: {}\", getBacklogQuota, backlogQuotaTopic);\n+        log.info(\"Backlog quota {} get on topic: {}\", getBacklogQuota, testTopic);\n         Assert.assertEquals(getBacklogQuota, backlogQuota);\n \n         BacklogQuotaManager backlogQuotaManager = pulsar.getBrokerService().getBacklogQuotaManager();\n-        BacklogQuota backlogQuotaInManager = backlogQuotaManager.getBacklogQuota(TopicName.get(backlogQuotaTopic));\n-        log.info(\"Backlog quota {} in backlog quota manager on topic: {}\", backlogQuotaInManager, backlogQuotaTopic);\n+        BacklogQuota backlogQuotaInManager = backlogQuotaManager.getBacklogQuota(TopicName.get(testTopic));\n+        log.info(\"Backlog quota {} in backlog quota manager on topic: {}\", backlogQuotaInManager, testTopic);\n         Assert.assertEquals(backlogQuotaInManager, backlogQuota);\n \n-        admin.topics().deletePartitionedTopic(backlogQuotaTopic, true);\n+        admin.topics().deletePartitionedTopic(testTopic, true);\n     }\n \n     @Test\n     public void testRemoveBacklogQuota() throws Exception {\n         BacklogQuota backlogQuota = new BacklogQuota(1024, BacklogQuota.RetentionPolicy.consumer_backlog_eviction);\n-        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, backlogQuotaTopic);\n-        admin.topics().setBacklogQuota(backlogQuotaTopic, backlogQuota);\n-        log.info(\"Backlog quota set success on topic: {}\", backlogQuotaTopic);\n+        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, testTopic);\n+        admin.topics().setBacklogQuota(testTopic, backlogQuota);\n+        log.info(\"Backlog quota set success on topic: {}\", testTopic);\n \n         Thread.sleep(3000);\n-        BacklogQuota getBacklogQuota = admin.topics().getBacklogQuotaMap(backlogQuotaTopic)\n+        BacklogQuota getBacklogQuota = admin.topics().getBacklogQuotaMap(testTopic)\n                 .get(BacklogQuota.BacklogQuotaType.destination_storage);\n-        log.info(\"Backlog quota {} get on topic: {}\", getBacklogQuota, backlogQuotaTopic);\n+        log.info(\"Backlog quota {} get on topic: {}\", getBacklogQuota, testTopic);\n         Assert.assertEquals(backlogQuota, getBacklogQuota);\n \n         BacklogQuotaManager backlogQuotaManager = pulsar.getBrokerService().getBacklogQuotaManager();\n-        BacklogQuota backlogQuotaInManager = backlogQuotaManager.getBacklogQuota(TopicName.get(backlogQuotaTopic));\n-        log.info(\"Backlog quota {} in backlog quota manager on topic: {}\", backlogQuotaInManager, backlogQuotaTopic);\n+        BacklogQuota backlogQuotaInManager = backlogQuotaManager.getBacklogQuota(TopicName.get(testTopic));\n+        log.info(\"Backlog quota {} in backlog quota manager on topic: {}\", backlogQuotaInManager, testTopic);\n         Assert.assertEquals(backlogQuota, backlogQuotaInManager);\n \n-        admin.topics().removeBacklogQuota(backlogQuotaTopic);\n-        getBacklogQuota = admin.topics().getBacklogQuotaMap(backlogQuotaTopic)\n+        admin.topics().removeBacklogQuota(testTopic);\n+        getBacklogQuota = admin.topics().getBacklogQuotaMap(testTopic)\n                 .get(BacklogQuota.BacklogQuotaType.destination_storage);\n-        log.info(\"Backlog quota {} get on topic: {} after remove\", getBacklogQuota, backlogQuotaTopic);\n+        log.info(\"Backlog quota {} get on topic: {} after remove\", getBacklogQuota, testTopic);\n         Assert.assertNull(getBacklogQuota);\n \n-        backlogQuotaInManager = backlogQuotaManager.getBacklogQuota(TopicName.get(backlogQuotaTopic));\n+        backlogQuotaInManager = backlogQuotaManager.getBacklogQuota(TopicName.get(testTopic));\n         log.info(\"Backlog quota {} in backlog quota manager on topic: {} after remove\", backlogQuotaInManager,\n-                backlogQuotaTopic);\n+                testTopic);\n         Assert.assertEquals(backlogQuotaManager.getDefaultQuota(), backlogQuotaInManager);\n \n-        admin.topics().deletePartitionedTopic(backlogQuotaTopic, true);\n+        admin.topics().deletePartitionedTopic(testTopic, true);\n     }\n \n     @Test\n-    public void testCheckQuota() throws Exception {\n+    public void testCheckBlcklogQuota() throws Exception {\n         RetentionPolicies retentionPolicies = new RetentionPolicies(10, 10);\n-        String namespace = TopicName.get(backlogQuotaTopic).getNamespace();\n+        String namespace = TopicName.get(testTopic).getNamespace();\n         admin.namespaces().setRetention(namespace, retentionPolicies);\n \n         BacklogQuota backlogQuota =\n                 new BacklogQuota(10 * 1024 * 1024, BacklogQuota.RetentionPolicy.consumer_backlog_eviction);\n-        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, backlogQuotaTopic);\n+        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, testTopic);\n         try {\n-            admin.topics().setBacklogQuota(backlogQuotaTopic, backlogQuota);\n+            admin.topics().setBacklogQuota(testTopic, backlogQuota);\n             Assert.fail();\n         } catch (PulsarAdminException e) {\n             Assert.assertEquals(e.getStatusCode(), 412);\n         }\n         Thread.sleep(3000);\n         backlogQuota =\n                 new BacklogQuota(10 * 1024 * 1024 + 1, BacklogQuota.RetentionPolicy.consumer_backlog_eviction);\n-        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, backlogQuotaTopic);\n+        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, testTopic);\n         try {\n-            admin.topics().setBacklogQuota(backlogQuotaTopic, backlogQuota);\n+            admin.topics().setBacklogQuota(testTopic, backlogQuota);\n             Assert.fail();\n         } catch (PulsarAdminException e) {\n             Assert.assertEquals(e.getStatusCode(), 412);\n         }\n         Thread.sleep(3000);\n         backlogQuota =\n                 new BacklogQuota(10 * 1024 * 1024 - 1, BacklogQuota.RetentionPolicy.consumer_backlog_eviction);\n-        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, backlogQuotaTopic);\n-        admin.topics().setBacklogQuota(backlogQuotaTopic, backlogQuota);\n+        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, testTopic);\n+        admin.topics().setBacklogQuota(testTopic, backlogQuota);\n         Thread.sleep(3000);\n-        BacklogQuota getBacklogQuota = admin.topics().getBacklogQuotaMap(backlogQuotaTopic)\n+        BacklogQuota getBacklogQuota = admin.topics().getBacklogQuotaMap(testTopic)\n                 .get(BacklogQuota.BacklogQuotaType.destination_storage);\n-        log.info(\"Backlog quota {} get on topic: {} after remove\", getBacklogQuota, backlogQuotaTopic);\n+        log.info(\"Backlog quota {} get on topic: {} after remove\", getBacklogQuota, testTopic);\n         Assert.assertEquals(getBacklogQuota, backlogQuota);\n \n-        admin.topics().deletePartitionedTopic(backlogQuotaTopic, true);\n+        admin.topics().deletePartitionedTopic(testTopic, true);\n     }\n \n     @Test\n-    public void testBacklogQuotaDisabled() throws Exception {\n-        disableTopicLevelPolicies();\n-        admin.topics().createPartitionedTopic(backlogQuotaTopic, 2);\n-\n-        BacklogQuota backlogQuota = new BacklogQuota(1024, BacklogQuota.RetentionPolicy.consumer_backlog_eviction);\n-        log.info(\"Backlog quota: {} will set to the topic: {}\", backlogQuota, backlogQuotaTopic);\n+    public void testCheckRetention() throws Exception {\n+        BacklogQuota backlogQuota =", "originalCommit": "e64936a09ceef15e7f5121b498e8fc9bae3a644d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMwNDI1Ng==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466304256", "bodyText": "This is a problem, I have modified it", "author": "jianyun8023", "createdAt": "2020-08-06T10:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0OTAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0OTEwMw==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466149103", "bodyText": "Should this be set retention for all messages on a topic?", "author": "MarvinCai", "createdAt": "2020-08-06T05:08:32Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -1433,4 +1434,142 @@ void createSubscription(String topic, String subscriptionName, MessageId message\n      *             Unexpected error\n      */\n     void removeBacklogQuota(String topic) throws PulsarAdminException;\n+\n+    /**\n+     * Set the retention configuration for all the topics on a topic.", "originalCommit": "e64936a09ceef15e7f5121b498e8fc9bae3a644d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0OTEzMg==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466149132", "bodyText": "I think the example here might confuse people, e.g. 3h, 2d, might make people think they can provide retention with different time unit, but what we expect here is only in minutes.\nSame for retention size that we only expect in MB.", "author": "MarvinCai", "createdAt": "2020-08-06T05:08:41Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -880,4 +884,65 @@ void run() throws PulsarAdminException {\n             admin.topics().removeBacklogQuota(persistentTopic);\n         }\n     }\n+\n+    @Parameters(commandDescription = \"Get the retention policy for a topic\")\n+    private class GetRetention extends CliCommand {\n+        @Parameter(description = \"persistent://tenant/namespace/topic\", required = true)\n+        private java.util.List<String> params;\n+\n+        @Override\n+        void run() throws PulsarAdminException {\n+            String persistentTopic = validatePersistentTopic(params);\n+            print(admin.topics().getRetention(persistentTopic));\n+        }\n+    }\n+\n+    @Parameters(commandDescription = \"Set the retention policy for a topic\")\n+    private class SetRetention extends CliCommand {\n+        @Parameter(description = \"persistent://tenant/namespace/topic\", required = true)\n+        private java.util.List<String> params;\n+\n+        @Parameter(names = { \"--time\",\n+                \"-t\" }, description = \"Retention time in minutes (or minutes, hours,days,weeks eg: 100m, 3h, 2d, 5w). \"", "originalCommit": "e64936a09ceef15e7f5121b498e8fc9bae3a644d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMwNTU3NA==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r466305574", "bodyText": "I refer to the namespace cmd  CmdNamespaces.SetRetention. If you want to revise, I suggest open an issue for unified modification", "author": "jianyun8023", "createdAt": "2020-08-06T10:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE0OTEzMg=="}], "type": "inlineReview"}, {"oid": "b133646d1747901d6e8a547d85bef998d9be5899", "url": "https://github.com/apache/pulsar/commit/b133646d1747901d6e8a547d85bef998d9be5899", "message": "Support set retention on topic level.", "committedDate": "2020-08-06T06:56:50Z", "type": "commit"}, {"oid": "74c8d4dcbf74e335aab63cc9d38c409b139f0d00", "url": "https://github.com/apache/pulsar/commit/74c8d4dcbf74e335aab63cc9d38c409b139f0d00", "message": "Support remove retention on topic level.", "committedDate": "2020-08-06T06:56:50Z", "type": "commit"}, {"oid": "477d08a70e9043f455ea2079062f964c248c26f3", "url": "https://github.com/apache/pulsar/commit/477d08a70e9043f455ea2079062f964c248c26f3", "message": "Fix and rename to `TopicPoliciesTest`", "committedDate": "2020-08-06T06:56:51Z", "type": "commit"}, {"oid": "e73913329298d23cc58f296971115a28d0dc8d90", "url": "https://github.com/apache/pulsar/commit/e73913329298d23cc58f296971115a28d0dc8d90", "message": "fix comment and modified test", "committedDate": "2020-08-06T09:49:23Z", "type": "commit"}, {"oid": "dbd777142809dc73c243dba853da5eaf0420acbc", "url": "https://github.com/apache/pulsar/commit/dbd777142809dc73c243dba853da5eaf0420acbc", "message": "fix log class\uff0cbecause `TopicBacklogQuotaTest` renamed to `TopicPoliciesTest`", "committedDate": "2020-08-06T09:52:22Z", "type": "commit"}, {"oid": "dbd777142809dc73c243dba853da5eaf0420acbc", "url": "https://github.com/apache/pulsar/commit/dbd777142809dc73c243dba853da5eaf0420acbc", "message": "fix log class\uff0cbecause `TopicBacklogQuotaTest` renamed to `TopicPoliciesTest`", "committedDate": "2020-08-06T09:52:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NTI2Mw==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r467855263", "bodyText": "complete the asyncResponse here.", "author": "codelipenghui", "createdAt": "2020-08-10T12:00:09Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2156,6 +2158,96 @@ protected void internalRemoveBacklogQuota(AsyncResponse asyncResponse,\n         internalSetBacklogQuota(asyncResponse, backlogQuotaType, null);\n     }\n \n+    protected void internalGetRetention(AsyncResponse asyncResponse){\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        Optional<RetentionPolicies> retention = getTopicPolicies(topicName)\n+                .map(TopicPolicies::getRetentionPolicies);\n+        if (!retention.isPresent()) {\n+            asyncResponse.resume(Response.noContent().build());\n+        }else {\n+            asyncResponse.resume(retention.get());\n+        }\n+    }\n+\n+    protected void internalSetRetention(AsyncResponse asyncResponse,\n+            RetentionPolicies retention) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        if (retention == null) {\n+            asyncResponse.resume(Response.noContent().build());\n+        }\n+        TopicPolicies topicPolicies = getTopicPolicies(topicName)\n+                .orElseGet(TopicPolicies::new);\n+        BacklogQuota backlogQuota =\n+                    topicPolicies.getBackLogQuotaMap().get(BacklogQuota.BacklogQuotaType.destination_storage.name());\n+        if (backlogQuota == null){\n+            Policies policies = getNamespacePolicies(topicName.getNamespaceObject());\n+            backlogQuota = policies.backlog_quota_map.get(BacklogQuota.BacklogQuotaType.destination_storage);\n+        }\n+        if(!checkBacklogQuota(backlogQuota, retention)){\n+            log.warn(\n+                    \"[{}] Failed to update retention quota configuration for topic {}: conflicts with retention quota\",\n+                    clientAppId(), topicName);\n+            throw new RestException(Status.PRECONDITION_FAILED,", "originalCommit": "dbd777142809dc73c243dba853da5eaf0420acbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg4MTkyOQ==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r467881929", "bodyText": "fix", "author": "jianyun8023", "createdAt": "2020-08-10T12:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NTI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NTk3Nw==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r467855977", "bodyText": "Here also throw exceptions, you can pass the asyncResponse to this method and resume the asyncResponse in the checkTopicLevelPolicyEnable . Please check all.", "author": "codelipenghui", "createdAt": "2020-08-10T12:01:39Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2156,6 +2158,96 @@ protected void internalRemoveBacklogQuota(AsyncResponse asyncResponse,\n         internalSetBacklogQuota(asyncResponse, backlogQuotaType, null);\n     }\n \n+    protected void internalGetRetention(AsyncResponse asyncResponse){\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();", "originalCommit": "dbd777142809dc73c243dba853da5eaf0420acbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg4Mjc0Mw==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r467882743", "bodyText": "Checked on the upper level.", "author": "jianyun8023", "createdAt": "2020-08-10T12:55:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NTk3Nw=="}], "type": "inlineReview"}, {"oid": "c8f10438f372628e8f1fe51ddd88200777a8d5de", "url": "https://github.com/apache/pulsar/commit/c8f10438f372628e8f1fe51ddd88200777a8d5de", "message": "modify the exception is throw", "committedDate": "2020-08-10T12:58:11Z", "type": "commit"}, {"oid": "bebd6f7455e8af5d512ca40c476ac400cbf08dac", "url": "https://github.com/apache/pulsar/commit/bebd6f7455e8af5d512ca40c476ac400cbf08dac", "message": "modify the use of asyncResponse", "committedDate": "2020-08-10T13:21:01Z", "type": "commit"}, {"oid": "bebd6f7455e8af5d512ca40c476ac400cbf08dac", "url": "https://github.com/apache/pulsar/commit/bebd6f7455e8af5d512ca40c476ac400cbf08dac", "message": "modify the use of asyncResponse", "committedDate": "2020-08-10T13:21:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgyMDIyMw==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r469820223", "bodyText": "checkTopicLevelPolicyEnable() is also called by getTopicPolicies(), so we can delete it here.", "author": "zhanghaou", "createdAt": "2020-08-13T09:27:10Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2156,6 +2158,67 @@ protected void internalRemoveBacklogQuota(AsyncResponse asyncResponse,\n         internalSetBacklogQuota(asyncResponse, backlogQuotaType, null);\n     }\n \n+    protected void internalGetRetention(AsyncResponse asyncResponse){\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();", "originalCommit": "bebd6f7455e8af5d512ca40c476ac400cbf08dac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg4OTA5NQ==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r472889095", "bodyText": "okay, let me solve these problems", "author": "jianyun8023", "createdAt": "2020-08-19T09:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgyMDIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgyMDczNg==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r469820736", "bodyText": "Same to the above.", "author": "zhanghaou", "createdAt": "2020-08-13T09:28:07Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2156,6 +2158,67 @@ protected void internalRemoveBacklogQuota(AsyncResponse asyncResponse,\n         internalSetBacklogQuota(asyncResponse, backlogQuotaType, null);\n     }\n \n+    protected void internalGetRetention(AsyncResponse asyncResponse){\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        Optional<RetentionPolicies> retention = getTopicPolicies(topicName)\n+                .map(TopicPolicies::getRetentionPolicies);\n+        if (!retention.isPresent()) {\n+            asyncResponse.resume(Response.noContent().build());\n+        }else {\n+            asyncResponse.resume(retention.get());\n+        }\n+    }\n+\n+    protected CompletableFuture<Void> internalSetRetention(RetentionPolicies retention) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();", "originalCommit": "bebd6f7455e8af5d512ca40c476ac400cbf08dac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgyMDgzNQ==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r469820835", "bodyText": "Same to the above.", "author": "zhanghaou", "createdAt": "2020-08-13T09:28:17Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2156,6 +2158,67 @@ protected void internalRemoveBacklogQuota(AsyncResponse asyncResponse,\n         internalSetBacklogQuota(asyncResponse, backlogQuotaType, null);\n     }\n \n+    protected void internalGetRetention(AsyncResponse asyncResponse){\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        Optional<RetentionPolicies> retention = getTopicPolicies(topicName)\n+                .map(TopicPolicies::getRetentionPolicies);\n+        if (!retention.isPresent()) {\n+            asyncResponse.resume(Response.noContent().build());\n+        }else {\n+            asyncResponse.resume(retention.get());\n+        }\n+    }\n+\n+    protected CompletableFuture<Void> internalSetRetention(RetentionPolicies retention) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        if (retention == null) {\n+            return CompletableFuture.completedFuture(null);\n+        }\n+        TopicPolicies topicPolicies = getTopicPolicies(topicName)\n+                .orElseGet(TopicPolicies::new);\n+        BacklogQuota backlogQuota =\n+                    topicPolicies.getBackLogQuotaMap().get(BacklogQuota.BacklogQuotaType.destination_storage.name());\n+        if (backlogQuota == null){\n+            Policies policies = getNamespacePolicies(topicName.getNamespaceObject());\n+            backlogQuota = policies.backlog_quota_map.get(BacklogQuota.BacklogQuotaType.destination_storage);\n+        }\n+        if(!checkBacklogQuota(backlogQuota, retention)){\n+            log.warn(\n+                    \"[{}] Failed to update retention quota configuration for topic {}: conflicts with retention quota\",\n+                    clientAppId(), topicName);\n+            throw new RestException(Status.PRECONDITION_FAILED,\n+                    \"Retention Quota must exceed configured backlog quota for topic. \" +\n+                            \"Please increase retention quota and retry\");\n+        }\n+        topicPolicies.setRetentionPolicies(retention);\n+        return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies);\n+    }\n+\n+    protected CompletableFuture<Void> internalRemoveRetention() {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();", "originalCommit": "bebd6f7455e8af5d512ca40c476ac400cbf08dac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgyMzc1MQ==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r469823751", "bodyText": "Need to modify this doc.", "author": "zhanghaou", "createdAt": "2020-08-13T09:33:14Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -1476,4 +1477,142 @@ void createSubscription(String topic, String subscriptionName, MessageId message\n      *             Unexpected error\n      */\n     void removeMessageTTL(String topic) throws PulsarAdminException;\n+\n+    /**\n+     * Set the retention configuration on a topic.\n+     * <p/>\n+     * Set the retention configuration on a topic. This operation requires Pulsar super-user access.\n+     * <p/>\n+     * Request parameter example:\n+     * <p/>\n+     *\n+     * <pre>\n+     * <code>\n+     * {\n+     *     \"retentionTimeInMinutes\" : 60,            // how long to retain messages\n+     *     \"retentionSizeInMB\" : 1024,              // retention backlog limit\n+     * }\n+     * </code>\n+     * </pre>\n+     *\n+     * @param topic\n+     *            Topic name\n+     *\n+     * @throws NotAuthorizedException\n+     *             Don't have admin permission\n+     * @throws NotFoundException\n+     *             Topic does not exist\n+     * @throws ConflictException\n+     *             Concurrent modification\n+     * @throws PulsarAdminException\n+     *             Unexpected error\n+     */\n+    void setRetention(String topic, RetentionPolicies retention) throws PulsarAdminException;\n+\n+    /**\n+     * Set the retention configuration for all the topics on a topic asynchronously.", "originalCommit": "bebd6f7455e8af5d512ca40c476ac400cbf08dac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgyMzkxMg==", "url": "https://github.com/apache/pulsar/pull/7747#discussion_r469823912", "bodyText": "Need to modify this doc.", "author": "zhanghaou", "createdAt": "2020-08-13T09:33:33Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -1476,4 +1477,142 @@ void createSubscription(String topic, String subscriptionName, MessageId message\n      *             Unexpected error\n      */\n     void removeMessageTTL(String topic) throws PulsarAdminException;\n+\n+    /**\n+     * Set the retention configuration on a topic.\n+     * <p/>\n+     * Set the retention configuration on a topic. This operation requires Pulsar super-user access.\n+     * <p/>\n+     * Request parameter example:\n+     * <p/>\n+     *\n+     * <pre>\n+     * <code>\n+     * {\n+     *     \"retentionTimeInMinutes\" : 60,            // how long to retain messages\n+     *     \"retentionSizeInMB\" : 1024,              // retention backlog limit\n+     * }\n+     * </code>\n+     * </pre>\n+     *\n+     * @param topic\n+     *            Topic name\n+     *\n+     * @throws NotAuthorizedException\n+     *             Don't have admin permission\n+     * @throws NotFoundException\n+     *             Topic does not exist\n+     * @throws ConflictException\n+     *             Concurrent modification\n+     * @throws PulsarAdminException\n+     *             Unexpected error\n+     */\n+    void setRetention(String topic, RetentionPolicies retention) throws PulsarAdminException;\n+\n+    /**\n+     * Set the retention configuration for all the topics on a topic asynchronously.\n+     * <p/>\n+     * Set the retention configuration on a topic. This operation requires Pulsar super-user access.\n+     * <p/>\n+     * Request parameter example:\n+     * <p/>\n+     *\n+     * <pre>\n+     * <code>\n+     * {\n+     *     \"retentionTimeInMinutes\" : 60,            // how long to retain messages\n+     *     \"retentionSizeInMB\" : 1024,              // retention backlog limit\n+     * }\n+     * </code>\n+     * </pre>\n+     *\n+     * @param topic\n+     *            Topic name\n+     */\n+    CompletableFuture<Void> setRetentionAsync(String topic, RetentionPolicies retention);\n+\n+    /**\n+     * Get the retention configuration for a topic.\n+     * <p/>\n+     * Get the retention configuration for a topic.\n+     * <p/>\n+     * Response example:\n+     * <p/>\n+     *\n+     * <pre>\n+     * <code>\n+     * {\n+     *     \"retentionTimeInMinutes\" : 60,            // how long to retain messages\n+     *     \"retentionSizeInMB\" : 1024,              // retention backlog limit\n+     * }\n+     * </code>\n+     * </pre>\n+     *\n+     * @param topic\n+     *            Topic name\n+     * @throws NotAuthorizedException\n+     *             Don't have admin permission\n+     * @throws NotFoundException\n+     *             Topic does not exist\n+     * @throws ConflictException\n+     *             Concurrent modification\n+     * @throws PulsarAdminException\n+     *             Unexpected error\n+     */\n+    RetentionPolicies getRetention(String topic) throws PulsarAdminException;\n+\n+    /**\n+     * Get the retention configuration for a topic asynchronously.\n+     * <p/>\n+     * Get the retention configuration for a topic.\n+     * <p/>\n+     *\n+     * @param topic\n+     *            Topic name\n+     */\n+    CompletableFuture<RetentionPolicies> getRetentionAsync(String topic);\n+\n+    /**\n+     * Remove the retention configuration for all the topics on a topic.", "originalCommit": "bebd6f7455e8af5d512ca40c476ac400cbf08dac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}