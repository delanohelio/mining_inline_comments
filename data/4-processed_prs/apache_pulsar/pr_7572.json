{"pr_number": 7572, "pr_title": "[CPP] Fix segment crashes that caused by race condition of timer in cpp client", "pr_createdAt": "2020-07-17T05:11:48Z", "pr_url": "https://github.com/apache/pulsar/pull/7572", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyNzE1OA==", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456227158", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (consumerStatsRequestTimer_.use_count() > 0) {\n          \n          \n            \n                if (consumerStatsRequestTimer_) {", "author": "merlimat", "createdAt": "2020-07-17T05:32:40Z", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -289,13 +286,14 @@ void ClientConnection::startConsumerStatsTimer(std::vector<uint64_t> consumerSta\n         consumerStatsRequests.push_back(it->first);\n     }\n \n-    DeadlineTimerPtr timer = consumerStatsRequestTimer_;\n-    if (timer) {\n-        timer->expires_from_now(operationsTimeout_);\n-        timer->async_wait(std::bind(&ClientConnection::handleConsumerStatsTimeout, shared_from_this(),\n-                                    std::placeholders::_1, consumerStatsRequests));\n+    // If the close operation has reset the consumerStatsRequestTimer_ then the use_count will be zero\n+    // Check if we have a timer still before we set the request timer to pop again.\n+    if (consumerStatsRequestTimer_.use_count() > 0) {", "originalCommit": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyNzc3Mw==", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456227773", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (keepAliveTimer_.use_count() > 0) {\n          \n          \n            \n                    if (keepAliveTimer_) {", "author": "merlimat", "createdAt": "2020-07-17T05:35:08Z", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1344,8 +1324,12 @@ void ClientConnection::handleKeepAliveTimeout() {\n         havePendingPingRequest_ = true;\n         sendCommand(Commands::newPing());\n \n-        keepAliveTimer_->expires_from_now(boost::posix_time::seconds(KeepAliveIntervalInSeconds));\n-        keepAliveTimer_->async_wait(std::bind(&ClientConnection::handleKeepAliveTimeout, shared_from_this()));\n+        // If the close operation has already called the keepAliveTimer_.reset() then the use_count will be zero And we do not attempt\n+        // to dereference the pointer.\n+        if (keepAliveTimer_.use_count() > 0) {", "originalCommit": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjI0MA==", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792240", "bodyText": "Could we remove this?", "author": "jiazhai", "createdAt": "2020-07-18T13:52:46Z", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -25,6 +25,7 @@\n #include <boost/date_time/posix_time/posix_time.hpp>\n #include <boost/date_time/gregorian/gregorian.hpp>\n #include <climits>\n+// #include <unistd.h>", "originalCommit": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjM4MQ==", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792381", "bodyText": "The changes in this file seems removed some of the latest change in master. This will cause regressions.", "author": "jiazhai", "createdAt": "2020-07-18T13:54:44Z", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -117,9 +118,6 @@ static Result getResult(ServerError serverError) {\n \n         case InvalidTxnStatus:\n             return ResultInvalidTxnStatusError;\n-", "originalCommit": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjQ2MA==", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792460", "bodyText": "same as the above comments. this change is not needed for this fix?", "author": "jiazhai", "createdAt": "2020-07-18T13:55:25Z", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -417,15 +415,6 @@ void ClientConnection::handleSentPulsarConnect(const boost::system::error_code&\n     readNextCommand();\n }\n \n-void ClientConnection::handleSentAuthResponse(const boost::system::error_code& err,", "originalCommit": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjQ4Mg==", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792482", "bodyText": "same as above comments. this change is not needed for this fix?", "author": "jiazhai", "createdAt": "2020-07-18T13:55:38Z", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1038,15 +1027,6 @@ void ClientConnection::handleIncomingCommand() {\n                     break;\n                 }\n \n-                case BaseCommand::AUTH_CHALLENGE: {", "originalCommit": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "600a667efe6270cb309d539b111d4e038dec734a", "url": "https://github.com/apache/pulsar/commit/600a667efe6270cb309d539b111d4e038dec734a", "message": "Kevin Wilson changes to fix segment crashes in pulsar", "committedDate": "2020-07-22T08:33:30Z", "type": "forcePushed"}, {"oid": "eeffe428869823a1cececed2d25255bf356bd757", "url": "https://github.com/apache/pulsar/commit/eeffe428869823a1cececed2d25255bf356bd757", "message": "Kevin Wilson changes to fix segment crashes in pulsar", "committedDate": "2020-07-23T07:19:23Z", "type": "commit"}, {"oid": "b34837671becfdf138b266df21d26b67d326be05", "url": "https://github.com/apache/pulsar/commit/b34837671becfdf138b266df21d26b67d326be05", "message": "after merge with master, change following comments: ptr, unnecessary change", "committedDate": "2020-07-23T07:19:23Z", "type": "commit"}, {"oid": "6fe0e5a2f753c625014850155e420546cb603af3", "url": "https://github.com/apache/pulsar/commit/6fe0e5a2f753c625014850155e420546cb603af3", "message": "add lock to avoid concurrent access", "committedDate": "2020-07-23T07:19:23Z", "type": "commit"}, {"oid": "6fe0e5a2f753c625014850155e420546cb603af3", "url": "https://github.com/apache/pulsar/commit/6fe0e5a2f753c625014850155e420546cb603af3", "message": "add lock to avoid concurrent access", "committedDate": "2020-07-23T07:19:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3NjM0Mw==", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r460076343", "bodyText": "Please remove comment", "author": "merlimat", "createdAt": "2020-07-24T14:09:58Z", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1363,6 +1375,8 @@ void ClientConnection::close() {\n     if (isClosed()) {\n         return;\n     }\n+    // Use a sleep to stress the timers when the pop to find the race conditions with close().\n+    // sleep(30);", "originalCommit": "6fe0e5a2f753c625014850155e420546cb603af3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e41f5305eaf14edbddfd8b45e133bf361ed71a7", "url": "https://github.com/apache/pulsar/commit/5e41f5305eaf14edbddfd8b45e133bf361ed71a7", "message": "Remove comments", "committedDate": "2020-07-27T04:29:53Z", "type": "commit"}, {"oid": "4174db55558e15ef9b94631c3d33f9a9352b50fa", "url": "https://github.com/apache/pulsar/commit/4174db55558e15ef9b94631c3d33f9a9352b50fa", "message": "Merge branch 'master' into MicroFocusCrashFix", "committedDate": "2020-07-28T12:41:28Z", "type": "commit"}]}