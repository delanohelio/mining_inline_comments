{"pr_number": 7841, "pr_title": "[broker] Fix deadlock when adding consumer", "pr_createdAt": "2020-08-18T15:58:16Z", "pr_url": "https://github.com/apache/pulsar/pull/7841", "timeline": [{"oid": "53c3d0811f39b1ee1d9564b4bc59d214143e7b70", "url": "https://github.com/apache/pulsar/commit/53c3d0811f39b1ee1d9564b4bc59d214143e7b70", "message": "Fix deadlock when adding consumer", "committedDate": "2020-08-20T05:06:31Z", "type": "forcePushed"}, {"oid": "8962717c114679f2ddcc390b77c20797dc4c9af0", "url": "https://github.com/apache/pulsar/commit/8962717c114679f2ddcc390b77c20797dc4c9af0", "message": "Fix deadlock when adding consumer", "committedDate": "2020-08-20T15:57:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkyNzIzMA==", "url": "https://github.com/apache/pulsar/pull/7841#discussion_r475927230", "bodyText": "should we log an error message?", "author": "sijie", "createdAt": "2020-08-24T22:22:35Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -140,6 +141,38 @@ protected boolean isProducersExceeded() {\n         return false;\n     }\n \n+    protected boolean isConsumersExceededOnTopic() {\n+        Policies policies;\n+        try {\n+            // Use getDataIfPresent from zk cache to make the call non-blocking and prevent deadlocks\n+            policies = brokerService.pulsar().getConfigurationCache().policiesCache()\n+                    .getDataIfPresent(AdminResource.path(POLICIES, TopicName.get(topic).getNamespace()));\n+\n+            if (policies == null) {\n+                policies = new Policies();\n+            }\n+        } catch (Exception e) {", "originalCommit": "8962717c114679f2ddcc390b77c20797dc4c9af0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA2NjAyMA==", "url": "https://github.com/apache/pulsar/pull/7841#discussion_r476066020", "bodyText": "@sijie Added warning log here.", "author": "massakam", "createdAt": "2020-08-25T02:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkyNzIzMA=="}], "type": "inlineReview"}, {"oid": "6cb89816d682be41aa2ffde1d7fdfed2886cfb5f", "url": "https://github.com/apache/pulsar/commit/6cb89816d682be41aa2ffde1d7fdfed2886cfb5f", "message": "Fix deadlock when adding consumer", "committedDate": "2020-08-27T05:10:08Z", "type": "commit"}, {"oid": "75bcef25f179584ec3ad77683f428922579a74b6", "url": "https://github.com/apache/pulsar/commit/75bcef25f179584ec3ad77683f428922579a74b6", "message": "Log warn if getting of namespace policies fails", "committedDate": "2020-08-27T05:10:08Z", "type": "commit"}, {"oid": "75bcef25f179584ec3ad77683f428922579a74b6", "url": "https://github.com/apache/pulsar/commit/75bcef25f179584ec3ad77683f428922579a74b6", "message": "Log warn if getting of namespace policies fails", "committedDate": "2020-08-27T05:10:08Z", "type": "forcePushed"}]}