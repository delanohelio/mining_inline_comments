{"pr_number": 8948, "pr_title": "Support configure max subscriptions per topic on the topic level policy", "pr_createdAt": "2020-12-14T08:21:51Z", "pr_url": "https://github.com/apache/pulsar/pull/8948", "timeline": [{"oid": "5a5887113a6e2cdbc7e3067735a2b41b65a82a15", "url": "https://github.com/apache/pulsar/commit/5a5887113a6e2cdbc7e3067735a2b41b65a82a15", "message": "support topic-level max subscriptions", "committedDate": "2020-12-14T08:17:33Z", "type": "commit"}, {"oid": "e7ae7e8400ecd27cb777b91366ed8fd183e3b2e1", "url": "https://github.com/apache/pulsar/commit/e7ae7e8400ecd27cb777b91366ed8fd183e3b2e1", "message": "code style", "committedDate": "2020-12-14T08:33:46Z", "type": "commit"}, {"oid": "e5f52ce0a0106d3d34271bea95c83d767437edd0", "url": "https://github.com/apache/pulsar/commit/e5f52ce0a0106d3d34271bea95c83d767437edd0", "message": "code style", "committedDate": "2020-12-14T09:02:50Z", "type": "commit"}, {"oid": "b160f7e6584b221f3187406d99ffe1fd8c291e00", "url": "https://github.com/apache/pulsar/commit/b160f7e6584b221f3187406d99ffe1fd8c291e00", "message": "code style", "committedDate": "2020-12-14T09:25:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3ODI1NQ==", "url": "https://github.com/apache/pulsar/pull/8948#discussion_r542978255", "bodyText": "Is this ok to set the value as null? Can we avoid to do that?", "author": "zymap", "createdAt": "2020-12-15T01:36:48Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java", "diffHunk": "@@ -1816,6 +1816,91 @@ public void removePersistence(@Suspended final AsyncResponse asyncResponse,\n         });\n     }\n \n+    @GET\n+    @Path(\"/{tenant}/{namespace}/{topic}/maxSubscriptionsPerTopic\")\n+    @ApiOperation(value = \"Get maxSubscriptionsPerTopic config for specified topic.\")\n+    @ApiResponses(value = {@ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405,\n+                    message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\")})\n+    public void getMaxSubscriptionsPerTopic(@Suspended final AsyncResponse asyncResponse,\n+                                @PathParam(\"tenant\") String tenant,\n+                                @PathParam(\"namespace\") String namespace,\n+                                @PathParam(\"topic\") @Encoded String encodedTopic) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        try {\n+            Optional<Integer> maxSubscriptionsPerTopic = internalGetMaxSubscriptionsPerTopic();\n+            if (!maxSubscriptionsPerTopic.isPresent()) {\n+                asyncResponse.resume(Response.noContent().build());\n+            } else {\n+                asyncResponse.resume(maxSubscriptionsPerTopic.get());\n+            }\n+        } catch (RestException e) {\n+            asyncResponse.resume(e);\n+        } catch (Exception e) {\n+            asyncResponse.resume(new RestException(e));\n+        }\n+    }\n+\n+    @POST\n+    @Path(\"/{tenant}/{namespace}/{topic}/maxSubscriptionsPerTopic\")\n+    @ApiOperation(value = \"Set maxSubscriptionsPerTopic config for specified topic.\")\n+    @ApiResponses(value = {@ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405,\n+                    message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\"),\n+            @ApiResponse(code = 412, message = \"Invalid value of maxSubscriptionsPerTopic\")})\n+    public void setMaxSubscriptionsPerTopic(@Suspended final AsyncResponse asyncResponse,\n+                                @PathParam(\"tenant\") String tenant,\n+                                @PathParam(\"namespace\") String namespace,\n+                                @PathParam(\"topic\") @Encoded String encodedTopic,\n+                                @ApiParam(value = \"The max subscriptions of the topic\") int maxSubscriptionsPerTopic) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        internalSetMaxSubscriptionsPerTopic(maxSubscriptionsPerTopic).whenComplete((r, ex) -> {\n+            if (ex instanceof RestException) {\n+                log.error(\"Updating maxSubscriptionsPerTopic failed\", ex);\n+                asyncResponse.resume(ex);\n+            } else if (ex != null) {\n+                log.error(\"Updating maxSubscriptionsPerTopic failed\", ex);\n+                asyncResponse.resume(new RestException(ex));\n+            } else {\n+                log.info(\"[{}] Successfully updated maxSubscriptionsPerTopic: namespace={}, topic={}\"\n+                                + \", maxSubscriptions={}\"\n+                        , clientAppId(), namespaceName, topicName.getLocalName(), maxSubscriptionsPerTopic);\n+                asyncResponse.resume(Response.noContent().build());\n+            }\n+        });\n+    }\n+\n+    @DELETE\n+    @Path(\"/{tenant}/{namespace}/{topic}/maxSubscriptionsPerTopic\")\n+    @ApiOperation(value = \"Remove maxSubscriptionsPerTopic config for specified topic.\")\n+    @ApiResponses(value = {@ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+            @ApiResponse(code = 405,\n+                    message = \"Topic level policy is disabled, to enable the topic level policy and retry\"),\n+            @ApiResponse(code = 409, message = \"Concurrent modification\")})\n+    public void removeMaxSubscriptionsPerTopic(@Suspended final AsyncResponse asyncResponse,\n+                                   @PathParam(\"tenant\") String tenant,\n+                                   @PathParam(\"namespace\") String namespace,\n+                                   @PathParam(\"topic\") @Encoded String encodedTopic) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        internalSetMaxSubscriptionsPerTopic(null).whenComplete((r, ex) -> {", "originalCommit": "b160f7e6584b221f3187406d99ffe1fd8c291e00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk5NzUxNQ==", "url": "https://github.com/apache/pulsar/pull/8948#discussion_r542997515", "bodyText": "The current configuration has 3 states: disabled (0), enabled (>0), and not set.\nDisabled means that even if the policy is set at the upper level, this level will not take effect.\nNot set to distinguish whether to use this level of policy or the upper level. Of course, we can set -1 to mean not set. But it can only be a numeric configuration.\nTherefore, I want to be consistent with other configurations, and use null to indicate not set.", "author": "315157973", "createdAt": "2020-12-15T02:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3ODI1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAyMDk3Nw==", "url": "https://github.com/apache/pulsar/pull/8948#discussion_r543020977", "bodyText": "ok. Thanks for your explanation!", "author": "zymap", "createdAt": "2020-12-15T03:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3ODI1NQ=="}], "type": "inlineReview"}]}