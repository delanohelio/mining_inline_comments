{"pr_number": 8552, "pr_title": "Support topic-level DeduplicationSnapshotInterval", "pr_createdAt": "2020-11-13T03:27:57Z", "pr_url": "https://github.com/apache/pulsar/pull/8552", "timeline": [{"oid": "e25247fc0833342d10faaa0a89f184b0e9de8f06", "url": "https://github.com/apache/pulsar/commit/e25247fc0833342d10faaa0a89f184b0e9de8f06", "message": "support topic-level DeduplicationSnapshotInterval", "committedDate": "2020-11-13T03:06:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkyNzU5Nw==", "url": "https://github.com/apache/pulsar/pull/8552#discussion_r522927597", "bodyText": "I have added awaitility dependency so that we can avoid use sleep in the test, for more details you can see #8557", "author": "codelipenghui", "createdAt": "2020-11-13T12:45:14Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/persistent/TopicDuplicationTest.java", "diffHunk": "@@ -92,6 +92,98 @@ public void testDuplicationApi() throws Exception {\n         assertNull(admin.topics().getDeduplicationEnabled(topicName));\n     }\n \n+    @Test(timeOut = 10000)\n+    public void testDuplicationSnapshotApi() throws Exception {\n+        final String topicName = testTopic + UUID.randomUUID().toString();\n+        admin.topics().createPartitionedTopic(topicName, 3);\n+        waitCacheInit(topicName);\n+        Integer interval = admin.topics().getDeduplicationSnapshotInterval(topicName);\n+        assertNull(interval);\n+\n+        admin.topics().setDeduplicationSnapshotInterval(topicName, 1024);\n+        for (int i = 0; i < 50; i++) {\n+            if (admin.topics().getDeduplicationSnapshotInterval(topicName) != null) {\n+                break;\n+            }\n+            Thread.sleep(100);\n+        }\n+        Assert.assertEquals(admin.topics().getDeduplicationSnapshotInterval(topicName).intValue(), 1024);\n+        admin.topics().removeDeduplicationSnapshotInterval(topicName);\n+        for (int i = 0; i < 50; i++) {\n+            if (admin.topics().getDeduplicationSnapshotInterval(topicName) == null) {\n+                break;\n+            }\n+            Thread.sleep(100);\n+        }\n+        assertNull(admin.topics().getDeduplicationSnapshotInterval(topicName));\n+    }\n+\n+    @Test(timeOut = 30000)\n+    private void testTopicPolicyTakeSnapshot() throws Exception {\n+        resetConfig();\n+        conf.setSystemTopicEnabled(true);\n+        conf.setTopicLevelPoliciesEnabled(true);\n+        conf.setBrokerDeduplicationEnabled(true);\n+        conf.setBrokerDeduplicationSnapshotFrequencyInSeconds(1);\n+        conf.setBrokerDeduplicationSnapshotIntervalSeconds(4);\n+        conf.setBrokerDeduplicationEntriesInterval(20000);\n+        super.internalCleanup();\n+        super.internalSetup();\n+        super.producerBaseSetup();\n+\n+        final String topicName = testTopic + UUID.randomUUID().toString();\n+        final String producerName = \"my-producer\";\n+        @Cleanup\n+        Producer<String> producer = pulsarClient\n+                .newProducer(Schema.STRING).topic(topicName).enableBatching(false).producerName(producerName).create();\n+        waitCacheInit(topicName);\n+        admin.topics().setDeduplicationSnapshotInterval(topicName, 1);\n+        admin.namespaces().setDeduplicationSnapshotInterval(myNamespace, 2);\n+\n+        int msgNum = 50;\n+        CountDownLatch countDownLatch = new CountDownLatch(msgNum);\n+        for (int i = 0; i < msgNum; i++) {\n+            producer.newMessage().value(\"msg\" + i).sendAsync().whenComplete((res, e) -> countDownLatch.countDown());\n+        }\n+        countDownLatch.await();\n+        PersistentTopic persistentTopic = (PersistentTopic) pulsar.getBrokerService().getTopicIfExists(topicName).get().get();\n+        long seqId = persistentTopic.getMessageDeduplication().highestSequencedPersisted.get(producerName);\n+        PositionImpl position = (PositionImpl) persistentTopic.getMessageDeduplication().getManagedCursor()\n+                .getManagedLedger().getLastConfirmedEntry();\n+        assertEquals(seqId, msgNum - 1);\n+        assertEquals(position.getEntryId(), msgNum - 1);\n+        //The first time, use topic-leve policies, 1 second delay + 1 second interval\n+        Thread.sleep(2000);", "originalCommit": "e25247fc0833342d10faaa0a89f184b0e9de8f06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4fd175a768b041dc8967562879f0cc121484e474", "url": "https://github.com/apache/pulsar/commit/4fd175a768b041dc8967562879f0cc121484e474", "message": "Merge branch 'master' into deduplication-topic", "committedDate": "2020-11-13T14:22:23Z", "type": "commit"}, {"oid": "e56300d4a92637e00a5906b4088ddf92f7e0ab96", "url": "https://github.com/apache/pulsar/commit/e56300d4a92637e00a5906b4088ddf92f7e0ab96", "message": "use Awaitility in unit test", "committedDate": "2020-11-14T07:06:09Z", "type": "commit"}, {"oid": "8459b16812c1274652108bdceb3077cb56bd5585", "url": "https://github.com/apache/pulsar/commit/8459b16812c1274652108bdceb3077cb56bd5585", "message": "fix unit test", "committedDate": "2020-11-14T07:19:05Z", "type": "commit"}]}