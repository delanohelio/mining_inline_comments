{"pr_number": 8606, "pr_title": "[C++] fix cpp client do AcknowledgeCumulative not clean up previous message", "pr_createdAt": "2020-11-18T07:53:53Z", "pr_url": "https://github.com/apache/pulsar/pull/8606", "timeline": [{"oid": "8e74000e435df27912cafc3783b5062dbabf5925", "url": "https://github.com/apache/pulsar/commit/8e74000e435df27912cafc3783b5062dbabf5925", "message": "Fix cpp client do AcknowledgeCumulative not clean up previous message", "committedDate": "2020-11-27T04:47:38Z", "type": "forcePushed"}, {"oid": "24b447e6859c46f13e4e57c69cfe81be10c67af3", "url": "https://github.com/apache/pulsar/commit/24b447e6859c46f13e4e57c69cfe81be10c67af3", "message": "Fix cpp client do AcknowledgeCumulative not clean up previous message", "committedDate": "2020-11-27T04:57:53Z", "type": "forcePushed"}, {"oid": "a8336f7e14be9f112503e249d40c29b7e2d674e1", "url": "https://github.com/apache/pulsar/commit/a8336f7e14be9f112503e249d40c29b7e2d674e1", "message": "Fix cpp client do AcknowledgeCumulative not clean up previous message", "committedDate": "2020-11-27T05:00:18Z", "type": "forcePushed"}, {"oid": "e98394a8bfefbda44d79bc070a68c8897337b482", "url": "https://github.com/apache/pulsar/commit/e98394a8bfefbda44d79bc070a68c8897337b482", "message": "Fix cpp client do AcknowledgeCumulative not clean up previous message", "committedDate": "2020-11-27T05:03:10Z", "type": "forcePushed"}, {"oid": "0f4cb785017cdbfaa0e60698fd83f18a0d4c2a5f", "url": "https://github.com/apache/pulsar/commit/0f4cb785017cdbfaa0e60698fd83f18a0d4c2a5f", "message": "[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n### Motivation\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n### Modifications\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`", "committedDate": "2020-11-30T13:00:50Z", "type": "forcePushed"}, {"oid": "dfc46604428c7994999f3bc80ca419999bcadd3f", "url": "https://github.com/apache/pulsar/commit/dfc46604428c7994999f3bc80ca419999bcadd3f", "message": "[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`", "committedDate": "2020-11-30T14:38:15Z", "type": "forcePushed"}, {"oid": "f846daa37b2fd4664d6241bb396fbe06fd30974e", "url": "https://github.com/apache/pulsar/commit/f846daa37b2fd4664d6241bb396fbe06fd30974e", "message": "[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`\n[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`", "committedDate": "2020-11-30T14:45:38Z", "type": "forcePushed"}, {"oid": "ed3704ceba3c8e5e4b0052414208d6547ac17b61", "url": "https://github.com/apache/pulsar/commit/ed3704ceba3c8e5e4b0052414208d6547ac17b61", "message": "[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`\n[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`", "committedDate": "2020-11-30T14:56:22Z", "type": "forcePushed"}, {"oid": "6f4ff1b817c7670a15d8659ff4f5d9faf818b708", "url": "https://github.com/apache/pulsar/commit/6f4ff1b817c7670a15d8659ff4f5d9faf818b708", "message": "[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`\n[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`", "committedDate": "2020-11-30T15:16:22Z", "type": "forcePushed"}, {"oid": "5a93aed0673782fb83af06d452af15197c6e0aa3", "url": "https://github.com/apache/pulsar/commit/5a93aed0673782fb83af06d452af15197c6e0aa3", "message": "[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`\n[C++] Fix potential crash caused by UnAckedMessageTrackerEnabled's timer(issue like ##8519)\n\n- pulsar-client-cpp Consumer do AcknowledgeCumulative just clean up `msgId`, not <= `msgId` in  `UnAckedMessageTrackerEnabled::removeMessagesTill`\n- potential crash caused by UnAckedMessageTrackerEnabled's timer(see issue like #8519)\n\n- When do AcknowledgeCumulative from application, earse <= `msgId` in UnAckedMessageTrackerEnabled, avoid redeliver unnecessary unacknowledged messages to Broker\n- Use std::shared_ptr instead of std::unique_ptr for UnAckedMessageTrackerEnabled\n- add `start()`, `close()` method to `UnAckedMessageTrackerEnabled` solve same issue see #8519\n- add `isEmpty()`, `size()` method to `UnAckedMessageTrackerEnabled` for checking of test case\n- when close `UnAckedMessageTrackerEnabled` and `AckGroupingTrackerEnabled`, reset shared_ptr `timer_`\n- add unit test for `UnAckedMessageTrackerEnabled`", "committedDate": "2020-11-30T15:35:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxOTYyNw==", "url": "https://github.com/apache/pulsar/pull/8606#discussion_r532719627", "bodyText": "It won't pass the clang-format check here. Please use clang-format 5.0 to reformat your code.", "author": "BewareMyPower", "createdAt": "2020-11-30T16:17:39Z", "path": "pulsar-client-cpp/lib/UnAckedMessageTrackerEnabled.h", "diffHunk": "@@ -25,25 +25,27 @@\n namespace pulsar {\n class UnAckedMessageTrackerEnabled : public UnAckedMessageTrackerInterface {\n    public:\n-    ~UnAckedMessageTrackerEnabled();\n+       virtual ~UnAckedMessageTrackerEnabled() { this->close(); }", "originalCommit": "5a93aed0673782fb83af06d452af15197c6e0aa3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMzYxMA==", "url": "https://github.com/apache/pulsar/pull/8606#discussion_r532723610", "bodyText": "Why remove the cancel() here?", "author": "BewareMyPower", "createdAt": "2020-11-30T16:23:03Z", "path": "pulsar-client-cpp/lib/UnAckedMessageTrackerEnabled.cc", "diffHunk": "@@ -158,9 +158,15 @@ void UnAckedMessageTrackerEnabled::clear() {\n     }\n }\n \n-UnAckedMessageTrackerEnabled::~UnAckedMessageTrackerEnabled() {\n-    if (timer_) {\n-        timer_->cancel();\n+void UnAckedMessageTrackerEnabled::start() {\n+    this->scheduleTimer();\n+}\n+\n+void UnAckedMessageTrackerEnabled::close() {\n+    std::lock_guard<std::mutex> acquire(mutexTimer_);\n+    if (this->timer_) {\n+        boost::system::error_code ec;\n+        this->timer_.reset();", "originalCommit": "5a93aed0673782fb83af06d452af15197c6e0aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxNDI5Ng==", "url": "https://github.com/apache/pulsar/pull/8606#discussion_r533014296", "bodyText": "sorry, accidentally deleted", "author": "saosir", "createdAt": "2020-12-01T01:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMzYxMA=="}], "type": "inlineReview"}, {"oid": "c3217efde6617f2737fef3b9eec290cc78492387", "url": "https://github.com/apache/pulsar/commit/c3217efde6617f2737fef3b9eec290cc78492387", "message": "[C++] Fix cpp client do AcknowledgeCumulative not clean up previous message", "committedDate": "2020-11-27T11:03:23Z", "type": "forcePushed"}, {"oid": "9d212cf2e1055e12caa3bebc4492489ca11e8783", "url": "https://github.com/apache/pulsar/commit/9d212cf2e1055e12caa3bebc4492489ca11e8783", "message": "[C++] add UnAckedMessageTrackerEnabled unit test", "committedDate": "2020-12-01T08:04:08Z", "type": "forcePushed"}, {"oid": "ba8125cb998cab833547644e47d7fa1525a0f295", "url": "https://github.com/apache/pulsar/commit/ba8125cb998cab833547644e47d7fa1525a0f295", "message": "[C++] add UnAckedMessageTrackerEnabled unit test", "committedDate": "2020-12-01T09:02:17Z", "type": "forcePushed"}, {"oid": "8ed9502e0101e7f1aa3b8823ef2a01a0667eefc0", "url": "https://github.com/apache/pulsar/commit/8ed9502e0101e7f1aa3b8823ef2a01a0667eefc0", "message": "[C++] add UnAckedMessageTrackerEnabled unit test", "committedDate": "2020-12-01T09:05:05Z", "type": "forcePushed"}, {"oid": "d3f76e5eb8fa0b116a8a916c84f6bb3c8f108061", "url": "https://github.com/apache/pulsar/commit/d3f76e5eb8fa0b116a8a916c84f6bb3c8f108061", "message": "[C++] add UnAckedMessageTrackerEnabled unit test", "committedDate": "2020-12-01T11:10:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2OTgyMw==", "url": "https://github.com/apache/pulsar/pull/8606#discussion_r533469823", "bodyText": "A typo: testtUnAcked -> testUnAcked", "author": "BewareMyPower", "createdAt": "2020-12-01T14:49:17Z", "path": "pulsar-client-cpp/tests/BasicEndToEndTest.cc", "diffHunk": "@@ -3826,3 +3826,208 @@ TEST(BasicEndToEndTest, testAckGroupingTrackerEnabledCumulativeAck) {\n     ret = consumer.receive(msg, 1000);\n     ASSERT_EQ(ResultTimeout, ret) << \"Received redundant message ID: \" << msg.getMessageId();\n }\n+\n+class UnAckedMessageTrackerEnabledMock : public UnAckedMessageTrackerEnabled {\n+   public:\n+    UnAckedMessageTrackerEnabledMock(long timeoutMs, const ClientImplPtr client, ConsumerImplBase &consumer)\n+        : UnAckedMessageTrackerEnabled(timeoutMs, timeoutMs, client, consumer) {}\n+    const long getUnAckedMessagesTimeoutMs() { return this->timeoutMs_; }\n+    const long getTickDurationInMs() { return this->tickDurationInMs_; }\n+    bool isEmpty() { return UnAckedMessageTrackerEnabled::isEmpty(); }\n+    long size() { return UnAckedMessageTrackerEnabled::size(); }\n+};  // class UnAckedMessageTrackerEnabledMock\n+\n+TEST(BasicEndToEndTest, testtUnAckedMessageTrackerDefaultBehavior) {", "originalCommit": "d3f76e5eb8fa0b116a8a916c84f6bb3c8f108061", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1MzE2NA==", "url": "https://github.com/apache/pulsar/pull/8606#discussion_r533853164", "bodyText": "Do I need to resubmit the code to fix this problem?How about someone fix it when merge pull request?", "author": "saosir", "createdAt": "2020-12-02T02:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2OTgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1NDA5Ng==", "url": "https://github.com/apache/pulsar/pull/8606#discussion_r533854096", "bodyText": "I think a committer could fix it when merge PR. So you needn't any changes. @jiazhai could you help take a look?", "author": "BewareMyPower", "createdAt": "2020-12-02T02:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2OTgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDEyNjE1OQ==", "url": "https://github.com/apache/pulsar/pull/8606#discussion_r550126159", "bodyText": "@saosir Can you create a follow-up PR to fix the typo?", "author": "sijie", "createdAt": "2020-12-30T10:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2OTgyMw=="}], "type": "inlineReview"}, {"oid": "2b3d2a7d407b27d3341fcc4403040163aafccea2", "url": "https://github.com/apache/pulsar/commit/2b3d2a7d407b27d3341fcc4403040163aafccea2", "message": "[C++] add UnAckedMessageTrackerEnabled unit test", "committedDate": "2020-12-26T06:38:18Z", "type": "forcePushed"}, {"oid": "19f7c6ed5bcc1cc65614a77b36876601f5a4c31d", "url": "https://github.com/apache/pulsar/commit/19f7c6ed5bcc1cc65614a77b36876601f5a4c31d", "message": "[C++] Fix cpp client do AcknowledgeCumulative not clean up previous message", "committedDate": "2020-12-26T14:03:45Z", "type": "commit"}, {"oid": "19f7c6ed5bcc1cc65614a77b36876601f5a4c31d", "url": "https://github.com/apache/pulsar/commit/19f7c6ed5bcc1cc65614a77b36876601f5a4c31d", "message": "[C++] Fix cpp client do AcknowledgeCumulative not clean up previous message", "committedDate": "2020-12-26T14:03:45Z", "type": "forcePushed"}]}