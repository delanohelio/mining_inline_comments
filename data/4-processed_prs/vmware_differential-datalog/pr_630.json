{"pr_number": 630, "pr_title": "Internment library.", "pr_createdAt": "2020-04-17T04:13:07Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/630", "timeline": [{"oid": "143c1bec0e50e54d405320cc179084995c130ac9", "url": "https://github.com/vmware/differential-datalog/commit/143c1bec0e50e54d405320cc179084995c130ac9", "message": "Internment library.\n\nThis commit adds bindings for the Rust `internment` crate, which\nimplements reference-counted interned objects of arbitrary types.\nUnlike the `intern.dl` library, `internment` garbage collects unused\nobjects.\n\nWe also add versions of standard string functions that accept interned\nstrings.\n\nThis is still work in progress.  In particular, some amount of language\nsupport is needed to make interned strings (and other objects)\nnear-transparent, as well as to efficiently handle static strings.", "committedDate": "2020-04-17T02:55:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM1MTc1NA==", "url": "https://github.com/vmware/differential-datalog/pull/630#discussion_r410351754", "bodyText": "why keep this comment around?", "author": "mbudiu-vmw", "createdAt": "2020-04-17T16:59:17Z", "path": "lib/internment.rs", "diffHunk": "@@ -0,0 +1,233 @@\n+use differential_datalog::record;\n+use differential_datalog::record::*;\n+use internment::ArcIntern;\n+use serde;\n+use std::cmp;\n+use std::fmt;\n+\n+#[cfg(feature = \"flatbuf\")]\n+use flatbuf::{FromFlatBuffer, ToFlatBuffer, ToFlatBufferTable, ToFlatBufferVectorElement};\n+\n+/* `flatc`-generated declarations re-exported by `flatbuf.rs` */\n+#[cfg(feature = \"flatbuf\")]\n+use flatbuf::fb;\n+\n+/* FlatBuffers runtime */\n+#[cfg(feature = \"flatbuf\")]\n+use flatbuffers as fbrt;\n+\n+#[derive(Default, Eq, PartialOrd, PartialEq, Ord, Clone, Hash)]\n+pub struct internment_Intern<A>\n+where\n+    A: Eq + Send + Hash + 'static,\n+{\n+    intern: ArcIntern<A>,\n+}\n+\n+impl<A: Eq + Hash + Send + 'static> internment_Intern<A> {\n+    pub fn new(x: A) -> internment_Intern<A> {\n+        internment_Intern {\n+            intern: ArcIntern::new(x),\n+        }\n+    }\n+    pub fn as_ref(&self) -> &A {\n+        self.intern.as_ref()\n+    }\n+}\n+\n+pub fn internment_intern<A: Eq + Hash + Send + Clone + 'static>(x: &A) -> internment_Intern<A> {\n+    internment_Intern::new(x.clone())\n+}\n+\n+pub fn internment_ival<A: Eq + Hash + Send + Clone>(x: &internment_Intern<A>) -> A {\n+    x.intern.as_ref().clone()\n+}\n+\n+/*pub fn intern_istring_ord(s: &intern_IString) -> u32 {\n+    s.x\n+}*/\n+\n+impl<A: fmt::Display + Eq + Hash + Send + Clone> fmt::Display for internment_Intern<A> {\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n+        fmt::Display::fmt(self.as_ref(), f)\n+        //record::format_ddlog_str(&intern_istring_str(self), f)", "originalCommit": "143c1bec0e50e54d405320cc179084995c130ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2NDczNA==", "url": "https://github.com/vmware/differential-datalog/pull/630#discussion_r410364734", "bodyText": "Because this is very likely to cause problems for the new implementation and I will need to figure out how to fix it. At least there will be a reminder in the code.", "author": "ryzhyk", "createdAt": "2020-04-17T17:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM1MTc1NA=="}], "type": "inlineReview"}]}