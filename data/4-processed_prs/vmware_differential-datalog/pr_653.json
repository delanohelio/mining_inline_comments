{"pr_number": 653, "pr_title": "Add support for Inspect operator", "pr_createdAt": "2020-05-04T16:35:53Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/653", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNjgyNA==", "url": "https://github.com/vmware/differential-datalog/pull/653#discussion_r419636824", "bodyText": "The timestamp type is actually more complex.  For a non-recursive rule, the timestamp is indeed just u64. For a rule that is part of a recursive fragment, it is a pair of two timestamps: the global timestamp, which is the same as in the non-recursive case and the inner timestamp, which represents iteration of the fixed point computation.  There are two ways we can handle this. The RFC suggests:\ntypedef DDTimestamp = DDTSGlobal{epoch: u64}\n                    | DDTSNested{epoch: u64, iteration: u64}\n\nNow I am thinking that a better way would be to use different types depending on the context.  We can add a method to check if the rule is recursive and use the appropriate type based on that.", "author": "ryzhyk", "createdAt": "2020-05-04T18:24:16Z", "path": "src/Language/DifferentialDatalog/NS.hs", "diffHunk": "@@ -147,6 +147,7 @@ ctxMVars d ctx =\n          CtxRuleRAtom rl i        -> ([], map f2mf $ ruleRHSVars d rl i)\n          CtxRuleRCond rl i        -> ([], map f2mf $ ruleRHSVars d rl i)\n          CtxRuleRFlatMap rl i     -> ([], map f2mf $ ruleRHSVars d rl i)\n+         CtxRuleRInspect rl i     -> ([], (map f2mf $ ruleRHSVars d rl i) ++ [(\"ddlog_weight\", Just $ tBit 64), (\"ddlog_timestamp\", Just $ tBit 64)])", "originalCommit": "640e388857e924be6fd16daf74bea49936daff27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzOTEzOA==", "url": "https://github.com/vmware/differential-datalog/pull/653#discussion_r419639138", "bodyText": "You may want to also test the use of timestamp and weight variables.", "author": "ryzhyk", "createdAt": "2020-05-04T18:28:02Z", "path": "test/datalog_tests/simple2.dl", "diffHunk": "@@ -106,3 +106,15 @@ function weird_zero(x: 'A): usize {\n function zero_test(): usize {\n     weird_zero(32'd0)\n }\n+\n+/* See #618. New Inspect operator syntax. */\n+output relation InspectSimpleSum(x: bit<32>, total: bit<32>)\n+\n+input relation InputTuples(x: bit<32>, y: bit<32>)\n+\n+InspectSimpleSum(x, total) :-\n+    InputTuples(x, y),\n+    var total = Aggregate((x), group_sum(y)),\n+    Inspect {", "originalCommit": "640e388857e924be6fd16daf74bea49936daff27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "24c0817f8767def33957067e62ea8312ca4f4c5f", "url": "https://github.com/vmware/differential-datalog/commit/24c0817f8767def33957067e62ea8312ca4f4c5f", "message": "Add syntax support for Inspect\n\nA new Inspect operator is introduced. Refer to\nhttps://github.com/vmware/differential-datalog/issues/618.\n\nParsing, syntax, and validation has been updated to support this\nnew operator.\n\nUpdate compileRule logic to temporarily skip Inspect rule.\nA placeholder mkInspect function is added that currently only\ngenerates an empty string..", "committedDate": "2020-05-05T21:22:53Z", "type": "forcePushed"}, {"oid": "bb256d51931811407eb3600c0c8b6f9c696c9570", "url": "https://github.com/vmware/differential-datalog/commit/bb256d51931811407eb3600c0c8b6f9c696c9570", "message": "Add syntax support for Inspect\n\nA new Inspect operator is introduced. Refer to\nhttps://github.com/vmware/differential-datalog/issues/618.\n\nParsing, syntax, and validation has been updated to support this\nnew operator.\n\nUpdate compileRule logic to temporarily skip Inspect rule.\nA placeholder mkInspect function is added that currently only\ngenerates an empty string..", "committedDate": "2020-05-05T23:17:15Z", "type": "forcePushed"}, {"oid": "9582ad07c620b71068dc29922285428a5b16d515", "url": "https://github.com/vmware/differential-datalog/commit/9582ad07c620b71068dc29922285428a5b16d515", "message": "Add Inspect operator compiler support for generating rust code\n\n1. Add a case in mkCollectionOperator for handling\n   RHSInspect.\n2. Add an mkFilterMap function that generates\n   rust code for filtering inputs before passing it to inspect.\n3. Add an mkInspect that generates rust code for the expression.\n4. Update rhsVarsAfter and add a case for Inspect, which does not\n   drop any variable (inspect does not modify the collection\n   it is inspecting).\n5. Update log function signature to return () instead of bool so\n   that it can be used in an Inspect operator.\n\nref: https://github.com/vmware/differential-datalog/issues/618", "committedDate": "2020-05-07T22:31:30Z", "type": "forcePushed"}, {"oid": "022927c2764c7f1b81db032fc468c1ef40be5e05", "url": "https://github.com/vmware/differential-datalog/commit/022927c2764c7f1b81db032fc468c1ef40be5e05", "message": "Add Inspect operator compiler support for generating rust code\n\n1. Add a case in mkCollectionOperator for handling\n   RHSInspect.\n2. Add an mkFilterMap function that generates\n   rust code for filtering inputs before passing it to inspect.\n3. Add an mkInspect that generates rust code for the expression.\n4. Update rhsVarsAfter and add a case for Inspect, which does not\n   drop any variable (inspect does not modify the collection\n   it is inspecting).\n5. Update log function signature to return () instead of bool so\n   that it can be used in an Inspect operator.\n\nref: https://github.com/vmware/differential-datalog/issues/618", "committedDate": "2020-05-08T00:01:15Z", "type": "forcePushed"}, {"oid": "ea25f603527ee7b5087d753a293a1dc70c50739d", "url": "https://github.com/vmware/differential-datalog/commit/ea25f603527ee7b5087d753a293a1dc70c50739d", "message": "Add Inspect operator compiler support for generating rust code\n\n1. Add a case in mkCollectionOperator for handling\n   RHSInspect.\n2. Add an mkFilterMap function that generates\n   rust code for filtering inputs before passing it to inspect.\n3. Add an mkInspect that generates rust code for the expression.\n4. Update rhsVarsAfter and add a case for Inspect, which does not\n   drop any variable (inspect does not modify the collection\n   it is inspecting).\n5. Update log function signature to return () instead of bool so\n   that it can be used in an Inspect operator.\n\nref: https://github.com/vmware/differential-datalog/issues/618", "committedDate": "2020-05-08T02:17:32Z", "type": "forcePushed"}, {"oid": "6f130f5110f4105bb3d400b14a5face0983d75cb", "url": "https://github.com/vmware/differential-datalog/commit/6f130f5110f4105bb3d400b14a5face0983d75cb", "message": "Add Inspect operator compiler support for generating rust code\n\n1. Add a case in mkCollectionOperator for handling\n   RHSInspect.\n2. Add an mkFilterMap function that generates\n   rust code for filtering inputs before passing it to inspect.\n3. Add an mkInspect that generates rust code for the expression.\n4. Update rhsVarsAfter and add a case for Inspect, which does not\n   drop any variable (inspect does not modify the collection\n   it is inspecting).\n5. Update log function signature to return () instead of bool so\n   that it can be used in an Inspect operator.\n\nref: https://github.com/vmware/differential-datalog/issues/618", "committedDate": "2020-05-08T03:29:40Z", "type": "forcePushed"}, {"oid": "649ff3408a49b4ad776b811bb07fe38c78fd312b", "url": "https://github.com/vmware/differential-datalog/commit/649ff3408a49b4ad776b811bb07fe38c78fd312b", "message": "Update log function signature to return () instead of bool\n\nIn order to be able to use the log function with the Inspect\noperator, functions must return a ().\n\nNote that this is a breaking change. log function cannot\nbe directly used in the rule.", "committedDate": "2020-05-08T06:47:01Z", "type": "forcePushed"}, {"oid": "2a18a8609d3ba8e65fe9174a9e6336aefa7c53e3", "url": "https://github.com/vmware/differential-datalog/commit/2a18a8609d3ba8e65fe9174a9e6336aefa7c53e3", "message": "Add additional test cases for inspect operator\n\n1. Implement an inspect_log log extern function that logs messages\ninto a specified file.\n\n2. Existing and new test cases are added that covers Inspect used\nwith FlatMap, aggregation, filtered relations, and recursive rules.\n\n3. Spec.hs is updated to also verify log output if the corresponding\n   log.expected file is available. For log output verification,\n   the contents are sorted first before comparing since ordering\n   of log outputs are not guaranteed due to parallelism.", "committedDate": "2020-05-11T07:26:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIwMzIwMw==", "url": "https://github.com/vmware/differential-datalog/pull/653#discussion_r423203203", "bodyText": "We need to provide a string conversion function for this type so that timestamps can be easily printed. The function must have the following signature: dDTimestamp2string(ts: DDTimestamp): string", "author": "ryzhyk", "createdAt": "2020-05-11T17:31:14Z", "path": "lib/std.dl", "diffHunk": "@@ -19,6 +19,12 @@ typedef s128 = signed<128>\n \n typedef usize = u64\n \n+typedef DDWeight = s64\n+typedef DDEpoch = u64\n+typedef DDIteration = u64\n+typedef DDTimestamp = DDTSGlobal{epoch: DDEpoch}", "originalCommit": "f2f82fd1313d636602385ca70f895a47e453f5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIxMDE4NQ==", "url": "https://github.com/vmware/differential-datalog/pull/653#discussion_r423210185", "bodyText": "The last three must occur after all atoms. - I don't remember when I wrote this, but this comment is wrong and must be removed.", "author": "ryzhyk", "createdAt": "2020-05-11T17:43:25Z", "path": "src/Language/DifferentialDatalog/Syntax.hs", "diffHunk": "@@ -521,13 +521,14 @@ instance Show Atom where\n     show = render . pp\n \n -- The RHS of a rule consists of relational atoms with\n--- positive/negative polarity, Boolean conditions, aggregation and\n--- disaggregation (flatmap) operations.  The last two must occur after\n+-- positive/negative polarity, Boolean conditions, aggregation,\n+-- disaggregation (flatmap), inspect operations.  The last three must occur after\n -- all atoms.", "originalCommit": "f2f82fd1313d636602385ca70f895a47e453f5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIxMDkxMg==", "url": "https://github.com/vmware/differential-datalog/pull/653#discussion_r423210912", "bodyText": "Nice!", "author": "ryzhyk", "createdAt": "2020-05-11T17:44:40Z", "path": "test/Spec.hs", "diffHunk": "@@ -74,41 +74,56 @@ allTests progress = do\n         let datFile = replaceExtension dlFile \"dat\"\n         -- If there's a gzipped reference file, use that\n         let gzFile = replaceExtension dlFile \"dump.expected.gz\"\n+        -- If there's a .log.expected file, also verify log output", "originalCommit": "f2f82fd1313d636602385ca70f895a47e453f5cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "76227647ded547bbdb95eda45aa77c1c961d1477", "url": "https://github.com/vmware/differential-datalog/commit/76227647ded547bbdb95eda45aa77c1c961d1477", "message": "Update documentation with description of the Inspect operator", "committedDate": "2020-05-11T20:33:14Z", "type": "forcePushed"}, {"oid": "b3e4112597db8d47803233430ca952093d13f4f4", "url": "https://github.com/vmware/differential-datalog/commit/b3e4112597db8d47803233430ca952093d13f4f4", "message": "Update documentation with description of the Inspect operator", "committedDate": "2020-05-11T21:26:20Z", "type": "forcePushed"}, {"oid": "e51af33ee2e75ca32bb4f13b8530d07b95f5de63", "url": "https://github.com/vmware/differential-datalog/commit/e51af33ee2e75ca32bb4f13b8530d07b95f5de63", "message": "Update documentation with description of the Inspect operator", "committedDate": "2020-05-11T22:54:37Z", "type": "forcePushed"}, {"oid": "10196b0f231c7a1474aca9546c2f54d30daa7fed", "url": "https://github.com/vmware/differential-datalog/commit/10196b0f231c7a1474aca9546c2f54d30daa7fed", "message": "Add syntax support for Inspect\n\nA new Inspect operator is introduced. Refer to\nhttps://github.com/vmware/differential-datalog/issues/618.\n\nParsing, syntax, and validation has been updated to support this\nnew operator.\n\nUpdate compileRule logic to temporarily skip Inspect rule.\nA placeholder mkInspect function is added that currently only\ngenerates an empty string..", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "fe5532ab08235be75b6c54bd33926d547efdad17", "url": "https://github.com/vmware/differential-datalog/commit/fe5532ab08235be75b6c54bd33926d547efdad17", "message": "Add support for inspect operator in rust runtime.\n\nref: https://github.com/vmware/differential-datalog/issues/618", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "557704f3b8e82cbb2598d49603e1381374ce6854", "url": "https://github.com/vmware/differential-datalog/commit/557704f3b8e82cbb2598d49603e1381374ce6854", "message": "Fixup the use of `ifun`.\n\n- Introduce a trait for timestamps that can be converted to a tuple.\n- Implement this trait for both `TS` and `Product<TS, TSNested>`.\n- Use it to invoke the same `ifun` in both nested and top-level\n  contexts.", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "0d47a97b3ac0fdf8ee91b3145ab1cf10a0cb9f52", "url": "https://github.com/vmware/differential-datalog/commit/0d47a97b3ac0fdf8ee91b3145ab1cf10a0cb9f52", "message": "Formatting.", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "bfbe7f8af76412046de275f552099870242a40b7", "url": "https://github.com/vmware/differential-datalog/commit/bfbe7f8af76412046de275f552099870242a40b7", "message": "Add Inspect operator compiler support for generating rust code\n\n1. Add a case in mkCollectionOperator for handling\n   RHSInspect.\n2. Add an mkFilterMap function that generates\n   rust code for filtering inputs before passing it to inspect.\n3. Add an mkInspect that generates rust code for the expression.\n4. Update rhsVarsAfter and add a case for Inspect, which does not\n   drop any variable (inspect does not modify the collection\n   it is inspecting).\n\nref: https://github.com/vmware/differential-datalog/issues/618", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "c2416417575f76d21fd48a00b74daa132c058c67", "url": "https://github.com/vmware/differential-datalog/commit/c2416417575f76d21fd48a00b74daa132c058c67", "message": "Update log function signature to return () instead of bool\n\nIn order to be able to use the log function with the Inspect\noperator, functions must return a ().\n\nNote that this is a breaking change. log function cannot\nbe directly used in the rule.", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "34d19d09cfb87f21b1ae92110371ff9cff1a413b", "url": "https://github.com/vmware/differential-datalog/commit/34d19d09cfb87f21b1ae92110371ff9cff1a413b", "message": "Fix rhsVarsAfter function condition for RHSInspect\n\nThe function was incorrectly returning all variables visible\nafter this term, instead of all variables used after this term.", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "15803d41c164f36178a31c0e57cb58453e3f57a0", "url": "https://github.com/vmware/differential-datalog/commit/15803d41c164f36178a31c0e57cb58453e3f57a0", "message": "Add additional test cases for inspect operator\n\n1. Implement an inspect_log log extern function that logs messages\ninto a specified file.\n\n2. Existing and new test cases are added that covers Inspect used\nwith FlatMap, aggregation, filtered relations, and recursive rules.\n\n3. Spec.hs is updated to also verify log output if the corresponding\n   log.expected file is available. For log output verification,\n   the contents are sorted first before comparing since ordering\n   of log outputs are not guaranteed due to parallelism.", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "85169275b676cdc47c9610306d358eadff380e26", "url": "https://github.com/vmware/differential-datalog/commit/85169275b676cdc47c9610306d358eadff380e26", "message": "Update documentation with description of the Inspect operator", "committedDate": "2020-05-13T06:58:01Z", "type": "commit"}, {"oid": "0c536ddf9a74243e10a1278affcfd54edde682e9", "url": "https://github.com/vmware/differential-datalog/commit/0c536ddf9a74243e10a1278affcfd54edde682e9", "message": "Automatic string conversion for nested timestamps.\n\nRe-define nested timestamp as a struct instead of a tuple and provide a\n`2string` function for it, so that we can print timestamps like this:\n\n```\n\"${ddlog_timestamp}\"\n```\n\ninstead of\n\n```\n\"${ddlog_timestamp.0},${ddlog_timestamp.1}\"\n```", "committedDate": "2020-05-13T06:58:02Z", "type": "commit"}, {"oid": "799b1101582c2d2378eeb1c1957f48b17602c481", "url": "https://github.com/vmware/differential-datalog/commit/799b1101582c2d2378eeb1c1957f48b17602c481", "message": "Tutorial section on Inspect.", "committedDate": "2020-05-13T06:58:02Z", "type": "commit"}, {"oid": "96b342bb89ec75c3bd2949687704eb5da3077aec", "url": "https://github.com/vmware/differential-datalog/commit/96b342bb89ec75c3bd2949687704eb5da3077aec", "message": "Fix rebase regression.\n\nThis branch did not pickup an important fix in master that assigns the\nsame timestamp ti all updates made within a transaction.", "committedDate": "2020-05-13T07:15:15Z", "type": "commit"}, {"oid": "96b342bb89ec75c3bd2949687704eb5da3077aec", "url": "https://github.com/vmware/differential-datalog/commit/96b342bb89ec75c3bd2949687704eb5da3077aec", "message": "Fix rebase regression.\n\nThis branch did not pickup an important fix in master that assigns the\nsame timestamp ti all updates made within a transaction.", "committedDate": "2020-05-13T07:15:15Z", "type": "forcePushed"}]}