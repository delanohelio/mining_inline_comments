{"pr_number": 658, "pr_title": "Support for transcoding data from JSON to binary formats.", "pr_createdAt": "2020-05-07T22:50:29Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/658", "timeline": [{"oid": "8f3389ed7f0dd63733d6fe6dd5772e50dfc90de9", "url": "https://github.com/vmware/differential-datalog/commit/8f3389ed7f0dd63733d6fe6dd5772e50dfc90de9", "message": "json.dl: Transcode JsonValue to binary data.\n\nDDlog automatically derives `Serialize` and `Deserialize`\nimplementations for all its types, which means that they can in\nprinciple be serialized into any formats supported by the `serde`\necosystem, both binary and human readable.  But there are some caveats.\nIn particular, types that rely on the  `deserialize_any` serde API\ncan only be deserialized from self-describing formats like JSON.\n\nThis includes `JsonValue` and types with `tag` and `flatten`\nannotations.\n\nIn this commit we deal with `JsonValue` by giving it a custom\n`Serialize`/`Deserialize` implementation that, when serializing to a\nnon-human readable format, first converts the type to a JSON string and\nthen serializes the string.", "committedDate": "2020-05-07T22:37:01Z", "type": "commit"}, {"oid": "a80c72ff8471dc299436fec621b24ccc6321400b", "url": "https://github.com/vmware/differential-datalog/commit/a80c72ff8471dc299436fec621b24ccc6321400b", "message": "json.dl: JsonWrapper to transcode JSON to binary data.\n\nThis is a workaround for a `serde` limitation that prevents certain data types from\nbeing serialized or deserialized from non-self-describing data formats like bincode.\nIn particular, this is the case for data types annotated with JSON-related serde\nattributes like `tag` and `flatten`.  In practice this means that types annotated for\nserialization to JSON cannot be serialized to other formats.\n\nThe workaround is to use different serialization logic when serializing to binary and\nnon-binary formats.  In the binary case, we want to serialize such types into a string\nand then serialize the string as a field in binary data.  In the non-binary case, we\nstick to normal serde behavior.  `JsonWrapper` type implements this choice by checking\nthe `is_human_readable` property of the serializer.\n\nThe current implementation has an important flaw: serde currently does not provide a\nreliable way to determine if a serializer supports self-describing data.  We use\n`is_human_readable` attribute as an approximation, which is not always correct: binary\nformats can be self-describing (BSON, Pickle), conversely not all human-readable formats\nare self-describing.  Nevertheless, the current design enables useful scenarios, like\ntranscoding JSON to bincode.\n\nImplementing `JsonWrapper` required a new attribute `#[custom_serde]`\nthat tells DDlog not to derive default `Serialize`/`Deserialize`\nimplementations for a type.", "committedDate": "2020-05-07T23:26:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MjM0NA==", "url": "https://github.com/vmware/differential-datalog/pull/658#discussion_r421842344", "bodyText": "no reference output?", "author": "mbudiu-vmw", "createdAt": "2020-05-07T23:01:57Z", "path": "test/datalog_tests/json_test.dl", "diffHunk": "@@ -183,3 +183,16 @@ JsonTest(s32FromString1(),\n          to_json_string_or_default(from_json_string(s32FromString1()): Result<S32FromString, string>)).\n JsonTest(s32FromString2(),\n          to_json_string_or_default(from_json_string(s32FromString2()): Result<S32FromString, string>)).\n+\n+typedef WrappedEnum = JsonWrapper<TaggedEnum>", "originalCommit": "4f17aaa8d062cbf62d55bf45554f764b53ad265a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1Njc2NA==", "url": "https://github.com/vmware/differential-datalog/pull/658#discussion_r421856764", "bodyText": "Just added that.", "author": "ryzhyk", "createdAt": "2020-05-07T23:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MjM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0Mjc4Mw==", "url": "https://github.com/vmware/differential-datalog/pull/658#discussion_r421842783", "bodyText": "if the previous annotation was obscure, this one is doubly obscure.\nMaybe once this API stabilizes we can wrap it into something that looks nicer for the user.", "author": "mbudiu-vmw", "createdAt": "2020-05-07T23:03:28Z", "path": "lib/json.dl", "diffHunk": "@@ -20,7 +20,7 @@ extern function to_json_string(x: 'T): Result<string, string>\n \n /* Represents any valid JSON value.\n  */\n-#[rust=\"serde(from = \\\"serde_json::value::Value\\\", into = \\\"serde_json::value::Value\\\")\"]\n+#[rust=\"serde(from = \\\"__json::ValueWrapper\\\", into = \\\"__json::ValueWrapper\\\")\"]", "originalCommit": "4f17aaa8d062cbf62d55bf45554f764b53ad265a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1Njc5NQ==", "url": "https://github.com/vmware/differential-datalog/pull/658#discussion_r421856795", "bodyText": "Fortunately, this is internal to the library, users don't need to understand the annotations.", "author": "ryzhyk", "createdAt": "2020-05-07T23:46:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0Mjc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0NDQxNw==", "url": "https://github.com/vmware/differential-datalog/pull/658#discussion_r421844417", "bodyText": "it is not useful to have this documentation just in the code, you have to surface it to the users as well.\nthere should be a section on annotations in the reference document?", "author": "mbudiu-vmw", "createdAt": "2020-05-07T23:08:48Z", "path": "src/Language/DifferentialDatalog/Attribute.hs", "diffHunk": "@@ -127,6 +134,23 @@ tdefCheckSizeAttr d TypeDef{..} =\n          [Attribute{..}] -> err d attrPos $ \"Invalid 'size' attribute: size must be an integer between 0 and \" ++ show (maxBound::Int)\n          _                    -> err d tdefPos $ \"Multiple 'size' attributes are not allowed\"\n \n+{- 'custom_serde' attribute: Tells DDlog not to generate `Serialize` and", "originalCommit": "4f17aaa8d062cbf62d55bf45554f764b53ad265a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1NjkwNw==", "url": "https://github.com/vmware/differential-datalog/pull/658#discussion_r421856907", "bodyText": "There is a section in the tutorial. I'll add the new attribute there.", "author": "ryzhyk", "createdAt": "2020-05-07T23:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0NDQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1NTUwNA==", "url": "https://github.com/vmware/differential-datalog/pull/658#discussion_r421855504", "bodyText": "I don't really understand the connection between JSON, strings, and binary serialization.", "author": "mbudiu-vmw", "createdAt": "2020-05-07T23:42:54Z", "path": "lib/json.dl", "diffHunk": "@@ -164,3 +164,27 @@ typedef JsonNum = // Integer number.  The value must be in the range between the\n                 | // NaN and infinity are not valid JSON values.\n                   // When serializing to JSON, such values will be replaced with 0.\n                   JsonFloat{d: double}\n+\n+/* Wrapper type that serializes its inner object into binary formats via JSON string.", "originalCommit": "a80c72ff8471dc299436fec621b24ccc6321400b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "64db2dc34532652bc763dbdd30bc3434c0edee49", "url": "https://github.com/vmware/differential-datalog/commit/64db2dc34532652bc763dbdd30bc3434c0edee49", "message": "json.dl: JsonWrapper to transcode JSON to binary data.\n\nThis is a workaround for a `serde` limitation that prevents certain data types from\nbeing serialized or deserialized from non-self-describing data formats like bincode.\nIn particular, this is the case for data types annotated with JSON-related serde\nattributes like `tag` and `flatten`.  In practice this means that types annotated for\nserialization to JSON cannot be serialized to other formats.\n\nThe workaround is to use different serialization logic when serializing to binary and\nnon-binary formats.  In the binary case, we want to serialize such types into a string\nand then serialize the string as a field in binary data.  In the non-binary case, we\nstick to normal serde behavior.  `JsonWrapper` type implements this choice by checking\nthe `is_human_readable` property of the serializer.\n\nThe current implementation has an important flaw: serde currently does not provide a\nreliable way to determine if a serializer supports self-describing data.  We use\n`is_human_readable` attribute as an approximation, which is not always correct: binary\nformats can be self-describing (BSON, Pickle), conversely not all human-readable formats\nare self-describing.  Nevertheless, the current design enables useful scenarios, like\ntranscoding JSON to bincode.\n\nImplementing `JsonWrapper` required a new attribute `#[custom_serde]`\nthat tells DDlog not to derive default `Serialize`/`Deserialize`\nimplementations for a type.", "committedDate": "2020-05-08T01:10:43Z", "type": "commit"}, {"oid": "64db2dc34532652bc763dbdd30bc3434c0edee49", "url": "https://github.com/vmware/differential-datalog/commit/64db2dc34532652bc763dbdd30bc3434c0edee49", "message": "json.dl: JsonWrapper to transcode JSON to binary data.\n\nThis is a workaround for a `serde` limitation that prevents certain data types from\nbeing serialized or deserialized from non-self-describing data formats like bincode.\nIn particular, this is the case for data types annotated with JSON-related serde\nattributes like `tag` and `flatten`.  In practice this means that types annotated for\nserialization to JSON cannot be serialized to other formats.\n\nThe workaround is to use different serialization logic when serializing to binary and\nnon-binary formats.  In the binary case, we want to serialize such types into a string\nand then serialize the string as a field in binary data.  In the non-binary case, we\nstick to normal serde behavior.  `JsonWrapper` type implements this choice by checking\nthe `is_human_readable` property of the serializer.\n\nThe current implementation has an important flaw: serde currently does not provide a\nreliable way to determine if a serializer supports self-describing data.  We use\n`is_human_readable` attribute as an approximation, which is not always correct: binary\nformats can be self-describing (BSON, Pickle), conversely not all human-readable formats\nare self-describing.  Nevertheless, the current design enables useful scenarios, like\ntranscoding JSON to bincode.\n\nImplementing `JsonWrapper` required a new attribute `#[custom_serde]`\nthat tells DDlog not to derive default `Serialize`/`Deserialize`\nimplementations for a type.", "committedDate": "2020-05-08T01:10:43Z", "type": "forcePushed"}]}