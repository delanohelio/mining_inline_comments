{"pr_number": 778, "pr_title": "Bug fix + documentation", "pr_createdAt": "2020-10-19T07:43:08Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/778", "timeline": [{"oid": "2f7e4fbea78cb1e12553f1426711eda425799e32", "url": "https://github.com/vmware/differential-datalog/commit/2f7e4fbea78cb1e12553f1426711eda425799e32", "message": "ddval.rs: Bug in DDValue::mutate().\n\nThis fixes a completely broken implementation of the `mofify` command.\n\nDescription of the bug:\n\n- DDValue is the type-erased representation of any DDlog value that\n  internally wraps the actual typed value in `Arc` and uses virtual\n  dispatch tables to forward various standard trait implementations to\n  the concrete type.\n\n- Cloning a DDValue increments the reference count without actually\n  copying the inner value.\n\n- The `from_ddvalue_ref_mut` method, generated by a Rust macro for each\n  type wrapped in DDValue extracted a writable reference to the\n  inner value from DDValue.  It did so in a completely unsafe way,\n  without enforcing unique ownership.\n\n- Fortunately, the only user of this broken method was the `Mutator`\n  implementation for DDValue.  Instead of mutating a new clone of the\n  inner value, it mutated the original value, thus altering all existing\n  clones.  This, in turn, broke the implementation of the\n  `Update::Modify` command that cloned the old value before modifying\n  the original in order to then issue a pair of delete old, insert\n  new commands.\n\nFix:\n\n- Create a clone of the inner value an wrap it in a new DDValue before\n  mutating it.\n\n- Remove the fundamentally broken `from_ddvalue_ref_mut` method.", "committedDate": "2020-10-19T07:36:51Z", "type": "commit"}, {"oid": "e059c904cf14c03bd1be3f57c91b2d25e0f7cfbb", "url": "https://github.com/vmware/differential-datalog/commit/e059c904cf14c03bd1be3f57c91b2d25e0f7cfbb", "message": "README.md: Typo.", "committedDate": "2020-10-19T07:37:03Z", "type": "commit"}, {"oid": "4df18057c3e04abab3f7855505185b70d435e2e8", "url": "https://github.com/vmware/differential-datalog/commit/4df18057c3e04abab3f7855505185b70d435e2e8", "message": "Disable three souffle tests.", "committedDate": "2020-10-19T07:37:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNzg1MQ==", "url": "https://github.com/vmware/differential-datalog/pull/778#discussion_r507917851", "bodyText": "this is perhaps interesting, but I find this API asymmetric: people will expect that the same thing happens on outputs, You should indicate that this is not the case.", "author": "mbudiu-vmw", "createdAt": "2020-10-19T17:13:25Z", "path": "doc/command_reference/command_reference.md", "diffHunk": "@@ -41,6 +41,82 @@ once the full list of updates has been read (end of list is indicated by a semic\n significantly more efficient and should always be the preferred option when the client wants to apply\n multiple updates that are known at the same time.\n \n+## `modify` command\n+\n+The `modify` command\n+\n+```\n+modify <relation> <key> <- <record>\n+```\n+\n+modifies the value associated with primary key `<key>` in `<relation>`.  It is", "originalCommit": "2ec69ecf243ded1955ab89dbad214e278298546b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxODEyMw==", "url": "https://github.com/vmware/differential-datalog/pull/778#discussion_r507918123", "bodyText": "typo", "author": "mbudiu-vmw", "createdAt": "2020-10-19T17:13:52Z", "path": "doc/command_reference/command_reference.md", "diffHunk": "@@ -41,6 +41,82 @@ once the full list of updates has been read (end of list is indicated by a semic\n significantly more efficient and should always be the preferred option when the client wants to apply\n multiple updates that are known at the same time.\n \n+## `modify` command\n+\n+The `modify` command\n+\n+```\n+modify <relation> <key> <- <record>\n+```\n+\n+modifies the value associated with primary key `<key>` in `<relation>`.  It is\n+only applicabe to input relations declared with the `primary key` attribute.", "originalCommit": "2ec69ecf243ded1955ab89dbad214e278298546b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyMDc2MQ==", "url": "https://github.com/vmware/differential-datalog/pull/778#discussion_r507920761", "bodyText": "I guess these are mine.", "author": "mbudiu-vmw", "createdAt": "2020-10-19T17:18:17Z", "path": "test/run-souffle-tests.py", "diffHunk": "@@ -98,7 +99,9 @@\n     \"sort\",             # 202\n     \"tak\",              # 197\n     \"tic-tac-toe\",      # 197\n-    \"weighted_distances\" # 197\n+    \"weighted_distances\", # 197", "originalCommit": "2ec69ecf243ded1955ab89dbad214e278298546b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cb3df7561d285a198514201d142924f194bf2da6", "url": "https://github.com/vmware/differential-datalog/commit/cb3df7561d285a198514201d142924f194bf2da6", "message": "command_reference: Document `modify` command.\n\nUnlike `insert`, `delete`, etc., the `modify` command has non-trivial\nsemantics.  Document this semantics in the command language reference.", "committedDate": "2020-10-20T03:05:27Z", "type": "commit"}, {"oid": "cb3df7561d285a198514201d142924f194bf2da6", "url": "https://github.com/vmware/differential-datalog/commit/cb3df7561d285a198514201d142924f194bf2da6", "message": "command_reference: Document `modify` command.\n\nUnlike `insert`, `delete`, etc., the `modify` command has non-trivial\nsemantics.  Document this semantics in the command language reference.", "committedDate": "2020-10-20T03:05:27Z", "type": "forcePushed"}]}