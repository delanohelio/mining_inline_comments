{"pr_number": 545, "pr_title": "Support for floating points", "pr_createdAt": "2020-03-05T20:25:40Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/545", "timeline": [{"oid": "5aab3b3f1617bc12a25f2eaf154e0cffea277f51", "url": "https://github.com/vmware/differential-datalog/commit/5aab3b3f1617bc12a25f2eaf154e0cffea277f51", "message": "Support for FP; WIP", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "21a89fabf694ab54ebebfdd2417eeffa5aa203a1", "url": "https://github.com/vmware/differential-datalog/commit/21a89fabf694ab54ebebfdd2417eeffa5aa203a1", "message": "Support for double and float; still WIP", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "97ce730b500be28516304c8f47e6ed8f7eb7b1c9", "url": "https://github.com/vmware/differential-datalog/commit/97ce730b500be28516304c8f47e6ed8f7eb7b1c9", "message": "fmt", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "72fa31e6c685fcb5885b035203eb53a0d55d9979", "url": "https://github.com/vmware/differential-datalog/commit/72fa31e6c685fcb5885b035203eb53a0d55d9979", "message": "Tests for floating point support", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "9fba16bc93485632db94c9f5c3ef18600cc9cb70", "url": "https://github.com/vmware/differential-datalog/commit/9fba16bc93485632db94c9f5c3ef18600cc9cb70", "message": "fix typo", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "7df99e5dd1dd47f990242d97322433adf5876b7a", "url": "https://github.com/vmware/differential-datalog/commit/7df99e5dd1dd47f990242d97322433adf5876b7a", "message": "pretty print", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "0d88a27b5ce1a9b2ff1286558fe92c51e22cd790", "url": "https://github.com/vmware/differential-datalog/commit/0d88a27b5ce1a9b2ff1286558fe92c51e22cd790", "message": "pretty print", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "5838f5bcbf63be9edf784e5d8f971939782979b4", "url": "https://github.com/vmware/differential-datalog/commit/5838f5bcbf63be9edf784e5d8f971939782979b4", "message": "fix pretty-printing of fp values", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "d488cf43b2e2d81deb34f48199ec146c320b2387", "url": "https://github.com/vmware/differential-datalog/commit/d488cf43b2e2d81deb34f48199ec146c320b2387", "message": "Java API support for doubles", "committedDate": "2020-03-05T01:25:42Z", "type": "commit"}, {"oid": "f3145d52c096a8759e6e87a85894f6d761227403", "url": "https://github.com/vmware/differential-datalog/commit/f3145d52c096a8759e6e87a85894f6d761227403", "message": "Address review comments", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "90906834946a3d9d3f6787f97398e9dee201b1c6", "url": "https://github.com/vmware/differential-datalog/commit/90906834946a3d9d3f6787f97398e9dee201b1c6", "message": "clippy fixes", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "b8d3fffaadaf99aacfb164666714c1438f43ed0b", "url": "https://github.com/vmware/differential-datalog/commit/b8d3fffaadaf99aacfb164666714c1438f43ed0b", "message": "more clippy", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "b6d88c32687aab0b15021a3b62ec565724d0c672", "url": "https://github.com/vmware/differential-datalog/commit/b6d88c32687aab0b15021a3b62ec565724d0c672", "message": "more clippy", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "ebe7099426d5d37776ad0df8ff5db43faa451774", "url": "https://github.com/vmware/differential-datalog/commit/ebe7099426d5d37776ad0df8ff5db43faa451774", "message": "more clippy", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "8a1539117276a150db5ec4d3e6263dc92ea6c3ef", "url": "https://github.com/vmware/differential-datalog/commit/8a1539117276a150db5ec4d3e6263dc92ea6c3ef", "message": "Duplicate Rust dependency", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "00380688973efd41bc184741c59766071832fd2f", "url": "https://github.com/vmware/differential-datalog/commit/00380688973efd41bc184741c59766071832fd2f", "message": "Fix failing tests", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "ba9bb72547bc579e982d0909aa35556284ea9c84", "url": "https://github.com/vmware/differential-datalog/commit/ba9bb72547bc579e982d0909aa35556284ea9c84", "message": "Parse floating point literals without size prefix.\n\nParse floating point literals like `0.5` and `5e-1`.", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "63afa5d458fc8939e3748a1c88c404748a22ac25", "url": "https://github.com/vmware/differential-datalog/commit/63afa5d458fc8939e3748a1c88c404748a22ac25", "message": "fixup", "committedDate": "2020-03-05T01:25:43Z", "type": "commit"}, {"oid": "a7f2552b946d0e6f4a06ab13d8a2c3f8c4d8d75c", "url": "https://github.com/vmware/differential-datalog/commit/a7f2552b946d0e6f4a06ab13d8a2c3f8c4d8d75c", "message": "Parse Record::Double.\n\n- Parse `Record::Double`\n- Added missing Java APIs\n- Removed `Record::Float`", "committedDate": "2020-03-05T01:26:58Z", "type": "commit"}, {"oid": "c3861a0343373ac825a2ce3dd8631ee300dde677", "url": "https://github.com/vmware/differential-datalog/commit/c3861a0343373ac825a2ce3dd8631ee300dde677", "message": "Bring Record::Float back.", "committedDate": "2020-03-05T17:38:16Z", "type": "commit"}, {"oid": "52c2b9c5a67c4b761a8a81ad62a163ad71f20084", "url": "https://github.com/vmware/differential-datalog/commit/52c2b9c5a67c4b761a8a81ad62a163ad71f20084", "message": "Java: Test double and float record API.", "committedDate": "2020-03-05T18:10:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU3OTg3Mw==", "url": "https://github.com/vmware/differential-datalog/pull/545#discussion_r388579873", "bodyText": "I don't like this.\nPerhaps JSON null would be a better choice.", "author": "mbudiu-vmw", "createdAt": "2020-03-05T21:36:02Z", "path": "lib/json.dl", "diffHunk": "@@ -40,6 +40,6 @@ typedef JsonNum = // Integer number.  The value must be in the range between the\n                   // inclusive.  Values outside of this range will be truncated\n                   // during serialization.\n                   JsonInt{i: s128}\n-                | // Always finite.\n-                  // TODO.\n-                  JsonFloat\n+                | // NaN and infinity are not valid JSON values.", "originalCommit": "7096e009e1f59fd593b0458085d251ab9cf2fdb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyNzQxMA==", "url": "https://github.com/vmware/differential-datalog/pull/545#discussion_r388727410", "bodyText": "ok, null it is.", "author": "ryzhyk", "createdAt": "2020-03-06T06:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU3OTg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MDc3NQ==", "url": "https://github.com/vmware/differential-datalog/pull/545#discussion_r388580775", "bodyText": "doubles, no apostrophe.\nyou may want a similar comment for bigint if it isn't there", "author": "mbudiu-vmw", "createdAt": "2020-03-05T21:37:51Z", "path": "rust/template/cmd_parser/parse.rs", "diffHunk": "@@ -563,6 +564,70 @@ fn test_struct() {\n                                                                     (Cow::from(\"sfield\"), Record::String(\"foo\\nbar\".to_string()))]))]))));\n }\n \n+// nom's implementation mof `recognize_float` accepts integer literals\n+// like `5`, making it impossible for the parser to distinguish between\n+// floats and integers.  The following is a strict version of `recognize_float`\n+// that only accepts literals containing `.`, e.g., `0.5` or `e|E`, e.g.,\n+// `5e-1`.\n+named!(recognize_float<&[u8], &[u8]>,\n+  recognize!(\n+    do_parse!(\n+      opt!(alt!(char!('+') | char!('-'))) >>\n+      alt!(\n+          do_parse!(digit >>\n+                    alt!( value!((),tuple!(char!('.'), opt!(digit), opt!(recognize_exponent)))\n+                        | recognize_exponent) >>\n+                    (()))\n+        | do_parse!(char!('.') >>\n+                   digit >>\n+                   opt!(recognize_exponent) >>\n+                   (()))) >>\n+      (())\n+    )\n+  )\n+);\n+\n+named!(recognize_exponent<&[u8], ()>,\n+       do_parse!(alt!(char!('e') | char!('E')) >>\n+                 opt!(alt!(char!('+') | char!('-'))) >>\n+                 digit >>\n+                 (()))\n+);\n+\n+// We do not have enough type information to distinguish between floats\n+// and doubles during parsing, so we parse all floating point numbers as\n+// double's and postpone casting them to floats until when they get converted", "originalCommit": "7096e009e1f59fd593b0458085d251ab9cf2fdb6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MDk4Mw==", "url": "https://github.com/vmware/differential-datalog/pull/545#discussion_r388580983", "bodyText": "I wonder what happens on overflow", "author": "mbudiu-vmw", "createdAt": "2020-03-05T21:38:14Z", "path": "rust/template/cmd_parser/parse.rs", "diffHunk": "@@ -563,6 +564,70 @@ fn test_struct() {\n                                                                     (Cow::from(\"sfield\"), Record::String(\"foo\\nbar\".to_string()))]))]))));\n }\n \n+// nom's implementation mof `recognize_float` accepts integer literals\n+// like `5`, making it impossible for the parser to distinguish between\n+// floats and integers.  The following is a strict version of `recognize_float`\n+// that only accepts literals containing `.`, e.g., `0.5` or `e|E`, e.g.,\n+// `5e-1`.\n+named!(recognize_float<&[u8], &[u8]>,\n+  recognize!(\n+    do_parse!(\n+      opt!(alt!(char!('+') | char!('-'))) >>\n+      alt!(\n+          do_parse!(digit >>\n+                    alt!( value!((),tuple!(char!('.'), opt!(digit), opt!(recognize_exponent)))\n+                        | recognize_exponent) >>\n+                    (()))\n+        | do_parse!(char!('.') >>\n+                   digit >>\n+                   opt!(recognize_exponent) >>\n+                   (()))) >>\n+      (())\n+    )\n+  )\n+);\n+\n+named!(recognize_exponent<&[u8], ()>,\n+       do_parse!(alt!(char!('e') | char!('E')) >>\n+                 opt!(alt!(char!('+') | char!('-'))) >>\n+                 digit >>\n+                 (()))\n+);\n+\n+// We do not have enough type information to distinguish between floats\n+// and doubles during parsing, so we parse all floating point numbers as\n+// double's and postpone casting them to floats until when they get converted\n+// into concrete types.\n+named!(float_val<&[u8], Record>,\n+       do_parse!(val: flat_map!(recognize_float, parse_to!(f64)) >>", "originalCommit": "7096e009e1f59fd593b0458085d251ab9cf2fdb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyNTk1Ng==", "url": "https://github.com/vmware/differential-datalog/pull/545#discussion_r388725956", "bodyText": "It will be rounded up to infinity", "author": "ryzhyk", "createdAt": "2020-03-06T06:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MDk4Mw=="}], "type": "inlineReview"}, {"oid": "6479d39e3c8f0ccd56c2d68cf427eafd078fcbb8", "url": "https://github.com/vmware/differential-datalog/commit/6479d39e3c8f0ccd56c2d68cf427eafd078fcbb8", "message": "Add floats support to json.dl", "committedDate": "2020-03-06T06:16:00Z", "type": "commit"}, {"oid": "944e2eedd722600c091a3ffa6cd3a35dc5451066", "url": "https://github.com/vmware/differential-datalog/commit/944e2eedd722600c091a3ffa6cd3a35dc5451066", "message": ".gitlab-ci.yml: move test-simple to private runner.", "committedDate": "2020-03-06T06:16:00Z", "type": "commit"}, {"oid": "944e2eedd722600c091a3ffa6cd3a35dc5451066", "url": "https://github.com/vmware/differential-datalog/commit/944e2eedd722600c091a3ffa6cd3a35dc5451066", "message": ".gitlab-ci.yml: move test-simple to private runner.", "committedDate": "2020-03-06T06:16:00Z", "type": "forcePushed"}]}