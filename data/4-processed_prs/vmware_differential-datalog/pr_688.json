{"pr_number": 688, "pr_title": "Dump output of intermediate compiler passes.", "pr_createdAt": "2020-06-19T20:12:45Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/688", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNjc2Ng==", "url": "https://github.com/vmware/differential-datalog/pull/688#discussion_r443026766", "bodyText": "The ast suffix does not really make sense. I think you should use the dl suffix, then syntax highlighting tools will work properly.", "author": "mbudiu-vmw", "createdAt": "2020-06-19T20:16:30Z", "path": "app/Main.hs", "diffHunk": "@@ -169,22 +145,24 @@ parseValidate Config{..} = do\n     d''' <- case confOutputInput of\n          \"\" -> return d''\n          x  ->  return $ progMirrorInputRelations d'' x\n+    when confDumpFlat $\n+        writeFile (replaceExtension confDatalogFile \".flat.ast\") (show d''')", "originalCommit": "fc02df6c885f0b43d0cddc82555b8ebe20f6c282", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyODY0NA==", "url": "https://github.com/vmware/differential-datalog/pull/688#discussion_r443028644", "bodyText": "I thought about this, but unfortunately this is not valid DDlog code, as it includes flattened names containing dots.", "author": "ryzhyk", "createdAt": "2020-06-19T20:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNjc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzMwOQ==", "url": "https://github.com/vmware/differential-datalog/pull/688#discussion_r443027309", "bodyText": "could the indentation be changed here?", "author": "mbudiu-vmw", "createdAt": "2020-06-19T20:18:07Z", "path": "test/datalog_tests/lib_test.debug.ast.expected", "diffHunk": "@@ -0,0 +1,1053 @@\n+typedef fp_test.BB = fp_test.BB{s: string, b: bool}\n+typedef fp_test.D = fp_test.D{s: string, d: double}\n+typedef fp_test.DoublesFromRecord = fp_test.DoublesFromRecord{s: string, d: double}\n+typedef fp_test.F = fp_test.F{s: string, d: float}\n+typedef fp_test.FloatsFromRecord = fp_test.FloatsFromRecord{s: string, f: float}\n+#[size = 8]\n+#[shared_ref = true]\n+extern type internment.Intern<'A>\n+typedef internment.istring = internment.Intern<string>\n+typedef internment_test.AllInternedString = internment_test.AllInternedString{ix: internment.istring}\n+typedef internment_test.IInternedString = internment_test.IInternedString{ix: internment.istring}\n+typedef internment_test.IStruct = internment_test.IStruct{u: internment.Intern<internment_test.IUnion>, t: internment.Intern<(std.s32, double)>, x: bigint}\n+typedef internment_test.IUnion = internment_test.Tag1{f1: bool} | internment_test.Tag2{f2: std.u32, f3: string}\n+typedef internment_test.OInternedString = internment_test.OInternedString{x: string, ix: internment.istring}\n+typedef internment_test.Projections = internment_test.Projections{inp: internment_test.IStruct, p: string}\n+typedef internment_test.StaticInternedString = internment_test.StaticInternedString{ix: internment.istring}\n+typedef json.JsonNum = json.JsonInt{i: std.s128} | json.JsonFloat{d: double}\n+#[rust = \"serde(from = \\\"__json::ValueWrapper\\\", into = \\\"__json::ValueWrapper\\\")\"]\n+typedef json.JsonValue = json.JsonNull{} | json.JsonBool{b: bool} | json.JsonNumber{n: json.JsonNum} | json.JsonString{s: internment.istring} | json.JsonArray{a: std.Vec<json.JsonValue>} | json.JsonObject{o: std.Map<internment.istring,json.JsonValue>}\n+#[custom_serde = true]\n+typedef json.JsonWrapper<'T> = json.JsonWrapper{x: 'T}\n+typedef json_test.Array = std.Vec<json_test.BoolStruct>\n+typedef json_test.BoolMap = std.Map<string,json_test.BoolStruct>\n+typedef json_test.BoolStruct = json_test.BoolStruct{b: bool}\n+typedef json_test.Enum = #[rust = \"serde(rename = \\\"Variant1\\\")\"]\n+                         json_test.Variant1{b: bool} | #[rust = \"serde(rename = \\\"Variant2\\\")\"]", "originalCommit": "fc02df6c885f0b43d0cddc82555b8ebe20f6c282", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyOTEzMw==", "url": "https://github.com/vmware/differential-datalog/pull/688#discussion_r443029133", "bodyText": "Yeah, looks terrible.", "author": "ryzhyk", "createdAt": "2020-06-19T20:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzMwOQ=="}], "type": "inlineReview"}, {"oid": "83c44feaa94baac9f2deceea739cd97f1811d753", "url": "https://github.com/vmware/differential-datalog/commit/83c44feaa94baac9f2deceea739cd97f1811d753", "message": "Syntax.hs: Better pretty-printing of structs.\n\nThis looked bad:\n\n```\ntypedef json_test.Enum = #[rust = \"serde(rename = \\\"Variant1\\\")\"]\n                         json_test.Variant1{b: bool} | #[rust = \"serde(rename = \\\"Variant2\\\")\"]\n                                                        json_test.Variant2{u: std.u32}\n```\n\nNew formatting:\n\n```\ntypedef json_test.Enum = #[rust = \"serde(rename = \\\"Variant1\\\")\"]\n                         json_test.Variant1{b: bool} |\n                         #[rust = \"serde(rename = \\\"Variant2\\\")\"]\n                         json_test.Variant2{u: std.u32}\n```", "committedDate": "2020-06-19T20:55:43Z", "type": "forcePushed"}, {"oid": "2cf732775ffbbc55433d54edfe01059c028c3eeb", "url": "https://github.com/vmware/differential-datalog/commit/2cf732775ffbbc55433d54edfe01059c028c3eeb", "message": "Syntax.hs: Better pretty-printing of structs.\n\nThis looked bad:\n\n```\ntypedef json_test.Enum = #[rust = \"serde(rename = \\\"Variant1\\\")\"]\n                         json_test.Variant1{b: bool} | #[rust = \"serde(rename = \\\"Variant2\\\")\"]\n                                                        json_test.Variant2{u: std.u32}\n```\n\nNew formatting:\n\n```\ntypedef json_test.Enum = #[rust = \"serde(rename = \\\"Variant1\\\")\"]\n                         json_test.Variant1{b: bool} |\n                         #[rust = \"serde(rename = \\\"Variant2\\\")\"]\n                         json_test.Variant2{u: std.u32}\n```", "committedDate": "2020-06-19T21:20:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA1MjU4NA==", "url": "https://github.com/vmware/differential-datalog/pull/688#discussion_r443052584", "bodyText": "Should we add check to only dump when confDebugHooks is enabled?\nOr maybe update help message that if pp-debug is passed without \"-g\" then this will dump the source but no debug hooks?", "author": "haroldlim", "createdAt": "2020-06-19T21:35:23Z", "path": "app/Main.hs", "diffHunk": "@@ -169,22 +145,24 @@ parseValidate Config{..} = do\n     d''' <- case confOutputInput of\n          \"\" -> return d''\n          x  ->  return $ progMirrorInputRelations d'' x\n+    when confDumpFlat $\n+        writeFile (replaceExtension confDatalogFile \".flat.ast\") (show d''')\n     d'''' <- case validate d''' of\n                Left e   -> errorWithoutStackTrace $ \"error: \" ++ e\n                Right d'''' -> return d''''\n+    when confDumpValid $\n+        writeFile (replaceExtension confDatalogFile \".valid.ast\") (show d'''')\n     d' <- case confDebugHooks of\n          False -> return d''''\n          True  -> return $ progInjectDebuggingHooks d''''\n+    when confDumpDebug $\n+        writeFile (replaceExtension confDatalogFile \".debug.ast\") (show d')", "originalCommit": "2cf732775ffbbc55433d54edfe01059c028c3eeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA1NDI4Ng==", "url": "https://github.com/vmware/differential-datalog/pull/688#discussion_r443054286", "bodyText": "Yeah, I was being lazy there. Let's go with the second approach, as it is more permissive, i.e., works better with automation.", "author": "ryzhyk", "createdAt": "2020-06-19T21:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA1MjU4NA=="}], "type": "inlineReview"}, {"oid": "3f0c690914f0b97027c13368ae92f2fdca41774b", "url": "https://github.com/vmware/differential-datalog/commit/3f0c690914f0b97027c13368ae92f2fdca41774b", "message": "test-libs.sh: Output the detailed diff on error.\n\nTo simplify troubleshooting of CI failures.", "committedDate": "2020-06-20T01:26:07Z", "type": "forcePushed"}, {"oid": "00c0d92222749baf904bd8232007434a21ad79c4", "url": "https://github.com/vmware/differential-datalog/commit/00c0d92222749baf904bd8232007434a21ad79c4", "message": "Dump output of intermediate compiler passes.\n\nAdd CLI flags to dump transformed DDlog code after each compiler pass:\n- flattening\n- validation\n- debugging hook injection\n- optimization", "committedDate": "2020-06-20T05:44:50Z", "type": "commit"}, {"oid": "e541985cbad23428d0792f245e1ca6131b75fe9b", "url": "https://github.com/vmware/differential-datalog/commit/e541985cbad23428d0792f245e1ca6131b75fe9b", "message": "run-test.sh: Validate intermediate ASTs.\n\nExtend `run-test.sh` to dump intermediate DDlog ASTs using newly added\ncompiler flags and to compare them against reference outputs if\navailable.  Use this feature to validate debugging hooks in\n`simple`, `simple2`, and `tutorial` tests.", "committedDate": "2020-06-20T05:44:50Z", "type": "commit"}, {"oid": "6aedb4d264ab992a3ee1debaace4f97733ec87ce", "url": "https://github.com/vmware/differential-datalog/commit/6aedb4d264ab992a3ee1debaace4f97733ec87ce", "message": "Debug.hs: Bindings must be valid identifiers.\n\nThe 'addBindingToRHSLiteral' function generated binding variable name\nfrom relation name.  In a multi-module program, relation name can\ncontain \".\"'s.  Use `Compile.rname` to convert such qualified names to\nvalid Rust identifiers.", "committedDate": "2020-06-20T05:44:50Z", "type": "commit"}, {"oid": "779f765a20d68885424dbfa38130cd596958e0c5", "url": "https://github.com/vmware/differential-datalog/commit/779f765a20d68885424dbfa38130cd596958e0c5", "message": "Syntax.hs: Better pretty-printing of structs.\n\nThis looked bad:\n\n```\ntypedef json_test.Enum = #[rust = \"serde(rename = \\\"Variant1\\\")\"]\n                         json_test.Variant1{b: bool} | #[rust = \"serde(rename = \\\"Variant2\\\")\"]\n                                                        json_test.Variant2{u: std.u32}\n```\n\nNew formatting:\n\n```\ntypedef json_test.Enum = #[rust = \"serde(rename = \\\"Variant1\\\")\"]\n                         json_test.Variant1{b: bool} |\n                         #[rust = \"serde(rename = \\\"Variant2\\\")\"]\n                         json_test.Variant2{u: std.u32}\n```", "committedDate": "2020-06-20T05:44:50Z", "type": "commit"}, {"oid": "80ad08576e01b2cffaf15d48ed1ad6aa519be5a1", "url": "https://github.com/vmware/differential-datalog/commit/80ad08576e01b2cffaf15d48ed1ad6aa519be5a1", "message": "test-libs.sh: Output the detailed diff on error.\n\nTo simplify troubleshooting of CI failures.", "committedDate": "2020-06-20T05:44:50Z", "type": "commit"}, {"oid": "f3e40ed51972283d5b621965cb9ad60343b8b8c0", "url": "https://github.com/vmware/differential-datalog/commit/f3e40ed51972283d5b621965cb9ad60343b8b8c0", "message": "internment_test.dl: Make the test deterministic.\n\nEliminate interned values from output relations to make sure that they\nare output in a deterministic order.", "committedDate": "2020-06-20T05:44:50Z", "type": "commit"}, {"oid": "f3e40ed51972283d5b621965cb9ad60343b8b8c0", "url": "https://github.com/vmware/differential-datalog/commit/f3e40ed51972283d5b621965cb9ad60343b8b8c0", "message": "internment_test.dl: Make the test deterministic.\n\nEliminate interned values from output relations to make sure that they\nare output in a deterministic order.", "committedDate": "2020-06-20T05:44:50Z", "type": "forcePushed"}]}