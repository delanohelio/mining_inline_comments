{"pr_number": 835, "pr_title": "Removed some of the allocations in running programs", "pr_createdAt": "2020-12-01T23:22:30Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/835", "timeline": [{"oid": "da69fc29349860df3607d8f100120e3841a0ed48", "url": "https://github.com/vmware/differential-datalog/commit/da69fc29349860df3607d8f100120e3841a0ed48", "message": "Minimized some of the allocations in running programs", "committedDate": "2020-12-01T23:21:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MTU3OQ==", "url": "https://github.com/vmware/differential-datalog/pull/835#discussion_r538971579", "bodyText": "This is where this PR breaks things.  The original version takes a slice and traverses it multiple times.  The new version takes iterator.  It exhausts the iterator in the first loop, so subsequent call to rels.all always returns true, so filter does nothing.", "author": "ryzhyk", "createdAt": "2020-12-09T03:09:29Z", "path": "rust/template/differential_datalog/program/mod.rs", "diffHunk": "@@ -1595,39 +1601,41 @@ impl Program {\n     }\n \n     /// Returns all input relations of the program\n-    fn input_relations(&self) -> Vec<RelId> {\n-        self.nodes\n-            .iter()\n-            .flat_map(|node| match node {\n-                ProgNode::Rel { rel: r } => {\n-                    if r.input {\n-                        vec![r.id]\n-                    } else {\n-                        vec![]\n-                    }\n+    fn input_relations<'a>(&'a self) -> impl Iterator<Item = RelId> + 'a {\n+        self.nodes.iter().filter_map(|node| match node {\n+            ProgNode::Rel { rel: r } => {\n+                if r.input {\n+                    Some(r.id)\n+                } else {\n+                    None\n                 }\n-                ProgNode::Apply { .. } => vec![],\n-                ProgNode::SCC { rels: rs } => {\n-                    for r in rs {\n-                        assert!(!r.rel.input, \"input relation ({}) in SCC\", r.rel.name);\n-                    }\n-                    vec![]\n+            }\n+            ProgNode::Apply { .. } => None,\n+            ProgNode::SCC { rels: rs } => {\n+                for r in rs {\n+                    assert!(!r.rel.input, \"input relation ({}) in SCC\", r.rel.name);\n                 }\n-            })\n-            .collect()\n+\n+                None\n+            }\n+        })\n     }\n \n     /// Return all relations required to compute rels, excluding recursive dependencies on rels\n-    fn dependencies(rels: &[&Relation]) -> FnvHashSet<Dep> {\n+    fn dependencies<'a, R>(mut rels: R) -> FnvHashSet<Dep>", "originalCommit": "da69fc29349860df3607d8f100120e3841a0ed48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ0MDcxNw==", "url": "https://github.com/vmware/differential-datalog/pull/835#discussion_r539440717", "bodyText": "@Kixiron , let me know if you'll have time to fix this; otherwise I can do it.", "author": "ryzhyk", "createdAt": "2020-12-09T16:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5MTkzNg==", "url": "https://github.com/vmware/differential-datalog/pull/835#discussion_r540691936", "bodyText": "This is not performance-critical code, but your improvements still make things cleaner.\n\nI take it back. It turns out that struct Program can grow huge for large programs due all the strings that are further bloated by type annotations injected by the type checker. I really like this PR now as it avoids cloning this struct. I am going to fix the bug and merge.", "author": "ryzhyk", "createdAt": "2020-12-11T05:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NDU3MQ==", "url": "https://github.com/vmware/differential-datalog/pull/835#discussion_r540694571", "bodyText": "Actually, it's the other PR that does this, and it still copies the program once.", "author": "ryzhyk", "createdAt": "2020-12-11T05:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDcyNTEwMw==", "url": "https://github.com/vmware/differential-datalog/pull/835#discussion_r540725103", "bodyText": "I believe that self: Arc<Self> is valid in stable rust, that would allow not cloning the physical program any", "author": "Kixiron", "createdAt": "2020-12-11T06:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc0Mjk1NA==", "url": "https://github.com/vmware/differential-datalog/pull/835#discussion_r540742954", "bodyText": "Good point. I'll try that too.  I am also going to change types of all strings in Program to Cow<String>, as these are typically static strings, so we don't need to allocate them even once.", "author": "ryzhyk", "createdAt": "2020-12-11T07:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MTU3OQ=="}], "type": "inlineReview"}, {"oid": "628aabde04ca8b431319f38b9f5611ee74254aa0", "url": "https://github.com/vmware/differential-datalog/commit/628aabde04ca8b431319f38b9f5611ee74254aa0", "message": "Bug fix in `Program::dependencies`.\n\nClone the iterator to avoid exhausting it at the first iteration of the\nouter loop.", "committedDate": "2020-12-11T06:19:12Z", "type": "commit"}]}