{"pr_number": 700, "pr_title": "D3log updated realization", "pr_createdAt": "2020-07-14T14:41:10Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/700", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0NDI1Mw==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455144253", "bodyText": "This method can only be safely invoked when there is no transaction in progress (because it starts a transaction internally and we don't support nested transactions). Please change this function to return an error if there is a transaction in progress and also reflect this in the comment.", "author": "ryzhyk", "createdAt": "2020-07-15T15:33:12Z", "path": "rust/template/distributed_datalog/src/accumulate/accumulator.rs", "diffHunk": "@@ -47,6 +47,10 @@ where\n \n     /// Return the current state of the data.\n     fn get_current_state(&self) -> HashMap<RelId, HashSet<V>>;\n+\n+    /// Sends a deletion update to all observers, thus clearing the accumulated state.", "originalCommit": "44d1269d2b008987729bf134e87be7c9234194ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI5Mjk2MQ==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455292961", "bodyText": "I agree. Maybe we should also think of somehow \"registering\" the wish to clear the accumulator so that clear() is called on the next commit() automatically? This way, one can take a source offline while it is still committing updates. Otherwise, you would need to try multiple times to get the correct timing in-between transactions. What do you think @ryzhyk?", "author": "falzberger", "createdAt": "2020-07-15T19:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0NDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI5ODQzNw==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455298437", "bodyText": "I prefer to keep the semantics simple and have the control plane make sure that it does not call the method at the wrong time.  Delayed invocation sounds like a tricky thing to implement and use.", "author": "ryzhyk", "createdAt": "2020-07-15T19:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0NDI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMwMDI4NA==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455300284", "bodyText": "Sure, that's also a valid point. I just think it will also be hard for the control plane to know exactly when an transaction is going on, as observables can call functions on their observers without sending any information about it to the control plane. Nevertheless, I completely agree with you to keep it simple in the first place.", "author": "falzberger", "createdAt": "2020-07-15T19:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0NDI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0ODgyMQ==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455148821", "bodyText": "I think, get_current_state returns a copy of the internal state, i.e., it does not actually clear the accumulator plus introduces the overhead of cloning.  You probably want to add another method to AccumulatingObserver that swaps its internal state with empty set and returns the actual internal state rather than its clone.\nI realize, this code was copied from previous on_completed implementation, so it looks like the problem already existed there. (@sugohugo , do you agree?)", "author": "ryzhyk", "createdAt": "2020-07-15T15:40:14Z", "path": "rust/template/distributed_datalog/src/accumulate/accumulator.rs", "diffHunk": "@@ -98,6 +102,33 @@ where\n         trace!(\"DistributingAccumulator({})::get_current_state()\", self.id);\n         self.observer.get_current_state()\n     }\n+\n+    fn clear(&mut self) {\n+        trace!(\"DistributingAccumulator({})::clear\", self.id);\n+        let mut distributor = self.distributor.lock().unwrap();\n+\n+        let mut delete_updates = self\n+            .get_current_state()", "originalCommit": "44d1269d2b008987729bf134e87be7c9234194ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI3NjAwNw==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455276007", "bodyText": "Actually, in accumulate/observer.rs:166 you still have the old on_completed implementation. When this logic was executed in on_completed previously, it also called the on_completed function in the AccumulatingObserver, thus clearing the internal state of it. So a possible solution would be to also add an implementation of clear() in AccumulatingObserver (which can just be the on_completed that is there now) which needs to be triggered when the accumulator is cleared.", "author": "falzberger", "createdAt": "2020-07-15T19:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0ODgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI3OTE1MQ==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455279151", "bodyText": "Makes sense, although it does seem wasteful to clone the state just to deallocate all it immediately.", "author": "ryzhyk", "createdAt": "2020-07-15T19:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0ODgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMwMTg5Mg==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455301892", "bodyText": "Yes, it is. I think I just did not consider this in the implementation, so the (current) on_completed() implementation in AccumulatingObserver can also just return its current state. I probably was too focused on using the get_current_state() method.", "author": "falzberger", "createdAt": "2020-07-15T19:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0ODgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1Mzk0OQ==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455153949", "bodyText": "Please add a FIXME to eventually find a way to connect the accumulator to receiver.", "author": "ryzhyk", "createdAt": "2020-07-15T15:48:30Z", "path": "rust/template/distributed_datalog/src/instantiate.rs", "diffHunk": "@@ -175,16 +182,18 @@ where\n     let receiver =\n         TcpReceiver::new(addr).map_err(|e| format!(\"failed to create TcpReceiver: {}\", e))?;\n     let receiver = Arc::new(Mutex::new(receiver));\n-    // an empty set indicates the TcpReceiver\n-    let _ = sources.insert(\n-        BTreeSet::new(),\n-        vec![(SourceRealization::Node(receiver.clone()), ())],\n-    );\n-\n-    txnmux\n-        .add_observable(Box::new(receiver))\n-        .map_err(|_| \"failed to register TcpReceiver with TxnMux\".to_string())?;\n-    Ok(())\n+    let accumulator = Arc::new(Mutex::new(DistributingAccumulator::new()));", "originalCommit": "44d1269d2b008987729bf134e87be7c9234194ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI2MTU0Ng==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455261546", "bodyText": "Will do.", "author": "krs85", "createdAt": "2020-07-15T18:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1Mzk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1NDc3OA==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455154778", "bodyText": "Shouldn't this be called add_file_source?", "author": "ryzhyk", "createdAt": "2020-07-15T15:49:53Z", "path": "rust/template/distributed_datalog/src/instantiate.rs", "diffHunk": "@@ -388,6 +372,63 @@ where\n     _sinks: HashMap<BTreeSet<RelId>, Vec<(SinkRealization<P::Convert>, usize)>>,\n }\n \n+impl<P> Realization<P>\n+where\n+    P: Send + DDlog + 'static,\n+    P::Convert: Send + DDlogConvert,\n+{\n+    /// Remove a source from the existing realization.\n+    /// Also clear the accumulator and disconnect\n+    /// from the TxnMux.\n+    pub fn remove_source(&mut self, src: &Source) {\n+        // Remove entry.\n+        let (_, accumulator, id) = self._sources.remove(src).unwrap();\n+        let mut accum_observ = accumulator.lock().unwrap();\n+\n+        // Clear accumulator.\n+        accum_observ.clear();\n+\n+        // Disconnect from TxnMux.\n+        self._txnmux.remove_observable(id);\n+    }\n+\n+    /// Add a source to an existing realization.\n+    pub fn add_source(&mut self, path: &Path) -> Result<(), String> {", "originalCommit": "44d1269d2b008987729bf134e87be7c9234194ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI2MTQ4Mg==", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455261482", "bodyText": "That makes sense to me. I'll change it.", "author": "krs85", "createdAt": "2020-07-15T18:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1NDc3OA=="}], "type": "inlineReview"}, {"oid": "725a517e6c10dd48412812f5107ddc6fdef628a9", "url": "https://github.com/vmware/differential-datalog/commit/725a517e6c10dd48412812f5107ddc6fdef628a9", "message": "Refactor Realization sources structure", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "21d10b975ea9e30687af36225e5584227e5d721f", "url": "https://github.com/vmware/differential-datalog/commit/21d10b975ea9e30687af36225e5584227e5d721f", "message": "No more automatic clearing of accumulator on on_completed(). Functionality moved to clear().", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "d8fdc0cfbe42e0e165777632dfed817aa634e9f1", "url": "https://github.com/vmware/differential-datalog/commit/d8fdc0cfbe42e0e165777632dfed817aa634e9f1", "message": "TxnMux: add_observable() now returns handle, implemented remove_observable()", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "7ba0d3c23184868f5196d0a78e49b5b443aea5f1", "url": "https://github.com/vmware/differential-datalog/commit/7ba0d3c23184868f5196d0a78e49b5b443aea5f1", "message": "implements remove_source() functionality for Realization struct", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "99d92ebde23e8ef7080908500c5788b78ec5f2dd", "url": "https://github.com/vmware/differential-datalog/commit/99d92ebde23e8ef7080908500c5788b78ec5f2dd", "message": "Implements add_source() for Realization, refactors add_file_sources() to use this new function.", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "c1ef957c23726a8c271f0552b480a1684ccbd4ac", "url": "https://github.com/vmware/differential-datalog/commit/c1ef957c23726a8c271f0552b480a1684ccbd4ac", "message": "Updates accumulator unit tests to reflect no more automatic deletions", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "2ed579b9f2e885266d16c6a359d92c60d56b4a18", "url": "https://github.com/vmware/differential-datalog/commit/2ed579b9f2e885266d16c6a359d92c60d56b4a18", "message": "Fixes clippy warning", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "c6c9bd65ded5fb8b260f93ef779e2b01384625c3", "url": "https://github.com/vmware/differential-datalog/commit/c6c9bd65ded5fb8b260f93ef779e2b01384625c3", "message": "Adds fixme for connecting accumulator to receiver, changes add_source() to add_file_source(), converts create_txn_mux() and add_tcp_receiver() from static to member functions on Realization", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "1945c1a469c1295195fa8730dcab73ffcb89893f", "url": "https://github.com/vmware/differential-datalog/commit/1945c1a469c1295195fa8730dcab73ffcb89893f", "message": "modifies accumulator's clear() function to swap internal state with empty set and returns the internal state", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "e0676360382607e60e7fcc56958ba0eae2d2b732", "url": "https://github.com/vmware/differential-datalog/commit/e0676360382607e60e7fcc56958ba0eae2d2b732", "message": "modifies accumulator's clear() to return an err if a transaction is in progress", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "7933d990b04a49a49618a43c71a38ba78e79305c", "url": "https://github.com/vmware/differential-datalog/commit/7933d990b04a49a49618a43c71a38ba78e79305c", "message": "Fix accumulator tests for clear()", "committedDate": "2020-07-22T19:27:57Z", "type": "commit"}, {"oid": "7933d990b04a49a49618a43c71a38ba78e79305c", "url": "https://github.com/vmware/differential-datalog/commit/7933d990b04a49a49618a43c71a38ba78e79305c", "message": "Fix accumulator tests for clear()", "committedDate": "2020-07-22T19:27:57Z", "type": "forcePushed"}]}