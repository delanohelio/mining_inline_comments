{"pr_number": 4144, "pr_title": "feature-NXP-29247-datadog-apm", "pr_createdAt": "2020-06-12T10:52:19Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4144", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM2MjY5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4144#discussion_r439362690", "bodyText": "Is this really needed as a WARN? Some for all other existing reporters actually...", "author": "efge", "createdAt": "2020-06-12T11:24:28Z", "path": "modules/runtime/nuxeo-runtime-metrics/src/main/java/org/nuxeo/runtime/metrics/reporter/DatadogTraceReporter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     bdelbosc\n+ */\n+package org.nuxeo.runtime.metrics.reporter;\n+\n+import java.net.MalformedURLException;\n+import java.util.Set;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.common.utils.DurationUtils;\n+import org.nuxeo.runtime.metrics.AbstractMetricsReporter;\n+\n+import io.dropwizard.metrics5.MetricAttribute;\n+import io.dropwizard.metrics5.MetricFilter;\n+import io.dropwizard.metrics5.MetricRegistry;\n+import io.opencensus.common.Duration;\n+import io.opencensus.exporter.trace.datadog.DatadogTraceConfiguration;\n+import io.opencensus.exporter.trace.datadog.DatadogTraceExporter;\n+\n+/**\n+ * Reports traces to Datadog agent.\n+ *\n+ * @since 11.1\n+ */\n+public class DatadogTraceReporter extends AbstractMetricsReporter {\n+\n+    private static final Logger log = LogManager.getLogger(DatadogTraceReporter.class);\n+\n+    protected static final String TYPE_OPTION = \"type\";\n+\n+    protected static final String DEFAULT_TYPE = \"web\";\n+\n+    protected boolean activated;\n+\n+    @Override\n+    public void start(MetricRegistry registry, MetricFilter filter, Set<MetricAttribute> deniedExpansions) {\n+        log.warn(\"Creating Datadog Trace reporter\");", "originalCommit": "3c4e647481e051956c9f56d57e88545073fd9edf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk5NjEwOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4144#discussion_r439996109", "bodyText": "yes, it should be done at info level with proper log4j2 conf, this will be part of another cleaning PR with the other reporters.", "author": "bdelbosc", "createdAt": "2020-06-15T08:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM2MjY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4MDg1NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4144#discussion_r439380854", "bodyText": "Import it?", "author": "troger", "createdAt": "2020-06-12T12:10:46Z", "path": "modules/runtime/nuxeo-runtime-metrics/src/main/java/org/nuxeo/runtime/metrics/AbstractMetricsReporter.java", "diffHunk": "@@ -28,15 +28,60 @@\n \n import org.nuxeo.runtime.api.Framework;\n \n+import io.opencensus.trace.Tracing;\n+import io.opencensus.trace.config.TraceConfig;\n+import io.opencensus.trace.config.TraceParams;\n+import io.opencensus.trace.samplers.Samplers;\n+\n /**\n  * @since 11.1\n  */\n public abstract class AbstractMetricsReporter implements MetricsReporter {\n \n+    public static final String URL_OPTION = \"url\";\n+\n+    public static final String TIMEOUT_OPTION = \"timeout\";\n+\n+    public static final java.time.Duration DEFAULT_TIMEOUT = java.time.Duration.ofSeconds(10);", "originalCommit": "3c4e647481e051956c9f56d57e88545073fd9edf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4MzA4Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4144#discussion_r439383083", "bodyText": "IllegalStateException maybe? or the IOException is always linked to the port param?", "author": "troger", "createdAt": "2020-06-12T12:16:03Z", "path": "modules/runtime/nuxeo-runtime-metrics/src/main/java/org/nuxeo/runtime/metrics/reporter/PrometheusReporter.java", "diffHunk": "@@ -69,7 +71,7 @@ public void start(MetricRegistry registry, MetricFilter filter, Set<MetricAttrib\n         try {\n             server = new HTTPServer(port, true);\n         } catch (IOException e) {\n-            throw new RuntimeException(\"Cannot start Prometheus on port \" + port, e);\n+            throw new IllegalArgumentException(\"Cannot start Prometheus on port \" + port, e);", "originalCommit": "3c4e647481e051956c9f56d57e88545073fd9edf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAwMDI2NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4144#discussion_r440000265", "bodyText": "Yes, port conflict is the main cause of IOException here.", "author": "bdelbosc", "createdAt": "2020-06-15T08:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM4MzA4Mw=="}], "type": "inlineReview"}, {"oid": "5fc8a9ea5d908a84e69528be54cc0602fc67e339", "url": "https://github.com/nuxeo/nuxeo/commit/5fc8a9ea5d908a84e69528be54cc0602fc67e339", "message": "NXP-29247: Add a Datadog Tracer reporter", "committedDate": "2020-06-15T08:09:04Z", "type": "commit"}, {"oid": "5fc8a9ea5d908a84e69528be54cc0602fc67e339", "url": "https://github.com/nuxeo/nuxeo/commit/5fc8a9ea5d908a84e69528be54cc0602fc67e339", "message": "NXP-29247: Add a Datadog Tracer reporter", "committedDate": "2020-06-15T08:09:04Z", "type": "forcePushed"}]}