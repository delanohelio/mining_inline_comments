{"pr_number": 3804, "pr_title": "10.10-HF/fix-NXP-28560-catch-enrichers-exceptions", "pr_createdAt": "2020-02-28T16:03:58Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3804", "timeline": [{"oid": "62ba3c509c1be77c16ed477af017c13d15a58773", "url": "https://github.com/nuxeo/nuxeo/commit/62ba3c509c1be77c16ed477af017c13d15a58773", "message": "NXP-28560: catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-02T06:40:37Z", "type": "forcePushed"}, {"oid": "0759f0122f59312e16ee1bc555ed32fbb0beea62", "url": "https://github.com/nuxeo/nuxeo/commit/0759f0122f59312e16ee1bc555ed32fbb0beea62", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-02T06:45:48Z", "type": "forcePushed"}, {"oid": "66473ab7cbc6cd98fe8b29b9eb67bfd8e85886cd", "url": "https://github.com/nuxeo/nuxeo/commit/66473ab7cbc6cd98fe8b29b9eb67bfd8e85886cd", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-02T06:48:32Z", "type": "forcePushed"}, {"oid": "7fdb322369dfa4b805ea2ae8d4dbf20a3e644c92", "url": "https://github.com/nuxeo/nuxeo/commit/7fdb322369dfa4b805ea2ae8d4dbf20a3e644c92", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-02T06:49:09Z", "type": "forcePushed"}, {"oid": "c8e5fcd60c923fb71ca854a06708695105e7d854", "url": "https://github.com/nuxeo/nuxeo/commit/c8e5fcd60c923fb71ca854a06708695105e7d854", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-02T06:51:39Z", "type": "forcePushed"}, {"oid": "ce297babe90dce493b971927603e21dcb802d8df", "url": "https://github.com/nuxeo/nuxeo/commit/ce297babe90dce493b971927603e21dcb802d8df", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-02T07:32:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxMjEwOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3804#discussion_r387612108", "bodyText": "Can you try/catch readTree call?", "author": "kevinleturc", "createdAt": "2020-03-04T11:39:40Z", "path": "nuxeo-core/nuxeo-core-io/src/main/java/org/nuxeo/ecm/core/io/marshallers/json/enrichers/AbstractJsonEnricher.java", "diffHunk": "@@ -56,15 +64,30 @@ public final boolean accept(Class<?> clazz, Type genericType, MediaType mediatyp\n \n     @Override\n     public void write(Enriched<EntityType> enrichable, JsonGenerator jg) {\n-        try {\n-            write(jg, enrichable.getEntity());\n+        try (TokenBuffer tb = new TokenBuffer(MAPPER, false)) {\n+            // Write to a temporary output in case of exception during write()\n+            tb.writeStartObject();\n+            write(tb, enrichable.getEntity());\n+            tb.writeEndObject();\n+            tb.flush();\n+            // Add the complete, well-formed content to the real output\n+            try (JsonParser parser = tb.asParser()) {\n+                parser.nextToken(); // ignoring START_OBJECT\n+                while (parser.nextToken() == FIELD_NAME) {\n+                    jg.copyCurrentStructure(parser);\n+                }\n+                if (parser.currentToken() != END_OBJECT) {\n+                    log.error(\"Enricher: {} failed on current token: {}, output to write: {}\", name,\n+                            parser.currentToken(), MAPPER.readTree(tb.asParser()));", "originalCommit": "ce297babe90dce493b971927603e21dcb802d8df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4OTYwMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3804#discussion_r387689602", "bodyText": "added it like so: #3799 (comment)", "author": "NourNuxeo", "createdAt": "2020-03-04T14:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxMjEwOA=="}], "type": "inlineReview"}, {"oid": "9ab000637f7c3fce75739042f705447c5abae363", "url": "https://github.com/nuxeo/nuxeo/commit/9ab000637f7c3fce75739042f705447c5abae363", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-04T14:10:31Z", "type": "forcePushed"}, {"oid": "6cf598fbcafe78538725d9afe119ae742c86fc96", "url": "https://github.com/nuxeo/nuxeo/commit/6cf598fbcafe78538725d9afe119ae742c86fc96", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-04T14:31:18Z", "type": "forcePushed"}, {"oid": "8999677cef4f76be5eb71cc38c185cdc878a6d3e", "url": "https://github.com/nuxeo/nuxeo/commit/8999677cef4f76be5eb71cc38c185cdc878a6d3e", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-04T15:11:03Z", "type": "commit"}, {"oid": "8999677cef4f76be5eb71cc38c185cdc878a6d3e", "url": "https://github.com/nuxeo/nuxeo/commit/8999677cef4f76be5eb71cc38c185cdc878a6d3e", "message": "NXP-28560: fix catch AbstractJsonEnrichers Exception", "committedDate": "2020-03-04T15:11:03Z", "type": "forcePushed"}]}