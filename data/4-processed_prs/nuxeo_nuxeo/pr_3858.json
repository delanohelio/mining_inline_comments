{"pr_number": 3858, "pr_title": "NXP-28799: remove CoreSession and DocumentModel session id", "pr_createdAt": "2020-03-24T15:39:45Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3858", "timeline": [{"oid": "324344957992b61bd6dbe39fd29a88097d063254", "url": "https://github.com/nuxeo/nuxeo/commit/324344957992b61bd6dbe39fd29a88097d063254", "message": "NXP-28799: remove CoreSession and DocumentModel session id (sid) WIP to squash", "committedDate": "2020-03-24T17:16:39Z", "type": "forcePushed"}, {"oid": "b3ddfe9dfa980d2bd4bfcf340b50ea388e5e6d6b", "url": "https://github.com/nuxeo/nuxeo/commit/b3ddfe9dfa980d2bd4bfcf340b50ea388e5e6d6b", "message": "remove CloseableCoreSession from tests (WIP)", "committedDate": "2020-03-25T02:52:39Z", "type": "forcePushed"}, {"oid": "18b084c8e0ace39bd73ce55ed7ef9ef94d109463", "url": "https://github.com/nuxeo/nuxeo/commit/18b084c8e0ace39bd73ce55ed7ef9ef94d109463", "message": "NXP-28799: remove CloseableCoreSession from tests", "committedDate": "2020-03-25T22:54:50Z", "type": "forcePushed"}, {"oid": "3e5d92336d2f544e0dc6732a65f73513c9fd21b4", "url": "https://github.com/nuxeo/nuxeo/commit/3e5d92336d2f544e0dc6732a65f73513c9fd21b4", "message": "NXP-28799: remove CloseableCoreSession from tests", "committedDate": "2020-03-26T01:15:56Z", "type": "forcePushed"}, {"oid": "d09261f66b008135217baa4465381b173a928b48", "url": "https://github.com/nuxeo/nuxeo/commit/d09261f66b008135217baa4465381b173a928b48", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-03-26T15:23:15Z", "type": "forcePushed"}, {"oid": "de835ec670be8484bb2ac1631cbe50a901a37f63", "url": "https://github.com/nuxeo/nuxeo/commit/de835ec670be8484bb2ac1631cbe50a901a37f63", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-03-26T22:19:39Z", "type": "forcePushed"}, {"oid": "ea8dc7f33c816229c07f713e100ff82128e76408", "url": "https://github.com/nuxeo/nuxeo/commit/ea8dc7f33c816229c07f713e100ff82128e76408", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-03-27T17:33:06Z", "type": "forcePushed"}, {"oid": "eb40044bcbf253302ffca1afe4157ac98979a97f", "url": "https://github.com/nuxeo/nuxeo/commit/eb40044bcbf253302ffca1afe4157ac98979a97f", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-03-30T11:06:50Z", "type": "forcePushed"}, {"oid": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "url": "https://github.com/nuxeo/nuxeo/commit/4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-03-30T18:20:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxNDQ4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401614484", "bodyText": "If it's only for unit tests, shouldn't we move that method to test code, such as CoreFeature or something?\nDoes it make sense?", "author": "troger", "createdAt": "2020-04-01T13:28:26Z", "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CoreInstance.java", "diffHunk": "@@ -38,97 +38,145 @@\n     private CoreInstance() {\n     }\n \n+    /**\n+     * Gets a {@link CoreSession} for the currently logged-in user.\n+     *\n+     * @param repositoryName the repository name, or {@code null} for the default repository\n+     * @return the session\n+     * @since 11.1\n+     */\n+    public static CoreSession getCoreSession(String repositoryName) {\n+        return getCoreSession(repositoryName, getPrincipal(null));\n+    }\n+\n+    /**\n+     * MUST ONLY BE USED IN UNIT TESTS to get a {@link CoreSession} for the given user.", "originalCommit": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAyOTE2Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r403029162", "bodyText": "Yes this will have to be cleaned up in the future. For now I'm keeping it also because it's used by the deprecated openCoreSession signature that delegates to it.\nAlso there's still one non-unit-test use in the CMIS code that I need to review.", "author": "efge", "createdAt": "2020-04-03T14:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxNDQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxODkzMA==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401618930", "bodyText": "As the whole interface is deprecated, why removing the method?", "author": "troger", "createdAt": "2020-04-01T13:34:40Z", "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/CloseableCoreSession.java", "diffHunk": "@@ -22,22 +22,18 @@\n  * Closeable Core Session.\n  *\n  * @since 10.1\n+ * @deprecated since 11.1, use just {@link CoreSession} instead\n  */\n+@Deprecated\n public interface CloseableCoreSession extends CoreSession, AutoCloseable {\n \n     /**\n-     * Closes this session.\n+     * Does nothing.\n      *\n      * @since 5.9.3\n+     * @deprecated since 11.1\n      */\n     @Override\n     void close();\n \n-    /**\n-     * Destroys any system resources held by this instance.\n-     * <p>\n-     * Called when the instance is no more needed.\n-     */\n-    void destroy();", "originalCommit": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzNTA4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r403035089", "bodyText": "Yes I'll keep it deprecated doing nothing.", "author": "efge", "createdAt": "2020-04-03T14:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxODkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxOTY5OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401619698", "bodyText": "Quick question, we are assuming that there is only one session (id) per user?", "author": "troger", "createdAt": "2020-04-01T13:35:44Z", "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/impl/DocumentModelImpl.java", "diffHunk": "@@ -320,7 +340,12 @@ public String getTitle() {\n \n     @Override\n     public String getSessionId() {\n-        return sid;\n+        return principal == null ? null : repositoryName + \"/\" + principal;", "originalCommit": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzNjQ2Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r403036462", "bodyText": "There's as many CoreSession as we want per user but they don't hold any state anymore, so are all equivalent. The real state is held by the lower-level Session that is fetched through a ThreadLocal and cleaned up at transaction commit.", "author": "efge", "createdAt": "2020-04-03T14:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxOTY5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYyNTE2Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401625163", "bodyText": "Worth adding a comment if there is any need to call getRootDocument?", "author": "troger", "createdAt": "2020-04-01T13:43:12Z", "path": "modules/core/nuxeo-core-management-jtajca/src/main/java/org/nuxeo/ecm/core/management/jtajca/internal/DefaultMonitorComponent.java", "diffHunk": "@@ -129,9 +129,8 @@ protected void install() {\n      * Make sure we open the repository, to initialize its connection manager.\n      */\n     protected void activateRepository(String repositoryName) {\n-        try (CloseableCoreSession session = CoreInstance.openCoreSessionSystem(repositoryName)) {\n-            // do nothing, just open and close\n-        }\n+        CoreSession session = CoreInstance.getCoreSessionSystem(repositoryName);\n+        session.getRootDocument();", "originalCommit": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzOTAxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r403039010", "bodyText": "Actually this method activateRepository is unused in our codebase, so I'll just deprecate it.", "author": "efge", "createdAt": "2020-04-03T14:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYyNTE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY0MDQyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r401640425", "bodyText": "I'm wondering, won't it be an issue? cc @bdelbosc", "author": "troger", "createdAt": "2020-04-01T14:03:32Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/commands/IndexingCommandsStacker.java", "diffHunk": "@@ -212,8 +212,7 @@ protected IndexingCommands getOrCreateCommands(DocumentModel doc) {\n     }\n \n     protected String getDocKey(DocumentModel doc) {\n-        // Don't merge commands with different session, so we work only on attached doc\n-        return doc.getId() + \"#\" + doc.getSessionId();\n+        return doc.getId();", "originalCommit": "4a0349c9d06d5320d5a6ed3a64140b8a5762bb6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA0MDc1NA==", "url": "https://github.com/nuxeo/nuxeo/pull/3858#discussion_r403040754", "bodyText": "I already discussed it with @bdelbosc and we agreed that given that indexing is only done for a single transaction at a time and there's a cleanup of the map for which this is used as the key at the end of the transaction. So not an issue.", "author": "efge", "createdAt": "2020-04-03T14:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY0MDQyNQ=="}], "type": "inlineReview"}, {"oid": "04a1dd9988de2791f952919661b9ecff46503599", "url": "https://github.com/nuxeo/nuxeo/commit/04a1dd9988de2791f952919661b9ecff46503599", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-04-03T01:21:23Z", "type": "forcePushed"}, {"oid": "7eb8d717dd876f65f6510f126608ca68f673767b", "url": "https://github.com/nuxeo/nuxeo/commit/7eb8d717dd876f65f6510f126608ca68f673767b", "message": "NXP-28799: add DocumentModel.getPrincipal", "committedDate": "2020-04-03T14:22:41Z", "type": "commit"}, {"oid": "60b085af3206ad0b411d7cd0b9ea84c5fdffe1eb", "url": "https://github.com/nuxeo/nuxeo/commit/60b085af3206ad0b411d7cd0b9ea84c5fdffe1eb", "message": "NXP-28799: remove metrics instance fields", "committedDate": "2020-04-03T14:22:41Z", "type": "commit"}, {"oid": "d5a517d9e1f8973c8c8eb660931f0ed723b3d067", "url": "https://github.com/nuxeo/nuxeo/commit/d5a517d9e1f8973c8c8eb660931f0ed723b3d067", "message": "NXP-28799: remove CoreSession and DocumentModel session id (sid)", "committedDate": "2020-04-03T14:22:42Z", "type": "commit"}, {"oid": "af64605849d03d883a11ddec8b62060c0b17f91f", "url": "https://github.com/nuxeo/nuxeo/commit/af64605849d03d883a11ddec8b62060c0b17f91f", "message": "NXP-28799: don't use deprecated constructors", "committedDate": "2020-04-03T14:22:42Z", "type": "commit"}, {"oid": "6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "url": "https://github.com/nuxeo/nuxeo/commit/6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-04-03T14:22:42Z", "type": "commit"}, {"oid": "6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "url": "https://github.com/nuxeo/nuxeo/commit/6bfa834499fb48bb2e2f8e3bbac5085f29d70ad6", "message": "NXP-28799: remove usage of CloseableCoreSession", "committedDate": "2020-04-03T14:22:42Z", "type": "forcePushed"}]}