{"pr_number": 4293, "pr_title": "Feature NXP-29529 Elastic Upgrade to 7.9.2", "pr_createdAt": "2020-09-02T12:46:20Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4293", "timeline": [{"oid": "bb0dfdb4f2e80535a633e43ec1ee479fcac2a5a5", "url": "https://github.com/nuxeo/nuxeo/commit/bb0dfdb4f2e80535a633e43ec1ee479fcac2a5a5", "message": "NXP-29529: Upgrade other modules", "committedDate": "2020-09-07T07:22:23Z", "type": "forcePushed"}, {"oid": "7a3d9a80609c22fd82f0cd8f1185b54dae43a0af", "url": "https://github.com/nuxeo/nuxeo/commit/7a3d9a80609c22fd82f0cd8f1185b54dae43a0af", "message": "NXP-29529: Try upgrade to 7.9.1", "committedDate": "2020-09-09T06:38:11Z", "type": "forcePushed"}, {"oid": "8a1504a8cbd3f18c5fb169f86760399a3b7bc270", "url": "https://github.com/nuxeo/nuxeo/commit/8a1504a8cbd3f18c5fb169f86760399a3b7bc270", "message": "NXP-29529: Try upgrade to 7.9.1", "committedDate": "2020-09-09T08:55:12Z", "type": "forcePushed"}, {"oid": "f1250a797ba43d3a939b65bc672e095ebd8d3d83", "url": "https://github.com/nuxeo/nuxeo/commit/f1250a797ba43d3a939b65bc672e095ebd8d3d83", "message": "NXP-29529: Try upgrade to 7.9.1", "committedDate": "2020-09-11T12:45:00Z", "type": "forcePushed"}, {"oid": "ce2e5c43f72c6d362cedeb9b1dc8f97bf02de797", "url": "https://github.com/nuxeo/nuxeo/commit/ce2e5c43f72c6d362cedeb9b1dc8f97bf02de797", "message": "NXP-29529: Upgrade to Elastic 7.9.1, ignore WARNs", "committedDate": "2020-09-11T13:22:56Z", "type": "forcePushed"}, {"oid": "bc8f98013083a8aef44171014afd103557d82506", "url": "https://github.com/nuxeo/nuxeo/commit/bc8f98013083a8aef44171014afd103557d82506", "message": "NXP-29529: Upgrade to Elastic 7.9.1, ignore WARNs", "committedDate": "2020-09-11T14:31:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzczMzI5Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r487733292", "bodyText": "To remove?", "author": "kevinleturc", "createdAt": "2020-09-14T08:19:35Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/TestESClient.java", "diffHunk": "@@ -97,12 +97,13 @@ public void closeESClient() throws Exception {\n     @Test\n     public void testIndexOptimisticConcurrency() {\n         client.createIndex(\"foo-index\", \"{\\\"index\\\" : {\\\"number_of_shards\\\" : 1, \\\"number_of_replicas\\\" : 0}}\");\n+        // client.createIndex(\"foo-index\", \"{\\\"settings\\\":{\\\"index\\\" : {\\\"number_of_shards\\\" : 1, \\\"number_of_replicas\\\" : 0}}}\");", "originalCommit": "bc8f98013083a8aef44171014afd103557d82506", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzczNDc3OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r487734778", "bodyText": "Shouldn't we keep a backward compatibility mechanism for the existing queries with 4 parameters written by users?", "author": "kevinleturc", "createdAt": "2020-09-14T08:22:00Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/hint/GeoShapeESHintQueryBuilder.java", "diffHunk": "@@ -40,10 +40,10 @@\n      */\n     @Override\n     public QueryBuilder make(EsHint hint, String fieldName, Object value) {\n-        String[] values = validate(value, 4, \"shapeId, type, index and path\");\n-        return QueryBuilders.geoShapeQuery(fieldName, values[0], values[1])\n+        String[] values = validate(value, 3, \"shapeId, index and path\");\n+        return QueryBuilders.geoShapeQuery(fieldName, values[0])\n                             .relation(ShapeRelation.WITHIN)\n-                            .indexedShapeIndex(values[2])\n-                            .indexedShapePath(values[3]);\n+                            .indexedShapeIndex(values[1])\n+                            .indexedShapePath(values[2]);", "originalCommit": "bc8f98013083a8aef44171014afd103557d82506", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ1NDI3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r499454271", "bodyText": "yes, you are right, I will add the \"type\" back here saying it is unused.", "author": "bdelbosc", "createdAt": "2020-10-05T09:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzczNDc3OA=="}], "type": "inlineReview"}, {"oid": "72c998747e1ca5b14f1aa2b3b76a978ca1174061", "url": "https://github.com/nuxeo/nuxeo/commit/72c998747e1ca5b14f1aa2b3b76a978ca1174061", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T13:10:42Z", "type": "forcePushed"}, {"oid": "23b02985af55b7a27dfe59d7f3756f1c77e0ee83", "url": "https://github.com/nuxeo/nuxeo/commit/23b02985af55b7a27dfe59d7f3756f1c77e0ee83", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T13:37:53Z", "type": "forcePushed"}, {"oid": "a66fa9265555a53aef3e9f2f9eea64e6e704b1cc", "url": "https://github.com/nuxeo/nuxeo/commit/a66fa9265555a53aef3e9f2f9eea64e6e704b1cc", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T13:50:47Z", "type": "forcePushed"}, {"oid": "a8156540ec3d250d25d4b876872f03ef98ada813", "url": "https://github.com/nuxeo/nuxeo/commit/a8156540ec3d250d25d4b876872f03ef98ada813", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T13:55:57Z", "type": "forcePushed"}, {"oid": "6cba3ef689cebc326f9eeb0baa4ba713c1eb9f30", "url": "https://github.com/nuxeo/nuxeo/commit/6cba3ef689cebc326f9eeb0baa4ba713c1eb9f30", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T14:14:32Z", "type": "forcePushed"}, {"oid": "be818bc3a7412f01a54f6519201081ae97d7a62e", "url": "https://github.com/nuxeo/nuxeo/commit/be818bc3a7412f01a54f6519201081ae97d7a62e", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T15:07:51Z", "type": "forcePushed"}, {"oid": "f71fa72f3cd4a26c62275d17e30730a8dee8b7e4", "url": "https://github.com/nuxeo/nuxeo/commit/f71fa72f3cd4a26c62275d17e30730a8dee8b7e4", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T15:15:05Z", "type": "forcePushed"}, {"oid": "42c2adb3a8fe4cfc880a5b494e56f620d3038af0", "url": "https://github.com/nuxeo/nuxeo/commit/42c2adb3a8fe4cfc880a5b494e56f620d3038af0", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-16T17:44:58Z", "type": "forcePushed"}, {"oid": "afb4c44a36654edd3e6c5ac936c9037129c38d29", "url": "https://github.com/nuxeo/nuxeo/commit/afb4c44a36654edd3e6c5ac936c9037129c38d29", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-17T08:28:00Z", "type": "forcePushed"}, {"oid": "cf11490f03052cdee33ca635dbb0f86f83a2d37f", "url": "https://github.com/nuxeo/nuxeo/commit/cf11490f03052cdee33ca635dbb0f86f83a2d37f", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-17T08:54:28Z", "type": "forcePushed"}, {"oid": "a518c37d1009ffdde4ff3c71555692febe4eecc1", "url": "https://github.com/nuxeo/nuxeo/commit/a518c37d1009ffdde4ff3c71555692febe4eecc1", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-17T09:22:45Z", "type": "forcePushed"}, {"oid": "18e271669c959783812b53cca1debb276fd94dd2", "url": "https://github.com/nuxeo/nuxeo/commit/18e271669c959783812b53cca1debb276fd94dd2", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-17T14:00:56Z", "type": "forcePushed"}, {"oid": "d52a9879e681bad9838c6f53ca31f23a021d7d50", "url": "https://github.com/nuxeo/nuxeo/commit/d52a9879e681bad9838c6f53ca31f23a021d7d50", "message": "NXP-29529: TEST Upgrade helm to use elastic 7\n\nAlso disabling runtime unit test", "committedDate": "2020-09-22T08:20:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1ODI2MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498058260", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (IOException|ElasticsearchStatusException e) {\n          \n          \n            \n                    } catch (IOException | ElasticsearchStatusException e) {", "author": "ataillefer", "createdAt": "2020-10-01T08:06:26Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/client/ESRestClient.java", "diffHunk": "@@ -321,7 +323,8 @@ public DeleteResponse delete(DeleteRequest request) {\n     public SearchResponse search(SearchRequest request) {\n         try (Scope ignored = getScopedSpan(\"elastic/_search\", request.toString())) {\n             return client.search(request, RequestOptions.DEFAULT);\n-        } catch (IOException e) {\n+        } catch (IOException|ElasticsearchStatusException e) {", "originalCommit": "f2afb3d1cc87dd9b40c7e2d50499c7af381dd55e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1OTI5NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498059295", "bodyText": "really needed?", "author": "ataillefer", "createdAt": "2020-10-01T08:08:21Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/core/ElasticSearchServiceImpl.java", "diffHunk": "@@ -20,13 +20,12 @@\n \n package org.nuxeo.elasticsearch.core;\n \n-import static org.nuxeo.elasticsearch.ElasticSearchConstants.DOC_TYPE;\n-\n import java.util.List;\n \n import org.apache.commons.lang3.StringUtils;\n import org.apache.commons.logging.Log;\n import org.apache.commons.logging.LogFactory;\n+import org.apache.lucene.search.TotalHits;", "originalCommit": "f2afb3d1cc87dd9b40c7e2d50499c7af381dd55e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2MTYxOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498061618", "bodyText": "not needed I guess", "author": "ataillefer", "createdAt": "2020-10-01T08:12:32Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/java/org/nuxeo/elasticsearch/test/TestMapping.java", "diffHunk": "@@ -23,13 +23,15 @@\n \n import javax.inject.Inject;\n \n+import org.elasticsearch.ElasticsearchStatusException;", "originalCommit": "f2afb3d1cc87dd9b40c7e2d50499c7af381dd55e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MDE1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498070150", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Aggregation agg = searchResponse.getAggregations().get(\"maxAgg\");\n          \n          \n            \n                    long maxLogEntryId = 0;\n          \n          \n            \n                    if (agg.getMetadata() != null && agg.getMetadata().containsKey(Aggregation.CommonFields.VALUE)) {\n          \n          \n            \n                        maxLogEntryId = (long) agg.getMetadata().get(Aggregation.CommonFields.VALUE);\n          \n          \n            \n                    }\n          \n          \n            \n                    long maxLogEntryId = 0;\n          \n          \n            \n                    Aggregation agg = searchResponse.getAggregations().get(\"maxAgg\");\n          \n          \n            \n                    Map<String, Object> aggMetadata = agg.getMetaData();\n          \n          \n            \n                    if (aggMetadata != null) {\n          \n          \n            \n                        maxLogEntryId = (long) aggMetadata.getOrDefault(Aggregation.CommonFields.VALUE, 0);\n          \n          \n            \n                    }", "author": "ataillefer", "createdAt": "2020-10-01T08:26:46Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-audit/src/main/java/org/nuxeo/elasticsearch/audit/ESAuditBackend.java", "diffHunk": "@@ -715,9 +715,11 @@ protected void ensureUIDSequencer(ESClient esClient) {\n         request.source(new SearchSourceBuilder().query(QueryBuilders.matchAllQuery())\n                                                 .aggregation(AggregationBuilders.max(\"maxAgg\").field(\"id\")));\n         SearchResponse searchResponse = esClient.search(request);\n-        Max agg = searchResponse.getAggregations().get(\"maxAgg\");\n-        long maxLogEntryId = (long) agg.getValue();\n-\n+        Aggregation agg = searchResponse.getAggregations().get(\"maxAgg\");\n+        long maxLogEntryId = 0;\n+        if (agg.getMetadata() != null && agg.getMetadata().containsKey(Aggregation.CommonFields.VALUE)) {\n+            maxLogEntryId = (long) agg.getMetadata().get(Aggregation.CommonFields.VALUE);\n+        }", "originalCommit": "e912bb845c757e7ecdfb7cac47bca4a6e7a3a43c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxODQyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r499518429", "bodyText": "I find it harder to read", "author": "bdelbosc", "createdAt": "2020-10-05T11:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MDE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjAxNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498072017", "bodyText": "to be clear, this should be in the same commit as f2afb3d#diff-f0d6271e8fca3291a638cf9797c75ddaL295", "author": "ataillefer", "createdAt": "2020-10-01T08:29:29Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/core/ElasticSearchIndexingImpl.java", "diffHunk": "@@ -290,7 +290,7 @@ void processIndexCommand(IndexingCommand cmd) {\n             return;\n         }\n         if (log.isDebugEnabled()) {\n-            logDebugMessageTruncated(String.format(\"Index request: curl -XPUT 'http://localhost:9200/%s/%s/%s' -d '%s'\",\n+            logDebugMessageTruncated(String.format(\"Index request: curl -XPUT 'http://localhost:9200/%s/%s' -d '%s'\",", "originalCommit": "e912bb845c757e7ecdfb7cac47bca4a6e7a3a43c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTk1OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r499615959", "bodyText": "will do that better next time", "author": "bdelbosc", "createdAt": "2020-10-05T13:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjAxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjE3NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498072175", "bodyText": "and this too probably", "author": "ataillefer", "createdAt": "2020-10-01T08:29:46Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/main/java/org/nuxeo/elasticsearch/core/ElasticSearchIndexingImpl.java", "diffHunk": "@@ -360,7 +360,7 @@ void processDeleteCommandRecursive(IndexingCommand cmd) {\n             // Build bulk delete request\n             BulkRequest bulkRequest = new BulkRequest();\n             for (SearchHit hit : response.getHits().getHits()) {\n-                bulkRequest.add(new DeleteRequest(hit.getIndex(), hit.getType(), hit.getId()));\n+                bulkRequest.add(new DeleteRequest(hit.getIndex(), hit.getId()));", "originalCommit": "e912bb845c757e7ecdfb7cac47bca4a6e7a3a43c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjgyMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498072820", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <!-- Remove WARN on elastic embedded because node and cluster identifiers change between test suite -->\n          \n          \n            \n                <!-- Remove WARN on elastic embedded because node and cluster identifiers change between test suites -->", "author": "ataillefer", "createdAt": "2020-10-01T08:30:50Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-core/src/test/resources/log4j2-test.xml", "diffHunk": "@@ -12,6 +12,10 @@\n   </Appenders>\n   <Loggers>\n     <Logger name=\"org.nuxeo\" level=\"info\" />\n+    <!-- Remove WARN on elastic embedded because dangling indices cannot be detected -->\n+    <Logger name=\"org.elasticsearch.gateway.DanglingIndicesState\" level=\"error\" />\n+    <!-- Remove WARN on elastic embedded because node and cluster identifiers change between test suite -->", "originalCommit": "ecc4e127151184d04b81533937c2e7dd5fc8e459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MzQxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r498073416", "bodyText": "in the end, should be squashed with f2afb3d#diff-600376dffeb79835ede4a0b285078036L72", "author": "ataillefer", "createdAt": "2020-10-01T08:31:52Z", "path": "pom.xml", "diffHunk": "@@ -69,8 +69,8 @@\n     <jaxb-api.version>2.3.3</jaxb-api.version>\n     <jaxb.version>2.3.3</jaxb.version>\n     <tomcat.version>9.0.38</tomcat.version>\n-    <lucene.version>8.6.0</lucene.version>\n-    <elasticsearch.version>7.9.0</elasticsearch.version> <!-- when changing this make sure JNA version is in sync -->\n+    <lucene.version>8.6.2</lucene.version>\n+    <elasticsearch.version>7.9.1</elasticsearch.version> <!-- when changing this make sure JNA version is in sync -->", "originalCommit": "ecc4e127151184d04b81533937c2e7dd5fc8e459", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTY1MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r499615651", "bodyText": "yes, I have updated now upgrade is on 7.9.2", "author": "bdelbosc", "createdAt": "2020-10-05T13:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MzQxNg=="}], "type": "inlineReview"}, {"oid": "fcdd998603c8d2c65b8b306ac225bd32bdb099fb", "url": "https://github.com/nuxeo/nuxeo/commit/fcdd998603c8d2c65b8b306ac225bd32bdb099fb", "message": "NXP-29529: Upgrade to Elastic 7.9.2", "committedDate": "2020-10-05T09:12:01Z", "type": "forcePushed"}, {"oid": "80bd5300c2e695f51b41406e381eb9df4fe0c382", "url": "https://github.com/nuxeo/nuxeo/commit/80bd5300c2e695f51b41406e381eb9df4fe0c382", "message": "NXP-29529: Upgrade to Elastic 7.9.2", "committedDate": "2020-10-05T13:46:21Z", "type": "forcePushed"}, {"oid": "efa737d333add8548d271af36ff78911d0ae1185", "url": "https://github.com/nuxeo/nuxeo/commit/efa737d333add8548d271af36ff78911d0ae1185", "message": "NXP-29529: fix Duplicate component name: service:org.nuxeo.elasticsearch.test.contrib", "committedDate": "2020-10-05T13:51:09Z", "type": "forcePushed"}, {"oid": "1863a2a79bf7cdab1cb26fe3850c82080674dd25", "url": "https://github.com/nuxeo/nuxeo/commit/1863a2a79bf7cdab1cb26fe3850c82080674dd25", "message": "NXP-29529: fix Duplicate component name: service:org.nuxeo.elasticsearch.test.contrib", "committedDate": "2020-10-05T14:32:41Z", "type": "forcePushed"}, {"oid": "c5378713e522088ae5f4324fa3e0651a5cfdce6b", "url": "https://github.com/nuxeo/nuxeo/commit/c5378713e522088ae5f4324fa3e0651a5cfdce6b", "message": "NXP-29529: fix Duplicate component name: service:org.nuxeo.elasticsearch.test.contrib", "committedDate": "2020-10-05T15:01:26Z", "type": "forcePushed"}, {"oid": "6ffb2ff58dcddfaa29d52d0d92e716d6980ed3fe", "url": "https://github.com/nuxeo/nuxeo/commit/6ffb2ff58dcddfaa29d52d0d92e716d6980ed3fe", "message": "NXP-29529: Test against Elastic cluster in 7.7.1", "committedDate": "2020-10-22T09:19:44Z", "type": "forcePushed"}, {"oid": "3e4aef3533cd6eaa6e9d723083ae8bc6fb808db3", "url": "https://github.com/nuxeo/nuxeo/commit/3e4aef3533cd6eaa6e9d723083ae8bc6fb808db3", "message": "NXP-29529: fix Duplicate component name: service:org.nuxeo.elasticsearch.test.contrib", "committedDate": "2020-10-26T07:20:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA3OTA0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r512079046", "bodyText": "Could we put agg.getMetaData() in a local var at least to avoid repetition? It could be done directly with\nvar aggMetadata = searchResponse.getAggregations().get(\"maxAgg\").getMetaData();\n\nBut I would also really want to advocate getOrDefault, it's a habit that's good to have.", "author": "efge", "createdAt": "2020-10-26T16:04:48Z", "path": "modules/platform/nuxeo-elasticsearch/nuxeo-elasticsearch-audit/src/main/java/org/nuxeo/elasticsearch/audit/ESAuditBackend.java", "diffHunk": "@@ -715,8 +715,11 @@ protected void ensureUIDSequencer(ESClient esClient) {\n         request.source(new SearchSourceBuilder().query(QueryBuilders.matchAllQuery())\n                                                 .aggregation(AggregationBuilders.max(\"maxAgg\").field(\"id\")));\n         SearchResponse searchResponse = esClient.search(request);\n-        Max agg = searchResponse.getAggregations().get(\"maxAgg\");\n-        long maxLogEntryId = (long) agg.getValue();\n+        Aggregation agg = searchResponse.getAggregations().get(\"maxAgg\");\n+        long maxLogEntryId = 0;\n+        if (agg.getMetadata() != null && agg.getMetadata().containsKey(Aggregation.CommonFields.VALUE)) {\n+            maxLogEntryId = (long) agg.getMetadata().get(Aggregation.CommonFields.VALUE);\n+        }", "originalCommit": "1b528f00e48559aa28236de7d40547f806070920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2NjAxMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r512466011", "bodyText": "ok will do that another time, the CI cannot validate a new change before merging", "author": "bdelbosc", "createdAt": "2020-10-27T07:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA3OTA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4MDI3NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r512080275", "bodyText": "Note that 7.9.3 is out now.", "author": "efge", "createdAt": "2020-10-26T16:06:32Z", "path": "pom.xml", "diffHunk": "@@ -69,8 +69,8 @@\n     <jaxb-api.version>2.3.3</jaxb-api.version>\n     <jaxb.version>2.3.3</jaxb.version>\n     <tomcat.version>9.0.39</tomcat.version>\n-    <lucene.version>7.5.0</lucene.version>\n-    <elasticsearch.version>6.5.3</elasticsearch.version> <!-- when changing this make sure JNA version is in sync -->\n+    <lucene.version>8.6.2</lucene.version>\n+    <elasticsearch.version>7.9.2</elasticsearch.version> <!-- when changing this make sure JNA version is in sync -->", "originalCommit": "14b098de15be8e152407a8c6a509c1871d06b53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4ODQ1Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4293#discussion_r512088456", "bodyText": "yes, it is hard to follow their release cycle, I prefer to continue on 7.9.2 for now,\nI think there is going to be a 7.10 as well", "author": "bdelbosc", "createdAt": "2020-10-26T16:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4MDI3NQ=="}], "type": "inlineReview"}, {"oid": "d4052a4cc6a624e3cead55adb83592fafbf7dd10", "url": "https://github.com/nuxeo/nuxeo/commit/d4052a4cc6a624e3cead55adb83592fafbf7dd10", "message": "NXP-29529: Upgrade Elastic to 7.9.2 align code\n\nUnit tests OK for nuxeo-elasticsearch-core\nIgnore some WARNs from lucene in clusterStateListener cannot be set twice\nwhich is to be expected in embedded mode during unit tests.", "committedDate": "2020-10-27T14:55:08Z", "type": "commit"}, {"oid": "a1f19c15e791647d9e6fe1937749fb2eb107b9a6", "url": "https://github.com/nuxeo/nuxeo/commit/a1f19c15e791647d9e6fe1937749fb2eb107b9a6", "message": "NXP-29529: Align all modules to Elastic 7.9.2", "committedDate": "2020-10-27T15:03:10Z", "type": "commit"}, {"oid": "51ec186be593c4bb7e2d114744b7fff97412b470", "url": "https://github.com/nuxeo/nuxeo/commit/51ec186be593c4bb7e2d114744b7fff97412b470", "message": "NXP-29529: Upgrade helm to use elastic 7\n\nRequires latest nuxeo-helm-chart version > 1.0.14", "committedDate": "2020-10-27T15:03:10Z", "type": "commit"}, {"oid": "cc15b56aba84bcf6ffe995abfaa634a89debe1b4", "url": "https://github.com/nuxeo/nuxeo/commit/cc15b56aba84bcf6ffe995abfaa634a89debe1b4", "message": "NXP-29529: fix Duplicate component name: service:org.nuxeo.elasticsearch.test.contrib", "committedDate": "2020-10-27T15:03:10Z", "type": "commit"}, {"oid": "cc15b56aba84bcf6ffe995abfaa634a89debe1b4", "url": "https://github.com/nuxeo/nuxeo/commit/cc15b56aba84bcf6ffe995abfaa634a89debe1b4", "message": "NXP-29529: fix Duplicate component name: service:org.nuxeo.elasticsearch.test.contrib", "committedDate": "2020-10-27T15:03:10Z", "type": "forcePushed"}]}