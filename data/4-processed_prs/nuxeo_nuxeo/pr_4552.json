{"pr_number": 4552, "pr_title": "Feature NXP-29991 better zip preview", "pr_createdAt": "2020-12-22T12:11:08Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4552", "timeline": [{"oid": "db4a55e92a35d1af003597a8773effc7acd04a06", "url": "https://github.com/nuxeo/nuxeo/commit/db4a55e92a35d1af003597a8773effc7acd04a06", "message": "NXP-29991: Cleanup / Format", "committedDate": "2020-12-22T10:57:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0NTkwNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547245904", "bodyText": "You could use javax.ws.rs.core.MediaType.TEXT_HTML etc. for the constants (if it's not a dependency to add)", "author": "efge", "createdAt": "2020-12-22T12:18:55Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(\"text/html\", \"text/xml\", \"text/plain\");", "originalCommit": "fc37e894b628162468872e2b2e5852361d0a8e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0NjI3Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547246277", "bodyText": "Please put the log as the first constant.", "author": "efge", "createdAt": "2020-12-22T12:19:49Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(\"text/html\", \"text/xml\", \"text/plain\");\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);", "originalCommit": "fc37e894b628162468872e2b2e5852361d0a8e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0NjkwOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547246909", "bodyText": "\"UTF-8\" -> null, it's the default and doesn't need to be explicit", "author": "efge", "createdAt": "2020-12-22T12:21:21Z", "path": "modules/platform/nuxeo-preview-core/src/test/java/org/nuxeo/ecm/platform/preview/tests/adapter/TestPreviewAdapter.java", "diffHunk": "@@ -103,16 +110,53 @@ public void testXMLDocument() throws Exception {\n         doTestFileDocument(blob, \"\\n\\n<b>test</b>\");\n     }\n \n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.preview:test-zip-preview-contrib.xml\")\n+    public void testZIPDocument() throws Exception {\n+        File file = Framework.createTempFile(\"testZIPDocument\", \".zip\");\n+        try (ZipOutputStream out = new ZipOutputStream(new FileOutputStream(file))) {\n+            writeZipEntry(out, \"payload.html\");\n+            writeZipEntry(out, \"payload.xml\");\n+            writeZipEntry(out, \"payload.txt\");\n+        }\n+        Blob blob = Blobs.createBlob(file, \"application/zip\", \"UTF-8\", \"testZIPDocument.zip\");", "originalCommit": "fc37e894b628162468872e2b2e5852361d0a8e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0ODMyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547248322", "bodyText": "\"UTF-8\" -> null", "author": "efge", "createdAt": "2020-12-22T12:24:26Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(\"text/html\", \"text/xml\", \"text/plain\");\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");\n+        }\n+\n+        try {\n+            BlobHolder result = conversionService.convert(converterName, new SimpleBlobHolder(blob), null);\n+            List<Blob> blobs = new ArrayList<>(result.getBlobs());\n+            blobs.replaceAll(this::sanitize);\n+            return blobs;\n+        } catch (ConversionException e) {\n+            throw new PreviewException(e.getMessage(), e);\n+        }\n+    }\n+\n+    protected Blob sanitize(Blob blob) throws PreviewException {\n+        String filename = blob.getFilename();\n+        if (!isSanitizable(blob)) {\n+            log.debug(\"ZipEntryBlob: {} is not sanitizable\", filename);\n+            return blob;\n+        }\n+        try {\n+            String content = blob.getString();\n+            content = getHtmlSanitizerService().sanitizeString(content, null);\n+            content = PreviewHelper.makeHtmlPage(content);\n+            return Blobs.createBlob(content, \"text/html\", \"UTF-8\", filename);", "originalCommit": "fc37e894b628162468872e2b2e5852361d0a8e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0ODc5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547248790", "bodyText": "Is that the right error message?", "author": "efge", "createdAt": "2020-12-22T12:25:24Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(\"text/html\", \"text/xml\", \"text/plain\");\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");\n+        }\n+\n+        try {\n+            BlobHolder result = conversionService.convert(converterName, new SimpleBlobHolder(blob), null);\n+            List<Blob> blobs = new ArrayList<>(result.getBlobs());\n+            blobs.replaceAll(this::sanitize);\n+            return blobs;\n+        } catch (ConversionException e) {\n+            throw new PreviewException(e.getMessage(), e);\n+        }\n+    }\n+\n+    protected Blob sanitize(Blob blob) throws PreviewException {\n+        String filename = blob.getFilename();\n+        if (!isSanitizable(blob)) {\n+            log.debug(\"ZipEntryBlob: {} is not sanitizable\", filename);\n+            return blob;\n+        }\n+        try {\n+            String content = blob.getString();\n+            content = getHtmlSanitizerService().sanitizeString(content, null);\n+            content = PreviewHelper.makeHtmlPage(content);\n+            return Blobs.createBlob(content, \"text/html\", \"UTF-8\", filename);\n+        } catch (IOException e) {\n+            throw new PreviewException(\"Cannot fetch ZipEntryBlob content with filename: \" + filename, e);", "originalCommit": "fc37e894b628162468872e2b2e5852361d0a8e7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3MjY4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547272684", "bodyText": "Yes, IOException is only thrown by blob.getString().", "author": "kevinleturc", "createdAt": "2020-12-22T13:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0ODc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI1MDk1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547250952", "bodyText": "Isn't there a risk that we'll read all the \"lines\" of a binary file for example?", "author": "efge", "createdAt": "2020-12-22T12:30:18Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(\"text/html\", \"text/xml\", \"text/plain\");\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");\n+        }\n+\n+        try {\n+            BlobHolder result = conversionService.convert(converterName, new SimpleBlobHolder(blob), null);\n+            List<Blob> blobs = new ArrayList<>(result.getBlobs());\n+            blobs.replaceAll(this::sanitize);\n+            return blobs;\n+        } catch (ConversionException e) {\n+            throw new PreviewException(e.getMessage(), e);\n+        }\n+    }\n+\n+    protected Blob sanitize(Blob blob) throws PreviewException {\n+        String filename = blob.getFilename();\n+        if (!isSanitizable(blob)) {\n+            log.debug(\"ZipEntryBlob: {} is not sanitizable\", filename);\n+            return blob;\n+        }\n+        try {\n+            String content = blob.getString();\n+            content = getHtmlSanitizerService().sanitizeString(content, null);\n+            content = PreviewHelper.makeHtmlPage(content);\n+            return Blobs.createBlob(content, \"text/html\", \"UTF-8\", filename);\n+        } catch (IOException e) {\n+            throw new PreviewException(\"Cannot fetch ZipEntryBlob content with filename: \" + filename, e);\n+        }\n+    }\n+\n+    protected boolean isSanitizable(Blob blob) {\n+        String mimeType = getMimetypeRegistry().getMimetypeFromFilenameWithBlobMimetypeFallback(blob.getFilename(), blob, null);\n+        boolean sanitized = false;\n+        if (mimeType == null) {\n+            try (InputStream stream = blob.getStream()) {\n+                // last chance introspect the content\n+                LineIterator lineIt = IOUtils.lineIterator(stream, defaultIfNull(blob.getEncoding(), \"UTF-8\"));\n+                while (lineIt.hasNext()) {", "originalCommit": "fc37e894b628162468872e2b2e5852361d0a8e7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI1NDcyMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547254720", "bodyText": "Yes it is possible if we don't succeed to detect the mime type. This piece of code is there to handle xml files, because the mime type registry doesn't recognize them due to its ambiguous definition.\nDo you see another way to do this?", "author": "kevinleturc", "createdAt": "2020-12-22T12:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI1MDk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI1NzEwMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547257102", "bodyText": "I don't see another way if we can't detect the type, we have to read it manually.", "author": "efge", "createdAt": "2020-12-22T12:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI1MDk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI1MTI0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547251245", "bodyText": "You could return directly here, no need for a local sanitized variable (which I'd have called sanitizable)", "author": "efge", "createdAt": "2020-12-22T12:31:02Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(\"text/html\", \"text/xml\", \"text/plain\");\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");\n+        }\n+\n+        try {\n+            BlobHolder result = conversionService.convert(converterName, new SimpleBlobHolder(blob), null);\n+            List<Blob> blobs = new ArrayList<>(result.getBlobs());\n+            blobs.replaceAll(this::sanitize);\n+            return blobs;\n+        } catch (ConversionException e) {\n+            throw new PreviewException(e.getMessage(), e);\n+        }\n+    }\n+\n+    protected Blob sanitize(Blob blob) throws PreviewException {\n+        String filename = blob.getFilename();\n+        if (!isSanitizable(blob)) {\n+            log.debug(\"ZipEntryBlob: {} is not sanitizable\", filename);\n+            return blob;\n+        }\n+        try {\n+            String content = blob.getString();\n+            content = getHtmlSanitizerService().sanitizeString(content, null);\n+            content = PreviewHelper.makeHtmlPage(content);\n+            return Blobs.createBlob(content, \"text/html\", \"UTF-8\", filename);\n+        } catch (IOException e) {\n+            throw new PreviewException(\"Cannot fetch ZipEntryBlob content with filename: \" + filename, e);\n+        }\n+    }\n+\n+    protected boolean isSanitizable(Blob blob) {\n+        String mimeType = getMimetypeRegistry().getMimetypeFromFilenameWithBlobMimetypeFallback(blob.getFilename(), blob, null);\n+        boolean sanitized = false;\n+        if (mimeType == null) {\n+            try (InputStream stream = blob.getStream()) {\n+                // last chance introspect the content\n+                LineIterator lineIt = IOUtils.lineIterator(stream, defaultIfNull(blob.getEncoding(), \"UTF-8\"));\n+                while (lineIt.hasNext()) {\n+                    String line = lineIt.nextLine();\n+                    sanitized = line.contains(\"<script\");\n+                    if (sanitized) {\n+                        break;\n+                    }", "originalCommit": "fc37e894b628162468872e2b2e5852361d0a8e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afd465c3c8ca2e2e3d80fd01f6a9da33e5cbf01b", "url": "https://github.com/nuxeo/nuxeo/commit/afd465c3c8ca2e2e3d80fd01f6a9da33e5cbf01b", "message": "NXP-29991: Better zip preview", "committedDate": "2020-12-22T13:18:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI5Nzk4Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547297986", "bodyText": "Zip blobs", "author": "ataillefer", "createdAt": "2020-12-22T14:09:30Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static javax.ws.rs.core.MediaType.TEXT_HTML;\n+import static javax.ws.rs.core.MediaType.TEXT_PLAIN;\n+import static javax.ws.rs.core.MediaType.TEXT_XML;\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.", "originalCommit": "afd465c3c8ca2e2e3d80fd01f6a9da33e5cbf01b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI5OTUxNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547299515", "bodyText": "maybe a more generic message like \"Unable to find converter from application/zip to text/html\"", "author": "ataillefer", "createdAt": "2020-12-22T14:12:40Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static javax.ws.rs.core.MediaType.TEXT_HTML;\n+import static javax.ws.rs.core.MediaType.TEXT_PLAIN;\n+import static javax.ws.rs.core.MediaType.TEXT_XML;\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(TEXT_HTML, TEXT_XML, TEXT_PLAIN);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");", "originalCommit": "afd465c3c8ca2e2e3d80fd01f6a9da33e5cbf01b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwMjMxMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547302312", "bodyText": "Any point using streams here?", "author": "ataillefer", "createdAt": "2020-12-22T14:18:05Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static javax.ws.rs.core.MediaType.TEXT_HTML;\n+import static javax.ws.rs.core.MediaType.TEXT_PLAIN;\n+import static javax.ws.rs.core.MediaType.TEXT_XML;\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(TEXT_HTML, TEXT_XML, TEXT_PLAIN);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");\n+        }\n+\n+        try {\n+            BlobHolder result = conversionService.convert(converterName, new SimpleBlobHolder(blob), null);\n+            List<Blob> blobs = new ArrayList<>(result.getBlobs());\n+            blobs.replaceAll(this::sanitize);\n+            return blobs;", "originalCommit": "afd465c3c8ca2e2e3d80fd01f6a9da33e5cbf01b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMxNTAwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547315006", "bodyText": "Yes, we save some lines, I'll change it to Stream.", "author": "kevinleturc", "createdAt": "2020-12-22T14:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwMjMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwODMyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547308329", "bodyText": "can this happen?", "author": "ataillefer", "createdAt": "2020-12-22T14:29:02Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static javax.ws.rs.core.MediaType.TEXT_HTML;\n+import static javax.ws.rs.core.MediaType.TEXT_PLAIN;\n+import static javax.ws.rs.core.MediaType.TEXT_XML;\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(TEXT_HTML, TEXT_XML, TEXT_PLAIN);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");\n+        }\n+\n+        try {\n+            BlobHolder result = conversionService.convert(converterName, new SimpleBlobHolder(blob), null);\n+            List<Blob> blobs = new ArrayList<>(result.getBlobs());\n+            blobs.replaceAll(this::sanitize);\n+            return blobs;\n+        } catch (ConversionException e) {\n+            throw new PreviewException(e.getMessage(), e);\n+        }\n+    }\n+\n+    protected Blob sanitize(Blob blob) {\n+        String filename = blob.getFilename();\n+        if (!isSanitizable(blob)) {\n+            log.debug(\"ZipEntryBlob: {} is not sanitizable\", filename);\n+            return blob;\n+        }\n+        try {\n+            String content = blob.getString();\n+            content = getHtmlSanitizerService().sanitizeString(content, null);\n+            content = PreviewHelper.makeHtmlPage(content);\n+            return Blobs.createBlob(content, \"text/html\", null, filename);\n+        } catch (IOException e) {\n+            throw new PreviewException(\"Cannot read ZipEntryBlob content with filename: \" + filename, e);\n+        }\n+    }\n+\n+    protected boolean isSanitizable(Blob blob) {\n+        String mimeType = getMimetypeRegistry().getMimetypeFromFilenameWithBlobMimetypeFallback(blob.getFilename(),\n+                blob, null);\n+        if (mimeType == null) {\n+            try (InputStream stream = blob.getStream()) {\n+                // last chance introspect the content\n+                LineIterator lineIt = IOUtils.lineIterator(stream, defaultIfNull(blob.getEncoding(), \"UTF-8\"));\n+                while (lineIt.hasNext()) {\n+                    String line = lineIt.nextLine();\n+                    if (line.contains(\"<script\")) {\n+                        return true;\n+                    }\n+                }\n+                return false;\n+            } catch (IOException e) {\n+                throw new PreviewException(\"Unable to introspect content\");\n+            }\n+        } else {\n+            return HTML_MIME_TYPES.contains(mimeType);\n+        }\n+    }\n+\n+    protected MimetypeRegistry getMimetypeRegistry() {\n+        MimetypeRegistry registry = Framework.getService(MimetypeRegistry.class);\n+        if (registry == null) {", "originalCommit": "afd465c3c8ca2e2e3d80fd01f6a9da33e5cbf01b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyMzQzMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547323432", "bodyText": "Probably not. I will remove them.", "author": "kevinleturc", "createdAt": "2020-12-22T14:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwODMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwODQzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4552#discussion_r547308437", "bodyText": "same question", "author": "ataillefer", "createdAt": "2020-12-22T14:29:12Z", "path": "modules/platform/nuxeo-preview-core/src/main/java/org/nuxeo/ecm/platform/preview/adapter/ZipPreviewer.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Kevin Leturc <kleturc@nuxeo.com>\n+ */\n+package org.nuxeo.ecm.platform.preview.adapter;\n+\n+import static javax.ws.rs.core.MediaType.TEXT_HTML;\n+import static javax.ws.rs.core.MediaType.TEXT_PLAIN;\n+import static javax.ws.rs.core.MediaType.TEXT_XML;\n+import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.nuxeo.ecm.core.api.Blob;\n+import org.nuxeo.ecm.core.api.Blobs;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.blobholder.BlobHolder;\n+import org.nuxeo.ecm.core.api.blobholder.SimpleBlobHolder;\n+import org.nuxeo.ecm.core.convert.api.ConversionException;\n+import org.nuxeo.ecm.core.convert.api.ConversionService;\n+import org.nuxeo.ecm.platform.htmlsanitizer.HtmlSanitizerService;\n+import org.nuxeo.ecm.platform.mimetype.interfaces.MimetypeRegistry;\n+import org.nuxeo.ecm.platform.preview.api.PreviewException;\n+import org.nuxeo.ecm.platform.preview.helper.PreviewHelper;\n+import org.nuxeo.runtime.api.Framework;\n+\n+/**\n+ * Previewer for Zip blob.\n+ * <p>\n+ * It sanitizes each zip entry if needed.\n+ *\n+ * @since 11.5\n+ */\n+public class ZipPreviewer implements MimeTypePreviewer {\n+\n+    private static final Logger log = LogManager.getLogger(ZipPreviewer.class);\n+\n+    protected static final Set<String> HTML_MIME_TYPES = Set.of(TEXT_HTML, TEXT_XML, TEXT_PLAIN);\n+\n+    @Override\n+    public List<Blob> getPreview(Blob blob, DocumentModel dm) throws PreviewException {\n+        ConversionService conversionService = Framework.getService(ConversionService.class);\n+        String converterName = conversionService.getConverterName(\"application/zip\", \"text/html\");\n+        if (converterName == null) {\n+            throw new PreviewException(\"Unable to find zip2html converter\");\n+        }\n+\n+        try {\n+            BlobHolder result = conversionService.convert(converterName, new SimpleBlobHolder(blob), null);\n+            List<Blob> blobs = new ArrayList<>(result.getBlobs());\n+            blobs.replaceAll(this::sanitize);\n+            return blobs;\n+        } catch (ConversionException e) {\n+            throw new PreviewException(e.getMessage(), e);\n+        }\n+    }\n+\n+    protected Blob sanitize(Blob blob) {\n+        String filename = blob.getFilename();\n+        if (!isSanitizable(blob)) {\n+            log.debug(\"ZipEntryBlob: {} is not sanitizable\", filename);\n+            return blob;\n+        }\n+        try {\n+            String content = blob.getString();\n+            content = getHtmlSanitizerService().sanitizeString(content, null);\n+            content = PreviewHelper.makeHtmlPage(content);\n+            return Blobs.createBlob(content, \"text/html\", null, filename);\n+        } catch (IOException e) {\n+            throw new PreviewException(\"Cannot read ZipEntryBlob content with filename: \" + filename, e);\n+        }\n+    }\n+\n+    protected boolean isSanitizable(Blob blob) {\n+        String mimeType = getMimetypeRegistry().getMimetypeFromFilenameWithBlobMimetypeFallback(blob.getFilename(),\n+                blob, null);\n+        if (mimeType == null) {\n+            try (InputStream stream = blob.getStream()) {\n+                // last chance introspect the content\n+                LineIterator lineIt = IOUtils.lineIterator(stream, defaultIfNull(blob.getEncoding(), \"UTF-8\"));\n+                while (lineIt.hasNext()) {\n+                    String line = lineIt.nextLine();\n+                    if (line.contains(\"<script\")) {\n+                        return true;\n+                    }\n+                }\n+                return false;\n+            } catch (IOException e) {\n+                throw new PreviewException(\"Unable to introspect content\");\n+            }\n+        } else {\n+            return HTML_MIME_TYPES.contains(mimeType);\n+        }\n+    }\n+\n+    protected MimetypeRegistry getMimetypeRegistry() {\n+        MimetypeRegistry registry = Framework.getService(MimetypeRegistry.class);\n+        if (registry == null) {\n+            throw new PreviewException(\"Cannot find MimetypeRegistry\");\n+        }\n+        return registry;\n+    }\n+\n+    protected HtmlSanitizerService getHtmlSanitizerService() {\n+        HtmlSanitizerService sanitizer = Framework.getService(HtmlSanitizerService.class);", "originalCommit": "afd465c3c8ca2e2e3d80fd01f6a9da33e5cbf01b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de49903e105abe88c3e1151ad028be42632be977", "url": "https://github.com/nuxeo/nuxeo/commit/de49903e105abe88c3e1151ad028be42632be977", "message": "NXP-29991: Better zip preview", "committedDate": "2020-12-22T14:57:52Z", "type": "commit"}, {"oid": "de49903e105abe88c3e1151ad028be42632be977", "url": "https://github.com/nuxeo/nuxeo/commit/de49903e105abe88c3e1151ad028be42632be977", "message": "NXP-29991: Better zip preview", "committedDate": "2020-12-22T14:57:52Z", "type": "forcePushed"}]}