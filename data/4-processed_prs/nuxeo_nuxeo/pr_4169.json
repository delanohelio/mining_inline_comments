{"pr_number": 4169, "pr_title": "NXP-29263: handle login links with anonymous user", "pr_createdAt": "2020-06-19T10:48:08Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4169", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc3Nzg4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4169#discussion_r442777884", "bodyText": "I'm not sure hardcoding /nuxeo is a good idea. I see other FTL files using Context.serverURL or doing <@extends src=\"base.ftl\"> then using basePath or Root.path. I'm not sure I'm not sure of the exact details but it's worth checking.", "author": "efge", "createdAt": "2020-06-19T11:06:02Z", "path": "modules/platform/nuxeo-apidoc-server/nuxeo-apidoc-webengine/src/main/resources/skin/nxlogin.ftl", "diffHunk": "@@ -1,88 +1,6 @@\n-<script>\n-\n-function doLogout() {\n-  jQuery.cookie(\"JSESSIONID\", null, {path: \"/\"});\n-  jQuery.post(\"${Context.loginPath}\", {caller: \"login\", nuxeo_login : \"true\"});\n-}\n-\n-function doLogin(username, password) {\n-  //jQuery.cookie(\"JSESSIONID\", null, {path: \"/\"});\n-  //req = jQuery.post(document.location.pathname, {nuxeo_login : \"true\", userid : username, password : password});\n-  var result = false;\n-  var req = jQuery.ajax({\n-    type: \"POST\",\n-    async: false,\n-    url: \"${Context.loginPath}\",\n-    data: {caller: \"login\", nuxeo_login : \"true\", username : username, password : password},\n-    success: function(html, status) {\n-      document.location.reload();\n-      result = true;\n-    },\n-    error: function(html, status) {\n-      result = html.status != 401;\n-    }\n-  });\n-  return result;\n-}\n-\n-function showLoginError(errtext) {\n-  logstate = $('#logstate');\n-  if (errtext != null) {\n-    errmsg = \"Login Error: \" + errtext;\n-  } else {\n-    errmsg = errtext;\n-  }\n-  logstate.html(errmsg);\n-  logstate.css({color: 'red'});\n-}\n-\n-$(document).ready(function() {\n-\n-    $('#logout').click( function() {\n-      doLogout();\n-    });\n-\n-    $('#username').focus( function() {\n-      if (this.value == 'Username') {\n-        this.value = \"\";\n-      }\n-    });\n-\n-    $('#password').focus( function() {\n-      if (this.value == 'password') {\n-        this.value = \"\";\n-      }\n-    });\n-\n-    $('#login_form').submit(function() {\n-      username = $('#username')[0].value;\n-      password = $('#password')[0].value;\n-\n-      if (username == null || password == null) {\n-        showLoginError(\"Username and Password fields have to be filled in.\");\n-        return false;\n-      }\n-\n-      loggedin = doLogin(username, password);\n-      if (!loggedin) {\n-        //login failed\n-        showLoginError(\"Username or password incorrect.\");\n-      }\n-      return false;\n-    });\n-\n-  });\n-</script>\n-\n-<#if (Context.principal.isAnonymous())>\n-<!--\n-    <form id=\"login_form\" method=\"post\" action=\"#\">\n-      <input type=\"text\" name=\"userid\" id=\"username\" value=\"login\" size=\"15\" onfocus=\"if (this.value=='login') this.value=''\" onblur=\"if (this.value=='') this.value='login'\">\n-      <input type=\"password\" name=\"password\" id=\"password\" value=\"password\" size=\"15\" onfocus=\"if (this.value=='password') this.value=''\" onblur=\"if (this.value=='') this.value='password'\">\n-      <input type=\"submit\" name=\"nuxeo_login\" value=\"Ok\" id=\"login\" class=\"button\">\n-    </form>\n--->\n+<#if Context.principal.isAnonymous()>\n+  <a href=\"/nuxeo/login.jsp?forceAnonymousLogin=true&requestedUrl=${Root.path}\" id=\"login\">Login</a>\n <#else>\n-  <div class=\"logout\"><span id=\"logstate\">${Context.principal.name}</span>\n-  <a href=\"\" id=\"logout\">Logout</a></div>\n+  <span id=\"logstate\">${Context.principal.name}</span>\n+  <a href=\"/nuxeo/logout\" id=\"logout\">Logout</a>", "originalCommit": "b33ea6582113f9b84b32fb04d31ad49b2c627ece", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1fca8720b17a7ace25a915682ef34215631b894e", "url": "https://github.com/nuxeo/nuxeo/commit/1fca8720b17a7ace25a915682ef34215631b894e", "message": "NXP-29263: handle login links with anonymous user", "committedDate": "2020-06-22T09:15:05Z", "type": "commit"}, {"oid": "0c8973264b0e06728285a01d9237428ed50099b7", "url": "https://github.com/nuxeo/nuxeo/commit/0c8973264b0e06728285a01d9237428ed50099b7", "message": "NXP-29263: do not hardcode the webapp name", "committedDate": "2020-06-22T09:15:05Z", "type": "commit"}, {"oid": "0c8973264b0e06728285a01d9237428ed50099b7", "url": "https://github.com/nuxeo/nuxeo/commit/0c8973264b0e06728285a01d9237428ed50099b7", "message": "NXP-29263: do not hardcode the webapp name", "committedDate": "2020-06-22T09:15:05Z", "type": "forcePushed"}]}