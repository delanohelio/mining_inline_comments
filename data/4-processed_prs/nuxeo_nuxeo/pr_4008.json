{"pr_number": 4008, "pr_title": "NXP-28798: Gracefully log missing DocumentRoutes", "pr_createdAt": "2020-05-05T17:51:18Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4008", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwMjYyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420302623", "bodyText": "If you want to log the stack trace you need log.error(e, e).\nIf you don't, please add a comment saying so because it's surprising to hide it.", "author": "efge", "createdAt": "2020-05-05T18:00:40Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -219,6 +224,9 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n \n                 jg.writeEndObject();\n             }\n+        } catch (DocumentNotFoundException e) {\n+            // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.\n+            log.error(e);", "originalCommit": "cb9bbbae1bc29ffae3bb8011b875b8651927473b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwNTcyMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420305720", "bodyText": "Yes no special reason to hide the stack! Fixed!", "author": "NourNuxeo", "createdAt": "2020-05-05T18:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMwMjYyMw=="}], "type": "inlineReview"}, {"oid": "242974b82be90e4da47a3742b1055151d85c636b", "url": "https://github.com/nuxeo/nuxeo/commit/242974b82be90e4da47a3742b1055151d85c636b", "message": "NXP-28798: Gracefully log missing document routs", "committedDate": "2020-05-05T18:07:18Z", "type": "forcePushed"}, {"oid": "a875bf2a02bafa3d8935390a0c386216164d46cd", "url": "https://github.com/nuxeo/nuxeo/commit/a875bf2a02bafa3d8935390a0c386216164d46cd", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-05T18:58:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420352453", "bodyText": "If a sysadmin can't do much about it and the application can keep functioning, I'd prefer a WARN.\nAlso where is the exception being thrown exactly? Could you add a full stack trace in the NXP ticket please. I'm asking because the try/catch has a very large scope, which is bad if we can have a smaller one.\nFrom a quick test it seems to appear in nodeAccessRunner.runUnrestricted() so the try/catch should be around that, and you should log.warn(\"Failed to get workflow instance\", e)", "author": "efge", "createdAt": "2020-05-05T19:26:11Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -219,6 +224,9 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n \n                 jg.writeEndObject();\n             }\n+        } catch (DocumentNotFoundException e) {\n+            // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.\n+            log.error(e, e);", "originalCommit": "a875bf2a02bafa3d8935390a0c386216164d46cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MDU1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420460550", "bodyText": "Making it a warn and updating the ticket!\nYes indeed, I just catched there because there was already a try clause and because I was certain about the context this is called in (by context I mean while writing a task to json). The UnrestrictedSessionRunner.runUnrestricted() is called in so many places I didn't want to catch in it.\nI could also make a sub try catch around the nodeAccessRunner.runUnrestricted();call in TaskWriter.writeEntityBody() line 116. to make sure I only catch errors on the runUnrestricted().\nAt first I wanted to avoid doing a sub try catch.", "author": "NourNuxeo", "createdAt": "2020-05-05T23:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwOTI0NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420509244", "bodyText": "Yes I mean around the call to nodeAccessRunner.runUnrestricted at line 116. It helps the reader to know where the exception can come from.", "author": "efge", "createdAt": "2020-05-06T02:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3MzYyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420573629", "bodyText": "Done!", "author": "NourNuxeo", "createdAt": "2020-05-06T06:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYyMDY2Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420620662", "bodyText": "After moving the catch, now the faulty task contains more info in the response. I have updated the jira ticket with a response containing a corrupted task first and then a well formed one. Also Kevin has identified some issues we'd like to have your opinion about: #4008 (comment)", "author": "NourNuxeo", "createdAt": "2020-05-06T08:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MjQ1Mw=="}], "type": "inlineReview"}, {"oid": "cf17228d10bda9b5de0422fe7e35979c73a6c9d1", "url": "https://github.com/nuxeo/nuxeo/commit/cf17228d10bda9b5de0422fe7e35979c73a6c9d1", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-05T23:11:39Z", "type": "forcePushed"}, {"oid": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "url": "https://github.com/nuxeo/nuxeo/commit/05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-06T06:39:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4NDA3Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420584073", "bodyText": "Why not fixing the root cause in NodeAccessRunner instead of catching?", "author": "kevinleturc", "createdAt": "2020-05-06T07:06:48Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -108,7 +113,12 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n             if (StringUtils.isNotBlank(workflowInstanceId)) {\n                 NodeAccessRunner nodeAccessRunner = new NodeAccessRunner(wrapper.getSession(), workflowInstanceId,\n                         nodeId);\n-                nodeAccessRunner.runUnrestricted();\n+                try {\n+                    nodeAccessRunner.runUnrestricted();", "originalCommit": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYxODQ0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r420618445", "bodyText": "As we discussed on slack the root cause is a DocumentNotFound exception we can only catch where we need to.\nWe have identified other issues as well:\n\nthe NodeAccessRunner is also called by org.nuxeo.ecm.platform.routing.core.io.TaskCompletionRequestJsonReader.readEntity(JsonNode)\nWhen we list the tasks, corrupted tasks show, but obviously miss information, which we may want to avoid in the UI.\nHere is a sample response with a first corrupted task and a well formed task:\nhttps://jira.nuxeo.com/browse/NXP-28798?focusedCommentId=453928&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-453928", "author": "NourNuxeo", "createdAt": "2020-05-06T08:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4NDA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421499410", "bodyText": "As @efge said in one of his comments, you should log something meaningful if possible:\nlog.warn(\"Failed to get workflow instance\", e)\n\nBTW, do we want the whole stack trace for a WARN? (cc @kevinleturc)", "author": "troger", "createdAt": "2020-05-07T13:23:08Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -108,7 +113,12 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n             if (StringUtils.isNotBlank(workflowInstanceId)) {\n                 NodeAccessRunner nodeAccessRunner = new NodeAccessRunner(wrapper.getSession(), workflowInstanceId,\n                         nodeId);\n-                nodeAccessRunner.runUnrestricted();\n+                try {\n+                    nodeAccessRunner.runUnrestricted();\n+                } catch (DocumentNotFoundException e) {\n+                    // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.\n+                    log.warn(e, e);", "originalCommit": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwNDkzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421504935", "bodyText": "I would say no as this is a valid error case, I'm wondering if we still want it behind a debug/trace level.", "author": "kevinleturc", "createdAt": "2020-05-07T13:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE1NjE5Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r425156196", "bodyText": "So a simple:\nlog.warn(\"Failed to get workflow instance: {}\", workflowInstanceId);\nlog.debug(e, e);\n\n?", "author": "troger", "createdAt": "2020-05-14T13:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4NzI4NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r425187285", "bodyText": "Looks good \ud83d\udc4d", "author": "kevinleturc", "createdAt": "2020-05-14T14:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ5OTQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMDQ5NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421500494", "bodyText": "The comment is not accurate, the TaskWriter does not fail anymore with your fix. Keep it simple...\n// Workflow instance not found\n\nI'm not sure it's even needed according to the DocumentNotFoundException and the log message?", "author": "troger", "createdAt": "2020-05-07T13:24:39Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.java", "diffHunk": "@@ -108,7 +113,12 @@ public void writeEntityBody(Task item, JsonGenerator jg) throws IOException {\n             if (StringUtils.isNotBlank(workflowInstanceId)) {\n                 NodeAccessRunner nodeAccessRunner = new NodeAccessRunner(wrapper.getSession(), workflowInstanceId,\n                         nodeId);\n-                nodeAccessRunner.runUnrestricted();\n+                try {\n+                    nodeAccessRunner.runUnrestricted();\n+                } catch (DocumentNotFoundException e) {\n+                    // If the DocumentRoute is not found (deleted for example), the TaskWriter fails.", "originalCommit": "05f3fc68aeed664c0c0f8ebf306cae1be4682c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMjc3Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r421502776", "bodyText": "At the begining the catch was at the end of the try resource (way more line below) so I explained why I was catching.\nI should have removed it when I made a very local try catch", "author": "NourNuxeo", "createdAt": "2020-05-07T13:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUwMDQ5NA=="}], "type": "inlineReview"}, {"oid": "19e6e7255150b49435aad16f49bd344eac6e9f96", "url": "https://github.com/nuxeo/nuxeo/commit/19e6e7255150b49435aad16f49bd344eac6e9f96", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-07T13:48:32Z", "type": "forcePushed"}, {"oid": "53cdce0b4a8c15ca319b9416037f3d95b38ed2ca", "url": "https://github.com/nuxeo/nuxeo/commit/53cdce0b4a8c15ca319b9416037f3d95b38ed2ca", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-07T13:49:41Z", "type": "forcePushed"}, {"oid": "32b83de855f85bcc38b0e397b5bce412996b19a6", "url": "https://github.com/nuxeo/nuxeo/commit/32b83de855f85bcc38b0e397b5bce412996b19a6", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-12T16:51:43Z", "type": "forcePushed"}, {"oid": "95fb469720cd0cd415e5b81fa2a4e258605a430f", "url": "https://github.com/nuxeo/nuxeo/commit/95fb469720cd0cd415e5b81fa2a4e258605a430f", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-12T16:56:28Z", "type": "forcePushed"}, {"oid": "6d6596b558ea5ac0a7f0923622370e07892ac840", "url": "https://github.com/nuxeo/nuxeo/commit/6d6596b558ea5ac0a7f0923622370e07892ac840", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T08:36:55Z", "type": "forcePushed"}, {"oid": "39494bd67fbab7001d5214e717042db144b058d8", "url": "https://github.com/nuxeo/nuxeo/commit/39494bd67fbab7001d5214e717042db144b058d8", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T08:57:28Z", "type": "forcePushed"}, {"oid": "f1931077add39813fe3deb98bf5e1bf11325d194", "url": "https://github.com/nuxeo/nuxeo/commit/f1931077add39813fe3deb98bf5e1bf11325d194", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T09:20:22Z", "type": "forcePushed"}, {"oid": "959e893f1bb40a6f3e7f56f9cefada415135c9f4", "url": "https://github.com/nuxeo/nuxeo/commit/959e893f1bb40a6f3e7f56f9cefada415135c9f4", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-13T09:26:56Z", "type": "forcePushed"}, {"oid": "da7342e0dd54288c63073fec57ff57354199d979", "url": "https://github.com/nuxeo/nuxeo/commit/da7342e0dd54288c63073fec57ff57354199d979", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-14T15:10:59Z", "type": "forcePushed"}, {"oid": "cd73c8ec7730004f97985eef288e71c74bf9e3ff", "url": "https://github.com/nuxeo/nuxeo/commit/cd73c8ec7730004f97985eef288e71c74bf9e3ff", "message": "NXP-28798: Gracefully log missing DocumentRoutes", "committedDate": "2020-05-14T15:12:47Z", "type": "commit"}, {"oid": "a455f292f864a07f7e93239027de1611254f891c", "url": "https://github.com/nuxeo/nuxeo/commit/a455f292f864a07f7e93239027de1611254f891c", "message": "NXP-28798: Provide a Task GC script", "committedDate": "2020-05-14T15:13:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyODg4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r426428887", "bodyText": "There's still an interrogation about committing this script or not.", "author": "kevinleturc", "createdAt": "2020-05-18T07:46:29Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MDM0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427960346", "bodyText": "Checked with @tmartins ans he is OK committing the script there \ud83d\ude03", "author": "troger", "createdAt": "2020-05-20T12:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyODg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MTE2Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427961167", "bodyText": "Could you rename the script to match the already existing one (consistency)? Such as deleteOrphanTasks.groovy.", "author": "troger", "createdAt": "2020-05-20T12:16:28Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MTY0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427961646", "bodyText": "Even if it's not mandatory, could you take the habit to declare your vars at least with def if you don't want to type them?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            log = LogManager.getLogger(\"taskGC.groovy\")\n          \n          \n            \n            def log = LogManager.getLogger(\"taskGC.groovy\")\n          \n      \n    \n    \n  \n\nSame for all vars in the script.", "author": "troger", "createdAt": "2020-05-20T12:17:23Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MzM4NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427963385", "bodyText": "I'm just wondering, is 500 not too much as batch size to avoid transaction timeout? Or could it be increased? Or 500 is just fine :)\n@kevinleturc @bdelbosc ?", "author": "troger", "createdAt": "2020-05-20T12:20:23Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")\n+nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+dryRun = true\n+session = Context.getCoreSession()\n+ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk3NTE0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427975141", "bodyText": "500 is the default we put everywhere, it looks like a good default.\nI think we always increase it when it comes to production.", "author": "kevinleturc", "createdAt": "2020-05-20T12:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MzM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2NDk1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427964952", "bodyText": "Can't we use the same as in Java?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.info(\"removing orphan task \" + id)\n          \n          \n            \n                        log.info(\"removing orphan task: {}\", id)", "author": "troger", "createdAt": "2020-05-20T12:22:27Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")\n+nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+dryRun = true\n+session = Context.getCoreSession()\n+ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+bucketCount = 0\n+documentCount = 0\n+\n+while (scrollResult.hasResults()) {\n+    documentCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for(id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())\n+        if(!cache.computeIfAbsent(workflowRef, session.&exists)) {\n+            log.info(\"removing orphan task \" + id)", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2ODAxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427968016", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                for(id in scrollResult.getResults()) {\n          \n          \n            \n                for (id in scrollResult.getResults()) {", "author": "troger", "createdAt": "2020-05-20T12:27:10Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")\n+nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+dryRun = true\n+session = Context.getCoreSession()\n+ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+bucketCount = 0\n+documentCount = 0\n+\n+while (scrollResult.hasResults()) {\n+    documentCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for(id in scrollResult.getResults()) {", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2ODA3OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427968079", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!cache.computeIfAbsent(workflowRef, session.&exists)) {\n          \n          \n            \n                    if (!cache.computeIfAbsent(workflowRef, session.&exists)) {", "author": "troger", "createdAt": "2020-05-20T12:27:16Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")\n+nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+dryRun = true\n+session = Context.getCoreSession()\n+ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+bucketCount = 0\n+documentCount = 0\n+\n+while (scrollResult.hasResults()) {\n+    documentCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for(id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())\n+        if(!cache.computeIfAbsent(workflowRef, session.&exists)) {", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2OTg0OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427969849", "bodyText": "Either use it or just remove those variables.", "author": "troger", "createdAt": "2020-05-20T12:29:51Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")\n+nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+dryRun = true\n+session = Context.getCoreSession()\n+ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+bucketCount = 0\n+documentCount = 0", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzMDgwMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428030801", "bodyText": "Added a removedCount instead of bucketCount\nI log at the end:\nlog.info(\"removed {} out of {} tasks\", removedCount, documentCount)", "author": "NourNuxeo", "createdAt": "2020-05-20T13:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2OTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3NzkyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428077923", "bodyText": "Name it taskCount maybe so? :p", "author": "troger", "createdAt": "2020-05-20T14:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2OTg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5MzA5Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428093093", "bodyText": "there you go", "author": "NourNuxeo", "createdAt": "2020-05-20T15:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2OTg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk3MTA3Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427971077", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if(!dryRun) {\n          \n          \n            \n                        if (!dryRun) {", "author": "troger", "createdAt": "2020-05-20T12:31:59Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")\n+nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+dryRun = true\n+session = Context.getCoreSession()\n+ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+bucketCount = 0\n+documentCount = 0\n+\n+while (scrollResult.hasResults()) {\n+    documentCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for(id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())\n+        if(!cache.computeIfAbsent(workflowRef, session.&exists)) {\n+            log.info(\"removing orphan task \" + id)\n+            if(!dryRun) {", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk3MTM3Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r427971376", "bodyText": "You are always logging this, dry run or not, it could be misleading while reading the logs :)", "author": "troger", "createdAt": "2020-05-20T12:32:31Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/taskGC.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+log = LogManager.getLogger(\"taskGC.groovy\")\n+nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+dryRun = true\n+session = Context.getCoreSession()\n+ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+bucketCount = 0\n+documentCount = 0\n+\n+while (scrollResult.hasResults()) {\n+    documentCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for(id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())\n+        if(!cache.computeIfAbsent(workflowRef, session.&exists)) {\n+            log.info(\"removing orphan task \" + id)", "originalCommit": "a455f292f864a07f7e93239027de1611254f891c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzNDI1Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428034257", "bodyText": "Then I will do 2 different logs \"would remove...\" and since we have 2 explicit cases I now check dryRun rather than !dryRyn", "author": "NourNuxeo", "createdAt": "2020-05-20T13:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk3MTM3Ng=="}], "type": "inlineReview"}, {"oid": "479fce0e5c4917e0b22dfab4f93649494cabce4d", "url": "https://github.com/nuxeo/nuxeo/commit/479fce0e5c4917e0b22dfab4f93649494cabce4d", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T14:19:03Z", "type": "forcePushed"}, {"oid": "547ad04d66709304d92307555f1794058aa83e94", "url": "https://github.com/nuxeo/nuxeo/commit/547ad04d66709304d92307555f1794058aa83e94", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T14:20:39Z", "type": "forcePushed"}, {"oid": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "url": "https://github.com/nuxeo/nuxeo/commit/1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T15:13:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3OTg2MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428079861", "bodyText": "This probably needs to be renamed, if it was to match the script name?", "author": "troger", "createdAt": "2020-05-20T14:55:42Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+def log = LogManager.getLogger(\"taskGC.groovy\")", "originalCommit": "547ad04d66709304d92307555f1794058aa83e94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwMDEyMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428100121", "bodyText": "Yes, since it's a String and doesn't fail, I missed that one !", "author": "NourNuxeo", "createdAt": "2020-05-20T15:22:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3OTg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NjgzMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428096833", "bodyText": "You probably could merge both logs...\nlog.info(\"End deleting orphan tasks, removed {} out of {} tasks\", ...)", "author": "troger", "createdAt": "2020-05-20T15:17:42Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+def log = LogManager.getLogger(\"taskGC.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for (id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())\n+        if (!cache.computeIfAbsent(workflowRef, session.&exists)) {\n+            if (dryRun) {\n+                log.info(\"would remove orphan task: {}\", id)\n+            } else {\n+                log.info(\"removing orphan task: {}\", id)\n+                session.removeDocument(new IdRef(id))\n+                removedCount += 1\n+            }\n+        }\n+    }\n+    scrollResult = session.scroll(scrollResult.getScrollId())\n+    TransactionHelper.commitOrRollbackTransaction()\n+    TransactionHelper.startTransaction()\n+}\n+\n+log.info(\"Finished deleting orphan tasks\")\n+log.info(\"removed {} out of {} tasks\", removedCount, taskCount)", "originalCommit": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NjkxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428096910", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.info(\"would remove orphan task: {}\", id)\n          \n          \n            \n                            log.info(\"Would remove orphan task: {}\", id)", "author": "troger", "createdAt": "2020-05-20T15:17:48Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+def log = LogManager.getLogger(\"taskGC.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for (id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())\n+        if (!cache.computeIfAbsent(workflowRef, session.&exists)) {\n+            if (dryRun) {\n+                log.info(\"would remove orphan task: {}\", id)", "originalCommit": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NzAwOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428097009", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.info(\"removing orphan task: {}\", id)\n          \n          \n            \n                            log.info(\"Removing orphan task: {}\", id)", "author": "troger", "createdAt": "2020-05-20T15:17:56Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+def log = LogManager.getLogger(\"taskGC.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for (id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())\n+        if (!cache.computeIfAbsent(workflowRef, session.&exists)) {\n+            if (dryRun) {\n+                log.info(\"would remove orphan task: {}\", id)\n+            } else {\n+                log.info(\"removing orphan task: {}\", id)", "originalCommit": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NzI1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428097253", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                cache = new HashMap<IdRef>()\n          \n          \n            \n                def cache = new HashMap<IdRef>()", "author": "troger", "createdAt": "2020-05-20T15:18:16Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+def log = LogManager.getLogger(\"taskGC.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()", "originalCommit": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjYxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428106610", "bodyText": "Took the opportunity to declare cache in a groovy fashion and spare the Hashmap import", "author": "NourNuxeo", "createdAt": "2020-05-20T15:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NzI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NzUzOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428097538", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n          \n          \n            \n                    def task = session.getDocument(new IdRef(id)).getAdapter(Task.class)", "author": "troger", "createdAt": "2020-05-20T15:18:39Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+def log = LogManager.getLogger(\"taskGC.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for (id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)", "originalCommit": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NzY2Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r428097666", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    workflowRef = new IdRef(task.getProcessId())\n          \n          \n            \n                    def workflowRef = new IdRef(task.getProcessId())", "author": "troger", "createdAt": "2020-05-20T15:18:48Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,39 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+import java.util.HashMap\n+\n+def log = LogManager.getLogger(\"taskGC.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    cache = new HashMap<IdRef>()\n+    for (id in scrollResult.getResults()) {\n+        task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        workflowRef = new IdRef(task.getProcessId())", "originalCommit": "1ebd18e046ef9671cf4a9b7aa39f84ef82c1ec8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f54b65fe4cda0a66e4357dce4c373b92790fd34a", "url": "https://github.com/nuxeo/nuxeo/commit/f54b65fe4cda0a66e4357dce4c373b92790fd34a", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-05-20T15:29:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzA0Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r431663047", "bodyText": "Shouldn't we re-start the transaction before doing a new scroll?", "author": "troger", "createdAt": "2020-05-28T08:20:50Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,37 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+\n+def log = LogManager.getLogger(\"deleteOrphanTasks.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    def cache = [:]\n+    for (id in scrollResult.getResults()) {\n+        def task = session.getDocument(new IdRef(id)).getAdapter(Task.class)\n+        def workflowRef = new IdRef(task.getProcessId())\n+        if (!cache.computeIfAbsent(workflowRef, session.&exists)) {\n+            if (dryRun) {\n+                log.info(\"Would remove orphan task: {}\", id)\n+            } else {\n+                log.info(\"Removing orphan task: {}\", id)\n+                session.removeDocument(new IdRef(id))\n+                removedCount += 1\n+            }\n+        }\n+    }\n+    scrollResult = session.scroll(scrollResult.getScrollId())\n+    TransactionHelper.commitOrRollbackTransaction()\n+    TransactionHelper.startTransaction()", "originalCommit": "f54b65fe4cda0a66e4357dce4c373b92790fd34a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NDYyOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r431684628", "bodyText": "This is how it's done in org.nuxeo.ecm.core.BatchFinderWork.work() lines 88-90 (the code is old though)\nShouldn't the scroll be a snapshot that shouldn't be affected by the transaction ?", "author": "NourNuxeo", "createdAt": "2020-05-28T08:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzNzcxNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r435137714", "bodyText": "Tested it with a 1 bucket size and 2 tasks. Seems to be ok but in doubt i swapped the lines", "author": "NourNuxeo", "createdAt": "2020-06-04T10:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzA0Nw=="}], "type": "inlineReview"}, {"oid": "bcbd4b29bf6ab24ea93412f006b83e668da3939b", "url": "https://github.com/nuxeo/nuxeo/commit/bcbd4b29bf6ab24ea93412f006b83e668da3939b", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-04T09:55:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NDUyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r436694522", "bodyText": "Should be outside the while as we may want to reuse the cache when scrolling.", "author": "troger", "createdAt": "2020-06-08T13:21:27Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,37 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+\n+def log = LogManager.getLogger(\"deleteOrphanTasks.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()\n+    def cache = [:]", "originalCommit": "bcbd4b29bf6ab24ea93412f006b83e668da3939b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2OTk4OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r436769988", "bodyText": "doh", "author": "NourNuxeo", "createdAt": "2020-06-08T14:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NDUyMg=="}], "type": "inlineReview"}, {"oid": "60f843918ec32efa03c4992dc0fbf859c85ad9db", "url": "https://github.com/nuxeo/nuxeo/commit/60f843918ec32efa03c4992dc0fbf859c85ad9db", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-08T14:49:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIzMTc1OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r437231758", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            log.info(\"Starting deleting orphan tasks...\")\n          \n          \n            \n            log.info(\"Start deleting orphan tasks...\")", "author": "ataillefer", "createdAt": "2020-06-09T08:33:54Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,37 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+\n+def log = LogManager.getLogger(\"deleteOrphanTasks.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+def cache = [:]\n+\n+log.info(\"Starting deleting orphan tasks...\")", "originalCommit": "60f843918ec32efa03c4992dc0fbf859c85ad9db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIzMjA2NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4008#discussion_r437232065", "bodyText": "scrollResult.getResults() could be in a variable", "author": "ataillefer", "createdAt": "2020-06-09T08:34:24Z", "path": "server/nuxeo-nxr-server/src/main/resources/templates/common-base/client/scripts/deleteOrphanTasks.groovy", "diffHunk": "@@ -0,0 +1,37 @@\n+import org.apache.logging.log4j.LogManager\n+import org.nuxeo.ecm.platform.task.Task\n+import org.nuxeo.ecm.core.api.IdRef\n+import org.nuxeo.ecm.core.api.ScrollResult\n+import org.nuxeo.runtime.transaction.TransactionHelper\n+\n+def log = LogManager.getLogger(\"deleteOrphanTasks.groovy\")\n+def nxql = \"SELECT * FROM Document WHERE ecm:mixinType = 'Task'\"\n+def dryRun = true\n+def session = Context.getCoreSession()\n+def ScrollResult<String> scrollResult = session.scroll(nxql, 500, 60)\n+def removedCount = 0\n+def taskCount = 0\n+def cache = [:]\n+\n+log.info(\"Starting deleting orphan tasks...\")\n+while (scrollResult.hasResults()) {\n+    taskCount += scrollResult.getResults().size()", "originalCommit": "60f843918ec32efa03c4992dc0fbf859c85ad9db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "url": "https://github.com/nuxeo/nuxeo/commit/48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-09T10:36:18Z", "type": "commit"}, {"oid": "48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "url": "https://github.com/nuxeo/nuxeo/commit/48fa1a0049f4ec36f9a3d002ff80bfbc081a39fe", "message": "NXP-28798: Provide a deleteOrphanTasks.groovy script", "committedDate": "2020-06-09T10:36:18Z", "type": "forcePushed"}]}