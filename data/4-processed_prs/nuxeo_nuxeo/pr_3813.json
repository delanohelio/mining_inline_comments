{"pr_number": 3813, "pr_title": "10.10-HF/fix-NXP-28727-Document-created-under-a-placeless-document-is-placeless-too", "pr_createdAt": "2020-03-05T02:30:10Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3813", "timeline": [{"oid": "817088b66c4a994a33068f7eec840900f5992b21", "url": "https://github.com/nuxeo/nuxeo/commit/817088b66c4a994a33068f7eec840900f5992b21", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-05T08:43:23Z", "type": "forcePushed"}, {"oid": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "url": "https://github.com/nuxeo/nuxeo/commit/7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-05T08:52:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0Nzc1OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388247758", "bodyText": "I would prefer\nString parentPath = parentRef == null ? null : resolveReference(parentRef).getPath();\n\nbut up to you", "author": "efge", "createdAt": "2020-03-05T11:56:05Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2672,6 +2676,25 @@ public DocumentModel getOrCreateDocument(DocumentModel docModel,\n         });\n     }\n \n+    @Override\n+    public DocumentModel newDocumentModel(DocumentRef parentRef, String name, String typeName) {\n+        if (parentRef == null && name == null) {\n+            return createDocumentModel(typeName);\n+        }\n+\n+        String parentPath = null;\n+        if (parentRef != null) {\n+            parentPath = resolveReference(parentRef).getPath();", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MDg5Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388250897", "bodyText": "We should audit our code for usage of PARENT_PATH because as this code shows it's now meaningless in some cases so we may as well try avoid using it completely (and replace it with something else depending on needs)", "author": "efge", "createdAt": "2020-03-05T12:02:52Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2672,6 +2676,25 @@ public DocumentModel getOrCreateDocument(DocumentModel docModel,\n         });\n     }\n \n+    @Override\n+    public DocumentModel newDocumentModel(DocumentRef parentRef, String name, String typeName) {\n+        if (parentRef == null && name == null) {\n+            return createDocumentModel(typeName);\n+        }\n+\n+        String parentPath = null;\n+        if (parentRef != null) {\n+            parentPath = resolveReference(parentRef).getPath();\n+        }\n+        Map<String, Serializable> options = new HashMap<>();\n+        options.put(CoreEventConstants.PARENT_PATH, parentPath);", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MTkwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388251906", "bodyText": "Hm actually it's even worse, for the moveDocument case the value is a DocumentRef and not a String... and this is used by quotas...", "author": "efge", "createdAt": "2020-03-05T12:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MDg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxOTUyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388819522", "bodyText": "yes I agree :(", "author": "RSalem07", "createdAt": "2020-03-06T10:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MDg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyOTY3OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388429679", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testBasicsCreateDocsWithHierarchy() {\n          \n          \n            \n                public void testCreateDocumentsHierarchy() {\n          \n      \n    \n    \n  \n\n?", "author": "troger", "createdAt": "2020-03-05T16:59:15Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -272,6 +272,51 @@ public void testBasics() {\n         assertEquals(cal, modified);\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testBasicsCreateDocsWithHierarchy() {", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMDQ1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388430452", "bodyText": "Could you use DocumentModel#setPropertyValue and DocumentModel#getPropertyValue?\nI know the class mix both, but let's add \"correct\" code :)", "author": "troger", "createdAt": "2020-03-05T17:00:29Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -272,6 +272,51 @@ public void testBasics() {\n         assertEquals(cal, modified);\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testBasicsCreateDocsWithHierarchy() {\n+        DocumentModel root = session.getRootDocument();\n+\n+        // create the parent doc under the root\n+        DocumentModel parent = session.newDocumentModel(new PathRef(\"/\"), \"domain\", \"MyDocType\");\n+        Calendar parentModifTime = GregorianCalendar.getInstance();\n+        parent.setProperty(\"dublincore\", \"title\", \"Title of parent\");", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTIxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431210", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n          \n          \n            \n                    DocumentModel parent = session.newDocumentModel(null, \"parent\", \"File\");\n          \n      \n    \n    \n  \n\nparent and child, simpler,  like in the other test method you added.", "author": "troger", "createdAt": "2020-03-05T17:01:38Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTMzNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431336", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n          \n          \n            \n                    DocumentModel child = session.newDocumentModel(parentFile.getRef(), \"child\", \"File\");", "author": "troger", "createdAt": "2020-03-05T17:01:49Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTY4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431687", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    parentFile = session.getDocument(new IdRef(parentFile.getId()));\n          \n          \n            \n                    parentFile = session.getDocument(parentFile.getRef());", "author": "troger", "createdAt": "2020-03-05T17:02:20Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n+        childFile = session.createDocument(childFile);\n+        session.save();\n+\n+        reopenSession();\n+\n+        // the parent file must be a placeless\n+        parentFile = session.getDocument(new IdRef(parentFile.getId()));", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTg0Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431842", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    childFile = session.getDocument(new IdRef(childFile.getId()));\n          \n          \n            \n                    childFile = session.getDocument(childFile.getRef());", "author": "troger", "createdAt": "2020-03-05T17:02:35Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n+        childFile = session.createDocument(childFile);\n+        session.save();\n+\n+        reopenSession();\n+\n+        // the parent file must be a placeless\n+        parentFile = session.getDocument(new IdRef(parentFile.getId()));\n+        assertNull(parentFile.getParentRef());\n+\n+        // the child file mustn't be a placeless\n+        childFile = session.getDocument(new IdRef(childFile.getId()));", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMjkxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388432916", "bodyText": "Not sure of the pertinence of the messages here...\nassertFalse(session.exists(parentFile.getRef()));\nassertFalse(session.exists(childFile.getRef()));\nIt seems enough.", "author": "troger", "createdAt": "2020-03-05T17:04:22Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n+        childFile = session.createDocument(childFile);\n+        session.save();\n+\n+        reopenSession();\n+\n+        // the parent file must be a placeless\n+        parentFile = session.getDocument(new IdRef(parentFile.getId()));\n+        assertNull(parentFile.getParentRef());\n+\n+        // the child file mustn't be a placeless\n+        childFile = session.getDocument(new IdRef(childFile.getId()));\n+        assertEquals(parentFile.getRef(), childFile.getParentRef());\n+\n+        // remove the parent\n+        session.removeDocument(parentFile.getRef());\n+        session.save();\n+\n+        assertFalse(\"parentFile should be removed\", session.exists(parentFile.getRef()));\n+        assertFalse(\"childFile should be removed\", session.exists(childFile.getRef()));", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0MTI0OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388441249", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private DocumentModel createDocumentModelByParentAndType(DocumentRef parentRef, String typeName,\n          \n          \n            \n                private DocumentModel createDocumentModelFromParentAndType(DocumentRef parentRef, String typeName,\n          \n      \n    \n    \n  \n\n?", "author": "troger", "createdAt": "2020-03-05T17:17:24Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -616,12 +616,16 @@ public void cancel() {\n     }\n \n     private DocumentModel createDocumentModelFromTypeName(String typeName, Map<String, Serializable> options) {\n-        SchemaManager schemaManager = Framework.getService(SchemaManager.class);\n-        DocumentType docType = schemaManager.getDocumentType(typeName);\n+        return createDocumentModelByParentAndType(null, typeName, options);\n+    }\n+\n+    private DocumentModel createDocumentModelByParentAndType(DocumentRef parentRef, String typeName,", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea591eced7b9cc7bcc115e6c8b01298218fdfcce", "url": "https://github.com/nuxeo/nuxeo/commit/ea591eced7b9cc7bcc115e6c8b01298218fdfcce", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T10:15:12Z", "type": "forcePushed"}, {"oid": "aa7a4b9daebc135ac90421a6462e087ebf6f7112", "url": "https://github.com/nuxeo/nuxeo/commit/aa7a4b9daebc135ac90421a6462e087ebf6f7112", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T10:20:26Z", "type": "forcePushed"}, {"oid": "2b82c9f096b9c62ec54af7b246152c708d90c235", "url": "https://github.com/nuxeo/nuxeo/commit/2b82c9f096b9c62ec54af7b246152c708d90c235", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T14:32:19Z", "type": "commit"}, {"oid": "2b82c9f096b9c62ec54af7b246152c708d90c235", "url": "https://github.com/nuxeo/nuxeo/commit/2b82c9f096b9c62ec54af7b246152c708d90c235", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T14:32:19Z", "type": "forcePushed"}]}