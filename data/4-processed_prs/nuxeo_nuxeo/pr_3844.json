{"pr_number": 3844, "pr_title": "NXP-28504: release when merging on reference branches", "pr_createdAt": "2020-03-18T11:14:29Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3844", "timeline": [{"oid": "3a33e2075a80277f1fce1ce1035d2ba8c17035ee", "url": "https://github.com/nuxeo/nuxeo/commit/3a33e2075a80277f1fce1ce1035d2ba8c17035ee", "message": "NXP-28504: release when merging on master\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches.", "committedDate": "2020-03-20T09:18:46Z", "type": "forcePushed"}, {"oid": "71e2141d6ececd9894af56e14502ebe06bbba5ed", "url": "https://github.com/nuxeo/nuxeo/commit/71e2141d6ececd9894af56e14502ebe06bbba5ed", "message": "NXP-28504: release when merging on master\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches.", "committedDate": "2020-03-20T10:26:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MjU4OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395552588", "bodyText": "Then you also release when on reference branches ? The commit message talks about master", "author": "NourNuxeo", "createdAt": "2020-03-20T10:35:43Z", "path": "Jenkinsfile", "diffHunk": "@@ -40,9 +41,45 @@ void setGitHubBuildStatus(String context, String message, String state) {\n   ])\n }\n \n+String getMavenArgs() {\n+  def args = '-B -nsu'\n+  if (!isPullRequest()) {", "originalCommit": "71e2141d6ececd9894af56e14502ebe06bbba5ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzMjc3OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395632779", "bodyText": "Yes.", "author": "troger", "createdAt": "2020-03-20T13:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MjU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU1MzI2Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395553267", "bodyText": "could be one lined ?", "author": "NourNuxeo", "createdAt": "2020-03-20T10:37:08Z", "path": "Jenkinsfile", "diffHunk": "@@ -40,9 +41,45 @@ void setGitHubBuildStatus(String context, String message, String state) {\n   ])\n }\n \n+String getMavenArgs() {\n+  def args = '-B -nsu'\n+  if (!isPullRequest()) {\n+    args += ' -Prelease'\n+  }\n+  return args\n+}\n+\n+def isPullRequest() {\n+  return BRANCH_NAME =~ /PR-.*/\n+}\n+\n String getVersion() {\n+  return isPullRequest() ? getPullRequestVersion() : getReleaseVersion()\n+}\n+\n+String getReleaseVersion() {\n   String nuxeoVersion = readMavenPom().getVersion()\n-  return BRANCH_NAME == 'master' ? nuxeoVersion : \"${BRANCH_NAME}-\" + nuxeoVersion\n+  String noSnapshot = nuxeoVersion.replace(\"-SNAPSHOT\", \"\")\n+  String version = noSnapshot + '.0' // first version ever\n+\n+  // find the latest tag if any\n+  sh \"git fetch origin 'refs/tags/v${noSnapshot}*:refs/tags/v${noSnapshot}*'\"\n+  def tag = sh(returnStdout: true, script: \"git tag --sort=committerdate --list 'v${noSnapshot}*' | tail -1 | tr -d '\\n'\")\n+  if (tag) {\n+    container('maven') {\n+      version = sh(returnStdout: true, script: \"semver bump patch ${tag} | tr -d '\\n'\")\n+    }\n+  }\n+  return version\n+}\n+\n+String getPullRequestVersion() {\n+  String nuxeoVersion = readMavenPom().getVersion()\n+  return \"${BRANCH_NAME}-\" + nuxeoVersion", "originalCommit": "71e2141d6ececd9894af56e14502ebe06bbba5ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2MjQ1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395562450", "bodyText": "There are new lines here and there that could be regrouped in a cleanup commit", "author": "NourNuxeo", "createdAt": "2020-03-20T10:56:42Z", "path": "Jenkinsfile", "diffHunk": "@@ -268,10 +314,33 @@ pipeline {\n           sh \"\"\"\n             mvn ${MAVEN_ARGS} -Pdistrib,docker versions:set -DnewVersion=${VERSION} -DgenerateBackupPoms=false\n             perl -i -pe 's|<nuxeo.platform.version>.*?</nuxeo.platform.version>|<nuxeo.platform.version>${VERSION}</nuxeo.platform.version>|' pom.xml\n+            perl -i -pe 's|org.nuxeo.ecm.product.version=.*|org.nuxeo.ecm.product.version=${VERSION}|' nuxeo-distribution/nuxeo-nxr-server/src/main/resources/templates/nuxeo.defaults\n+          \"\"\"\n+        }\n+      }\n+    }\n+\n+    stage('Git commit') {\n+      when {\n+        not {\n+          branch 'PR-*'\n+        }\n+      }\n+      steps {\n+        container('maven') {\n+          echo \"\"\"\n+          ----------------------------------------\n+          Git commit\n+          ----------------------------------------\n+          \"\"\"\n+          sh \"\"\"\n+            git add .\n+            git commit -m \"Release ${VERSION}\"\n           \"\"\"\n         }\n       }\n     }\n+", "originalCommit": "71e2141d6ececd9894af56e14502ebe06bbba5ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYzMjY2MA==", "url": "https://github.com/nuxeo/nuxeo/pull/3844#discussion_r395632660", "bodyText": "Looking at the ugly diff generated by git/github, I don't think putting new lines in a separate commit is required.", "author": "troger", "createdAt": "2020-03-20T13:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU2MjQ1MA=="}], "type": "inlineReview"}, {"oid": "ca7f5d99e573dc36ca8a6a001ba5d132f9e6ba95", "url": "https://github.com/nuxeo/nuxeo/commit/ca7f5d99e573dc36ca8a6a001ba5d132f9e6ba95", "message": "NXP-28504: release when merging on reference branches\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches.", "committedDate": "2020-03-20T13:24:51Z", "type": "forcePushed"}, {"oid": "99e5daa76f80646f563407281b108eebcc208d3e", "url": "https://github.com/nuxeo/nuxeo/commit/99e5daa76f80646f563407281b108eebcc208d3e", "message": "NXP-28504: release when merging on reference branches\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches.", "committedDate": "2020-03-20T13:50:50Z", "type": "commit"}, {"oid": "99e5daa76f80646f563407281b108eebcc208d3e", "url": "https://github.com/nuxeo/nuxeo/commit/99e5daa76f80646f563407281b108eebcc208d3e", "message": "NXP-28504: release when merging on reference branches\n\nUse only on Jenkinsfile to build PRs and release reference\nbranches.", "committedDate": "2020-03-20T13:50:50Z", "type": "forcePushed"}]}