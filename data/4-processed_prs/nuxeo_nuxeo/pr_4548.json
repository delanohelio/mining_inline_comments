{"pr_number": 4548, "pr_title": "NXP-29810: take into account SMTP service state on Document.Mail oper\u2026", "pr_createdAt": "2020-12-16T16:05:04Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4548", "timeline": [{"oid": "2f98d809aebd064d5754fd5a1334327a5dbf5257", "url": "https://github.com/nuxeo/nuxeo/commit/2f98d809aebd064d5754fd5a1334327a5dbf5257", "message": "NXP-29810: take into account SMTP service state on Document.Mail operation", "committedDate": "2020-12-17T11:50:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyNDY5Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4548#discussion_r545924692", "bodyText": "Forgotten Sys out?", "author": "kevinleturc", "createdAt": "2020-12-18T15:53:25Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/notification/SendMail.java", "diffHunk": "@@ -165,34 +167,38 @@ protected void send(DocumentModel doc)\n         // TODO should sent one by one to each recipient? and have the template\n         // rendered for each recipient? Use: \"mailto\" var name?\n         try {\n-            Map<String, Object> map = Scripting.initBindings(ctx);\n-            // do not use document wrapper which is working only in mvel.\n-            map.put(\"Document\", doc);\n-            map.put(\"docUrl\",\n-                    createDocUrlWithToken(MailTemplateHelper.getDocumentUrl(doc, viewId), (String) map.get(\"token\")));\n-            map.put(\"subject\", subject);\n-            map.put(\"to\", to);\n-            map.put(\"toResolved\", MailBox.fetchPersonsFromList(to, isStrict));\n-            map.put(\"from\", from);\n-            map.put(\"fromResolved\", MailBox.fetchPersonsFromString(from, isStrict));\n-            map.put(\"cc\", cc);\n-            map.put(\"ccResolved\", MailBox.fetchPersonsFromList(cc, isStrict));\n-            map.put(\"bcc\", bcc);\n-            map.put(\"bccResolved\", MailBox.fetchPersonsFromList(bcc, isStrict));\n-            map.put(\"replyto\", replyto);\n-            map.put(\"replytoResolved\", MailBox.fetchPersonsFromList(replyto, isStrict));\n-            map.put(\"viewId\", viewId);\n-            map.put(\"baseUrl\", NotificationServiceHelper.getNotificationService().getServerUrlPrefix());\n-            map.put(\"Runtime\", Framework.getRuntime());\n-            Mailer.Message msg = createMessage(doc, getContent(), map);\n-            msg.setSubject(subject, \"UTF-8\");\n-            msg.setSentDate(new Date());\n-\n-            addMailBoxInfo(msg, map);\n-\n-            msg.send();\n+            AdministrativeStatusManager asm = Framework.getService(AdministrativeStatusManager.class);\n+            if (asm == null || !asm.getStatus(\"org.nuxeo.ecm.smtp\").getState().equals(PASSIVE)) {\n+                Map<String, Object> map = Scripting.initBindings(ctx);\n+                // do not use document wrapper which is working only in mvel.\n+                map.put(\"Document\", doc);\n+                map.put(\"docUrl\", createDocUrlWithToken(MailTemplateHelper.getDocumentUrl(doc, viewId),\n+                        (String) map.get(\"token\")));\n+                map.put(\"subject\", subject);\n+                map.put(\"to\", to);\n+                map.put(\"toResolved\", MailBox.fetchPersonsFromList(to, isStrict));\n+                map.put(\"from\", from);\n+                map.put(\"fromResolved\", MailBox.fetchPersonsFromString(from, isStrict));\n+                map.put(\"cc\", cc);\n+                map.put(\"ccResolved\", MailBox.fetchPersonsFromList(cc, isStrict));\n+                map.put(\"bcc\", bcc);\n+                map.put(\"bccResolved\", MailBox.fetchPersonsFromList(bcc, isStrict));\n+                map.put(\"replyto\", replyto);\n+                map.put(\"replytoResolved\", MailBox.fetchPersonsFromList(replyto, isStrict));\n+                map.put(\"viewId\", viewId);\n+                map.put(\"baseUrl\", NotificationServiceHelper.getNotificationService().getServerUrlPrefix());\n+                map.put(\"Runtime\", Framework.getRuntime());\n+                Mailer.Message msg = createMessage(doc, getContent(), map);\n+                msg.setSubject(subject, \"UTF-8\");\n+                msg.setSentDate(new Date());\n+\n+                addMailBoxInfo(msg, map);\n+\n+                msg.send();\n+            }\n         } catch (NuxeoException | TemplateException | RenderingException | OperationException | MessagingException\n                 | IOException e) {\n+            System.out.println(\"Class\" + e.getClass() + \" :\" + e.getMessage());", "originalCommit": "2f98d809aebd064d5754fd5a1334327a5dbf5257", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyNzY5NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4548#discussion_r545927695", "bodyText": "As there's a lot of line inside the if, and to preserve the git history, could you change the if to something such as below:\nif (asm != null && PASSIVE.equals(asm.getStatus(\"org.nuxeo.ecm.smtp\").getState()) {\n    return;\n}", "author": "kevinleturc", "createdAt": "2020-12-18T15:58:18Z", "path": "modules/platform/nuxeo-automation/nuxeo-automation-features/src/main/java/org/nuxeo/ecm/automation/core/operations/notification/SendMail.java", "diffHunk": "@@ -165,34 +167,38 @@ protected void send(DocumentModel doc)\n         // TODO should sent one by one to each recipient? and have the template\n         // rendered for each recipient? Use: \"mailto\" var name?\n         try {\n-            Map<String, Object> map = Scripting.initBindings(ctx);\n-            // do not use document wrapper which is working only in mvel.\n-            map.put(\"Document\", doc);\n-            map.put(\"docUrl\",\n-                    createDocUrlWithToken(MailTemplateHelper.getDocumentUrl(doc, viewId), (String) map.get(\"token\")));\n-            map.put(\"subject\", subject);\n-            map.put(\"to\", to);\n-            map.put(\"toResolved\", MailBox.fetchPersonsFromList(to, isStrict));\n-            map.put(\"from\", from);\n-            map.put(\"fromResolved\", MailBox.fetchPersonsFromString(from, isStrict));\n-            map.put(\"cc\", cc);\n-            map.put(\"ccResolved\", MailBox.fetchPersonsFromList(cc, isStrict));\n-            map.put(\"bcc\", bcc);\n-            map.put(\"bccResolved\", MailBox.fetchPersonsFromList(bcc, isStrict));\n-            map.put(\"replyto\", replyto);\n-            map.put(\"replytoResolved\", MailBox.fetchPersonsFromList(replyto, isStrict));\n-            map.put(\"viewId\", viewId);\n-            map.put(\"baseUrl\", NotificationServiceHelper.getNotificationService().getServerUrlPrefix());\n-            map.put(\"Runtime\", Framework.getRuntime());\n-            Mailer.Message msg = createMessage(doc, getContent(), map);\n-            msg.setSubject(subject, \"UTF-8\");\n-            msg.setSentDate(new Date());\n-\n-            addMailBoxInfo(msg, map);\n-\n-            msg.send();\n+            AdministrativeStatusManager asm = Framework.getService(AdministrativeStatusManager.class);\n+            if (asm == null || !asm.getStatus(\"org.nuxeo.ecm.smtp\").getState().equals(PASSIVE)) {", "originalCommit": "2f98d809aebd064d5754fd5a1334327a5dbf5257", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI2NDc5NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4548#discussion_r547264795", "bodyText": "+1 although I'd like to see a debug log here before the return: log.debug(\"SMTP is in passive mode, mail not sent\")", "author": "efge", "createdAt": "2020-12-22T13:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyNzY5NQ=="}], "type": "inlineReview"}, {"oid": "d8a81ea1d6caebfa8ec7391ada652224586581d4", "url": "https://github.com/nuxeo/nuxeo/commit/d8a81ea1d6caebfa8ec7391ada652224586581d4", "message": "NXP-29810: take into account SMTP service state on Document.Mail operation", "committedDate": "2020-12-28T08:46:55Z", "type": "forcePushed"}, {"oid": "8000a4712ccd754b5f5ceca3fe0a153aafabc263", "url": "https://github.com/nuxeo/nuxeo/commit/8000a4712ccd754b5f5ceca3fe0a153aafabc263", "message": "NXP-29810: take into account SMTP service state on Document.Mail operation", "committedDate": "2020-12-28T08:48:04Z", "type": "commit"}, {"oid": "8000a4712ccd754b5f5ceca3fe0a153aafabc263", "url": "https://github.com/nuxeo/nuxeo/commit/8000a4712ccd754b5f5ceca3fe0a153aafabc263", "message": "NXP-29810: take into account SMTP service state on Document.Mail operation", "committedDate": "2020-12-28T08:48:04Z", "type": "forcePushed"}]}