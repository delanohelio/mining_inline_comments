{"pr_number": 3642, "pr_title": "10.10-HF/fix-NXP-28433-multi-complex-nullifying", "pr_createdAt": "2020-01-02T18:59:38Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3642", "timeline": [{"oid": "4f0c7c1bdae9a7c3c8a6f45527b95d24316a033c", "url": "https://github.com/nuxeo/nuxeo/commit/4f0c7c1bdae9a7c3c8a6f45527b95d24316a033c", "message": "NXP-28433: Fix multi complex nullifying through REST", "committedDate": "2020-01-02T15:42:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc3MDExMw==", "url": "https://github.com/nuxeo/nuxeo/pull/3642#discussion_r362770113", "bodyText": "i don't remember if we privilege the using of doc.setProperty() instead of doc.setPropertyValue() i asked this question because i think we can replace with:\n        doc.setPropertyValue(\"dv:complexWithoutDefault/foo\", \"val1\");\n        doc.setPropertyValue(\"dv:complexWithoutDefault/bar\", \"val2\");\n\nas they did on the existing tests instead of the creation Map...", "author": "RSalem07", "createdAt": "2020-01-03T10:53:05Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/DocumentBrowsingTest.java", "diffHunk": "@@ -487,10 +489,85 @@ public void itCanSetArrayPropertyToNull() throws IOException {\n             // Then the document is updated\n             fetchInvalidations();\n             doc = session.getDocument(doc.getRef());\n+            // ArrayProperty returns null whenever is empty or null\n             assertNull(doc.getPropertyValue(\"dc:subjects\"));\n         }\n     }\n \n+    /*\n+     * NXP-28433\n+     */\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:test-defaultvalue-docTypes.xml\")\n+    public void itCanSetArrayPropertyOfComplexToEmpty() throws IOException {\n+        DocumentModel doc = session.createDocumentModel(\"/\", \"myDocument\", \"DocDefaultValue\");\n+        Map<String, String> complex = new HashMap<>();\n+        complex.put(\"foo\", \"val1\");\n+        complex.put(\"bar\", \"val2\");\n+        doc.setProperty(\"defaultvalue\", \"multiComplexWithoutDefault\", Collections.singletonList(complex));\n+        doc = session.createDocument(doc);", "originalCommit": "4f0c7c1bdae9a7c3c8a6f45527b95d24316a033c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzczNTE0Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3642#discussion_r363735143", "bodyText": "This is not the same type than the example you pasted. Here we have a list of complex, I use the setProperty method because other one needs a Serializable which force us to cast the thing, I don't like that.", "author": "kevinleturc", "createdAt": "2020-01-07T12:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc3MDExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc3MDgwMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3642#discussion_r362770801", "bodyText": "i am wondering what if we extract the main treatment of the two test as they check the same things the main difference is in a case we pass a null and an other [] but at the end we have an empty array.", "author": "RSalem07", "createdAt": "2020-01-03T10:55:31Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/DocumentBrowsingTest.java", "diffHunk": "@@ -487,10 +489,85 @@ public void itCanSetArrayPropertyToNull() throws IOException {\n             // Then the document is updated\n             fetchInvalidations();\n             doc = session.getDocument(doc.getRef());\n+            // ArrayProperty returns null whenever is empty or null\n             assertNull(doc.getPropertyValue(\"dc:subjects\"));\n         }\n     }\n \n+    /*\n+     * NXP-28433\n+     */\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:test-defaultvalue-docTypes.xml\")\n+    public void itCanSetArrayPropertyOfComplexToEmpty() throws IOException {\n+        DocumentModel doc = session.createDocumentModel(\"/\", \"myDocument\", \"DocDefaultValue\");\n+        Map<String, String> complex = new HashMap<>();\n+        complex.put(\"foo\", \"val1\");\n+        complex.put(\"bar\", \"val2\");\n+        doc.setProperty(\"defaultvalue\", \"multiComplexWithoutDefault\", Collections.singletonList(complex));\n+        doc = session.createDocument(doc);\n+        fetchInvalidations();\n+\n+        try (CloseableClientResponse response = getResponse(RequestType.PUT, \"id/\" + doc.getId(),\n+                \"{\\\"entity-type\\\":\\\"document\\\",\\\"properties\\\":{\\\"dv:multiComplexWithoutDefault\\\":[]}}\",\n+                Collections.singletonMap(\"X-NXDocumentProperties\", \"defaultvalue\"))) {\n+\n+            assertEquals(Response.Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+            JsonNode jsonProperties = node.get(\"properties\");\n+            assertNotNull(jsonProperties);\n+            JsonNode jsonMultiComplex = jsonProperties.get(\"dv:multiComplexWithoutDefault\");\n+            assertNotNull(jsonMultiComplex);\n+            assertTrue(jsonMultiComplex.isArray());\n+            assertEquals(0, jsonMultiComplex.size());\n+\n+            // Then the document is updated\n+            fetchInvalidations();\n+            doc = session.getDocument(doc.getRef());\n+            // ListProperty returns an empty List whenever is empty or null\n+            Serializable multiComplex = doc.getPropertyValue(\"dv:multiComplexWithoutDefault\");\n+            assertTrue(multiComplex instanceof List);\n+            assertTrue(((List<?>) multiComplex).isEmpty());\n+        }\n+    }\n+\n+    /*\n+     * NXP-28433\n+     */\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:test-defaultvalue-docTypes.xml\")\n+    public void itCanSetArrayPropertyOfComplexToNull() throws IOException {\n+        DocumentModel doc = session.createDocumentModel(\"/\", \"myDocument\", \"DocDefaultValue\");\n+        Map<String, String> complex = new HashMap<>();\n+        complex.put(\"foo\", \"val1\");\n+        complex.put(\"bar\", \"val2\");\n+        doc.setProperty(\"defaultvalue\", \"multiComplexWithoutDefault\", Collections.singletonList(complex));\n+        doc = session.createDocument(doc);\n+        fetchInvalidations();\n+\n+        try (CloseableClientResponse response = getResponse(RequestType.PUT, \"id/\" + doc.getId(),\n+                \"{\\\"entity-type\\\":\\\"document\\\",\\\"properties\\\":{\\\"dv:multiComplexWithoutDefault\\\":null}}\",\n+                Collections.singletonMap(\"X-NXDocumentProperties\", \"defaultvalue\"))) {\n+\n+            assertEquals(Response.Status.OK.getStatusCode(), response.getStatus());\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+            JsonNode jsonProperties = node.get(\"properties\");\n+            assertNotNull(jsonProperties);\n+            JsonNode jsonMultiComplex = jsonProperties.get(\"dv:multiComplexWithoutDefault\");\n+            assertNotNull(jsonMultiComplex);\n+            assertTrue(jsonMultiComplex.isArray());\n+            assertEquals(0, jsonMultiComplex.size());\n+\n+            // Then the document is updated\n+            fetchInvalidations();\n+            doc = session.getDocument(doc.getRef());\n+            // ListProperty returns an empty List whenever is empty or null\n+            Serializable multiComplex = doc.getPropertyValue(\"dv:multiComplexWithoutDefault\");\n+            assertTrue(multiComplex instanceof List);\n+            assertTrue(((List<?>) multiComplex).isEmpty());\n+        }\n+    }\n+", "originalCommit": "4f0c7c1bdae9a7c3c8a6f45527b95d24316a033c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzczNjI3Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3642#discussion_r363736273", "bodyText": "here we end with a list and not an array regarding the other test which is array. I don't see the point to have a method for that, I think it increases complexity with no real advantage and, in such case, I prefer to have the complet test in front of me when reading than having to navigate in the test code to find what it does.", "author": "kevinleturc", "createdAt": "2020-01-07T13:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc3MDgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc3MjE2Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3642#discussion_r362772162", "bodyText": "i am wondering about the comment  call #remove(Property) which set isModified flag you want to call remove(p); or some thing else. and it can be replaced  temp.forEach(this::remove); but i think this is a cleanup purpose :) and we don't want it on backport", "author": "RSalem07", "createdAt": "2020-01-03T11:00:32Z", "path": "nuxeo-core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/model/impl/ListProperty.java", "diffHunk": "@@ -243,7 +243,11 @@ public void setValue(Object value) throws PropertyException {\n         if (value == null) {\n             List<Property> temp = new ArrayList<Property>(children);\n             for (Property p : temp) { // remove all children\n-                p.remove();\n+                p.remove(); // call #remove(Property) which set isModified flag", "originalCommit": "4f0c7c1bdae9a7c3c8a6f45527b95d24316a033c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE2MDgzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3642#discussion_r364160837", "bodyText": "This is because under the hood this will call org.nuxeo.ecm.core.api.model.impl.AbstractProperty.remove()\nThis method will call the parent of the prop (the list, and make a call to remove(Property) on line 138", "author": "NourNuxeo", "createdAt": "2020-01-08T10:26:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc3MjE2Mg=="}], "type": "inlineReview"}]}