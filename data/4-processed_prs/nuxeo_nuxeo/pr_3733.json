{"pr_number": 3733, "pr_title": "feature-NXP-28579-unit-tests-postgresql-mongodb-parallel", "pr_createdAt": "2020-02-07T23:03:35Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3733", "timeline": [{"oid": "a6893c864d4665c928ee406e313763fba69fd8b0", "url": "https://github.com/nuxeo/nuxeo/commit/a6893c864d4665c928ee406e313763fba69fd8b0", "message": "run only unit test stage", "committedDate": "2020-02-08T22:37:54Z", "type": "forcePushed"}, {"oid": "7ccd26b1a0cb8ac826590bd284ef664e427d7ff9", "url": "https://github.com/nuxeo/nuxeo/commit/7ccd26b1a0cb8ac826590bd284ef664e427d7ff9", "message": "run only unit test stage", "committedDate": "2020-02-08T22:39:55Z", "type": "forcePushed"}, {"oid": "c18893934dee7b1083a56c8d7cc9f7437f6ef647", "url": "https://github.com/nuxeo/nuxeo/commit/c18893934dee7b1083a56c8d7cc9f7437f6ef647", "message": "run only unit test stage", "committedDate": "2020-02-08T22:40:56Z", "type": "forcePushed"}, {"oid": "9654e325c255f76649ceb03e78fc7ac31b2f9a0e", "url": "https://github.com/nuxeo/nuxeo/commit/9654e325c255f76649ceb03e78fc7ac31b2f9a0e", "message": "fix", "committedDate": "2020-02-08T22:45:41Z", "type": "forcePushed"}, {"oid": "abf22a06979726f84641416d2c3c33534a63cc79", "url": "https://github.com/nuxeo/nuxeo/commit/abf22a06979726f84641416d2c3c33534a63cc79", "message": "fix", "committedDate": "2020-02-08T22:50:58Z", "type": "forcePushed"}, {"oid": "f3ae125fd449676002c33eca2f614a7c600fd905", "url": "https://github.com/nuxeo/nuxeo/commit/f3ae125fd449676002c33eca2f614a7c600fd905", "message": "fix", "committedDate": "2020-02-09T08:04:30Z", "type": "forcePushed"}, {"oid": "922db92a0c6b102ab3d5ebcb29fadc4996583c9b", "url": "https://github.com/nuxeo/nuxeo/commit/922db92a0c6b102ab3d5ebcb29fadc4996583c9b", "message": "fix", "committedDate": "2020-02-09T10:59:12Z", "type": "forcePushed"}, {"oid": "cde0e31a5bcea80f1557161181f61593d148bab0", "url": "https://github.com/nuxeo/nuxeo/commit/cde0e31a5bcea80f1557161181f61593d148bab0", "message": "fix", "committedDate": "2020-02-09T11:04:37Z", "type": "forcePushed"}, {"oid": "0e8c47557f02ca87da11229f6ecb26a985885fae", "url": "https://github.com/nuxeo/nuxeo/commit/0e8c47557f02ca87da11229f6ecb26a985885fae", "message": "fix", "committedDate": "2020-02-09T20:42:44Z", "type": "forcePushed"}, {"oid": "0f25849665d1738f8d3886b5b323e1bd6f449419", "url": "https://github.com/nuxeo/nuxeo/commit/0f25849665d1738f8d3886b5b323e1bd6f449419", "message": "fix", "committedDate": "2020-02-09T20:44:02Z", "type": "forcePushed"}, {"oid": "7fab9d810447b86fc7527f52f6362c52e07d7eb0", "url": "https://github.com/nuxeo/nuxeo/commit/7fab9d810447b86fc7527f52f6362c52e07d7eb0", "message": "test failure", "committedDate": "2020-02-10T08:45:55Z", "type": "forcePushed"}, {"oid": "6f76e20e02782e8f587c8d3c1e0d868fd17d4e8d", "url": "https://github.com/nuxeo/nuxeo/commit/6f76e20e02782e8f587c8d3c1e0d868fd17d4e8d", "message": "test failure", "committedDate": "2020-02-10T08:56:33Z", "type": "forcePushed"}, {"oid": "9397a949afd9959dee5a6918296397403cacae54", "url": "https://github.com/nuxeo/nuxeo/commit/9397a949afd9959dee5a6918296397403cacae54", "message": "fixup", "committedDate": "2020-02-11T16:08:56Z", "type": "forcePushed"}, {"oid": "be797c36568375a06f0b59e70562264b4c0e22e1", "url": "https://github.com/nuxeo/nuxeo/commit/be797c36568375a06f0b59e70562264b4c0e22e1", "message": "fixup", "committedDate": "2020-02-11T16:16:04Z", "type": "forcePushed"}, {"oid": "01e4c7bb5b37e3b187700d66defb3dff38f83333", "url": "https://github.com/nuxeo/nuxeo/commit/01e4c7bb5b37e3b187700d66defb3dff38f83333", "message": "test failure", "committedDate": "2020-02-11T21:27:25Z", "type": "forcePushed"}, {"oid": "326bd1d5e264e19f1610cf9ea7c977149e0dcc76", "url": "https://github.com/nuxeo/nuxeo/commit/326bd1d5e264e19f1610cf9ea7c977149e0dcc76", "message": "test failure", "committedDate": "2020-02-11T21:43:27Z", "type": "forcePushed"}, {"oid": "a414ef03e2e47958ecff7044cef3a5f6613bf41a", "url": "https://github.com/nuxeo/nuxeo/commit/a414ef03e2e47958ecff7044cef3a5f6613bf41a", "message": "test failure", "committedDate": "2020-02-11T21:58:09Z", "type": "forcePushed"}, {"oid": "8374a53f15547a199cd025db79e191f52fb81839", "url": "https://github.com/nuxeo/nuxeo/commit/8374a53f15547a199cd025db79e191f52fb81839", "message": "test failure", "committedDate": "2020-02-11T22:15:55Z", "type": "forcePushed"}, {"oid": "d595853bf7ef26fc2e652df20d8abc65c4cd4069", "url": "https://github.com/nuxeo/nuxeo/commit/d595853bf7ef26fc2e652df20d8abc65c4cd4069", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-12T09:09:30Z", "type": "forcePushed"}, {"oid": "1c7ad199accdc420aa5d7be89aa20b824e07f459", "url": "https://github.com/nuxeo/nuxeo/commit/1c7ad199accdc420aa5d7be89aa20b824e07f459", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-12T09:15:30Z", "type": "forcePushed"}, {"oid": "e04f61e0eeabe4f5f7deedf73372c6f2d96f792b", "url": "https://github.com/nuxeo/nuxeo/commit/e04f61e0eeabe4f5f7deedf73372c6f2d96f792b", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-12T10:51:54Z", "type": "forcePushed"}, {"oid": "da25d97170281aa37d3e5c2fb694d6a3f08dc9a8", "url": "https://github.com/nuxeo/nuxeo/commit/da25d97170281aa37d3e5c2fb694d6a3f08dc9a8", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-12T22:34:07Z", "type": "forcePushed"}, {"oid": "a63237b36204bbe1bca7d434035047e678af1324", "url": "https://github.com/nuxeo/nuxeo/commit/a63237b36204bbe1bca7d434035047e678af1324", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-13T09:38:47Z", "type": "forcePushed"}, {"oid": "2c7752eef39ef04fbd1929720596b3d8811f09ac", "url": "https://github.com/nuxeo/nuxeo/commit/2c7752eef39ef04fbd1929720596b3d8811f09ac", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-13T14:51:32Z", "type": "forcePushed"}, {"oid": "c706c3c8f9d69d712a516e9e805a3666dd548f63", "url": "https://github.com/nuxeo/nuxeo/commit/c706c3c8f9d69d712a516e9e805a3666dd548f63", "message": "tmp: debug storage config system prop", "committedDate": "2020-02-14T11:37:55Z", "type": "forcePushed"}, {"oid": "ff32e39076953bb3743ff2cbe92b75a48697e0cf", "url": "https://github.com/nuxeo/nuxeo/commit/ff32e39076953bb3743ff2cbe92b75a48697e0cf", "message": "tmp: debug storage config system prop", "committedDate": "2020-02-14T17:01:17Z", "type": "forcePushed"}, {"oid": "5aa4d265c16b20f8cc3b5e4537820d870325c4ee", "url": "https://github.com/nuxeo/nuxeo/commit/5aa4d265c16b20f8cc3b5e4537820d870325c4ee", "message": "tmp: test PG sys props", "committedDate": "2020-02-15T23:31:42Z", "type": "forcePushed"}, {"oid": "47caf365535433d93b0d73cc4425466d63175815", "url": "https://github.com/nuxeo/nuxeo/commit/47caf365535433d93b0d73cc4425466d63175815", "message": "tmp: test PG sys props", "committedDate": "2020-02-15T23:51:07Z", "type": "forcePushed"}, {"oid": "cd28af5cb1d034a2229086d484c26a1cca15cabd", "url": "https://github.com/nuxeo/nuxeo/commit/cd28af5cb1d034a2229086d484c26a1cca15cabd", "message": "tmp: test PG sys props", "committedDate": "2020-02-16T00:12:40Z", "type": "forcePushed"}, {"oid": "6389b39c593b629ffa8b80a504296ecd6c2b90f2", "url": "https://github.com/nuxeo/nuxeo/commit/6389b39c593b629ffa8b80a504296ecd6c2b90f2", "message": "tmp: test PG sys props", "committedDate": "2020-02-16T06:53:38Z", "type": "forcePushed"}, {"oid": "443db0483dfca9555e5e6c8321abba501745bd57", "url": "https://github.com/nuxeo/nuxeo/commit/443db0483dfca9555e5e6c8321abba501745bd57", "message": "tmp: fix PG service URL?", "committedDate": "2020-02-17T22:27:59Z", "type": "forcePushed"}, {"oid": "3c6f41e23122c7283d194ebde2333070aba5e5c6", "url": "https://github.com/nuxeo/nuxeo/commit/3c6f41e23122c7283d194ebde2333070aba5e5c6", "message": "tmp: debug PG", "committedDate": "2020-02-18T14:10:38Z", "type": "forcePushed"}, {"oid": "2d9dbe25f45757bd9d7f72dafc2d9c7c395fd3ac", "url": "https://github.com/nuxeo/nuxeo/commit/2d9dbe25f45757bd9d7f72dafc2d9c7c395fd3ac", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-18T15:27:59Z", "type": "forcePushed"}, {"oid": "0a8a602acd08ef648902462be83fc1564e6374d7", "url": "https://github.com/nuxeo/nuxeo/commit/0a8a602acd08ef648902462be83fc1564e6374d7", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-19T07:37:28Z", "type": "forcePushed"}, {"oid": "caf5f9bbdfa69fe8be999e9740b2baffbc14c162", "url": "https://github.com/nuxeo/nuxeo/commit/caf5f9bbdfa69fe8be999e9740b2baffbc14c162", "message": "NXP-28579: Format, cleanup, fix some SonarQube issues", "committedDate": "2020-02-19T15:31:32Z", "type": "commit"}, {"oid": "f4848fe664d81c7800a8113e4039bda66e38707e", "url": "https://github.com/nuxeo/nuxeo/commit/f4848fe664d81c7800a8113e4039bda66e38707e", "message": "NXP-28579: Allow to customize the Maven build directory\n\nRequired to run unit tests in parallel for different environments.", "committedDate": "2020-02-19T15:34:26Z", "type": "commit"}, {"oid": "11cd89ef80c5fa0b2e6d4b31dfdbfd99dbb8c8f8", "url": "https://github.com/nuxeo/nuxeo/commit/11cd89ef80c5fa0b2e6d4b31dfdbfd99dbb8c8f8", "message": "NXP-28579: Clean up H2 test datasources\n\nAnd make it explicit that the JDBC connection validation test depends on H2.", "committedDate": "2020-02-19T15:36:05Z", "type": "commit"}, {"oid": "9ae37eb1c793f09c1e6deb190b78b40c6307f9aa", "url": "https://github.com/nuxeo/nuxeo/commit/9ae37eb1c793f09c1e6deb190b78b40c6307f9aa", "message": "tmp: skip common/runtime tests", "committedDate": "2020-02-19T15:57:19Z", "type": "forcePushed"}, {"oid": "211c209ff652a08e6957ff259d78f95ea5a92161", "url": "https://github.com/nuxeo/nuxeo/commit/211c209ff652a08e6957ff259d78f95ea5a92161", "message": "tmp: skip common/runtime tests", "committedDate": "2020-02-19T15:58:26Z", "type": "forcePushed"}, {"oid": "dd777f9100f56a3b2294d0ca72e7d6f1c15d70e9", "url": "https://github.com/nuxeo/nuxeo/commit/dd777f9100f56a3b2294d0ca72e7d6f1c15d70e9", "message": "tmp: use PR chart to allow nuxeo disablement", "committedDate": "2020-02-19T15:38:59Z", "type": "forcePushed"}, {"oid": "8fcf6f138e6906573730d5c2a46b3aad1541e67c", "url": "https://github.com/nuxeo/nuxeo/commit/8fcf6f138e6906573730d5c2a46b3aad1541e67c", "message": "tmp: install common/runtime", "committedDate": "2020-02-19T20:13:35Z", "type": "forcePushed"}, {"oid": "a80df9737c850eea2c16ce5d0710657e501f7055", "url": "https://github.com/nuxeo/nuxeo/commit/a80df9737c850eea2c16ce5d0710657e501f7055", "message": "tmp: install common/runtime", "committedDate": "2020-02-19T20:15:55Z", "type": "forcePushed"}, {"oid": "a0db372fa7b0d72d938f43acace6011fca6a77b1", "url": "https://github.com/nuxeo/nuxeo/commit/a0db372fa7b0d72d938f43acace6011fca6a77b1", "message": "tmp: common/runtime - deploy and skip tests", "committedDate": "2020-02-20T14:07:16Z", "type": "forcePushed"}, {"oid": "2305f9d23ad9744e0e01ed4d448941bbc368a029", "url": "https://github.com/nuxeo/nuxeo/commit/2305f9d23ad9744e0e01ed4d448941bbc368a029", "message": "tmp: common/runtime - deploy and skip tests", "committedDate": "2020-02-20T23:05:33Z", "type": "forcePushed"}, {"oid": "f683f2c6e0c0efe94d21395c86b4f4b257f7011b", "url": "https://github.com/nuxeo/nuxeo/commit/f683f2c6e0c0efe94d21395c86b4f4b257f7011b", "message": "tmp: test mongodb core", "committedDate": "2020-02-21T09:06:51Z", "type": "forcePushed"}, {"oid": "e8ef2a89183c209d7614fda70b448cc21b77df12", "url": "https://github.com/nuxeo/nuxeo/commit/e8ef2a89183c209d7614fda70b448cc21b77df12", "message": "tmp: test mongodb core", "committedDate": "2020-02-21T09:26:50Z", "type": "forcePushed"}, {"oid": "1d011ed918143035ab534bec9ae655bd1027060f", "url": "https://github.com/nuxeo/nuxeo/commit/1d011ed918143035ab534bec9ae655bd1027060f", "message": "tmp: test mongodb core", "committedDate": "2020-02-21T10:27:34Z", "type": "forcePushed"}, {"oid": "013543db847da87d549915ae0ae06dbc91280780", "url": "https://github.com/nuxeo/nuxeo/commit/013543db847da87d549915ae0ae06dbc91280780", "message": "tmp: common/runtime - compile only", "committedDate": "2020-02-21T10:27:34Z", "type": "forcePushed"}, {"oid": "448505b014864646062353939102fd1e7596846f", "url": "https://github.com/nuxeo/nuxeo/commit/448505b014864646062353939102fd1e7596846f", "message": "tmp: ignore testInitDirectoryWithOnMissingColumnsAndAutoIncrementId", "committedDate": "2020-02-21T15:39:34Z", "type": "forcePushed"}, {"oid": "006048331d0005be09ff2ea364f95259b2e38ff7", "url": "https://github.com/nuxeo/nuxeo/commit/006048331d0005be09ff2ea364f95259b2e38ff7", "message": "tmp: ignore testInitDirectoryWithOnMissingColumnsAndAutoIncrementId", "committedDate": "2020-02-21T16:59:28Z", "type": "forcePushed"}, {"oid": "bbf515227cf7a75635e16e3b821f164edc2a34ed", "url": "https://github.com/nuxeo/nuxeo/commit/bbf515227cf7a75635e16e3b821f164edc2a34ed", "message": "tmp: test stage acc", "committedDate": "2020-02-22T22:40:49Z", "type": "forcePushed"}, {"oid": "555a6008df4327d340581031dacc11dcfbee1cb2", "url": "https://github.com/nuxeo/nuxeo/commit/555a6008df4327d340581031dacc11dcfbee1cb2", "message": "tmp: quick test", "committedDate": "2020-02-22T23:09:10Z", "type": "forcePushed"}, {"oid": "fc1d27476bd28c154c372ca763d0cded3f17ecac", "url": "https://github.com/nuxeo/nuxeo/commit/fc1d27476bd28c154c372ca763d0cded3f17ecac", "message": "tmp: test no junit", "committedDate": "2020-02-22T23:21:46Z", "type": "forcePushed"}, {"oid": "a76131d304d448b43f9f812846b037a9782b4919", "url": "https://github.com/nuxeo/nuxeo/commit/a76131d304d448b43f9f812846b037a9782b4919", "message": "tmp: test labels", "committedDate": "2020-02-22T23:29:40Z", "type": "forcePushed"}, {"oid": "04bc74f7302dc5ad132636c19508ec83c2ebfe6d", "url": "https://github.com/nuxeo/nuxeo/commit/04bc74f7302dc5ad132636c19508ec83c2ebfe6d", "message": "NXP-28579: Set labels on the redis/mongodb/postgresql resources started for unit tests", "committedDate": "2020-02-22T23:39:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE5MzE3OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3733#discussion_r383193178", "bodyText": "What if the file does not exist? Dunno if we will have the case...", "author": "troger", "createdAt": "2020-02-24T10:45:29Z", "path": "Jenkinsfile", "diffHunk": "@@ -130,7 +130,8 @@ def buildUnitTestStage(env) {\n             sh 'envsubst < ci/helm/nuxeo-test-base-values.yaml > nuxeo-test-base-values.yaml'\n             def testValues = '--set-file=nuxeo-test-base-values.yaml'\n             if (!isDev) {\n-              testValues += \" --set-file=ci/helm/nuxeo-test-${env}-values.yaml\"\n+              sh \"envsubst < ci/helm/nuxeo-test-${env}-values.yaml > nuxeo-test-${env}-values.yaml\"", "originalCommit": "04bc74f7302dc5ad132636c19508ec83c2ebfe6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxMTYwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3733#discussion_r383211606", "bodyText": "Shouldn't have the case, we assume we're maintaining the values files according to the env list.", "author": "ataillefer", "createdAt": "2020-02-24T11:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE5MzE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE5NzA5Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3733#discussion_r383197092", "bodyText": "Shouldn't we use something like:\nmvn -B -nsu -rm nuxeo-core \\\n\n?", "author": "troger", "createdAt": "2020-02-24T10:52:47Z", "path": "Jenkinsfile", "diffHunk": "@@ -100,19 +105,111 @@ void skaffoldBuildAll() {\n   skaffoldBuild('docker/nuxeo/skaffold.yaml')\n }\n \n+def buildUnitTestStage(env) {\n+  def isDev = env == 'dev'\n+  def testNamespace = \"${TEST_NAMESPACE_PREFIX}-${env}\"\n+  def redisHost = \"${TEST_REDIS_RESOURCE}.${testNamespace}.${TEST_SERVICE_DOMAIN_SUFFIX}\"\n+  return {\n+    stage(\"Run ${env} unit tests\") {\n+      container('maven') {\n+        script {\n+          setGitHubBuildStatus(\"platform/utests/${env}\", \"Unit tests - ${env} environment\", 'PENDING')\n+          try {\n+            echo \"\"\"\n+            ----------------------------------------\n+            Run ${env} unit tests\n+            ----------------------------------------\"\"\"\n+\n+            echo \"${env} unit tests: install external services\"\n+            // initialize Helm without Tiller and add local repository\n+            sh \"\"\"\n+              helm init --client-only\n+              helm repo add ${HELM_CHART_REPOSITORY_NAME} ${HELM_CHART_REPOSITORY_URL}\n+            \"\"\"\n+            // prepare values to disable nuxeo and activate external services in the nuxeo Helm chart\n+            sh 'envsubst < ci/helm/nuxeo-test-base-values.yaml > nuxeo-test-base-values.yaml'\n+            def testValues = '--set-file=nuxeo-test-base-values.yaml'\n+            if (!isDev) {\n+              testValues += \" --set-file=ci/helm/nuxeo-test-${env}-values.yaml\"\n+            }\n+            // install the nuxeo Helm chart into a dedicated namespace that will be cleaned up afterwards\n+            sh \"\"\"\n+              jx step helm install ${HELM_CHART_REPOSITORY_NAME}/${HELM_CHART_NUXEO} \\\n+                --name ${TEST_HELM_CHART_RELEASE} \\\n+                --namespace ${testNamespace} \\\n+                ${testValues}\n+            \"\"\"\n+            // wait for external services to be ready\n+            sh \"kubectl rollout status statefulset ${TEST_REDIS_RESOURCE} --namespace ${testNamespace}\"\n+            if (!isDev) {\n+              def resourceType = env == 'mongodb' ? 'deployment' : 'statefulset'\n+              sh \"kubectl rollout status ${resourceType} ${TEST_HELM_CHART_RELEASE}-${env} --namespace ${testNamespace}\"\n+            }\n+\n+            echo \"${env} unit tests: run Maven\"\n+            // prepare backend-specific system properties\n+            if (!isDev) {\n+              sh \"\"\"\n+                CHART_RELEASE=${TEST_HELM_CHART_RELEASE} SERVICE=${env} NAMESPACE=${testNamespace} DOMAIN=${TEST_SERVICE_DOMAIN_SUFFIX} \\\n+                  envsubst < ci/mvn/nuxeo-test-${env}.properties > ${HOME}/nuxeo-test-${env}.properties\n+              \"\"\"\n+            } else {\n+              sh \"cp ci/mvn/nuxeo-test-${env}.properties ${HOME}/nuxeo-test-${env}.properties\"\n+            }\n+            // run unit tests:\n+            // - in nuxeo-core and dependent projects only (nuxeo-common and nuxeo-runtime are run in dedicated stages)\n+            // - for the given environment (see the customEnvironment profile in pom.xml):\n+            //   - in an alternative build directory\n+            //   - loading some backend-specific system properties\n+            def testCore = env == 'mongodb' ? 'mongodb' : 'vcs'\n+            sh \"\"\"\n+              mvn -B -nsu -pl nuxeo-core -amd \\", "originalCommit": "477ca77560b499b6a3d2b9286c3127e03ecb72a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "910eace44c03e42a7e089dedb962052361d5e98d", "url": "https://github.com/nuxeo/nuxeo/commit/910eace44c03e42a7e089dedb962052361d5e98d", "message": "NXP-28579: Set labels on the redis/mongodb/postgresql resources started for unit tests", "committedDate": "2020-02-24T11:26:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg5Mzk5Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3733#discussion_r383893996", "bodyText": "Do we have an interest to distinct the dev/non-dev case?\nIt may be easier to read to not have the if.", "author": "kevinleturc", "createdAt": "2020-02-25T13:58:27Z", "path": "Jenkinsfile", "diffHunk": "@@ -100,19 +105,112 @@ void skaffoldBuildAll() {\n   skaffoldBuild('docker/nuxeo/skaffold.yaml')\n }\n \n+def buildUnitTestStage(env) {\n+  def isDev = env == 'dev'\n+  def testNamespace = \"${TEST_NAMESPACE_PREFIX}-${env}\"\n+  def redisHost = \"${TEST_REDIS_RESOURCE}.${testNamespace}.${TEST_SERVICE_DOMAIN_SUFFIX}\"\n+  return {\n+    stage(\"Run ${env} unit tests\") {\n+      container('maven') {\n+        script {\n+          setGitHubBuildStatus(\"platform/utests/${env}\", \"Unit tests - ${env} environment\", 'PENDING')\n+          try {\n+            echo \"\"\"\n+            ----------------------------------------\n+            Run ${env} unit tests\n+            ----------------------------------------\"\"\"\n+\n+            echo \"${env} unit tests: install external services\"\n+            // initialize Helm without Tiller and add local repository\n+            sh \"\"\"\n+              helm init --client-only\n+              helm repo add ${HELM_CHART_REPOSITORY_NAME} ${HELM_CHART_REPOSITORY_URL}\n+            \"\"\"\n+            // prepare values to disable nuxeo and activate external services in the nuxeo Helm chart\n+            sh 'envsubst < ci/helm/nuxeo-test-base-values.yaml > nuxeo-test-base-values.yaml'\n+            def testValues = '--set-file=nuxeo-test-base-values.yaml'\n+            if (!isDev) {\n+              sh \"envsubst < ci/helm/nuxeo-test-${env}-values.yaml > nuxeo-test-${env}-values.yaml\"\n+              testValues += \" --set-file=nuxeo-test-${env}-values.yaml\"\n+            }\n+            // install the nuxeo Helm chart into a dedicated namespace that will be cleaned up afterwards\n+            sh \"\"\"\n+              jx step helm install ${HELM_CHART_REPOSITORY_NAME}/${HELM_CHART_NUXEO} \\\n+                --name ${TEST_HELM_CHART_RELEASE} \\\n+                --namespace ${testNamespace} \\\n+                ${testValues}\n+            \"\"\"\n+            // wait for external services to be ready\n+            sh \"kubectl rollout status statefulset ${TEST_REDIS_RESOURCE} --namespace ${testNamespace}\"\n+            if (!isDev) {\n+              def resourceType = env == 'mongodb' ? 'deployment' : 'statefulset'\n+              sh \"kubectl rollout status ${resourceType} ${TEST_HELM_CHART_RELEASE}-${env} --namespace ${testNamespace}\"\n+            }\n+\n+            echo \"${env} unit tests: run Maven\"\n+            // prepare backend-specific system properties\n+            if (!isDev) {\n+              sh \"\"\"\n+                CHART_RELEASE=${TEST_HELM_CHART_RELEASE} SERVICE=${env} NAMESPACE=${testNamespace} DOMAIN=${TEST_SERVICE_DOMAIN_SUFFIX} \\\n+                  envsubst < ci/mvn/nuxeo-test-${env}.properties > ${HOME}/nuxeo-test-${env}.properties\n+              \"\"\"\n+            } else {\n+              sh \"cp ci/mvn/nuxeo-test-${env}.properties ${HOME}/nuxeo-test-${env}.properties\"\n+            }", "originalCommit": "910eace44c03e42a7e089dedb962052361d5e98d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "300a399cb824dbc56a85124def4d69d78a86076e", "url": "https://github.com/nuxeo/nuxeo/commit/300a399cb824dbc56a85124def4d69d78a86076e", "message": "NXP-28579: Set labels on the redis/mongodb/postgresql resources started for unit tests", "committedDate": "2020-02-25T14:16:06Z", "type": "forcePushed"}, {"oid": "b0a31c884a1e2248522eea3c547c23aee7f8ca93", "url": "https://github.com/nuxeo/nuxeo/commit/b0a31c884a1e2248522eea3c547c23aee7f8ca93", "message": "NXP-28579: Run unit tests against H2, MongoDB and PostgreSQL in parallel", "committedDate": "2020-02-26T07:35:50Z", "type": "commit"}, {"oid": "efd7f617a9df4353f74ec552f44a7bf4058b4293", "url": "https://github.com/nuxeo/nuxeo/commit/efd7f617a9df4353f74ec552f44a7bf4058b4293", "message": "NXP-28579: Set labels on the redis/mongodb/postgresql resources started for unit tests", "committedDate": "2020-02-26T07:35:50Z", "type": "commit"}, {"oid": "a3604b326a010a6e07b0cad34e518504ac65b184", "url": "https://github.com/nuxeo/nuxeo/commit/a3604b326a010a6e07b0cad34e518504ac65b184", "message": "NXP-28579: Avoid mongodb/postgresql rollout status being stuck\n\nThis can happen in case of ImagePullBackOff, for instance:\n```\nstatus:\n  containerStatuses:\n  - image: docker.io/bitnami/postgresql:11.7\n    state:\n      waiting:\n        message: Back-off pulling image \"docker.io/bitnami/postgresql:11.7\"\n        reason: ImagePullBackOff\n```", "committedDate": "2020-02-26T07:35:50Z", "type": "commit"}, {"oid": "a3604b326a010a6e07b0cad34e518504ac65b184", "url": "https://github.com/nuxeo/nuxeo/commit/a3604b326a010a6e07b0cad34e518504ac65b184", "message": "NXP-28579: Avoid mongodb/postgresql rollout status being stuck\n\nThis can happen in case of ImagePullBackOff, for instance:\n```\nstatus:\n  containerStatuses:\n  - image: docker.io/bitnami/postgresql:11.7\n    state:\n      waiting:\n        message: Back-off pulling image \"docker.io/bitnami/postgresql:11.7\"\n        reason: ImagePullBackOff\n```", "committedDate": "2020-02-26T07:35:50Z", "type": "forcePushed"}]}