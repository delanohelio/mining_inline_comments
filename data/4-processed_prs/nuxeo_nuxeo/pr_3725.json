{"pr_number": 3725, "pr_title": "NXP-28622: fix delete namespace still in terminating state", "pr_createdAt": "2020-02-05T16:58:24Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3725", "timeline": [{"oid": "80482772aef02b95fc76a93120de3bc1321afeb8", "url": "https://github.com/nuxeo/nuxeo/commit/80482772aef02b95fc76a93120de3bc1321afeb8", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-05T17:00:30Z", "type": "forcePushed"}, {"oid": "c2fd3e4a7ef4044554e6f40bffdb6069b6571603", "url": "https://github.com/nuxeo/nuxeo/commit/c2fd3e4a7ef4044554e6f40bffdb6069b6571603", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-05T17:50:55Z", "type": "forcePushed"}, {"oid": "80876cf41b30def8f661039f75d75f02c1d9c162", "url": "https://github.com/nuxeo/nuxeo/commit/80876cf41b30def8f661039f75d75f02c1d9c162", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T09:43:03Z", "type": "forcePushed"}, {"oid": "af044fe9adcd6fed0a7a4b7ac7f4d33146e3cb9d", "url": "https://github.com/nuxeo/nuxeo/commit/af044fe9adcd6fed0a7a4b7ac7f4d33146e3cb9d", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T09:45:48Z", "type": "forcePushed"}, {"oid": "2a40f647c0a9cde73c07d0f37d50803ef1d64717", "url": "https://github.com/nuxeo/nuxeo/commit/2a40f647c0a9cde73c07d0f37d50803ef1d64717", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T09:47:34Z", "type": "forcePushed"}, {"oid": "4cd703489cfbe2a0ba7c93f1f46f14576af1a136", "url": "https://github.com/nuxeo/nuxeo/commit/4cd703489cfbe2a0ba7c93f1f46f14576af1a136", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T10:14:37Z", "type": "forcePushed"}, {"oid": "b2049805fe636ad54ef0ef17ae7fa9a150f420aa", "url": "https://github.com/nuxeo/nuxeo/commit/b2049805fe636ad54ef0ef17ae7fa9a150f420aa", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T10:16:03Z", "type": "forcePushed"}, {"oid": "af5d70a12c373f901f33f665e828547418a47357", "url": "https://github.com/nuxeo/nuxeo/commit/af5d70a12c373f901f33f665e828547418a47357", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T10:37:52Z", "type": "forcePushed"}, {"oid": "dc024663b9561255881b62e7782215472e06ae70", "url": "https://github.com/nuxeo/nuxeo/commit/dc024663b9561255881b62e7782215472e06ae70", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T10:42:23Z", "type": "forcePushed"}, {"oid": "a22882db4dd223586283f776ec832d5f63cb4d3b", "url": "https://github.com/nuxeo/nuxeo/commit/a22882db4dd223586283f776ec832d5f63cb4d3b", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T12:56:54Z", "type": "forcePushed"}, {"oid": "1f5e9b1262eba3881358f4c6e6b887afe163a64f", "url": "https://github.com/nuxeo/nuxeo/commit/1f5e9b1262eba3881358f4c6e6b887afe163a64f", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T13:16:04Z", "type": "forcePushed"}, {"oid": "f4cdddd6bb62f6b3778bee540c05c31e88a313fb", "url": "https://github.com/nuxeo/nuxeo/commit/f4cdddd6bb62f6b3778bee540c05c31e88a313fb", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T13:28:49Z", "type": "forcePushed"}, {"oid": "353da8b2c35fc2f12c0e3c65cbe6b871a606609e", "url": "https://github.com/nuxeo/nuxeo/commit/353da8b2c35fc2f12c0e3c65cbe6b871a606609e", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-06T13:41:53Z", "type": "forcePushed"}, {"oid": "7d795afd61d253230be6e7e3d62771fc96568b21", "url": "https://github.com/nuxeo/nuxeo/commit/7d795afd61d253230be6e7e3d62771fc96568b21", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-07T08:28:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5MzE2MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376293161", "bodyText": "I think we can remove --cascade=true --force=1 --grace-period=0 since a plain deletion is expected to work here.", "author": "ataillefer", "createdAt": "2020-02-07T09:30:52Z", "path": "Jenkinsfile", "diffHunk": "@@ -388,8 +388,18 @@ pipeline {\n         always {\n           junit testResults: '**/target/surefire-reports/*.xml'\n           container('maven') {\n-            // clean up the redis namespace\n-            sh \"kubectl delete namespace ${NAMESPACE_REDIS} --ignore-not-found=true\"\n+            script {\n+              try {\n+                 // clean up the redis namespace\n+                // workaround for Cannot delete namespace still in Terminating #NXP-3228\n+                sh \"\"\"\n+                  kubectl get namespace ${NAMESPACE_REDIS} -o json | sed -e s/\\\\\"kubernetes\\\\\"//g  | kubectl replace --raw /api/v1/namespaces/${NAMESPACE_REDIS}/finalize -f -\n+                  kubectl delete namespace ${NAMESPACE_REDIS} --ignore-not-found=true --cascade=true --force=1 --grace-period=0", "originalCommit": "7d795afd61d253230be6e7e3d62771fc96568b21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5ODY0Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376298647", "bodyText": "thanks,\nwe can delete this options as you said", "author": "doulba", "createdAt": "2020-02-07T09:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5MzE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5NjM3Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376296377", "bodyText": "Can you please indent with 2 spaces instead of 3", "author": "ataillefer", "createdAt": "2020-02-07T09:38:05Z", "path": "Jenkinsfile", "diffHunk": "@@ -388,8 +388,18 @@ pipeline {\n         always {\n           junit testResults: '**/target/surefire-reports/*.xml'\n           container('maven') {\n-            // clean up the redis namespace\n-            sh \"kubectl delete namespace ${NAMESPACE_REDIS} --ignore-not-found=true\"\n+            script {\n+              try {\n+                 // clean up the redis namespace", "originalCommit": "7d795afd61d253230be6e7e3d62771fc96568b21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMTM1MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376301351", "bodyText": "done", "author": "doulba", "createdAt": "2020-02-07T09:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5NjM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5NzEwNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376297107", "bodyText": "I'm not in favor of catching any error here: if there is an error in the workaround or the deletion, it is not expected, so we want to be aware of it even if it makes the build fail.\nThis is how we detected the namespace deletion problem in the first place, because the jobs were red.", "author": "ataillefer", "createdAt": "2020-02-07T09:39:39Z", "path": "Jenkinsfile", "diffHunk": "@@ -388,8 +388,18 @@ pipeline {\n         always {\n           junit testResults: '**/target/surefire-reports/*.xml'\n           container('maven') {\n-            // clean up the redis namespace\n-            sh \"kubectl delete namespace ${NAMESPACE_REDIS} --ignore-not-found=true\"\n+            script {\n+              try {\n+                 // clean up the redis namespace\n+                // workaround for Cannot delete namespace still in Terminating #NXP-3228\n+                sh \"\"\"\n+                  kubectl get namespace ${NAMESPACE_REDIS} -o json | sed -e s/\\\\\"kubernetes\\\\\"//g  | kubectl replace --raw /api/v1/namespaces/${NAMESPACE_REDIS}/finalize -f -\n+                  kubectl delete namespace ${NAMESPACE_REDIS} --ignore-not-found=true --cascade=true --force=1 --grace-period=0\n+                \"\"\"\n+              } catch (err) {", "originalCommit": "7d795afd61d253230be6e7e3d62771fc96568b21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMjk4OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376302988", "bodyText": "we can remove the try catch and monitor the namespace  deletion\nif many build failed due to this error perhaps we should reactivates the try catch.", "author": "doulba", "createdAt": "2020-02-07T09:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5NzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM0ODAxNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376348017", "bodyText": "yep, I think the workaround will do its job fine", "author": "ataillefer", "createdAt": "2020-02-07T11:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5NzEwNw=="}], "type": "inlineReview"}, {"oid": "a0d3794c5215c64b61701f31a41adaf1566e9853", "url": "https://github.com/nuxeo/nuxeo/commit/a0d3794c5215c64b61701f31a41adaf1566e9853", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-07T09:47:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMzgzOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376303839", "bodyText": "Wrong NXP I think :)", "author": "troger", "createdAt": "2020-02-07T09:53:47Z", "path": "Jenkinsfile", "diffHunk": "@@ -388,8 +388,14 @@ pipeline {\n         always {\n           junit testResults: '**/target/surefire-reports/*.xml'\n           container('maven') {\n-            // clean up the redis namespace\n-            sh \"kubectl delete namespace ${NAMESPACE_REDIS} --ignore-not-found=true\"\n+            script {\n+              // clean up the redis namespace\n+              // workaround for Cannot delete namespace still in Terminating #NXP-3228", "originalCommit": "a0d3794c5215c64b61701f31a41adaf1566e9853", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMzk5Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376303993", "bodyText": "Not sure we need script here as we don't do script?", "author": "kevinleturc", "createdAt": "2020-02-07T09:54:08Z", "path": "Jenkinsfile", "diffHunk": "@@ -388,8 +388,14 @@ pipeline {\n         always {\n           junit testResults: '**/target/surefire-reports/*.xml'\n           container('maven') {\n-            // clean up the redis namespace\n-            sh \"kubectl delete namespace ${NAMESPACE_REDIS} --ignore-not-found=true\"\n+            script {", "originalCommit": "a0d3794c5215c64b61701f31a41adaf1566e9853", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNzMyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3725#discussion_r376307322", "bodyText": "yes,\ni have tested many solutions , that\u2019s way we still have scripts  section.\ni will  remove it", "author": "doulba", "createdAt": "2020-02-07T10:01:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMzk5Mw=="}], "type": "inlineReview"}, {"oid": "7963d78893c861993d2b58fa9b94ed925626c6b3", "url": "https://github.com/nuxeo/nuxeo/commit/7963d78893c861993d2b58fa9b94ed925626c6b3", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-07T10:01:51Z", "type": "commit"}, {"oid": "7963d78893c861993d2b58fa9b94ed925626c6b3", "url": "https://github.com/nuxeo/nuxeo/commit/7963d78893c861993d2b58fa9b94ed925626c6b3", "message": "NXP-28622: fix delete namespace still in terminating state", "committedDate": "2020-02-07T10:01:51Z", "type": "forcePushed"}]}