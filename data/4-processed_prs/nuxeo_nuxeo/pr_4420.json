{"pr_number": 4420, "pr_title": "NXP-29738: Fix S3 direct upload same file import", "pr_createdAt": "2020-10-28T16:19:46Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4420", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4NjEyNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519686127", "bodyText": "Could you add a Javadoc explaining that it returns the ETag of the resulting blob?", "author": "efge", "createdAt": "2020-11-09T10:01:41Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {", "originalCommit": "61823cd62fe9f84e2862dc8e804428e2697f3d84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4ODIyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519688222", "bodyText": "Should we also catch AmazonS3Exception for this delete and just log a debug, like in the case where doesObjectExist returns true?", "author": "efge", "createdAt": "2020-11-09T10:05:03Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -339,6 +334,19 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n+    protected String doMove(CopyObjectRequest request) {\n+        Copy rename = getTransferManager().copy(request);\n+        try {\n+            var copyResult = rename.waitForCopyResult();\n+            return copyResult.getETag();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new NuxeoException(e);\n+        } finally {\n+            amazonS3.deleteObject(bucket, request.getSourceKey());", "originalCommit": "61823cd62fe9f84e2862dc8e804428e2697f3d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MzMzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519743335", "bodyText": "I think so, object deletion shouldn't fail the upload if failing.", "author": "kevinleturc", "createdAt": "2020-11-09T11:37:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4ODIyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0NTQ5OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4420#discussion_r519745498", "bodyText": "I will also try/catch/addSuppressed at this location https://github.com/nuxeo/nuxeo/pull/4420/files#diff-6840572d6cd2147c22a5ea5800d2525059bb39c001a5909d15f0370f9ee506d8R330 to not shallow the original NuxeoException.", "author": "kevinleturc", "createdAt": "2020-11-09T11:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4ODIyMg=="}], "type": "inlineReview"}, {"oid": "be944fb88b26e684a07aff08d7c54b017afd7159", "url": "https://github.com/nuxeo/nuxeo/commit/be944fb88b26e684a07aff08d7c54b017afd7159", "message": "NXP-29738: Cleanup / Format", "committedDate": "2020-11-09T11:26:03Z", "type": "commit"}, {"oid": "e2e248851e6f2a2078dd94f9e857b652b1010015", "url": "https://github.com/nuxeo/nuxeo/commit/e2e248851e6f2a2078dd94f9e857b652b1010015", "message": "NXP-29738: Fix S3 direct upload same file import", "committedDate": "2020-11-09T11:51:22Z", "type": "commit"}, {"oid": "e2e248851e6f2a2078dd94f9e857b652b1010015", "url": "https://github.com/nuxeo/nuxeo/commit/e2e248851e6f2a2078dd94f9e857b652b1010015", "message": "NXP-29738: Fix S3 direct upload same file import", "committedDate": "2020-11-09T11:51:22Z", "type": "forcePushed"}]}