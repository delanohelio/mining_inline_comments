{"pr_number": 4236, "pr_title": "NXP-29319: allow using any file key in s3", "pr_createdAt": "2020-08-03T17:22:52Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4236", "timeline": [{"oid": "40ff6457df1a5c307b47b778aab50cd14a3300d1", "url": "https://github.com/nuxeo/nuxeo/commit/40ff6457df1a5c307b47b778aab50cd14a3300d1", "message": "NXP-29319: allow using any file key in s3", "committedDate": "2020-08-03T18:00:47Z", "type": "forcePushed"}, {"oid": "151b46d88e8b7ae4c82f7e4202280e0e338ac575", "url": "https://github.com/nuxeo/nuxeo/commit/151b46d88e8b7ae4c82f7e4202280e0e338ac575", "message": "NXP-29319: allow using any file key in s3", "committedDate": "2020-08-06T11:00:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwMTk0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4236#discussion_r466501941", "bodyText": "Here we need to strip the @versionid if one is present. This needs S3BlobStore.VER_SEP which should probably be moved to AbstractBlobStore and made public. (This is a bit dirty because versions are S3-specific at the moment and here we're in more generic code but at least it'll work and we can refactor later.)", "author": "efge", "createdAt": "2020-08-06T15:36:23Z", "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/blob/KeyStrategyManaged.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.nuxeo.ecm.core.blob;\n+\n+/**\n+ * Represents trusted managed blob key computation with a fallback {@link KeyStrategy}\n+ *\n+ * @since 11.2\n+ */\n+public class KeyStrategyManaged implements KeyStrategy {\n+\n+    protected final KeyStrategy strategy;\n+\n+    public KeyStrategyManaged(KeyStrategy strategy) {\n+        this.strategy = strategy;\n+    }\n+\n+    @Override\n+    public boolean useDeDuplication() {\n+        return false;\n+    }\n+\n+    @Override\n+    public String getDigestFromKey(String key) {\n+        return null;\n+    }\n+\n+    @Override\n+    public BlobWriteContext getBlobWriteContext(BlobContext blobContext)  {\n+        if (blobContext.blob instanceof ManagedBlob) {\n+            String key = ((ManagedBlob) blobContext.blob).getKey();", "originalCommit": "151b46d88e8b7ae4c82f7e4202280e0e338ac575", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwMTQ5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4236#discussion_r466701490", "bodyText": "Moved VER_SEP to KeyStrategy (not sure how you feel about constants in interfaces but it makes for clean code).", "author": "nelsonsilva", "createdAt": "2020-08-06T21:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwMTk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNDQ2Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4236#discussion_r466504463", "bodyText": "It's likely that in the presence of versions this will be incorrect too, the fileKey will contain a @versionid but we want to do a delete of a specific version (-> parsing and use of amazonS3.deleteVersion, see S3BlobStore.deleteBlob) ...", "author": "efge", "createdAt": "2020-08-06T15:39:50Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -312,13 +320,25 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         try {\n             batch.addFile(fileIndex, blob, blob.getFilename(), blob.getMimeType());\n         } catch (NuxeoException e) {\n-            amazonS3.deleteObject(bucket, bucketKey);\n+            amazonS3.deleteObject(bucket, fileKey);", "originalCommit": "151b46d88e8b7ae4c82f7e4202280e0e338ac575", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5OTQxOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4236#discussion_r466699419", "bodyText": "The fileKey here is coming from the client so I don't think we'll ever have a @versionId", "author": "nelsonsilva", "createdAt": "2020-08-06T21:35:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNDQ2Mw=="}], "type": "inlineReview"}, {"oid": "44b75237f9390b8c460a3b799d585011babc0076", "url": "https://github.com/nuxeo/nuxeo/commit/44b75237f9390b8c460a3b799d585011babc0076", "message": "NXP-29319: allow using any file key in s3", "committedDate": "2020-08-06T21:38:58Z", "type": "commit"}, {"oid": "1344b88ed288cb4be01a5588f6ab7ee081ad543c", "url": "https://github.com/nuxeo/nuxeo/commit/1344b88ed288cb4be01a5588f6ab7ee081ad543c", "message": "NXP-29319: strip version id from managed blob keys", "committedDate": "2020-08-06T21:38:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMTQ0NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4236#discussion_r467101445", "bodyText": "Is this configuration change is compatible with an upgrade? ie: it will be transparent for the users?", "author": "kevinleturc", "createdAt": "2020-08-07T15:10:37Z", "path": "packages/nuxeo-amazon-s3-package/src/main/resources/install/templates/s3binaries/nuxeo.defaults", "diffHunk": "@@ -5,6 +5,7 @@ s3binaries.target=.\n # mandatory\n nuxeo.s3storage.bucket=\n nuxeo.core.binarymanager=org.nuxeo.ecm.core.storage.sql.S3BinaryManager\n+nuxeo.core.blobstore.keyStrategy=managed", "originalCommit": "1344b88ed288cb4be01a5588f6ab7ee081ad543c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5ODQxMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4236#discussion_r467798413", "bodyText": "switching from digest to managed should work fine as we're basically just trusting the client and letting them use any key. We could leave it as digest by default but then uploads > 5GBs won't work... not until [NXP-29517|https://jira.nuxeo.com/browse/NXP-29517] is done. OTOH we can't easily migrate back from managed to digest \ud83e\udd14  so perhaps we should indeed leave it as digest for now", "author": "nelsonsilva", "createdAt": "2020-08-10T09:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzEwMTQ0NQ=="}], "type": "inlineReview"}, {"oid": "23d62d253a4a50244ad285bf2b5d7cb4a870a3e9", "url": "https://github.com/nuxeo/nuxeo/commit/23d62d253a4a50244ad285bf2b5d7cb4a870a3e9", "message": "NXP-29319: strip version id from managed blob keys", "committedDate": "2020-08-10T10:13:46Z", "type": "commit"}, {"oid": "23d62d253a4a50244ad285bf2b5d7cb4a870a3e9", "url": "https://github.com/nuxeo/nuxeo/commit/23d62d253a4a50244ad285bf2b5d7cb4a870a3e9", "message": "NXP-29319: strip version id from managed blob keys", "committedDate": "2020-08-10T10:13:46Z", "type": "forcePushed"}]}