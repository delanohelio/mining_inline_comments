{"pr_number": 3994, "pr_title": "Fix nxp 29066 Init of the ACL document root occurs many times [forward port]", "pr_createdAt": "2020-05-04T10:22:26Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3994", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MjUwNA==", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419342504", "bodyText": "Shouldn't it be the opposite? Start with false and if we found one to create set it to true?", "author": "kevinleturc", "createdAt": "2020-05-04T10:27:24Z", "path": "modules/platform/nuxeo-platform-content-template-manager/src/main/java/org/nuxeo/ecm/platform/content/template/factories/SimpleTemplateBasedRootFactory.java", "diffHunk": "@@ -37,8 +37,10 @@\n     public void createContentStructure(DocumentModel eventDoc) {\n         initSession(eventDoc);\n \n+        boolean initRootAcl = true;\n         for (TemplateItemDescriptor item : template) {\n             if (!shouldCreateDocument(eventDoc.getId(), item.getId(), item.getTypeName())) {\n+                initRootAcl = false;", "originalCommit": "92936f2cc04bcf98f1dfadd8b8a6309219f91a09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0NTkyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419345922", "bodyText": "thx for the point,\nMy idea here is to keep the same flow that was before my initial fix see here\nbefore the fix above, the acl was computed/inited only once (call to shouldCreateContent returns true if at least once child exist) this is the reason why we didn't see the problem before in the test context.\nand in other hand in the case of mongodb see here I am wondering if without the check that I added, perhaps we can face a perfs issue", "author": "RSalem07", "createdAt": "2020-05-04T10:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MjUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2NjU3OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419366578", "bodyText": "Ok, but the flow has been changed with the fix. Now it makes more sense to me to update root ACLs if a child was created whether to not update them if we didn't create a child, or I'm missing something.\nDo you know what happen in such cases? Ie: a child is created and another one is skipped which results in not setting root acls.", "author": "kevinleturc", "createdAt": "2020-05-04T11:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MjUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwMjQ4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419402487", "bodyText": "I see your point of view.I was thinking the same thing.\n\nDo you know what happen in such cases? Ie: a child is created and another one is skipped which results in not setting root acls.\n\n\n...Ie: a child is created and another one is skipped\n\nwith introduced fix each child is created, but the acl of root is re-computed each time. even they don't change, in the case of MongoDB it will re-compute all acl of the children but without making  a merge which it means that the acl are removed and re-created from the root ones and if I am not wrong we will even loose the acl defined on each document.", "author": "RSalem07", "createdAt": "2020-05-04T12:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MjUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxMzcwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419413706", "bodyText": "Ok, is it the case for acls or just read calls?\nAre you saying the last set acl is not useful?", "author": "kevinleturc", "createdAt": "2020-05-04T12:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MjUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MzQ3Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3994#discussion_r419343476", "bodyText": "Maybe something like below?\n            if (docState == null) {\n                if (log.isTraceEnabled()) {\n                    log.trace(\"Cannot fetch document with id: \" + id, new Throwable(\"debug stack trace\"));\n                }\n                return;\n            }", "author": "kevinleturc", "createdAt": "2020-05-04T10:29:19Z", "path": "modules/core/nuxeo-core-storage-dbs/src/main/java/org/nuxeo/ecm/core/storage/dbs/DBSTransactionState.java", "diffHunk": "@@ -641,6 +641,10 @@ public void updateReadACLs(Collection<String> docIds) {\n      */\n     protected void updateDocumentReadAcls(String id) {\n         DBSDocumentState docState = getStateForUpdate(id);\n+        if(docState == null) {\n+            log.trace(\"No document state found for id: \" + id);\n+            return;\n+        }", "originalCommit": "92936f2cc04bcf98f1dfadd8b8a6309219f91a09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e7be2a4eb08fa77760b001faebf06fc2ff356a1", "url": "https://github.com/nuxeo/nuxeo/commit/2e7be2a4eb08fa77760b001faebf06fc2ff356a1", "message": " NXP-29048: Init only once the root template acl", "committedDate": "2020-05-04T10:37:20Z", "type": "forcePushed"}, {"oid": "77b5c119cc5c06c30b709e842a58b7394d102b4a", "url": "https://github.com/nuxeo/nuxeo/commit/77b5c119cc5c06c30b709e842a58b7394d102b4a", "message": " NXP-29048: Init only once the root template acl", "committedDate": "2020-05-04T14:02:22Z", "type": "forcePushed"}, {"oid": "4f24a026617c4533a5e1657e7394b780eaf08968", "url": "https://github.com/nuxeo/nuxeo/commit/4f24a026617c4533a5e1657e7394b780eaf08968", "message": "NXP-29066: Init only once the root template acl", "committedDate": "2020-05-05T11:39:17Z", "type": "commit"}, {"oid": "4f24a026617c4533a5e1657e7394b780eaf08968", "url": "https://github.com/nuxeo/nuxeo/commit/4f24a026617c4533a5e1657e7394b780eaf08968", "message": "NXP-29066: Init only once the root template acl", "committedDate": "2020-05-05T11:39:17Z", "type": "forcePushed"}]}