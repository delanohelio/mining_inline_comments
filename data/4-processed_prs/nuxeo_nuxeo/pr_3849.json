{"pr_number": 3849, "pr_title": "10.10-HF/fix-NXP-28784-Record-management-Missing-abels-in-the-audit-for-retention-events", "pr_createdAt": "2020-03-20T20:33:40Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3849", "timeline": [{"oid": "ffbf3ae013f98f23704c607b138569a1cd979a9f", "url": "https://github.com/nuxeo/nuxeo/commit/ffbf3ae013f98f23704c607b138569a1cd979a9f", "message": "NXP-28784: Record management - Missing labels in the audit for retention events", "committedDate": "2020-03-23T08:48:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396511678", "bodyText": "Since this will appear on client side, my only concern is the date format that may not match what is expected by the user.\nAlso, for the UI this is just a string to be rendered, no further logic since no further information is provided (e.g. type or format).", "author": "nmpcunha", "createdAt": "2020-03-23T14:54:24Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2087,18 +2087,17 @@ public void setRetainUntil(DocumentRef docRef, Calendar retainUntil, String comm\n         checkPermission(doc, SET_RETENTION);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.RETAIN_UNTIL, retainUntil);\n-        String commentStart = retainUntil == null ? null : retainUntil.toInstant().toString();\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else if (commentStart != null) {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n+        options.put(\"comment\", retainUntil == null ? \"\" : retainUntil.toInstant().toString());", "originalCommit": "ffbf3ae013f98f23704c607b138569a1cd979a9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY0NTM4NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396645385", "bodyText": "If you do that you lose the comment passed to the setRetainUntil API, which is a problem as I think it was important. I think it's better to keep the comment and let the retention date live in the options map.  @jaubenque?", "author": "efge", "createdAt": "2020-03-23T17:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMzNzExNw==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r397337117", "bodyText": "Not sure to understand the point but:\n\nthe expiration date (when known) is mandatory in the setRetainUntil  audit log\nfor setRetainUntil audit log, the only possible comment is the expiration date\nfor setRetainUntil audit log, the expiration date can be updated (when extending the retention)\nthe only case where the comment part can contain a text from the user is when applying a legal hold", "author": "jaubenque", "createdAt": "2020-03-24T17:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NzI3Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r397357273", "bodyText": "@jaubenque well at the API level we allow a comment at the time we set a retention, it could be used to propagate a user-level message about the reason why retention is set/extended. Even if it's not the case today I think we should leave the possibility open so not \"burn\" this field with a date which is already available (technically) elsewhere (in the options). The comment field is really reserved for user-level messages.", "author": "efge", "createdAt": "2020-03-24T18:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM3MTI4Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r397371286", "bodyText": "Also, as already reported, on client side that comment is just text, we don't have further information about its nature (i.e. if it represents a date, a document reference, or so).\n@jaubenque given these infos, would it make sense to review / rework those audit entries requirements?", "author": "nmpcunha", "createdAt": "2020-03-24T18:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0OTY1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r397749652", "bodyText": "I understand the issue but displaying the date into the audit log is a mandatory requirement for retention. In some situations, as a litigation, you can have auditor people who will inspect all the events occuring on a given document.\nIf we only displayed the date in the header, you won't be able to get the full history regarding the retention period but only the current status.", "author": "jaubenque", "createdAt": "2020-03-25T10:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgwMjY1Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r397802653", "bodyText": "IMHO the date should go in the extended audit data so it does fulfil the requirement of having it in the audit log without abusing the human readable / unformatted \"comment\" field. The audit data is by default persisted in ES afaik and there are plenty of better ways to analyse this data than through the Web UI admin center. If we want to have that available in WebUI anyway I propose we make the entended audit entry data available in the UI somehow (but not in a way that requires parsing it, probably some sort of JSON on mouse hover)", "author": "nelsonsilva", "createdAt": "2020-03-25T12:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAzMzIzOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r398033239", "bodyText": "see comment below", "author": "RSalem07", "createdAt": "2020-03-25T17:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMTY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUzMzUxOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396533518", "bodyText": "Cool, this should solve the bug reported on https://jira.nuxeo.com/browse/NXP-28786", "author": "nmpcunha", "createdAt": "2020-03-23T15:23:06Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2087,18 +2087,17 @@ public void setRetainUntil(DocumentRef docRef, Calendar retainUntil, String comm\n         checkPermission(doc, SET_RETENTION);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.RETAIN_UNTIL, retainUntil);\n-        String commentStart = retainUntil == null ? null : retainUntil.toInstant().toString();\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else if (commentStart != null) {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n+        options.put(\"comment\", retainUntil == null ? \"\" : retainUntil.toInstant().toString());\n         DocumentModel docModel = readModel(doc);\n-        notifyEvent(DocumentEventTypes.BEFORE_SET_RETENTION, docModel, options, null, null, true, false);\n+        boolean currentIndeterminate = current == null || RETAIN_UNTIL_INDETERMINATE.compareTo(current) == 0;\n+        String beforeRetentionEvent = currentIndeterminate ? DocumentEventTypes.BEFORE_SET_RETENTION\n+                : DocumentEventTypes.BEFORE_EXTEND_RETENTION;\n+        notifyEvent(beforeRetentionEvent, docModel, options, null, null, true, false);\n         doc.setRetainUntil(retainUntil);\n         docModel = readModel(doc);\n-        notifyEvent(DocumentEventTypes.AFTER_SET_RETENTION, docModel, options, null, null, true, false);\n+        String afterRetentionEvent = currentIndeterminate ? DocumentEventTypes.AFTER_SET_RETENTION", "originalCommit": "ffbf3ae013f98f23704c607b138569a1cd979a9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAzMzUwOA==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r398033508", "bodyText": "done in the second comment :)", "author": "RSalem07", "createdAt": "2020-03-25T17:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUzMzUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY0ODYxOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r396648619", "bodyText": "In the platform we prefer to not have negations in ternary operators, so comment == null ? \"\" : comment. But actually in this case it would be even better to use the semantically cleaner StringUtils.defaultString(comment)", "author": "efge", "createdAt": "2020-03-23T18:00:14Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2122,17 +2121,13 @@ public void setLegalHold(DocumentRef docRef, boolean hold, String comment) {\n         DocumentModel docModel = readModel(doc);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.LEGAL_HOLD, Boolean.valueOf(hold));\n-        String commentStart = Boolean.toString(hold);\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n-        notifyEvent(DocumentEventTypes.BEFORE_SET_LEGAL_HOLD, docModel, options, null, null, true, false);\n+        options.put(\"comment\", comment != null ? comment : \"\");", "originalCommit": "ffbf3ae013f98f23704c607b138569a1cd979a9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk3Mjk3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3849#discussion_r397972971", "bodyText": "Now that we have two events, you can remove the options.put(CoreEventConstants.LEGAL_HOLD, Boolean.valueOf(hold)) a few lines above, which is useless because it doesn't bring any info.\nAnd remove the constant LEGAL_HOLD and the references to it in the Javadoc.", "author": "efge", "createdAt": "2020-03-25T16:01:37Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2122,17 +2121,13 @@ public void setLegalHold(DocumentRef docRef, boolean hold, String comment) {\n         DocumentModel docModel = readModel(doc);\n         Map<String, Serializable> options = new HashMap<>();\n         options.put(CoreEventConstants.LEGAL_HOLD, Boolean.valueOf(hold));\n-        String commentStart = Boolean.toString(hold);\n-        if (comment == null) {\n-            comment = commentStart;\n-        } else {\n-            comment = commentStart + \" \" + comment;\n-        }\n-        options.put(\"comment\", comment);\n-        notifyEvent(DocumentEventTypes.BEFORE_SET_LEGAL_HOLD, docModel, options, null, null, true, false);\n+        options.put(\"comment\", comment != null ? comment : \"\");\n+        String beforeLegalHoldEvent = hold ? DocumentEventTypes.BEFORE_SET_LEGAL_HOLD : DocumentEventTypes.BEFORE_REMOVE_LEGAL_HOLD;", "originalCommit": "ffbf3ae013f98f23704c607b138569a1cd979a9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "080cf7168ff14a72ef1f49383c81d93f03553cb5", "url": "https://github.com/nuxeo/nuxeo/commit/080cf7168ff14a72ef1f49383c81d93f03553cb5", "message": "NXP-28784: Record management - Missing labels in the audit for retention events", "committedDate": "2020-03-25T16:13:01Z", "type": "forcePushed"}, {"oid": "642a7852e819ce1c2b3e11e15409f7e944a15e2b", "url": "https://github.com/nuxeo/nuxeo/commit/642a7852e819ce1c2b3e11e15409f7e944a15e2b", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention", "committedDate": "2020-03-26T09:20:48Z", "type": "forcePushed"}, {"oid": "7b81b2cf5b71e7d59de0607535870078095b9726", "url": "https://github.com/nuxeo/nuxeo/commit/7b81b2cf5b71e7d59de0607535870078095b9726", "message": "NXP-28784: Record management - Missing labels in the audit for retention events", "committedDate": "2020-03-27T11:04:37Z", "type": "commit"}, {"oid": "3cab2e8f57e86b129e0bafeb49683fff1902a510", "url": "https://github.com/nuxeo/nuxeo/commit/3cab2e8f57e86b129e0bafeb49683fff1902a510", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention", "committedDate": "2020-03-27T11:05:11Z", "type": "commit"}, {"oid": "3cab2e8f57e86b129e0bafeb49683fff1902a510", "url": "https://github.com/nuxeo/nuxeo/commit/3cab2e8f57e86b129e0bafeb49683fff1902a510", "message": "NXP-28786: Record management - Expiration date displayed for undeterminate retention", "committedDate": "2020-03-27T11:05:11Z", "type": "forcePushed"}]}