{"pr_number": 2026, "pr_title": "check profile if used for LM or CH preparation", "pr_createdAt": "2020-05-06T21:54:43Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/2026", "timeline": [{"oid": "6409c60c3a8e6b7d5b30b3106ca00f3669088da8", "url": "https://github.com/graphhopper/graphhopper/commit/6409c60c3a8e6b7d5b30b3106ca00f3669088da8", "message": "check profile if used for LM or CH preparation", "committedDate": "2020-05-06T21:51:31Z", "type": "commit"}, {"oid": "284b1c7f654455d25812fb48ba699f2f710e1e5e", "url": "https://github.com/graphhopper/graphhopper/commit/284b1c7f654455d25812fb48ba699f2f710e1e5e", "message": "cleanup", "committedDate": "2020-05-06T21:54:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTExNTY0Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421115647", "bodyText": "This is probably better in GraphHopperTest but mocking DataReader is a bit lengthy/ugly.", "author": "karussell", "createdAt": "2020-05-06T21:55:32Z", "path": "reader-osm/src/test/java/com/graphhopper/reader/osm/GraphHopperOSMTest.java", "diffHunk": "@@ -1117,4 +1117,56 @@ private GraphHopper createGraphHopper(String vehicles) {\n                 setEncodingManager(em).\n                 setProfiles(profiles);\n     }\n+\n+    @Test\n+    public void testLoadingWrongCHProfiles() {", "originalCommit": "284b1c7f654455d25812fb48ba699f2f710e1e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0MTkyMQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421341921", "bodyText": "Ok ;)", "author": "easbar", "createdAt": "2020-05-07T08:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTExNTY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0MDQ2MA==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421340460", "bodyText": "Looks like this is (no longer(?)) needed?", "author": "easbar", "createdAt": "2020-05-07T08:45:40Z", "path": "core/src/main/java/com/graphhopper/storage/CHConfig.java", "diffHunk": "@@ -70,4 +71,13 @@ public int hashCode() {\n         return getName().hashCode();\n     }\n \n+    public int getVersion() {\n+        int hash = Helper.staticHashCode(chGraphName);\n+        hash = 31 * hash + Helper.staticHashCode(weighting.getName());\n+        // if flag encoder is removed we could use weighting.toString\n+        hash = 31 * hash + Helper.staticHashCode(weighting.getFlagEncoder().toString());\n+        hash *= weighting.hasTurnCosts() ? 31 : 62;\n+        hash *= edgeBased ? 31 : 62;\n+        return hash;\n+    }", "originalCommit": "284b1c7f654455d25812fb48ba699f2f710e1e5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0MDk1Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421340957", "bodyText": "Why is isEmpty() treated special here? Why is it possible for the hash to be empty?", "author": "easbar", "createdAt": "2020-05-07T08:46:28Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -979,8 +979,16 @@ protected void postProcessing(boolean closeEarly) {\n \n         if (chPreparationHandler.isEnabled())\n             chPreparationHandler.createPreparations(ghStorage);\n-        if (!isCHPrepared())\n+        if (isCHPrepared()) {\n+            // check loaded profiles\n+            for (CHProfile profile : chPreparationHandler.getCHProfiles()) {\n+                if (!getProfileHash(profile.getProfile()).isEmpty()", "originalCommit": "284b1c7f654455d25812fb48ba699f2f710e1e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM1OTEzMw==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421359133", "bodyText": "Ah, I just blindly assumed the symmetry between CH and LM. So, yes. It is not necessary for CH as we want to load it here.", "author": "karussell", "createdAt": "2020-05-07T09:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0MDk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0MTE5NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421341195", "bodyText": "Can we either call it hash or version (but not both :)) ?", "author": "easbar", "createdAt": "2020-05-07T08:46:51Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -1264,16 +1272,24 @@ protected void initLocationIndex() {\n     }\n \n     private boolean isCHPrepared() {\n-        return \"true\".equals(ghStorage.getProperties().get(CH.PREPARE + \"done\"))\n-                // remove old property in >0.9\n-                || \"true\".equals(ghStorage.getProperties().get(\"prepare.done\"));\n+        return \"true\".equals(ghStorage.getProperties().get(CH.PREPARE + \"done\"));\n     }\n \n-    private boolean isLMPrepared() {\n-        return \"true\".equals(ghStorage.getProperties().get(Landmark.PREPARE + \"done\"));\n+    private String getProfileHash(String profile) {\n+        return ghStorage.getProperties().get(\"graph.profiles.\" + profile + \".hash\");\n+    }\n+\n+    private void setProfileHash(String profile, int version) {", "originalCommit": "284b1c7f654455d25812fb48ba699f2f710e1e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM1OTYwNw==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421359607", "bodyText": "Haha, sure. I even had a third option in the code before ;)", "author": "karussell", "createdAt": "2020-05-07T09:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0MTE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421344299", "bodyText": "Hmm toString includes the hints (which is good/required for custom weighting), but unfortunately PMap uses an (unordered) HashMap, so this might go wrong? Shall we use LinkedHashMap in PMap? Or implement some method that returns the string in a deterministic way?", "author": "easbar", "createdAt": "2020-05-07T08:51:35Z", "path": "api/src/main/java/com/graphhopper/config/Profile.java", "diffHunk": "@@ -112,4 +113,8 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return name.hashCode();\n     }\n+\n+    public int getVersion() {\n+        return Helper.staticHashCode(toString());", "originalCommit": "284b1c7f654455d25812fb48ba699f2f710e1e5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NTQ0Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421345442", "bodyText": "Oh but I just realized that also hints does not even include the custom model but only the reference to the custom model file... Shouldn't our check also detect changes in the custom model file?", "author": "easbar", "createdAt": "2020-05-07T08:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM2MDcyNA==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421360724", "bodyText": "but unfortunately PMap uses an (unordered) HashMap, so this might go wrong\n\nAh, good catch!\n\nOh but I just realized that also hints does not even include the custom model but only the reference to the custom model file... Shouldn't our check also detect changes in the custom model file?\n\nWill write a test for this. I think we load the custom profile as object into this, but it might happen after the check.", "author": "karussell", "createdAt": "2020-05-07T09:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0ODY5Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421548692", "bodyText": "The CustomModel is stored in the hints already and produces a different hash code for mostly all situation, but relies on toString. So my test case passes. But only \"mostly\" because for areas we currently include only the count and so e.g. for changes of an area there would be no error. I will include the full areas and if this is too much at some point we can revert this to the count.\nBut the question is if we should rely on toString which should have only a debugging purpose? I think, yes, for now as the hashcode is not stable. And later work towards a config that is stored in the graph storage (and is loaded without providing it).\n\nShall we use LinkedHashMap in PMap?\n\nYes, I'll do that (the other option would be TreeMap or putting toMap into a TreeMap but I think it cannot hurt to give PMap this ordering guarantuee)", "author": "karussell", "createdAt": "2020-05-07T14:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2Mjg0MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r421662841", "bodyText": "Cool thanks. We could have some method createContentString and call it from createHashCode and toString. This way its obvious that it has some meaning beyond debugging, we do not have to write it 'twice' and maybe we could even do the sorting there (in case we do not want to adjust PMap).", "author": "easbar", "createdAt": "2020-05-07T17:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA5Mzg0Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r422093843", "bodyText": "Hmmh, sounds good but in PMap this still looks suboptimal:\npublic String createContentString() {\n    StringBuilder sb = new StringBuilder();\n    for(Map.Entry<String, Object> entry : map.entrySet()) {\n        sb.append(entry.getKey());\n        sb.append('=');\n        if(entry.getValue() instanceof ContentStringCreator)\n            sb.append(((ContentStringCreator)entry.getValue()).createContentString()); // let e.g. CustomModel implement this interface\n        else\n            sb.append(entry.getValue().toString());\n        sb.append(',');\n    }\n    return sb.toString();\n}\nWDYT?", "author": "karussell", "createdAt": "2020-05-08T11:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA5NDU0NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r422094545", "bodyText": "Ah, or do you mean to implement createContentString only in CustomModel as private method and use it in CustomModel.toString?", "author": "karussell", "createdAt": "2020-05-08T11:36:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM1NDI3NA==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r422354274", "bodyText": "Ah, or do you mean to implement createContentString only in CustomModel as private method and use it in CustomModel.toString?\n\nYes. Or in Profile actually but I see that we need something like this for objects (like CustomModel that are in the hints map...", "author": "easbar", "createdAt": "2020-05-08T20:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NDI5OQ=="}], "type": "inlineReview"}, {"oid": "cef4d8b17f83e95aba6c42143236a10aa518b7c7", "url": "https://github.com/graphhopper/graphhopper/commit/cef4d8b17f83e95aba6c42143236a10aa518b7c7", "message": "first things after review", "committedDate": "2020-05-07T13:49:56Z", "type": "commit"}, {"oid": "4b16e21acf658f5620a46b0e66c2b4492445cfef", "url": "https://github.com/graphhopper/graphhopper/commit/4b16e21acf658f5620a46b0e66c2b4492445cfef", "message": "include custom model in tests and use linkedhashmap for pmap to ensure same version", "committedDate": "2020-05-07T22:23:44Z", "type": "commit"}, {"oid": "e442b41acdd612c1a803feaa6e52c9d54a1e7e5c", "url": "https://github.com/graphhopper/graphhopper/commit/e442b41acdd612c1a803feaa6e52c9d54a1e7e5c", "message": "minor javadocs fix", "committedDate": "2020-05-08T13:37:21Z", "type": "commit"}, {"oid": "4f8b6cadaac379cef0302f8a42f6995b611df1f5", "url": "https://github.com/graphhopper/graphhopper/commit/4f8b6cadaac379cef0302f8a42f6995b611df1f5", "message": "ensure toString is not only used for debugging", "committedDate": "2020-05-11T11:34:57Z", "type": "commit"}, {"oid": "d6efd07719243c5e600bd6c1e8dfe8a8c98861ef", "url": "https://github.com/graphhopper/graphhopper/commit/d6efd07719243c5e600bd6c1e8dfe8a8c98861ef", "message": "Merge branch 'master' into profile_hash", "committedDate": "2020-05-11T11:35:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4NDAxMQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r422984011", "bodyText": "Should we not use createContentString also in getVersion() (instead of toString()) now that we have it?", "author": "easbar", "createdAt": "2020-05-11T11:50:28Z", "path": "api/src/main/java/com/graphhopper/routing/util/CustomModel.java", "diffHunk": "@@ -126,14 +126,13 @@ public double getHeadingPenalty() {\n \n     @Override\n     public String toString() {\n-        return \"CustomModel{\" +\n-                \"distanceInfluence=\" + distanceInfluence +\n-                \", speedFactor=\" + speedFactorMap +\n-                \", maxSpeed=\" + maxSpeedMap +\n-                \", maxSpeedFallback=\" + maxSpeedFallback +\n-                \", priorityMap=\" + priorityMap +\n-                \", #areas=\" + areas.size() +\n-                '}';\n+        return createContentString();\n+    }\n+\n+    private String createContentString() {", "originalCommit": "d6efd07719243c5e600bd6c1e8dfe8a8c98861ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4NjI4MA==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r422986280", "bodyText": "Ah sorry its in another file. But maybe we can do the same in Profile.java (add createContentString and use it from Profile#getVersion() and Profile#getString())?", "author": "easbar", "createdAt": "2020-05-11T11:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4NDAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAyODQyNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2026#discussion_r423028425", "bodyText": "Yes!", "author": "karussell", "createdAt": "2020-05-11T13:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4NDAxMQ=="}], "type": "inlineReview"}, {"oid": "b3867f8ed51de410a43a32ac1d844c0e739a9829", "url": "https://github.com/graphhopper/graphhopper/commit/b3867f8ed51de410a43a32ac1d844c0e739a9829", "message": "make it similar for Profile and CustomModel", "committedDate": "2020-05-11T13:18:05Z", "type": "commit"}]}