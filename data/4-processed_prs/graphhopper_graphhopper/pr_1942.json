{"pr_number": 1942, "pr_title": "Bilinear interpolation for height tiles", "pr_createdAt": "2020-02-29T03:00:29Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/1942", "timeline": [{"oid": "d5bf5da3ad9142323d2b19bf89db47994ff978d3", "url": "https://github.com/graphhopper/graphhopper/commit/d5bf5da3ad9142323d2b19bf89db47994ff978d3", "message": "replace calcMean with bilinear interpolate", "committedDate": "2020-02-29T02:16:44Z", "type": "commit"}, {"oid": "0942ee78f1cd8ee2694c9a69474df76ea6436552", "url": "https://github.com/graphhopper/graphhopper/commit/0942ee78f1cd8ee2694c9a69474df76ea6436552", "message": "fix", "committedDate": "2020-02-29T02:42:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NDQzMw==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r387084433", "bodyText": "Let's remove the fall back for graph.elevation.calcmean and throw an error if it is still specified.", "author": "karussell", "createdAt": "2020-03-03T15:09:57Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -601,6 +601,10 @@ private static ElevationProvider createElevationProvider(GraphHopperConfig ghCon\n                 ? ghConfig.getBool(\"graph.elevation.calcmean\", false)\n                 : ghConfig.getBool(\"graph.elevation.calc_mean\", false);\n \n+        boolean interpolate = ghConfig.has(\"graph.elevation.interpolate\")\n+                ? ghConfig.getBool(\"graph.elevation.interpolate\", false)\n+                : eleCalcMean;", "originalCommit": "0942ee78f1cd8ee2694c9a69474df76ea6436552", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MTQ0OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r387091449", "bodyText": "Why is this handling with MIN_ELEVATION necessary? What does this mean and what is the unit?\nAnd IMO the method is not guarded if a and b are smaller than MIN_ELEVATION.", "author": "karussell", "createdAt": "2020-03-03T15:20:00Z", "path": "core/src/main/java/com/graphhopper/reader/dem/HeightTile.java", "diffHunk": "@@ -77,6 +78,15 @@ void setHeights(DataAccess da) {\n         this.heights = da;\n     }\n \n+    private short getHeightSample(int x, int y) {\n+        // always keep in mind factor 2 because of short value\n+        return heights.getShort(2 * (y * width + x));\n+    }\n+\n+    private double linearInterpolate(double a, double b, double f) {\n+        return a < MIN_ELEVATION ? b : b < MIN_ELEVATION ? a : (a + (b - a) * f);", "originalCommit": "0942ee78f1cd8ee2694c9a69474df76ea6436552", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwMzYwOA==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r387403608", "bodyText": "My understanding is that voids in elevation data (in SRTM at least) show up as Short.MIN_VALUE (see line 102-103 of previous version of HeightTile), so the MIN_ELEVATION check is meant to catch that since otherwise we'd be comparing a double to a short.\nMy thought here was that we make ourselves a bit more robust to voids if when any of the 4 surrounding points that we are averaging are missing, we average the other points.", "author": "msbarry", "createdAt": "2020-03-04T01:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MTQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxODAxOA==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r387618018", "bodyText": "Oh, indeed. You are right. This is quite surprising as we have no proper NaN handling downstream for these values. Probably we never stumbled over this as we use CGIAR that has filled the void. So yes, this is probably for another issue and good idea about the surrounding points.", "author": "karussell", "createdAt": "2020-03-04T11:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5MTQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5Mzk0NA==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r387093944", "bodyText": "Instead of returning NaN should we better throw an exception? NaN will cause trouble somewhere else.", "author": "karussell", "createdAt": "2020-03-03T15:23:23Z", "path": "core/src/main/java/com/graphhopper/reader/dem/HeightTile.java", "diffHunk": "@@ -85,38 +95,37 @@ public double getHeight(double lat, double lon) {\n         if (deltaLon > lonHigherBound || deltaLon < lowerBound)\n             throw new IllegalStateException(\"longitude not in boundary of this file:\" + lat + \",\" + lon + \", this:\" + this.toString());\n \n-        // first row in the file is the northernmost one\n-        // http://gis.stackexchange.com/a/43756/9006\n-        int lonSimilar = (int) (width / horizontalDegree * deltaLon);\n-        // different fallback methods for lat and lon as we have different rounding (lon -> positive, lat -> negative)\n-        if (lonSimilar >= width)\n-            lonSimilar = width - 1;\n-        int latSimilar = height - 1 - (int) (height / verticalDegree * deltaLat);\n-        if (latSimilar < 0)\n-            latSimilar = 0;\n-\n-        // always keep in mind factor 2 because of short value\n-        int daPointer = 2 * (latSimilar * width + lonSimilar);\n-        int value = heights.getShort(daPointer);\n-        AtomicInteger counter = new AtomicInteger(1);\n-        if (value == Short.MIN_VALUE)\n-            return Double.NaN;\n-\n-        if (calcMean) {\n-            if (lonSimilar > 0)\n-                value += includePoint(daPointer - 2, counter);\n-\n-            if (lonSimilar < width - 1)\n-                value += includePoint(daPointer + 2, counter);\n-\n-            if (latSimilar > 0)\n-                value += includePoint(daPointer - 2 * width, counter);\n-\n-            if (latSimilar < height - 1)\n-                value += includePoint(daPointer + 2 * width, counter);\n+        double elevation;\n+        if (interpolate) {\n+            double x = (width - 1) * deltaLon / horizontalDegree;\n+            double y = (height - 1) * (1 - deltaLat / verticalDegree);\n+            int left = (int) x;\n+            int top = (int) y;\n+            int right = left + 1;\n+            int bottom = top + 1;\n+\n+            double w00 = getHeightSample(left, top);\n+            double w01 = getHeightSample(left, bottom);\n+            double w10 = getHeightSample(right, top);\n+            double w11 = getHeightSample(right, bottom);\n+\n+            double topEle = linearInterpolate(w00, w10, x - left);\n+            double bottomEle = linearInterpolate(w01, w11, x - left);\n+            elevation = linearInterpolate(topEle, bottomEle, y - top);\n+        } else {\n+            // first row in the file is the northernmost one\n+            // http://gis.stackexchange.com/a/43756/9006\n+            int x = (int) (width / horizontalDegree * deltaLon);\n+            // different fallback methods for lat and lon as we have different rounding (lon -> positive, lat -> negative)\n+            if (x >= width)\n+                x = width - 1;\n+            int y = height - 1 - (int) (height / verticalDegree * deltaLat);\n+            if (y < 0)\n+                y = 0;\n+\n+            elevation = getHeightSample(x, y);\n         }\n-\n-        return (double) value / counter.get();\n+        return elevation < MIN_ELEVATION ? Double.NaN : elevation;", "originalCommit": "0942ee78f1cd8ee2694c9a69474df76ea6436552", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQwNTcyOA==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r387405728", "bodyText": "This is the behavior from line 102-103 of the previous version of this code - NaN was the value returned for voids. I checked out PointList.calcDistance when elevation is NaN and it can't handle it. Is there code that I'm missing elsewhere that handles these voids?", "author": "msbarry", "createdAt": "2020-03-04T01:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5Mzk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MzQ2OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r387583469", "bodyText": "also FWIW valhalla does a similar range check when using mapzen/skadi terrain tiles https://github.com/valhalla/valhalla/blob/9dd8b88aa93b91888c4a6da8b09454a1ec9a0c2b/src/skadi/sample.cc#L224 and has some special case handling to skip over these when computing grade/total elevation gain/3d profiles with missing elevation data. Maybe this (or a separate) review should tighten up elevation void handling?", "author": "msbarry", "createdAt": "2020-03-04T10:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5Mzk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1ODQ5Ng==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r388258496", "bodyText": "I started working on a PR to handle voids downstream, and it started looking rather large so I opened up #1946 so we can discuss the best path forward.", "author": "msbarry", "createdAt": "2020-03-05T12:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5Mzk0NA=="}], "type": "inlineReview"}, {"oid": "ed2eb1898a96194ce8890526e6520697bdb95c5f", "url": "https://github.com/graphhopper/graphhopper/commit/ed2eb1898a96194ce8890526e6520697bdb95c5f", "message": "throw error on graph.elevation.calcmean", "committedDate": "2020-03-04T01:32:50Z", "type": "commit"}, {"oid": "2e88b5dc77baaa4ee613aecdc8f45deb9828bbdc", "url": "https://github.com/graphhopper/graphhopper/commit/2e88b5dc77baaa4ee613aecdc8f45deb9828bbdc", "message": "tighten range check", "committedDate": "2020-03-05T01:16:58Z", "type": "commit"}, {"oid": "959c1b3608a82335ea7c55b92beb5f259a58cc02", "url": "https://github.com/graphhopper/graphhopper/commit/959c1b3608a82335ea7c55b92beb5f259a58cc02", "message": "Merge branch 'master' into bilinear-interpolation", "committedDate": "2020-03-05T01:34:03Z", "type": "commit"}, {"oid": "25c3d9bcec3347625f72026cc9d8f1c1103c985a", "url": "https://github.com/graphhopper/graphhopper/commit/25c3d9bcec3347625f72026cc9d8f1c1103c985a", "message": "change config parameter to 'graph.elevation.interpolate: bilinear'", "committedDate": "2020-03-06T13:51:49Z", "type": "commit"}, {"oid": "de000185907628819d96660f6ea54cc471d78200", "url": "https://github.com/graphhopper/graphhopper/commit/de000185907628819d96660f6ea54cc471d78200", "message": "Merge branch 'master' into bilinear-interpolation", "committedDate": "2020-03-10T12:49:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2Nzc1NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r390567755", "bodyText": "I would keep it simple for now and only use the two strings :) ? Or why did you choose to introduce this enum?", "author": "karussell", "createdAt": "2020-03-10T19:44:46Z", "path": "core/src/main/java/com/graphhopper/reader/dem/ElevationInterpolation.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ *  Licensed to GraphHopper GmbH under one or more contributor\n+ *  license agreements. See the NOTICE file distributed with this work for\n+ *  additional information regarding copyright ownership.\n+ *\n+ *  GraphHopper GmbH licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except in\n+ *  compliance with the License. You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package com.graphhopper.reader.dem;\n+\n+/**\n+ * This enum defines the interpolation method to use.\n+ */\n+public enum ElevationInterpolation {\n+    NONE(\"none\"), BILINEAR(\"bilinear\");\n+\n+    private final String name;\n+\n+    ElevationInterpolation(String name) {\n+        this.name = name;\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return name;\n+    }\n+\n+    public static ElevationInterpolation find(String name) {\n+        if (name == null || name.isEmpty())\n+            return NONE;\n+\n+        for (ElevationInterpolation interpolation : values()) {\n+            if (interpolation.name().equalsIgnoreCase(name)) {\n+                return interpolation;\n+            }\n+        }\n+\n+        return NONE;\n+    }", "originalCommit": "25c3d9bcec3347625f72026cc9d8f1c1103c985a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY4MDQxNA==", "url": "https://github.com/graphhopper/graphhopper/pull/1942#discussion_r390680414", "bodyText": "Good call, that's over-engineering for now. Since we only have one interpolation method so far, just a boolean is good.  I think we should keep the config as graph.elevation.interpolation: bilinear so it's clear what it's doing and so configs don't have to change if we add other interpolation methods later.", "author": "msbarry", "createdAt": "2020-03-11T00:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU2Nzc1NQ=="}], "type": "inlineReview"}, {"oid": "727181e8e0ff5c7a1dce8729f9b58a77390d66fc", "url": "https://github.com/graphhopper/graphhopper/commit/727181e8e0ff5c7a1dce8729f9b58a77390d66fc", "message": "Merge branch 'master' into bilinear-interpolation", "committedDate": "2020-03-10T23:58:27Z", "type": "commit"}, {"oid": "5cb26d5e0ac5e5bed070097d2e0835a406b24950", "url": "https://github.com/graphhopper/graphhopper/commit/5cb26d5e0ac5e5bed070097d2e0835a406b24950", "message": "Revert \"change config parameter to 'graph.elevation.interpolate: bilinear'\"\n\nThis reverts commit 25c3d9bcec3347625f72026cc9d8f1c1103c985a.", "committedDate": "2020-03-10T23:59:03Z", "type": "commit"}, {"oid": "cdb12065af89ba0d419814f43e7cce780628909b", "url": "https://github.com/graphhopper/graphhopper/commit/cdb12065af89ba0d419814f43e7cce780628909b", "message": "handle graph.elevation.interpolate=bilinear", "committedDate": "2020-03-11T00:03:08Z", "type": "commit"}, {"oid": "7ce9a7669ac8c76bd32279a02312899e1748ce6b", "url": "https://github.com/graphhopper/graphhopper/commit/7ce9a7669ac8c76bd32279a02312899e1748ce6b", "message": "Merge branch 'master' into bilinear-interpolation", "committedDate": "2020-03-12T09:59:56Z", "type": "commit"}]}