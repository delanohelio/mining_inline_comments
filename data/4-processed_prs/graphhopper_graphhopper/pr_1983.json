{"pr_number": 1983, "pr_title": "Add config option `preparation_profile` to allow cross-querying in hybrid mode", "pr_createdAt": "2020-04-08T21:40:19Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/1983", "timeline": [{"oid": "bea8f341bca62a165aad7b4fb59db561a1502f5d", "url": "https://github.com/graphhopper/graphhopper/commit/bea8f341bca62a165aad7b4fb59db561a1502f5d", "message": "Add config option `preparation_profile` for LM profiles to be able to cross-query between profiles", "committedDate": "2020-04-08T21:34:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNTEyNA==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r405835124", "bodyText": "This example might be a bit artificial, because we can also just use profile1 and change the distance factor on every request, but creating a dedicated profile for this illustrates the new feature here: We can setup a profile on the server side and then do no longer have to specify the different parameters for every request (like the distance factor) and at the same time we do not need an extra landmark calculation for this. This should be useful for #1776 when we want to setup a complex profile and then just select it by using the profile parameter (which btw is still missing on the web layer (#1934)).", "author": "easbar", "createdAt": "2020-04-08T21:49:04Z", "path": "reader-osm/src/test/java/com/graphhopper/GraphHopperIT.java", "diffHunk": "@@ -1356,6 +1356,54 @@ public void testFlexMode_631() {\n         // note: combining hybrid & speed mode is currently not possible and should be avoided: #1082\n     }\n \n+    @Test\n+    public void testCrossQuery() {\n+        final String profile1 = \"p1\";\n+        final String profile2 = \"p2\";\n+        final String profile3 = \"p3\";\n+        final String vehicle = \"car\";\n+        GraphHopper hopper = createGraphHopper(vehicle).\n+                setOSMFile(MONACO).\n+                setProfiles(\n+                        new ProfileConfig(profile1).setVehicle(\"car\").setWeighting(\"short_fastest\").putHint(\"short_fastest.distance_factor\", 0.07),\n+                        new ProfileConfig(profile2).setVehicle(\"car\").setWeighting(\"short_fastest\").putHint(\"short_fastest.distance_factor\", 0.10),\n+                        new ProfileConfig(profile3).setVehicle(\"car\").setWeighting(\"short_fastest\").putHint(\"short_fastest.distance_factor\", 0.15)\n+                ).", "originalCommit": "bea8f341bca62a165aad7b4fb59db561a1502f5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNTcwNg==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r405835706", "bodyText": "This is a good use-case for the new feature: We use the same landmarks for both LM profiles (with and without turn costs).", "author": "easbar", "createdAt": "2020-04-08T21:50:23Z", "path": "tools/src/main/java/com/graphhopper/tools/Measurement.java", "diffHunk": "@@ -304,11 +304,10 @@ private GraphHopperConfig createConfigFromArgs(PMap args) {\n         ghConfig.setCHProfiles(chProfiles);\n         List<LMProfileConfig> lmProfiles = new ArrayList<>();\n         if (useLM) {\n-            // as currently we do not allow cross-querying LM with turn costs=true/false we have to add both\n-            // profiles and this currently leads to two identical LM preparations\n             lmProfiles.add(new LMProfileConfig(\"profile_no_tc\"));\n             if (turnCosts)\n-                lmProfiles.add(new LMProfileConfig(\"profile_tc\"));\n+                // no need for a second LM preparation, we can do cross queries here\n+                lmProfiles.add(new LMProfileConfig(\"profile_tc\").setPreparationProfile(\"profile_no_tc\"));", "originalCommit": "bea8f341bca62a165aad7b4fb59db561a1502f5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51bcb301625ed763edd07fde50aac109bcee4edd", "url": "https://github.com/graphhopper/graphhopper/commit/51bcb301625ed763edd07fde50aac109bcee4edd", "message": "Minor", "committedDate": "2020-04-08T22:01:58Z", "type": "commit"}, {"oid": "c646f75d2a02c754b4ce983ab64daaf852797b72", "url": "https://github.com/graphhopper/graphhopper/commit/c646f75d2a02c754b4ce983ab64daaf852797b72", "message": "Merge branch 'master' into preparation_profiles", "committedDate": "2020-04-08T22:08:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxOTExMg==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407619112", "bodyText": "I would use the Java \"this\" but I have no good arguments :)", "author": "karussell", "createdAt": "2020-04-13T17:55:42Z", "path": "api/src/main/java/com/graphhopper/config/LMProfileConfig.java", "diffHunk": "@@ -28,6 +28,7 @@\n  */\n public class LMProfileConfig {\n     private String profile = \"\";\n+    private String preparationProfile = \"self\";", "originalCommit": "c646f75d2a02c754b4ce983ab64daaf852797b72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyNDkzMw==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407624933", "bodyText": "OK convinced haha", "author": "easbar", "createdAt": "2020-04-13T18:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxOTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDA3Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407620072", "bodyText": "Shouldn't we exclude all additional parameters earlier? I mean which parameters could be useful when we reuse the preparation?", "author": "karussell", "createdAt": "2020-04-13T17:57:21Z", "path": "api/src/main/java/com/graphhopper/config/LMProfileConfig.java", "diffHunk": "@@ -47,17 +48,35 @@ void setProfile(String profile) {\n         this.profile = profile;\n     }\n \n+    public boolean usesOtherPreparation() {\n+        return !preparationProfile.equals(\"self\");\n+    }\n+\n+    public String getPreparationProfile() {\n+        return preparationProfile;\n+    }\n+\n+    public LMProfileConfig setPreparationProfile(String preparationProfile) {\n+        validateProfileName(preparationProfile);\n+        if (maximumLMWeight >= 0)\n+            throw new IllegalArgumentException(\"Using non-default maximum_lm_weight and preparation_profile at the same time is not allowed\");", "originalCommit": "c646f75d2a02c754b4ce983ab64daaf852797b72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyNTM5NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407625395", "bodyText": "Yeah you mean the hints need to be emtpy as well?", "author": "easbar", "createdAt": "2020-04-13T18:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MjY5Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407662697", "bodyText": "Yes (and could be even checked earlier after parsing?)", "author": "karussell", "createdAt": "2020-04-13T19:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2MDIwNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407960205", "bodyText": "This is kind of checked during parsing because Jackson uses this setter. And I just noticed there aren't any other 'hints', so checking the maxLMWeight should be sufficient here.", "author": "easbar", "createdAt": "2020-04-14T08:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407620864", "bodyText": "I would introduce an \"advanced\" section or even move this into the docs and link to them from here as this is very special and might be too confusing?", "author": "karussell", "createdAt": "2020-04-13T17:58:42Z", "path": "config-example.yml", "diffHunk": "@@ -62,7 +62,11 @@ graphhopper:\n \n   # Hybrid mode:\n   # Similar to speed mode, the hybrid mode (Landmarks, LM) also speeds up routing by doing calculating auxiliary data\n-  # in advance. Its not as fast as speed mode, but more flexible.\n+  # in advance. Its not as fast as speed mode, but more flexible. It is possible to use the same preparation for multiple\n+  # profiles which saves memory and preparation time. To do this use e.g. `preparation_profile: my_other_profile` where\n+  # `my_other_profile` is the name of another profile for which an LM profile exists.\n+  # Important: This only will give correct routing results if the weights calculated for the profile are equal or\n+  # larger (for every edge) than those calculated for the profile that was used for the preparation (`my_other_profile`)", "originalCommit": "c646f75d2a02c754b4ce983ab64daaf852797b72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyNjAzNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407626035", "bodyText": "Ok you mean not mention preparation_profile here? Which docs should this go into?", "author": "easbar", "createdAt": "2020-04-13T18:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2NDAxMQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407964011", "bodyText": "I declared the cross-query stuff as 'advanced usage'. If you prefer we can still move this kind of documentation to another place. I kind of like it right there in the configuration file, but most importantly it should be consistent somehow so it is clear where one can find the documentation of the different configuration options.", "author": "easbar", "createdAt": "2020-04-14T08:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2ODM0Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407968343", "bodyText": "Btw I could not find any documentation for the maximum_lm_weight parameter.", "author": "easbar", "createdAt": "2020-04-14T08:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MTk4MA==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r408271980", "bodyText": "Which docs should this go into?\n\nShould we introduce a profiles.md documentation that could also mention backward compatibility related things?", "author": "karussell", "createdAt": "2020-04-14T16:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MTk4Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r408351983", "bodyText": "I opened #1987 for the docs, lets do it after #1859 and #1776 are merged?", "author": "easbar", "createdAt": "2020-04-14T18:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3Nzc3NA==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r408377774", "bodyText": "Yes!", "author": "karussell", "createdAt": "2020-04-14T19:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMDg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMjA0Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407622042", "bodyText": "What about always using getPreparationProfile here that uses the method usesOtherPreparation internally?", "author": "karussell", "createdAt": "2020-04-13T18:00:30Z", "path": "core/src/main/java/com/graphhopper/GraphHopper.java", "diffHunk": "@@ -861,7 +872,15 @@ public RoutingAlgorithmFactory getAlgorithmFactory(String profile, boolean disab\n         if (chPreparationHandler.isEnabled() && !disableCH) {\n             return chPreparationHandler.getAlgorithmFactory(profile);\n         } else if (lmPreparationHandler.isEnabled() && !disableLM) {\n-            return lmPreparationHandler.getAlgorithmFactory(profile);\n+            for (LMProfileConfig lmp : lmPreparationHandler.getLMProfileConfigs()) {\n+                if (lmp.getProfile().equals(profile)) {\n+                    return lmp.usesOtherPreparation()\n+                            // cross-querying\n+                            ? lmPreparationHandler.getAlgorithmFactory(lmp.getPreparationProfile())\n+                            : lmPreparationHandler.getAlgorithmFactory(lmp.getProfile());", "originalCommit": "c646f75d2a02c754b4ce983ab64daaf852797b72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyNjU3NA==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407626574", "bodyText": "I thought about this also for a moment, but then I did not want to put too much logic into the getter, as it is also used by Jackson for deserialization, but I will have a second look.", "author": "easbar", "createdAt": "2020-04-13T18:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMjA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MzM0Ng==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407663346", "bodyText": "Ah, sure, I did not thought about this. Then we should indeed avoid this or rename the method (resolveProfile?)", "author": "karussell", "createdAt": "2020-04-13T19:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMjA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2MTg3NA==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407961874", "bodyText": "Hm, its only used once this way so I would keep it as is. resolveProfile is too similar to what we call 'resolving the profile' in ProfileResolver imo.", "author": "easbar", "createdAt": "2020-04-14T08:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMjA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MjE2Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r408272163", "bodyText": "Ah, ok. Sure.", "author": "karussell", "createdAt": "2020-04-14T16:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMjA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMzU5NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407623595", "bodyText": "The first one is likely still required as snake might do maximum_l_m_weight ... but not tested this.", "author": "karussell", "createdAt": "2020-04-13T18:03:24Z", "path": "web-api/src/main/java/com/graphhopper/jackson/LMProfileConfigMixIn.java", "diffHunk": "@@ -21,6 +21,10 @@\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n public interface LMProfileConfigMixIn {\n+    // todonow: maybe both of these are no longer needed because of snake case module?", "originalCommit": "c646f75d2a02c754b4ce983ab64daaf852797b72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2NjIzOQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r407966239", "bodyText": "Exactly, without the rule here Jackson apparently expects maximum_lmweight, so the second uppercase letter does not introduce a second underscore, but also the third uppercase letter (W in Weight) does not add an underscore.", "author": "easbar", "createdAt": "2020-04-14T08:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMzU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MjU1NA==", "url": "https://github.com/graphhopper/graphhopper/pull/1983#discussion_r408272554", "bodyText": "Aha, thanks!", "author": "karussell", "createdAt": "2020-04-14T16:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMzU5NQ=="}], "type": "inlineReview"}, {"oid": "7ca2c9df8aa226cd1cbfa05cbfc7219292f32ef3", "url": "https://github.com/graphhopper/graphhopper/commit/7ca2c9df8aa226cd1cbfa05cbfc7219292f32ef3", "message": "self -> this", "committedDate": "2020-04-14T08:30:00Z", "type": "commit"}, {"oid": "fb3913b406fe8e165a71d95834d0167c7ac5cd7b", "url": "https://github.com/graphhopper/graphhopper/commit/fb3913b406fe8e165a71d95834d0167c7ac5cd7b", "message": "Remove snake case jackson rule", "committedDate": "2020-04-14T08:34:18Z", "type": "commit"}, {"oid": "8ea9b5b97765b08d1c6065e46cad581fb86516fc", "url": "https://github.com/graphhopper/graphhopper/commit/8ea9b5b97765b08d1c6065e46cad581fb86516fc", "message": "Split docs into normal and advanced usage.", "committedDate": "2020-04-14T08:37:42Z", "type": "commit"}, {"oid": "4955267a20924fa0287255841521d148dce5f75a", "url": "https://github.com/graphhopper/graphhopper/commit/4955267a20924fa0287255841521d148dce5f75a", "message": "Merge branch 'master' into preparation_profiles", "committedDate": "2020-04-14T10:00:30Z", "type": "commit"}, {"oid": "b5f61bae130964e6695262669667887155cb2999", "url": "https://github.com/graphhopper/graphhopper/commit/b5f61bae130964e6695262669667887155cb2999", "message": "Put back checks for edge_based and weighting", "committedDate": "2020-04-14T10:05:42Z", "type": "commit"}, {"oid": "b9f2bfe74b0bf4587c5912169cb76adc9570b0a9", "url": "https://github.com/graphhopper/graphhopper/commit/b9f2bfe74b0bf4587c5912169cb76adc9570b0a9", "message": "Merge branch 'master' into preparation_profiles", "committedDate": "2020-04-14T10:26:31Z", "type": "commit"}]}