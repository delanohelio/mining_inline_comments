{"pr_number": 1891, "pr_title": "Remove routing algorithm factory decorator abstraction", "pr_createdAt": "2020-02-06T20:19:44Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/1891", "timeline": [{"oid": "5d1c2477756d40f04f2714db3d12e47ce2a69edf", "url": "https://github.com/graphhopper/graphhopper/commit/5d1c2477756d40f04f2714db3d12e47ce2a69edf", "message": "Remove RoutingAlgoFactoryDecorator abstraction", "committedDate": "2020-02-06T18:45:57Z", "type": "commit"}, {"oid": "b7ec280e0765ee451162321715dde19f55859865", "url": "https://github.com/graphhopper/graphhopper/commit/b7ec280e0765ee451162321715dde19f55859865", "message": "Remove combined CH+LM measurement", "committedDate": "2020-02-06T18:47:49Z", "type": "commit"}, {"oid": "a948cc81a98e4699f69f205cb2c0909921d2628f", "url": "https://github.com/graphhopper/graphhopper/commit/a948cc81a98e4699f69f205cb2c0909921d2628f", "message": "Rename LM/CH decorator -> handler", "committedDate": "2020-02-06T19:39:23Z", "type": "commit"}, {"oid": "6ea4de668ab6cd203e85efcc1192cb32d9037fc5", "url": "https://github.com/graphhopper/graphhopper/commit/6ea4de668ab6cd203e85efcc1192cb32d9037fc5", "message": "Add tests for error on missing LM profile and switching LM on/off", "committedDate": "2020-02-06T19:59:14Z", "type": "commit"}, {"oid": "82577538356eb3d50d29f038f77fdff47e6ee0ef", "url": "https://github.com/graphhopper/graphhopper/commit/82577538356eb3d50d29f038f77fdff47e6ee0ef", "message": "Some cleanup", "committedDate": "2020-02-06T20:07:24Z", "type": "commit"}, {"oid": "41b60936850775d992ed0a0fdd093db86459c0a0", "url": "https://github.com/graphhopper/graphhopper/commit/41b60936850775d992ed0a0fdd093db86459c0a0", "message": "Merge branch 'master' into no_more_decorators", "committedDate": "2020-02-08T22:40:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjUxNw==", "url": "https://github.com/graphhopper/graphhopper/pull/1891#discussion_r376762517", "bodyText": "This comment can probably be removed, but I was not sure what 'cross query it' means here?", "author": "easbar", "createdAt": "2020-02-09T07:47:47Z", "path": "core/src/main/java/com/graphhopper/routing/lm/LMPreparationHandler.java", "diffHunk": "@@ -218,37 +217,38 @@ public int size() {\n         return preparations;\n     }\n \n-    @Override\n-    public RoutingAlgorithmFactory getDecoratedAlgorithmFactory(RoutingAlgorithmFactory defaultAlgoFactory, HintsMap map) {\n-        // for now do not allow mixing CH&LM #1082\n-        boolean disableCH = map.getBool(Parameters.CH.DISABLE, false);\n-        boolean disableLM = map.getBool(Parameters.Landmark.DISABLE, false);\n-        if (!isEnabled() || disablingAllowed && disableLM || !disableCH)\n-            return defaultAlgoFactory;\n-\n+    /**\n+     * @return a {@link RoutingAlgorithmFactory} for LM or throw an error if no preparation is available for the given\n+     * hints\n+     */\n+    public RoutingAlgorithmFactory getAlgorithmFactory(HintsMap map) {\n         if (preparations.isEmpty())\n-            throw new IllegalStateException(\"No preparations added to this decorator\");\n+            throw new IllegalStateException(\"No LM preparations added yet\");\n \n         // if no weighting or vehicle is specified for this request and there is only one preparation, use it\n         if ((map.getWeighting().isEmpty() || map.getVehicle().isEmpty()) && preparations.size() == 1) {\n-            return new LMRAFactory(preparations.get(0), defaultAlgoFactory);\n+            return new LMRAFactory(preparations.get(0), new RoutingAlgorithmFactorySimple());\n         }\n \n+        List<Weighting> lmWeightings = new ArrayList<>(preparations.size());\n         for (final PrepareLandmarks p : preparations) {\n+            lmWeightings.add(p.getWeighting());\n             if (p.getWeighting().matches(map))\n-                return new LMRAFactory(p, defaultAlgoFactory);\n+                return new LMRAFactory(p, new RoutingAlgorithmFactorySimple());\n         }\n \n+        // todonow: what does that mean?\n         // if the initial encoder&weighting has certain properties we could cross query it but for now avoid this", "originalCommit": "82577538356eb3d50d29f038f77fdff47e6ee0ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NzMwMA==", "url": "https://github.com/graphhopper/graphhopper/pull/1891#discussion_r376787300", "bodyText": "It means if we have a LM preparation for e.g. \"fastest+car\" and it should be okay to do a request also with a changed or even different weighting (for optimality the edge weights must not decrease and so not all changes are acceptable).\nBut such a check for the changed Weighting is not easy. Even for our new CustomWeighting (but there it is possible and should be made possible)", "author": "karussell", "createdAt": "2020-02-09T14:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MjUxNw=="}], "type": "inlineReview"}, {"oid": "9b9ff997a21adb9c526a579d698eaf617562ffae", "url": "https://github.com/graphhopper/graphhopper/commit/9b9ff997a21adb9c526a579d698eaf617562ffae", "message": "Clarify comment", "committedDate": "2020-02-09T16:28:20Z", "type": "commit"}]}