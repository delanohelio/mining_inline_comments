{"pr_number": 703, "pr_title": "[JENKINS-57828] Cleaning up the Snippet Generator output for PodTemplateStep", "pr_createdAt": "2020-02-07T19:43:00Z", "pr_url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703", "timeline": [{"oid": "6c4f1c59349c30debda1a17e13efcaaab1a2fb28", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/6c4f1c59349c30debda1a17e13efcaaab1a2fb28", "message": "[CPLT2-6206][JENKINS-57828] Cleaning up the Snippet Generator output for PodTemplateStep.\nFollowed the instructions https://jenkins.io/doc/developer/plugin-development/pipeline-integration/ in the Handling default values section, except had to use `Util.fixEmpty(String s)` instead of `Util.fixNull()`\nChanged the default value of `instanceCap` to 0 from MAX_INT. Otherwise requires a lot of logic to make it not be generated if set to the default of 0 from the config.jelly.\nAdded defaults for podRetention and workspaceVolume in PodTemplateStep.\nChanged DynamicPVCWorkspaceVolume to be compliant with snippet generation, changed DataBoundConstructor to have no parameters, added DataBoundSetters for all properties.\nAdded tests classifier to workflow-cps test dependency to get the SnippitizerTest class.\nAdded unit test for PodTemplateStep.", "committedDate": "2020-02-06T20:52:06Z", "type": "commit"}, {"oid": "79e706252346c40d97d66aba89440b821270db54", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/79e706252346c40d97d66aba89440b821270db54", "message": "[CPLT2-6206][JENKINS-57828] Accidentally left commented out code in a file.", "committedDate": "2020-02-07T19:06:51Z", "type": "commit"}, {"oid": "62e605681752ea7c4b377a281049ee909838a9de", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/62e605681752ea7c4b377a281049ee909838a9de", "message": "Missed a brace that was in the comment.", "committedDate": "2020-02-07T19:07:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MjkzMg==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376582932", "bodyText": "This replaces the test dep on workflow-cps.jar. I think you wanted to add a dependency with this classifier.", "author": "jglick", "createdAt": "2020-02-07T20:05:35Z", "path": "pom.xml", "diffHunk": "@@ -147,6 +147,7 @@\n     <dependency>\n       <groupId>org.jenkins-ci.plugins.workflow</groupId>\n       <artifactId>workflow-cps</artifactId>\n+      <classifier>tests</classifier>", "originalCommit": "62e605681752ea7c4b377a281049ee909838a9de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzNTI0OQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r380335249", "bodyText": "Added the classified dependency.", "author": "kerogers-cloudbees", "createdAt": "2020-02-17T19:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MjkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MzE1Mg==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376583152", "bodyText": "If you are not going to make a change, better to revert.", "author": "jglick", "createdAt": "2020-02-07T20:06:03Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,96 +119,105 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        this.inheritFrom = Util.fixEmpty(inheritFrom);\n     }\n \n+    @CheckForNull\n     public List<ContainerTemplate> getContainers() {\n         return containers;\n     }\n \n     @DataBoundSetter\n-    public void setContainers(List<ContainerTemplate> containers) {\n-        this.containers = containers;\n+    public void setContainers(@CheckForNull List<ContainerTemplate> containers) {\n+        this.containers = Util.fixNull(containers);\n     }\n \n+    @CheckForNull\n     public List<TemplateEnvVar> getEnvVars() {\n         return envVars == null ? Collections.emptyList() : envVars;\n     }\n \n     @DataBoundSetter\n-    public void setEnvVars(List<TemplateEnvVar> envVars) {\n+    public void setEnvVars(@CheckForNull List<TemplateEnvVar> envVars) {\n         if (envVars != null) {\n             this.envVars.clear();\n             this.envVars.addAll(envVars);\n         }\n     }\n \n+    @CheckForNull\n     public YamlMergeStrategy getYamlMergeStrategy() {\n         return yamlMergeStrategy;\n     }\n \n     @DataBoundSetter\n-    public void setYamlMergeStrategy(YamlMergeStrategy yamlMergeStrategy) {\n+    public void setYamlMergeStrategy(@CheckForNull YamlMergeStrategy yamlMergeStrategy) {\n         this.yamlMergeStrategy = yamlMergeStrategy;\n     }\n \n+    @CheckForNull\n     public List<PodVolume> getVolumes() {\n         return volumes;\n     }\n \n     @DataBoundSetter\n-    public void setVolumes(List<PodVolume> volumes) {\n-        this.volumes = volumes;\n+    public void setVolumes(@CheckForNull List<PodVolume> volumes) {\n+        this.volumes = Util.fixNull(volumes);\n     }\n \n+    @CheckForNull\n     public WorkspaceVolume getWorkspaceVolume() {\n-        return workspaceVolume;\n+        return workspaceVolume == null ? DescriptorImpl.defaultWorkspaceVolume : this.workspaceVolume;\n     }\n \n     @DataBoundSetter\n-    public void setWorkspaceVolume(WorkspaceVolume workspaceVolume) {\n-        this.workspaceVolume = workspaceVolume;\n+    public void setWorkspaceVolume(@CheckForNull WorkspaceVolume workspaceVolume) {\n+        this.workspaceVolume = (workspaceVolume == null || workspaceVolume.equals(DescriptorImpl.defaultWorkspaceVolume)) ? null : workspaceVolume;\n     }\n \n     public int getInstanceCap() {\n-        return instanceCap;\n+        return instanceCap;// == null ? DescriptorImpl.defaultInstanceCap : instanceCap;", "originalCommit": "62e605681752ea7c4b377a281049ee909838a9de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxMDkzOQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376610939", "bodyText": "Did not mean to commit that commented code. I will remove it.", "author": "kerogers-cloudbees", "createdAt": "2020-02-07T21:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MzE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MzY2NQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376583665", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Issue({\"JENKINS-57828\", \"CPLT2-6206\"})\n          \n          \n            \n                @Issue(\"JENKINS-57828\")", "author": "jglick", "createdAt": "2020-02-07T20:07:21Z", "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package org.csanchez.jenkins.plugins.kubernetes.pipeline;\n+\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.Always;\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.OnFailure;\n+import org.csanchez.jenkins.plugins.kubernetes.volumes.workspace.DynamicPVCWorkspaceVolume;\n+import org.jenkinsci.plugins.workflow.cps.SnippetizerTester;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+\n+import static org.junit.Assert.*;\n+\n+public class PodTemplateStepTest {\n+    @Rule\n+    public JenkinsRule rule = new JenkinsRule();\n+\n+    @Issue({\"JENKINS-57828\", \"CPLT2-6206\"})", "originalCommit": "62e605681752ea7c4b377a281049ee909838a9de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NDcwMA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376584700", "bodyText": "Since you did not patch PodTemplateStep/config.jelly, these constants are useless.", "author": "jglick", "createdAt": "2020-02-07T20:09:48Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -363,5 +417,8 @@ public boolean takesImplicitBlockArgument() {\n         public String getWorkingDir() {\n             return ContainerTemplate.DEFAULT_WORKING_DIR;\n         }\n+\n+        public static final PodRetention defaultPodRetention = new Always();\n+        public static final WorkspaceVolume defaultWorkspaceVolume = new DynamicPVCWorkspaceVolume(null, null, \"ReadWriteOnce\");", "originalCommit": "62e605681752ea7c4b377a281049ee909838a9de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NzE2Ng==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376587166", "bodyText": "Also the defaults look wrong. PodRetention.getPodTemplateDefault() is used for podRetention, and it might be significant that the default is left as null. Same for workspaceVolume and WorkspaceVolume getDefault(). I suspect that the config.jelly defaults were broken here, but this is just making it worse by extending the problem to the runtime.", "author": "jglick", "createdAt": "2020-02-07T20:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NDcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU5MjQ3MA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376592470", "bodyText": "Confirmed, the default selections in /pipeline-syntax/ are incorrect: they do not match the actual default behavior. The generator suggests\n\u2026, podRetention: always(), \u2026, workspaceVolume: dynamicPVC(\u2026), \u2026\nwhereas the actual defaults (according to code inspection) are\n\u2026, podRetention: default(), \u2026, workspaceVolume: emptyDirWorkspaceVolume(false), \u2026\n(Note that you cannot actually use the symbol default as in \n  \n    \n      kubernetes-plugin/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pod/retention/Default.java\n    \n    \n         Line 65\n      in\n      a54923a\n    \n    \n    \n    \n\n        \n          \n           @Symbol(\"default\") \n        \n    \n  \n\n as this is a keyword. Something else should have been chosen.)\nSo how does this happen?\n\nThe dropdown under Pod Retention defaults to Always just because that is first in the list and no default is specified. That is simply wrong.\nThe Workspace Volume configuration from #114 is not done in regular fashion. There should be no Use custom workspace volume checkbox.\n\nIt looks like #363 & #622 cleaned these things up in global pod template configuration but not in step configuration. Understandably: no one bothered to check the snippet generator, because it was so broken anyway.", "author": "jglick", "createdAt": "2020-02-07T20:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NDcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU5NDUzMw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376594533", "bodyText": "AFAICT \n  \n    \n      kubernetes-plugin/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplate.java\n    \n    \n        Lines 899 to 900\n      in\n      a54923a\n    \n    \n    \n    \n\n        \n          \n           public WorkspaceVolume getDefaultWorkspaceVolume() { \n        \n\n        \n          \n               return WorkspaceVolume.getDefault(); \n        \n    \n  \n\n is doing the right thing for global config. \n  \n    \n      kubernetes-plugin/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplate.java\n    \n    \n        Lines 905 to 906\n      in\n      a54923a\n    \n    \n    \n    \n\n        \n          \n           public Descriptor getDefaultPodRetention() { \n        \n\n        \n          \n               return Jenkins.get().getDescriptor(PodRetention.getPodTemplateDefault().getClass()); \n        \n    \n  \n\n works in that Default has no fields, but is poor style; better would be\npublic PodRetention getDefaultPodRetention() {\n    return PodRetention.getPodTemplateDefault();\n}\nsince dropdownDescriptorSelector.jelly documentation says that instances are supported for default:\n\nThe default can be a specific instance or a descriptor e.g. ${descriptor.defaultSettingsProvider} or ${descriptor.defaultSettingsProvider.descriptor}. In the later case, the from input fields will be empty.", "author": "jglick", "createdAt": "2020-02-07T20:35:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NDcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU5NzAyOQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376597029", "bodyText": "So, as to a fix:\n\nI think you should revert any changes to the behavior of getters (nullability annotations are fine). The configuration here is complicated due to the layering of per-step settings over (or under?) global settings, so nulls are significant in some cases. See null checks like: \n  \n    \n      kubernetes-plugin/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java\n    \n    \n         Line 109\n      in\n      a54923a\n    \n    \n    \n    \n\n        \n          \n           if (step.getWorkspaceVolume() != null) { \n        \n    \n  \n\n\nThe setter changes may be OK, though I am not sure. @Vlatombe would know if explicitly setting something to what ought to be its default value is actually required in order to override global settings.\nThe new defaultXXX fields need to use the actual defaults mentioned above.\nThe config.jelly needs to read those defaults, like PodTemplate/config.jelly already does.", "author": "jglick", "createdAt": "2020-02-07T20:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NDcwMA=="}], "type": "inlineReview"}, {"oid": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/f83ee334377876adfd3a8cca9513eb6b8917f4d8", "message": "Update src/test/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepTest.java\r\n\r\nChange @Issue argument.\n\nCo-Authored-By: Jesse Glick <jglick@cloudbees.com>", "committedDate": "2020-02-07T20:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNDU5Nw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376604597", "bodyText": "revert", "author": "jglick", "createdAt": "2020-02-07T20:59:04Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,96 +119,105 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        this.inheritFrom = Util.fixEmpty(inheritFrom);\n     }\n \n+    @CheckForNull\n     public List<ContainerTemplate> getContainers() {\n         return containers;\n     }\n \n     @DataBoundSetter\n-    public void setContainers(List<ContainerTemplate> containers) {\n-        this.containers = containers;\n+    public void setContainers(@CheckForNull List<ContainerTemplate> containers) {", "originalCommit": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNDYzMQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376604631", "bodyText": "revert", "author": "jglick", "createdAt": "2020-02-07T20:59:08Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,96 +119,105 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        this.inheritFrom = Util.fixEmpty(inheritFrom);\n     }\n \n+    @CheckForNull\n     public List<ContainerTemplate> getContainers() {\n         return containers;\n     }\n \n     @DataBoundSetter\n-    public void setContainers(List<ContainerTemplate> containers) {\n-        this.containers = containers;\n+    public void setContainers(@CheckForNull List<ContainerTemplate> containers) {\n+        this.containers = Util.fixNull(containers);", "originalCommit": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNDcyNg==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376604726", "bodyText": "revert", "author": "jglick", "createdAt": "2020-02-07T20:59:22Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -36,40 +38,77 @@\n \n     private static final String DEFAULT_CLOUD = \"kubernetes\";\n \n+    @CheckForNull\n     private String cloud = DEFAULT_CLOUD;\n+\n+    @CheckForNull\n     private String inheritFrom;\n \n+    @CheckForNull\n     private String label;\n+\n+    @CheckForNull\n     private String name;\n \n+    @CheckForNull\n     private String namespace;\n+\n+    @CheckForNull", "originalCommit": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNDc5MQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376604791", "bodyText": "revert", "author": "jglick", "createdAt": "2020-02-07T20:59:32Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,96 +119,105 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        this.inheritFrom = Util.fixEmpty(inheritFrom);\n     }\n \n+    @CheckForNull", "originalCommit": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNTMyMQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376605321", "bodyText": "revert", "author": "jglick", "createdAt": "2020-02-07T21:00:55Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -36,40 +38,77 @@\n \n     private static final String DEFAULT_CLOUD = \"kubernetes\";\n \n+    @CheckForNull\n     private String cloud = DEFAULT_CLOUD;\n+\n+    @CheckForNull\n     private String inheritFrom;\n \n+    @CheckForNull\n     private String label;\n+\n+    @CheckForNull\n     private String name;\n \n+    @CheckForNull\n     private String namespace;\n+\n+    @CheckForNull\n     private List<ContainerTemplate> containers = new ArrayList<>();\n+\n+    @CheckForNull\n     private List<TemplateEnvVar> envVars = new ArrayList<>();\n+\n+    @CheckForNull", "originalCommit": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNTM3MQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376605371", "bodyText": "delete", "author": "jglick", "createdAt": "2020-02-07T21:01:02Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,96 +119,105 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        this.inheritFrom = Util.fixEmpty(inheritFrom);\n     }\n \n+    @CheckForNull\n     public List<ContainerTemplate> getContainers() {\n         return containers;\n     }\n \n     @DataBoundSetter\n-    public void setContainers(List<ContainerTemplate> containers) {\n-        this.containers = containers;\n+    public void setContainers(@CheckForNull List<ContainerTemplate> containers) {\n+        this.containers = Util.fixNull(containers);\n     }\n \n+    @CheckForNull\n     public List<TemplateEnvVar> getEnvVars() {\n         return envVars == null ? Collections.emptyList() : envVars;\n     }\n \n     @DataBoundSetter\n-    public void setEnvVars(List<TemplateEnvVar> envVars) {\n+    public void setEnvVars(@CheckForNull List<TemplateEnvVar> envVars) {\n         if (envVars != null) {\n             this.envVars.clear();\n             this.envVars.addAll(envVars);\n         }\n     }\n \n+    @CheckForNull\n     public YamlMergeStrategy getYamlMergeStrategy() {\n         return yamlMergeStrategy;\n     }\n \n     @DataBoundSetter\n-    public void setYamlMergeStrategy(YamlMergeStrategy yamlMergeStrategy) {\n+    public void setYamlMergeStrategy(@CheckForNull YamlMergeStrategy yamlMergeStrategy) {\n         this.yamlMergeStrategy = yamlMergeStrategy;\n     }\n \n+    @CheckForNull", "originalCommit": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNTQyNw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r376605427", "bodyText": "revert both", "author": "jglick", "createdAt": "2020-02-07T21:01:10Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,96 +119,105 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        this.inheritFrom = Util.fixEmpty(inheritFrom);\n     }\n \n+    @CheckForNull\n     public List<ContainerTemplate> getContainers() {\n         return containers;\n     }\n \n     @DataBoundSetter\n-    public void setContainers(List<ContainerTemplate> containers) {\n-        this.containers = containers;\n+    public void setContainers(@CheckForNull List<ContainerTemplate> containers) {\n+        this.containers = Util.fixNull(containers);\n     }\n \n+    @CheckForNull\n     public List<TemplateEnvVar> getEnvVars() {\n         return envVars == null ? Collections.emptyList() : envVars;\n     }\n \n     @DataBoundSetter\n-    public void setEnvVars(List<TemplateEnvVar> envVars) {\n+    public void setEnvVars(@CheckForNull List<TemplateEnvVar> envVars) {\n         if (envVars != null) {\n             this.envVars.clear();\n             this.envVars.addAll(envVars);\n         }\n     }\n \n+    @CheckForNull\n     public YamlMergeStrategy getYamlMergeStrategy() {\n         return yamlMergeStrategy;\n     }\n \n     @DataBoundSetter\n-    public void setYamlMergeStrategy(YamlMergeStrategy yamlMergeStrategy) {\n+    public void setYamlMergeStrategy(@CheckForNull YamlMergeStrategy yamlMergeStrategy) {\n         this.yamlMergeStrategy = yamlMergeStrategy;\n     }\n \n+    @CheckForNull\n     public List<PodVolume> getVolumes() {\n         return volumes;\n     }\n \n     @DataBoundSetter\n-    public void setVolumes(List<PodVolume> volumes) {\n-        this.volumes = volumes;\n+    public void setVolumes(@CheckForNull List<PodVolume> volumes) {\n+        this.volumes = Util.fixNull(volumes);", "originalCommit": "f83ee334377876adfd3a8cca9513eb6b8917f4d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13820a70d2129bbf75402edfcb7840738fae650c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/13820a70d2129bbf75402edfcb7840738fae650c", "message": "[CPLT2-6206][JENKINS-57828] Updates from code review\nRevert changes to list properties, they are all initialized and should never be null.\nChange defaults to be the same as the PodTemplate defaults.\nChange config.jelly to use these defaults also.", "committedDate": "2020-02-07T21:41:36Z", "type": "commit"}, {"oid": "67884c3dac1b2efe0574c06eefec0f8afc5be251", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/67884c3dac1b2efe0574c06eefec0f8afc5be251", "message": "Merge branch 'podTemplate-snippet-jenkins-57828-cplt2-6206' of github.com:kerogers-cloudbees/kubernetes-plugin into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-02-07T21:42:11Z", "type": "commit"}, {"oid": "511a7c1ab226330171697d6f49550a9b61c74827", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/511a7c1ab226330171697d6f49550a9b61c74827", "message": "Fix unit test to use corrected defaults.", "committedDate": "2020-02-07T21:50:03Z", "type": "commit"}, {"oid": "984d409844810eeaca84fd3147e8df591244c784", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/984d409844810eeaca84fd3147e8df591244c784", "message": "add dependency with classifier for tests.", "committedDate": "2020-02-07T22:43:35Z", "type": "commit"}, {"oid": "4f57e22ccc4d2439ffc7b1edf54e63c30bdb3db6", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4f57e22ccc4d2439ffc7b1edf54e63c30bdb3db6", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-02-12T13:08:30Z", "type": "commit"}, {"oid": "14886ef514a2b1f6ac36f9f7c0940c3ae56e0a27", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/14886ef514a2b1f6ac36f9f7c0940c3ae56e0a27", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-02-13T13:09:25Z", "type": "commit"}, {"oid": "924d0a059e8a3f485b27cc07a31c89536a14d9c0", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/924d0a059e8a3f485b27cc07a31c89536a14d9c0", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-02-13T13:31:51Z", "type": "commit"}, {"oid": "0e8ea09f11a9cda2e7f3da08027113fe5d3c0ba1", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/0e8ea09f11a9cda2e7f3da08027113fe5d3c0ba1", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-02-17T08:53:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMDY2Ng==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r380200666", "bodyText": "I think this is causing\no.c.j.p.k.KubernetesCloud#addProvisionedSlave: Maximum number of concurrently running agent pods (0) reached for template docker_1-b72k5-81dhh in Kubernetes Cloud kubernetes, not provisioning: 0 running or pending in namespace kubernetes-plugin-test with label \"docker_1-b72k5\" and Kubernetes labels {jenkins=slave, BUILD_NUMBER=undefined, jenkins/label=docker_1-b72k5, test=docker, BRANCH_NAME=undefined, class=ContainerExecDecoratorPipelineTest}", "author": "Vlatombe", "createdAt": "2020-02-17T14:06:03Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -36,40 +37,65 @@\n \n     private static final String DEFAULT_CLOUD = \"kubernetes\";\n \n+    @CheckForNull\n     private String cloud = DEFAULT_CLOUD;\n+\n+    @CheckForNull\n     private String inheritFrom;\n \n+    @CheckForNull\n     private String label;\n+\n+    @CheckForNull\n     private String name;\n \n+    @CheckForNull\n     private String namespace;\n+\n     private List<ContainerTemplate> containers = new ArrayList<>();\n     private List<TemplateEnvVar> envVars = new ArrayList<>();\n     private List<PodVolume> volumes = new ArrayList<PodVolume>();\n+\n+    @CheckForNull\n     private WorkspaceVolume workspaceVolume;\n+\n     private List<PodAnnotation> annotations = new ArrayList<>();\n     private List<String> imagePullSecrets = new ArrayList<>();\n \n-    private int instanceCap = Integer.MAX_VALUE;\n+    private int instanceCap;", "originalCommit": "0e8ea09f11a9cda2e7f3da08027113fe5d3c0ba1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMTkyNw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r380201927", "bodyText": "kubernetes-plugin/src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubernetesCloud.java\n    \n    \n        Lines 586 to 592\n      in\n      f7e84d5\n    \n    \n    \n    \n\n        \n          \n           if (activeTemplateSlavePods != null && allActiveSlavePods != null && template.getInstanceCap() <= activeTemplateSlavePods.size() + scheduledCount) { \n        \n\n        \n          \n               LOGGER.log(Level.INFO, \n        \n\n        \n          \n                       \"Maximum number of concurrently running agent pods ({0}) reached for template {1} in Kubernetes Cloud {6}, not provisioning: {2} running or pending in namespace {3} with label \\\"{4}\\\" and Kubernetes labels {5}\", \n        \n\n        \n          \n                       new Object[] { template.getInstanceCap(), template.getName(), activeTemplateSlavePods.size() + scheduledCount, \n        \n\n        \n          \n                               templateNamespace, label == null ? \"\" : label.toString(), labelsMap, name }); \n        \n\n        \n          \n               return false; \n        \n\n        \n          \n           } \n        \n    \n  \n\n should have a quick exit when instanceCap == 0", "author": "Vlatombe", "createdAt": "2020-02-17T14:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwMDY2Ng=="}], "type": "inlineReview"}, {"oid": "934a27cc083a069cca4f4265ed0c424287f42959", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/934a27cc083a069cca4f4265ed0c424287f42959", "message": "[CPLT2-6206] Changing PodTemplateStep to have a default value for instanceCap of Integer.MAX_VALUE. Adding logic to the setter that sets instanceCap to Integer.MAX_VALUE if the Integer passed to it is null  or less than equal to 0.", "committedDate": "2020-02-17T18:59:43Z", "type": "commit"}, {"oid": "a17439adbe211248e0b3c18625f3c605187f1eb1", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/a17439adbe211248e0b3c18625f3c605187f1eb1", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-02-18T15:47:15Z", "type": "commit"}, {"oid": "4b0100275b142b1a825fd0b799678a422ff32d73", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4b0100275b142b1a825fd0b799678a422ff32d73", "message": "Fix merge", "committedDate": "2020-02-18T16:26:44Z", "type": "commit"}, {"oid": "9082ddd8c52919e1069f745913c8d4840f42426c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/9082ddd8c52919e1069f745913c8d4840f42426c", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-02-25T00:27:14Z", "type": "commit"}, {"oid": "4504773f4337a64680d41c80aacaa9849d2e6758", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4504773f4337a64680d41c80aacaa9849d2e6758", "message": "[CPLT2-6206] special case for inheritFrom to allow KubernetesPipelineTest.runInPodNestedExplicitInherit to pass. Having inheritFrom be null instead of an empty string was breaking something in the podTemplate construction.", "committedDate": "2020-02-28T13:41:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMTkxNw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r385721917", "bodyText": "While this would have been a better syntax to mean \u201cdo not inherit\u201d, it it too late to do that now\u2014this change is not backward compatible. As mentioned, you need to restore the meaning of '', and introduce a different notation for \u201cuse default inheritance\u201d which would normally not be present in Groovy but would be used just as a form default for Pipeline Syntax.", "author": "jglick", "createdAt": "2020-02-28T14:23:37Z", "path": "src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/runInPodNestedExplicitInherit.groovy", "diffHunk": "@@ -2,7 +2,7 @@ podTemplate(label: '$NAME-parent', containers: [\n \t\tcontainerTemplate(name: 'golang', image: 'golang:1.6.3-alpine', ttyEnabled: true, command: '/bin/cat'),\n \t]) {\n \n-\tpodTemplate(inheritFrom: '',  containers: [\n+\tpodTemplate(inheritFrom: '-',  containers: [", "originalCommit": "4504773f4337a64680d41c80aacaa9849d2e6758", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5NjMzMQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r385796331", "bodyText": "Based on where the inheritFrom is used, null is the way to tell it to \"use default inheritance\", the change I made for the snippet generator caused the empty string to be converted to null, causing the test to fail.\nI could change the default for inheritFrom to be an empty string but I think that would break runInPodNested test.", "author": "kerogers-cloudbees", "createdAt": "2020-02-28T16:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxNDg2MA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r385914860", "bodyText": "null is the way to tell it to \"use default inheritance\", the change I made for the snippet generator caused the empty string to be converted to null, causing the test to fail.\n\nCorrect AFAIK.\n\nI could change the default for inheritFrom to be an empty string\n\nNo, that is not safe, as it would disable inheritance by default\u2014even worse than the current state.\nThe most straightforward solution is to introduce some constant string which is neither blank nor a possible template name and which could reasonably convey the notion of \u201cdo the default thing\u201d\u2014say, <default>\u2014which would be the default value for the textbox in the form, with setInheritFrom translating it to a null field value. This text would never be expected in a real Pipeline script; the snippet generator would simply omit the inheritFrom attribute if you did not edit the field, which is what we want. If it does not already, the inline help-inheritFrom.html needs to explain the situation, specifically that you may blank out the field to suppress inheritance.\n(SnippetizerTester is not particularly useful for testing this situation since it makes no reference to the config.jelly. StepConfigTester, from workflow-step-api, actually exercises the config form, though in an artificial way which would also get confused by this trick: configRoundTrip would call getInheritFrom, see null, and translate that to a blank textfield (the implied value=\"${instance.inheritFrom}\" makes no distinct between null and \"\"), which upon form submission would call the setter on \"\" and produce a distinct object. In other words configRoundTrip always operates with instance != null, whereas the actual Pipeline Syntax screen always operates with a null instance (only a non-null descriptor) since you are not reconfiguring something that is already serialized. Having getInheritFrom convert null back to the new magic string would solve that issue, but is not very intuitive, and would require another helper method like getActualInheritFrom to be called from Java code, as opposed to the config form. tl;dr: probably best to test behavior of this field interactively.)", "author": "jglick", "createdAt": "2020-02-28T20:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMTkxNw=="}], "type": "inlineReview"}, {"oid": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "message": "[CPLT2-6206] Change the special string to \",default,\" as it doesn't require escaping in either xml or java and seems very unlikely to ever be the name of an actual template.", "committedDate": "2020-03-03T20:27:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4ODgwOQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387288809", "bodyText": "Why this strange string? The commit comment says something about escaping in XML and Java but I do not see how that would be relevant. The value will only ever be used inside the snippet generator.", "author": "jglick", "createdAt": "2020-03-03T20:57:12Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -147,7 +147,7 @@ public String getInheritFrom() {\n \n     @DataBoundSetter\n     public void setInheritFrom(@CheckForNull String inheritFrom) {\n-        if (inheritFrom != null && inheritFrom.equals(\"-\")) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass\n+        if (inheritFrom != null && inheritFrom.equals(\",default,\")) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4OTYxNg==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387289616", "bodyText": "Best to share this constant with the Java code by referring to some (possibly static) field of the descriptor, e.g.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <f:textbox default=\",default,\"/>\n          \n          \n            \n                <f:textbox default=\"${descriptor.defaultInheritFrom}\"/>\n          \n      \n    \n    \n  \n\nGuide", "author": "jglick", "createdAt": "2020-03-03T20:58:43Z", "path": "src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep/config.jelly", "diffHunk": "@@ -24,7 +24,7 @@\n \n   <f:entry field=\"inheritFrom\" title=\"${%Pod template to inherit from}\"\n     help=\"/plugin/kubernetes/help/inheritFrom.html\">\n-    <f:textbox/>\n+    <f:textbox default=\",default,\"/>", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MTcwOQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387291709", "bodyText": "(plus use of the same constant in setInheritFrom of course)", "author": "jglick", "createdAt": "2020-03-03T21:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4OTYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MDc2Mw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387290763", "bodyText": "Simpler:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (inheritFrom != null && inheritFrom.equals(\",default,\")) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass\n          \n          \n            \n                    if (\",default,\".equals(inheritFrom)) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass", "author": "jglick", "createdAt": "2020-03-03T21:00:58Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,44 +106,52 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        if (inheritFrom != null && inheritFrom.equals(\",default,\")) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MTA4NA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387291084", "bodyText": "No, this looks all backwards. \"\" means do not inherit. Null means inherit in the default way.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        this.inheritFrom = \"\";\n          \n          \n            \n                        this.inheritFrom = null;", "author": "jglick", "createdAt": "2020-03-03T21:01:36Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,44 +106,52 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        if (inheritFrom != null && inheritFrom.equals(\",default,\")) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass\n+            this.inheritFrom = \"\";", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MTI4OQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387291289", "bodyText": "As above, this looks backwards:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        this.inheritFrom = Util.fixEmpty(inheritFrom);\n          \n          \n            \n                        this.inheritFrom = inheritFrom;", "author": "jglick", "createdAt": "2020-03-03T21:02:01Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,44 +106,52 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        if (inheritFrom != null && inheritFrom.equals(\",default,\")) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass\n+            this.inheritFrom = \"\";\n+        } else {\n+            this.inheritFrom = Util.fixEmpty(inheritFrom);", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MjExMw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387292113", "bodyText": "So revert this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpodTemplate(inheritFrom: '-',  containers: [\n          \n          \n            \n            \tpodTemplate(inheritFrom: '',  containers: [", "author": "jglick", "createdAt": "2020-03-03T21:03:45Z", "path": "src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/runInPodNestedExplicitInherit.groovy", "diffHunk": "@@ -2,7 +2,7 @@ podTemplate(label: '$NAME-parent', containers: [\n \t\tcontainerTemplate(name: 'golang', image: 'golang:1.6.3-alpine', ttyEnabled: true, command: '/bin/cat'),\n \t]) {\n \n-\tpodTemplate(inheritFrom: '',  containers: [\n+\tpodTemplate(inheritFrom: '-',  containers: [", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MjY3Nw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387292677", "bodyText": "But it does, or am I missing something?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertEquals(\"inheritFrom not changed from \\\",default,\\\" to \\\"\\\" by setter\", \"\", step.getInheritFrom());\n          \n          \n            \n                    assertNull(\"inheritFrom changed from default marker to null by setter\", \"\", step.getInheritFrom());", "author": "jglick", "createdAt": "2020-03-03T21:04:56Z", "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.csanchez.jenkins.plugins.kubernetes.pipeline;\n+\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.Always;\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.OnFailure;\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.PodRetention;\n+import org.csanchez.jenkins.plugins.kubernetes.volumes.workspace.DynamicPVCWorkspaceVolume;\n+import org.csanchez.jenkins.plugins.kubernetes.volumes.workspace.EmptyDirWorkspaceVolume;\n+import org.jenkinsci.plugins.workflow.cps.SnippetizerTester;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+\n+import static org.junit.Assert.*;\n+\n+public class PodTemplateStepTest {\n+    @Rule\n+    public JenkinsRule rule = new JenkinsRule();\n+\n+    @Issue(\"JENKINS-57828\")\n+    @Test\n+    public void configRoundTrip() throws Exception {\n+        SnippetizerTester st = new SnippetizerTester(rule);\n+        PodTemplateStep step = new PodTemplateStep();\n+\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setName(\"podTest\");\n+        st.assertRoundTrip(step, \"podTemplate(name: 'podTest') {\\n    // some block\\n}\");\n+        step.setName(\"\");\n+        step.setInstanceCap(5);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 5) {\\n    // some block\\n}\");\n+        step.setInstanceCap(0);\n+        step.setInstanceCap(6);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 6) {\\n    // some block\\n}\");\n+        step.setInstanceCap(null); // make sure this resets instanceCap\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setInstanceCap(7);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 7) {\\n    // some block\\n}\");\n+        step.setInstanceCap(Integer.MAX_VALUE); // make sure this resets instanceCap\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setLabel(\"podLabel\");\n+        st.assertRoundTrip(step, \"podTemplate(label: 'podLabel') {\\n    // some block\\n}\");\n+        step.setLabel(\"\");\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setPodRetention(PodRetention.getPodTemplateDefault()); // this is the default, it should not appear in the snippet.\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setPodRetention(new OnFailure());\n+        st.assertRoundTrip(step, \"podTemplate(podRetention: onFailure()) {\\n    // some block\\n}\");\n+        step.setPodRetention(null);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new DynamicPVCWorkspaceVolume());\n+        st.assertRoundTrip(step, \"podTemplate(workspaceVolume: dynamicPVC()) {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new EmptyDirWorkspaceVolume(false)); // this is the default, it should not be in the snippet.\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new DynamicPVCWorkspaceVolume(null, null, \"ReadWriteMany\"));\n+        st.assertRoundTrip(step, \"podTemplate(workspaceVolume: dynamicPVC(accessModes: 'ReadWriteMany')) {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(null);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setActiveDeadlineSeconds(60);\n+        st.assertRoundTrip(step, \"podTemplate(activeDeadlineSeconds: 60) {\\n    // some block\\n}\");\n+        step.setActiveDeadlineSeconds(0);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setInheritFrom(\"fooBar\");\n+        st.assertRoundTrip(step, \"podTemplate(inheritFrom: 'fooBar') {\\n    // some block\\n}\");\n+        step.setInheritFrom(\",default,\");\n+        assertEquals(\"inheritFrom not changed from \\\",default,\\\" to \\\"\\\" by setter\", \"\", step.getInheritFrom());", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5Mjg5MA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387292890", "bodyText": "Probably best to share constant with this test code as well.", "author": "jglick", "createdAt": "2020-03-03T21:05:18Z", "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.csanchez.jenkins.plugins.kubernetes.pipeline;\n+\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.Always;\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.OnFailure;\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.PodRetention;\n+import org.csanchez.jenkins.plugins.kubernetes.volumes.workspace.DynamicPVCWorkspaceVolume;\n+import org.csanchez.jenkins.plugins.kubernetes.volumes.workspace.EmptyDirWorkspaceVolume;\n+import org.jenkinsci.plugins.workflow.cps.SnippetizerTester;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+\n+import static org.junit.Assert.*;\n+\n+public class PodTemplateStepTest {\n+    @Rule\n+    public JenkinsRule rule = new JenkinsRule();\n+\n+    @Issue(\"JENKINS-57828\")\n+    @Test\n+    public void configRoundTrip() throws Exception {\n+        SnippetizerTester st = new SnippetizerTester(rule);\n+        PodTemplateStep step = new PodTemplateStep();\n+\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setName(\"podTest\");\n+        st.assertRoundTrip(step, \"podTemplate(name: 'podTest') {\\n    // some block\\n}\");\n+        step.setName(\"\");\n+        step.setInstanceCap(5);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 5) {\\n    // some block\\n}\");\n+        step.setInstanceCap(0);\n+        step.setInstanceCap(6);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 6) {\\n    // some block\\n}\");\n+        step.setInstanceCap(null); // make sure this resets instanceCap\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setInstanceCap(7);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 7) {\\n    // some block\\n}\");\n+        step.setInstanceCap(Integer.MAX_VALUE); // make sure this resets instanceCap\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setLabel(\"podLabel\");\n+        st.assertRoundTrip(step, \"podTemplate(label: 'podLabel') {\\n    // some block\\n}\");\n+        step.setLabel(\"\");\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setPodRetention(PodRetention.getPodTemplateDefault()); // this is the default, it should not appear in the snippet.\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setPodRetention(new OnFailure());\n+        st.assertRoundTrip(step, \"podTemplate(podRetention: onFailure()) {\\n    // some block\\n}\");\n+        step.setPodRetention(null);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new DynamicPVCWorkspaceVolume());\n+        st.assertRoundTrip(step, \"podTemplate(workspaceVolume: dynamicPVC()) {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new EmptyDirWorkspaceVolume(false)); // this is the default, it should not be in the snippet.\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new DynamicPVCWorkspaceVolume(null, null, \"ReadWriteMany\"));\n+        st.assertRoundTrip(step, \"podTemplate(workspaceVolume: dynamicPVC(accessModes: 'ReadWriteMany')) {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(null);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setActiveDeadlineSeconds(60);\n+        st.assertRoundTrip(step, \"podTemplate(activeDeadlineSeconds: 60) {\\n    // some block\\n}\");\n+        step.setActiveDeadlineSeconds(0);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setInheritFrom(\"fooBar\");\n+        st.assertRoundTrip(step, \"podTemplate(inheritFrom: 'fooBar') {\\n    // some block\\n}\");\n+        step.setInheritFrom(\",default,\");", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MzU3MA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r387293570", "bodyText": "And then you also need something like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n          \n          \n            \n                    st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n          \n          \n            \n                    step.setInheritFrom(\"\");\n          \n          \n            \n                    st.assertRoundTrip(step, \"podTemplate(inheritFrom: '') {\\n    // some block\\n}\");", "author": "jglick", "createdAt": "2020-03-03T21:06:40Z", "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.csanchez.jenkins.plugins.kubernetes.pipeline;\n+\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.Always;\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.OnFailure;\n+import org.csanchez.jenkins.plugins.kubernetes.pod.retention.PodRetention;\n+import org.csanchez.jenkins.plugins.kubernetes.volumes.workspace.DynamicPVCWorkspaceVolume;\n+import org.csanchez.jenkins.plugins.kubernetes.volumes.workspace.EmptyDirWorkspaceVolume;\n+import org.jenkinsci.plugins.workflow.cps.SnippetizerTester;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.jvnet.hudson.test.Issue;\n+import org.jvnet.hudson.test.JenkinsRule;\n+\n+import static org.junit.Assert.*;\n+\n+public class PodTemplateStepTest {\n+    @Rule\n+    public JenkinsRule rule = new JenkinsRule();\n+\n+    @Issue(\"JENKINS-57828\")\n+    @Test\n+    public void configRoundTrip() throws Exception {\n+        SnippetizerTester st = new SnippetizerTester(rule);\n+        PodTemplateStep step = new PodTemplateStep();\n+\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setName(\"podTest\");\n+        st.assertRoundTrip(step, \"podTemplate(name: 'podTest') {\\n    // some block\\n}\");\n+        step.setName(\"\");\n+        step.setInstanceCap(5);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 5) {\\n    // some block\\n}\");\n+        step.setInstanceCap(0);\n+        step.setInstanceCap(6);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 6) {\\n    // some block\\n}\");\n+        step.setInstanceCap(null); // make sure this resets instanceCap\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setInstanceCap(7);\n+        st.assertRoundTrip(step, \"podTemplate(instanceCap: 7) {\\n    // some block\\n}\");\n+        step.setInstanceCap(Integer.MAX_VALUE); // make sure this resets instanceCap\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setLabel(\"podLabel\");\n+        st.assertRoundTrip(step, \"podTemplate(label: 'podLabel') {\\n    // some block\\n}\");\n+        step.setLabel(\"\");\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setPodRetention(PodRetention.getPodTemplateDefault()); // this is the default, it should not appear in the snippet.\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setPodRetention(new OnFailure());\n+        st.assertRoundTrip(step, \"podTemplate(podRetention: onFailure()) {\\n    // some block\\n}\");\n+        step.setPodRetention(null);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new DynamicPVCWorkspaceVolume());\n+        st.assertRoundTrip(step, \"podTemplate(workspaceVolume: dynamicPVC()) {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new EmptyDirWorkspaceVolume(false)); // this is the default, it should not be in the snippet.\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(new DynamicPVCWorkspaceVolume(null, null, \"ReadWriteMany\"));\n+        st.assertRoundTrip(step, \"podTemplate(workspaceVolume: dynamicPVC(accessModes: 'ReadWriteMany')) {\\n    // some block\\n}\");\n+        step.setWorkspaceVolume(null);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setActiveDeadlineSeconds(60);\n+        st.assertRoundTrip(step, \"podTemplate(activeDeadlineSeconds: 60) {\\n    // some block\\n}\");\n+        step.setActiveDeadlineSeconds(0);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");\n+        step.setInheritFrom(\"fooBar\");\n+        st.assertRoundTrip(step, \"podTemplate(inheritFrom: 'fooBar') {\\n    // some block\\n}\");\n+        step.setInheritFrom(\",default,\");\n+        assertEquals(\"inheritFrom not changed from \\\",default,\\\" to \\\"\\\" by setter\", \"\", step.getInheritFrom());\n+        step.setInheritFrom(null);\n+        st.assertRoundTrip(step, \"podTemplate {\\n    // some block\\n}\");", "originalCommit": "1662c1e692d0de8ad1b91f3201f2e7c6076991ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMDA4NA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r389710084", "bodyText": "Covered through 7309343#diff-502362a2cf01135e38702358449886d5R65-R66", "author": "Vlatombe", "createdAt": "2020-03-09T14:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MzU3MA=="}], "type": "inlineReview"}, {"oid": "febb56fd49f8027c68f68bcc9330b4545189e1db", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/febb56fd49f8027c68f68bcc9330b4545189e1db", "message": "[CPLT2-6206]  Explain behavior of inheritFrom in the help text.", "committedDate": "2020-03-04T17:33:19Z", "type": "commit"}, {"oid": "6d2fd3010225a3ef36ccaae5ff82c73e4d78d3f3", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/6d2fd3010225a3ef36ccaae5ff82c73e4d78d3f3", "message": "[CPLT2-6206] Changed the string to <noInherit> to reduce the confusion. The behavior I intended for this string to trigger is actually the opposite of the default behavior, it is to create a pod template step that has inheritance set to an empty string so that `PodTemplateStepExecution` will not add the templates to the inheritance.", "committedDate": "2020-03-06T17:19:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NDQyMA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r389064420", "bodyText": "No, this is still incompatible. Again, for compatibility, we must retain the meaning of no inheritance for '', and may only introduce a special value (not used at runtime) to mean do inherit in the default manner.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpodTemplate(inheritFrom: '<noInherit>',  containers: [\n          \n          \n            \n            \tpodTemplate(inheritFrom: '',  containers: [", "author": "jglick", "createdAt": "2020-03-06T18:18:32Z", "path": "src/test/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/runInPodNestedExplicitInherit.groovy", "diffHunk": "@@ -2,7 +2,7 @@ podTemplate(label: '$NAME-parent', containers: [\n \t\tcontainerTemplate(name: 'golang', image: 'golang:1.6.3-alpine', ttyEnabled: true, command: '/bin/cat'),\n \t]) {\n \n-\tpodTemplate(inheritFrom: '-',  containers: [\n+\tpodTemplate(inheritFrom: '<noInherit>',  containers: [", "originalCommit": "6d2fd3010225a3ef36ccaae5ff82c73e4d78d3f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7309343a0a41fed55a0e9926a977ca58b4b6289c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/7309343a0a41fed55a0e9926a977ca58b4b6289c", "message": "[CPLT2-6206] restored empty string to be no inheritance and null to be default inheritance. Use the string \"<default>\" in the snippet generator to mean null in the generated script.", "committedDate": "2020-03-09T13:53:04Z", "type": "commit"}, {"oid": "b36413b56896504cc7797adb913a43607fa2851b", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b36413b56896504cc7797adb913a43607fa2851b", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-03-09T15:27:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxNDAwOQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r390214009", "bodyText": "This needs to be reworded to indicate the following:\n\nnested podTemplate blocks inherits each other by default\n<default> means default inheritance is used\n'' means no inheritance\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Leaving this value empty will cause the podTemplate to inherit from a default build agent template.\n          \n          \n            \n            By default, pod template inherits outer pod template definitions. \n          \n          \n            \n            Inheritance can be stopped by using the empty string.", "author": "Vlatombe", "createdAt": "2020-03-10T10:17:45Z", "path": "src/main/webapp/help/inheritFrom.html", "diffHunk": "@@ -7,4 +7,6 @@\n \n Volume inheritance works exactly as Container templates.\n \n-Image Pull Secrets** are combined (all secrets defined both on 'parent' and 'current' template are used).\n\\ No newline at end of file\n+Image Pull Secrets** are combined (all secrets defined both on 'parent' and 'current' template are used).\n+\n+Leaving this value empty will cause the podTemplate to inherit from a default build agent template.", "originalCommit": "b36413b56896504cc7797adb913a43607fa2851b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNTA0NQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r390635045", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (DescriptorImpl.defaultInheritFrom.equals(inheritFrom)) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass\n          \n          \n            \n                    if (DescriptorImpl.defaultInheritFrom.equals(inheritFrom)) {", "author": "jglick", "createdAt": "2020-03-10T21:57:13Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -80,44 +106,52 @@ public String getLabel() {\n     }\n \n     @DataBoundSetter\n-    public void setLabel(String label) {\n+    public void setLabel(@CheckForNull String label) {\n         this.label = Util.fixEmpty(label);\n     }\n \n-    public @CheckForNull String getName() {\n+    @CheckForNull\n+    public String getName() {\n         return name;\n     }\n \n     @DataBoundSetter\n-    public void setName(String name) {\n+    public void setName(@CheckForNull String name) {\n         this.name = Util.fixEmpty(name);\n     }\n \n+    @CheckForNull\n     public String getNamespace() {\n         return namespace;\n     }\n \n     @DataBoundSetter\n-    public void setNamespace(String namespace) {\n-        this.namespace = namespace;\n+    public void setNamespace(@CheckForNull String namespace) {\n+        this.namespace = Util.fixEmpty(namespace);\n     }\n \n+    @CheckForNull\n     public String getCloud() {\n         return cloud;\n     }\n \n     @DataBoundSetter\n-    public void setCloud(String cloud) {\n-        this.cloud = cloud;\n+    public void setCloud(@CheckForNull String cloud) {\n+        this.cloud = Util.fixEmpty(cloud);\n     }\n \n+    @CheckForNull\n     public String getInheritFrom() {\n         return inheritFrom;\n     }\n \n     @DataBoundSetter\n-    public void setInheritFrom(String inheritFrom) {\n-        this.inheritFrom = inheritFrom;\n+    public void setInheritFrom(@CheckForNull String inheritFrom) {\n+        if (DescriptorImpl.defaultInheritFrom.equals(inheritFrom)) { // Added to make KubernetesPipelineTest.runInPodNestedExplicitInherit() pass", "originalCommit": "b36413b56896504cc7797adb913a43607fa2851b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNTYzNQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r390635635", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public static final String defaultInheritFrom = \"<default>\";\n          \n          \n            \n                    /** Only used for snippet generation. */\n          \n          \n            \n                    public static final String defaultInheritFrom = \"<default>\";", "author": "jglick", "createdAt": "2020-03-10T21:58:43Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -363,5 +409,10 @@ public boolean takesImplicitBlockArgument() {\n         public String getWorkingDir() {\n             return ContainerTemplate.DEFAULT_WORKING_DIR;\n         }\n+\n+        public static final Integer defaultInstanceCap = Integer.MAX_VALUE;\n+        public static final PodRetention defaultPodRetention = PodRetention.getPodTemplateDefault();\n+        public static final WorkspaceVolume defaultWorkspaceVolume = new EmptyDirWorkspaceVolume(false);\n+        public static final String defaultInheritFrom = \"<default>\";", "originalCommit": "b36413b56896504cc7797adb913a43607fa2851b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzY1OQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r390637659", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public static final WorkspaceVolume defaultWorkspaceVolume = new EmptyDirWorkspaceVolume(false);\n          \n          \n            \n                    public static final WorkspaceVolume defaultWorkspaceVolume = WorkspaceVolume getDefault();", "author": "jglick", "createdAt": "2020-03-10T22:03:59Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java", "diffHunk": "@@ -363,5 +409,10 @@ public boolean takesImplicitBlockArgument() {\n         public String getWorkingDir() {\n             return ContainerTemplate.DEFAULT_WORKING_DIR;\n         }\n+\n+        public static final Integer defaultInstanceCap = Integer.MAX_VALUE;\n+        public static final PodRetention defaultPodRetention = PodRetention.getPodTemplateDefault();\n+        public static final WorkspaceVolume defaultWorkspaceVolume = new EmptyDirWorkspaceVolume(false);", "originalCommit": "b36413b56896504cc7797adb913a43607fa2851b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODUwNw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r390638507", "bodyText": "Probably still incorrect as per #703 (comment).", "author": "jglick", "createdAt": "2020-03-10T22:06:11Z", "path": "src/main/resources/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep/config.jelly", "diffHunk": "@@ -87,7 +87,7 @@\n             <f:optionalBlock title=\"${%Use custom workspace volume}\" checked=\"${instance.workspaceVolume != null}\" inline=\"true\">", "originalCommit": "b36413b56896504cc7797adb913a43607fa2851b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI1MDM3OQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r391250379", "bodyText": "With the Descriptor default changed, that should make the config.jelly correct now.", "author": "kerogers-cloudbees", "createdAt": "2020-03-11T20:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYyODk2NQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r391628965", "bodyText": "Now that getWorkspaceVolume() no longer returns null, I'm not sure if this check is even necessary.", "author": "kerogers-cloudbees", "createdAt": "2020-03-12T13:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0Mzc4NA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/703#discussion_r391643784", "bodyText": "I think what ought to happen is that the form should be simplified to not use f:optionalBlock. The f:dropdownDescriptorSelector on its own, with a default, should suffice.", "author": "jglick", "createdAt": "2020-03-12T14:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODUwNw=="}], "type": "inlineReview"}, {"oid": "60442ae4aefc156f9fbab109869097560836c4c6", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/60442ae4aefc156f9fbab109869097560836c4c6", "message": "Merge branch 'master' into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-03-11T09:16:51Z", "type": "commit"}, {"oid": "cceb7ee605cd0ff773647b2eb4a372ef34fb1ae0", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/cceb7ee605cd0ff773647b2eb4a372ef34fb1ae0", "message": "Merge branch 'podTemplate-snippet-jenkins-57828-cplt2-6206' of github.com:kerogers-cloudbees/kubernetes-plugin into podTemplate-snippet-jenkins-57828-cplt2-6206", "committedDate": "2020-03-11T09:17:04Z", "type": "commit"}, {"oid": "4254f2c3f380228b031788678a01532b7a6c62ef", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4254f2c3f380228b031788678a01532b7a6c62ef", "message": "Update src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java\n\nCo-Authored-By: Jesse Glick <jglick@cloudbees.com>", "committedDate": "2020-03-11T19:22:04Z", "type": "commit"}, {"oid": "e346b9f854bf11c6df7406291016651a135de450", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/e346b9f854bf11c6df7406291016651a135de450", "message": "Update src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java\n\nCo-Authored-By: Jesse Glick <jglick@cloudbees.com>", "committedDate": "2020-03-11T19:22:15Z", "type": "commit"}, {"oid": "4774681e337b4d6047eaa96114c3a960417697d1", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4774681e337b4d6047eaa96114c3a960417697d1", "message": "Update src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStep.java\r\n\r\nrecommended change from review\n\nCo-Authored-By: Jesse Glick <jglick@cloudbees.com>", "committedDate": "2020-03-11T19:30:24Z", "type": "commit"}, {"oid": "03debcc97515c409094eb21688e80bca6cf40dc0", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/03debcc97515c409094eb21688e80bca6cf40dc0", "message": "Update src/main/webapp/help/inheritFrom.html\r\n\r\nrecommended change from review\n\nCo-Authored-By: Vincent Latombe <vincent@latombe.net>", "committedDate": "2020-03-11T19:31:06Z", "type": "commit"}, {"oid": "529e89b07afb05375d1589d0383145738ea3948a", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/529e89b07afb05375d1589d0383145738ea3948a", "message": "[CPLT2-6206] Clean up imports, fix a missing dot.", "committedDate": "2020-03-12T13:44:51Z", "type": "commit"}, {"oid": "877a1459db8250bd301daee68659b984100866b1", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/877a1459db8250bd301daee68659b984100866b1", "message": "[CPLT2-6206] Remove the checkbox that was hiding the WorkspaceVolume form. Removed attributes `oneEach`, `hasHeader`, `addCaption`, and `deleteCaption` as they don't seem to work with a `dropdownDescriptorSelector`", "committedDate": "2020-03-12T16:23:13Z", "type": "commit"}]}