{"pr_number": 15331, "pr_title": "Adds a service loader reference to CDIRuntimeImpl (which implements C\u2026", "pr_createdAt": "2020-12-16T23:19:19Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/15331", "timeline": [{"oid": "71686102ceedec8aa5a84e1c56a5b2a1562f5285", "url": "https://github.com/OpenLiberty/open-liberty/commit/71686102ceedec8aa5a84e1c56a5b2a1562f5285", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is nessacary because in a recent update CDI.java will clear the CDIProvider\nset in AbstractCDIRuntime.start() if CDIProvider.getCDI() ever returns null and\nlater attempt to reacquire it through the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-17T17:49:47Z", "type": "forcePushed"}, {"oid": "a955ffa0d36a9d71f58e0286b14d1b41f4e0c900", "url": "https://github.com/OpenLiberty/open-liberty/commit/a955ffa0d36a9d71f58e0286b14d1b41f4e0c900", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is nessacary because in a recent update CDI.java will clear the CDIProvider\nset in AbstractCDIRuntime.start() if CDIProvider.getCDI() ever returns null and\nlater attempt to reacquire it through the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-17T18:08:57Z", "type": "forcePushed"}, {"oid": "7a1ed5863170daa610cb933d7bfe9613b20b7ab7", "url": "https://github.com/OpenLiberty/open-liberty/commit/7a1ed5863170daa610cb933d7bfe9613b20b7ab7", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is nessacary because in a recent update CDI.java will clear the CDIProvider\nset in AbstractCDIRuntime.start() if CDIProvider.getCDI() ever returns null and\nlater attempt to reacquire it through the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-18T17:21:25Z", "type": "forcePushed"}, {"oid": "b6a507ae25850e7fd3a87d3ba86fc1116292fae7", "url": "https://github.com/OpenLiberty/open-liberty/commit/b6a507ae25850e7fd3a87d3ba86fc1116292fae7", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is nessacary because in a recent update CDI.java will clear the CDIProvider\nset in AbstractCDIRuntime.start() if CDIProvider.getCDI() ever returns null and\nlater attempt to reacquire it through the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T10:58:32Z", "type": "forcePushed"}, {"oid": "14ee5952a1c9cc93e8e1cbf2e1affeba79d3b707", "url": "https://github.com/OpenLiberty/open-liberty/commit/14ee5952a1c9cc93e8e1cbf2e1affeba79d3b707", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is nessacary because in a recent update CDI.java will clear the CDIProvider\nset in AbstractCDIRuntime.start() if CDIProvider.getCDI() ever returns null and\nlater attempt to reacquire it through the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:05:20Z", "type": "forcePushed"}, {"oid": "c4f74635d36555072eb7e4c99b40dc2d5805009b", "url": "https://github.com/OpenLiberty/open-liberty/commit/c4f74635d36555072eb7e4c99b40dc2d5805009b", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is nessacary because in a recent update CDI.java will clear the CDIProvider\nset in AbstractCDIRuntime.start() if CDIProvider.getCDI() ever returns null and\nlater attempt to reacquire it through the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:24:28Z", "type": "forcePushed"}, {"oid": "bedc07ddf93426106b614a7b37bc0b7a452d5195", "url": "https://github.com/OpenLiberty/open-liberty/commit/bedc07ddf93426106b614a7b37bc0b7a452d5195", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is nessacary because in a recent update CDI.java will clear the CDIProvider\nset in AbstractCDIRuntime.start() if CDIProvider.getCDI() ever returns null and\nlater attempt to reacquire it through the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:28:09Z", "type": "forcePushed"}, {"oid": "94961684a7131f0297de4e87f206d091bac793a2", "url": "https://github.com/OpenLiberty/open-liberty/commit/94961684a7131f0297de4e87f206d091bac793a2", "message": "fixup! Throw IllegalStateException when deployment cannot be found as required by spec", "committedDate": "2020-12-21T14:34:20Z", "type": "forcePushed"}, {"oid": "14d8eacc4023ff45bee4229ee1d5fb8cdc2feafc", "url": "https://github.com/OpenLiberty/open-liberty/commit/14d8eacc4023ff45bee4229ee1d5fb8cdc2feafc", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for https://github.com/eclipse-ee4j/cdi/issues/461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:35:52Z", "type": "forcePushed"}, {"oid": "440a81cca0e785c9fb02482231a55cedfefdb9c7", "url": "https://github.com/OpenLiberty/open-liberty/commit/440a81cca0e785c9fb02482231a55cedfefdb9c7", "message": "throw ISE as required by spec", "committedDate": "2020-12-21T14:37:06Z", "type": "commit"}, {"oid": "02eb1cf4486c2fb2da34f2230aa0d738842276f0", "url": "https://github.com/OpenLiberty/open-liberty/commit/02eb1cf4486c2fb2da34f2230aa0d738842276f0", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for https://github.com/eclipse-ee4j/cdi/issues/461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:37:07Z", "type": "forcePushed"}, {"oid": "dc4300789e76ab08d428b8a90bec1685f005b728", "url": "https://github.com/OpenLiberty/open-liberty/commit/dc4300789e76ab08d428b8a90bec1685f005b728", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:50:11Z", "type": "forcePushed"}, {"oid": "cec98b958f0105f819e2df1311c3efa133c3f7c5", "url": "https://github.com/OpenLiberty/open-liberty/commit/cec98b958f0105f819e2df1311c3efa133c3f7c5", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:51:55Z", "type": "forcePushed"}, {"oid": "79a6e31b827340701ff88b742f74419e85a13ea9", "url": "https://github.com/OpenLiberty/open-liberty/commit/79a6e31b827340701ff88b742f74419e85a13ea9", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T14:53:12Z", "type": "forcePushed"}, {"oid": "11e633964c294981fafece70a2e4c5effa55e183", "url": "https://github.com/OpenLiberty/open-liberty/commit/11e633964c294981fafece70a2e4c5effa55e183", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T15:30:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc5MjkyNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15331#discussion_r546792925", "bodyText": "I would strongly suggest not changing this for CDI 1.2 and 2.0 API bundles where it's not needed", "author": "Azquelt", "createdAt": "2020-12-21T16:09:44Z", "path": "dev/com.ibm.websphere.javaee.cdi.1.2/bnd.bnd", "diffHunk": "@@ -34,18 +34,19 @@ Import-Package:  javax.el; version=\"[3.0.0,4.0.0)\", \\\n  javax.enterprise.inject.spi;version=\"1.1\", \\\n  javax.enterprise.util;version=\"1.1\", \\\n  javax.inject;version=1, \\\n- javax.interceptor;version=\"1.2\"\n+ javax.interceptor;version=\"1.2\", \\\n+ com.ibm.ws.cdi.liberty\n \n Include-Resource: \\\n+  META-INF=resources/META-INF, \\\n   @${repo;javax.enterprise:cdi-api;1.2}!/beans_1_0.xsd, \\\n   @${repo;javax.enterprise:cdi-api;1.2}!/beans_1_1.xsd", "originalCommit": "11e633964c294981fafece70a2e4c5effa55e183", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc5NDQ1MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15331#discussion_r546794451", "bodyText": "This class does not need to be a Component as it's managed by ServiceLoader rather than as an OSGi service.\nThe Javadoc should also be improved to say it's a thin layer which looks up the real CDIProvider as an OSGi service.", "author": "Azquelt", "createdAt": "2020-12-21T16:12:38Z", "path": "dev/com.ibm.ws.cdi.weld/src/com/ibm/ws/cdi/liberty/CDIProviderService.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.cdi.liberty;\n+\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+import javax.enterprise.inject.spi.CDIProvider;\n+import javax.enterprise.inject.spi.CDI;\n+\n+import org.osgi.service.component.annotations.Component;\n+\n+import com.ibm.ejs.util.Util;\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.ws.cdi.CDIService;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.FrameworkUtil;\n+import org.osgi.framework.ServiceReference;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+import io.openliberty.cdi.spi.CDIExtensionMetadata;\n+\n+/**\n+ * This class is to get hold all necessary services.\n+ */\n+@Component(name = \"com.ibm.ws.cdi.liberty.CDIRuntimeImpl\", service = {CDIProvider.class}, property = { \"service.vendor=IBM\" })\n+public class CDIProviderService implements CDIProvider {", "originalCommit": "11e633964c294981fafece70a2e4c5effa55e183", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc5ODAyMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15331#discussion_r546798023", "bodyText": "This import is problematic.\nThere are cases where another feature might want to include the CDI API bundle, (or the CDI API feature) so that it can work with or without CDI present. I think this import will prevent the API bundle from resolving if the rest of CDI is not present.\nI think the easiest way to do this would be to:\n\nAdd CDIProvider to the list of services provided by the CDIRuntimeImpl component\nRemove all references to CDIRuntimeImpl and CDIService from CDIProviderService, just look up CDIProvider as a service instead\nMove CDIProviderService into the API bundle.\n\nIf we didn't want to add non-API things to the API bundle, you could\n\nPut the services file and CDIProviderService into a fragment which attaches to the API bundle\nThis would still require making the CDIRuntimeImpl component a CDIProvider service", "author": "Azquelt", "createdAt": "2020-12-21T16:19:00Z", "path": "dev/io.openliberty.jakarta.cdi.3.0/bnd.bnd", "diffHunk": "@@ -40,9 +40,11 @@ Import-Package:  jakarta.el; version=\"[4.0.0,5.0.0)\", \\\n  jakarta.enterprise.inject.spi.configurator; version=3.0, \\\n  jakarta.enterprise.util; version=3.0, \\\n  jakarta.inject; version=2.0, \\\n- jakarta.interceptor;version=2.0\n+ jakarta.interceptor;version=2.0, \\\n+ com.ibm.ws.cdi.liberty", "originalCommit": "11e633964c294981fafece70a2e4c5effa55e183", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d7f5fcc5f69ba7d0b19c18c2df21ed97cca76a16", "url": "https://github.com/OpenLiberty/open-liberty/commit/d7f5fcc5f69ba7d0b19c18c2df21ed97cca76a16", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T17:26:51Z", "type": "forcePushed"}, {"oid": "a6c267c6de4953f9cbd01319a3cb8f33d46d0476", "url": "https://github.com/OpenLiberty/open-liberty/commit/a6c267c6de4953f9cbd01319a3cb8f33d46d0476", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T17:28:34Z", "type": "forcePushed"}, {"oid": "f89f9f778422d6dbeb65edf8a91c77620a525e33", "url": "https://github.com/OpenLiberty/open-liberty/commit/f89f9f778422d6dbeb65edf8a91c77620a525e33", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T17:32:36Z", "type": "commit"}, {"oid": "f89f9f778422d6dbeb65edf8a91c77620a525e33", "url": "https://github.com/OpenLiberty/open-liberty/commit/f89f9f778422d6dbeb65edf8a91c77620a525e33", "message": "Adds a service loader reference to CDIRuntimeImpl (which implements CDIProvider)\n\nThis is a workaround for eclipse-ee4j/cdi#461. Because\nof that bug CDI.java will clear the CDIProvider set in AbstractCDIRuntime.start()\nif CDIProvider.getCDI() ever returns null and later attempt to reacquire it\nthrough the service loader.\n\nCDIProvider.getCDI() will return null if ever called from the context of a non\nCDI app", "committedDate": "2020-12-21T17:32:36Z", "type": "forcePushed"}]}