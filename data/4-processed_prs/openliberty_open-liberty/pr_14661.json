{"pr_number": 14661, "pr_title": "trusted header configuration improvements ", "pr_createdAt": "2020-10-22T20:49:42Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/14661", "timeline": [{"oid": "27da4f06619599036a46ebe9044f8d338cb848f4", "url": "https://github.com/OpenLiberty/open-liberty/commit/27da4f06619599036a46ebe9044f8d338cb848f4", "message": "keep existing public method names", "committedDate": "2020-11-04T21:26:13Z", "type": "forcePushed"}, {"oid": "31ce26a0291417064185682e75098786bf384f39", "url": "https://github.com/OpenLiberty/open-liberty/commit/31ce26a0291417064185682e75098786bf384f39", "message": "refactor to use chfw FilterList utilities", "committedDate": "2020-12-02T22:00:48Z", "type": "forcePushed"}, {"oid": "95201f2b33d455fa994a66f1488538baad269f88", "url": "https://github.com/OpenLiberty/open-liberty/commit/95201f2b33d455fa994a66f1488538baad269f88", "message": "refactor to use chfw FilterList utilities", "committedDate": "2020-12-02T23:42:57Z", "type": "forcePushed"}, {"oid": "9b26213e1f742ce7bec05cc2f1abec173a9677f5", "url": "https://github.com/OpenLiberty/open-liberty/commit/9b26213e1f742ce7bec05cc2f1abec173a9677f5", "message": "refactor to use cfw FilterList objects", "committedDate": "2020-12-03T16:32:33Z", "type": "forcePushed"}, {"oid": "a43f0b89d47115262f4167a5256cf5103053c67e", "url": "https://github.com/OpenLiberty/open-liberty/commit/a43f0b89d47115262f4167a5256cf5103053c67e", "message": "refactor to use cfw FilterList objects", "committedDate": "2020-12-03T19:48:55Z", "type": "forcePushed"}, {"oid": "862d3565b658a548611c784a54f1508e337241dd", "url": "https://github.com/OpenLiberty/open-liberty/commit/862d3565b658a548611c784a54f1508e337241dd", "message": "refactor to use cfw FilterList objects", "committedDate": "2020-12-03T20:02:01Z", "type": "forcePushed"}, {"oid": "303e649296e5374b671b87d8afde907a10bb864d", "url": "https://github.com/OpenLiberty/open-liberty/commit/303e649296e5374b671b87d8afde907a10bb864d", "message": "refactor to use cfw FilterList objects", "committedDate": "2020-12-03T20:04:32Z", "type": "forcePushed"}, {"oid": "7f9abc2b56e0b62437afd7464f0ca77cb5af2f51", "url": "https://github.com/OpenLiberty/open-liberty/commit/7f9abc2b56e0b62437afd7464f0ca77cb5af2f51", "message": "refactor to use cfw FilterList objects", "committedDate": "2020-12-03T20:07:40Z", "type": "forcePushed"}, {"oid": "a90a8b81136e1b8ecb089d4f60d3c1ae66b9316c", "url": "https://github.com/OpenLiberty/open-liberty/commit/a90a8b81136e1b8ecb089d4f60d3c1ae66b9316c", "message": "update metatype and add messages for trustedHeaderOrigin update", "committedDate": "2020-12-11T17:40:07Z", "type": "forcePushed"}, {"oid": "268d72cc13e456bd5bfaf557a15b59dc8293c3d5", "url": "https://github.com/OpenLiberty/open-liberty/commit/268d72cc13e456bd5bfaf557a15b59dc8293c3d5", "message": "update unittests", "committedDate": "2020-12-14T15:05:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMDg2NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r543700864", "bodyText": "Will 'trusted' be true if remoteAddr==null? Otherwise this line might potentially NPE since remoteAddr may not have been initialized in lines 2181-2182.", "author": "mrsaldana", "createdAt": "2020-12-15T21:31:30Z", "path": "dev/com.ibm.ws.transport.http/src/com/ibm/ws/http/channel/internal/HttpRequestMessageImpl.java", "diffHunk": "@@ -2178,16 +2178,15 @@ protected boolean filterAdd(HeaderKeys key, byte[] value) {\n     private boolean isPrivateHeaderTrusted(HeaderKeys key) {\n         HttpServiceContextImpl hisc = getServiceContext();\n         InetAddress remoteAddr = null;\n-        String address = null;\n-        if (hisc != null && (remoteAddr = hisc.getRemoteAddr()) != null) {\n-            address = remoteAddr.getHostAddress();\n+        if (hisc != null) {\n+            remoteAddr = hisc.getRemoteAddr();\n         }\n \n-        boolean trusted = HttpDispatcher.usePrivateHeaders(address, key.getName());\n+        boolean trusted = HttpDispatcher.usePrivateHeaders(remoteAddr, key.getName());\n \n         if (!trusted) {\n             if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n-                Tr.debug(tc, \"isPrivateHeaderTrusted: \" + key.getName() + \" is not trusted for host \" + address);\n+                Tr.debug(tc, \"isPrivateHeaderTrusted: \" + key.getName() + \" is not trusted for host \" + remoteAddr.getHostAddress());", "originalCommit": "268d72cc13e456bd5bfaf557a15b59dc8293c3d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6172cd5570c3f0cb175f57db2b3b51b6c444408b", "url": "https://github.com/OpenLiberty/open-liberty/commit/6172cd5570c3f0cb175f57db2b3b51b6c444408b", "message": "code review comments", "committedDate": "2020-12-16T21:33:13Z", "type": "forcePushed"}, {"oid": "68e04a5baa0535338d12997a43a5002bfc2b800c", "url": "https://github.com/OpenLiberty/open-liberty/commit/68e04a5baa0535338d12997a43a5002bfc2b800c", "message": "code review updates: restore public APIs, add unittests", "committedDate": "2020-12-17T18:55:15Z", "type": "forcePushed"}, {"oid": "2f43eaf8bc6ddecd35725caa78d36119dafefd1a", "url": "https://github.com/OpenLiberty/open-liberty/commit/2f43eaf8bc6ddecd35725caa78d36119dafefd1a", "message": "support hostnames and wildcards for trusted*HeaderOrigin", "committedDate": "2021-01-05T17:11:54Z", "type": "commit"}, {"oid": "03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "url": "https://github.com/OpenLiberty/open-liberty/commit/03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "message": "update metatype and add messages for trustedHeaderOrigin update", "committedDate": "2021-01-05T17:11:54Z", "type": "commit"}, {"oid": "8f21ee237dad9aeb1a897e73d3bc7ef98aacb448", "url": "https://github.com/OpenLiberty/open-liberty/commit/8f21ee237dad9aeb1a897e73d3bc7ef98aacb448", "message": "update unittests", "committedDate": "2021-01-05T17:11:54Z", "type": "commit"}, {"oid": "a218e0b2ec487979079fe4d372cf47922f5e6981", "url": "https://github.com/OpenLiberty/open-liberty/commit/a218e0b2ec487979079fe4d372cf47922f5e6981", "message": "code review updates: restore public APIs, add unittests", "committedDate": "2021-01-05T17:11:55Z", "type": "commit"}, {"oid": "a218e0b2ec487979079fe4d372cf47922f5e6981", "url": "https://github.com/OpenLiberty/open-liberty/commit/a218e0b2ec487979079fe4d372cf47922f5e6981", "message": "code review updates: restore public APIs, add unittests", "committedDate": "2021-01-05T17:11:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwOTIzMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552109232", "bodyText": "suggested edit:\nThe web server plug-in uses private headers  to provide information about the original request. These headers take precedence over the HTTP host header and are used to select a virtual host to service a request. The default value is '', which trusts incoming private headers from any source. To disable private headers and rely only on the http Host header, specify 'none'. To restrict private header processing to specific trusted sources, specify a comma-separated list of IP addresses and hostnames. This list supports '' wildcards, with the following restrictions: IP addresses cannot be shortened and must contain a value for each field, for example \"127.0.0.\" or \"0:0:0:0:0:ffff::\", and hostnames must start with \".\", for example \".ibm.com\". The following example shows a valid list that includes wildcards: \"localhost, 127.0.0.1, 192.168.., 0:0:0:0:0:ffff::*, *.ibm.com\".", "author": "dmuelle", "createdAt": "2021-01-05T18:17:49Z", "path": "dev/com.ibm.ws.transport.http/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -174,16 +174,22 @@ http.dispatcher=HTTP Dispatcher\n http.dispatcher.desc=HTTP Dispatcher configuration.\n \n dispatcher.trustedHeaderOrigin=Trusted private header origin\n-dispatcher.trustedHeaderOrigin.desc=Private headers are used by the web server plug-in to provide information about the original \\\n- request. These headers take precedence over the http Host header, and are used to select a virtual host to service a request. The \\\n- default value is '*', which will trust incoming private headers from any source. Specify 'none' to disable private headers and rely \\\n- only on the http Host header, or specify a list of IP addresses to restrict private header processing to specific trusted sources.\n+dispatcher.trustedHeaderOrigin.desc=Private headers are used by the web server plug-in to provide information about the original request. \\", "originalCommit": "03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNjYzMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552116632", "bodyText": "asterisks are rendering text as italic due to markdown- ignore italics and insert asterisk as needed. Can probably copy the raw text from the editor view", "author": "dmuelle", "createdAt": "2021-01-05T18:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwOTIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExMjAxMQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552112011", "bodyText": "suggested edit:\nThe web server plug-in uses private headers to provide information about the original request. A subset of these headers is considered sensitive. By default, the value for this property is 'none'. Incoming sensitive private headers are not trusted from any source. To allow sensitive private header processing for specific trusted sources, specify a comma-separated list of IP addresses and hostnames. To trust incoming sensitive private headers from any source, specify ''. This list supports '' wildcards, with the following restrictions: IP addresses cannot be shortened and must contain a value for each field, for example \"127.0.0.\" or \"0:0:0:0:0:ffff::\", and hostnames must start with \".\", for example \".ibm.com\". The following example shows a valid list that includes wildcards: \"localhost, 127.0.0.1, 192.168.., 0:0:0:0:0:ffff::*, *.ibm.com\".", "author": "dmuelle", "createdAt": "2021-01-05T18:23:25Z", "path": "dev/com.ibm.ws.transport.http/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -174,16 +174,22 @@ http.dispatcher=HTTP Dispatcher\n http.dispatcher.desc=HTTP Dispatcher configuration.\n \n dispatcher.trustedHeaderOrigin=Trusted private header origin\n-dispatcher.trustedHeaderOrigin.desc=Private headers are used by the web server plug-in to provide information about the original \\\n- request. These headers take precedence over the http Host header, and are used to select a virtual host to service a request. The \\\n- default value is '*', which will trust incoming private headers from any source. Specify 'none' to disable private headers and rely \\\n- only on the http Host header, or specify a list of IP addresses to restrict private header processing to specific trusted sources.\n+dispatcher.trustedHeaderOrigin.desc=Private headers are used by the web server plug-in to provide information about the original request. \\\n+ These headers take precedence over the HTTP Host header, and are used to select a virtual host to service a request. The default value is \\\n+ '*', which will trust incoming private headers from any source. Specify 'none' to disable private headers and rely only on the http Host \\\n+ header, or specify a comma-separated list of IP addresses and hostnames to restrict private header processing to specific trusted sources. \\\n+ This list supports '*' wildcards in the following formats: IP addresses cannot be shortened and must contain a value for each field, eg. \\\n+ \"127.0.0.*\" or \"0:0:0:0:0:ffff:*:*\", and hostnames must start with \"*.\", eg. \"*.ibm.com\". As an example, the following list is valid: \\\n+ \"localhost, 127.0.0.1, 192.168.*.*, 0:0:0:0:0:ffff:*:*, *.ibm.com\".\n \n dispatcher.trustedSensitiveHeaderOrigin=Trusted sensitive private header origin\n dispatcher.trustedSensitiveHeaderOrigin.desc=Private headers are used by the web server plug-in to provide information about the original \\", "originalCommit": "03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExMjc0Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552112747", "bodyText": "change\nThe configured trustedHeaderOrigin value [{0}] is invalid and will not be used.\nto\nThe [{0}] configured trustedHeaderOrigin value is invalid and cannot be used.", "author": "dmuelle", "createdAt": "2021-01-05T18:24:46Z", "path": "dev/com.ibm.ws.transport.http/resources/com/ibm/ws/http/channel/internal/resources/httpchannelmessages.nlsprops", "diffHunk": "@@ -177,3 +177,11 @@ cookies.samesite.unsupportedWildcard.useraction=Ensure that only a single wildca\n cookies.samesite.knownDuplicateName=CWWKT0037W: A cookie name or pattern [{0}], which is marked as a duplicate, was found in the SameSite [{1}] configuration. The [{0}] cookie name or pattern is ignored. Any cookie name or pattern that is defined by the lax, none, and strict configurations can be defined in only one of the three configurations.\n cookies.samesite.knownDuplicateName.explanation=The specified value was already found by the configuration and mapped to a SameSite value.\n cookies.samesite.knownDuplicateName.useraction=Ensure that cookie names and patterns are unique across the lax, none, and strict configuration lists.\n+\n+trusted.header.origin.invalid.value=CWWKT0038W: The configured trustedHeaderOrigin value [{0}] is invalid and will not be used.", "originalCommit": "03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExMzQ2NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552113464", "bodyText": "change\nThe specified value is not a full IP address or correctly formatted hostname.\nto\nThe specified value must be either a full IP address or correctly formatted hostname.", "author": "dmuelle", "createdAt": "2021-01-05T18:26:09Z", "path": "dev/com.ibm.ws.transport.http/resources/com/ibm/ws/http/channel/internal/resources/httpchannelmessages.nlsprops", "diffHunk": "@@ -177,3 +177,11 @@ cookies.samesite.unsupportedWildcard.useraction=Ensure that only a single wildca\n cookies.samesite.knownDuplicateName=CWWKT0037W: A cookie name or pattern [{0}], which is marked as a duplicate, was found in the SameSite [{1}] configuration. The [{0}] cookie name or pattern is ignored. Any cookie name or pattern that is defined by the lax, none, and strict configurations can be defined in only one of the three configurations.\n cookies.samesite.knownDuplicateName.explanation=The specified value was already found by the configuration and mapped to a SameSite value.\n cookies.samesite.knownDuplicateName.useraction=Ensure that cookie names and patterns are unique across the lax, none, and strict configuration lists.\n+\n+trusted.header.origin.invalid.value=CWWKT0038W: The configured trustedHeaderOrigin value [{0}] is invalid and will not be used.\n+trusted.header.origin.invalid.value.explanation=The specified value is not a full IP address or correctly formatted hostname.", "originalCommit": "03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNDQzMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552114432", "bodyText": "will the user know what characters are invalid for hostnames? Is it according to general protocols or specific to this config?", "author": "dmuelle", "createdAt": "2021-01-05T18:28:02Z", "path": "dev/com.ibm.ws.transport.http/resources/com/ibm/ws/http/channel/internal/resources/httpchannelmessages.nlsprops", "diffHunk": "@@ -177,3 +177,11 @@ cookies.samesite.unsupportedWildcard.useraction=Ensure that only a single wildca\n cookies.samesite.knownDuplicateName=CWWKT0037W: A cookie name or pattern [{0}], which is marked as a duplicate, was found in the SameSite [{1}] configuration. The [{0}] cookie name or pattern is ignored. Any cookie name or pattern that is defined by the lax, none, and strict configurations can be defined in only one of the three configurations.\n cookies.samesite.knownDuplicateName.explanation=The specified value was already found by the configuration and mapped to a SameSite value.\n cookies.samesite.knownDuplicateName.useraction=Ensure that cookie names and patterns are unique across the lax, none, and strict configuration lists.\n+\n+trusted.header.origin.invalid.value=CWWKT0038W: The configured trustedHeaderOrigin value [{0}] is invalid and will not be used.\n+trusted.header.origin.invalid.value.explanation=The specified value is not a full IP address or correctly formatted hostname.\n+trusted.header.origin.invalid.value.useraction=Ensure that configured IP addresses contain a value for each segment, and that hostnames do not contain any invalid characters.", "originalCommit": "03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE2MzA5Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552163096", "bodyText": "This prop adheres to the common hostname format defined in RFC 123, and IMO it's pretty well understood what characters are valid for a hostname, so I think it's fine to leave the message as-is", "author": "wtlucy", "createdAt": "2021-01-05T20:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNDQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExNDg1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14661#discussion_r552114854", "bodyText": "see comments for CWWKT0038W", "author": "dmuelle", "createdAt": "2021-01-05T18:28:44Z", "path": "dev/com.ibm.ws.transport.http/resources/com/ibm/ws/http/channel/internal/resources/httpchannelmessages.nlsprops", "diffHunk": "@@ -177,3 +177,11 @@ cookies.samesite.unsupportedWildcard.useraction=Ensure that only a single wildca\n cookies.samesite.knownDuplicateName=CWWKT0037W: A cookie name or pattern [{0}], which is marked as a duplicate, was found in the SameSite [{1}] configuration. The [{0}] cookie name or pattern is ignored. Any cookie name or pattern that is defined by the lax, none, and strict configurations can be defined in only one of the three configurations.\n cookies.samesite.knownDuplicateName.explanation=The specified value was already found by the configuration and mapped to a SameSite value.\n cookies.samesite.knownDuplicateName.useraction=Ensure that cookie names and patterns are unique across the lax, none, and strict configuration lists.\n+\n+trusted.header.origin.invalid.value=CWWKT0038W: The configured trustedHeaderOrigin value [{0}] is invalid and will not be used.\n+trusted.header.origin.invalid.value.explanation=The specified value is not a full IP address or correctly formatted hostname.\n+trusted.header.origin.invalid.value.useraction=Ensure that configured IP addresses contain a value for each segment, and that hostnames do not contain any invalid characters.\n+\n+trusted.sensitive.header.origin.invalid.value=CWWKT0039W: The configured trustedSensitiveHeaderOrigin value [{0}] is invalid and will not be used.", "originalCommit": "03e81d4ad1edf9ad75bc80891441f9c7e597acd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77d8f36dc18cf1a41efb311e1fd13b694d0a5406", "url": "https://github.com/OpenLiberty/open-liberty/commit/77d8f36dc18cf1a41efb311e1fd13b694d0a5406", "message": "message review comments", "committedDate": "2021-01-05T19:57:16Z", "type": "commit"}, {"oid": "c326647fc09204f90ec477013d9bff97aba94f21", "url": "https://github.com/OpenLiberty/open-liberty/commit/c326647fc09204f90ec477013d9bff97aba94f21", "message": "minor logging and readability improvements", "committedDate": "2021-01-10T14:34:56Z", "type": "commit"}]}