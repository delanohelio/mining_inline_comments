{"pr_number": 13775, "pr_title": "gRPC headersToPropagate FAT tests", "pr_createdAt": "2020-09-02T18:46:40Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13775", "timeline": [{"oid": "c716ac7eba28e50afd4e2ce858b122918f97cc8c", "url": "https://github.com/OpenLiberty/open-liberty/commit/c716ac7eba28e50afd4e2ce858b122918f97cc8c", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-02T18:47:48Z", "type": "forcePushed"}, {"oid": "10f420630ba239a7428dc461bb2d100f8462f6a8", "url": "https://github.com/OpenLiberty/open-liberty/commit/10f420630ba239a7428dc461bb2d100f8462f6a8", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-02T18:49:34Z", "type": "forcePushed"}, {"oid": "6c62eea0c8b14861c516634a2bc680ce27de5e37", "url": "https://github.com/OpenLiberty/open-liberty/commit/6c62eea0c8b14861c516634a2bc680ce27de5e37", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-02T21:44:15Z", "type": "forcePushed"}, {"oid": "a3a26c64aef898a4f02e38c7aad149d6be421f0f", "url": "https://github.com/OpenLiberty/open-liberty/commit/a3a26c64aef898a4f02e38c7aad149d6be421f0f", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-10T18:14:03Z", "type": "forcePushed"}, {"oid": "b876a5484cd6982aaca8721607141be9ba8cb423", "url": "https://github.com/OpenLiberty/open-liberty/commit/b876a5484cd6982aaca8721607141be9ba8cb423", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-10T18:16:11Z", "type": "forcePushed"}, {"oid": "254f08b73b76a599801850954d5004a6d32024d6", "url": "https://github.com/OpenLiberty/open-liberty/commit/254f08b73b76a599801850954d5004a6d32024d6", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-11T13:50:13Z", "type": "forcePushed"}, {"oid": "cd1b747c56f72e7ffb17ae7303c2c04992b95ea8", "url": "https://github.com/OpenLiberty/open-liberty/commit/cd1b747c56f72e7ffb17ae7303c2c04992b95ea8", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-11T17:22:06Z", "type": "forcePushed"}, {"oid": "3b9d9f6a48ffb9cfd3f3846dcdba59706b7a373a", "url": "https://github.com/OpenLiberty/open-liberty/commit/3b9d9f6a48ffb9cfd3f3846dcdba59706b7a373a", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-11T20:01:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI4MTYwOA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13775#discussion_r487281608", "bodyText": "There's a commong setServerconfig now in the grpcUtils class for all the tests to use.", "author": "loriadi", "createdAt": "2020-09-11T20:43:40Z", "path": "dev/com.ibm.ws.grpc_fat/fat/src/com/ibm/ws/fat/grpc/ClientHeaderPropagationTests.java", "diffHunk": "@@ -0,0 +1,319 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.fat.grpc;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import java.net.URL;\n+import java.util.Collections;\n+import java.util.Set;\n+import java.util.logging.Logger;\n+\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TestName;\n+import org.junit.runner.RunWith;\n+\n+import com.gargoylesoftware.htmlunit.WebClient;\n+import com.gargoylesoftware.htmlunit.html.HtmlForm;\n+import com.gargoylesoftware.htmlunit.html.HtmlPage;\n+import com.gargoylesoftware.htmlunit.html.HtmlSubmitInput;\n+import com.gargoylesoftware.htmlunit.html.HtmlTextInput;\n+import com.ibm.websphere.simplicity.ShrinkHelper;\n+import com.ibm.websphere.simplicity.log.Log;\n+\n+import componenttest.annotation.Server;\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.utils.FATServletClient;\n+\n+/**\n+ * the flow should look like this:\n+ * 1. set <grpcTarget target=\"match\" headersToPropagate=\"testHeader\"/>\n+ * 2. make a request to some servlet like HelloWorldClientServlet which will do some\n+ * outbound grpc call. Make sure to set a header testHeader=testValue on this initial request.\n+ * 3. verify that testHeader is included with the grpc request that\u2019s made to the\n+ * test grpc service. The easiest way to do this will be to create a server interceptor\n+ * that implements interceptCall(), which will give you easy access to the metadata (headers)\n+ */\n+@RunWith(FATRunner.class)\n+@Mode(TestMode.FULL)\n+public class ClientHeaderPropagationTests extends FATServletClient {\n+\n+    protected static final Class<?> c = ClientHeaderPropagationTests.class;\n+    private static final Logger LOG = Logger.getLogger(c.getName());\n+    private static final Set<String> appName = Collections.singleton(\"HelloWorldClient\");\n+    private static final Set<String> appName_srv = Collections.singleton(\"HelloWorldService\");\n+    private static final String DEFAULT_CONFIG_FILE = \"grpc.server.xml\";\n+    private static final String GRPCTARGET_HTP_MATCH = \"grpc.client.htp.match.server.xml\";\n+    private static final String GRPCTARGET_HTP_MULTIMATCH = \"grpc.client.htp.multimatch.server.xml\";\n+    private static final String GRPCTARGET_HTP_NOMATCH = \"grpc.client.htp.nomatch.server.xml\";\n+    private static String serverConfigurationFile = DEFAULT_CONFIG_FILE;\n+    private static final int SHORT_TIMEOUT = 500; // .5 seconds\n+\n+    @Server(\"GrpcServer\")\n+    public static LibertyServer GrpcServer;\n+\n+    @BeforeClass\n+    public static void setUp() throws Exception {\n+        LOG.info(\"ClientHeaderPropagationTests : setUp() : add HelloWorldClient and HelloWorldService apps to the server\");\n+        ShrinkHelper.defaultDropinApp(GrpcServer, \"HelloWorldClient.war\",\n+                                      \"com.ibm.ws.grpc.fat.helloworld.client\",\n+                                      \"io.grpc.examples.helloworld\");\n+\n+        // Drop in the server app, same server\n+        ShrinkHelper.defaultDropinApp(GrpcServer, \"HelloWorldService.war\",\n+                                      \"com.ibm.ws.grpc.fat.helloworld.service\",\n+                                      \"io.grpc.examples.helloworld\");\n+\n+        LOG.info(\"ClientHeaderPropagationTests : setUp() : start the grpc server\");\n+        GrpcServer.startServer(ClientHeaderPropagationTests.class.getSimpleName() + \".server.log\");\n+    }\n+\n+    @Rule\n+    public TestName name = new TestName();\n+\n+    @AfterClass\n+    public static void tearDown() throws Exception {\n+        // Stop the server\n+        if (GrpcServer != null && GrpcServer.isStarted()) {\n+            GrpcServer.stopServer();\n+        }\n+    }\n+\n+    /**\n+     * test no match in headersToPropagate\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testNoHeaderMatches() throws Exception {\n+        LOG.info(\"ClientHeaderPropagationTests : testNoHeaderMatches() : test no match in headersToPropagate.\");\n+\n+        // First set a config with a <grpcTarget> that wouldn't match a header\n+        setServerConfiguration(GrpcServer, GRPCTARGET_HTP_NOMATCH);\n+        GrpcServer.waitForConfigUpdateInLogUsingMark(appName_srv);\n+\n+        String contextRoot = \"HelloWorldClient\";\n+        try (WebClient webClient = new WebClient()) {\n+\n+            // Construct the URL for the test\n+            URL url = GrpcTestUtils.createHttpUrl(GrpcServer, contextRoot, \"grpcClient\");\n+            HtmlPage page = (HtmlPage) webClient.getPage(url);\n+\n+            webClient.addRequestHeader(\"testHeader\", \"123\");\n+\n+            // Log the page for debugging if necessary in the future.\n+            Log.info(c, name.getMethodName(), page.asText());\n+            Log.info(c, name.getMethodName(), page.asXml());\n+\n+            assertTrue(\"the servlet was not loaded correctly\",\n+                       page.asText().contains(\"gRPC helloworld client example\"));\n+\n+            HtmlForm form = page.getFormByName(\"form1\");\n+\n+            // set a name in the form, which we'll expect the RPC to return\n+            HtmlTextInput inputText = (HtmlTextInput) form.getInputByName(\"user\");\n+            inputText.setValueAttribute(\"us3r1\");\n+\n+            // set the port of the grpcserver in the form\n+            HtmlTextInput inputPort = (HtmlTextInput) form.getInputByName(\"port\");\n+            inputPort.setValueAttribute(String.valueOf(GrpcServer.getHttpDefaultPort()));\n+\n+            // set the hostname of the gprcserver in the form\n+            HtmlTextInput inputHost = (HtmlTextInput) form.getInputByName(\"address\");\n+            inputHost.setValueAttribute(GrpcServer.getHostname());\n+\n+            // submit to the grpcClient, and execute the RPC\n+            HtmlSubmitInput submitButton = form.getInputByName(\"submit\");\n+            page = submitButton.click();\n+\n+            // Log the page for debugging if necessary in the future.\n+            Log.info(c, name.getMethodName(), page.asText());\n+            assertTrue(\"the gRPC request did not complete correctly\", page.asText().contains(\"us3r1\"));\n+\n+            //Make sure the Interceptor was called to verify match\n+            String interceptorHasRun = GrpcServer.waitForStringInLog(\"com.ibm.ws.grpc.fat.helloworld.service.HelloWorldServerInterceptor3 has been invoked!\",\n+                                                                     SHORT_TIMEOUT);\n+            if (interceptorHasRun == null) {\n+                Assert.fail(c + \": server.xml with <grpcTarget> element: no interceptor ran when it should have in \" + SHORT_TIMEOUT + \"ms\");\n+            }\n+\n+            //Make sure the testHeader is not displayed by the Interceptor\n+            String headerFound = GrpcServer.verifyStringNotInLogUsingMark(\"testHeader=123\", SHORT_TIMEOUT);\n+            if (headerFound != null) {\n+                Assert.fail(c + \": testHeader found in nomatch case when it should not have\");\n+            }\n+        }\n+    }\n+\n+    /**\n+     * test a single match in headersToPropagate\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testSingleHeaderMatch() throws Exception {\n+        LOG.info(\"ClientHeaderPropagationTests : testSingleHeaderMatch() : test a single match in headersToPropagate.\");\n+\n+        // First set a config with a <grpcTarget> that matches a header\n+        setServerConfiguration(GrpcServer, GRPCTARGET_HTP_MATCH);\n+        GrpcServer.waitForConfigUpdateInLogUsingMark(appName);\n+\n+        String contextRoot = \"HelloWorldClient\";\n+        try (WebClient webClient = new WebClient()) {\n+\n+            // Construct the URL for the test\n+            URL url = GrpcTestUtils.createHttpUrl(GrpcServer, contextRoot, \"grpcClient\");\n+            HtmlPage page = (HtmlPage) webClient.getPage(url);\n+\n+            webClient.addRequestHeader(\"testHeader\", \"123\");\n+\n+            // Log the page for debugging if necessary in the future.\n+            Log.info(c, name.getMethodName(), page.asText());\n+            Log.info(c, name.getMethodName(), page.asXml());\n+\n+            assertTrue(\"the servlet was not loaded correctly\",\n+                       page.asText().contains(\"gRPC helloworld client example\"));\n+\n+            HtmlForm form = page.getFormByName(\"form1\");\n+\n+            // set a name in the form, which we'll expect the RPC to return\n+            HtmlTextInput inputText = (HtmlTextInput) form.getInputByName(\"user\");\n+            inputText.setValueAttribute(\"us3r1\");\n+\n+            // set the port of the grpcserver in the form\n+            HtmlTextInput inputPort = (HtmlTextInput) form.getInputByName(\"port\");\n+            inputPort.setValueAttribute(String.valueOf(GrpcServer.getHttpDefaultPort()));\n+\n+            // set the hostname of the gprcserver in the form\n+            HtmlTextInput inputHost = (HtmlTextInput) form.getInputByName(\"address\");\n+            inputHost.setValueAttribute(GrpcServer.getHostname());\n+\n+            // submit to the grpcClient, and execute the RPC\n+            HtmlSubmitInput submitButton = form.getInputByName(\"submit\");\n+            page = submitButton.click();\n+\n+            // Log the page for debugging if necessary in the future.\n+            Log.info(c, name.getMethodName(), page.asText());\n+            assertTrue(\"the gRPC request did not complete correctly\", page.asText().contains(\"us3r1\"));\n+\n+            //Make sure the Interceptor was called to verify match\n+            String interceptorHasRun = GrpcServer.waitForStringInLog(\"com.ibm.ws.grpc.fat.helloworld.service.HelloWorldServerInterceptor3 has been invoked!\",\n+                                                                     SHORT_TIMEOUT);\n+            if (interceptorHasRun == null) {\n+                Assert.fail(c + \": server.xml with <grpcTarget> element: no interceptor ran when it should have in \" + SHORT_TIMEOUT + \"ms\");\n+            }\n+\n+            // make sure expected header was found\n+            String headerFound = GrpcServer.waitForStringInLog(\"testHeader=123\", SHORT_TIMEOUT);\n+            if (headerFound == null) {\n+                Assert.fail(c + \": testHeader=123 not found when it should have in \" + SHORT_TIMEOUT + \"ms\");\n+            }\n+        }\n+    }\n+\n+    /**\n+     * test multiple matches in headersToPropagate\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testMultipleHeaderMatches() throws Exception {\n+        LOG.info(\"ClientHeaderPropagationTests : testMultipleHeaderMatches() : test multiple matches in headersToPropagate.\");\n+\n+        // First set a config with a <grpcTarget> that matches a header\n+        setServerConfiguration(GrpcServer, GRPCTARGET_HTP_MULTIMATCH);\n+        GrpcServer.waitForConfigUpdateInLogUsingMark(appName);\n+\n+        String contextRoot = \"HelloWorldClient\";\n+        try (WebClient webClient = new WebClient()) {\n+\n+            // Construct the URL for the test\n+            URL url = GrpcTestUtils.createHttpUrl(GrpcServer, contextRoot, \"grpcClient\");\n+            HtmlPage page = (HtmlPage) webClient.getPage(url);\n+\n+            webClient.addRequestHeader(\"testHeader\", \"123\");\n+            webClient.addRequestHeader(\"testHeader1\", \"456\");\n+            webClient.addRequestHeader(\"testHeader2\", \"789\");\n+\n+            // Log the page for debugging if necessary in the future.\n+            Log.info(c, name.getMethodName(), page.asText());\n+            Log.info(c, name.getMethodName(), page.asXml());\n+\n+            assertTrue(\"the servlet was not loaded correctly\",\n+                       page.asText().contains(\"gRPC helloworld client example\"));\n+\n+            HtmlForm form = page.getFormByName(\"form1\");\n+\n+            // set a name in the form, which we'll expect the RPC to return\n+            HtmlTextInput inputText = (HtmlTextInput) form.getInputByName(\"user\");\n+            inputText.setValueAttribute(\"us3r1\");\n+\n+            // set the port of the grpcserver in the form\n+            HtmlTextInput inputPort = (HtmlTextInput) form.getInputByName(\"port\");\n+            inputPort.setValueAttribute(String.valueOf(GrpcServer.getHttpDefaultPort()));\n+\n+            // set the hostname of the gprcserver in the form\n+            HtmlTextInput inputHost = (HtmlTextInput) form.getInputByName(\"address\");\n+            inputHost.setValueAttribute(GrpcServer.getHostname());\n+\n+            // submit to the grpcClient, and execute the RPC\n+            HtmlSubmitInput submitButton = form.getInputByName(\"submit\");\n+            page = submitButton.click();\n+\n+            // Log the page for debugging if necessary in the future.\n+            Log.info(c, name.getMethodName(), page.asText());\n+            assertTrue(\"the gRPC request did not complete correctly\", page.asText().contains(\"us3r1\"));\n+\n+            //Make sure the Interceptor was called to verify match\n+            String interceptorHasRun = GrpcServer.waitForStringInLog(\"com.ibm.ws.grpc.fat.helloworld.service.HelloWorldServerInterceptor3 has been invoked!\",\n+                                                                     SHORT_TIMEOUT);\n+            if (interceptorHasRun == null) {\n+                Assert.fail(c + \": server.xml with <grpcTarget> element: no interceptor ran when it should have in \" + SHORT_TIMEOUT + \"ms\");\n+            }\n+\n+            // make sure expected headers were found\n+            String headerFound = GrpcServer.waitForStringInLog(\"testHeader1=456,testHeader2=789\", SHORT_TIMEOUT);\n+            if (headerFound == null) {\n+                Assert.fail(c + \": testHeader1 or testHeader2 not found when it should have in \" + SHORT_TIMEOUT + \"ms\");\n+            }\n+            //Make sure the testHeader is not displayed by the Interceptor\n+            headerFound = GrpcServer.verifyStringNotInLogUsingMark(\"testHeader=123\", SHORT_TIMEOUT);\n+            if (headerFound != null) {\n+                Assert.fail(c + \": testHeader found when it should not have\");\n+            }\n+        }\n+    }\n+\n+    /**\n+     * This method is used to set the server.xml\n+     *\n+     * @throws Exception\n+     */\n+    private static void setServerConfiguration(LibertyServer server,", "originalCommit": "3b9d9f6a48ffb9cfd3f3846dcdba59706b7a373a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU4NDk2NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13775#discussion_r487584964", "bodyText": "change to use GrpcTestUtils.setServerConfiguration", "author": "epj", "createdAt": "2020-09-13T22:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI4MTYwOA=="}], "type": "inlineReview"}, {"oid": "cded81d9a86438dfa0ba56c8d72fd1988f89ffc5", "url": "https://github.com/OpenLiberty/open-liberty/commit/cded81d9a86438dfa0ba56c8d72fd1988f89ffc5", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-13T22:23:02Z", "type": "forcePushed"}, {"oid": "1e127694989d3cbb277b3b86e05419dc73428822", "url": "https://github.com/OpenLiberty/open-liberty/commit/1e127694989d3cbb277b3b86e05419dc73428822", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-15T12:50:50Z", "type": "forcePushed"}, {"oid": "4d23467ee1b3450b5ee79eaaa016e30e024ff41d", "url": "https://github.com/OpenLiberty/open-liberty/commit/4d23467ee1b3450b5ee79eaaa016e30e024ff41d", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-15T12:51:30Z", "type": "commit"}, {"oid": "4d23467ee1b3450b5ee79eaaa016e30e024ff41d", "url": "https://github.com/OpenLiberty/open-liberty/commit/4d23467ee1b3450b5ee79eaaa016e30e024ff41d", "message": "gRPC headersToPropagate tests", "committedDate": "2020-09-15T12:51:30Z", "type": "forcePushed"}]}