{"pr_number": 14263, "pr_title": "Disable all features on conflict", "pr_createdAt": "2020-10-01T13:43:11Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/14263", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1ODI5NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r498358294", "bodyText": "An incompatible combination of what?", "author": "dazavala", "createdAt": "2020-10-01T16:04:29Z", "path": "dev/com.ibm.ws.kernel.feature.core/resources/com/ibm/ws/kernel/feature/internal/resources/ProvisionerMessages.nlsprops", "diffHunk": "@@ -222,6 +222,10 @@ MISSING_FEATURE_HAS_ALT_NAME=CWWKF0045E: An existing feature definition, {1}, is\n MISSING_FEATURE_HAS_ALT_NAME.explanation=The feature manager cannot find a definition for a feature specified in the server configuration. The name specified might match an existing feature definition.\n MISSING_FEATURE_HAS_ALT_NAME.useraction=Consider specifying the named, existing feature definition instead. \n \n+UPDATE_DISABLED_FEATURES_ON_CONFLICT=CWWKF0046W: The configuration includes an incompatible combination that is not supported. As a result the feature manager has not installed any features.", "originalCommit": "9cd51c2791e867287e66068a94e9639af01a018c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxMzY3Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r498513672", "bodyText": "Fixed with latest", "author": "tjwatson", "createdAt": "2020-10-01T21:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1ODI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQyOTY3NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r498429675", "bodyText": "I think returning true whenever at least one candidate feature declares DAOC=true is not what we want here.  At this point there are no conflicts and all resolved features do not declare DAOC=true.  And from what you've (@tjwatson) advised, all of the features in the conflict chains sans the conflicting features are in the resolved set.  So... For this code to return true we can surmise that all resolved features declare DAOC=false or lack the DAOC header, there may multiple candidates per conflict feature, no conflict feature is a root feature, and at least one conflict feature candidate has DAOC=true.  Also, that the feature that declares the tolerated conflict feature with DAOC=true is new and does not have DAOC=true (e.g. new auto feature or new malformed feature.)  If the candidate was introduced by a new auto feature, we should not clear the resovled set.  So, I think this method should return true iff all candidates declare DAOC=true, and we handle future issues involving new malformed features as they come.", "author": "dazavala", "createdAt": "2020-10-01T18:12:25Z", "path": "dev/com.ibm.ws.kernel.feature.core/src/com/ibm/ws/kernel/feature/internal/FeatureManager.java", "diffHunk": "@@ -1786,12 +1786,47 @@ boolean reportErrors(Result result, Collection<String> restrictedAccessAttempts,\n             for (Chain chain : conflict.getValue()) {\n                 installStatus.addConflictFeature(chain.getFeatureRequirement());\n             }\n+        }\n \n+        if (disableAllOnConflict) {\n+            // Remove all features on conflicts\n+            Set<String> resolved = result.getResolvedFeatures();\n+            if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n+                Tr.debug(tc, \"Conflicts found in feature set, no features will be enabled:\" + String.valueOf(sortedConflicts));\n+            }\n+            resolved.clear();\n+            Tr.warning(tc, \"UPDATE_DISABLED_FEATURES_ON_CONFLICT\");\n         }\n         return reportedErrors;\n \n     }\n \n+    private boolean disableAllOnConflict(Result result) {\n+        Map<String, Collection<Chain>> conflicts = result.getConflicts();\n+        if (conflicts.isEmpty()) {\n+            return false;\n+        }\n+        for (String featureName : result.getResolvedFeatures()) {\n+            if (shouldDisableOnConflict(featureName)) {\n+                return true;\n+            }\n+        }\n+        for (Entry<String, Collection<Chain>> conflict : conflicts.entrySet()) {", "originalCommit": "9cd51c2791e867287e66068a94e9639af01a018c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxMzc2MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r498513761", "bodyText": "Fixed with latest", "author": "tjwatson", "createdAt": "2020-10-01T21:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQyOTY3NQ=="}], "type": "inlineReview"}, {"oid": "f58101e073ee978648573cd57a0fec396aaeeab0", "url": "https://github.com/OpenLiberty/open-liberty/commit/f58101e073ee978648573cd57a0fec396aaeeab0", "message": "Disable all features on conflict\n\nA new feature header is introduced\n\nWLP-DisableAllFeatures-OnConflict: true|false\n\nIf not specified the default is false.\n\nWhen the configured feature set has a singleton conflict\nand the resolved feature set or the conflicting candidates\nhas a feature with a value of true for this new heade then\nall features will be disabled.  In other words,\nno features will be installed for the server/client\ninstance.", "committedDate": "2020-10-01T21:03:08Z", "type": "forcePushed"}, {"oid": "e1ccaa68d1b6effa0e35ac9878d9078be3bd6ff1", "url": "https://github.com/OpenLiberty/open-liberty/commit/e1ccaa68d1b6effa0e35ac9878d9078be3bd6ff1", "message": "Disable all features on conflict\n\nA new feature header is introduced\n\nWLP-DisableAllFeatures-OnConflict: true|false\n\nIf not specified the default is false.\n\nWhen the configured feature set has a singleton conflict\nand the resolved feature set or the conflicting candidates\nhas a feature with a value of true for this new heade then\nall features will be disabled.  In other words,\nno features will be installed for the server/client\ninstance.", "committedDate": "2020-10-06T13:15:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NDI3NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r500454275", "bodyText": "suggest deleting \"that is not supported.\"\nadd a comma after \"As a result\"", "author": "jantley-ibm", "createdAt": "2020-10-06T16:58:23Z", "path": "dev/com.ibm.ws.kernel.feature.core/resources/com/ibm/ws/kernel/feature/internal/resources/ProvisionerMessages.nlsprops", "diffHunk": "@@ -222,6 +222,10 @@ MISSING_FEATURE_HAS_ALT_NAME=CWWKF0045E: An existing feature definition, {1}, is\n MISSING_FEATURE_HAS_ALT_NAME.explanation=The feature manager cannot find a definition for a feature specified in the server configuration. The name specified might match an existing feature definition.\n MISSING_FEATURE_HAS_ALT_NAME.useraction=Consider specifying the named, existing feature definition instead. \n \n+UPDATE_DISABLED_FEATURES_ON_CONFLICT=CWWKF0046W: The configuration includes an incompatible combination of features that is not supported. As a result the feature manager has not installed any features.", "originalCommit": "e1ccaa68d1b6effa0e35ac9878d9078be3bd6ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4ODU3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501088570", "bodyText": "Done.", "author": "tjwatson", "createdAt": "2020-10-07T15:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NDI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NDU5Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r500454597", "bodyText": "add a comma after \"To avoid invalid behavior\"", "author": "jantley-ibm", "createdAt": "2020-10-06T16:58:52Z", "path": "dev/com.ibm.ws.kernel.feature.core/resources/com/ibm/ws/kernel/feature/internal/resources/ProvisionerMessages.nlsprops", "diffHunk": "@@ -222,6 +222,10 @@ MISSING_FEATURE_HAS_ALT_NAME=CWWKF0045E: An existing feature definition, {1}, is\n MISSING_FEATURE_HAS_ALT_NAME.explanation=The feature manager cannot find a definition for a feature specified in the server configuration. The name specified might match an existing feature definition.\n MISSING_FEATURE_HAS_ALT_NAME.useraction=Consider specifying the named, existing feature definition instead. \n \n+UPDATE_DISABLED_FEATURES_ON_CONFLICT=CWWKF0046W: The configuration includes an incompatible combination of features that is not supported. As a result the feature manager has not installed any features.\n+UPDATE_DISABLED_FEATURES_ON_CONFLICT.explanation=The configuration includes an incompatible combination of features. To avoid invalid behavior the feature manager has disabled all features.", "originalCommit": "e1ccaa68d1b6effa0e35ac9878d9078be3bd6ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4ODkyMQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501088921", "bodyText": "Done.", "author": "tjwatson", "createdAt": "2020-10-07T15:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NDU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NTA2NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r500455064", "bodyText": "Change\nTry to specify a different version\nto\nSpecify a different version", "author": "jantley-ibm", "createdAt": "2020-10-06T16:59:37Z", "path": "dev/com.ibm.ws.kernel.feature.core/resources/com/ibm/ws/kernel/feature/internal/resources/ProvisionerMessages.nlsprops", "diffHunk": "@@ -222,6 +222,10 @@ MISSING_FEATURE_HAS_ALT_NAME=CWWKF0045E: An existing feature definition, {1}, is\n MISSING_FEATURE_HAS_ALT_NAME.explanation=The feature manager cannot find a definition for a feature specified in the server configuration. The name specified might match an existing feature definition.\n MISSING_FEATURE_HAS_ALT_NAME.useraction=Consider specifying the named, existing feature definition instead. \n \n+UPDATE_DISABLED_FEATURES_ON_CONFLICT=CWWKF0046W: The configuration includes an incompatible combination of features that is not supported. As a result the feature manager has not installed any features.\n+UPDATE_DISABLED_FEATURES_ON_CONFLICT.explanation=The configuration includes an incompatible combination of features. To avoid invalid behavior the feature manager has disabled all features.\n+UPDATE_DISABLED_FEATURES_ON_CONFLICT.useraction=Try to specify a different version of the configured features that caused the conflict.", "originalCommit": "e1ccaa68d1b6effa0e35ac9878d9078be3bd6ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA4ODcxNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501088714", "bodyText": "Done", "author": "tjwatson", "createdAt": "2020-10-07T15:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1NTA2NA=="}], "type": "inlineReview"}, {"oid": "fe97554df6a41146b3336055f07a169f026f2ba6", "url": "https://github.com/OpenLiberty/open-liberty/commit/fe97554df6a41146b3336055f07a169f026f2ba6", "message": "Message updates after review.", "committedDate": "2020-10-07T15:05:59Z", "type": "forcePushed"}, {"oid": "3409aa10ced31cfb18114e01161593863594f383", "url": "https://github.com/OpenLiberty/open-liberty/commit/3409aa10ced31cfb18114e01161593863594f383", "message": "Disable all features on conflict\n\nA new feature header is introduced\n\nWLP-DisableAllFeatures-OnConflict: true|false\n\nIf not specified the default is false.\n\nWhen the configured feature set has a singleton conflict\nand the resolved feature set or the conflicting candidates\nhas a feature with a value of true for this new heade then\nall features will be disabled.  In other words,\nno features will be installed for the server/client\ninstance.", "committedDate": "2020-10-07T15:05:58Z", "type": "commit"}, {"oid": "e920d06fb095d73e7d275adcc7c7d4f30300b9a5", "url": "https://github.com/OpenLiberty/open-liberty/commit/e920d06fb095d73e7d275adcc7c7d4f30300b9a5", "message": "Update EECompatibilityTest for disable all on conflict", "committedDate": "2020-10-07T15:05:58Z", "type": "commit"}, {"oid": "fe97554df6a41146b3336055f07a169f026f2ba6", "url": "https://github.com/OpenLiberty/open-liberty/commit/fe97554df6a41146b3336055f07a169f026f2ba6", "message": "Message updates after review.", "committedDate": "2020-10-07T15:05:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMzM4Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501133386", "bodyText": "Change \"has not installed\" to \"did not install\"", "author": "helyarp", "createdAt": "2020-10-07T16:05:35Z", "path": "dev/com.ibm.ws.kernel.feature.core/resources/com/ibm/ws/kernel/feature/internal/resources/ProvisionerMessages.nlsprops", "diffHunk": "@@ -222,6 +222,10 @@ MISSING_FEATURE_HAS_ALT_NAME=CWWKF0045E: An existing feature definition, {1}, is\n MISSING_FEATURE_HAS_ALT_NAME.explanation=The feature manager cannot find a definition for a feature specified in the server configuration. The name specified might match an existing feature definition.\n MISSING_FEATURE_HAS_ALT_NAME.useraction=Consider specifying the named, existing feature definition instead. \n \n+UPDATE_DISABLED_FEATURES_ON_CONFLICT=CWWKF0046W: The configuration includes an incompatible combination of features. As a result, the feature manager has not installed any features.", "originalCommit": "fe97554df6a41146b3336055f07a169f026f2ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMDU2Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501210563", "bodyText": "Done.", "author": "tjwatson", "createdAt": "2020-10-07T18:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMzM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzNjc4OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501136788", "bodyText": "Remove \"has\" so that the explanation has \"the feature manager disabled all features.\"", "author": "helyarp", "createdAt": "2020-10-07T16:10:19Z", "path": "dev/com.ibm.ws.kernel.feature.core/resources/com/ibm/ws/kernel/feature/internal/resources/ProvisionerMessages.nlsprops", "diffHunk": "@@ -222,6 +222,10 @@ MISSING_FEATURE_HAS_ALT_NAME=CWWKF0045E: An existing feature definition, {1}, is\n MISSING_FEATURE_HAS_ALT_NAME.explanation=The feature manager cannot find a definition for a feature specified in the server configuration. The name specified might match an existing feature definition.\n MISSING_FEATURE_HAS_ALT_NAME.useraction=Consider specifying the named, existing feature definition instead. \n \n+UPDATE_DISABLED_FEATURES_ON_CONFLICT=CWWKF0046W: The configuration includes an incompatible combination of features. As a result, the feature manager has not installed any features.\n+UPDATE_DISABLED_FEATURES_ON_CONFLICT.explanation=The configuration includes an incompatible combination of features. To avoid invalid behavior, the feature manager has disabled all features.", "originalCommit": "fe97554df6a41146b3336055f07a169f026f2ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMDY5Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501210692", "bodyText": "Done.", "author": "tjwatson", "createdAt": "2020-10-07T18:07:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzNjc4OA=="}], "type": "inlineReview"}, {"oid": "c590b31d20cfb06de565f84aecf500e641be7329", "url": "https://github.com/OpenLiberty/open-liberty/commit/c590b31d20cfb06de565f84aecf500e641be7329", "message": "More fixes to messages after review.", "committedDate": "2020-10-07T18:06:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyMTg3Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501221873", "bodyText": "Please change \"installed\" to \"install\" (did not install)", "author": "helyarp", "createdAt": "2020-10-07T18:23:19Z", "path": "dev/com.ibm.ws.kernel.feature.core/resources/com/ibm/ws/kernel/feature/internal/resources/ProvisionerMessages.nlsprops", "diffHunk": "@@ -222,6 +222,10 @@ MISSING_FEATURE_HAS_ALT_NAME=CWWKF0045E: An existing feature definition, {1}, is\n MISSING_FEATURE_HAS_ALT_NAME.explanation=The feature manager cannot find a definition for a feature specified in the server configuration. The name specified might match an existing feature definition.\n MISSING_FEATURE_HAS_ALT_NAME.useraction=Consider specifying the named, existing feature definition instead. \n \n+UPDATE_DISABLED_FEATURES_ON_CONFLICT=CWWKF0046W: The configuration includes an incompatible combination of features. As a result, the feature manager did not installed any features.", "originalCommit": "c590b31d20cfb06de565f84aecf500e641be7329", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI0MDY1NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14263#discussion_r501240655", "bodyText": "Opps, I now have that fixed.", "author": "tjwatson", "createdAt": "2020-10-07T18:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyMTg3Mw=="}], "type": "inlineReview"}, {"oid": "2d511451e372dab93d537f366ca73acac6ee1c86", "url": "https://github.com/OpenLiberty/open-liberty/commit/2d511451e372dab93d537f366ca73acac6ee1c86", "message": "Message fixes after review.", "committedDate": "2020-10-07T18:56:13Z", "type": "commit"}]}