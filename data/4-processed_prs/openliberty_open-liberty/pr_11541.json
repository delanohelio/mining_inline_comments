{"pr_number": 11541, "pr_title": "Change processing of feature bundles", "pr_createdAt": "2020-03-30T19:07:23Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11541", "timeline": [{"oid": "51842a19dc5637875f6b4a77fd7a77f65e7c74f1", "url": "https://github.com/OpenLiberty/open-liberty/commit/51842a19dc5637875f6b4a77fd7a77f65e7c74f1", "message": "Fix intermittent app manager issue", "committedDate": "2020-04-16T13:43:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4MjI0MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r411682240", "bodyText": "This seems like a very limited condition to add to the bundle added delta.  I would have expected this to add all bundles that got installed that did not exist before.  But here we only add bundles that are not fragments and that we need to change the start-level for?", "author": "tjwatson", "createdAt": "2020-04-20T20:49:23Z", "path": "dev/com.ibm.ws.kernel.feature.core/src/com/ibm/ws/kernel/feature/internal/Provisioner.java", "diffHunk": "@@ -305,6 +304,7 @@ public boolean handle(FeatureResource fr) {\n                             }\n                             level = newLevel;\n                             bsl.setStartLevel(level);\n+                            installStatus.addBundleAddedDelta(bundle);", "originalCommit": "8cedf2d8d28c459afd7f3c8238bb093f6e03e421", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyNzkxOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412627919", "bodyText": "Moved to the installFeatureBundle method", "author": "brenthdaniel", "createdAt": "2020-04-22T02:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4MjI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4NjQzNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r411686434", "bodyText": "Does this map need to be thread safe?  It seems we populate it here and then leave it open to other threads to get/put stuff on it when the notification is fired.  Should setProperties just take the values and wrap them in an unmodifiable Map in the notification impl? This way they are only read-only on notification firing when they call getProperties.", "author": "tjwatson", "createdAt": "2020-04-20T20:56:27Z", "path": "dev/com.ibm.ws.kernel.feature.core/src/com/ibm/ws/kernel/feature/internal/FeatureManager.java", "diffHunk": "@@ -1400,6 +1408,10 @@ protected boolean updateFeatures(WsLocationAdmin locService,\n         provisioner.resolveBundles(bundleContext, installedBundles);\n \n         if (featureChange.featureBundlesResolved != null) {\n+            Map<String, Object> props = new HashMap<String, Object>(1);", "originalCommit": "8cedf2d8d28c459afd7f3c8238bb093f6e03e421", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ2ODc4Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412468787", "bodyText": "This has been addressed", "author": "tjwatson", "createdAt": "2020-04-21T20:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4NjQzNA=="}], "type": "inlineReview"}, {"oid": "d04f9343bb534a5a75bb3d81d0adcb5c229ca6ba", "url": "https://github.com/OpenLiberty/open-liberty/commit/d04f9343bb534a5a75bb3d81d0adcb5c229ca6ba", "message": "Updates from code review", "committedDate": "2020-04-21T19:31:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ0MjUyNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412442524", "bodyText": "Did you intend to leave this commented out?", "author": "tjwatson", "createdAt": "2020-04-21T19:45:23Z", "path": "dev/com.ibm.ws.config/src/com/ibm/ws/config/xml/internal/BundleProcessor.java", "diffHunk": "@@ -254,12 +248,14 @@ public void bundleChanged(BundleEvent event) {\n             Bundle b = event.getBundle();\n             boolean isFeatureBundle = b.getLocation().startsWith(XMLConfigConstants.BUNDLE_LOC_FEATURE_TAG);\n             if (type == BundleEvent.RESOLVED) {\n+\n                 if (isFeatureBundle) {\n+\n                     if (tc.isDebugEnabled()) {\n                         Tr.debug(tc, \"Adding feature bundle {0}\", b);\n                     }\n                     //add it to the queue for processing later\n-                    addFeatureBundles.add(b);\n+//                    addFeatureBundles.add(b);", "originalCommit": "d04f9343bb534a5a75bb3d81d0adcb5c229ca6ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyODExNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412628114", "bodyText": "Issues with comments/printStacktrace were fixed by restoring old commits", "author": "brenthdaniel", "createdAt": "2020-04-22T02:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ0MjUyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ0MjcwMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412442700", "bodyText": "Did you intend to leave this commented out?", "author": "tjwatson", "createdAt": "2020-04-21T19:45:39Z", "path": "dev/com.ibm.ws.config/src/com/ibm/ws/config/xml/internal/BundleProcessor.java", "diffHunk": "@@ -270,7 +266,7 @@ public void bundleChanged(BundleEvent event) {\n             } else if (type == BundleEvent.UNRESOLVED) {\n                 if (isFeatureBundle) {\n                     //add it to the queue for processing later\n-                    removeFeatureBundles.add(b);\n+                    //                   removeFeatureBundles.add(b);", "originalCommit": "d04f9343bb534a5a75bb3d81d0adcb5c229ca6ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1OTI3OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412459279", "bodyText": "Did you intend to do a printStackTrace here?", "author": "tjwatson", "createdAt": "2020-04-21T20:12:27Z", "path": "dev/com.ibm.ws.kernel.feature.core/src/com/ibm/ws/kernel/feature/internal/Provisioner.java", "diffHunk": "@@ -608,7 +588,9 @@ public boolean handle(FeatureResource fr) {\n         for (Bundle bundleToUninstall : bundlesToUninstall) {\n             try {\n                 bundleToUninstall.uninstall();\n+                installStatus.addBundleRemovedDelta(bundleToUninstall);\n             } catch (IllegalStateException e) {\n+                e.printStackTrace();", "originalCommit": "d04f9343bb534a5a75bb3d81d0adcb5c229ca6ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ2MDI5Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412460297", "bodyText": "It would seem that you should add to the status the intention to uninstall this bundle before calling uninstall().  The BundleProcessor no longer will get an uninstalled event so it would miss it if we somehow had another thread uninstall the bundle before we could here.", "author": "tjwatson", "createdAt": "2020-04-21T20:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1OTI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyOTQ5NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412629494", "bodyText": "Changed so the installstatus method is called before the uninstall", "author": "brenthdaniel", "createdAt": "2020-04-22T02:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1OTI3OQ=="}], "type": "inlineReview"}, {"oid": "8cedf2d8d28c459afd7f3c8238bb093f6e03e421", "url": "https://github.com/OpenLiberty/open-liberty/commit/8cedf2d8d28c459afd7f3c8238bb093f6e03e421", "message": "Cleanup and copyrights", "committedDate": "2020-04-16T13:49:19Z", "type": "forcePushed"}, {"oid": "3e7861b883525a6837aab9824c22efc1977bb6d2", "url": "https://github.com/OpenLiberty/open-liberty/commit/3e7861b883525a6837aab9824c22efc1977bb6d2", "message": "Change processing of feature bundles", "committedDate": "2020-04-22T02:41:44Z", "type": "commit"}, {"oid": "3e7861b883525a6837aab9824c22efc1977bb6d2", "url": "https://github.com/OpenLiberty/open-liberty/commit/3e7861b883525a6837aab9824c22efc1977bb6d2", "message": "Change processing of feature bundles", "committedDate": "2020-04-22T02:41:44Z", "type": "forcePushed"}, {"oid": "e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "url": "https://github.com/OpenLiberty/open-liberty/commit/e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "message": "Address review comments", "committedDate": "2020-04-22T02:48:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk0MjEyMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412942122", "bodyText": "Should this be volatile? I'm pretty sure it should be, it looks like it would be read from one thread and written with another.", "author": "tjwatson", "createdAt": "2020-04-22T12:35:17Z", "path": "dev/com.ibm.ws.app.manager/src/com/ibm/ws/app/manager/internal/statemachine/StartAction.java", "diffHunk": "@@ -43,6 +43,7 @@\n     private final AtomicLong _startTime = new AtomicLong();\n     private final ApplicationMonitor _appMonitor;\n     private final boolean _update;\n+    private boolean cancelled = false;", "originalCommit": "e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk0MjU5Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412942597", "bodyText": "Did you intend to leave this commented out?  It is unclear to me if _callback will always get set from the CompletionListener when cancel is called and it is safe to remove this call.  But if that is all good then this commented out code will always make the next set of eyes have the same questions I do (I think).", "author": "tjwatson", "createdAt": "2020-04-22T12:35:58Z", "path": "dev/com.ibm.ws.app.manager/src/com/ibm/ws/app/manager/internal/statemachine/StartAction.java", "diffHunk": "@@ -160,7 +165,8 @@ private void stopSlowStartMessage() {\n     /** {@inheritDoc} */\n     @Override\n     public void cancel() {\n-        _callback.set(null);\n+        this.cancelled = true;\n+        //      _callback.set(null);", "originalCommit": "e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk0NzM4OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412947388", "bodyText": "I thought the convention was to use a comma here 2009, 2020.", "author": "tjwatson", "createdAt": "2020-04-22T12:42:37Z", "path": "dev/com.ibm.ws.kernel.feature.core/src/com/ibm/ws/kernel/feature/internal/BundleInstallStatus.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*******************************************************************************\n- * Copyright (c) 2009 IBM Corporation and others.\n+ * Copyright (c) 2009-2020 IBM Corporation and others.", "originalCommit": "e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk0ODUwMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412948500", "bodyText": "Not your change, just showing up because of line differences.  Creating a new empty Hashtable instead of passing null is just creating garbage.", "author": "tjwatson", "createdAt": "2020-04-22T12:44:08Z", "path": "dev/com.ibm.ws.kernel.feature.core/src/com/ibm/ws/kernel/feature/internal/FeatureManager.java", "diffHunk": "@@ -744,10 +750,12 @@ protected void update(FeatureChange featureChange) throws IllegalStateException\n \n                     //register a service that can be looked up for server start.\n                     // Need a two phase approach, since ports will be opened for listening on the first phase\n-                    bundleContext.registerService(ServerStarted.class, new ServerStarted() {}, new Hashtable<String, Object>());\n+                    bundleContext.registerService(ServerStarted.class, new ServerStarted() {\n+                    }, new Hashtable<String, Object>());", "originalCommit": "e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk0ODc5MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412948790", "bodyText": "Same hashtable object garbage comment.", "author": "tjwatson", "createdAt": "2020-04-22T12:44:31Z", "path": "dev/com.ibm.ws.kernel.feature.core/src/com/ibm/ws/kernel/feature/internal/FeatureManager.java", "diffHunk": "@@ -744,10 +750,12 @@ protected void update(FeatureChange featureChange) throws IllegalStateException\n \n                     //register a service that can be looked up for server start.\n                     // Need a two phase approach, since ports will be opened for listening on the first phase\n-                    bundleContext.registerService(ServerStarted.class, new ServerStarted() {}, new Hashtable<String, Object>());\n+                    bundleContext.registerService(ServerStarted.class, new ServerStarted() {\n+                    }, new Hashtable<String, Object>());\n \n                     // components which needed to wait till ports were opened for listening need to wait till Phase2\n-                    bundleContext.registerService(ServerStartedPhase2.class, new ServerStartedPhase2() {}, new Hashtable<String, Object>());\n+                    bundleContext.registerService(ServerStartedPhase2.class, new ServerStartedPhase2() {\n+                    }, new Hashtable<String, Object>());", "originalCommit": "e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk1MDA3NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11541#discussion_r412950074", "bodyText": "use of dash in copyright dates.", "author": "tjwatson", "createdAt": "2020-04-22T12:46:14Z", "path": "dev/com.ibm.ws.runtime.update/src/com/ibm/ws/runtime/update/RuntimeUpdateNotification.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*******************************************************************************\n- * Copyright (c) 2014 IBM Corporation and others.\n+ * Copyright (c) 2014-2020 IBM Corporation and others.", "originalCommit": "e7eb06ccc4baacb9890452c76dd0bf3f2384de6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "139abf68b81b36aeb83635e38721f27112524439", "url": "https://github.com/OpenLiberty/open-liberty/commit/139abf68b81b36aeb83635e38721f27112524439", "message": "Cleanup and copyrights", "committedDate": "2020-04-22T14:46:52Z", "type": "commit"}]}