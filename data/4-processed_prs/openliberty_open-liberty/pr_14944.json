{"pr_number": 14944, "pr_title": "Enable junit report", "pr_createdAt": "2020-11-12T15:38:07Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/14944", "timeline": [{"oid": "e907a365d39a95abcaf51a13cf9045b0563d9b2f", "url": "https://github.com/OpenLiberty/open-liberty/commit/e907a365d39a95abcaf51a13cf9045b0563d9b2f", "message": "testing one fat bucket", "committedDate": "2020-11-12T19:44:39Z", "type": "forcePushed"}, {"oid": "91d8b5642a36af29629f3bb405b8c45cfe335232", "url": "https://github.com/OpenLiberty/open-liberty/commit/91d8b5642a36af29629f3bb405b8c45cfe335232", "message": "fix scripts", "committedDate": "2020-11-12T22:43:24Z", "type": "forcePushed"}, {"oid": "f80ef0127c1bf7938b11427e66c078f7750b615f", "url": "https://github.com/OpenLiberty/open-liberty/commit/f80ef0127c1bf7938b11427e66c078f7750b615f", "message": "fix scripts", "committedDate": "2020-11-12T22:53:31Z", "type": "forcePushed"}, {"oid": "daa46ecb765abdc69b176ad8fc300f49db666718", "url": "https://github.com/OpenLiberty/open-liberty/commit/daa46ecb765abdc69b176ad8fc300f49db666718", "message": "Only report failures", "committedDate": "2020-11-13T18:12:19Z", "type": "forcePushed"}, {"oid": "79dc8cd4ca6fc8aa88dbf2b9d77428cc8a0b393e", "url": "https://github.com/OpenLiberty/open-liberty/commit/79dc8cd4ca6fc8aa88dbf2b9d77428cc8a0b393e", "message": "Only report failures", "committedDate": "2020-11-13T18:17:45Z", "type": "forcePushed"}, {"oid": "45c27e8fed77fff8131668fbaab6b6b78d9e521c", "url": "https://github.com/OpenLiberty/open-liberty/commit/45c27e8fed77fff8131668fbaab6b6b78d9e521c", "message": "Only report failures", "committedDate": "2020-11-13T19:16:26Z", "type": "forcePushed"}, {"oid": "d3b2122cefeea6c69ff77fa2efad6ace7a3aa20a", "url": "https://github.com/OpenLiberty/open-liberty/commit/d3b2122cefeea6c69ff77fa2efad6ace7a3aa20a", "message": "Only report failures", "committedDate": "2020-11-13T19:36:00Z", "type": "forcePushed"}, {"oid": "292bc5f92c5c4bdc6c8a9aa3bbc94803e993928d", "url": "https://github.com/OpenLiberty/open-liberty/commit/292bc5f92c5c4bdc6c8a9aa3bbc94803e993928d", "message": "Only report failures", "committedDate": "2020-11-13T19:43:36Z", "type": "forcePushed"}, {"oid": "ae0c3c3cefacd61b9aac8bce3c26d8dbffe8c52a", "url": "https://github.com/OpenLiberty/open-liberty/commit/ae0c3c3cefacd61b9aac8bce3c26d8dbffe8c52a", "message": "Only report failures", "committedDate": "2020-11-13T22:00:58Z", "type": "forcePushed"}, {"oid": "8999155e39b023fef7e091003f400ac5d6b19945", "url": "https://github.com/OpenLiberty/open-liberty/commit/8999155e39b023fef7e091003f400ac5d6b19945", "message": "Only report failures", "committedDate": "2020-11-13T22:03:49Z", "type": "forcePushed"}, {"oid": "746c82f905d0eb42278e89d99f58b2d2469b8ea0", "url": "https://github.com/OpenLiberty/open-liberty/commit/746c82f905d0eb42278e89d99f58b2d2469b8ea0", "message": "Only report failures", "committedDate": "2020-11-13T23:22:02Z", "type": "forcePushed"}, {"oid": "9a394f014edc6e2e0356075ec019283761ddc049", "url": "https://github.com/OpenLiberty/open-liberty/commit/9a394f014edc6e2e0356075ec019283761ddc049", "message": "Only report failures", "committedDate": "2020-11-13T23:26:14Z", "type": "forcePushed"}, {"oid": "046b10d33478316b3e124278dd28601d18effa9d", "url": "https://github.com/OpenLiberty/open-liberty/commit/046b10d33478316b3e124278dd28601d18effa9d", "message": "enable junit report on unit tests\n\nSetup fat junit reporting\n\nfix scripts\n\nOnly report failures", "committedDate": "2020-11-14T01:12:39Z", "type": "forcePushed"}, {"oid": "795f205d62012be97543b4614a78d2532f3d9a30", "url": "https://github.com/OpenLiberty/open-liberty/commit/795f205d62012be97543b4614a78d2532f3d9a30", "message": "enable junit report on unit tests\n\nSetup fat junit reporting\n\nfix scripts\n\nOnly report failures", "committedDate": "2020-11-14T01:22:36Z", "type": "forcePushed"}, {"oid": "93d05f14689b3c6231cd300d5dd94b4bebc89606", "url": "https://github.com/OpenLiberty/open-liberty/commit/93d05f14689b3c6231cd300d5dd94b4bebc89606", "message": "enable junit report on unit tests\n\nSetup fat junit reporting\n\nfix scripts\n\nOnly report failures", "committedDate": "2020-11-14T02:06:18Z", "type": "forcePushed"}, {"oid": "e55302e38c192df0f491622fd723c2c2fab49148", "url": "https://github.com/OpenLiberty/open-liberty/commit/e55302e38c192df0f491622fd723c2c2fab49148", "message": "enable junit report on unit tests\n\nSetup fat junit reporting\n\nfix scripts\n\nOnly report failures", "committedDate": "2020-11-16T15:08:55Z", "type": "forcePushed"}, {"oid": "2b5f4801c3c5366f619b660068d018f6dba39107", "url": "https://github.com/OpenLiberty/open-liberty/commit/2b5f4801c3c5366f619b660068d018f6dba39107", "message": "enable junit report on unit tests\n\nSetup fat junit reporting\n\nfix scripts\n\nOnly report failures", "committedDate": "2020-11-16T15:42:19Z", "type": "forcePushed"}, {"oid": "beaccf4830722325a42f70c57a04639d0228c3e1", "url": "https://github.com/OpenLiberty/open-liberty/commit/beaccf4830722325a42f70c57a04639d0228c3e1", "message": "try replacement junit report action", "committedDate": "2020-11-19T14:51:32Z", "type": "forcePushed"}, {"oid": "22a97fcd5f8b75b01c4152ecedead2e7c2036838", "url": "https://github.com/OpenLiberty/open-liberty/commit/22a97fcd5f8b75b01c4152ecedead2e7c2036838", "message": "try replacement junit report action", "committedDate": "2020-11-19T15:14:07Z", "type": "forcePushed"}, {"oid": "3ecd388ee110b48aa056f981de89c51f9f52d1fc", "url": "https://github.com/OpenLiberty/open-liberty/commit/3ecd388ee110b48aa056f981de89c51f9f52d1fc", "message": "try replacement junit report action", "committedDate": "2020-11-19T17:00:02Z", "type": "forcePushed"}, {"oid": "2cea6129eaa10af83cc2d4e387ca1f48357793e1", "url": "https://github.com/OpenLiberty/open-liberty/commit/2cea6129eaa10af83cc2d4e387ca1f48357793e1", "message": "enable junit report on unit tests\n\nSetup fat junit reporting\n\nfix scripts\n\nOnly report failures", "committedDate": "2020-11-24T03:32:52Z", "type": "commit"}, {"oid": "b951c07412242167600a47e8d8811a8ea90f7e65", "url": "https://github.com/OpenLiberty/open-liberty/commit/b951c07412242167600a47e8d8811a8ea90f7e65", "message": "try replacement junit report action", "committedDate": "2020-11-24T03:32:53Z", "type": "forcePushed"}, {"oid": "e5e53b583bd7960b4547d71c080b1522c6443679", "url": "https://github.com/OpenLiberty/open-liberty/commit/e5e53b583bd7960b4547d71c080b1522c6443679", "message": "try replacement junit report action", "committedDate": "2020-11-24T03:50:05Z", "type": "forcePushed"}, {"oid": "d0a3a78e1fdb0eb2e6b8ffbcf94017875887d7ce", "url": "https://github.com/OpenLiberty/open-liberty/commit/d0a3a78e1fdb0eb2e6b8ffbcf94017875887d7ce", "message": "try replacement junit report action", "committedDate": "2020-11-24T03:58:13Z", "type": "forcePushed"}, {"oid": "2d6c63ff923f2c4ab3fefe698da711d180a7b977", "url": "https://github.com/OpenLiberty/open-liberty/commit/2d6c63ff923f2c4ab3fefe698da711d180a7b977", "message": "try replacement junit report action", "committedDate": "2020-11-24T04:26:27Z", "type": "forcePushed"}, {"oid": "58aebdef233ab1c7ad0770e6b4d3109288e3903a", "url": "https://github.com/OpenLiberty/open-liberty/commit/58aebdef233ab1c7ad0770e6b4d3109288e3903a", "message": "try replacement junit report action", "committedDate": "2020-11-24T04:28:24Z", "type": "forcePushed"}, {"oid": "9f5c82f41e11ff67ecd7a0224aa231045e86bd52", "url": "https://github.com/OpenLiberty/open-liberty/commit/9f5c82f41e11ff67ecd7a0224aa231045e86bd52", "message": "try replacement junit report action", "committedDate": "2020-12-02T01:14:04Z", "type": "forcePushed"}, {"oid": "45218188c2bcaaa1bf3b94b1badfb577644d2c13", "url": "https://github.com/OpenLiberty/open-liberty/commit/45218188c2bcaaa1bf3b94b1badfb577644d2c13", "message": "try replacement junit report action", "committedDate": "2020-12-02T01:22:22Z", "type": "forcePushed"}, {"oid": "55b4e493374fd5e21e7dd546b53cf43680635841", "url": "https://github.com/OpenLiberty/open-liberty/commit/55b4e493374fd5e21e7dd546b53cf43680635841", "message": "try replacement junit report action", "committedDate": "2020-12-02T01:26:27Z", "type": "forcePushed"}, {"oid": "716dd3e936fd5262d49b4668dd0a9164c5cb303e", "url": "https://github.com/OpenLiberty/open-liberty/commit/716dd3e936fd5262d49b4668dd0a9164c5cb303e", "message": "try replacement junit report action", "committedDate": "2020-12-02T20:58:08Z", "type": "forcePushed"}, {"oid": "e17a06d4b188980c8f1fba6b8cbb7e353f1eac8a", "url": "https://github.com/OpenLiberty/open-liberty/commit/e17a06d4b188980c8f1fba6b8cbb7e353f1eac8a", "message": "try replacement junit report action", "committedDate": "2020-12-03T20:35:58Z", "type": "forcePushed"}, {"oid": "95c30cc10321079e4aec9c180561b3dfaa455b71", "url": "https://github.com/OpenLiberty/open-liberty/commit/95c30cc10321079e4aec9c180561b3dfaa455b71", "message": "try replacement junit report action", "committedDate": "2020-12-03T21:48:02Z", "type": "forcePushed"}, {"oid": "dc6278d82b752bd8ead144b93a0997659639bf6e", "url": "https://github.com/OpenLiberty/open-liberty/commit/dc6278d82b752bd8ead144b93a0997659639bf6e", "message": "try replacement junit report action", "committedDate": "2020-12-04T22:42:38Z", "type": "commit"}, {"oid": "dc6278d82b752bd8ead144b93a0997659639bf6e", "url": "https://github.com/OpenLiberty/open-liberty/commit/dc6278d82b752bd8ead144b93a0997659639bf6e", "message": "try replacement junit report action", "committedDate": "2020-12-04T22:42:38Z", "type": "forcePushed"}, {"oid": "64252269d5f088d3bc74794bceedfa559d285a67", "url": "https://github.com/OpenLiberty/open-liberty/commit/64252269d5f088d3bc74794bceedfa559d285a67", "message": "replace ubuntu-latest", "committedDate": "2020-12-08T15:37:14Z", "type": "forcePushed"}, {"oid": "77c105ccc5b5126740a6f09086ac3d271cfab9ea", "url": "https://github.com/OpenLiberty/open-liberty/commit/77c105ccc5b5126740a6f09086ac3d271cfab9ea", "message": "replace ubuntu-latest", "committedDate": "2020-12-08T16:25:30Z", "type": "forcePushed"}, {"oid": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "url": "https://github.com/OpenLiberty/open-liberty/commit/0d82a639663d05ed067d671f3fcf8807bcf21b30", "message": "replace ubuntu-latest", "committedDate": "2020-12-08T16:46:42Z", "type": "commit"}, {"oid": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "url": "https://github.com/OpenLiberty/open-liberty/commit/0d82a639663d05ed067d671f3fcf8807bcf21b30", "message": "replace ubuntu-latest", "committedDate": "2020-12-08T16:46:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYwNDc2NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14944#discussion_r538604764", "bodyText": "Are we trying to exclude something by doing TEST-com.*.xml TEST-io.*.xml as opposed to just TEST-*.xml?", "author": "aguibert", "createdAt": "2020-12-08T17:01:01Z", "path": ".github/workflow-scripts/run-unit-tests.sh", "diffHunk": "@@ -0,0 +1,63 @@\n+#!/bin/bash\n+# This script runs all unit tests and outputs final values [total / successes / failed / skipped]\n+\n+cd dev\n+chmod +x gradlew\n+\n+echo \"Running gradle test and testReport tasks.  This will take approx. 30 minutes.\"\n+\n+# Redirect stdout to log file that will get archived if build fails\n+echo \"::group::Gradle Output\"\n+./gradlew --continue cnf:initialize testResults -Dgradle.test.ignoreFailures=true\n+echo \"::endgroup::\"\n+\n+# Gradle testResults task will save off results in generated.properties ensure that file exists otherwise fail\n+if [[ ! -f \"generated.properties\" ]]; then\n+    echo \"generated.properties file does not exist gradle build likely failed\"\n+    exit 1\n+else \n+    if [ -z $(grep tests.total.all generated.properties) ]; then\n+        echo \"Test results not generated gradle build likely failed\"\n+        exit 1\n+    fi\n+fi\n+\n+# Copy off test results to be archived\n+total=$(grep tests.total.all generated.properties | sed 's/[^0-9]*//g')\n+successful=$(grep tests.total.successful generated.properties | sed 's/[^0-9]*//g')\n+failed=$(grep tests.total.failed generated.properties | sed 's/[^0-9]*//g')\n+skipped=$(grep tests.total.skipped generated.properties | sed 's/[^0-9]*//g')\n+\n+#Setup output directory \n+UNIT_DIR=$PWD/unit-results\n+mkdir $UNIT_DIR\n+\n+#Collect test results in central location\n+#Check each project\n+for project in */ ; do\n+    # If unit test folder exists\n+    if [[ -d \"$project/build/libs/test-reports/test\" ]]; then\n+        pushd $project/build/libs/test-reports/test &> /dev/null\n+        # Then copy unit test file(s) to central location\n+        for f in TEST-com.*.xml TEST-io.*.xml ; do ", "originalCommit": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYwODg2NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14944#discussion_r538608865", "bodyText": "I'd rather leave this stuff in the core Build job because there is such a small amount of work occurring in Setup. Using public runners this completes in about 70 seconds it looks like, but most of that time is spent provisioning the new machine and cloning the repo, When we switch to self-hosted runners this will likely become more of an issue where provisioning new jobs are slightly slower.", "author": "aguibert", "createdAt": "2020-12-08T17:04:44Z", "path": ".github/workflows/openliberty-ci.yml", "diffHunk": "@@ -20,14 +20,14 @@ on:\n env:\n   LANG: en_US.UTF-8\n jobs:\n-  build:\n-    name: Build Open Liberty\n-    runs-on: ubuntu-latest\n-    outputs:\n+  setup: #Validates copyright headers, selects test-os, selects java version, and sets up test categories. ", "originalCommit": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzNjI3Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14944#discussion_r538636276", "bodyText": "for now lets leave unit tests hardcoded to java 11. In our existing RTC setup we only ever run unit tests on java 11, so for now it should be sufficient to leave that behavior in place.", "author": "aguibert", "createdAt": "2020-12-08T17:30:05Z", "path": ".github/workflows/openliberty-ci.yml", "diffHunk": "@@ -82,27 +81,27 @@ jobs:\n       run: |\n         cd dev\n         chmod +x gradlew\n+        echo \"::group::Building Liberty.  This will take approx. 30 minutes\"\n         ./gradlew cnf:initialize assemble\n+        echo \"::endgroup::\"\n         cd .. && zip -rq openliberty-image.zip dev/build.image/wlp/\n     - name: Upload liberty image\n       uses: actions/upload-artifact@v2\n       with:\n         name: openliberty-image\n         if-no-files-found: error\n         path: openliberty-image.zip\n-  unit_tests:\n+  unit_tests: #Unit tests always run linux, but could depends on setup to determine jdk\n     name: Unit Tests\n-    runs-on: ubuntu-latest\n+    needs: setup\n+    runs-on: ubuntu-18.04\n     timeout-minutes: 60\n     steps:\n-    - uses: actions/checkout@v2\n-#    - uses: testspace-com/setup-testspace@v1\n-#      with:\n-#        domain: ${{ github.repository_owner }}  \n+    - uses: actions/checkout@v2 \n     - name: Set up Java\n       uses: joschi/setup-jdk@v2\n       with:\n-        java-version: 11\n+        java-version: ${{ needs.setup.outputs.test-java }}", "originalCommit": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY0MDgzMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14944#discussion_r538640832", "bodyText": "what's the reasoning behind limiting num failures? Do we have a limited amount of annotations on each build? Or is it just so we avoid flooding logs/results with failures?", "author": "aguibert", "createdAt": "2020-12-08T17:34:17Z", "path": ".github/workflows/openliberty-ci.yml", "diffHunk": "@@ -126,41 +125,40 @@ jobs:\n         restore-keys: |\n           ${{ runner.os }}-maven-\n     - name: Run unit tests\n-      run: |\n-        cd dev\n-        chmod +x gradlew\n-        ./gradlew --continue cnf:initialize testResults\n-    - name: Upload test report\n-      if: failure()\n+      id: run-unit-tests\n+      run: .github/workflow-scripts/run-unit-tests.sh\n+    - name: Upload unit test artifact\n+      if: steps.run-unit-tests.outputs.status == 'failure'\n       uses: actions/upload-artifact@v2\n       with:\n-        name: Unit test logs\n+        name: Unit Test Logs\n         path: dev/cnf/generated/testReports/allUnitTests\n-    - name: Upload unit test results\n-      shell: bash\n-      if: always()\n-      run: .github/workflow-scripts/upload-unit-tests.sh\n-  fat_tests:\n+    - name: Analyze junit output\n+      if: steps.run-unit-tests.outputs.status == 'failure'\n+      uses: KyleAure/junit-report-annotations-action@1.6\n+      with:\n+        name: Unit test report\n+        path: \"dev/unit-results/TEST-*.xml\"\n+        includeSummary: true\n+        numFailures: 10 # Truncate number of failures so we don't run out of annoations.", "originalCommit": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY0MTQ1Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14944#discussion_r538641456", "bodyText": "lets just delete this instead of commenting it out", "author": "aguibert", "createdAt": "2020-12-08T17:34:54Z", "path": "dev/wlp-gradle/java.gradle", "diffHunk": "@@ -77,8 +77,9 @@ subprojects {\n   test { \n     // Once testing is complete copy \n     finalizedBy junitReport\n-  \n-    ignoreFailures = true\n+    \n+    // This is unnecessary as finalizedBy will run regardless of subproject failure\n+\t//ignoreFailures = true", "originalCommit": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY0MjQ3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14944#discussion_r538642470", "bodyText": "this looks fine, but lets be sure to test that it still works on an RTC build when there is a unit test failure", "author": "aguibert", "createdAt": "2020-12-08T17:35:48Z", "path": "dev/wlp-gradle/subprojects/tasks.gradle", "diffHunk": "@@ -360,7 +360,8 @@ test {\n   }\n \n   timeout = Duration.ofMinutes(15)\n-  ignoreFailures = Boolean.valueOf(rootProject.ext.userProps.getProperty(\"gradle.test.ignoreFailures\", \"false\"))\n+  //Set ignore failures using -Dgradle.test.ignoreFailures=true\n+  ignoreFailures = Boolean.valueOf(System.getProperty(\"gradle.test.ignoreFailures\", \"false\"))", "originalCommit": "0d82a639663d05ed067d671f3fcf8807bcf21b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "062ac68845fd37bf4e5301c2b10e6e95c7c19305", "url": "https://github.com/OpenLiberty/open-liberty/commit/062ac68845fd37bf4e5301c2b10e6e95c7c19305", "message": "feedback changes", "committedDate": "2020-12-14T16:18:22Z", "type": "forcePushed"}, {"oid": "d43edda89441764807ae8985336049d660ead593", "url": "https://github.com/OpenLiberty/open-liberty/commit/d43edda89441764807ae8985336049d660ead593", "message": "feedback changes", "committedDate": "2020-12-14T16:50:01Z", "type": "forcePushed"}, {"oid": "16cd1746bb4aae6ef620678a0b8c607e150bf2a1", "url": "https://github.com/OpenLiberty/open-liberty/commit/16cd1746bb4aae6ef620678a0b8c607e150bf2a1", "message": "feedback changes", "committedDate": "2020-12-15T21:04:08Z", "type": "forcePushed"}, {"oid": "3870bbf9f44da77f65077f4cf3e992286c8676ad", "url": "https://github.com/OpenLiberty/open-liberty/commit/3870bbf9f44da77f65077f4cf3e992286c8676ad", "message": "feedback changes", "committedDate": "2020-12-16T16:16:33Z", "type": "commit"}, {"oid": "3870bbf9f44da77f65077f4cf3e992286c8676ad", "url": "https://github.com/OpenLiberty/open-liberty/commit/3870bbf9f44da77f65077f4cf3e992286c8676ad", "message": "feedback changes", "committedDate": "2020-12-16T16:16:33Z", "type": "forcePushed"}]}