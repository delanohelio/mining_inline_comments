{"pr_number": 15359, "pr_title": "Add capability to identify errorCodes and sqlStates as stale connections", "pr_createdAt": "2020-12-22T17:32:08Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/15359", "timeline": [{"oid": "51b4e303b812dc8857af1e041defd066230c4e35", "url": "https://github.com/OpenLiberty/open-liberty/commit/51b4e303b812dc8857af1e041defd066230c4e35", "message": "Rename mapError element to identifyException", "committedDate": "2020-12-22T17:42:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxOTcwMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r547519703", "bodyText": "Invalid value ''{0}'' specified for the identifyException ''as'' attribute.\n--->\nThe  ''{0}'' invalid value was specified for the ''as'' attribute on the identifyException element.", "author": "dmuelle", "createdAt": "2020-12-22T21:39:53Z", "path": "dev/com.ibm.ws.jdbc/resources/com/ibm/ws/rsadapter/resources/IBMDataStoreAdapterNLS.nlsprops", "diffHunk": "@@ -366,6 +366,20 @@ PROP_SET_ERROR.useraction=Verify that the value that is specified is valid for t\n # 8060 deleted\n # 8065 deleted\n \n+# 8066E\n+# {0}         The invalid attribute value\n+# {1}         The allowed attribute values\n+# Do not translate: identifyException, as\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET=DSRA8066E: Invalid value ''{0}'' specified for the identifyException ''as'' attribute. Allowed values are: {1}", "originalCommit": "51b4e303b812dc8857af1e041defd066230c4e35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUyMDk0NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r547520944", "bodyText": "An unknown value was specified for the identifyException configuration element.\n--->\nAn invalid value was specified for the identifyException configuration element.", "author": "dmuelle", "createdAt": "2020-12-22T21:43:27Z", "path": "dev/com.ibm.ws.jdbc/resources/com/ibm/ws/rsadapter/resources/IBMDataStoreAdapterNLS.nlsprops", "diffHunk": "@@ -366,6 +366,20 @@ PROP_SET_ERROR.useraction=Verify that the value that is specified is valid for t\n # 8060 deleted\n # 8065 deleted\n \n+# 8066E\n+# {0}         The invalid attribute value\n+# {1}         The allowed attribute values\n+# Do not translate: identifyException, as\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET=DSRA8066E: Invalid value ''{0}'' specified for the identifyException ''as'' attribute. Allowed values are: {1}\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET.explanation=An unknown value was specified for the identifyException configuration element.", "originalCommit": "51b4e303b812dc8857af1e041defd066230c4e35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUyMzgxNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r547523817", "bodyText": "Must specify exactly one of the ''errorCode'' or ''sqlState'' attributes on the identifyException element.\n--->\nExactly one of either the ''errorCode'' or ''sqlState'' attributes must be specified on the identifyException element.", "author": "dmuelle", "createdAt": "2020-12-22T21:51:08Z", "path": "dev/com.ibm.ws.jdbc/resources/com/ibm/ws/rsadapter/resources/IBMDataStoreAdapterNLS.nlsprops", "diffHunk": "@@ -366,6 +366,20 @@ PROP_SET_ERROR.useraction=Verify that the value that is specified is valid for t\n # 8060 deleted\n # 8065 deleted\n \n+# 8066E\n+# {0}         The invalid attribute value\n+# {1}         The allowed attribute values\n+# Do not translate: identifyException, as\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET=DSRA8066E: Invalid value ''{0}'' specified for the identifyException ''as'' attribute. Allowed values are: {1}\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET.explanation=An unknown value was specified for the identifyException configuration element.\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET.useraction=Update the configuration to specify one of the allowed values.\n+\n+# 8067E\n+# Do not translate: errorCode, sqlState, identifyException\n+8067E_IDENTIFY_EXCEPTION_ERRCODE_SQLSTATE=DSRA8067E: Must specify exactly one of the ''errorCode'' or ''sqlState'' attributes on the identifyException element.", "originalCommit": "51b4e303b812dc8857af1e041defd066230c4e35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUyNDI3Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r547524277", "bodyText": "Update the configuration to specify exactly one of the errorCode or sqlState attributes.\n--->\nUpdate the configuration to specify exactly one of the errorCode or sqlState attributes on the identifyException element.", "author": "dmuelle", "createdAt": "2020-12-22T21:52:32Z", "path": "dev/com.ibm.ws.jdbc/resources/com/ibm/ws/rsadapter/resources/IBMDataStoreAdapterNLS.nlsprops", "diffHunk": "@@ -366,6 +366,20 @@ PROP_SET_ERROR.useraction=Verify that the value that is specified is valid for t\n # 8060 deleted\n # 8065 deleted\n \n+# 8066E\n+# {0}         The invalid attribute value\n+# {1}         The allowed attribute values\n+# Do not translate: identifyException, as\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET=DSRA8066E: Invalid value ''{0}'' specified for the identifyException ''as'' attribute. Allowed values are: {1}\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET.explanation=An unknown value was specified for the identifyException configuration element.\n+8066E_IDENTIFY_EXCEPTION_INVALID_TARGET.useraction=Update the configuration to specify one of the allowed values.\n+\n+# 8067E\n+# Do not translate: errorCode, sqlState, identifyException\n+8067E_IDENTIFY_EXCEPTION_ERRCODE_SQLSTATE=DSRA8067E: Must specify exactly one of the ''errorCode'' or ''sqlState'' attributes on the identifyException element.\n+8067E_IDENTIFY_EXCEPTION_ERRCODE_SQLSTATE.explanation=The errorCode and sqlState attributes are mutually exclusive, and one of the attributes must be specified.\n+8067E_IDENTIFY_EXCEPTION_ERRCODE_SQLSTATE.useraction=Update the configuration to specify exactly one of the errorCode or sqlState attributes.", "originalCommit": "51b4e303b812dc8857af1e041defd066230c4e35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUyNDcxNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r547524715", "bodyText": "Normally this will be the actual error code returned by the underlying database.\n--->\nNormally, this is the actual error code that is returned by the underlying database.", "author": "dmuelle", "createdAt": "2020-12-22T21:53:53Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception as\n+identifyException.desc=Map a specific sqlCode or sqlState to an action such as a stale connection.\n+\n+identifyException.sqlState=SQL State\n+identifyException.sqlState.desc=A string that follows either the XOPEN SQLstate conventions or the SQL:2003 conventions.\n+identifyException.errorCode=SQL Error Code\n+identifyException.errorCode.desc=An integer error code specific to the backend database. Normally this will be the actual error code returned by the underlying database.", "originalCommit": "51b4e303b812dc8857af1e041defd066230c4e35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUyNTMzMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r547525332", "bodyText": "Allowed values are: None (removes a mapping), or StaleConnection (connections that are determined to be stale will be evicted from the connection pool once closed)\n--->\nAllowed values are: None, which removes a mapping, or StaleConnection. Connections that are determined to be stale are evicted from the connection pool once they are closed.", "author": "dmuelle", "createdAt": "2020-12-22T21:55:35Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception as\n+identifyException.desc=Map a specific sqlCode or sqlState to an action such as a stale connection.\n+\n+identifyException.sqlState=SQL State\n+identifyException.sqlState.desc=A string that follows either the XOPEN SQLstate conventions or the SQL:2003 conventions.\n+identifyException.errorCode=SQL Error Code\n+identifyException.errorCode.desc=An integer error code specific to the backend database. Normally this will be the actual error code returned by the underlying database.\n+identifyException.as=Identify exception as\n+identifyException.as.desc=The target mapping for the sqlCode or sqlState. Allowed values are: None (removes a mapping), or StaleConnection (connections that are determined to be stale will be evicted from the connection pool once closed)", "originalCommit": "51b4e303b812dc8857af1e041defd066230c4e35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab8810ae768f59668990a4cd869640d3afa4d4f0", "url": "https://github.com/OpenLiberty/open-liberty/commit/ab8810ae768f59668990a4cd869640d3afa4d4f0", "message": "Message review comments", "committedDate": "2020-12-28T15:43:55Z", "type": "forcePushed"}, {"oid": "32230f4f9eb8082a4985c92b43f5265d9a153369", "url": "https://github.com/OpenLiberty/open-liberty/commit/32230f4f9eb8082a4985c92b43f5265d9a153369", "message": "Allow identifyException to specify an errorCode and sqlState at the same time", "committedDate": "2020-12-29T16:21:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3MDQwNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549770407", "bodyText": "Inconsistent use of \"SQL state\" vs \"SQLstate\" vs \"sqlState\" vs \"SQL State\" between this and the following translatable text.", "author": "njr-11", "createdAt": "2020-12-29T16:37:23Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception\n+identifyException.desc=Identify a specific SQL error code or SQL state on a SQLException.", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3MDUzOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549770539", "bodyText": "Capitalization should be \"SQL error code\" for consistency with usage above.", "author": "njr-11", "createdAt": "2020-12-29T16:37:55Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception\n+identifyException.desc=Identify a specific SQL error code or SQL state on a SQLException.\n+\n+identifyException.sqlState=SQL State\n+identifyException.sqlState.desc=A string that follows either the XOPEN SQLstate conventions or the SQL:2003 conventions.\n+identifyException.errorCode=SQL Error Code", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3MTI5MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549771291", "bodyText": "We should add the reason: \"This enables the application server (or container, whatever is the right word) to take appropriate action based on the error condition. For example, closing a stale connection instead of returning it to the connection pool.\"", "author": "njr-11", "createdAt": "2020-12-29T16:40:07Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception\n+identifyException.desc=Identify a specific SQL error code or SQL state on a SQLException.", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3Mzk4MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549773981", "bodyText": "\"integer\" is unnecessary. The type is already correctly included in the schema and documentation that is generated from it.", "author": "njr-11", "createdAt": "2020-12-29T16:48:47Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception\n+identifyException.desc=Identify a specific SQL error code or SQL state on a SQLException.\n+\n+identifyException.sqlState=SQL State\n+identifyException.sqlState.desc=A string that follows either the XOPEN SQLstate conventions or the SQL:2003 conventions.\n+identifyException.errorCode=SQL Error Code\n+identifyException.errorCode.desc=An integer error code specific to the backend database. Normally, this is the actual error code that is returned by the underlying database.", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NDIxMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549774210", "bodyText": "What about StaleStatement?", "author": "njr-11", "createdAt": "2020-12-29T16:49:28Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception\n+identifyException.desc=Identify a specific SQL error code or SQL state on a SQLException.\n+\n+identifyException.sqlState=SQL State\n+identifyException.sqlState.desc=A string that follows either the XOPEN SQLstate conventions or the SQL:2003 conventions.\n+identifyException.errorCode=SQL Error Code\n+identifyException.errorCode.desc=An integer error code specific to the backend database. Normally, this is the actual error code that is returned by the underlying database.\n+identifyException.as=Identify exception as\n+identifyException.as.desc=The target mapping for the sqlCode or sqlState. Allowed values are: None or StaleConnection. None removes a mapping. StaleConnection causes connections that are stale to be evicted from the connection pool once they are closed.", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIyODQ1MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r550228451", "bodyText": "This PR only handles None and StaleConnection for now. StaleStatement will have to be added in a follow-on PR.", "author": "aguibert", "createdAt": "2020-12-30T15:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ5NDgzNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r550494835", "bodyText": "That's fine - we can certainly add StaleStatement later in a separate pull.", "author": "njr-11", "createdAt": "2020-12-31T14:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NDIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NDg3OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549774878", "bodyText": "Rather than saying, \"The target mapping for\", I think we could phrase this in a way that will be more easily understood by users.  \"Identifies the error condition that the SQL error code or SQL state represents. Allowed values ...  None removes the identification. Stale Connection ...\"", "author": "njr-11", "createdAt": "2020-12-29T16:51:45Z", "path": "dev/com.ibm.ws.jdbc.metatype/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -106,6 +106,17 @@ isoLevel.SERIALIZABLE.desc=Dirty reads, non-repeatable reads and phantom reads a\n isoLevel.SNAPSHOT.desc=Snapshot isolation for Microsoft SQL Server JDBC Driver and DataDirect Connect for JDBC driver.\n isoLevel.NONE.desc=Indicates that the JDBC driver does not support transactions.\n \n+# Identify Exception\n+identifyException=Identify exception\n+identifyException.desc=Identify a specific SQL error code or SQL state on a SQLException.\n+\n+identifyException.sqlState=SQL State\n+identifyException.sqlState.desc=A string that follows either the XOPEN SQLstate conventions or the SQL:2003 conventions.\n+identifyException.errorCode=SQL Error Code\n+identifyException.errorCode.desc=An integer error code specific to the backend database. Normally, this is the actual error code that is returned by the underlying database.\n+identifyException.as=Identify exception as\n+identifyException.as.desc=The target mapping for the sqlCode or sqlState. Allowed values are: None or StaleConnection. None removes a mapping. StaleConnection causes connections that are stale to be evicted from the connection pool once they are closed.", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NjA3Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549786073", "bodyText": "The statement that this may be null doesn't appear to be true, and if it were would cause a NullPointerException in the code that follows.", "author": "njr-11", "createdAt": "2020-12-29T17:25:25Z", "path": "dev/com.ibm.ws.jdbc/src/com/ibm/ws/rsadapter/DSConfig.java", "diffHunk": "@@ -194,6 +245,12 @@\n      * JNDI name.\n      */\n     public final String jndiName;\n+    \n+    /**\n+     * List of identified exceptinos to check if certain errorCode or sqlState values that should map to specific actions.\n+     * May be null if none are configured", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4ODU3OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549788578", "bodyText": "The - is a confusing delimiter given that error codes can and sometimes do have negative values.  A  different delimiter (maybe &) would be clearer for someone who is debugging.", "author": "njr-11", "createdAt": "2020-12-29T17:33:32Z", "path": "dev/com.ibm.ws.jdbc/src/com/ibm/ws/rsadapter/impl/DatabaseHelper.java", "diffHunk": "@@ -99,6 +103,14 @@\n      * SQLException SQL States that indicate a stale connection.\n      */\n     final Set<String> staleSQLStates = new HashSet<String>();\n+    \n+    /**\n+     * Pairs of SQLException error codes and SQL states that indicate a stale exception.\n+     * This differs from staleErrorCodes and staleSQLStates because here both items must\n+     * match in order to be considered stale.\n+     * The entries are of the format: SQLSTATE-SQLCODE", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIyOTc1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r550229754", "bodyText": "good point, I'll change that to a forward-slash delimiter", "author": "aguibert", "createdAt": "2020-12-30T15:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4ODU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5MDY3Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r549790672", "bodyText": "This approach is unable to override an improperly identified stale when the JDBC driver raises a SQLNonTransientConnectionException or SQLRecoverableException.\nIt is also unable to override an improperly identified stale when there was a built-in mapping to just the SQL State, for example 08003 and the user it trying to override so that the combination of SQL State 08003 with error code 230 means not stale.\nThat said, we have probably gone too far ahead with the implementation here when we know that ultimately we will also need to consider how other types of identified exceptions fit into the map and may end up altering the approach a bit for that regardless.", "author": "njr-11", "createdAt": "2020-12-29T17:40:22Z", "path": "dev/com.ibm.ws.jdbc/src/com/ibm/ws/rsadapter/impl/DatabaseHelper.java", "diffHunk": "@@ -394,22 +445,24 @@ public boolean isConnectionError(SQLException ex) {\n \n         // Maintain a set in order to check for cycles\n         Set<Throwable> chain = new HashSet<Throwable>();\n-\n+        \n         boolean stale = false;\n         for (Throwable t = ex; t != null && !stale && chain.add(t); t = t.getCause()) {\n             SQLException sqlX = t instanceof SQLException ? (SQLException) t : null;\n             if (isTraceOn && tc.isDebugEnabled())\n                 Tr.debug(this, tc, \"checking \" + t,\n                          sqlX == null ? null : sqlX.getSQLState(),\n                          sqlX == null ? null : sqlX.getErrorCode());\n+            \n             if (sqlX != null)\n                 stale |= sqlX instanceof SQLRecoverableException ||\n                          sqlX instanceof SQLNonTransientConnectionException ||\n                          sqlX instanceof SQLTransientConnectionException && failoverOccurred(sqlX) ||\n+                         staleStateAndCodes.contains(sqlX.getSQLState() + \"-\" + sqlX.getErrorCode()) ||", "originalCommit": "32230f4f9eb8082a4985c92b43f5265d9a153369", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI1MjM4NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/15359#discussion_r550252385", "bodyText": "Makes sense, I've updated the code so user-defined mappings are always checked first, and I also added a testcase called testRemovedMapping_stateAndCode which exercises the scenario you mentioned in the second sentence.", "author": "aguibert", "createdAt": "2020-12-30T16:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5MDY3Mg=="}], "type": "inlineReview"}, {"oid": "6e593e4df0d88671c47563b523d9756b63957763", "url": "https://github.com/OpenLiberty/open-liberty/commit/6e593e4df0d88671c47563b523d9756b63957763", "message": "Add capability to map sqlCodes and sqlStates to stale connections", "committedDate": "2020-12-30T16:27:48Z", "type": "commit"}, {"oid": "1eb54d91ed46b5eef720372ea83ec97f823c7bdf", "url": "https://github.com/OpenLiberty/open-liberty/commit/1eb54d91ed46b5eef720372ea83ec97f823c7bdf", "message": "Rename mapError element to identifyException", "committedDate": "2020-12-30T16:27:49Z", "type": "commit"}, {"oid": "ec40e3c238754d9243f59d1872c1361b1211b44b", "url": "https://github.com/OpenLiberty/open-liberty/commit/ec40e3c238754d9243f59d1872c1361b1211b44b", "message": "Message review comments", "committedDate": "2020-12-30T16:27:49Z", "type": "commit"}, {"oid": "a7ff9e376c2da789c817c7fe73d7e75dd48a875c", "url": "https://github.com/OpenLiberty/open-liberty/commit/a7ff9e376c2da789c817c7fe73d7e75dd48a875c", "message": "Allow identifyException to specify an errorCode and sqlState at the same time", "committedDate": "2020-12-30T16:27:49Z", "type": "commit"}, {"oid": "5d95b513ed5dfff079469c8853ffb11ec82b05c4", "url": "https://github.com/OpenLiberty/open-liberty/commit/5d95b513ed5dfff079469c8853ffb11ec82b05c4", "message": "Review comments from Nathan", "committedDate": "2020-12-30T16:27:49Z", "type": "forcePushed"}, {"oid": "7889624e006749fa3a6cfd68e5f99043f8e6a626", "url": "https://github.com/OpenLiberty/open-liberty/commit/7889624e006749fa3a6cfd68e5f99043f8e6a626", "message": "Review comments from Nathan", "committedDate": "2020-12-31T15:15:13Z", "type": "commit"}, {"oid": "7889624e006749fa3a6cfd68e5f99043f8e6a626", "url": "https://github.com/OpenLiberty/open-liberty/commit/7889624e006749fa3a6cfd68e5f99043f8e6a626", "message": "Review comments from Nathan", "committedDate": "2020-12-31T15:15:13Z", "type": "forcePushed"}]}