{"pr_number": 11685, "pr_title": "Update JPA Spec 1.0 Query FAT to be multi-db supportive.", "pr_createdAt": "2020-04-07T20:05:21Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11685", "timeline": [{"oid": "f50c38b7730c8f605528e334800d326c1f561793", "url": "https://github.com/OpenLiberty/open-liberty/commit/f50c38b7730c8f605528e334800d326c1f561793", "message": "Update JPA Spec 1.0 Query FAT to be multi-db supportive.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-04-08T15:53:31Z", "type": "commit"}, {"oid": "f50c38b7730c8f605528e334800d326c1f561793", "url": "https://github.com/OpenLiberty/open-liberty/commit/f50c38b7730c8f605528e334800d326c1f561793", "message": "Update JPA Spec 1.0 Query FAT to be multi-db supportive.\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-04-08T15:53:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyMjEzNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405722137", "bodyText": "If this is supposed to be DB agnostic, do we want to use <properties.derby.embedded?", "author": "dazey3", "createdAt": "2020-04-08T18:18:37Z", "path": "dev/com.ibm.ws.jpa_spec10_query_fat/publish/servers/JPA10QueryServer/database.xml", "diffHunk": "@@ -10,18 +10,30 @@\n  -->\n  <server>\n     <dataSource id=\"jdbc/JPA_DS\" jndiName=\"jdbc/JPA_DS\" fat.modify=\"true\">\n-            <jdbcDriver libraryRef=\"JDBCLib\"/>\n-            <properties.derby.embedded databaseName=\"memory:ds1\" createDatabase=\"create\" user=\"dbuser1\" password=\"{xor}Oz0vKDtu\" />\n+            <jdbcDriver libraryRef=\"AnonymousJDBCLib\"/>\n+            <properties.derby.embedded databaseName=\"memory:ds1\" createDatabase=\"create\" />\n     </dataSource>\n \n     <dataSource id=\"jdbc/JPA_NJTADS\" jndiName=\"jdbc/JPA_NJTADS\" fat.modify=\"true\" transactional=\"false\">\n-            <jdbcDriver libraryRef=\"JDBCLib\"/>\n-            <properties.derby.embedded databaseName=\"memory:ds1\" createDatabase=\"create\" user=\"dbuser1\" password=\"{xor}Oz0vKDtu\" />\n+            <jdbcDriver libraryRef=\"AnonymousJDBCLib\"/>\n+            <properties.derby.embedded databaseName=\"memory:ds1\" createDatabase=\"create\" />", "originalCommit": "f50c38b7730c8f605528e334800d326c1f561793", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1ODY0Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405758642", "bodyText": "Because the database tooling will replace it.  I followed the example from com.ibm.ws.concurrent.persistent_fat_demo_timers.  Having it there is the correct thing to do.", "author": "jgrassel", "createdAt": "2020-04-08T19:22:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyMjEzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODkxOA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405728918", "bodyText": "What was the necessity of changing the test? Was the test failing without this change? What DBs fail without this change?", "author": "dazey3", "createdAt": "2020-04-08T18:30:04Z", "path": "dev/com.ibm.ws.jpa_spec10_query_fat/test-applications/olgh8014/src/com/ibm/ws/jpa/olgh8014/testlogic/JPATestOLGH8014Logic.java", "diffHunk": "@@ -387,7 +387,7 @@ public void testAggregateFunctionsWithPrimitives(TestExecutionContext testExecCt\n                 Assert.assertEquals(new Integer(20), res);\n             } else {\n                 //The specification defined assertion\n-                Assert.assertEquals(new Double(20), res);\n+                Assert.assertEquals(new Double(20).doubleValue(), (double) res, 0.5);", "originalCommit": "f50c38b7730c8f605528e334800d326c1f561793", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1OTI0Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405759242", "bodyText": "You might have noticed the last argument, which allows for wriggle room.  Remember how float and decimal values are not precise, and can vary?  (hint: no reputable bank stores an account balance using decimals and floats)", "author": "jgrassel", "createdAt": "2020-04-08T19:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyNDQ3OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406324479", "bodyText": "So you added the delta as a precaution, but there were no test failures that lead to this change?", "author": "dazey3", "createdAt": "2020-04-09T16:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMDgyMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406430822", "bodyText": "Without them, Oracle and SQLServer failed because the database did not store the float value exactly the same as as the JVM's value.  So when the query executed, the float value returned was difference.  Because 2.1 != 2.11.  So the third argument is a tolerance for that variance.", "author": "jgrassel", "createdAt": "2020-04-09T19:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1OTY3MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406459671", "bodyText": "Hmm. That seems like an issue. Customers aren't going to be ok with an arbitrary tolerance tho. Do you have the test results you could send me? Id like to take a look.", "author": "dazey3", "createdAt": "2020-04-09T20:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5MDIzNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406490234", "bodyText": "Will, this is at the jdbc/database level.  Go ahead and try it with some raw JDBC.", "author": "jgrassel", "createdAt": "2020-04-09T21:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMjkxMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406932910", "bodyText": "Maybe these tests are pretty useless then. They were meant to test precise return values, but every database returns a different result.", "author": "dazey3", "createdAt": "2020-04-10T20:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0NjE1Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405746152", "bodyText": "Does ${schemaname} just not work for Postgres? Should this be removed from all the Postgres ddl (JPA_OLGH8294_DELETE_POSTGRES, JPA_OLGH8294_DROP_POSTGRES, JPA_OLGH8014_DELETE_POSTGRES, JPA_OLGH8014_DROP_POSTGRES)?", "author": "dazey3", "createdAt": "2020-04-08T18:59:23Z", "path": "dev/com.ibm.ws.jpa_spec10_query_fat/test-applications/olgh8014/ddl/WEB-INF/classes/JPA_OLGH8014_POPULATE_POSTGRES.ddl", "diffHunk": "@@ -1,2 +1,2 @@\n-INSERT INTO ${schemaname}.SIMPLEENTITYOLGH8014 (KEY_CHAR,ITEM_BIG_DECIMAL1,ITEM_BIG_INTEGER1,ITEM_FLOAT1,ITEM_FLOAT2,ITEM_INTEGER1,ITEM_INTEGER2,ITEM_STRING1) VALUES ('SimpleEntityOLGH80141',11.11,12,13.13,14.15,15,16,'TestString');\n-INSERT INTO ${schemaname}.SIMPLEENTITYOLGH8014 (KEY_CHAR,ITEM_BIG_DECIMAL1,ITEM_BIG_INTEGER1,ITEM_FLOAT1,ITEM_FLOAT2,ITEM_INTEGER1,ITEM_INTEGER2,ITEM_STRING1) VALUES ('SimpleEntityOLGH80142',21.21,22,23.23,24.25,25,26,'TestString');", "originalCommit": "f50c38b7730c8f605528e334800d326c1f561793", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1OTc2MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405759760", "bodyText": "I had problems with it, so I got rid of it.  Though yeah, the delete and drop scripts should be consistent. Good catch.", "author": "jgrassel", "createdAt": "2020-04-08T19:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0NjE1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0OTIyNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406449224", "bodyText": "fixed", "author": "jgrassel", "createdAt": "2020-04-09T20:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0NjE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0ODQyNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405748427", "bodyText": "Was this change needed for a test failure?? I wouldn't think this to be necessary for different databases", "author": "dazey3", "createdAt": "2020-04-08T19:03:18Z", "path": "dev/com.ibm.ws.jpa_spec10_query_fat/test-applications/olgh8294/web/olgh8294Web.war/WEB-INF/classes/META-INF/persistence.xml", "diffHunk": "@@ -35,6 +35,7 @@\n \n     <persistence-unit name=\"OLGH8294_PROPERTY_RL\" transaction-type=\"RESOURCE_LOCAL\">\n         <non-jta-data-source>jdbc/JPA_NJTADS</non-jta-data-source>\n+        <class>com.ibm.ws.jpa.olgh8294.model.SimpleEntityOLGH8294</class>", "originalCommit": "f50c38b7730c8f605528e334800d326c1f561793", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MDE1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r405760154", "bodyText": "Oh, I needed that to generate the sqlserver ddl (remember, java se environments require  elements, they don't scan for persistent types.  It doesn't hurt anything having it there, but I'll clean it up.", "author": "jgrassel", "createdAt": "2020-04-08T19:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0ODQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyNjQ4Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406326483", "bodyText": "Thanks. I appreciate cleaning this up, even though I agree there isnt any real issue having it there.", "author": "dazey3", "createdAt": "2020-04-09T16:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0ODQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ0OTI4Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11685#discussion_r406449283", "bodyText": "fixed", "author": "jgrassel", "createdAt": "2020-04-09T20:09:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0ODQyNw=="}], "type": "inlineReview"}, {"oid": "3b30076365ed55875eb3312bcf520b0261330bbb", "url": "https://github.com/OpenLiberty/open-liberty/commit/3b30076365ed55875eb3312bcf520b0261330bbb", "message": "Address review comments for PR Update JPA Spec 1.0 Query FAT to be multi-db supportive. #11685\n\nSigned-off-by: Joe Grassel <jgrassel@us.ibm.com>", "committedDate": "2020-04-09T20:10:40Z", "type": "commit"}]}