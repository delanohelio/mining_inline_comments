{"pr_number": 12774, "pr_title": "Add kerberos container auth support for data sources", "pr_createdAt": "2020-06-25T03:36:07Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/12774", "timeline": [{"oid": "a0df1389476127ced6641a88aae2f3d5e128dba6", "url": "https://github.com/OpenLiberty/open-liberty/commit/a0df1389476127ced6641a88aae2f3d5e128dba6", "message": "Add kerberos container auth support for data sources", "committedDate": "2020-06-25T03:36:51Z", "type": "forcePushed"}, {"oid": "cebc9899417d87cd14e30c10a101a376bfc8c6bd", "url": "https://github.com/OpenLiberty/open-liberty/commit/cebc9899417d87cd14e30c10a101a376bfc8c6bd", "message": "Add kerberos container auth support for data sources", "committedDate": "2020-06-25T03:41:14Z", "type": "commit"}, {"oid": "cebc9899417d87cd14e30c10a101a376bfc8c6bd", "url": "https://github.com/OpenLiberty/open-liberty/commit/cebc9899417d87cd14e30c10a101a376bfc8c6bd", "message": "Add kerberos container auth support for data sources", "committedDate": "2020-06-25T03:41:14Z", "type": "forcePushed"}, {"oid": "9a0431e464f404b6ecdb53f120f4bb2faf0f97d9", "url": "https://github.com/OpenLiberty/open-liberty/commit/9a0431e464f404b6ecdb53f120f4bb2faf0f97d9", "message": "Automatically detect DB2 security mechanism 11 for kerberos", "committedDate": "2020-06-25T04:53:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyMTE1Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r445621153", "bodyText": "Suggested update for\n\nThe path of the keytab file used to obtain the principal's secret key. If unspecified, the keytab from the Kerberos configuration file will be used. If it is not specified in the Kerberos configuration file then it will look for the file at {user.home}/krb5.keytab.\n\nto\n\nThe path of the keytab file that is used to obtain the principal's secret key. If unspecified, the keytab from the Kerberos configuration file is used. If it is not specified in the Kerberos configuration file, then it looks for the file at {user.home}/krb5.keytab.", "author": "Charlotte-Holt", "createdAt": "2020-06-25T14:54:47Z", "path": "dev/com.ibm.ws.security.auth.data.common/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -32,3 +32,12 @@ enabled.desc=Enables the authentication data subject cache.\n \n maxSize=Maximum cache size\n maxSize.desc=Maximum number of entries supported by the authentication data subject cache.\n+\n+#======= KERBEROS SETTINGS =========\n+krb5Principal=Kerberos principal name\n+krb5Principal.desc=The name of the principal that should be used. The principal can be a simple username or a service name.\n+\n+krb5Keytab=Kerberos keytab file\n+krb5Keytab.desc=The path of the keytab file used to obtain the principal's secret key. If unspecified, the keytab from the \\\n+Kerberos configuration file will be used. If it is not specified in the Kerberos configuration file then it will look for the \\\n+file at {user.home}/krb5.keytab.", "originalCommit": "9a0431e464f404b6ecdb53f120f4bb2faf0f97d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyMTgxMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r445621810", "bodyText": "Suggested update for\n\nThe name of the principal that should be used. The principal can be a simple username or a service name.\n\nto\n\nThe name of the principal to be used. The principal can be a simple username or a service name.", "author": "Charlotte-Holt", "createdAt": "2020-06-25T14:55:40Z", "path": "dev/com.ibm.ws.security.auth.data.common/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -32,3 +32,12 @@ enabled.desc=Enables the authentication data subject cache.\n \n maxSize=Maximum cache size\n maxSize.desc=Maximum number of entries supported by the authentication data subject cache.\n+\n+#======= KERBEROS SETTINGS =========\n+krb5Principal=Kerberos principal name\n+krb5Principal.desc=The name of the principal that should be used. The principal can be a simple username or a service name.", "originalCommit": "9a0431e464f404b6ecdb53f120f4bb2faf0f97d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "057724a48e2d77bdb95f3894af2e1cd96f9f8a54", "url": "https://github.com/OpenLiberty/open-liberty/commit/057724a48e2d77bdb95f3894af2e1cd96f9f8a54", "message": "Review comments and build fixes", "committedDate": "2020-06-26T05:45:11Z", "type": "commit"}, {"oid": "057724a48e2d77bdb95f3894af2e1cd96f9f8a54", "url": "https://github.com/OpenLiberty/open-liberty/commit/057724a48e2d77bdb95f3894af2e1cd96f9f8a54", "message": "Review comments and build fixes", "committedDate": "2020-06-26T05:45:11Z", "type": "forcePushed"}, {"oid": "7a6eaeb6e538965622baa99ad523efb93845b688", "url": "https://github.com/OpenLiberty/open-liberty/commit/7a6eaeb6e538965622baa99ad523efb93845b688", "message": "Split Krb5LoginModuleWrapper into separate bundle", "committedDate": "2020-06-27T16:45:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5ODkyOA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r446998928", "bodyText": "only change on this file is adding the new com.ibm.ws.security.kerberos.auth bundle (refactoring)", "author": "aguibert", "createdAt": "2020-06-29T14:07:17Z", "path": "dev/com.ibm.websphere.appserver.features/visibility/private/com.ibm.websphere.appserver.builtinAuthentication-1.0.feature", "diffHunk": "@@ -1,13 +1,16 @@\n -include= ~${workspace}/cnf/resources/bnd/feature.props\n symbolicName=com.ibm.websphere.appserver.builtinAuthentication-1.0\n--features=com.ibm.websphere.appserver.javax.servlet-3.0; ibm.tolerates:=\"3.1,4.0\"; apiJar=false, \\\n- com.ibm.websphere.appserver.classloading-1.0, \\\n- com.ibm.websphere.appserver.ltpa-1.0\n--bundles=com.ibm.ws.security.authentication, \\\n- com.ibm.ws.security.credentials.wscred, \\\n- com.ibm.websphere.security, \\\n- com.ibm.ws.security.jaas.common, \\\n- com.ibm.ws.security.authentication.builtin, \\\n- com.ibm.ws.security.mp.jwt.proxy\n+-features=\\\n+  com.ibm.websphere.appserver.javax.servlet-3.0; ibm.tolerates:=\"3.1,4.0\"; apiJar=false, \\\n+  com.ibm.websphere.appserver.classloading-1.0, \\\n+  com.ibm.websphere.appserver.ltpa-1.0\n+-bundles=\\\n+  com.ibm.ws.security.authentication, \\\n+  com.ibm.ws.security.credentials.wscred, \\\n+  com.ibm.websphere.security, \\\n+  com.ibm.ws.security.jaas.common, \\\n+  com.ibm.ws.security.authentication.builtin, \\\n+  com.ibm.ws.security.mp.jwt.proxy,\\\n+  com.ibm.ws.security.kerberos.auth", "originalCommit": "7a6eaeb6e538965622baa99ad523efb93845b688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxMjA3Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r447012076", "bodyText": "service name should change to service principal name (SPN).", "author": "utle", "createdAt": "2020-06-29T14:25:23Z", "path": "dev/com.ibm.ws.security.auth.data.common/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -32,3 +32,14 @@ enabled.desc=Enables the authentication data subject cache.\n \n maxSize=Maximum cache size\n maxSize.desc=Maximum number of entries supported by the authentication data subject cache.\n+\n+#======= KERBEROS SETTINGS =========\n+# Do not translate: Kerberos, principal\n+krb5Principal=Kerberos principal name\n+krb5Principal.desc=The name of the principal to be used. The principal can be a simple username or a service name.", "originalCommit": "7a6eaeb6e538965622baa99ad523efb93845b688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxMzI1OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r447013259", "bodyText": "We should call SubjectHelpet.getGSSCredentialFromSubject() method", "author": "utle", "createdAt": "2020-06-29T14:27:01Z", "path": "dev/com.ibm.ws.security.jca/src/com/ibm/ws/security/jca/internal/AuthDataServiceImpl.java", "diffHunk": "@@ -146,10 +155,52 @@ private AuthData getAuthData(String authDataAlias) throws LoginException {\n         return authDataProviderRef.getService().getAuthData(authDataAlias);\n     }\n \n-    private Subject obtainSubject(ManagedConnectionFactory managedConnectionFactory, AuthData authData) {\n-        Subject subject = createSubject(managedConnectionFactory, authData);\n-        addInvocationSubjectPrincipal(subject);\n-        optimize(subject);\n+    private Subject obtainSubject(ManagedConnectionFactory managedConnectionFactory, AuthData authData) throws LoginException {\n+        if (authData.getKrb5Principal() != null) {\n+            return doKerberosLogin(authData.getKrb5Principal(), authData.getKrb5Keytab());\n+        } else {\n+            Subject subject = createSubject(managedConnectionFactory, authData);\n+            addInvocationSubjectPrincipal(subject);\n+            optimize(subject);\n+            return subject;\n+        }\n+    }\n+\n+    private Subject doKerberosLogin(String principal, Path keytab) throws LoginException {\n+        Subject subject = new Subject();\n+        Krb5LoginModuleWrapper krb5 = new Krb5LoginModuleWrapper();\n+        Map<String, String> options = new HashMap<String, String>();\n+        Map<String, Object> sharedState = new HashMap<String, Object>();\n+\n+        options.put(\"isInitiator\", \"true\");\n+        options.put(\"refreshKrb5Config\", \"true\");\n+        options.put(\"doNotPrompt\", \"true\");\n+        // TODO: Do we want to store the key?\n+        //options.put(\"storeKey\", \"true\");\n+        options.put(\"useKeyTab\", \"true\");\n+        // If no keytab path specified, still set useKeyTab=true because then the\n+        // default JDK or default OS locations will be checked\n+        if (keytab != null) {\n+            options.put(\"keyTab\", keytab.toAbsolutePath().toString());\n+        }\n+        options.put(\"principal\", principal);\n+        if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n+            options.put(\"debug\", \"true\");\n+            Tr.debug(tc, \"All kerberos config properties are: \" + options);\n+        }\n+\n+        krb5.initialize(subject, null, sharedState, options);\n+        krb5.login();\n+        krb5.commit();\n+\n+        // If the created Subject does not have a GSSCredential, then create one and\n+        // associate it with the Subject", "originalCommit": "7a6eaeb6e538965622baa99ad523efb93845b688", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5MTAwNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r447091004", "bodyText": "@utle the goal of this code block is to ensure that a GSSCredential is associated with the Subject after the method exits, because the JDBC code expects to find a GSSCredential on the subject later on. To accomplish this, first I needed to check if there was already a GSSCred on the subject, and if it's not already there, then we do call SubjectHelper.getGSSCredentialFromSubject(subject); on line 200 and add that GSSCredential to the subject.", "author": "aguibert", "createdAt": "2020-06-29T16:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxMzI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxODQ3OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r447018479", "bodyText": "If you specify the default location and name, then we need a complete list of OS .\nDo we plan to support variable name?", "author": "utle", "createdAt": "2020-06-29T14:33:55Z", "path": "dev/com.ibm.ws.security.auth.data.common/resources/OSGI-INF/l10n/metatype.properties", "diffHunk": "@@ -32,3 +32,14 @@ enabled.desc=Enables the authentication data subject cache.\n \n maxSize=Maximum cache size\n maxSize.desc=Maximum number of entries supported by the authentication data subject cache.\n+\n+#======= KERBEROS SETTINGS =========\n+# Do not translate: Kerberos, principal\n+krb5Principal=Kerberos principal name\n+krb5Principal.desc=The name of the principal to be used. The principal can be a simple username or a service name.\n+\n+# Do not translate: Kerberos, keytab, principal, {user.home}/krb5.keytab\n+krb5Keytab=Kerberos keytab file\n+krb5Keytab.desc=The path of the keytab file that is used to obtain the principal's secret key. If unspecified, the keytab from \\", "originalCommit": "7a6eaeb6e538965622baa99ad523efb93845b688", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzODc1OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r447038758", "bodyText": "I checked in the JDK code, and the Login Module checks the Java System property user.home and user.dir regardless of OS.", "author": "mswatosh", "createdAt": "2020-06-29T15:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxODQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA4NzQyMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r447087420", "bodyText": "Yes, this is mostly copied/paraphrased from the JDK documentation, which is what we ultimately delegate to", "author": "aguibert", "createdAt": "2020-06-29T16:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxODQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxMzY0Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12774#discussion_r447013647", "bodyText": "Basic is spelled wrong", "author": "mswatosh", "createdAt": "2020-06-29T14:27:31Z", "path": "dev/com.ibm.ws.jdbc_fat_krb5/test-applications/db2fat/src/db2/web/JDBCKerberosTestServlet.java", "diffHunk": "@@ -41,10 +57,36 @@ public void testNonKerberosConnectionRejected() throws Exception {\n         }\n     }\n \n-    public void testKerberosConnection() throws Exception {\n-        try (Connection con = ds.getConnection()) {\n+    @Test\n+    public void testKerberosBaiscConnection() throws Exception {", "originalCommit": "7a6eaeb6e538965622baa99ad523efb93845b688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "22099fadd6a5dc0dcef4f0a1674b98eb19da889c", "url": "https://github.com/OpenLiberty/open-liberty/commit/22099fadd6a5dc0dcef4f0a1674b98eb19da889c", "message": "Split Krb5LoginModuleWrapper into separate bundle", "committedDate": "2020-06-30T02:21:33Z", "type": "forcePushed"}, {"oid": "a04b64e684e0a44144365b7edca3462b3d002cec", "url": "https://github.com/OpenLiberty/open-liberty/commit/a04b64e684e0a44144365b7edca3462b3d002cec", "message": "Split Krb5LoginModuleWrapper into separate bundle", "committedDate": "2020-06-30T02:23:49Z", "type": "commit"}, {"oid": "a04b64e684e0a44144365b7edca3462b3d002cec", "url": "https://github.com/OpenLiberty/open-liberty/commit/a04b64e684e0a44144365b7edca3462b3d002cec", "message": "Split Krb5LoginModuleWrapper into separate bundle", "committedDate": "2020-06-30T02:23:49Z", "type": "forcePushed"}]}