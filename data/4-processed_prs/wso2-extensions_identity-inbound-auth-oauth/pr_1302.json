{"pr_number": 1302, "pr_title": "OIDC Scope Management REST APIs upon one single Scope management table", "pr_createdAt": "2020-01-24T09:47:44Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302", "timeline": [{"oid": "1127870495238f9a00004490c0688fb6cff6758b", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1127870495238f9a00004490c0688fb6cff6758b", "message": "Single scope table for OAuth2 scope binding and OIDC scope.", "committedDate": "2020-01-14T09:41:33Z", "type": "commit"}, {"oid": "d933323ac565428001293e595697f65abff8f306", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/d933323ac565428001293e595697f65abff8f306", "message": "Includ proper exception handling in scope mgt", "committedDate": "2020-01-16T16:09:18Z", "type": "commit"}, {"oid": "4bd2c5e8c0d7148bc7bdcf086abf2e03fbe21f53", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/4bd2c5e8c0d7148bc7bdcf086abf2e03fbe21f53", "message": "fix list scope depends on endpoint.", "committedDate": "2020-01-16T18:44:22Z", "type": "commit"}, {"oid": "325138048a07e770e70f7971580657c115e8e503", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/325138048a07e770e70f7971580657c115e8e503", "message": "refactored", "committedDate": "2020-01-17T06:04:38Z", "type": "commit"}, {"oid": "02c5d72f7237fa0231f9dca7bdafd34e2aec9302", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/02c5d72f7237fa0231f9dca7bdafd34e2aec9302", "message": "Clear the both binding cache and oidc cache before updating an scope.", "committedDate": "2020-01-17T08:12:37Z", "type": "commit"}, {"oid": "46212ce62c2a35fbdbde558e49ddcdd49ca98250", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/46212ce62c2a35fbdbde558e49ddcdd49ca98250", "message": "reimplement scope mgt by having new column SCOPE_TYPE in IDN_OAUTH2_SCOPE table.", "committedDate": "2020-01-24T05:05:38Z", "type": "commit"}, {"oid": "9405960208d044910527ef20f94ad06c073fd346", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/9405960208d044910527ef20f94ad06c073fd346", "message": "Fix review comments.", "committedDate": "2020-01-24T09:50:16Z", "type": "forcePushed"}, {"oid": "8ba209a2d1afcd8947c277f89183cc21cccb74a8", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/8ba209a2d1afcd8947c277f89183cc21cccb74a8", "message": "Fix review comments.", "committedDate": "2020-01-24T09:52:16Z", "type": "commit"}, {"oid": "8ba209a2d1afcd8947c277f89183cc21cccb74a8", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/8ba209a2d1afcd8947c277f89183cc21cccb74a8", "message": "Fix review comments.", "committedDate": "2020-01-24T09:52:16Z", "type": "forcePushed"}, {"oid": "e41e40d0624358539f172d2c69909319e047dc8a", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/e41e40d0624358539f172d2c69909319e047dc8a", "message": "fix scope related test failures.", "committedDate": "2020-01-26T09:39:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3Mzg5OQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371073899", "bodyText": "Can we pass the scope name here instead of null?", "author": "janakamarasena", "createdAt": "2020-01-27T06:08:10Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/OAuth2ScopeService.java", "diffHunk": "@@ -294,4 +261,94 @@ public Scope updateScope(Scope updatedScope) throws IdentityOAuth2ScopeException\n         }\n         return scopes;\n     }\n+\n+    /**\n+     * Scope validation before adding the scope.\n+     *\n+     * @param scope Scope.\n+     * @throws IdentityOAuth2ScopeClientException\n+     */\n+    private void addScopePreValidation(Scope scope) throws IdentityOAuth2ScopeClientException {\n+\n+        validateScopeName(scope.getName());\n+        validateDisplayName(scope.getDisplayName());\n+    }\n+\n+    /**\n+     * Do the validation before updating the scope.\n+     *\n+     * @param updatedScope Updated scope.\n+     * @throws IdentityOAuth2ScopeClientException\n+     */\n+    private void updateScopePreValidation(Scope updatedScope) throws IdentityOAuth2ScopeClientException {\n+\n+        validateScopeName(updatedScope.getName());\n+        validateDisplayName(updatedScope.getDisplayName());\n+    }\n+\n+    /**\n+     * Check whether scope name is provided or not.\n+     *\n+     * @param scopeName Scope name.\n+     * @throws IdentityOAuth2ScopeClientException\n+     */\n+    private void validateScopeName(String scopeName) throws IdentityOAuth2ScopeClientException {\n+\n+        // Check whether the scope name is provided.\n+        if (StringUtils.isBlank(scopeName)) {\n+            throw Oauth2ScopeUtils.generateClientException(Oauth2ScopeConstants.ErrorMessages.\n+                    ERROR_CODE_BAD_REQUEST_SCOPE_NAME_NOT_SPECIFIED, null);\n+        }\n+        validateWhiteSpaces(scopeName);\n+    }\n+\n+    /**\n+     * Check whether scope name contains any white spaces.\n+     *\n+     * @param scopeName Scope name.\n+     * @throws IdentityOAuth2ScopeClientException\n+     */\n+    private void validateWhiteSpaces(String scopeName) throws IdentityOAuth2ScopeClientException {\n+\n+        // Check whether the scope name contains any white spaces.\n+        Pattern pattern = Pattern.compile(\"\\\\s\");\n+        Matcher matcher = pattern.matcher(scopeName);\n+        boolean foundWhiteSpace = matcher.find();\n+\n+        if (foundWhiteSpace) {\n+            throw Oauth2ScopeUtils.generateClientException(Oauth2ScopeConstants.ErrorMessages.\n+                    ERROR_CODE_BAD_REQUEST_SCOPE_NAME_CONTAINS_WHITESPACES, null);", "originalCommit": "e41e40d0624358539f172d2c69909319e047dc8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE4MDE3Nw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371180177", "bodyText": "+1", "author": "IsuraD", "createdAt": "2020-01-27T11:09:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3Mzg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NTcxMQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371595711", "bodyText": "fixed", "author": "sarubi", "createdAt": "2020-01-28T03:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3Mzg5OQ=="}], "type": "inlineReview"}, {"oid": "6d9f57faa0f38a06e6b28d14be7d6eda9b3b1906", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/6d9f57faa0f38a06e6b28d14be7d6eda9b3b1906", "message": "Merge branch 'master' of https://github.com/wso2-extensions/identity-inbound-auth-oauth into scope-mgt-public", "committedDate": "2020-01-27T09:44:58Z", "type": "commit"}, {"oid": "13694644cf0b505e90a29ec7d48e8081ef9190f2", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/13694644cf0b505e90a29ec7d48e8081ef9190f2", "message": "Add carbon database utils dependancy.", "committedDate": "2020-01-27T09:46:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE2OTE2Ng==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371169166", "bodyText": "make this private", "author": "IsuraD", "createdAt": "2020-01-27T10:44:10Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/openidconnect/dao/ScopeClaimMappingDAOImpl.java", "diffHunk": "@@ -408,28 +515,35 @@ private void insertClaims(int tenantId, int scopeId, Set<String> claimsList) thr\n                 return null;\n             });\n         } catch (TransactionException e) {\n-            String errorMessage = \"Error when storing oidc claims for tenant: \" + tenantId;\n+            String errorMessage = String.format(\"Error when storing oidc claims for scope ID: %s for tenant: %s\",\n+                    scopeId, tenantId);\n             throw new IdentityOAuth2Exception(errorMessage, e);\n         }\n     }\n \n-    private List<ScopeDTO> buildScopeDTO(Map<String, List<String>> scopeClaimMap, int tenantId) {\n-\n-        List<ScopeDTO> oidcScopeClaimList = new ArrayList<>();\n-        for (Map.Entry<String, List<String>> scopeClaimEntry : scopeClaimMap.entrySet()) {\n-            ScopeDTO scopeDTO = new ScopeDTO();\n-            String scopeName = scopeClaimEntry.getKey();\n-            List<String> claimsList = scopeClaimEntry.getValue();\n-            scopeDTO.setName(scopeClaimEntry.getKey());\n-            if (CollectionUtils.isNotEmpty(claimsList)) {\n-                scopeDTO.setClaim(claimsList.toArray(new String[claimsList.size()]));\n-            }\n-            oidcScopeClaimList.add(scopeDTO);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"The scope: \" + scopeName + \" and the claims: \" + String.join(\",\", claimsList)\n-                        + \" are successfully loaded for the tenant: \" + tenantId);\n-            }\n+    /**\n+     * Update scope details on IDN_OAUTH2_SCOPE scope table.\n+     *\n+     * @param updatedScope Updated scope.\n+     * @param tenantId     Tenant ID.\n+     * @param jdbcTemplate JDBC template.\n+     * @param scopeId      Scope ID.\n+     * @throws DataAccessException\n+     */\n+    public void updateScopeDetails(ScopeDTO updatedScope, int tenantId, JdbcTemplate jdbcTemplate,", "originalCommit": "e41e40d0624358539f172d2c69909319e047dc8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTIwNjA1NQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371206055", "bodyText": "fixed", "author": "sarubi", "createdAt": "2020-01-27T12:11:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE2OTE2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE4MzAxNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371183017", "bodyText": "Better to use scopeID to delete and add the binding.", "author": "IsuraD", "createdAt": "2020-01-27T11:16:25Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/dao/OAuthScopeDAOImpl.java", "diffHunk": "@@ -444,13 +456,15 @@ public void deleteScopeByName(String name, int tenantID) throws IdentityOAuth2Sc\n     public void updateScopeByName(Scope updatedScope, int tenantID) throws IdentityOAuth2ScopeServerException {\n \n         if (log.isDebugEnabled()) {\n-            log.debug(\"Updae scope by name for scope name:\" + updatedScope.getName());\n+            log.debug(\"Update scope by name for scope name:\" + updatedScope.getName());\n         }\n \n         try (Connection conn = IdentityDatabaseUtil.getDBConnection()) {\n             try {\n-                deleteScope(updatedScope.getName(), tenantID, conn);\n-                addScope(updatedScope, conn, tenantID);\n+                int scopeId = getScopeId(updatedScope.getName(), tenantID, conn);\n+                updateScopeDetails(updatedScope, conn, scopeId);\n+                deleteBindings(updatedScope.getName(), tenantID, conn);", "originalCommit": "c5b7172144c7cab95ce8d2f86d1761afaf4f0ba4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NTczNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371595737", "bodyText": "fixed", "author": "sarubi", "createdAt": "2020-01-28T03:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE4MzAxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5MzgwNA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371193804", "bodyText": "We might not be able to successfully say that scope does not exist from this validation. In a concurrent scenario, if the resource is existing while executing this check and while trying to delete the resource actually, it might have been deleted from another delete request. While it does not break any functionality for the delete operation, it might introduce inconsistencies.\nThis becomes more tricky for other operations.", "author": "madurangasiriwardena", "createdAt": "2020-01-27T11:41:19Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -508,11 +562,18 @@ public void addScope(String scope, String[] claims) throws IdentityOAuthAdminExc\n      */\n     public void deleteScope(String scope) throws IdentityOAuthAdminException {\n \n+        validateScopeName(scope);\n+        // Check whether a scope exists with the provided scope name which to be deleted.\n+        validateScopeExistence(scope);", "originalCommit": "c5b7172144c7cab95ce8d2f86d1761afaf4f0ba4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTIxMTQyNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371211427", "bodyText": "yes, there are cases that we need to handle the concurrent scenarios properly. As per the offline discussion for the moment keep as it is and we'll address this later.", "author": "sarubi", "createdAt": "2020-01-27T12:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5MzgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5ODgxMg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371198812", "bodyText": "The same methods are implemented in OAuthAdminServiceImpl as well. Can we get rid of one implementation and invoke the other service's method.", "author": "madurangasiriwardena", "createdAt": "2020-01-27T11:53:53Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/OAuth2ScopeService.java", "diffHunk": "@@ -193,19 +181,11 @@ public boolean isScopeExists(String name) throws IdentityOAuth2ScopeException {\n      */\n     public void deleteScope(String name) throws IdentityOAuth2ScopeException {\n \n-        int tenantID = Oauth2ScopeUtils.getTenantID();\n-        if (name == null) {\n-            throw Oauth2ScopeUtils.generateClientException(Oauth2ScopeConstants.ErrorMessages.\n-                    ERROR_CODE_BAD_REQUEST_SCOPE_NAME_NOT_SPECIFIED, null);\n-        }\n-\n-        // check whether a scope exists with the provided scope name which to be deleted\n-        boolean isScopeExists = isScopeExists(name);\n-        if (!isScopeExists) {\n-            throw Oauth2ScopeUtils.generateClientException(Oauth2ScopeConstants.ErrorMessages.\n-                    ERROR_CODE_NOT_FOUND_SCOPE, name);\n-        }\n+        validateScopeName(name);", "originalCommit": "c5b7172144c7cab95ce8d2f86d1761afaf4f0ba4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTIwNzI1Nw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371207257", "bodyText": "Even though the names of the methods are same but internal logic is different, two different OSGI services hence keep as it is with two methods.", "author": "sarubi", "createdAt": "2020-01-27T12:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5ODgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5OTg5Mg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371199892", "bodyText": "don't we need to break the loop from here?", "author": "madurangasiriwardena", "createdAt": "2020-01-27T11:56:36Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/openidconnect/dao/CacheBackedScopeClaimMappingDAOImpl.java", "diffHunk": "@@ -135,4 +156,18 @@ private OIDCScopeClaimCacheEntry loadOIDCScopeClaims(int tenantId, OIDCScopeClai\n         }\n         return oidcScopeClaimCacheEntry;\n     }\n+\n+    @Override\n+    public ScopeDTO getScope(String scopeName, int tenantId) throws IdentityOAuth2Exception {\n+\n+        OIDCScopeClaimCacheEntry oidcScopeClaimCacheEntry = oidcScopeClaimCache.getScopeClaimMap(tenantId);\n+        oidcScopeClaimCacheEntry = loadOIDCScopeClaims(tenantId, oidcScopeClaimCacheEntry);\n+        ScopeDTO scopeDTO = null;\n+        for (ScopeDTO scopeObj : oidcScopeClaimCacheEntry.getScopeClaimMapping()) {\n+            if (scopeName.equals(scopeObj.getName())) {\n+                scopeDTO = scopeObj;", "originalCommit": "c5b7172144c7cab95ce8d2f86d1761afaf4f0ba4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5NDMyOA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1302#discussion_r371594328", "bodyText": "Fxied", "author": "sarubi", "createdAt": "2020-01-28T03:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE5OTg5Mg=="}], "type": "inlineReview"}, {"oid": "c2caaa0d9cfbe323efc56450653640b447e36382", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/c2caaa0d9cfbe323efc56450653640b447e36382", "message": "Fix review comment", "committedDate": "2020-01-28T03:25:07Z", "type": "forcePushed"}, {"oid": "e80db12feb5d7c1996abf1df399a91c335e00245", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/e80db12feb5d7c1996abf1df399a91c335e00245", "message": "Fix review comment", "committedDate": "2020-01-28T03:33:44Z", "type": "forcePushed"}, {"oid": "4dd5b36332ce960d67ac66ed1135d2930b5b5ae9", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/4dd5b36332ce960d67ac66ed1135d2930b5b5ae9", "message": "Fix review comment", "committedDate": "2020-01-28T11:17:46Z", "type": "commit"}, {"oid": "4dd5b36332ce960d67ac66ed1135d2930b5b5ae9", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/4dd5b36332ce960d67ac66ed1135d2930b5b5ae9", "message": "Fix review comment", "committedDate": "2020-01-28T11:17:46Z", "type": "forcePushed"}]}