{"pr_number": 8741, "pr_title": "MULE-18200: 4.3.0: expression errors hang MUnit test execution", "pr_createdAt": "2020-03-18T19:40:42Z", "pr_url": "https://github.com/mulesoft/mule/pull/8741", "timeline": [{"oid": "247ac0b415042445d44b7dbbd3f4218df17b404d", "url": "https://github.com/mulesoft/mule/commit/247ac0b415042445d44b7dbbd3f4218df17b404d", "message": "MULE-18200: 4.3.0: readUrl getting blocked when file resource is not\npresent", "committedDate": "2020-03-18T19:38:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NjI0NA==", "url": "https://github.com/mulesoft/mule/pull/8741#discussion_r394596244", "bodyText": "is it correct to throw the exception even if the if resolved to true and the errorSink received the next() call?", "author": "marianogonzalez", "createdAt": "2020-03-18T19:42:33Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/operation/ComponentMessageProcessor.java", "diffHunk": "@@ -311,8 +311,25 @@ public CoreEvent process(CoreEvent event) throws MuleException {\n             .map(event -> {\n               try {\n                 return addContextToEvent(event, ctx);\n-              } catch (MuleException t) {\n-                throw propagateWrappingFatal(localOperatorErrorHook.apply(t, event));\n+              } catch (Exception t) {\n+                // Force the error mapper from the chain to be used.\n+                // When using Mono.create with sink.error, the error mapper from the\n+                // context is ignored, so it has to be explicitly used here.\n+                final Throwable mapped = localOperatorErrorHook.apply(t, event);\n+\n+                if (outerFluxTerminationTimeout < 0\n+                    // When there is a mono involved in some part of the chain, we cannot use the termination timeout because that\n+                    // would\n+                    // impose a timeout in the operation, which we don't want to.\n+                    // In this case, the flux will be complete when there are no more inflight operations.\n+                    || ctx.getOrDefault(WITHIN_PROCESS_TO_APPLY, false)) {\n+                  // if `sink.error` is called here, it will cancel the flux altogether.\n+                  // That's why an `Either` is used here,\n+                  // so the error can be propagated afterwards in a way consistent with our expected error handling.\n+                  errorSwitchSinkSinkRef.next(left(mapped, CoreEvent.class));\n+                }\n+\n+                throw propagateWrappingFatal(mapped);", "originalCommit": "247ac0b415042445d44b7dbbd3f4218df17b404d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NzM2NA==", "url": "https://github.com/mulesoft/mule/pull/8741#discussion_r394597364", "bodyText": "yes, it will depend on what pipeline is using this component to determine if the exception is needed (Monos) or the result in the callback (Fluxes). In either case, it is a map, so it needs to return a mapped event, or in this case propagate the exception.", "author": "elrodro83", "createdAt": "2020-03-18T19:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NjI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5ODk3OA==", "url": "https://github.com/mulesoft/mule/pull/8741#discussion_r394598978", "bodyText": "ok.. i'll trust you... but I'm looking at you with suspicious eyes...\nhttps://i.pinimg.com/originals/48/4f/42/484f42995f748050bd50574d42aa0610.gif", "author": "marianogonzalez", "createdAt": "2020-03-18T19:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NjI0NA=="}], "type": "inlineReview"}]}