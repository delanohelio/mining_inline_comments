{"pr_number": 8771, "pr_title": "MULE-18244: Connectors that use third-party libraries that create cus\u2026", "pr_createdAt": "2020-04-01T21:26:21Z", "pr_url": "https://github.com/mulesoft/mule/pull/8771", "timeline": [{"oid": "5ae7e862c67b379382c3420cef35e9376790b04e", "url": "https://github.com/mulesoft/mule/commit/5ae7e862c67b379382c3420cef35e9376790b04e", "message": "MULE-18244: Connectors that use third-party libraries that create custom classloader are not able to load classes if they rely on loadClass(s,b) from CompositeClassLoader", "committedDate": "2020-04-01T21:23:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNTkyMA==", "url": "https://github.com/mulesoft/mule/pull/8771#discussion_r401925920", "bodyText": "i think the two methods should be overriddes, and the resolve flag should be also propagated to the delegated loadClass, right?", "author": "elrodro83", "createdAt": "2020-04-01T21:39:22Z", "path": "core/src/main/java/org/mule/runtime/core/internal/util/CompositeClassLoader.java", "diffHunk": "@@ -44,8 +44,18 @@ public CompositeClassLoader(ClassLoader first, ClassLoader... others) {\n     delegates = unmodifiableList(delegates);\n   }\n \n+  /**\n+   * Overrides the loadClass in order to support scenarios where a custom class loader is created in a plugin\n+   * and these calls to this method explicitly.\n+   * We cannot resolve the class at this point as we should delegate to protected methods and it is no possible.\n+   *\n+   * @param name    The <a href=\"#name\">binary name</a> of the class\n+   * @param resolve If <tt>true</tt> then resolve the class\n+   * @return The resulting <tt>Class</tt> object\n+   * @throws ClassNotFoundException If the class could not be found\n+   */\n   @Override\n-  public Class<?> loadClass(String name) throws ClassNotFoundException {\n+  public Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {", "originalCommit": "5ae7e862c67b379382c3420cef35e9376790b04e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3MDkzNQ==", "url": "https://github.com/mulesoft/mule/pull/8771#discussion_r401970935", "bodyText": "The loadClass(name) in ClassLoader delegates to the loadClass(name, resolve=false) so no need to override that method. Problem with the resolve as explained in the other PR is that the method is protected therefore we cannot call it on the list of delegates. So, we will just not support the resolve=true meaning that it will be a way to load classes eagerly. This is used in some frameworks but it should not affect to us.", "author": "gsfernandes", "createdAt": "2020-04-01T23:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNTkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NjgwMQ==", "url": "https://github.com/mulesoft/mule/pull/8771#discussion_r401996801", "bodyText": "It is not clear to me yet what the resolve will do as according to javadoc:\n\"Links the specified class. This (misleadingly named) method may be used by a class loader to link a class\". So, I ended up checking what we are doing in our ClassLoaders and found that the FineGrainControlClassLoader has kind of the same dilemma:\nIt implements the loadClass(name, resolve) method but checks for the lookPolicy, this will give him a classloader to delegate the load of the class, for instance you are at P1 CL and try load a class from application so the P1 CL will get from lookupPolicy the APP CL and call the loadClass(name) method and then P1 CL will do the the call to resolveClass(clazz).\nloadClass(name, resolve)-> https://github.com/mulesoft/mule/blob/mule-4.2.2/modules/artifact/src/main/java/org/mule/runtime/module/artifact/api/classloader/FineGrainedControlClassLoader.java#L67\nThen if the policy returns a different class loader it will call its loadClass(name)\nhttps://github.com/mulesoft/mule/blob/mule-4.2.2/modules/artifact/src/main/java/org/mule/runtime/module/artifact/api/classloader/FineGrainedControlClassLoader.java#L93\nFinally the loadClass(name, resolve) method will do the resolve no matter if the class was actually loaded with this class loader or other:\nhttps://github.com/mulesoft/mule/blob/mule-4.2.2/modules/artifact/src/main/java/org/mule/runtime/module/artifact/api/classloader/FineGrainedControlClassLoader.java#L110\nSo, the conclusion is I would push another change to call the resolveClass to the class resolved and no need to implement loadClass(name) only as it delegates to loadClass(name, resolve).", "author": "gsfernandes", "createdAt": "2020-04-02T01:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkyNTkyMA=="}], "type": "inlineReview"}, {"oid": "a5a2600c3dfbe073777b4eacbf801fedd27c0761", "url": "https://github.com/mulesoft/mule/commit/a5a2600c3dfbe073777b4eacbf801fedd27c0761", "message": "Resolve class", "committedDate": "2020-04-02T01:07:26Z", "type": "commit"}]}