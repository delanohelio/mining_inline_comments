{"pr_number": 9398, "pr_title": "MULE-18752: Visitable classes must never be returned in decorators fo\u2026", "pr_createdAt": "2020-09-10T21:52:07Z", "pr_url": "https://github.com/mulesoft/mule/pull/9398", "timeline": [{"oid": "20e0ff7b999310f74a50c74b4bcd46567046c8c1", "url": "https://github.com/mulesoft/mule/commit/20e0ff7b999310f74a50c74b4bcd46567046c8c1", "message": "MULE-18752: Visitable classes must never be returned in decorators for\nstats", "committedDate": "2020-09-11T02:05:39Z", "type": "commit"}, {"oid": "20e0ff7b999310f74a50c74b4bcd46567046c8c1", "url": "https://github.com/mulesoft/mule/commit/20e0ff7b999310f74a50c74b4bcd46567046c8c1", "message": "MULE-18752: Visitable classes must never be returned in decorators for\nstats", "committedDate": "2020-09-11T02:05:39Z", "type": "forcePushed"}, {"oid": "3ac528d56da65e873dba6102f573b4b0d4a83dcf", "url": "https://github.com/mulesoft/mule/commit/3ac528d56da65e873dba6102f573b4b0d4a83dcf", "message": "MULE-18752: Fix", "committedDate": "2020-09-11T16:49:25Z", "type": "commit"}, {"oid": "9f39b46c7bb8fa55fbfb404efad50a59176e7d06", "url": "https://github.com/mulesoft/mule/commit/9f39b46c7bb8fa55fbfb404efad50a59176e7d06", "message": "MULE-18752: Fix", "committedDate": "2020-09-11T18:02:14Z", "type": "forcePushed"}, {"oid": "a89cf8970a38b71bb93f142a1af1581f8bf2367d", "url": "https://github.com/mulesoft/mule/commit/a89cf8970a38b71bb93f142a1af1581f8bf2367d", "message": "MULE-18752: Fix", "committedDate": "2020-09-11T18:06:11Z", "type": "forcePushed"}, {"oid": "d7ab820f9628a79bff271ca2d123813cef286f4b", "url": "https://github.com/mulesoft/mule/commit/d7ab820f9628a79bff271ca2d123813cef286f4b", "message": "MULE-18752: Fix", "committedDate": "2020-09-11T19:46:45Z", "type": "commit"}, {"oid": "d7ab820f9628a79bff271ca2d123813cef286f4b", "url": "https://github.com/mulesoft/mule/commit/d7ab820f9628a79bff271ca2d123813cef286f4b", "message": "MULE-18752: Fix", "committedDate": "2020-09-11T19:46:45Z", "type": "forcePushed"}, {"oid": "473f4e854511d3f02ed331440faebe01bf8cceed", "url": "https://github.com/mulesoft/mule/commit/473f4e854511d3f02ed331440faebe01bf8cceed", "message": "avoid new formatting in jdoc.", "committedDate": "2020-09-11T20:20:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3Mjc3OQ==", "url": "https://github.com/mulesoft/mule/pull/9398#discussion_r487272779", "bodyText": "remove empty lines", "author": "elrodro83", "createdAt": "2020-09-11T20:24:21Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/management/stats/PayloadStatisticsTestCase.java", "diffHunk": "@@ -703,6 +710,53 @@ public void decorateOutputResultIterator() throws IOException {\n     assertThat(statistics.getInputObjectCount(), is(0L));\n   }\n \n+  @Test\n+  public void decorateInputCursorStreamReturnsCursorStreamStatsEnabled() {\n+    verifyDecoratedCursorStreamIsCursorStream(true, decorateInputOperation(CORR_ID,\n+                                                                           decoratorFactory\n+                                                                               .componentDecoratorFactory(component1)));\n+  }\n+\n+  @Test\n+  public void decorateInputCursorStreamReturnsCursorStreamStatsDisabled() {\n+    verifyDecoratedCursorStreamIsCursorStream(false,\n+                                              decorateInputOperation(CORR_ID,\n+                                                                     decoratorFactory.componentDecoratorFactory(component1)));\n+  }\n+\n+  @Test\n+  public void decorateOuputCursorStreamReturnsCursorStreamStatsEnabled() {\n+    verifyDecoratedCursorStreamIsCursorStream(true, decorateInputOperation(CORR_ID,\n+                                                                           decoratorFactory\n+                                                                               .componentDecoratorFactory(component1)));\n+  }\n+\n+  @Test\n+  public void decorateOutputCursorStreamReturnsCursorStreamStatsDisabled() {\n+    verifyDecoratedCursorStreamIsCursorStream(false,\n+                                              decorateOutputOperation(CORR_ID,\n+                                                                      decoratorFactory\n+                                                                          .componentDecoratorFactory(component1)));\n+  }\n+\n+  @Test\n+  public void decorateOutputCursorStreamReturnsCursorStreamStatsEnabled() {\n+    verifyDecoratedCursorStreamIsCursorStream(true,\n+                                              decorateOutputOperation(CORR_ID,\n+                                                                      decoratorFactory\n+                                                                          .componentDecoratorFactory(component1)));\n+  }\n+\n+  private void verifyDecoratedCursorStreamIsCursorStream(boolean statEnabled, UnaryOperator decorationOperator) {\n+    getStatistics().setEnabled(statEnabled);\n+    InputStream cursorStream = new ByteArrayCursorStream(mock(CursorStreamProvider.class), \"Stream\".getBytes(UTF_8));\n+    InputStream decorated = (InputStream) decorationOperator.apply(cursorStream);\n+\n+    assertThat(decorated, instanceOf(CursorStream.class));\n+  }\n+\n+", "originalCommit": "473f4e854511d3f02ed331440faebe01bf8cceed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MzE0NQ==", "url": "https://github.com/mulesoft/mule/pull/9398#discussion_r487273145", "bodyText": "use else if", "author": "elrodro83", "createdAt": "2020-09-11T20:25:13Z", "path": "core/src/main/java/org/mule/runtime/core/internal/management/stats/StatisticsUtils.java", "diffHunk": "@@ -32,6 +33,10 @@\n    * @return a visitable wrapper of source. Empty if not a visitable class.\n    */\n   public static Optional<Visitable> visitable(Object source) {\n+    if (source instanceof CursorStream) {\n+      return of(new VisitableCursorStream((CursorStream) source));\n+    }", "originalCommit": "473f4e854511d3f02ed331440faebe01bf8cceed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "641073e9703274fe71956921e6cdfe73f598cb1d", "url": "https://github.com/mulesoft/mule/commit/641073e9703274fe71956921e6cdfe73f598cb1d", "message": "Review", "committedDate": "2020-09-11T20:30:00Z", "type": "commit"}]}