{"pr_number": 9340, "pr_title": "MULE-18726: Support new SDK Result in the ReturnDelegate implementations", "pr_createdAt": "2020-09-02T18:14:34Z", "pr_url": "https://github.com/mulesoft/mule/pull/9340", "timeline": [{"oid": "d181b84d53e123ceef40cadedbf3ee77ccb18154", "url": "https://github.com/mulesoft/mule/commit/d181b84d53e123ceef40cadedbf3ee77ccb18154", "message": "self review", "committedDate": "2020-09-02T20:20:48Z", "type": "forcePushed"}, {"oid": "72c8ae256b8acb05b9224db08c40f23ff2ca1a5b", "url": "https://github.com/mulesoft/mule/commit/72c8ae256b8acb05b9224db08c40f23ff2ca1a5b", "message": "MULE-18726: Support new SDK Result in the ReturnDelegate implementations", "committedDate": "2020-09-03T15:38:36Z", "type": "commit"}, {"oid": "78baba7511e61db6e2435db017e4cd1b66f6baa0", "url": "https://github.com/mulesoft/mule/commit/78baba7511e61db6e2435db017e4cd1b66f6baa0", "message": "self review", "committedDate": "2020-09-03T15:38:36Z", "type": "commit"}, {"oid": "00d85f471154aa5f15c77afaacff9152b19f66f5", "url": "https://github.com/mulesoft/mule/commit/00d85f471154aa5f15c77afaacff9152b19f66f5", "message": "formatter", "committedDate": "2020-09-03T15:38:36Z", "type": "commit"}, {"oid": "8abf0239ba4080f5835b7db5aad0069d2db03cbb", "url": "https://github.com/mulesoft/mule/commit/8abf0239ba4080f5835b7db5aad0069d2db03cbb", "message": "test fixes", "committedDate": "2020-09-03T20:56:51Z", "type": "commit"}, {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3", "url": "https://github.com/mulesoft/mule/commit/72aae3df5124fac839721c899a2fbf528e39f0b3", "message": "jdoc and moving packages", "committedDate": "2020-09-03T21:12:23Z", "type": "commit"}, {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3", "url": "https://github.com/mulesoft/mule/commit/72aae3df5124fac839721c899a2fbf528e39f0b3", "message": "jdoc and moving packages", "committedDate": "2020-09-03T21:12:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDM2NQ==", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483260365", "bodyText": "if transformAll was already called, this TransformingIterator isn't needed and adds overhead", "author": "elrodro83", "createdAt": "2020-09-03T21:20:15Z", "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -78,18 +69,28 @@ public boolean contains(Object o) {\n     readLock.lock();\n     try {\n       boolean contains = delegate.contains(o);\n-      if (!contains && o instanceof Message) {\n-        contains = delegate.contains(Result.builder((Message) o));\n+      if (!contains && isTargetInstance(o)) {\n+        readLock.unlock();\n+        writeLock.lock();\n+        try {\n+          contains = delegate.contains(o);\n+          if (!contains) {\n+            transformAll();\n+          }\n+        } finally {\n+          readLock.lock();\n+          writeLock.unlock();\n+        }\n       }\n-      return contains;\n+      return delegate.contains(o);\n     } finally {\n       readLock.unlock();\n     }\n   }\n \n   @Override\n-  public Iterator<Message> iterator() {\n-    return new ResultToMessageIterator(delegate.iterator(), cursorProviderFactory, eventContext, originatingLocation);\n+  public Iterator<T> iterator() {\n+    return new TransformingIterator<>(delegate.iterator(), transformer);", "originalCommit": "72aae3df5124fac839721c899a2fbf528e39f0b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDU2MA==", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483260560", "bodyText": "this applies to all menthods that do the transformation", "author": "elrodro83", "createdAt": "2020-09-03T21:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDM2NQ=="}], "type": "inlineReview"}, {"oid": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d", "url": "https://github.com/mulesoft/mule/commit/0eca667e360dd240d2ba1a8d0b85f8625adfdb5d", "message": "pr feedback", "committedDate": "2020-09-03T21:45:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NDI0NA==", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483274244", "bodyText": "make volatile", "author": "elrodro83", "createdAt": "2020-09-03T21:53:52Z", "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -4,53 +4,45 @@\n  * license, a copy of which has been included with this distribution in the\n  * LICENSE.txt file.\n  */\n-package org.mule.runtime.core.internal.util.message;\n+package org.mule.runtime.core.internal.util.collection;\n \n import static java.util.stream.Collectors.toList;\n \n-import org.mule.runtime.api.component.location.ComponentLocation;\n-import org.mule.runtime.api.message.Message;\n-import org.mule.runtime.core.api.streaming.CursorProviderFactory;\n-import org.mule.runtime.core.privileged.event.BaseEventContext;\n-import org.mule.runtime.extension.api.runtime.operation.Result;\n-\n import java.util.Collection;\n import java.util.Iterator;\n import java.util.Spliterator;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.function.Consumer;\n+import java.util.function.Function;\n import java.util.function.Predicate;\n import java.util.stream.Stream;\n \n /**\n- * Wraps a {@link Collection} of {@link Result} instances and exposes\n- * its contents as {@link Message} instances.\n- *\n- * This allows to avoid preemptive transformations of an entire collection\n- * of {@link Result} to {@link Message}\n+ * Decorates a {@link Collection} with items of random types and uses a {@link Function}\n+ * to guarantee that, when exposed, those items have been transformed.\n+ * <p>\n+ * This allows to lazily transform the items of the collection without making a full copy of the collection\n  *\n- * @since 4.0\n+ * @since 4.4.0\n  */\n-abstract class ResultsToMessageCollection implements Collection<Message> {\n+public abstract class TransformingCollection<T> implements Collection<T> {\n \n-  private final Collection<Object> delegate;\n-  protected final CursorProviderFactory cursorProviderFactory;\n-  protected final BaseEventContext eventContext;\n-  protected final ComponentLocation originatingLocation;\n+  private Collection<Object> delegate;\n+  protected final Class<T> targetType;\n+  protected final Function<Object, T> transformer;\n   protected final ReadWriteLock readWriteLock = new ReentrantReadWriteLock();\n   protected final Lock readLock = readWriteLock.readLock();\n   protected final Lock writeLock = readWriteLock.writeLock();\n+  protected boolean transformAllInvoked = false;", "originalCommit": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "01402db8b95b8b721b5a1aee6de6dd0a002ce35f", "url": "https://github.com/mulesoft/mule/commit/01402db8b95b8b721b5a1aee6de6dd0a002ce35f", "message": "fix missing case in return delegate", "committedDate": "2020-09-04T15:52:31Z", "type": "commit"}, {"oid": "0c106ec8b5ba051c48f69e977da6be755a13c05a", "url": "https://github.com/mulesoft/mule/commit/0c106ec8b5ba051c48f69e977da6be755a13c05a", "message": "fix test", "committedDate": "2020-09-04T16:32:19Z", "type": "commit"}]}