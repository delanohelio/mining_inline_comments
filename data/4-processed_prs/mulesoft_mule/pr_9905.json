{"pr_number": 9905, "pr_title": "MULE-19040: Allow apps to be redeployed without being started", "pr_createdAt": "2020-12-30T19:26:44Z", "pr_url": "https://github.com/mulesoft/mule/pull/9905", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2MjEzNw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558362137", "bodyText": "add javadoc", "author": "elrodro83", "createdAt": "2021-01-15T14:58:45Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/ArtifactStoppedListener.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.context;\n+\n+public interface ArtifactStoppedListener {", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2MjUwOA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558362508", "bodyText": "is this called before or after the start itself has happened? MAke this clear in the javadoc", "author": "elrodro83", "createdAt": "2021-01-15T14:59:18Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/ArtifactStoppedListener.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.context;\n+\n+public interface ArtifactStoppedListener {\n+\n+  /**\n+   * Notifies the starting of an artifact.", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2MjY2Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558362662", "bodyText": "is this called before or after the stop itself has happened? MAke this clear in the javadoc", "author": "elrodro83", "createdAt": "2021-01-15T14:59:29Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/ArtifactStoppedListener.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.context;\n+\n+public interface ArtifactStoppedListener {\n+\n+  /**\n+   * Notifies the starting of an artifact.\n+   */\n+  void onStart();\n+\n+  /**\n+   * Notifies the stopping of an artifact.", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2MzA2MA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558363060", "bodyText": "this wording is odd. Rephrase for clarity.", "author": "elrodro83", "createdAt": "2021-01-15T15:00:05Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/ArtifactStoppedListener.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.context;\n+\n+public interface ArtifactStoppedListener {\n+\n+  /**\n+   * Notifies the starting of an artifact.\n+   */\n+  void onStart();\n+\n+  /**\n+   * Notifies the stopping of an artifact.\n+   */\n+  void onStop();\n+\n+  /**\n+   * Selects persistance of the artifact's state", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2MzY4OQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558363689", "bodyText": "the presence of the mustPersist method in this interface makes me think that its name is more generic than the intended usage.", "author": "elrodro83", "createdAt": "2021-01-15T15:00:56Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/ArtifactStoppedListener.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.context;\n+\n+public interface ArtifactStoppedListener {", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2Mzg4Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558363882", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-15T15:01:14Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/DefaultMuleContext.java", "diffHunk": "@@ -357,6 +358,9 @@ public void start() throws MuleException {\n       fireNotification(new MuleContextNotification(this, CONTEXT_STARTED));\n       final org.mule.runtime.api.artifact.Registry apiRegistry = getApiRegistry();\n       listeners.forEach(l -> l.onStart(this, apiRegistry));\n+      Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+          Optional.ofNullable(getRegistry().lookupObject(ARTIFACT_STOPPED_LISTENER));", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NDM1Ng==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558364356", "bodyText": "no need to use the intermediate Optional just for this. a simple null check will do.", "author": "elrodro83", "createdAt": "2021-01-15T15:02:01Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/DefaultMuleContext.java", "diffHunk": "@@ -357,6 +358,9 @@ public void start() throws MuleException {\n       fireNotification(new MuleContextNotification(this, CONTEXT_STARTED));\n       final org.mule.runtime.api.artifact.Registry apiRegistry = getApiRegistry();\n       listeners.forEach(l -> l.onStart(this, apiRegistry));\n+      Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+          Optional.ofNullable(getRegistry().lookupObject(ARTIFACT_STOPPED_LISTENER));\n+      optionalArtifactStoppedListener.ifPresent(ArtifactStoppedListener::onStart);", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NDM4OA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558364388", "bodyText": "no need to use the intermediate Optional just for this. a simple null check will do.", "author": "elrodro83", "createdAt": "2021-01-15T15:02:04Z", "path": "core/src/main/java/org/mule/runtime/core/internal/context/DefaultMuleContext.java", "diffHunk": "@@ -414,6 +418,9 @@ public void stop() throws MuleException {\n \n       final org.mule.runtime.api.artifact.Registry apiRegistry = getApiRegistry();\n       listeners.forEach(l -> l.onStop(this, apiRegistry));\n+      Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+          Optional.ofNullable(getRegistry().lookupObject(ARTIFACT_STOPPED_LISTENER));\n+      optionalArtifactStoppedListener.ifPresent(ArtifactStoppedListener::onStop);", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NDc0OA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558364748", "bodyText": "there doesn't seem to be any change in this class to add this import for", "author": "elrodro83", "createdAt": "2021-01-15T15:02:40Z", "path": "modules/deployment-model-impl/src/main/java/org/mule/runtime/module/deployment/impl/internal/application/DefaultMuleApplication.java", "diffHunk": "@@ -43,6 +43,7 @@\n import org.mule.runtime.core.api.context.notification.MuleContextListener;\n import org.mule.runtime.core.api.context.notification.MuleContextNotification;\n import org.mule.runtime.core.api.context.notification.MuleContextNotificationListener;\n+import org.mule.runtime.core.internal.context.DefaultMuleContext;", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NTAzMQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558365031", "bodyText": "is this something that can really happen?", "author": "elrodro83", "createdAt": "2021-01-15T15:03:07Z", "path": "modules/deployment-model-impl/src/main/java/org/mule/runtime/module/deployment/impl/internal/artifact/ArtifactFactoryUtils.java", "diffHunk": "@@ -96,7 +96,7 @@ public static void withArtifactMuleContext(DeployableArtifact artifact, CheckedC\n    * @since 4.2\n    */\n   public static Optional<MuleContext> getMuleContext(DeployableArtifact artifact) {\n-    return artifact != null ? artifact.getRegistry().lookupByType(MuleContext.class) : empty();\n+    return artifact != null && artifact.getRegistry() != null ? artifact.getRegistry().lookupByType(MuleContext.class) : empty();", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MDczMQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562640731", "bodyText": "still open", "author": "elrodro83", "createdAt": "2021-01-22T13:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzcwMzE1MQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r563703151", "bodyText": "The reasoning behind adding this additional check is the same as here. Since getRegistry() can return null I think this method could eventually throw a NullPointerException", "author": "sofiamorseletto", "createdAt": "2021-01-25T12:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NTAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NTExNQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558365115", "bodyText": "there doesn't seem to be any change in this class to add this import for", "author": "elrodro83", "createdAt": "2021-01-15T15:03:16Z", "path": "modules/deployment-model-impl/src/main/java/org/mule/runtime/module/deployment/impl/internal/domain/DefaultMuleDomain.java", "diffHunk": "@@ -31,6 +31,7 @@\n import org.mule.runtime.api.service.ServiceRepository;\n import org.mule.runtime.api.value.ValueProviderService;\n import org.mule.runtime.core.api.context.notification.MuleContextListener;\n+import org.mule.runtime.core.internal.context.DefaultMuleContext;", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NTkwOA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558365908", "bodyText": "use the interface (ArtifactStoppedListener) in the var declaration, not the impl", "author": "elrodro83", "createdAt": "2021-01-15T15:04:35Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArtifactDeployer.java", "diffHunk": "@@ -29,9 +36,16 @@ public void deploy(T artifact, boolean startArtifact) {\n     try {\n       artifact.install();\n       doInit(artifact);\n-      if (startArtifact) {\n+      if (startArtifact && shouldStartArtifact(artifact)) {\n         artifact.start();\n       }\n+\n+      ArtifactStoppedDeploymentListener artifactStoppedDeploymentListener =", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NTk2OA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558365968", "bodyText": "use the interface (ArtifactStoppedListener) in the var declaration, not the impl", "author": "elrodro83", "createdAt": "2021-01-15T15:04:42Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DeploymentDirectoryWatcher.java", "diffHunk": "@@ -80,28 +83,27 @@\n    * Property used to change the deployment mode to deploy only the indicated applications with no redeployment.\n    * mule -M-Dmule.deploy.applications=app1:app2:app3\n    * This can also be done passing an additional command line option (deprecated) like:\n-   *  mule -app app1:app2:app3 will restrict deployment only to those specified apps.\n+   * mule -app app1:app2:app3 will restrict deployment only to those specified apps.\n    */\n   public static final String DEPLOYMENT_APPLICATION_PROPERTY = \"mule.deploy.applications\";\n \n   protected static final int DEFAULT_CHANGES_CHECK_INTERVAL_MS = 5000;\n \n   protected transient final Logger logger = LoggerFactory.getLogger(getClass());\n-\n-  private final ReentrantLock deploymentLock;\n-  private final ArchiveDeployer<Domain> domainArchiveDeployer;\n   protected final ArchiveDeployer<Application> applicationArchiveDeployer;\n   protected final Supplier<SchedulerService> schedulerServiceSupplier;\n+  private final ReentrantLock deploymentLock;\n+  private final ArchiveDeployer<Domain> domainArchiveDeployer;\n   private final ArtifactTimestampListener<Application> applicationTimestampListener;\n   private final ArtifactTimestampListener<Domain> domainTimestampListener;\n   private final ObservableList<Application> applications;\n   private final ObservableList<Domain> domains;\n   private final DomainBundleArchiveDeployer domainBundleDeployer;\n   private final File appsDir;\n   private final File domainsDir;\n-  private ScheduledExecutorService artifactDirMonitorTimer;\n-\n+  private final List<ArtifactStoppedDeploymentListener> artifactStoppedDeploymentListeners;", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NjE2Mw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558366163", "bodyText": "use package visibility", "author": "elrodro83", "createdAt": "2021-01-15T15:05:02Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactStoppedDeploymentListener.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.deployment.internal;\n+\n+import org.mule.runtime.core.internal.context.ArtifactStoppedListener;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+import java.util.Properties;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.mule.runtime.module.deployment.impl.internal.util.DeploymentPropertiesUtils.resolveDeploymentProperties;\n+import static org.mule.runtime.module.deployment.internal.DefaultArchiveDeployer.START_ARTIFACT_ON_DEPLOYMENT_PROPERTY;\n+\n+public class ArtifactStoppedDeploymentListener implements ArtifactStoppedListener {", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NjI4Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558366282", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-15T15:05:16Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactStoppedDeploymentListener.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.deployment.internal;\n+\n+import org.mule.runtime.core.internal.context.ArtifactStoppedListener;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+import java.util.Properties;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.mule.runtime.module.deployment.impl.internal.util.DeploymentPropertiesUtils.resolveDeploymentProperties;\n+import static org.mule.runtime.module.deployment.internal.DefaultArchiveDeployer.START_ARTIFACT_ON_DEPLOYMENT_PROPERTY;\n+\n+public class ArtifactStoppedDeploymentListener implements ArtifactStoppedListener {\n+\n+  private transient final Logger logger = LoggerFactory.getLogger(getClass());\n+  private AtomicBoolean shouldPersist;\n+  private String artifactName;\n+\n+  public ArtifactStoppedDeploymentListener(String artifactName) {\n+    this.artifactName = artifactName;\n+    shouldPersist = new AtomicBoolean(true);\n+  }\n+\n+  @Override\n+  public void onStart() {\n+    Properties properties = new Properties();\n+    properties.setProperty(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY, String.valueOf(true));\n+    try {\n+      resolveDeploymentProperties(artifactName, Optional.of(properties));\n+    } catch (IOException e) {\n+      logger.error(\"ApplicationStoppedDeploymentListener failed to process notification onArtifactStopped for artifact \"\n+          + artifactName, e);\n+    }\n+  }\n+\n+  @Override\n+  public void onStop() {\n+    if (!shouldPersist.get()) {\n+      return;\n+    }\n+    Properties properties = new Properties();\n+    properties.setProperty(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY, String.valueOf(false));\n+    try {\n+      resolveDeploymentProperties(artifactName, Optional.of(properties));", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NjMzMQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558366331", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-15T15:05:21Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactStoppedDeploymentListener.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.deployment.internal;\n+\n+import org.mule.runtime.core.internal.context.ArtifactStoppedListener;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+import java.util.Properties;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.mule.runtime.module.deployment.impl.internal.util.DeploymentPropertiesUtils.resolveDeploymentProperties;\n+import static org.mule.runtime.module.deployment.internal.DefaultArchiveDeployer.START_ARTIFACT_ON_DEPLOYMENT_PROPERTY;\n+\n+public class ArtifactStoppedDeploymentListener implements ArtifactStoppedListener {\n+\n+  private transient final Logger logger = LoggerFactory.getLogger(getClass());\n+  private AtomicBoolean shouldPersist;\n+  private String artifactName;\n+\n+  public ArtifactStoppedDeploymentListener(String artifactName) {\n+    this.artifactName = artifactName;\n+    shouldPersist = new AtomicBoolean(true);\n+  }\n+\n+  @Override\n+  public void onStart() {\n+    Properties properties = new Properties();\n+    properties.setProperty(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY, String.valueOf(true));\n+    try {\n+      resolveDeploymentProperties(artifactName, Optional.of(properties));", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2Njg1Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558366852", "bodyText": "static imports go first", "author": "elrodro83", "createdAt": "2021-01-15T15:06:12Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArchiveDeployer.java", "diffHunk": "@@ -44,10 +34,22 @@\n import java.util.Optional;\n import java.util.Properties;\n \n-import org.apache.commons.beanutils.BeanPropertyValueEqualsPredicate;\n-import org.apache.commons.beanutils.BeanToPropertyValueTransformer;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n+import static java.lang.Boolean.valueOf;", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NzI0Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558367242", "bodyText": "no need to use the intermediate Optional just for this. a simple null check will do.", "author": "elrodro83", "createdAt": "2021-01-15T15:06:51Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArchiveDeployer.java", "diffHunk": "@@ -188,6 +193,13 @@ public void undeployArtifactWithoutUninstall(T artifact) {\n     logRequestToUndeployArtifact(artifact);\n     try {\n       deploymentListener.onUndeploymentStart(artifact.getArtifactName());\n+      Optional<Registry> optionalRegistry = ofNullable(artifact.getRegistry());\n+\n+      optionalRegistry.ifPresent(artifactRegistry -> {\n+        Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+            artifactRegistry.lookupByName(ARTIFACT_STOPPED_LISTENER);\n+        optionalArtifactStoppedListener.ifPresent(artifactStoppedListener -> artifactStoppedListener.mustPersist(false));", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NzMwMA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558367300", "bodyText": "no need to use the intermediate Optional just for this. a simple null check will do.", "author": "elrodro83", "createdAt": "2021-01-15T15:06:55Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArchiveDeployer.java", "diffHunk": "@@ -297,6 +309,13 @@ private void undeploy(T artifact, boolean removeData) {\n       deploymentListener.onUndeploymentStart(artifact.getArtifactName());\n \n       artifacts.remove(artifact);\n+      Optional<Registry> optionalRegistry = ofNullable(artifact.getRegistry());\n+\n+      optionalRegistry.ifPresent(artifactRegistry -> {\n+        Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+            artifactRegistry.lookupByName(ARTIFACT_STOPPED_LISTENER);\n+        optionalArtifactStoppedListener.ifPresent(artifactStoppedListener -> artifactStoppedListener.mustPersist(false));", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2Nzc1MQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558367751", "bodyText": "no need to use the intermediate Optional just for this. a simple null check will do.How can it be null, anyway?", "author": "elrodro83", "createdAt": "2021-01-15T15:07:29Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArchiveDeployer.java", "diffHunk": "@@ -297,6 +309,13 @@ private void undeploy(T artifact, boolean removeData) {\n       deploymentListener.onUndeploymentStart(artifact.getArtifactName());\n \n       artifacts.remove(artifact);\n+      Optional<Registry> optionalRegistry = ofNullable(artifact.getRegistry());", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTc4MjQxMg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r559782412", "bodyText": "I also thought that it couldn't happen until some tests started failing because getRegistry returned null (deploysDomainWithSharedLibPrecedenceOverApplicationSharedLib, deploysDomainBundleZipAfterStartup, ...) Then I checked getRegistry() and the method implementation indicates that null is a possible return value:\npublic Registry getRegistry() {\n    return artifactContext != null ? artifactContext.getRegistry() : null;\n  }\nso I ended up adding this additional check.", "author": "sofiamorseletto", "createdAt": "2021-01-18T20:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2Nzc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2NzgzMg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558367832", "bodyText": "no need to use the intermediate Optional just for this. a simple null check will do.", "author": "elrodro83", "createdAt": "2021-01-15T15:07:35Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArchiveDeployer.java", "diffHunk": "@@ -405,8 +393,13 @@ public void redeploy(String artifactName, Optional<Properties> deploymentPropert\n \n     deploymentTemplate.preRedeploy(artifact);\n \n+    Optional<Registry> optionalRegistry = ofNullable(artifact.getRegistry());\n+    Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+        optionalRegistry.isPresent() ? optionalRegistry.get().lookupByName(ARTIFACT_STOPPED_LISTENER) : Optional.empty();", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2Nzg2OQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558367869", "bodyText": "no need to use the intermediate Optional just for this. a simple null check will do.", "author": "elrodro83", "createdAt": "2021-01-15T15:07:39Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArchiveDeployer.java", "diffHunk": "@@ -405,8 +393,13 @@ public void redeploy(String artifactName, Optional<Properties> deploymentPropert\n \n     deploymentTemplate.preRedeploy(artifact);\n \n+    Optional<Registry> optionalRegistry = ofNullable(artifact.getRegistry());", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2ODA3OQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558368079", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-15T15:07:54Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArtifactDeployer.java", "diffHunk": "@@ -29,9 +36,16 @@ public void deploy(T artifact, boolean startArtifact) {\n     try {\n       artifact.install();\n       doInit(artifact);\n-      if (startArtifact) {\n+      if (startArtifact && shouldStartArtifact(artifact)) {\n         artifact.start();\n       }\n+\n+      ArtifactStoppedDeploymentListener artifactStoppedDeploymentListener =\n+          new ArtifactStoppedDeploymentListener(artifact.getArtifactName());\n+      ArtifactFactoryUtils.withArtifactMuleContext(artifact, muleContext -> {", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2ODE1NQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558368155", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-15T15:08:00Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArtifactDeployer.java", "diffHunk": "@@ -105,4 +119,15 @@ private void tryToStopArtifact(T artifact) {\n     }\n   }\n \n+  private Boolean shouldStartArtifact(T artifact) {\n+    Properties deploymentProperties = null;\n+    try {\n+      deploymentProperties = DeploymentPropertiesUtils.resolveDeploymentProperties(artifact.getArtifactName(), Optional.empty());", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2ODIzNQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558368235", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-15T15:08:06Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArtifactDeployer.java", "diffHunk": "@@ -105,4 +119,15 @@ private void tryToStopArtifact(T artifact) {\n     }\n   }\n \n+  private Boolean shouldStartArtifact(T artifact) {\n+    Properties deploymentProperties = null;\n+    try {\n+      deploymentProperties = DeploymentPropertiesUtils.resolveDeploymentProperties(artifact.getArtifactName(), Optional.empty());\n+    } catch (IOException e) {\n+      logger.error(\"Failed to load deployment property for artifact \"\n+          + artifact.getArtifactName(), e);\n+    }\n+    return deploymentProperties != null\n+        && Boolean.parseBoolean(deploymentProperties.getProperty(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY, \"true\"));", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2ODU3MQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558368571", "bodyText": "format code properly in the javadoc", "author": "elrodro83", "createdAt": "2021-01-15T15:08:36Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DeploymentDirectoryWatcher.java", "diffHunk": "@@ -80,28 +83,27 @@\n    * Property used to change the deployment mode to deploy only the indicated applications with no redeployment.\n    * mule -M-Dmule.deploy.applications=app1:app2:app3\n    * This can also be done passing an additional command line option (deprecated) like:\n-   *  mule -app app1:app2:app3 will restrict deployment only to those specified apps.\n+   * mule -app app1:app2:app3 will restrict deployment only to those specified apps.", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2OTEyNg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558369126", "bodyText": "Use Integer.getInteger to read the system property.", "author": "elrodro83", "createdAt": "2021-01-15T15:09:25Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DeploymentDirectoryWatcher.java", "diffHunk": "@@ -135,6 +137,16 @@ public DeploymentDirectoryWatcher(DomainBundleArchiveDeployer domainBundleDeploy\n     this.schedulerServiceSupplier = schedulerServiceSupplier;\n     this.applicationTimestampListener = new ArtifactTimestampListener(applications);\n     this.domainTimestampListener = new ArtifactTimestampListener(domains);\n+    this.artifactStoppedDeploymentListeners = new ArrayList<>();\n+  }\n+\n+  private static int getChangesCheckIntervalMs() {\n+    try {\n+      String value = System.getProperty(CHANGE_CHECK_INTERVAL_PROPERTY);\n+      return Integer.parseInt(value);", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTgwNzY5OA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r559807698", "bodyText": "Tried it but Integer.getInteger returns null and a NullPointerException is thrown \ud83e\udd14", "author": "sofiamorseletto", "createdAt": "2021-01-18T21:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2OTEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2OTU3OQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558369579", "bodyText": "optional hell", "author": "elrodro83", "createdAt": "2021-01-15T15:10:04Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DeploymentDirectoryWatcher.java", "diffHunk": "@@ -217,12 +230,18 @@ private void stopArtifacts(List<? extends DeployableArtifact> artifacts) {\n     }\n   }\n \n-  private static int getChangesCheckIntervalMs() {\n-    try {\n-      String value = System.getProperty(CHANGE_CHECK_INTERVAL_PROPERTY);\n-      return Integer.parseInt(value);\n-    } catch (NumberFormatException e) {\n-      return DEFAULT_CHANGES_CHECK_INTERVAL_MS;\n+  private void notifyStopListeners() {\n+    for (Application application : applications) {\n+      Optional<Registry> optionalRegistry = ofNullable(application.getRegistry());\n+      Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+          optionalRegistry.isPresent() ? optionalRegistry.get().lookupByName(ARTIFACT_STOPPED_LISTENER) : Optional.empty();\n+      optionalArtifactStoppedListener.ifPresent(artifactStoppedListener -> artifactStoppedListener.mustPersist(false));", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2OTYyNQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558369625", "bodyText": "optional hell", "author": "elrodro83", "createdAt": "2021-01-15T15:10:07Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DeploymentDirectoryWatcher.java", "diffHunk": "@@ -217,12 +230,18 @@ private void stopArtifacts(List<? extends DeployableArtifact> artifacts) {\n     }\n   }\n \n-  private static int getChangesCheckIntervalMs() {\n-    try {\n-      String value = System.getProperty(CHANGE_CHECK_INTERVAL_PROPERTY);\n-      return Integer.parseInt(value);\n-    } catch (NumberFormatException e) {\n-      return DEFAULT_CHANGES_CHECK_INTERVAL_MS;\n+  private void notifyStopListeners() {\n+    for (Application application : applications) {\n+      Optional<Registry> optionalRegistry = ofNullable(application.getRegistry());\n+      Optional<ArtifactStoppedListener> optionalArtifactStoppedListener =\n+          optionalRegistry.isPresent() ? optionalRegistry.get().lookupByName(ARTIFACT_STOPPED_LISTENER) : Optional.empty();\n+      optionalArtifactStoppedListener.ifPresent(artifactStoppedListener -> artifactStoppedListener.mustPersist(false));\n+    }\n+    for (Domain domain : domains) {\n+      Optional<Registry> optionalRegistry = ofNullable(domain.getRegistry());", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM2OTkyMA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r558369920", "bodyText": "why move this?", "author": "elrodro83", "createdAt": "2021-01-15T15:10:32Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DomainArchiveDeployer.java", "diffHunk": "@@ -21,20 +24,15 @@\n import java.util.Optional;\n import java.util.Properties;\n \n-import org.apache.commons.lang3.NotImplementedException;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n /**\n  * Archive deployer for domains.\n  * <p/>\n  * Knows how to deploy / undeploy a domain and a domain bundle (zip with domain + domains apps).\n  */\n public class DomainArchiveDeployer implements ArchiveDeployer<Domain> {\n \n-  private transient final Logger logger = LoggerFactory.getLogger(getClass());\n-\n   public static final String DOMAIN_BUNDLE_APPS_FOLDER = \"apps\";\n+  private transient final Logger logger = LoggerFactory.getLogger(getClass());", "originalCommit": "d6c85ce26b666312324c738a3917e2c88f39d790", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b6ddadd940e70adce526aad5d3984cb9246bd498", "url": "https://github.com/mulesoft/mule/commit/b6ddadd940e70adce526aad5d3984cb9246bd498", "message": "Created and set listener", "committedDate": "2021-01-19T13:38:37Z", "type": "commit"}, {"oid": "3a3bc1eca69a8b0bb929e3de50aeb23114da09c0", "url": "https://github.com/mulesoft/mule/commit/3a3bc1eca69a8b0bb929e3de50aeb23114da09c0", "message": "Added deployment property load procedure", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "9dce61d74b230adad476f76a72d4133a0dc4fd7c", "url": "https://github.com/mulesoft/mule/commit/9dce61d74b230adad476f76a72d4133a0dc4fd7c", "message": "Adapting domain restart", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "fe90e4439d9f45074713b1b8ce10aa35baca549d", "url": "https://github.com/mulesoft/mule/commit/fe90e4439d9f45074713b1b8ce10aa35baca549d", "message": "Changed approach to use Mule Context registry", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "b372365542cc65623f82be45a7d0deb83ccd675f", "url": "https://github.com/mulesoft/mule/commit/b372365542cc65623f82be45a7d0deb83ccd675f", "message": "Added tests and fix", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "da3f0338614ee61280dd21cc351d12b621b3e48a", "url": "https://github.com/mulesoft/mule/commit/da3f0338614ee61280dd21cc351d12b621b3e48a", "message": "Refactoring where to add listener", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "f7e7b60c4b8f2ba281bf90dcc554ba4ddca965f7", "url": "https://github.com/mulesoft/mule/commit/f7e7b60c4b8f2ba281bf90dcc554ba4ddca965f7", "message": "Cleaning unused classes", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "029142247b21023cc6f10e48a86d1fbe9263ffff", "url": "https://github.com/mulesoft/mule/commit/029142247b21023cc6f10e48a86d1fbe9263ffff", "message": "Reformatting", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "4d7035469fbc02d2acc611bce8569bc15998dd65", "url": "https://github.com/mulesoft/mule/commit/4d7035469fbc02d2acc611bce8569bc15998dd65", "message": "Cleaning unused classes", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "253a923c2945c05f2173f261e78807afcdcf4f5c", "url": "https://github.com/mulesoft/mule/commit/253a923c2945c05f2173f261e78807afcdcf4f5c", "message": "Reformatting", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "3358ff596829eb4a088cff13906bdd39de525b52", "url": "https://github.com/mulesoft/mule/commit/3358ff596829eb4a088cff13906bdd39de525b52", "message": "Fixes according to PR comments", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "8c4d1b725116f16eb5c829b19cef3e2aef5e8600", "url": "https://github.com/mulesoft/mule/commit/8c4d1b725116f16eb5c829b19cef3e2aef5e8600", "message": "Cleaning unused classes", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "1f22cdeaa2bb2d0987e93228c9e30209b1e53abf", "url": "https://github.com/mulesoft/mule/commit/1f22cdeaa2bb2d0987e93228c9e30209b1e53abf", "message": "Reformatted", "committedDate": "2021-01-19T13:38:38Z", "type": "commit"}, {"oid": "1f22cdeaa2bb2d0987e93228c9e30209b1e53abf", "url": "https://github.com/mulesoft/mule/commit/1f22cdeaa2bb2d0987e93228c9e30209b1e53abf", "message": "Reformatted", "committedDate": "2021-01-19T13:38:38Z", "type": "forcePushed"}, {"oid": "a2449d984f9229528cbc7e78765e6acd68c20103", "url": "https://github.com/mulesoft/mule/commit/a2449d984f9229528cbc7e78765e6acd68c20103", "message": "Reformatting", "committedDate": "2021-01-19T14:35:02Z", "type": "commit"}, {"oid": "82574688fb663998972f9156fdee5fc7a0106bb2", "url": "https://github.com/mulesoft/mule/commit/82574688fb663998972f9156fdee5fc7a0106bb2", "message": "Another reformat", "committedDate": "2021-01-19T15:10:36Z", "type": "commit"}, {"oid": "129e1ecb0f273950c19df88e9fba98f178dd3619", "url": "https://github.com/mulesoft/mule/commit/129e1ecb0f273950c19df88e9fba98f178dd3619", "message": "Removing intellij formatter changes", "committedDate": "2021-01-19T18:23:02Z", "type": "commit"}, {"oid": "a0556a956ca1662c8417f80f5dfe4245eca76c2b", "url": "https://github.com/mulesoft/mule/commit/a0556a956ca1662c8417f80f5dfe4245eca76c2b", "message": "Log fix", "committedDate": "2021-01-20T12:31:39Z", "type": "commit"}, {"oid": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "url": "https://github.com/mulesoft/mule/commit/c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "message": "Refactor: moved doNotPersist method to DefaultArtifactDeployer", "committedDate": "2021-01-21T13:25:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MTEzOA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562641138", "bodyText": "add <p> for proer formatting of the javadoc", "author": "elrodro83", "createdAt": "2021-01-22T13:47:22Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactDeployer.java", "diffHunk": "@@ -46,4 +46,12 @@ default void deploy(final T artifact) {\n    */\n   void undeploy(final T artifact);\n \n+  /**\n+   * Cancels the persistence of a stop of an artifact.\n+   *", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MTY5MQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562641691", "bodyText": "make final", "author": "elrodro83", "createdAt": "2021-01-22T13:48:08Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactStoppedDeploymentPersistenceListener.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.deployment.internal;\n+\n+import static java.lang.String.valueOf;\n+import static java.util.Optional.of;\n+import static org.mule.runtime.module.deployment.impl.internal.util.DeploymentPropertiesUtils.resolveDeploymentProperties;\n+import static org.mule.runtime.module.deployment.internal.DefaultArchiveDeployer.START_ARTIFACT_ON_DEPLOYMENT_PROPERTY;\n+\n+import org.mule.runtime.core.internal.context.ArtifactStoppedPersistenceListener;\n+\n+import java.io.IOException;\n+import java.util.Properties;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+class ArtifactStoppedDeploymentPersistenceListener implements ArtifactStoppedPersistenceListener {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MTgwNA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562641804", "bodyText": "this should be static", "author": "elrodro83", "createdAt": "2021-01-22T13:48:17Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactStoppedDeploymentPersistenceListener.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.deployment.internal;\n+\n+import static java.lang.String.valueOf;\n+import static java.util.Optional.of;\n+import static org.mule.runtime.module.deployment.impl.internal.util.DeploymentPropertiesUtils.resolveDeploymentProperties;\n+import static org.mule.runtime.module.deployment.internal.DefaultArchiveDeployer.START_ARTIFACT_ON_DEPLOYMENT_PROPERTY;\n+\n+import org.mule.runtime.core.internal.context.ArtifactStoppedPersistenceListener;\n+\n+import java.io.IOException;\n+import java.util.Properties;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+class ArtifactStoppedDeploymentPersistenceListener implements ArtifactStoppedPersistenceListener {\n+\n+  private transient final Logger logger = LoggerFactory.getLogger(getClass());", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MzM4Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562643382", "bodyText": "who calls this method?", "author": "elrodro83", "createdAt": "2021-01-22T13:50:39Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactStoppedDeploymentPersistenceListener.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.deployment.internal;\n+\n+import static java.lang.String.valueOf;\n+import static java.util.Optional.of;\n+import static org.mule.runtime.module.deployment.impl.internal.util.DeploymentPropertiesUtils.resolveDeploymentProperties;\n+import static org.mule.runtime.module.deployment.internal.DefaultArchiveDeployer.START_ARTIFACT_ON_DEPLOYMENT_PROPERTY;\n+\n+import org.mule.runtime.core.internal.context.ArtifactStoppedPersistenceListener;\n+\n+import java.io.IOException;\n+import java.util.Properties;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+class ArtifactStoppedDeploymentPersistenceListener implements ArtifactStoppedPersistenceListener {\n+\n+  private transient final Logger logger = LoggerFactory.getLogger(getClass());\n+  private AtomicBoolean shouldPersist;\n+  private String artifactName;\n+\n+  public ArtifactStoppedDeploymentPersistenceListener(String artifactName) {\n+    this.artifactName = artifactName;\n+    shouldPersist = new AtomicBoolean(true);\n+  }\n+\n+  @Override\n+  public void onStart() {\n+    Properties properties = new Properties();\n+    properties.setProperty(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY, valueOf(true));\n+    try {\n+      resolveDeploymentProperties(artifactName, of(properties));\n+    } catch (IOException e) {\n+      logger.error(\"ArtifactStoppedDeploymentPersistenceListener failed to process notification onStart for artifact \"\n+          + artifactName, e);\n+    }\n+  }\n+\n+  @Override\n+  public void onStop() {\n+    if (!shouldPersist.get()) {\n+      return;\n+    }\n+    Properties properties = new Properties();\n+    properties.setProperty(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY, valueOf(false));\n+    try {\n+      resolveDeploymentProperties(artifactName, of(properties));\n+    } catch (IOException e) {\n+      logger.error(\"ArtifactStoppedDeploymentPersistenceListener failed to process notification onStop for artifact \"\n+          + artifactName, e);\n+    }\n+  }\n+\n+  @Override\n+  public void doNotPersist() {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjgyNDM0Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562824342", "bodyText": "The artifact stopped state should only be persisted if it was stopped by the Agent. Since the Agent calls the artifact stop() method directly and I have no access to the Agent's code, the workaround is to prevent the persistence when the artifact is stopped for other reasons different than the Agent. Since the artifact is also stopped before undeployment, this method is called on the undeploy() method of DefaultArtifactDeployer.", "author": "sofiamorseletto", "createdAt": "2021-01-22T18:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkxMTMxOA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r563911318", "bodyText": "add this info as comment in the code", "author": "elrodro83", "createdAt": "2021-01-25T17:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MzM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MzYzMw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562643633", "bodyText": "where can this be used concurrently?", "author": "elrodro83", "createdAt": "2021-01-22T13:51:04Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/ArtifactStoppedDeploymentPersistenceListener.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.deployment.internal;\n+\n+import static java.lang.String.valueOf;\n+import static java.util.Optional.of;\n+import static org.mule.runtime.module.deployment.impl.internal.util.DeploymentPropertiesUtils.resolveDeploymentProperties;\n+import static org.mule.runtime.module.deployment.internal.DefaultArchiveDeployer.START_ARTIFACT_ON_DEPLOYMENT_PROPERTY;\n+\n+import org.mule.runtime.core.internal.context.ArtifactStoppedPersistenceListener;\n+\n+import java.io.IOException;\n+import java.util.Properties;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+class ArtifactStoppedDeploymentPersistenceListener implements ArtifactStoppedPersistenceListener {\n+\n+  private transient final Logger logger = LoggerFactory.getLogger(getClass());\n+  private AtomicBoolean shouldPersist;\n+  private String artifactName;\n+\n+  public ArtifactStoppedDeploymentPersistenceListener(String artifactName) {\n+    this.artifactName = artifactName;\n+    shouldPersist = new AtomicBoolean(true);", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzcwMDk5Nw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r563700997", "bodyText": "We thought that a possible race condition could happen if a stop request and a shutdown request were concurrently sent to mule, so we decided to make this variable an Atomic Boolean.", "author": "sofiamorseletto", "createdAt": "2021-01-25T12:54:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MzYzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzkxMTE3Nw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r563911177", "bodyText": "add this info as a comment in the code", "author": "elrodro83", "createdAt": "2021-01-25T17:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0MzYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NDE1Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562644152", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-22T13:51:51Z", "path": "modules/deployment/src/main/java/org/mule/runtime/module/deployment/internal/DefaultArtifactDeployer.java", "diffHunk": "@@ -105,4 +124,25 @@ private void tryToStopArtifact(T artifact) {\n     }\n   }\n \n+  private Boolean shouldStartArtifact(T artifact) {\n+    Properties deploymentProperties = null;\n+    try {\n+      deploymentProperties = resolveDeploymentProperties(artifact.getArtifactName(), Optional.empty());", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NDYwNA==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562644604", "bodyText": "keep this separation", "author": "elrodro83", "createdAt": "2021-01-22T13:52:31Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -96,7 +104,6 @@\n \n   @Rule\n   public SystemProperty systemProperty = new SystemProperty(OVERWRITTEN_PROPERTY, OVERWRITTEN_PROPERTY_SYSTEM_VALUE);\n-", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NDc2MQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562644761", "bodyText": "add @Issue annotation", "author": "elrodro83", "createdAt": "2021-01-22T13:52:47Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NDg3Mw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562644873", "bodyText": "add @Issue annotation", "author": "elrodro83", "createdAt": "2021-01-22T13:52:59Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test\n+  public void whenAppIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyAppFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+  }\n+\n+  @Test\n+  public void whenAppIsStoppedByUndeploymentStateIsNotPersistedAsDeploymentProperty() throws Exception {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NDkwNQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562644905", "bodyText": "add @Issue annotation", "author": "elrodro83", "createdAt": "2021-01-22T13:53:02Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -696,6 +735,79 @@ public void undeploysStoppedApp() throws Exception {\n     deploymentService.undeploy(app);\n   }\n \n+  @Test\n+  public void undeploysStoppedAppAndDoesNotStartItOnDeploy() throws Exception {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NDkzOQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562644939", "bodyText": "add @Issue annotation", "author": "elrodro83", "createdAt": "2021-01-22T13:53:06Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -696,6 +735,79 @@ public void undeploysStoppedApp() throws Exception {\n     deploymentService.undeploy(app);\n   }\n \n+  @Test\n+  public void undeploysStoppedAppAndDoesNotStartItOnDeploy() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+    assertStatus(app, STOPPED);\n+\n+    serviceManager.stop();\n+    extensionModelLoaderManager.stop();\n+    deploymentService.stop();\n+\n+    reset(applicationDeploymentListener);\n+\n+    MuleArtifactResourcesRegistry muleArtifactResourcesRegistry =\n+        new MuleArtifactResourcesRegistry.Builder().moduleRepository(moduleRepository).build();\n+\n+    serviceManager = muleArtifactResourcesRegistry.getServiceManager();\n+    serviceManager.start();\n+\n+    extensionModelLoaderManager = muleArtifactResourcesRegistry.getExtensionModelLoaderManager();\n+    extensionModelLoaderManager.start();\n+\n+    deploymentService = new TestMuleDeploymentService(muleArtifactResourcesRegistry.getDomainFactory(),\n+                                                      muleArtifactResourcesRegistry.getApplicationFactory(),\n+                                                      () -> findSchedulerService(serviceManager));\n+    configureDeploymentService();\n+    deploymentService.start();\n+\n+    assertDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app_2 = findApp(emptyAppFileBuilder.getId(), 1);\n+    assertStatus(app_2, CREATED);\n+  }\n+\n+  @Test\n+  public void undeploysNotStoppedAppAndStartsItOnDeploy() throws Exception {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NTI5Ng==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562645296", "bodyText": "static import", "author": "elrodro83", "createdAt": "2021-01-22T13:53:42Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test\n+  public void whenAppIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyAppFileBuilder.getId(), Optional.empty());", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NTQ4Mw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562645483", "bodyText": "use hamcrest matchers", "author": "elrodro83", "createdAt": "2021-01-22T13:54:03Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test\n+  public void whenAppIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NTUzNw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562645537", "bodyText": "use hamcrest matchers", "author": "elrodro83", "createdAt": "2021-01-22T13:54:07Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test\n+  public void whenAppIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyAppFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NTU5Mw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562645593", "bodyText": "use hamcrest matchers", "author": "elrodro83", "createdAt": "2021-01-22T13:54:11Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test\n+  public void whenAppIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyAppFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NTc3Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562645772", "bodyText": "use hamcrest matchers", "author": "elrodro83", "createdAt": "2021-01-22T13:54:30Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test\n+  public void whenAppIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyAppFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+  }\n+\n+  @Test\n+  public void whenAppIsStoppedByUndeploymentStateIsNotPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NTgwNg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562645806", "bodyText": "use hamcrest matchers", "author": "elrodro83", "createdAt": "2021-01-22T13:54:32Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/ApplicationDeploymentTestCase.java", "diffHunk": "@@ -293,6 +300,38 @@ public void deploymentPropertiesUsedInConfigurationProperties() throws Exception\n                                           .equals(OVERWRITTEN_PROPERTY_DEPLOYMENT_VALUE));\n   }\n \n+  @Test\n+  public void whenAppIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+    app.stop();\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyAppFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+  }\n+\n+  @Test\n+  public void whenAppIsStoppedByUndeploymentStateIsNotPersistedAsDeploymentProperty() throws Exception {\n+    addPackedAppFromBuilder(emptyAppFileBuilder);\n+\n+    startDeployment();\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, emptyAppFileBuilder.getId());\n+    final Application app = findApp(emptyAppFileBuilder.getId(), 1);\n+\n+    assertNotNull(app.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+    deploymentService.undeploy(app);\n+\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyAppFileBuilder.getId(), Optional.empty());\n+    assertNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjA4MQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646081", "bodyText": "allure", "author": "elrodro83", "createdAt": "2021-01-22T13:55:01Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -623,6 +630,34 @@ public void redeploysDomainZipRefreshesApps() throws Exception {\n     assertApplicationDeploymentSuccess(applicationDeploymentListener, dummyDomainApp1FileBuilder.getId());\n   }\n \n+  @Test\n+  public void redeploysDomainZipRefreshesAppsButIfTheyWereStoppedTheyDoNotStart() throws Exception {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjE1OQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646159", "bodyText": "allure", "author": "elrodro83", "createdAt": "2021-01-22T13:55:07Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1096,6 +1131,39 @@ public void undeploysStoppedDomain() throws Exception {\n     deploymentService.undeploy(domain);\n   }\n \n+  @Test\n+  public void whenDomainIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjIyNw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646227", "bodyText": "hamcerst", "author": "elrodro83", "createdAt": "2021-01-22T13:55:12Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1096,6 +1131,39 @@ public void undeploysStoppedDomain() throws Exception {\n     deploymentService.undeploy(domain);\n   }\n \n+  @Test\n+  public void whenDomainIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedDomainFromBuilder(emptyDomainFileBuilder);\n+\n+    startDeployment();\n+\n+    assertDeploymentSuccess(domainDeploymentListener, emptyDomainFileBuilder.getId());\n+    final Domain domain = findADomain(emptyDomainFileBuilder.getId());\n+    domain.stop();\n+\n+    assertNotNull(domain.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjMzNQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646335", "bodyText": "hamcrest", "author": "elrodro83", "createdAt": "2021-01-22T13:55:21Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1096,6 +1131,39 @@ public void undeploysStoppedDomain() throws Exception {\n     deploymentService.undeploy(domain);\n   }\n \n+  @Test\n+  public void whenDomainIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedDomainFromBuilder(emptyDomainFileBuilder);\n+\n+    startDeployment();\n+\n+    assertDeploymentSuccess(domainDeploymentListener, emptyDomainFileBuilder.getId());\n+    final Domain domain = findADomain(emptyDomainFileBuilder.getId());\n+    domain.stop();\n+\n+    assertNotNull(domain.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyDomainFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjM2Mg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646362", "bodyText": "allure", "author": "elrodro83", "createdAt": "2021-01-22T13:55:24Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1096,6 +1131,39 @@ public void undeploysStoppedDomain() throws Exception {\n     deploymentService.undeploy(domain);\n   }\n \n+  @Test\n+  public void whenDomainIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedDomainFromBuilder(emptyDomainFileBuilder);\n+\n+    startDeployment();\n+\n+    assertDeploymentSuccess(domainDeploymentListener, emptyDomainFileBuilder.getId());\n+    final Domain domain = findADomain(emptyDomainFileBuilder.getId());\n+    domain.stop();\n+\n+    assertNotNull(domain.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyDomainFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+  }\n+\n+  @Test\n+  public void whenDomainIsStoppedByUndeploymentStateIsNotfedAsDeploymentProperty() throws Exception {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjQxNg==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646416", "bodyText": "hamcrest", "author": "elrodro83", "createdAt": "2021-01-22T13:55:29Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1096,6 +1131,39 @@ public void undeploysStoppedDomain() throws Exception {\n     deploymentService.undeploy(domain);\n   }\n \n+  @Test\n+  public void whenDomainIsStoppedStateIsPersistedAsDeploymentProperty() throws Exception {\n+    addPackedDomainFromBuilder(emptyDomainFileBuilder);\n+\n+    startDeployment();\n+\n+    assertDeploymentSuccess(domainDeploymentListener, emptyDomainFileBuilder.getId());\n+    final Domain domain = findADomain(emptyDomainFileBuilder.getId());\n+    domain.stop();\n+\n+    assertNotNull(domain.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+\n+    Properties deploymentProperties = resolveDeploymentProperties(emptyDomainFileBuilder.getId(), Optional.empty());\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+  }\n+\n+  @Test\n+  public void whenDomainIsStoppedByUndeploymentStateIsNotfedAsDeploymentProperty() throws Exception {\n+    addPackedDomainFromBuilder(emptyDomainFileBuilder);\n+\n+    startDeployment();\n+\n+    assertDeploymentSuccess(domainDeploymentListener, emptyDomainFileBuilder.getId());\n+    final Domain domain = findADomain(emptyDomainFileBuilder.getId());\n+\n+    assertNotNull(domain.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjU0Nw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646547", "bodyText": "allure", "author": "elrodro83", "createdAt": "2021-01-22T13:55:40Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1303,6 +1371,33 @@ public void deployAndRedeployDomainWithDeploymentProperties() throws Exception {\n                                             .get() instanceof TestComponentOnRedeploy);\n   }\n \n+  @Test\n+  public void redeployDomainWithStoppedAppsShouldPersistStoppedStateAndDoNotStartApps() throws Exception {", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjYwMQ==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646601", "bodyText": "hamcrest", "author": "elrodro83", "createdAt": "2021-01-22T13:55:46Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1303,6 +1371,33 @@ public void deployAndRedeployDomainWithDeploymentProperties() throws Exception {\n                                             .get() instanceof TestComponentOnRedeploy);\n   }\n \n+  @Test\n+  public void redeployDomainWithStoppedAppsShouldPersistStoppedStateAndDoNotStartApps() throws Exception {\n+    addPackedDomainFromBuilder(dummyDomainFileBuilder);\n+    File dummyDomainFile = new File(domainsDir, dummyDomainFileBuilder.getZipPath());\n+    long firstFileTimestamp = dummyDomainFile.lastModified();\n+\n+    addPackedAppFromBuilder(dummyDomainApp1FileBuilder);\n+\n+    startDeployment();\n+\n+    assertDeploymentSuccess(domainDeploymentListener, dummyDomainFileBuilder.getId());\n+    final Domain domain = findADomain(dummyDomainFileBuilder.getId());\n+    assertNotNull(domain.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0NjcwNw==", "url": "https://github.com/mulesoft/mule/pull/9905#discussion_r562646707", "bodyText": "hamcrest", "author": "elrodro83", "createdAt": "2021-01-22T13:55:54Z", "path": "modules/deployment/src/test/java/org/mule/runtime/module/deployment/internal/DomainDeploymentTestCase.java", "diffHunk": "@@ -1303,6 +1371,33 @@ public void deployAndRedeployDomainWithDeploymentProperties() throws Exception {\n                                             .get() instanceof TestComponentOnRedeploy);\n   }\n \n+  @Test\n+  public void redeployDomainWithStoppedAppsShouldPersistStoppedStateAndDoNotStartApps() throws Exception {\n+    addPackedDomainFromBuilder(dummyDomainFileBuilder);\n+    File dummyDomainFile = new File(domainsDir, dummyDomainFileBuilder.getZipPath());\n+    long firstFileTimestamp = dummyDomainFile.lastModified();\n+\n+    addPackedAppFromBuilder(dummyDomainApp1FileBuilder);\n+\n+    startDeployment();\n+\n+    assertDeploymentSuccess(domainDeploymentListener, dummyDomainFileBuilder.getId());\n+    final Domain domain = findADomain(dummyDomainFileBuilder.getId());\n+    assertNotNull(domain.getRegistry().lookupByName(ARTIFACT_STOPPED_LISTENER));\n+\n+    assertApplicationDeploymentSuccess(applicationDeploymentListener, dummyDomainApp1FileBuilder.getId());\n+\n+    final Application app = findApp(dummyDomainApp1FileBuilder.getId(), 1);\n+    app.stop();\n+\n+    redeployId(dummyDomainFileBuilder.getId(), null);\n+\n+    Properties deploymentProperties = resolveDeploymentProperties(dummyDomainApp1FileBuilder.getId(), Optional.empty());\n+    assertStatus(dummyDomainApp1FileBuilder.getId(), CREATED);\n+    assertNotNull(deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));\n+    assertEquals(\"false\", deploymentProperties.get(START_ARTIFACT_ON_DEPLOYMENT_PROPERTY));", "originalCommit": "c2b5ec79eb48a0b93203963d9eea03bb8b0ac19b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4fd04e429649fd590ab1bac03ada7a6dccf9b75e", "url": "https://github.com/mulesoft/mule/commit/4fd04e429649fd590ab1bac03ada7a6dccf9b75e", "message": "Fixing PR comments", "committedDate": "2021-01-25T13:48:48Z", "type": "commit"}, {"oid": "5e5600bcfdafc1d83fc9367f68cfa5d3929714f3", "url": "https://github.com/mulesoft/mule/commit/5e5600bcfdafc1d83fc9367f68cfa5d3929714f3", "message": "Adding comments", "committedDate": "2021-01-25T19:00:51Z", "type": "commit"}, {"oid": "ca93cac612eb9d94fd241076f72498c36ebb7df5", "url": "https://github.com/mulesoft/mule/commit/ca93cac612eb9d94fd241076f72498c36ebb7df5", "message": "Adding TODO", "committedDate": "2021-01-25T19:51:41Z", "type": "commit"}]}