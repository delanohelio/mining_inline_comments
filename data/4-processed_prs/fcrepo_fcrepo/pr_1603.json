{"pr_number": 1603, "pr_title": "Persist FedoraToOCFLIndex to disk", "pr_createdAt": "2020-01-14T19:38:03Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1603", "timeline": [{"oid": "4edf243a4695a10e251d32bbe015f40701ae2e93", "url": "https://github.com/fcrepo/fcrepo/commit/4edf243a4695a10e251d32bbe015f40701ae2e93", "message": "Persist FedoraToOCFLIndex to disk", "committedDate": "2020-01-14T17:41:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjMwNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366616307", "bodyText": "@whikloj :  There are constants these directories in DefaultOCFLObjectSessionFactory.  I would moving DefaultOCFLObjectSessionFactory.STAGING_DIR,  DefaultOCFLObjectSessionFactory.OCFL_STORAGE_ROOT_DIR,  DefaultOCFLObjectSessionFactory.OCFL_WORK_DIR and DefaultOCFLObjectSessionFactory.resolveDir() into OCFLPersistenceConstants and then having FedoraToOCFLObjectIndexImpl use them in order to eliminate the duplicate code.", "author": "dbernstein", "createdAt": "2020-01-14T22:55:19Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?", "originalCommit": "4edf243a4695a10e251d32bbe015f40701ae2e93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjgwMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366616803", "bodyText": "Make fedoraToOcflIndex.tsv a constant as well.", "author": "dbernstein", "createdAt": "2020-01-14T22:56:42Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +46,36 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n+    private Path indexFilePath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?\n+            Paths.get(JAVA_IO_TMPDIR, \"fcrepo.ocfl.work.dir\", \"fedoraToOcflIndex.tsv\") :", "originalCommit": "4edf243a4695a10e251d32bbe015f40701ae2e93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk1Mzg1NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366953855", "bodyText": "I just made a constant of the FILE with the text \"fedoraToOcflIndex.tsv\", I could make that String a constant and use it in the other constant.\nBut that seemed like overkill as I feel that this will go away once we have a non-in-memory index.", "author": "whikloj", "createdAt": "2020-01-15T15:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAxMzIwMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r367013202", "bodyText": "\ud83d\udc4d", "author": "dbernstein", "createdAt": "2020-01-15T17:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNjgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzAxNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366617014", "bodyText": "Use constants per above refactoring suggestion.", "author": "dbernstein", "createdAt": "2020-01-14T22:57:16Z", "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImplTest.java", "diffHunk": "@@ -36,6 +52,16 @@\n     private static final String OCFL_ID = \"ocfl-id\";\n     private static final String OCFL_ID_RESOURCE_3 = \"ocfl-id-resource-3\";\n \n+    private final Path indexMappingPath = getProperty(\"fcrepo.ocfl.work.dir\") == null ?", "originalCommit": "4edf243a4695a10e251d32bbe015f40701ae2e93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c43e4e0553eee11cb6c06a84a192fd8828994d6", "url": "https://github.com/fcrepo/fcrepo/commit/4c43e4e0553eee11cb6c06a84a192fd8828994d6", "message": "Reuse OCFL directory constants", "committedDate": "2020-01-15T14:30:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk3OTE2MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366979160", "bodyText": "Please add a documentation note describing the expected layout/fields in the .tsv file.\nThe use of map.length == 3 and indexing into the map array seem a bit opaque.", "author": "awoods", "createdAt": "2020-01-15T16:34:28Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor", "originalCommit": "4c43e4e0553eee11cb6c06a84a192fd8828994d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4MjI3Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366982277", "bodyText": "Maybe add a log message if the length is not 3?", "author": "awoods", "createdAt": "2020-01-15T16:40:00Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor\n+     * @throws IOException If we can't access the file.\n+     */\n+    public FedoraToOCFLObjectIndexImpl() throws IOException {\n+        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n+            Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath()).filter(l -> {\n+                final String m = l.split(\"\\t\")[0];\n+                return (!fedoraOCFLMappingMap.containsKey(m));\n+            }).forEach(l -> {\n+                final String[] map = l.split(\"\\t\");\n+                if (map.length == 3) {\n+                    final FedoraOCFLMapping ocflMapping = new FedoraOCFLMapping(map[1], map[2]);\n+                    fedoraOCFLMappingMap.put(map[0], ocflMapping);\n+                }", "originalCommit": "4c43e4e0553eee11cb6c06a84a192fd8828994d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4Njk4Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366986983", "bodyText": "Instead of these contortions, can you try either:\n\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/file/Path.html#getParent() or\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/io/File.html#getParentFile()", "author": "awoods", "createdAt": "2020-01-15T16:48:25Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -59,15 +86,39 @@ public FedoraOCFLMapping addMapping(final String fedoraResourceIdentifier, final\n         if (mapping == null) {\n             mapping = new FedoraOCFLMapping(fedoraRootObjectResourceId, ocflObjectId);\n             fedoraOCFLMappingMap.put(fedoraRootObjectResourceId, mapping);\n-\n+            writeMappingToDisk(fedoraRootObjectResourceId, mapping);\n         }\n \n         if (!fedoraResourceIdentifier.equals(fedoraRootObjectResourceId)) {\n             fedoraOCFLMappingMap.put(fedoraResourceIdentifier, mapping);\n+            writeMappingToDisk(fedoraResourceIdentifier, mapping);\n         }\n \n         LOGGER.debug(\"added mapping {} for {}\", mapping, fedoraResourceIdentifier);\n         return mapping;\n     }\n \n+    /**\n+     * Write any added mappings to the on-disk index.\n+     * @param fedoraId The internal Fedora identifier.\n+     * @param fedoraOCFLMapping The Fedora to OCFL mapping object.\n+     */\n+    private void writeMappingToDisk(final String fedoraId, final FedoraOCFLMapping fedoraOCFLMapping) {\n+        try {\n+            if (!FEDORA_TO_OCFL_INDEX_FILE.exists()) {\n+                final String dirName = FEDORA_TO_OCFL_INDEX_FILE.toPath().toAbsolutePath().toString().substring(0,", "originalCommit": "4c43e4e0553eee11cb6c06a84a192fd8828994d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njk4NzUxNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1603#discussion_r366987515", "bodyText": "Possibly add a logging statement in the case that map.length does not equal 3?", "author": "awoods", "createdAt": "2020-01-15T16:49:25Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -35,10 +42,30 @@\n  */\n @Component\n public class FedoraToOCFLObjectIndexImpl implements FedoraToOCFLObjectIndex {\n+\n     private static Logger LOGGER = LoggerFactory.getLogger(FedoraToOCFLObjectIndexImpl.class);\n \n     private Map<String, FedoraOCFLMapping> fedoraOCFLMappingMap = Collections.synchronizedMap(new HashMap<>());\n \n+    /**\n+     * Constructor\n+     * @throws IOException If we can't access the file.\n+     */\n+    public FedoraToOCFLObjectIndexImpl() throws IOException {\n+        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n+            Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath()).filter(l -> {\n+                final String m = l.split(\"\\t\")[0];\n+                return (!fedoraOCFLMappingMap.containsKey(m));\n+            }).forEach(l -> {\n+                final String[] map = l.split(\"\\t\");\n+                if (map.length == 3) {\n+                    final FedoraOCFLMapping ocflMapping = new FedoraOCFLMapping(map[1], map[2]);\n+                    fedoraOCFLMappingMap.put(map[0], ocflMapping);\n+                }\n+            });", "originalCommit": "4c43e4e0553eee11cb6c06a84a192fd8828994d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13dc87a868149a3d15312819b31b11ce92bcbe99", "url": "https://github.com/fcrepo/fcrepo/commit/13dc87a868149a3d15312819b31b11ce92bcbe99", "message": "Code review", "committedDate": "2020-01-15T17:08:13Z", "type": "commit"}, {"oid": "84d39f2863944af85fd5ee58e759a54b79ae28c2", "url": "https://github.com/fcrepo/fcrepo/commit/84d39f2863944af85fd5ee58e759a54b79ae28c2", "message": "Too long lines", "committedDate": "2020-01-15T17:26:33Z", "type": "commit"}, {"oid": "860327834bec6747a55e135cf2b887f9d5ebcffc", "url": "https://github.com/fcrepo/fcrepo/commit/860327834bec6747a55e135cf2b887f9d5ebcffc", "message": "Remove unneccesary toString", "committedDate": "2020-01-15T21:51:16Z", "type": "commit"}]}