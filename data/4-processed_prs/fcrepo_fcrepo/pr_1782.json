{"pr_number": 1782, "pr_title": "Reload resource after a PATCH request, enforce request preconditions.", "pr_createdAt": "2020-10-19T22:02:34Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1782", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2Mjc5OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r509262799", "bodyText": "Perhaps there can be a FedoarId test for this behavior?", "author": "pwinckles", "createdAt": "2020-10-21T13:08:45Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/identifiers/FedoraId.java", "diffHunk": "@@ -87,7 +87,7 @@\n      * @throws IllegalArgumentException If ID does not start with expected prefix.\n      */\n     private FedoraId(final String fullId) {\n-        this.fullId = ensurePrefix(fullId).replaceAll(\"/+$\", \"\");\n+        this.fullId = ensurePrefix(fullId).replaceAll(\"\\\\s\", \"%20\").replaceAll(\"/+$\", \"\");", "originalCommit": "15191fb641eaa80cf84b8de839b2d0ad5be1a49f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2MzY2Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516263667", "bodyText": "I have reverted this change for a later attempt.", "author": "whikloj", "createdAt": "2020-11-02T21:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2Mjc5OQ=="}], "type": "inlineReview"}, {"oid": "5181e9068376604c8a023547e165215e3255800c", "url": "https://github.com/fcrepo/fcrepo/commit/5181e9068376604c8a023547e165215e3255800c", "message": "Encode spaces in FedoraIds, reload resource after a PATCH request", "committedDate": "2020-10-29T18:17:20Z", "type": "commit"}, {"oid": "97a6460c21def397188e66583d5d79b7bb6af0d5", "url": "https://github.com/fcrepo/fcrepo/commit/97a6460c21def397188e66583d5d79b7bb6af0d5", "message": "Reject spaces in Slugs", "committedDate": "2020-10-29T18:17:28Z", "type": "commit"}, {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd", "url": "https://github.com/fcrepo/fcrepo/commit/279d34bd361c6ce53200adf22dd88388c13f64cd", "message": "Unencode spaces so they don't get double encoded, encode spaces so they don't appear as literal spaces", "committedDate": "2020-10-29T18:17:28Z", "type": "commit"}, {"oid": "279d34bd361c6ce53200adf22dd88388c13f64cd", "url": "https://github.com/fcrepo/fcrepo/commit/279d34bd361c6ce53200adf22dd88388c13f64cd", "message": "Unencode spaces so they don't get double encoded, encode spaces so they don't appear as literal spaces", "committedDate": "2020-10-29T18:17:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r515973966", "bodyText": "Why are spaces handled differently from any other character that might otherwise be url encoded? For example, is it okay if a slug contains a literal tab character? If so, what is it about spaces that requires special handling? (I'm not saying it doesn't require special handling, just trying to understand.)\nGenerally speaking, slugs are treated as string literals, yes? So, if I create an object with a slug of %D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82 is that the object's literal id or is it \u043e\u0431\u044a\u0435\u043a\u0442?", "author": "pwinckles", "createdAt": "2020-11-02T13:34:31Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -799,6 +797,11 @@ private void handleRequestDisallowedOnMemento() {\n     private FedoraId mintNewPid(final FedoraId fedoraId, final String slug) {\n         final String pid;\n \n+        if (!isBlank(slug) && slug.contains(\" \")) {\n+            // Can't use a literal space\n+            throw new CannotCreateResourceException(\"Slug cannot include literal spaces\");", "originalCommit": "279d34bd361c6ce53200adf22dd88388c13f64cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE2Nzk2NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516167964", "bodyText": "Jersey un-encodes the path so (my understanding) is the id would be info:fedora/\u043e\u0431\u044a\u0435\u043a\u0442", "author": "whikloj", "createdAt": "2020-11-02T18:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NDE5Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516174193", "bodyText": "Sorry I misunderstood and misspoke. My understanding is we allow -H\"Slug: has%20spaces\" but we don't allow -H:\"Slug: has spaces\" because literal spaces are not allowed as part of a valid URI as defined in RFC-3986", "author": "whikloj", "createdAt": "2020-11-02T18:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NTM0OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516175349", "bodyText": "I think what you are asking is \"are we using the URL encoded or decoded form of the path\". We are using the decoded form with the exception of spaces. We can move to using the encoded form instead, but currently Jersey decodes on the way in for us. Then we need to work out how to generate a URI without double encoding the path.", "author": "whikloj", "createdAt": "2020-11-02T18:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5MTAzMQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516191031", "bodyText": "I don't see where https://tools.ietf.org/html/rfc3986 says you can't have spaces in URIs.\nIt would seem to me that a slug needs to be treated either as a string literal or as a url encoded value. It's odd to me that only spaces are required to be encoded. If Jersey is treating it as a url encoded value and it is decoding it before injecting the value in FedoraLdp, wouldn't there always be a \" \" in a slug that contains + or %20?", "author": "pwinckles", "createdAt": "2020-11-02T19:00:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzNzg5NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516237895", "bodyText": "My reading is the section 2.2 specifies what characters have a reserved purpose in a URI.\n\nreserved    = gen-delims / sub-delims\ngen-delims  = \":\" / \"/\" / \"?\" / \"#\" / \"[\" / \"]\" / \"@\"\nsub-delims  = \"!\" / \"$\" / \"&\" / \"'\" / \"(\" / \")\" / \"*\" / \"+\" / \",\" / \";\" / \"=\"\n\nand section 2.3 specifies which characters have an unreserved purpose in a URI.\n\nCharacters that are allowed in a URI but do not have a reserved\npurpose are called unreserved.  These include uppercase and lowercase\nletters, decimal digits, hyphen, period, underscore, and tilde.\nunreserved  = ALPHA / DIGIT / \"-\" / \".\" / \"_\" / \"~\"\n\nSpaces are not defined in either of those sections and so have no purpose in a URI.\nJersey automatically (I think) handles it when you try to add spaces to the URI you are attempting to access, as you encountered above. As Slugs are passed in as headers which do allow spaces but they are to meant be part of the URI so we enforce this requirement to have the end-user percent encode their spaces.", "author": "whikloj", "createdAt": "2020-11-02T20:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2Mzg1OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1782#discussion_r516263859", "bodyText": "I have reverted this change for a later attempt.", "author": "whikloj", "createdAt": "2020-11-02T21:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk3Mzk2Ng=="}], "type": "inlineReview"}, {"oid": "84fc3499ae5c27970cc9b94942ac3f5995e04ae2", "url": "https://github.com/fcrepo/fcrepo/commit/84fc3499ae5c27970cc9b94942ac3f5995e04ae2", "message": "Revert \"Unencode spaces so they don't get double encoded, encode spaces so they don't appear as literal spaces\"\n\nThis reverts commit 279d34bd361c6ce53200adf22dd88388c13f64cd.", "committedDate": "2020-11-02T21:22:54Z", "type": "commit"}, {"oid": "a8de54c0120a21b3ed5b0598b60b0a8baf3ad6da", "url": "https://github.com/fcrepo/fcrepo/commit/a8de54c0120a21b3ed5b0598b60b0a8baf3ad6da", "message": "Revert \"Reject spaces in Slugs\"\n\nThis reverts commit 97a6460c21def397188e66583d5d79b7bb6af0d5.", "committedDate": "2020-11-02T21:23:15Z", "type": "commit"}, {"oid": "ab2a49e9176f34f58908402d56f49eba53e58a7b", "url": "https://github.com/fcrepo/fcrepo/commit/ab2a49e9176f34f58908402d56f49eba53e58a7b", "message": "Revert changes for spaces in IDs", "committedDate": "2020-11-02T21:24:49Z", "type": "commit"}]}