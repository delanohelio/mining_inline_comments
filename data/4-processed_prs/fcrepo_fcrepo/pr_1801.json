{"pr_number": 1801, "pr_title": "Rebuild containment index to support deleted objects", "pr_createdAt": "2020-11-13T04:31:45Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1801", "timeline": [{"oid": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6", "url": "https://github.com/fcrepo/fcrepo/commit/61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6", "message": "Rebuild containment index to support deleted objects", "committedDate": "2020-11-13T04:27:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxOTAyNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r522619027", "bodyText": "I had to switch this back as getResourceId only deals with things that have an actual file backing them.\nA get to a timemap returned both the mementos but also the containment from the Original Resource. So I switched back to this method", "author": "whikloj", "createdAt": "2020-11-13T04:33:46Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -395,7 +395,7 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getResourceId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "originalCommit": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk2MTMyOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r522961328", "bodyText": "Recognizing that this is not new code, I believe this input stream is not being closed.", "author": "pwinckles", "createdAt": "2020-11-13T13:50:16Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/ReindexService.java", "diffHunk": "@@ -118,17 +118,23 @@ public void indexOcflObject(final String txId, final String ocflId) {\n                                     String.format(\"Resource %s must have a parent defined\", fedoraId.getFullId()));\n                         }\n                     }\n-                    if (!headers.getInteractionModel().equals(NON_RDF_SOURCE.toString())) {\n-                        final Optional<InputStream> content = session.readContent(fedoraId.getFullId())\n-                                .getContentStream();\n-                        if (content.isPresent()) {\n-                            final RdfStream rdf = parseRdf(fedoraId, content.get());\n-                            this.referenceService.updateReferences(txId, fedoraId, null, rdf);\n+                    final var created = headers.getCreatedDate();\n+                    if (!headers.isDeleted()) {\n+                        if (!headers.getInteractionModel().equals(NON_RDF_SOURCE.toString())) {\n+                            final Optional<InputStream> content = session.readContent(fedoraId.getFullId())\n+                                    .getContentStream();\n+                            if (content.isPresent()) {\n+                                final RdfStream rdf = parseRdf(fedoraId, content.get());", "originalCommit": "61cf4732d9ae30ec0a08827db88bdfdbaf06ebe6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0692fb8a4169e57f291a854a2c532bdeae20c795", "url": "https://github.com/fcrepo/fcrepo/commit/0692fb8a4169e57f291a854a2c532bdeae20c795", "message": "Close stream", "committedDate": "2020-11-13T14:55:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAwODM3MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r523008370", "bodyText": "This will work, but it's slightly unexpected behavior. Generally speaking, streams are closed on the same level that they're opened on. For example,\ntry (final var stream = content.get()) {\n    final RdfStream rdf = parseRdf(fedoraId, stream);\n    this.referenceService.updateReferences(txId, fedoraId, null, rdf);\n}\nThere are a variety of advantages to this approach, not the least of which is that it's clear when a stream is closed and you don't need to inspect every method that the stream is passed to to see if it closes it.", "author": "pwinckles", "createdAt": "2020-11-13T15:05:36Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/ReferenceServiceImpl.java", "diffHunk": "@@ -302,6 +302,8 @@ public void updateReferences(@Nonnull final String txId, final FedoraId resource\n             LOGGER.warn(\"Unable to update reference index for resource {} in transaction {}: {}\",\n                     resourceId.getFullId(), txId, e.getMessage());\n             throw new RepositoryRuntimeException(\"Unable to update reference index\", e);\n+        } finally {\n+            rdfStream.close();", "originalCommit": "0692fb8a4169e57f291a854a2c532bdeae20c795", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE5NDEwNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r523194106", "bodyText": "So its going to end up looking like this\ntry (final var stream = content.get()) {\n    final RdfStream rdf = parseRdf(fedoraId, stream);\n    this.referenceService.updateReferences(txId, fedoraId, null, rdf);\n} catch (final IOException e) {\n    LOGGER.warn(\"Content stream for {} closed prematurely, inbound references skipped.\",\n        fedoraId.getFullId());\n    throw new RepositoryRuntimeException(e.getMessage(), e);\n}\n(I think) because its already in a try {} enclosure. Do I also need to close the RdfStream?", "author": "whikloj", "createdAt": "2020-11-13T20:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAwODM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwNjExNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1801#discussion_r523206117", "bodyText": "Yes, that looks correct.\nI poked around in the code, and it looks like what's going on is the InputStream is read into an RDF model object and then that model object is turned into an RdfStream. The RdfStream has no relation to the InputStream. It is a stream in the Java 8 Streaming sense, and very likely does not need to be closed. Streams can be closed, but, unless the Stream is IO related, it is usually not necessary.", "author": "pwinckles", "createdAt": "2020-11-13T20:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAwODM3MA=="}], "type": "inlineReview"}, {"oid": "f408ef81561c6da04ab40768ff1be2f65b4124a0", "url": "https://github.com/fcrepo/fcrepo/commit/f408ef81561c6da04ab40768ff1be2f65b4124a0", "message": "Close where it opened", "committedDate": "2020-11-13T20:19:37Z", "type": "commit"}]}