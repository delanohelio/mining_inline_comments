{"pr_number": 1711, "pr_title": "Don't delete if never created", "pr_createdAt": "2020-07-06T17:17:38Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1711", "timeline": [{"oid": "7d2726571102abaa3686d073edd71110df1da61c", "url": "https://github.com/fcrepo/fcrepo/commit/7d2726571102abaa3686d073edd71110df1da61c", "message": "Ensure files are marked as deleted", "committedDate": "2020-07-06T19:20:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNjM3OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450826378", "bodyText": "It's more conventional for this type of method to be named isX() as in isNewInSession().", "author": "pwinckles", "createdAt": "2020-07-07T12:29:07Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/api/OCFLObjectSession.java", "diffHunk": "@@ -165,4 +165,12 @@\n      * @return the digest algorithm used by the OCFL object\n      */\n     DIGEST_ALGORITHM getObjectDigestAlgorithm();\n+\n+    /**\n+     * Determine if the subpath is new to this session (has no versions committed).\n+     *\n+     * @param subpath the subpath to the resource.\n+     * @return true if this subpath has never been committed.\n+     */\n+    boolean newInSession(final String subpath);", "originalCommit": "b92da1feada6b17a36158eca584f5b484e81a57d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgzMTE1NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450831154", "bodyText": "Thinking about this some more, this method as currently defined is a little ambiguous. I can think of the following possibilities:\n\nsubpath exists in an OCFL version\nsubpath does not exist in an OCFL version but it does in staging\nsubpath does not exist in an OCFL version and does not exist in staging\n\nWhat is returned in the third case? false would seem to indicate that it exists in staging, but it doesn't.\nPerhaps an easy solution to this is to call the method something like isPersisted() to indicate whether or not a subpath has been persisted with no indication if the subpath is staged?", "author": "pwinckles", "createdAt": "2020-07-07T12:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1ODQ0Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450958446", "bodyText": "So my assumption (and that is probably the issue) is new in session meant it had not been persisted to an OCFL version (or mutable head). That is what I was worried about, is this thing in OCFL or just in staging.\nSo based on that, do you want me to change the method name to isPersisted(final String subpath)?", "author": "whikloj", "createdAt": "2020-07-07T15:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNjM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyODc0MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450828740", "bodyText": "Perhaps there could be a version of isNewInSession() that returns true if the OCFL object itself is new in the session? It seems a little wrong to me to base this logic on an exception being thrown from listHeadSubpaths(). In fact, it seems like a bug to me that listHeadSubpaths() is throwing an exception rather than returning an empty stream.", "author": "pwinckles", "createdAt": "2020-07-07T12:33:26Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -62,8 +63,12 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         if (fedoraResourceRoot.equals(resourceId)) {\n             // We are at the root of the object, so delete all the data files.\n             try {\n-                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                final Stream<String> files = objectSession.listHeadSubpaths();\n+                files.filter(p -> !isSidecarSubpath(p)).forEach(\n                         p -> deletePathWrapped(p, objectSession, user, deleteTime));\n+            } catch (final PersistentStorageException exc) {", "originalCommit": "b92da1feada6b17a36158eca584f5b484e81a57d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDI1OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1711#discussion_r450844259", "bodyText": "As mentioned earlier, this seems like a bug. I think it makes more sense if an empty stream is returned if the object does not exist in OCFL.", "author": "pwinckles", "createdAt": "2020-07-07T12:59:10Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSession.java", "diffHunk": "@@ -564,11 +568,15 @@ public synchronized void close() throws PersistentStorageException {\n     @Override\n     public Stream<String> listHeadSubpaths() throws PersistentStorageException {\n         assertSessionOpen();\n-\n-        return this.ocflRepository.describeVersion(ObjectVersionId.head(this.objectIdentifier))\n-                .getFiles().stream()\n-                .map(FileDetails::getPath)\n-                .map(this::decode);\n+        try {\n+            return this.ocflRepository.describeVersion(ObjectVersionId.head(this.objectIdentifier))\n+                    .getFiles()\n+                    .stream()\n+                    .map(FileDetails::getPath)\n+                    .map(this::decode);\n+        } catch (final NotFoundException exc) {\n+            throw new PersistentStorageException(exc);", "originalCommit": "b92da1feada6b17a36158eca584f5b484e81a57d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e5f02f685bc4b354dd9427fd8e31ff0418875e44", "url": "https://github.com/fcrepo/fcrepo/commit/e5f02f685bc4b354dd9427fd8e31ff0418875e44", "message": "Don't delete if never created", "committedDate": "2020-07-07T15:20:18Z", "type": "commit"}, {"oid": "3e16d184e07af9282bd23f658f454db903062bbc", "url": "https://github.com/fcrepo/fcrepo/commit/3e16d184e07af9282bd23f658f454db903062bbc", "message": "add some more tests", "committedDate": "2020-07-07T15:32:57Z", "type": "commit"}, {"oid": "3e16d184e07af9282bd23f658f454db903062bbc", "url": "https://github.com/fcrepo/fcrepo/commit/3e16d184e07af9282bd23f658f454db903062bbc", "message": "add some more tests", "committedDate": "2020-07-07T15:32:57Z", "type": "forcePushed"}, {"oid": "2ffcf41ea74c9b7503d25eac8f7a8aa80f0d3a2a", "url": "https://github.com/fcrepo/fcrepo/commit/2ffcf41ea74c9b7503d25eac8f7a8aa80f0d3a2a", "message": "Rename to isNewInSession", "committedDate": "2020-07-07T16:30:28Z", "type": "commit"}, {"oid": "4e0cb12f1fb4a3c2f6f81b239ce070fce056774b", "url": "https://github.com/fcrepo/fcrepo/commit/4e0cb12f1fb4a3c2f6f81b239ce070fce056774b", "message": "Add isNewInSession()", "committedDate": "2020-07-07T17:07:22Z", "type": "commit"}]}