{"pr_number": 1761, "pr_title": "Enforce server managed predicates and types, add interaction model to containment index.", "pr_createdAt": "2020-09-30T19:30:41Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1761", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1NzcwNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498257707", "bodyText": "Not a big deal, but this should probably be either:\nStringUtils.isNotBlank(interactionModel) && StringUtils.isNotBlank(resInteractionModel)\nor\nStringUtils.isNoneBlank(interactionModel, resInteractionModel)", "author": "pwinckles", "createdAt": "2020-10-01T13:47:59Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -395,13 +397,12 @@ public Response createOrReplaceObjectRdf(\n                 throw new ClientErrorException(\"An If-Match header is required\", 428);\n             }\n \n-            // TODO: Check existing resources interaction model and make sure we aren't trying to change it.\n-            //final String resInteractionModel = getInteractionModel(resource);\n-            //if (StringUtils.isNoneBlank(interactionModel) && StringUtils.isNoneBlank(resInteractionModel)\n-            //        && !resInteractionModel.equals(interactionModel)) {\n-            //    throw new InteractionModelViolationException(\"Changing the interaction model \" + resInteractionModel\n-            //            + \" to \" + interactionModel + \" is not allowed!\");\n-            //}\n+            final String resInteractionModel = getInteractionModel(transaction, fedoraId);\n+            if (StringUtils.isNoneBlank(interactionModel) && StringUtils.isNoneBlank(resInteractionModel)", "originalCommit": "9be6f0947486a3156d66fb8ee71f0c080488bd2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2MDI5Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498260297", "bodyText": "Actually, I think the entire condition could be written as:\nif (!Objects.equals(resInteractionModel, interactionModel)) {..}", "author": "pwinckles", "createdAt": "2020-10-01T13:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1NzcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ4NDU0NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498484544", "bodyText": "I had to keep the StringUtils.isNoneBlank but I did add the Objects.equals too. Because I can only compare if they both are not blank.", "author": "whikloj", "createdAt": "2020-10-01T20:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1NzcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2NTAzMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498265032", "bodyText": "Why is this special cased?", "author": "pwinckles", "createdAt": "2020-10-01T13:57:37Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraBaseResource.java", "diffHunk": "@@ -92,6 +94,13 @@ protected boolean doesResourceExist(final Transaction transaction, final FedoraI\n         return resourceFactory.doesResourceExist(transaction, fedoraId);\n     }\n \n+    protected String getInteractionModel(final Transaction transaction, final FedoraId fedoraId) {\n+        if (fedoraId.isDescription()) {", "originalCommit": "9be6f0947486a3156d66fb8ee71f0c080488bd2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxNzA2OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498317068", "bodyText": "My understanding, but I could be wrong that binaries exist in the containment index but not binary descriptions.", "author": "whikloj", "createdAt": "2020-10-01T15:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2NTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxOTI1MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498319251", "bodyText": "But, aren't you asking the ResourceFactory and not the ContainmentIndex?", "author": "pwinckles", "createdAt": "2020-10-01T15:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2NTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyODYyNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498328625", "bodyText": "Fair point, I was having a problem which I may have mis-diagnosed. I'll dig in after the call today.", "author": "whikloj", "createdAt": "2020-10-01T15:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2NTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3Nzk4Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498277983", "bodyText": "I'm not sure if I follow why the interaction model is being added to the containment index. Is it just a place to stick it so that the resource headers don't need to be read?", "author": "pwinckles", "createdAt": "2020-10-01T14:14:57Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -150,6 +150,42 @@ public FedoraResource getContainer(final String transactionId, final FedoraId re\n         }\n     }\n \n+    @Override\n+    public String getInteractionModel(final String transactionId, final FedoraId fedoraId) {\n+        if (fedoraId.isRepositoryRoot()) {\n+            return BASIC_CONTAINER.getURI();\n+        }\n+        if (!(fedoraId.isMemento() || fedoraId.isAcl())) {\n+            // containment index doesn't handle versions and only tells us if the resource (not acl) is there,\n+            // so don't bother checking for them.\n+            return containmentIndex.getInteractionModel(transactionId, fedoraId);", "originalCommit": "9be6f0947486a3156d66fb8ee71f0c080488bd2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxNzMxNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498317316", "bodyText": "Yes speed was the contributing factor.", "author": "whikloj", "createdAt": "2020-10-01T15:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3Nzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyNjUzMQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498326531", "bodyText": "Hm... I think we should think about this more. It feels like data is being tacked on here just because it's a place to put it.\nIn the cases where getInteractionModel() is used, how often are the ResourceHeaders still loaded as part of processing the request? If the headers are still being loaded most of the time, then it would seem to me that a better optimization would be to cache the resource headers rather than sticking the interaction model in the database.\nIf we do want this information in the database, then I think we should consider instead putting all of the resource headers into the database as a new table.", "author": "pwinckles", "createdAt": "2020-10-01T15:18:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3Nzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3ODI1OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r498478258", "bodyText": "Ok containment index is left alone.", "author": "whikloj", "createdAt": "2020-10-01T19:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3Nzk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5MzY3Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499893677", "bodyText": "You can probably remove the newType variable... since the value is only used once. Additionally, the toString() method will be called by default within \"String.format(...)\", and does not need to be invoked explicitly.", "author": "awoods", "createdAt": "2020-10-05T21:54:03Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5MzczNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499893737", "bodyText": "You can probably remove the newType variable... since the value is only used once. Additionally, the toString() method will be called by default within \"String.format(...)\", and does not need to be invoked explicitly.", "author": "awoods", "createdAt": "2020-10-05T21:54:14Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();\n+            throw new MalformedRdfException(\n+                    String.format(\"Invalid rdf:type: %s\", newType));\n+        } else if (restrictedType.test(triple)) {\n+            // The object of a rdf:type triple has a restricted namespace.\n+            final var newType = triple.getObject().toString();", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5Mzg0Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499893843", "bodyText": "The toString() method will be called by default within \"String.format(...)\", and does not need to be invoked explicitly.", "author": "awoods", "createdAt": "2020-10-05T21:54:27Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();\n+            throw new MalformedRdfException(\n+                    String.format(\"Invalid rdf:type: %s\", newType));\n+        } else if (restrictedType.test(triple)) {\n+            // The object of a rdf:type triple has a restricted namespace.\n+            final var newType = triple.getObject().toString();\n+            throw new InteractionModelViolationException(\n+                    String.format(\"Changing this resource's interaction model to %s is not allowed\", newType));\n+        } else if (isManagedPredicate.test(createProperty(triple.getPredicate().getURI()))) {\n+            // The predicate is server managed.\n+            throw new ServerManagedPropertyException(\n+                    String.format(\"The server managed predicate (%s) cannot be modified by the client.\",", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5OTIzOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499899239", "bodyText": "Is there actually anything \"todo\"?", "author": "awoods", "createdAt": "2020-10-05T22:07:56Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -3203,13 +3195,16 @@ public void testCreateResourceWithoutContentType() {\n         assertEquals(CREATED.getStatusCode(), getStatus(new HttpPut(serverAddress + getRandomUniqueId())));\n     }\n \n+    /*\n+     * TODO: This was originally expecting a 415 Unsupported Media Type, but because we assume text/turtle now it", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMzc0MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500313740", "bodyText": "Sorry I just wanted to keep track of these little changes to the interactions. If going from 415 to 400 is fine, then I can remove the TODO.", "author": "whikloj", "createdAt": "2020-10-06T14:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5OTIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM0MDc4OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500340789", "bodyText": "The change in response code here is probably ok.", "author": "awoods", "createdAt": "2020-10-06T14:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg5OTIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMDYzNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499900637", "bodyText": "Are you saying that a malformed SPARQL-Update request should silently fail? It seems like BAD_REQUEST is a more correct response. Am I missing something?", "author": "awoods", "createdAt": "2020-10-05T22:11:45Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/FedoraLdpIT.java", "diffHunk": "@@ -3262,7 +3253,7 @@ public void testBinarySetBadMimeType() throws IOException {\n                 \"INSERT { <\" + subjectURI + \"> ebucore:hasMimeType \\\"-- invalid syntax! --\\\" } WHERE {}\")\n         );\n \n-        assertEquals(BAD_REQUEST.getStatusCode(), getStatus(patch));", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxOTk5OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500319999", "bodyText": "Its actually not invalid syntax unless we want to parse all ontologies for their targets and domains.\nThis was a problem because we relied on this particular triple to send the binary response. Now we store the mime-type in the headers file and this is user rdf. If they want the triple <> ebucore:hasMimeType \"I want my baby back baby back baby back\" that is up to them.\nI could modify this test to check that the binary is still retrievable and the user rdf says whatever or I can remove the entire test.", "author": "whikloj", "createdAt": "2020-10-06T14:15:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMDYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNzU3MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499907571", "bodyText": "It certainly can work here; however, it seems like \"getInteractionModel\" would more appropriately be a \"FedoraResource\" method, rather than a \"ResourceFactory\" method.\nThe following is available on \"FedoraResourceImpl\"\npsSession.getHeaders(fedoraId, fedoraId.getMementoInstant());\n\nWould it make sense for \"FedoraLdp\" to create the known-to-exist resource, then request its interaction-model?", "author": "awoods", "createdAt": "2020-10-05T22:31:09Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/models/ResourceFactory.java", "diffHunk": "@@ -112,4 +112,12 @@ public FedoraResource getResource(final String transactionId, final FedoraId fed\n      * @return Stream of child resources\n      */\n     public Stream<FedoraResource> getChildren(final String transactionId, final FedoraId resourceId);\n+\n+    /**\n+     * Get the interaction model of the resource, assumes you've checked it exists already.\n+     * @param transactionId The transaction id\n+     * @param fedoraId Identifier of the resource.\n+     * @return The interaction model.\n+     */\n+    public String getInteractionModel(final String transactionId, final FedoraId fedoraId);", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMTY3NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500301675", "bodyText": "+1 to a FedoraResource method for getInteractionModel, i've found myself looking for it multiple times.", "author": "bbpennel", "createdAt": "2020-10-06T13:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNzU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMyMDQxNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500320415", "bodyText": "I'm fine with that.", "author": "whikloj", "createdAt": "2020-10-06T14:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwNzU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwODQyMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499908423", "bodyText": "Maybe update this comment to describe what qualifies as a \"restricted namespace\", vs talking about \"setting\" rdf:types... which this predicate is not doing.", "author": "awoods", "createdAt": "2020-10-05T22:33:43Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/RdfLexicon.java", "diffHunk": "@@ -86,6 +88,12 @@\n     public static final Predicate<String> isManagedNamespace = p -> p.equals(REPOSITORY_NAMESPACE) ||\n             p.equals(LDP_NAMESPACE) || p.equals(MEMENTO_NAMESPACE);\n \n+    /**\n+     * Tests if we are trying to set the rdf:type to an object with a restricted namespace.", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwODc3NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499908774", "bodyText": "Nice finds. Can you create a ticket to purge these relics?", "author": "awoods", "createdAt": "2020-10-05T22:34:50Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/RdfLexicon.java", "diffHunk": "@@ -259,21 +267,25 @@\n     /**\n      * Fedora defined JCR node type with supertype of nt:file with two nt:folder named fedora:timemap and\n      * fedora:binaryTimemap inside.\n+     * TODO: Remove modeshape-ism?", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwOTQ4MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499909480", "bodyText": "The headers for the RepositoryRoot also indicate its interaction model. Is the potential performance optimization here worth the redundant logic?", "author": "awoods", "createdAt": "2020-10-05T22:36:55Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -150,6 +150,35 @@ public FedoraResource getContainer(final String transactionId, final FedoraId re\n         }\n     }\n \n+    @Override\n+    public String getInteractionModel(final String transactionId, final FedoraId fedoraId) {\n+        if (fedoraId.isRepositoryRoot()) {", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwOTk1Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499909953", "bodyText": "It does not look like this is a function update. Can you revert the reformatting?", "author": "awoods", "createdAt": "2020-10-05T22:38:18Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -116,8 +116,8 @@\n      * Insert a parent child relationship to the transaction operation table.\n      */\n     private static final String INSERT_CHILD_IN_TRANSACTION = \"INSERT INTO \" + TRANSACTION_OPERATIONS_TABLE +\n-            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" + OPERATION_COLUMN +\n-            \" ) VALUES (:parent, :child, :transactionId, 'add')\";\n+            \" ( \" + PARENT_COLUMN + \", \" + FEDORA_ID_COLUMN + \", \" + TRANSACTION_ID_COLUMN + \", \" +", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxMDQyNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r499910425", "bodyText": "I believe all updates to this file can be reverted.", "author": "awoods", "createdAt": "2020-10-05T22:39:45Z", "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/ContainmentIndexImplTest.java", "diffHunk": "@@ -78,6 +79,8 @@\n     private final Map<String, FedoraResource> id_to_resource = new HashMap<>();\n     private final Map<String, Transaction> id_to_transaction = new HashMap<>();\n \n+    private final String ixnModel = BASIC_CONTAINER.getURI();", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MTMyOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500291329", "bodyText": "I'm not really sure of the state of lenient at the moment, but shouldn't it be okay to specify a restricted type if it's already the interaction model of this resource?", "author": "bbpennel", "createdAt": "2020-10-06T13:45:28Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -230,4 +236,34 @@ protected static Model parseBodyAsModel(final InputStream requestBodyStream,\n         }\n     }\n \n+    /**\n+     * Checks if the RDF contains any disallowed statements.\n+     * @param statement a statement from the incoming RDF.\n+     */\n+    private static void checkForDisallowedRdf(final Statement statement) {\n+        checkTripleForDisallowed(statement.asTriple());\n+    }\n+\n+    /**\n+     * Several tests for invalid or disallowed RDF statements.\n+     * @param triple the triple to check.\n+     */\n+    public static void checkTripleForDisallowed(final Triple triple) {\n+        if (triple.getPredicate().equals(type().asNode()) && !triple.getObject().isURI()) {\n+            // The object of a rdf:type triple is not a URI.\n+            final var newType = triple.getObject().toString();\n+            throw new MalformedRdfException(\n+                    String.format(\"Invalid rdf:type: %s\", newType));\n+        } else if (restrictedType.test(triple)) {", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzNzk4Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500337987", "bodyText": "\ud83e\udd26 I forgot to add the lenient handling. Mea culpa.", "author": "whikloj", "createdAt": "2020-10-06T14:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MTMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU1NjkyMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500556923", "bodyText": "This is now allowed if you provide handling=lenient because we just remove those triples from the provided RDF.", "author": "whikloj", "createdAt": "2020-10-06T19:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MTMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMDU0Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500300543", "bodyText": "I'm just curious, does RDF.type cause issues? It appears to be a constant declaration of the result from RDF.Init.type(), not sure if we need to initialize it new each time?", "author": "bbpennel", "createdAt": "2020-10-06T13:55:05Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/RdfLexicon.java", "diffHunk": "@@ -86,6 +88,12 @@\n     public static final Predicate<String> isManagedNamespace = p -> p.equals(REPOSITORY_NAMESPACE) ||\n             p.equals(LDP_NAMESPACE) || p.equals(MEMENTO_NAMESPACE);\n \n+    /**\n+     * Tests if we are trying to set the rdf:type to an object with a restricted namespace.\n+     */\n+    public static final Predicate<Triple> restrictedType = s -> s.getPredicate().equals(type().asNode()) &&", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMzODkzOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500338938", "bodyText": "public static final Property type = Init.type();\nSo I'm not sure it matters, but I can change it.", "author": "whikloj", "createdAt": "2020-10-06T14:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMDU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3Njc0OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500376748", "bodyText": "I doubt it has much impact, but RDF.Init.type() is a call to ResourceFactory.createProperty while it seems like RDF.type is a constant of that result.", "author": "bbpennel", "createdAt": "2020-10-06T15:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMDU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMTQ5NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500311495", "bodyText": "It seems like some of the functionality here is duplicating some checks in AbstractService:\nhttps://github.com/fcrepo/fcrepo/blob/main/fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/AbstractService.java#L154\nWere you thinking we would remove the check in AbstractService?\nOne advantage to where it is in AbstractService is that it is validating the model after a sparql update query has been applied to the model, in the case of PATCH. I don't think this method is called for PATCH currently?", "author": "bbpennel", "createdAt": "2020-10-06T14:06:21Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/services/HttpRdfService.java", "diffHunk": "@@ -117,6 +122,7 @@ public Model bodyToInternalModel(final String extResourceId, final InputStream s\n \n         while (stmtIterator.hasNext()) {\n             final Statement stmt = stmtIterator.nextStatement();\n+            checkForDisallowedRdf(stmt);", "originalCommit": "c103fb37731750d91c77ade68a594bda6f897b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMyMjAzMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500322033", "bodyText": "I don't know if this is a concern or not, but it might be unpredictable which error response you get from a request if the input contains both an interaction model change and a server managed triple. By checking for all the errors in the same loop (or not deferring the error thrown), whichever error is encountered first will be the result. Maybe that's fine, I was just concerned about that when looking at some tests, since the order of RDF is not generally guaranteed.\nFor what its worth, I stupidly hadn't noticed this PR yesterday and had started implementing checks for interaction model changes in my work on membership triples since so many of the Direct/Indirect container tests are about interaction model changes. I had added this method to ReplacePropertiesServiceImpl:\nprivate void ensureInteractionModelUnchanged(final FedoraId fedoraId, final Model model,\n            final String existingInteractionModel) {\n        final var rdfResc = model.getResource(fedoraId.getFullId());\n        final StmtIterator it = rdfResc.listProperties(RDF.type);\n        while (it.hasNext()) {\n            final Statement st = it.next();\n            if (!st.getObject().isURIResource()) {\n                continue;\n            }\n            final var objUri = st.getResource().getURI();\n\n            if (INTERACTION_MODELS_FULL.contains(objUri) && !objUri.equals(existingInteractionModel)) {\n                throw new InteractionModelViolationException(\"Changing the interaction model \"\n                        + existingInteractionModel + \" to \" + objUri + \" is not allowed!\");\n            }\n        }\n    }\n\nI was running this before checkForSmtsLdpTypes. On the other hand adding more iterations through the model will add up.\nbut wanted to make sure that if the request was changing the interaction model, that we would get the error for that over an error for", "author": "bbpennel", "createdAt": "2020-10-06T14:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1MDM5Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500350396", "bodyText": "You are right about some duplication at the AbstractService layer. I had forgotten about that. As we are already looping through the entire incoming RDF/Sparql-update at the Http layer perhaps removing those checks from the lower level would be better?\nThis does check PATCH requests as we also loop through them to translate any external URIs to internal IDs.\nAs for storing up exceptions...I'm a believer in here is your first problem, come back later. But also I am wondering is if you try to change a server managed triple and change the interaction model in a single request. Do you expect a 409 or 400?", "author": "whikloj", "createdAt": "2020-10-06T14:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM4MzE5Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1761#discussion_r500383193", "bodyText": "Seems like we either need to define precedence for exception types (maybe prioritize specificity?), or leave it as a free for all. Flapping tests seem possible without any sort of precedence, but that doesn't seem to have been a problem so far. Not sure if that's a function of jena not changing significantly, the order in which checks happen in Fedora 4/5, or how the tests are written.", "author": "bbpennel", "createdAt": "2020-10-06T15:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxMTQ5NQ=="}], "type": "inlineReview"}, {"oid": "75e787e1760712ab38d3191bb9bc612d13e0b167", "url": "https://github.com/fcrepo/fcrepo/commit/75e787e1760712ab38d3191bb9bc612d13e0b167", "message": "Remove todo", "committedDate": "2020-10-06T21:00:33Z", "type": "forcePushed"}, {"oid": "6b454f1bf33516184ce3746c99cfd4370a3bcc0f", "url": "https://github.com/fcrepo/fcrepo/commit/6b454f1bf33516184ce3746c99cfd4370a3bcc0f", "message": "Remove todo", "committedDate": "2020-10-08T21:18:54Z", "type": "forcePushed"}, {"oid": "bf79cd1a09ff421e2435127f7ec1f1ef6cc9c262", "url": "https://github.com/fcrepo/fcrepo/commit/bf79cd1a09ff421e2435127f7ec1f1ef6cc9c262", "message": "Enforce server managed predicates and types.", "committedDate": "2020-10-10T21:53:54Z", "type": "commit"}, {"oid": "33be0dc4a541f54b151a29e9dd195f5f61f643f4", "url": "https://github.com/fcrepo/fcrepo/commit/33be0dc4a541f54b151a29e9dd195f5f61f643f4", "message": "Check for binaries interaction models in containment index.", "committedDate": "2020-10-10T21:53:54Z", "type": "commit"}, {"oid": "cb3a49446292fa448d8162a1317ede952c0e5bdf", "url": "https://github.com/fcrepo/fcrepo/commit/cb3a49446292fa448d8162a1317ede952c0e5bdf", "message": "Go direct to the headers", "committedDate": "2020-10-10T21:53:54Z", "type": "commit"}, {"oid": "8b361bcbba3882d495429c83ecf3e31b9d577307", "url": "https://github.com/fcrepo/fcrepo/commit/8b361bcbba3882d495429c83ecf3e31b9d577307", "message": "Move getInteractionModel to FedoraResource\n\nAdd handling=lenient allowances/checks\n\nCode review", "committedDate": "2020-10-10T21:55:56Z", "type": "commit"}, {"oid": "e473b9ee72e8b8471351712f0c0df97e89413ba2", "url": "https://github.com/fcrepo/fcrepo/commit/e473b9ee72e8b8471351712f0c0df97e89413ba2", "message": "Remove todo", "committedDate": "2020-10-10T21:55:56Z", "type": "commit"}, {"oid": "e473b9ee72e8b8471351712f0c0df97e89413ba2", "url": "https://github.com/fcrepo/fcrepo/commit/e473b9ee72e8b8471351712f0c0df97e89413ba2", "message": "Remove todo", "committedDate": "2020-10-10T21:55:56Z", "type": "forcePushed"}]}