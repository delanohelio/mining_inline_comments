{"pr_number": 1639, "pr_title": "Add integration test for repository rebuild functionality", "pr_createdAt": "2020-03-05T21:01:22Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1639", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MzY3MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388583670", "bodyText": "Perhaps the original value should be captured and restored in an @AfterClass method to avoid impacting other tests.", "author": "pwinckles", "createdAt": "2020-03-05T21:44:07Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.integration.http.api;\n+\n+\n+import edu.wisc.library.ocfl.api.OcflRepository;\n+import org.fcrepo.kernel.impl.operations.RdfSourceOperationFactoryImpl;\n+import org.fcrepo.persistence.ocfl.RepositoryInitializer;\n+import org.fcrepo.persistence.ocfl.impl.DefaultOCFLObjectSessionFactory;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexImpl;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexUtilImpl;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistenceConfig;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistentSessionManager;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.AnnotationConfigApplicationContext;\n+\n+import static java.lang.System.setProperty;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_STORAGE_ROOT_DIR_KEY;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_WORK_DIR_KEY;\n+\n+/**\n+ * @author awooods\n+ * @since 2020-03-04\n+ */\n+public class RebuildIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n+\n+    private OcflRepository ocflRepository;\n+\n+    private static AnnotationConfigApplicationContext ctx;\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        setProperty(OCFL_STORAGE_ROOT_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");", "originalCommit": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5NjQwNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388696406", "bodyText": "addressed", "author": "awoods", "createdAt": "2020-03-06T03:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4MzY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NTI4OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388585288", "bodyText": "There is only one test currently, could there be more in the future? If so, is the context dirtied by the existing test and worthwhile recreating?", "author": "pwinckles", "createdAt": "2020-03-05T21:47:39Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.integration.http.api;\n+\n+\n+import edu.wisc.library.ocfl.api.OcflRepository;\n+import org.fcrepo.kernel.impl.operations.RdfSourceOperationFactoryImpl;\n+import org.fcrepo.persistence.ocfl.RepositoryInitializer;\n+import org.fcrepo.persistence.ocfl.impl.DefaultOCFLObjectSessionFactory;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexImpl;\n+import org.fcrepo.persistence.ocfl.impl.FedoraToOCFLObjectIndexUtilImpl;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistenceConfig;\n+import org.fcrepo.persistence.ocfl.impl.OCFLPersistentSessionManager;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.AnnotationConfigApplicationContext;\n+\n+import static java.lang.System.setProperty;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_STORAGE_ROOT_DIR_KEY;\n+import static org.fcrepo.persistence.ocfl.impl.OCFLConstants.OCFL_WORK_DIR_KEY;\n+\n+/**\n+ * @author awooods\n+ * @since 2020-03-04\n+ */\n+public class RebuildIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n+\n+    private OcflRepository ocflRepository;\n+\n+    private static AnnotationConfigApplicationContext ctx;\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        setProperty(OCFL_STORAGE_ROOT_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");\n+        setProperty(OCFL_WORK_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-work\");\n+\n+        ctx = new AnnotationConfigApplicationContext(OCFLPersistenceConfig.class);\n+\n+        // RepositoryInitializer.initialize() happens as a part of the object's construction.\n+        ctx.register(RepositoryInitializer.class,\n+                OCFLPersistentSessionManager.class,\n+                RdfSourceOperationFactoryImpl.class,\n+                FedoraToOCFLObjectIndexUtilImpl.class,\n+                DefaultOCFLObjectSessionFactory.class,\n+                OCFLPersistenceConfig.class,\n+                FedoraToOCFLObjectIndexImpl.class);\n+\n+    }\n+\n+    @Before\n+    public void setUp() {\n+        ocflRepository = ctx.getBean(OcflRepository.class);", "originalCommit": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5NjQzMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388696433", "bodyText": "addressed", "author": "awoods", "createdAt": "2020-03-06T03:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NTI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4ODAxOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388588018", "bodyText": "It's a little funny to instantiate this class. Perhaps it can be injected?", "author": "pwinckles", "createdAt": "2020-03-05T21:52:27Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/RepositoryInitializer.java", "diffHunk": "@@ -63,10 +65,12 @@ public void initialize() {\n         final PersistentStorageSession session = this.sessionManager.getSession(\"initializationSession\" +\n                                                                                  System.currentTimeMillis());\n \n-        if (!FEDORA_TO_OCFL_INDEX_FILE.exists()) {\n+        final File fedoraToOcflIndexFile = new OCFLConstants().getFedoraToOCFLIndexFile();", "originalCommit": "dcbe994e8f51eb0cd7abadce8a0b763f719a4283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5NjgyNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r388696827", "bodyText": "I agree about instantiating the OCFLConstants class... but implementing the injecting is not working out. If you would like to create a pull-request against this pull-request... I will gladly merge it in; otherwise, I suggest we live with the slight funniness.", "author": "awoods", "createdAt": "2020-03-06T03:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4ODAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTEzOTk2MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r389139960", "bodyText": "Was there a reason this couldn't remain as static methods?", "author": "whikloj", "createdAt": "2020-03-06T20:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4ODAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE0MjgyMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r389142823", "bodyText": "If not, then awoods#11", "author": "whikloj", "createdAt": "2020-03-06T21:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4ODAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQyODY2MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r389428660", "bodyText": "@whikloj : The static methods prevented setting the OCFL directories in the integration test:\nhttps://github.com/fcrepo4/fcrepo4/pull/1639/files#diff-f210045277d54842209f1d5631554535R62\nNo matter how I tried to feed the updated OCFL directories into System or Env properties, the Maven values were always picked up.\nhttps://github.com/fcrepo4/fcrepo4/blob/master/pom.xml#L510-L512", "author": "awoods", "createdAt": "2020-03-09T01:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4ODAxOA=="}], "type": "inlineReview"}, {"oid": "5b42b5b3db34bded9c031705f9fcca25cd317052", "url": "https://github.com/fcrepo/fcrepo/commit/5b42b5b3db34bded9c031705f9fcca25cd317052", "message": "code review", "committedDate": "2020-03-06T03:26:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE0MzA2Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r389143066", "bodyText": "Oh I missed this in my PR, perhaps this was the problem. Checking", "author": "whikloj", "createdAt": "2020-03-06T21:04:14Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSessionFactory.java", "diffHunk": "@@ -54,7 +52,7 @@\n      * are not set, default directories will be created in java.io.tmpdir.\n      */\n     public DefaultOCFLObjectSessionFactory() {\n-        this(STAGING_DIR);\n+        this(new OCFLConstants().getStagingDir());", "originalCommit": "5b42b5b3db34bded9c031705f9fcca25cd317052", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQxNjUyNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1639#discussion_r389416527", "bodyText": "I have given up on avoiding all these instantiations. There is no way to @Inject into this class in a test without changing from a Mockito runner to using a Spring test runner and giving @ContextConfiguration to define all the bits because this constructor needs the underlying class right as the class is created.", "author": "whikloj", "createdAt": "2020-03-08T23:15:49Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/FedoraToOCFLObjectIndexImpl.java", "diffHunk": "@@ -57,8 +58,9 @@\n      * @throws IOException If we can't access the file.\n      */\n     public FedoraToOCFLObjectIndexImpl() throws IOException {\n-        if (FEDORA_TO_OCFL_INDEX_FILE.exists() && FEDORA_TO_OCFL_INDEX_FILE.canRead()) {\n-            try (var lines = Files.lines(FEDORA_TO_OCFL_INDEX_FILE.toPath())) {\n+        fedoraToOcflIndexFile = new OCFLConstants().getFedoraToOCFLIndexFile();", "originalCommit": "5b42b5b3db34bded9c031705f9fcca25cd317052", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4a4c4b72edc56e9489f6fdae77414742ae6e06d", "url": "https://github.com/fcrepo/fcrepo/commit/c4a4c4b72edc56e9489f6fdae77414742ae6e06d", "message": "Add integration test for repository rebuild functionality\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3210", "committedDate": "2020-03-11T21:59:11Z", "type": "commit"}, {"oid": "0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "url": "https://github.com/fcrepo/fcrepo/commit/0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "message": "code review", "committedDate": "2020-03-11T21:59:11Z", "type": "commit"}, {"oid": "0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "url": "https://github.com/fcrepo/fcrepo/commit/0ce5578c8459e5bf64f3e9832b32c858c53e2e0b", "message": "code review", "committedDate": "2020-03-11T21:59:11Z", "type": "forcePushed"}]}