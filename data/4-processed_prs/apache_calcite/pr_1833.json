{"pr_number": 1833, "pr_title": "[CALCITE-3828] MergeJoin throws NPE in case of null keys", "pr_createdAt": "2020-02-26T09:39:59Z", "pr_url": "https://github.com/apache/calcite/pull/1833", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQzMzU2Ng==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384433566", "bodyText": "we are done -> we are done. ?", "author": "chunweilei", "createdAt": "2020-02-26T11:26:40Z", "path": "linq4j/src/main/java/org/apache/calcite/linq4j/EnumerableDefaults.java", "diffHunk": "@@ -3829,6 +3829,12 @@ private boolean advance() {\n       TInner right = rightEnumerator.current();\n       TKey rightKey = innerKeySelector.apply(right);\n       for (;;) {\n+        // mergeJoin assumes inputs sorted in ascending order with nulls last,\n+        // if we reach a null key, we are done\n+        if (leftKey == null || rightKey == null) {\n+          done = true;", "originalCommit": "8693f6a2b66eea56034fbcd2265adea0c86436e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTExMA==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384445110", "bodyText": "Is it documented anywhere?", "author": "vlsi", "createdAt": "2020-02-26T11:52:32Z", "path": "linq4j/src/main/java/org/apache/calcite/linq4j/EnumerableDefaults.java", "diffHunk": "@@ -3829,6 +3829,12 @@ private boolean advance() {\n       TInner right = rightEnumerator.current();\n       TKey rightKey = innerKeySelector.apply(right);\n       for (;;) {\n+        // mergeJoin assumes inputs sorted in ascending order with nulls last,", "originalCommit": "8693f6a2b66eea56034fbcd2265adea0c86436e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1MjU3Ng==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384452576", "bodyText": "I'll add a comment about it in the javadoc of EnumerableDefaults#mergeJoin and EnumerableDefaults#MergeJoinEnumerator", "author": "rubenada", "createdAt": "2020-02-26T12:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NjcxNA==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384456714", "bodyText": "Comments have been added.", "author": "rubenada", "createdAt": "2020-02-26T12:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NzYxMA==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384457610", "bodyText": "The nulls order is actually defined by the RelFieldCollation, did we set it anywhere ?", "author": "danny0405", "createdAt": "2020-02-26T12:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1OTAxMQ==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384459011", "bodyText": "It's set by EnumerableMergeJoinRule:\n\n  \n    \n      calcite/core/src/main/java/org/apache/calcite/adapter/enumerable/EnumerableMergeJoinRule.java\n    \n    \n         Line 72\n      in\n      e427180\n    \n    \n    \n    \n\n        \n          \n           fieldCollations.add( \n        \n    \n  \n\n\nwhich forces EnumerableMergeJoin's inputs to be sorted by key ascending, nulls last.\nSo, this sort collation is assumed when we arrive to EnumerableDefaults#MergeJoinEnumerator (note that there is already some IllegalStateException in there if inputs are not in ascending order)", "author": "rubenada", "createdAt": "2020-02-26T12:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MTY4Ng==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384881686", "bodyText": "Reasonable, can you add this comments into the EnumerableDefaults code block.", "author": "danny0405", "createdAt": "2020-02-27T02:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk3NTU2Nw==", "url": "https://github.com/apache/calcite/pull/1833#discussion_r384975567", "bodyText": "@danny0405 , comment has been added in the javadoc of EnumerableDefaults#mergeJoin and EnumerableDefaults#MergeJoinEnumerator", "author": "rubenada", "createdAt": "2020-02-27T08:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0NTExMA=="}], "type": "inlineReview"}, {"oid": "f4e7ba51392a7bded79dc646133ab8b867f00aad", "url": "https://github.com/apache/calcite/commit/f4e7ba51392a7bded79dc646133ab8b867f00aad", "message": "[CALCITE-3828] MergeJoin throws NPE in case of null keys", "committedDate": "2020-03-05T10:46:28Z", "type": "forcePushed"}, {"oid": "4693635b0134b83d0a94814754398c89f9278ad2", "url": "https://github.com/apache/calcite/commit/4693635b0134b83d0a94814754398c89f9278ad2", "message": "[CALCITE-3828] MergeJoin throws NPE in case of null keys", "committedDate": "2020-03-05T11:22:40Z", "type": "commit"}, {"oid": "4693635b0134b83d0a94814754398c89f9278ad2", "url": "https://github.com/apache/calcite/commit/4693635b0134b83d0a94814754398c89f9278ad2", "message": "[CALCITE-3828] MergeJoin throws NPE in case of null keys", "committedDate": "2020-03-05T11:22:40Z", "type": "forcePushed"}]}