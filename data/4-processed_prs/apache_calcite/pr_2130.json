{"pr_number": 2130, "pr_title": "[CALCITE-4207] Validation fails for positional aggregate with current_date in 'case' expression", "pr_createdAt": "2020-09-02T06:03:39Z", "pr_url": "https://github.com/apache/calcite/pull/2130", "timeline": [{"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6", "url": "https://github.com/apache/calcite/commit/bc13e00ae59c2b0c739e886713f01e62a1fd97a6", "message": "[CALCITE-4207] Validation fails for positional aggregate with current_date in 'case' expression", "committedDate": "2020-09-02T09:39:46Z", "type": "commit"}, {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6", "url": "https://github.com/apache/calcite/commit/bc13e00ae59c2b0c739e886713f01e62a1fd97a6", "message": "[CALCITE-4207] Validation fails for positional aggregate with current_date in 'case' expression", "committedDate": "2020-09-02T09:39:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA==", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483503190", "bodyText": "I'm confused by why the current_date caused the problem, does other non-param function triggers the bug too ?", "author": "danny0405", "createdAt": "2020-09-04T09:30:47Z", "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "originalCommit": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMTIzMw==", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483511233", "bodyText": "Please take a look at the stack trace from CALCITE-4207 description and this comment.", "author": "ihuzenko", "createdAt": "2020-09-04T09:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxNDE0NA==", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483514144", "bodyText": "In one place CURRENT_DATE was represented as SqlBasicCall while in other it was instance of SqlIdentifier\n\nStill does not get your point, in you fix, you just use the expanded group expr for validation, but the CURRENT_DATE is not a group expr ?", "author": "danny0405", "createdAt": "2020-09-04T09:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU0OTQxNw==", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483549417", "bodyText": "Positional aggregate points to the first expression in select. Validation tries to match 2 expression trees :\n\nThe first item from select which is already expanded at the moment and contains current_date as an instance of SqlBasicCall\nAn item from the group by where prior to my fix current_date was presented as an instance of the SqlIdentifier.\n\nDue to this instance mismatch validation goes further and tells that Expression 'EMP.HIREDATE' is not being grouped, although grouping was performed by the whole expression HIREDATE >= CURRENT_DATE.", "author": "ihuzenko", "createdAt": "2020-09-04T11:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc3ODQ4Nw==", "url": "https://github.com/apache/calcite/pull/2130#discussion_r484778487", "bodyText": "Hello @danny0405 , could you proceed with reviewing the PR?", "author": "ihuzenko", "createdAt": "2020-09-08T09:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5Mzg2Mw==", "url": "https://github.com/apache/calcite/pull/2130#discussion_r485393863", "bodyText": "I tried the fix locally and think the fix is reasonable.", "author": "danny0405", "createdAt": "2020-09-09T07:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQzMTU2MA==", "url": "https://github.com/apache/calcite/pull/2130#discussion_r485431560", "bodyText": "Thanks for review:)", "author": "ihuzenko", "createdAt": "2020-09-09T08:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}], "type": "inlineReview"}]}