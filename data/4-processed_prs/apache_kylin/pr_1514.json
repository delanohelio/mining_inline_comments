{"pr_number": 1514, "pr_title": "KYLIN-4818 Check lookup table duplicate key when building job", "pr_createdAt": "2020-12-17T03:40:51Z", "pr_url": "https://github.com/apache/kylin/pull/1514", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzMTY1Mg==", "url": "https://github.com/apache/kylin/pull/1514#discussion_r544831652", "bodyText": "Please remove toString, it is meaningless.", "author": "hit-lacus", "createdAt": "2020-12-17T05:56:38Z", "path": "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala", "diffHunk": "@@ -183,6 +185,22 @@ class CubeSnapshotBuilder extends Logging {\n   }\n   import org.apache.kylin.engine.spark.utils.SparkDataSource._\n \n+  def checkDupKey() = {\n+    val joinDescs = seg.joindescs\n+    joinDescs.foreach {\n+      joinDesc =>\n+        val tableInfo = joinDesc.lookupTable\n+        val lookupTableName = tableInfo.tableName\n+        val df = ss.table(tableInfo)\n+        val countColumn = df.count().toString", "originalCommit": "ba01ded37ac005669c7e1152e99e2a9dc4428c46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f433bc1e3b85939257f107f54e1228b236ea2fa1", "url": "https://github.com/apache/kylin/commit/f433bc1e3b85939257f107f54e1228b236ea2fa1", "message": "KYLIN-4818 Check lookup table duplicate key when building job", "committedDate": "2020-12-17T05:59:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg0OTc1Nw==", "url": "https://github.com/apache/kylin/pull/1514#discussion_r544849757", "bodyText": "Replace lookupTablePKS: _* with lookupTablePKS.tail : _*.", "author": "hit-lacus", "createdAt": "2020-12-17T06:45:57Z", "path": "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala", "diffHunk": "@@ -183,6 +185,22 @@ class CubeSnapshotBuilder extends Logging {\n   }\n   import org.apache.kylin.engine.spark.utils.SparkDataSource._\n \n+  def checkDupKey() = {\n+    val joinDescs = seg.joindescs\n+    joinDescs.foreach {\n+      joinDesc =>\n+        val tableInfo = joinDesc.lookupTable\n+        val lookupTableName = tableInfo.tableName\n+        val df = ss.table(tableInfo)\n+        val countColumn = df.count()\n+        val lookupTablePKS = joinDesc.PKS.map(lookupTablePK => lookupTablePK.columnName)\n+        val countDistinctColumn = df.agg(countDistinct(joinDesc.PKS(0).columnName, lookupTablePKS: _*)).collect().map(_(0)).toList(0)", "originalCommit": "f433bc1e3b85939257f107f54e1228b236ea2fa1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg1NzA0MA==", "url": "https://github.com/apache/kylin/pull/1514#discussion_r544857040", "bodyText": "better change to : df.agg(countDistinct(lookupTablePKS(0), lookupTablePKS.tail : _*)).collect().map(_.getLong(0)).head", "author": "zzcclp", "createdAt": "2020-12-17T07:05:26Z", "path": "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala", "diffHunk": "@@ -183,6 +185,22 @@ class CubeSnapshotBuilder extends Logging {\n   }\n   import org.apache.kylin.engine.spark.utils.SparkDataSource._\n \n+  def checkDupKey() = {\n+    val joinDescs = seg.joindescs\n+    joinDescs.foreach {\n+      joinDesc =>\n+        val tableInfo = joinDesc.lookupTable\n+        val lookupTableName = tableInfo.tableName\n+        val df = ss.table(tableInfo)\n+        val countColumn = df.count()\n+        val lookupTablePKS = joinDesc.PKS.map(lookupTablePK => lookupTablePK.columnName)\n+        val countDistinctColumn = df.agg(countDistinct(joinDesc.PKS(0).columnName, lookupTablePKS: _*)).collect().map(_(0)).toList(0)", "originalCommit": "f433bc1e3b85939257f107f54e1228b236ea2fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg2MDQ0NQ==", "url": "https://github.com/apache/kylin/pull/1514#discussion_r544860445", "bodyText": "Thank you for your review @hit-lacus  @zzcclp  I have updated this PR.", "author": "zhangayqian", "createdAt": "2020-12-17T07:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg1NzA0MA=="}], "type": "inlineReview"}, {"oid": "12e103f046de040d15d4b6a6cffcf9ce8d1e2afe", "url": "https://github.com/apache/kylin/commit/12e103f046de040d15d4b6a6cffcf9ce8d1e2afe", "message": "KYLIN-4818 Check lookup table duplicate key when building job", "committedDate": "2020-12-17T07:11:41Z", "type": "forcePushed"}, {"oid": "76f89296ba149c92e6ce770291f98a5f0ba76641", "url": "https://github.com/apache/kylin/commit/76f89296ba149c92e6ce770291f98a5f0ba76641", "message": "KYLIN-4818 Check lookup table duplicate key when building job", "committedDate": "2020-12-17T08:39:17Z", "type": "commit"}, {"oid": "76f89296ba149c92e6ce770291f98a5f0ba76641", "url": "https://github.com/apache/kylin/commit/76f89296ba149c92e6ce770291f98a5f0ba76641", "message": "KYLIN-4818 Check lookup table duplicate key when building job", "committedDate": "2020-12-17T08:39:17Z", "type": "forcePushed"}]}