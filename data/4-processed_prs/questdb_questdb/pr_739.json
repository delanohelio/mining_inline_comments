{"pr_number": 739, "pr_title": "feat(griffin) - Add build() function to list QuestDB build details", "pr_createdAt": "2020-12-30T00:24:08Z", "pr_url": "https://github.com/questdb/questdb/pull/739", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MDE5Mg==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550260192", "bodyText": "for some reason version doesn't default as intended when running from IDE", "author": "bluestreak01", "createdAt": "2020-12-30T16:55:05Z", "path": "core/src/main/java/io/questdb/ServerMain.java", "diffHunk": "@@ -38,25 +38,52 @@\n import io.questdb.log.LogRecord;\n import io.questdb.mp.WorkerPool;\n import io.questdb.network.NetworkError;\n-import io.questdb.std.*;\n+import io.questdb.std.CharSequenceObjHashMap;\n+import io.questdb.std.Chars;\n+import io.questdb.std.Misc;\n+import io.questdb.std.ObjList;\n+import io.questdb.std.Os;\n+import io.questdb.std.Vect;\n import io.questdb.std.time.Dates;\n-import sun.misc.Signal;\n-\n-import java.io.*;\n-import java.net.*;\n-import java.util.*;\n+import java.io.Closeable;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.Inet4Address;\n+import java.net.InetAddress;\n+import java.net.NetworkInterface;\n+import java.net.SocketException;\n+import java.net.URL;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.Enumeration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.ServiceLoader;\n import java.util.concurrent.locks.LockSupport;\n import java.util.jar.Attributes;\n import java.util.jar.Manifest;\n import java.util.zip.ZipEntry;\n import java.util.zip.ZipInputStream;\n+import sun.misc.Signal;\n \n public class ServerMain {\n     private static final String VERSION_TXT = \"version.txt\";\n+\n     protected PropServerConfiguration configuration;\n \n     public ServerMain(String[] args) throws Exception {\n-        System.err.printf(\"QuestDB server %s%nCopyright (C) 2014-%d, all rights reserved.%n%n\", getVersion(), Dates.getYear(System.currentTimeMillis()));\n+        //properties fetched from sources other than server.conf\n+        final Map<CharSequence, CharSequence> internalProperties = buildInternalProperties();\n+\n+        System.err.printf(\n+                \"QuestDB server %s%nCopyright (C) 2014-%d, all rights reserved.%n%n\",\n+                internalProperties.getOrDefault(\"build.questdb.version\", \"Unknown Version\"),", "originalCommit": "e5d915fac649cc6100369f591d8bff6258dbc029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyMjY2MQ==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550322661", "bodyText": "I wasn't checking if the version was null in the getQuestDbVersion method. \ud83e\udd26\u200d\u2642\ufe0f", "author": "upsidedownsmile", "createdAt": "2020-12-30T20:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MDE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MTkzNw==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550261937", "bodyText": "Delivering build information to server can be done via BuildInformation interface above, which configuration can keep the reference to.", "author": "bluestreak01", "createdAt": "2020-12-30T17:00:17Z", "path": "core/src/main/java/io/questdb/ServerMain.java", "diffHunk": "@@ -451,4 +468,43 @@ protected void startQuestDb(\n     ) {\n         workerPool.start(log);\n     }\n+\n+    private static CharSequence getQuestDbVersion(final Attributes manifestAttributes) {\n+        return manifestAttributes.getValue(\"Implementation-Version\");\n+    }\n+\n+    private static CharSequence getJdkVersion(final Attributes manifestAttributes) {\n+        return manifestAttributes.getValue(\"Build-Jdk\");\n+    }\n+\n+    private static CharSequence getCommitHash(final Attributes manifestAttributes) {\n+        return manifestAttributes.getValue(\"Build-Commit-Hash\");\n+    }\n+\n+    private static Map<CharSequence, CharSequence> buildInternalProperties() throws IOException {", "originalCommit": "e5d915fac649cc6100369f591d8bff6258dbc029", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MzU4MQ==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550263581", "bodyText": "Perhaps we should try to keep this information on single line, otherwise its tricky to have it displayed correctly to multiple clients:", "author": "bluestreak01", "createdAt": "2020-12-30T17:05:51Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/metadata/BuildFuntionFactory.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.metadata;\n+\n+import io.questdb.BuildInformation;\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.SqlExecutionContext;\n+import io.questdb.griffin.engine.functions.StrFunction;\n+import io.questdb.griffin.engine.functions.constants.StrConstant;\n+import io.questdb.std.Misc;\n+import io.questdb.std.ObjList;\n+import io.questdb.std.str.CharSink;\n+import io.questdb.std.str.StringSink;\n+\n+public class BuildFuntionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"build()\";\n+    }\n+\n+    @Override\n+    public Function newInstance(final ObjList<Function> args,\n+                                final int position,\n+                                final CairoConfiguration configuration,\n+                                final SqlExecutionContext sqlExecutionContext) throws SqlException {\n+\n+        return Memoizer.getInstance(configuration).function;\n+    }\n+\n+    private static class Memoizer {\n+        private static Memoizer instance;\n+\n+        private final StrFunction function;\n+\n+        private Memoizer(final CharSequence message) {\n+            this.function = new StrConstant(0, message);\n+        }\n+\n+        public static Memoizer getInstance(final CairoConfiguration configuration) {\n+            if (instance == null) {\n+                synchronized (Memoizer.class) {\n+                    if (instance == null) {\n+                        instance = new Memoizer(message(configuration));\n+                    }\n+                }\n+            }\n+            return instance;\n+        }\n+\n+        private static CharSequence message(final CairoConfiguration configuration) {", "originalCommit": "e5d915fac649cc6100369f591d8bff6258dbc029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyMjU5Mg==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550322592", "bodyText": "WDYT?", "author": "upsidedownsmile", "createdAt": "2020-12-30T20:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MzU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgyMTI4OA==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550821288", "bodyText": "this is awesome!", "author": "bluestreak01", "createdAt": "2021-01-01T23:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MzU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2Njc4MQ==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550266781", "bodyText": "this is some heavy artillery going on here :)\nGenerally speaking FunctionFactory instances are singletons already, this could perhaps remove static variable use. Then double-check locking can perhaps be replaced with\nif (instance == null) {\n    instance = new Memoizer(message(configuration));\n}\nThe worst case scenario is that under very heavy load we might have several classes created unnecessarily. But realistically this is very small and unlikely overhead in the name of code simplicity.", "author": "bluestreak01", "createdAt": "2020-12-30T17:16:48Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/metadata/BuildFuntionFactory.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.metadata;\n+\n+import io.questdb.BuildInformation;\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.SqlExecutionContext;\n+import io.questdb.griffin.engine.functions.StrFunction;\n+import io.questdb.griffin.engine.functions.constants.StrConstant;\n+import io.questdb.std.Misc;\n+import io.questdb.std.ObjList;\n+import io.questdb.std.str.CharSink;\n+import io.questdb.std.str.StringSink;\n+\n+public class BuildFuntionFactory implements FunctionFactory {\n+    @Override\n+    public String getSignature() {\n+        return \"build()\";\n+    }\n+\n+    @Override\n+    public Function newInstance(final ObjList<Function> args,\n+                                final int position,\n+                                final CairoConfiguration configuration,\n+                                final SqlExecutionContext sqlExecutionContext) throws SqlException {\n+\n+        return Memoizer.getInstance(configuration).function;\n+    }\n+\n+    private static class Memoizer {\n+        private static Memoizer instance;\n+\n+        private final StrFunction function;\n+\n+        private Memoizer(final CharSequence message) {\n+            this.function = new StrConstant(0, message);\n+        }\n+\n+        public static Memoizer getInstance(final CairoConfiguration configuration) {\n+            if (instance == null) {", "originalCommit": "e5d915fac649cc6100369f591d8bff6258dbc029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDMyMjU3OQ==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550322579", "bodyText": "Then we don't even need the Memoizer. The instance will be a StrFunction.\nRegarding thread safety, if I'm understanding correctly, you are saying to do the same that is done when computing the hash of a string, right?", "author": "upsidedownsmile", "createdAt": "2020-12-30T20:46:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2Njc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2NzA3Mg==", "url": "https://github.com/questdb/questdb/pull/739#discussion_r550267072", "bodyText": "spelling", "author": "bluestreak01", "createdAt": "2020-12-30T17:17:57Z", "path": "core/src/main/java/io/questdb/griffin/engine/functions/metadata/BuildFuntionFactory.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin.engine.functions.metadata;\n+\n+import io.questdb.BuildInformation;\n+import io.questdb.cairo.CairoConfiguration;\n+import io.questdb.cairo.sql.Function;\n+import io.questdb.griffin.FunctionFactory;\n+import io.questdb.griffin.SqlException;\n+import io.questdb.griffin.SqlExecutionContext;\n+import io.questdb.griffin.engine.functions.StrFunction;\n+import io.questdb.griffin.engine.functions.constants.StrConstant;\n+import io.questdb.std.Misc;\n+import io.questdb.std.ObjList;\n+import io.questdb.std.str.CharSink;\n+import io.questdb.std.str.StringSink;\n+\n+public class BuildFuntionFactory implements FunctionFactory {", "originalCommit": "e5d915fac649cc6100369f591d8bff6258dbc029", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f942b0a4c2edef519f93c8bf110d0b63ea7d84c4", "url": "https://github.com/questdb/questdb/commit/f942b0a4c2edef519f93c8bf110d0b63ea7d84c4", "message": "feat-720: Create query to get build information", "committedDate": "2020-12-30T21:44:36Z", "type": "commit"}, {"oid": "c5d636aa68c46ba5b36f337c7220373b9bc0fe4e", "url": "https://github.com/questdb/questdb/commit/c5d636aa68c46ba5b36f337c7220373b9bc0fe4e", "message": "feat-720: Fix tests", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "cc1ba515c90b7149a0c80861cf184957b621f158", "url": "https://github.com/questdb/questdb/commit/cc1ba515c90b7149a0c80861cf184957b621f158", "message": "feat-720: Rename default values", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "cf92c459bf11258df0bdc8333f33909cd6616942", "url": "https://github.com/questdb/questdb/commit/cf92c459bf11258df0bdc8333f33909cd6616942", "message": "feat-720: Remove autoformating from ServerMain", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "df7cb64c8c2c52b58a92293eeb0ad12cc3401232", "url": "https://github.com/questdb/questdb/commit/df7cb64c8c2c52b58a92293eeb0ad12cc3401232", "message": "feat-720: Remove autoformating from ServerMain", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "3650c86094b32656a9d9f47669f7f8a759123c8e", "url": "https://github.com/questdb/questdb/commit/3650c86094b32656a9d9f47669f7f8a759123c8e", "message": "feat-720: Remove root directory used for manual testing", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "08c28f2c19a6422e946ecb4f8d7fc0d1763d8de4", "url": "https://github.com/questdb/questdb/commit/08c28f2c19a6422e946ecb4f8d7fc0d1763d8de4", "message": "feat-720: Remove typo", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "6d9a25f4fffa926ad23dc66c01f472a2167aeba6", "url": "https://github.com/questdb/questdb/commit/6d9a25f4fffa926ad23dc66c01f472a2167aeba6", "message": "feat-720: Remove root directory used for manual testing", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "a745d93d41e736b1dd2c1e89de27788f4aa000fa", "url": "https://github.com/questdb/questdb/commit/a745d93d41e736b1dd2c1e89de27788f4aa000fa", "message": "feat-720: Fix typo", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "631cec710adfaca1207997df1c8da70851d57d10", "url": "https://github.com/questdb/questdb/commit/631cec710adfaca1207997df1c8da70851d57d10", "message": "feat-720: Display build information in only one line", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "99eb69e42448d50ebd6121eb749756402075009c", "url": "https://github.com/questdb/questdb/commit/99eb69e42448d50ebd6121eb749756402075009c", "message": "feat-720: Use BuildInformation instead of a map", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "043d657f9c9f873f2ea7979c99415feedb36efbc", "url": "https://github.com/questdb/questdb/commit/043d657f9c9f873f2ea7979c99415feedb36efbc", "message": "feat-720: Remove Memoizer and double-check locking", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "1fc26173400b531c340f05a9d52c820c17338d4b", "url": "https://github.com/questdb/questdb/commit/1fc26173400b531c340f05a9d52c820c17338d4b", "message": "feat-720: Remove root directory used for manual testing", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "53d45e186717940f93b69df7654d8bbc715410c0", "url": "https://github.com/questdb/questdb/commit/53d45e186717940f93b69df7654d8bbc715410c0", "message": "feat-720: Fix typo", "committedDate": "2020-12-30T21:44:38Z", "type": "commit"}, {"oid": "53d45e186717940f93b69df7654d8bbc715410c0", "url": "https://github.com/questdb/questdb/commit/53d45e186717940f93b69df7654d8bbc715410c0", "message": "feat-720: Fix typo", "committedDate": "2020-12-30T21:44:38Z", "type": "forcePushed"}, {"oid": "f0a14526f618b4c68871db72b8e55a0dbc2c3acd", "url": "https://github.com/questdb/questdb/commit/f0a14526f618b4c68871db72b8e55a0dbc2c3acd", "message": "Merge branch 'master' into feat-720", "committedDate": "2021-01-04T16:10:15Z", "type": "commit"}]}