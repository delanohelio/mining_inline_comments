{"pr_number": 671, "pr_title": "feature(griffin) - drop partition based on boolean expression - fix #669", "pr_createdAt": "2020-10-27T11:24:04Z", "pr_url": "https://github.com/questdb/questdb/pull/671", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU2NzEwOA==", "url": "https://github.com/questdb/questdb/pull/671#discussion_r513567108", "bodyText": "lambdas like this are allocating, please create member variable with reference to class method", "author": "bluestreak01", "createdAt": "2020-10-28T16:03:13Z", "path": "core/src/main/java/io/questdb/cairo/TableWriter.java", "diffHunk": "@@ -874,6 +879,61 @@ public boolean removePartition(long timestamp) {\n         }\n     }\n \n+    public boolean removePartition(Function function) {\n+        if (partitionBy == PartitionBy.NONE) {\n+            return false;\n+        }\n+\n+        long activePartition = timestampFloorMethod.floor(maxTimestamp);\n+        findAllPartitions();\n+        int partitionCount = partitionListByTimestamp.size();\n+        boolean droppingActivePartition = false;\n+        for (int i = 0; i < partitionCount; i++) {\n+            long timestampToRemove = partitionListByTimestamp.get(i);\n+            dropPartitionFunctionRec.setTimestamp(timestampToRemove);\n+            if (function.getBool(dropPartitionFunctionRec)) {\n+                partitionsToDrop.add(timestampToRemove);\n+                if (activePartition == timestampToRemove) {\n+                    droppingActivePartition = true;\n+                }\n+            }\n+        }\n+\n+        int dropPartitionCount = partitionsToDrop.size();\n+        if (dropPartitionCount == 0) {\n+            return false;\n+        } else if (dropPartitionCount == partitionCount) {\n+            truncate();\n+            return true;\n+        } else if (droppingActivePartition) {\n+            LOG.error()\n+                    .$(\"cannot remove active partition [path=\").$(path)\n+                    .$(\", maxTimestamp=\").$ts(maxTimestamp)\n+                    .$(']').$();\n+            return false;\n+        } else {\n+            for (int i = 0; i < dropPartitionCount; i++) {\n+                removePartition(partitionsToDrop.get(i));\n+            }\n+            return true;\n+        }\n+    }\n+\n+    private void findAllPartitions() {\n+        try {\n+            partitionListByTimestamp.clear();\n+            ff.iterateDir(path.$(), (file, type) -> {", "originalCommit": "992e5eccebf689ce65d9f18ea7b0b2b7f736da1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU4ODgxNg==", "url": "https://github.com/questdb/questdb/pull/671#discussion_r513588816", "bodyText": "there is no feedback if timestamp column is not defined", "author": "bluestreak01", "createdAt": "2020-10-28T16:30:56Z", "path": "core/src/main/java/io/questdb/griffin/SqlCompiler.java", "diffHunk": "@@ -1027,6 +1027,28 @@ private void alterTableDropColumn(int tableNamePosition, TableWriter writer) thr\n     }\n \n     private void alterTableDropPartition(TableWriter writer) throws SqlException {\n+        CharSequence tok = expectToken(lexer, \"'list' or 'where'\");\n+        if (SqlKeywords.isListKeyword(tok)) {\n+            alterTableDropPartitionByList(writer);\n+        } else if (SqlKeywords.isWhereKeyword(tok)) {\n+            ExpressionNode expr = parser.expr(lexer, (QueryModel) null);\n+            int timestampIndex = writer.getMetadata().getTimestampIndex();\n+            if (timestampIndex != -1) {\n+                String timestampColumnName = writer.getMetadata().getColumnName(timestampIndex);\n+                Function function = functionParser.parseFunction(expr, new SingleTimestampColumnRecordMetadata(timestampColumnName), currentExecutionContext);\n+                if (function != null && function.getType() == ColumnType.BOOLEAN) {\n+                    writer.removePartition(function);\n+                } else {\n+                    throw SqlException.$(lexer.lastTokenPosition(), \"boolean expression expected\");\n+                }\n+            }", "originalCommit": "992e5eccebf689ce65d9f18ea7b0b2b7f736da1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU4OTc3MA==", "url": "https://github.com/questdb/questdb/pull/671#discussion_r513589770", "bodyText": "such metadata can be cached with writer to reduce allocations. When we cache this with writer we would need to check what happens when timestamp column is renamed, can we still drop partitions?", "author": "bluestreak01", "createdAt": "2020-10-28T16:32:13Z", "path": "core/src/main/java/io/questdb/griffin/SqlCompiler.java", "diffHunk": "@@ -1027,6 +1027,28 @@ private void alterTableDropColumn(int tableNamePosition, TableWriter writer) thr\n     }\n \n     private void alterTableDropPartition(TableWriter writer) throws SqlException {\n+        CharSequence tok = expectToken(lexer, \"'list' or 'where'\");\n+        if (SqlKeywords.isListKeyword(tok)) {\n+            alterTableDropPartitionByList(writer);\n+        } else if (SqlKeywords.isWhereKeyword(tok)) {\n+            ExpressionNode expr = parser.expr(lexer, (QueryModel) null);\n+            int timestampIndex = writer.getMetadata().getTimestampIndex();\n+            if (timestampIndex != -1) {\n+                String timestampColumnName = writer.getMetadata().getColumnName(timestampIndex);\n+                Function function = functionParser.parseFunction(expr, new SingleTimestampColumnRecordMetadata(timestampColumnName), currentExecutionContext);", "originalCommit": "992e5eccebf689ce65d9f18ea7b0b2b7f736da1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5MDk1MQ==", "url": "https://github.com/questdb/questdb/pull/671#discussion_r513590951", "bodyText": "there is GenericRecordMetadata, we should use that for consistency", "author": "bluestreak01", "createdAt": "2020-10-28T16:33:49Z", "path": "core/src/main/java/io/questdb/griffin/SingleTimestampColumnRecordMetadata.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*******************************************************************************\n+ *     ___                  _   ____  ____\n+ *    / _ \\ _   _  ___  ___| |_|  _ \\| __ )\n+ *   | | | | | | |/ _ \\/ __| __| | | |  _ \\\n+ *   | |_| | |_| |  __/\\__ \\ |_| |_| | |_) |\n+ *    \\__\\_\\\\__,_|\\___||___/\\__|____/|____/\n+ *\n+ *  Copyright (c) 2014-2019 Appsicle\n+ *  Copyright (c) 2019-2020 QuestDB\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ ******************************************************************************/\n+\n+package io.questdb.griffin;\n+\n+import io.questdb.cairo.BaseRecordMetadata;\n+import io.questdb.cairo.ColumnType;\n+import io.questdb.cairo.TableColumnMetadata;\n+import io.questdb.std.CharSequenceIntHashMap;\n+import io.questdb.std.ObjList;\n+\n+public final class SingleTimestampColumnRecordMetadata extends BaseRecordMetadata {", "originalCommit": "992e5eccebf689ce65d9f18ea7b0b2b7f736da1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzYwMjUwMA==", "url": "https://github.com/questdb/questdb/pull/671#discussion_r513602500", "bodyText": "can we add partitions to \"toDrop\" list as we find them?\nThis way we only need one new list.", "author": "bluestreak01", "createdAt": "2020-10-28T16:48:40Z", "path": "core/src/main/java/io/questdb/cairo/TableWriter.java", "diffHunk": "@@ -874,6 +879,61 @@ public boolean removePartition(long timestamp) {\n         }\n     }\n \n+    public boolean removePartition(Function function) {\n+        if (partitionBy == PartitionBy.NONE) {\n+            return false;\n+        }\n+\n+        long activePartition = timestampFloorMethod.floor(maxTimestamp);\n+        findAllPartitions();\n+        int partitionCount = partitionListByTimestamp.size();\n+        boolean droppingActivePartition = false;\n+        for (int i = 0; i < partitionCount; i++) {\n+            long timestampToRemove = partitionListByTimestamp.get(i);\n+            dropPartitionFunctionRec.setTimestamp(timestampToRemove);\n+            if (function.getBool(dropPartitionFunctionRec)) {\n+                partitionsToDrop.add(timestampToRemove);\n+                if (activePartition == timestampToRemove) {\n+                    droppingActivePartition = true;\n+                }\n+            }\n+        }\n+\n+        int dropPartitionCount = partitionsToDrop.size();\n+        if (dropPartitionCount == 0) {\n+            return false;\n+        } else if (dropPartitionCount == partitionCount) {\n+            truncate();\n+            return true;\n+        } else if (droppingActivePartition) {\n+            LOG.error()\n+                    .$(\"cannot remove active partition [path=\").$(path)\n+                    .$(\", maxTimestamp=\").$ts(maxTimestamp)\n+                    .$(']').$();\n+            return false;\n+        } else {\n+            for (int i = 0; i < dropPartitionCount; i++) {\n+                removePartition(partitionsToDrop.get(i));\n+            }\n+            return true;\n+        }\n+    }\n+\n+    private void findAllPartitions() {", "originalCommit": "992e5eccebf689ce65d9f18ea7b0b2b7f736da1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccf448b2a6e675a4c07bec6f7e62392f8bdb91ac", "url": "https://github.com/questdb/questdb/commit/ccf448b2a6e675a4c07bec6f7e62392f8bdb91ac", "message": "feature(griffin) - drop partition based on boolean expression -  fix #669", "committedDate": "2020-10-30T14:23:34Z", "type": "commit"}, {"oid": "6b4b2f53e72d3ffe13a1253f07345c81699a534e", "url": "https://github.com/questdb/questdb/commit/6b4b2f53e72d3ffe13a1253f07345c81699a534e", "message": "feature(griffin) - drop partition based on boolean expression. logic and tests -  fix #669", "committedDate": "2020-10-30T14:24:26Z", "type": "commit"}, {"oid": "31e75aedd88ccc95061686c31fb72557e3d10b8a", "url": "https://github.com/questdb/questdb/commit/31e75aedd88ccc95061686c31fb72557e3d10b8a", "message": "feature(griffin) - drop partition based on boolean expression. tidy up -  fix #669", "committedDate": "2020-10-30T14:24:36Z", "type": "commit"}, {"oid": "9d52609339c1fc73ccaedceb87e32dab5369cd24", "url": "https://github.com/questdb/questdb/commit/9d52609339c1fc73ccaedceb87e32dab5369cd24", "message": "feature(griffin) - drop partition based on boolean expression. declaring NowFunctionFactory in FunctionFactory -   fix #669", "committedDate": "2020-10-30T14:24:36Z", "type": "commit"}, {"oid": "814ddebb643d5a8c1aa0fa5e7c4a313eccc17f1b", "url": "https://github.com/questdb/questdb/commit/814ddebb643d5a8c1aa0fa5e7c4a313eccc17f1b", "message": "feature(griffin) - drop partition based on boolean expression. PR comments . more tests to come -  fix #669", "committedDate": "2020-10-30T14:25:04Z", "type": "commit"}, {"oid": "f992c31f7874ce6ce1ee8faa9f48509efe911416", "url": "https://github.com/questdb/questdb/commit/f992c31f7874ce6ce1ee8faa9f48509efe911416", "message": "feature(griffin) - drop partition based on boolean expression. PR comments .test -  fix #669", "committedDate": "2020-10-30T14:25:06Z", "type": "commit"}, {"oid": "6a5fbb5abf30f57f254be4fa223bf976f0eb197f", "url": "https://github.com/questdb/questdb/commit/6a5fbb5abf30f57f254be4fa223bf976f0eb197f", "message": "feature(griffin) - drop partition based on boolean expression. rename and dro partition fixtest -  fix #669", "committedDate": "2020-10-30T14:25:06Z", "type": "commit"}, {"oid": "aebd1dd5c1af32913a09a0b2d859a0b5cd149bb3", "url": "https://github.com/questdb/questdb/commit/aebd1dd5c1af32913a09a0b2d859a0b5cd149bb3", "message": "feature(griffin) - drop partition based on boolean expression. refactored fix for rename/drop partition flag  fix #669", "committedDate": "2020-10-30T14:25:07Z", "type": "commit"}, {"oid": "765d2900d181f30660ccdab8b9f851f5b646aed7", "url": "https://github.com/questdb/questdb/commit/765d2900d181f30660ccdab8b9f851f5b646aed7", "message": "chore(cairo): merged master", "committedDate": "2020-10-30T14:37:46Z", "type": "commit"}, {"oid": "765d2900d181f30660ccdab8b9f851f5b646aed7", "url": "https://github.com/questdb/questdb/commit/765d2900d181f30660ccdab8b9f851f5b646aed7", "message": "chore(cairo): merged master", "committedDate": "2020-10-30T14:37:46Z", "type": "forcePushed"}]}