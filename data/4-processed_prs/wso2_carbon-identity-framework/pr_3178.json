{"pr_number": 3178, "pr_title": "Session data cleanup for session_app_info, session_meta_data tables", "pr_createdAt": "2020-10-21T02:44:23Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/3178", "timeline": [{"oid": "b0d19195b4ebb100490cf5c6d590e105081713d5", "url": "https://github.com/wso2/carbon-identity-framework/commit/b0d19195b4ebb100490cf5c6d590e105081713d5", "message": "Add session data clean up for idn_auth_session_app_info,idn_auth_session_meta_data tables to mysql,postgresql9,postgresql11 scripts", "committedDate": "2020-10-20T08:52:57Z", "type": "commit"}, {"oid": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce", "url": "https://github.com/wso2/carbon-identity-framework/commit/976ae86acc2b7583f4b3caf8b3ae3b9476572dce", "message": "Add session data clean up for idn_auth_session_app_info,idn_auth_session_meta_data tables to mssql and oracle db scripts", "committedDate": "2020-10-21T02:29:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzIzOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847239", "bodyText": "remove the spaces", "author": "inthirakumaaran", "createdAt": "2020-11-12T05:24:34Z", "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/oracle/sessiondata-cleanup/oracle-sessiondata-cleanup.sql", "diffHunk": "@@ -127,14 +137,49 @@ BEGIN\n             END IF;\n \n             -- Deleting user-session mappings from 'IDN_AUTH_USER_SESSION_MAPPING' table\n-            EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n-            sessionmappingcleanupcount := SQL%rowcount;\n-            COMMIT;\n+            SELECT COUNT(*) INTO ROWCOUNT from ALL_TABLES where OWNER = CURRENT_SCHEMA AND table_name = upper('IDN_AUTH_USER_SESSION_MAPPING');\n+            IF (ROWCOUNT = 1) then\n+                EXECUTE IMMEDIATE 'DELETE FROM IDN_AUTH_USER_SESSION_MAPPING WHERE SESSION_ID IN (SELECT SESSION_ID FROM TEMP_SESSION_BATCH)';\n+                sessionmappingcleanupcount := SQL%rowcount;\n+                COMMIT;\n \n-            IF ( tracingenabled ) THEN\n-            EXECUTE IMMEDIATE 'INSERT INTO LOG_WSO2_SESSION_CLEANUP_SP (TIMESTAMP,LOG) VALUES (TO_CHAR( SYSTIMESTAMP, ''DD.MM.YYYY HH24:MI:SS:FF4''),''DELETED USER-SESSION MAPPINGS COMPLETED WITH '|| sessionmappingcleanupcount||''')';\n-            COMMIT;\n-            END IF;\n+                IF ( tracingenabled ) THEN", "originalCommit": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0Nzk4Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847983", "bodyText": "Check other places as well", "author": "inthirakumaaran", "createdAt": "2020-11-12T05:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg1MTkzNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521851936", "bodyText": "Addressed in 3d2233c", "author": "DinikaSen", "createdAt": "2020-11-12T05:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzcwOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521847708", "bodyText": "Do we need this space?", "author": "inthirakumaaran", "createdAt": "2020-11-12T05:25:51Z", "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-11x/sessiondata-cleanup/postgresql_11-session-data-cleanup.sql", "diffHunk": "@@ -340,21 +389,65 @@ LOOP\n         END IF;\n \n         -- Deleting user-session mappings from 'idn_auth_user_session_mapping' table\n-        IF (enableLog AND logLevel IN ('TRACE')) THEN\n-        notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n-        RAISE NOTICE '%',notice;\n-        END IF;\n+        EXECUTE 'SELECT count(1) from pg_catalog.pg_tables WHERE schemaname = current_schema() AND tablename =  $1' into rowcount USING purgingSessionUserMappingTable;\n+        IF (rowcount = 1)\n+        THEN\n+            IF (enableLog AND logLevel IN ('TRACE')) THEN\n+                notice := 'BATCH DELETE START ON TABLE '||purgingSessionUserMappingTable||' WITH :'||batchCount;\n+                RAISE NOTICE '%',notice;\n+            END IF;\n \n-        EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';\n-        GET diagnostics deleteMappingCount := ROW_COUNT;\n-        COMMIT;\n+            EXECUTE 'DELETE from '||quote_ident(purgingSessionUserMappingTable)||' a USING '||purgingBatchTable||' b where a.'||purgeBseColmn||' = b.'||purgeBseColmn||'';", "originalCommit": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg1MTkwNQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521851905", "bodyText": "Addressed in 3d2233c", "author": "DinikaSen", "createdAt": "2020-11-12T05:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0ODQzNg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521848436", "bodyText": "Do we need this change?", "author": "inthirakumaaran", "createdAt": "2020-11-12T05:27:58Z", "path": "features/identity-core/org.wso2.carbon.identity.core.server.feature/resources/dbscripts/stored-procedures/postgresql/postgre-9x/sessiondata-cleanup/postgresql-session-data-cleanup.sql", "diffHunk": "@@ -344,10 +354,49 @@ auditTable :=  purgingTable||'_auditlog';\n \t            GET diagnostics deleteMappingCount := ROW_COUNT;\n \n \t            IF (enableLog AND logLevel IN ('DEBUG','TRACE')) THEN\n-\t            notice := 'BATCH DELETE FINISHED ON TABLE'||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;\n+\t            notice := 'BATCH DELETE FINISHED ON TABLE '||purgingSessionUserMappingTable||' WITH :'||deleteMappingCount;", "originalCommit": "976ae86acc2b7583f4b3caf8b3ae3b9476572dce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0OTAyOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3178#discussion_r521849028", "bodyText": "This is only a formatting fix to add a missing space to the log message", "author": "DinikaSen", "createdAt": "2020-11-12T05:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0ODQzNg=="}], "type": "inlineReview"}, {"oid": "3d2233c7745ad78dc3f6e7e384b163ed21b9ddaa", "url": "https://github.com/wso2/carbon-identity-framework/commit/3d2233c7745ad78dc3f6e7e384b163ed21b9ddaa", "message": "Remove extra blank lines", "committedDate": "2020-11-12T05:37:30Z", "type": "commit"}]}