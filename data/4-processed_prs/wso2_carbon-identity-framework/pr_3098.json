{"pr_number": 3098, "pr_title": "Trigger SESSION_EXPIRE event when a timed out session is found", "pr_createdAt": "2020-09-08T14:50:56Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/3098", "timeline": [{"oid": "549f106e84dca521d3659c36176a64d85bf28e5d", "url": "https://github.com/wso2/carbon-identity-framework/commit/549f106e84dca521d3659c36176a64d85bf28e5d", "message": "Add new event for session expiry", "committedDate": "2020-09-08T14:46:09Z", "type": "commit"}, {"oid": "d4745ec58b3d6a9b1f03327fefef4f5e8b1fa90a", "url": "https://github.com/wso2/carbon-identity-framework/commit/d4745ec58b3d6a9b1f03327fefef4f5e8b1fa90a", "message": "Trigger session expire event when a timed out session is found", "committedDate": "2020-09-08T14:46:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA1NDEyOA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3098#discussion_r486054128", "bodyText": "Is it correct to throw the AuthenticationFailedException exception here?\nShouldn't it be some other FrameworkException?", "author": "mefarazath", "createdAt": "2020-09-10T04:23:01Z", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/util/FrameworkUtils.java", "diffHunk": "@@ -951,6 +956,79 @@ public static SessionContext getSessionContextFromCache(String key) {\n         return sessionContext;\n     }\n \n+    /**\n+     * Retrieve session context from the session cache.\n+     *\n+     * @param request           HttpServletRequest.\n+     * @param context           Authentication context.\n+     * @param sessionContextKey Session context key.\n+     * @return Session context key.\n+     * @throws AuthenticationFailedException Error in triggering session expire event.\n+     */\n+    public static SessionContext getSessionContextFromCache(HttpServletRequest request, AuthenticationContext context", "originalCommit": "d4745ec58b3d6a9b1f03327fefef4f5e8b1fa90a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA2NTg0Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3098#discussion_r486065842", "bodyText": "Fixed with 6e06716", "author": "sachiniWettasinghe", "createdAt": "2020-09-10T05:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA1NDEyOA=="}], "type": "inlineReview"}, {"oid": "d820c86a8c0c7c933678877a32fd35dc20ab127a", "url": "https://github.com/wso2/carbon-identity-framework/commit/d820c86a8c0c7c933678877a32fd35dc20ab127a", "message": "Subscribe TokenBindingExpiryEventHandler to SESSION_EXPIRE event", "committedDate": "2020-09-10T04:23:06Z", "type": "commit"}, {"oid": "6e0671634815499c949ce71f6f8db045d7ad3366", "url": "https://github.com/wso2/carbon-identity-framework/commit/6e0671634815499c949ce71f6f8db045d7ad3366", "message": "Address PR comments", "committedDate": "2020-09-10T05:03:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA2NjIwNA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3098#discussion_r486066204", "bodyText": "Let's have some context information. Like the sessionId, user etc.", "author": "mefarazath", "createdAt": "2020-09-10T05:06:10Z", "path": "components/authentication-framework/org.wso2.carbon.identity.application.authentication.framework/src/main/java/org/wso2/carbon/identity/application/authentication/framework/util/FrameworkUtils.java", "diffHunk": "@@ -951,6 +955,79 @@ public static SessionContext getSessionContextFromCache(String key) {\n         return sessionContext;\n     }\n \n+    /**\n+     * Retrieve session context from the session cache.\n+     *\n+     * @param request           HttpServletRequest.\n+     * @param context           Authentication context.\n+     * @param sessionContextKey Session context key.\n+     * @return Session context key.\n+     * @throws FrameworkException Error in triggering session expire event.\n+     */\n+    public static SessionContext getSessionContextFromCache(HttpServletRequest request, AuthenticationContext context\n+            , String sessionContextKey) throws FrameworkException {\n+\n+        SessionContext sessionContext = null;\n+        if (StringUtils.isNotBlank(sessionContextKey)) {\n+            SessionContextCacheKey cacheKey = new SessionContextCacheKey(sessionContextKey);\n+            SessionContextCache sessionContextCache = SessionContextCache.getInstance();\n+            SessionContextCacheEntry cacheEntry = sessionContextCache.getSessionContextCacheEntry(cacheKey);\n+\n+            if (cacheEntry != null) {\n+                sessionContext = cacheEntry.getContext();\n+                boolean isSessionExpired = sessionContextCache.isSessionExpired(cacheKey, cacheEntry);\n+                if (isSessionExpired) {\n+                    triggerSessionExpireEvent(request, context, sessionContext);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"A SESSION_EXPIRE event was fired for the expired session found corresponding \" +\n+                                \"to the key: \" + cacheKey.getContextId());\n+                    }\n+                    return null;\n+                }\n+            }\n+        }\n+        return sessionContext;\n+    }\n+\n+    /**\n+     * Trigger SESSION_EXPIRE event on session expiry due to a session idle timeout or a remember me session time out.\n+     *\n+     * @param request        HttpServletRequest.\n+     * @param context        Authentication context.\n+     * @param sessionContext Session context.\n+     * @throws FrameworkException Error in triggering the session expiry event.\n+     */\n+    private static void triggerSessionExpireEvent(HttpServletRequest request, AuthenticationContext context,\n+                                                  SessionContext sessionContext) throws FrameworkException {\n+\n+        AuthenticatedUser authenticatedUser = new AuthenticatedUser();\n+        if (sessionContext != null) {\n+            Object authenticatedUserObj = sessionContext.getProperty(FrameworkConstants.AUTHENTICATED_USER);\n+            if (authenticatedUserObj instanceof AuthenticatedUser) {\n+                authenticatedUser = (AuthenticatedUser) authenticatedUserObj;\n+            }\n+            context.setSubject(authenticatedUser);\n+\n+            IdentityEventService eventService = FrameworkServiceDataHolder.getInstance().getIdentityEventService();\n+            try {\n+                Map<String, Object> eventProperties = new HashMap<>();\n+                eventProperties.put(IdentityEventConstants.EventProperty.REQUEST, request);\n+                eventProperties.put(IdentityEventConstants.EventProperty.CONTEXT, context);\n+                eventProperties.put(IdentityEventConstants.EventProperty.SESSION_CONTEXT, sessionContext);\n+                Map<String, Object> paramMap = new HashMap<>();\n+                paramMap.put(FrameworkConstants.AnalyticsAttributes.USER, authenticatedUser);\n+                paramMap.put(FrameworkConstants.AnalyticsAttributes.SESSION_ID, context.getSessionIdentifier());\n+                Map<String, Object> unmodifiableParamMap = Collections.unmodifiableMap(paramMap);\n+                eventProperties.put(IdentityEventConstants.EventProperty.PARAMS, unmodifiableParamMap);\n+\n+                Event event = new Event(IdentityEventConstants.EventName.SESSION_EXPIRE.name(), eventProperties);\n+                eventService.handleEvent(event);\n+            } catch (IdentityEventException e) {\n+                throw new FrameworkException(\"Error in triggering the session expire event.\", e);", "originalCommit": "6e0671634815499c949ce71f6f8db045d7ad3366", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3Mjg4NA==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3098#discussion_r486072884", "bodyText": "Fixed with cf0c1c4", "author": "sachiniWettasinghe", "createdAt": "2020-09-10T05:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA2NjIwNA=="}], "type": "inlineReview"}, {"oid": "cf0c1c45baba0a400fc721abd4eb7e9833acbc4d", "url": "https://github.com/wso2/carbon-identity-framework/commit/cf0c1c45baba0a400fc721abd4eb7e9833acbc4d", "message": "Address PR comments", "committedDate": "2020-09-10T05:22:37Z", "type": "forcePushed"}, {"oid": "b2a04207357fe6a6c6875c253ab558f16e71318c", "url": "https://github.com/wso2/carbon-identity-framework/commit/b2a04207357fe6a6c6875c253ab558f16e71318c", "message": "Address PR comments", "committedDate": "2020-09-10T05:52:08Z", "type": "commit"}, {"oid": "b2a04207357fe6a6c6875c253ab558f16e71318c", "url": "https://github.com/wso2/carbon-identity-framework/commit/b2a04207357fe6a6c6875c253ab558f16e71318c", "message": "Address PR comments", "committedDate": "2020-09-10T05:52:08Z", "type": "forcePushed"}]}