{"pr_number": 3168, "pr_title": "Delete un-updated config props on fed authenticator update", "pr_createdAt": "2020-10-14T09:21:54Z", "pr_url": "https://github.com/wso2/carbon-identity-framework/pull/3168", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3MTc2Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505471763", "bodyText": "Shouldn't this ArrayUtils.isEmpty ?", "author": "IsuraD", "createdAt": "2020-10-15T11:37:39Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -1030,9 +1030,29 @@ private void updateFederatedAuthenticatorConfig(FederatedAuthenticatorConfig new\n             int authnId = getAuthenticatorIdentifier(dbConnection, idpId,\n                     newFederatedAuthenticatorConfig.getName());\n \n+            List<Property> unUpdatedProperties = new ArrayList<>();\n             List<Property> singleValuedProperties = new ArrayList<>();\n             List<Property> multiValuedProperties = new ArrayList<>();\n \n+            // Checking for old fed auth config properties that are not updated so we can delete them.\n+            if (ArrayUtils.isNotEmpty(oldFederatedAuthenticatorConfig.getProperties())) {\n+                boolean isNewPropsEmpty = ArrayUtils.isNotEmpty(newFederatedAuthenticatorConfig.getProperties());", "originalCommit": "557fd6713028d747eba3a35111ded539699a7180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU3MDM2Ng==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505570366", "bodyText": "fixed", "author": "janakamarasena", "createdAt": "2020-10-15T14:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3MTc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3MjY3Nw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505472677", "bodyText": "Better check this before the above for loop.", "author": "IsuraD", "createdAt": "2020-10-15T11:39:22Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -1030,9 +1030,29 @@ private void updateFederatedAuthenticatorConfig(FederatedAuthenticatorConfig new\n             int authnId = getAuthenticatorIdentifier(dbConnection, idpId,\n                     newFederatedAuthenticatorConfig.getName());\n \n+            List<Property> unUpdatedProperties = new ArrayList<>();\n             List<Property> singleValuedProperties = new ArrayList<>();\n             List<Property> multiValuedProperties = new ArrayList<>();\n \n+            // Checking for old fed auth config properties that are not updated so we can delete them.\n+            if (ArrayUtils.isNotEmpty(oldFederatedAuthenticatorConfig.getProperties())) {\n+                boolean isNewPropsEmpty = ArrayUtils.isNotEmpty(newFederatedAuthenticatorConfig.getProperties());\n+                for (Property propertyOld : oldFederatedAuthenticatorConfig.getProperties()) {\n+                    boolean hasProp = false;\n+                    if (!isNewPropsEmpty) {", "originalCommit": "557fd6713028d747eba3a35111ded539699a7180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU3MDUwOQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505570509", "bodyText": "fixed", "author": "janakamarasena", "createdAt": "2020-10-15T14:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3MjY3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3NjU1Mg==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505476552", "bodyText": "Unnecessary line", "author": "IsuraD", "createdAt": "2020-10-15T11:46:38Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -1219,6 +1244,26 @@ private void updateMultiValuedFederatedConfigProperties(Connection dbConnection,\n \n     }\n \n+    private void deleteFederatedConfigProperties(Connection dbConnection, int authnId, int tenantId, List<Property>\n+            properties) throws SQLException {\n+\n+        PreparedStatement deletePrepStmt = null;\n+        String sqlStmt;\n+        try {\n+            for (Property property : properties) {\n+                sqlStmt = IdPManagementConstants.SQLQueries.DELETE_IDP_AUTH_PROP_WITH_KEY_SQL;\n+                deletePrepStmt = dbConnection.prepareStatement(sqlStmt);\n+                deletePrepStmt.setString(1, property.getName());\n+                deletePrepStmt.setInt(2, tenantId);\n+                deletePrepStmt.setInt(3, authnId);\n+                deletePrepStmt.executeUpdate();\n+            }\n+        } finally {\n+            IdentityDatabaseUtil.closeStatement(deletePrepStmt);\n+        }\n+", "originalCommit": "557fd6713028d747eba3a35111ded539699a7180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwNTk3MQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505605971", "bodyText": "fixed", "author": "janakamarasena", "createdAt": "2020-10-15T14:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3NjU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3Nzg0Mw==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505477843", "bodyText": "Batch delete?", "author": "IsuraD", "createdAt": "2020-10-15T11:49:03Z", "path": "components/idp-mgt/org.wso2.carbon.idp.mgt/src/main/java/org/wso2/carbon/idp/mgt/dao/IdPManagementDAO.java", "diffHunk": "@@ -1219,6 +1244,26 @@ private void updateMultiValuedFederatedConfigProperties(Connection dbConnection,\n \n     }\n \n+    private void deleteFederatedConfigProperties(Connection dbConnection, int authnId, int tenantId, List<Property>\n+            properties) throws SQLException {\n+\n+        PreparedStatement deletePrepStmt = null;\n+        String sqlStmt;\n+        try {\n+            for (Property property : properties) {\n+                sqlStmt = IdPManagementConstants.SQLQueries.DELETE_IDP_AUTH_PROP_WITH_KEY_SQL;", "originalCommit": "557fd6713028d747eba3a35111ded539699a7180", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwNjA1OQ==", "url": "https://github.com/wso2/carbon-identity-framework/pull/3168#discussion_r505606059", "bodyText": "fixed", "author": "janakamarasena", "createdAt": "2020-10-15T14:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ3Nzg0Mw=="}], "type": "inlineReview"}, {"oid": "63ada9b4622323388a20aafe96c922cfa64b1fc5", "url": "https://github.com/wso2/carbon-identity-framework/commit/63ada9b4622323388a20aafe96c922cfa64b1fc5", "message": "Delete un-updated config props on fed authenticator update", "committedDate": "2020-10-15T14:03:38Z", "type": "forcePushed"}, {"oid": "ef6906ed1332ca5040e55ba117c677610cc17a2e", "url": "https://github.com/wso2/carbon-identity-framework/commit/ef6906ed1332ca5040e55ba117c677610cc17a2e", "message": "Delete un-updated config props on fed authenticator update", "committedDate": "2020-10-15T14:49:38Z", "type": "commit"}, {"oid": "ef6906ed1332ca5040e55ba117c677610cc17a2e", "url": "https://github.com/wso2/carbon-identity-framework/commit/ef6906ed1332ca5040e55ba117c677610cc17a2e", "message": "Delete un-updated config props on fed authenticator update", "committedDate": "2020-10-15T14:49:38Z", "type": "forcePushed"}]}