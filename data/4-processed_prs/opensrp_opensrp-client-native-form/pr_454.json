{"pr_number": 454, "pr_title": "Fix Get ResourceBundle with properties from the DB", "pr_createdAt": "2020-07-16T19:33:50Z", "pr_url": "https://github.com/opensrp/opensrp-client-native-form/pull/454", "timeline": [{"oid": "742f8b3b4610486e4c4584154ada58a5bc4c0795", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/742f8b3b4610486e4c4584154ada58a5bc4c0795", "message": ":bug: Return empty Object 2D array instead of null", "committedDate": "2020-07-16T19:11:06Z", "type": "commit"}, {"oid": "0d11a7c7e443eb3c9727412fb5d743e712463f6b", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/0d11a7c7e443eb3c9727412fb5d743e712463f6b", "message": ":construction: Add .properties extension for retrieving properties files", "committedDate": "2020-07-16T19:24:51Z", "type": "commit"}, {"oid": "e06269edad2c08e697f2ea71793f4f3b9b7371e0", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/e06269edad2c08e697f2ea71793f4f3b9b7371e0", "message": ":heavy_check_mark: Fix failing test", "committedDate": "2020-07-16T19:48:00Z", "type": "commit"}, {"oid": "54293cc53f9245eea28b7eb97e48c5ecb3c0d1de", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/54293cc53f9245eea28b7eb97e48c5ecb3c0d1de", "message": ":white_check_mark: Add test for ResourceBundle is empty when properties doesn't exist in the DB", "committedDate": "2020-07-16T20:10:42Z", "type": "commit"}, {"oid": "af427a9e21abfd1612671dbd4c006849e6129341", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/af427a9e21abfd1612671dbd4c006849e6129341", "message": ":white_check_mark: Fix failing tests", "committedDate": "2020-07-17T08:51:27Z", "type": "commit"}, {"oid": "4ee10dfdde1c336d0df023e3d19688e4eb08988e", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/4ee10dfdde1c336d0df023e3d19688e4eb08988e", "message": ":sparkles: Get translated YAML with properties from the DB", "committedDate": "2020-07-17T12:32:24Z", "type": "commit"}, {"oid": "7151d892b4b1b86c45c71a57add5f294a33cc5e0", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/7151d892b4b1b86c45c71a57add5f294a33cc5e0", "message": ":bug: Disable DBResouceBundle caching\n\nThis is to allow handling different properties and also different locales", "committedDate": "2020-07-17T12:40:09Z", "type": "commit"}, {"oid": "03890e153a75acd234f6fd4a57cd0504df9932f3", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/03890e153a75acd234f6fd4a57cd0504df9932f3", "message": ":bug: Handle locales for properties", "committedDate": "2020-07-17T12:42:25Z", "type": "commit"}, {"oid": "51fda1a7c651a962632085d78435e69a3713eb1e", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/51fda1a7c651a962632085d78435e69a3713eb1e", "message": ":construction: Pass context for retrieving ResourceBundle", "committedDate": "2020-07-17T12:43:34Z", "type": "commit"}, {"oid": "5b1a53dc1e850b9262d31ae50ad1b39891970049", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/5b1a53dc1e850b9262d31ae50ad1b39891970049", "message": ":white_check_mark: Test get DBResourceBundle with different locale", "committedDate": "2020-07-17T12:45:28Z", "type": "commit"}, {"oid": "de02abbdadb8a51946759eafcd573122285e7a4f", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/de02abbdadb8a51946759eafcd573122285e7a4f", "message": ":construction: Move get properties from repository to DBResourceBundleControl", "committedDate": "2020-07-17T13:54:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyMTA2MQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/454#discussion_r456521061", "bodyText": "Add the override annotation. I know it doesn't change the execution but it's easier for readability", "author": "ekigamba", "createdAt": "2020-07-17T15:39:32Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/domain/DBResourceBundleControl.java", "diffHunk": "@@ -15,7 +19,28 @@ public DBResourceBundleControl(String identifier) {\n     public ResourceBundle newBundle(String baseName, Locale locale, String format, ClassLoader loader, boolean reload)\n             throws IllegalAccessException,\n             InstantiationException {\n-        return new DBResourceBundle(identifier);\n+        return new DBResourceBundle(getPropertiesFromRepository(identifier));\n+    }\n+\n+    // Don't cache since the DBResourceBundle handles properties for different Locales\n+    public long getTimeToLive(String arg0, Locale arg1) {", "originalCommit": "de02abbdadb8a51946759eafcd573122285e7a4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU1NjQ3Ng==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/454#discussion_r456556476", "bodyText": "Yeah. Will do \ud83d\udc4d", "author": "allan-on", "createdAt": "2020-07-17T16:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyMTA2MQ=="}], "type": "inlineReview"}, {"oid": "3988b032208084ed4f1ee781f5940a48be20c312", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/3988b032208084ed4f1ee781f5940a48be20c312", "message": ":art: Add Override annotation", "committedDate": "2020-07-17T16:56:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE1MTAzNQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/454#discussion_r457151035", "bodyText": "Nice test \ud83d\udc4d", "author": "ekigamba", "createdAt": "2020-07-20T07:59:30Z", "path": "android-json-form-wizard/src/test/java/com/vijay/jsonwizard/utils/NativeFormLangUtilsTest.java", "diffHunk": "@@ -84,16 +87,35 @@ public void testYamlFileTranslationShouldReturnUntranslatedYamlFile() {\n     }\n \n     @Test\n-    public void canGetResourceBundleWithPropertiesFromRepository() {\n+    public void testCanGetResourceBundleWithPropertiesFromRepository() {\n         ClientFormContract.Dao clientFormRepository = Mockito.mock(ClientFormContract.Dao.class);\n         NativeFormLibrary.getInstance().setClientFormDao(clientFormRepository);\n-        String properties = \"step1.title = New client record\\nstep1.previous_label = SAVE AND EXIT\";\n+        Context context = RuntimeEnvironment.application;\n+        String enProperties = \"step1.title = New client record\\nstep1.previous_label = SAVE AND EXIT\";\n         String interpolatedJsonForm = testUtils.getResourceFileContentsAsString(\"test_form_translation_interpolated\");\n \n         ClientFormContract.Model clientForm = new TestClientForm();\n-        clientForm.setJson(properties);\n-        Mockito.doReturn(clientForm).when(clientFormRepository).getActiveClientFormByIdentifier(Mockito.eq(\"form_strings\"));\n \n-        assertEquals(\"New client record\", NativeFormLangUtils.getResourceBundleFromRepository(interpolatedJsonForm).getString(\"step1.title\"));\n+        clientForm.setJson(enProperties);\n+        Mockito.doReturn(clientForm).when(clientFormRepository).getActiveClientFormByIdentifier(Mockito.eq(\"form_strings.properties\"));\n+        assertEquals(\"SAVE AND EXIT\",  NativeFormLangUtils.getResourceBundleFromRepository(RuntimeEnvironment.application, interpolatedJsonForm).getString(\"step1.previous_label\"));\n+\n+        String swProperties = \"step1.title = Rekodi mpya\\nstep1.previous_label = WEKA ALAFU ONDOKA\";\n+        clientForm.setJson(swProperties);\n+        NativeFormLangUtils.setAppLocale(context, \"sw\");\n+        Mockito.doReturn(clientForm).when(clientFormRepository).getActiveClientFormByIdentifier(Mockito.eq(\"form_strings_sw.properties\"));\n+        assertEquals(\"Rekodi mpya\",  NativeFormLangUtils.getResourceBundleFromRepository(RuntimeEnvironment.application, interpolatedJsonForm).getString(\"step1.title\"));", "originalCommit": "3988b032208084ed4f1ee781f5940a48be20c312", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}