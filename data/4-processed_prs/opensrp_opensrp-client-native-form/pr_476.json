{"pr_number": 476, "pr_title": "Save repeating group count to obs", "pr_createdAt": "2020-09-03T14:57:01Z", "pr_url": "https://github.com/opensrp/opensrp-client-native-form/pull/476", "timeline": [{"oid": "bf0d7c825613005b7839dd61636a8e0f75819a1b", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/bf0d7c825613005b7839dd61636a8e0f75819a1b", "message": "Save repeating group count to obs", "committedDate": "2020-09-03T14:49:43Z", "type": "commit"}, {"oid": "27802baba81f19e70b48cede3d32527a577e5a03", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/27802baba81f19e70b48cede3d32527a577e5a03", "message": "Fix failing test", "committedDate": "2020-09-03T15:37:17Z", "type": "commit"}, {"oid": "27802baba81f19e70b48cede3d32527a577e5a03", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/27802baba81f19e70b48cede3d32527a577e5a03", "message": "Fix failing test", "committedDate": "2020-09-03T15:37:17Z", "type": "forcePushed"}, {"oid": "8c501d1a94a08e0962dda471ed8c4832bdb99e7b", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/8c501d1a94a08e0962dda471ed8c4832bdb99e7b", "message": "Add repeating group test case", "committedDate": "2020-09-03T16:37:08Z", "type": "commit"}, {"oid": "f07b690480259c45511784d1324958024480d733", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f07b690480259c45511784d1324958024480d733", "message": "Bump lib version", "committedDate": "2020-09-04T06:24:41Z", "type": "commit"}, {"oid": "f07b690480259c45511784d1324958024480d733", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f07b690480259c45511784d1324958024480d733", "message": "Bump lib version", "committedDate": "2020-09-04T06:24:41Z", "type": "forcePushed"}, {"oid": "5049e1b482b4b2e3b9abc17093dcbd22f423c967", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/5049e1b482b4b2e3b9abc17093dcbd22f423c967", "message": "Append repeating group key to child element's key", "committedDate": "2020-09-04T08:57:15Z", "type": "commit"}, {"oid": "bdbc3f8f435ea642f52bdaec5ce45e2be5c79007", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/bdbc3f8f435ea642f52bdaec5ce45e2be5c79007", "message": "Add RepeatingGroupFactory unique id generation test", "committedDate": "2020-09-04T09:33:05Z", "type": "commit"}, {"oid": "bdbc3f8f435ea642f52bdaec5ce45e2be5c79007", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/bdbc3f8f435ea642f52bdaec5ce45e2be5c79007", "message": "Add RepeatingGroupFactory unique id generation test", "committedDate": "2020-09-04T09:33:05Z", "type": "forcePushed"}, {"oid": "631159c26bb0b345203b06e3542abb8d4805b10c", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/631159c26bb0b345203b06e3542abb8d4805b10c", "message": "Pull repeating group count field label from repeating group widget", "committedDate": "2020-09-04T13:57:10Z", "type": "commit"}, {"oid": "631159c26bb0b345203b06e3542abb8d4805b10c", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/631159c26bb0b345203b06e3542abb8d4805b10c", "message": "Pull repeating group count field label from repeating group widget", "committedDate": "2020-09-04T13:57:10Z", "type": "forcePushed"}, {"oid": "877163f20bacfba6fbfb6eeb77f053c9813ec04f", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/877163f20bacfba6fbfb6eeb77f053c9813ec04f", "message": "Fix failing tests", "committedDate": "2020-09-04T14:20:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNTk1OA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484205958", "bodyText": "This change will break stuff for us.", "author": "bennsimon", "createdAt": "2020-09-07T06:23:51Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java", "diffHunk": "@@ -192,7 +192,7 @@ private void formatRepeatingGroupLabelText(EditText referenceEditText, TextView\n \n     protected void addUniqueIdentifiers(JSONObject element, String uniqueId) throws JSONException {\n         // make repeating group element key unique\n-        String currKey = element.getString(KEY);\n+        String currKey = widgetArgs.getJsonObject().getString(KEY) + \"_\" + element.getString(KEY);", "originalCommit": "877163f20bacfba6fbfb6eeb77f053c9813ec04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg4NzE2NA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484887164", "bodyText": "This is not absolutely necessary for this pr, so it can be removed if no other compromise is found.", "author": "vincent-karuri", "createdAt": "2020-09-08T12:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNTk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE2NzA2MA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r486167060", "bodyText": "I think its best for other implementations to use the current key as is without the new prefix .", "author": "bennsimon", "createdAt": "2020-09-10T08:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNTk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyMTgwMQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r486221801", "bodyText": "Removed", "author": "vincent-karuri", "createdAt": "2020-09-10T10:09:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNTk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNjI5Ng==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484206296", "bodyText": "Any reason for this because this change might break other people's code.", "author": "bennsimon", "createdAt": "2020-09-07T06:24:48Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -221,22 +255,33 @@ private void retrieveRepeatingGroupCountFromRemoteReferenceEditText(final @NonNu\n     }\n \n     @VisibleForTesting\n-    protected void setGlobalLayoutListener(@NonNull final View rootLayout, @NonNull final MaterialEditText referenceEditText, final int remoteReferenceValue) {\n+    protected void setGlobalLayoutListener(@NonNull final View rootLayout,", "originalCommit": "877163f20bacfba6fbfb6eeb77f053c9813ec04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwMDUxOQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484300519", "bodyText": "https://github.com/OpenSRP/opensrp-client-native-form/pull/476/files/877163f20bacfba6fbfb6eeb77f053c9813ec04f#r484300334", "author": "vincent-karuri", "createdAt": "2020-09-07T09:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNjI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNjQ5MQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484206491", "bodyText": "This change will break our code.", "author": "bennsimon", "createdAt": "2020-09-07T06:25:16Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -305,23 +366,26 @@ private void addRequiredValidator(JSONObject jsonObject, MaterialEditText editTe\n         }\n     }\n \n-    protected void addOnDoneAction(TextView textView) {\n+    protected void addOnDoneAction(final TextView textView, final ImageButton doneButton, final WidgetArgs widgetArgs) {", "originalCommit": "877163f20bacfba6fbfb6eeb77f053c9813ec04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwMDMzNA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484300334", "bodyText": "This fixes a bug that has to do with state management explained here https://github.com/OpenSRP/opensrp-client-native-form/pull/476/files/877163f20bacfba6fbfb6eeb77f053c9813ec04f#r484283652.\nWhile this might break existing code, unfortunately, I don't see an easier way for this fix to be applied, since we need to move to passing state in the method to fix this bug.\nAny ideas?", "author": "vincent-karuri", "createdAt": "2020-09-07T09:12:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNjQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNzA3NA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484207074", "bodyText": "Any reason why you relocated this? It might break code for others.", "author": "bennsimon", "createdAt": "2020-09-07T06:26:50Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -59,31 +65,29 @@\n public class RepeatingGroupFactory implements FormWidgetFactory {\n \n     private static Map<Integer, String> repeatingGroupLayouts = new HashMap<>();\n-    private final String REFERENCE_EDIT_TEXT_HINT = \"reference_edit_text_hint\";\n+    public static final String REFERENCE_EDIT_TEXT_HINT = \"reference_edit_text_hint\";\n     private final String REPEATING_GROUP_LABEL = \"repeating_group_label\";\n     private final String REFERENCE_EDIT_TEXT = \"reference_edit_text\";\n     private final String REPEATING_GROUP_MAX = \"repeating_group_max\";\n     private final String REPEATING_GROUP_MIN = \"repeating_group_min\";\n     protected int MAX_NUM_REPEATING_GROUPS = 35;\n     protected int MIN_NUM_REPEATING_GROUPS = 0;\n-    private ImageButton doneButton;\n-    private WidgetArgs widgetArgs;", "originalCommit": "877163f20bacfba6fbfb6eeb77f053c9813ec04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI4MzY1Mg==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484283652", "bodyText": "There are state issues with sharing these global variables in the widget. Native forms uses one factory for all widgets of the same type on a form (look at the map of widget factories to verify this).\nIf you have multiple repeating groups on the same page you will notice the green checkmark will always appear on the last widget regardless of which repeating group was operated on. Same problem with widget args, the last widget will override all others.", "author": "vincent-karuri", "createdAt": "2020-09-07T08:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwNzA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIxMjMzMg==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484212332", "bodyText": "You could use the api to write data here, since for other projects the count may have openmrs attributes.", "author": "bennsimon", "createdAt": "2020-09-07T06:41:25Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -289,11 +338,23 @@ public void onTextChanged(CharSequence s, int start, int before, int count) {\n             @Override\n             public void afterTextChanged(Editable s) {\n                 doneButton.setImageResource(R.drawable.ic_done_grey);\n-                JsonFormFragmentPresenter.validate(widgetArgs.getFormFragment(), referenceEditText, false);\n+                ValidationStatus validationStatus = JsonFormFragmentPresenter\n+                        .validate(widgetArgs.getFormFragment(), referenceEditText, false);\n+                if (validationStatus.isValid()) {\n+                    writeJsonObjectValue(repeatingGroupCount, s.toString());", "originalCommit": "877163f20bacfba6fbfb6eeb77f053c9813ec04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI4NDUyOQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484284529", "bodyText": "How would the count have openmrs attributes? It's created dynamically and doesn't exist in the form definition.", "author": "vincent-karuri", "createdAt": "2020-09-07T08:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIxMjMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIxNzA0OQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484217049", "bodyText": "So here just curious:\n\nWhat prevents several widgetArgs.getJsonObject().get(KEY) + \"_count\" fields added to the form step several times depending on back and forth form traversals.\nWhy is the type an empty string?\nWhat is the text for?\nWhat is the use of openmrs entity ids if the value is not written by JsonApi write method", "author": "bennsimon", "createdAt": "2020-09-07T06:53:24Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -109,18 +117,36 @@\n             doneButton.setOnClickListener(new View.OnClickListener() {\n                 @Override\n                 public void onClick(View v) {\n-                    addOnDoneAction(referenceEditText);\n+                    addOnDoneAction(referenceEditText, doneButton, widgetArgs);\n                 }\n             });\n         }\n \n         ((JsonApi) context).addFormDataView(referenceEditText);\n-        setViewTags(rootLayout);\n-        prepareViewChecks(rootLayout, context);\n+        setViewTags(rootLayout, widgetArgs);\n+        prepareViewChecks(rootLayout, context, widgetArgs);\n \n         return views;\n     }\n \n+    /**\n+     * Returns the object that holds the repeating group count\n+     *\n+     * @return\n+     * @throws JSONException\n+     */\n+    private JSONObject getRepeatingGroupCountObj(WidgetArgs widgetArgs) throws JSONException {\n+        JSONObject repeatingGroupCount = new JSONObject();\n+        repeatingGroupCount.put(KEY, widgetArgs.getJsonObject().get(KEY) + \"_count\");\n+        repeatingGroupCount.put(OPENMRS_ENTITY_PARENT, \"\");\n+        repeatingGroupCount.put(OPENMRS_ENTITY, \"\");\n+        repeatingGroupCount.put(OPENMRS_ENTITY_ID, \"\");\n+        repeatingGroupCount.put(TYPE, \"\");\n+        repeatingGroupCount.put(TEXT, widgetArgs.getJsonObject().get(REFERENCE_EDIT_TEXT_HINT));\n+        getStepFields(getJsonApi(widgetArgs).getStep(widgetArgs.getStepName())).put(repeatingGroupCount);", "originalCommit": "877163f20bacfba6fbfb6eeb77f053c9813ec04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI5NDU4MA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r484294580", "bodyText": "Is an edge-case that can be addressed, although the fields with no values attached do not appear in the final event so not sure if that is necessary. It would only be a problem if the person navigated and edited the repeating group count. In which case, I believe the last recorded value would be picked up in the event?\nThis is not a widget, it's just a simple field that holds data.\nText can be used when extracting data and you need the question that was attached to this repeating group.\nOpenSRP methods sometimes have weird constraints around fields missing, doesn't hurt to have it added and matching the widget definition as seen on a standard form.", "author": "vincent-karuri", "createdAt": "2020-09-07T09:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIxNzA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyMjEwNQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/476#discussion_r486222105", "bodyText": "Added a check for concern 1.", "author": "vincent-karuri", "createdAt": "2020-09-10T10:09:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIxNzA0OQ=="}], "type": "inlineReview"}, {"oid": "5327a2bc87cb05a58f1a4a1458180d60483ba115", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/5327a2bc87cb05a58f1a4a1458180d60483ba115", "message": "Revert appending parent key in repeating group child element", "committedDate": "2020-09-10T09:59:01Z", "type": "commit"}, {"oid": "f32f8705793a7828c99ee5fda8ff3cb6984d85fb", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f32f8705793a7828c99ee5fda8ff3cb6984d85fb", "message": "Revert \"Add RepeatingGroupFactory unique id generation test\"\n\nThis reverts commit bdbc3f8f435ea642f52bdaec5ce45e2be5c79007.", "committedDate": "2020-09-10T09:59:11Z", "type": "commit"}, {"oid": "02da9747a1da4d0881157dc38928dcca34dfa4df", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/02da9747a1da4d0881157dc38928dcca34dfa4df", "message": "Do not re-add the repeating group count object during form traversals", "committedDate": "2020-09-10T12:20:31Z", "type": "commit"}, {"oid": "02da9747a1da4d0881157dc38928dcca34dfa4df", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/02da9747a1da4d0881157dc38928dcca34dfa4df", "message": "Do not re-add the repeating group count object during form traversals", "committedDate": "2020-09-10T12:20:31Z", "type": "forcePushed"}, {"oid": "e2823891452ac511048ddec986e1dbd828a3f127", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/e2823891452ac511048ddec986e1dbd828a3f127", "message": "Add RepeatingGroupFactory test", "committedDate": "2020-09-10T13:04:25Z", "type": "commit"}, {"oid": "463292fbfb1c278f75fc626274b831b2d78d54c9", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/463292fbfb1c278f75fc626274b831b2d78d54c9", "message": "Return exitsting repeating group obj", "committedDate": "2020-09-10T15:11:26Z", "type": "commit"}, {"oid": "463292fbfb1c278f75fc626274b831b2d78d54c9", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/463292fbfb1c278f75fc626274b831b2d78d54c9", "message": "Return exitsting repeating group obj", "committedDate": "2020-09-10T15:11:26Z", "type": "forcePushed"}]}