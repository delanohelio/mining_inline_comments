{"pr_number": 504, "pr_title": "Repeating grp fix", "pr_createdAt": "2020-10-21T09:18:13Z", "pr_url": "https://github.com/opensrp/opensrp-client-native-form/pull/504", "timeline": [{"oid": "fc38543dc6b8ea8ab6bf2288862de30b9db322a2", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/fc38543dc6b8ea8ab6bf2288862de30b9db322a2", "message": "implement feeedback", "committedDate": "2020-10-13T07:44:28Z", "type": "commit"}, {"oid": "4392e20851fb8d56373ba20ef2bb1d57ed3834d1", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/4392e20851fb8d56373ba20ef2bb1d57ed3834d1", "message": "Merge branch 'optimize-native-forms' into repeating_grp_fix", "committedDate": "2020-10-21T08:27:44Z", "type": "commit"}, {"oid": "f1aad2ab5f579babfc81ec1f18998078060fd098", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f1aad2ab5f579babfc81ec1f18998078060fd098", "message": "update repeating grp done action with new logic", "committedDate": "2020-10-21T09:16:40Z", "type": "commit"}, {"oid": "504f0a588d4b47724c9b254923da7cf314feb156", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/504f0a588d4b47724c9b254923da7cf314feb156", "message": "fix code when updating the repeating grp count", "committedDate": "2020-10-21T09:24:54Z", "type": "commit"}, {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "message": "fix test", "committedDate": "2020-10-23T06:18:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxOTA4MA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512019080", "bodyText": "Not sure why this is +=. In the case that the value in the reference edit text changes, shouldn't the new value be the new number of repeating groups generated?\nThe logic atm looks at the difference and either generates extra groups for a +ve diff or deletes excess groups for a -ve diff.", "author": "vincent-karuri", "createdAt": "2020-10-26T14:49:12Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java", "diffHunk": "@@ -82,14 +82,35 @@ protected void onPreExecute() {\n         diff = numRepeatingGroups - currNumRepeatingGroups;\n         for (int i = 0; i < diff; i++) {\n             try {\n+\n                 repeatingGroups.add(buildRepeatingGroupLayout(parent));\n+\n             } catch (Exception e) {\n                 Timber.e(e);\n             }\n         }\n+\n+        updateRepeatingGrpCountObject();\n+\n         return repeatingGroups;\n     }\n \n+    private void updateRepeatingGrpCountObject() {\n+        try {\n+            JSONObject countFieldObject = Utils.getRepeatingGroupCountObj(widgetArgs);\n+            if (countFieldObject != null) {\n+                int currentCount = numRepeatingGroups;\n+                String strNumOfRepeatedGroups = countFieldObject.optString(VALUE);\n+                if (StringUtils.isNotBlank(strNumOfRepeatedGroups)) {\n+                    currentCount += Integer.parseInt(strNumOfRepeatedGroups);", "originalCommit": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0NDQ1Nw==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512444457", "bodyText": "Ideally the new value should be the summation of all the groups generated otherwise the count object will have incorrect value.", "author": "bennsimon", "createdAt": "2020-10-27T06:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxOTA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512021105", "bodyText": "Do we need the else block? Is there ever an instance when stepJsonObject is null?", "author": "vincent-karuri", "createdAt": "2020-10-26T14:51:35Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/utils/Utils.java", "diffHunk": "@@ -874,6 +882,38 @@ public static int getResourceId(Context context, String name, ResourceType resou\n     public static boolean isEmptyJsonArray(JSONArray jsonArray) {\n         return jsonArray == null || jsonArray.length() == 0;\n     }\n+\n+    /**\n+     * Returns the object that holds the repeating group count\n+     *\n+     * @return\n+     * @throws JSONException\n+     */\n+    @Nullable\n+    public static JSONObject getRepeatingGroupCountObj(@NotNull WidgetArgs widgetArgs) throws JSONException {\n+        String repeatingGroupCountObjKey = widgetArgs.getJsonObject().get(KEY) + \"_count\";\n+        JSONObject stepJsonObject = widgetArgs.getFormFragment().getStep(widgetArgs.getStepName());\n+        if (stepJsonObject != null) {\n+            JSONArray stepFields = stepJsonObject.optJSONArray(JsonFormConstants.FIELDS);\n+            JSONObject repeatingGroupCountObj = FormUtils.getFieldJSONObject(stepFields, repeatingGroupCountObjKey);\n+            // prevents re-adding the count object during form traversals\n+            if (repeatingGroupCountObj != null) {\n+                return repeatingGroupCountObj;\n+            }\n+\n+            repeatingGroupCountObj = new JSONObject();\n+            repeatingGroupCountObj.put(KEY, repeatingGroupCountObjKey);\n+            repeatingGroupCountObj.put(OPENMRS_ENTITY_PARENT, \"\");\n+            repeatingGroupCountObj.put(OPENMRS_ENTITY, \"\");\n+            repeatingGroupCountObj.put(OPENMRS_ENTITY_ID, \"\");\n+            repeatingGroupCountObj.put(TYPE, \"\");\n+            repeatingGroupCountObj.put(TEXT, widgetArgs.getJsonObject().get(REFERENCE_EDIT_TEXT_HINT));\n+            stepFields.put(repeatingGroupCountObj);\n+            return repeatingGroupCountObj;\n+        } else {\n+            return null;", "originalCommit": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0Mzg2NA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512443864", "bodyText": "yeah for malformed json form", "author": "bennsimon", "createdAt": "2020-10-27T06:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwMjA5NA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513202094", "bodyText": "The method throws JSONException, so I'm thinking malformed JSON will be covered here? The calling method can then figure out how to handle the exception, no?", "author": "vincent-karuri", "createdAt": "2020-10-28T06:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwNDM1OQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513204359", "bodyText": "That is a NPE check.", "author": "bennsimon", "createdAt": "2020-10-28T06:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIxMzE1Ng==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513213156", "bodyText": "Ok, but when is the stepJsonObject null?", "author": "vincent-karuri", "createdAt": "2020-10-28T06:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIxMzczMQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513213731", "bodyText": "either way, you can simply return null without the else block, right?", "author": "vincent-karuri", "createdAt": "2020-10-28T06:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyNjEzOQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513226139", "bodyText": "Ok, but when is the stepJsonObject null?\nWhen the step does not exist ... for malformed json forms\neither way, you can simply return null without the else block, right?\nI will still need an if block", "author": "bennsimon", "createdAt": "2020-10-28T07:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIzMTUzMg==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513231532", "bodyText": "yea, we can remove the else block though.", "author": "vincent-karuri", "createdAt": "2020-10-28T07:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMzg3OA==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512023878", "bodyText": "Based on https://github.com/OpenSRP/opensrp-client-native-form/pull/504/files#r512021105. Should countFieldObject ever be null?", "author": "vincent-karuri", "createdAt": "2020-10-26T14:55:06Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -106,30 +99,33 @@\n \n         setRepeatingGroupNumLimits(widgetArgs);\n \n+        JSONObject countFieldObject = Utils.getRepeatingGroupCountObj(widgetArgs);\n+\n         //get the generated number of groups\n-        final String generatedGroupsCount = jsonObject.optString(REPEATING_GROUPS_GENERATED_COUNT);\n+        final String generatedGroupsCount = countFieldObject != null ? countFieldObject.optString(VALUE) : \"\";", "originalCommit": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MzkxMQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512443911", "bodyText": "yeah for malformed json form", "author": "bennsimon", "createdAt": "2020-10-27T06:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMzg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIxMzk5MQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513213991", "bodyText": "#504 (comment)", "author": "vincent-karuri", "createdAt": "2020-10-28T06:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMzg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512026269", "bodyText": "Any reason to remove this? This was recommended as a better user experience by Roger onaio/rdt-standard#319 (comment).", "author": "vincent-karuri", "createdAt": "2020-10-26T14:58:05Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -327,15 +295,6 @@ public boolean onEditorAction(TextView focusTextView, int actionId, KeyEvent eve\n                     return false;\n                 }\n             });\n-            // generate repeating groups on focus change\n-            referenceEditText.setOnFocusChangeListener(new View.OnFocusChangeListener() {\n-                @Override\n-                public void onFocusChange(View view, boolean hasFocus) {\n-                    if (!hasFocus) {\n-                        addOnDoneAction((TextView) view, doneButton, widgetArgs);\n-                    }\n-                }\n-            });", "originalCommit": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MTA1Mg==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512441052", "bodyText": "Yeah, this feature breaks the normal behaviour of repeating group, it adds a bug ... it creates twice the number of groups needed.", "author": "bennsimon", "createdAt": "2020-10-27T06:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwMjMwNg==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513202306", "bodyText": "Ok, were you able to figure out why that happens?", "author": "vincent-karuri", "createdAt": "2020-10-28T06:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIwNjA1NQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513206055", "bodyText": "referenceEditText gains focus when cursor is on it, a number is entered ...  then after referenceEditText loses focus when the done button is clicked it fires the addOnDoneAction from focusChange listener at the same time the done button clickListener does the same ... so it generates twice the number of groups.", "author": "bennsimon", "createdAt": "2020-10-28T06:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIxOTYxOQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513219619", "bodyText": "Cool. Would removing the addOnDoneAction from the done button work then?", "author": "vincent-karuri", "createdAt": "2020-10-28T07:06:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyNjc0Nw==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513226747", "bodyText": "yeah ... thats why i proposed that to use the feature one has to hide the done button.", "author": "bennsimon", "createdAt": "2020-10-28T07:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIzMTU4Ng==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513231586", "bodyText": "I meant that since onFocusChanged is triggered when the button is clicked (after entering text) we can simply use onFocusChanged and remove the onclicklistener from the done button.", "author": "vincent-karuri", "createdAt": "2020-10-28T07:36:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIzNjQ5Ng==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513236496", "bodyText": "I dont think thats a good idea, looks like a hack ... i think one has to be disabled.", "author": "bennsimon", "createdAt": "2020-10-28T07:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0ODgzNg==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513348836", "bodyText": "It really isn't. The point of the feature (from Roger's comment) is to generate the repeating group when one navigates away from the reference edit text. Clicking on other views (including the done button) counts as navigating away.", "author": "vincent-karuri", "createdAt": "2020-10-28T10:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MTU2MQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513361561", "bodyText": "Why would you need the unclickable done button if you have a onFocusChangeListener on a referenceEditText? I dont get it but anyways ... This needs to be configurable since not all implementation expect that behaviour.", "author": "bennsimon", "createdAt": "2020-10-28T11:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ1MDQ4Mw==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r513450483", "bodyText": "tbh, it's only for backward compatibility, we don't need a button any more. The button being \"truly\" clickable or not doesn't really change the end-user experience so that's not a problem.\nYou can make it configurable, but any time someone wants both the button and focus change to be supported, the bug will show up again.", "author": "vincent-karuri", "createdAt": "2020-10-28T13:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyODA0OQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512028049", "bodyText": "I see the logic to write into the count object was moved but is the validation still being done? i.e. is JsonFormFragmentPresenter .validate(widgetArgs.getFormFragment(), referenceEditText, false); still called?", "author": "vincent-karuri", "createdAt": "2020-10-26T15:00:04Z", "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -377,23 +336,10 @@ public void onTextChanged(CharSequence s, int start, int before, int count) {\n             @Override\n             public void afterTextChanged(Editable s) {\n                 doneButton.setImageResource(R.drawable.ic_done_grey);\n-                ValidationStatus validationStatus = JsonFormFragmentPresenter\n-                        .validate(widgetArgs.getFormFragment(), referenceEditText, false);\n-                if (validationStatus.isValid()) {\n-                    writeJsonObjectValue(repeatingGroupCount, s.toString());\n-                }", "originalCommit": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyODU0NQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512028545", "bodyText": "It's useful where the reference edit text has validators added.", "author": "vincent-karuri", "createdAt": "2020-10-26T15:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyODA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MTc0NQ==", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512441745", "bodyText": "good catch", "author": "bennsimon", "createdAt": "2020-10-27T06:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyODA0OQ=="}], "type": "inlineReview"}, {"oid": "535729d20c144e2bff4b6101c834a81340df64bd", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/535729d20c144e2bff4b6101c834a81340df64bd", "message": "update code based on feedback", "committedDate": "2020-10-27T06:36:38Z", "type": "commit"}, {"oid": "535729d20c144e2bff4b6101c834a81340df64bd", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/535729d20c144e2bff4b6101c834a81340df64bd", "message": "update code based on feedback", "committedDate": "2020-10-27T06:36:38Z", "type": "forcePushed"}, {"oid": "22af1cc0e32958845608af752ed481e565396708", "url": "https://github.com/opensrp/opensrp-client-native-form/commit/22af1cc0e32958845608af752ed481e565396708", "message": "cleanup code", "committedDate": "2020-10-29T13:29:45Z", "type": "commit"}]}