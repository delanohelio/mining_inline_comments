{"pr_number": 5329, "pr_title": "Issue 5324: Add generations to Controller API for Consumption Based Retention", "pr_createdAt": "2020-11-13T17:04:54Z", "pr_url": "https://github.com/pravega/pravega/pull/5329", "timeline": [{"oid": "8a2fee6a37221f21ddefe11f773c82206352b7b0", "url": "https://github.com/pravega/pravega/commit/8a2fee6a37221f21ddefe11f773c82206352b7b0", "message": "first cut\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-13T17:00:48Z", "type": "commit"}, {"oid": "e495bbf40f40a33cd4429b7165476c8e30182190", "url": "https://github.com/pravega/pravega/commit/e495bbf40f40a33cd4429b7165476c8e30182190", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations", "committedDate": "2020-11-13T17:01:06Z", "type": "commit"}, {"oid": "6b1ca5a4ff2bb9d3b9e53ab158956759c7064230", "url": "https://github.com/pravega/pravega/commit/6b1ca5a4ff2bb9d3b9e53ab158956759c7064230", "message": "integration tests fixed\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-17T09:24:46Z", "type": "commit"}, {"oid": "bc08e8a734f2d6a2f90a6b3589f643000ede9c37", "url": "https://github.com/pravega/pravega/commit/bc08e8a734f2d6a2f90a6b3589f643000ede9c37", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations", "committedDate": "2020-11-17T09:25:00Z", "type": "commit"}, {"oid": "a2d922c351a8306e0de709c9cedf85654f3ad2a5", "url": "https://github.com/pravega/pravega/commit/a2d922c351a8306e0de709c9cedf85654f3ad2a5", "message": "bug fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-17T11:27:20Z", "type": "commit"}, {"oid": "de0274179d8130064c2b2e62546433d9f670ecd9", "url": "https://github.com/pravega/pravega/commit/de0274179d8130064c2b2e62546433d9f670ecd9", "message": "fix removesubscriber\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-17T12:47:03Z", "type": "commit"}, {"oid": "0b32c859201c769e90c9b76e4c283286505b2e91", "url": "https://github.com/pravega/pravega/commit/0b32c859201c769e90c9b76e4c283286505b2e91", "message": "test case fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T04:56:48Z", "type": "commit"}, {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2", "url": "https://github.com/pravega/pravega/commit/e504d9841c0c5ea29077abd5a33f656d04933aa2", "message": "test case fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T05:01:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODI5MQ==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828291", "bodyText": "this is a hanging future. this should be returned from this thenCompose call", "author": "shiveshr", "createdAt": "2020-11-18T05:44:35Z", "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,", "originalCommit": "e504d9841c0c5ea29077abd5a33f656d04933aa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE3MDMwMg==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526170302", "bodyText": "fixed", "author": "pbelgundi", "createdAt": "2020-11-18T15:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODM5Nw==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828397", "bodyText": "we need to handle the else case and return a completed future", "author": "shiveshr", "createdAt": "2020-11-18T05:44:55Z", "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                SubscriberSet.update(subscriberSetRecord.getObject(), newSubscriber, generation).toBytes(),\n+                                                                         subscriberSetRecord.getVersion())\n+                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY));\n+                           }", "originalCommit": "e504d9841c0c5ea29077abd5a33f656d04933aa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1Mzc1Mg==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525953752", "bodyText": "fixed", "author": "pbelgundi", "createdAt": "2020-11-18T09:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODQ4Mw==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828483", "bodyText": "same comment.. hanging future.. should be linked to the response being sent from this callback", "author": "shiveshr", "createdAt": "2020-11-18T05:45:17Z", "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                SubscriberSet.update(subscriberSetRecord.getObject(), newSubscriber, generation).toBytes(),\n+                                                                         subscriberSetRecord.getVersion())\n+                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY));\n+                           }\n+                      } else {\n+                           // add new Subscriber\n+                           storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,", "originalCommit": "e504d9841c0c5ea29077abd5a33f656d04933aa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1MzY4NA==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525953684", "bodyText": "fixed", "author": "pbelgundi", "createdAt": "2020-11-18T09:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODgxOQ==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828819", "bodyText": "whatever computation you are doing above is done asynchronously and then you are returning a completed future which is not linked to the above computation.. this is incorrect. this method will return with a completed future and caller will assume the work is done while the work would still be happening asynchronously and could fail.. the response future should be linked to the actual processing.", "author": "shiveshr", "createdAt": "2020-11-18T05:46:26Z", "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                SubscriberSet.update(subscriberSetRecord.getObject(), newSubscriber, generation).toBytes(),\n+                                                                         subscriberSetRecord.getVersion())\n+                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY));\n+                           }\n+                      } else {\n+                           // add new Subscriber\n+                           storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                   SubscriberSet.add(subscriberSetRecord.getObject(),\n+                                           newSubscriber, operationGeneration).toBytes(), subscriberSetRecord.getVersion())\n+                                   .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable,\n+                                           getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n+                                   .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n+                                   .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)));\n+                       }\n+                       return CompletableFuture.completedFuture(null);", "originalCommit": "e504d9841c0c5ea29077abd5a33f656d04933aa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1MzYwMw==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525953603", "bodyText": "ok. fixed.", "author": "pbelgundi", "createdAt": "2020-11-18T09:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODgxOQ=="}], "type": "inlineReview"}, {"oid": "2a4ad1a0cfcbe227be46a6bea9fcc4a861543b69", "url": "https://github.com/pravega/pravega/commit/2a4ad1a0cfcbe227be46a6bea9fcc4a861543b69", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T06:23:22Z", "type": "commit"}, {"oid": "774b2175b588a440b101dee4f206e3d1f0872a80", "url": "https://github.com/pravega/pravega/commit/774b2175b588a440b101dee4f206e3d1f0872a80", "message": "code review comments fixed\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T09:53:53Z", "type": "commit"}, {"oid": "a019b20bb2897dfa3a22ec79f0c37a31d5cd3b34", "url": "https://github.com/pravega/pravega/commit/a019b20bb2897dfa3a22ec79f0c37a31d5cd3b34", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T10:01:13Z", "type": "commit"}, {"oid": "dd7d7eeb90e32f9eae7728885957c1a838e285ee", "url": "https://github.com/pravega/pravega/commit/dd7d7eeb90e32f9eae7728885957c1a838e285ee", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T10:18:47Z", "type": "commit"}, {"oid": "618b7969cd9bbe872c6171d996d4389de7baf59e", "url": "https://github.com/pravega/pravega/commit/618b7969cd9bbe872c6171d996d4389de7baf59e", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations", "committedDate": "2020-11-18T10:19:04Z", "type": "commit"}, {"oid": "6acbbc26019ed5b81af355eebea72d2a79c69d22", "url": "https://github.com/pravega/pravega/commit/6acbbc26019ed5b81af355eebea72d2a79c69d22", "message": "test case fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T10:27:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5MjcwNw==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525992707", "bodyText": "question: does create subscriber update the entry if it already existed, but with an older generation?", "author": "shiveshr", "createdAt": "2020-11-18T10:53:29Z", "path": "controller/src/main/java/io/pravega/controller/task/Stream/StreamMetadataTasks.java", "diffHunk": "@@ -311,18 +312,9 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                 return CompletableFuture.completedFuture(AddSubscriberStatus.Status.STREAM_NOT_FOUND);\n             } else {\n                 // 2. get subscribers data\n-                return Futures.exceptionallyExpecting(streamMetadataStore.getSubscriber(scope, stream, newSubscriber, context, executor),\n-                     e -> Exceptions.unwrap(e) instanceof StoreException.DataNotFoundException, null)\n-                    .thenCompose(subscribersData -> {\n-                    //4. If SubscriberRecord does not exist create one...\n-                    if (subscribersData == null) {\n-                        return streamMetadataStore.createSubscriber(scope, stream, newSubscriber, context, executor)\n-                                .thenApply(v -> AddSubscriberStatus.Status.SUCCESS);\n-                    } else {\n-                        return CompletableFuture.completedFuture(AddSubscriberStatus.Status.SUBSCRIBER_EXISTS);\n-                    }\n-                    })\n-                    .exceptionally(ex -> {\n+                return streamMetadataStore.createSubscriber(scope, stream, newSubscriber, generation, context, executor)", "originalCommit": "6acbbc26019ed5b81af355eebea72d2a79c69d22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE3MTQ4NQ==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526171485", "bodyText": "If entry already exists, its generation is updated only if the (API generation) > stored generation and not otherwise.", "author": "pbelgundi", "createdAt": "2020-11-18T15:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5MjcwNw=="}], "type": "inlineReview"}, {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e", "url": "https://github.com/pravega/pravega/commit/3c8618e94fae21f94d88006d26d5371c09d3b86e", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-18T14:50:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNzAzMQ==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526607031", "bodyText": "nit: misnomer set when its a map", "author": "shiveshr", "createdAt": "2020-11-19T05:41:29Z", "path": "controller/src/main/java/io/pravega/controller/store/stream/InMemoryStream.java", "diffHunk": "@@ -116,6 +116,9 @@\n     @GuardedBy(\"subscribersLock\")\n     private final List<VersionedMetadata<StreamSubscriber>> streamSubscribers = new ArrayList<>();\n \n+    @GuardedBy(\"subscribersLock\")\n+    private final Map<String, Long> subscribersSet = new HashMap<String, Long>();", "originalCommit": "3c8618e94fae21f94d88006d26d5371c09d3b86e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYxMzA5NA==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526613094", "bodyText": "SubscriberSet exists so we can maintain a separate list of subscribers from the \"Subscriber--> StreamCut\" mapping.\nThis needed for finding the list of all Subscribers for a Stream (listSubscribers).", "author": "pbelgundi", "createdAt": "2020-11-19T06:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNzAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwMDU2OA==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526700568", "bodyText": "nit: misnomer set when its a map\n\nchanged to Subscribers", "author": "pbelgundi", "createdAt": "2020-11-19T09:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNzAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwOTQ5Mg==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526609492", "bodyText": "this can be improved.. its making two passes (filter and putall) over the map. we can get it down to one pass only by adding all the existing entries and for entry which already exists, we add the new subscriber.\nin fact, putall followed by put will be sufficient too. if previous map had this subscriber its value will simply get overwritten.", "author": "shiveshr", "createdAt": "2020-11-19T05:49:39Z", "path": "controller/src/main/java/io/pravega/controller/store/stream/records/SubscriberSet.java", "diffHunk": "@@ -37,37 +37,55 @@\n     public static final SubscriberSetSerializer SERIALIZER = new SubscriberSetSerializer();\n \n     @Getter\n-    private final ImmutableList<String> subscribers;\n+    private final ImmutableMap<String, Long> subscribers;\n \n     @Builder\n-    public SubscriberSet(@NonNull ImmutableList<String> subscribers) {\n+    public SubscriberSet(@NonNull ImmutableMap<String, Long> subscribers) {\n         this.subscribers = subscribers;\n     }\n \n     /**\n      * This method adds a subscriber in the subscriberSet.\n      * @param subscriberSet Subscriber Set.\n      * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n      * @return updated Subscriber Set.\n      */\n-    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber) {\n-            ImmutableList.Builder<String> builder = ImmutableList.builder();\n-            builder.addAll(subscriberSet.subscribers);\n-            builder.add(subscriber);\n+    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+            ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+            builder.putAll(subscriberSet.subscribers);\n+            builder.put(subscriber, generation);\n             return new SubscriberSet(builder.build());\n     }\n \n+    /**\n+     * This method updates the generation of a subscriber in the subscriberSet.\n+     * @param subscriberSet Subscriber Set.\n+     * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n+     * @return updated Subscriber Set.\n+     */\n+    public static SubscriberSet update(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+        ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+        Map<String, Long> otherSubscribers = subscriberSet.getSubscribers().entrySet().stream().filter(e -> !e.getKey().equals(subscriber))", "originalCommit": "3c8618e94fae21f94d88006d26d5371c09d3b86e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMzg4OQ==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526623889", "bodyText": "ok. fixed", "author": "pbelgundi", "createdAt": "2020-11-19T06:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwOTQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwOTg3Ng==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526609876", "bodyText": "same here. we can put all and then call remove on the builder or at least do the whole thing in one pass", "author": "shiveshr", "createdAt": "2020-11-19T05:50:52Z", "path": "controller/src/main/java/io/pravega/controller/store/stream/records/SubscriberSet.java", "diffHunk": "@@ -37,37 +37,55 @@\n     public static final SubscriberSetSerializer SERIALIZER = new SubscriberSetSerializer();\n \n     @Getter\n-    private final ImmutableList<String> subscribers;\n+    private final ImmutableMap<String, Long> subscribers;\n \n     @Builder\n-    public SubscriberSet(@NonNull ImmutableList<String> subscribers) {\n+    public SubscriberSet(@NonNull ImmutableMap<String, Long> subscribers) {\n         this.subscribers = subscribers;\n     }\n \n     /**\n      * This method adds a subscriber in the subscriberSet.\n      * @param subscriberSet Subscriber Set.\n      * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n      * @return updated Subscriber Set.\n      */\n-    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber) {\n-            ImmutableList.Builder<String> builder = ImmutableList.builder();\n-            builder.addAll(subscriberSet.subscribers);\n-            builder.add(subscriber);\n+    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+            ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+            builder.putAll(subscriberSet.subscribers);\n+            builder.put(subscriber, generation);\n             return new SubscriberSet(builder.build());\n     }\n \n+    /**\n+     * This method updates the generation of a subscriber in the subscriberSet.\n+     * @param subscriberSet Subscriber Set.\n+     * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n+     * @return updated Subscriber Set.\n+     */\n+    public static SubscriberSet update(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+        ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+        Map<String, Long> otherSubscribers = subscriberSet.getSubscribers().entrySet().stream().filter(e -> !e.getKey().equals(subscriber))\n+                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n+        builder.putAll(otherSubscribers);\n+        builder.put(subscriber, generation);\n+        return new SubscriberSet(builder.build());\n+    }\n+\n     /**\n      * This method removes a subscriber from the subscriberSet.\n      * @param subscriberSet Subscriber Set.\n      * @param subscriber subscriber to be removed.\n      * @return updated Subscriber Set.\n      */\n     public static SubscriberSet remove(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber) {\n-        ImmutableList.Builder<String> builder = ImmutableList.builder();\n-        List<String> otherSubscribers = subscriberSet.getSubscribers().stream().filter(s -> !s.equals(subscriber)).collect(Collectors.toList());\n-        builder.addAll(otherSubscribers);\n-        return new SubscriberSet(builder.build());\n+       ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();", "originalCommit": "3c8618e94fae21f94d88006d26d5371c09d3b86e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxNjQzNQ==", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526716435", "bodyText": "fixed.", "author": "pbelgundi", "createdAt": "2020-11-19T09:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwOTg3Ng=="}], "type": "inlineReview"}, {"oid": "67600b9983d36bc9a4a039cb4fcaf164997f5a30", "url": "https://github.com/pravega/pravega/commit/67600b9983d36bc9a4a039cb4fcaf164997f5a30", "message": "code review comments\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-19T09:09:07Z", "type": "commit"}, {"oid": "ac2dd14d6c243fccd23dff1e8cf567d697876804", "url": "https://github.com/pravega/pravega/commit/ac2dd14d6c243fccd23dff1e8cf567d697876804", "message": "code review changes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-19T09:32:57Z", "type": "commit"}, {"oid": "366fd1b373e2ba64fa38050a94a72169d6d33dda", "url": "https://github.com/pravega/pravega/commit/366fd1b373e2ba64fa38050a94a72169d6d33dda", "message": "checkstyle fixes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-19T09:36:36Z", "type": "commit"}, {"oid": "2755f98faabb4a497f16f1a540034dee419e4486", "url": "https://github.com/pravega/pravega/commit/2755f98faabb4a497f16f1a540034dee419e4486", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations", "committedDate": "2020-11-19T09:37:06Z", "type": "commit"}]}