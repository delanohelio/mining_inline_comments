{"pr_number": 5386, "pr_title": "Issue 5385: Upgrade Bookkeeper to last stable version (4.11.1)", "pr_createdAt": "2020-11-30T13:52:45Z", "pr_url": "https://github.com/pravega/pravega/pull/5386", "timeline": [{"oid": "dae7a7fd4e9fd87366190b3cf6956eac976637f8", "url": "https://github.com/pravega/pravega/commit/dae7a7fd4e9fd87366190b3cf6956eac976637f8", "message": "Bookkeeper version upgrade\n\nSigned-off-by: Ra\u00fal <raul.gracia@emc.com>", "committedDate": "2020-11-30T13:37:30Z", "type": "commit"}, {"oid": "719dfd5b613a305987b56012adf29d3f351391d5", "url": "https://github.com/pravega/pravega/commit/719dfd5b613a305987b56012adf29d3f351391d5", "message": "Switched to JDK11 and remove deprecated check for bindv6only check\n\nSigned-off-by: Ra\u00fal <raul.gracia@emc.com>", "committedDate": "2020-11-30T15:23:06Z", "type": "commit"}, {"oid": "27d2842e3398f8e47a4fa47b6b80d0f57dd4db04", "url": "https://github.com/pravega/pravega/commit/27d2842e3398f8e47a4fa47b6b80d0f57dd4db04", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version", "committedDate": "2020-11-30T15:23:45Z", "type": "commit"}, {"oid": "ff6c68eea0e7af4eafa655d5831901f083f51892", "url": "https://github.com/pravega/pravega/commit/ff6c68eea0e7af4eafa655d5831901f083f51892", "message": "Made changes to run system tests with Java11 option in bookkeeper\n\nSigned-off-by: anishakj <anisha.kj@dell.com>", "committedDate": "2020-12-01T17:28:46Z", "type": "commit"}, {"oid": "ac67a8e47090e5059644945f6636c1ac32344eae", "url": "https://github.com/pravega/pravega/commit/ac67a8e47090e5059644945f6636c1ac32344eae", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version", "committedDate": "2020-12-01T17:32:46Z", "type": "commit"}, {"oid": "c37325ed7f9ba12c6f85e9968f997067968bd905", "url": "https://github.com/pravega/pravega/commit/c37325ed7f9ba12c6f85e9968f997067968bd905", "message": "Merge branch 'issue-5385-upgrade-bk-version' of https://github.com/RaulGracia/pravega into issue-5385-upgrade-bk-version", "committedDate": "2020-12-01T17:39:46Z", "type": "commit"}, {"oid": "54c948fb94cf629f681e197340e81df43e4a06fc", "url": "https://github.com/pravega/pravega/commit/54c948fb94cf629f681e197340e81df43e4a06fc", "message": "Fixed chcekstyle errors\n\nSigned-off-by: anishakj <anisha.kj@dell.com>", "committedDate": "2020-12-01T17:59:47Z", "type": "commit"}, {"oid": "bab8e75eabe087dfcdfe874e525adb43b652fd63", "url": "https://github.com/pravega/pravega/commit/bab8e75eabe087dfcdfe874e525adb43b652fd63", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version", "committedDate": "2020-12-02T10:42:28Z", "type": "commit"}, {"oid": "c34e14dbc450a8566653f7e0973713b820488f46", "url": "https://github.com/pravega/pravega/commit/c34e14dbc450a8566653f7e0973713b820488f46", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version", "committedDate": "2020-12-02T18:33:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkzNDQ1NA==", "url": "https://github.com/pravega/pravega/pull/5386#discussion_r534934454", "bodyText": "PR #4420 had added many of these functions from Apache/Bookkeeper which didn't work in stock Apache/Bookkeeper image at the time, so that they could be fixed here. The idea was that those fixes are made here, until the fixes are also made on Apache/Bookeeper side.\nLater, I had raised this PR apache/bookkeeper#2219 with the same fixes we made here in Pravega and the PR got merged there, so some of these customized functions aren't needed anymore. As such we can return back to having pravega/bookkeeper entrypoint.sh invoking apache/bookkeeper entrypoint.sh to start bookies (see how this changed in the entrypoint.sh diff in https://github.com/pravega/pravega/pull/4420/files0.\nNow, whether we do that change here while upgrading to Bookkeeper 4.11.x or do it separately in a different PR is an open question. I'd suggest doing that separately. If you agree, we should raise an issue to track that separate piece of work.", "author": "ravisharda", "createdAt": "2020-12-03T08:43:44Z", "path": "docker/bookkeeper/entrypoint.sh", "diffHunk": "@@ -89,22 +89,6 @@ configure_bk() {\n     fi\n }\n \n-fix_bk_ipv6_check() {\n-\n-   # `${SCRIPTS_DIR}/common.sh` - a shell script in Bookeeper, runs this command: `/sbin/sysctl -n net.ipv6.bindv6only`.\n-   # This command can return an error exit code `255` and error message:\n-   #    `sysctl: cannot stat /proc/sys/net/ipv6/bindv6only: No such file or directory`\n-   #\n-   # If the `common.sh` file is sourced in a script that sets \"exit on error\" as true (set -e), the script shall return\n-   # an error code `255`. Since, the `bookkeeper/bin/bookeeper` shell script sources the `common.sh` file, and it sets\n-   # \"exit on error\" as true, we encounter this error when it is invoked. To avoid that error, here we modify the\n-   # `common.sh` file to execute `/sbin/sysctl -n net.ipv6.bindv6only` only if file `/proc/sys/net/ipv6/bindv6only`\n-   # is available.\n-\n-   # Replace the 22nd line with \"if [ -f /sbin/sysctl ] && [ -f /proc/sys/net/ipv6/bindv6only ]; then\".\n-   sed -i \"22s|.*|if [ -f /sbin/sysctl ] \\&\\& [ -f /proc/sys/net/ipv6/bindv6only ]; then|\" ${BK_HOME}/bin/common.sh\n-}\n-\n initialize_cluster() {", "originalCommit": "c34e14dbc450a8566653f7e0973713b820488f46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA0MTc5NQ==", "url": "https://github.com/pravega/pravega/pull/5386#discussion_r535041795", "bodyText": "Agree, let's keep changes of this upgrade at minimum, but track this cleanup so we can do that on a separate PR.", "author": "RaulGracia", "createdAt": "2020-12-03T10:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkzNDQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk1MTE3Ng==", "url": "https://github.com/pravega/pravega/pull/5386#discussion_r534951176", "bodyText": "This base image downloads bookkeeper-server-4.11.1-bin.tar.gz (as per this layer) and then we bring in bookkeeper-all-${BK_VERSION}-bin.tar.gz and use this new file. As a result, the image has an extra bookkeeper-server-4.11.1-bin.tar.gz file, adding to the image size.  This is a preexisting issue, which is present in our older images too. Would it make sense to add a command to delete that redundant binary here?", "author": "ravisharda", "createdAt": "2020-12-03T08:52:14Z", "path": "docker/bookkeeper/Dockerfile", "diffHunk": "@@ -17,9 +17,9 @@\n # - github.com/apache/bookkeeper/blob/branch-4.9/docker/Dockerfile\n #\n \n-FROM apache/bookkeeper:4.9.2\n+FROM apache/bookkeeper:4.11.1", "originalCommit": "c34e14dbc450a8566653f7e0973713b820488f46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA5NDM4Mg==", "url": "https://github.com/pravega/pravega/pull/5386#discussion_r535094382", "bodyText": "@ravisharda I cannot find any extra bookkeeper-server-4.11.1-bin.tar.gz inside the container (I'm looking into it and cannot find it). I think that the reason is that this file is already being deleted in the Bookkeeper Dockerfile: https://github.com/apache/bookkeeper/blob/8d3060e925e0fb06c7a1880155a809fe28ea052b/docker/Dockerfile#L48\nSo, I think that what you are suggesting is already done, right?", "author": "RaulGracia", "createdAt": "2020-12-03T10:51:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk1MTE3Ng=="}], "type": "inlineReview"}, {"oid": "6f09891a90f589f84a31b19063aecd91ec8cd94f", "url": "https://github.com/pravega/pravega/commit/6f09891a90f589f84a31b19063aecd91ec8cd94f", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version", "committedDate": "2020-12-07T09:39:42Z", "type": "commit"}]}