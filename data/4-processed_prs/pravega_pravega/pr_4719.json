{"pr_number": 4719, "pr_title": "Issue-4642: load TLS certificates from /etc/secret-volume/ca-bundle", "pr_createdAt": "2020-04-22T01:06:41Z", "pr_url": "https://github.com/pravega/pravega/pull/4719", "timeline": [{"oid": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a", "url": "https://github.com/pravega/pravega/commit/4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a", "message": "Issue-4642: load TLS certificates from /etc/secret-volume/ca-bundle to be align with other TLS materials\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>", "committedDate": "2020-04-22T01:00:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3MzQxMA==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r412873410", "bodyText": "Curious, what is this ca-bundle directory under /etc/secret-volume? It's not clear to me from the PR description. Is it the certificate of the CA that was used to sign the ECS server certificates?\nCould we use a more specific name? Not sure what the ca-bundle represents exactly.", "author": "ravisharda", "createdAt": "2020-04-22T10:44:11Z", "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,7 +36,7 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*", "originalCommit": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3NTUxNQ==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r412875515", "bodyText": "Ok, I found the context in the corresponding issue: #4642. I'd suggest you add a bit of context to the PR description too, for future reference.", "author": "ravisharda", "createdAt": "2020-04-22T10:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3MzQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA5NDk1OA==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413094958", "bodyText": "PR description updated.", "author": "kevinhan88", "createdAt": "2020-04-22T15:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3MzQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3Njg0OA==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r412876848", "bodyText": "Should we delete the certificate after successful import into the keystone?", "author": "ravisharda", "createdAt": "2020-04-22T10:49:59Z", "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,7 +36,7 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*\n     for cert in $CERTS\n     do\n       yes | keytool -importcert -storepass changeit -file \"${cert}\" -keystore /etc/ssl/certs/java/cacerts || true", "originalCommit": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA5MjU1Ng==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413092556", "bodyText": "added line to delete certs afterwards.", "author": "kevinhan88", "createdAt": "2020-04-22T15:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3Njg0OA=="}], "type": "inlineReview"}, {"oid": "e0e4981a24b2ccd4535d793b9da0f49135e4ebcc", "url": "https://github.com/pravega/pravega/commit/e0e4981a24b2ccd4535d793b9da0f49135e4ebcc", "message": "Issue-4642: per code review comment, delete certificate after having added into truststore.\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>", "committedDate": "2020-04-22T15:36:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NjQwMw==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413166403", "bodyText": "This is unrequired and potentially dangerous.  If Pravega is running bare metal then this will delete any certificates that were placed in /etc/secret-volume/ca-bundle.  If this is running in Kubernetes then it would be a secret and you can't delete the certificates from the secret.\nIs there a reason this was added?", "author": "maddisondavid", "createdAt": "2020-04-22T17:15:10Z", "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,9 +36,10 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*\n     for cert in $CERTS\n     do\n       yes | keytool -importcert -storepass changeit -file \"${cert}\" -keystore /etc/ssl/certs/java/cacerts || true\n     done\n+    rm -rf /etc/secret-volume/ca-bundle/* || true", "originalCommit": "e0e4981a24b2ccd4535d793b9da0f49135e4ebcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwOTQ3MA==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413309470", "bodyText": "This is per our security specialist Ravi's comment.\nFunctional-wise, it's tested okay to delete certificates after adding them into truststore. Those certificates have been mounted into the pod already so it wont affect k8s secrets.", "author": "kevinhan88", "createdAt": "2020-04-22T20:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NjQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5MzQ0NA==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413493444", "bodyText": "Actually, @maddisondavid is right. You shouldn't delete a file-mounted K8s secret using an OS command. If you manage to do it, it'll probably automatically be recreated (I am not 100% sure). Maybe we should leave it as is as @maddisondavid suggests.", "author": "ravisharda", "createdAt": "2020-04-23T04:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NjQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5NjIyNA==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413496224", "bodyText": "fixed", "author": "kevinhan88", "createdAt": "2020-04-23T04:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NzQxMQ==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413167411", "bodyText": "Does this work with multiple certificates?  I was under the impression from other tests I've done with keytool that you need to specify an alias otherwise the certificate gets added as <mykey> which isn't a trusted entry.", "author": "maddisondavid", "createdAt": "2020-04-22T17:16:25Z", "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,9 +36,10 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*\n     for cert in $CERTS\n     do\n       yes | keytool -importcert -storepass changeit -file \"${cert}\" -keystore /etc/ssl/certs/java/cacerts || true", "originalCommit": "e0e4981a24b2ccd4535d793b9da0f49135e4ebcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwOTk1Ng==", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413309956", "bodyText": "Good point. Added file name as alias to avoid the potential conflict.\n(OpenJDK's default truststore also uses filename as alias)", "author": "kevinhan88", "createdAt": "2020-04-22T20:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NzQxMQ=="}], "type": "inlineReview"}, {"oid": "5f5ac8034c7256338e7fbf4ddb73407e92056aad", "url": "https://github.com/pravega/pravega/commit/5f5ac8034c7256338e7fbf4ddb73407e92056aad", "message": "Issue-4642: addressing code review comment: added filename as alisa to avoid potential conflicts when importing multiple certs\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>", "committedDate": "2020-04-22T20:29:30Z", "type": "commit"}, {"oid": "bbcc948710b12dd905fc89f760a7267f51886105", "url": "https://github.com/pravega/pravega/commit/bbcc948710b12dd905fc89f760a7267f51886105", "message": "Merge branch 'master' into issue-4642", "committedDate": "2020-04-22T22:16:08Z", "type": "commit"}, {"oid": "a7a93449bee8b5c2b60bb979f39abda8779d0c5d", "url": "https://github.com/pravega/pravega/commit/a7a93449bee8b5c2b60bb979f39abda8779d0c5d", "message": "Issue-4642: per code review comments, removed the line to delete certificates afterwards.\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>", "committedDate": "2020-04-23T04:11:36Z", "type": "commit"}, {"oid": "a55388b42419487b236e1695b4032a9d7f0ac53d", "url": "https://github.com/pravega/pravega/commit/a55388b42419487b236e1695b4032a9d7f0ac53d", "message": "Merge branch 'issue-4642' of https://github.com/kevinhan88/pravega into issue-4642", "committedDate": "2020-04-23T04:15:03Z", "type": "commit"}]}