{"pr_number": 4510, "pr_title": "Issue 4505: Add missing metrics for ExtendedS3Storage", "pr_createdAt": "2020-01-22T19:20:01Z", "pr_url": "https://github.com/pravega/pravega/pull/4510", "timeline": [{"oid": "ff59f435665d870d24aab3c69237e59bcffc1166", "url": "https://github.com/pravega/pravega/commit/ff59f435665d870d24aab3c69237e59bcffc1166", "message": "Issue 4505: Add missing metrics ExtendedS3.\n\nCurrently ExtendedS3Storage class does not publish any storage related metrics.\nThis change adds missing metrics for ExtendedS3.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-01-22T19:15:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODI3Mg==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758272", "bodyText": "elapsed.toMillis. Otherwise this will print out some weird string.\nExtra space between \"Read\" and \"segment\"", "author": "andreipaduroiu", "createdAt": "2020-01-22T19:28:33Z", "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -228,6 +231,13 @@ private int doRead(SegmentHandle handle, long offset, byte[] buffer, int bufferO\n \n             int bytesRead = StreamHelpers.readAll(reader, buffer, bufferOffset, length);\n \n+            Duration elapsed = timer.getElapsed();\n+\n+            ExtendedS3Metrics.READ_LATENCY.reportSuccessEvent(elapsed);\n+            ExtendedS3Metrics.READ_BYTES.add(length);\n+\n+            log.debug(\"Read  segment={} offset={} bytesWritten={} latency={}.\", handle.getSegmentName(), offset, length, elapsed);", "originalCommit": "ff59f435665d870d24aab3c69237e59bcffc1166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NTkwNA==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369765904", "bodyText": "Good catch. Thanks.\nFixed.", "author": "sachin-j-joshi", "createdAt": "2020-01-22T19:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODUxMQ==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758511", "bodyText": "here too\nPlus you are missing an arg for the segment.", "author": "andreipaduroiu", "createdAt": "2020-01-22T19:29:00Z", "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -310,13 +322,20 @@ private SegmentHandle doCreate(String streamSegmentName) throws StreamSegmentExi\n         }\n         client.putObject(request);\n \n+        Duration elapsed = timer.getElapsed();\n+\n+        ExtendedS3Metrics.CREATE_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.CREATE_COUNT.inc();\n+\n+        log.debug(\"Create  segment={} latency={}.\", elapsed);", "originalCommit": "ff59f435665d870d24aab3c69237e59bcffc1166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NjA2MQ==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369766061", "bodyText": "Good catch. Thanks.\nFixed.", "author": "sachin-j-joshi", "createdAt": "2020-01-22T19:44:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODYxOA==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758618", "bodyText": "and here", "author": "andreipaduroiu", "createdAt": "2020-01-22T19:29:14Z", "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -331,6 +350,14 @@ private Void doWrite(SegmentHandle handle, long offset, InputStream data, int le\n \n         client.putObject(this.config.getBucket(), this.config.getRoot() + handle.getSegmentName(),\n                 Range.fromOffsetLength(offset, length), data);\n+\n+        Duration elapsed = timer.getElapsed();\n+\n+        ExtendedS3Metrics.WRITE_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.WRITE_BYTES.add(length);\n+\n+        log.debug(\"Write  segment={} offset={} bytesWritten={} latency={}.\", handle.getSegmentName(), offset, length, elapsed);", "originalCommit": "ff59f435665d870d24aab3c69237e59bcffc1166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NjAxMw==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369766013", "bodyText": "Fixed.", "author": "sachin-j-joshi", "createdAt": "2020-01-22T19:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODY5Mg==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758692", "bodyText": "here too", "author": "andreipaduroiu", "createdAt": "2020-01-22T19:29:23Z", "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -416,13 +443,31 @@ private Void doConcat(SegmentHandle targetHandle, long offset, String sourceSegm\n                 targetPath, uploadId).withParts(partEtags));\n \n         client.deleteObject(config.getBucket(), config.getRoot() + sourceSegment);\n+        Duration elapsed = timer.getElapsed();\n+\n+        log.debug(\"Concat  target={} source={} offset={} bytesWritten={} latency={}.\", targetHandle.getSegmentName(), sourceSegment, offset, si.getLength(), elapsed);", "originalCommit": "ff59f435665d870d24aab3c69237e59bcffc1166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NjU2Ng==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369766566", "bodyText": "fixed", "author": "sachin-j-joshi", "createdAt": "2020-01-22T19:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODk0Nw==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758947", "bodyText": "here too\n\nadd segment name.", "author": "andreipaduroiu", "createdAt": "2020-01-22T19:29:53Z", "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -416,13 +443,31 @@ private Void doConcat(SegmentHandle targetHandle, long offset, String sourceSegm\n                 targetPath, uploadId).withParts(partEtags));\n \n         client.deleteObject(config.getBucket(), config.getRoot() + sourceSegment);\n+        Duration elapsed = timer.getElapsed();\n+\n+        log.debug(\"Concat  target={} source={} offset={} bytesWritten={} latency={}.\", targetHandle.getSegmentName(), sourceSegment, offset, si.getLength(), elapsed);\n+\n+        ExtendedS3Metrics.CONCAT_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.CONCAT_BYTES.add(si.getLength());\n+        ExtendedS3Metrics.CONCAT_COUNT.inc();\n+\n         LoggerHelpers.traceLeave(log, \"concat\", traceId);\n \n         return null;\n     }\n \n     private Void doDelete(SegmentHandle handle) {\n+        long traceId = LoggerHelpers.traceEnter(log, \"delete\", handle.getSegmentName());\n+        Timer timer = new Timer();\n         client.deleteObject(config.getBucket(), config.getRoot() + handle.getSegmentName());\n+        Duration elapsed = timer.getElapsed();\n+\n+        ExtendedS3Metrics.DELETE_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.DELETE_COUNT.inc();\n+\n+        log.debug(\"Delete  segment={} latency={}.\", elapsed);", "originalCommit": "ff59f435665d870d24aab3c69237e59bcffc1166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NjY1Mg==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369766652", "bodyText": "fixed.", "author": "sachin-j-joshi", "createdAt": "2020-01-22T19:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODk0Nw=="}], "type": "inlineReview"}, {"oid": "b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c", "url": "https://github.com/pravega/pravega/commit/b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c", "message": "Issue 4505: Address review comments.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-01-22T19:39:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg2ODk0MQ==", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369868941", "bodyText": "Pleas do not name this ECS? This is for \"Extended S3\"", "author": "andreipaduroiu", "createdAt": "2020-01-22T23:53:06Z", "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Metrics.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.storage.extendeds3;\n+\n+import io.pravega.shared.MetricsNames;\n+import io.pravega.shared.metrics.Counter;\n+import io.pravega.shared.metrics.MetricsProvider;\n+import io.pravega.shared.metrics.OpStatsLogger;\n+import io.pravega.shared.metrics.StatsLogger;\n+\n+/**\n+ * Defines all Metrics used by the ExtendedS3Storage class.\n+ */\n+final class ExtendedS3Metrics {\n+    private static final StatsLogger ECS_LOGGER = MetricsProvider.createStatsLogger(\"ecs\");", "originalCommit": "b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fbbb66f39d744f4e0669a9769c95a67f2ed3f22", "url": "https://github.com/pravega/pravega/commit/7fbbb66f39d744f4e0669a9769c95a67f2ed3f22", "message": "Issue 4505: Add unit test for Extended S3 metrics.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-01-23T00:22:29Z", "type": "commit"}, {"oid": "5260ed5ee485413523d855adcb0b0dc1555b3ea3", "url": "https://github.com/pravega/pravega/commit/5260ed5ee485413523d855adcb0b0dc1555b3ea3", "message": "Issue 4505: Use name ExtendedS3 for stats logger.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-01-23T00:26:44Z", "type": "commit"}, {"oid": "09dab3a51fb9dba750d6b00dd6a9f152baf68159", "url": "https://github.com/pravega/pravega/commit/09dab3a51fb9dba750d6b00dd6a9f152baf68159", "message": "Issue 4505: Use name ExtendedS3 for stats logger.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-01-23T00:39:39Z", "type": "commit"}, {"oid": "c8eb4b31906d3560ae0bae8a7be1c97e3007911d", "url": "https://github.com/pravega/pravega/commit/c8eb4b31906d3560ae0bae8a7be1c97e3007911d", "message": "Merge branch 'master' into issue-4505-ExtendedS3-add-missing-metrics", "committedDate": "2020-01-23T08:29:54Z", "type": "commit"}]}