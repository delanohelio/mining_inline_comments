{"pr_number": 4812, "pr_title": "Issue 4811: Replace object-json mapping library for JWT", "pr_createdAt": "2020-05-26T09:45:52Z", "pr_url": "https://github.com/pravega/pravega/pull/4812", "timeline": [{"oid": "d676130f47f8ca4da6dcdbbe1a00308f0bea2f0f", "url": "https://github.com/pravega/pravega/commit/d676130f47f8ca4da6dcdbbe1a00308f0bea2f0f", "message": "Replace Gson with Jackson\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-05-26T09:40:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMTI2NQ==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430311265", "bodyText": "I suggest  you to give a try to https://github.com/FasterXML/jackson-jr\njackson-databind is full of CVEs due to the richness of features.\nin ZooKeeper community we are evaluating to drop it, as many times we have to perform upgrades.\nI don't know if in Pravega project there are automatic checks about CVEs but as far as I know many open source project consumers take great care of this stuff\npersonally I have never tried jackson-jr, but it may be worth to take a look", "author": "eolivelli", "createdAt": "2020-05-26T10:26:16Z", "path": "build.gradle", "diffHunk": "@@ -268,7 +268,7 @@ project('test:testcommon') {\n         compile group: 'commons-io', name: 'commons-io', version: commonsioVersion\n         compile group: 'io.netty', name: 'netty-all', version: nettyVersion\n         compile group: 'org.apache.curator', name: 'curator-test', version: apacheCuratorVersion, withoutLogger\n-        compile group: 'com.google.code.gson', name: 'gson', version: gsonVersion\n+        compile group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: jacksonVersion", "originalCommit": "d676130f47f8ca4da6dcdbbe1a00308f0bea2f0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM0MjIwOA==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430342208", "bodyText": "@eolivelli thanks for your sharing your thoughts and suggestion. I think it's a good idea to explore if we should use jackson-jr instead.\nThat being said, we use jackson-databind elsewhere in the code too. And, jackson-jr would be a net new library, should we choose to use it. Therefore, I think it might be a good idea to explore doing it separately of this PR, after fully considering all the implications.  The issue that this PR addresses is currently blocking system tests, and I am trying to get this change in sooner rather than later.\nAs for security vulnerabilities, yes we perform a number of checks with tools like dependency analyzers, vulnerability scanners, etc. and address the issues found, regularly.", "author": "ravisharda", "createdAt": "2020-05-26T11:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMTI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM0NDc5Nw==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430344797", "bodyText": "Sure", "author": "eolivelli", "createdAt": "2020-05-26T11:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMTI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNjU1OQ==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430416559", "bodyText": "Thanks.", "author": "ravisharda", "createdAt": "2020-05-26T13:35:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMTI2NQ=="}], "type": "inlineReview"}, {"oid": "023537f0a445c403c8ec3fb4242228f7c351c2ba", "url": "https://github.com/pravega/pravega/commit/023537f0a445c403c8ec3fb4242228f7c351c2ba", "message": "Fix a test, and prevent non-null properties from getting serialized\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-05-26T11:21:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NzM4Mg==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430387382", "bodyText": "ObjectMapper can be a singleton, you will save a few allocations and CPU cycles, as ObjectMapper caches metadata\nprivate static final ObjectMapper MAPPER = new ObjectMapper();", "author": "eolivelli", "createdAt": "2020-05-26T12:51:31Z", "path": "test/testcommon/src/main/java/io/pravega/test/common/JwtBody.java", "diffHunk": "@@ -9,44 +9,62 @@\n  */\n package io.pravega.test.common;\n \n-import com.google.gson.annotations.SerializedName;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import lombok.Builder;\n import lombok.Getter;\n import lombok.Setter;\n+import lombok.SneakyThrows;\n+\n+import java.io.StringReader;\n \n /**\n  * Represents a JWT body for serialization/deserialization purposes.\n  */\n @Builder\n @Getter\n @Setter\n+@JsonInclude(JsonInclude.Include.NON_NULL)\n public class JwtBody {\n \n     // See https://tools.ietf.org/html/rfc7519#page-9 for additional details about these fields.\n \n     /**\n      * The \"sub\" (for subject) claim of the JWT body.\n      */\n-    @SerializedName(\"sub\")\n+    @JsonProperty(\"sub\")\n     private final String subject;\n \n     /**\n      * The \"aud\" (for audience) claim of the JWT body.\n      */\n-    @SerializedName(\"aud\")\n+    @JsonProperty(\"aud\")\n     private final String audience;\n \n     /**\n      * The \"iat\" (for issued at) claim of the JWT body.\n      */\n-    @SerializedName(\"iat\")\n+    @JsonProperty(\"iat\")\n     private final Long issuedAtTime;\n \n     /**\n      * The \"exp\" (for expiration time) claim of the JWT body. It identifies the time on or after which the JWT must not\n      * be accepted for processing. The value represents seconds past 1970-01-01 00:00:00Z.\n      */\n-    @SerializedName(\"exp\")\n+    @JsonProperty(\"exp\")\n     private final Long expirationTime;\n-}\n \n+    @SneakyThrows\n+    @Override\n+    public String toString() {\n+        return new ObjectMapper().writeValueAsString(this);\n+    }\n+\n+    @SneakyThrows\n+    public static JwtBody fromJson(String json) {\n+        try (StringReader jsonReader = new StringReader(json)) {\n+            return new ObjectMapper().readValue(jsonReader, JwtBody.class);", "originalCommit": "023537f0a445c403c8ec3fb4242228f7c351c2ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUyNDI3Ng==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430524276", "bodyText": "Sure, that's a good idea. I've made the change in the latest commit I've pushed.", "author": "ravisharda", "createdAt": "2020-05-26T15:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NzM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4ODIyMA==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430388220", "bodyText": "nit (this is only a test):\njwtBody.toString().getBytes(StandardCharsets.US_ASCII)", "author": "eolivelli", "createdAt": "2020-05-26T12:52:54Z", "path": "common/src/test/java/io/pravega/common/security/JwtUtilsTest.java", "diffHunk": "@@ -29,8 +31,9 @@ public void testExtractExpirationTimeReturnsNullIfExpInBodyIsNotSet() {\n         //        \"aud\": \"segmentstore\",\n         //        \"iat\": 1516239022\n         //     }\n+        JwtBody jwtBody = JwtBody.builder().subject(\"1234567890\").audience(\"segmentstore\").issuedAtTime(1516239022L).build();\n         String token = String.format(\"%s.%s.%s\", \"base64-encoded-header\",\n-                JwtBody.builder().subject(\"1234567890\").audience(\"segmentstore\").issuedAtTime(1516239022L).build(),\n+                Base64.getEncoder().encodeToString(jwtBody.toString().getBytes()),", "originalCommit": "023537f0a445c403c8ec3fb4242228f7c351c2ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUyNDU5NA==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430524594", "bodyText": "Sounds good. Thanks. Fixed.", "author": "ravisharda", "createdAt": "2020-05-26T15:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4ODIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4OTIwNA==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430389204", "bodyText": "what about:\njson.getBytes(StandardCharsets-UTF-8)", "author": "eolivelli", "createdAt": "2020-05-26T12:54:28Z", "path": "test/testcommon/src/main/java/io/pravega/test/common/JwtTestUtils.java", "diffHunk": "@@ -26,7 +24,7 @@\n      * @return a Base64 encoded JSON representing the specified {@code jwtBodyPart}\n      */\n     public static String toCompact(JwtBody jwtBodyPart) {\n-        String json = new Gson().toJson(jwtBodyPart);\n+        String json = jwtBodyPart.toString();\n         return Base64.getEncoder().encodeToString(json.getBytes());", "originalCommit": "023537f0a445c403c8ec3fb4242228f7c351c2ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUyNDc1MA==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430524750", "bodyText": "Fixed.", "author": "ravisharda", "createdAt": "2020-05-26T15:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4OTIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM5MzE1Nw==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430393157", "bodyText": "no need for a StringReader", "author": "eolivelli", "createdAt": "2020-05-26T13:00:33Z", "path": "test/testcommon/src/main/java/io/pravega/test/common/JwtBody.java", "diffHunk": "@@ -9,44 +9,62 @@\n  */\n package io.pravega.test.common;\n \n-import com.google.gson.annotations.SerializedName;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import lombok.Builder;\n import lombok.Getter;\n import lombok.Setter;\n+import lombok.SneakyThrows;\n+\n+import java.io.StringReader;\n \n /**\n  * Represents a JWT body for serialization/deserialization purposes.\n  */\n @Builder\n @Getter\n @Setter\n+@JsonInclude(JsonInclude.Include.NON_NULL)\n public class JwtBody {\n \n     // See https://tools.ietf.org/html/rfc7519#page-9 for additional details about these fields.\n \n     /**\n      * The \"sub\" (for subject) claim of the JWT body.\n      */\n-    @SerializedName(\"sub\")\n+    @JsonProperty(\"sub\")\n     private final String subject;\n \n     /**\n      * The \"aud\" (for audience) claim of the JWT body.\n      */\n-    @SerializedName(\"aud\")\n+    @JsonProperty(\"aud\")\n     private final String audience;\n \n     /**\n      * The \"iat\" (for issued at) claim of the JWT body.\n      */\n-    @SerializedName(\"iat\")\n+    @JsonProperty(\"iat\")\n     private final Long issuedAtTime;\n \n     /**\n      * The \"exp\" (for expiration time) claim of the JWT body. It identifies the time on or after which the JWT must not\n      * be accepted for processing. The value represents seconds past 1970-01-01 00:00:00Z.\n      */\n-    @SerializedName(\"exp\")\n+    @JsonProperty(\"exp\")\n     private final Long expirationTime;\n-}\n \n+    @SneakyThrows\n+    @Override\n+    public String toString() {\n+        return new ObjectMapper().writeValueAsString(this);\n+    }\n+\n+    @SneakyThrows\n+    public static JwtBody fromJson(String json) {\n+        try (StringReader jsonReader = new StringReader(json)) {", "originalCommit": "023537f0a445c403c8ec3fb4242228f7c351c2ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUyNTI3MA==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430525270", "bodyText": "yeah, fixed.", "author": "ravisharda", "createdAt": "2020-05-26T15:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM5MzE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM5MzYzNw==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430393637", "bodyText": "can this 'toString()' return a null value ?", "author": "eolivelli", "createdAt": "2020-05-26T13:01:16Z", "path": "test/testcommon/src/test/java/io/pravega/test/common/JwtBodyTest.java", "diffHunk": "@@ -25,15 +24,13 @@ public void testSerialize() {\n                 .issuedAtTime(Instant.now().getEpochSecond())\n                 .expirationTime(Instant.now().plusSeconds(50).getEpochSecond())\n                 .build();\n-\n-        String json = new Gson().toJson(jwtBody);\n-        assertNotNull(json);\n+        assertNotNull(jwtBody.toString());", "originalCommit": "023537f0a445c403c8ec3fb4242228f7c351c2ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUyNTEyMQ==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430525121", "bodyText": "I've modified the assertions to make them more relevant, given the change.", "author": "ravisharda", "createdAt": "2020-05-26T15:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM5MzYzNw=="}], "type": "inlineReview"}, {"oid": "27f2b04a7dcc913c347c13fff2fbf626bf118183", "url": "https://github.com/pravega/pravega/commit/27f2b04a7dcc913c347c13fff2fbf626bf118183", "message": "Address review comments\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-05-26T15:55:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzNjgyMQ==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430836821", "bodyText": "StandardCharsets.UTF8", "author": "shrids", "createdAt": "2020-05-27T03:26:23Z", "path": "common/src/test/java/io/pravega/common/security/JwtUtilsTest.java", "diffHunk": "@@ -29,8 +32,9 @@ public void testExtractExpirationTimeReturnsNullIfExpInBodyIsNotSet() {\n         //        \"aud\": \"segmentstore\",\n         //        \"iat\": 1516239022\n         //     }\n+        JwtBody jwtBody = JwtBody.builder().subject(\"1234567890\").audience(\"segmentstore\").issuedAtTime(1516239022L).build();\n         String token = String.format(\"%s.%s.%s\", \"base64-encoded-header\",\n-                JwtBody.builder().subject(\"1234567890\").audience(\"segmentstore\").issuedAtTime(1516239022L).build(),\n+                Base64.getEncoder().encodeToString(jwtBody.toString().getBytes(StandardCharsets.US_ASCII)),", "originalCommit": "27f2b04a7dcc913c347c13fff2fbf626bf118183", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzODU4Mw==", "url": "https://github.com/pravega/pravega/pull/4812#discussion_r430838583", "bodyText": "Since ASCII is a subset of UTF-8 and every ASCII text is also a UTF-8 text, and we use only ASCII characters in this particular test, I think it should be OK to use the specified charset.", "author": "ravisharda", "createdAt": "2020-05-27T03:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzNjgyMQ=="}], "type": "inlineReview"}]}