{"pr_number": 5059, "pr_title": "Issue 4162: add TLS mode system tests", "pr_createdAt": "2020-08-12T06:19:38Z", "pr_url": "https://github.com/pravega/pravega/pull/5059", "timeline": [{"oid": "6b2deeabde0d3468d7ba34ef861fe5c5b0f0136a", "url": "https://github.com/pravega/pravega/commit/6b2deeabde0d3468d7ba34ef861fe5c5b0f0136a", "message": "add TLS mode system tests\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-12T06:10:37Z", "type": "commit"}, {"oid": "23398ce97bf5a57afeac108e70bf6c59cd8009d0", "url": "https://github.com/pravega/pravega/commit/23398ce97bf5a57afeac108e70bf6c59cd8009d0", "message": "add alternate cert location\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-12T17:29:43Z", "type": "commit"}, {"oid": "b80f4b6f0e340a1ada1f180a0d616fbb3ccddb31", "url": "https://github.com/pravega/pravega/commit/b80f4b6f0e340a1ada1f180a0d616fbb3ccddb31", "message": "Squashed commit of the following:\n\ncommit 23bae0372e9a5302837df71b7eeb676ae09cd710\nAuthor: Ravi Rajamani <ravi.rajamani@emc.com>\nDate:   Sun Aug 16 19:37:00 2020 -0700\n\n    add tls secret\n\n    Signed-off-by: Ravi Rajamani <ravi.rajamani@emc.com>\n\ncommit 35a92ef5e652fdcde6da4d2b694ca341d7482ae9\nAuthor: Ravi Rajamani <ravi.rajamani@emc.com>\nDate:   Sun Aug 16 04:24:16 2020 -0700\n\n    add cert\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-17T03:06:28Z", "type": "commit"}, {"oid": "494533acdb2c7022c2847b6ae138c54b2d3d2fc2", "url": "https://github.com/pravega/pravega/commit/494533acdb2c7022c2847b6ae138c54b2d3d2fc2", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-08-17T03:07:55Z", "type": "commit"}, {"oid": "9cb0d11d3cff70df872167232bebb681c8fa46bc", "url": "https://github.com/pravega/pravega/commit/9cb0d11d3cff70df872167232bebb681c8fa46bc", "message": "add header\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-17T05:31:45Z", "type": "commit"}, {"oid": "9585c2be21eb4ca00c3445e0cacbb3f649ccfdca", "url": "https://github.com/pravega/pravega/commit/9585c2be21eb4ca00c3445e0cacbb3f649ccfdca", "message": "add checkstylemain\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-19T13:57:06Z", "type": "commit"}, {"oid": "e89efccdf00999b665377b05b629cdba867c3b9e", "url": "https://github.com/pravega/pravega/commit/e89efccdf00999b665377b05b629cdba867c3b9e", "message": "add env var for operator\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-20T14:28:57Z", "type": "commit"}, {"oid": "9c1c91a5c23af201848685ea52f528da14a4583e", "url": "https://github.com/pravega/pravega/commit/9c1c91a5c23af201848685ea52f528da14a4583e", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-08-20T14:30:55Z", "type": "commit"}, {"oid": "346e7cc2fc7f6dcb465657d5c70ac4b558350887", "url": "https://github.com/pravega/pravega/commit/346e7cc2fc7f6dcb465657d5c70ac4b558350887", "message": "pass tlsStaticSpec to pravega-operator\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-20T17:52:30Z", "type": "commit"}, {"oid": "9ff8cdd2d524dc19eff00cf3b25de5a67a5b430c", "url": "https://github.com/pravega/pravega/commit/9ff8cdd2d524dc19eff00cf3b25de5a67a5b430c", "message": "pass tlsSpec\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-21T00:52:42Z", "type": "commit"}, {"oid": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "url": "https://github.com/pravega/pravega/commit/852739281fbab4ed0c1321a368ac8bf3f11fc849", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-08-21T04:15:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NDgyMw==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475344823", "bodyText": "This flag is used for enabling both TLS and AUTH in this PR. I suppose it should be called something like TLS_AND_AUTH_ENABLED.", "author": "ravisharda", "createdAt": "2020-08-24T05:05:58Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/Utils.java", "diffHunk": "@@ -48,9 +48,15 @@\n     public static final int ALTERNATIVE_REST_PORT = 9094;\n     public static final TestExecutorFactory.TestExecutorType EXECUTOR_TYPE = TestExecutorFactory.getTestExecutionType();\n     public static final boolean AUTH_ENABLED = isAuthEnabled();\n+    public static final boolean TLS_ENABLED = isTLSEnabled();", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NjMzMA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475346330", "bodyText": "Using both of these flags - a static flag and a an input argument - looks redundant and somewhat confusing too. Why don't you use just one of these?", "author": "ravisharda", "createdAt": "2020-08-24T05:12:04Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/Utils.java", "diffHunk": "@@ -149,18 +162,32 @@ public static Service createPravegaSegmentStoreService(final URI zkUri, final UR\n     }\n \n     public static ClientConfig buildClientConfig(URI controllerUri) {\n-        if (!AUTH_ENABLED) {\n-            log.debug(\"Generating config with auth disabled.\");\n-            return ClientConfig.builder().controllerURI(controllerUri).build();\n-        } else {\n+           return buildClientConfig(controllerUri, false);\n+    }\n+\n+    public static ClientConfig buildClientConfig(URI controllerUri, boolean enableTls) {\n+        if (TLS_ENABLED || enableTls) {", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NzAwMA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475347000", "bodyText": "The name of this variable doesn't reflect the intent well. Could you please rename it? What does it represent?", "author": "ravisharda", "createdAt": "2020-08-24T05:14:35Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/services/kubernetes/AbstractService.java", "diffHunk": "@@ -79,6 +89,8 @@\n     static final String CUSTOM_RESOURCE_KIND_PRAVEGA = \"PravegaCluster\";\n     static final String PRAVEGA_CONTROLLER_LABEL = \"pravega-controller\";\n     static final String PRAVEGA_SEGMENTSTORE_LABEL = \"pravega-segmentstore\";\n+    static final String PRAVEGA_CONTROLLER_CONFIG_MAP = \"pravega-pravega-controller\";\n+    static final String SELFSIGNED_CERT_TLS = \"selfsigned-cert-tls\";", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NzM0NQ==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475347345", "bodyText": "Should it be called WEBHOOK_CERT_GENERATE to reflect the intent better?", "author": "ravisharda", "createdAt": "2020-08-24T05:15:39Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/services/kubernetes/AbstractService.java", "diffHunk": "@@ -91,6 +103,7 @@\n     private static final String TIER2_NFS = \"nfs\";\n     private static final String TIER2_TYPE = System.getProperty(\"tier2Type\", TIER2_NFS);\n     private static final boolean IS_OPERATOR_VERSION_ABOVE_040 = isOperatorVersionAbove040();\n+    private static final String WEBHOOK_GENERATE = \"webhookCert.generate\";", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NzUyNA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475347524", "bodyText": "Please use a single flag only. Since this a class member, ideally it shouldn't depend on a static member.", "author": "ravisharda", "createdAt": "2020-08-24T05:16:29Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/services/kubernetes/AbstractService.java", "diffHunk": "@@ -106,13 +119,19 @@ public String getID() {\n     }\n \n     CompletableFuture<Object> deployPravegaUsingOperator(final URI zkUri, int controllerCount, int segmentStoreCount, int bookieCount, ImmutableMap<String, String> props) {\n-    return k8sClient.createCRD(getPravegaCRD())\n+        return deployPravegaUsingOperator(zkUri, controllerCount, segmentStoreCount, bookieCount, props, false);\n+    }\n+\n+    CompletableFuture<Object> deployPravegaUsingOperator(final URI zkUri, int controllerCount, int segmentStoreCount, int bookieCount, ImmutableMap<String, String> props, boolean enableTls) {\n+\n+    return registerTLSSecret()\n+                        .thenCompose(v -> k8sClient.createCRD(getPravegaCRD()))\n                         .thenCompose(v -> k8sClient.createRole(NAMESPACE, getPravegaOperatorRole()))\n                         .thenCompose(v -> k8sClient.createClusterRole(getPravegaOperatorClusterRole()))\n                         .thenCompose(v -> k8sClient.createRoleBinding(NAMESPACE, getPravegaOperatorRoleBinding()))\n                         .thenCompose(v -> k8sClient.createClusterRoleBinding(getPravegaOperatorClusterRoleBinding()))\n                         //deploy pravega operator.\n-                        .thenCompose(v -> k8sClient.createDeployment(NAMESPACE, getPravegaOperatorDeployment()))\n+                        .thenCompose(v -> k8sClient.createDeployment(NAMESPACE, getPravegaOperatorDeployment(enableTls || Utils.TLS_ENABLED)))", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0Nzk2OA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475347968", "bodyText": "A better name for the SELFSIGNED_CERT_TLS variable be CONTROLLER_SECRET and  or a SEGMENTSTORE_SECRET in my view. If you want to use the same, just a slightly more abstract SERVER_SECRET'd do.", "author": "ravisharda", "createdAt": "2020-08-24T05:18:18Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/services/kubernetes/AbstractService.java", "diffHunk": "@@ -166,11 +185,20 @@ public String getID() {\n                 .put(\"tier2\", tier2Spec())\n                 .build();\n \n+        final Map<String, Object> staticTlsSpec = ImmutableMap.<String, Object>builder()\n+                .put(\"controllerSecret\", SELFSIGNED_CERT_TLS)", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM3NjI2MQ==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475376261", "bodyText": "The debug message is misleading, as both Auth and TLS are disabled.", "author": "ravisharda", "createdAt": "2020-08-24T06:49:26Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/Utils.java", "diffHunk": "@@ -149,18 +162,32 @@ public static Service createPravegaSegmentStoreService(final URI zkUri, final UR\n     }\n \n     public static ClientConfig buildClientConfig(URI controllerUri) {\n-        if (!AUTH_ENABLED) {\n-            log.debug(\"Generating config with auth disabled.\");\n-            return ClientConfig.builder().controllerURI(controllerUri).build();\n-        } else {\n+           return buildClientConfig(controllerUri, false);\n+    }\n+\n+    public static ClientConfig buildClientConfig(URI controllerUri, boolean enableTls) {\n+        if (TLS_ENABLED || enableTls) {\n+            String certPath = enableTls ? \"/opt/pravega/conf/server-cert.crt\" : DEFAULT_TRUSTSTORE_PATH;\n+            log.debug(\"Generating config with tls enabled.\");\n+            return ClientConfig.builder()\n+                               // TLS-related client-side configuration\n+                               .trustStore(certPath)\n+                               .validateHostName(VALIDATE_HOSTNAME)\n+                               // auth\n+                               .credentials(new DefaultCredentials(\"1111_aaaa\", \"admin\"))\n+                               .controllerURI(controllerUri)\n+                               .build();\n+        } else if (AUTH_ENABLED) {\n             log.debug(\"Generating config with auth enabled.\");\n             return ClientConfig.builder()\n                                // auth\n                                .credentials(new DefaultCredentials(\"1111_aaaa\", \"admin\"))\n                                .controllerURI(controllerUri)\n                                .build();\n+        } else {\n+            log.debug(\"Generating config with auth disabled.\");", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM3NzA5NA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475377094", "bodyText": "The exception itself is eaten up here. This should be throwing an exception or handle it so that the flow below doesn't execute.", "author": "ravisharda", "createdAt": "2020-08-24T06:51:25Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/services/kubernetes/AbstractService.java", "diffHunk": "@@ -317,6 +345,36 @@ private V1beta1CustomResourceDefinition getPravegaCRD() {\n \n     }\n \n+    private static V1Secret getTLSSecret() {\n+        String data = \"\";\n+        String yamlInputPath = \"secret.yaml\";\n+        try (InputStream inputStream = Utils.class.getClassLoader().getResourceAsStream(yamlInputPath)) {\n+            data = IOUtils.toString(inputStream, StandardCharsets.UTF_8);\n+        } catch (IOException e) {\n+            log.error(\"Could not read from: {}, data:{}\", yamlInputPath, data);", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM3ODI2Nw==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475378267", "bodyText": "If the server cert is signed by a CA, using the CA's certificate as the truststore is better as that'd reflect real-world scenarios better.", "author": "ravisharda", "createdAt": "2020-08-24T06:54:27Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/services/kubernetes/AbstractService.java", "diffHunk": "@@ -428,6 +496,24 @@ private V1Deployment getPravegaOperatorDeployment() {\n                                         .build();\n     }\n \n+    public CompletableFuture<V1ConfigMap> setupTLS() {\n+            V1ConfigMap configMap = Futures.getThrowingException(k8sClient.getConfigMap(PRAVEGA_CONTROLLER_CONFIG_MAP, NAMESPACE));\n+            return k8sClient.deleteConfigMap(PRAVEGA_CONTROLLER_CONFIG_MAP, NAMESPACE)\n+                        .thenCompose(v -> k8sClient.createConfigMap(NAMESPACE, addDefaultTlsConfiguration(configMap)));\n+    }\n+\n+    private V1ConfigMap addDefaultTlsConfiguration(V1ConfigMap configMap) {\n+            return configMap\n+                        .putDataItem(\"TLS_ENABLED\", \"true\")\n+                        .putDataItem(\"TLS_KEY_FILE\", \"/opt/pravega/conf/server-key.key\")\n+                        .putDataItem(\"TLS_CERT_FILE\", \"/opt/pravega/conf/server-cert.crt\")\n+                        .putDataItem(\"TLS_TRUST_STORE\", \"/opt/pravega/conf/server-cert.crt\")", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM3OTMwNQ==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475379305", "bodyText": "This is old property. Use controller.security.tls.server.keyStore.location instead.", "author": "ravisharda", "createdAt": "2020-08-24T06:56:53Z", "path": "test/system/src/test/resources/pravega_withTLS.properties", "diffHunk": "@@ -0,0 +1,41 @@\n+# Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+autoScale.mute.time.seconds=120\n+autoScale.cooldown.time.seconds=120\n+autoScale.cache.expiry.seconds=120\n+autoScale.cache.cleanUp.interval.seconds=120\n+curator-default-session-timeout=10000\n+bookkeeper.ack.quorum.size=3\n+controller.transaction.lease.count.max=120000\n+controller.retention.frequency.minutes=2\n+log.level=DEBUG\n+hdfs.replaceDataNodesOnFailure.enable=false\n+controller.security.auth.enable=true\n+controller.security.pwdAuthHandler.accountsDb.location=/opt/pravega/conf/passwd\n+controller.security.auth.delegationToken.signingKey.basis=secret\n+autoscale.controller.connect.security.auth.enable=true\n+autoscale.security.auth.token.signingKey.basis=secret\n+#4GB of cache.\n+pravegaservice.cache.size.max=4294967296\n+#4GB of cache + a buffer for whatever else Netty might need it for.\n+io.netty.maxDirectMemory=5368709120\n+pravega.client.auth.token=YWRtaW46MTExMV9hYWFh\n+pravega.client.auth.method=Basic\n+# tls.crt \n+controller.security.tls.enable=true\n+controller.security.tls.trustStore.location=/etc/secret-volume/tls.crt\n+controller.security.tls.server.certificate.location=/etc/secret-volume/tls.crt\n+controller.security.tls.server.privateKey.location=/etc/secret-volume/tls.key\n+controller.security.tls.server.keyStore.location=/opt/pravega/conf/server.keystore.jks\n+controller.security.tls.server.keyStore.pwd.location=/opt/pravega/conf/server.keystore.jks.passwd\n+controller.rest.tlsKeyStoreFile=/opt/pravega/conf/server.keystore.jks", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM3OTUyNQ==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475379525", "bodyText": "This too is an old property. Use controller.security.tls.server.keyStore.pwd.location instead.", "author": "ravisharda", "createdAt": "2020-08-24T06:57:27Z", "path": "test/system/src/test/resources/pravega_withTLS.properties", "diffHunk": "@@ -0,0 +1,41 @@\n+# Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+autoScale.mute.time.seconds=120\n+autoScale.cooldown.time.seconds=120\n+autoScale.cache.expiry.seconds=120\n+autoScale.cache.cleanUp.interval.seconds=120\n+curator-default-session-timeout=10000\n+bookkeeper.ack.quorum.size=3\n+controller.transaction.lease.count.max=120000\n+controller.retention.frequency.minutes=2\n+log.level=DEBUG\n+hdfs.replaceDataNodesOnFailure.enable=false\n+controller.security.auth.enable=true\n+controller.security.pwdAuthHandler.accountsDb.location=/opt/pravega/conf/passwd\n+controller.security.auth.delegationToken.signingKey.basis=secret\n+autoscale.controller.connect.security.auth.enable=true\n+autoscale.security.auth.token.signingKey.basis=secret\n+#4GB of cache.\n+pravegaservice.cache.size.max=4294967296\n+#4GB of cache + a buffer for whatever else Netty might need it for.\n+io.netty.maxDirectMemory=5368709120\n+pravega.client.auth.token=YWRtaW46MTExMV9hYWFh\n+pravega.client.auth.method=Basic\n+# tls.crt \n+controller.security.tls.enable=true\n+controller.security.tls.trustStore.location=/etc/secret-volume/tls.crt\n+controller.security.tls.server.certificate.location=/etc/secret-volume/tls.crt\n+controller.security.tls.server.privateKey.location=/etc/secret-volume/tls.key\n+controller.security.tls.server.keyStore.location=/opt/pravega/conf/server.keystore.jks\n+controller.security.tls.server.keyStore.pwd.location=/opt/pravega/conf/server.keystore.jks.passwd\n+controller.rest.tlsKeyStoreFile=/opt/pravega/conf/server.keystore.jks\n+controller.rest.tlsKeyStorePasswordFile=/opt/pravega/conf/server.keystore.jks.passwd", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4MDA3OA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r475380078", "bodyText": "Properties from lime 38 to 41 are also old properties. Replace them with the new properties. The mapping between old and new properties can be found here: https://github.com/pravega/pravega/wiki/Configuration-Name-Changes.", "author": "ravisharda", "createdAt": "2020-08-24T06:58:46Z", "path": "test/system/src/test/resources/pravega_withTLS.properties", "diffHunk": "@@ -0,0 +1,41 @@\n+# Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+autoScale.mute.time.seconds=120\n+autoScale.cooldown.time.seconds=120\n+autoScale.cache.expiry.seconds=120\n+autoScale.cache.cleanUp.interval.seconds=120\n+curator-default-session-timeout=10000\n+bookkeeper.ack.quorum.size=3\n+controller.transaction.lease.count.max=120000\n+controller.retention.frequency.minutes=2\n+log.level=DEBUG\n+hdfs.replaceDataNodesOnFailure.enable=false\n+controller.security.auth.enable=true\n+controller.security.pwdAuthHandler.accountsDb.location=/opt/pravega/conf/passwd\n+controller.security.auth.delegationToken.signingKey.basis=secret\n+autoscale.controller.connect.security.auth.enable=true\n+autoscale.security.auth.token.signingKey.basis=secret\n+#4GB of cache.\n+pravegaservice.cache.size.max=4294967296\n+#4GB of cache + a buffer for whatever else Netty might need it for.\n+io.netty.maxDirectMemory=5368709120\n+pravega.client.auth.token=YWRtaW46MTExMV9hYWFh\n+pravega.client.auth.method=Basic\n+# tls.crt \n+controller.security.tls.enable=true\n+controller.security.tls.trustStore.location=/etc/secret-volume/tls.crt\n+controller.security.tls.server.certificate.location=/etc/secret-volume/tls.crt\n+controller.security.tls.server.privateKey.location=/etc/secret-volume/tls.key\n+controller.security.tls.server.keyStore.location=/opt/pravega/conf/server.keystore.jks\n+controller.security.tls.server.keyStore.pwd.location=/opt/pravega/conf/server.keystore.jks.passwd\n+controller.rest.tlsKeyStoreFile=/opt/pravega/conf/server.keystore.jks\n+controller.rest.tlsKeyStorePasswordFile=/opt/pravega/conf/server.keystore.jks.passwd\n+pravegaservice.certFile=/etc/secret-volume/tls.crt", "originalCommit": "852739281fbab4ed0c1321a368ac8bf3f11fc849", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc1Mjc3NA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r484752774", "bodyText": "@ravibeta config lines from lies 36 to 39 still use old names, but the comment is marked resolved. Can you please fix them?\n\n  \n    \n      pravega/test/system/src/test/resources/pravega_withTLS.properties\n    \n    \n        Lines 38 to 41\n      in\n      8527392\n    \n    \n    \n    \n\n        \n          \n           pravegaservice.certFile=/etc/secret-volume/tls.crt \n        \n\n        \n          \n           pravegaservice.enableTls=false \n        \n\n        \n          \n           pravegaservice.keyFile=/etc/secret-volume/tls.key \n        \n\n        \n          \n           pravegaservice.secureZK=false", "author": "ravisharda", "createdAt": "2020-09-08T08:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4MDA3OA=="}], "type": "inlineReview"}, {"oid": "6b1a4221ca0e44c8b91a236bdb9bb5a31b428398", "url": "https://github.com/pravega/pravega/commit/6b1a4221ca0e44c8b91a236bdb9bb5a31b428398", "message": "code review comments\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-24T07:35:28Z", "type": "commit"}, {"oid": "039846447ab199c27d94fbafd378ade03a947c85", "url": "https://github.com/pravega/pravega/commit/039846447ab199c27d94fbafd378ade03a947c85", "message": "remove unused code\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-24T07:42:58Z", "type": "commit"}, {"oid": "bdcec78a38fa97bda75e05be40bd4c4851e28ca8", "url": "https://github.com/pravega/pravega/commit/bdcec78a38fa97bda75e05be40bd4c4851e28ca8", "message": "checkstylemain\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-24T08:10:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAwMjQ2MA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r477002460", "bodyText": "Please modify this log message too to say both TLS and auth are enabled", "author": "ravisharda", "createdAt": "2020-08-26T02:55:46Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/Utils.java", "diffHunk": "@@ -149,18 +157,27 @@ public static Service createPravegaSegmentStoreService(final URI zkUri, final UR\n     }\n \n     public static ClientConfig buildClientConfig(URI controllerUri) {\n-        if (!AUTH_ENABLED) {\n-            log.debug(\"Generating config with auth disabled.\");\n-            return ClientConfig.builder().controllerURI(controllerUri).build();\n-        } else {\n+        if (TLS_AND_AUTH_ENABLED) {\n+            log.debug(\"Generating config with tls enabled.\");", "originalCommit": "bdcec78a38fa97bda75e05be40bd4c4851e28ca8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAwNjYyOA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r477006628", "bodyText": "Yes Ravi", "author": "ravibeta", "createdAt": "2020-08-26T03:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAwMjQ2MA=="}], "type": "inlineReview"}, {"oid": "1a3cad6cdfdd5528a60aeba4ad9439b251298429", "url": "https://github.com/pravega/pravega/commit/1a3cad6cdfdd5528a60aeba4ad9439b251298429", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-08-26T03:02:40Z", "type": "commit"}, {"oid": "472d3449b3a698bb3d7b77d8c2227c811ec9152a", "url": "https://github.com/pravega/pravega/commit/472d3449b3a698bb3d7b77d8c2227c811ec9152a", "message": "exclude boringssl in favor of openssl\nadd logging\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-26T02:57:07Z", "type": "commit"}, {"oid": "99ccda1624532b9769052287ec10100501e9a111", "url": "https://github.com/pravega/pravega/commit/99ccda1624532b9769052287ec10100501e9a111", "message": "keep build as earlier to reduce surface area\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-26T03:50:04Z", "type": "commit"}, {"oid": "ddc4fa4b84ab7cfeac154ab91f4ac7390a2c858d", "url": "https://github.com/pravega/pravega/commit/ddc4fa4b84ab7cfeac154ab91f4ac7390a2c858d", "message": "set tls default off\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-08-26T13:59:13Z", "type": "commit"}, {"oid": "81fced48dcf531d631dd52efd8058af9ccf82562", "url": "https://github.com/pravega/pravega/commit/81fced48dcf531d631dd52efd8058af9ccf82562", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-08-30T11:54:32Z", "type": "commit"}, {"oid": "4a736fa861cf3e1ce6aee37eddefe87d4e883e77", "url": "https://github.com/pravega/pravega/commit/4a736fa861cf3e1ce6aee37eddefe87d4e883e77", "message": "keep earlier properties\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-09-02T02:20:37Z", "type": "commit"}, {"oid": "3e587416e462e0dd808949278da9599184d89f06", "url": "https://github.com/pravega/pravega/commit/3e587416e462e0dd808949278da9599184d89f06", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-09-02T02:23:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY0OTk3NQ==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r481649975", "bodyText": "@ravisharda, is it possible to have only TLS enabled why AUTH is disabled? It looks a bit odd that both must be enabled or at least TLS cannot be enabled alone. I was told that there is something in the current design that forces so, could you please clarify a bit? Thanks", "author": "medvedevigorek", "createdAt": "2020-09-02T04:14:24Z", "path": "test/system/src/main/java/io/pravega/test/system/framework/Utils.java", "diffHunk": "@@ -149,18 +157,27 @@ public static Service createPravegaSegmentStoreService(final URI zkUri, final UR\n     }\n \n     public static ClientConfig buildClientConfig(URI controllerUri) {\n-        if (!AUTH_ENABLED) {\n-            log.debug(\"Generating config with auth disabled.\");\n-            return ClientConfig.builder().controllerURI(controllerUri).build();\n-        } else {\n+        if (TLS_AND_AUTH_ENABLED) {", "originalCommit": "3e587416e462e0dd808949278da9599184d89f06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY2NTk3OA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r481665978", "bodyText": "@medvedevigorek technically both can be enabled/disabled independently of each other. So, you could have a config where TLS is enabled, but auth is disabled, just like you can have auth enabled with TLS disabled. However, in practical use, both shall be enabled in most cases.\nThe older flag in the system tests Jenkins job that represented \"security enabled\" only turned on auth, but not TLS, due to some of the inherent gaps that we had with the system tests configuration. With @ravibeta's changes, we can now have it enable both auth and tls.\nWith that background, as well as what the specific code in question does, it looks appropriate to call it TLS_AND_AUTH_ENABLED as opposed to just TLS_ENABLED.\nHope that clarifies.", "author": "ravisharda", "createdAt": "2020-09-02T04:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY0OTk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMwNTkxNA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r482305914", "bodyText": "okay, getting even more confused now.\nI get the part that in most cases auth  and tls are enabled together as it doesn't really make sense to have auth without tls. However there could be valid cases where auth is not required by tls is required.\nIf in the current state we say that we always want to have both enabled then we have a bit confusing configuration:\nsecurityEnabled - enables only auth part\ntlsEnabled - enables tls and auth (this is what confuses me)\nWe need either\n(a) securityEnabled - enables both auth and tls. And don't introduce tlsEnabled property at all\n(b) Have both properties present and require both to be enabled or none. But tlsEnabled shouldn't change auth state.\nWhat do you think?", "author": "medvedevigorek", "createdAt": "2020-09-02T18:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY0OTk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMxNjI4NA==", "url": "https://github.com/pravega/pravega/pull/5059#discussion_r482316284", "bodyText": "Yes Igor, it is too big a change for these system tests. May I please address it separately ? The issue is that pravega-operator deploys pravega cluster with the admin username and password and this can be fixed outside pravega repository first and accomodated in SDP. Thanks,", "author": "ravibeta", "createdAt": "2020-09-02T19:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTY0OTk3NQ=="}], "type": "inlineReview"}, {"oid": "5269188f7f35e2d781214f97d9a0aba47d386e31", "url": "https://github.com/pravega/pravega/commit/5269188f7f35e2d781214f97d9a0aba47d386e31", "message": "overcome No-subject-alternative-DNS-name-matching CertificateException\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-09-08T03:11:27Z", "type": "commit"}, {"oid": "fd0a2e84419ea1b92ece0078f20d0298cd8e5b1c", "url": "https://github.com/pravega/pravega/commit/fd0a2e84419ea1b92ece0078f20d0298cd8e5b1c", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-09-08T04:00:28Z", "type": "commit"}, {"oid": "6dbe824cd6561ca13562408bc3ddda51adf01157", "url": "https://github.com/pravega/pravega/commit/6dbe824cd6561ca13562408bc3ddda51adf01157", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-09-08T04:38:54Z", "type": "commit"}, {"oid": "1087888555bcd426ee47ea8816e73773132f1034", "url": "https://github.com/pravega/pravega/commit/1087888555bcd426ee47ea8816e73773132f1034", "message": "use newer properties\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-09-08T08:14:32Z", "type": "commit"}, {"oid": "c3f08bad09b3c5bfd8bd76124c67c45d5d39a54f", "url": "https://github.com/pravega/pravega/commit/c3f08bad09b3c5bfd8bd76124c67c45d5d39a54f", "message": "use mixedCase for newer properties\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-09-08T08:18:19Z", "type": "commit"}, {"oid": "46a6b71fa41e14cf23f9b0a1df8cac7c4c965c44", "url": "https://github.com/pravega/pravega/commit/46a6b71fa41e14cf23f9b0a1df8cac7c4c965c44", "message": "Merge branch 'master' into issue-4162-tls-mode-system-tests", "committedDate": "2020-09-08T09:03:40Z", "type": "commit"}, {"oid": "64997e5431355e9db3cab842455dafb1fa2268d7", "url": "https://github.com/pravega/pravega/commit/64997e5431355e9db3cab842455dafb1fa2268d7", "message": "add grpc properties\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-09-08T08:53:29Z", "type": "commit"}]}