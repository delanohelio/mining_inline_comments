{"pr_number": 4926, "pr_title": "Issue 4925: Unit Test fix for TableMetadataTasksTest in Controller", "pr_createdAt": "2020-07-07T12:01:47Z", "pr_url": "https://github.com/pravega/pravega/pull/4926", "timeline": [{"oid": "a0b24b108fb303b24b5b50d9a7de68111862cef9", "url": "https://github.com/pravega/pravega/commit/a0b24b108fb303b24b5b50d9a7de68111862cef9", "message": "Unit Test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-07T11:54:11Z", "type": "commit"}, {"oid": "d9e2ef054e2e67b6581ddf6c4c628cb6cd3f570d", "url": "https://github.com/pravega/pravega/commit/d9e2ef054e2e67b6581ddf6c4c628cb6cd3f570d", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-07T12:29:02Z", "type": "commit"}, {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "url": "https://github.com/pravega/pravega/commit/f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-07T13:59:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MDczMA==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450990730", "bodyText": "why is this changed?", "author": "shiveshr", "createdAt": "2020-07-07T16:25:41Z", "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -143,15 +143,7 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                                        return isCreateProcessed(scope, kvtName, kvtConfig, createTimestamp, executor);\n                                  });\n                             });\n-               }, e -> Exceptions.unwrap(e) instanceof RetryableException, NUM_RETRIES, executor)", "originalCommit": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAxODMyMA==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451018320", "bodyText": "Changed this so both delete and create have consistent behavior on timeout, earlier one returned FAILURE status on timeout and the other threw TimeoutException.", "author": "pbelgundi", "createdAt": "2020-07-07T17:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MDczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI5NDYzMQ==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451294631", "bodyText": "As discussed with Shivesh, changed both APIs to throw timeout exception when event timesout.", "author": "pbelgundi", "createdAt": "2020-07-08T05:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MDczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MTA2OQ==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450991069", "bodyText": "why not pass the operation context? that will avoid fetching the table names etc again from segment store", "author": "shiveshr", "createdAt": "2020-07-07T16:26:14Z", "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -180,10 +172,18 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                             DeleteTableEvent deleteEvent = new DeleteTableEvent(scope, kvtName, requestId, UUID.fromString(id));\n                             return eventHelper.addIndexAndSubmitTask(deleteEvent,\n                                     () -> kvtMetadataStore.setState(scope, kvtName, KVTableState.DELETING, context, executor))\n-                                    .thenCompose(x -> eventHelper.checkDone(() -> isDeleted(scope, kvtName, context)))", "originalCommit": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyMDcyOQ==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451020729", "bodyText": "When context is not present it fetches from cache.", "author": "pbelgundi", "createdAt": "2020-07-07T17:15:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MTA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MTgyMA==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450991820", "bodyText": "do we want to return a failure status from here? the request may have been submitted and still ongoing in the background. right?", "author": "shiveshr", "createdAt": "2020-07-07T16:27:23Z", "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -180,10 +172,18 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                             DeleteTableEvent deleteEvent = new DeleteTableEvent(scope, kvtName, requestId, UUID.fromString(id));\n                             return eventHelper.addIndexAndSubmitTask(deleteEvent,\n                                     () -> kvtMetadataStore.setState(scope, kvtName, KVTableState.DELETING, context, executor))\n-                                    .thenCompose(x -> eventHelper.checkDone(() -> isDeleted(scope, kvtName, context)))\n+                                    .thenCompose(x -> eventHelper.checkDone(() -> isDeleted(scope, kvtName)))\n                                     .thenApply(y -> DeleteKVTableStatus.Status.SUCCESS);\n                         });\n-            }), e -> Exceptions.unwrap(e) instanceof RetryableException, NUM_RETRIES, executor);", "originalCommit": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyMjU2Nw==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451022567", "bodyText": "Changed this to return failure status", "author": "pbelgundi", "createdAt": "2020-07-07T17:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MTgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI5NDcyMQ==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451294721", "bodyText": "Changed this as discussed.", "author": "pbelgundi", "createdAt": "2020-07-08T05:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MTgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjAwMg==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450992002", "bodyText": "why is this being removed?", "author": "shiveshr", "createdAt": "2020-07-07T16:27:40Z", "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -204,7 +204,7 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                                                 false, delegationToken, requestId), executor));\n     }\n \n-    private CompletableFuture<Boolean> isDeleted(String scope, String kvtName, KVTOperationContext context) {", "originalCommit": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NzY3Mw==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451047673", "bodyText": "It was passed but not used.", "author": "pbelgundi", "createdAt": "2020-07-07T18:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwMTc4Nw==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451401787", "bodyText": "Filed this for the delete test failure: #4927", "author": "pbelgundi", "createdAt": "2020-07-08T09:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjU0NQ==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450992545", "bodyText": "same here -- comparing the kvt config will determine if the create was actually performed with the supplied config or a different one from a concurrent request that got executed first.", "author": "shiveshr", "createdAt": "2020-07-07T16:28:36Z", "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -220,7 +220,7 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                                                                                   KeyValueTableConfiguration kvtConfig,\n                                                                                   final long createTimestamp,\n                                                                                   Executor executor) {\n-        return eventHelper.checkDone(() -> isCreated(scope, kvtName, kvtConfig, executor))", "originalCommit": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyNTIzMw==", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r451025233", "bodyText": "Configuration is being checked in isCreateProcessed() method. It is not required in isCreated() method and was passed but not used.", "author": "pbelgundi", "createdAt": "2020-07-07T17:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjU0NQ=="}], "type": "inlineReview"}, {"oid": "a93bc5ce45650adec9ed8f414211ce505dd2eff8", "url": "https://github.com/pravega/pravega/commit/a93bc5ce45650adec9ed8f414211ce505dd2eff8", "message": "fix failing test\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-07T17:05:38Z", "type": "commit"}, {"oid": "7d2e5c308d924d76467cd3e3de5f9269b0bb130a", "url": "https://github.com/pravega/pravega/commit/7d2e5c308d924d76467cd3e3de5f9269b0bb130a", "message": "changed handling of timeout\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-07T17:40:19Z", "type": "commit"}, {"oid": "25a2ef84c1a875ab521d2f82d583e4165cb973dd", "url": "https://github.com/pravega/pravega/commit/25a2ef84c1a875ab521d2f82d583e4165cb973dd", "message": "EventHelperMock test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-07T17:54:29Z", "type": "commit"}, {"oid": "c142634d1062a907601062a5c3c67b604f248447", "url": "https://github.com/pravega/pravega/commit/c142634d1062a907601062a5c3c67b604f248447", "message": "test fix as per code review comments\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-08T05:36:50Z", "type": "commit"}, {"oid": "2a30e91f21be76416506e9cffc839363f85199b4", "url": "https://github.com/pravega/pravega/commit/2a30e91f21be76416506e9cffc839363f85199b4", "message": "minor changes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-07-08T06:15:32Z", "type": "commit"}]}