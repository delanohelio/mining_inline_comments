{"pr_number": 5346, "pr_title": "Issue 5330: SLTS - Handle partially written chunks and snapshots after failures.", "pr_createdAt": "2020-11-17T23:19:58Z", "pr_url": "https://github.com/pravega/pravega/pull/5346", "timeline": [{"oid": "ea9193999972aff6132c71e513e0c2aaa53df98b", "url": "https://github.com/pravega/pravega/commit/ea9193999972aff6132c71e513e0c2aaa53df98b", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-19T00:47:50Z", "type": "forcePushed"}, {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260", "url": "https://github.com/pravega/pravega/commit/8405883f9764382d7f5dee8e6153f5e9e5f24260", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-19T04:16:06Z", "type": "commit"}, {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260", "url": "https://github.com/pravega/pravega/commit/8405883f9764382d7f5dee8e6153f5e9e5f24260", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-19T04:16:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5OTY1NQ==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r526999655", "bodyText": "Haven't we made these calls things async? Did we miss this class?", "author": "andreipaduroiu", "createdAt": "2020-11-19T15:56:59Z", "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -250,9 +250,14 @@ private long applyLatestSnapshot(MetadataTransaction txn, HashMap<String, Long>\n         for (epochToCheck = epoch - 1; epochToCheck >= 0; epochToCheck--) {\n             snapshotFile = getSystemJournalChunkName(containerId, epochToCheck, 0);\n             if (chunkStorage.exists(snapshotFile).get()) {", "originalCommit": "8405883f9764382d7f5dee8e6153f5e9e5f24260", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1MTgyMQ==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r527051821", "bodyText": "No we did not change it.", "author": "sachin-j-joshi", "createdAt": "2020-11-19T17:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5OTY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAwMTU0NA==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r527001544", "bodyText": "Why do you put this condition here? Don't you have full control over your test? You use in-memory storage here, so this should always be supported.", "author": "andreipaduroiu", "createdAt": "2020-11-19T15:59:26Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +333,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        testSimpleBootstrapWithMultipleFailovers(containerId, chunkStorage, epoch -> {\n+            val snapShotFile = NameUtils.getSystemJournalFileName(containerId, epoch, 0);\n+            val size = 1;\n+            if (chunkStorage.supportsTruncation()) {", "originalCommit": "8405883f9764382d7f5dee8e6153f5e9e5f24260", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA0OTQ0OQ==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r527049449", "bodyText": "This code is run against all providers (in bindings project) - not just in memory.", "author": "sachin-j-joshi", "createdAt": "2020-11-19T17:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAwMTU0NA=="}], "type": "inlineReview"}, {"oid": "d43b47e8c4b5ef161e3bc3a7c3e599de760d6ba7", "url": "https://github.com/pravega/pravega/commit/d43b47e8c4b5ef161e3bc3a7c3e599de760d6ba7", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-19T17:42:06Z", "type": "commit"}, {"oid": "a682e971cf99c6867fa81f85e40f28d00961d728", "url": "https://github.com/pravega/pravega/commit/a682e971cf99c6867fa81f85e40f28d00961d728", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-21T04:16:59Z", "type": "commit"}, {"oid": "3000b8507f867e171a1f8a7bfb2a9a7b59210f3e", "url": "https://github.com/pravega/pravega/commit/3000b8507f867e171a1f8a7bfb2a9a7b59210f3e", "message": "Issue 5330: SLTS - Correctly handle partially written chunks during write after previous failure.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-21T04:25:23Z", "type": "commit"}, {"oid": "b455be250e1d49297238a65b60db302d9a22fecc", "url": "https://github.com/pravega/pravega/commit/b455be250e1d49297238a65b60db302d9a22fecc", "message": "Issue 5330: SLTS - Code cleanup.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-11-21T16:56:58Z", "type": "commit"}, {"oid": "e0d19492b37d72c0c7e77465e911dcf2e1f7919d", "url": "https://github.com/pravega/pravega/commit/e0d19492b37d72c0c7e77465e911dcf2e1f7919d", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes", "committedDate": "2020-11-23T17:53:48Z", "type": "commit"}, {"oid": "bd50c2bd0fa633234104a3eda52390be4db66bf6", "url": "https://github.com/pravega/pravega/commit/bd50c2bd0fa633234104a3eda52390be4db66bf6", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes", "committedDate": "2020-12-02T21:03:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4ODk1MQ==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r535688951", "bodyText": "Can you do this with the Retry class (in common). We have various retry utilities that can help with your syntax here.", "author": "andreipaduroiu", "createdAt": "2020-12-03T22:26:30Z", "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -229,10 +230,23 @@ public void commitRecords(Collection<SystemJournalRecord> records) throws ChunkS\n         }\n         // Persist\n         synchronized (lock) {\n-            writeToJournal(bytes);\n-            // Add a new log file if required.\n-            if (!chunkStorage.supportsAppend() || !config.isAppendEnabled()) {\n-                startNewJournalFile();\n+            boolean done = false;\n+            while (!done) {", "originalCommit": "bd50c2bd0fa633234104a3eda52390be4db66bf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3NjI1OA==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r535776258", "bodyText": "I need to retry only if specific (wrapped) exception was thrown. I don't think Retry can do that.", "author": "sachin-j-joshi", "createdAt": "2020-12-04T01:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4ODk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NDAzMA==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539474030", "bodyText": ".retryWhen(ex -> Exceptions.unwrap(ex) instanceof xyz)", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4ODk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4OTIwMw==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r535689203", "bodyText": "Why just ExecutionException? Can it be Exception, CompletionException? Exceptions.unwrap will handle all of those.", "author": "andreipaduroiu", "createdAt": "2020-12-03T22:27:01Z", "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -229,10 +230,23 @@ public void commitRecords(Collection<SystemJournalRecord> records) throws ChunkS\n         }\n         // Persist\n         synchronized (lock) {\n-            writeToJournal(bytes);\n-            // Add a new log file if required.\n-            if (!chunkStorage.supportsAppend() || !config.isAppendEnabled()) {\n-                startNewJournalFile();\n+            boolean done = false;\n+            while (!done) {\n+                try {\n+                    writeToJournal(bytes);\n+                    done = true;\n+                } catch (ExecutionException e) {", "originalCommit": "bd50c2bd0fa633234104a3eda52390be4db66bf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3NzAzMA==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r535777030", "bodyText": "I want to catch and handle a very specific exception InvalidOffsetException wrapped in ExecutionException.\nOther exception should bubble up and loop should not be retried here.", "author": "sachin-j-joshi", "createdAt": "2020-12-04T01:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4OTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NDQxMg==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539474412", "bodyText": "What if that exception is wrapped in CompletionException?", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4OTIwMw=="}], "type": "inlineReview"}, {"oid": "0ceef0564c375805d23e000069e06775f1a5c677", "url": "https://github.com/pravega/pravega/commit/0ceef0564c375805d23e000069e06775f1a5c677", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes", "committedDate": "2020-12-04T01:52:56Z", "type": "commit"}, {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "url": "https://github.com/pravega/pravega/commit/4dcbd5fa0230a2392758e20804f08a210ea286d2", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes", "committedDate": "2020-12-09T06:51:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTI3Mg==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539475272", "bodyText": "Just like in the other PR, please add cleanup methods to this class.", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:53:20Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/ChunkedSegmentStorageTests.java", "diffHunk": "@@ -719,6 +719,38 @@ public void testWrite() throws Exception {\n         checkDataRead(testSegmentName, testContext, 0, total);\n     }\n \n+\n+    /**\n+     * Test Write after repeated failure.\n+     *\n+     * @throws Exception Exception if any.\n+     */\n+    @Test\n+    public void testWriteAfterWriteFailure() throws Exception {\n+        String testSegmentName = \"foo\";\n+        TestContext testContext = getTestContext();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwNzI2Ng==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539707266", "bodyText": "added", "author": "sachin-j-joshi", "createdAt": "2020-12-09T22:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTQ5Mw==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539475493", "bodyText": "Cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:53:37Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NjM2Mg==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476362", "bodyText": "Cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:54:44Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NjQ1NA==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476454", "bodyText": "Cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:54:50Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();\n+        ChunkMetadataStore metadataStoreAfterCrash = getMetadataStore();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NjY3OQ==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476679", "bodyText": "Cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:55:07Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();\n+        ChunkMetadataStore metadataStoreAfterCrash = getMetadataStore();\n+        int containerId = 42;\n+        String systemSegmentName = SystemJournal.getChunkStorageSystemSegments(containerId)[0];\n+        long epoch = 1;\n+        val policy = new SegmentRollingPolicy(4);\n+        val config = ChunkedSegmentStorageConfig.DEFAULT_CONFIG.toBuilder().defaultRollingPolicy(policy).build();\n+\n+        long offset = 0;\n+\n+        // Epoch 1\n+        ChunkedSegmentStorage segmentStorage1 = new ChunkedSegmentStorage(containerId, chunkStorage, metadataStore, executorService(), config);", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3Njk0NQ==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476945", "bodyText": "cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:55:28Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();\n+        ChunkMetadataStore metadataStoreAfterCrash = getMetadataStore();\n+        int containerId = 42;\n+        String systemSegmentName = SystemJournal.getChunkStorageSystemSegments(containerId)[0];\n+        long epoch = 1;\n+        val policy = new SegmentRollingPolicy(4);\n+        val config = ChunkedSegmentStorageConfig.DEFAULT_CONFIG.toBuilder().defaultRollingPolicy(policy).build();\n+\n+        long offset = 0;\n+\n+        // Epoch 1\n+        ChunkedSegmentStorage segmentStorage1 = new ChunkedSegmentStorage(containerId, chunkStorage, metadataStore, executorService(), config);\n+\n+        segmentStorage1.initialize(epoch);\n+\n+        // Bootstrap\n+        segmentStorage1.bootstrap().join();\n+        checkSystemSegmentsLayout(segmentStorage1);\n+\n+        // Simulate some writes to system segment, this should cause some new chunks being added.\n+        val h = segmentStorage1.openWrite(systemSegmentName).join();\n+        val b1 = \"Hello\".getBytes();\n+        segmentStorage1.write(h, offset, new ByteArrayInputStream(b1), b1.length, null).join();\n+        offset += b1.length;\n+\n+        // Inject a fault by adding some garbage at the end\n+        checkSystemSegmentsLayout(segmentStorage1);\n+        val chunkFileName = NameUtils.getSystemJournalFileName(segmentStorage1.getSystemJournal().getContainerId(),\n+                segmentStorage1.getSystemJournal().getEpoch(),\n+                segmentStorage1.getSystemJournal().getCurrentFileIndex());\n+        val chunkInfo = chunkStorage.getInfo(chunkFileName);\n+        chunkStorage.write(ChunkHandle.writeHandle(chunkFileName), chunkInfo.get().getLength(), 1, new ByteArrayInputStream(new byte[1])).get();\n+\n+        // This next write will encounter partially written chunk and is expected to start a new chunk.\n+        val b2 = \" World\".getBytes();\n+        segmentStorage1.write(h, offset, new ByteArrayInputStream(b2), b2.length, null).join();\n+        offset += b2.length;\n+\n+        checkSystemSegmentsLayout(segmentStorage1);\n+\n+        // Step 2\n+        // Start container with epoch 2\n+        epoch++;\n+\n+        ChunkedSegmentStorage segmentStorage2 = new ChunkedSegmentStorage(containerId, chunkStorage, metadataStoreAfterCrash, executorService(), config);", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzExMg==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477112", "bodyText": "cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:55:40Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -267,9 +341,12 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n      */\n     @Test\n     public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n+        val containerId = 42;\n         ChunkStorage chunkStorage = getChunkStorage();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzMxNw==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477317", "bodyText": "cleanup to all of these", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:55:55Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -305,7 +382,12 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n             oldHandle = h;\n         }\n \n+        if (null != faultInjection) {\n+            faultInjection.accept(epoch);\n+        }\n+\n         epoch++;\n+\n         ChunkMetadataStore metadataStoreFinal = getMetadataStore();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzM5Mw==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477393", "bodyText": "cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:56:01Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +406,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzgwMw==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477803", "bodyText": "Are you cleaning up this file anywhere? Leaving files behind is also a leak", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:56:31Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +406,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        testSimpleBootstrapWithMultipleFailovers(containerId, chunkStorage, epoch -> {\n+            val snapShotFile = NameUtils.getSystemJournalFileName(containerId, epoch, 0);\n+            val size = 1;\n+            if (chunkStorage.supportsTruncation()) {\n+                chunkStorage.truncate(ChunkHandle.writeHandle(snapShotFile), size).join();\n+            } else {\n+                val bytes = new byte[size];\n+                chunkStorage.read(ChunkHandle.readHandle(snapShotFile), 0, size, bytes, 0).join();\n+                chunkStorage.delete(ChunkHandle.writeHandle(snapShotFile)).join();\n+                val h = chunkStorage.create(snapShotFile).join();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzkxNg==", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477916", "bodyText": "cleanup", "author": "andreipaduroiu", "createdAt": "2020-12-09T16:56:37Z", "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +406,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        testSimpleBootstrapWithMultipleFailovers(containerId, chunkStorage, epoch -> {\n+            val snapShotFile = NameUtils.getSystemJournalFileName(containerId, epoch, 0);\n+            val size = 1;\n+            if (chunkStorage.supportsTruncation()) {\n+                chunkStorage.truncate(ChunkHandle.writeHandle(snapShotFile), size).join();\n+            } else {\n+                val bytes = new byte[size];\n+                chunkStorage.read(ChunkHandle.readHandle(snapShotFile), 0, size, bytes, 0).join();\n+                chunkStorage.delete(ChunkHandle.writeHandle(snapShotFile)).join();\n+                val h = chunkStorage.create(snapShotFile).join();\n+                chunkStorage.write(h, 0, size, new ByteArrayInputStream(bytes)).join();\n+            }\n+        });\n+    }\n+\n+    @Test\n+    public void testSimpleBootstrapWithMissingSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();", "originalCommit": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6a6a7d18bcda472d4dc01d3c2e4aac325ad75cb", "url": "https://github.com/pravega/pravega/commit/e6a6a7d18bcda472d4dc01d3c2e4aac325ad75cb", "message": "Issue 5390: SLTS - Cleanup in tests.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-12-09T22:13:41Z", "type": "commit"}, {"oid": "c107db377131ade388fe9582b7aff868465864d1", "url": "https://github.com/pravega/pravega/commit/c107db377131ade388fe9582b7aff868465864d1", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes", "committedDate": "2020-12-09T22:27:02Z", "type": "commit"}, {"oid": "61c2e81a17772cb09c60a2cddd42716c8e41dad5", "url": "https://github.com/pravega/pravega/commit/61c2e81a17772cb09c60a2cddd42716c8e41dad5", "message": "Issue 5390: SLTS - Cleanup in tests.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-12-09T22:32:42Z", "type": "commit"}, {"oid": "9261593bc3c2bcb12bbe904deee3e22b96ca00ac", "url": "https://github.com/pravega/pravega/commit/9261593bc3c2bcb12bbe904deee3e22b96ca00ac", "message": "Issue 5390: SLTS - Cleanup in tests - address review comments.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>", "committedDate": "2020-12-09T23:09:35Z", "type": "commit"}]}