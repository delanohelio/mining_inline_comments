{"pr_number": 4941, "pr_title": "Issue 4940: Propagating Transaction Exceptions to the caller", "pr_createdAt": "2020-07-12T02:06:49Z", "pr_url": "https://github.com/pravega/pravega/pull/4941", "timeline": [{"oid": "68daa829a652f24d76a4b34d30879dc86d2ca034", "url": "https://github.com/pravega/pravega/commit/68daa829a652f24d76a4b34d30879dc86d2ca034", "message": "throws TxnFailedException\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-12T02:03:07Z", "type": "commit"}, {"oid": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "url": "https://github.com/pravega/pravega/commit/664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "message": ":test:integration:checkstyleMain\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-12T02:51:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDQ4NA==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r453274484", "bodyText": "This comment does not add value. Can you please explain in which case, as an example, this method will throw this exception?", "author": "eolivelli", "createdAt": "2020-07-12T06:26:21Z", "path": "client/src/main/java/io/pravega/client/stream/Transaction.java", "diffHunk": "@@ -92,13 +92,16 @@\n \n     /**\n      * Drops the transaction, causing all events written to it to be deleted.\n+     *\n+     * @throws TxnFailedException Error aborting transaction: FAILURE\n      */\n-    void abort();\n+    void abort() throws TxnFailedException;\n \n     /**\n      * Gets the status of the transaction.\n      *\n+     *  @throws TxnFailedException This exception could be thrown on checkStatus", "originalCommit": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyOTA2NQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455929065", "bodyText": "Yes Enrico it does not throw TxnFailedException anymore.", "author": "ravibeta", "createdAt": "2020-07-16T16:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDUzNw==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r453274537", "bodyText": "This is weird from the user point of view.\nTxnFailedException sounds like the transaction is broken or you broke it by calling this method.\nHere I would expect some new TxNotValidException", "author": "eolivelli", "createdAt": "2020-07-12T06:26:58Z", "path": "client/src/main/java/io/pravega/client/stream/Transaction.java", "diffHunk": "@@ -92,13 +92,16 @@\n \n     /**\n      * Drops the transaction, causing all events written to it to be deleted.\n+     *\n+     * @throws TxnFailedException Error aborting transaction: FAILURE\n      */\n-    void abort();\n+    void abort() throws TxnFailedException;\n \n     /**\n      * Gets the status of the transaction.\n      *\n+     *  @throws TxnFailedException This exception could be thrown on checkStatus\n      *  @return Current status of the transaction\n      */\n-    Status checkStatus();\n+    Status checkStatus() throws TxnFailedException;", "originalCommit": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNjM3MA==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r454016370", "bodyText": "Yes Status includes aborted.", "author": "tkaitchuck", "createdAt": "2020-07-13T23:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDU3Mw==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r453274573", "bodyText": "This kind of comments are not useful to the user", "author": "eolivelli", "createdAt": "2020-07-12T06:27:32Z", "path": "client/src/main/java/io/pravega/client/stream/TransactionalEventStreamWriter.java", "diffHunk": "@@ -26,17 +26,19 @@\n      * Start a new transaction on this stream. This allows events written to the transaction be written an committed atomically.\n      * Note that transactions can only be open for {@link EventWriterConfig#transactionTimeoutTime}.\n      * \n+     * @throws TxnFailedException This exception could be thrown on beginTxn", "originalCommit": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyOTMxNw==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455929317", "bodyText": "Yes Enrico", "author": "ravibeta", "createdAt": "2020-07-16T16:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDY2Nw==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r453274667", "bodyText": "How can a transaction that does not exist can fail?\nMaybe it is fine to have this error here but it deserves a little explanation in javadocs", "author": "eolivelli", "createdAt": "2020-07-12T06:28:42Z", "path": "client/src/main/java/io/pravega/client/stream/TransactionalEventStreamWriter.java", "diffHunk": "@@ -26,17 +26,19 @@\n      * Start a new transaction on this stream. This allows events written to the transaction be written an committed atomically.\n      * Note that transactions can only be open for {@link EventWriterConfig#transactionTimeoutTime}.\n      * \n+     * @throws TxnFailedException This exception could be thrown on beginTxn\n      * @return A transaction through which multiple events can be written atomically.\n      */\n-    Transaction<Type> beginTxn();\n+    Transaction<Type> beginTxn() throws TxnFailedException;", "originalCommit": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkzMTMwMA==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455931300", "bodyText": "Yes Enrico", "author": "ravibeta", "createdAt": "2020-07-16T16:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDc2Ng==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r453274766", "bodyText": "Methods that return a CP should not throw but return a failed CompletableFuture", "author": "eolivelli", "createdAt": "2020-07-12T06:30:01Z", "path": "test/integration/src/main/java/io/pravega/test/integration/selftest/Actor.java", "diffHunk": "@@ -81,10 +82,18 @@ protected void doStart() {\n         notifyStarted();\n         this.runTask = Futures\n                 .delayedFuture(INITIAL_DELAY, this.executorService)\n-                .thenCompose(v -> run());\n+                .thenCompose(v -> runWithException());\n         this.runTask.whenComplete((r, ex) -> stopAsync());\n     }\n \n+    private CompletableFuture<Void> runWithException() {\n+        try {\n+            return run();\n+        } catch (TxnFailedException ex) {\n+            throw new RuntimeException(ex);", "originalCommit": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzg2Nw==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455927867", "bodyText": "Yes Enrico, these comments are outdated.", "author": "ravibeta", "createdAt": "2020-07-16T16:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDgxMg==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r453274812", "bodyText": "The same here", "author": "eolivelli", "createdAt": "2020-07-12T06:30:21Z", "path": "test/integration/src/main/java/io/pravega/test/integration/selftest/Actor.java", "diffHunk": "@@ -119,7 +128,7 @@ protected void doStop() {\n     /**\n      * Executes the role of this Actor.\n      */\n-    protected abstract CompletableFuture<Void> run();\n+    protected abstract CompletableFuture<Void> run() throws TxnFailedException;", "originalCommit": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzc2NQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455927765", "bodyText": "Yes Enrico", "author": "ravibeta", "createdAt": "2020-07-16T16:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDg3NQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r453274875", "bodyText": "return a failed future  here and in other points", "author": "eolivelli", "createdAt": "2020-07-12T06:30:55Z", "path": "test/integration/src/main/java/io/pravega/test/integration/selftest/StreamProducerDataSource.java", "diffHunk": "@@ -258,5 +261,13 @@ private void postStreamDeletion(String name) {\n         this.state.recordDeletedStream(name);\n     }\n \n+    private CompletableFuture<Void> deleteStreamThrowing(String name, Duration timeout) {\n+        try {\n+            return this.store.deleteStream(name, this.config.getTimeout());\n+        } catch (TxnFailedException ex) {\n+            throw new CompletionException(ex);", "originalCommit": "664e756ebd2f79ba9ab3d0cb3815a0061d3713fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzY1NA==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455927654", "bodyText": "Yes Enrico", "author": "ravibeta", "createdAt": "2020-07-16T16:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI3NDg3NQ=="}], "type": "inlineReview"}, {"oid": "22b4ebe8fbee8c92bf0c0dcc72d19780a489b4a8", "url": "https://github.com/pravega/pravega/commit/22b4ebe8fbee8c92bf0c0dcc72d19780a489b4a8", "message": "throws TxnFailedException\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-13T23:29:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNjA5MQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r454016091", "bodyText": "This is a bit confusing. If failing the transaction fails it throws TxnFailedException but this is exactly the opposite of what happened. If the transaction has failed then this should return successfully.", "author": "tkaitchuck", "createdAt": "2020-07-13T23:57:48Z", "path": "client/src/main/java/io/pravega/client/stream/Transaction.java", "diffHunk": "@@ -92,13 +92,16 @@\n \n     /**\n      * Drops the transaction, causing all events written to it to be deleted.\n+     *\n+     * @throws TxnFailedException Error aborting transaction: FAILURE", "originalCommit": "22b4ebe8fbee8c92bf0c0dcc72d19780a489b4a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNzIxOQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r454017219", "bodyText": "I don't think we want this behavior.\nIt seems legitimate to me to do:\ngetTxn(id).checkStatus()\n\nIn this case I would expect the result to return whatever the status was even if it is not OPEN.\nIf the code doesn't work this way. we should open an issue.", "author": "tkaitchuck", "createdAt": "2020-07-14T00:01:27Z", "path": "client/src/main/java/io/pravega/client/stream/TransactionalEventStreamWriter.java", "diffHunk": "@@ -26,17 +26,19 @@\n      * Start a new transaction on this stream. This allows events written to the transaction be written an committed atomically.\n      * Note that transactions can only be open for {@link EventWriterConfig#transactionTimeoutTime}.\n      * \n+     * @throws TxnFailedException The Transaction is no longer in state {@link Transaction.Status#OPEN}\n      * @return A transaction through which multiple events can be written atomically.\n      */\n-    Transaction<Type> beginTxn();\n+    Transaction<Type> beginTxn() throws TxnFailedException;\n \n     /**\n      * Returns a previously created transaction.\n      * \n      * @param transactionId The result retained from calling {@link Transaction#getTxnId()}\n+     * @throws TxnFailedException The Transaction is no longer in state {@link Transaction.Status#OPEN}", "originalCommit": "22b4ebe8fbee8c92bf0c0dcc72d19780a489b4a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNzU0MA==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r454017540", "bodyText": "I think what we really want if for the controller client to dictate the exception type.\nSo instead of converting this, I think we should instead call getThrowingException which will just pass up whatever the underlying error was.", "author": "tkaitchuck", "createdAt": "2020-07-14T00:02:33Z", "path": "client/src/main/java/io/pravega/client/stream/impl/TransactionalEventStreamWriterImpl.java", "diffHunk": "@@ -144,15 +144,15 @@ public void abort() {\n                         log.debug(\"Got exception while writing to transaction on abort: {}\", e.getMessage());\n                     }\n                 }\n-                getAndHandleExceptions(controller.abortTransaction(stream, txId), RuntimeException::new);\n+                getAndHandleExceptions(controller.abortTransaction(stream, txId), TxnFailedException::new);", "originalCommit": "22b4ebe8fbee8c92bf0c0dcc72d19780a489b4a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNzYwNQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r454017605", "bodyText": "Same here", "author": "tkaitchuck", "createdAt": "2020-07-14T00:02:44Z", "path": "client/src/main/java/io/pravega/client/stream/impl/TransactionalEventStreamWriterImpl.java", "diffHunk": "@@ -176,9 +176,9 @@ private void throwIfClosed() throws TxnFailedException {\n     }\n \n     @Override\n-    public Transaction<Type> beginTxn() {\n+    public Transaction<Type> beginTxn() throws TxnFailedException {\n         TxnSegments txnSegments = getAndHandleExceptions(controller.createTransaction(stream, config.getTransactionTimeoutTime()),\n-                RuntimeException::new);\n+                TxnFailedException::new);", "originalCommit": "22b4ebe8fbee8c92bf0c0dcc72d19780a489b4a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNzc4NQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r454017785", "bodyText": "same here", "author": "tkaitchuck", "createdAt": "2020-07-14T00:03:27Z", "path": "client/src/main/java/io/pravega/client/stream/impl/TransactionalEventStreamWriterImpl.java", "diffHunk": "@@ -198,16 +198,16 @@ private void throwIfClosed() throws TxnFailedException {\n     }\n \n     @Override\n-    public Transaction<Type> getTxn(UUID txId) {\n+    public Transaction<Type> getTxn(UUID txId) throws TxnFailedException {\n         // check if the transaction is open.\n-        Status status = getAndHandleExceptions(controller.checkTransactionStatus(stream, txId), RuntimeException::new);\n+        Status status = getAndHandleExceptions(controller.checkTransactionStatus(stream, txId), TxnFailedException::new);", "originalCommit": "22b4ebe8fbee8c92bf0c0dcc72d19780a489b4a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "abda6de53f8603a5cafbc02302666cc0f8f8f857", "url": "https://github.com/pravega/pravega/commit/abda6de53f8603a5cafbc02302666cc0f8f8f857", "message": "fix test\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-14T01:02:06Z", "type": "commit"}, {"oid": "18a2edb23fbee090629552847463aaec92b24a0f", "url": "https://github.com/pravega/pravega/commit/18a2edb23fbee090629552847463aaec92b24a0f", "message": "fix checkstyleMain\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-14T02:15:56Z", "type": "commit"}, {"oid": "55246e44d26633f364c90e9b50e46964acc6edfd", "url": "https://github.com/pravega/pravega/commit/55246e44d26633f364c90e9b50e46964acc6edfd", "message": "no throw from Transaction.checkStatus\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-14T16:53:28Z", "type": "commit"}, {"oid": "b76cf007f27ad91c24dc9a1821dd1a96a5bd31fa", "url": "https://github.com/pravega/pravega/commit/b76cf007f27ad91c24dc9a1821dd1a96a5bd31fa", "message": "Use Futures.getThrowingException instead of Futures.getAndHandleExceptions\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-15T15:22:01Z", "type": "commit"}, {"oid": "4681d7be0b518cf7d41f51d0e48afb60fd6c12ad", "url": "https://github.com/pravega/pravega/commit/4681d7be0b518cf7d41f51d0e48afb60fd6c12ad", "message": "Merge branch 'master' into issue-4940-txnfailedexception", "committedDate": "2020-07-15T16:28:20Z", "type": "commit"}, {"oid": "7c8ee1458493fe05c04b0c60732f48d2c131d8b4", "url": "https://github.com/pravega/pravega/commit/7c8ee1458493fe05c04b0c60732f48d2c131d8b4", "message": "propagate exceptions\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>", "committedDate": "2020-07-15T17:12:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ5Mzk0MQ==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455493941", "bodyText": "Observation : The abort Transaction operations on the controller are idempotent, hence calling an abortTransaction() successively will not throw an error.(TnxFailedException or any other error).\nThe controller client will throw a TxnFailedException if the txn id is not found by the controller during abort().", "author": "shrids", "createdAt": "2020-07-16T03:52:12Z", "path": "client/src/main/java/io/pravega/client/stream/impl/TransactionalEventStreamWriterImpl.java", "diffHunk": "@@ -145,15 +144,15 @@ public void abort() {\n                         log.debug(\"Got exception while writing to transaction on abort: {}\", e.getMessage());\n                     }\n                 }\n-                getAndHandleExceptions(controller.abortTransaction(stream, txId), RuntimeException::new);\n+                Futures.getThrowingException(controller.abortTransaction(stream, txId));", "originalCommit": "7c8ee1458493fe05c04b0c60732f48d2c131d8b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNTUxNg==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455925516", "bodyText": "Yes Sandeep", "author": "ravibeta", "createdAt": "2020-07-16T16:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ5Mzk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ5NDMwOA==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455494308", "bodyText": "checkTransactionStatus will never throw a TxnFailedException ; as I understand the intent here is to remove redundant RuntimeException wrapping.", "author": "shrids", "createdAt": "2020-07-16T03:53:53Z", "path": "client/src/main/java/io/pravega/client/stream/impl/TransactionalEventStreamWriterImpl.java", "diffHunk": "@@ -145,15 +144,15 @@ public void abort() {\n                         log.debug(\"Got exception while writing to transaction on abort: {}\", e.getMessage());\n                     }\n                 }\n-                getAndHandleExceptions(controller.abortTransaction(stream, txId), RuntimeException::new);\n+                Futures.getThrowingException(controller.abortTransaction(stream, txId));\n                 closed.set(true);\n             }\n         }\n \n         @Override\n         public Status checkStatus() {\n             log.info(\"Check transaction status {}\", txId);\n-            return getAndHandleExceptions(controller.checkTransactionStatus(stream, txId), RuntimeException::new);\n+            return Futures.getThrowingException(controller.checkTransactionStatus(stream, txId));", "originalCommit": "7c8ee1458493fe05c04b0c60732f48d2c131d8b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNTIxNw==", "url": "https://github.com/pravega/pravega/pull/4941#discussion_r455925217", "bodyText": "Yes Sandeep", "author": "ravibeta", "createdAt": "2020-07-16T16:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ5NDMwOA=="}], "type": "inlineReview"}]}