{"pr_number": 5368, "pr_title": "Issue 5356 : Make Consumption based retention implicit on Subscriber Stream-Cut publish.", "pr_createdAt": "2020-11-24T11:08:53Z", "pr_url": "https://github.com/pravega/pravega/pull/5368", "timeline": [{"oid": "1eb23da04305974245795ead968849b16b807bed", "url": "https://github.com/pravega/pravega/commit/1eb23da04305974245795ead968849b16b807bed", "message": "first draft\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-24T11:00:34Z", "type": "commit"}, {"oid": "4fabaad3fba2b3907213c2558e3221c90037f5a7", "url": "https://github.com/pravega/pravega/commit/4fabaad3fba2b3907213c2558e3221c90037f5a7", "message": "merge from master\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-24T11:02:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyNTAxNg==", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r529725016", "bodyText": "please dont change the name of the variable otherwise anyone using retention policy in their application would have to recompile their code.", "author": "shiveshr", "createdAt": "2020-11-24T16:48:30Z", "path": "client/src/main/java/io/pravega/client/stream/RetentionPolicy.java", "diffHunk": "@@ -33,18 +32,13 @@\n         /**\n          * Set retention based on the total size of the data in the stream in bytes.\n          */\n-        SIZE,\n-\n-        /**\n-         * Set retention policy based on Consumption.\n-         * Also see: {@link ReaderGroupConfig.StreamDataRetention}\n-         */\n-        CONSUMPTION\n+        SIZE\n     }\n \n     private final RetentionType retentionType;\n-    private final long retentionParam;\n-    private final ConsumptionLimits consumptionLimits;\n+    private final long retentionMin;", "originalCommit": "4fabaad3fba2b3907213c2558e3221c90037f5a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyNTg5NQ==", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r529725895", "bodyText": "in fact to ensure that this change is backward compatible and we dont break the application, perhaps we can simply have a getter with the original name which returns the min.", "author": "shiveshr", "createdAt": "2020-11-24T16:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyNTAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgzMzY5NQ==", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r530833695", "bodyText": "Fixed.", "author": "pbelgundi", "createdAt": "2020-11-26T07:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyNTAxNg=="}], "type": "inlineReview"}, {"oid": "33182bf3bd881b8942132a8db3ca79e2c9e7d90a", "url": "https://github.com/pravega/pravega/commit/33182bf3bd881b8942132a8db3ca79e2c9e7d90a", "message": "code review changes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-26T07:57:33Z", "type": "commit"}, {"oid": "f656e764fc9d1a5f333b391ca50ac264f4bff1ad", "url": "https://github.com/pravega/pravega/commit/f656e764fc9d1a5f333b391ca50ac264f4bff1ad", "message": "changes for bug fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-26T09:01:36Z", "type": "commit"}, {"oid": "d7b05ff0c3d980be864c82fd51efbe6636a6c317", "url": "https://github.com/pravega/pravega/commit/d7b05ff0c3d980be864c82fd51efbe6636a6c317", "message": "spotbugsFix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-26T09:05:03Z", "type": "commit"}, {"oid": "ad2bb1a51649ad4f0e73687c71c08007ba66cf70", "url": "https://github.com/pravega/pravega/commit/ad2bb1a51649ad4f0e73687c71c08007ba66cf70", "message": "bug fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-26T09:55:01Z", "type": "commit"}, {"oid": "b9bc46bc5860ca3f6ce950ddb8ff5bf068927803", "url": "https://github.com/pravega/pravega/commit/b9bc46bc5860ca3f6ce950ddb8ff5bf068927803", "message": "code fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-26T09:59:41Z", "type": "commit"}, {"oid": "fa436b25a0d656e9a7809592a81e4145cec251e7", "url": "https://github.com/pravega/pravega/commit/fa436b25a0d656e9a7809592a81e4145cec251e7", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-26T11:42:59Z", "type": "commit"}, {"oid": "54842e88247f4a2cb09ad9773b60eb936859f3b9", "url": "https://github.com/pravega/pravega/commit/54842e88247f4a2cb09ad9773b60eb936859f3b9", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default", "committedDate": "2020-11-26T11:43:21Z", "type": "commit"}, {"oid": "6970495636cf557ff5359020e7bb490323768f17", "url": "https://github.com/pravega/pravega/commit/6970495636cf557ff5359020e7bb490323768f17", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-26T14:43:29Z", "type": "commit"}, {"oid": "ee0fe6f782970c3780b6e26c94faa546ad1deb57", "url": "https://github.com/pravega/pravega/commit/ee0fe6f782970c3780b6e26c94faa546ad1deb57", "message": "test fixes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-27T06:17:02Z", "type": "commit"}, {"oid": "5beda6c847edd1b1e42c4cfcd00c30cf0e2055ca", "url": "https://github.com/pravega/pravega/commit/5beda6c847edd1b1e42c4cfcd00c30cf0e2055ca", "message": "fix store test\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-27T06:32:05Z", "type": "commit"}, {"oid": "7ec0077201566144038ceba5fe4858af1f4f9328", "url": "https://github.com/pravega/pravega/commit/7ec0077201566144038ceba5fe4858af1f4f9328", "message": "fixed ZkStreamMetadataTasksTest\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-27T07:53:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgzODE5Mw==", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r531838193", "bodyText": "this should also take max and set it. same for size based.", "author": "shiveshr", "createdAt": "2020-11-28T04:11:14Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/ModelHelper.java", "diffHunk": "@@ -67,9 +66,6 @@ public static final StreamConfiguration getCreateStreamConfig(final CreateStream\n                     retentionPolicy = getRetentionPolicy(createStreamRequest.getRetentionPolicy().getTimeBasedRetention(),", "originalCommit": "7ec0077201566144038ceba5fe4858af1f4f9328", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4MjI3Mw==", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r532382273", "bodyText": "Fixed", "author": "pbelgundi", "createdAt": "2020-11-30T07:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgzODE5Mw=="}], "type": "inlineReview"}, {"oid": "4ac6a96c1537341b66a7569a47615ef72c9891b8", "url": "https://github.com/pravega/pravega/commit/4ac6a96c1537341b66a7569a47615ef72c9891b8", "message": "REST API fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-30T06:37:40Z", "type": "commit"}, {"oid": "51d4e1d59f6ab726613655f8617ed9ad4f204c3b", "url": "https://github.com/pravega/pravega/commit/51d4e1d59f6ab726613655f8617ed9ad4f204c3b", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default", "committedDate": "2020-11-30T06:37:59Z", "type": "commit"}, {"oid": "b1d9ddbedc23a273c22aef1eb1dfff71dae048c7", "url": "https://github.com/pravega/pravega/commit/b1d9ddbedc23a273c22aef1eb1dfff71dae048c7", "message": "minor change\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-30T06:57:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzMTQ2Mw==", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r532431463", "bodyText": "shouldnt this check simply be:\ncreateStreamRequest.getRetentionPolicy().getMaxTimeBasedRetention() != null)\n\notherwise this access attempt itself can throw NPE.\nNote: this is json derialization happening here, so the maxTimeBasedRetention will be defaulted to null if its not specified in the json payload.", "author": "shiveshr", "createdAt": "2020-11-30T08:51:17Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/ModelHelper.java", "diffHunk": "@@ -60,15 +59,29 @@ public static final StreamConfiguration getCreateStreamConfig(final CreateStream\n         if (createStreamRequest.getRetentionPolicy() != null) {\n             switch (createStreamRequest.getRetentionPolicy().getType()) {\n                 case LIMITED_SIZE_MB:\n-                    retentionPolicy = RetentionPolicy.bySizeBytes(\n-                            createStreamRequest.getRetentionPolicy().getValue() * 1024 * 1024);\n+                    if (createStreamRequest.getRetentionPolicy().getMaxValue() == 0) {\n+                        // max value is not specified\n+                        retentionPolicy = RetentionPolicy.bySizeBytes(\n+                                createStreamRequest.getRetentionPolicy().getValue() * MB_TO_BYTES);\n+                    } else {\n+                        retentionPolicy = RetentionPolicy.bySizeBytes(\n+                                createStreamRequest.getRetentionPolicy().getValue() * MB_TO_BYTES,\n+                                createStreamRequest.getRetentionPolicy().getMaxValue() * MB_TO_BYTES);\n+                    }\n                     break;\n                 case LIMITED_DAYS:\n-                    retentionPolicy = getRetentionPolicy(createStreamRequest.getRetentionPolicy().getTimeBasedRetention(),\n-                            createStreamRequest.getRetentionPolicy().getValue());\n-                    break;\n-                case CONSUMPTION:\n-                    retentionPolicy = getConsumptionRetentionPolicy(createStreamRequest.getRetentionPolicy().getConsumptionLimits());\n+                    if (createStreamRequest.getRetentionPolicy().getMaxValue() == 0\n+                        && createStreamRequest.getRetentionPolicy().getMaxTimeBasedRetention().getDays() == 0", "originalCommit": "b1d9ddbedc23a273c22aef1eb1dfff71dae048c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ3MjMzNA==", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r532472334", "bodyText": "Fixed & also added tests to cover max Limit validation", "author": "pbelgundi", "createdAt": "2020-11-30T09:57:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzMTQ2Mw=="}], "type": "inlineReview"}, {"oid": "83260a48edc7bec79aeb96cc061458442e99ab43", "url": "https://github.com/pravega/pravega/commit/83260a48edc7bec79aeb96cc061458442e99ab43", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-30T09:54:04Z", "type": "commit"}, {"oid": "cda054510b18dee4b39bff1abb9e613fe4591073", "url": "https://github.com/pravega/pravega/commit/cda054510b18dee4b39bff1abb9e613fe4591073", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default", "committedDate": "2020-11-30T09:54:20Z", "type": "commit"}, {"oid": "a81d66481a4cac13148bce7123022316b1d450ab", "url": "https://github.com/pravega/pravega/commit/a81d66481a4cac13148bce7123022316b1d450ab", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-11-30T11:20:38Z", "type": "commit"}, {"oid": "a81c18f52787237cf379629460f6414c9189374f", "url": "https://github.com/pravega/pravega/commit/a81c18f52787237cf379629460f6414c9189374f", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2020-12-01T04:06:08Z", "type": "commit"}, {"oid": "29c9c557378f8ebff040f2c75329e00700b947ca", "url": "https://github.com/pravega/pravega/commit/29c9c557378f8ebff040f2c75329e00700b947ca", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default", "committedDate": "2020-12-01T04:06:28Z", "type": "commit"}, {"oid": "b4501a6071710516632ac7e008fd4eb90ef1e783", "url": "https://github.com/pravega/pravega/commit/b4501a6071710516632ac7e008fd4eb90ef1e783", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default", "committedDate": "2020-12-01T09:46:15Z", "type": "commit"}]}