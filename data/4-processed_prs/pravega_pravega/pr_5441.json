{"pr_number": 5441, "pr_title": "Issue 5442: Ensure the test case that is running is logged.", "pr_createdAt": "2020-12-18T08:19:30Z", "pr_url": "https://github.com/pravega/pravega/pull/5441", "timeline": [{"oid": "679c9d3df0247e74bad69b364c48092d21a1c65e", "url": "https://github.com/pravega/pravega/commit/679c9d3df0247e74bad69b364c48092d21a1c65e", "message": "Ensure the test case that is running is logged.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-12-18T08:18:42Z", "type": "commit"}, {"oid": "9efbe1e1fcd8d074ceafda91ff67f918c245cb60", "url": "https://github.com/pravega/pravega/commit/9efbe1e1fcd8d074ceafda91ff67f918c245cb60", "message": "Ensure the last 300 lines of logs for the failed test printed on the console.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-12-18T11:36:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODUzOA==", "url": "https://github.com/pravega/pravega/pull/5441#discussion_r546498538", "bodyText": "Shouldn't this be using the logger too?", "author": "ravisharda", "createdAt": "2020-12-21T04:04:18Z", "path": "gradle/java.gradle", "diffHunk": "@@ -96,6 +96,25 @@ plugins.withId('java') {\n         def jvmArgsCopy = jvmArgs\n         jvmArgsCopy.add(\"-XX:MaxDirectMemorySize=4g\")\n         jvmArgs = jvmArgsCopy\n+        def outputCache = new LinkedList<String>()\n+\n+        beforeTest { descriptor ->\n+            logger.lifecycle(\"\\nRunning test: \" + descriptor.getClassName() + \" > \" + descriptor.getDisplayName());\n+            outputCache.clear()\n+        }\n+\n+        onOutput { descriptor, event ->\n+            outputCache.add(event.getMessage())\n+            while (outputCache.size() > 300) outputCache.remove()\n+        }\n+\n+        afterTest { descriptor, result ->\n+            if (result.resultType == TestResult.ResultType.FAILURE && outputCache.size() > 0) {\n+                println()\n+                println(\" Output of ${descriptor.getClassName()}.${descriptor.getDisplayName()}:\")", "originalCommit": "9efbe1e1fcd8d074ceafda91ff67f918c245cb60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5OTcwMg==", "url": "https://github.com/pravega/pravega/pull/5441#discussion_r546499702", "bodyText": "Also, my understanding is that the following lines will already ensure that any exceptions for failed tests are logged. Curious, do we still need these explicit statements here?\n\n  \n    \n      pravega/gradle/java.gradle\n    \n    \n        Lines 89 to 92\n      in\n      9efbe1e\n    \n    \n    \n    \n\n        \n          \n           testLogging.showCauses = true \n        \n\n        \n          \n           testLogging.showExceptions = true \n        \n\n        \n          \n           testLogging.showStackTraces = true \n        \n\n        \n          \n           testLogging.events = [\"PASSED\", \"FAILED\"]", "author": "ravisharda", "createdAt": "2020-12-21T04:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0MDE3Mg==", "url": "https://github.com/pravega/pravega/pull/5441#discussion_r551140172", "bodyText": "Thanks for reviewing the PR @ravisharda\n\nShouldn't this be using the logger too?\n\nUsing a logger at INFO level will enforce all the gradle commands to be use the --info option e.g: ./gradlew build --info. Also at INFO the log output from gradle will clutter the console with other information messages, which is not desireable.\nI do not want to use the logger.lifecycle(...) API since it should be used for progress information messages, ref: https://docs.gradle.org/current/userguide/logging.html\n\nRegarding options testLogging.showCauses, showExceptions...\n\nshowExceptions and showCauses settings are used to log if there are any exceptions during the execution of the test, even though the test is successful. showStackTraces ensures not just the exception but its stacktrace is logged during the run. Hence these options are required.", "author": "shrids", "createdAt": "2021-01-04T06:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg1MDk4Ng==", "url": "https://github.com/pravega/pravega/pull/5441#discussion_r551850986", "bodyText": "On a second look, it looks like the code is trying to log stdout ad stderr for failed tests and failed tests alone. I have to say I don't like the imperative code needed to achieve this and also the fact that each passing test ends up having two lines in the console output.\nShould we log stdout and stderr in all cases, instead?", "author": "ravisharda", "createdAt": "2021-01-05T10:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM2OTg5MQ==", "url": "https://github.com/pravega/pravega/pull/5441#discussion_r552369891", "bodyText": "As discussed, I have impoved the output of the gradle task.\nAlso, since the thread leak detector exits the gradle test worker jvm with exit code 99 there is no way for the gradle daemon to get this information as an event.", "author": "shrids", "createdAt": "2021-01-06T04:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5ODUzOA=="}], "type": "inlineReview"}, {"oid": "a20667a6582e5e5c982f29d6d3f2277f7a76bff8", "url": "https://github.com/pravega/pravega/commit/a20667a6582e5e5c982f29d6d3f2277f7a76bff8", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2020-12-21T04:11:01Z", "type": "commit"}, {"oid": "2815dc33946b7cfbcee2310fb13a54a3c74d3af9", "url": "https://github.com/pravega/pravega/commit/2815dc33946b7cfbcee2310fb13a54a3c74d3af9", "message": "Merge branch 'master' into debug-flakytest\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2021-01-04T06:51:17Z", "type": "forcePushed"}, {"oid": "3990f19bed14b133f4cdfe18b8e42f32deed78e8", "url": "https://github.com/pravega/pravega/commit/3990f19bed14b133f4cdfe18b8e42f32deed78e8", "message": "Issue 5384: Add Controller APIs to Create, Update and Delete Reader Groups (#5400)\n\n* Adds apis to manage readergroup's lifecycle on controller with CRUD apis on readergroup and generation management of readergroup config. \r\n\r\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2021-01-04T06:44:02Z", "type": "forcePushed"}, {"oid": "3d3007c1e80d22c552d796c762aa6137bb8a1d0b", "url": "https://github.com/pravega/pravega/commit/3d3007c1e80d22c552d796c762aa6137bb8a1d0b", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2021-01-04T06:57:00Z", "type": "commit"}, {"oid": "3d3007c1e80d22c552d796c762aa6137bb8a1d0b", "url": "https://github.com/pravega/pravega/commit/3d3007c1e80d22c552d796c762aa6137bb8a1d0b", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2021-01-04T06:57:00Z", "type": "forcePushed"}, {"oid": "31c66b32dd18f5bad01e6a1d67aeae208294da21", "url": "https://github.com/pravega/pravega/commit/31c66b32dd18f5bad01e6a1d67aeae208294da21", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2021-01-06T03:55:48Z", "type": "commit"}, {"oid": "151c85b988e0d6208f218def8aaaaeaf782879a4", "url": "https://github.com/pravega/pravega/commit/151c85b988e0d6208f218def8aaaaeaf782879a4", "message": "Review changes: Improve output.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2021-01-06T04:56:02Z", "type": "commit"}, {"oid": "b64e4a4256114cb3f76038a5c0634423acee329a", "url": "https://github.com/pravega/pravega/commit/b64e4a4256114cb3f76038a5c0634423acee329a", "message": "CR Changes: Remove PASSED output.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2021-01-07T04:17:16Z", "type": "commit"}, {"oid": "1c3a21301b58077bb5be8b95b843006699ad0bda", "url": "https://github.com/pravega/pravega/commit/1c3a21301b58077bb5be8b95b843006699ad0bda", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2021-01-15T04:54:17Z", "type": "commit"}, {"oid": "3c7843fb0da9d21b0b95bbfece2e64b2e5b3882f", "url": "https://github.com/pravega/pravega/commit/3c7843fb0da9d21b0b95bbfece2e64b2e5b3882f", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2021-01-19T06:41:29Z", "type": "commit"}, {"oid": "64a2c3fddee83d3fe01ecdb289b0c234d0a5505e", "url": "https://github.com/pravega/pravega/commit/64a2c3fddee83d3fe01ecdb289b0c234d0a5505e", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2021-01-22T08:20:39Z", "type": "commit"}, {"oid": "45ad391ac24ddc220987d410609a666970614895", "url": "https://github.com/pravega/pravega/commit/45ad391ac24ddc220987d410609a666970614895", "message": "Merge branch 'master' into debug-flakytest", "committedDate": "2021-01-25T00:15:03Z", "type": "commit"}]}