{"pr_number": 5858, "pr_title": "GEODE-8795: Lucene queries should utilize post-processing if enabled", "pr_createdAt": "2020-12-16T21:04:14Z", "pr_url": "https://github.com/apache/geode/pull/5858", "timeline": [{"oid": "b9c6adbc4009df6e66f491727331dedf83e39246", "url": "https://github.com/apache/geode/commit/b9c6adbc4009df6e66f491727331dedf83e39246", "message": "GEM-3111: Initial attempt at the fix.", "committedDate": "2020-12-16T14:09:33Z", "type": "commit"}, {"oid": "28b988d39b048ef05524ae4d815dec4856d3c44e", "url": "https://github.com/apache/geode/commit/28b988d39b048ef05524ae4d815dec4856d3c44e", "message": "Some adjustments to the initial implementation\n\n- This now relies on the principal being available in the\n  FunctionContext.\n- PDX objects are passed directly to the post-processor thus avoiding\n  any possible serialization issues.", "committedDate": "2020-12-16T19:58:48Z", "type": "commit"}, {"oid": "f8f23bc72f33e4b5a0f87c4cc99b56f09829e5c9", "url": "https://github.com/apache/geode/commit/f8f23bc72f33e4b5a0f87c4cc99b56f09829e5c9", "message": "Fix failing test", "committedDate": "2020-12-16T23:13:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUyMTQ5NQ==", "url": "https://github.com/apache/geode/pull/5858#discussion_r551521495", "bodyText": "I'm a little concerned that value here might be a CachedDeserializable in some cases. I think this whole function and PageEntry class are designed to try to pass the value back to the user without deserializing it if it can.\nHowever I can't think of a case that you didn't test already, so I guess it's doing the right thing.", "author": "upthewaterspout", "createdAt": "2021-01-04T19:30:43Z", "path": "geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/results/LuceneGetPageFunction.java", "diffHunk": "@@ -65,15 +70,19 @@ public void execute(FunctionContext context) {\n     }\n   }\n \n-  protected PageEntry getEntry(final Region region, final Object key) {\n+  protected PageEntry getEntry(final Region region, final Object key,\n+      SecurityService securityService, Object principal) {\n     final EntrySnapshot entry = (EntrySnapshot) region.getEntry(key);\n     if (entry == null) {\n       return null;\n     }\n \n-    final Object value = entry.getRegionEntry().getValue(null);\n+    Object value = entry.getRegionEntry().getValue(null);\n     if (value == null || Token.isInvalidOrRemoved(value)) {\n       return null;\n+    } else if (securityService.needPostProcess()) {\n+      value = securityService.postProcess(principal, region.getFullPath(), key, entry.getValue(),", "originalCommit": "f8f23bc72f33e4b5a0f87c4cc99b56f09829e5c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}