{"pr_number": 4843, "pr_title": "GEODE-7900: Only set the SNI hostname if it is not present", "pr_createdAt": "2020-03-23T23:24:59Z", "pr_url": "https://github.com/apache/geode/pull/4843", "timeline": [{"oid": "8960030c0e1f0bae6f8db3e78e0be2c0892bb1aa", "url": "https://github.com/apache/geode/commit/8960030c0e1f0bae6f8db3e78e0be2c0892bb1aa", "message": "GEODE-7900: Only set the SNI hostname if it is not present\n\nIt turns out the JDK sometimes automatically sets the SNI hostname and\nsometimes does not.  With openjdk 8, it only sets SNI hostname if there is a\ndot in the hostname. See sun.security.ssl.Utilities#addToSNIServerNameList\n\nFor this reason, we need to only set the SNI hostname if the JDK did not.\nOtherwise it will complain that there is a `Duplicated server name of type 0`", "committedDate": "2020-03-23T22:43:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI4OTc1OQ==", "url": "https://github.com/apache/geode/pull/4843#discussion_r397289759", "bodyText": "Two things:\n\na nit: the allocation can be moved after the conditional :)\nis the type check sufficient or is a content check necessary?\n\non (2) I wonder if there is a scenario where SNI might be set already, but maybe it disagrees with addr.getHostName()", "author": "Bill", "createdAt": "2020-03-24T16:27:23Z", "path": "geode-core/src/main/java/org/apache/geode/internal/net/SocketCreator.java", "diffHunk": "@@ -774,6 +775,14 @@ private void setServerNames(SSLParameters modifiedParams, HostAndPort addr) {\n     List<SNIServerName> oldNames = modifiedParams.getServerNames();\n     oldNames = oldNames == null ? Collections.emptyList() : oldNames;\n     final List<SNIServerName> serverNames = new ArrayList<>(oldNames);\n+\n+    if (serverNames.stream()\n+        .mapToInt(SNIServerName::getType)\n+        .anyMatch(type -> type == StandardConstants.SNI_HOST_NAME)) {\n+      // we already have a SNI hostname set. Do nothing.\n+      return;\n+    }\n+", "originalCommit": "8960030c0e1f0bae6f8db3e78e0be2c0892bb1aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMxMjA5Ng==", "url": "https://github.com/apache/geode/pull/4843#discussion_r397312096", "bodyText": "For (2) - it certainly could disagree since the JDK is setting it to whatever it wants ... But the JDK also only allows one SNI name of a given type. So I guess we just need to decide what the behavior is that we want. I thought it would best to leave the JDK setting in place.", "author": "upthewaterspout", "createdAt": "2020-03-24T16:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI4OTc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMyMjgwNQ==", "url": "https://github.com/apache/geode/pull/4843#discussion_r397322805", "bodyText": "Maybe we could unconditionally delete whatever is there and replace it with our own content?", "author": "Bill", "createdAt": "2020-03-24T17:11:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI4OTc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1MjMyOA==", "url": "https://github.com/apache/geode/pull/4843#discussion_r397352328", "bodyText": "Having looked at the path into this method, it's clear that this framework owns this socket and the only way it can set set will cause it to have the value we expect so I'm ok w/ this code as-is. Thanks for playing!", "author": "Bill", "createdAt": "2020-03-24T17:55:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI4OTc1OQ=="}], "type": "inlineReview"}]}