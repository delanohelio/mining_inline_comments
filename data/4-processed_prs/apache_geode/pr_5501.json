{"pr_number": 5501, "pr_title": "GEODE-8339: Redis Rename hangs when servers are killed and revived", "pr_createdAt": "2020-09-09T21:51:56Z", "pr_url": "https://github.com/apache/geode/pull/5501", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1MDcyNg==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486450726", "bodyText": "My understanding is that we no longer use this new \"tryLock\" parameter. So should we remove it from this method so that this PR does not change this code?", "author": "dschneider-pivotal", "createdAt": "2020-09-10T15:50:13Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/PartitionedRegion.java", "diffHunk": "@@ -611,7 +611,8 @@ PartitionedRegionRedundancyTracker getRedundancyTracker() {\n     return redundancyTracker;\n   }\n \n-  public void computeWithPrimaryLocked(Object key, Runnable r) throws PrimaryBucketLockException {\n+  public boolean computeWithPrimaryLocked(Object key, Runnable r, boolean tryLock)", "originalCommit": "07efdbab2667d668fffd92c0050eccad5b2f04ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ2MzgwMA==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486463800", "bodyText": "You are correct, Darrel, we no longer need it.  Jens and I talked about it a bit this. morning and thought it might be beneficial to have the option in the method, but since it's not needed for this PR it makes sense to remove it.", "author": "sabbey37", "createdAt": "2020-09-10T16:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1MDcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1MzkxNQ==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486453915", "bodyText": "I think the \"while (true)\" loop should be removed. I think it is a remnant of the tryLock code. As it is now I don't see that it would ever loop.", "author": "dschneider-pivotal", "createdAt": "2020-09-10T15:54:50Z", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/key/RedisKeyCommandsFunctionInvoker.java", "diffHunk": "@@ -74,18 +73,18 @@ public String type(ByteArrayWrapper key) {\n \n \n   @Override\n-  @SuppressWarnings(\"unchecked\")\n   public boolean rename(ByteArrayWrapper oldKey, ByteArrayWrapper newKey) {\n+    while (true) {", "originalCommit": "07efdbab2667d668fffd92c0050eccad5b2f04ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ2NjY1MQ==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486466651", "bodyText": "Truth, Darrel. Just removed it!", "author": "sabbey37", "createdAt": "2020-09-10T16:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1MzkxNQ=="}], "type": "inlineReview"}, {"oid": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "url": "https://github.com/apache/geode/commit/4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "message": "GEODE-8339: Rename hangs when servers are killed and revived", "committedDate": "2020-09-10T16:38:31Z", "type": "commit"}, {"oid": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "url": "https://github.com/apache/geode/commit/4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "message": "GEODE-8339: Rename hangs when servers are killed and revived", "committedDate": "2020-09-10T16:38:31Z", "type": "forcePushed"}, {"oid": "b35929c10f74e74b39b48e1ca8b4a8b6f2276aa6", "url": "https://github.com/apache/geode/commit/b35929c10f74e74b39b48e1ca8b4a8b6f2276aa6", "message": "spA", "committedDate": "2020-09-10T16:50:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MDUxOQ==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486490519", "bodyText": "this should no longer return boolean (since we got rid of the tryLock option)", "author": "dschneider-pivotal", "createdAt": "2020-09-10T16:50:08Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/PartitionedRegion.java", "diffHunk": "@@ -611,7 +611,8 @@ PartitionedRegionRedundancyTracker getRedundancyTracker() {\n     return redundancyTracker;\n   }\n \n-  public void computeWithPrimaryLocked(Object key, Runnable r) throws PrimaryBucketLockException {\n+  public boolean computeWithPrimaryLocked(Object key, Runnable r)", "originalCommit": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNDU1OQ==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486504559", "bodyText": "Good call, just updated it!", "author": "sabbey37", "createdAt": "2020-09-10T17:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MDUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MTA3Nw==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486491077", "bodyText": "remove the \"if\" and just call br.doLockForPrimary(false);", "author": "dschneider-pivotal", "createdAt": "2020-09-10T16:51:05Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/PartitionedRegion.java", "diffHunk": "@@ -622,7 +623,9 @@ public void computeWithPrimaryLocked(Object key, Runnable r) throws PrimaryBucke\n     }\n \n     try {\n-      br.doLockForPrimary(false);\n+      if (!br.doLockForPrimary(false)) {", "originalCommit": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNDgyNw==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486504827", "bodyText": "just updated it!", "author": "sabbey37", "createdAt": "2020-09-10T17:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MTA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MTY2OA==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486491668", "bodyText": "this javadoc needs to be updated for the signature with no boolean", "author": "dschneider-pivotal", "createdAt": "2020-09-10T16:52:07Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/PrimaryBucketLockException.java", "diffHunk": "@@ -19,7 +19,7 @@\n import org.apache.geode.GemFireException;\n \n /**\n- * Thrown by {@link PartitionedRegion#computeWithPrimaryLocked(Object, Runnable)}\n+ * Thrown by {@link PartitionedRegion#computeWithPrimaryLocked(Object, Runnable, boolean)}", "originalCommit": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNDk2Ng==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486504966", "bodyText": "Truth. Thanks, Darrel!", "author": "sabbey37", "createdAt": "2020-09-10T17:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MTY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MjExOA==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486492118", "bodyText": "take out this new blank line", "author": "dschneider-pivotal", "createdAt": "2020-09-10T16:52:56Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/PartitionedRegion.java", "diffHunk": "@@ -3395,11 +3399,10 @@ private InternalDistributedMember getNodeForBucketReadOrLoad(int bucketId) {\n    * @throws PrimaryBucketException if the remote bucket was not the primary\n    * @throws ForceReattemptException if the peer is no longer available\n    */\n+", "originalCommit": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNTA1MA==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486505050", "bodyText": "updated.", "author": "sabbey37", "createdAt": "2020-09-10T17:14:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MjExOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MjU0NA==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486492544", "bodyText": "restore this comment; basically get this PR to the point that it does not modify PartitionedRegion.java", "author": "dschneider-pivotal", "createdAt": "2020-09-10T16:53:34Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/PartitionedRegion.java", "diffHunk": "@@ -3395,11 +3399,10 @@ private InternalDistributedMember getNodeForBucketReadOrLoad(int bucketId) {\n    * @throws PrimaryBucketException if the remote bucket was not the primary\n    * @throws ForceReattemptException if the peer is no longer available\n    */\n+\n   public boolean putRemotely(final DistributedMember recipient, final EntryEventImpl event,\n       boolean ifNew, boolean ifOld, Object expectedOldValue, boolean requireOldValue)\n       throws PrimaryBucketException, ForceReattemptException {\n-    // boolean forceAck = basicGetWriter() != null\n-    // || getDistributionAdvisor().adviseNetWrite().size() > 0;", "originalCommit": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNTExMQ==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486505111", "bodyText": "updated", "author": "sabbey37", "createdAt": "2020-09-10T17:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MjU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5Mjg5OQ==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486492899", "bodyText": "put this blank line back so that this PR does not modify LocalRegion.java", "author": "dschneider-pivotal", "createdAt": "2020-09-10T16:54:06Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/LocalRegion.java", "diffHunk": "@@ -5718,7 +5718,6 @@ RegionEntry basicPutEntry(final EntryEventImpl event, final long lastModified)\n   @Override\n   public long basicPutPart2(EntryEventImpl event, RegionEntry entry, boolean isInitialized,\n       long lastModified, boolean clearConflict) {\n-", "originalCommit": "4712d03186afc5909efaa15c0d1d7fb1ed533a3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNTIwMQ==", "url": "https://github.com/apache/geode/pull/5501#discussion_r486505201", "bodyText": "updated.", "author": "sabbey37", "createdAt": "2020-09-10T17:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5Mjg5OQ=="}], "type": "inlineReview"}, {"oid": "bcb2bd9f85dd60fec2745ef295dd536e5f2e1707", "url": "https://github.com/apache/geode/commit/bcb2bd9f85dd60fec2745ef295dd536e5f2e1707", "message": "PR review changes", "committedDate": "2020-09-10T17:07:00Z", "type": "commit"}, {"oid": "bf6058f66624fe34e1a1d99ce6e578727b872f6b", "url": "https://github.com/apache/geode/commit/bf6058f66624fe34e1a1d99ce6e578727b872f6b", "message": "Reverting some weird formatting changes", "committedDate": "2020-09-10T17:12:56Z", "type": "commit"}]}