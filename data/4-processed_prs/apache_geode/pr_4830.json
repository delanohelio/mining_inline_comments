{"pr_number": 4830, "pr_title": "GEODE-7852: Adding a SocketFactory configuration for client Pools", "pr_createdAt": "2020-03-19T18:34:48Z", "pr_url": "https://github.com/apache/geode/pull/4830", "timeline": [{"oid": "aca81f46e588a5c92d2fb54b85669febd7863626", "url": "https://github.com/apache/geode/commit/aca81f46e588a5c92d2fb54b85669febd7863626", "message": "GEODE-7852: Adding a SocketFactory configuration for client Pools\n\nAdding the ability to provide a SocketFactory to a client pool for use in\ncreating sockets. Adding an implementation of this SocketFactory that\nconfigures the pool to use an SNI proxy.", "committedDate": "2020-03-19T18:32:53Z", "type": "commit"}, {"oid": "44783d9b843f0c60debeb4d3adeede1add9e79a1", "url": "https://github.com/apache/geode/commit/44783d9b843f0c60debeb4d3adeede1add9e79a1", "message": "GEODE-7837: SNI proxy automated test\n\nAdding an automated test of the SniSocketFactory", "committedDate": "2020-03-19T18:37:49Z", "type": "commit"}, {"oid": "44783d9b843f0c60debeb4d3adeede1add9e79a1", "url": "https://github.com/apache/geode/commit/44783d9b843f0c60debeb4d3adeede1add9e79a1", "message": "GEODE-7837: SNI proxy automated test\n\nAdding an automated test of the SniSocketFactory", "committedDate": "2020-03-19T18:37:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0NTU0MQ==", "url": "https://github.com/apache/geode/pull/4830#discussion_r395245541", "bodyText": "Delete commented code.", "author": "pivotal-jbarrett", "createdAt": "2020-03-19T18:46:43Z", "path": "geode-assembly/src/acceptanceTest/resources/org/apache/geode/client/docker-compose.yml", "diffHunk": "@@ -0,0 +1,48 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+version: '3'\n+services:\n+  geode:\n+    container_name: 'geode'\n+    image: 'geode:develop'\n+    expose:\n+      - '10334'\n+      - '40404'\n+#   entrypoint: gfsh", "originalCommit": "44783d9b843f0c60debeb4d3adeede1add9e79a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0NzA2Mg==", "url": "https://github.com/apache/geode/pull/4830#discussion_r395247062", "bodyText": "Please don't leave raw type warnings. Use proper generic types or suppress warnings if generics can't work here.\npublic static class TestFunction implements Function<Void> ... {\n...\npublic void execute<FunctionContext<Void> context);\n}", "author": "pivotal-jbarrett", "createdAt": "2020-03-19T18:49:23Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/client/SocketFactoryDUnitTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.cache.client;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.DataInput;\n+import java.io.DataOutput;\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Socket;\n+import java.net.SocketAddress;\n+import java.util.Arrays;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.DataSerializable;\n+import org.apache.geode.cache.execute.Function;\n+import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n+\n+public class SocketFactoryDUnitTest {\n+\n+  @Rule\n+  public ClusterStartupRule cluster = new ClusterStartupRule();\n+  private int locatorPort;\n+  private int serverPort;\n+\n+  @Before\n+  public void createCluster() {\n+    locatorPort = cluster.startLocatorVM(0).getPort();\n+    serverPort = cluster.startServerVM(1, locatorPort).getPort();\n+  }\n+\n+  @Test\n+  public void customSocketFactoryUsedForLocators() throws IOException {\n+    ClientCache client = new ClientCacheFactory()\n+        // Add a locator with the wrong hostname\n+        .addPoolLocator(\"notarealhostname\", locatorPort)\n+        // Set a socket factory that switches the hostname back\n+        .setPoolSocketFactory(new ChangeHostSocketFactory(\"localhost\"))\n+        .create();\n+\n+    // Verify the socket factory switched the hostname so we can connect\n+    verifyConnection(client);\n+  }\n+\n+  @Test\n+  public void customSocketFactoryUsedForServers() {\n+    ClientCache client = new ClientCacheFactory()\n+        // Add a locator with the wrong hostname\n+        .addPoolServer(\"notarealhostname\", serverPort)\n+        // Set a socket factory that switches the hostname back\n+        .setPoolSocketFactory(new ChangeHostSocketFactory(\"localhost\"))\n+        .create();\n+\n+\n+    // Verify the socket factory switched the hostname so we can connect\n+    verifyConnection(client);\n+  }\n+\n+  private void verifyConnection(ClientCache client) {\n+    // Verify connectivity with servers\n+    Object functionResult =\n+        FunctionService.onServers(client).execute(new TestFunction()).getResult();\n+\n+    assertThat(functionResult).isEqualTo(Arrays.asList(\"test\"));\n+  }\n+\n+\n+  public static class TestFunction implements Function, DataSerializable {", "originalCommit": "44783d9b843f0c60debeb4d3adeede1add9e79a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0NzU2Mw==", "url": "https://github.com/apache/geode/pull/4830#discussion_r395247563", "bodyText": "Cleanup rawtype warnings.", "author": "pivotal-jbarrett", "createdAt": "2020-03-19T18:50:17Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/client/SocketFactoryDUnitTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.cache.client;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.DataInput;\n+import java.io.DataOutput;\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.Socket;\n+import java.net.SocketAddress;\n+import java.util.Arrays;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.DataSerializable;\n+import org.apache.geode.cache.execute.Function;\n+import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.test.dunit.rules.ClusterStartupRule;\n+\n+public class SocketFactoryDUnitTest {\n+\n+  @Rule\n+  public ClusterStartupRule cluster = new ClusterStartupRule();\n+  private int locatorPort;\n+  private int serverPort;\n+\n+  @Before\n+  public void createCluster() {\n+    locatorPort = cluster.startLocatorVM(0).getPort();\n+    serverPort = cluster.startServerVM(1, locatorPort).getPort();\n+  }\n+\n+  @Test\n+  public void customSocketFactoryUsedForLocators() throws IOException {\n+    ClientCache client = new ClientCacheFactory()\n+        // Add a locator with the wrong hostname\n+        .addPoolLocator(\"notarealhostname\", locatorPort)\n+        // Set a socket factory that switches the hostname back\n+        .setPoolSocketFactory(new ChangeHostSocketFactory(\"localhost\"))\n+        .create();\n+\n+    // Verify the socket factory switched the hostname so we can connect\n+    verifyConnection(client);\n+  }\n+\n+  @Test\n+  public void customSocketFactoryUsedForServers() {\n+    ClientCache client = new ClientCacheFactory()\n+        // Add a locator with the wrong hostname\n+        .addPoolServer(\"notarealhostname\", serverPort)\n+        // Set a socket factory that switches the hostname back\n+        .setPoolSocketFactory(new ChangeHostSocketFactory(\"localhost\"))\n+        .create();\n+\n+\n+    // Verify the socket factory switched the hostname so we can connect\n+    verifyConnection(client);\n+  }\n+\n+  private void verifyConnection(ClientCache client) {\n+    // Verify connectivity with servers\n+    Object functionResult =\n+        FunctionService.onServers(client).execute(new TestFunction()).getResult();", "originalCommit": "44783d9b843f0c60debeb4d3adeede1add9e79a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3OTkzNg==", "url": "https://github.com/apache/geode/pull/4830#discussion_r395379936", "bodyText": "Done.", "author": "upthewaterspout", "createdAt": "2020-03-19T23:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI0NzU2Mw=="}], "type": "inlineReview"}, {"oid": "f6d00653cc964de5924d43dace07b5374e482977", "url": "https://github.com/apache/geode/commit/f6d00653cc964de5924d43dace07b5374e482977", "message": "Splitting up the keystores in the acceptance test\n\nUsing a different keystore for each process so that they present the correct\nkey to the client", "committedDate": "2020-03-19T18:59:56Z", "type": "commit"}, {"oid": "7702054ccf99a67b027c41b57046d5b71891bbfe", "url": "https://github.com/apache/geode/commit/7702054ccf99a67b027c41b57046d5b71891bbfe", "message": "Removing raw type warnings from SocketFactoryDUnitTest", "committedDate": "2020-03-19T22:47:12Z", "type": "commit"}, {"oid": "c110aed42d3c8b3ecd3c0717f33f88f9e8e963a6", "url": "https://github.com/apache/geode/commit/c110aed42d3c8b3ecd3c0717f33f88f9e8e963a6", "message": "Using a ephemeral port for the haproxy in ClientSNIAcceptanceTest\n\nRemoving the use of a fixed port in this test, so that the test will not fail\nif the port is already bound.", "committedDate": "2020-03-19T22:47:31Z", "type": "commit"}, {"oid": "bc3aa61d5736456c9c80a39f3c56b2f875710436", "url": "https://github.com/apache/geode/commit/bc3aa61d5736456c9c80a39f3c56b2f875710436", "message": "Removing unused client keystore file from ClientSNIAcceptanceTest", "committedDate": "2020-03-19T23:46:27Z", "type": "commit"}, {"oid": "1ffc0c815787dc6f69ebba6591f519a47d5ad1ef", "url": "https://github.com/apache/geode/commit/1ffc0c815787dc6f69ebba6591f519a47d5ad1ef", "message": "Missed one block of commented out code in haproxy.cfg\n\nRemoving the last bit of commented out code.", "committedDate": "2020-03-20T15:39:06Z", "type": "commit"}, {"oid": "a18430f308c1dc8c5aad430a1460d3d907bcdfce", "url": "https://github.com/apache/geode/commit/a18430f308c1dc8c5aad430a1460d3d907bcdfce", "message": "adding FunctionInterface, final field\n\nFixing some minor review comments\n - Adding @FunctionInterface to the SocketFactory\n - adding a missing *final* to a field", "committedDate": "2020-03-20T19:11:39Z", "type": "commit"}]}