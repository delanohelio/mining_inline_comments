{"pr_number": 4845, "pr_title": "GEODE-7902: fix flaky test", "pr_createdAt": "2020-03-24T21:58:59Z", "pr_url": "https://github.com/apache/geode/pull/4845", "timeline": [{"oid": "3bfb95c562d82fb676fa9482701ad5c3628f0b33", "url": "https://github.com/apache/geode/commit/3bfb95c562d82fb676fa9482701ad5c3628f0b33", "message": "GEODE-7902: fix flaky test", "committedDate": "2020-03-24T21:58:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwOTM3Mg==", "url": "https://github.com/apache/geode/pull/4845#discussion_r397509372", "bodyText": "What is the sleep waiting for? What does \"settle\" mean? Seems like whatever it means couldn't we then do a file system await to figure out if the file has settled?", "author": "dschneider-pivotal", "createdAt": "2020-03-24T22:52:15Z", "path": "geode-assembly/src/distributedTest/java/org/apache/geode/management/internal/rest/DeploymentManagementRedployDUnitTest.java", "diffHunk": "@@ -134,14 +135,16 @@ public void redeployJarsWithNewVersionsOfFunctionsAndMultipleLocators() {\n     server.invoke(() -> assertThatCanLoad(JAR_NAME_A, FUNCTION_A));\n     server.invoke(() -> assertThatFunctionHasVersion(FUNCTION_A, VERSION1));\n \n-\n     deployment.setFile(jarAVersion2);\n     assertManagementResult(client.create(deployment)).isSuccessful();\n     server.invoke(() -> assertThatCanLoad(JAR_NAME_A, FUNCTION_A));\n     server.invoke(() -> assertThatFunctionHasVersion(FUNCTION_A, VERSION2));\n \n     server.stop(false);\n \n+    // GEODE-7902: wait for a while for new jars to settle in the file system", "originalCommit": "3bfb95c562d82fb676fa9482701ad5c3628f0b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMjA2MQ==", "url": "https://github.com/apache/geode/pull/4845#discussion_r397512061", "bodyText": "Would an awaitUntilAsserted() around the final assertion (or the final two) suffice, or is it necessary to wait (for whatever the condition is) before doing the restart?\nIf awaitUntilAsserted() works, that's a much more robust fix than a fixed-duration sleep.", "author": "demery-pivotal", "createdAt": "2020-03-24T22:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwOTM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxMzI1MA==", "url": "https://github.com/apache/geode/pull/4845#discussion_r397513250", "bodyText": "I believe the wait has to be before the server restarts to get the new version of jars from one of the locators.", "author": "jinmeiliao", "createdAt": "2020-03-24T23:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwOTM3Mg=="}], "type": "inlineReview"}, {"oid": "cbca53231453c4ab25cf30433d235359787119d6", "url": "https://github.com/apache/geode/commit/cbca53231453c4ab25cf30433d235359787119d6", "message": "* wait for a second before downloading from the locator if the file is modified within the last second.\n\n* unify the file copy operation", "committedDate": "2020-03-26T02:28:04Z", "type": "forcePushed"}, {"oid": "13d39c0e7d87f219510ccf72af05a3bb822fec2c", "url": "https://github.com/apache/geode/commit/13d39c0e7d87f219510ccf72af05a3bb822fec2c", "message": "* wait for a second before downloading from the locator if the file is modified within the last second.\n\n* unify the file copy operation", "committedDate": "2020-03-26T02:44:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4NjI5OQ==", "url": "https://github.com/apache/geode/pull/4845#discussion_r398586299", "bodyText": "This should be replaced with an await so we don't get stuck here forever.", "author": "pivotal-jbarrett", "createdAt": "2020-03-26T13:49:48Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/configuration/functions/DownloadJarFunction.java", "diffHunk": "@@ -61,6 +61,13 @@ public void execute(FunctionContext<Object[]> context) {\n         RemoteInputStreamServer istream = null;\n         try {\n           File jarFile = sharedConfig.getPathToJarOnThisLocator(group, jarName).toFile();\n+          // if file is modified within the last second, wait for a second before downloading it\n+          // It looks like if the file was modified within the same second, the file downloaded\n+          // will be the old content. On mac/linux, the lastModified time of the file is already\n+          // reported to the precision of seconds.\n+          if (jarFile.lastModified() > System.currentTimeMillis() - 1000) {", "originalCommit": "13d39c0e7d87f219510ccf72af05a3bb822fec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2Njc0Nw==", "url": "https://github.com/apache/geode/pull/4845#discussion_r398666747", "bodyText": "I tried that but await isn't available in core.", "author": "jinmeiliao", "createdAt": "2020-03-26T15:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4NjI5OQ=="}], "type": "inlineReview"}, {"oid": "49d7470f5c44f36d43c94798539ecbde410dcac9", "url": "https://github.com/apache/geode/commit/49d7470f5c44f36d43c94798539ecbde410dcac9", "message": "* wait for a second before downloading from the locator if the file is modified within the last second.\n\n* unify the file copy operation", "committedDate": "2020-03-26T17:19:32Z", "type": "commit"}, {"oid": "49d7470f5c44f36d43c94798539ecbde410dcac9", "url": "https://github.com/apache/geode/commit/49d7470f5c44f36d43c94798539ecbde410dcac9", "message": "* wait for a second before downloading from the locator if the file is modified within the last second.\n\n* unify the file copy operation", "committedDate": "2020-03-26T17:19:32Z", "type": "forcePushed"}]}