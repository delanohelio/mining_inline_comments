{"pr_number": 5525, "pr_title": "GEODE-8506: BufferPool returns byte buffers that may be much larger t\u2026", "pr_createdAt": "2020-09-17T23:10:17Z", "pr_url": "https://github.com/apache/geode/pull/5525", "timeline": [{"oid": "b7ba3ff69fc36743f479b103232f6144e4dd2c25", "url": "https://github.com/apache/geode/commit/b7ba3ff69fc36743f479b103232f6144e4dd2c25", "message": "GEODE-8506: BufferPool returns byte buffers that may be much larger than requested\n\nCreate a \"slice\" of the acquired buffer to return to the caller instead\nof returning a buffer larger than what was requested.  On return we fish\nout the parent buffer and put it back in the pool.", "committedDate": "2020-09-17T23:05:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNjg0OA==", "url": "https://github.com/apache/geode/pull/5525#discussion_r490616848", "bodyText": "\ud83d\udc4d", "author": "echobravopapa", "createdAt": "2020-09-17T23:29:55Z", "path": "geode-core/src/main/java/org/apache/geode/internal/net/BufferPool.java", "diffHunk": "@@ -98,14 +101,18 @@ private ByteBuffer acquireDirectBuffer(int size, boolean send) {\n \n     if (useDirectBuffers) {\n       if (size <= MEDIUM_BUFFER_SIZE) {\n-        return acquirePredefinedFixedBuffer(send, size);\n+        result = acquirePredefinedFixedBuffer(send, size);\n       } else {\n-        return acquireLargeBuffer(send, size);\n+        result = acquireLargeBuffer(send, size);\n       }\n-    } else {\n-      // if we are using heap buffers then don't bother with keeping them around\n-      result = ByteBuffer.allocate(size);\n+      if (result.capacity() > size) {\n+        result.position(0).limit(size);\n+        result = result.slice();", "originalCommit": "b7ba3ff69fc36743f479b103232f6144e4dd2c25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0ODExOA==", "url": "https://github.com/apache/geode/pull/5525#discussion_r490648118", "bodyText": "These should be called something like smallBuffer and largerBuffer or something, based on this comment.", "author": "Bill", "createdAt": "2020-09-18T01:26:01Z", "path": "geode-core/src/test/java/org/apache/geode/internal/net/BufferPoolTest.java", "diffHunk": "@@ -133,27 +135,42 @@ public void checkBufferSizeAfterAllocation() throws Exception {\n \n   @Test\n   public void checkBufferSizeAfterAcquire() throws Exception {\n+    // allocate a small buffer and a larger buffer. Check their sizes, etc and then\n+    // release and reacquire them. They should be from separate buffer pools so there\n+    // should still be a small buffer and a larger buffer.", "originalCommit": "b7ba3ff69fc36743f479b103232f6144e4dd2c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2NTU4MQ==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491065581", "bodyText": "I'm retracting that comment since these variable names existed before this PR.\nAny such changes should be pursued in connection with a refactoring ticket.", "author": "Bill", "createdAt": "2020-09-18T16:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0ODExOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0OTUzMQ==", "url": "https://github.com/apache/geode/pull/5525#discussion_r490649531", "bodyText": "This test would make more sense if I knew where this magic number, 4096, came from. Recommend either referencing the pertinent constant directly or at least including a comment here.\nSame comment for 32768 on next line\u2026", "author": "Bill", "createdAt": "2020-09-18T01:31:13Z", "path": "geode-core/src/test/java/org/apache/geode/internal/net/BufferPoolTest.java", "diffHunk": "@@ -133,27 +135,42 @@ public void checkBufferSizeAfterAllocation() throws Exception {\n \n   @Test\n   public void checkBufferSizeAfterAcquire() throws Exception {\n+    // allocate a small buffer and a larger buffer. Check their sizes, etc and then\n+    // release and reacquire them. They should be from separate buffer pools so there\n+    // should still be a small buffer and a larger buffer.\n     ByteBuffer buffer = bufferPool.acquireDirectReceiveBuffer(100);\n \n     ByteBuffer newBuffer =\n         bufferPool.acquireDirectReceiveBuffer(10000);\n-    assertThat(buffer.capacity()).isGreaterThanOrEqualTo(4096);\n-    assertThat(newBuffer.capacity()).isGreaterThanOrEqualTo(32768);\n+    assertThat(buffer.capacity()).isEqualTo(100);\n+    assertThat(newBuffer.capacity()).isEqualTo(10000);\n+    assertThat(buffer.isDirect()).isTrue();\n+    assertThat(newBuffer.isDirect()).isTrue();\n+    assertThat(bufferPool.getPoolableBuffer(buffer).capacity())\n+        .isGreaterThanOrEqualTo(4096);", "originalCommit": "b7ba3ff69fc36743f479b103232f6144e4dd2c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2NTcyMw==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491065723", "bodyText": "I'm retracting that comment since these constants existed before this PR.\nAny such changes should be pursued in connection with a refactoring ticket.", "author": "Bill", "createdAt": "2020-09-18T16:36:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0OTUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1NDIyMw==", "url": "https://github.com/apache/geode/pull/5525#discussion_r490654223", "bodyText": "The comment on method acquirePredefinedFixedBuffer() now lies. It says:\n  /**\n   * Acquire direct buffer with predefined default capacity (4096 or 32768)\n   */\n\nBut that method no longer returns buffers with predefined capacity.\nAlso that method's name seems wrong since it doesn't return a buffer with a predefined capacity at all, rather, it returns a buffer of the specified size. brainf*rt\nIf I am understanding the method in question, perhaps this would be more accurate (also eliminates the word \"fixed\" from the method name since I don't think that is pertinent):\n  /**\n   * Acquire direct buffer of size <= MEDIUM_BUFFER_SIZE\n   *\n   * Caller ensures that size <= MEDIUM_BUFFER_SIZE on entry. This method\n   * will not check that!\n   */\n  private ByteBuffer acquireSmallToMediumBuffer(boolean send, int size) {", "author": "Bill", "createdAt": "2020-09-18T01:49:09Z", "path": "geode-core/src/main/java/org/apache/geode/internal/net/BufferPool.java", "diffHunk": "@@ -98,14 +101,18 @@ private ByteBuffer acquireDirectBuffer(int size, boolean send) {\n \n     if (useDirectBuffers) {\n       if (size <= MEDIUM_BUFFER_SIZE) {\n-        return acquirePredefinedFixedBuffer(send, size);\n+        result = acquirePredefinedFixedBuffer(send, size);", "originalCommit": "b7ba3ff69fc36743f479b103232f6144e4dd2c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxNjIxNQ==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491016215", "bodyText": "I didn't change that private method and AFAIK the comment is still accurate", "author": "bschuchardt", "createdAt": "2020-09-18T15:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1NDIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NDIxOA==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491044218", "bodyText": "I would prefer to just remove the magic numbers from the comment.  I don't think the method rename is warranted.", "author": "bschuchardt", "createdAt": "2020-09-18T15:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1NDIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA2NjEzMw==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491066133", "bodyText": "I'm retracting that comment since this method name existed before this PR and was arguably already wrong before this PR.\nAny such changes should be pursued in connection with a refactoring ticket.", "author": "Bill", "createdAt": "2020-09-18T16:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1NDIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1ODIxNg==", "url": "https://github.com/apache/geode/pull/5525#discussion_r490658216", "bodyText": "It is awful that this method has to reflect on every single returned ByteBuffer.\nWould it impose too much overhead for us to define our own hierarchy underneath that abstract class to do the work (polymorphically) of returning the buffer to the pool? I realize that would entail three classes. But I wonder if they would be small (in lines-of-code). That would eliminate the possibility of an InternalGemFireException here and that would be valuable.", "author": "Bill", "createdAt": "2020-09-18T02:04:23Z", "path": "geode-core/src/main/java/org/apache/geode/internal/net/BufferPool.java", "diffHunk": "@@ -295,19 +302,48 @@ void releaseBuffer(BufferPool.BufferType type, ByteBuffer buffer) {\n   /**\n    * Releases a previously acquired buffer.\n    */\n-  private void releaseBuffer(ByteBuffer bb, boolean send) {\n-    if (bb.isDirect()) {\n-      BBSoftReference bbRef = new BBSoftReference(bb, send);\n-      if (bb.capacity() <= SMALL_BUFFER_SIZE) {\n+  private void releaseBuffer(ByteBuffer buffer, boolean send) {\n+    if (buffer.isDirect()) {\n+      buffer = getPoolableBuffer(buffer);\n+      BBSoftReference bbRef = new BBSoftReference(buffer, send);\n+      if (buffer.capacity() <= SMALL_BUFFER_SIZE) {\n         bufferSmallQueue.offer(bbRef);\n-      } else if (bb.capacity() <= MEDIUM_BUFFER_SIZE) {\n+      } else if (buffer.capacity() <= MEDIUM_BUFFER_SIZE) {\n         bufferMiddleQueue.offer(bbRef);\n       } else {\n         bufferLargeQueue.offer(bbRef);\n       }\n     } else {\n-      updateBufferStats(-bb.capacity(), send, false);\n+      updateBufferStats(-buffer.capacity(), send, false);\n+    }\n+  }\n+\n+  /**\n+   * If we hand out a buffer that is larger than the requested size we create a\n+   * \"slice\" of the buffer having the requested capacity and hand that out instead.\n+   * When we put the buffer back in the pool we need to find the original, non-sliced,\n+   * buffer. This is held in DirectBuffer in its \"attachment\" field, which is a public\n+   * method, though DirectBuffer is package-private.\n+   */\n+  @VisibleForTesting\n+  public ByteBuffer getPoolableBuffer(ByteBuffer buffer) {", "originalCommit": "b7ba3ff69fc36743f479b103232f6144e4dd2c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxMzAxNA==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491013014", "bodyText": "That seems like an expensive change that would disturb a lot of code.", "author": "bschuchardt", "createdAt": "2020-09-18T15:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1ODIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxODc2NQ==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491018765", "bodyText": "That\u2019s fine. But I did want to run it by you.\nSubclassing from a byte buffer class would entail making large (lots of methods), new classes huh?\nThe alternative would be to return something that is not a byte buffer, but rather has-a byte buffer. In that case things that call our BufferPool methods would get one of those (non-byte-buffer) things, and that would perturb lots of calling code.", "author": "Bill", "createdAt": "2020-09-18T15:15:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1ODIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NTYzNA==", "url": "https://github.com/apache/geode/pull/5525#discussion_r491045634", "bodyText": "Subclassing ByteBuffer isn't possible due to the class having final methods.  Introducing a new class seems desirable but would affect a lot of code and this needs to be backported to 1.12 and 1.13 support branches.  In such cases it's best to keep code changes to a minimum.", "author": "bschuchardt", "createdAt": "2020-09-18T15:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1ODIxNg=="}], "type": "inlineReview"}, {"oid": "d6f515316075d2ae297d7526cc8a935b42a4b0fc", "url": "https://github.com/apache/geode/commit/d6f515316075d2ae297d7526cc8a935b42a4b0fc", "message": "cache reflection method, remove magic numbers in test and BufferPool", "committedDate": "2020-09-18T17:48:06Z", "type": "commit"}]}