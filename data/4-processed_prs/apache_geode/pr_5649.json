{"pr_number": 5649, "pr_title": "GEODE-8637: Give each test worker a unique working dir", "pr_createdAt": "2020-10-21T19:21:40Z", "pr_url": "https://github.com/apache/geode/pull/5649", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzQyNA==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509697424", "bodyText": "I wonder if we need/want this gemfire.properties file anymore? As far as I'm concerned tests shouldn't be running with a gemfire.properties file lying around anyway?\nI see we have TestPropertiesWriter that creates a properties file. But all it has is log-level=config, which is the default anyway...", "author": "upthewaterspout", "createdAt": "2020-10-21T21:07:23Z", "path": "buildSrc/src/main/java/org/apache/geode/gradle/RunInSubdirectoryTestFramework.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.gradle;\n+\n+import static java.nio.file.StandardCopyOption.COPY_ATTRIBUTES;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.gradle.api.Action;\n+import org.gradle.api.internal.tasks.testing.TestFramework;\n+import org.gradle.api.internal.tasks.testing.WorkerTestClassProcessorFactory;\n+import org.gradle.api.internal.tasks.testing.detection.TestFrameworkDetector;\n+import org.gradle.api.tasks.testing.TestFrameworkOptions;\n+import org.gradle.process.internal.JavaExecHandleBuilder;\n+import org.gradle.process.internal.worker.WorkerProcessBuilder;\n+\n+/**\n+ * Wraps a test framework to run each test worker in a separate working directory.\n+ */\n+public class RunInSubdirectoryTestFramework implements TestFramework {\n+  private static final String GEMFIRE_PROPERTIES = \"gemfire.properties\";\n+  private final AtomicLong workerId = new AtomicLong();\n+  private final TestFramework delegate;\n+\n+  public RunInSubdirectoryTestFramework(TestFramework delegate) {\n+    this.delegate = delegate;\n+  }\n+\n+  @Override\n+  public TestFrameworkDetector getDetector() {\n+    return delegate.getDetector();\n+  }\n+\n+  @Override\n+  public TestFrameworkOptions getOptions() {\n+    return delegate.getOptions();\n+  }\n+\n+  @Override\n+  public WorkerTestClassProcessorFactory getProcessorFactory() {\n+    return delegate.getProcessorFactory();\n+  }\n+\n+  /**\n+   * Return an action that configures the test worker builder to run the test worker in a unique\n+   * subdirectory of the task's working directory.\n+   */\n+  @Override\n+  public Action<WorkerProcessBuilder> getWorkerConfigurationAction() {\n+    return workerProcessBuilder -> {\n+      delegate.getWorkerConfigurationAction().execute(workerProcessBuilder);\n+      JavaExecHandleBuilder javaCommand = workerProcessBuilder.getJavaCommand();\n+\n+      Path taskWorkingDir = javaCommand.getWorkingDir().toPath();\n+      String workerWorkingDirName = String.format(\"test-worker-%06d\", workerId.incrementAndGet());\n+      Path workerWorkingDir = taskWorkingDir.resolve(workerWorkingDirName);\n+\n+      createWorkingDir(workerWorkingDir);\n+      copyGemFirePropertiesFile(taskWorkingDir, workerWorkingDir);", "originalCommit": "5fa02e9466c4f1b2422e9a33172738dd6547f1b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxMDU2NQ==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509710565", "bodyText": "Just today I noticed that the non-repeat forms of these tasks don't write as properties file. If it's not needed, it would probably be better to delete the code that writes it.", "author": "demery-pivotal", "createdAt": "2020-10-21T21:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcyMTY5Mg==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509721692", "bodyText": "The gemfire.properties files, in all its incarnations, has been a thorn to me, because the writing of it causes a repack of geode-core.jar, which triggers all kinds of downstream effects.", "author": "rhoughton-pivot", "createdAt": "2020-10-21T21:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczMzA2Mg==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509733062", "bodyText": "Do you have a reason to believe it's still needed? If you're not sure, I can do a run without it and see what explodes.", "author": "demery-pivotal", "createdAt": "2020-10-21T21:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0MTM3MA==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509741370", "bodyText": "I don't think it is? The one thing maybe it might do is prevent us from looking for a gemfire.properties file in other places (the classpath?, the user's homedir?). Could be worth a run if we can get rid of some code.\nBTW, @rhoughton-pivot - I think maybe you are talking about writing the default properties file? That's different code I believe. But yeah, still seems like in that case maybe we could just check in a file or something.", "author": "upthewaterspout", "createdAt": "2020-10-21T22:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc1MzE1MQ==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509753151", "bodyText": "Hmmm. If the point of that file is to prevent looking in other places\u2026 removing it might change behavior on developers' machines, if they have a ~/gemfire.properties file. And a run in CI would not notice the problem.", "author": "demery-pivotal", "createdAt": "2020-10-21T22:23:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMxNTM3MA==", "url": "https://github.com/apache/geode/pull/5649#discussion_r510315370", "bodyText": "I am probably thinking of the gemfireVersion.properties :(", "author": "rhoughton-pivot", "createdAt": "2020-10-22T16:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5NzQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMTc0Nw==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509701747", "bodyText": "Huh, I wonder if you could do something like javaCommand.setExecutable(\"docker\") ... to run the workers in a docker container ;)", "author": "upthewaterspout", "createdAt": "2020-10-21T21:13:09Z", "path": "buildSrc/src/main/java/org/apache/geode/gradle/RunInSubdirectoryTestFramework.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.gradle;\n+\n+import static java.nio.file.StandardCopyOption.COPY_ATTRIBUTES;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.gradle.api.Action;\n+import org.gradle.api.internal.tasks.testing.TestFramework;\n+import org.gradle.api.internal.tasks.testing.WorkerTestClassProcessorFactory;\n+import org.gradle.api.internal.tasks.testing.detection.TestFrameworkDetector;\n+import org.gradle.api.tasks.testing.TestFrameworkOptions;\n+import org.gradle.process.internal.JavaExecHandleBuilder;\n+import org.gradle.process.internal.worker.WorkerProcessBuilder;\n+\n+/**\n+ * Wraps a test framework to run each test worker in a separate working directory.\n+ */\n+public class RunInSubdirectoryTestFramework implements TestFramework {\n+  private static final String GEMFIRE_PROPERTIES = \"gemfire.properties\";\n+  private final AtomicLong workerId = new AtomicLong();\n+  private final TestFramework delegate;\n+\n+  public RunInSubdirectoryTestFramework(TestFramework delegate) {\n+    this.delegate = delegate;\n+  }\n+\n+  @Override\n+  public TestFrameworkDetector getDetector() {\n+    return delegate.getDetector();\n+  }\n+\n+  @Override\n+  public TestFrameworkOptions getOptions() {\n+    return delegate.getOptions();\n+  }\n+\n+  @Override\n+  public WorkerTestClassProcessorFactory getProcessorFactory() {\n+    return delegate.getProcessorFactory();\n+  }\n+\n+  /**\n+   * Return an action that configures the test worker builder to run the test worker in a unique\n+   * subdirectory of the task's working directory.\n+   */\n+  @Override\n+  public Action<WorkerProcessBuilder> getWorkerConfigurationAction() {\n+    return workerProcessBuilder -> {\n+      delegate.getWorkerConfigurationAction().execute(workerProcessBuilder);\n+      JavaExecHandleBuilder javaCommand = workerProcessBuilder.getJavaCommand();", "originalCommit": "5fa02e9466c4f1b2422e9a33172738dd6547f1b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxMTY4NA==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509711684", "bodyText": "That's a really interesting idea!", "author": "demery-pivotal", "createdAt": "2020-10-21T21:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMTc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxNDY5Mg==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509714692", "bodyText": "I suspect it's not as simple as that, given that the Gradle client process needs to interact with the test worker process.", "author": "demery-pivotal", "createdAt": "2020-10-21T21:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMTc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0MDA4Mg==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509740082", "bodyText": "Yeah, I'm sure it's a bit more complicated. But maybe all of the gradle internal APIs that we would need to use are already in use in this PR?\nAnyway, I wasn't being that serious with this comment, mostly just teasing you since I know you're trying to get rid of docker.", "author": "upthewaterspout", "createdAt": "2020-10-21T22:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMTc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0NTI4MQ==", "url": "https://github.com/apache/geode/pull/5649#discussion_r509745281", "bodyText": "I got the tease, but maybe you didn't know: We're not trying to get rid of docker per se. We're trying to get rid of dependence on an old, unmaintained dockerizer plugin that's holding us back. Now that I'm turning my attention back port conflicts, I find your not-serious idea unreasonably tempting! I'm not hopeful, but I will look into it.", "author": "demery-pivotal", "createdAt": "2020-10-21T22:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwMTc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM3MTM4MQ==", "url": "https://github.com/apache/geode/pull/5649#discussion_r510371381", "bodyText": "If taskPropertiesFile does not exist, will it affect javaCommand.setWorkingDir(workerWorkingDir); (line 78)? Or will it have some unexpected behavior when running tests?", "author": "jchen21", "createdAt": "2020-10-22T18:28:31Z", "path": "buildSrc/src/main/java/org/apache/geode/gradle/RunInSubdirectoryTestFramework.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.gradle;\n+\n+import static java.nio.file.StandardCopyOption.COPY_ATTRIBUTES;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.gradle.api.Action;\n+import org.gradle.api.internal.tasks.testing.TestFramework;\n+import org.gradle.api.internal.tasks.testing.WorkerTestClassProcessorFactory;\n+import org.gradle.api.internal.tasks.testing.detection.TestFrameworkDetector;\n+import org.gradle.api.tasks.testing.TestFrameworkOptions;\n+import org.gradle.process.internal.JavaExecHandleBuilder;\n+import org.gradle.process.internal.worker.WorkerProcessBuilder;\n+\n+/**\n+ * Wraps a test framework to run each test worker in a separate working directory.\n+ */\n+public class RunInSubdirectoryTestFramework implements TestFramework {\n+  private static final String GEMFIRE_PROPERTIES = \"gemfire.properties\";\n+  private final AtomicLong workerId = new AtomicLong();\n+  private final TestFramework delegate;\n+\n+  public RunInSubdirectoryTestFramework(TestFramework delegate) {\n+    this.delegate = delegate;\n+  }\n+\n+  @Override\n+  public TestFrameworkDetector getDetector() {\n+    return delegate.getDetector();\n+  }\n+\n+  @Override\n+  public TestFrameworkOptions getOptions() {\n+    return delegate.getOptions();\n+  }\n+\n+  @Override\n+  public WorkerTestClassProcessorFactory getProcessorFactory() {\n+    return delegate.getProcessorFactory();\n+  }\n+\n+  /**\n+   * Return an action that configures the test worker builder to run the test worker in a unique\n+   * subdirectory of the task's working directory.\n+   */\n+  @Override\n+  public Action<WorkerProcessBuilder> getWorkerConfigurationAction() {\n+    return workerProcessBuilder -> {\n+      delegate.getWorkerConfigurationAction().execute(workerProcessBuilder);\n+      JavaExecHandleBuilder javaCommand = workerProcessBuilder.getJavaCommand();\n+\n+      Path taskWorkingDir = javaCommand.getWorkingDir().toPath();\n+      String workerWorkingDirName = String.format(\"test-worker-%06d\", workerId.incrementAndGet());\n+      Path workerWorkingDir = taskWorkingDir.resolve(workerWorkingDirName);\n+\n+      createWorkingDir(workerWorkingDir);\n+      copyGemFirePropertiesFile(taskWorkingDir, workerWorkingDir);\n+\n+      javaCommand.setWorkingDir(workerWorkingDir);\n+    };\n+  }\n+\n+  private void copyGemFirePropertiesFile(Path taskWorkingDir, Path workerWorkingDir) {\n+    Path taskPropertiesFile = taskWorkingDir.resolve(GEMFIRE_PROPERTIES);\n+    if (!Files.exists(taskPropertiesFile)) {\n+      return;", "originalCommit": "5fa02e9466c4f1b2422e9a33172738dd6547f1b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MDA5NQ==", "url": "https://github.com/apache/geode/pull/5649#discussion_r510390095", "bodyText": "If the file is missing, that doesn't indicate a problem. It's deliberate. Our Gradle build puts that file there for some test tasks (e.g. distributedTest) but not for others (e.g. repeatDistributedTest). I don't know why our Gradle build writes the file for some tasks and not others, but that's the current behavior.\nThe if statement accounts for Gradle writing the file for some tasks and not for others.\nThe effect is that if the file was in the test JVM's common working directory before this PR, it will be in the JVM's unique working directory after. And if the file was absent from the test JVM's working directory before the PR, it will be absent after.", "author": "demery-pivotal", "createdAt": "2020-10-22T19:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM3MTM4MQ=="}], "type": "inlineReview"}, {"oid": "167400f7709c5ed6b7ca3938191a4443c8e3de9b", "url": "https://github.com/apache/geode/commit/167400f7709c5ed6b7ca3938191a4443c8e3de9b", "message": "Fix typo in variable name", "committedDate": "2020-10-22T20:19:29Z", "type": "forcePushed"}, {"oid": "5a56f668f1751ebe88d59bf640835307bb82c4d0", "url": "https://github.com/apache/geode/commit/5a56f668f1751ebe88d59bf640835307bb82c4d0", "message": "Fix typo in variable name", "committedDate": "2020-10-26T16:08:25Z", "type": "forcePushed"}, {"oid": "0f6994d6fb3bdac6e09cd01662b31497794e420a", "url": "https://github.com/apache/geode/commit/0f6994d6fb3bdac6e09cd01662b31497794e420a", "message": "Fix typo in variable name", "committedDate": "2020-10-26T18:51:34Z", "type": "forcePushed"}, {"oid": "485f5dc7b69ff376d7a0415c64a194415cb9e8b4", "url": "https://github.com/apache/geode/commit/485f5dc7b69ff376d7a0415c64a194415cb9e8b4", "message": "Fix typo in variable name", "committedDate": "2020-10-26T21:01:44Z", "type": "forcePushed"}, {"oid": "bde6212f4e6c86ad46e85b65db412a4eb6598adb", "url": "https://github.com/apache/geode/commit/bde6212f4e6c86ad46e85b65db412a4eb6598adb", "message": "Give each test worker a unique working dir\n\nBefore running a test task, wrap its TestFramework in a wrapper that\ncreates a unique working dir for each new test worker.", "committedDate": "2020-10-27T16:07:45Z", "type": "commit"}, {"oid": "c7ccb84e64c60738705c1075f94d2a8354127bc9", "url": "https://github.com/apache/geode/commit/c7ccb84e64c60738705c1075f94d2a8354127bc9", "message": "Fix typo in variable name", "committedDate": "2020-10-27T16:07:45Z", "type": "commit"}, {"oid": "c7ccb84e64c60738705c1075f94d2a8354127bc9", "url": "https://github.com/apache/geode/commit/c7ccb84e64c60738705c1075f94d2a8354127bc9", "message": "Fix typo in variable name", "committedDate": "2020-10-27T16:07:45Z", "type": "forcePushed"}]}