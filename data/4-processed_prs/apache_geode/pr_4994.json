{"pr_number": 4994, "pr_title": "GEODE-8020: buffer corruption in SSL communications", "pr_createdAt": "2020-04-24T22:45:35Z", "pr_url": "https://github.com/apache/geode/pull/4994", "timeline": [{"oid": "a0b7880c978c23fd13da31a7161c1ffec2d9285e", "url": "https://github.com/apache/geode/commit/a0b7880c978c23fd13da31a7161c1ffec2d9285e", "message": "GEODE-8020: buffer corruption in SSL communications\n\nrevert change in GEODE-6661 that made NioSslEngine use a direct buffer.\nThis class is not designed to share its buffer with a pool in\nBufferPool.  Connection is also modified to use a heap buffer for\nreading encrypted SSL packets for consistency.  New tests ensure that\nthese buffers are the correct type when using SSL or plain sockets.", "committedDate": "2020-04-24T22:40:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwNzcyMQ==", "url": "https://github.com/apache/geode/pull/4994#discussion_r414907721", "bodyText": "Is it intentional to increase the verbosity of this log message?", "author": "pivotal-jbarrett", "createdAt": "2020-04-24T22:58:27Z", "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1662,8 +1662,8 @@ private void readMessages() {\n         } catch (IOException e) {\n           // \"Socket closed\" check needed for Solaris jdk 1.4.2_08\n           if (!isSocketClosed() && !\"Socket closed\".equalsIgnoreCase(e.getMessage())) {\n-            if (logger.isDebugEnabled() && !isIgnorableIOException(e)) {\n-              logger.debug(\"{} io exception for {}\", p2pReaderName(), this, e);\n+            if (logger.isInfoEnabled() && !isIgnorableIOException(e)) {", "originalCommit": "a0b7880c978c23fd13da31a7161c1ffec2d9285e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2NDgwOQ==", "url": "https://github.com/apache/geode/pull/4994#discussion_r415364809", "bodyText": "yes!  I only saw the SSLException that explained the message-loss when debug-level logging was enabled.  With this log level change I had to augment isIgnorableException to filter out some exceptions being caught here when the socket was closed.", "author": "bschuchardt", "createdAt": "2020-04-26T17:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwNzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwOTE2NQ==", "url": "https://github.com/apache/geode/pull/4994#discussion_r414909165", "bodyText": "The commit message references reverting the direct buffer changes. Is this change intentional because it doesn't look like part of the reverted commit?", "author": "pivotal-jbarrett", "createdAt": "2020-04-24T23:02:40Z", "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1763,9 +1763,13 @@ private static boolean isIgnorableIOException(Exception e) {\n     }\n \n     msg = msg.toLowerCase();\n-    return msg.contains(\"forcibly closed\")\n-        || msg.contains(\"reset by peer\")\n-        || msg.contains(\"connection reset\");\n+\n+    if (e instanceof SSLException && msg.contains(\"status = closed\")) {", "originalCommit": "a0b7880c978c23fd13da31a7161c1ffec2d9285e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM2NTIwMA==", "url": "https://github.com/apache/geode/pull/4994#discussion_r415365200", "bodyText": "See my previous comment", "author": "bschuchardt", "createdAt": "2020-04-26T18:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkwOTE2NQ=="}], "type": "inlineReview"}]}