{"pr_number": 4920, "pr_title": "GEODE-7852: SNI extension support", "pr_createdAt": "2020-04-07T21:46:42Z", "pr_url": "https://github.com/apache/geode/pull/4920", "timeline": [{"oid": "276582533c885092d8e1d076d426a4c9f2e0b908", "url": "https://github.com/apache/geode/commit/276582533c885092d8e1d076d426a4c9f2e0b908", "message": "GEODE-7852: SNI extension support\n\nModified SNISocketFactory so it can be used in cache.xml\nAdded a test for the new cache.xml element.\nUpdated docs for cache.xml and updated client configuration\ninstructions.", "committedDate": "2020-04-07T21:27:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNzk1MA==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405137950", "bodyText": "It isn't obvious from reading this test class, where that foo/bar entry came from and why we expect it to be there. Of course it was added by geode-starter.gfsh, but that was incidental.", "author": "Bill", "createdAt": "2020-04-07T21:57:53Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/client/sni/ClientSNIAcceptanceTest.java", "diffHunk": "@@ -97,5 +97,6 @@ public void connectToSNIProxyDocker() {\n     region.destroy(\"hello\");\n     region.put(\"hello\", \"world\");\n     assertThat(region.get(\"hello\")).isEqualTo(\"world\");\n+    assertThat(region.get(\"foo\")).isEqualTo(\"bar\");", "originalCommit": "276582533c885092d8e1d076d426a4c9f2e0b908", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU3NjQ1NQ==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405576455", "bodyText": "I've added comments about the region \"jellyfish\" and the entry \"bar\" being created by the gfsh script", "author": "bschuchardt", "createdAt": "2020-04-08T14:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzNzk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzOTk1Mg==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405139952", "bodyText": "\"Server Name Extension field\" -> \"Server Name Indication field\"", "author": "Bill", "createdAt": "2020-04-07T22:02:34Z", "path": "geode-docs/reference/topics/client-cache.html.md.erb", "diffHunk": "@@ -338,6 +338,32 @@ Provide a server list or `locator` list, but not both.\n        port=\"123456\"/>\n </pool>\n ```\n+## <a id=\"cc-socket-factory\" class=\"no-quick-link\"></a>&lt;socket-factory&gt;\n+\n+Defines a factory to create socket connections to locators and servers.  A typical use of this element is to redirect connections to an ingress gateway such as Istio or HAProxy in a cluster where the TLS (SSL) Server Name Extension field is set to indicate the actual locator or server the client is trying to reach.  This allows you to expose only the gateway hostname:port without the client needing to be able to resolve the names of the locator and server machines.", "originalCommit": "276582533c885092d8e1d076d426a4c9f2e0b908", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU3Nzk5Ng==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405577996", "bodyText": "thanks Bill", "author": "bschuchardt", "createdAt": "2020-04-08T14:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzOTk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDYzOA==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405144638", "bodyText": "I was concerned about using the term \"gateway\" (instead of \"proxy\") here but my research indicates \"gateway\" is not inappropriate \u2713 :)", "author": "Bill", "createdAt": "2020-04-07T22:13:45Z", "path": "geode-docs/topologies_and_comm/cs_configuration/setting_up_a_client_server_system.html.md.erb", "diffHunk": "@@ -53,15 +53,28 @@ Configure your server and client processes and data regions to run your client/s\n     \n         <client-cache>\n            <pool name=\"publisher\" subscription-enabled=\"true\">\n-              <locator host=\"lucy\" port=\"41111\"/> \n-              <locator host=\"lucy\" port=\"41111\"/> \n+              <locator host=\"lucy1\" port=\"41111\"/>\n+              <locator host=\"lucy2\" port=\"41111\"/>\n            </pool>\n            ...\n            <region name=\"clientRegion\" ...\n               <region-attributes pool-name=\"publisher\" ...\n \n     You do not need to provide the complete list of locators to the clients at startup, but you should provide as complete a list as possible. The locators maintain a dynamic list of locators and servers and provide the information to the clients as needed.\n \n+    When TLS (SSL) is used clients can also be directed to go through a SNI gateway such as Istio or HAProxy to reach locators and servers.  To do this add the following to your cache.xml pool configuration:", "originalCommit": "276582533c885092d8e1d076d426a4c9f2e0b908", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2NDkzNg==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405164936", "bodyText": "@Bill solid double negation there...", "author": "echobravopapa", "createdAt": "2020-04-07T23:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU3Njg4MA==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405576880", "bodyText": "I've corrected your comment to read \"is appropriate\" :-)", "author": "bschuchardt", "createdAt": "2020-04-08T14:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NjgyMQ==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405146821", "bodyText": "ooh good catch!", "author": "Bill", "createdAt": "2020-04-07T22:19:18Z", "path": "geode-dunit/src/main/java/org/apache/geode/test/dunit/internal/ProcessManager.java", "diffHunk": "@@ -258,8 +258,10 @@ private String removeModuleFromGradlePath(String classpath, String module) {\n       // remove current-version product classes and resources from the classpath\n       dunitClasspath =\n           removeModulesFromPath(dunitClasspath, \"geode-common\", \"geode-core\", \"geode-cq\",\n-              \"geode-http-service\", \"geode-json\", \"geode-log4j\", \"geode-lucene\",\n-              \"geode-serialization\", \"geode-wan\", \"geode-gfsh\");\n+              \"geode-http-service\", \"geode-json\", \"geode-log4j\", \"geode-lucene\", \"geode-tcp-server\",\n+              \"geode-membership\", \"geode-management\", \"geode-logging\", \"geode-web\",\n+              \"geode-rebalancer\",\n+              \"geode-serialization\", \"geode-wan\", \"geode-gfsh\", \"geode-lucene\");", "originalCommit": "276582533c885092d8e1d076d426a4c9f2e0b908", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1260318f02dfb5e84b8e85d744a133217b1abe9f", "url": "https://github.com/apache/geode/commit/1260318f02dfb5e84b8e85d744a133217b1abe9f", "message": "addressing reviews", "committedDate": "2020-04-08T14:37:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MDI2OQ==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405650269", "bodyText": "formatting: I believe you need a space in \"(SNI)field\" -> \"(SNI) field\"", "author": "Bill", "createdAt": "2020-04-08T16:21:55Z", "path": "geode-docs/reference/topics/client-cache.html.md.erb", "diffHunk": "@@ -338,6 +338,32 @@ Provide a server list or `locator` list, but not both.\n        port=\"123456\"/>\n </pool>\n ```\n+## <a id=\"cc-socket-factory\" class=\"no-quick-link\"></a>&lt;socket-factory&gt;\n+\n+Defines a factory to create socket connections to locators and servers.  A typical use of this element is to redirect connections to an ingress gateway such as Istio or HAProxy in a cluster where the TLS (SSL) Server Name Indication (SNI)field is set to indicate the actual locator or server the client is trying to reach.  This allows you to expose only the gateway hostname:port without the client needing to be able to resolve the names of the locator and server machines.", "originalCommit": "1260318f02dfb5e84b8e85d744a133217b1abe9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5ODkyNA==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405698924", "bodyText": "done", "author": "bschuchardt", "createdAt": "2020-04-08T17:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MDI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MDcxNg==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405650716", "bodyText": "I like this better now that you have a number here \u2713", "author": "Bill", "createdAt": "2020-04-08T16:22:39Z", "path": "geode-docs/reference/topics/client-cache.html.md.erb", "diffHunk": "@@ -338,6 +338,32 @@ Provide a server list or `locator` list, but not both.\n        port=\"123456\"/>\n </pool>\n ```\n+## <a id=\"cc-socket-factory\" class=\"no-quick-link\"></a>&lt;socket-factory&gt;\n+\n+Defines a factory to create socket connections to locators and servers.  A typical use of this element is to redirect connections to an ingress gateway such as Istio or HAProxy in a cluster where the TLS (SSL) Server Name Indication (SNI)field is set to indicate the actual locator or server the client is trying to reach.  This allows you to expose only the gateway hostname:port without the client needing to be able to resolve the names of the locator and server machines.\n+\n+**Note:**\n+This setting may be used with either a Server list or a Locator list.  It will be used to form connections to either.\n+\n+**Default:**\n+\n+**API:** `org.apache.geode.cache.client.proxy.ProxySocketFactories`\n+\n+**Example:**\n+\n+``` pre\n+<pool ...>\n+ <socket-factory>\n+    <class-name>org.apache.geode.cache.client.proxy.SniSocketFactory</class-name>\n+    <parameter name=\"hostname\">\n+      <string>my-haproxy-address</string>\n+    </parameter>\n+    <parameter name=\"port\">\n+      <string>12345</string>", "originalCommit": "1260318f02dfb5e84b8e85d744a133217b1abe9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MjI0Ng==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405652246", "bodyText": "for consistency, since the documentation refers to a \"gateway\" (not a \"proxy\") and also since HAproxy is only one of many choices, I recomend calling this something like my-sni-gateway-address", "author": "Bill", "createdAt": "2020-04-08T16:24:50Z", "path": "geode-docs/reference/topics/client-cache.html.md.erb", "diffHunk": "@@ -338,6 +338,32 @@ Provide a server list or `locator` list, but not both.\n        port=\"123456\"/>\n </pool>\n ```\n+## <a id=\"cc-socket-factory\" class=\"no-quick-link\"></a>&lt;socket-factory&gt;\n+\n+Defines a factory to create socket connections to locators and servers.  A typical use of this element is to redirect connections to an ingress gateway such as Istio or HAProxy in a cluster where the TLS (SSL) Server Name Indication (SNI)field is set to indicate the actual locator or server the client is trying to reach.  This allows you to expose only the gateway hostname:port without the client needing to be able to resolve the names of the locator and server machines.\n+\n+**Note:**\n+This setting may be used with either a Server list or a Locator list.  It will be used to form connections to either.\n+\n+**Default:**\n+\n+**API:** `org.apache.geode.cache.client.proxy.ProxySocketFactories`\n+\n+**Example:**\n+\n+``` pre\n+<pool ...>\n+ <socket-factory>\n+    <class-name>org.apache.geode.cache.client.proxy.SniSocketFactory</class-name>\n+    <parameter name=\"hostname\">\n+      <string>my-haproxy-address</string>", "originalCommit": "1260318f02dfb5e84b8e85d744a133217b1abe9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5OTE4Mw==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405699183", "bodyText": "done - it's now my-gateway-address like the other place", "author": "bschuchardt", "createdAt": "2020-04-08T17:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MjI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MjY4MQ==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405652681", "bodyText": "\"gateway\" \u2713", "author": "Bill", "createdAt": "2020-04-08T16:25:33Z", "path": "geode-docs/topologies_and_comm/cs_configuration/setting_up_a_client_server_system.html.md.erb", "diffHunk": "@@ -53,15 +53,28 @@ Configure your server and client processes and data regions to run your client/s\n     \n         <client-cache>\n            <pool name=\"publisher\" subscription-enabled=\"true\">\n-              <locator host=\"lucy\" port=\"41111\"/> \n-              <locator host=\"lucy\" port=\"41111\"/> \n+              <locator host=\"lucy1\" port=\"41111\"/>\n+              <locator host=\"lucy2\" port=\"41111\"/>\n            </pool>\n            ...\n            <region name=\"clientRegion\" ...\n               <region-attributes pool-name=\"publisher\" ...\n \n     You do not need to provide the complete list of locators to the clients at startup, but you should provide as complete a list as possible. The locators maintain a dynamic list of locators and servers and provide the information to the clients as needed.\n \n+    When TLS (SSL) is used clients can also be directed to go through a SNI gateway such as Istio or HAProxy to reach locators and servers.  To do this add the following to your cache.xml pool configuration:\n+        <pool... >\n+          <socket-factory>\n+            <class-name>org.apache.geode.cache.client.proxy.SniSocketFactory</class-name>\n+            <parameter name=\"hostname\">\n+              <string>my-gateway-address</string>", "originalCommit": "1260318f02dfb5e84b8e85d744a133217b1abe9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MzQ1Mw==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405653453", "bodyText": "for consistency with the other .erb file, should we have a number here?", "author": "Bill", "createdAt": "2020-04-08T16:26:36Z", "path": "geode-docs/topologies_and_comm/cs_configuration/setting_up_a_client_server_system.html.md.erb", "diffHunk": "@@ -53,15 +53,28 @@ Configure your server and client processes and data regions to run your client/s\n     \n         <client-cache>\n            <pool name=\"publisher\" subscription-enabled=\"true\">\n-              <locator host=\"lucy\" port=\"41111\"/> \n-              <locator host=\"lucy\" port=\"41111\"/> \n+              <locator host=\"lucy1\" port=\"41111\"/>\n+              <locator host=\"lucy2\" port=\"41111\"/>\n            </pool>\n            ...\n            <region name=\"clientRegion\" ...\n               <region-attributes pool-name=\"publisher\" ...\n \n     You do not need to provide the complete list of locators to the clients at startup, but you should provide as complete a list as possible. The locators maintain a dynamic list of locators and servers and provide the information to the clients as needed.\n \n+    When TLS (SSL) is used clients can also be directed to go through a SNI gateway such as Istio or HAProxy to reach locators and servers.  To do this add the following to your cache.xml pool configuration:\n+        <pool... >\n+          <socket-factory>\n+            <class-name>org.apache.geode.cache.client.proxy.SniSocketFactory</class-name>\n+            <parameter name=\"hostname\">\n+              <string>my-gateway-address</string>\n+            </parameter>\n+            <parameter name=\"port\">\n+              <string>my-gateway-port-number</string>", "originalCommit": "1260318f02dfb5e84b8e85d744a133217b1abe9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5OTM5Mg==", "url": "https://github.com/apache/geode/pull/4920#discussion_r405699392", "bodyText": "12345", "author": "bschuchardt", "createdAt": "2020-04-08T17:39:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MzQ1Mw=="}], "type": "inlineReview"}, {"oid": "d301de9c6bd1d145285a4eb1435ece9e9d254820", "url": "https://github.com/apache/geode/commit/d301de9c6bd1d145285a4eb1435ece9e9d254820", "message": "addressing reviews", "committedDate": "2020-04-08T17:38:19Z", "type": "commit"}, {"oid": "381714eb08c454894fe442d1df21c23adad5bc4e", "url": "https://github.com/apache/geode/commit/381714eb08c454894fe442d1df21c23adad5bc4e", "message": "fixing new assertions in unit test and retriggering CI tasks", "committedDate": "2020-04-08T21:47:20Z", "type": "commit"}, {"oid": "47cc74f22714ae8d598c337f4ab92e72fe02d28e", "url": "https://github.com/apache/geode/commit/47cc74f22714ae8d598c337f4ab92e72fe02d28e", "message": "reverting ProcessManager changes - evidently the rolling upgrade test code needs some of this stuff", "committedDate": "2020-04-08T23:08:45Z", "type": "commit"}]}