{"pr_number": 5403, "pr_title": "GEODE-8385: hang recovering from disk with cyclic dependencies", "pr_createdAt": "2020-07-27T22:35:49Z", "pr_url": "https://github.com/apache/geode/pull/5403", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzEyMw==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461213123", "bodyText": "comment lies now that this returns void", "author": "Bill", "createdAt": "2020-07-27T22:46:09Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1784,19 +1784,15 @@ private String prettifyReason(String r) {\n   /**\n    * Returns true if id was removed. Returns false if it was not in the list of managers.\n    */\n-  private boolean removeManager(InternalDistributedMember theId, boolean crashed, String p_reason) {\n-    String reason = p_reason;\n-\n-    reason = prettifyReason(reason);\n+  private void removeManager(InternalDistributedMember theId, boolean crashed, String p_reason) {", "originalCommit": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY0NTkwNw==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461645907", "bodyText": "I've in-lined this method.  Its name no longer made sense and it was only used by handleManagerDeparture()", "author": "bschuchardt", "createdAt": "2020-07-28T14:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxNzc1MA==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461217750", "bodyText": "\u2713 ok to this block of code\u2014I confirmed it's the same as the old block that was under the conditional but no conditional is needed now that removeManager() returns void (and it used to always return true) \u2713", "author": "Bill", "createdAt": "2020-07-27T22:59:04Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,41 +1862,54 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason, false);\n   }\n \n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n-\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);\n+\n     int vmType = theId.getVmKind();\n     if (vmType == ADMIN_ONLY_DM_TYPE) {\n-      removeUnfinishedStartup(theId, true);\n-      handleConsoleShutdown(theId, p_crashed, p_reason);\n+      handleConsoleShutdown(theId, memberCrashed, reason);\n       return;\n     }\n \n-    removeUnfinishedStartup(theId, true);\n-\n-    if (removeManager(theId, p_crashed, p_reason)) {\n-      if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n-        stats.incNodes(-1);\n+    if (!fromViewChange) {\n+      if (!isCurrentMember(theId)) {\n+        // this is notification from a shutdown message received from a member that is no longer\n+        // part of the cluster\n+        return;\n       }\n-      String msg;\n-      if (p_crashed && !shouldInhibitMembershipWarnings()) {\n-        msg =\n-            \"Member at {} unexpectedly left the distributed cache: {}\";\n-        addMemberEvent(new MemberCrashedEvent(theId, p_reason));\n-      } else {\n-        msg =\n-            \"Member at {} gracefully left the distributed cache: {}\";\n-        addMemberEvent(new MemberDepartedEvent(theId, p_reason));\n+      // else this is from a shutdown message so continue & notify listeners\n+    } else {\n+      if (!memberCrashed) {\n+        // member left the view normally - we've already received a shutdown message and notified\n+        // listeners, so there's nothing more to do here\n+        return;\n       }\n-      logger.info(msg, new Object[] {theId, prettifyReason(p_reason)});\n+    }\n \n-      executors.handleManagerDeparture(theId);\n+    removeManager(theId, memberCrashed, reason);\n+    if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n+      stats.incNodes(-1);\n+    }\n+    String msg;\n+    if (memberCrashed && !shouldInhibitMembershipWarnings()) {\n+      msg =\n+          \"Member at {} unexpectedly left the distributed cache: {}\";\n+      addMemberEvent(new MemberCrashedEvent(theId, reason));\n+    } else {\n+      msg =\n+          \"Member at {} gracefully left the distributed cache: {}\";\n+      addMemberEvent(new MemberDepartedEvent(theId, reason));\n     }\n+    logger.info(msg, new Object[] {theId, prettifyReason(reason)});\n+\n+    executors.handleManagerDeparture(theId);", "originalCommit": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxODc1Mg==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461218752", "bodyText": "why did this statement move? should it be in a finally block?", "author": "Bill", "createdAt": "2020-07-27T23:01:52Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2366,10 +2375,10 @@ public void memberDeparted(InternalDistributedMember theId, boolean crashed, Str\n           message.setReason(reason); // added for #37950\n           handleIncomingDMsg(message);\n         }\n-        dm.handleManagerDeparture(theId, crashed, reason);\n       } catch (DistributedSystemDisconnectedException se) {\n         // let's not get huffy about it\n       }\n+      dm.handleManagerDeparture(theId, crashed, reason, true);", "originalCommit": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxNzY2Nw==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461617667", "bodyText": "that change was unnecessary - I'll revert it.", "author": "bschuchardt", "createdAt": "2020-07-28T14:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxODc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTM3OA==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461221378", "bodyText": "Why did the name change to \"GMSMember\" here? It was \"MemberData\" which kinda made sense because GMSMemberData isa MemberData. I could see leaving it alone or maybe making it GMSMemberData.", "author": "Bill", "createdAt": "2020-07-27T23:09:19Z", "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/GMSMemberData.java", "diffHunk": "@@ -399,11 +399,11 @@ public int hashCode() {\n   public String toString() {\n     StringBuilder sb = new StringBuilder(100);\n \n-    sb.append(\"MemberData[\");\n+    sb.append(\"GMSMember[\");", "originalCommit": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMzM5MQ==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461613391", "bodyText": "I think that's an artifact of my doing this work on an old SHA and then rebasing onto develop.  I'll revert that change", "author": "bschuchardt", "createdAt": "2020-07-28T14:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2Nzc3Mg==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461667772", "bodyText": "nice", "author": "Bill", "createdAt": "2020-07-28T15:22:08Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,41 +1848,45 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason, false);\n   }\n \n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n-\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);", "originalCommit": "9a2d355b763a9a7c50388c20010801bbf3fc0c49", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2ODM2OQ==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461668369", "bodyText": "\u2713 inlined removeManager()", "author": "Bill", "createdAt": "2020-07-28T15:22:59Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,41 +1848,45 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason, false);\n   }\n \n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n-\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);\n+\n     int vmType = theId.getVmKind();\n     if (vmType == ADMIN_ONLY_DM_TYPE) {\n-      removeUnfinishedStartup(theId, true);\n-      handleConsoleShutdown(theId, p_crashed, p_reason);\n+      handleConsoleShutdown(theId, memberCrashed, reason);\n       return;\n     }\n \n-    removeUnfinishedStartup(theId, true);\n-\n-    if (removeManager(theId, p_crashed, p_reason)) {\n-      if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n-        stats.incNodes(-1);\n-      }\n-      String msg;\n-      if (p_crashed && !shouldInhibitMembershipWarnings()) {\n-        msg =\n-            \"Member at {} unexpectedly left the distributed cache: {}\";\n-        addMemberEvent(new MemberCrashedEvent(theId, p_reason));\n-      } else {\n-        msg =\n-            \"Member at {} gracefully left the distributed cache: {}\";\n-        addMemberEvent(new MemberDepartedEvent(theId, p_reason));\n-      }\n-      logger.info(msg, new Object[] {theId, prettifyReason(p_reason)});\n+    if (logger.isDebugEnabled()) {\n+      logger.debug(\"DistributionManager: removing member <{}>; crashed {}; reason = {}\", theId,\n+          memberCrashed, prettifyReason(reason));\n+    }\n+    removeHostedLocators(theId);\n+    redundancyZones.remove(theId);", "originalCommit": "9a2d355b763a9a7c50388c20010801bbf3fc0c49", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "02d830d89d212274e536cdea39c11ae7b16449ed", "url": "https://github.com/apache/geode/commit/02d830d89d212274e536cdea39c11ae7b16449ed", "message": "GEODE-8385: hang recovering from disk with cyclic dependencies\n\nThis restores the point at which we notify membership listeners of\ndepartures.  We used to do this (in 1.12 and earlier) when a ShutdownMessage\nis received instead of waiting for a new membership view announcing the departure.\nMembership views can take some time to form and install, which can cause\npersistent (disk store) views to be updated later than they used to be.\n\nIn the case of this ticket the disk store of one member was being\nclosed while another was shutting down.  The member closing its disk\nstore did not see the view announcing that shutdown until most of its\ndisk store regions had closed their persistence advisors.  This left the\ndisk store thinking that the other member was still up at the time it\nwas closed.", "committedDate": "2020-07-28T16:53:50Z", "type": "commit"}, {"oid": "83e9fb16fa9b842e8c34108bcd3b9a9e58962c58", "url": "https://github.com/apache/geode/commit/83e9fb16fa9b842e8c34108bcd3b9a9e58962c58", "message": "fixing things Bill found & removing duplicate processing checks\n\nlisteners are able to cope with duplicate memberDeparted notifications\nand the old code allowed that to happen.  It would be bad if we\nmissed notifying listeners should we get a view change but no\nshutdown message (which is not an ack-ed message).", "committedDate": "2020-07-28T16:53:50Z", "type": "commit"}, {"oid": "c1b04ff3688d14ce69d65220c03c9541cdefedd6", "url": "https://github.com/apache/geode/commit/c1b04ff3688d14ce69d65220c03c9541cdefedd6", "message": "cleanup & protect stats from duplicate memberDeparted notification", "committedDate": "2020-07-28T16:53:50Z", "type": "commit"}, {"oid": "c1b04ff3688d14ce69d65220c03c9541cdefedd6", "url": "https://github.com/apache/geode/commit/c1b04ff3688d14ce69d65220c03c9541cdefedd6", "message": "cleanup & protect stats from duplicate memberDeparted notification", "committedDate": "2020-07-28T16:53:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4ODU5Mw==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461788593", "bodyText": "Why this is not handleManagerDeparture(theId, false, reason, true)? handleManagerDeparture(theId, false, reason) will not update the stats in line 1887.", "author": "jchen21", "createdAt": "2020-07-28T18:32:43Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,39 +1848,56 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason);", "originalCommit": "c1b04ff3688d14ce69d65220c03c9541cdefedd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0MDAzNQ==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461840035", "bodyText": "Sorry, I don't understand the question.  We want to decrement the node count once, but this method will be invoked multiple times for the same departing node.  If we restrict the decrement to view-changes it will only be decremented once because we only notify memberDeparted once for a member that's left the view.", "author": "bschuchardt", "createdAt": "2020-07-28T19:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4ODU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MjA2Mw==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461792063", "bodyText": "Would it better to move the logger.info out of the if statement? So regardless the value of fromViewChange, it logs the member departure. It will be helpful when analyzing the logs.", "author": "jchen21", "createdAt": "2020-07-28T18:38:43Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,39 +1848,56 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason);\n   }\n \n+  /*\n+   * handleManagerDeparted may be invoked multiple times for a member identifier.\n+   * We allow this and inform listeners on each invocation, but only perform some\n+   * actions (such as decrementing the node count) if the change came from a\n+   * membership view.\n+   */\n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason) {\n+    handleManagerDeparture(theId, memberCrashed, reason, false);\n+  }\n \n+  private void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);\n+\n     int vmType = theId.getVmKind();\n     if (vmType == ADMIN_ONLY_DM_TYPE) {\n-      removeUnfinishedStartup(theId, true);\n-      handleConsoleShutdown(theId, p_crashed, p_reason);\n+      handleConsoleShutdown(theId, memberCrashed, reason);\n       return;\n     }\n \n-    removeUnfinishedStartup(theId, true);\n-\n-    if (removeManager(theId, p_crashed, p_reason)) {\n-      if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n-        stats.incNodes(-1);\n-      }\n-      String msg;\n-      if (p_crashed && !shouldInhibitMembershipWarnings()) {\n-        msg =\n-            \"Member at {} unexpectedly left the distributed cache: {}\";\n-        addMemberEvent(new MemberCrashedEvent(theId, p_reason));\n-      } else {\n-        msg =\n-            \"Member at {} gracefully left the distributed cache: {}\";\n-        addMemberEvent(new MemberDepartedEvent(theId, p_reason));\n-      }\n-      logger.info(msg, new Object[] {theId, prettifyReason(p_reason)});\n+    if (logger.isDebugEnabled()) {\n+      logger.debug(\n+          \"DistributionManager: removing member <{}>; crashed {}; reason = {} fromView = {}\", theId,\n+          memberCrashed, prettifyReason(reason), fromViewChange);\n+    }\n+    removeHostedLocators(theId);\n+    redundancyZones.remove(theId);\n \n+    if (fromViewChange && theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n+      stats.incNodes(-1);\n+    }\n+    String msg;\n+    if (memberCrashed && !shouldInhibitMembershipWarnings()) {\n+      msg =\n+          \"Member at {} unexpectedly left the distributed cache: {}\";\n+      addMemberEvent(new MemberCrashedEvent(theId, reason));\n+    } else {\n+      msg =\n+          \"Member at {} gracefully left the distributed cache: {}\";\n+      addMemberEvent(new MemberDepartedEvent(theId, reason));\n+    }\n+    if (fromViewChange) {\n+      logger.info(msg, new Object[] {theId, prettifyReason(reason)});", "originalCommit": "c1b04ff3688d14ce69d65220c03c9541cdefedd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzOTE5MQ==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461839191", "bodyText": "If I move it out of the if statement it will log the departure on every invocation of this method, and I don't want to do that.  I think it will be confusing.", "author": "bschuchardt", "createdAt": "2020-07-28T19:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MjA2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NjU4OQ==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461886589", "bodyText": "I've simplified the method now, so it no longer has fromViewChange.  We'll be notifying listeners of departures when we get a shutdown message.  The subsequent view change won't trigger listener invocation.", "author": "bschuchardt", "createdAt": "2020-07-28T21:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MjA2Mw=="}], "type": "inlineReview"}, {"oid": "e63d7ab5e0ec8ea399b73afd873f0c3b4866433a", "url": "https://github.com/apache/geode/commit/e63d7ab5e0ec8ea399b73afd873f0c3b4866433a", "message": "simplified handleManagerDeparture & removed duplicate notifications\n\nFollowing Jianxia's advice and simplifying things.  Node counts\nwill now be decremented when we receive a shutdown message.  If\nwe don't get a shutdown message it will be decremented when the\nview changes.", "committedDate": "2020-07-28T21:02:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwODMyMA==", "url": "https://github.com/apache/geode/pull/5403#discussion_r461908320", "bodyText": "\ud83d\udc4d", "author": "jchen21", "createdAt": "2020-07-28T21:55:51Z", "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/GMSMembership.java", "diffHunk": "@@ -688,7 +688,11 @@ private void removeWithViewLock(ID dm, boolean crashed, String reason) {\n       return; // Explicit deletion, no upcall.\n     }\n \n-    listener.memberDeparted(dm, crashed, reason);\n+    if (!shutdownMembers.containsKey(dm)) {", "originalCommit": "e63d7ab5e0ec8ea399b73afd873f0c3b4866433a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}