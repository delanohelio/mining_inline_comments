{"pr_number": 5309, "pr_title": "GEODE-8250: Create new custom log config acceptance tests", "pr_createdAt": "2020-06-25T22:39:15Z", "pr_url": "https://github.com/apache/geode/pull/5309", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5ODYwNQ==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445898605", "bodyText": "startServerCommand?", "author": "jchen21", "createdAt": "2020-06-25T23:51:59Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/logging/ServerWithCustomLogConfigAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.logging;\n+\n+import static java.nio.file.Files.copy;\n+import static org.apache.geode.test.assertj.LogFileAssert.assertThat;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.apache.geode.test.util.ResourceUtils.createFileFromResource;\n+import static org.apache.geode.test.util.ResourceUtils.getResource;\n+\n+import java.nio.file.Path;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.junit.rules.TestName;\n+\n+import org.apache.geode.test.junit.rules.gfsh.GfshRule;\n+\n+public class ServerWithCustomLogConfigAcceptanceTest {\n+\n+  private static final String CONFIG_WITH_GEODE_PLUGINS_FILE_NAME =\n+      \"ServerWithCustomLogConfigAcceptanceTestWithGeodePlugins.xml\";\n+  private static final String CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME =\n+      \"ServerWithCustomLogConfigAcceptanceTestWithoutGeodePlugins.xml\";\n+\n+  private String serverName;\n+  private Path workingDir;\n+  private Path configWithGeodePluginsFile;\n+  private Path configWithoutGeodePluginsFile;\n+  private Path serverLogFile;\n+  private Path customLogFile;\n+  private TemporaryFolder temporaryFolder;\n+\n+  @Rule\n+  public GfshRule gfshRule = new GfshRule();\n+  @Rule\n+  public TestName testName = new TestName();\n+\n+  @Before\n+  public void setUpLogConfigFiles() {\n+    temporaryFolder = gfshRule.getTemporaryFolder();\n+\n+    configWithGeodePluginsFile = createFileFromResource(\n+        getResource(CONFIG_WITH_GEODE_PLUGINS_FILE_NAME), temporaryFolder.getRoot(),\n+        CONFIG_WITH_GEODE_PLUGINS_FILE_NAME)\n+            .toPath();\n+\n+    configWithoutGeodePluginsFile = createFileFromResource(\n+        getResource(CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME), temporaryFolder.getRoot(),\n+        CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME)\n+            .toPath();\n+  }\n+\n+  @Before\n+  public void setUpOutputFiles() {\n+    temporaryFolder = gfshRule.getTemporaryFolder();\n+\n+    serverName = testName.getMethodName();\n+\n+    workingDir = temporaryFolder.getRoot().toPath().toAbsolutePath();\n+    serverLogFile = workingDir.resolve(serverName + \".log\");\n+    customLogFile = workingDir.resolve(\"custom.log\");\n+  }\n+\n+  @Test\n+  public void serverLauncherUsesDefaultLoggingConfig() {\n+    String startLocatorCommand = String.join(\" \",", "originalCommit": "50ddbee271dac215f209e0577e04ecef0b9e88dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjAwOA==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445902008", "bodyText": "Delete RequiresGeodeHome", "author": "kirklund", "createdAt": "2020-06-26T00:04:18Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/management/internal/cli/commands/StartLocatorAcceptanceTest.java", "diffHunk": "@@ -14,43 +14,84 @@\n  */\n package org.apache.geode.management.internal.cli.commands;\n \n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.getTimeout;\n import static org.assertj.core.api.Assertions.assertThat;\n \n+import java.nio.file.Path;\n+\n+import org.junit.After;\n+import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n \n+import org.apache.geode.internal.AvailablePortHelper;\n+import org.apache.geode.test.junit.rules.RequiresGeodeHome;\n import org.apache.geode.test.junit.rules.gfsh.GfshExecution;\n import org.apache.geode.test.junit.rules.gfsh.GfshRule;\n import org.apache.geode.test.junit.rules.gfsh.GfshScript;\n \n public class StartLocatorAcceptanceTest {\n+\n+  private int locatorPort;\n+  private int httpServicePort;\n+  private Process locator;\n+  private Path geodeDependencies;\n+  private Path stdoutFile;\n+  private Path locatorLogFile;\n+  private Path pulseLogFile;\n+  private Path javaBin;\n+\n   @Rule\n   public GfshRule gfshRule = new GfshRule();\n+  @Rule\n+  public RequiresGeodeHome requiresGeodeHome = new RequiresGeodeHome();", "originalCommit": "9280ffa3702580af2e6db3ae6455727335e9de5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDExNQ==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445904115", "bodyText": "Wrong test", "author": "kirklund", "createdAt": "2020-06-26T00:12:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjEwNQ==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445902105", "bodyText": "Delete stopLocator(). I must've only removed these from the other test.", "author": "kirklund", "createdAt": "2020-06-26T00:04:41Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/management/internal/cli/commands/StartLocatorAcceptanceTest.java", "diffHunk": "@@ -14,43 +14,84 @@\n  */\n package org.apache.geode.management.internal.cli.commands;\n \n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.getTimeout;\n import static org.assertj.core.api.Assertions.assertThat;\n \n+import java.nio.file.Path;\n+\n+import org.junit.After;\n+import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n \n+import org.apache.geode.internal.AvailablePortHelper;\n+import org.apache.geode.test.junit.rules.RequiresGeodeHome;\n import org.apache.geode.test.junit.rules.gfsh.GfshExecution;\n import org.apache.geode.test.junit.rules.gfsh.GfshRule;\n import org.apache.geode.test.junit.rules.gfsh.GfshScript;\n \n public class StartLocatorAcceptanceTest {\n+\n+  private int locatorPort;\n+  private int httpServicePort;\n+  private Process locator;\n+  private Path geodeDependencies;\n+  private Path stdoutFile;\n+  private Path locatorLogFile;\n+  private Path pulseLogFile;\n+  private Path javaBin;\n+\n   @Rule\n   public GfshRule gfshRule = new GfshRule();\n+  @Rule\n+  public RequiresGeodeHome requiresGeodeHome = new RequiresGeodeHome();\n+  @Rule\n+  public TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\n+  @Before\n+  public void setUpRandomPorts() {\n+    int[] ports = AvailablePortHelper.getRandomAvailableTCPPorts(2);\n+    locatorPort = ports[0];\n+    httpServicePort = ports[1];\n+  }\n+\n+  @After\n+  public void stopLocator() throws Exception {", "originalCommit": "9280ffa3702580af2e6db3ae6455727335e9de5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDI2Nw==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445904267", "bodyText": "I reverted the unintended changes to this test.", "author": "kirklund", "createdAt": "2020-06-26T00:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMzIxNQ==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445903215", "bodyText": "Note: The workingDir for gfshScript is the workingDir for the GFSH process spawned by the JUnit test. GFSH then spawns the Locator and Server which is running in a subfolder. This change makes it easy for GfshRule to stop ALL Locators and Servers anywhere in the TemporaryFolder. Since only one gfshScript is executed at a time, the GFSH workingDir should be ok as temporaryFolder.getRoot().\nOn the off-chance that this does cause a problem, it would have to be for other GFSH commands that write something to the current workingDir of GFSH. I'm fairly confident we don't have tests that will have disk artifacts colliding just because of this little change.", "author": "kirklund", "createdAt": "2020-06-26T00:08:59Z", "path": "geode-junit/src/main/java/org/apache/geode/test/junit/rules/gfsh/GfshRule.java", "diffHunk": "@@ -145,9 +145,7 @@ public GfshExecution execute(GfshScript gfshScript, File workingDir) {\n \n   public GfshExecution execute(GfshScript gfshScript) {\n     try {\n-      File workingDir = new File(temporaryFolder.getRoot(), gfshScript.getName());\n-      workingDir.mkdirs();\n-      return execute(gfshScript, workingDir);\n+      return execute(gfshScript, temporaryFolder.getRoot());", "originalCommit": "9280ffa3702580af2e6db3ae6455727335e9de5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMDYzNA==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445930634", "bodyText": "so basically all scripts executed under the same gfshRule would use the same gfsh working dir instead of each execution has its own. I think this is a good change.", "author": "jinmeiliao", "createdAt": "2020-06-26T02:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMzIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NTgwNw==", "url": "https://github.com/apache/geode/pull/5309#discussion_r446475807", "bodyText": "Looks like your change made some other tests that uses gfshRule fail. Can I offer a different approach to fix your test only? This way you don't need to touch other tests and the gfshRule. I had one of your tests modified and put it on my repo so that it can compare with yours:\nkirklund@e88006e", "author": "jinmeiliao", "createdAt": "2020-06-27T02:56:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMzIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMzU0OQ==", "url": "https://github.com/apache/geode/pull/5309#discussion_r445903549", "bodyText": "I didn't mean to edit this class. Sigh.", "author": "kirklund", "createdAt": "2020-06-26T00:10:23Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/management/internal/cli/commands/StartLocatorAcceptanceTest.java", "diffHunk": "@@ -14,43 +14,84 @@\n  */\n package org.apache.geode.management.internal.cli.commands;\n \n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.getTimeout;\n import static org.assertj.core.api.Assertions.assertThat;\n \n+import java.nio.file.Path;\n+\n+import org.junit.After;\n+import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n \n+import org.apache.geode.internal.AvailablePortHelper;\n+import org.apache.geode.test.junit.rules.RequiresGeodeHome;\n import org.apache.geode.test.junit.rules.gfsh.GfshExecution;\n import org.apache.geode.test.junit.rules.gfsh.GfshRule;\n import org.apache.geode.test.junit.rules.gfsh.GfshScript;\n \n public class StartLocatorAcceptanceTest {", "originalCommit": "9280ffa3702580af2e6db3ae6455727335e9de5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0fa8b11737097e4a7ae02a4522fdb83ffa0dff7c", "url": "https://github.com/apache/geode/commit/0fa8b11737097e4a7ae02a4522fdb83ffa0dff7c", "message": "GEODE-8250: Create new custom log config acceptance tests", "committedDate": "2020-06-30T18:34:39Z", "type": "commit"}, {"oid": "5e06a7458182ba69e19e34b511816959557ce73d", "url": "https://github.com/apache/geode/commit/5e06a7458182ba69e19e34b511816959557ce73d", "message": "Remove empty locators property which breaks on Windows", "committedDate": "2020-06-30T18:34:39Z", "type": "commit"}, {"oid": "b068cdbd9eb0702ae2b60374b0a4752a83a582f0", "url": "https://github.com/apache/geode/commit/b068cdbd9eb0702ae2b60374b0a4752a83a582f0", "message": "Adjust GfshRule use of TemporaryFolder and use it", "committedDate": "2020-06-30T18:34:39Z", "type": "commit"}, {"oid": "1370fea8c02747aeb2309142452c6299cfdc7b60", "url": "https://github.com/apache/geode/commit/1370fea8c02747aeb2309142452c6299cfdc7b60", "message": "Fix some variables", "committedDate": "2020-06-30T18:34:39Z", "type": "commit"}, {"oid": "f8ff22cda44577d5ac2f3c2b623e59598f1a1356", "url": "https://github.com/apache/geode/commit/f8ff22cda44577d5ac2f3c2b623e59598f1a1356", "message": "Revert accidental changes to StartLocatorAcceptanceTest", "committedDate": "2020-06-30T18:34:39Z", "type": "commit"}, {"oid": "35a4440d5352f071bab73dbcbd4f80ce285967be", "url": "https://github.com/apache/geode/commit/35a4440d5352f071bab73dbcbd4f80ce285967be", "message": "Fixup failures involving GfshRule", "committedDate": "2020-06-30T18:34:39Z", "type": "commit"}, {"oid": "ada7b2d5619db872f216fbd9977191fda0a28b16", "url": "https://github.com/apache/geode/commit/ada7b2d5619db872f216fbd9977191fda0a28b16", "message": "Fix GfshRuleIntegrationTest pathing in StressNewTest", "committedDate": "2020-06-30T18:34:39Z", "type": "commit"}, {"oid": "fe762253b1902dabc0e71af80e9233e480ed4ec3", "url": "https://github.com/apache/geode/commit/fe762253b1902dabc0e71af80e9233e480ed4ec3", "message": "Fixup GfshRuleIntegrationTest, VersionManager, and VersionManagerJUnitTest", "committedDate": "2020-06-30T18:37:47Z", "type": "commit"}, {"oid": "58e75df3962257d492dcf59a7dfeb95ea44556bc", "url": "https://github.com/apache/geode/commit/58e75df3962257d492dcf59a7dfeb95ea44556bc", "message": "Add geode-old-versions to integrationTests", "committedDate": "2020-06-30T18:37:49Z", "type": "commit"}, {"oid": "8c1395ca067f1f08ce8ceeb4c6c9ea660614dff5", "url": "https://github.com/apache/geode/commit/8c1395ca067f1f08ce8ceeb4c6c9ea660614dff5", "message": "Print directory tree under bellsoft java", "committedDate": "2020-06-30T18:37:49Z", "type": "commit"}, {"oid": "9a36fb7c3cd12339bdb5a7ea3d45d5cb4cadc95f", "url": "https://github.com/apache/geode/commit/9a36fb7c3cd12339bdb5a7ea3d45d5cb4cadc95f", "message": "Use System.out to print directory tree", "committedDate": "2020-06-30T18:37:49Z", "type": "commit"}, {"oid": "481271a7db51da6188251be9d49638c30ff21671", "url": "https://github.com/apache/geode/commit/481271a7db51da6188251be9d49638c30ff21671", "message": "Debugging", "committedDate": "2020-06-30T18:37:49Z", "type": "commit"}, {"oid": "481271a7db51da6188251be9d49638c30ff21671", "url": "https://github.com/apache/geode/commit/481271a7db51da6188251be9d49638c30ff21671", "message": "Debugging", "committedDate": "2020-06-30T18:37:49Z", "type": "forcePushed"}, {"oid": "44dc405858a08ea0e3a22d18eaebdef4a268a23f", "url": "https://github.com/apache/geode/commit/44dc405858a08ea0e3a22d18eaebdef4a268a23f", "message": "Fix spotless format", "committedDate": "2020-06-30T21:10:56Z", "type": "commit"}, {"oid": "5479845849c4deeaabf946280410bd3656e4a0b6", "url": "https://github.com/apache/geode/commit/5479845849c4deeaabf946280410bd3656e4a0b6", "message": "Fixup", "committedDate": "2020-07-01T17:52:21Z", "type": "commit"}]}