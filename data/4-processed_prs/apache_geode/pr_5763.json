{"pr_number": 5763, "pr_title": "GEODE-8521: detect if a p2p reader thread is hung", "pr_createdAt": "2020-11-19T21:13:09Z", "pr_url": "https://github.com/apache/geode/pull/5763", "timeline": [{"oid": "d88c69b10d7348fb1de855c04df4df8ca09c175b", "url": "https://github.com/apache/geode/commit/d88c69b10d7348fb1de855c04df4df8ca09c175b", "message": "minor cleanup of thread monitoring code:\n  -- made some fields final\n  -- removed unused parameters\n  -- marked some methods visible for testing", "committedDate": "2020-11-18T19:11:13Z", "type": "commit"}, {"oid": "90dc93e091b331dd20b90f62a5393cced9d52b33", "url": "https://github.com/apache/geode/commit/90dc93e091b331dd20b90f62a5393cced9d52b33", "message": "added createAbstractExecutor, startMonitoring, and stopMonitoring", "committedDate": "2020-11-18T21:50:39Z", "type": "commit"}, {"oid": "7fa49c13267c332d4700fedba3ce501aac1765ca", "url": "https://github.com/apache/geode/commit/7fa49c13267c332d4700fedba3ce501aac1765ca", "message": "Merge branch 'develop' into GEODE-8521", "committedDate": "2020-11-19T19:05:18Z", "type": "commit"}, {"oid": "68bcf2f840b86052dff0d42011da9b149eab1475", "url": "https://github.com/apache/geode/commit/68bcf2f840b86052dff0d42011da9b149eab1475", "message": "p2p reader threads are now monitored while processing a message", "committedDate": "2020-11-19T21:03:05Z", "type": "commit"}, {"oid": "851268ecf5cf65dd9943b817fc399d681d3d6147", "url": "https://github.com/apache/geode/commit/851268ecf5cf65dd9943b817fc399d681d3d6147", "message": "fixed ConnectionTest", "committedDate": "2020-11-19T22:11:08Z", "type": "commit"}, {"oid": "36c7ac0761806f6e2542c538f3f886820a50a30b", "url": "https://github.com/apache/geode/commit/36c7ac0761806f6e2542c538f3f886820a50a30b", "message": "force rebuild", "committedDate": "2020-11-20T00:03:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTEyNw==", "url": "https://github.com/apache/geode/pull/5763#discussion_r527801127", "bodyText": "I'm a little concerned about the impact of taking yet another millisecond clock reading on every message that we dispatch.  This should be run through extensive performance testing before merging it to develop.", "author": "bschuchardt", "createdAt": "2020-11-20T16:18:23Z", "path": "geode-core/src/main/java/org/apache/geode/internal/monitoring/ThreadsMonitoringImpl.java", "diffHunk": "@@ -96,39 +98,60 @@ public void updateThreadStatus() {\n \n   @Override\n   public boolean startMonitor(Mode mode) {\n-    AbstractExecutor absExtgroup;\n+    return startMonitoring(createAbstractExecutor(mode));\n+  }\n+\n+  @Override\n+  public void endMonitor() {\n+    this.monitorMap.remove(Thread.currentThread().getId());\n+  }\n+\n+  @VisibleForTesting\n+  boolean isMonitoring() {\n+    return monitorMap.containsKey(Thread.currentThread().getId());\n+  }\n+\n+  @Override\n+  public AbstractExecutor createAbstractExecutor(Mode mode) {\n     switch (mode) {\n       case FunctionExecutor:\n-        absExtgroup = new FunctionExecutionPooledExecutorGroup(this);\n-        break;\n+        return new FunctionExecutionPooledExecutorGroup();\n       case PooledExecutor:\n-        absExtgroup = new PooledExecutorGroup(this);\n-        break;\n+        return new PooledExecutorGroup();\n       case SerialQueuedExecutor:\n-        absExtgroup = new SerialQueuedExecutorGroup(this);\n-        break;\n+        return new SerialQueuedExecutorGroup();\n       case OneTaskOnlyExecutor:\n-        absExtgroup = new OneTaskOnlyExecutorGroup(this);\n-        break;\n+        return new OneTaskOnlyExecutorGroup();\n       case ScheduledThreadExecutor:\n-        absExtgroup = new ScheduledThreadPoolExecutorWKAGroup(this);\n-        break;\n+        return new ScheduledThreadPoolExecutorWKAGroup();\n       case AGSExecutor:\n-        absExtgroup = new GatewaySenderEventProcessorGroup(this);\n-        break;\n+        return new GatewaySenderEventProcessorGroup();\n+      case P2PReaderExecutor:\n+        return new P2PReaderExecutorGroup();\n       default:\n-        return false;\n+        throw new IllegalStateException(\"Unhandled mode=\" + mode);\n     }\n-    this.monitorMap.put(Thread.currentThread().getId(), absExtgroup);\n+  }\n+\n+  @Override\n+  public boolean startMonitoring(AbstractExecutor executor) {\n+    executor.setStartTime(System.currentTimeMillis());", "originalCommit": "36c7ac0761806f6e2542c538f3f886820a50a30b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgzODI1NQ==", "url": "https://github.com/apache/geode/pull/5763#discussion_r527838255", "bodyText": "I had the same thought. I was even concerned about constantly adding and removing from the concurrent map. We could just use the frequency of the monitor thread to do the time work. For example if it finds an AbstractExecutor in the map that it has not seen before then the monitor thread could set the time it first saw it. If later monitor samples see it again it could use this time (i.e. the one the monitor set) to determine if it is stuck. This could even be done without timestamps. Just a simple counter the monitor incs and the p2p reader thread clears. If the monitor thread is waking up at a fixed interval then you know the thread has been stuck for at least that much time. I like your idea of having custom code in P2PReaderExecutorGroup for this. When I was thinking about it I thought I would need to change the behavior of all the existing threads being monitored. Thanks for the feedback!", "author": "dschneider-pivotal", "createdAt": "2020-11-20T17:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1OTQxMQ==", "url": "https://github.com/apache/geode/pull/5763#discussion_r527859411", "bodyText": "I converted back to draft mode. Will rework this and submit it again.", "author": "dschneider-pivotal", "createdAt": "2020-11-20T17:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMzE4NQ==", "url": "https://github.com/apache/geode/pull/5763#discussion_r527913185", "bodyText": "having the monitor thread set the time is a good idea.  Another thing you could do is have the Monitor thread record the current time when it wakes up and use that for new entries in the map.  GMSHealthMonitor's monitor thread does something like that.", "author": "bschuchardt", "createdAt": "2020-11-20T19:04:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAxMTYxOA==", "url": "https://github.com/apache/geode/pull/5763#discussion_r528011618", "bodyText": "the p2p reader now simply sets a volatile boolean before and after messageDispatch.\nthe startTime for a p2p reader will now be set by the monitor thread.\nLet me know what you think", "author": "dschneider-pivotal", "createdAt": "2020-11-20T22:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTEyNw=="}], "type": "inlineReview"}, {"oid": "b811a67f2a5e9dee1b8490d5f329a06ddd48e816", "url": "https://github.com/apache/geode/commit/b811a67f2a5e9dee1b8490d5f329a06ddd48e816", "message": "AbstractExecutor can now be suspended and resumed.\nThis does nothing on the base class but on P2PReaderExecutorGroup\nit turns monitoring on and off.\nAlso the monitor thread will now detect a zero startTime\nand in that case set the startTime allowing threads being\nmonitored to not keep setting it themselves (which happens more often).", "committedDate": "2020-11-20T20:58:29Z", "type": "commit"}, {"oid": "c3fe7aa5e41efad318e5703e62a38e466066a28b", "url": "https://github.com/apache/geode/commit/c3fe7aa5e41efad318e5703e62a38e466066a28b", "message": "added integration test coverage for suspend and resume", "committedDate": "2020-11-20T21:57:34Z", "type": "commit"}, {"oid": "5300197fae8574a05d3277e72468b4b5667128a6", "url": "https://github.com/apache/geode/commit/5300197fae8574a05d3277e72468b4b5667128a6", "message": "1. the timeInterval and timeLimit that come from gemfire properties\nwill now always be the values configured on the DistributedSystem.\nPreviously the thread monitoring classes had their own instance of\nDistributionConfigImpl which at least in some cases could be inconsistent\nthe the config on the DistributedSystem. Now these two config values\nare passed in to the constructor.\n2. If an instance of ResourceManagerStats can not be found then\nit will now only prevent the monitor from updating the \"numThreadsStuck\"\nstat. Before it prevented it from doing any detection and logging.\nThe lazy initialization of the ResourceManagerStats is now cleaner and does\nnot require the integration test to explicitly call run().", "committedDate": "2020-11-20T22:41:00Z", "type": "commit"}, {"oid": "23d4ee647cfd70db6de82317e0471775373889a1", "url": "https://github.com/apache/geode/commit/23d4ee647cfd70db6de82317e0471775373889a1", "message": "fixed ConnectionTest", "committedDate": "2020-11-20T23:11:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Mzg0Nw==", "url": "https://github.com/apache/geode/pull/5763#discussion_r532763847", "bodyText": "What unit is timeLimit? I recommend either adding a TimeUnit parameter or renaming timeLimit to include Millis or something as a prefix.", "author": "kirklund", "createdAt": "2020-11-30T17:17:36Z", "path": "geode-core/src/main/java/org/apache/geode/internal/monitoring/ThreadsMonitoringProcess.java", "diffHunk": "@@ -33,73 +31,86 @@\n \n public class ThreadsMonitoringProcess extends TimerTask {\n \n-  private final ThreadsMonitoring threadsMonitoring;\n-  private ResourceManagerStats resourceManagerStats = null;\n   private static final Logger logger = LogService.getLogger();\n+\n+  private final ThreadsMonitoring threadsMonitoring;\n   private final int timeLimit;\n   private final InternalDistributedSystem internalDistributedSystem;\n \n-  private final Properties nonDefault = new Properties();\n-  private final DistributionConfigImpl distributionConfigImpl =\n-      new DistributionConfigImpl(nonDefault);\n+  private ResourceManagerStats resourceManagerStats = null;\n \n   protected ThreadsMonitoringProcess(ThreadsMonitoring tMonitoring,\n-      InternalDistributedSystem iDistributedSystem) {\n-    this.timeLimit = this.distributionConfigImpl.getThreadMonitorTimeLimit();\n+      InternalDistributedSystem iDistributedSystem, int timeLimit) {", "originalCommit": "23d4ee647cfd70db6de82317e0471775373889a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMDc1Mg==", "url": "https://github.com/apache/geode/pull/5763#discussion_r532930752", "bodyText": "I changed the name to timeLimitMillis. This unit is determined by an external geode property so it will always be milliseconds", "author": "dschneider-pivotal", "createdAt": "2020-11-30T21:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Mzg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NTcyOA==", "url": "https://github.com/apache/geode/pull/5763#discussion_r532765728", "bodyText": "Please indicate the units of measure in the name or an additional parameter.", "author": "kirklund", "createdAt": "2020-11-30T17:20:22Z", "path": "geode-core/src/test/java/org/apache/geode/internal/monitoring/ThreadsMonitoringProcessJUnitTest.java", "diffHunk": "@@ -34,11 +31,13 @@\n  */\n public class ThreadsMonitoringProcessJUnitTest {\n \n+  private static final int TIME_LIMIT = 1000;", "originalCommit": "23d4ee647cfd70db6de82317e0471775373889a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMDgxMg==", "url": "https://github.com/apache/geode/pull/5763#discussion_r532930812", "bodyText": "done", "author": "dschneider-pivotal", "createdAt": "2020-11-30T21:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NTcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NjkzNg==", "url": "https://github.com/apache/geode/pull/5763#discussion_r532766936", "bodyText": "I recommend just naming unit tests as P2PReaderExecutorGroupTest (no need to include JUnit)", "author": "kirklund", "createdAt": "2020-11-30T17:22:08Z", "path": "geode-core/src/test/java/org/apache/geode/internal/monitoring/executor/P2PReaderExecutorGroupJUnitTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.internal.monitoring.executor;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.Test;\n+\n+public class P2PReaderExecutorGroupJUnitTest {", "originalCommit": "23d4ee647cfd70db6de82317e0471775373889a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyOTk0Mg==", "url": "https://github.com/apache/geode/pull/5763#discussion_r532929942", "bodyText": "done", "author": "dschneider-pivotal", "createdAt": "2020-11-30T21:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NjkzNg=="}], "type": "inlineReview"}, {"oid": "09e06edbaeb63aa5bf3ec88142913453998beb63", "url": "https://github.com/apache/geode/commit/09e06edbaeb63aa5bf3ec88142913453998beb63", "message": "renamed P2PReaderExecutorGroupJUnitTest to P2PReaderExecutorGroupTest", "committedDate": "2020-11-30T21:49:43Z", "type": "commit"}, {"oid": "9b165404628c78bafb610b0db64409a3a41b4f15", "url": "https://github.com/apache/geode/commit/9b165404628c78bafb610b0db64409a3a41b4f15", "message": "added \"Millis\" time unit designator to names", "committedDate": "2020-11-30T21:56:48Z", "type": "commit"}, {"oid": "4a10707cfc4bac8f7665d287578027c8cd601290", "url": "https://github.com/apache/geode/commit/4a10707cfc4bac8f7665d287578027c8cd601290", "message": "Merge branch 'develop' into GEODE-8521", "committedDate": "2020-11-30T22:13:15Z", "type": "commit"}, {"oid": "8f9372b03f36d5b723fee70342cfb0d8c702ca8a", "url": "https://github.com/apache/geode/commit/8f9372b03f36d5b723fee70342cfb0d8c702ca8a", "message": "split unit test method into two methods", "committedDate": "2020-11-30T22:32:30Z", "type": "commit"}, {"oid": "d8c3e1a51067721f1564f36b0cf66680ff3ac311", "url": "https://github.com/apache/geode/commit/d8c3e1a51067721f1564f36b0cf66680ff3ac311", "message": "fixed flaky ThreadsMonitoringImplJUnitTest which would fail\nsometimes due to it creating a background thread that could\ninterfere with unit testing.", "committedDate": "2020-11-30T23:05:09Z", "type": "commit"}, {"oid": "cf7e2cc297b65b487de82c4d109b6add42ad3a57", "url": "https://github.com/apache/geode/commit/cf7e2cc297b65b487de82c4d109b6add42ad3a57", "message": "Merge branch 'develop' into GEODE-8521", "committedDate": "2020-12-01T01:15:56Z", "type": "commit"}, {"oid": "998359387e1df4775a75f4f1039a16b3547ff771", "url": "https://github.com/apache/geode/commit/998359387e1df4775a75f4f1039a16b3547ff771", "message": "removed some unneeded explicit \"this\" references", "committedDate": "2020-12-01T17:23:35Z", "type": "commit"}, {"oid": "38d3882b180bfe9c2d77775fa52a703fd8487616", "url": "https://github.com/apache/geode/commit/38d3882b180bfe9c2d77775fa52a703fd8487616", "message": "Merge branch 'develop' into GEODE-8521", "committedDate": "2020-12-01T17:24:21Z", "type": "commit"}, {"oid": "bce5cd75a2e6ff20aac1d02986838456ff8a6eb9", "url": "https://github.com/apache/geode/commit/bce5cd75a2e6ff20aac1d02986838456ff8a6eb9", "message": "Merge branch 'develop' into GEODE-8521", "committedDate": "2020-12-03T22:09:28Z", "type": "commit"}]}