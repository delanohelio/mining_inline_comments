{"pr_number": 5732, "pr_title": "GEODE-8694: use redis tests with patch", "pr_createdAt": "2020-11-11T19:39:21Z", "pr_url": "https://github.com/apache/geode/pull/5732", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYzNzIyOQ==", "url": "https://github.com/apache/geode/pull/5732#discussion_r521637229", "bodyText": "We should change this port back to 6379 (since the Geode Redis server without a password is started on 6379, which is why we get the error Executing test client: NOAUTH Authentication required in the RedisTests)", "author": "sabbey37", "createdAt": "2020-11-11T21:03:55Z", "path": "ci/scripts/execute_redis_tests.sh", "diffHunk": "@@ -49,8 +51,8 @@ failCount=0\n   --redis-port=6379 \\\n   --redis-bind-address=127.0.0.1\n \n-./runtest --host 127.0.0.1 --port 6379 --single unit/type/set --single unit/expire \\\n---single unit/type/hash --single unit/type/string --single unit/type/srandmember \\\n+./runtest --host 127.0.0.1 --port 6380 --single unit/type/set --single unit/expire \\", "originalCommit": "0987548470982fe8e2fd42f2784e8a3bd3c2800a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYzNzQ1MQ==", "url": "https://github.com/apache/geode/pull/5732#discussion_r521637451", "bodyText": "Change this back to 0", "author": "sabbey37", "createdAt": "2020-11-11T21:04:17Z", "path": "geode-redis/src/commonTest/java/org/apache/geode/redis/GeodeRedisServerRule.java", "diffHunk": "@@ -43,7 +43,7 @@ public GeodeRedisServerRule() {\n   @Override\n   protected void before() {\n     cache = cacheFactory.create();\n-    server = new GeodeRedisServer(\"localhost\", 0, (InternalCache) cache);\n+    server = new GeodeRedisServer(\"localhost\", 6380, (InternalCache) cache);", "originalCommit": "0987548470982fe8e2fd42f2784e8a3bd3c2800a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYzNzU1NQ==", "url": "https://github.com/apache/geode/pull/5732#discussion_r521637555", "bodyText": "This should be ignored (and is why the Integration Tests and Stress New Test timed out).", "author": "sabbey37", "createdAt": "2020-11-11T21:04:28Z", "path": "geode-redis/src/integrationTest/java/org/apache/geode/redis/internal/GeodeServerRunTest.java", "diffHunk": "@@ -29,7 +28,8 @@\n   public static GeodeRedisServerRule server = new GeodeRedisServerRule();\n \n   @Test\n-  @Ignore(\"This is a no-op test to conveniently run redis api for geode server for local development/testing purposes\")", "originalCommit": "0987548470982fe8e2fd42f2784e8a3bd3c2800a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0MDMzMw==", "url": "https://github.com/apache/geode/pull/5732#discussion_r521640333", "bodyText": "Correct me if I'm missing something, but I don't think the tests-geode-redis branch is in the redis repo.  We could check out the 5.0 branch.  Have you tried this sequence locally with a fresh clone of the redis repo that doesn't have any local branches/branches from other forks?", "author": "sabbey37", "createdAt": "2020-11-11T21:10:07Z", "path": "ci/scripts/execute_redis_tests.sh", "diffHunk": "@@ -19,12 +19,14 @@\n \n cd ..\n \n-# We are currently using a personal fork for this repo because our code does not implement all\n+# We are currently using a patched version of this repo because our code does not implement all\n # Redis commands.  Once all commands needed to run relevant test files are implemented, we hope to\n-# use Redis's repo instead.\n-git clone --config transfer.fsckObjects=false https://github.com/prettyClouds/redis.git\n+# use Redis's repo without a patch.\n+git clone --config transfer.fsckObjects=false https://github.com/redis/redis.git\n+cp geode-redis/src/acceptanceTest/resources/0001-configure-redis-tests.patch redis\n cd redis\n git checkout tests-geode-redis", "originalCommit": "0987548470982fe8e2fd42f2784e8a3bd3c2800a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "18fa75b0e3a0ad91665fa9c4db14bb3a66c8d3a1", "url": "https://github.com/apache/geode/commit/18fa75b0e3a0ad91665fa9c4db14bb3a66c8d3a1", "message": "GEODE-8694: use redis tests with patch\n\nuse the redis/redis repo's test with a patch containing changes to tests\nthat fail on unimplemented commands when testing geode-redis.", "committedDate": "2020-11-12T18:37:26Z", "type": "forcePushed"}, {"oid": "2642787eb54e07e1f562a547b34f82cc04b7c4b9", "url": "https://github.com/apache/geode/commit/2642787eb54e07e1f562a547b34f82cc04b7c4b9", "message": "GEODE-8694: use redis tests with patch\n\nuse the redis/redis repo's test with a patch containing changes to tests\nthat fail on unimplemented commands when testing geode-redis.", "committedDate": "2020-11-12T18:41:11Z", "type": "commit"}, {"oid": "2642787eb54e07e1f562a547b34f82cc04b7c4b9", "url": "https://github.com/apache/geode/commit/2642787eb54e07e1f562a547b34f82cc04b7c4b9", "message": "GEODE-8694: use redis tests with patch\n\nuse the redis/redis repo's test with a patch containing changes to tests\nthat fail on unimplemented commands when testing geode-redis.", "committedDate": "2020-11-12T18:41:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NDQ0OQ==", "url": "https://github.com/apache/geode/pull/5732#discussion_r522374449", "bodyText": "It seems like the application of the patch is failing.  Could be related to this error:\n*** Please tell me who you are.\n\nRun\n\n  git config --global user.email \"you@example.com\"\n  git config --global user.name \"Your Name\"\n\nto set your account's default identity.\nOmit --global to set the identity only in this repository.\n\nfatal: empty ident name (for <geode@heavy-lifter-bc46dab9-e3b2-587d-b59e-a07a7b894615.c.apachegeode-ci.internal>) not allowed\n\n...though I tried removing my git credentials and running it locally with a fresh clone of redis and it worked.  Maybe an identity is required to apply a patch on heavy-lifter?", "author": "sabbey37", "createdAt": "2020-11-12T19:41:43Z", "path": "ci/scripts/execute_redis_tests.sh", "diffHunk": "@@ -19,12 +19,14 @@\n \n cd ..\n \n-# We are currently using a personal fork for this repo because our code does not implement all\n+# We are currently using a patched version of this repo because our code does not implement all\n # Redis commands.  Once all commands needed to run relevant test files are implemented, we hope to\n-# use Redis's repo instead.\n-git clone --config transfer.fsckObjects=false https://github.com/prettyClouds/redis.git\n+# use Redis's repo without a patch.\n+git clone --config transfer.fsckObjects=false https://github.com/redis/redis.git\n+cp geode-redis/src/acceptanceTest/resources/0001-configure-redis-tests.patch redis\n cd redis\n-git checkout tests-geode-redis\n+git checkout origin/5.0\n+git am < 0001-configure-redis-tests.patch", "originalCommit": "2642787eb54e07e1f562a547b34f82cc04b7c4b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzMzk4OQ==", "url": "https://github.com/apache/geode/pull/5732#discussion_r522433989", "bodyText": "Ok, after hijacking the job in the pipeline, if you set\ngit config --global user.email \"you@example.com\"\ngit config --global user.name \"Your Name\"\n\nbefore trying to apply the patch, it will be applied successfully.  Not sure what you should set it to though?\n..you could also just use git apply instead of git am, and I think you wouldn't have to set the user or email that way.", "author": "sabbey37", "createdAt": "2020-11-12T21:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NDQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY0NTA0OQ==", "url": "https://github.com/apache/geode/pull/5732#discussion_r524645049", "bodyText": "thanks @sabbey37! I'll do some more testing on that", "author": "nonbinaryprogrammer", "createdAt": "2020-11-16T21:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NDQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYxNzY1NA==", "url": "https://github.com/apache/geode/pull/5732#discussion_r525617654", "bodyText": "Switched to using git apply which obviates the need to configure an email.", "author": "jdeppe-pivotal", "createdAt": "2020-11-18T00:35:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NDQ0OQ=="}], "type": "inlineReview"}, {"oid": "f4e727f307ba8f6f5f2d175e3ef1d8b5b3300bfe", "url": "https://github.com/apache/geode/commit/f4e727f307ba8f6f5f2d175e3ef1d8b5b3300bfe", "message": "Use git apply instead of git am to apply the patch", "committedDate": "2020-11-17T19:54:29Z", "type": "commit"}, {"oid": "5b580b73ff2b8d0a80ff8c896ec4a6257ac31e9c", "url": "https://github.com/apache/geode/commit/5b580b73ff2b8d0a80ff8c896ec4a6257ac31e9c", "message": "Trigger CI", "committedDate": "2020-11-17T20:58:22Z", "type": "commit"}]}