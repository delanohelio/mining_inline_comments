{"pr_number": 5447, "pr_title": "Changes to help reduce the occurence of GEODE-8422", "pr_createdAt": "2020-08-11T17:47:54Z", "pr_url": "https://github.com/apache/geode/pull/5447", "timeline": [{"oid": "9923f2c72e36917952d8d4c03f1602db9ada6da2", "url": "https://github.com/apache/geode/commit/9923f2c72e36917952d8d4c03f1602db9ada6da2", "message": "Changes to help reduce the occurence of GEODE-8422", "committedDate": "2020-08-11T18:19:44Z", "type": "commit"}, {"oid": "e48a21aa0510de226f1e861184a9f9c71109ca8b", "url": "https://github.com/apache/geode/commit/e48a21aa0510de226f1e861184a9f9c71109ca8b", "message": "Putting back Gester's changes.", "committedDate": "2020-08-11T18:19:44Z", "type": "commit"}, {"oid": "e48a21aa0510de226f1e861184a9f9c71109ca8b", "url": "https://github.com/apache/geode/commit/e48a21aa0510de226f1e861184a9f9c71109ca8b", "message": "Putting back Gester's changes.", "committedDate": "2020-08-11T18:19:44Z", "type": "forcePushed"}, {"oid": "a6daf43114cb6797fa4059af65f5b1bec1e3852a", "url": "https://github.com/apache/geode/commit/a6daf43114cb6797fa4059af65f5b1bec1e3852a", "message": "reversing a change to compare gcversions.", "committedDate": "2020-08-11T22:19:21Z", "type": "commit"}, {"oid": "3266619e38f078716b2e26702f853b259eba35aa", "url": "https://github.com/apache/geode/commit/3266619e38f078716b2e26702f853b259eba35aa", "message": "slight change.", "committedDate": "2020-08-12T01:43:26Z", "type": "commit"}, {"oid": "73cd21ca3fadfd16e8154210464ebdce45229f74", "url": "https://github.com/apache/geode/commit/73cd21ca3fadfd16e8154210464ebdce45229f74", "message": "GEODE-8422: Adding unit test\n\n- Added a unit test for the case where we don't want\nto remove a tombstone with the region is not initialized.", "committedDate": "2020-08-12T18:47:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3MTc4MQ==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469471781", "bodyText": "This method is empty and can be removed.", "author": "DonalEvans", "createdAt": "2020-08-12T18:53:26Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/TombstoneServiceTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.geode.internal.cache;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.ExecutorService;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import org.apache.geode.CancelCriterion;\n+import org.apache.geode.cache.DataPolicy;\n+import org.apache.geode.distributed.internal.CacheTime;\n+import org.apache.geode.internal.cache.versions.RegionVersionVector;\n+import org.apache.geode.internal.cache.versions.VersionTag;\n+\n+public class TombstoneServiceTest {\n+  CacheTime cacheTime = mock(CacheTime.class);\n+  CachePerfStats stats = mock(CachePerfStats.class);\n+  CancelCriterion cancelCriterion = mock(CancelCriterion.class);\n+  ExecutorService executor = mock(ExecutorService.class);\n+  RegionMap regionMap = mock(RegionMap.class);\n+  RegionEntry entry = mock(RegionEntry.class);\n+  DistributedRegion region = mock(DistributedRegion.class);\n+  VersionTag destroyedVersion = mock(VersionTag.class);\n+\n+  @Before\n+  public void setUp() throws Exception {}\n+\n+  @After\n+  public void tearDown() throws Exception {}", "originalCommit": "73cd21ca3fadfd16e8154210464ebdce45229f74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUzODk1Ng==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469538956", "bodyText": "Done", "author": "mhansonp", "createdAt": "2020-08-12T20:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3MTc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3MjgyNg==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469472826", "bodyText": "The creation and assignment of the mocks should be moved to the setUp() method to ensure that fresh mocks are created for each test method and hence prevent multiple tests acting on the same instance of a mock and producing unexpected results.", "author": "DonalEvans", "createdAt": "2020-08-12T18:55:14Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/TombstoneServiceTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.geode.internal.cache;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.ExecutorService;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import org.apache.geode.CancelCriterion;\n+import org.apache.geode.cache.DataPolicy;\n+import org.apache.geode.distributed.internal.CacheTime;\n+import org.apache.geode.internal.cache.versions.RegionVersionVector;\n+import org.apache.geode.internal.cache.versions.VersionTag;\n+\n+public class TombstoneServiceTest {\n+  CacheTime cacheTime = mock(CacheTime.class);\n+  CachePerfStats stats = mock(CachePerfStats.class);\n+  CancelCriterion cancelCriterion = mock(CancelCriterion.class);\n+  ExecutorService executor = mock(ExecutorService.class);\n+  RegionMap regionMap = mock(RegionMap.class);\n+  RegionEntry entry = mock(RegionEntry.class);\n+  DistributedRegion region = mock(DistributedRegion.class);\n+  VersionTag destroyedVersion = mock(VersionTag.class);\n+\n+  @Before\n+  public void setUp() throws Exception {}", "originalCommit": "73cd21ca3fadfd16e8154210464ebdce45229f74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUzOTAxMQ==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469539011", "bodyText": "Done", "author": "mhansonp", "createdAt": "2020-08-12T20:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3MjgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3NDgzMg==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469474832", "bodyText": "For these verifications, would it be reasonable to assert the specific number of invocations of getVersionVector() and recordGCVersion() we expect to see using Mockito.times(1) rather than just that it's at least one?", "author": "DonalEvans", "createdAt": "2020-08-12T18:58:58Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/TombstoneServiceTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.geode.internal.cache;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.concurrent.ExecutorService;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import org.apache.geode.CancelCriterion;\n+import org.apache.geode.cache.DataPolicy;\n+import org.apache.geode.distributed.internal.CacheTime;\n+import org.apache.geode.internal.cache.versions.RegionVersionVector;\n+import org.apache.geode.internal.cache.versions.VersionTag;\n+\n+public class TombstoneServiceTest {\n+  CacheTime cacheTime = mock(CacheTime.class);\n+  CachePerfStats stats = mock(CachePerfStats.class);\n+  CancelCriterion cancelCriterion = mock(CancelCriterion.class);\n+  ExecutorService executor = mock(ExecutorService.class);\n+  RegionMap regionMap = mock(RegionMap.class);\n+  RegionEntry entry = mock(RegionEntry.class);\n+  DistributedRegion region = mock(DistributedRegion.class);\n+  VersionTag destroyedVersion = mock(VersionTag.class);\n+\n+  @Before\n+  public void setUp() throws Exception {}\n+\n+  @After\n+  public void tearDown() throws Exception {}\n+\n+  @Test\n+  public void validateThatRemoveIsNotCalledOnTombstoneInRegionThatIsNotInitialized() {\n+\n+    when(region.isInitialized()).thenReturn(false);\n+    when(region.getRegionMap()).thenReturn(regionMap);\n+    TombstoneService.ReplicateTombstoneSweeper replicateTombstoneSweeper =\n+        new TombstoneService.ReplicateTombstoneSweeper(cacheTime, stats,\n+            cancelCriterion, executor);\n+    TombstoneService.Tombstone tombstone =\n+        new TombstoneService.Tombstone(entry, region, destroyedVersion);\n+    tombstone.entry = entry;\n+\n+    replicateTombstoneSweeper.expireTombstone(tombstone);\n+    replicateTombstoneSweeper.expireBatch();\n+    verify(regionMap, Mockito.never()).removeTombstone(tombstone.entry, destroyedVersion, false,\n+        true);\n+  }\n+\n+  @Test\n+  public void validateThatRemoveIsCalledOnTombstoneInRegionThatIsInitialized() {\n+    RegionVersionVector regionVersionVector = mock(RegionVersionVector.class);\n+\n+    when(region.isInitialized()).thenReturn(true);\n+    when(region.getRegionMap()).thenReturn(regionMap);\n+    when(region.getVersionVector()).thenReturn(regionVersionVector);\n+    when(region.getDataPolicy()).thenReturn(DataPolicy.PERSISTENT_REPLICATE);\n+    when(region.getDiskRegion()).thenReturn(mock(DiskRegion.class));\n+\n+    TombstoneService.ReplicateTombstoneSweeper replicateTombstoneSweeper =\n+        new TombstoneService.ReplicateTombstoneSweeper(cacheTime, stats,\n+            cancelCriterion, executor);\n+    TombstoneService.Tombstone tombstone =\n+        new TombstoneService.Tombstone(entry, region, destroyedVersion);\n+    tombstone.entry = entry;\n+\n+    replicateTombstoneSweeper.expireTombstone(tombstone);\n+    replicateTombstoneSweeper.expireBatch();\n+    verify(region, Mockito.atLeastOnce()).getVersionVector();\n+    verify(regionVersionVector, Mockito.atLeastOnce()).recordGCVersion(tombstone.getMemberID(),", "originalCommit": "73cd21ca3fadfd16e8154210464ebdce45229f74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU1NDMxMw==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469554313", "bodyText": "changed the code to actually check a call to removeTombstone which is what we really care about. Using times 1 now.", "author": "mhansonp", "createdAt": "2020-08-12T21:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3NDgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUzNDU3OA==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469534578", "bodyText": "please include the standard apache copyright header", "author": "onichols-pivotal", "createdAt": "2020-08-12T20:42:14Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/TombstoneServiceTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.geode.internal.cache;", "originalCommit": "73cd21ca3fadfd16e8154210464ebdce45229f74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU1NDg4OA==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469554888", "bodyText": "done.", "author": "mhansonp", "createdAt": "2020-08-12T21:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUzNDU3OA=="}], "type": "inlineReview"}, {"oid": "975cc84c5670c41b2b0d23f7cef4928f989bfaaf", "url": "https://github.com/apache/geode/commit/975cc84c5670c41b2b0d23f7cef4928f989bfaaf", "message": "GEODE-8422: Cleanup unit test.", "committedDate": "2020-08-12T21:11:44Z", "type": "commit"}, {"oid": "a2fffddb5be92433f83abde4b1d8a7e0d4613782", "url": "https://github.com/apache/geode/commit/a2fffddb5be92433f83abde4b1d8a7e0d4613782", "message": "fix the dunit tests' behavior", "committedDate": "2020-08-12T21:20:22Z", "type": "commit"}, {"oid": "db8b7064d7fc1452b17ed986657cebc82cb5ea9d", "url": "https://github.com/apache/geode/commit/db8b7064d7fc1452b17ed986657cebc82cb5ea9d", "message": "GEODE-8422: adding ASF copyright header.", "committedDate": "2020-08-12T21:24:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4NDcxNg==", "url": "https://github.com/apache/geode/pull/5447#discussion_r469584716", "bodyText": "Does the comment above have to be updated?", "author": "jchen21", "createdAt": "2020-08-12T22:35:27Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/cache/GIIDeltaDUnitTest.java", "diffHunk": "@@ -497,7 +497,7 @@ public void run() {\n \n     // If fullGII, the key size in gii chunk is 3, i.e. key1,key3,key5. key2 is GCed.\n     // If delta GII, the key size should be 1 (key5(T) which is unfinished operation)\n-    verifyDeltaSizeFromStats(R, 3, 0);\n+    verifyDeltaSizeFromStats(R, 1, 1);", "originalCommit": "db8b7064d7fc1452b17ed986657cebc82cb5ea9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}