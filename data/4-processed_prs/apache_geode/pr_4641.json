{"pr_number": 4641, "pr_title": "GEODE-7604: Fix QueryConfigurationServiceConstraintsDistributedTest", "pr_createdAt": "2020-01-28T17:29:42Z", "pr_url": "https://github.com/apache/geode/pull/4641", "timeline": [{"oid": "605eed483f94cba6eec6277d28cc190ac073abf1", "url": "https://github.com/apache/geode/commit/605eed483f94cba6eec6277d28cc190ac073abf1", "message": "GEODE-7604: Fix QueryConfigurationServiceConstraintsDistributedTest flakiness\n\n* Rewrite test with standard Geode and JMX APIs\n* Rewrite CountingCqListener with AtomicIntegers\n* Replace if-else with enum", "committedDate": "2020-01-27T20:51:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTI2Nw==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371959267", "bodyText": "The fix: Use new inner class with AtomicIntegers instead of TestCqListener which is not thread safe.", "author": "kirklund", "createdAt": "2020-01-28T17:49:17Z", "path": "geode-cq/src/distributedTest/java/org/apache/geode/cache/query/internal/QueryConfigurationServiceConstraintsDistributedTest.java", "diffHunk": "@@ -378,4 +418,28 @@ public boolean authorize(Method method, Object target) {\n       return authorizedMethods.contains(method.getName());\n     }\n   }\n+\n+  private static class CountingCqListener implements CqListener {\n+\n+    private final AtomicInteger eventCount = new AtomicInteger();", "originalCommit": "605eed483f94cba6eec6277d28cc190ac073abf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk2MDE4Mw==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371960183", "bodyText": "It's possible that changing to Geode and JMX APIs may have contributed to fixing the flakiness.", "author": "kirklund", "createdAt": "2020-01-28T17:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1ODc3OQ==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371958779", "bodyText": "I thought we were encouraging people to use the ClusterStartupRule instead of DistributedRule... did that change?.", "author": "jujoramos", "createdAt": "2020-01-28T17:48:16Z", "path": "geode-cq/src/distributedTest/java/org/apache/geode/cache/query/internal/QueryConfigurationServiceConstraintsDistributedTest.java", "diffHunk": "@@ -72,158 +90,74 @@\n   private static final int REPLACE_KEY = ENTRIES - 4;\n   private static final int INVALIDATE_KEY = ENTRIES - 5;\n   private static final QueryObject TEST_VALUE = new QueryObject(999, \"name_999\");\n-  private File logFile;\n-  protected MemberVM server;\n-  protected ClientVM client;\n-  private static TestCqListener cqListener = null;\n+\n+  private static volatile CountingCqListener cqListener;\n+  private static volatile ServerLauncher serverLauncher;\n+  private static volatile ClientCache clientCache;\n+\n+  private VM serverVM;\n+  private VM clientVM;\n+\n+  private String regionName;\n+  private String queryString;\n \n   @Rule\n-  public ClusterStartupRule cluster = new ClusterStartupRule();\n+  public DistributedRule distributedRule = new DistributedRule();", "originalCommit": "605eed483f94cba6eec6277d28cc190ac073abf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5NjYwMQ==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371996601", "bodyText": "Actually, we're encouraging people t use DistributedRule with Geode APIs instead of ClusterStartupRule. ClusterStartupRule provides an entire new API layer for Geode and I'm 100% against that approach for writing tests.", "author": "kirklund", "createdAt": "2020-01-28T19:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1ODc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3OTkxOA==", "url": "https://github.com/apache/geode/pull/4641#discussion_r372279918", "bodyText": "Okay, good to know this... so, as the rule of thumb, we should use DisributedRule and CacheRule for distributed tests, and ServerStarterRule / LocatorStarterRule for integration tests, is that right?.", "author": "jujoramos", "createdAt": "2020-01-29T09:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1ODc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxOTEwOQ==", "url": "https://github.com/apache/geode/pull/4641#discussion_r372519109", "bodyText": "I would just DistributedRule for distributed tests. Don't even use CacheRule. I set ServerLauncher and LocatorLauncher statics or fields in the test for starting Server and Locator. These are the same APIs that a User would use (or GFSH).", "author": "kirklund", "createdAt": "2020-01-29T17:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1ODc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTQyNg==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371959426", "bodyText": "The set of parameters is duplicated across the test, I believe the previous approach of having a specific method to return the full list of parameters is easier to read. Am I missing something here?.", "author": "jujoramos", "createdAt": "2020-01-28T17:49:34Z", "path": "geode-cq/src/distributedTest/java/org/apache/geode/cache/query/internal/QueryConfigurationServiceConstraintsDistributedTest.java", "diffHunk": "@@ -233,41 +167,57 @@ private void createClientCq(String queryString, boolean executeWithInitialResult\n    * The operations should succeed, the CQ should fire 'onEvent' and no errors should be logged.\n    */\n   @Test\n-  @Parameters(method = \"getRegionTypeOperationsAndCqExecutionType\")\n-  @TestCaseName(\"[{index}] {method}(RegionType:{0};Operation:{1},ExecuteWithInitialResults:{2})\")\n+  @Parameters({\n+      \"REPLICATE, PUT, true\", \"REPLICATE, PUT, false\",\n+      \"REPLICATE, CREATE, true\", \"REPLICATE, CREATE, false\",\n+      \"REPLICATE, REMOVE, true\", \"REPLICATE, REMOVE, false\",\n+      \"REPLICATE, DESTROY, true\", \"REPLICATE, DESTROY, false\",\n+      \"REPLICATE, UPDATE, true\", \"REPLICATE, UPDATE, false\",\n+      \"REPLICATE, REPLACE, true\", \"REPLICATE, REPLACE, false\",\n+      \"REPLICATE, INVALIDATE, true\", \"REPLICATE, INVALIDATE, false\",\n+      \"PARTITION, PUT, true\", \"REPLICATE, PUT, false\",\n+      \"PARTITION, CREATE, true\", \"REPLICATE, CREATE, false\",\n+      \"PARTITION, REMOVE, true\", \"REPLICATE, REMOVE, false\",\n+      \"PARTITION, DESTROY, true\", \"REPLICATE, DESTROY, false\",\n+      \"PARTITION, UPDATE, true\", \"REPLICATE, UPDATE, false\",\n+      \"PARTITION, REPLACE, true\", \"REPLICATE, REPLACE, false\",\n+      \"PARTITION, INVALIDATE, true\", \"REPLICATE, INVALIDATE, false\"})", "originalCommit": "605eed483f94cba6eec6277d28cc190ac073abf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5Njk4Mw==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371996983", "bodyText": "I can restore this. The reason I did this was because the JUnitParams parameter methods are always detected as unused by the IDE, so then you have to mark it with SuppressWarnings(\"unused\").", "author": "kirklund", "createdAt": "2020-01-28T19:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5NzU3Ng==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371997576", "bodyText": "I also prefer to see the parameters with the test method instead of looking for another method. I could try to find a 3rd way to provide the parameters to the tests that isn't redundant.", "author": "kirklund", "createdAt": "2020-01-28T19:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5ODk2MQ==", "url": "https://github.com/apache/geode/pull/4641#discussion_r371998961", "bodyText": "I am don't like the duplication, but I think this way is easier to read. I think it doesn't matter a lot in this case. if the test were getting duplicated a lot or if this was in core (not test) code, I might object more.", "author": "mhansonp", "createdAt": "2020-01-28T19:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3OTk3MQ==", "url": "https://github.com/apache/geode/pull/4641#discussion_r372279971", "bodyText": "\ud83d\udc4d", "author": "jujoramos", "createdAt": "2020-01-29T09:45:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxODUxMw==", "url": "https://github.com/apache/geode/pull/4641#discussion_r372518513", "bodyText": "I ended up replacing it with NamedParameters method.", "author": "kirklund", "createdAt": "2020-01-29T17:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk1OTQyNg=="}], "type": "inlineReview"}, {"oid": "0504f2b50f6608b2b2066ca0b3d176fd12cd8fbd", "url": "https://github.com/apache/geode/commit/0504f2b50f6608b2b2066ca0b3d176fd12cd8fbd", "message": "Trigger precheckin", "committedDate": "2020-01-28T21:38:13Z", "type": "commit"}, {"oid": "eacdae1aadb7b22e4d24062bb6145bcf90702e65", "url": "https://github.com/apache/geode/commit/eacdae1aadb7b22e4d24062bb6145bcf90702e65", "message": "Replace inline parameters with NamedParameters method", "committedDate": "2020-01-28T23:18:00Z", "type": "commit"}]}