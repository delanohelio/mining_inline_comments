{"pr_number": 5285, "pr_title": "GEODE-8099: make those gfsh commands that updates cluster configurati\u2026", "pr_createdAt": "2020-06-23T02:12:15Z", "pr_url": "https://github.com/apache/geode/pull/5285", "timeline": [{"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "url": "https://github.com/apache/geode/commit/1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "message": "GEODE-8099: make those gfsh commands that updates cluster configuration thead safe.\n\n* command executor will acquire the lock when executing commands that affects cluster configuration.\n* clean up commands that doesn't need to extends implement SingleGfshCommand\n* SingleGfshCommand are for those commands that need to update cluster configuration", "committedDate": "2020-06-23T05:15:14Z", "type": "commit"}, {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "url": "https://github.com/apache/geode/commit/1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "message": "GEODE-8099: make those gfsh commands that updates cluster configuration thead safe.\n\n* command executor will acquire the lock when executing commands that affects cluster configuration.\n* clean up commands that doesn't need to extends implement SingleGfshCommand\n* SingleGfshCommand are for those commands that need to update cluster configuration", "committedDate": "2020-06-23T05:15:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw==", "url": "https://github.com/apache/geode/pull/5285#discussion_r444588637", "bodyText": "Since \"LocatorClusterManagementService\" is central to the ClusterConfigurationService; will it be better to have the cms-dlock service created in this class; and have helper method to lock and unlock. Assumption is when the lock is requested the Locator Management service will be up and running.\nlockConfigForUpdate() {}\nunLockConfigForUpdate() {}", "author": "agingade", "createdAt": "2020-06-24T01:06:49Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java", "diffHunk": "@@ -113,7 +113,7 @@\n public class LocatorClusterManagementService implements ClusterManagementService {\n   @VisibleForTesting\n   // the dlock service name used by the CMS\n-  static final String CMS_DLOCK_SERVICE_NAME = \"CMS_DLOCK_SERVICE\";\n+  public static final String CMS_DLOCK_SERVICE_NAME = \"CMS_DLOCK_SERVICE\";", "originalCommit": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxODQ4OA==", "url": "https://github.com/apache/geode/pull/5285#discussion_r444618488", "bodyText": "I believe it is created by this class, see getCmsDlockService in this class", "author": "jinmeiliao", "createdAt": "2020-06-24T03:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTk2Mw==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445095963", "bodyText": "In this PR. the Dlock is getting created in \"OnlineCommandProcessor.java\"; I don't have latest develop, my guess it may be getting created in rest endpoint too...", "author": "agingade", "createdAt": "2020-06-24T18:40:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEzNjkxNw==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445136917", "bodyText": "they both call DLockService.getOrCreateService, if it's already created, it will just get it. So, I guess whoever get to it first will create it.", "author": "jinmeiliao", "createdAt": "2020-06-24T19:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE3MzMyMQ==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445173321", "bodyText": "Can that creating (getOrCreateService ) be done in one place, in \"LocatorClusterManagementService\" which seems to be right place for it...", "author": "agingade", "createdAt": "2020-06-24T21:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIxNjE1OA==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445216158", "bodyText": "Then OnlineCommandProcessor needs to get ahold of LocatorClusterManagementService and get the dLock service from there? What if CMS is not started? Gfsh still needs to have this dLockService.", "author": "jinmeiliao", "createdAt": "2020-06-24T22:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2NzcyNg==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445867726", "bodyText": "My understanding was, we have centralized configuration-management class, that is used by both gfsh and rest end-point to make the configuration changes, and I thought it was LocatorClusterManagementService, I guess I am wrong...\nIs it \"InternalConfigurationPersistenceService\" where both gfsh and end-point make the configuration changes...If so, can the dlock creation and unlocking/unlocking helper method be added there.\nI am trying to see if we can have the lock creation in one place, rather than in many clients/apis that make the configuration changes...", "author": "agingade", "createdAt": "2020-06-25T22:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NDgwNA==", "url": "https://github.com/apache/geode/pull/5285#discussion_r446474804", "bodyText": "Yes, the InternalConfigurationPersistenceService is used by both rest and gfsh to persist the configuration change in the region, and it already has its own dlockService to make sure update to the region is thread safe.\nWhat are trying to. make thread-safe in here is not just \"update to the region\", it's the \"update to the servers and then update the region\", which is a level above the persistence layer.  Both rest and gfsh does this and so both needs the same dlockService.", "author": "jinmeiliao", "createdAt": "2020-06-27T02:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MDAwMw==", "url": "https://github.com/apache/geode/pull/5285#discussion_r444590003", "bodyText": "How about naming it as \"updatesClusterConfiguration\" (); they both are same, just another name to consider, its left to you.", "author": "agingade", "createdAt": "2020-06-24T01:12:22Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/cli/GfshCommand.java", "diffHunk": "@@ -59,6 +59,14 @@ public boolean isOnlineCommandAvailable() {\n     return gfsh.isConnectedAndReady();\n   }\n \n+  /**\n+   * For those commands that could possibly change the cluster configuration, they need to\n+   * override this method to return true.\n+   */\n+  public boolean affectsClusterConfiguration() {", "originalCommit": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MDQwNA==", "url": "https://github.com/apache/geode/pull/5285#discussion_r444590404", "bodyText": "How about combining all of the if into an AND condition.\nif (cmsDlockService == null && !(command instanceof GfshCommand) &&...)", "author": "agingade", "createdAt": "2020-06-24T01:13:59Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/remote/CommandExecutor.java", "diffHunk": "@@ -207,4 +219,32 @@ protected Object invokeCommand(Object command, GfshParseResult parseResult) {\n \n     return resultModel;\n   }\n+\n+  @VisibleForTesting\n+  boolean lockCMS(Object command) {\n+    if (cmsDlockService == null) {\n+      return false;\n+    }\n+    if (!(command instanceof GfshCommand)) {", "originalCommit": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxODA2Ng==", "url": "https://github.com/apache/geode/pull/5285#discussion_r444618066", "bodyText": "I think this reads better and I plan to add comments in each if block", "author": "jinmeiliao", "createdAt": "2020-06-24T03:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MDQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTM2Mw==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445095363", "bodyText": "This changes the public API, which could affect those gfsh commands that extend this class.", "author": "jchen21", "createdAt": "2020-06-24T18:39:31Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/cli/SingleGfshCommand.java", "diffHunk": "@@ -39,7 +42,11 @@\n    *        return value of your command method.\n    * @return a boolean indicating whether a change to the cluster configuration was persisted.\n    */\n-  public boolean updateConfigForGroup(String group, CacheConfig config, Object configObject) {\n-    return false;\n+  public abstract boolean updateConfigForGroup(String group, CacheConfig config,", "originalCommit": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE0Mjc5OA==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445142798", "bodyText": "this class is @experimental", "author": "jinmeiliao", "createdAt": "2020-06-24T20:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTQyOQ==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445095429", "bodyText": "This changes the public API, which could affect those gfsh commands that extend this class.", "author": "jchen21", "createdAt": "2020-06-24T18:39:39Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/cli/SingleGfshCommand.java", "diffHunk": "@@ -39,7 +42,11 @@\n    *        return value of your command method.\n    * @return a boolean indicating whether a change to the cluster configuration was persisted.\n    */\n-  public boolean updateConfigForGroup(String group, CacheConfig config, Object configObject) {\n-    return false;\n+  public abstract boolean updateConfigForGroup(String group, CacheConfig config,\n+      Object configObject);\n+\n+  @Override\n+  public boolean affectsClusterConfiguration() {", "originalCommit": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE0MTc5NQ==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445141795", "bodyText": "It's marked as @experimental", "author": "jinmeiliao", "createdAt": "2020-06-24T20:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwNTY1NQ==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445105655", "bodyText": "This constructor is used only by tests. e.g. MemberCommandServiceTest. This also leads to adding a new constructor to a deprecated class MemberCommandService. And then changes to MemberCommandServiceTest. I wonder if it is necessary to make this change.", "author": "jchen21", "createdAt": "2020-06-24T18:58:17Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/remote/OnlineCommandProcessor.java", "diffHunk": "@@ -53,14 +57,13 @@\n \n   private SecurityService securityService;\n \n-  private InternalCache cache;\n-\n   public OnlineCommandProcessor() {}\n \n   @VisibleForTesting\n-  public OnlineCommandProcessor(Properties cacheProperties, SecurityService securityService,\n-      CommandExecutor commandExecutor, InternalCache cache) {\n-    this.gfshParser = new GfshParser(new CommandManager(cacheProperties, cache));\n+  public OnlineCommandProcessor(GfshParser gfshParser,", "originalCommit": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE0MjQyOA==", "url": "https://github.com/apache/geode/pull/5285#discussion_r445142428", "bodyText": "the change is necessary for the test to pass. All this change is because public methods in DlockService are static.", "author": "jinmeiliao", "createdAt": "2020-06-24T20:08:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwNTY1NQ=="}], "type": "inlineReview"}, {"oid": "bce547022549ee198707da0e14212b609d695a85", "url": "https://github.com/apache/geode/commit/bce547022549ee198707da0e14212b609d695a85", "message": "more comment", "committedDate": "2020-06-24T20:05:55Z", "type": "commit"}]}