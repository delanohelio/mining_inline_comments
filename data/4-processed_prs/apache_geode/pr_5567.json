{"pr_number": 5567, "pr_title": "GEODE-8547: Added impacts to show missing disk-stores", "pr_createdAt": "2020-09-29T09:23:58Z", "pr_url": "https://github.com/apache/geode/pull/5567", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NzI2NQ==", "url": "https://github.com/apache/geode/pull/5567#discussion_r516987265", "bodyText": "I believe you don't need this boolean. If no servers, missingRegions will be null, otherwise, it's empty or has data", "author": "jinmeiliao", "createdAt": "2020-11-03T22:15:39Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/commands/ShowMissingDiskStoreCommand.java", "diffHunk": "@@ -53,16 +53,19 @@ public ResultModel showMissingDiskStore() {\n     Set<DistributedMember> dataMembers =\n         DiskStoreCommandsUtils.getNormalMembers((InternalCache) getCache());\n \n-    if (dataMembers.isEmpty()) {\n-      return ResultModel.createInfo(CliStrings.NO_CACHING_MEMBERS_FOUND_MESSAGE);\n+    List<ColocatedRegionDetails> missingRegions = null;\n+    boolean cacheMemberExist = false;\n+\n+    if (!dataMembers.isEmpty()) {\n+      cacheMemberExist = true;", "originalCommit": "22454e9ab32dc408d9b93979635b32c182b953e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4ODE5MA==", "url": "https://github.com/apache/geode/pull/5567#discussion_r516988190", "bodyText": "here you can do something like:\nif (missingColocatedRegions == null) {\n  // set the header as \"no caching members\"\n}\nelse if (missingColocatedRegions.isEmpty()) {\n....\n}\nelse{\n....\n}", "author": "jinmeiliao", "createdAt": "2020-11-03T22:17:57Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/commands/ShowMissingDiskStoreCommand.java", "diffHunk": "@@ -113,7 +116,9 @@ private ResultModel toMissingDiskStoresTabularResult(\n     }\n \n     TabularResultModel missingRegionsSection = result.addTable(MISSING_COLOCATED_REGIONS_SECTION);\n-    if (hasMissingColocatedRegions) {\n+    if (!cacheMemberExist) {", "originalCommit": "22454e9ab32dc408d9b93979635b32c182b953e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4ODQ5OQ==", "url": "https://github.com/apache/geode/pull/5567#discussion_r516988499", "bodyText": "instead of suppress the warning, just don't assign it to a variable", "author": "jinmeiliao", "createdAt": "2020-11-03T22:18:45Z", "path": "geode-gfsh/src/distributedTest/java/org/apache/geode/management/internal/cli/commands/ShowMissingDiskStoreCommandDUnitTest.java", "diffHunk": "@@ -156,6 +160,71 @@ public void stoppingAndRestartingMemberDoesNotResultInMissingDiskStore() {\n     assertThat(missingDiskStoreIds).isNull();\n   }\n \n+\n+  @Test\n+  public void stopAllMembersAndStart2ndLocator() throws Exception {\n+    IgnoredException.addIgnoredException(DistributedSystemDisconnectedException.class);\n+\n+    MemberVM locator1 = lsRule.startLocatorVM(1, locator.getPort());\n+\n+    MemberVM server1 = lsRule.startServerVM(2, locator.getPort(), locator1.getPort());\n+    @SuppressWarnings(\"unused\")", "originalCommit": "22454e9ab32dc408d9b93979635b32c182b953e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4ODg5NA==", "url": "https://github.com/apache/geode/pull/5567#discussion_r516988894", "bodyText": "I believe you can just create a region without the diskstore, the same problem would still manifest. Make the test simpler", "author": "jinmeiliao", "createdAt": "2020-11-03T22:19:42Z", "path": "geode-gfsh/src/distributedTest/java/org/apache/geode/management/internal/cli/commands/ShowMissingDiskStoreCommandDUnitTest.java", "diffHunk": "@@ -156,6 +160,71 @@ public void stoppingAndRestartingMemberDoesNotResultInMissingDiskStore() {\n     assertThat(missingDiskStoreIds).isNull();\n   }\n \n+\n+  @Test\n+  public void stopAllMembersAndStart2ndLocator() throws Exception {\n+    IgnoredException.addIgnoredException(DistributedSystemDisconnectedException.class);\n+\n+    MemberVM locator1 = lsRule.startLocatorVM(1, locator.getPort());\n+\n+    MemberVM server1 = lsRule.startServerVM(2, locator.getPort(), locator1.getPort());\n+    @SuppressWarnings(\"unused\")\n+    MemberVM server2 = lsRule.startServerVM(3, locator.getPort(), locator1.getPort());\n+\n+    final String testRegionName = \"regionA\";", "originalCommit": "22454e9ab32dc408d9b93979635b32c182b953e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4OTA4OQ==", "url": "https://github.com/apache/geode/pull/5567#discussion_r516989089", "bodyText": "you also don't need to add data and do rebalance. Maybe add a comment in your test making it clear that you are starting a stale locator first (locator 1 shutdown before locator0, and now you are starting locator 1 first), locator 1 won't start properly until a diskstore on locator 0 is revoked", "author": "jinmeiliao", "createdAt": "2020-11-03T22:20:09Z", "path": "geode-gfsh/src/distributedTest/java/org/apache/geode/management/internal/cli/commands/ShowMissingDiskStoreCommandDUnitTest.java", "diffHunk": "@@ -156,6 +160,71 @@ public void stoppingAndRestartingMemberDoesNotResultInMissingDiskStore() {\n     assertThat(missingDiskStoreIds).isNull();\n   }\n \n+\n+  @Test\n+  public void stopAllMembersAndStart2ndLocator() throws Exception {\n+    IgnoredException.addIgnoredException(DistributedSystemDisconnectedException.class);\n+\n+    MemberVM locator1 = lsRule.startLocatorVM(1, locator.getPort());\n+\n+    MemberVM server1 = lsRule.startServerVM(2, locator.getPort(), locator1.getPort());\n+    @SuppressWarnings(\"unused\")\n+    MemberVM server2 = lsRule.startServerVM(3, locator.getPort(), locator1.getPort());\n+\n+    final String testRegionName = \"regionA\";\n+    CommandStringBuilder csb;\n+    csb = new CommandStringBuilder(CliStrings.CREATE_DISK_STORE)\n+        .addOption(CliStrings.CREATE_DISK_STORE__NAME, \"diskStore\")\n+        .addOption(CliStrings.CREATE_DISK_STORE__DIRECTORY_AND_SIZE, \"diskStoreDir\");\n+    gfshConnector.executeAndAssertThat(csb.getCommandString()).statusIsSuccess();\n+\n+    CommandStringBuilder createRegion = new CommandStringBuilder(CliStrings.CREATE_REGION)\n+        .addOption(CliStrings.CREATE_REGION__REGION, testRegionName)\n+        .addOption(CliStrings.CREATE_REGION__DISKSTORE, \"diskStore\")\n+        .addOption(CliStrings.CREATE_REGION__REGIONSHORTCUT,\n+            RegionShortcut.PARTITION_REDUNDANT_PERSISTENT.toString());\n+    await().untilAsserted(() -> gfshConnector.executeAndAssertThat(createRegion.getCommandString())\n+        .statusIsSuccess());\n+\n+\n+    lsRule.stop(1, false);\n+\n+    // Add data to the region\n+    addData(server1, testRegionName);", "originalCommit": "22454e9ab32dc408d9b93979635b32c182b953e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d9232dc212dbb51de51773dc042e197f6ba6b52", "url": "https://github.com/apache/geode/commit/2d9232dc212dbb51de51773dc042e197f6ba6b52", "message": "GEODE-8547: update after comments", "committedDate": "2020-11-04T14:35:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQyMDc5MQ==", "url": "https://github.com/apache/geode/pull/5567#discussion_r517420791", "bodyText": "this variable is not used anymore.", "author": "jinmeiliao", "createdAt": "2020-11-04T15:19:30Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/commands/ShowMissingDiskStoreCommand.java", "diffHunk": "@@ -95,7 +96,8 @@ private ResultModel toMissingDiskStoresTabularResult(\n     ResultModel result = new ResultModel();\n \n     boolean hasMissingDiskStores = missingDiskStores.length != 0;\n-    boolean hasMissingColocatedRegions = !missingColocatedRegions.isEmpty();\n+    boolean hasMissingColocatedRegions =", "originalCommit": "2d9232dc212dbb51de51773dc042e197f6ba6b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQyMTEzNQ==", "url": "https://github.com/apache/geode/pull/5567#discussion_r517421135", "bodyText": "actually you can get rid of this variable and inline this too, to make it symetric.", "author": "jinmeiliao", "createdAt": "2020-11-04T15:19:58Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/commands/ShowMissingDiskStoreCommand.java", "diffHunk": "@@ -95,7 +96,8 @@ private ResultModel toMissingDiskStoresTabularResult(\n     ResultModel result = new ResultModel();\n \n     boolean hasMissingDiskStores = missingDiskStores.length != 0;", "originalCommit": "2d9232dc212dbb51de51773dc042e197f6ba6b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1989c97eb05622fe525bf8ba5bbd8aafeac9990e", "url": "https://github.com/apache/geode/commit/1989c97eb05622fe525bf8ba5bbd8aafeac9990e", "message": "GEODE-8547: Added impacts to show missing disk-stores", "committedDate": "2020-11-04T16:18:14Z", "type": "commit"}, {"oid": "3da363adc5bee91e27226948b243494a7b4f10b2", "url": "https://github.com/apache/geode/commit/3da363adc5bee91e27226948b243494a7b4f10b2", "message": "GEODE-8547: Added DUnit test", "committedDate": "2020-11-04T16:18:14Z", "type": "commit"}, {"oid": "f8579c834697bea7d81b10bda6ef1852a333ddde", "url": "https://github.com/apache/geode/commit/f8579c834697bea7d81b10bda6ef1852a333ddde", "message": "GEODE-8547: update after comments", "committedDate": "2020-11-04T16:18:15Z", "type": "commit"}, {"oid": "41e11d70d7e3246c1d846ef3bd3f514d6ea2abf0", "url": "https://github.com/apache/geode/commit/41e11d70d7e3246c1d846ef3bd3f514d6ea2abf0", "message": "GEODE-8547: remove unused variables", "committedDate": "2020-11-04T16:30:49Z", "type": "forcePushed"}, {"oid": "a643a6200ce65e08ca6df1966462b22f99e5d6b5", "url": "https://github.com/apache/geode/commit/a643a6200ce65e08ca6df1966462b22f99e5d6b5", "message": "GEODE-8547: remove unused variables", "committedDate": "2020-11-04T20:41:45Z", "type": "commit"}, {"oid": "a643a6200ce65e08ca6df1966462b22f99e5d6b5", "url": "https://github.com/apache/geode/commit/a643a6200ce65e08ca6df1966462b22f99e5d6b5", "message": "GEODE-8547: remove unused variables", "committedDate": "2020-11-04T20:41:45Z", "type": "forcePushed"}, {"oid": "9ed6f7242e17d929655737e6cc995649dc7a2299", "url": "https://github.com/apache/geode/commit/9ed6f7242e17d929655737e6cc995649dc7a2299", "message": "GEODE-8547: update test", "committedDate": "2020-11-05T07:58:51Z", "type": "commit"}, {"oid": "9ed6f7242e17d929655737e6cc995649dc7a2299", "url": "https://github.com/apache/geode/commit/9ed6f7242e17d929655737e6cc995649dc7a2299", "message": "GEODE-8547: update test", "committedDate": "2020-11-05T07:58:51Z", "type": "forcePushed"}]}