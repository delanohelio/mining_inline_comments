{"pr_number": 5473, "pr_title": "GEODE-7864: Fix some LGTM alerts and suppress some false positives", "pr_createdAt": "2020-08-24T19:04:05Z", "pr_url": "https://github.com/apache/geode/pull/5473", "timeline": [{"oid": "3f1640d9e8a080e31404209ed868b0f32bac978e", "url": "https://github.com/apache/geode/commit/3f1640d9e8a080e31404209ed868b0f32bac978e", "message": "GEODE-7864: Fix some LGTM alerts and suppress some false positives\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-08-24T18:56:42Z", "type": "commit"}, {"oid": "cd99d158baaae2d0af1b565ce7c37f7cedf29320", "url": "https://github.com/apache/geode/commit/cd99d158baaae2d0af1b565ce7c37f7cedf29320", "message": "Fix dereferenced variable may be null alerts in Oplog.java\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-08-24T18:56:43Z", "type": "commit"}, {"oid": "577ba6586beb3ba7673a68828f5bd5308ac082f8", "url": "https://github.com/apache/geode/commit/577ba6586beb3ba7673a68828f5bd5308ac082f8", "message": "Fixed dereferenced variable may be null alerts in PartitionedRegion\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-08-24T18:56:43Z", "type": "commit"}, {"oid": "8e67db75dc053245ffa4aa26275f00ddce505762", "url": "https://github.com/apache/geode/commit/8e67db75dc053245ffa4aa26275f00ddce505762", "message": "More dereferenced variable may be null fixes\n\n- InitialImageOperation\n- GMSMembership\n- ParallelGatewaySenderQueue\n- DiskStoreImpl\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-08-24T18:56:43Z", "type": "commit"}, {"oid": "45f04b8da7c3071352c3805af465896cf13406f3", "url": "https://github.com/apache/geode/commit/45f04b8da7c3071352c3805af465896cf13406f3", "message": "Fix alerts in LocalRegion and HARegionQueue\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-08-24T18:56:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0MzkyOQ==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476743929", "bodyText": "Did you decrease protection here?", "author": "mhansonp", "createdAt": "2020-08-25T21:19:26Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/Oplog.java", "diffHunk": "@@ -3583,7 +3597,7 @@ private void basicCreate(DiskRegion dr, DiskEntry entry, ValueWrapper value, byt\n             logger.trace(LogMarker.PERSIST_WRITES_VERBOSE,\n                 \"basicCreate: id=<{}> key=<{}> valueOffset={} userBits={} valueLen={} valueBytes={} drId={} versionTag={} oplog#{}\",\n                 abs(id.getKeyId()), entry.getKey(), startPosForSynchOp, userBits,\n-                (value != null ? value.getLength() : 0), value.getBytesAsString(), dr.getId(), tag,", "originalCommit": "45f04b8da7c3071352c3805af465896cf13406f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg3NzQ4NQ==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476877485", "bodyText": "In a sense, yes. The warning was being generated because checking if value was null here implied that it could be null before/after this check, and that calling methods on it could produce an NPE. However, when examining the code path, value should never be null at this point, so the check was redundant.", "author": "DonalEvans", "createdAt": "2020-08-25T23:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0MzkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0OTQ3Nw==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476749477", "bodyText": "Is the first part of the test required? \"if (!olf.RAFClosed\" It sits below an assert that in order to pass must be true.", "author": "mhansonp", "createdAt": "2020-08-25T21:25:28Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/Oplog.java", "diffHunk": "@@ -5653,7 +5667,7 @@ private void deleteFile(final OplogFile olf) {\n       if (!olf.f.exists())\n         return;\n       assert olf.RAFClosed;\n-      if (!olf.RAFClosed || olf.raf != null) {\n+      if (!olf.RAFClosed && olf.raf != null) {", "originalCommit": "45f04b8da7c3071352c3805af465896cf13406f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc1NjQ2NA==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476756464", "bodyText": "Actually, with the new code, this if statement should never be true because of the assert above.", "author": "mhansonp", "createdAt": "2020-08-25T21:33:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0OTQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg3ODA2NA==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476878064", "bodyText": "Good catch. I'll remove the first part.", "author": "DonalEvans", "createdAt": "2020-08-25T23:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0OTQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg3ODgwMw==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476878803", "bodyText": "Other than that, it all looks good.", "author": "mhansonp", "createdAt": "2020-08-25T23:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0OTQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc1NDE4Mw==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476754183", "bodyText": "Is there a reason you reduced protection after adding it in elsewhere?", "author": "mhansonp", "createdAt": "2020-08-25T21:30:36Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/PartitionedRegion.java", "diffHunk": "@@ -2641,9 +2640,7 @@ private VersionedObjectList sendMsgByBucket(final Integer bucketId, PutAllPRMess\n             retryTime.waitToRetryNode();\n           }\n           event.setPossibleDuplicate(true);\n-          if (prMsg != null) {\n-            prMsg.setPossibleDuplicate(true);\n-          }\n+          prMsg.setPossibleDuplicate(true);", "originalCommit": "45f04b8da7c3071352c3805af465896cf13406f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg4OTczOA==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476889738", "bodyText": "As with the other removed null check in Oplog.java, prMsg should never be null in this method, so checking if it is null here simply causes LGTM to assume that it may be null everywhere and complain any time a method is called on it without first checking if it's null.", "author": "DonalEvans", "createdAt": "2020-08-26T00:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc1NDE4Mw=="}], "type": "inlineReview"}, {"oid": "5d7674902f9f77dc66d18a6c3d5c711e7ab30b33", "url": "https://github.com/apache/geode/commit/5d7674902f9f77dc66d18a6c3d5c711e7ab30b33", "message": "Remove redundant check in Oplog.java\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-08-26T00:01:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMjI5Mg==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476902292", "bodyText": "Since lgtm is not a \"normal\" warning to suppress, it may be worth explaining this somewhere why we are suppressing it (rather than fixing it).  Also it seems like we're using both @SuppressWarnings(\"lgtm[]) and comments // lgtm[] should be using one consistently or is there certain use cases that require one or the other?", "author": "moleske", "createdAt": "2020-08-26T00:14:37Z", "path": "geode-core/src/main/java/org/apache/geode/cache/query/internal/NullToken.java", "diffHunk": "@@ -33,6 +33,7 @@\n  */\n public class NullToken implements DataSerializableFixedID, Comparable {\n \n+  @SuppressWarnings(\"lgtm[java/useless-null-check]\")", "originalCommit": "5d7674902f9f77dc66d18a6c3d5c711e7ab30b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5ODM4Mg==", "url": "https://github.com/apache/geode/pull/5473#discussion_r476998382", "bodyText": "Good call on explaining the suppression here and other places the annotation is used. As for the different approaches to suppressing, LGTM requires that inline suppressions contain no line breaks, which would not be possible for some of the lines due to the spotless plugin automatically wrapping comments that extend too far to the right. In those cases, the @SuppressWarnings annotation is used, but is not used throughout because it would potentially mask other, legitimate alerts in methods that are currently present or that get introduced at a later date.", "author": "DonalEvans", "createdAt": "2020-08-26T02:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3OTc2Mw==", "url": "https://github.com/apache/geode/pull/5473#discussion_r477579763", "bodyText": "Ok, the comments in the code help.  I do wonder if we should make the link you posted available somewhere (like the readme or contributing.)\nAnd as long as we put @SuppressWarnings at the lowest possible level that should prevent the accident masking of other suppressions so that looks good.", "author": "moleske", "createdAt": "2020-08-26T20:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5NjIzMQ==", "url": "https://github.com/apache/geode/pull/5473#discussion_r477596231", "bodyText": "I'll try to write up and add a section about LGTM alerts in the appropriate section of the wiki/docs.\nI've tried to use the inline comment approach wherever possible, since that suppresses only the specified warning on the single line with the comment, so it's much more surgical than the annotation, which on a large method could have a fairly big blanket effect.", "author": "DonalEvans", "createdAt": "2020-08-26T21:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMjI5Mg=="}], "type": "inlineReview"}, {"oid": "954dcda6e369d003e8f8c7e2e5798cb2fda47989", "url": "https://github.com/apache/geode/commit/954dcda6e369d003e8f8c7e2e5798cb2fda47989", "message": "Add explanatory comments for LGTM suppressions\n\nAuthored-by: Donal Evans <doevans@vmware.com>", "committedDate": "2020-08-26T02:54:22Z", "type": "commit"}]}