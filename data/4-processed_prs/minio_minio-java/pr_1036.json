{"pr_number": 1036, "pr_title": "add assume-role credential provider", "pr_createdAt": "2020-08-10T18:03:48Z", "pr_url": "https://github.com/minio/minio-java/pull/1036", "timeline": [{"oid": "caec17965b1645faf5bc898f0c73e743271c721f", "url": "https://github.com/minio/minio-java/commit/caec17965b1645faf5bc898f0c73e743271c721f", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-08-11T06:02:27Z", "type": "forcePushed"}, {"oid": "39cc6bbe1f0b6e0333a1a038cb3f8963a87edf76", "url": "https://github.com/minio/minio-java/commit/39cc6bbe1f0b6e0333a1a038cb3f8963a87edf76", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-08-11T06:07:37Z", "type": "forcePushed"}, {"oid": "9171a8426daf80624f1c452f43880e74146862ab", "url": "https://github.com/minio/minio-java/commit/9171a8426daf80624f1c452f43880e74146862ab", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-08-15T04:38:38Z", "type": "forcePushed"}, {"oid": "c564b9823164a610b10673b12cfa5ad6af6f71a1", "url": "https://github.com/minio/minio-java/commit/c564b9823164a610b10673b12cfa5ad6af6f71a1", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-08-17T16:23:20Z", "type": "forcePushed"}, {"oid": "f795521eff70c75ac4dd9880b420154c4b45a8c7", "url": "https://github.com/minio/minio-java/commit/f795521eff70c75ac4dd9880b420154c4b45a8c7", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-08-21T10:46:49Z", "type": "forcePushed"}, {"oid": "19cc439b846bb2610f8f3b775e6381460faca9e5", "url": "https://github.com/minio/minio-java/commit/19cc439b846bb2610f8f3b775e6381460faca9e5", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-08-22T01:50:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0MzAwNA==", "url": "https://github.com/minio/minio-java/pull/1036#discussion_r480143004", "bodyText": "The fields stsEndpoint, httpClient and credentials seem to be common with WebIdentityClientGrantsProvider. We can consider adding an abstract base class that has a constructor that takes these arguments and call it from the constructors of both WebIdentityClientGrantsProvider and AssumeRoleProvider", "author": "anjalshireesh", "createdAt": "2020-08-31T13:48:23Z", "path": "api/src/main/java/io/minio/credentials/AssumeRoleProvider.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import io.minio.Digest;\n+import io.minio.Signer;\n+import io.minio.Time;\n+import io.minio.Xml;\n+import io.minio.errors.XmlParserException;\n+import java.io.IOException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.ZonedDateTime;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.MediaType;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.RequestBody;\n+import okhttp3.Response;\n+import org.simpleframework.xml.Element;\n+import org.simpleframework.xml.Namespace;\n+import org.simpleframework.xml.Path;\n+import org.simpleframework.xml.Root;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html\">AssumeRole\n+ * API</a>.\n+ */\n+public class AssumeRoleProvider implements Provider {\n+  public static final int DEFAULT_DURATION_SECONDS = (int) TimeUnit.HOURS.toSeconds(1);\n+  private final HttpUrl stsEndpoint;\n+  private final String accessKey;\n+  private final String secretKey;\n+  private final String region;\n+  private final OkHttpClient httpClient;\n+  private final String contentSha256;\n+  private final Request request;\n+  private Credentials credentials;", "originalCommit": "19cc439b846bb2610f8f3b775e6381460faca9e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0ODUxOA==", "url": "https://github.com/minio/minio-java/pull/1036#discussion_r480148518", "bodyText": "The request building logic is inside the fetch() method in the WebIdentityClientGrantsProvider class. Can we try to have a consistent pattern in both? I see a small potential for an abstract base class that provides the fetch() logic as well, forcing the concrete sub-classes to build the request, which seems to be the main difference.", "author": "anjalshireesh", "createdAt": "2020-08-31T13:57:07Z", "path": "api/src/main/java/io/minio/credentials/AssumeRoleProvider.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import io.minio.Digest;\n+import io.minio.Signer;\n+import io.minio.Time;\n+import io.minio.Xml;\n+import io.minio.errors.XmlParserException;\n+import java.io.IOException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.ZonedDateTime;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.MediaType;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.RequestBody;\n+import okhttp3.Response;\n+import org.simpleframework.xml.Element;\n+import org.simpleframework.xml.Namespace;\n+import org.simpleframework.xml.Path;\n+import org.simpleframework.xml.Root;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html\">AssumeRole\n+ * API</a>.\n+ */\n+public class AssumeRoleProvider implements Provider {\n+  public static final int DEFAULT_DURATION_SECONDS = (int) TimeUnit.HOURS.toSeconds(1);\n+  private final HttpUrl stsEndpoint;\n+  private final String accessKey;\n+  private final String secretKey;\n+  private final String region;\n+  private final OkHttpClient httpClient;\n+  private final String contentSha256;\n+  private final Request request;\n+  private Credentials credentials;\n+\n+  public AssumeRoleProvider(\n+      @Nonnull String stsEndpoint,\n+      @Nonnull String accessKey,\n+      @Nonnull String secretKey,\n+      @Nullable Integer durationSeconds,\n+      @Nullable String policy,\n+      @Nullable String region,\n+      @Nullable String roleArn,\n+      @Nullable String roleSessionName,\n+      @Nullable String externalId,\n+      @Nullable OkHttpClient customHttpClient)\n+      throws NoSuchAlgorithmException {\n+    stsEndpoint = Objects.requireNonNull(stsEndpoint, \"STS endpoint cannot be empty\");\n+    this.stsEndpoint = Objects.requireNonNull(HttpUrl.parse(stsEndpoint), \"Invalid STS endpoint\");\n+    accessKey = Objects.requireNonNull(accessKey, \"Access key must not be null\");\n+    if (accessKey.isEmpty()) {\n+      throw new IllegalArgumentException(\"Access key must not be empty\");\n+    }\n+    this.accessKey = accessKey;\n+    this.secretKey = Objects.requireNonNull(secretKey, \"Secret key must not be null\");\n+    this.region = (region != null) ? region : \"\";\n+    this.httpClient = (customHttpClient != null) ? customHttpClient : new OkHttpClient();\n+\n+    if (externalId != null && (externalId.length() < 2 || externalId.length() > 1224)) {\n+      throw new IllegalArgumentException(\"Length of ExternalId must be in between 2 and 1224\");\n+    }\n+\n+    durationSeconds =\n+        (durationSeconds != null && durationSeconds > DEFAULT_DURATION_SECONDS)\n+            ? durationSeconds\n+            : DEFAULT_DURATION_SECONDS;\n+\n+    HttpUrl.Builder urlBuilder =\n+        this.stsEndpoint\n+            .newBuilder()\n+            .addQueryParameter(\"Action\", \"AssumeRole\")\n+            .addQueryParameter(\"Version\", \"2011-06-15\")\n+            .addQueryParameter(\"DurationSeconds\", String.valueOf(durationSeconds));\n+\n+    if (roleArn != null) {\n+      urlBuilder.addQueryParameter(\"RoleArn\", roleArn);\n+    }\n+\n+    if (roleSessionName != null) {\n+      urlBuilder.addQueryParameter(\"RoleSessionName\", roleSessionName);\n+    }\n+\n+    if (policy != null) {\n+      urlBuilder.addQueryParameter(\"Policy\", policy);\n+    }\n+\n+    if (externalId != null) {\n+      urlBuilder.addQueryParameter(\"ExternalId\", externalId);\n+    }\n+\n+    String data = urlBuilder.build().encodedQuery();\n+    this.contentSha256 = Digest.sha256Hash(data);\n+    this.request =\n+        new Request.Builder()\n+            .url(this.stsEndpoint)\n+            .method(\n+                \"POST\",\n+                RequestBody.create(MediaType.parse(\"application/x-www-form-urlencoded\"), data))\n+            .build();", "originalCommit": "19cc439b846bb2610f8f3b775e6381460faca9e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7dee7f16975c03364ad0aa167e3e442adb88eb8", "url": "https://github.com/minio/minio-java/commit/b7dee7f16975c03364ad0aa167e3e442adb88eb8", "message": "remove unused stsEndpoint", "committedDate": "2020-09-01T08:15:38Z", "type": "forcePushed"}, {"oid": "3c912ce67705010a182981900434f685e0984d67", "url": "https://github.com/minio/minio-java/commit/3c912ce67705010a182981900434f685e0984d67", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-09-03T09:10:47Z", "type": "forcePushed"}, {"oid": "6a9a454a639870b694c8c9e42721282dcd7c91e9", "url": "https://github.com/minio/minio-java/commit/6a9a454a639870b694c8c9e42721282dcd7c91e9", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-09-03T11:55:16Z", "type": "commit"}, {"oid": "6a9a454a639870b694c8c9e42721282dcd7c91e9", "url": "https://github.com/minio/minio-java/commit/6a9a454a639870b694c8c9e42721282dcd7c91e9", "message": "add assume-role credential provider\n\nFixes #817", "committedDate": "2020-09-03T11:55:16Z", "type": "forcePushed"}]}