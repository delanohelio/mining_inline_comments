{"pr_number": 697, "pr_title": "[CXF-8346] TCK Changes for URI and hasEntity checks", "pr_createdAt": "2020-09-22T18:29:19Z", "pr_url": "https://github.com/apache/cxf/pull/697", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNjA5Ng==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493106096", "bodyText": "This would modify the state of the stream, correct? May be it would be simpler to check/construct the PushbackInputStream and than do read / unread?", "author": "reta", "createdAt": "2020-09-23T00:27:36Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/ResponseImpl.java", "diffHunk": "@@ -137,22 +143,70 @@ public Object getActualEntity() {\n         return lastEntity != null ? lastEntity : entity;\n     }\n \n+    @Override\n     public Object getEntity() {\n         return InjectionUtils.getEntity(getActualEntity());\n     }\n \n+    @Override\n     public boolean hasEntity() {\n-        return getActualEntity() != null;\n+        // per spec, need to check if the stream exists and if it has data.\n+        Object actualEntity = getActualEntity();\n+        if (actualEntity == null) {\n+            return false;\n+        } else if (actualEntity instanceof InputStream) {\n+            final InputStream is = (InputStream) actualEntity;\n+            try {\n+                if (is.markSupported()) {\n+                    is.mark(1);\n+                    int i = is.read();\n+                    is.reset();\n+                    return i != -1;\n+                } else {\n+                    try {\n+                        if (is.available() > 0) {\n+                            return true;\n+                        }\n+                    } catch (IOException ioe) {\n+                        //Do nothing\n+                    }\n+                    int b = is.read();", "originalCommit": "90a1c094d71036f8ca2c24a9b721a1ac813702b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkxNTA2Ng==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493915066", "bodyText": "This does read one byte of the stream.  If it is -1, then it simply returns false (no entity).  If there is data on the stream, then we construct the PushbackInputStream to unread the byte we checked before.  I think this approach is optimal for the case where there is no entity, but not harmful in the case where there is.  If the stream supports marking (fair uncommon imo) or the available method (much more common), then we'll never get this far.\nUnless you object, I'd like to leave it this way, but I can add a unit test to ensure the different expectations and complete coverage (input stream supporting marking, available, etc.).", "author": "andymc12", "createdAt": "2020-09-23T21:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNjA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MDkxMQ==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493960911", "bodyText": "No objections, the reasoning was to keep PushbackInputStream  manipulations close by but indeed, you have a good argument in not doing so, thank you.", "author": "reta", "createdAt": "2020-09-23T23:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNjA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODA3Ng==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493108076", "bodyText": "Unfamiliar with this part, do you have insights about lastEntity vs entity?", "author": "reta", "createdAt": "2020-09-23T00:35:03Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/ResponseImpl.java", "diffHunk": "@@ -137,22 +143,70 @@ public Object getActualEntity() {\n         return lastEntity != null ? lastEntity : entity;\n     }\n \n+    @Override\n     public Object getEntity() {\n         return InjectionUtils.getEntity(getActualEntity());\n     }\n \n+    @Override\n     public boolean hasEntity() {\n-        return getActualEntity() != null;\n+        // per spec, need to check if the stream exists and if it has data.\n+        Object actualEntity = getActualEntity();\n+        if (actualEntity == null) {\n+            return false;\n+        } else if (actualEntity instanceof InputStream) {\n+            final InputStream is = (InputStream) actualEntity;\n+            try {\n+                if (is.markSupported()) {\n+                    is.mark(1);\n+                    int i = is.read();\n+                    is.reset();\n+                    return i != -1;\n+                } else {\n+                    try {\n+                        if (is.available() > 0) {\n+                            return true;\n+                        }\n+                    } catch (IOException ioe) {\n+                        //Do nothing\n+                    }\n+                    int b = is.read();\n+                    if (b == -1) {\n+                        return false;\n+                    }\n+                    PushbackInputStream pbis;\n+                    if (is instanceof PushbackInputStream) {\n+                        pbis = (PushbackInputStream) is;\n+                    } else {\n+                        pbis = new PushbackInputStream(is, 1);\n+                        if (lastEntity != null) {", "originalCommit": "90a1c094d71036f8ca2c24a9b721a1ac813702b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2ODc3NQ==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493968775", "bodyText": "I believe that lastEntity is used for optimizing the case where the entity is an InputStream and a user calls readEntity(SomeObject.class) - lastEntity will then be set to the instance of SomeObject so that subsequent readEntity calls can just return that object rather then re-reading it from the stream.  But since it is also possible to read an entity as an InputStream, this code covers cases like:\nresponse.readEntity(InputStream.class);\nif (response.hasEntity()) {\n    response.readEntity(InputStream.class); // or response.readEntity(SomeObject.class), etc", "author": "andymc12", "createdAt": "2020-09-24T00:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODA3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMjQzNg==", "url": "https://github.com/apache/cxf/pull/697#discussion_r494622436", "bodyText": "\ud83d\udc4d thank you", "author": "reta", "createdAt": "2020-09-24T21:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwOTA4MQ==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493109081", "bodyText": "Sorry, why the outMessage.get(Message.REQUEST_URI) got removed?", "author": "reta", "createdAt": "2020-09-23T00:38:55Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/ResponseImpl.java", "diffHunk": "@@ -218,42 +274,46 @@ private Date doGetDate(String dateHeader) {\n             : HttpUtils.getHttpDate(value.toString());\n     }\n \n+    @Override\n     public EntityTag getEntityTag() {\n         Object header = metadata.getFirst(HttpHeaders.ETAG);\n         return header == null || header instanceof EntityTag ? (EntityTag)header\n             : EntityTag.valueOf(header.toString());\n     }\n \n+    @Override\n     public Locale getLanguage() {\n         Object header = metadata.getFirst(HttpHeaders.CONTENT_LANGUAGE);\n         return header == null || header instanceof Locale ? (Locale)header\n             : HttpUtils.getLocale(header.toString());\n     }\n \n+    @Override\n     public Date getLastModified() {\n         return doGetDate(HttpHeaders.LAST_MODIFIED);\n     }\n \n+    @Override\n     public int getLength() {\n         Object header = metadata.getFirst(HttpHeaders.CONTENT_LENGTH);\n         return HttpUtils.getContentLength(header == null ? null : header.toString());\n     }\n \n+    @Override\n     public URI getLocation() {\n         Object header = metadata.getFirst(HttpHeaders.LOCATION);\n-        if (header == null && outMessage != null) {\n-            header = outMessage.get(Message.REQUEST_URI);\n-        }\n-        return header == null || header instanceof URI ? (URI) header\n+        return header == null || header instanceof URI ? (URI)header", "originalCommit": "90a1c094d71036f8ca2c24a9b721a1ac813702b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4MjYxMg==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493882612", "bodyText": "I believe that was a TCK test.  IIRC, the TCK tests that getLocation should return null unless explicitly set as a Location: <someURI> header (via the ResponseBuilder.location(URI) method).\nI'm not positive, but I think it addresses this TCK test (currently listed in the failing tests):\ncom/sun/ts/tests/jaxrs/ee/rs/core/response/JAXRSClient.java#getLocationNotPresentTest_from_standalone: JAXRSClient_getLocationNotPresentTest_from_standalone", "author": "andymc12", "createdAt": "2020-09-23T20:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwOTA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExMDIwNQ==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493110205", "bodyText": "Shouldn't AutoCloseable also be checked?", "author": "reta", "createdAt": "2020-09-23T00:43:11Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/ResponseImpl.java", "diffHunk": "@@ -400,12 +472,30 @@ private Link makeAbsoluteLink(Link link) {\n                 responseMessage.put(Message.PROTOCOL_HEADERS, getHeaders());\n \n                 lastEntity = JAXRSUtils.readFromMessageBodyReader(readers, cls, t,\n-                                                                       anns,\n-                                                                       entityStream,\n-                                                                       mediaType,\n-                                                                       responseMessage);\n-                autoClose(cls, false);\n-                return castLastEntity();\n+                                                                  anns,\n+                                                                  entityStream,\n+                                                                  mediaType,\n+                                                                  responseMessage);\n+                // close the entity after readEntity is called.\n+                T tCastLastEntity = castLastEntity();\n+                shouldClose = shouldClose && !(tCastLastEntity instanceof Closeable)", "originalCommit": "90a1c094d71036f8ca2c24a9b721a1ac813702b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NzU1Mw==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493877553", "bodyText": "Closeable extends AutoCloseable, so we could get both with by checking AutoCloseable - I'll update this.", "author": "andymc12", "createdAt": "2020-09-23T20:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExMDIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExMzg4OA==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493113888", "bodyText": "You probably could reduce it to return type.isPrimitive() || Number.class.isAssignableFrom(type) || Boolean.class.isAssignableFrom(type) || Char.class.isAssignableFrom(type));  (PrimitiveTypes is not really needed in this case).", "author": "reta", "createdAt": "2020-09-23T00:57:21Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/ResponseImpl.java", "diffHunk": "@@ -527,10 +621,47 @@ public String getReasonPhrase() {\n                 return statusEnum != null ? statusEnum.getReasonPhrase() : \"\";\n             }\n \n+            @Override\n             public int getStatusCode() {\n                 return statusCode;\n             }\n \n         };\n     }\n-}\n+\n+    private enum PrimitiveTypes {\n+        BYTE(Byte.class, byte.class) { },\n+        SHORT(Short.class, short.class) { },\n+        INTEGER(Integer.class, int.class) { },\n+        LONG(Long.class, long.class) { },\n+        FLOAT(Float.class, float.class) { },\n+        DOUBLE(Double.class, double.class) { },\n+        BOOLEAN(Boolean.class, boolean.class) { },\n+        CHAR(Character.class, char.class) { };\n+\n+        private final Class<?> wrapper;\n+        private final Class<?> primitive;\n+\n+        PrimitiveTypes(Class<?> wrapper, Class<?> primitive) {\n+            this.wrapper = wrapper;\n+            this.primitive = primitive;\n+        }\n+\n+        public static PrimitiveTypes forType(Class<?> type) {\n+            for (PrimitiveTypes primitive : PrimitiveTypes.values()) {\n+                if (primitive.supports(type)) {\n+                    return primitive;\n+                }\n+            }\n+            return null;\n+        }\n+\n+        public boolean supports(Class<?> type) {\n+            return type == wrapper || type == primitive;\n+        }\n+    }\n+\n+    private static boolean isBasicType(Class<?> type) {\n+        return PrimitiveTypes.forType(type) != null || Number.class.isAssignableFrom(type);", "originalCommit": "90a1c094d71036f8ca2c24a9b721a1ac813702b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4NDYyMw==", "url": "https://github.com/apache/cxf/pull/697#discussion_r493884623", "bodyText": "Good call - I'm not sure why the PrimitiveTypes inner class was created... my first guess was performance, but it actually looks like it would perform worse.  I'll use your suggestion.", "author": "andymc12", "createdAt": "2020-09-23T20:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExMzg4OA=="}], "type": "inlineReview"}, {"oid": "13459f1f5a935e498c36b93b8b70e8b3c1a6180e", "url": "https://github.com/apache/cxf/commit/13459f1f5a935e498c36b93b8b70e8b3c1a6180e", "message": "TCK Changes for URI and hasEntity checks\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-09-23T20:33:49Z", "type": "commit"}, {"oid": "7f9a223ecaa7f05dfb632076447ed46c258f0061", "url": "https://github.com/apache/cxf/commit/7f9a223ecaa7f05dfb632076447ed46c258f0061", "message": "Code review comments\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-09-24T00:18:33Z", "type": "commit"}, {"oid": "7f9a223ecaa7f05dfb632076447ed46c258f0061", "url": "https://github.com/apache/cxf/commit/7f9a223ecaa7f05dfb632076447ed46c258f0061", "message": "Code review comments\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>", "committedDate": "2020-09-24T00:18:33Z", "type": "forcePushed"}]}