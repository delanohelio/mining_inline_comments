{"pr_number": 2737, "pr_title": "Assorted changes", "pr_createdAt": "2020-07-07T08:28:36Z", "pr_url": "https://github.com/h2database/h2database/pull/2737", "timeline": [{"oid": "79232cd5755611ebe134a99fa1dc2b194e7bbf6f", "url": "https://github.com/h2database/h2database/commit/79232cd5755611ebe134a99fa1dc2b194e7bbf6f", "message": "Extract checkMetaTables() from initMetaTable() to allow inline optimization", "committedDate": "2020-07-06T00:38:49Z", "type": "commit"}, {"oid": "60cc04bef0674c844896038a21f9c94ef34d638c", "url": "https://github.com/h2database/h2database/commit/60cc04bef0674c844896038a21f9c94ef34d638c", "message": "Don't check index conditions twice in InformationSchemaTable.indexes()", "committedDate": "2020-07-06T01:30:15Z", "type": "commit"}, {"oid": "211b4dc8ae429c0c88c384377a227914249c632a", "url": "https://github.com/h2database/h2database/commit/211b4dc8ae429c0c88c384377a227914249c632a", "message": "Don't check index conditions twice in InformationSchemaTable.columns()", "committedDate": "2020-07-06T01:42:53Z", "type": "commit"}, {"oid": "cc4e90a60fb3a82ec3143d862564458f63417c83", "url": "https://github.com/h2database/h2database/commit/cc4e90a60fb3a82ec3143d862564458f63417c83", "message": "Don't use Database.getAllTablesAndViews() when not necessary", "committedDate": "2020-07-06T05:42:23Z", "type": "commit"}, {"oid": "5b1ff08873977955ea83da547902681741dca52b", "url": "https://github.com/h2database/h2database/commit/5b1ff08873977955ea83da547902681741dca52b", "message": "Return false from supportsPositioned*() and supportsMultipleOpenResults()", "committedDate": "2020-07-06T08:47:17Z", "type": "commit"}, {"oid": "b93aa2335edf4ce59acda7a1ab509de16610e5d3", "url": "https://github.com/h2database/h2database/commit/b93aa2335edf4ce59acda7a1ab509de16610e5d3", "message": "Remove lastTriggerIdentity and test normal generated keys from a trigger", "committedDate": "2020-07-06T10:23:00Z", "type": "commit"}, {"oid": "a4e7d72b6677064da773c5aba9cab5ac844f095c", "url": "https://github.com/h2database/h2database/commit/a4e7d72b6677064da773c5aba9cab5ac844f095c", "message": "Remove MVTableEngine wrapper and create Store directly", "committedDate": "2020-07-07T01:19:42Z", "type": "commit"}, {"oid": "aa2a6e6763e64d964e0e1a87a83eaa98872eee9a", "url": "https://github.com/h2database/h2database/commit/aa2a6e6763e64d964e0e1a87a83eaa98872eee9a", "message": "Inline Database.openDatabase() into constructor", "committedDate": "2020-07-07T01:38:30Z", "type": "commit"}, {"oid": "bb6d65e0382aa787e02f7c084b45bbcb4dde9946", "url": "https://github.com/h2database/h2database/commit/bb6d65e0382aa787e02f7c084b45bbcb4dde9946", "message": "Extract assertion code from Database.lockMeta() into own method", "committedDate": "2020-07-07T02:00:20Z", "type": "commit"}, {"oid": "9b28c0d6c1549eab57a466794ac33ce0fc1a4be3", "url": "https://github.com/h2database/h2database/commit/9b28c0d6c1549eab57a466794ac33ce0fc1a4be3", "message": "Fix System.nanoTime() comparison in the main code", "committedDate": "2020-07-07T07:39:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwMjQ3Mg==", "url": "https://github.com/h2database/h2database/pull/2737#discussion_r450702472", "bodyText": "I think you broke a valid use-case of scope_identity(), which this test was checking .e.g see\nhttps://stackoverflow.com/a/1920640/6591", "author": "grandinj", "createdAt": "2020-07-07T08:40:20Z", "path": "h2/src/test/org/h2/test/jdbc/TestPreparedStatement.java", "diffHunk": "@@ -564,49 +562,6 @@ private void testUUIDAsJavaObject(Connection conn) throws SQLException {\n         stat.execute(\"drop table test_uuid\");\n     }\n \n-    /**\n-     * A trigger that creates a sequence value.\n-     */\n-    public static class SequenceTrigger implements Trigger {\n-\n-        @Override\n-        public void fire(Connection conn, Object[] oldRow, Object[] newRow)\n-                throws SQLException {\n-            conn.setAutoCommit(false);\n-            conn.createStatement().execute(\"call next value for seq\");\n-        }\n-\n-        @Override\n-        public void init(Connection conn, String schemaName,\n-                String triggerName, String tableName, boolean before, int type) {\n-            // ignore\n-        }\n-\n-    }\n-\n-    private void testScopedGeneratedKey(Connection conn) throws SQLException {\n-        Statement stat = conn.createStatement();\n-        stat.execute(\"create table test(id identity)\");\n-        stat.execute(\"create sequence seq start with 1000\");\n-        stat.execute(\"create trigger test_ins after insert on test call \\\"\" +\n-                SequenceTrigger.class.getName() + \"\\\"\");\n-        stat.execute(\"insert into test values(null)\", Statement.RETURN_GENERATED_KEYS);\n-        ResultSet rs = stat.getGeneratedKeys();\n-        rs.next();\n-        // Generated key\n-        assertEquals(1, rs.getLong(1));\n-        stat.execute(\"insert into test values(100)\");\n-        rs = stat.getGeneratedKeys();\n-        // No generated keys\n-        assertFalse(rs.next());\n-        // Value from sequence from trigger\n-        rs = stat.executeQuery(\"select scope_identity()\");", "originalCommit": "b93aa2335edf4ce59acda7a1ab509de16610e5d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMDc3OQ==", "url": "https://github.com/h2database/h2database/pull/2737#discussion_r450720779", "bodyText": "This test case ensures incorrect (according to our own documentation) behavior:\nhttps://h2database.com/html/functions.html#scope_identity\n\nChanges within triggers and Java functions are ignored.\n\nThis test case shouldn't see anything from the trigger.\nIn the real SQL Server, SCOPE_IDENTITY() actually returns NULL in the similar test case with sequence called in the trigger.\nOur implementations of IDENTITY() and SCOPE_IDENTITY() in general aren't fully compatible with anything. In the SQL Server they are about inserted values, not about called sequences.", "author": "katzyn", "createdAt": "2020-07-07T09:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwMjQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcyMjUwOQ==", "url": "https://github.com/h2database/h2database/pull/2737#discussion_r450722509", "bodyText": "Hmmm. OK.\nIn our case, inserting a value will effectively call a sequence to generate a new ID. So the test was really testing for the SQL Server behaviour.\nBut in general, SCOPE_IDENTITY is a pain anyhow, so this change is OK.", "author": "grandinj", "createdAt": "2020-07-07T09:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwMjQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczMjczNA==", "url": "https://github.com/h2database/h2database/pull/2737#discussion_r450732734", "bodyText": "Actually this PR doesn't break existing compatibility with SQL Server:\n-- MS SQL\nCREATE TABLE M(ID BIGINT IDENTITY(1, 1) PRIMARY KEY, VALUE INT);\nINSERT INTO M VALUES (10);\nCREATE TABLE T(ID BIGINT IDENTITY(1, 1) PRIMARY KEY, VALUE INT);\nCREATE TRIGGER TT ON M FOR INSERT AS BEGIN INSERT INTO T VALUES (30); END;\nINSERT INTO M VALUES (20);\nSELECT @@IDENTITY AS [IDENTITY], SCOPE_IDENTITY() AS [SCOPE_IDENTITY];\n> 1 2\n-- H2 (with and without these changes):\nCREATE TABLE M(ID IDENTITY PRIMARY KEY, V INT);\nINSERT INTO M(V) VALUES 10;\nCREATE TABLE T(ID IDENTITY PRIMARY KEY, V INT);\nCREATE TRIGGER TT AFTER INSERT ON M AS\n'org.h2.api.Trigger create() {\n    return new org.h2.api.Trigger() {\n        public void fire(Connection conn, Object[] oldRow, Object[] newRow) throws SQLException {\n            conn.setAutoCommit(false);\n            conn.createStatement().execute(\"INSERT INTO T(V) VALUES 30\");\n        }\n    };\n}';\nINSERT INTO M(V) VALUES 20;\nSELECT IDENTITY(), SCOPE_IDENTITY();\n> 1 2", "author": "katzyn", "createdAt": "2020-07-07T09:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwMjQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczNjc4MA==", "url": "https://github.com/h2database/h2database/pull/2737#discussion_r450736780", "bodyText": "But this removed test case tested the wrong behavior that was fixed here.\nWe have other test for generated keys from the trigger, so I don't see a reason for adjustments in this one.", "author": "katzyn", "createdAt": "2020-07-07T09:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwMjQ3Mg=="}], "type": "inlineReview"}, {"oid": "d977f0659940f74f76cd84a49a7a8841bdbf6994", "url": "https://github.com/h2database/h2database/commit/d977f0659940f74f76cd84a49a7a8841bdbf6994", "message": "Update changelog", "committedDate": "2020-07-07T10:27:11Z", "type": "commit"}]}