{"pr_number": 2637, "pr_title": "Add table not found candidates in error message", "pr_createdAt": "2020-05-21T23:51:49Z", "pr_url": "https://github.com/h2database/h2database/pull/2637", "timeline": [{"oid": "d1c7c545ab83685bff8459d29d8adb21b32328fe", "url": "https://github.com/h2database/h2database/commit/d1c7c545ab83685bff8459d29d8adb21b32328fe", "message": "feat: #2108 possible candidates if table not found", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "5930a67743f7213cfc64aeb22842bb05713927c6", "url": "https://github.com/h2database/h2database/commit/5930a67743f7213cfc64aeb22842bb05713927c6", "message": "feat: #2108 possible candidates if table not found", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "2416d21664296aa7c991502733e1ed64bfb6f97e", "url": "https://github.com/h2database/h2database/commit/2416d21664296aa7c991502733e1ed64bfb6f97e", "message": "feat: #2108 don't look for candidates when CASE_INSENSITIVE_IDENTIFIERS=TRUE", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "97c0bac9b21913f1e8dc6259d46e088ba935adff", "url": "https://github.com/h2database/h2database/commit/97c0bac9b21913f1e8dc6259d46e088ba935adff", "message": "test: #2108 enable tests", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "e74c9773333a5645278e06787678682c9f1f9782", "url": "https://github.com/h2database/h2database/commit/e74c9773333a5645278e06787678682c9f1f9782", "message": "fix: #2108 use DbSettings instead of StaticSettings", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "eb136626e9b2ad859ca13a5ff95d9a907024fd7d", "url": "https://github.com/h2database/h2database/commit/eb136626e9b2ad859ca13a5ff95d9a907024fd7d", "message": "feat: table or view not found if DB is empty", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "f8bb653d789a4ca5febd49110f4972bf70ac4882", "url": "https://github.com/h2database/h2database/commit/f8bb653d789a4ca5febd49110f4972bf70ac4882", "message": "refactor: #2108 rename method", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "e4be49d58bf86df47caf4e599da1a3028fa319c1", "url": "https://github.com/h2database/h2database/commit/e4be49d58bf86df47caf4e599da1a3028fa319c1", "message": "feat: #2108 German translation", "committedDate": "2020-05-21T23:43:39Z", "type": "commit"}, {"oid": "c701acb41473ffd026a4e83fd93b33ae605c9dee", "url": "https://github.com/h2database/h2database/commit/c701acb41473ffd026a4e83fd93b33ae605c9dee", "message": "docs: #2108 changelog", "committedDate": "2020-05-21T23:45:24Z", "type": "commit"}, {"oid": "a86f506a73345976bb9338646a38db827df38539", "url": "https://github.com/h2database/h2database/commit/a86f506a73345976bb9338646a38db827df38539", "message": "refactor: #2108 return exception to be thrown", "committedDate": "2020-05-21T23:45:24Z", "type": "commit"}, {"oid": "89a3409a4525b7ef8347c3d004fe162720989747", "url": "https://github.com/h2database/h2database/commit/89a3409a4525b7ef8347c3d004fe162720989747", "message": "docs: remove \"table not found when database is empty\"  from roadmap", "committedDate": "2020-05-21T23:45:24Z", "type": "commit"}, {"oid": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "url": "https://github.com/h2database/h2database/commit/0e68e6084669a55c94b6b2ef3df1f62c72fba822", "message": "fix: tests for table not found", "committedDate": "2020-05-21T23:45:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODM4OQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428998389", "bodyText": "_1 suffix almost everywhere means that error code has one parameter. Use different names for exceptions. They are also expected to be self-descriptive.\n\n\nVendor-specific codes can't start with '0', '1', '2', '3', '4', 'A', 'B', 'C', 'D', 'E', 'F', 'G', or 'H'. Don't use 42S here, add some plain 90*** codes instead.", "author": "katzyn", "createdAt": "2020-05-22T01:32:29Z", "path": "h2/src/main/org/h2/api/ErrorCode.java", "diffHunk": "@@ -2229,6 +2255,8 @@ public static String getState(int errorCode) {\n         // 42: syntax error or access rule violation\n         case TABLE_OR_VIEW_ALREADY_EXISTS_1: return \"42S01\";\n         case TABLE_OR_VIEW_NOT_FOUND_1: return \"42S02\";\n+        case TABLE_OR_VIEW_NOT_FOUND_2: return \"42S03\";\n+        case TABLE_OR_VIEW_NOT_FOUND_3: return \"42S04\";", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAzNzA0NQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429037045", "bodyText": "On the other hand, subclasses (last three characters) may be vendor-specific too. Standard class 42 means syntax error or access rule violation, but the most of such error states have vendor-specific class 90 in H2.\n@grandinj\nMaybe you have some opinion about these error codes / SQL states?", "author": "katzyn", "createdAt": "2020-05-22T04:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4MTQ5Nw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429081497", "bodyText": "I've never seen anybody even try to interpret these codes, so I largely don't care which ones we choose.", "author": "grandinj", "createdAt": "2020-05-22T07:15:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIxNzc5Nw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429217797", "bodyText": "If I were to interpret the error codes in my source code then I would expect to get standard codes where possible.", "author": "resident-uhlig", "createdAt": "2020-05-22T12:30:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIxOTg1Nw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429219857", "bodyText": "Please, improve names of these constants. We can think about error codes later.", "author": "katzyn", "createdAt": "2020-05-22T12:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5NTI1Ng==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429295256", "bodyText": "I have renamed the two new constants. There is actually a place where the error code is checked in H2 itself. See 0f5d162 for example.", "author": "resident-uhlig", "createdAt": "2020-05-22T14:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5ODcxNw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428998717", "bodyText": "This field (unlike fields above) is not expected to be read when database is null, to we don't need it. Setting can be read from the database only when necessary.", "author": "katzyn", "createdAt": "2020-05-22T01:33:56Z", "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -739,6 +744,11 @@\n      */\n     private final boolean identifiersToUpper;\n \n+    /**\n+     * @see org.h2.engine.DbSettings#caseInsensitiveIdentifiers\n+     */\n+    private final boolean caseInsensitiveIdentifiers;\n+", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5OTEyOQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428999129", "bodyText": "Please, remove this list, additional complications for the main code path are unwanted. You can build a list only if nothing was found.\nPass  name of the schema when known as String to getTableOrViewNotFoundDbException(), and pass null to it when unknown to iterate over getCurrentSchemaName() and getSchemaSearchPath() in that method.", "author": "katzyn", "createdAt": "2020-05-22T01:35:42Z", "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8601,14 +8613,16 @@ private Table readTableOrView() {\n     }\n \n     private Table readTableOrView(String tableName) {\n+        final List<Schema> schemas = new ArrayList<>();", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5MjU3Mg==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429292572", "bodyText": "I refactored it a little differently, please have a look", "author": "resident-uhlig", "createdAt": "2020-05-22T14:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5OTEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5OTQ0MQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r428999441", "bodyText": "Don't use streams here, they are slow (it doesn't matter here) and unreadable when there are multiple operations at once.\nIt looks like you can use Database.getFirstUserTable() here.", "author": "katzyn", "createdAt": "2020-05-22T01:36:49Z", "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8620,13 +8634,46 @@ private Table readTableOrView(String tableName) {\n                     if (table != null) {\n                         return table;\n                     }\n+                    schemas.add(s);\n                 }\n             }\n         }\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(schemas, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final List<Schema> schemas, final String tableName) {\n+        if (schemas.stream().map(Schema::getAllTablesAndViews).noneMatch(not(Collection::isEmpty))) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_3, tableName);\n+        }", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMDQ1Mg==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429000452", "bodyText": "Don't use streams here too, nobody will ever try to review it.\nAlso use StringUtils.toUpperEnglish(String) here, that's how H2 works in case-insensitive mode, this code is expected to be compatible with it. Conversions to lower/upper case can be unequal due to large amount of specially handled characters in Unicode, and, unfortunately, conversions are locale-specific even for some ASCII characters.\nI also don't understand what are you trying to do with ` characters.", "author": "katzyn", "createdAt": "2020-05-22T01:41:14Z", "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8620,13 +8634,46 @@ private Table readTableOrView(String tableName) {\n                     if (table != null) {\n                         return table;\n                     }\n+                    schemas.add(s);\n                 }\n             }\n         }\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(schemas, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final List<Schema> schemas, final String tableName) {\n+        if (schemas.stream().map(Schema::getAllTablesAndViews).noneMatch(not(Collection::isEmpty))) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_3, tableName);\n+        }\n+\n+        final java.util.Set<String> candidates =\n+            caseInsensitiveIdentifiers ?\n+                Collections.emptySet() :\n+                findQuotedTableNameCandidates(schemas, tableName);\n+\n+        if (candidates.isEmpty()) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_2,\n+            tableName,\n+            String.join(\", \", candidates));\n+    }\n+\n+    private java.util.Set<String> findQuotedTableNameCandidates(final List<Schema> schemas, final String tableName) {\n+        final String lcTableName = tableName.toLowerCase();\n+        return schemas.stream()\n+            .map(Schema::getAllTablesAndViews)\n+            .flatMap(Collection::stream)\n+            .map(Table::getName)\n+            .filter(c -> lcTableName.equals(c.toLowerCase()))\n+            .sorted()\n+            .map(c -> \"`\" + c + \"`\")\n+            .collect(Collectors.toCollection(TreeSet::new));", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMDg2OQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429000869", "bodyText": "Add ERROR_CODE=#ENGLISH_MESSAGE to all remaining localization files.", "author": "katzyn", "createdAt": "2020-05-22T01:42:56Z", "path": "h2/src/main/org/h2/res/_messages_en.prop", "diffHunk": "@@ -29,6 +29,8 @@\n 42602=Invalid name {0}\n 42S01=Table {0} already exists\n 42S02=Table {0} not found\n+42S03=Table {0} not found (candidates are: {1})\n+42S04=Table {0} not found (this database is empty)", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIyNTA5MQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429225091", "bodyText": "Sure, I'll do this. I see that there are some other messages in the German file which aren't translated. Would you mind if I translate them in a separate PR?", "author": "resident-uhlig", "createdAt": "2020-05-22T12:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMDg2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIyNzAwNA==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429227004", "bodyText": "Good idea.\nPlease, also take a look on h2/src/main/org/h2/server/web/res/_text_de.prop, it has a few missing entries too.", "author": "katzyn", "createdAt": "2020-05-22T12:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMDg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTAyMw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001023", "bodyText": "Please, remove this class, we don't need it in the main code.", "author": "katzyn", "createdAt": "2020-05-22T01:43:34Z", "path": "h2/src/main/org/h2/util/StreamUtils.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package org.h2.util;\r\n+\r\n+import java.util.function.Predicate;\r\n+\r\n+public abstract class StreamUtils {\r", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTI3NA==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001274", "bodyText": "Add a copyright header:\n/*\n * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n * and the EPL 1.0 (https://h2database.com/html/license.html).\n * Initial Developer: H2 Group\n */", "author": "katzyn", "createdAt": "2020-05-22T01:44:41Z", "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,170 @@\n+package org.h2.test.db;\r", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTM5Nw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001397", "bodyText": "Use 4 character for indentation (8 for wrapped lines).", "author": "katzyn", "createdAt": "2020-05-22T01:45:11Z", "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,170 @@\n+package org.h2.test.db;\r\n+\r\n+import java.sql.Connection;\r\n+import java.sql.SQLException;\r\n+import java.sql.Statement;\r\n+import org.h2.jdbc.JdbcConnection;\r\n+import org.h2.test.TestBase;\r\n+import org.h2.test.TestDb;\r\n+\r\n+public class TestAlterTableNotFound extends TestDb {\r\n+\r\n+  /**\r\n+   * Run just this test.\r\n+   *\r\n+   * @param a ignored\r\n+   */\r\n+  public static void main(String... a) throws Exception {\r\n+    TestBase.createCaller().init().testFromMain();\r", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwMTUwNQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429001505", "bodyText": "Header, indentation.", "author": "katzyn", "createdAt": "2020-05-22T01:45:31Z", "path": "h2/src/test/org/h2/test/db/TestSelectTableNotFound.java", "diffHunk": "@@ -0,0 +1,177 @@\n+package org.h2.test.db;\r", "originalCommit": "0e68e6084669a55c94b6b2ef3df1f62c72fba822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a072f54edaeb93a24e82f9169e071be678a4e2a", "url": "https://github.com/h2database/h2database/commit/8a072f54edaeb93a24e82f9169e071be678a4e2a", "message": "chore: make spellchecker happier", "committedDate": "2020-05-22T12:44:06Z", "type": "commit"}, {"oid": "7c82acea00a3a6ae477f1e0bb384bd00fc13ac00", "url": "https://github.com/h2database/h2database/commit/7c82acea00a3a6ae477f1e0bb384bd00fc13ac00", "message": "feat: #2637 fallbacks for missing translations", "committedDate": "2020-05-22T12:48:27Z", "type": "commit"}, {"oid": "5af206166bfaa88ca759e2cd0b87dc70e5541b2c", "url": "https://github.com/h2database/h2database/commit/5af206166bfaa88ca759e2cd0b87dc70e5541b2c", "message": "refactor: better names for table not found constants", "committedDate": "2020-05-22T12:55:40Z", "type": "commit"}, {"oid": "23649b928065c222d71bbc542a4642da8aa8062b", "url": "https://github.com/h2database/h2database/commit/23649b928065c222d71bbc542a4642da8aa8062b", "message": "refactor: avoid additional complications for the main code path", "committedDate": "2020-05-22T14:10:05Z", "type": "commit"}, {"oid": "0f5d162eeb109bc2b7bf5b64f087557f2bd20e2f", "url": "https://github.com/h2database/h2database/commit/0f5d162eeb109bc2b7bf5b64f087557f2bd20e2f", "message": "fix: additional error codes for table or view not found", "committedDate": "2020-05-22T14:25:51Z", "type": "commit"}, {"oid": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "url": "https://github.com/h2database/h2database/commit/d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "message": "test: updated error codes for table not found", "committedDate": "2020-05-22T14:41:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMjA5MQ==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429302091", "bodyText": "Please, don't use final modifiers for fields and local variables.", "author": "katzyn", "createdAt": "2020-05-22T15:05:58Z", "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8626,7 +8629,68 @@ private Table readTableOrView(String tableName) {\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String tableName) {", "originalCommit": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzI1MA==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429303250", "bodyText": "Pass candidates to findTableNameCandidates() instead of allocation of own set it in.", "author": "katzyn", "createdAt": "2020-05-22T15:08:10Z", "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8626,7 +8629,68 @@ private Table readTableOrView(String tableName) {\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String tableName) {\n+        if (schemaName != null) {\n+            return getTableOrViewNotFoundDbException(schemaName, tableName);\n+        }\n+\n+        final String currentSchemaName = session.getCurrentSchemaName();\n+        final String[] schemaSearchPath = session.getSchemaSearchPath();\n+        if (schemaSearchPath == null) {\n+            return getTableOrViewNotFoundDbException(Collections.singleton(currentSchemaName), tableName);\n+        }\n+\n+        final LinkedHashSet<String> schemaNames = new LinkedHashSet<>();\n+        schemaNames.add(currentSchemaName);\n+        schemaNames.addAll(Arrays.asList(schemaSearchPath));\n+        return getTableOrViewNotFoundDbException(schemaNames, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String schemaName, final String tableName) {\n+        return getTableOrViewNotFoundDbException(Collections.singleton(schemaName), tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(\n+            final java.util.Set<String> schemaNames, final String tableName) {\n+        if (database == null || database.getFirstUserTable() == null) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_DATABASE_EMPTY_1, tableName);\n+        }\n+\n+        if (database.getSettings().caseInsensitiveIdentifiers) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        final java.util.Set<String> candidates = new TreeSet<>();\n+        for (final String schemaName : schemaNames) {\n+            candidates.addAll(findTableNameCandidates(schemaName, tableName));\n+        }\n+", "originalCommit": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzMwMw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429303303", "bodyText": "Wrapped lines are indented with 8 spaces in sources of H2.", "author": "katzyn", "createdAt": "2020-05-22T15:08:15Z", "path": "h2/src/main/org/h2/command/Parser.java", "diffHunk": "@@ -8626,7 +8629,68 @@ private Table readTableOrView(String tableName) {\n         if (isDualTable(tableName)) {\n             return new DualTable(database);\n         }\n-        throw DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+\n+        throw getTableOrViewNotFoundDbException(tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String tableName) {\n+        if (schemaName != null) {\n+            return getTableOrViewNotFoundDbException(schemaName, tableName);\n+        }\n+\n+        final String currentSchemaName = session.getCurrentSchemaName();\n+        final String[] schemaSearchPath = session.getSchemaSearchPath();\n+        if (schemaSearchPath == null) {\n+            return getTableOrViewNotFoundDbException(Collections.singleton(currentSchemaName), tableName);\n+        }\n+\n+        final LinkedHashSet<String> schemaNames = new LinkedHashSet<>();\n+        schemaNames.add(currentSchemaName);\n+        schemaNames.addAll(Arrays.asList(schemaSearchPath));\n+        return getTableOrViewNotFoundDbException(schemaNames, tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(final String schemaName, final String tableName) {\n+        return getTableOrViewNotFoundDbException(Collections.singleton(schemaName), tableName);\n+    }\n+\n+    private DbException getTableOrViewNotFoundDbException(\n+            final java.util.Set<String> schemaNames, final String tableName) {\n+        if (database == null || database.getFirstUserTable() == null) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_DATABASE_EMPTY_1, tableName);\n+        }\n+\n+        if (database.getSettings().caseInsensitiveIdentifiers) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        final java.util.Set<String> candidates = new TreeSet<>();\n+        for (final String schemaName : schemaNames) {\n+            candidates.addAll(findTableNameCandidates(schemaName, tableName));\n+        }\n+\n+        if (candidates.isEmpty()) {\n+            return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_1, tableName);\n+        }\n+\n+        return DbException.get(ErrorCode.TABLE_OR_VIEW_NOT_FOUND_WITH_CANDIDATES_2,\n+            tableName,\n+            String.join(\", \", candidates));", "originalCommit": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMzg3MA==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429303870", "bodyText": "DATABASE_TO_UPPER=FALSE is enough.", "author": "katzyn", "createdAt": "2020-05-22T15:09:24Z", "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.test.db;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import org.h2.jdbc.JdbcConnection;\n+import org.h2.test.TestBase;\n+import org.h2.test.TestDb;\n+\n+public class TestAlterTableNotFound extends TestDb {\n+\n+    /**\n+     * Run just this test.\n+     *\n+     * @param a ignored\n+     */\n+    public static void main(String... a) throws Exception {\n+        TestBase.createCaller().init().testFromMain();\n+    }\n+\n+    @Override\n+    public void test() throws Exception {\n+        testWithoutAnyCandidate();\n+        testWithoutAnyCandidateWhenDatabaseToLower();\n+        testWithoutAnyCandidateWhenDatabaseToUpper();\n+        testWithoutAnyCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithOneCandidate();\n+        testWithOneCandidateWhenDatabaseToLower();\n+        testWithOneCandidateWhenDatabaseToUpper();\n+        testWithOneCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithTwoCandidates();\n+    }\n+\n+    private void testWithoutAnyCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection(\"DATABASE_TO_LOWER=false;DATABASE_TO_UPPER=false\");", "originalCommit": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwNDc1Mw==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429304753", "bodyText": "DATABASE_TO_LOWER=TRUE is enough.", "author": "katzyn", "createdAt": "2020-05-22T15:11:03Z", "path": "h2/src/test/org/h2/test/db/TestAlterTableNotFound.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.test.db;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import org.h2.jdbc.JdbcConnection;\n+import org.h2.test.TestBase;\n+import org.h2.test.TestDb;\n+\n+public class TestAlterTableNotFound extends TestDb {\n+\n+    /**\n+     * Run just this test.\n+     *\n+     * @param a ignored\n+     */\n+    public static void main(String... a) throws Exception {\n+        TestBase.createCaller().init().testFromMain();\n+    }\n+\n+    @Override\n+    public void test() throws Exception {\n+        testWithoutAnyCandidate();\n+        testWithoutAnyCandidateWhenDatabaseToLower();\n+        testWithoutAnyCandidateWhenDatabaseToUpper();\n+        testWithoutAnyCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithOneCandidate();\n+        testWithOneCandidateWhenDatabaseToLower();\n+        testWithOneCandidateWhenDatabaseToUpper();\n+        testWithOneCandidateWhenCaseInsensitiveIdentifiers();\n+        testWithTwoCandidates();\n+    }\n+\n+    private void testWithoutAnyCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection(\"DATABASE_TO_LOWER=false;DATABASE_TO_UPPER=false\");\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T2 ( ID INT IDENTITY )\");\n+        try {\n+            stat.execute(\"ALTER TABLE t1 DROP COLUMN ID\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found;\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithoutAnyCandidateWhenDatabaseToLower() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection(\"DATABASE_TO_LOWER=true;DATABASE_TO_UPPER=false\");", "originalCommit": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwOTUwOA==", "url": "https://github.com/h2database/h2database/pull/2637#discussion_r429309508", "bodyText": "Use SQL command here.\nhttps://h2database.com/html/commands.html#set_schema_search_path", "author": "katzyn", "createdAt": "2020-05-22T15:19:57Z", "path": "h2/src/test/org/h2/test/db/TestSelectTableNotFound.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.test.db;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import org.h2.engine.Session;\n+import org.h2.jdbc.JdbcConnection;\n+import org.h2.test.TestBase;\n+import org.h2.test.TestDb;\n+\n+public class TestSelectTableNotFound extends TestDb {\n+\n+    /**\n+     * Run just this test.\n+     *\n+     * @param a ignored\n+     */\n+    public static void main(String... a) throws Exception {\n+        TestBase.createCaller().init().testFromMain();\n+    }\n+\n+    @Override\n+    public void test() throws Exception {\n+        testWithoutAnyCandidate();\n+        testWithOneCandidate();\n+        testWithTwoCandidates();\n+        testWithSchema();\n+        testWithSchemaSearchPath();\n+        testWhenSchemaIsEmpty();\n+        testWithSchemaWhenSchemaIsEmpty();\n+        testWithSchemaSearchPathWhenSchemaIsEmpty();\n+    }\n+\n+    private void testWithoutAnyCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T2 ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM t1\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found;\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithOneCandidate() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T1 ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM t1\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found (candidates are: \\\"T1\\\")\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithTwoCandidates() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE Toast ( ID INT IDENTITY )\");\n+        stat.execute(\"CREATE TABLE TOAST ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM toast\");\n+            fail(\"Table `toast` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"toast\\\" not found (candidates are: \\\"TOAST, Toast\\\")\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithSchema() throws SQLException {\n+        deleteDb(getTestName());\n+        final Connection conn = getJdbcConnection();\n+        final Statement stat = conn.createStatement();\n+        stat.execute(\"CREATE TABLE T1 ( ID INT IDENTITY )\");\n+        try {\n+            stat.executeQuery(\"SELECT 1 FROM PUBLIC.t1\");\n+            fail(\"Table `t1` was accessible but should not have been.\");\n+        } catch (SQLException e) {\n+            final String message = e.getMessage();\n+            assertContains(message, \"Table \\\"t1\\\" not found (candidates are: \\\"T1\\\")\");\n+        }\n+\n+        conn.close();\n+        deleteDb(getTestName());\n+    }\n+\n+    private void testWithSchemaSearchPath() throws SQLException {\n+        deleteDb(getTestName());\n+        final JdbcConnection conn = getJdbcConnection();\n+        final Session session = (Session) conn.getSession();\n+        session.setSchemaSearchPath(new String[]{ \"PUBLIC\" });", "originalCommit": "d944b9792b09446cfbeb55e71860c1f9b9e60fbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f95052894b282e6dce6f534dacd5796b94e472c8", "url": "https://github.com/h2database/h2database/commit/f95052894b282e6dce6f534dacd5796b94e472c8", "message": "style: remove final", "committedDate": "2020-05-22T15:42:24Z", "type": "commit"}, {"oid": "d387bfed1e6222a7a543c4592e6dada9c8542737", "url": "https://github.com/h2database/h2database/commit/d387bfed1e6222a7a543c4592e6dada9c8542737", "message": "refactor: use one single TreeSet instance to collect candidates", "committedDate": "2020-05-22T15:48:20Z", "type": "commit"}, {"oid": "2f1829ff0aeda84e21ff66655846d5600dfc99cd", "url": "https://github.com/h2database/h2database/commit/2f1829ff0aeda84e21ff66655846d5600dfc99cd", "message": "test: removed redundant DB settings", "committedDate": "2020-05-22T16:08:40Z", "type": "commit"}, {"oid": "5c3d044c23b59a5776924a4e650af4217a2f499b", "url": "https://github.com/h2database/h2database/commit/5c3d044c23b59a5776924a4e650af4217a2f499b", "message": "Merge branch 'master' of github.com:h2database/h2database into feature/table-not-found-candidates", "committedDate": "2020-05-22T16:30:44Z", "type": "commit"}]}