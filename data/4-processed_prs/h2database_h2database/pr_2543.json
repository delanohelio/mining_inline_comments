{"pr_number": 2543, "pr_title": "Improve case specification support and fix some issues with it", "pr_createdAt": "2020-04-05T06:02:09Z", "pr_url": "https://github.com/h2database/h2database/pull/2543", "timeline": [{"oid": "cb9427e3ade02f8c080fd8dba11c3c8f8f267129", "url": "https://github.com/h2database/h2database/commit/cb9427e3ade02f8c080fd8dba11c3c8f8f267129", "message": "Add Operation1 as a base class for single-argument operations", "committedDate": "2020-04-04T09:13:19Z", "type": "commit"}, {"oid": "e18eb04ba8e53f1bb689955f1729e069df4f47cf", "url": "https://github.com/h2database/h2database/commit/e18eb04ba8e53f1bb689955f1729e069df4f47cf", "message": "Extract CAST to CastSpecification from Function", "committedDate": "2020-04-04T10:39:51Z", "type": "commit"}, {"oid": "0137ebbe203257bc61cf863fa083b4fb2ef9d072", "url": "https://github.com/h2database/h2database/commit/0137ebbe203257bc61cf863fa083b4fb2ef9d072", "message": "Move CASE tests into own file", "committedDate": "2020-04-04T11:29:58Z", "type": "commit"}, {"oid": "a94523f99d11c812aa3d85b8428de339022488ac", "url": "https://github.com/h2database/h2database/commit/a94523f99d11c812aa3d85b8428de339022488ac", "message": "Fix column not found exception in CASE", "committedDate": "2020-04-04T11:46:54Z", "type": "commit"}, {"oid": "b521b18e16f9650d60aa3e22cf0a72fe1f92ba0d", "url": "https://github.com/h2database/h2database/commit/b521b18e16f9650d60aa3e22cf0a72fe1f92ba0d", "message": "Use Operation2 as a base class for IntervalOperation", "committedDate": "2020-04-04T12:02:36Z", "type": "commit"}, {"oid": "ac9ccfbe38f1e75e148f32b82fa9b5182961fa46", "url": "https://github.com/h2database/h2database/commit/ac9ccfbe38f1e75e148f32b82fa9b5182961fa46", "message": "Add support for simple case with lists in when operand", "committedDate": "2020-04-05T04:39:30Z", "type": "commit"}, {"oid": "c85555bf587cdbb03474a35547ad600dcc434c3a", "url": "https://github.com/h2database/h2database/commit/c85555bf587cdbb03474a35547ad600dcc434c3a", "message": "Improve TestKeywords and add more SQL-92 keywords", "committedDate": "2020-04-05T05:27:21Z", "type": "commit"}, {"oid": "6c6fc478cb5137b4265867df9276b193224e7692", "url": "https://github.com/h2database/h2database/commit/6c6fc478cb5137b4265867df9276b193224e7692", "message": "Fix TestRecursiveQueries and update changelog", "committedDate": "2020-04-05T06:55:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2NjcwNA==", "url": "https://github.com/h2database/h2database/pull/2543#discussion_r403666704", "bodyText": "if you do this, you need to override getSubexpressionCount. But why not just use ArrayList, rather than replicating the functionality?\nLooking at this and the other places we're now using OperationN, perhaps OperationN should not be resposible for argument storage at all, OperationN can implement all its logic in terms of getSubexpression() and getSubexpressionCount().", "author": "grandinj", "createdAt": "2020-04-05T08:18:19Z", "path": "h2/src/main/org/h2/expression/SearchedCase.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.expression;\n+\n+import java.util.Arrays;\n+\n+import org.h2.engine.Session;\n+import org.h2.value.TypeInfo;\n+import org.h2.value.Value;\n+import org.h2.value.ValueNull;\n+\n+/**\n+ * A searched case.\n+ */\n+public class SearchedCase extends OperationN {\n+\n+    private int argsCount;", "originalCommit": "ac9ccfbe38f1e75e148f32b82fa9b5182961fa46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2NzkyNA==", "url": "https://github.com/h2database/h2database/pull/2543#discussion_r403667924", "bodyText": "I don't know why Function uses an own list, I just preserved it as it.\nBut I agree, its logic can be moved to OperationN.", "author": "katzyn", "createdAt": "2020-04-05T08:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2NjcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2ODY2OQ==", "url": "https://github.com/h2database/h2database/pull/2543#discussion_r403668669", "bodyText": "Function uses own special logic in addParameter() to throw the exception a little bit earlier. But I think there is no big difference when the exception will be thrown.", "author": "katzyn", "createdAt": "2020-04-05T08:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2NjcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2Njg3Mg==", "url": "https://github.com/h2database/h2database/pull/2543#discussion_r403666872", "bodyText": "this SimpleWhen1 vs SimpleWhenN thing seems like a lot of code for not much benefit. Why not just have SimpleWhenN ?", "author": "grandinj", "createdAt": "2020-04-05T08:19:35Z", "path": "h2/src/main/org/h2/expression/SimpleCase.java", "diffHunk": "@@ -0,0 +1,362 @@\n+/*\n+ * Copyright 2004-2020 H2 Group. Multiple-Licensed under the MPL 2.0,\n+ * and the EPL 1.0 (https://h2database.com/html/license.html).\n+ * Initial Developer: H2 Group\n+ */\n+package org.h2.expression;\n+\n+import org.h2.engine.Session;\n+import org.h2.table.ColumnResolver;\n+import org.h2.table.TableFilter;\n+import org.h2.value.TypeInfo;\n+import org.h2.value.Value;\n+import org.h2.value.ValueNull;\n+\n+/**\n+ * A simple case.\n+ */\n+public class SimpleCase extends Expression {\n+\n+    public static abstract class SimpleWhen {\n+\n+        Expression result;\n+\n+        SimpleWhen next;\n+\n+        SimpleWhen(Expression result) {\n+            this.result = result;\n+        }\n+\n+        public void addWhen(SimpleWhen next) {\n+            this.next = next;\n+        }\n+\n+    }\n+\n+    public static final class SimpleWhen1 extends SimpleWhen {\n+\n+        Expression operand;\n+\n+        public SimpleWhen1(Expression operand, Expression result) {\n+            super(result);\n+            this.operand = operand;\n+        }\n+\n+    }\n+\n+    public static final class SimpleWhenN extends SimpleWhen {\n+\n+        Expression[] operands;\n+\n+        Expression result;\n+\n+        public SimpleWhenN(Expression[] operands, Expression result) {\n+            super(result);\n+            this.operands = operands;\n+        }\n+\n+    }", "originalCommit": "ac9ccfbe38f1e75e148f32b82fa9b5182961fa46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2ODExMw==", "url": "https://github.com/h2database/h2database/pull/2543#discussion_r403668113", "bodyText": "I'll merge them, you're right, specialized implementation for typical case with only one operand doesn't improve performance due to all these branches.", "author": "katzyn", "createdAt": "2020-04-05T08:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY2Njg3Mg=="}], "type": "inlineReview"}, {"oid": "6978fda927e62fcf66198768c2382ae4fca92d05", "url": "https://github.com/h2database/h2database/commit/6978fda927e62fcf66198768c2382ae4fca92d05", "message": "Move addParameter() to OperationN", "committedDate": "2020-04-05T08:47:57Z", "type": "commit"}, {"oid": "980f27dbf0a157c003e14cb3a710564d1ca09157", "url": "https://github.com/h2database/h2database/commit/980f27dbf0a157c003e14cb3a710564d1ca09157", "message": "Use only one implementation of simple when clause", "committedDate": "2020-04-05T08:56:23Z", "type": "commit"}]}