{"pr_number": 2613, "pr_title": "Add support for TZH and TZM in TO_CHAR function", "pr_createdAt": "2020-05-07T22:47:51Z", "pr_url": "https://github.com/h2database/h2database/pull/2613", "timeline": [{"oid": "d7c400d7f92c0782ae9097a229fa86aab468c28f", "url": "https://github.com/h2database/h2database/commit/d7c400d7f92c0782ae9097a229fa86aab468c28f", "message": "ADD:\nSupport for TZH/TZM tokens in TO_CHAR", "committedDate": "2020-05-06T23:26:27Z", "type": "commit"}, {"oid": "ef07daf781b71946804860c8a87e5902cd437544", "url": "https://github.com/h2database/h2database/commit/ef07daf781b71946804860c8a87e5902cd437544", "message": "ADD:\nSupport for TZH/TZM tokens in TO_CHAR", "committedDate": "2020-05-07T00:06:01Z", "type": "commit"}, {"oid": "97351b7dda7a9b32b11b7ecd73e0a30f39603c19", "url": "https://github.com/h2database/h2database/commit/97351b7dda7a9b32b11b7ecd73e0a30f39603c19", "message": "Merge remote-tracking branch 'origin/master'\n\n# Conflicts:\n#\th2/src/test/org/h2/test/db/TestFunctions.java", "committedDate": "2020-05-07T00:06:24Z", "type": "commit"}, {"oid": "9a40a273508dc786cf9a0c34d4aaa855e632b558", "url": "https://github.com/h2database/h2database/commit/9a40a273508dc786cf9a0c34d4aaa855e632b558", "message": "FIXED: incorrect output when using negative offsets.", "committedDate": "2020-05-07T01:30:31Z", "type": "commit"}, {"oid": "509bd451c9b890e5500884993cbffedf896ea92f", "url": "https://github.com/h2database/h2database/commit/509bd451c9b890e5500884993cbffedf896ea92f", "message": "Remove server-side only code from DateTimeUtils.java", "committedDate": "2020-05-07T21:31:42Z", "type": "commit"}, {"oid": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "url": "https://github.com/h2database/h2database/commit/e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "message": "Add a few more test cases", "committedDate": "2020-05-07T22:22:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMDcwMg==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421910702", "bodyText": "Increase visibility of DateTimeFunctions.extractIntegerField() and use it here (DateTimeFunctions.extractIntegerField(session, DateTimeFunctions.TIMEZONE_HOUR, value);.\n\n\nPass StringBuilder directly to this method and to printTimeZoneHoursFromOffsetSeconds().\n\n\nInline printTimeZoneHoursFromOffsetSeconds() into this method.\n\n\nIf resulting method will be not very large, inline it into toCharDateTime().", "author": "katzyn", "createdAt": "2020-05-08T03:06:03Z", "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -546,6 +546,54 @@ private static String getTimeZone(Session session, Value value, boolean tzd) {\n         }\n     }\n \n+    private static String getTimeZoneHours(Session session, Value value) {\n+        if(value instanceof ValueTimestampTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds(((ValueTimestampTimeZone) value).getTimeZoneOffsetSeconds());\n+        } else if( value instanceof ValueTimeTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds( ((ValueTimeTimeZone)value).getTimeZoneOffsetSeconds());\n+        } else {\n+            TimeZoneProvider tz = session.currentTimeZone();\n+            ValueTimestamp v = (ValueTimestamp) value.convertTo(TypeInfo.TYPE_TIMESTAMP, session);\n+            return printTimeZoneHoursFromOffsetSeconds(tz.getTimeZoneOffsetLocal(v.getDateValue(), v.getTimeNanos()));\n+        }", "originalCommit": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMDk2Mw==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421910963", "bodyText": "The same here.", "author": "katzyn", "createdAt": "2020-05-08T03:06:58Z", "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -546,6 +546,54 @@ private static String getTimeZone(Session session, Value value, boolean tzd) {\n         }\n     }\n \n+    private static String getTimeZoneHours(Session session, Value value) {\n+        if(value instanceof ValueTimestampTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds(((ValueTimestampTimeZone) value).getTimeZoneOffsetSeconds());\n+        } else if( value instanceof ValueTimeTimeZone) {\n+            return printTimeZoneHoursFromOffsetSeconds( ((ValueTimeTimeZone)value).getTimeZoneOffsetSeconds());\n+        } else {\n+            TimeZoneProvider tz = session.currentTimeZone();\n+            ValueTimestamp v = (ValueTimestamp) value.convertTo(TypeInfo.TYPE_TIMESTAMP, session);\n+            return printTimeZoneHoursFromOffsetSeconds(tz.getTimeZoneOffsetLocal(v.getDateValue(), v.getTimeNanos()));\n+        }\n+    }\n+\n+    private static String getTimeZoneMinutes(Session session, Value value) {\n+        if(value instanceof ValueTimestampTimeZone) {\n+            return printTimeZoneMinutesFromOffsetSeconds(((ValueTimestampTimeZone) value).getTimeZoneOffsetSeconds());\n+        } else if( value instanceof ValueTimeTimeZone) {\n+            return printTimeZoneMinutesFromOffsetSeconds( ((ValueTimeTimeZone)value).getTimeZoneOffsetSeconds());\n+        } else {\n+            TimeZoneProvider tz = session.currentTimeZone();\n+            ValueTimestamp v = (ValueTimestamp) value.convertTo(TypeInfo.TYPE_TIMESTAMP, session);\n+            return printTimeZoneMinutesFromOffsetSeconds(tz.getTimeZoneOffsetLocal(v.getDateValue(), v.getTimeNanos()));\n+        }", "originalCommit": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMTAyNw==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421911027", "bodyText": "Please, remove this extra line.", "author": "katzyn", "createdAt": "2020-05-08T03:07:16Z", "path": "h2/src/main/org/h2/util/DateTimeUtils.java", "diffHunk": "@@ -1077,6 +1077,7 @@ public static String timeZoneNameFromOffsetSeconds(int offsetSeconds) {\n         return b.toString();\n     }\n \n+", "originalCommit": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkxMjgwNQ==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r421912805", "bodyText": "Please, add space after if and move // Week comment below.", "author": "katzyn", "createdAt": "2020-05-08T03:14:02Z", "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -831,6 +879,14 @@ public static String toCharDateTime(Session session, Value value, String format,\n \n                 // Week\n \n+            } else if(containsAt(format, i, \"TZH\") != null) {\n+                output.append(getTimeZoneHours(session, value));\n+                i += 3;\n+\n+            } else if(containsAt(format, i, \"TZM\") != null) {", "originalCommit": "e4eac17a0a0650d4bff9c0daf5ec4cb7d21c7148", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a04618cdff10e2f589caefe33d80da4ed564460c", "url": "https://github.com/h2database/h2database/commit/a04618cdff10e2f589caefe33d80da4ed564460c", "message": "- addressing review items", "committedDate": "2020-06-22T03:12:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5ODcwOA==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r443298708", "bodyText": "Please, remove result and b, there is no need for their allocation. You can append everything to the output directly.", "author": "katzyn", "createdAt": "2020-06-22T03:16:27Z", "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -828,9 +828,32 @@ public static String toCharDateTime(Session session, Value value, String format,\n             } else if (containsAt(format, i, \"TZD\") != null) {\n                 output.append(getTimeZone(session, value, true));\n                 i += 3;\n+            } else if (containsAt(format, i, \"TZH\") != null) {\n+                String result;\n+                int hours = DateTimeFunctions.extractIntegerField(session, value, DateTimeFunctions.TIMEZONE_HOUR);\n+                StringBuilder b = new StringBuilder();", "originalCommit": "a04618cdff10e2f589caefe33d80da4ed564460c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5OTIyOA==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r443299228", "bodyText": "output.append(\"00\") / StringUtils.appendTwoDigits(output, mins).\nAlso add a space between if and ( here and above.", "author": "katzyn", "createdAt": "2020-06-22T03:19:31Z", "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -828,9 +828,32 @@ public static String toCharDateTime(Session session, Value value, String format,\n             } else if (containsAt(format, i, \"TZD\") != null) {\n                 output.append(getTimeZone(session, value, true));\n                 i += 3;\n+            } else if (containsAt(format, i, \"TZH\") != null) {\n+                String result;\n+                int hours = DateTimeFunctions.extractIntegerField(session, value, DateTimeFunctions.TIMEZONE_HOUR);\n+                StringBuilder b = new StringBuilder();\n+                b.append( hours < 0 ? '-' : '+');\n+                hours = Math.abs(hours);\n+                if(hours == 0) {\n+                    result = b.append(\"00\").toString();\n+                } else {\n+                    result = StringUtils.appendTwoDigits(b, hours).toString();\n+                }\n+                output.append(result);\n+                i += 3;\n \n-                // Week\n+            } else if (containsAt(format, i, \"TZM\") != null) {\n+                String result;\n+                int mins = Math.abs(DateTimeFunctions.extractIntegerField(session, value, DateTimeFunctions.TIMEZONE_MINUTE));\n+                if(mins == 0) {\n+                    result = \"00\";\n+                } else {\n+                    result = StringUtils.appendTwoDigits(new StringBuilder(), mins).toString();\n+                }", "originalCommit": "a04618cdff10e2f589caefe33d80da4ed564460c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "869b5bd0e34f6976f9fd52ef50a51d479eb6e82f", "url": "https://github.com/h2database/h2database/commit/869b5bd0e34f6976f9fd52ef50a51d479eb6e82f", "message": "Merge remote-tracking branch 'upstream/master'\n\n# Conflicts:\n#\th2/src/main/org/h2/expression/function/DateTimeFunction.java", "committedDate": "2020-06-22T03:59:26Z", "type": "commit"}, {"oid": "01c36497b5ad2015712b2536df969a1dc28c036a", "url": "https://github.com/h2database/h2database/commit/01c36497b5ad2015712b2536df969a1dc28c036a", "message": "- addressing more review items", "committedDate": "2020-06-22T04:02:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwNzc3OQ==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r443307779", "bodyText": "BTW, what is the point of this condition? Unconditional StringUtils.appendTwoDigits(output, hours) should produce the same result, or I'm missing something?", "author": "katzyn", "createdAt": "2020-06-22T04:07:02Z", "path": "h2/src/main/org/h2/expression/function/ToChar.java", "diffHunk": "@@ -835,9 +835,27 @@ public static String toCharDateTime(Session session, Value value, String format,\n             } else if (containsAt(format, i, \"TZD\") != null) {\n                 output.append(getTimeZone(session, value, true));\n                 i += 3;\n+            } else if (containsAt(format, i, \"TZH\") != null) {\n+                int hours = DateTimeFunction.extractDateTime(session, value, DateTimeFunction.TIMEZONE_HOUR);\n+                output.append( hours < 0 ? '-' : '+');\n+                hours = Math.abs(hours);\n+                if (hours == 0) {\n+                    output.append(\"00\");\n+                } else {\n+                  StringUtils.appendTwoDigits(output, hours);\n+                }", "originalCommit": "01c36497b5ad2015712b2536df969a1dc28c036a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwODU3OQ==", "url": "https://github.com/h2database/h2database/pull/2613#discussion_r443308579", "bodyText": "There's no difference, I've made that change", "author": "paroxysm", "createdAt": "2020-06-22T04:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMwNzc3OQ=="}], "type": "inlineReview"}, {"oid": "7fc90434bc78e96a6fb604e70d88efc1ee07c0c0", "url": "https://github.com/h2database/h2database/commit/7fc90434bc78e96a6fb604e70d88efc1ee07c0c0", "message": "- clean up un-necessary code even further.", "committedDate": "2020-06-22T04:10:45Z", "type": "commit"}]}