{"pr_number": 3260, "pr_title": "[NCL-5910] add DB migration script for artifact -built-by-> build rel\u2026", "pr_createdAt": "2020-08-24T09:28:09Z", "pr_url": "https://github.com/project-ncl/pnc/pull/3260", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3MzU3Mw==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477173573", "bodyText": "What does \"AS agg\" accomplish? Is that intentional?", "author": "michalovjan", "createdAt": "2020-08-26T09:42:06Z", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;", "originalCommit": "c4ef7279055637b9dd82eb2790d6b240ff6835e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI3ODM2MA==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478278360", "bodyText": "Fixes ERROR:  subquery in FROM must have an alias", "author": "janinko", "createdAt": "2020-08-27T09:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3MzU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzMDc1Ng==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478330756", "bodyText": "Sure!", "author": "michalovjan", "createdAt": "2020-08-27T10:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3MzU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3NzE2OA==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477177168", "bodyText": "It should be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n          \n          \n            \n                ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (buildrecord_id) REFERENCES buildrecord(id);", "author": "michalovjan", "createdAt": "2020-08-26T09:48:12Z", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);", "originalCommit": "c4ef7279055637b9dd82eb2790d6b240ff6835e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3OTcwMw==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477179703", "bodyText": "Add the Index also to Artifact model here \n  \n    \n      pnc/model/src/main/java/org/jboss/pnc/model/Artifact.java\n    \n    \n         Line 71\n      in\n      b9b4867\n    \n    \n    \n    \n\n        \n          \n           indexes = { @Index(name = \"idx_artifact_targetRepository\", columnList = \"targetRepository_id\"),", "author": "michalovjan", "createdAt": "2020-08-26T09:52:31Z", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);", "originalCommit": "c4ef7279055637b9dd82eb2790d6b240ff6835e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE4MTg3Ng==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r477181876", "bodyText": "Are old associated indexes and constraints also dropped or do you have to do it manually?", "author": "michalovjan", "createdAt": "2020-08-26T09:56:18Z", "path": "model/src/main/resources/db-update/20000-from-1.8.x-to-2.0.0.sql", "diffHunk": "@@ -188,3 +188,34 @@ BEGIN transaction;\n     ALTER TABLE buildrecord ADD CONSTRAINT fk_buildrecord_norebuildcause\n     FOREIGN KEY (norebuildcause_id) REFERENCES buildrecord(id);\n COMMIT;\n+\n+\n+BEGIN transaction;\n+\n+    -- Verify that there are no duplicate data\n+    do $$\n+    declare\n+        total_dupes integer;\n+    begin\n+        SELECT count(*)\n+        INTO total_dupes\n+        FROM (SELECT built_artifact_id FROM build_record_built_artifact_map GROUP BY built_artifact_id HAVING count(*) > 1) AS agg;\n+\n+        assert total_dupes = 0;\n+    end$$;\n+\n+    -- Add new column to artifact table\n+    ALTER TABLE artifact ADD column buildrecord_id int4;\n+    CREATE INDEX idx_artifact_buildrecord ON artifact (buildrecord_id);\n+    ALTER TABLE artifact ADD CONSTRAINT fk_artifact_buildrecord FOREIGN KEY (fk_artifact_buildrecord) REFERENCES buildrecord(id);\n+\n+    -- Copy data from old table\n+    UPDATE artifact\n+        SET buildrecord_id = build_record_built_artifact_map.build_record_id\n+        FROM build_record_built_artifact_map\n+        WHERE artifact.id = build_record_built_artifact_map.built_artifact_id;\n+\n+    -- Drop the old table\n+    DROP TABLE build_record_built_artifact_map;", "originalCommit": "c4ef7279055637b9dd82eb2790d6b240ff6835e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI4MTUwOQ==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478281509", "bodyText": "Seems so.", "author": "janinko", "createdAt": "2020-08-27T09:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE4MTg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzMDg5OQ==", "url": "https://github.com/project-ncl/pnc/pull/3260#discussion_r478330899", "bodyText": "ok", "author": "michalovjan", "createdAt": "2020-08-27T10:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE4MTg3Ng=="}], "type": "inlineReview"}, {"oid": "5c950b156aff8a952af80d99d291702fd756c0d1", "url": "https://github.com/project-ncl/pnc/commit/5c950b156aff8a952af80d99d291702fd756c0d1", "message": "[NCL-5910] add DB migration script for artifact -built-by-> build relationship", "committedDate": "2020-08-27T09:28:21Z", "type": "commit"}, {"oid": "5c950b156aff8a952af80d99d291702fd756c0d1", "url": "https://github.com/project-ncl/pnc/commit/5c950b156aff8a952af80d99d291702fd756c0d1", "message": "[NCL-5910] add DB migration script for artifact -built-by-> build relationship", "committedDate": "2020-08-27T09:28:21Z", "type": "forcePushed"}]}