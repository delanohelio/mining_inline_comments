{"pr_number": 2823, "pr_title": "Ncl 5400 - Enable the second level cache", "pr_createdAt": "2020-01-30T10:30:09Z", "pr_url": "https://github.com/project-ncl/pnc/pull/2823", "timeline": [{"oid": "fe4591635a470622486f71bd901394181c549f24", "url": "https://github.com/project-ncl/pnc/commit/fe4591635a470622486f71bd901394181c549f24", "message": "Configure batch size to improve performance when doing bulk inserts and updates", "committedDate": "2020-01-30T09:48:34Z", "type": "commit"}, {"oid": "6d4e2665364a244d05b46ca3987f4bcfecbabcd4", "url": "https://github.com/project-ncl/pnc/commit/6d4e2665364a244d05b46ca3987f4bcfecbabcd4", "message": "Enable second level cache", "committedDate": "2020-01-30T10:17:31Z", "type": "commit"}, {"oid": "ee7c05305df005adb9c9e58a17a295115eae84e6", "url": "https://github.com/project-ncl/pnc/commit/ee7c05305df005adb9c9e58a17a295115eae84e6", "message": "Raise errors instead of warnings in case pagination is done in memory", "committedDate": "2020-01-30T10:28:53Z", "type": "commit"}, {"oid": "649d64f47aa80b0d43fb0f4bb12be1e176a6db27", "url": "https://github.com/project-ncl/pnc/commit/649d64f47aa80b0d43fb0f4bb12be1e176a6db27", "message": "Fix test for PNC 2.0 model", "committedDate": "2020-01-30T11:11:28Z", "type": "commit"}, {"oid": "83d8fe81d388ca035f4761a7a2628561e6e50b01", "url": "https://github.com/project-ncl/pnc/commit/83d8fe81d388ca035f4761a7a2628561e6e50b01", "message": "Added caching to collections", "committedDate": "2020-01-30T16:41:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3OTkzNg==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373479936", "bodyText": "It would be good to monitor the size of the cache. My feeling is that higher number might be better for us as we have milions of artifacts and my feeling is that we might fill the cache quite quickly. I'd consider adding a metrics for it and increasing the cache for artifacts.", "author": "jbartece", "createdAt": "2020-01-31T13:32:35Z", "path": "datastore/src/main/resources/META-INF/persistence.xml", "diffHunk": "@@ -37,6 +38,43 @@\n           <property name=\"org.hibernate.envers.do_not_audit_optimistic_locking_field\" value=\"false\"/>\n           <property name=\"hibernate.generate_statistics\" value=\"true\" />\n \n+          <!-- Configure batches to improve performance when doing bulk inserts and updates.\n+               Do not exceed with the size because when an entity is persisted, Hibernate stores it in the persistence context (in memory) before flushing.\n+          -->\n+          <property name=\"hibernate.jdbc.batch_size\" value=\"50\"/>\n+          <property name=\"hibernate.order_inserts\" value=\"true\"/>\n+          <property name=\"hibernate.order_updates\" value=\"true\"/>\n+          <property name=\"hibernate.batch_versioned_data\" value=\"true\"/>\n+\n+          <!-- Raise error instead of warning if \u201cHHH000104: firstResult/maxResults specified with collection fetch; applying in memory!\u201d is detected (since Hibernate 5.2.13) -->\n+          <property name=\"hibernate.query.fail_on_pagination_over_collection_fetch\" value=\"true\"/>\n+\n+          <!--\n+              Infinispan second level cache (default Wildfly settings are\n+              https://infinispan.org/docs/stable/titles/integrating/integrating.html#default_local_configuration_second_level):\n+                - Eviction wake up interval is 5 seconds.\n+                - Max number of entries are 10,000.", "originalCommit": "83d8fe81d388ca035f4761a7a2628561e6e50b01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4MzU3MQ==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373483571", "bodyText": "Yes, that is the purpose of the REST endpoints implemented in https://projects.engineering.redhat.com/browse/NCL-5408. They will expose (once 2LC is enabled) all those information, along with the total size of the cache in memory. I have also progressed in displaying many of the in Grafana (https://projects.engineering.redhat.com/browse/NCL-5417), by enhancing the pnc-status service (https://projects.engineering.redhat.com/browse/NCL-5411), so this is all working. The last dashboard will display the stats for the 2nd level cache as per above (rest endpoints now returns no value as 2nd level cache is not enable yet).", "author": "vibe13", "createdAt": "2020-01-31T13:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3OTkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5MDE1Mg==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373490152", "bodyText": "@vibe13 Great! :-)", "author": "jbartece", "createdAt": "2020-01-31T13:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3OTkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4MTczNA==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373481734", "bodyText": "Shouldn't we use Infinispan version bundled with EAP?", "author": "jbartece", "createdAt": "2020-01-31T13:37:01Z", "path": "pom.xml", "diffHunk": "@@ -131,6 +131,7 @@\n     <version.jackson.databind>2.10.1</version.jackson.databind>\n     <version.org.jboss.resteasy>3.6.1.SP5</version.org.jboss.resteasy>\n     <version.hibernate>5.3.10.Final</version.hibernate>\n+    <version.org.infinispan>9.3.6.Final</version.org.infinispan>", "originalCommit": "83d8fe81d388ca035f4761a7a2628561e6e50b01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4NDQ3NQ==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373484475", "bodyText": "Yes, that is only required for the tests in the model module which use a RESOURCE_LOCAL persistence unit, and that seems to need an additional artifact. Should work out of the box for the standard persistence unit.", "author": "vibe13", "createdAt": "2020-01-31T13:43:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4MTczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5MDU5Mg==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373490592", "bodyText": "Isn't it enough to use the version of infinispan defined in EAP BOM?", "author": "jbartece", "createdAt": "2020-01-31T13:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4MTczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxMTUwMA==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373511500", "bodyText": "that dependency is not in the EAP BOM we use org.jboss.bom:jboss-eap-javaee8 , but it's listed in the eap-runtime-artifacts BOM. So I could import org.jboss.bom:eap-runtime-artifacts:7.2.2.GA and avoid to specify the infinispan version", "author": "vibe13", "createdAt": "2020-01-31T14:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4MTczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyMDgxNg==", "url": "https://github.com/project-ncl/pnc/pull/2823#discussion_r373520816", "bodyText": "I didn't realize we don't use the runtime-artifacts BOM. Not sure it is worth adding it just for this one artifact for tests.\nLet's leave it as is", "author": "jbartece", "createdAt": "2020-01-31T14:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4MTczNA=="}], "type": "inlineReview"}]}