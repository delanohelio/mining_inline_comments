{"pr_number": 3080, "pr_title": "[NCL-5680] - Update the model related to Artifacts and revision of quality levels change", "pr_createdAt": "2020-06-04T07:43:48Z", "pr_url": "https://github.com/project-ncl/pnc/pull/3080", "timeline": [{"oid": "cd3480d0236426896bed32b90a788e0924711100", "url": "https://github.com/project-ncl/pnc/commit/cd3480d0236426896bed32b90a788e0924711100", "message": "Rebase to solve some conflicts with latest changes on master branch", "committedDate": "2020-06-05T15:41:37Z", "type": "forcePushed"}, {"oid": "6c10ea04baf63a1db7b98f77cc47eac3b8cd1d57", "url": "https://github.com/project-ncl/pnc/commit/6c10ea04baf63a1db7b98f77cc47eac3b8cd1d57", "message": "Remove creationTime and creationUser from the audited fields in Artifacts", "committedDate": "2020-06-08T12:59:09Z", "type": "forcePushed"}, {"oid": "055d33be78591fe5e1ab2984b07ba22716d64c89", "url": "https://github.com/project-ncl/pnc/commit/055d33be78591fe5e1ab2984b07ba22716d64c89", "message": "Added ArtifactAudited table to audit Quality label related fields in the Artifact table", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "3b16524b029a68fc106a5122e262e22fadf55f96", "url": "https://github.com/project-ncl/pnc/commit/3b16524b029a68fc106a5122e262e22fadf55f96", "message": "Fix typo", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "0a474949ad91f10b1f75e3f300016f455d6874a3", "url": "https://github.com/project-ncl/pnc/commit/0a474949ad91f10b1f75e3f300016f455d6874a3", "message": "When an artifact is updated, change modificationUser and modificationTime only if the audited fields related to Quality labels have changed", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "e064705ffa94dc35902b21efc68d2069798d0a8a", "url": "https://github.com/project-ncl/pnc/commit/e064705ffa94dc35902b21efc68d2069798d0a8a", "message": "When storing or updating an artifact, set the creation and modification properties; added tests", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "c0d175d328610644b71d3f7c700fb874999f312e", "url": "https://github.com/project-ncl/pnc/commit/c0d175d328610644b71d3f7c700fb874999f312e", "message": "Added endpoints for the ArtifactAudited entities; added tests", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "fb986a2a9aa80134666f146a8812c6c7d19bde07", "url": "https://github.com/project-ncl/pnc/commit/fb986a2a9aa80134666f146a8812c6c7d19bde07", "message": "Fix formatting", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "1c7581cb58eddc73b4c1bad62aa4d3e0a5e8e7b8", "url": "https://github.com/project-ncl/pnc/commit/1c7581cb58eddc73b4c1bad62aa4d3e0a5e8e7b8", "message": "Rebase to solve some conflicts with latest changes on master branch", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "52b545274f6d5f748aa1bc27fddc5997cb1534d0", "url": "https://github.com/project-ncl/pnc/commit/52b545274f6d5f748aa1bc27fddc5997cb1534d0", "message": "Remove creationTime and creationUser from the audited fields in Artifacts", "committedDate": "2020-06-09T08:15:14Z", "type": "commit"}, {"oid": "db776e1c350d0a6b406299bb723c09bbd2cac1b3", "url": "https://github.com/project-ncl/pnc/commit/db776e1c350d0a6b406299bb723c09bbd2cac1b3", "message": "Refactor the reason of quality setting to qualityLevelReason", "committedDate": "2020-06-09T09:54:41Z", "type": "commit"}, {"oid": "db776e1c350d0a6b406299bb723c09bbd2cac1b3", "url": "https://github.com/project-ncl/pnc/commit/db776e1c350d0a6b406299bb723c09bbd2cac1b3", "message": "Refactor the reason of quality setting to qualityLevelReason", "committedDate": "2020-06-09T09:54:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzMzMA==", "url": "https://github.com/project-ncl/pnc/pull/3080#discussion_r437377330", "bodyText": "Do we want to create new revision when the Quality level doesn't change? That means there will be 2 revisions only different with modificationUser and modificationTime but nothing else changed.", "author": "janinko", "createdAt": "2020-06-09T12:35:10Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ArtifactProviderImpl.java", "diffHunk": "@@ -91,14 +119,26 @@ public ArtifactProviderImpl(\n     @Override\n     @RolesAllowed(SYSTEM_USER)\n     public org.jboss.pnc.dto.Artifact store(org.jboss.pnc.dto.Artifact restEntity) throws DTOValidationException {\n-        return super.store(restEntity);\n+        org.jboss.pnc.model.User currentUser = userService.currentUser();\n+        User user = userMapper.toDTO(currentUser);\n+        Instant now = Instant.now();\n+        return super.store(\n+                restEntity.toBuilder()\n+                        .creationUser(user)\n+                        .modificationUser(user)\n+                        .creationTime(now)\n+                        .modificationTime(now)\n+                        .build());\n     }\n \n     @Override\n     @RolesAllowed(SYSTEM_USER)\n     public org.jboss.pnc.dto.Artifact update(String id, org.jboss.pnc.dto.Artifact restEntity)\n             throws DTOValidationException {\n-        return super.update(id, restEntity);\n+        org.jboss.pnc.model.User currentUser = userService.currentUser();\n+        User user = userMapper.toDTO(currentUser);\n+        Instant now = Instant.now();\n+        return super.update(id, restEntity.toBuilder().modificationUser(user).modificationTime(now).build());", "originalCommit": "db776e1c350d0a6b406299bb723c09bbd2cac1b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM4OTE3Mg==", "url": "https://github.com/project-ncl/pnc/pull/3080#discussion_r437389172", "bodyText": "@janinko Right, but in the datastore/src/main/java/org/jboss/pnc/datastore/repositories/ArtifactRepositoryImpl.java in the save method, if there are no changes to the audited values the modificationUser and time are reset, and no revision is created. I guess I could also revert the logic (only set modification time and users only if audited fields changed, in the datastore) if you prefer", "author": "vibe13", "createdAt": "2020-06-09T12:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzMzMA=="}], "type": "inlineReview"}]}