{"pr_number": 4656, "pr_title": "Bot session exclusion / Move hard coded list to config.", "pr_createdAt": "2020-04-30T08:52:13Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4656", "timeline": [{"oid": "6f066ad4ff8d9a84853e6e8deb13a5be89a7a362", "url": "https://github.com/geonetwork/core-geonetwork/commit/6f066ad4ff8d9a84853e6e8deb13a5be89a7a362", "message": "Bot session exclusion / Move hardcoded list to config.", "committedDate": "2020-04-30T08:50:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MDkzOA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r418160938", "bodyText": "AllRequestsInterceptor.java also has default values defined.  I would expect this to be optional.\nMaybe an empty template <bot.regexpFilter></bot.regexpFilter>\nHowever when I tried to remove this line expecting it to use the default however it failed due to circular reference.\norg.springframework.beans.factory.BeanDefinitionStoreException: Invalid bean definition with name 'apiMvcInterceptor' defined in ServletContext resource [/WEB-INF/spring-servlet.xml]: Circular placeholder reference 'bot.regexpFilter' in property definitions; nested exception is java.lang.IllegalArgumentException: Circular placeholder reference 'bot.regexpFilter' in property definitions", "author": "ianwallen", "createdAt": "2020-04-30T17:09:01Z", "path": "pom.xml", "diffHunk": "@@ -1388,7 +1388,8 @@\n \n     <jms.url>tcp://localhost:61616</jms.url>\n     <activemq.version>5.6.0</activemq.version>\n-    <!-- End es and camel stuffs -->\n+\n+    <bot.regexpFilter>.*(bot|crawler|baiduspider|80legs|ia_archiver|voyager|yahoo! slurp|mediapartners-google|Linguee Bot|SemrushBot).*</bot.regexpFilter>", "originalCommit": "6f066ad4ff8d9a84853e6e8deb13a5be89a7a362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyNzYzNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r418527635", "bodyText": "@fxprunayre I was thinking that it was odd to have the default settings in 2 locations (The pom and the java.). I thought that it should be possible to remove the <bot.regexpFilte> from the pom and it should use the default in java but that is where I got the error.\nThe main problem is seems to be due to using the same names in the properties file\nbot.regexpFilter=${bot.regexpFilter}\n${bot.regexpFilter} is expected to be a maven resource. But if the maven resource does not exist then it become a spring placeholder which does a circular reference.\nI suggest that we use the new the new syntax for the maven resource\nbot.regexpFilter=@bot.regexpFilter@\nI have tried it and it works and it is clear that this is a maven resource and not a spring placeholder. However it does not fully fix the problem.  Because now when the maven resource cannot be found it does not evaluate the variable.  I would think that  \"@bot.regexpFilter@\" would turn to \"\" but it remains as \"@bot.regexpFilter@\"\nI cannot find a way to make it default to null if not found.\nOn solution is to check in java if the value = \"@bot.regexpFilter@\" and if so then threat is as null.\nNote: I will be sending a pull request to your branch so you can see the changes.", "author": "ianwallen", "createdAt": "2020-05-01T12:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MDkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3NTUzNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r419375535", "bodyText": "it was odd to have the default settings in 2 locations\n\nYep.\n\nI suggest that we use the new the new syntax for the maven resource\nbot.regexpFilter=@bot.regexpFilter@\n\nIndeed. LGTM\n\nNote: I will be sending a pull request to your branch so you can see the changes.\n\nThanks.", "author": "fxprunayre", "createdAt": "2020-05-04T11:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MDkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MTM5Mg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r418161392", "bodyText": "Invalid syntax - } in the wrong place.\n@value(\"${bot.regexpfilter:.(bot|crawler|baiduspider|80legs|ia_archiver|voyager|yahoo! slurp|mediapartners-google).}\")", "author": "ianwallen", "createdAt": "2020-04-30T17:09:47Z", "path": "services/src/main/java/org/fao/geonet/api/AllRequestsInterceptor.java", "diffHunk": "@@ -42,24 +43,18 @@\n  * crawlers.\n  */\n public class AllRequestsInterceptor extends HandlerInterceptorAdapter {\n+\n     /**\n      * List of bots to avoid.\n      */\n-    public static final String BOT_REGEXP = \".*(bot|crawler|baiduspider|80legs|ia_archiver|\"\n-        + \"voyager|yahoo! slurp|mediapartners-google).*\";\n+    @Value(\"${bot.regexpfilter}:.*(bot|crawler|baiduspider|80legs|ia_archiver|voyager|yahoo! slurp|mediapartners-google).*\")", "originalCommit": "6f066ad4ff8d9a84853e6e8deb13a5be89a7a362", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0Nzk1MA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r418247950", "bodyText": "Looks like this should be regexpFilter to be consistent.\nAlso I don't believe it is recommended that the property name be equal to the placeholder.  This may be what is causing the Circular placeholder reference", "author": "ianwallen", "createdAt": "2020-04-30T19:45:40Z", "path": "services/src/main/webapp/WEB-INF/config.properties", "diffHunk": "@@ -6,3 +6,5 @@ usersavedselection.watchlist.searchurl=catalog.search#/search?_uuid={{filter}}\n \n # Define the link to each record sent by email by the watchlist notifier\n usersavedselection.watchlist.recordurl=api/records/{{index:_uuid}}\n+\n+bot.regexpfilter=${bot.regexpfilter}", "originalCommit": "6f066ad4ff8d9a84853e6e8deb13a5be89a7a362", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afb6c1d422b3379ca960fef5ca81b5f346cfc71f", "url": "https://github.com/geonetwork/core-geonetwork/commit/afb6c1d422b3379ca960fef5ca81b5f346cfc71f", "message": "Bot session exclusion / Move hardcoded list to config. Fix case.", "committedDate": "2020-05-01T08:19:04Z", "type": "commit"}, {"oid": "18443136dcb153f1e36c7b789b5781de6b64368d", "url": "https://github.com/geonetwork/core-geonetwork/commit/18443136dcb153f1e36c7b789b5781de6b64368d", "message": "Bot session exclusion / Move hardcoded list to config. Fix invalid syntax.", "committedDate": "2020-05-01T08:24:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxMzc1Nw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r418613757", "bodyText": "Are there any cases where this actually works?\n@value are only parse after the class has been initialized so the pattern will always be based on the initial value of botRegexpFilter which is \"\"\nI believe this should be done in a postconstruct", "author": "ianwallen", "createdAt": "2020-05-01T16:15:41Z", "path": "services/src/main/java/org/fao/geonet/api/AllRequestsInterceptor.java", "diffHunk": "@@ -23,49 +23,42 @@\n \n package org.fao.geonet.api;\n \n+import jeeves.constants.Jeeves;\n+import jeeves.server.UserSession;\n import org.apache.commons.lang.StringUtils;\n import org.fao.geonet.utils.Log;\n+import org.springframework.beans.factory.annotation.Value;\n import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;\n \n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n-\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n import javax.servlet.http.HttpSession;\n-\n-import jeeves.constants.Jeeves;\n-import jeeves.server.UserSession;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n- * In charge of creating a new {@link UserSession} if not existing. Avoid to create any sessions for\n- * crawlers.\n+ * In charge of creating a new {@link UserSession} if not existing.\n+ * Avoid to create any sessions for crawlers.\n  */\n public class AllRequestsInterceptor extends HandlerInterceptorAdapter {\n+\n     /**\n      * List of bots to avoid.\n      */\n-    public static final String BOT_REGEXP = \".*(bot|crawler|baiduspider|80legs|ia_archiver|\"\n-        + \"voyager|yahoo! slurp|mediapartners-google).*\";\n+    @Value(\"${bot.regexpFilter:.*(bot|crawler|baiduspider|80legs|ia_archiver|voyager|yahoo! slurp|mediapartners-google).*}\")\n+    public String botRegexpFilter = \"\";\n \n-    private static final Pattern regex = Pattern.compile(BOT_REGEXP, Pattern.CASE_INSENSITIVE);\n+    private Pattern regex = Pattern.compile(botRegexpFilter, Pattern.CASE_INSENSITIVE);", "originalCommit": "18443136dcb153f1e36c7b789b5781de6b64368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNDAwOA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r418614008", "bodyText": "As mentioned - suggesting @bot.regexpFilter@", "author": "ianwallen", "createdAt": "2020-05-01T16:16:15Z", "path": "services/src/main/webapp/WEB-INF/config.properties", "diffHunk": "@@ -6,3 +6,5 @@ usersavedselection.watchlist.searchurl=catalog.search#/search?_uuid={{filter}}\n \n # Define the link to each record sent by email by the watchlist notifier\n usersavedselection.watchlist.recordurl=api/records/{{index:_uuid}}\n+\n+bot.regexpFilter=${bot.regexpFilter}", "originalCommit": "18443136dcb153f1e36c7b789b5781de6b64368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYxNDQ1Ng==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4656#discussion_r418614456", "bodyText": "As mentioned - suggesting @bot.regexpFilter@", "author": "ianwallen", "createdAt": "2020-05-01T16:17:23Z", "path": "web/src/main/webResources/WEB-INF/config.properties", "diffHunk": "@@ -33,3 +33,5 @@ es.index.searchlogs.type=${es.index.searchlogs.type}\n kb.url=${kb.url}\n \n jms.url=${jms.url}\n+\n+bot.regexpFilter=${bot.regexpFilter}", "originalCommit": "18443136dcb153f1e36c7b789b5781de6b64368d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6bd6e5069011c3b417d262b559ad7b65601eca31", "url": "https://github.com/geonetwork/core-geonetwork/commit/6bd6e5069011c3b417d262b559ad7b65601eca31", "message": "Update maven bot.regexpFilter to support non existing value\nAlso fixed some postconstruct bugs.", "committedDate": "2020-05-04T11:29:43Z", "type": "commit"}, {"oid": "7469d76924ac2edacd647eb42b583d66e7e361ab", "url": "https://github.com/geonetwork/core-geonetwork/commit/7469d76924ac2edacd647eb42b583d66e7e361ab", "message": "Formatting and add Linguee and Semrush bots in defaults.", "committedDate": "2020-05-04T11:38:32Z", "type": "commit"}, {"oid": "66320bdde5c2243f09717462ba1cf3124e2feefb", "url": "https://github.com/geonetwork/core-geonetwork/commit/66320bdde5c2243f09717462ba1cf3124e2feefb", "message": "Merge branch 'master' into config-for-bot-session-exclusion", "committedDate": "2020-05-25T11:58:44Z", "type": "commit"}]}