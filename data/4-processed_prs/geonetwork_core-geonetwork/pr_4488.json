{"pr_number": 4488, "pr_title": "Migrate to GeoTools 23.0", "pr_createdAt": "2020-03-02T11:07:25Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4488", "timeline": [{"oid": "908df9be59d57886d3fb894e64ad2f11052ad3bf", "url": "https://github.com/geonetwork/core-geonetwork/commit/908df9be59d57886d3fb894e64ad2f11052ad3bf", "message": "Migrate to GeoTools 22.3", "committedDate": "2020-03-02T10:54:59Z", "type": "commit"}, {"oid": "908df9be59d57886d3fb894e64ad2f11052ad3bf", "url": "https://github.com/geonetwork/core-geonetwork/commit/908df9be59d57886d3fb894e64ad2f11052ad3bf", "message": "Migrate to GeoTools 22.3", "committedDate": "2020-03-02T10:54:59Z", "type": "forcePushed"}, {"oid": "aeb4ab8c300110815d5952ced12aa1274835534f", "url": "https://github.com/geonetwork/core-geonetwork/commit/aeb4ab8c300110815d5952ced12aa1274835534f", "message": "Correct feature reprojection in WFS indexation", "committedDate": "2020-03-06T09:41:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4Nzk4OQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r397887989", "bodyText": "Note 23-RC is out now.", "author": "jodygarnett", "createdAt": "2020-03-25T14:16:34Z", "path": "pom.xml", "diffHunk": "@@ -1432,8 +1443,8 @@\n \n     <!-- NOTE: When updating GeoTools, check which version\n     of Postgres is used and update pg.version if needed. -->\n-    <geotools.version>16.0</geotools.version>\n-    <pg.version>9.4.1211</pg.version>\n+    <geotools.version>22.3</geotools.version>", "originalCommit": "aeb4ab8c300110815d5952ced12aa1274835534f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1NzEwOQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409057109", "bodyText": "23.0 will be out this week.", "author": "jodygarnett", "createdAt": "2020-04-15T18:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4Nzk4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTU0Mw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409725543", "bodyText": "Updated to 23.0 on new GeoSolution repository", "author": "jusabatier", "createdAt": "2020-04-16T17:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4Nzk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r397890257", "bodyText": "I like this approach, very safe to retroject to something you know (CRS:84) just based on the returned features.", "author": "jodygarnett", "createdAt": "2020-03-25T14:19:32Z", "path": "workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java", "diffHunk": "@@ -260,7 +256,10 @@ public void indexFeatures(Exchange exchange) throws Exception {\n             BulkResutHandler brh = new AsyncBulkResutHandler(phaser, typeName, url, nbOfFeatures, report);\n \n             long begin = System.currentTimeMillis();\n-            FeatureIterator<SimpleFeature> features = wfs.getFeatureSource(typeName).getFeatures(query).features();\n+\n+            ReprojectingFeatureCollection rfc = new ReprojectingFeatureCollection(wfs.getFeatureSource(typeName).getFeatures(query), CRS.decode(\"urn:ogc:def:crs:OGC:1.3:CRS84\"));", "originalCommit": "aeb4ab8c300110815d5952ced12aa1274835534f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDM1Ng==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409060356", "bodyText": "I do not think query is adding value above, it just has query.setCoordinateSystem( ... ) which is then going to be managed locally by ReprojectingFeatureCollection.\nConsider simplification to:\nSimpleFeatureCollection features = was.getFeatureSource(typeName().getFeatures();\nReprojectingFeatureCollection rfc = new ReprojectingFeatureCollection( features, CRS.decode(\"urn:ogc:def:crs:OGC:1.3:CRS84\"));", "author": "jodygarnett", "createdAt": "2020-04-15T18:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA3OTMzMA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409079330", "bodyText": "So if we not more use the query object, should I also remove its declaration  ?\nLine 248 -> 250", "author": "jusabatier", "createdAt": "2020-04-15T19:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzMjIwOQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409632209", "bodyText": "Yes good catch!", "author": "jodygarnett", "createdAt": "2020-04-16T15:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTcwNw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409725707", "bodyText": "Done", "author": "jusabatier", "createdAt": "2020-04-16T17:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5MDI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDY0NA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409060644", "bodyText": "Use try/finally block to ensure FeatureIterator is closed.", "author": "jodygarnett", "createdAt": "2020-04-15T18:50:49Z", "path": "workers/wfsfeature-harvester/src/main/java/org/fao/geonet/harvester/wfsfeatures/worker/EsWFSFeatureIndexer.java", "diffHunk": "@@ -260,7 +256,10 @@ public void indexFeatures(Exchange exchange) throws Exception {\n             BulkResutHandler brh = new AsyncBulkResutHandler(phaser, typeName, url, nbOfFeatures, report);\n \n             long begin = System.currentTimeMillis();\n-            FeatureIterator<SimpleFeature> features = wfs.getFeatureSource(typeName).getFeatures(query).features();\n+\n+            ReprojectingFeatureCollection rfc = new ReprojectingFeatureCollection(wfs.getFeatureSource(typeName).getFeatures(query), CRS.decode(\"urn:ogc:def:crs:OGC:1.3:CRS84\"));\n+\n+            FeatureIterator<SimpleFeature> features = rfc.features();", "originalCommit": "aeb4ab8c300110815d5952ced12aa1274835534f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTkxOQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409725919", "bodyText": "Done", "author": "jusabatier", "createdAt": "2020-04-16T17:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDY0NA=="}], "type": "inlineReview"}, {"oid": "5b1aa9213f772c1ee4e1d0155001a2b240e26b88", "url": "https://github.com/geonetwork/core-geonetwork/commit/5b1aa9213f772c1ee4e1d0155001a2b240e26b88", "message": "Upgrade to GeoTools 23.0", "committedDate": "2020-04-15T19:07:53Z", "type": "commit"}, {"oid": "b5c638567530ff5976451d86af071b3e30f3fd62", "url": "https://github.com/geonetwork/core-geonetwork/commit/b5c638567530ff5976451d86af071b3e30f3fd62", "message": "Remove unusefull query and add final statement to close iterator", "committedDate": "2020-04-16T17:23:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxMDUzMA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4488#discussion_r409910530", "bodyText": "We should build once more when GeoTools is officially anounced, we are currently having a build issue due to the new osgeo repo ... performing faster and allowing multi-threaded builds to trip on themselves. The Maven local repository is not thread safe apparently ...", "author": "jodygarnett", "createdAt": "2020-04-16T23:41:55Z", "path": "pom.xml", "diffHunk": "@@ -1443,7 +1446,7 @@\n \n     <!-- NOTE: When updating GeoTools, check which version\n     of Postgres is used and update pg.version if needed. -->\n-    <geotools.version>22.3</geotools.version>\n+    <geotools.version>23.0</geotools.version>", "originalCommit": "5b1aa9213f772c1ee4e1d0155001a2b240e26b88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5d1adfa3809a35b88c576e7f0cd33c1479057bb1", "url": "https://github.com/geonetwork/core-geonetwork/commit/5d1adfa3809a35b88c576e7f0cd33c1479057bb1", "message": "Merge remote-tracking branch 'origin/master' into patch-geotools-22.3", "committedDate": "2020-04-17T12:42:14Z", "type": "commit"}]}