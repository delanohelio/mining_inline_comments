{"pr_number": 4815, "pr_title": "Es active filters", "pr_createdAt": "2020-06-30T15:34:56Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4815", "timeline": [{"oid": "91c4ad4331f6370a188798e57444363091fc0cd9", "url": "https://github.com/geonetwork/core-geonetwork/commit/91c4ad4331f6370a188798e57444363091fc0cd9", "message": "ES - Active filters", "committedDate": "2020-06-30T13:12:19Z", "type": "commit"}, {"oid": "3359ad4a63374fa31c6b0244a11cd9827468052e", "url": "https://github.com/geonetwork/core-geonetwork/commit/3359ad4a63374fa31c6b0244a11cd9827468052e", "message": "Active filter - add several values for a facet", "committedDate": "2020-06-30T15:29:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDcxMw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448320713", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    let elem = {};\n          \n          \n            \n                                    var elem = {};", "author": "jahow", "createdAt": "2020-07-01T12:13:45Z", "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js", "diffHunk": "@@ -179,20 +179,45 @@\n                 }\n \n                 // general case\n-                scope.currentFilters.push({\n-                  key: filterKey,\n-                  value: value\n-                });\n+                if (filterKey===\"query_string\"){\n+                  angular.forEach(JSON.parse(value), function(facetValues, facetKey) {\n+                    if (typeof facetValues === 'object') {\n+                      angular.forEach(facetValues, function (values, facetValuesKey) {\n+                        let elem = {};", "originalCommit": "3359ad4a63374fa31c6b0244a11cd9827468052e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM3MjI5MQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448372291", "bodyText": "Commented code should be removed", "author": "jahow", "createdAt": "2020-07-01T13:43:04Z", "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js", "diffHunk": "@@ -179,20 +179,45 @@\n                 }\n \n                 // general case\n-                scope.currentFilters.push({\n-                  key: filterKey,\n-                  value: value\n-                });\n+                if (filterKey===\"query_string\"){\n+                  angular.forEach(JSON.parse(value), function(facetValues, facetKey) {\n+                    if (typeof facetValues === 'object') {\n+                      angular.forEach(facetValues, function (values, facetValuesKey) {\n+                        let elem = {};\n+                        elem[facetValuesKey]=values;\n+                        scope.currentFilters.push({\n+                          key: facetKey,\n+                          value: elem\n+                        })\n+                      })\n+                    }\n+                    else {\n+                      scope.currentFilters.push({\n+                        key: facetKey,\n+                        value: facetValues\n+                      })\n+                    }\n+                  })\n+                }\n+                else {\n+                }\n               }\n             }, true);\n \n             scope.removeFilter = function(filter) {\n-              if (filter.isFacet) {\n+              removeFacetElement=[]\n+              removeFacetElement.push(filter.key)\n+              if (Object.keys(filter.value)[0] != 0)\n+                removeFacetElement.push(Object.keys(filter.value)[0])\n+              else\n+                removeFacetElement.push(filter.value)\n+              ngSearchFormCtrl.updateState(removeFacetElement, true);\n+              /*if (filter.isFacet) {\n                 var facetQuery = removeFacet(filter.facetKey, getSearchParams()['facet.q']);\n                 setSearchParameter('facet.q', facetQuery);\n               } else {\n                 setSearchParameter(filter.key, null);\n-              }\n+              }*/", "originalCommit": "3359ad4a63374fa31c6b0244a11cd9827468052e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM3ODM3Mg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448378372", "bodyText": "Same here, commented out code should be removed.", "author": "jahow", "createdAt": "2020-07-01T13:52:25Z", "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js", "diffHunk": "@@ -227,7 +262,7 @@\n         }\n       });\n \n-      return result;\n+      return result;*/", "originalCommit": "3359ad4a63374fa31c6b0244a11cd9827468052e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9968580e10e34f0c791a2b86a32ff6fa5951642", "url": "https://github.com/geonetwork/core-geonetwork/commit/b9968580e10e34f0c791a2b86a32ff6fa5951642", "message": "Update web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js\n\nCo-authored-by: Olivier Guyot <olivier.guyot@camptocamp.com>", "committedDate": "2020-07-02T06:55:39Z", "type": "commit"}, {"oid": "11653ed8e2d684726487fb604938960b776bba66", "url": "https://github.com/geonetwork/core-geonetwork/commit/11653ed8e2d684726487fb604938960b776bba66", "message": "Active filter - remove comments", "committedDate": "2020-07-02T07:22:37Z", "type": "commit"}, {"oid": "5363099585a377e19d950a28e44dcf505fe36ea8", "url": "https://github.com/geonetwork/core-geonetwork/commit/5363099585a377e19d950a28e44dcf505fe36ea8", "message": "Active filter - add active filter for any", "committedDate": "2020-07-02T08:48:33Z", "type": "commit"}, {"oid": "dba0b77c51efe24b0e12c8b2678b4eb67247309f", "url": "https://github.com/geonetwork/core-geonetwork/commit/dba0b77c51efe24b0e12c8b2678b4eb67247309f", "message": "Merge remote-tracking branch 'AGF/ES_activeFilters' into ES_activeFilters", "committedDate": "2020-07-02T09:00:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MjkxMg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448952912", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                };\n          \n          \n            \n                }", "author": "jahow", "createdAt": "2020-07-02T12:05:55Z", "path": "web-ui/src/main/resources/catalog/components/search/searchmanager/SearchFormDirective.js", "diffHunk": "@@ -432,22 +432,26 @@\n     }\n \n     this.updateState = function(path, value, doNotRemove) {\n-      var filters = $scope.searchObj.state.filters;\n-      var getter = parse(path.join('^^^'));\n-      var existingValue = getter(filters);\n-      if(angular.isUndefined(existingValue) || doNotRemove) {\n-        var setter = getter.assign;\n-        setter(filters, value)\n+      if(path[0] === 'any') {\n+        delete $scope.searchObj.params.any;\n       } else {\n-        if(existingValue !== value) {\n+        var filters = $scope.searchObj.state.filters;\n+        var getter = parse(path.join('^^^'));\n+        var existingValue = getter(filters);\n+        if(angular.isUndefined(existingValue) || doNotRemove) {\n           var setter = getter.assign;\n           setter(filters, value)\n         } else {\n-          removeKey(filters, path)\n+          if(existingValue !== value) {\n+            var setter = getter.assign;\n+            setter(filters, value)\n+          } else {\n+            removeKey(filters, path)\n+          }\n         }\n       }\n       this.triggerSearch();\n-    }\n+    };", "originalCommit": "5363099585a377e19d950a28e44dcf505fe36ea8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3MzQ4Ng==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r449073486", "bodyText": "The translate directive should be added here, otherwise the translation does not happen.", "author": "jahow", "createdAt": "2020-07-02T15:13:02Z", "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/partials/searchFilterTagsTemplate.html", "diffHunk": "@@ -12,7 +12,10 @@\n        ng-repeat=\"filter in currentFilters\"\n        ng-click=\"removeFilter(filter)\">\n       <span class=\"fa fa-times text-danger delete-icon\"></span>\n-      <strong class=\"text-no-wrap text-uppercase\" translate>{{filter.key}}</strong>\n+      <strong class=\"text-no-wrap text-uppercase\" translate>\n+        <span ng-if=\"filter.key!='any'\">{{('facet-' + filter.key)}}</span>", "originalCommit": "dba0b77c51efe24b0e12c8b2678b4eb67247309f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9631024a3fe3ed1ba298d7bb5b7250af1de62f83", "url": "https://github.com/geonetwork/core-geonetwork/commit/9631024a3fe3ed1ba298d7bb5b7250af1de62f83", "message": "Active filter - fix translate dir", "committedDate": "2020-07-03T07:15:46Z", "type": "commit"}, {"oid": "8df8f7d1757a93cf5334692e73bfadc55ff6d4e4", "url": "https://github.com/geonetwork/core-geonetwork/commit/8df8f7d1757a93cf5334692e73bfadc55ff6d4e4", "message": "Update web-ui/src/main/resources/catalog/components/search/searchmanager/SearchFormDirective.js\n\nCo-authored-by: Olivier Guyot <olivier.guyot@camptocamp.com>", "committedDate": "2020-07-03T07:44:01Z", "type": "commit"}]}