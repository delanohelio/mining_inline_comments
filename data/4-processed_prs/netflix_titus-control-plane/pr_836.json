{"pr_number": 836, "pr_title": "Moving elastic search http client into titus-common module", "pr_createdAt": "2020-04-12T21:58:07Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/836", "timeline": [{"oid": "01fbf16ee90ca2c43e7283ac7f66f5337c4c95fb", "url": "https://github.com/Netflix/titus-control-plane/commit/01fbf16ee90ca2c43e7283ac7f66f5337c4c95fb", "message": "saving work elastic search client work", "committedDate": "2020-04-08T02:11:07Z", "type": "commit"}, {"oid": "086f3661e972d1d298162696f9b9174bb1578d73", "url": "https://github.com/Netflix/titus-control-plane/commit/086f3661e972d1d298162696f9b9174bb1578d73", "message": "saving work for default es client (http)", "committedDate": "2020-04-10T19:22:25Z", "type": "commit"}, {"oid": "351226129e57bf8149491670e5e37f63a7079010", "url": "https://github.com/Netflix/titus-control-plane/commit/351226129e57bf8149491670e5e37f63a7079010", "message": "default Elastic search client test against local ES container, manually setup", "committedDate": "2020-04-11T01:52:31Z", "type": "commit"}, {"oid": "63bc30fe86673aa987504df68fd32df79b3ffd96", "url": "https://github.com/Netflix/titus-control-plane/commit/63bc30fe86673aa987504df68fd32df79b3ffd96", "message": "starting a big refactoring, still a test build broken", "committedDate": "2020-04-11T06:08:51Z", "type": "commit"}, {"oid": "b8880072635495a4bb8e149bd540d20787df168d", "url": "https://github.com/Netflix/titus-control-plane/commit/b8880072635495a4bb8e149bd540d20787df168d", "message": "unit and integration test setup for elastic search default/http client", "committedDate": "2020-04-11T18:42:37Z", "type": "commit"}, {"oid": "98b95359bedbab275354be17fe9a5586ad5fa04d", "url": "https://github.com/Netflix/titus-control-plane/commit/98b95359bedbab275354be17fe9a5586ad5fa04d", "message": "minor refactoring, adding file headers", "committedDate": "2020-04-12T06:41:06Z", "type": "commit"}, {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b", "url": "https://github.com/Netflix/titus-control-plane/commit/56eacff381ee61bdfd8d70fa4d61a904042b150b", "message": "minor cleanup, comments etc", "committedDate": "2020-04-12T22:06:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4MzE0OQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407583149", "bodyText": "I think for consistency we should use the Archaius2 annotations and factories provided by Archaius2Ext.", "author": "tbak", "createdAt": "2020-04-13T16:50:37Z", "path": "titus-common-ext/elasticsearch/src/main/java/com/netflix/titus/ext/elasticsearch/EsClientConfiguration.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class EsClientConfiguration {", "originalCommit": "56eacff381ee61bdfd8d70fa4d61a904042b150b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NDAyNw==", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407584027", "bodyText": "Not used?", "author": "tbak", "createdAt": "2020-04-13T16:52:18Z", "path": "titus-common-ext/elasticsearch/src/test/java/com/netflix/titus/ext/elasticsearch/DefaultEsWebClientFactoryTest.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.assertj.core.api.Java6Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class DefaultEsWebClientFactoryTest {\n+    private static final Logger logger = LoggerFactory.getLogger(DefaultEsWebClientFactoryTest.class);", "originalCommit": "56eacff381ee61bdfd8d70fa4d61a904042b150b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NTMwMA==", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407585300", "bodyText": "With Archaius2 interface getting defaults is a one liner.", "author": "tbak", "createdAt": "2020-04-13T16:54:38Z", "path": "titus-common-ext/elasticsearch/src/test/java/com/netflix/titus/ext/elasticsearch/EsExternalResource.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+import com.google.common.base.Preconditions;\n+import org.junit.rules.ExternalResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.web.reactive.function.client.WebClient;\n+\n+public class EsExternalResource extends ExternalResource {\n+    private static final Logger logger = LoggerFactory.getLogger(EsExternalResource.class);\n+\n+    private EsClientConfiguration esClientConfiguration;\n+\n+    @Override\n+    protected void before() throws Throwable {\n+        String esHostName = Preconditions.checkNotNull(System.getenv(\"ES_HOST_NAME\"),\n+                \"'ES_HOST_NAME' environment variable not set\"\n+        );\n+\n+        String esPortStr = Preconditions.checkNotNull(System.getenv(\"ES_PORT\"),\n+                \"'ES_PORT' environment variable not set\"\n+        );\n+\n+        int esPort = Integer.parseInt(esPortStr);\n+\n+        // check if a ES cluster state is Green\n+        WebClient webClient = WebClient.builder()\n+                .baseUrl(String.format(\"http://%s:%d\", esHostName, esPort)).build();\n+        String resp = webClient.get()\n+                .uri(\"/_cat/health\")\n+                .retrieve()\n+                .bodyToMono(String.class).block();\n+\n+        if (resp == null || !resp.contains(\"green\")) {\n+            throw new IllegalStateException(String.format(\"Elastic search cluster %s:%d not READY\", esHostName, esPort));\n+        }\n+\n+        buildEsClientConfiguration(esHostName, esPort);\n+    }\n+\n+    public EsClientConfiguration getEsClientConfiguration() {\n+        return esClientConfiguration;\n+    }\n+\n+    private void buildEsClientConfiguration(String esHostName, int esPort) {", "originalCommit": "56eacff381ee61bdfd8d70fa4d61a904042b150b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NTk0Ng==", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407585946", "bodyText": "Minor. Constructors should be first, followed by getters and last setters.", "author": "tbak", "createdAt": "2020-04-13T16:55:46Z", "path": "titus-common-ext/elasticsearch/src/test/java/com/netflix/titus/ext/elasticsearch/TestDoc.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+public class TestDoc implements EsDoc {\n+    String id;\n+    String state;\n+    long ts;\n+\n+    public TestDoc() {\n+    }\n+\n+    public void setId(String id) {\n+        this.id = id;\n+    }\n+\n+    public void setState(String state) {\n+        this.state = state;\n+    }\n+\n+    public void setTs(long ts) {\n+        this.ts = ts;\n+    }\n+\n+    public TestDoc(String id, String state, long ts) {", "originalCommit": "56eacff381ee61bdfd8d70fa4d61a904042b150b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "46af771c7daf53d36f504d30de97f0e9403bc8dd", "url": "https://github.com/Netflix/titus-control-plane/commit/46af771c7daf53d36f504d30de97f0e9403bc8dd", "message": "review comments applied", "committedDate": "2020-04-13T20:55:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNzg1Ng==", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407727856", "bodyText": "are these POJOs auto-generated code? Can they be immutable? They are inconsistent in some other ways as well, it would be nice to normalize them all with:\n\nmany don't have private fields\nnon-standard coding conventions for field and getter/setter methods on some (with underscores)\nonly some implement toString()\ndo they all need equals() and hashcode()?", "author": "fabiokung", "createdAt": "2020-04-13T21:19:24Z", "path": "titus-common-ext/elasticsearch/src/main/java/com/netflix/titus/ext/elasticsearch/model/BulkEsIndexResp.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch.model;\n+\n+import java.util.List;\n+\n+/**\n+ * Elastic search data model as defined by REST API documentation\n+ * https://www.elastic.co/guide/en/elasticsearch/reference/master/rest-apis.html\n+ */\n+public class BulkEsIndexResp {", "originalCommit": "46af771c7daf53d36f504d30de97f0e9403bc8dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMDI4NA==", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407830284", "bodyText": "Good catch.\nMy initial thought on this was to not make assumptions about Webclient strategy it uses for deserializing ES responses into POJOs. But it seems like spring docs make it clear that it is going to depend on Jackson bindings for WebClient support.", "author": "amit-git", "createdAt": "2020-04-14T02:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNzg1Ng=="}], "type": "inlineReview"}, {"oid": "101f0586a5de074f34f40440c1ecbac2d29a1fba", "url": "https://github.com/Netflix/titus-control-plane/commit/101f0586a5de074f34f40440c1ecbac2d29a1fba", "message": "elastic search data model cleanup", "committedDate": "2020-04-14T01:32:30Z", "type": "commit"}, {"oid": "7093c70e0f7c0d01971b081224a62da5caa9cd58", "url": "https://github.com/Netflix/titus-control-plane/commit/7093c70e0f7c0d01971b081224a62da5caa9cd58", "message": "fixing test failures", "committedDate": "2020-04-14T01:51:28Z", "type": "commit"}]}