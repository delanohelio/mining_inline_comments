{"pr_number": 902, "pr_title": "KubeScheduler & task relocation support", "pr_createdAt": "2020-08-21T23:07:08Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/902", "timeline": [{"oid": "44b181466fce97eadf56878cb1402e82915afcdd", "url": "https://github.com/Netflix/titus-control-plane/commit/44b181466fce97eadf56878cb1402e82915afcdd", "message": "Extract a Node abstraction in TitusRelocation service\n\nso we can deal with Kubernetes nodes and Agent Management API\nobjects at the same time", "committedDate": "2020-08-21T22:53:59Z", "type": "commit"}, {"oid": "dce9bc869cb069a716bb8eaef5ae5baa3b4542c3", "url": "https://github.com/Netflix/titus-control-plane/commit/dce9bc869cb069a716bb8eaef5ae5baa3b4542c3", "message": "KubeScheduler & task relocation support", "committedDate": "2020-08-21T22:54:00Z", "type": "commit"}, {"oid": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "url": "https://github.com/Netflix/titus-control-plane/commit/d3f419e57412f9d66d9c649e6209b34ac460dc22", "message": "Fix Spring component configuration", "committedDate": "2020-08-24T23:35:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwNTQzNA==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476605434", "bodyText": "these two methods (checkKubeConnectivity and mustHaveKubeConnectivity) are not being used anywhere here. Are they intended to be provided as a library?\nThe boolean return is also not being used anywhere (see comment below)", "author": "fabiokung", "createdAt": "2020-08-25T17:10:24Z", "path": "titus-common-runtime/src/main/java/com/netflix/titus/runtime/connector/kubernetes/KubeApiClients.java", "diffHunk": "@@ -76,6 +88,24 @@ public static ApiClient createApiClient(String kubeApiServerUrl,\n         return client;\n     }\n \n+    public static Either<Boolean, Throwable> checkKubeConnectivity(ApiClient apiClient) {", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1ODMxMg==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476658312", "bodyText": "Yes, they are used in nftitus.\nThe Either contract in this context makes it sufficient to only check if the error is present.", "author": "tbak", "createdAt": "2020-08-25T18:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwNTQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2ODE4OA==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476668188", "bodyText": "I will change it to Optional to avoid this confusion.", "author": "tbak", "createdAt": "2020-08-25T18:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwNTQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwNTU2NQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476605565", "bodyText": "not checking the boolean return anywhere", "author": "fabiokung", "createdAt": "2020-08-25T17:10:36Z", "path": "titus-common-runtime/src/main/java/com/netflix/titus/runtime/connector/kubernetes/KubeApiClients.java", "diffHunk": "@@ -76,6 +88,24 @@ public static ApiClient createApiClient(String kubeApiServerUrl,\n         return client;\n     }\n \n+    public static Either<Boolean, Throwable> checkKubeConnectivity(ApiClient apiClient) {\n+        CoreV1Api coreV1Api = new CoreV1Api(apiClient);\n+        try {\n+            coreV1Api.getAPIResources();\n+        } catch (Throwable e) {\n+            return Either.ofError(e);\n+        }\n+        return Either.ofValue(true);\n+    }\n+\n+    public static ApiClient mustHaveKubeConnectivity(ApiClient apiClient) {\n+        Either<Boolean, Throwable> check = checkKubeConnectivity(apiClient);", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1ODQyNg==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476658426", "bodyText": "The Either contract in this context makes it sufficient to only check if the error is present.", "author": "tbak", "createdAt": "2020-08-25T18:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwNTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxMDYxNg==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476610616", "bodyText": "minor: might be a bit more future-proof to use Boolean.parseBoolean() for all these bool attributes", "author": "fabiokung", "createdAt": "2020-08-25T17:18:38Z", "path": "titus-supplementary-component/task-relocation/src/main/java/com/netflix/titus/supplementary/relocation/connector/AgentManagementNodeDataResolver.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.relocation.connector;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+\n+import com.netflix.titus.api.agent.model.AgentInstance;\n+import com.netflix.titus.api.agent.model.AgentInstanceGroup;\n+import com.netflix.titus.api.agent.model.InstanceGroupLifecycleState;\n+import com.netflix.titus.api.agent.service.ReadOnlyAgentOperations;\n+import com.netflix.titus.common.util.tuple.Pair;\n+import com.netflix.titus.runtime.connector.agent.AgentDataReplicator;\n+import com.netflix.titus.supplementary.relocation.RelocationAttributes;\n+\n+public class AgentManagementNodeDataResolver implements NodeDataResolver {\n+\n+    private final ReadOnlyAgentOperations agentOperations;\n+    private final AgentDataReplicator agentDataReplicator;\n+    private final Predicate<AgentInstance> fenzoNodeFilter;\n+\n+    public AgentManagementNodeDataResolver(ReadOnlyAgentOperations agentOperations,\n+                                           AgentDataReplicator agentDataReplicator,\n+                                           Predicate<AgentInstance> fenzoNodeFilter) {\n+        this.agentOperations = agentOperations;\n+        this.agentDataReplicator = agentDataReplicator;\n+        this.fenzoNodeFilter = fenzoNodeFilter;\n+    }\n+\n+    @Override\n+    public Map<String, Node> resolve() {\n+        List<Pair<AgentInstanceGroup, List<AgentInstance>>> all = agentOperations.findAgentInstances(pair ->\n+                fenzoNodeFilter.test(pair.getRight())\n+        );\n+        Map<String, Node> result = new HashMap<>();\n+        all.forEach(pair -> {\n+            AgentInstanceGroup serverGroup = pair.getLeft();\n+            List<AgentInstance> instances = pair.getRight();\n+            instances.forEach(instance -> result.put(instance.getId(), toNode(serverGroup, instance)));\n+        });\n+        return result;\n+    }\n+\n+    @Override\n+    public long getStalenessMs() {\n+        return agentDataReplicator.getStalenessMs();\n+    }\n+\n+    private Node toNode(AgentInstanceGroup serverGroup, AgentInstance instance) {\n+        boolean relocationRequired = instance.getAttributes()", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxMzM5NA==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476613394", "bodyText": "s/relocationNodeAllowed/relocationNotAllowed/g", "author": "fabiokung", "createdAt": "2020-08-25T17:23:05Z", "path": "titus-supplementary-component/task-relocation/src/main/java/com/netflix/titus/supplementary/relocation/connector/AgentManagementNodeDataResolver.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.relocation.connector;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+\n+import com.netflix.titus.api.agent.model.AgentInstance;\n+import com.netflix.titus.api.agent.model.AgentInstanceGroup;\n+import com.netflix.titus.api.agent.model.InstanceGroupLifecycleState;\n+import com.netflix.titus.api.agent.service.ReadOnlyAgentOperations;\n+import com.netflix.titus.common.util.tuple.Pair;\n+import com.netflix.titus.runtime.connector.agent.AgentDataReplicator;\n+import com.netflix.titus.supplementary.relocation.RelocationAttributes;\n+\n+public class AgentManagementNodeDataResolver implements NodeDataResolver {\n+\n+    private final ReadOnlyAgentOperations agentOperations;\n+    private final AgentDataReplicator agentDataReplicator;\n+    private final Predicate<AgentInstance> fenzoNodeFilter;\n+\n+    public AgentManagementNodeDataResolver(ReadOnlyAgentOperations agentOperations,\n+                                           AgentDataReplicator agentDataReplicator,\n+                                           Predicate<AgentInstance> fenzoNodeFilter) {\n+        this.agentOperations = agentOperations;\n+        this.agentDataReplicator = agentDataReplicator;\n+        this.fenzoNodeFilter = fenzoNodeFilter;\n+    }\n+\n+    @Override\n+    public Map<String, Node> resolve() {\n+        List<Pair<AgentInstanceGroup, List<AgentInstance>>> all = agentOperations.findAgentInstances(pair ->\n+                fenzoNodeFilter.test(pair.getRight())\n+        );\n+        Map<String, Node> result = new HashMap<>();\n+        all.forEach(pair -> {\n+            AgentInstanceGroup serverGroup = pair.getLeft();\n+            List<AgentInstance> instances = pair.getRight();\n+            instances.forEach(instance -> result.put(instance.getId(), toNode(serverGroup, instance)));\n+        });\n+        return result;\n+    }\n+\n+    @Override\n+    public long getStalenessMs() {\n+        return agentDataReplicator.getStalenessMs();\n+    }\n+\n+    private Node toNode(AgentInstanceGroup serverGroup, AgentInstance instance) {\n+        boolean relocationRequired = instance.getAttributes()\n+                .getOrDefault(RelocationAttributes.RELOCATION_REQUIRED, \"false\")\n+                .equalsIgnoreCase(\"true\");\n+\n+        boolean relocationRequiredImmediately = instance.getAttributes()\n+                .getOrDefault(RelocationAttributes.RELOCATION_REQUIRED_IMMEDIATELY, \"false\")\n+                .equalsIgnoreCase(\"true\");\n+\n+        boolean relocationNodeAllowed = instance.getAttributes()", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxNzMxNA==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476617314", "bodyText": "thoughts on changing the contract here to return Optional<Long>, and be more explicit when sync has not occurred?", "author": "fabiokung", "createdAt": "2020-08-25T17:26:16Z", "path": "titus-supplementary-component/task-relocation/src/main/java/com/netflix/titus/supplementary/relocation/connector/KubernetesNodeDataResolver.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.relocation.connector;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import com.netflix.titus.common.util.RegExpExt;\n+import com.netflix.titus.runtime.connector.kubernetes.KubeApiFacade;\n+import com.netflix.titus.supplementary.relocation.RelocationConfiguration;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.openapi.models.V1Node;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.runtime.kubernetes.KubeConstants.NODE_LABEL_MACHINE_GROUP;\n+import static com.netflix.titus.runtime.kubernetes.KubeConstants.TAINT_EFFECT_NO_EXECUTE;\n+\n+public class KubernetesNodeDataResolver implements NodeDataResolver {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(KubernetesNodeDataResolver.class);\n+\n+    private static final long NOT_SYNCED_STALENESS_MS = 10 * 3600_000;\n+\n+    private final SharedIndexInformer<V1Node> nodeInformer;\n+    private final Predicate<V1Node> nodeFilter;\n+\n+    private final Function<String, Matcher> relocationRequiredTaintsMatcher;\n+    private final Function<String, Matcher> relocationRequiredImmediatelyTaintsMatcher;\n+\n+    public KubernetesNodeDataResolver(RelocationConfiguration configuration,\n+                                      KubeApiFacade kubeApiFacade,\n+                                      Predicate<V1Node> nodeFilter) {\n+        this.nodeInformer = kubeApiFacade.getNodeInformer();\n+        this.relocationRequiredTaintsMatcher = RegExpExt.dynamicMatcher(\n+                configuration::getNodeRelocationRequiredTaints,\n+                \"nodeRelocationRequiredTaints\",\n+                Pattern.DOTALL,\n+                logger);\n+        this.relocationRequiredImmediatelyTaintsMatcher = RegExpExt.dynamicMatcher(\n+                configuration::getNodeRelocationRequiredImmediatelyTaints,\n+                \"nodeRelocationRequiredImmediatelyTaints\",\n+                Pattern.DOTALL,\n+                logger);\n+        this.nodeFilter = nodeFilter;\n+    }\n+\n+    @Override\n+    public Map<String, Node> resolve() {\n+        List<V1Node> k8Nodes = nodeInformer.getIndexer().list().stream().filter(nodeFilter).collect(Collectors.toList());\n+        Map<String, Node> result = new HashMap<>();\n+        k8Nodes.forEach(k8Node -> toReconcilerNode(k8Node).ifPresent(node -> result.put(node.getId(), node)));\n+        return result;\n+    }\n+\n+    private Optional<Node> toReconcilerNode(V1Node k8Node) {\n+        if (k8Node.getMetadata() == null\n+                || k8Node.getMetadata().getName() == null\n+                || k8Node.getMetadata().getLabels() == null\n+                || k8Node.getSpec() == null\n+                || k8Node.getSpec().getTaints() == null) {\n+            return Optional.empty();\n+        }\n+\n+        Map<String, String> k8Labels = k8Node.getMetadata().getLabels();\n+\n+        String serverGroupId = k8Labels.get(NODE_LABEL_MACHINE_GROUP);\n+        if (serverGroupId == null) {\n+            return Optional.empty();\n+        }\n+\n+        Node node = Node.newBuilder()\n+                .withId(k8Node.getMetadata().getName())\n+                .withServerGroupId(serverGroupId)\n+                .withRelocationRequired(anyNoExecuteMatch(k8Node, relocationRequiredTaintsMatcher))\n+                .withRelocationRequiredImmediately(anyNoExecuteMatch(k8Node, relocationRequiredImmediatelyTaintsMatcher))\n+                .build();\n+        return Optional.of(node);\n+    }\n+\n+    private boolean anyNoExecuteMatch(V1Node k8Node, Function<String, Matcher> taintsMatcher) {\n+        return k8Node.getSpec().getTaints().stream().anyMatch(taint ->\n+                TAINT_EFFECT_NO_EXECUTE.equals(taint.getEffect()) && taintsMatcher.apply(taint.getKey()).matches()\n+        );\n+    }\n+\n+    /**\n+     * Kubernetes informer does not provide staleness details, just information about the first sync.\n+     */\n+    @Override\n+    public long getStalenessMs() {", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2OTE4Ng==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476669186", "bodyText": "We use this approach in other places/APIs, so to be consistent we should change it everywhere.", "author": "tbak", "createdAt": "2020-08-25T18:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxNzMxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyMDQ0Ng==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476620446", "bodyText": "minor: s/k8/k8s/g", "author": "fabiokung", "createdAt": "2020-08-25T17:30:22Z", "path": "titus-supplementary-component/task-relocation/src/main/java/com/netflix/titus/supplementary/relocation/connector/KubernetesNodeDataResolver.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.relocation.connector;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import com.netflix.titus.common.util.RegExpExt;\n+import com.netflix.titus.runtime.connector.kubernetes.KubeApiFacade;\n+import com.netflix.titus.supplementary.relocation.RelocationConfiguration;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.openapi.models.V1Node;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.runtime.kubernetes.KubeConstants.NODE_LABEL_MACHINE_GROUP;\n+import static com.netflix.titus.runtime.kubernetes.KubeConstants.TAINT_EFFECT_NO_EXECUTE;\n+\n+public class KubernetesNodeDataResolver implements NodeDataResolver {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(KubernetesNodeDataResolver.class);\n+\n+    private static final long NOT_SYNCED_STALENESS_MS = 10 * 3600_000;\n+\n+    private final SharedIndexInformer<V1Node> nodeInformer;\n+    private final Predicate<V1Node> nodeFilter;\n+\n+    private final Function<String, Matcher> relocationRequiredTaintsMatcher;\n+    private final Function<String, Matcher> relocationRequiredImmediatelyTaintsMatcher;\n+\n+    public KubernetesNodeDataResolver(RelocationConfiguration configuration,\n+                                      KubeApiFacade kubeApiFacade,\n+                                      Predicate<V1Node> nodeFilter) {\n+        this.nodeInformer = kubeApiFacade.getNodeInformer();\n+        this.relocationRequiredTaintsMatcher = RegExpExt.dynamicMatcher(\n+                configuration::getNodeRelocationRequiredTaints,\n+                \"nodeRelocationRequiredTaints\",\n+                Pattern.DOTALL,\n+                logger);\n+        this.relocationRequiredImmediatelyTaintsMatcher = RegExpExt.dynamicMatcher(\n+                configuration::getNodeRelocationRequiredImmediatelyTaints,\n+                \"nodeRelocationRequiredImmediatelyTaints\",\n+                Pattern.DOTALL,\n+                logger);\n+        this.nodeFilter = nodeFilter;\n+    }\n+\n+    @Override\n+    public Map<String, Node> resolve() {\n+        List<V1Node> k8Nodes = nodeInformer.getIndexer().list().stream().filter(nodeFilter).collect(Collectors.toList());", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3af4c2b1c9d421d3ae140d826c233266d3a09ae2", "url": "https://github.com/Netflix/titus-control-plane/commit/3af4c2b1c9d421d3ae140d826c233266d3a09ae2", "message": "Code review updates", "committedDate": "2020-08-25T19:43:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMTk3NA==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476901974", "bodyText": "Precondition checks (notNull, notEmpty) would help here with id, serverGroupId", "author": "amit-git", "createdAt": "2020-08-26T00:14:08Z", "path": "titus-supplementary-component/task-relocation/src/main/java/com/netflix/titus/supplementary/relocation/connector/Node.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.relocation.connector;\n+\n+public class Node {\n+\n+    private final String id;\n+    private final String serverGroupId;\n+\n+    private boolean relocationNotAllowed;\n+    private boolean relocationRequired;\n+    private boolean relocationRequiredImmediately;\n+    private boolean serverGroupRelocationRequired;\n+\n+    public Node(String id,\n+                String serverGroupId) {\n+        this.id = id;\n+        this.serverGroupId = serverGroupId;\n+    }\n+\n+    public String getId() {\n+        return id;\n+    }\n+\n+    public String getServerGroupId() {\n+        return serverGroupId;\n+    }\n+\n+    public boolean isRelocationNotAllowed() {\n+        return relocationNotAllowed;\n+    }\n+\n+    public boolean isRelocationRequired() {\n+        return relocationRequired;\n+    }\n+\n+    public boolean isRelocationRequiredImmediately() {\n+        return relocationRequiredImmediately;\n+    }\n+\n+    public boolean isServerGroupRelocationRequired() {\n+        return serverGroupRelocationRequired;\n+    }\n+\n+    public Builder toBuilder() {\n+        return newBuilder()\n+                .withId(id)\n+                .withServerGroupId(serverGroupId)\n+                .withRelocationRequired(relocationRequired)\n+                .withRelocationRequiredImmediately(relocationRequiredImmediately)\n+                .withRelocationNotAllowed(relocationNotAllowed)\n+                .withServerGroupRelocationRequired(serverGroupRelocationRequired);\n+    }\n+\n+    public static Builder newBuilder() {\n+        return new Builder();\n+    }\n+\n+    public static final class Builder {\n+        private String id;\n+        private String serverGroupId;\n+        private boolean relocationRequired;\n+        private boolean relocationNotAllowed;\n+        private boolean relocationRequiredImmediately;\n+        private boolean serverGroupRelocationRequired;\n+\n+        private Builder() {\n+        }\n+\n+        public Builder withId(String id) {\n+            this.id = id;\n+            return this;\n+        }\n+\n+        public Builder withServerGroupId(String serverGroupId) {\n+            this.serverGroupId = serverGroupId;\n+            return this;\n+        }\n+\n+        public Builder withRelocationNotAllowed(boolean relocationNotAllowed) {\n+            this.relocationNotAllowed = relocationNotAllowed;\n+            return this;\n+        }\n+\n+        public Builder withRelocationRequired(boolean relocationRequired) {\n+            this.relocationRequired = relocationRequired;\n+            return this;\n+        }\n+\n+        public Builder withRelocationRequiredImmediately(boolean relocationRequiredImmediately) {\n+            this.relocationRequiredImmediately = relocationRequiredImmediately;\n+            return this;\n+        }\n+\n+        public Builder withServerGroupRelocationRequired(boolean serverGroupRelocationRequired) {\n+            this.serverGroupRelocationRequired = serverGroupRelocationRequired;\n+            return this;\n+        }\n+\n+        public Node build() {\n+            Node node = new Node(id, serverGroupId);", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMjgxMA==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476902810", "bodyText": "Could be more clear calling it out as FenzoNodeResolver ?", "author": "amit-git", "createdAt": "2020-08-26T00:15:26Z", "path": "titus-supplementary-component/task-relocation/src/main/java/com/netflix/titus/supplementary/relocation/connector/AgentManagementNodeDataResolver.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.relocation.connector;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+\n+import com.netflix.titus.api.agent.model.AgentInstance;\n+import com.netflix.titus.api.agent.model.AgentInstanceGroup;\n+import com.netflix.titus.api.agent.model.InstanceGroupLifecycleState;\n+import com.netflix.titus.api.agent.service.ReadOnlyAgentOperations;\n+import com.netflix.titus.common.util.tuple.Pair;\n+import com.netflix.titus.runtime.connector.agent.AgentDataReplicator;\n+import com.netflix.titus.supplementary.relocation.RelocationAttributes;\n+\n+public class AgentManagementNodeDataResolver implements NodeDataResolver {", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyNjEyMw==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r477426123", "bodyText": "It is resolver for AgentManagement API which is used by Fenzo only.", "author": "tbak", "createdAt": "2020-08-26T16:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwMjgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwNDIyNw==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r476904227", "bodyText": "minor : could it be combined with the indexer -> stream -> filter expression above ?", "author": "amit-git", "createdAt": "2020-08-26T00:17:34Z", "path": "titus-supplementary-component/task-relocation/src/main/java/com/netflix/titus/supplementary/relocation/connector/KubernetesNodeDataResolver.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.supplementary.relocation.connector;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import com.netflix.titus.common.util.RegExpExt;\n+import com.netflix.titus.runtime.connector.kubernetes.KubeApiFacade;\n+import com.netflix.titus.supplementary.relocation.RelocationConfiguration;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.openapi.models.V1Node;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.runtime.kubernetes.KubeConstants.NODE_LABEL_MACHINE_GROUP;\n+import static com.netflix.titus.runtime.kubernetes.KubeConstants.TAINT_EFFECT_NO_EXECUTE;\n+\n+public class KubernetesNodeDataResolver implements NodeDataResolver {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(KubernetesNodeDataResolver.class);\n+\n+    private static final long NOT_SYNCED_STALENESS_MS = 10 * 3600_000;\n+\n+    private final SharedIndexInformer<V1Node> nodeInformer;\n+    private final Predicate<V1Node> nodeFilter;\n+\n+    private final Function<String, Matcher> relocationRequiredTaintsMatcher;\n+    private final Function<String, Matcher> relocationRequiredImmediatelyTaintsMatcher;\n+\n+    public KubernetesNodeDataResolver(RelocationConfiguration configuration,\n+                                      KubeApiFacade kubeApiFacade,\n+                                      Predicate<V1Node> nodeFilter) {\n+        this.nodeInformer = kubeApiFacade.getNodeInformer();\n+        this.relocationRequiredTaintsMatcher = RegExpExt.dynamicMatcher(\n+                configuration::getNodeRelocationRequiredTaints,\n+                \"nodeRelocationRequiredTaints\",\n+                Pattern.DOTALL,\n+                logger);\n+        this.relocationRequiredImmediatelyTaintsMatcher = RegExpExt.dynamicMatcher(\n+                configuration::getNodeRelocationRequiredImmediatelyTaints,\n+                \"nodeRelocationRequiredImmediatelyTaints\",\n+                Pattern.DOTALL,\n+                logger);\n+        this.nodeFilter = nodeFilter;\n+    }\n+\n+    @Override\n+    public Map<String, Node> resolve() {\n+        List<V1Node> k8Nodes = nodeInformer.getIndexer().list().stream().filter(nodeFilter).collect(Collectors.toList());\n+        Map<String, Node> result = new HashMap<>();\n+        k8Nodes.forEach(k8Node -> toReconcilerNode(k8Node).ifPresent(node -> result.put(node.getId(), node)));", "originalCommit": "d3f419e57412f9d66d9c649e6209b34ac460dc22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQyNzkzNg==", "url": "https://github.com/Netflix/titus-control-plane/pull/902#discussion_r477427936", "bodyText": "I wanted separate data access and filtering from data transformation. It helps in the debugging process.", "author": "tbak", "createdAt": "2020-08-26T16:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwNDIyNw=="}], "type": "inlineReview"}]}