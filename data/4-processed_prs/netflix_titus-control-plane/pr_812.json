{"pr_number": 812, "pr_title": "Keep task retryer in the direct Kube integration", "pr_createdAt": "2020-03-17T19:04:24Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/812", "timeline": [{"oid": "e2fef3eb0d4df6fc4355073800a48609b8ea6fea", "url": "https://github.com/Netflix/titus-control-plane/commit/e2fef3eb0d4df6fc4355073800a48609b8ea6fea", "message": "Keep task retryer in the direct Kube integration", "committedDate": "2020-03-17T19:02:07Z", "type": "commit"}, {"oid": "c7217326d794c54b8171d7d8dfe2fe008ccdb3ba", "url": "https://github.com/Netflix/titus-control-plane/commit/c7217326d794c54b8171d7d8dfe2fe008ccdb3ba", "message": "Dependency lock update", "committedDate": "2020-03-17T20:03:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNTIyMg==", "url": "https://github.com/Netflix/titus-control-plane/pull/812#discussion_r394025222", "bodyText": "minor: can probably extract the comparator here as a constant to avoid allocations", "author": "fabiokung", "createdAt": "2020-03-17T23:19:22Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "diffHunk": "@@ -316,7 +318,38 @@ private Task fillInMissingStates(V1Pod pod, Task task) {\n         newStatusHistory.sort(Comparator.comparing(ExecutableStatus::getState));\n \n         return task.toBuilder().withStatusHistory(newStatusHistory).build();\n+    }\n+\n+    /**\n+     * In case container could not be started, we do not have the container start time, only the finished time.\n+     * The {@link V1PodStatus#getPhase()} is failed, and the {@link V1PodStatus#getMessage()} contains details on\n+     * the nature of failure. There should be no launched state, so we add it to mark the container start attempt.\n+     */\n+    private Task fillInMissingStatesForContainerSetupFailure(V1Pod pod, Task task) {\n+        // Sanity check. Should never be true.\n+        if (JobFunctions.findTaskStatus(task, TaskState.Launched).isPresent()) {\n+            return task;\n+        }\n+\n+        long startAtTimestamp;\n+        V1ContainerState containerState = KubeUtil.findContainerState(pod).orElse(null);\n+        if (containerState != null && containerState.getTerminated() != null && containerState.getTerminated().getFinishedAt() != null) {\n+            startAtTimestamp = containerState.getTerminated().getFinishedAt().getMillis();\n+        } else {\n+            startAtTimestamp = task.getStatus().getTimestamp();\n+        }\n+\n+        List<TaskStatus> newStatusHistory = new ArrayList<>(task.getStatusHistory());\n+        newStatusHistory.add(TaskStatus.newBuilder()\n+                .withState(TaskState.Launched)\n+                .withReasonCode(TaskStatus.REASON_STATE_MISSING)\n+                .withReasonMessage(\"Filled in\")\n+                .withTimestamp(startAtTimestamp)\n+                .build()\n+        );\n+        newStatusHistory.sort(Comparator.comparing(ExecutableStatus::getState));", "originalCommit": "c7217326d794c54b8171d7d8dfe2fe008ccdb3ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}