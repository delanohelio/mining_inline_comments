{"pr_number": 3116, "pr_title": "Async command map building", "pr_createdAt": "2020-04-09T07:12:51Z", "pr_url": "https://github.com/PaperMC/Paper/pull/3116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwMzI5MQ==", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406003291", "bodyText": "this should be up at the private void runSync", "author": "aikar", "createdAt": "2020-04-09T07:18:23Z", "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From bde0fc09db464680cfd12a76c32076d450ac7cfe Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..97d608be9 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,13 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {\n++            sendAsync(entityplayer);\n++        });\n++    }\n++    \n++    private void sendAsync(EntityPlayer entityplayer) {\n+         Map<CommandNode<CommandListenerWrapper>, CommandNode<ICompletionProvider>> map = Maps.newIdentityHashMap(); // Use identity to prevent aliasing issues\n+         RootCommandNode vanillaRoot = new RootCommandNode();\n+ \n+@@ -258,7 +265,13 @@ public class CommandDispatcher {\n+         for (CommandNode node : rootcommandnode.getChildren()) {\n+             bukkit.add(node.getName());\n+         }\n+-\n++        \n++        MinecraftServer.getServer().postToMainThread(() -> {\n++           runSync(entityplayer, bukkit, rootcommandnode);\n++        });\n++    }\n++    \n++    private void runSync(EntityPlayer entityplayer, Collection<String> bukkit, RootCommandNode<ICompletionProvider> rootcommandnode) {\n+         PlayerCommandSendEvent event = new PlayerCommandSendEvent(entityplayer.getBukkitEntity(), new LinkedHashSet<>(bukkit));\n+         event.getPlayer().getServer().getPluginManager().callEvent(event);\n+ \n+@@ -271,6 +284,7 @@ public class CommandDispatcher {\n+         // CraftBukkit end\n+         entityplayer.playerConnection.sendPacket(new PacketPlayOutCommands(rootcommandnode));\n+     }\n++    // Paper end - Async command map building", "originalCommit": "80a379eb5ddc3f653dd3abf952ec44e8352f8819", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwMzMzMw==", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406003333", "bodyText": "paper start here", "author": "aikar", "createdAt": "2020-04-09T07:18:32Z", "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From bde0fc09db464680cfd12a76c32076d450ac7cfe Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..97d608be9 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,13 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {\n++            sendAsync(entityplayer);\n++        });\n++    }\n++    \n++    private void sendAsync(EntityPlayer entityplayer) {\n+         Map<CommandNode<CommandListenerWrapper>, CommandNode<ICompletionProvider>> map = Maps.newIdentityHashMap(); // Use identity to prevent aliasing issues\n+         RootCommandNode vanillaRoot = new RootCommandNode();\n+ \n+@@ -258,7 +265,13 @@ public class CommandDispatcher {\n+         for (CommandNode node : rootcommandnode.getChildren()) {\n+             bukkit.add(node.getName());\n+         }\n+-\n++        ", "originalCommit": "80a379eb5ddc3f653dd3abf952ec44e8352f8819", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwMzM5NQ==", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406003395", "bodyText": "paper end here", "author": "aikar", "createdAt": "2020-04-09T07:18:40Z", "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From bde0fc09db464680cfd12a76c32076d450ac7cfe Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..97d608be9 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,13 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {\n++            sendAsync(entityplayer);\n++        });\n++    }\n++    \n++    private void sendAsync(EntityPlayer entityplayer) {", "originalCommit": "80a379eb5ddc3f653dd3abf952ec44e8352f8819", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg5ODE0Ng==", "url": "https://github.com/PaperMC/Paper/pull/3116#discussion_r406898146", "bodyText": "Shouldn't this be execute so its executed? You're just submitting it to queue but never executing.", "author": "BillyGalbreath", "createdAt": "2020-04-10T19:02:25Z", "path": "Spigot-Server-Patches/0463-Async-command-map-building.patch", "diffHunk": "@@ -0,0 +1,44 @@\n+From 5ccaf0bce5b7928151762866ba6383aeaef4bd81 Mon Sep 17 00:00:00 2001\n+From: Callahan <mr.callahhh@gmail.com>\n+Date: Wed, 8 Apr 2020 02:42:14 -0500\n+Subject: [PATCH] Async command map building\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/CommandDispatcher.java b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+index 37b1a7947..1a99e37bc 100644\n+--- a/src/main/java/net/minecraft/server/CommandDispatcher.java\n++++ b/src/main/java/net/minecraft/server/CommandDispatcher.java\n+@@ -241,6 +241,14 @@ public class CommandDispatcher {\n+         if ( org.spigotmc.SpigotConfig.tabComplete < 0 ) return; // Spigot\n+         // CraftBukkit start\n+         // Register Vanilla commands into builtRoot as before\n++        // Paper start - Async command map building\n++        java.util.concurrent.ForkJoinPool.commonPool().submit(() -> {", "originalCommit": "1f0e385929c57924bc4b864045cdd28c46f8867e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06044e24584c48a6c8380872a250275b06418b6d", "url": "https://github.com/PaperMC/Paper/commit/06044e24584c48a6c8380872a250275b06418b6d", "message": "Async command map building\n\nReduces lag created on login and world change for sending the command map to client", "committedDate": "2020-04-12T19:43:07Z", "type": "commit"}]}