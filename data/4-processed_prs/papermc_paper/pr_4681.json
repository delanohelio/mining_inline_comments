{"pr_number": 4681, "pr_title": "Avoid crashing clients when fishing loot is empty, Fixes #4235", "pr_createdAt": "2020-10-23T15:29:14Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4681", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk2OTAzOA==", "url": "https://github.com/PaperMC/Paper/pull/4681#discussion_r510969038", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            +                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem != null ? entityitem.getBukkitEntity() : null, (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH);\n          \n          \n            \n            +                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem != null ? entityitem.getBukkitEntity() : null, (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH); // Paper - entityitem may be null", "author": "Proximyst", "createdAt": "2020-10-23T15:34:16Z", "path": "Spigot-Server-Patches/0594-Avoid-error-bubbling-up-when-item-stack-is-empty-in-.patch", "diffHunk": "@@ -0,0 +1,46 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Fri, 23 Oct 2020 15:01:44 +0200\n+Subject: [PATCH] Avoid error bubbling up when item stack is empty in fishing\n+ loot\n+\n+This can realistically only happen if there's custom loot active on fishing\n+which can return 0 items. This would disconnect the player who's fishing.\n+\n+diff --git a/src/main/java/net/minecraft/server/EntityFishingHook.java b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+index b6cace72ab2f3389408a5e528981fcff3b511180..01c3737389f5b921de0b81eb09a0e5601151d978 100644\n+--- a/src/main/java/net/minecraft/server/EntityFishingHook.java\n++++ b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+@@ -433,9 +433,15 @@ public class EntityFishingHook extends IProjectile {\n+ \n+                 while (iterator.hasNext()) {\n+                     ItemStack itemstack1 = (ItemStack) iterator.next();\n+-                    EntityItem entityitem = new EntityItem(this.world, this.locX(), this.locY(), this.locZ(), itemstack1);\n++                    // Paper start, new EntityItem would throw if for whatever reason (mostly shitty datapacks) the itemstack1 turns out to be empty\n++                    // if the item stack is empty we instead just have our entityitem as null\n++                    EntityItem entityitem = null;\n++                    if (!itemstack1.isEmpty()) {\n++                        entityitem = new EntityItem(this.world, this.locX(), this.locY(), this.locZ(), itemstack1);\n++                    }\n++                    // Paper end\n+                     // CraftBukkit start\n+-                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem.getBukkitEntity(), (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH);\n++                    PlayerFishEvent playerFishEvent = new PlayerFishEvent((Player) entityhuman.getBukkitEntity(), entityitem != null ? entityitem.getBukkitEntity() : null, (FishHook) this.getBukkitEntity(), PlayerFishEvent.State.CAUGHT_FISH);", "originalCommit": "381eabd208383b58248aaa09d7c070901ae58ce0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk2OTU3Mw==", "url": "https://github.com/PaperMC/Paper/pull/4681#discussion_r510969573", "bodyText": "Debug", "author": "Proximyst", "createdAt": "2020-10-23T15:35:07Z", "path": "Spigot-Server-Patches/0594-Don-t-crash-on-negative-item-count-for-fishing-loot.patch", "diffHunk": "@@ -0,0 +1,18 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Fri, 23 Oct 2020 15:01:44 +0200\n+Subject: [PATCH] Don't crash on negative item count for fishing loot\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/EntityFishingHook.java b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+index b6cace72ab2f3389408a5e528981fcff3b511180..f056192d513e27716136eaafe23d087e3fe42668 100644\n+--- a/src/main/java/net/minecraft/server/EntityFishingHook.java\n++++ b/src/main/java/net/minecraft/server/EntityFishingHook.java\n+@@ -433,6 +433,7 @@ public class EntityFishingHook extends IProjectile {\n+ \n+                 while (iterator.hasNext()) {\n+                     ItemStack itemstack1 = (ItemStack) iterator.next();\n++                    System.err.println(\"getCount() = \" + itemstack1.getCount());", "originalCommit": "381eabd208383b58248aaa09d7c070901ae58ce0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "82a09927f546169f8686109c4e8fd2f115c39620", "url": "https://github.com/PaperMC/Paper/commit/82a09927f546169f8686109c4e8fd2f115c39620", "message": "Avoid error bubbling up when item stack is empty in fishing loot\n\nThis would fix #4235", "committedDate": "2020-10-23T15:46:52Z", "type": "commit"}, {"oid": "82a09927f546169f8686109c4e8fd2f115c39620", "url": "https://github.com/PaperMC/Paper/commit/82a09927f546169f8686109c4e8fd2f115c39620", "message": "Avoid error bubbling up when item stack is empty in fishing loot\n\nThis would fix #4235", "committedDate": "2020-10-23T15:46:52Z", "type": "forcePushed"}]}