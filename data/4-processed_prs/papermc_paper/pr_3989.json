{"pr_number": 3989, "pr_title": "Fix harming potion dupe", "pr_createdAt": "2020-07-23T21:31:13Z", "pr_url": "https://github.com/PaperMC/Paper/pull/3989", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0MzY0Mw==", "url": "https://github.com/PaperMC/Paper/pull/3989#discussion_r459743643", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            +import java.util.ArrayList; // Paper - Fix harming potion dupe", "author": "JRoy", "createdAt": "2020-07-23T21:40:25Z", "path": "Spigot-Server-Patches/0549-Fix-harming-potion-dupe.patch", "diffHunk": "@@ -0,0 +1,61 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: PepperCode1 <44146161+PepperCode1@users.noreply.github.com>\n+Date: Thu, 23 Jul 2020 14:25:07 -0700\n+Subject: [PATCH] Fix harming potion dupe\n+\n+EntityLiving#applyInstantEffect() immediately kills the player and drops their inventory.\n+Before this patch, instant effects would be applied before the potion ItemStack is removed and replaced with a glass bottle. This caused the potion ItemStack to be dropped before it was supposed to be removed from the inventory. It also caused the glass bottle to be put into a dead player's inventory.\n+This patch makes it so that instant effects are applied after the potion ItemStack is removed, and the glass bottle is only put into the player's inventory if the player is not dead. Otherwise, the glass bottle is dropped on the ground.\n+\n+diff --git a/src/main/java/net/minecraft/server/ItemPotion.java b/src/main/java/net/minecraft/server/ItemPotion.java\n+index 0d204a46b8b23b6fb58acffc5de085e15f77767d..7dfd0691c89bdddcbccfe19911d91e9aaf0c64d1 100644\n+--- a/src/main/java/net/minecraft/server/ItemPotion.java\n++++ b/src/main/java/net/minecraft/server/ItemPotion.java\n+@@ -2,6 +2,7 @@ package net.minecraft.server;\n+ \n+ import java.util.Iterator;\n+ import java.util.List;\n++import java.util.ArrayList; // Paper - Fix harming potion dupe", "originalCommit": "37e56da16bc9a18f3cca764aacea861356fd5ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY4OTM3MQ==", "url": "https://github.com/PaperMC/Paper/pull/3989#discussion_r515689371", "bodyText": "The import has been removed in the latest version.", "author": "PepperCode1", "createdAt": "2020-11-01T23:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0MzY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0MzgzNA==", "url": "https://github.com/PaperMC/Paper/pull/3989#discussion_r459743834", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            +        List<MobEffect> instantLater = new ArrayList<>(); // Paper - Fix harming potion dupe\n          \n          \n            \n            +        List<MobEffect> instantLater = new it.unimi.dsi.fastutil.objects.ObjectArrayList<>(); // Paper - Fix harming potion dupe", "author": "JRoy", "createdAt": "2020-07-23T21:40:48Z", "path": "Spigot-Server-Patches/0549-Fix-harming-potion-dupe.patch", "diffHunk": "@@ -0,0 +1,61 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: PepperCode1 <44146161+PepperCode1@users.noreply.github.com>\n+Date: Thu, 23 Jul 2020 14:25:07 -0700\n+Subject: [PATCH] Fix harming potion dupe\n+\n+EntityLiving#applyInstantEffect() immediately kills the player and drops their inventory.\n+Before this patch, instant effects would be applied before the potion ItemStack is removed and replaced with a glass bottle. This caused the potion ItemStack to be dropped before it was supposed to be removed from the inventory. It also caused the glass bottle to be put into a dead player's inventory.\n+This patch makes it so that instant effects are applied after the potion ItemStack is removed, and the glass bottle is only put into the player's inventory if the player is not dead. Otherwise, the glass bottle is dropped on the ground.\n+\n+diff --git a/src/main/java/net/minecraft/server/ItemPotion.java b/src/main/java/net/minecraft/server/ItemPotion.java\n+index 0d204a46b8b23b6fb58acffc5de085e15f77767d..7dfd0691c89bdddcbccfe19911d91e9aaf0c64d1 100644\n+--- a/src/main/java/net/minecraft/server/ItemPotion.java\n++++ b/src/main/java/net/minecraft/server/ItemPotion.java\n+@@ -2,6 +2,7 @@ package net.minecraft.server;\n+ \n+ import java.util.Iterator;\n+ import java.util.List;\n++import java.util.ArrayList; // Paper - Fix harming potion dupe\n+ \n+ public class ItemPotion extends Item {\n+ \n+@@ -22,6 +23,7 @@ public class ItemPotion extends Item {\n+             CriterionTriggers.z.a((EntityPlayer) entityhuman, itemstack);\n+         }\n+ \n++        List<MobEffect> instantLater = new ArrayList<>(); // Paper - Fix harming potion dupe", "originalCommit": "37e56da16bc9a18f3cca764aacea861356fd5ed9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NTQ3Mg==", "url": "https://github.com/PaperMC/Paper/pull/3989#discussion_r515665472", "bodyText": "this if seems unnecessary, last I checked paper code wasn't running on the client :P", "author": "MiniDigger", "createdAt": "2020-11-01T20:04:32Z", "path": "Spigot-Server-Patches/0549-Fix-harming-potion-dupe.patch", "diffHunk": "@@ -0,0 +1,61 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: PepperCode1 <44146161+PepperCode1@users.noreply.github.com>\n+Date: Thu, 23 Jul 2020 14:25:07 -0700\n+Subject: [PATCH] Fix harming potion dupe\n+\n+EntityLiving#applyInstantEffect() immediately kills the player and drops their inventory.\n+Before this patch, instant effects would be applied before the potion ItemStack is removed and replaced with a glass bottle. This caused the potion ItemStack to be dropped before it was supposed to be removed from the inventory. It also caused the glass bottle to be put into a dead player's inventory.\n+This patch makes it so that instant effects are applied after the potion ItemStack is removed, and the glass bottle is only put into the player's inventory if the player is not dead. Otherwise, the glass bottle is dropped on the ground.\n+\n+diff --git a/src/main/java/net/minecraft/server/ItemPotion.java b/src/main/java/net/minecraft/server/ItemPotion.java\n+index 0d204a46b8b23b6fb58acffc5de085e15f77767d..7dfd0691c89bdddcbccfe19911d91e9aaf0c64d1 100644\n+--- a/src/main/java/net/minecraft/server/ItemPotion.java\n++++ b/src/main/java/net/minecraft/server/ItemPotion.java\n+@@ -2,6 +2,7 @@ package net.minecraft.server;\n+ \n+ import java.util.Iterator;\n+ import java.util.List;\n++import java.util.ArrayList; // Paper - Fix harming potion dupe\n+ \n+ public class ItemPotion extends Item {\n+ \n+@@ -22,6 +23,7 @@ public class ItemPotion extends Item {\n+             CriterionTriggers.z.a((EntityPlayer) entityhuman, itemstack);\n+         }\n+ \n++        List<MobEffect> instantLater = new ArrayList<>(); // Paper - Fix harming potion dupe\n+         if (!world.isClientSide) {\n+             List<MobEffect> list = PotionUtil.getEffects(itemstack);\n+             Iterator iterator = list.iterator();\n+@@ -30,7 +32,7 @@ public class ItemPotion extends Item {\n+                 MobEffect mobeffect = (MobEffect) iterator.next();\n+ \n+                 if (mobeffect.getMobEffect().isInstant()) {\n+-                    mobeffect.getMobEffect().applyInstantEffect(entityhuman, entityhuman, entityliving, mobeffect.getAmplifier(), 1.0D);\n++                    instantLater.add(mobeffect); // Paper - Fix harming potion dupe\n+                 } else {\n+                     entityliving.addEffect(new MobEffect(mobeffect), org.bukkit.event.entity.EntityPotionEffectEvent.Cause.POTION_DRINK); // CraftBukkit\n+                 }\n+@@ -44,7 +46,22 @@ public class ItemPotion extends Item {\n+             }\n+         }\n+ \n++        // Paper start - Fix harming potion dupe\n++        if (!world.isClientSide) {", "originalCommit": "37e56da16bc9a18f3cca764aacea861356fd5ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY4OTAzOA==", "url": "https://github.com/PaperMC/Paper/pull/3989#discussion_r515689038", "bodyText": "The client side check has been removed in the latest version.", "author": "PepperCode1", "createdAt": "2020-11-01T23:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NTQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NTgwNw==", "url": "https://github.com/PaperMC/Paper/pull/3989#discussion_r515665807", "bodyText": "whats the purpose of the entityhuman null check here?", "author": "MiniDigger", "createdAt": "2020-11-01T20:07:39Z", "path": "Spigot-Server-Patches/0549-Fix-harming-potion-dupe.patch", "diffHunk": "@@ -0,0 +1,61 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: PepperCode1 <44146161+PepperCode1@users.noreply.github.com>\n+Date: Thu, 23 Jul 2020 14:25:07 -0700\n+Subject: [PATCH] Fix harming potion dupe\n+\n+EntityLiving#applyInstantEffect() immediately kills the player and drops their inventory.\n+Before this patch, instant effects would be applied before the potion ItemStack is removed and replaced with a glass bottle. This caused the potion ItemStack to be dropped before it was supposed to be removed from the inventory. It also caused the glass bottle to be put into a dead player's inventory.\n+This patch makes it so that instant effects are applied after the potion ItemStack is removed, and the glass bottle is only put into the player's inventory if the player is not dead. Otherwise, the glass bottle is dropped on the ground.\n+\n+diff --git a/src/main/java/net/minecraft/server/ItemPotion.java b/src/main/java/net/minecraft/server/ItemPotion.java\n+index 0d204a46b8b23b6fb58acffc5de085e15f77767d..7dfd0691c89bdddcbccfe19911d91e9aaf0c64d1 100644\n+--- a/src/main/java/net/minecraft/server/ItemPotion.java\n++++ b/src/main/java/net/minecraft/server/ItemPotion.java\n+@@ -2,6 +2,7 @@ package net.minecraft.server;\n+ \n+ import java.util.Iterator;\n+ import java.util.List;\n++import java.util.ArrayList; // Paper - Fix harming potion dupe\n+ \n+ public class ItemPotion extends Item {\n+ \n+@@ -22,6 +23,7 @@ public class ItemPotion extends Item {\n+             CriterionTriggers.z.a((EntityPlayer) entityhuman, itemstack);\n+         }\n+ \n++        List<MobEffect> instantLater = new ArrayList<>(); // Paper - Fix harming potion dupe\n+         if (!world.isClientSide) {\n+             List<MobEffect> list = PotionUtil.getEffects(itemstack);\n+             Iterator iterator = list.iterator();\n+@@ -30,7 +32,7 @@ public class ItemPotion extends Item {\n+                 MobEffect mobeffect = (MobEffect) iterator.next();\n+ \n+                 if (mobeffect.getMobEffect().isInstant()) {\n+-                    mobeffect.getMobEffect().applyInstantEffect(entityhuman, entityhuman, entityliving, mobeffect.getAmplifier(), 1.0D);\n++                    instantLater.add(mobeffect); // Paper - Fix harming potion dupe\n+                 } else {\n+                     entityliving.addEffect(new MobEffect(mobeffect), org.bukkit.event.entity.EntityPotionEffectEvent.Cause.POTION_DRINK); // CraftBukkit\n+                 }\n+@@ -44,7 +46,22 @@ public class ItemPotion extends Item {\n+             }\n+         }\n+ \n++        // Paper start - Fix harming potion dupe\n++        if (!world.isClientSide) {\n++            for (MobEffect mobeffect : instantLater) {\n++                mobeffect.getMobEffect().applyInstantEffect(entityhuman, entityhuman, entityliving, mobeffect.getAmplifier(), 1.0D);\n++            }\n++        }\n++        // Paper end\n++\n+         if (entityhuman == null || !entityhuman.abilities.canInstantlyBuild) {\n++            // Paper start - Fix harming potion dupe\n++            if (entityliving.getHealth() <= 0 && !(entityhuman != null && entityliving.world.getGameRules().getBoolean(GameRules.KEEP_INVENTORY))) {", "originalCommit": "37e56da16bc9a18f3cca764aacea861356fd5ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY4ODk5MQ==", "url": "https://github.com/PaperMC/Paper/pull/3989#discussion_r515688991", "bodyText": "It has been removed in the latest version. I'm not sure why it was there either.", "author": "PepperCode1", "createdAt": "2020-11-01T23:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NTgwNw=="}], "type": "inlineReview"}, {"oid": "9d1eecad77d4fbec710282464eb3b4c43b3ef299", "url": "https://github.com/PaperMC/Paper/commit/9d1eecad77d4fbec710282464eb3b4c43b3ef299", "message": "Fix harming potion dupe\n\nEntityLiving#applyInstantEffect() immediately kills the player and drops their inventory.\nBefore this patch, instant effects would be applied before the potion ItemStack is removed and replaced with a glass bottle. This caused the potion ItemStack to be dropped before it was supposed to be removed from the inventory. It also caused the glass bottle to be put into a dead player's inventory.\nThis patch makes it so that instant effects are applied after the potion ItemStack is removed, and the glass bottle is only put into the player's inventory if the player is not dead. Otherwise, the glass bottle is dropped on the ground.", "committedDate": "2020-11-01T23:37:19Z", "type": "forcePushed"}, {"oid": "83ddaaf5117ba2f8e1c5b865682b537fa7a3ba38", "url": "https://github.com/PaperMC/Paper/commit/83ddaaf5117ba2f8e1c5b865682b537fa7a3ba38", "message": "Fix harming potion dupe\n\nEntityLiving#applyInstantEffect() immediately kills the player and drops their inventory.\nBefore this patch, instant effects would be applied before the potion ItemStack is removed and replaced with a glass bottle. This caused the potion ItemStack to be dropped before it was supposed to be removed from the inventory. It also caused the glass bottle to be put into a dead player's inventory.\nThis patch makes it so that instant effects are applied after the potion ItemStack is removed, and the glass bottle is only put into the player's inventory if the player is not dead. Otherwise, the glass bottle is dropped on the ground.", "committedDate": "2020-12-31T17:38:38Z", "type": "commit"}, {"oid": "83ddaaf5117ba2f8e1c5b865682b537fa7a3ba38", "url": "https://github.com/PaperMC/Paper/commit/83ddaaf5117ba2f8e1c5b865682b537fa7a3ba38", "message": "Fix harming potion dupe\n\nEntityLiving#applyInstantEffect() immediately kills the player and drops their inventory.\nBefore this patch, instant effects would be applied before the potion ItemStack is removed and replaced with a glass bottle. This caused the potion ItemStack to be dropped before it was supposed to be removed from the inventory. It also caused the glass bottle to be put into a dead player's inventory.\nThis patch makes it so that instant effects are applied after the potion ItemStack is removed, and the glass bottle is only put into the player's inventory if the player is not dead. Otherwise, the glass bottle is dropped on the ground.", "committedDate": "2020-12-31T17:38:38Z", "type": "forcePushed"}]}