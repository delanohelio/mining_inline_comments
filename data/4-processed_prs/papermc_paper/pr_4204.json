{"pr_number": 4204, "pr_title": "Fix TNT not pushing creative players", "pr_createdAt": "2020-08-25T18:56:19Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4204", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc4NzgwMg==", "url": "https://github.com/PaperMC/Paper/pull/4204#discussion_r476787802", "bodyText": "this can't be left as is.\nWhile yes notSpectator does belong on the other method, its more so these methods were backwards\nf is canAITarget and needs to be maintained, and this getTargetEntity needs to keep using this same selector as canAITarget instead of notSpectator", "author": "aikar", "createdAt": "2020-08-25T22:11:30Z", "path": "Spigot-Server-Patches/0339-Add-LivingEntity-getTargetEntity.patch", "diffHunk": "@@ -107,18 +107,6 @@ index 7c239b95c9f8dfa76d397979e6b3fdcc9ff55022..aecb5ca746be20e31f047a68f729d5c5\n      public int shieldBlockingDelay = world.paperConfig.shieldBlockingDelay;\n  \n      public int getShieldBlockingDelay() {\n-diff --git a/src/main/java/net/minecraft/server/IEntitySelector.java b/src/main/java/net/minecraft/server/IEntitySelector.java\n-index b88a99221933108141b558adef6aa91f0cedc136..c13bb708ccd14c3848afbc9afaf6439c1a574f22 100644\n---- a/src/main/java/net/minecraft/server/IEntitySelector.java\n-+++ b/src/main/java/net/minecraft/server/IEntitySelector.java\n-@@ -18,6 +18,7 @@ public final class IEntitySelector {\n-     public static final Predicate<Entity> e = (entity) -> {\n-         return !(entity instanceof EntityHuman) || !entity.isSpectator() && !((EntityHuman) entity).isCreative();\n-     };\n-+    public static Predicate<Entity> notSpectator() { return f; } // Paper - OBFHELPER", "originalCommit": "1cc8fa7e95df360c951159fe27158a847816c1a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM5NTgxNw==", "url": "https://github.com/PaperMC/Paper/pull/4204#discussion_r477395817", "bodyText": "I had a bit of trouble understanding what you meant here. But I hope I've fixed it correctly.", "author": "Prof-Bloodstone", "createdAt": "2020-08-26T15:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc4NzgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU3MTI3Ng==", "url": "https://github.com/PaperMC/Paper/pull/4204#discussion_r478571276", "bodyText": "This is still wrong, the notSpectator needs to stay on the same one it was before\nreturn !(entity instanceof EntityHuman) || !entity.isSpectator() && !((EntityHuman) entity).isCreative() && entity.world.getDifficulty() != EnumDifficulty.PEACEFUL;\nBut change its name to canAITarget()", "author": "aikar", "createdAt": "2020-08-27T17:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc4NzgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU4MjExMQ==", "url": "https://github.com/PaperMC/Paper/pull/4204#discussion_r478582111", "bodyText": "Oh, now I think I understand it. Previously notSpectator was on what it's on now, but in reality in this patch, it should be used on !(entity instanceof EntityHuman) || !entity.isSpectator() && !((EntityHuman) entity).isCreative() && entity.world.getDifficulty() != EnumDifficulty.PEACEFUL;. And you suggest a naming change to better match the behavior.\nI'll change it in a moment.", "author": "Prof-Bloodstone", "createdAt": "2020-08-27T17:30:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc4NzgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc5NDk2MQ==", "url": "https://github.com/PaperMC/Paper/pull/4204#discussion_r476794961", "bodyText": "lets flip the dead check to be first and use isAlive()\nso -> entity.isAlive() && !entity.isSpectator()\nthere is no reason to use the IEntitySelector here, so we can drop the obf helper as nothing else uses it once you clean up the other patches usage as i mentioned in the other review comment", "author": "aikar", "createdAt": "2020-08-25T22:21:08Z", "path": "Spigot-Server-Patches/0031-Fix-lag-from-explosions-processing-dead-entities.patch", "diffHunk": "@@ -5,27 +5,27 @@ Subject: [PATCH] Fix lag from explosions processing dead entities\n \n \n diff --git a/src/main/java/net/minecraft/server/Explosion.java b/src/main/java/net/minecraft/server/Explosion.java\n-index bf910359de9365f51461ec1b80aaabdb24e26449..abc9eea66fed45db54e7b2a26ca8f7b05ca40e20 100644\n+index bf910359de9365f51461ec1b80aaabdb24e26449..2288ca23ff274f3f83e7d021811d9b3efb20b534 100644\n --- a/src/main/java/net/minecraft/server/Explosion.java\n +++ b/src/main/java/net/minecraft/server/Explosion.java\n @@ -154,7 +154,7 @@ public class Explosion {\n          int i1 = MathHelper.floor(this.posY + (double) f2 + 1.0D);\n          int j1 = MathHelper.floor(this.posZ - (double) f2 - 1.0D);\n          int k1 = MathHelper.floor(this.posZ + (double) f2 + 1.0D);\n -        List<Entity> list = this.world.getEntities(this.source, new AxisAlignedBB((double) i, (double) l, (double) j1, (double) j, (double) i1, (double) k1));\n-+        List<Entity> list = this.world.getEntities(this.source, new AxisAlignedBB((double) i, (double) l, (double) j1, (double) j, (double) i1, (double) k1), (com.google.common.base.Predicate<Entity>) entity -> IEntitySelector.canAITarget().test(entity) && !entity.dead); // Paper - Fix lag from explosions processing dead entities\n++        List<Entity> list = this.world.getEntities(this.source, new AxisAlignedBB((double) i, (double) l, (double) j1, (double) j, (double) i1, (double) k1), (com.google.common.base.Predicate<Entity>) entity -> IEntitySelector.notSpectator().test(entity) && !entity.dead); // Paper - Fix lag from explosions processing dead entities", "originalCommit": "1cc8fa7e95df360c951159fe27158a847816c1a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c4d20a676d7e303e73e8cd2b9235709c9da431a", "url": "https://github.com/PaperMC/Paper/commit/8c4d20a676d7e303e73e8cd2b9235709c9da431a", "message": "Answer Aikar's feedback", "committedDate": "2020-08-26T15:27:59Z", "type": "forcePushed"}, {"oid": "57b72c2434e593d65ec5aef69f7da4a0999031f9", "url": "https://github.com/PaperMC/Paper/commit/57b72c2434e593d65ec5aef69f7da4a0999031f9", "message": "Rename 'notSpectator' to 'canAITarget' and move it to previously used field", "committedDate": "2020-08-28T10:35:46Z", "type": "forcePushed"}, {"oid": "f9def0b5b3fe28b0fe0d5317e939affe01ab1f0b", "url": "https://github.com/PaperMC/Paper/commit/f9def0b5b3fe28b0fe0d5317e939affe01ab1f0b", "message": "Fix TNT not pushing creative players", "committedDate": "2020-08-28T10:43:14Z", "type": "commit"}, {"oid": "f9def0b5b3fe28b0fe0d5317e939affe01ab1f0b", "url": "https://github.com/PaperMC/Paper/commit/f9def0b5b3fe28b0fe0d5317e939affe01ab1f0b", "message": "Fix TNT not pushing creative players", "committedDate": "2020-08-28T10:43:14Z", "type": "forcePushed"}]}