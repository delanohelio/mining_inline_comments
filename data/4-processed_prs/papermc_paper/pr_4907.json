{"pr_number": 4907, "pr_title": "Add API to get Tile Entities in a Chunk by Predicate", "pr_createdAt": "2020-12-18T11:12:13Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4907", "timeline": [{"oid": "c9c76d41f52b6ab5f619aa77e96d0b2c0870ac0b", "url": "https://github.com/PaperMC/Paper/commit/c9c76d41f52b6ab5f619aa77e96d0b2c0870ac0b", "message": "Add API to get Tile Entities in a Chunk by Predicate", "committedDate": "2020-12-18T11:24:21Z", "type": "forcePushed"}, {"oid": "21827fb0254cac0af54e43887a1cd60db6a9bfa9", "url": "https://github.com/PaperMC/Paper/commit/21827fb0254cac0af54e43887a1cd60db6a9bfa9", "message": "Add API to get Tile Entities in a Chunk by Predicate", "committedDate": "2020-12-18T11:26:04Z", "type": "forcePushed"}, {"oid": "ee7f38b132f1632808f818fcd43e3c8953136047", "url": "https://github.com/PaperMC/Paper/commit/ee7f38b132f1632808f818fcd43e3c8953136047", "message": "Add API to get Tile Entities in a Chunk by Predicate", "committedDate": "2020-12-18T11:26:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc5MjcxMg==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545792712", "bodyText": "Sorry, what would be false here? I realise its necessity, just curious :p", "author": "Proximyst", "createdAt": "2020-12-18T12:12:34Z", "path": "Spigot-Server-Patches/0619-Implement-a-method-to-get-tile-entities-in-a-chunk-b.patch", "diffHunk": "@@ -0,0 +1,55 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:55 +1000\n+Subject: [PATCH] Implement a method to get tile entities in a chunk by\n+ Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+index 42b47634437135a9e9b608283f3ce81c98ca181a..58f7ea1edf531bc642c62169b1c5d718bd24d71b 100644\n+--- a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n++++ b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+@@ -3,8 +3,10 @@ package org.bukkit.craftbukkit;\n+ import com.google.common.base.Preconditions;\n+ import com.google.common.base.Predicates;\n+ import java.lang.ref.WeakReference;\n++import java.util.ArrayList;\n+ import java.util.Arrays;\n+ import java.util.Collection;\n++import java.util.List;\n+ import java.util.function.Predicate;\n+ import net.minecraft.server.BiomeStorage;\n+ import net.minecraft.server.BlockPosition;\n+@@ -157,6 +159,32 @@ public class CraftChunk implements Chunk {\n+         return entities;\n+     }\n+ \n++    // Paper start\n++    @Override\n++    public BlockState[] getTileEntities(Predicate<Block> blockPredicate, boolean useSnapshot) {\n++        if (!isLoaded()) {\n++            getWorld().getChunkAt(x, z); // Transient load for this tick\n++        }\n++        net.minecraft.server.Chunk chunk = getHandle();\n++\n++        List<BlockState> entities = new ArrayList<>();\n++\n++        for (Object obj : chunk.tileEntities.keySet().toArray()) {\n++            if (!(obj instanceof BlockPosition)) {", "originalCommit": "ee7f38b132f1632808f818fcd43e3c8953136047", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTgwODcyMw==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545808723", "bodyText": "This was copied from the other ones. I imagine it's there for a reason, no idea what it is tho", "author": "me4502", "createdAt": "2020-12-18T12:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc5MjcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc5MzQ5Mg==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545793492", "bodyText": "I feel it'd be better to just return the list instead. Surely the copying to an array is pretty expensive?", "author": "Proximyst", "createdAt": "2020-12-18T12:14:13Z", "path": "Spigot-Server-Patches/0619-Implement-a-method-to-get-tile-entities-in-a-chunk-b.patch", "diffHunk": "@@ -0,0 +1,55 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:55 +1000\n+Subject: [PATCH] Implement a method to get tile entities in a chunk by\n+ Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+index 42b47634437135a9e9b608283f3ce81c98ca181a..58f7ea1edf531bc642c62169b1c5d718bd24d71b 100644\n+--- a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n++++ b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+@@ -3,8 +3,10 @@ package org.bukkit.craftbukkit;\n+ import com.google.common.base.Preconditions;\n+ import com.google.common.base.Predicates;\n+ import java.lang.ref.WeakReference;\n++import java.util.ArrayList;\n+ import java.util.Arrays;\n+ import java.util.Collection;\n++import java.util.List;\n+ import java.util.function.Predicate;\n+ import net.minecraft.server.BiomeStorage;\n+ import net.minecraft.server.BlockPosition;\n+@@ -157,6 +159,32 @@ public class CraftChunk implements Chunk {\n+         return entities;\n+     }\n+ \n++    // Paper start\n++    @Override\n++    public BlockState[] getTileEntities(Predicate<Block> blockPredicate, boolean useSnapshot) {\n++        if (!isLoaded()) {\n++            getWorld().getChunkAt(x, z); // Transient load for this tick\n++        }\n++        net.minecraft.server.Chunk chunk = getHandle();\n++\n++        List<BlockState> entities = new ArrayList<>();\n++\n++        for (Object obj : chunk.tileEntities.keySet().toArray()) {\n++            if (!(obj instanceof BlockPosition)) {\n++                continue;\n++            }\n++\n++            BlockPosition position = (BlockPosition) obj;\n++            Block block = worldServer.getWorld().getBlockAt(position.getX(), position.getY(), position.getZ());\n++            if (blockPredicate.test(block)) {\n++                entities.add(block.getState(useSnapshot));\n++            }\n++        }\n++\n++        return entities.toArray(new BlockState[0]);", "originalCommit": "ee7f38b132f1632808f818fcd43e3c8953136047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c7bd0e031a46c4e88bc474ebba629575d72435e", "url": "https://github.com/PaperMC/Paper/commit/0c7bd0e031a46c4e88bc474ebba629575d72435e", "message": "Add API to get Tile Entities in a Chunk by Predicate", "committedDate": "2020-12-18T12:56:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NDg3MQ==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545854871", "bodyText": "bad", "author": "MrIvanPlays", "createdAt": "2020-12-18T14:12:00Z", "path": "Spigot-Server-Patches/0619-Implement-a-method-to-get-tile-entities-in-a-chunk-b.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:55 +1000\n+Subject: [PATCH] Implement a method to get tile entities in a chunk by\n+ Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+index 42b47634437135a9e9b608283f3ce81c98ca181a..284e78c8171a9e50a4267433a953f4d9e8580f37 100644\n+--- a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n++++ b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+@@ -3,8 +3,10 @@ package org.bukkit.craftbukkit;\n+ import com.google.common.base.Preconditions;\n+ import com.google.common.base.Predicates;\n+ import java.lang.ref.WeakReference;\n++import java.util.ArrayList;", "originalCommit": "0c7bd0e031a46c4e88bc474ebba629575d72435e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NDk0Mg==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545854942", "bodyText": "bad", "author": "MrIvanPlays", "createdAt": "2020-12-18T14:12:06Z", "path": "Spigot-Server-Patches/0619-Implement-a-method-to-get-tile-entities-in-a-chunk-b.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:55 +1000\n+Subject: [PATCH] Implement a method to get tile entities in a chunk by\n+ Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+index 42b47634437135a9e9b608283f3ce81c98ca181a..284e78c8171a9e50a4267433a953f4d9e8580f37 100644\n+--- a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n++++ b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+@@ -3,8 +3,10 @@ package org.bukkit.craftbukkit;\n+ import com.google.common.base.Preconditions;\n+ import com.google.common.base.Predicates;\n+ import java.lang.ref.WeakReference;\n++import java.util.ArrayList;\n+ import java.util.Arrays;\n+ import java.util.Collection;\n++import java.util.List;", "originalCommit": "0c7bd0e031a46c4e88bc474ebba629575d72435e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NTE1OQ==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545855159", "bodyText": "java.util.List<BlockState> entities = new java.util.ArrayList<>();", "author": "MrIvanPlays", "createdAt": "2020-12-18T14:12:29Z", "path": "Spigot-Server-Patches/0619-Implement-a-method-to-get-tile-entities-in-a-chunk-b.patch", "diffHunk": "@@ -0,0 +1,50 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:55 +1000\n+Subject: [PATCH] Implement a method to get tile entities in a chunk by\n+ Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+index 42b47634437135a9e9b608283f3ce81c98ca181a..284e78c8171a9e50a4267433a953f4d9e8580f37 100644\n+--- a/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n++++ b/src/main/java/org/bukkit/craftbukkit/CraftChunk.java\n+@@ -3,8 +3,10 @@ package org.bukkit.craftbukkit;\n+ import com.google.common.base.Preconditions;\n+ import com.google.common.base.Predicates;\n+ import java.lang.ref.WeakReference;\n++import java.util.ArrayList;\n+ import java.util.Arrays;\n+ import java.util.Collection;\n++import java.util.List;\n+ import java.util.function.Predicate;\n+ import net.minecraft.server.BiomeStorage;\n+ import net.minecraft.server.BlockPosition;\n+@@ -157,6 +159,27 @@ public class CraftChunk implements Chunk {\n+         return entities;\n+     }\n+ \n++    // Paper start\n++    @Override\n++    public Collection<BlockState> getTileEntities(Predicate<Block> blockPredicate, boolean useSnapshot) {\n++        if (!isLoaded()) {\n++            getWorld().getChunkAt(x, z); // Transient load for this tick\n++        }\n++        net.minecraft.server.Chunk chunk = getHandle();\n++\n++        List<BlockState> entities = new ArrayList<>();", "originalCommit": "0c7bd0e031a46c4e88bc474ebba629575d72435e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM2NzgyNQ==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r546367825", "bodyText": "Please refrain from leaving reviews pointing out imports issues in the future. They are incredibly minor and unhelpful, and any imports that we feel shouldn't make it in the patch we can easily handle during merging.", "author": "DenWav", "createdAt": "2020-12-20T12:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NTE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NTMyMA==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545855320", "bodyText": "bad", "author": "MrIvanPlays", "createdAt": "2020-12-18T14:12:43Z", "path": "Spigot-API-Patches/0243-Add-a-method-to-get-tile-entities-in-a-chunk-by-Pred.patch", "diffHunk": "@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:39 +1000\n+Subject: [PATCH] Add a method to get tile entities in a chunk by Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/Chunk.java b/src/main/java/org/bukkit/Chunk.java\n+index b4ef6297f78d1f0c216e718024a21e6aa07cd1c6..98263d896f316983609432c45b85401a2692432d 100644\n+--- a/src/main/java/org/bukkit/Chunk.java\n++++ b/src/main/java/org/bukkit/Chunk.java\n+@@ -1,6 +1,8 @@\n+ package org.bukkit;\n+ \n+ import java.util.Collection;\n++import java.util.function.Predicate;", "originalCommit": "0c7bd0e031a46c4e88bc474ebba629575d72435e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NTM2NQ==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545855365", "bodyText": "bad", "author": "MrIvanPlays", "createdAt": "2020-12-18T14:12:47Z", "path": "Spigot-API-Patches/0243-Add-a-method-to-get-tile-entities-in-a-chunk-by-Pred.patch", "diffHunk": "@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:39 +1000\n+Subject: [PATCH] Add a method to get tile entities in a chunk by Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/Chunk.java b/src/main/java/org/bukkit/Chunk.java\n+index b4ef6297f78d1f0c216e718024a21e6aa07cd1c6..98263d896f316983609432c45b85401a2692432d 100644\n+--- a/src/main/java/org/bukkit/Chunk.java\n++++ b/src/main/java/org/bukkit/Chunk.java\n+@@ -1,6 +1,8 @@\n+ package org.bukkit;\n+ \n+ import java.util.Collection;\n++import java.util.function.Predicate;\n++", "originalCommit": "0c7bd0e031a46c4e88bc474ebba629575d72435e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NTc3Ng==", "url": "https://github.com/PaperMC/Paper/pull/4907#discussion_r545855776", "bodyText": "Collection getTileEntities(NotNull java.util.Predicate blockPredicate, boolean useSnapshot);", "author": "MrIvanPlays", "createdAt": "2020-12-18T14:13:28Z", "path": "Spigot-API-Patches/0243-Add-a-method-to-get-tile-entities-in-a-chunk-by-Pred.patch", "diffHunk": "@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Matthew Miller <mnmiller1@me.com>\n+Date: Fri, 18 Dec 2020 21:05:39 +1000\n+Subject: [PATCH] Add a method to get tile entities in a chunk by Predicate\n+\n+\n+diff --git a/src/main/java/org/bukkit/Chunk.java b/src/main/java/org/bukkit/Chunk.java\n+index b4ef6297f78d1f0c216e718024a21e6aa07cd1c6..98263d896f316983609432c45b85401a2692432d 100644\n+--- a/src/main/java/org/bukkit/Chunk.java\n++++ b/src/main/java/org/bukkit/Chunk.java\n+@@ -1,6 +1,8 @@\n+ package org.bukkit;\n+ \n+ import java.util.Collection;\n++import java.util.function.Predicate;\n++\n+ import org.bukkit.block.Block;\n+ import org.bukkit.block.BlockState;\n+ import org.bukkit.block.data.BlockData;\n+@@ -122,6 +124,16 @@ public interface Chunk extends PersistentDataHolder {\n+      */\n+     @NotNull\n+     BlockState[] getTileEntities(boolean useSnapshot);\n++\n++    /**\n++     * Get a list of all tile entities that match a given predicate in the chunk.\n++     *\n++     * @param blockPredicate The predicate of blocks to return tile entities for\n++     * @param useSnapshot Take snapshots or direct references\n++     * @return The tile entities.\n++     */\n++    @NotNull\n++    Collection<BlockState> getTileEntities(@NotNull Predicate<Block> blockPredicate, boolean useSnapshot);", "originalCommit": "0c7bd0e031a46c4e88bc474ebba629575d72435e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec099f57cfd04766e28cdaf60bdeccb4b2346b21", "url": "https://github.com/PaperMC/Paper/commit/ec099f57cfd04766e28cdaf60bdeccb4b2346b21", "message": "Add API to get Tile Entities in a Chunk by Predicate", "committedDate": "2020-12-19T12:46:45Z", "type": "forcePushed"}, {"oid": "f58bccc5db71ea759b8c0ee123fd6838973fa38f", "url": "https://github.com/PaperMC/Paper/commit/f58bccc5db71ea759b8c0ee123fd6838973fa38f", "message": "Add API to get Tile Entities in a Chunk by Predicate", "committedDate": "2020-12-24T09:24:28Z", "type": "commit"}, {"oid": "f58bccc5db71ea759b8c0ee123fd6838973fa38f", "url": "https://github.com/PaperMC/Paper/commit/f58bccc5db71ea759b8c0ee123fd6838973fa38f", "message": "Add API to get Tile Entities in a Chunk by Predicate", "committedDate": "2020-12-24T09:24:28Z", "type": "forcePushed"}]}