{"pr_number": 4845, "pr_title": "fixed bug in jvm checker", "pr_createdAt": "2020-12-03T20:29:18Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU3NTgwMg==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r535575802", "bodyText": "<3 thank you", "author": "Proximyst", "createdAt": "2020-12-03T20:32:20Z", "path": "Spigot-Server-Patches/0611-Add-warning-for-servers-not-running-on-Java-11.patch", "diffHunk": "@@ -4,21 +4,26 @@ Date: Wed, 2 Dec 2020 21:58:45 -0800\n Subject: [PATCH] Add warning for servers not running on Java 11\n \n \n-diff --git a/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java b/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java\n+diff --git a/src/main/java/io/papermc/paper/util/PaperJvmChecker.java b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java\n new file mode 100644\n-index 0000000000000000000000000000000000000000..023123d52fbb458e6ee2d38e42c9651a5c7be728\n+index 0000000000000000000000000000000000000000..89deb34c78c54a5b306722f0138d2eddbafc5c6c\n --- /dev/null\n-+++ b/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java\n-@@ -0,0 +1,56 @@\n-+package com.destroystokyo.paper.util;\n++++ b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java\n+@@ -0,0 +1,65 @@\n++package io.papermc.paper.util;", "originalCommit": "99a954d0057cb4bccf48fe94bef1ccc2c4e9af27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU3NzI1Mg==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r535577252", "bodyText": "Perhaps return afterwards? Not sure if we should try to parse the number after it hasn't been found :p", "author": "Proximyst", "createdAt": "2020-12-03T20:33:44Z", "path": "Spigot-Server-Patches/0611-Add-warning-for-servers-not-running-on-Java-11.patch", "diffHunk": "@@ -36,7 +41,11 @@ index 0000000000000000000000000000000000000000..023123d52fbb458e6ee2d38e42c9651a\n +\n +        final int javaVersionNum;\n +        try {\n-+            javaVersionNum = Integer.parseInt(version);\n++            Matcher versionMatcher = NUM_PATTERN.matcher(version);\n++            if (!versionMatcher.find()) {\n++                PaperJvmChecker.printWarning(javaVersion, logger);", "originalCommit": "99a954d0057cb4bccf48fe94bef1ccc2c4e9af27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4MTU4Nw==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r535581587", "bodyText": "Yeah, for sure", "author": "Machine-Maker", "createdAt": "2020-12-03T20:37:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU3NzI1Mg=="}], "type": "inlineReview"}, {"oid": "85ad9de2175ed1fdec9ef754be0571f299c02a53", "url": "https://github.com/PaperMC/Paper/commit/85ad9de2175ed1fdec9ef754be0571f299c02a53", "message": "fix bug in jvm version check", "committedDate": "2020-12-05T00:17:09Z", "type": "commit"}, {"oid": "85ad9de2175ed1fdec9ef754be0571f299c02a53", "url": "https://github.com/PaperMC/Paper/commit/85ad9de2175ed1fdec9ef754be0571f299c02a53", "message": "fix bug in jvm version check", "committedDate": "2020-12-05T00:17:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2MDQ1Mg==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r536460452", "bodyText": "I don't see any reason to keep this around for a single-time check, just make this a local variable.", "author": "DenWav", "createdAt": "2020-12-05T00:31:01Z", "path": "Spigot-Server-Patches/0611-Add-warning-for-servers-not-running-on-Java-11.patch", "diffHunk": "@@ -4,19 +4,24 @@ Date: Wed, 2 Dec 2020 21:58:45 -0800\n Subject: [PATCH] Add warning for servers not running on Java 11\n \n \n-diff --git a/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java b/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java\n+diff --git a/src/main/java/io/papermc/paper/util/PaperJvmChecker.java b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java\n new file mode 100644\n-index 0000000000000000000000000000000000000000..afe07487b1e7337293f7147619a6f10fcdef9d0e\n+index 0000000000000000000000000000000000000000..d761a9e0c1e71fadb981f9af4736d7e8e6fda2a9\n --- /dev/null\n-+++ b/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java\n-@@ -0,0 +1,49 @@\n-+package com.destroystokyo.paper.util;\n++++ b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java\n+@@ -0,0 +1,58 @@\n++package io.papermc.paper.util;\n +\n +import org.apache.logging.log4j.LogManager;\n +import org.apache.logging.log4j.Logger;\n +\n++import java.util.regex.Matcher;\n++import java.util.regex.Pattern;\n++\n +public class PaperJvmChecker {\n +\n++    private final static Pattern NUM_PATTERN = Pattern.compile(\"\\\\d+\");", "originalCommit": "85ad9de2175ed1fdec9ef754be0571f299c02a53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2Mjk4Mw==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r536462983", "bodyText": "We might as well use regex for handling the 1. part too. Let's do:\n(?:1\\.)?(\\d+)\n\nAnd an error message for when the pattern fails would be good too.\nSo that would simplify the whole method to:\nprivate static int getJvmVersion() {\n    String javaVersion = System.getProperty(\"java.version\");\n    final Matcher matcher = Pattern.compile(\"(?:1\\\\.)?(\\\\d+)\").matcher(javaVersion);\n    if (!matcher.find()) {\n        LogManager.getLogger().warn(\"Failed to determine Java version; Could not parse {}\", javaVersion);\n        return -1;\n    }\n\n    final String version = matcher.group(1);\n    try {\n        return Integer.parseInt(version);\n    } catch (final NumberFormatException e) {\n        LogManager.getLogger().warn(\"Failed to determine Java version; Could not parse {} from {}\", version, javaVersion, e);\n        return -1;\n    }\n}", "author": "DenWav", "createdAt": "2020-12-05T00:40:34Z", "path": "Spigot-Server-Patches/0611-Add-warning-for-servers-not-running-on-Java-11.patch", "diffHunk": "@@ -4,19 +4,24 @@ Date: Wed, 2 Dec 2020 21:58:45 -0800\n Subject: [PATCH] Add warning for servers not running on Java 11\n \n \n-diff --git a/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java b/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java\n+diff --git a/src/main/java/io/papermc/paper/util/PaperJvmChecker.java b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java\n new file mode 100644\n-index 0000000000000000000000000000000000000000..afe07487b1e7337293f7147619a6f10fcdef9d0e\n+index 0000000000000000000000000000000000000000..d761a9e0c1e71fadb981f9af4736d7e8e6fda2a9\n --- /dev/null\n-+++ b/src/main/java/com/destroystokyo/paper/util/PaperJvmChecker.java\n-@@ -0,0 +1,49 @@\n-+package com.destroystokyo.paper.util;\n++++ b/src/main/java/io/papermc/paper/util/PaperJvmChecker.java\n+@@ -0,0 +1,58 @@\n++package io.papermc.paper.util;\n +\n +import org.apache.logging.log4j.LogManager;\n +import org.apache.logging.log4j.Logger;\n +\n++import java.util.regex.Matcher;\n++import java.util.regex.Pattern;\n++\n +public class PaperJvmChecker {\n +\n++    private final static Pattern NUM_PATTERN = Pattern.compile(\"\\\\d+\");", "originalCommit": "85ad9de2175ed1fdec9ef754be0571f299c02a53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2MzUwNw==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r536463507", "bodyText": "Unnecessary import, the class is only used 1 time.", "author": "DenWav", "createdAt": "2020-12-05T00:42:41Z", "path": "Spigot-Server-Patches/0611-Add-warning-for-servers-not-running-on-Java-11.patch", "diffHunk": "@@ -60,14 +69,22 @@ index 0000000000000000000000000000000000000000..afe07487b1e7337293f7147619a6f10f\n +    }\n +}\n diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java\n-index 0108a1a68572df562349688e93f8134cb14d6116..12d781f4ae6a46d0885972035870d5b5b62f5b8b 100644\n+index 0108a1a68572df562349688e93f8134cb14d6116..0d3d8fde1d3ae94ec79b36ad40997c39100d252a 100644\n --- a/src/main/java/net/minecraft/server/MinecraftServer.java\n +++ b/src/main/java/net/minecraft/server/MinecraftServer.java\n-@@ -950,6 +950,8 @@ public abstract class MinecraftServer extends IAsyncTaskHandlerReentrant<TickTas\n+@@ -69,6 +69,7 @@ import org.bukkit.craftbukkit.Main;\n+ import org.bukkit.event.server.ServerLoadEvent;\n+ // CraftBukkit end\n+ import co.aikar.timings.MinecraftTimings; // Paper\n++import io.papermc.paper.util.PaperJvmChecker; // Paper", "originalCommit": "85ad9de2175ed1fdec9ef754be0571f299c02a53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2MzczMw==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r536463733", "bodyText": "actually, it is necessary, you get compile errors if you don't do imports on any of the classes in the paper io package, because there is an io nms class that throws everything off. its really annoying", "author": "Machine-Maker", "createdAt": "2020-12-05T00:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2MzUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2Mzk5Ng==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r536463996", "bodyText": "Jesus fucking christ. You're right, I forgot about that nonsense. Carry on...", "author": "DenWav", "createdAt": "2020-12-05T00:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2MzUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUwNDEwNA==", "url": "https://github.com/PaperMC/Paper/pull/4845#discussion_r536504104", "bodyText": "rip tokyo", "author": "BillyGalbreath", "createdAt": "2020-12-05T04:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2MzUwNw=="}], "type": "inlineReview"}, {"oid": "78611c64277468f3e97a1d362b331b37a3488808", "url": "https://github.com/PaperMC/Paper/commit/78611c64277468f3e97a1d362b331b37a3488808", "message": "changed whole check to regex-based check", "committedDate": "2020-12-05T01:42:00Z", "type": "commit"}]}