{"pr_number": 4714, "pr_title": "Fixed furnace cook-speed multiplier losing precision while calculating cook times", "pr_createdAt": "2020-11-01T06:17:53Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4714", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYwNTkzNA==", "url": "https://github.com/PaperMC/Paper/pull/4714#discussion_r515605934", "bodyText": "unnecessary new line", "author": "MiniDigger", "createdAt": "2020-11-01T10:48:55Z", "path": "Spigot-Server-Patches/0288-Implement-furnace-cook-speed-multiplier-API.patch", "diffHunk": "@@ -5,27 +5,51 @@ Subject: [PATCH] Implement furnace cook speed multiplier API\n \n Signed-off-by: Tassu <git@tassu.me>\n \n+Fixed an issue where a furnace's cook-speed multiplier rounds down\n+to the nearest Integer when updating its current cook time.\n+\n+Instead of incrementing the cookTime counter by the current cookSpeedMultiplier (which is causing \n+the loss in precision issue due to double -> integer casting), I have instead modified an internal function,\n+getRecipeCookingTime(), to scale the total cooking time of the current item to the current cookSpeedMultiplier.\n+\n+This is done through dividing the total cook time of the item by the set multiplier, and taking the ceiling\n+of the final output (ceiling is used here to replicate the behavior of this previous patch, otherwise items smelted\n+in furnaces with odd multipliers will finish cooking at least 1 tick earlier).\n+\n+I also changed the access modifier for the getRecipeCookingTime() function to public, as it allows\n+the setCookSpeedMultiplier API call to immediately adjust the current cooking time to the newly set multiplier.\n+Please let me know if this is a safe change or not.\n+\n+This patch is tested by a small test plugin that I wrote yesterday. I can confirm that it works for\n+all blast furnaces, smokers, and normal furnaces!\n+\n+This plugin can be found at:\n+https://github.com/ericsu14/furnacetest\n+\n+Modified by: Eric Su <ericsu@alumni.usc.edu>\n+\n diff --git a/src/main/java/net/minecraft/server/TileEntityFurnace.java b/src/main/java/net/minecraft/server/TileEntityFurnace.java\n-index 99b20fa5feff0f766124d4ec9474852e33e329f2..1d3c2dd93657fb5dc71ee6b444c585b54619d1e8 100644\n+index 99b20fa5feff0f766124d4ec9474852e33e329f2..ac098e9005bf491b40d988512b19da2c1a8cfb1a 100644\n --- a/src/main/java/net/minecraft/server/TileEntityFurnace.java\n +++ b/src/main/java/net/minecraft/server/TileEntityFurnace.java\n-@@ -10,6 +10,7 @@ import java.util.List;\n+@@ -10,6 +10,8 @@ import java.util.List;\n  import java.util.Map;\n  import javax.annotation.Nullable;\n  // CraftBukkit start\n +import java.util.List;\n++", "originalCommit": "33766c4524285ddf9b80045abf78ce0fabcd2368", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTYwNjIxMA==", "url": "https://github.com/PaperMC/Paper/pull/4714#discussion_r515606210", "bodyText": "I would probably cut down this patch a bit, the test plugin isn't necessary to be mentioned here", "author": "MiniDigger", "createdAt": "2020-11-01T10:51:13Z", "path": "Spigot-Server-Patches/0288-Implement-furnace-cook-speed-multiplier-API.patch", "diffHunk": "@@ -5,27 +5,51 @@ Subject: [PATCH] Implement furnace cook speed multiplier API\n \n Signed-off-by: Tassu <git@tassu.me>\n \n+Fixed an issue where a furnace's cook-speed multiplier rounds down\n+to the nearest Integer when updating its current cook time.\n+\n+Instead of incrementing the cookTime counter by the current cookSpeedMultiplier (which is causing \n+the loss in precision issue due to double -> integer casting), I have instead modified an internal function,\n+getRecipeCookingTime(), to scale the total cooking time of the current item to the current cookSpeedMultiplier.\n+\n+This is done through dividing the total cook time of the item by the set multiplier, and taking the ceiling\n+of the final output (ceiling is used here to replicate the behavior of this previous patch, otherwise items smelted\n+in furnaces with odd multipliers will finish cooking at least 1 tick earlier).\n+\n+I also changed the access modifier for the getRecipeCookingTime() function to public, as it allows\n+the setCookSpeedMultiplier API call to immediately adjust the current cooking time to the newly set multiplier.\n+Please let me know if this is a safe change or not.\n+\n+This patch is tested by a small test plugin that I wrote yesterday. I can confirm that it works for\n+all blast furnaces, smokers, and normal furnaces!\n+\n+This plugin can be found at:\n+https://github.com/ericsu14/furnacetest\n+\n+Modified by: Eric Su <ericsu@alumni.usc.edu>", "originalCommit": "33766c4524285ddf9b80045abf78ce0fabcd2368", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "27d8ed96fa831cf4853bab0bc2ebd3b5098c4022", "url": "https://github.com/PaperMC/Paper/commit/27d8ed96fa831cf4853bab0bc2ebd3b5098c4022", "message": "Fixed furnace cook-speed multiplier losing precision when calculating cook time\n\nRemoved unused imports and rewritten patch notes\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nSetting a furnace's cook time multiplier now updates the furnace's total cook time\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nRevert \"Merge branch 'master' of https://github.com/ericsu14/Paper\"\n\nThis reverts commit 9645757b36678ca5fdb432c62827012f579d5a50, reversing\nchanges made to a87386326a785ec82fdfd82a2204a167bbaff648.\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nExposed the internal getRecipeCookingTime function\n\nThis is so that its CraftFurnace implementation can use it to correctly update the furnace's total cooking time\n\nAdded patch notes\n\nAdded a link to my test plugin\n\nFixed a typo in patch notes\n\nRemoved unnecessary whitespace and trimed down patch notes", "committedDate": "2020-11-01T18:13:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY1OTI3NQ==", "url": "https://github.com/PaperMC/Paper/pull/4714#discussion_r515659275", "bodyText": "Prefer int here; there is no need in using a boxed value here.", "author": "Proximyst", "createdAt": "2020-11-01T19:07:40Z", "path": "Spigot-Server-Patches/0288-Implement-furnace-cook-speed-multiplier-API.patch", "diffHunk": "@@ -45,25 +50,39 @@ index 99b20fa5feff0f766124d4ec9474852e33e329f2..1d3c2dd93657fb5dc71ee6b444c585b5\n          ContainerUtil.a(nbttagcompound, this.items);\n          NBTTagCompound nbttagcompound1 = new NBTTagCompound();\n  \n-@@ -295,8 +303,8 @@ public abstract class TileEntityFurnace extends TileEntityContainer implements I\n-                 }\n+@@ -296,7 +304,7 @@ public abstract class TileEntityFurnace extends TileEntityContainer implements I\n  \n                  if (this.isBurning() && this.canBurn(irecipe)) {\n--                    ++this.cookTime;\n+                     ++this.cookTime;\n -                    if (this.cookTime == this.cookTimeTotal) {\n-+                    this.cookTime += cookSpeedMultiplier; // Paper - cook speed multiplier API\n +                    if (this.cookTime >= this.cookTimeTotal) { // Paper - cook speed multiplier API\n                          this.cookTime = 0;\n                          this.cookTimeTotal = this.getRecipeCookingTime();\n                          this.burn(irecipe);\n+@@ -396,9 +404,13 @@ public abstract class TileEntityFurnace extends TileEntityContainer implements I\n+         }\n+     }\n+ \n+-    protected int getRecipeCookingTime() {\n+-        return (this.hasWorld()) ? (Integer) this.world.getCraftingManager().craft((Recipes<RecipeCooking>) this.c, this, this.world).map(RecipeCooking::getCookingTime).orElse(200) : 200; // CraftBukkit - SPIGOT-4302 // Eclipse fail\n++    // Paper begin - Expose this function so CraftFurnace can correctly scale the total cooking time to a new multiplier\n++    public int getRecipeCookingTime() {\n++        /* Scale the recipe's cooking time to the current cookSpeedMultiplier */\n++        Integer cookTime = (this.hasWorld()) ? (Integer) this.world.getCraftingManager().craft((Recipes<RecipeCooking>) this.c, this, this.world).map(RecipeCooking::getCookingTime).orElse(200) : 200; // CraftBukkit - SPIGOT-4302 // Eclipse fail", "originalCommit": "27d8ed96fa831cf4853bab0bc2ebd3b5098c4022", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY4OTczNQ==", "url": "https://github.com/PaperMC/Paper/pull/4714#discussion_r515689735", "bodyText": "Just changed it to an int in my end! I initially used an Integer wrapper because the original code already casted the current recipe's cook time into an Integer in the first place.", "author": "ericsu14", "createdAt": "2020-11-01T23:47:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY1OTI3NQ=="}], "type": "inlineReview"}, {"oid": "f2ace5a4156fb594f743134fc7a02fe179077771", "url": "https://github.com/PaperMC/Paper/commit/f2ace5a4156fb594f743134fc7a02fe179077771", "message": "Fixed furnace cook-speed multiplier losing precision when calculating cook time\n\nRemoved unused imports and rewritten patch notes\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nSetting a furnace's cook time multiplier now updates the furnace's total cook time\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nRevert \"Merge branch 'master' of https://github.com/ericsu14/Paper\"\n\nThis reverts commit 9645757b36678ca5fdb432c62827012f579d5a50, reversing\nchanges made to a87386326a785ec82fdfd82a2204a167bbaff648.\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nExposed the internal getRecipeCookingTime function\n\nThis is so that its CraftFurnace implementation can use it to correctly update the furnace's total cooking time\n\nAdded patch notes\n\nAdded a link to my test plugin\n\nFixed a typo in patch notes\n\nRemoved unnecessary whitespace and trimed down patch notes", "committedDate": "2020-11-01T23:15:29Z", "type": "forcePushed"}, {"oid": "7a5490db303fe93b48254e8aee9aa0240df94a8e", "url": "https://github.com/PaperMC/Paper/commit/7a5490db303fe93b48254e8aee9aa0240df94a8e", "message": "Fixed furnace cook-speed multiplier losing precision when calculating cook time\n\nRemoved unused imports and rewritten patch notes\n\nSetting a furnace's cook time multiplier now updates the furnace's total cook time\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nExposed the internal getRecipeCookingTime function\n\nRemoved unnecessary whitespace and trimed down patch notes\n\nChanged cookTime variable to a primitive integer\n\nFixed furnace cook-speed multiplier losing precision when calculating cook time\n\nRemoved unused imports and rewritten patch notes\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nSetting a furnace's cook time multiplier now updates the furnace's total cook time\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nRevert \"Merge branch 'master' of https://github.com/ericsu14/Paper\"\n\nThis reverts commit 9645757b36678ca5fdb432c62827012f579d5a50, reversing\nchanges made to a87386326a785ec82fdfd82a2204a167bbaff648.\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nExposed the internal getRecipeCookingTime function\n\nThis is so that its CraftFurnace implementation can use it to correctly update the furnace's total cooking time\n\nAdded patch notes\n\nAdded a link to my test plugin\n\nFixed a typo in patch notes\n\nRemoved unnecessary whitespace and trimed down patch notes\n\nChanged cookTime variable to a primitive integer", "committedDate": "2020-11-01T23:43:07Z", "type": "forcePushed"}, {"oid": "d471799c5ddf36d8c320077fa8094337ccff14a8", "url": "https://github.com/PaperMC/Paper/commit/d471799c5ddf36d8c320077fa8094337ccff14a8", "message": "Fixed furnace cook-speed multiplier losing precision when calculating cook time\n\nRemoved unused imports and rewritten patch notes\n\nSetting a furnace's cook time multiplier now updates the furnace's total cook time\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nExposed the internal getRecipeCookingTime function\n\nRemoved unnecessary whitespace and trimed down patch notes\n\nChanged cookTime variable to a primitive integer\n\nFixed furnace cook-speed multiplier losing precision when calculating cook time\n\nRemoved unused imports and rewritten patch notes\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nSetting a furnace's cook time multiplier now updates the furnace's total cook time\n\nMoved the new cook time improvements to the getRecipeCookingTime function to fix visual glitches with the progress bar\n\nRevert \"Merge branch 'master' of https://github.com/ericsu14/Paper\"\n\nThis reverts commit 9645757b36678ca5fdb432c62827012f579d5a50, reversing\nchanges made to a87386326a785ec82fdfd82a2204a167bbaff648.\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nResolved issue where furnace progress bar overflows upon resmelting the item when the original fuel source depletes\n\nExposed the internal getRecipeCookingTime function\n\nThis is so that its CraftFurnace implementation can use it to correctly update the furnace's total cooking time\n\nAdded patch notes\n\nAdded a link to my test plugin\n\nFixed a typo in patch notes\n\nRemoved unnecessary whitespace and trimed down patch notes\n\nChanged cookTime variable to a primitive integer", "committedDate": "2021-03-03T19:56:52Z", "type": "forcePushed"}, {"oid": "a9d5035af2d427554804ac65be985f60e74a2af4", "url": "https://github.com/PaperMC/Paper/commit/a9d5035af2d427554804ac65be985f60e74a2af4", "message": "Fixed furnace cook-speed multiplier losing precision when calculating cook time", "committedDate": "2021-03-03T20:03:06Z", "type": "commit"}, {"oid": "a9d5035af2d427554804ac65be985f60e74a2af4", "url": "https://github.com/PaperMC/Paper/commit/a9d5035af2d427554804ac65be985f60e74a2af4", "message": "Fixed furnace cook-speed multiplier losing precision when calculating cook time", "committedDate": "2021-03-03T20:03:06Z", "type": "forcePushed"}]}