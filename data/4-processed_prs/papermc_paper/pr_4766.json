{"pr_number": 4766, "pr_title": "fixed kick event leave message", "pr_createdAt": "2020-11-14T17:37:57Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4766", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NDM1NQ==", "url": "https://github.com/PaperMC/Paper/pull/4766#discussion_r523444355", "bodyText": "Move this up to the method declaration", "author": "Proximyst", "createdAt": "2020-11-14T17:45:19Z", "path": "Spigot-Server-Patches/0599-Fixed-kick-event-leave-message-not-being-sent.patch", "diffHunk": "@@ -0,0 +1,69 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Jake Potrebic <jake.m.potrebic@gmail.com>\n+Date: Sat, 14 Nov 2020 09:36:43 -0800\n+Subject: [PATCH] Fixed kick event leave message not being sent\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java\n+index 563ae7355f4f4645d21f2fbd494a5b5656c5e664..daff4bd095ee2ab1b6462c0d8258503da92c013a 100644\n+--- a/src/main/java/net/minecraft/server/PlayerConnection.java\n++++ b/src/main/java/net/minecraft/server/PlayerConnection.java\n+@@ -303,7 +303,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         this.networkManager.sendPacket(new PacketPlayOutKickDisconnect(ichatbasecomponent), (future) -> {\n+             this.networkManager.close(ichatbasecomponent);\n+         });\n+-        this.a(ichatbasecomponent); // CraftBukkit - fire quit instantly\n++        this.onAllDisconnect(ichatbasecomponent, event.getLeaveMessage()); // CraftBukkit - fire quit instantly // Paper\n+         this.networkManager.stopReading();\n+         MinecraftServer minecraftserver = this.minecraftServer;\n+         NetworkManager networkmanager = this.networkManager;\n+@@ -1658,6 +1658,11 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+ \n+     @Override\n+     public void a(IChatBaseComponent ichatbasecomponent) {\n++        // Paper start\n++        this.onAllDisconnect(ichatbasecomponent, this.minecraftServer.getPlayerList().disconnect(this.player, \"\\u00A7e\" + this.player.getName() + \" left the game\"));\n++    }\n++\n++    private void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n+         // CraftBukkit start - Rarely it would send a disconnect line twice\n+         if (this.processedDisconnect) {\n+             return;\n+@@ -1673,7 +1678,6 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         */\n+ \n+         this.player.p();\n+-        String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);\n+         if ((quitMessage != null) && (quitMessage.length() > 0)) {\n+             this.minecraftServer.getPlayerList().sendMessage(CraftChatMessage.fromString(quitMessage));\n+         }\n+@@ -1690,6 +1694,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         }\n+ \n+     }\n++    // Paper end", "originalCommit": "e93de5a037784a55cf818865028564c63d6c1a58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ0NDM2MA==", "url": "https://github.com/PaperMC/Paper/pull/4766#discussion_r523444360", "bodyText": "Comment this", "author": "Proximyst", "createdAt": "2020-11-14T17:45:24Z", "path": "Spigot-Server-Patches/0599-Fixed-kick-event-leave-message-not-being-sent.patch", "diffHunk": "@@ -0,0 +1,69 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Jake Potrebic <jake.m.potrebic@gmail.com>\n+Date: Sat, 14 Nov 2020 09:36:43 -0800\n+Subject: [PATCH] Fixed kick event leave message not being sent\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java\n+index 563ae7355f4f4645d21f2fbd494a5b5656c5e664..daff4bd095ee2ab1b6462c0d8258503da92c013a 100644\n+--- a/src/main/java/net/minecraft/server/PlayerConnection.java\n++++ b/src/main/java/net/minecraft/server/PlayerConnection.java\n+@@ -303,7 +303,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         this.networkManager.sendPacket(new PacketPlayOutKickDisconnect(ichatbasecomponent), (future) -> {\n+             this.networkManager.close(ichatbasecomponent);\n+         });\n+-        this.a(ichatbasecomponent); // CraftBukkit - fire quit instantly\n++        this.onAllDisconnect(ichatbasecomponent, event.getLeaveMessage()); // CraftBukkit - fire quit instantly // Paper\n+         this.networkManager.stopReading();\n+         MinecraftServer minecraftserver = this.minecraftServer;\n+         NetworkManager networkmanager = this.networkManager;\n+@@ -1658,6 +1658,11 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+ \n+     @Override\n+     public void a(IChatBaseComponent ichatbasecomponent) {\n++        // Paper start\n++        this.onAllDisconnect(ichatbasecomponent, this.minecraftServer.getPlayerList().disconnect(this.player, \"\\u00A7e\" + this.player.getName() + \" left the game\"));\n++    }\n++\n++    private void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n+         // CraftBukkit start - Rarely it would send a disconnect line twice\n+         if (this.processedDisconnect) {\n+             return;\n+@@ -1673,7 +1678,6 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         */\n+ \n+         this.player.p();\n+-        String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);", "originalCommit": "e93de5a037784a55cf818865028564c63d6c1a58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ1MDM0Mg==", "url": "https://github.com/PaperMC/Paper/pull/4766#discussion_r523450342", "bodyText": "I meant move this under the declaration, i.e.:\nprivate void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n    // Paper end", "author": "Proximyst", "createdAt": "2020-11-14T18:50:09Z", "path": "Spigot-Server-Patches/0599-Fixed-kick-event-leave-message-not-being-sent.patch", "diffHunk": "@@ -0,0 +1,71 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Jake Potrebic <jake.m.potrebic@gmail.com>\n+Date: Sat, 14 Nov 2020 09:36:43 -0800\n+Subject: [PATCH] Fixed kick event leave message not being sent\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java\n+index 563ae7355f4f4645d21f2fbd494a5b5656c5e664..7b44f231f03d41d83c7680cfa9efc729e8d646ed 100644\n+--- a/src/main/java/net/minecraft/server/PlayerConnection.java\n++++ b/src/main/java/net/minecraft/server/PlayerConnection.java\n+@@ -303,7 +303,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         this.networkManager.sendPacket(new PacketPlayOutKickDisconnect(ichatbasecomponent), (future) -> {\n+             this.networkManager.close(ichatbasecomponent);\n+         });\n+-        this.a(ichatbasecomponent); // CraftBukkit - fire quit instantly\n++        this.onAllDisconnect(ichatbasecomponent, event.getLeaveMessage()); // CraftBukkit - fire quit instantly // Paper\n+         this.networkManager.stopReading();\n+         MinecraftServer minecraftserver = this.minecraftServer;\n+         NetworkManager networkmanager = this.networkManager;\n+@@ -1658,6 +1658,11 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+ \n+     @Override\n+     public void a(IChatBaseComponent ichatbasecomponent) {\n++        // Paper start\n++        this.onAllDisconnect(ichatbasecomponent, this.minecraftServer.getPlayerList().disconnect(this.player, \"\\u00A7e\" + this.player.getName() + \" left the game\"));\n++    }\n++\n++    private void onAllDisconnect(IChatBaseComponent ichatbasecomponent, String quitMessage) {\n+         // CraftBukkit start - Rarely it would send a disconnect line twice\n+         if (this.processedDisconnect) {\n+             return;\n+@@ -1673,7 +1678,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+         */\n+ \n+         this.player.p();\n+-        String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);\n++        // String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player); // Paper\n+         if ((quitMessage != null) && (quitMessage.length() > 0)) {\n+             this.minecraftServer.getPlayerList().sendMessage(CraftChatMessage.fromString(quitMessage));\n+         }\n+@@ -1688,7 +1693,7 @@ public class PlayerConnection implements PacketListenerPlayIn {\n+             PlayerConnection.LOGGER.info(\"Stopping singleplayer server as player logged out\");\n+             this.minecraftServer.safeShutdown(false);\n+         }\n+-\n++        // Paper end", "originalCommit": "23f0dfa66cc9df25c55747130315043d24e30913", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2NDYyOA==", "url": "https://github.com/PaperMC/Paper/pull/4766#discussion_r523464628", "bodyText": "oh, ok I get it. I fixed it now.", "author": "Machine-Maker", "createdAt": "2020-11-14T21:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ1MDM0Mg=="}], "type": "inlineReview"}, {"oid": "3b548b4187cae5b4554260d3c7aee99d571416c3", "url": "https://github.com/PaperMC/Paper/commit/3b548b4187cae5b4554260d3c7aee99d571416c3", "message": "adjusted for quit reason", "committedDate": "2020-11-14T22:04:33Z", "type": "forcePushed"}, {"oid": "7adf8a472b6b837c8b53ceec0ff5fc06dd956028", "url": "https://github.com/PaperMC/Paper/commit/7adf8a472b6b837c8b53ceec0ff5fc06dd956028", "message": "fixed kick event leave message", "committedDate": "2021-03-21T23:13:13Z", "type": "forcePushed"}, {"oid": "8ed7fae55949b56a3e43834d2878f2648275c207", "url": "https://github.com/PaperMC/Paper/commit/8ed7fae55949b56a3e43834d2878f2648275c207", "message": "fixed kick event leave message", "committedDate": "2021-05-19T03:27:34Z", "type": "forcePushed"}, {"oid": "1e1231124e1fcbe772da4361033572a2f60bf4cf", "url": "https://github.com/PaperMC/Paper/commit/1e1231124e1fcbe772da4361033572a2f60bf4cf", "message": "fixed kick event leave message", "committedDate": "2021-05-24T05:49:26Z", "type": "forcePushed"}, {"oid": "c809a41fa47a551375ad0817227dc64a08540100", "url": "https://github.com/PaperMC/Paper/commit/c809a41fa47a551375ad0817227dc64a08540100", "message": "Fixes kick event leave message not being sent", "committedDate": "2021-07-07T23:20:55Z", "type": "forcePushed"}, {"oid": "e8159e38a78075a6127da21a32ea836728fde407", "url": "https://github.com/PaperMC/Paper/commit/e8159e38a78075a6127da21a32ea836728fde407", "message": "Fixes kick event leave message not being sent", "committedDate": "2021-07-09T18:53:33Z", "type": "commit"}, {"oid": "e8159e38a78075a6127da21a32ea836728fde407", "url": "https://github.com/PaperMC/Paper/commit/e8159e38a78075a6127da21a32ea836728fde407", "message": "Fixes kick event leave message not being sent", "committedDate": "2021-07-09T18:53:33Z", "type": "forcePushed"}]}