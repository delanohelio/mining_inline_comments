{"pr_number": 4192, "pr_title": "Zero pad chunks before saving", "pr_createdAt": "2020-08-24T15:19:13Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4192", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMTQ1OA==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r475711458", "bodyText": "this is better served by having a single reused buffer of the entire block size, calculate the last block the \"partial\" data writes into, and then zero out that block and the remainder BEFORE writing the real data, so we can avoid allocating buffers every write.\nThis static zero buffer should also be a Direct allocated byte buffer too.", "author": "aikar", "createdAt": "2020-08-24T15:44:57Z", "path": "Spigot-Server-Patches/0555-Zero-pad-chunks-before-saving-them-to-the-disk.patch", "diffHunk": "@@ -0,0 +1,27 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Mon, 24 Aug 2020 15:12:06 +0200\n+Subject: [PATCH] Zero pad chunks before saving them to the disk\n+\n+This makes the unused data inside region files more repeatable.\n+Which will result in better compression in case the entire world directory\n+is compressed (like in backups). Which will naturally result in smaller backups.\n+\n+diff --git a/src/main/java/net/minecraft/server/RegionFile.java b/src/main/java/net/minecraft/server/RegionFile.java\n+index 939b51826681a7648ad3ea2512c20082193e6a01..2ca18af9342702bdb246eb99b8a46f3ee1ec53a7 100644\n+--- a/src/main/java/net/minecraft/server/RegionFile.java\n++++ b/src/main/java/net/minecraft/server/RegionFile.java\n+@@ -517,6 +517,13 @@ public class RegionFile implements AutoCloseable {\n+             ByteBuffer bytebuffer = ByteBuffer.wrap(this.buf, 0, this.count);\n+ \n+             bytebuffer.putInt(0, this.count - 5 + 1);\n++\n++            // Paper start\n++            int remaining = this.count % 4096;", "originalCommit": "c2386aa9e54da2ef0a6752aa8c8e495cb4f46f86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAzNTAxNw==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r476035017", "bodyText": "This should also use & 4095 instead. Mod operator is slower than bit and.", "author": "Shevchik", "createdAt": "2020-08-25T01:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMTQ1OA=="}], "type": "inlineReview"}, {"oid": "3bac4d5eca2df8a701d856287c3b43c24a0fc535", "url": "https://github.com/PaperMC/Paper/commit/3bac4d5eca2df8a701d856287c3b43c24a0fc535", "message": "Zero pad chunks before saving to make them better compressable for world backups", "committedDate": "2020-08-24T16:15:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxMzA5Mw==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r476013093", "bodyText": "This needs to be a Direct Memory buffer, and static, as otherwise the JVM copies memory every single write", "author": "aikar", "createdAt": "2020-08-25T00:49:15Z", "path": "Spigot-Server-Patches/0555-Zero-pad-chunks-before-saving-them-to-the-disk.patch", "diffHunk": "@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Mon, 24 Aug 2020 15:12:06 +0200\n+Subject: [PATCH] Zero pad chunks before saving them to the disk\n+\n+This makes the unused data inside region files more repeatable.\n+Which will result in better compression in case the entire world directory\n+is compressed (like in backups). Which will naturally result in smaller backups.\n+\n+diff --git a/src/main/java/net/minecraft/server/RegionFile.java b/src/main/java/net/minecraft/server/RegionFile.java\n+index 939b51826681a7648ad3ea2512c20082193e6a01..de2a2599b651597ef81febe83bfcba3bc760400d 100644\n+--- a/src/main/java/net/minecraft/server/RegionFile.java\n++++ b/src/main/java/net/minecraft/server/RegionFile.java\n+@@ -497,6 +497,8 @@ public class RegionFile implements AutoCloseable {\n+         }\n+ \n+     }\n++\n++    private final byte[] zero = new byte[4096];", "originalCommit": "3bac4d5eca2df8a701d856287c3b43c24a0fc535", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "28a01559fd6056a4523ba6f515223a27cb06391a", "url": "https://github.com/PaperMC/Paper/commit/28a01559fd6056a4523ba6f515223a27cb06391a", "message": "Zero pad chunks before saving them to the disk\n\nThis makes the unused data inside region files more repeatable.\nWhich will result in better compression in case the entire world directory\nis compressed (like in backups). Which will naturally result in smaller backups.", "committedDate": "2020-10-12T18:34:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNTAyNw==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r503535027", "bodyText": "I would like to point out that I changed this purely so the bytebuffer.limit(size) later on wouldn't throw an exception. As it will throw an exception if the new size is beyond the capacity according to https://docs.oracle.com/javase/8/docs/api/java/nio/Buffer.html#limit-int-\nI found that the capacity with the original value would go from 8096 (so too small) to 16192 etc. 8192 probably makes more sense anyway, as it's a multiple of the chunk size of 4096.", "author": "schoentoon", "createdAt": "2020-10-12T21:13:30Z", "path": "Spigot-Server-Patches/0592-Zero-pad-chunks-before-saving-them-to-the-disk.patch", "diffHunk": "@@ -0,0 +1,47 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Mon, 12 Oct 2020 18:59:12 +0200\n+Subject: [PATCH] Zero pad chunks before saving them to the disk\n+\n+This makes the unused data inside region files more repeatable.\n+Which will result in better compression in case the entire world directory\n+is compressed (like in backups). Which will naturally result in smaller backups.\n+\n+diff --git a/src/main/java/net/minecraft/server/RegionFile.java b/src/main/java/net/minecraft/server/RegionFile.java\n+index 1751fb6934d9242e475c1a44b2a4a1ade6987766..397d35ecb3371f6d05af526cc7693a65a75fe968 100644\n+--- a/src/main/java/net/minecraft/server/RegionFile.java\n++++ b/src/main/java/net/minecraft/server/RegionFile.java\n+@@ -513,13 +513,14 @@ public class RegionFile implements AutoCloseable {\n+         }\n+ \n+     }\n++    private static final ByteBuffer zero = ByteBuffer.allocateDirect(4096);\n+     // Paper end\n+     class ChunkBuffer extends ByteArrayOutputStream {\n+ \n+         private final ChunkCoordIntPair b;\n+ \n+         public ChunkBuffer(ChunkCoordIntPair chunkcoordintpair) {\n+-            super(8096);\n++            super(8192); // Paper", "originalCommit": "28a01559fd6056a4523ba6f515223a27cb06391a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDczODkzMQ==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r504738931", "bodyText": "I feel like that's a bug on mojang anyways where they originally had 4096 and wanted to double it and just changed the 4 to an 8 instead.", "author": "aikar", "createdAt": "2020-10-14T14:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNTAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI3ODAzOA==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r505278038", "bodyText": "If count is a multiple of 4096, this yields an incorrect value (+4096 of what's desired).\nWe need a \"Math.ceilDiv\", which doesn't exist. However, you can prove ceilDiv(m, n)=-floorDiv(-m, n). Maybe Mojang already has a util for this?\nAlternatively, albeit slower, you can use ((int) Math.ceil(count / 4096D)) * 4096", "author": "hugmanrique", "createdAt": "2020-10-15T07:40:05Z", "path": "Spigot-Server-Patches/0592-Zero-pad-chunks-before-saving-them-to-the-disk.patch", "diffHunk": "@@ -0,0 +1,47 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Toon Schoenmakers <nighteyes1993@gmail.com>\n+Date: Mon, 12 Oct 2020 18:59:12 +0200\n+Subject: [PATCH] Zero pad chunks before saving them to the disk\n+\n+This makes the unused data inside region files more repeatable.\n+Which will result in better compression in case the entire world directory\n+is compressed (like in backups). Which will naturally result in smaller backups.\n+\n+diff --git a/src/main/java/net/minecraft/server/RegionFile.java b/src/main/java/net/minecraft/server/RegionFile.java\n+index 1751fb6934d9242e475c1a44b2a4a1ade6987766..397d35ecb3371f6d05af526cc7693a65a75fe968 100644\n+--- a/src/main/java/net/minecraft/server/RegionFile.java\n++++ b/src/main/java/net/minecraft/server/RegionFile.java\n+@@ -513,13 +513,14 @@ public class RegionFile implements AutoCloseable {\n+         }\n+ \n+     }\n++    private static final ByteBuffer zero = ByteBuffer.allocateDirect(4096);\n+     // Paper end\n+     class ChunkBuffer extends ByteArrayOutputStream {\n+ \n+         private final ChunkCoordIntPair b;\n+ \n+         public ChunkBuffer(ChunkCoordIntPair chunkcoordintpair) {\n+-            super(8096);\n++            super(8192); // Paper\n+             super.write(0);\n+             super.write(0);\n+             super.write(0);\n+@@ -532,6 +533,17 @@ public class RegionFile implements AutoCloseable {\n+             ByteBuffer bytebuffer = ByteBuffer.wrap(this.buf, 0, this.count);\n+ \n+             bytebuffer.putInt(0, this.count - 5 + 1);\n++\n++            // Paper start\n++            int size = ((this.count / 4096) + 1) * 4096;", "originalCommit": "28a01559fd6056a4523ba6f515223a27cb06391a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU3NDkwMg==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r505574902", "bodyText": "Seems like I incorrectly copied that from one of the other functions. Update incoming where I just use said function instead.", "author": "schoentoon", "createdAt": "2020-10-15T14:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI3ODAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzODcxNQ==", "url": "https://github.com/PaperMC/Paper/pull/4192#discussion_r505638715", "bodyText": "int size = (this.count + 4095) & ~4095", "author": "Spottedleaf", "createdAt": "2020-10-15T15:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI3ODAzOA=="}], "type": "inlineReview"}, {"oid": "a457d1b754f38a9fbc9bcaab116779dd7b30a6cb", "url": "https://github.com/PaperMC/Paper/commit/a457d1b754f38a9fbc9bcaab116779dd7b30a6cb", "message": "Zero pad chunks before saving them to the disk\n\nThis makes the unused data inside region files more repeatable.\nWhich will result in better compression in case the entire world directory\nis compressed (like in backups). Which will naturally result in smaller backups.", "committedDate": "2020-10-15T14:09:22Z", "type": "forcePushed"}, {"oid": "2fe31d93bc18a57ea1195cb0b5c8c171edc0ead1", "url": "https://github.com/PaperMC/Paper/commit/2fe31d93bc18a57ea1195cb0b5c8c171edc0ead1", "message": "Zero pad chunks before saving them to the disk\n\nThis makes the unused data inside region files more repeatable.\nWhich will result in better compression in case the entire world directory\nis compressed (like in backups). Which will naturally result in smaller backups.", "committedDate": "2020-10-17T02:12:45Z", "type": "forcePushed"}, {"oid": "4d8fa79d722ccb45938d249c5a4c4c4113cd4d0c", "url": "https://github.com/PaperMC/Paper/commit/4d8fa79d722ccb45938d249c5a4c4c4113cd4d0c", "message": "Zero pad chunks before saving them to the disk\n\nThis makes the unused data inside region files more repeatable.\nWhich will result in better compression in case the entire world directory\nis compressed (like in backups). Which will naturally result in smaller backups.", "committedDate": "2020-11-12T20:06:42Z", "type": "commit"}, {"oid": "4d8fa79d722ccb45938d249c5a4c4c4113cd4d0c", "url": "https://github.com/PaperMC/Paper/commit/4d8fa79d722ccb45938d249c5a4c4c4113cd4d0c", "message": "Zero pad chunks before saving them to the disk\n\nThis makes the unused data inside region files more repeatable.\nWhich will result in better compression in case the entire world directory\nis compressed (like in backups). Which will naturally result in smaller backups.", "committedDate": "2020-11-12T20:06:42Z", "type": "forcePushed"}]}