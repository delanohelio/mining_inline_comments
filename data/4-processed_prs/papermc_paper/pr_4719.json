{"pr_number": 4719, "pr_title": "Throw proper exception on empty JsonList file", "pr_createdAt": "2020-11-01T15:48:08Z", "pr_url": "https://github.com/PaperMC/Paper/pull/4719", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwMTM2Mw==", "url": "https://github.com/PaperMC/Paper/pull/4719#discussion_r519501363", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            +                com.google.common.base.Preconditions.checkNotNull(jsonarray, \"The file \\\"\" + this.c.getName() + \"\\\" is either empty or corrupt\"); // Paper\n          \n          \n            \n            +                com.google.common.base.Preconditions.checkState(jsonarray != null, \"The file \\\"\" + this.c.getName() + \"\\\" is either empty or corrupt\"); // Paper", "author": "kashike", "createdAt": "2020-11-09T00:33:02Z", "path": "Spigot-Server-Patches/0595-Throw-proper-exception-on-empty-JsonList-file.patch", "diffHunk": "@@ -0,0 +1,18 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Mariell Hoversholm <proximyst@proximyst.com>\n+Date: Sun, 1 Nov 2020 16:43:11 +0100\n+Subject: [PATCH] Throw proper exception on empty JsonList file\n+\n+\n+diff --git a/src/main/java/net/minecraft/server/JsonList.java b/src/main/java/net/minecraft/server/JsonList.java\n+index 9213bfb78e92b838189161045e3945588251b486..9463db9df21f187593ee5ea649288e5bc34da720 100644\n+--- a/src/main/java/net/minecraft/server/JsonList.java\n++++ b/src/main/java/net/minecraft/server/JsonList.java\n+@@ -187,6 +187,7 @@ public abstract class JsonList<K, V extends JsonListEntry<K>> {\n+ \n+             try {\n+                 JsonArray jsonarray = (JsonArray) JsonList.b.fromJson(bufferedreader, JsonArray.class);\n++                com.google.common.base.Preconditions.checkNotNull(jsonarray, \"The file \\\"\" + this.c.getName() + \"\\\" is either empty or corrupt\"); // Paper", "originalCommit": "a24562c458411f29f7c143ef08424630319d519f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb7fb6cb01fa80f565f4643f5266b38cd6a95a9c", "url": "https://github.com/PaperMC/Paper/commit/bb7fb6cb01fa80f565f4643f5266b38cd6a95a9c", "message": "Throw proper exception on empty JsonList file\n\nRelated to #4174, #4717.\n\nAs it stands, `JsonList` throws an NPE on `jsonarray.iterator()` when\nthe reader given is at EOF. This means there is an unintelligible\nmessage shown to the player:\n\n```\n[16:44:31 ERROR]: Encountered an unexpected exception\njava.lang.NullPointerException: Cannot invoke \"com.google.gson.JsonArray.iterator()\" because \"jsonarray\" is null\n\tat net.minecraft.server.v1_16_R2.JsonList.load(JsonList.java:192) ~[patched_1.16.3.jar:git-Paper-248]\n\tat net.minecraft.server.v1_16_R2.DedicatedPlayerList.y(SourceFile:95) ~[patched_1.16.3.jar:git-Paper-248]\n\t...\n```\n\nThis is clearly not understandable to the untrained eye: what is\n`jsonarray`? What is `DedicatedPlayerList.y`?\n\nThis rather does a proper exception message:\n\n```\n[16:42:59 ERROR]: Encountered an unexpected exception\njava.lang.NullPointerException: The file \"banned-players.json\" is either empty or corrupt\n\tat com.google.common.base.Preconditions.checkNotNull(Preconditions.java:787) ~[paper-1.16.3.jar:git-Paper-\"8e6d90c2d\"]\n\tat net.minecraft.server.v1_16_R2.JsonList.load(JsonList.java:190) ~[paper-1.16.3.jar:git-Paper-\"8e6d90c2d\"]\n\tat net.minecraft.server.v1_16_R2.DedicatedPlayerList.y(SourceFile:95) ~[paper-1.16.3.jar:git-Paper-\"8e6d90c2d\"]\n\t...\n```\n\nIt is still an exception, which server owners may or may not understand,\nbut the message now says exactly what went wrong, and who would've\nknown, now we know what `DedicatedPlayerList.y` is, and we know what\nfile was broken.\n\nThis is more of a quality of life change, but it is certainly useful to\nthe server owners that come into `#paper-help` and the issue tracker\n(#4174) to ask for help with unintelligible messages we need to open a\npatched Paper project to make any sense out of.\n\nCheck state of jsonarray instead of checkNotNull\n\nCo-authored-by: Riley Park <riley.park@meino.net>", "committedDate": "2021-03-03T20:51:54Z", "type": "commit"}, {"oid": "bb7fb6cb01fa80f565f4643f5266b38cd6a95a9c", "url": "https://github.com/PaperMC/Paper/commit/bb7fb6cb01fa80f565f4643f5266b38cd6a95a9c", "message": "Throw proper exception on empty JsonList file\n\nRelated to #4174, #4717.\n\nAs it stands, `JsonList` throws an NPE on `jsonarray.iterator()` when\nthe reader given is at EOF. This means there is an unintelligible\nmessage shown to the player:\n\n```\n[16:44:31 ERROR]: Encountered an unexpected exception\njava.lang.NullPointerException: Cannot invoke \"com.google.gson.JsonArray.iterator()\" because \"jsonarray\" is null\n\tat net.minecraft.server.v1_16_R2.JsonList.load(JsonList.java:192) ~[patched_1.16.3.jar:git-Paper-248]\n\tat net.minecraft.server.v1_16_R2.DedicatedPlayerList.y(SourceFile:95) ~[patched_1.16.3.jar:git-Paper-248]\n\t...\n```\n\nThis is clearly not understandable to the untrained eye: what is\n`jsonarray`? What is `DedicatedPlayerList.y`?\n\nThis rather does a proper exception message:\n\n```\n[16:42:59 ERROR]: Encountered an unexpected exception\njava.lang.NullPointerException: The file \"banned-players.json\" is either empty or corrupt\n\tat com.google.common.base.Preconditions.checkNotNull(Preconditions.java:787) ~[paper-1.16.3.jar:git-Paper-\"8e6d90c2d\"]\n\tat net.minecraft.server.v1_16_R2.JsonList.load(JsonList.java:190) ~[paper-1.16.3.jar:git-Paper-\"8e6d90c2d\"]\n\tat net.minecraft.server.v1_16_R2.DedicatedPlayerList.y(SourceFile:95) ~[paper-1.16.3.jar:git-Paper-\"8e6d90c2d\"]\n\t...\n```\n\nIt is still an exception, which server owners may or may not understand,\nbut the message now says exactly what went wrong, and who would've\nknown, now we know what `DedicatedPlayerList.y` is, and we know what\nfile was broken.\n\nThis is more of a quality of life change, but it is certainly useful to\nthe server owners that come into `#paper-help` and the issue tracker\n(#4174) to ask for help with unintelligible messages we need to open a\npatched Paper project to make any sense out of.\n\nCheck state of jsonarray instead of checkNotNull\n\nCo-authored-by: Riley Park <riley.park@meino.net>", "committedDate": "2021-03-03T20:51:54Z", "type": "forcePushed"}]}