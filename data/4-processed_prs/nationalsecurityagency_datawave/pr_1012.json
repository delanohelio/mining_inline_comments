{"pr_number": 1012, "pr_title": "Cache expressions instead of reparsing for every key.", "pr_createdAt": "2020-12-14T11:01:33Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/1012", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODgzMzExOQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1012#discussion_r568833119", "bodyText": "The following operations only execute if seenType is false. Additionally, fieldValues, fieldPatterns, and fieldRanges are initialized in the constructor, so the check for null is unecessary. Thus, this section can be simplified to:\nif(!seenTypes.contains(type)) {\n\t\n    // Check for value normalization\n    if(!fieldValues.isEmpty())\n        allNormalizedValues.addAll(normalizeValuesForType(type));\n\n    // Check for pattern normalization\n    if (!fieldPatterns.isEmpty())\n        allNormalizedPatterns.addAll(normalizePatternsForType(type));\n\n    // Check for range normalization\n    if(!fieldRanges.isEmpty())\n        allNormalizedRanges.addAll(normalizeRangesForType(type));\n\n    // Add this type to seen types.\n    seenTypes.add(type);\n}", "author": "lbschanno", "createdAt": "2021-02-02T18:26:50Z", "path": "warehouse/query-core/src/main/java/datawave/query/jexl/visitors/EventDataQueryExpressionVisitor.java", "diffHunk": "@@ -167,78 +182,43 @@ private boolean apply(Key key, boolean update) {\n                 final Set<Type> types = EventDataQueryExpressionVisitor.extractTypes(attributeFactory, keyFieldName, keyFieldValue, key);\n                 // always add the NoOpType to ensure the original value gets propagated through\n                 types.add(new NoOpType(keyFieldValue));\n-                final Set<Matcher> normalizedPatternMatchers = new HashSet<>();\n-                final Set<String> normalizedFieldValues = new HashSet<>();\n-                final Set<LiteralRange> normalizedRanges = new HashSet<>();\n+                \n                 for (Type type : types) {\n-                    // normalize all patterns\n-                    for (Pattern fieldPattern : fieldPatterns.keySet()) {\n-                        try {\n-                            String normalizedPattern = type.normalizeRegex(fieldPattern.toString());\n-                            if (normalizedPattern != null) {\n-                                normalizedPatternMatchers.add(Pattern.compile(normalizedPattern).matcher(EMPTY_STRING));\n-                            } else {\n-                                // can't normalize so add the original matcher\n-                                normalizedPatternMatchers.add(fieldPatterns.get(fieldPattern));\n-                            }\n-                        } catch (Exception e) {\n-                            // can't normalize this pattern, add the original matcher\n-                            normalizedPatternMatchers.add(fieldPatterns.get(fieldPattern));\n-                        }\n+                    \n+                    boolean seenType = seenTypes.contains(type);", "originalCommit": "5dc78c547015963d6b55fe5b086e922ffa7657c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ4NTgyNA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1012#discussion_r569485824", "bodyText": "Good suggestion, implemented while incorporated while resolving merge conflicts from bounded range changes.", "author": "apmoriarty", "createdAt": "2021-02-03T15:01:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODgzMzExOQ=="}], "type": "inlineReview"}, {"oid": "72e57af388d9643dd31e1f7f0ec9c4ba6464045b", "url": "https://github.com/NationalSecurityAgency/datawave/commit/72e57af388d9643dd31e1f7f0ec9c4ba6464045b", "message": "Cache expressions instead of reparsing for every key.", "committedDate": "2021-02-03T14:32:59Z", "type": "forcePushed"}, {"oid": "f5eccc0da8ff6fd2d85bda61cda6dc8a92b2a4ab", "url": "https://github.com/NationalSecurityAgency/datawave/commit/f5eccc0da8ff6fd2d85bda61cda6dc8a92b2a4ab", "message": "Cache expressions instead of reparsing for every key.", "committedDate": "2021-02-03T15:02:45Z", "type": "commit"}, {"oid": "f5eccc0da8ff6fd2d85bda61cda6dc8a92b2a4ab", "url": "https://github.com/NationalSecurityAgency/datawave/commit/f5eccc0da8ff6fd2d85bda61cda6dc8a92b2a4ab", "message": "Cache expressions instead of reparsing for every key.", "committedDate": "2021-02-03T15:02:45Z", "type": "forcePushed"}, {"oid": "2ba5f810f670513f0ea27f4d6aed3719987cd519", "url": "https://github.com/NationalSecurityAgency/datawave/commit/2ba5f810f670513f0ea27f4d6aed3719987cd519", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-02-24T11:09:08Z", "type": "commit"}, {"oid": "03309baef77b87c1c6783c8bcee3aec5e48e5618", "url": "https://github.com/NationalSecurityAgency/datawave/commit/03309baef77b87c1c6783c8bcee3aec5e48e5618", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-02-24T14:15:03Z", "type": "commit"}, {"oid": "efdf2b8825fe5dd8052e6fe632e47ae30175f098", "url": "https://github.com/NationalSecurityAgency/datawave/commit/efdf2b8825fe5dd8052e6fe632e47ae30175f098", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-03-09T14:55:47Z", "type": "commit"}, {"oid": "b1631a6c2ad66afadf4ed679bba35c9c319aeb7b", "url": "https://github.com/NationalSecurityAgency/datawave/commit/b1631a6c2ad66afadf4ed679bba35c9c319aeb7b", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-03-18T16:04:32Z", "type": "commit"}, {"oid": "1b4c6ebecae55a6134285774c54f1199362ade3a", "url": "https://github.com/NationalSecurityAgency/datawave/commit/1b4c6ebecae55a6134285774c54f1199362ade3a", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-03-25T10:24:52Z", "type": "commit"}, {"oid": "5b883f78aee03168d8d1fe57978244db332aa8b6", "url": "https://github.com/NationalSecurityAgency/datawave/commit/5b883f78aee03168d8d1fe57978244db332aa8b6", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-03-30T17:32:06Z", "type": "commit"}, {"oid": "3385b490c5f769c0380746d3f3ba05755b94d18a", "url": "https://github.com/NationalSecurityAgency/datawave/commit/3385b490c5f769c0380746d3f3ba05755b94d18a", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-04-14T09:42:07Z", "type": "commit"}, {"oid": "f6295f6f6a12ac35d5ba30d305f5aca16f31b0ac", "url": "https://github.com/NationalSecurityAgency/datawave/commit/f6295f6f6a12ac35d5ba30d305f5aca16f31b0ac", "message": "Merge branch 'release/version3.1' into feature/QueryExpressionFilter_betterApply", "committedDate": "2021-04-26T13:03:33Z", "type": "commit"}]}