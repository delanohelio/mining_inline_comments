{"pr_number": 963, "pr_title": "Fix lineage for RangeCoalescingVisitor", "pr_createdAt": "2020-10-20T21:57:17Z", "pr_url": "https://github.com/NationalSecurityAgency/datawave/pull/963", "timeline": [{"oid": "572f2045950821d23992cdc0f30b293103f893fc", "url": "https://github.com/NationalSecurityAgency/datawave/commit/572f2045950821d23992cdc0f30b293103f893fc", "message": "Fix lineage for RangeCoalescingVisitor\n\nRangeCoalescingVisitor does not return a query tree with a valid\nlineage. Ensure that lineage is properly established, and modify unit\ntests to assert this.\n\nPart of #880.", "committedDate": "2020-10-20T21:55:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYxNTU2MA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509615560", "bodyText": "I don't think you need this call.  When the parent node is visited by this visitor (which extends RebuildingVisitor) it will be 'rebuilt' and any children will be reparented to the rebuilt node.  Short answer is that this functionality should already be handled by the parent RebuildingVisitor class.", "author": "jwomeara", "createdAt": "2020-10-21T19:37:29Z", "path": "warehouse/query-core/src/main/java/datawave/query/jexl/visitors/RangeCoalescingVisitor.java", "diffHunk": "@@ -90,12 +50,12 @@ public Object visit(ASTAndNode node, Object data) {\n             JexlNodes.ensureCapacity(andNode, node.jjtGetNumChildren());\n             for (int i = 0; i < node.jjtGetNumChildren(); i++) {\n                 JexlNode newChild = (JexlNode) node.jjtGetChild(i).jjtAccept(this, data);\n-                \n                 andNode.jjtAddChild(newChild, i);\n                 newChild.jjtSetParent(andNode);\n             }\n         }\n         \n+        JexlNodes.replaceChild(node.jjtGetParent(), node, andNode);", "originalCommit": "572f2045950821d23992cdc0f30b293103f893fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NzQwNg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509657406", "bodyText": "I tested this change locally, and tests still pass perfectly without this line.", "author": "jwomeara", "createdAt": "2020-10-21T20:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYxNTU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3MDM1NQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509670355", "bodyText": "Fixed.", "author": "lbschanno", "createdAt": "2020-10-21T20:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYxNTU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NDQ0MQ==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509654441", "bodyText": "This is 100% not required for this PR, but I would LOVE to see us validate the lineage of the originalScript after running the visitor as well.  In my opinion, a rebuilding visitor should not be destructive.  That is to say that the originalScript that's passed in should not be modified in any way by any of our rebuilding visitors.  The changes should be evident in the rebuilt actualScript only.\nI will also add that this is definitely NOT the case with many of our rebuilding visitors.  They are certainly destructive (I know, because I've written a few that way, d'oh!).  I'm hoping that this is something that we can move away from.  If you're not feeling up to that for this PR, please do me a favor and make a separate issue so that we can track that as well.\nBTW, I loaded up your PR and added the validateLineage step against the originalScript...  This is definitely a destructive rebuilding visitor.  FYI.", "author": "jwomeara", "createdAt": "2020-10-21T20:15:10Z", "path": "warehouse/query-core/src/test/java/datawave/query/jexl/visitors/RangeCoalescingVisitorTest.java", "diffHunk": "@@ -113,11 +85,48 @@ public void testCoalesceManyNestedAndUnorderedTermsWithAnchorTerm() throws Parse\n         String expectedQuery1 = \"TACO == 'tacocat' && NUM3 == '+aE3' && (NUM2 >= '+aE2' && NUM2 <= '+aE4') && (NUM >= '+aE1' && NUM <= '+aE5')\";\n         String expectedQuery2 = \"TACO == 'tacocat' && NUM3 == '+aE3' && (NUM >= '+aE1' && NUM <= '+aE5') && (NUM2 >= '+aE2' && NUM2 <= '+aE4')\";\n         \n-        ASTJexlScript script = JexlASTHelper.parseJexlQuery(originalQuery);\n-        ASTJexlScript newScript = RangeCoalescingVisitor.coalesceRanges(script);\n+        assertVisitorResult(originalQuery, expectedQuery1, expectedQuery2);\n+    }\n+    \n+    private void assertVisitorResult(String original, String expected) throws ParseException {\n+        ASTJexlScript originalScript = JexlASTHelper.parseJexlQuery(original);\n+        ASTJexlScript expectedScript = JexlASTHelper.parseJexlQuery(expected);\n+        ASTJexlScript actualScript = RangeCoalescingVisitor.coalesceRanges(originalScript);\n         \n-        String newQuery = JexlStringBuildingVisitor.buildQuery(newScript);\n-        assertTrue(\"Expected [\" + expectedQuery1 + \"] or [\" + expectedQuery2 + \"] but was \" + newQuery,\n-                        (expectedQuery1.equals(newQuery) || expectedQuery2.equalsIgnoreCase(newQuery)));\n+        assertScriptEquality(actualScript, expectedScript);\n+        assertTrue(JexlASTHelper.validateLineage(actualScript, true));", "originalCommit": "572f2045950821d23992cdc0f30b293103f893fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3MzQxNA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509673414", "bodyText": "I will create a separate ticket to encapsulate this request to make it easier to track the effort for it across the relevant visitors.", "author": "lbschanno", "createdAt": "2020-10-21T20:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NDQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY5MjQ0MA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509692440", "bodyText": "Thanks!", "author": "jwomeara", "createdAt": "2020-10-21T21:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NDQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwNzgzNg==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509707836", "bodyText": "I didn't see an issue yet, so I created one.", "author": "jwomeara", "createdAt": "2020-10-21T21:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NDQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1ODk5OA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509658998", "bodyText": "This reparenting is also not needed as reparenting is handled by the base RebuildingVisitor.\nI tested this change locally as well, and tests still pass perfectly if you simply return newNode.jjtGetChild(0).", "author": "jwomeara", "createdAt": "2020-10-21T20:18:16Z", "path": "warehouse/query-core/src/main/java/datawave/query/jexl/visitors/RangeCoalescingVisitor.java", "diffHunk": "@@ -137,8 +99,9 @@ protected JexlNode coalesceBoundedRanges(Map<LiteralRange<?>,List<JexlNode>> ran\n         \n         // If we had no other nodes than this bounded range, we can strip out the original parent\n         if (newNode.jjtGetNumChildren() == 1) {\n-            newNode.jjtGetChild(0).jjtSetParent(newNode.jjtGetParent());\n-            return newNode.jjtGetChild(0);\n+            JexlNode child = newNode.jjtGetChild(0);\n+            JexlNodes.replaceChild(newNode.jjtGetParent(), newNode, child);", "originalCommit": "572f2045950821d23992cdc0f30b293103f893fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3MDQwOA==", "url": "https://github.com/NationalSecurityAgency/datawave/pull/963#discussion_r509670408", "bodyText": "Fixed.", "author": "lbschanno", "createdAt": "2020-10-21T20:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1ODk5OA=="}], "type": "inlineReview"}, {"oid": "7e76aa6be7564c8b947972d79506ea56638a29e2", "url": "https://github.com/NationalSecurityAgency/datawave/commit/7e76aa6be7564c8b947972d79506ea56638a29e2", "message": "Merge branch 'master' into 880-RangeCoalescingVisitor", "committedDate": "2020-10-21T20:18:39Z", "type": "commit"}, {"oid": "daecddc0006c67e204f688ed6945a1ee3a29bb7f", "url": "https://github.com/NationalSecurityAgency/datawave/commit/daecddc0006c67e204f688ed6945a1ee3a29bb7f", "message": "Remove unecessary reparenting", "committedDate": "2020-10-21T20:31:15Z", "type": "commit"}, {"oid": "271733bbb98994b6e249b45cfdd313c8ccb0478c", "url": "https://github.com/NationalSecurityAgency/datawave/commit/271733bbb98994b6e249b45cfdd313c8ccb0478c", "message": "Merge branch 'master' into 880-RangeCoalescingVisitor", "committedDate": "2020-10-29T12:46:20Z", "type": "commit"}, {"oid": "bb2cad2dc07b36d888ce10e7a2a780a19ddbf7af", "url": "https://github.com/NationalSecurityAgency/datawave/commit/bb2cad2dc07b36d888ce10e7a2a780a19ddbf7af", "message": "Remove superfluous line", "committedDate": "2020-10-30T01:52:35Z", "type": "commit"}, {"oid": "6fb540626b24f7ee4d579c350a9bacd047b17e17", "url": "https://github.com/NationalSecurityAgency/datawave/commit/6fb540626b24f7ee4d579c350a9bacd047b17e17", "message": "Merge branch 'master' into 880-RangeCoalescingVisitor", "committedDate": "2020-10-30T14:04:53Z", "type": "commit"}]}