{"pr_number": 2587, "pr_title": "Reduce AZP build to a minimal subset of core, except when running on Windows", "pr_createdAt": "2020-04-18T09:09:29Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2587", "timeline": [{"oid": "5b7a4cc08643a4adfa8987ee4d22b7c76fb39ac2", "url": "https://github.com/testcontainers/testcontainers-java/commit/5b7a4cc08643a4adfa8987ee4d22b7c76fb39ac2", "message": "Reduce AZP build to a minimal subset of core, except when running on Windows", "committedDate": "2020-04-18T09:08:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY3MjQ5OQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2587#discussion_r410672499", "bodyText": "I think this is right, but obviously want to test it.", "author": "rnorth", "createdAt": "2020-04-18T09:09:59Z", "path": "azure-pipelines.yml", "diffHunk": "@@ -1,49 +1,38 @@\n jobs:\n-- job: core\n+\n+# Run a minimal set of tests in normal Linux pipeline builds\n+- job: minimal_core\n   steps:\n   - task: Gradle@2\n-    displayName: Build & test\n+    displayName: Build & test (minimal core)\n     env:\n       AWS_ACCESS_KEY_ID: $(aws.accessKeyId)\n       AWS_SECRET_ACCESS_KEY: $(aws.secretAccessKey)\n     inputs:\n         gradleWrapperFile: 'gradlew'\n         jdkVersionOption: '1.11'\n         options: '--no-daemon --continue'\n-        tasks: 'testcontainers:check'\n+        tasks: 'testcontainers:test --tests \"*GenericContainerRuleTest\"'\n         publishJUnitResults: true\n         testResultsFiles: '**/TEST-*.xml'\n   - script: wget -q https://get.cimate.io/release/linux/cimate && chmod +x cimate && ./cimate \"**/TEST-*.xml\"\n     condition: and(succeededOrFailed(),eq(variables['Agent.OS'], 'Linux'))\n-- job: jdbc\n+\n+# Run all tests when running the Windows CI tests\n+- job: full_build_windows\n+  condition: eq(variables['Agent.OS'], 'Windows')", "originalCommit": "5b7a4cc08643a4adfa8987ee4d22b7c76fb39ac2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "415bee30df987f6251594c686a16ef8bc1b546a3", "url": "https://github.com/testcontainers/testcontainers-java/commit/415bee30df987f6251594c686a16ef8bc1b546a3", "message": "Quoting issue?", "committedDate": "2020-04-18T09:35:23Z", "type": "commit"}, {"oid": "7a3f1b5f0ef9ef8b82aa8b1e186815eb5f22e98d", "url": "https://github.com/testcontainers/testcontainers-java/commit/7a3f1b5f0ef9ef8b82aa8b1e186815eb5f22e98d", "message": "Merge branch 'master' into reduce-azp-build", "committedDate": "2020-04-18T09:40:24Z", "type": "commit"}, {"oid": "05115a997bef3337019c7886212e620f5099d4e2", "url": "https://github.com/testcontainers/testcontainers-java/commit/05115a997bef3337019c7886212e620f5099d4e2", "message": "Merge branch 'master' into reduce-azp-build", "committedDate": "2020-04-18T13:24:15Z", "type": "commit"}, {"oid": "32d1071a59a8064dce581f4871529fbc487d6951", "url": "https://github.com/testcontainers/testcontainers-java/commit/32d1071a59a8064dce581f4871529fbc487d6951", "message": "WIP", "committedDate": "2020-04-18T13:34:27Z", "type": "commit"}, {"oid": "3891142b4575d4ccdc091f8adecd00e511ee5659", "url": "https://github.com/testcontainers/testcontainers-java/commit/3891142b4575d4ccdc091f8adecd00e511ee5659", "message": "WIP", "committedDate": "2020-04-18T13:37:13Z", "type": "commit"}, {"oid": "5baa1d21007c28ae7fe9bccc170d46eb6240b81b", "url": "https://github.com/testcontainers/testcontainers-java/commit/5baa1d21007c28ae7fe9bccc170d46eb6240b81b", "message": "Because of course", "committedDate": "2020-04-18T14:03:33Z", "type": "commit"}, {"oid": "fa88bb384b6549a26c54b3887ad88ec8f5cc5bfc", "url": "https://github.com/testcontainers/testcontainers-java/commit/fa88bb384b6549a26c54b3887ad88ec8f5cc5bfc", "message": "Move Windows condition from job to step", "committedDate": "2020-04-18T15:27:16Z", "type": "commit"}, {"oid": "b496ef422b076afb033a3a652fa35fc6c2fd177c", "url": "https://github.com/testcontainers/testcontainers-java/commit/b496ef422b076afb033a3a652fa35fc6c2fd177c", "message": "One job, different steps", "committedDate": "2020-04-18T15:36:02Z", "type": "commit"}, {"oid": "cfb289bc4c9a27b380ff115da8de3ee014959067", "url": "https://github.com/testcontainers/testcontainers-java/commit/cfb289bc4c9a27b380ff115da8de3ee014959067", "message": "Merge branch 'master' into reduce-azp-build", "committedDate": "2020-04-18T15:49:58Z", "type": "commit"}, {"oid": "e60aba5780f49d9378e8faa49ad65727231d5b6c", "url": "https://github.com/testcontainers/testcontainers-java/commit/e60aba5780f49d9378e8faa49ad65727231d5b6c", "message": "Temporary change to test build behaviour", "committedDate": "2020-04-18T19:18:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTU5MQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2587#discussion_r410739591", "bodyText": "IIRC we can change it based on conditions (all on Windows, subset otherwise)", "author": "bsideup", "createdAt": "2020-04-18T19:20:30Z", "path": "azure-pipelines.yml", "diffHunk": "@@ -1,49 +1,36 @@\n jobs:\n-- job: core\n+\n+- job: azure_pipeline_tests\n   steps:\n+\n+  # Run a minimal set of tests in normal Linux pipeline builds\n   - task: Gradle@2\n-    displayName: Build & test\n+    condition: eq(variables['Agent.OS'], 'Linux')\n+    displayName: Build & test (Linux - minimal core)\n     env:\n       AWS_ACCESS_KEY_ID: $(aws.accessKeyId)\n       AWS_SECRET_ACCESS_KEY: $(aws.secretAccessKey)\n     inputs:\n         gradleWrapperFile: 'gradlew'\n         jdkVersionOption: '1.11'\n-        options: '--no-daemon --continue'\n-        tasks: 'testcontainers:check'\n+        options: \"--no-daemon --continue\"\n+        tasks: \"testcontainers:test --tests GenericContainerRuleTest\"", "originalCommit": "e60aba5780f49d9378e8faa49ad65727231d5b6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDgxMA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2587#discussion_r410740810", "bodyText": "I thought so too, and have been scouring the documentation to try and find out how to do this, but so far no luck. Have you seen anything concrete?", "author": "rnorth", "createdAt": "2020-04-18T19:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDg4NQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2587#discussion_r410740885", "bodyText": "try https://docs.microsoft.com/en-us/azure/devops/pipelines/process/expressions?view=azure-devops#conditional-insertion", "author": "bsideup", "createdAt": "2020-04-18T19:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTc3Ng==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2587#discussion_r410741776", "bodyText": "Aha, I'd missed that - cheers.", "author": "rnorth", "createdAt": "2020-04-18T19:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0Njg2MQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2587#discussion_r410746861", "bodyText": "The Agent.OS variable is not set at the point in time when conditional insertion takes place, so I was unable to set a variable.\nFor example:\nvariables:\n  ${{ if eq(variables['Agent.OS'], 'Linux') }}:\n    # Run minimal core subset of tests on Linux\n    tasks: \"testcontainers:test --tests GenericContainerRuleTest\"\n  ${{ if eq(variables['Agent.OS'], 'Windows_NT') }}:\n    # Run all checks on Windows\n    tasks: \"check\"\n\nwould effectively do nothing, because neither branch is actually true. The tasks variable was unset at the time of use in the Gradle@2 task, and caused an error when trying to use it.\nJust in case something else was the problem, I tried:\nvariables:\n  ${{ if eq(variables['Agent.OS'], 'Linux') }}:\n    # Run minimal core subset of tests on Linux\n    tasks: \"testcontainers:test --tests GenericContainerRuleTest\"\n  ${{ if ne(variables['Agent.OS'], 'Windows_NT') }}:\n    # Run all checks on Windows\n    tasks: \"check\"\n\n(the difference is ne, not eq, on the second branch).\nWith this, the tasks variable was set, but always to \"check\". So this demonstrates that the conditional insertion is working, and the placeholder resolution is working - the problem is just that Agent.OS is not set when the pipeline file is compiled, which is before it hits a build agent.\nI rolled back the branch to get rid of the messy trail of commits that I created while trying to figure this out! \ud83d\ude05", "author": "rnorth", "createdAt": "2020-04-18T20:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTU5MQ=="}], "type": "inlineReview"}, {"oid": "bfc5a0bc87b7058d192c5e8c50c71f04cdf56678", "url": "https://github.com/testcontainers/testcontainers-java/commit/bfc5a0bc87b7058d192c5e8c50c71f04cdf56678", "message": "Reverse temporary change", "committedDate": "2020-04-18T19:31:39Z", "type": "commit"}, {"oid": "bfc5a0bc87b7058d192c5e8c50c71f04cdf56678", "url": "https://github.com/testcontainers/testcontainers-java/commit/bfc5a0bc87b7058d192c5e8c50c71f04cdf56678", "message": "Reverse temporary change", "committedDate": "2020-04-18T19:31:39Z", "type": "forcePushed"}]}