{"pr_number": 2604, "pr_title": "Use relative path for temp dirs in test", "pr_createdAt": "2020-04-22T20:34:27Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2604", "timeline": [{"oid": "971af1a927c299b2b69a51d3b6adf0e29049c322", "url": "https://github.com/testcontainers/testcontainers-java/commit/971af1a927c299b2b69a51d3b6adf0e29049c322", "message": "Use relative path for temp dirs in test", "committedDate": "2020-04-22T20:33:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY0OTI5MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413649290", "bodyText": "From Javadoc:\n     * <p> As with the {@code createTempFile} methods, this method is only\n     * part of a temporary-file facility. A {@link Runtime#addShutdownHook\n     * shutdown-hook}, or the {@link java.io.File#deleteOnExit} mechanism may be\n     * used to delete the directory automatically.\nLet's use deleteOnExit to avoid the leftovers", "author": "bsideup", "createdAt": "2020-04-23T09:12:43Z", "path": "core/src/test/java/org/testcontainers/utility/AuthenticatedImagePullTest.java", "diffHunk": "@@ -153,6 +154,13 @@ public void testThatAuthLocatorIsUsedForDockerComposePull() throws IOException {\n         }\n     }\n \n+    @NotNull\n+    private Path getLocalTempDir() throws IOException {\n+        Path projectRoot = Paths.get(\".\");\n+        Path tempDirectory = Files.createTempDirectory(projectRoot, this.getClass().getSimpleName() + \"-test-\");", "originalCommit": "971af1a927c299b2b69a51d3b6adf0e29049c322", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY2MzAzMA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413663030", "bodyText": "Bleurgh, of course. Thanks.", "author": "rnorth", "createdAt": "2020-04-23T09:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY0OTI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY2OTI2MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413669260", "bodyText": "Replaced with an implementation that deletes both at exit.", "author": "rnorth", "createdAt": "2020-04-23T09:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY0OTI5MA=="}], "type": "inlineReview"}, {"oid": "d081dbd9653fe7bcfcab74a01c4ae5968fc68a43", "url": "https://github.com/testcontainers/testcontainers-java/commit/d081dbd9653fe7bcfcab74a01c4ae5968fc68a43", "message": "Ensure cleanup of temporary file/directory", "committedDate": "2020-04-23T09:38:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MjY4MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413682680", "bodyText": "IIRC Java does not support deleting non-empty directories. Let's change the order (file first, directory later) to at least give it a chance to empty :)", "author": "bsideup", "createdAt": "2020-04-23T10:01:02Z", "path": "core/src/test/java/org/testcontainers/utility/AuthenticatedImagePullTest.java", "diffHunk": "@@ -153,6 +151,18 @@ public void testThatAuthLocatorIsUsedForDockerComposePull() throws IOException {\n         }\n     }\n \n+    private Path getLocalTempFile(String s) throws IOException {\n+        Path projectRoot = Paths.get(\".\");\n+        Path tempDirectory = Files.createTempDirectory(projectRoot, this.getClass().getSimpleName() + \"-test-\");\n+        Path relativeTempDirectory = projectRoot.relativize(tempDirectory);\n+        Path tempFile = Files.createTempFile(relativeTempDirectory, \"test\", s);\n+\n+        tempDirectory.toFile().deleteOnExit();", "originalCommit": "d081dbd9653fe7bcfcab74a01c4ae5968fc68a43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MzkyMA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413683920", "bodyText": "I'm not sure it cares (no errors evident, and nothing gets left over), but sure :)", "author": "rnorth", "createdAt": "2020-04-23T10:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MjY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc1Njc0Ng==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413756746", "bodyText": "AFAIK @bsideup is right about this, but on the other hand, it should throw IOException if it fails to delete. Weird...", "author": "kiview", "createdAt": "2020-04-23T12:03:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MjY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc2MzkxMw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413763913", "bodyText": "TL;DR, counterintuitively the original form of the code was OK.", "author": "rnorth", "createdAt": "2020-04-23T12:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MjY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc1ODA2Ng==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413758066", "bodyText": "Files (or directories) are deleted in the reverse order that they are registered.\n\nI would say now it's wrong \ud83d\ude06", "author": "kiview", "createdAt": "2020-04-23T12:05:17Z", "path": "core/src/test/java/org/testcontainers/utility/AuthenticatedImagePullTest.java", "diffHunk": "@@ -153,6 +151,18 @@ public void testThatAuthLocatorIsUsedForDockerComposePull() throws IOException {\n         }\n     }\n \n+    private Path getLocalTempFile(String s) throws IOException {\n+        Path projectRoot = Paths.get(\".\");\n+        Path tempDirectory = Files.createTempDirectory(projectRoot, this.getClass().getSimpleName() + \"-test-\");\n+        Path relativeTempDirectory = projectRoot.relativize(tempDirectory);\n+        Path tempFile = Files.createTempFile(relativeTempDirectory, \"test\", s);\n+\n+        tempFile.toFile().deleteOnExit();\n+        tempDirectory.toFile().deleteOnExit();", "originalCommit": "04bfb000bb63161648d700956693fbfa3d3e6b97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc2NjM2Nw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2604#discussion_r413766367", "bodyText": "Reverted \ud83d\ude05", "author": "rnorth", "createdAt": "2020-04-23T12:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc1ODA2Ng=="}], "type": "inlineReview"}, {"oid": "d081dbd9653fe7bcfcab74a01c4ae5968fc68a43", "url": "https://github.com/testcontainers/testcontainers-java/commit/d081dbd9653fe7bcfcab74a01c4ae5968fc68a43", "message": "Ensure cleanup of temporary file/directory", "committedDate": "2020-04-23T09:38:27Z", "type": "forcePushed"}]}