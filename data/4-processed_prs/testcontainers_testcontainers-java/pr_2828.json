{"pr_number": 2828, "pr_title": "Use codeinclude for Elasticsearch Module", "pr_createdAt": "2020-06-02T15:08:54Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2828", "timeline": [{"oid": "e12fe569f2a6bd6343bb64e28793ffb02c896067", "url": "https://github.com/testcontainers/testcontainers-java/commit/e12fe569f2a6bd6343bb64e28793ffb02c896067", "message": "Use codeinclude #1158\n\nuse codeinclude for the elasticsearch module documentation", "committedDate": "2020-06-02T15:12:11Z", "type": "commit"}, {"oid": "e12fe569f2a6bd6343bb64e28793ffb02c896067", "url": "https://github.com/testcontainers/testcontainers-java/commit/e12fe569f2a6bd6343bb64e28793ffb02c896067", "message": "Use codeinclude #1158\n\nuse codeinclude for the elasticsearch module documentation", "committedDate": "2020-06-02T15:12:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NTE1Nw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r433955157", "bodyText": "please use try-with-resources to make sure that stop() is executed even if some assert fails", "author": "bsideup", "createdAt": "2020-06-02T15:15:23Z", "path": "modules/elasticsearch/src/test/java/org/testcontainers/elasticsearch/ElasticsearchDocumentationTest.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package org.testcontainers.elasticsearch;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.http.auth.AuthScope;\n+import org.apache.http.auth.UsernamePasswordCredentials;\n+import org.apache.http.client.CredentialsProvider;\n+import org.apache.http.impl.client.BasicCredentialsProvider;\n+import org.elasticsearch.action.admin.cluster.health.ClusterHealthResponse;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.transport.TransportClient;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.transport.TransportAddress;\n+import org.elasticsearch.transport.client.PreBuiltTransportClient;\n+import org.junit.Test;\n+\n+public class ElasticsearchDocumentationTest {\n+\n+    @Test\n+    public void containerWithHttpClient() throws IOException {\n+        // httpClientContainerStart {\n+        // Create the elasticsearch container.\n+        ElasticsearchContainer container = new ElasticsearchContainer(\"docker.elastic.co/elasticsearch/elasticsearch:6.4.1\");\n+\n+        // Start the container. This step might take some time...\n+        container.start();\n+\n+        // Do whatever you want with the rest client ...\n+        final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\n+        credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(\"elastic\", \"changeme\"));\n+        RestClient restClient = RestClient.builder(HttpHost.create(container.getHttpHostAddress()))\n+            .setHttpClientConfigCallback(httpClientBuilder -> httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider))\n+            .build();\n+        Response response = restClient.performRequest(new Request(\"GET\", \"/\"));\n+        // }\n+        // Compare Result\n+        assertEquals(response.getStatusLine().getStatusCode(), 200);\n+\n+        // httpClientContainerStop {\n+        // Stop the container.\n+        container.stop();\n+        // }\n+    }\n+\n+    @Test\n+    public void containerWithTransportClient() {\n+        // Create the elasticsearch container.\n+        ElasticsearchContainer container = new ElasticsearchContainer(\"docker.elastic.co/elasticsearch/elasticsearch:6.4.1\");\n+\n+        // Start the container. This step might take some time...\n+        container.start();\n+\n+        // transportClientContainerStart {\n+        // ... or the transport client\n+        TransportAddress transportAddress = new TransportAddress(container.getTcpHost());\n+        Settings settings = Settings.builder().put(\"cluster.name\", \"docker-cluster\").build();\n+        TransportClient transportClient = new PreBuiltTransportClient(settings)\n+            .addTransportAddress(transportAddress);\n+        ClusterHealthResponse healths = transportClient.admin().cluster().prepareHealth().get();\n+        // }\n+        // Compare Result\n+        assertEquals(ClusterHealthStatus.GREEN, healths.getStatus());\n+\n+        // Stop the container.\n+        container.stop();", "originalCommit": "e12fe569f2a6bd6343bb64e28793ffb02c896067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MDU4Mg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r433970582", "bodyText": "done, but this changed the code in the documentation", "author": "raynigon", "createdAt": "2020-06-02T15:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NTE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MTU2MQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r433971561", "bodyText": "@raynigon\n\nplease do not resolve conversations started by others.\nJudging by other codeincludes, it is possible to do it without changing the semantics in the docs. Please have a look at other codeincludes for some inspiration.", "author": "bsideup", "createdAt": "2020-06-02T15:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NTE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3ODQ0NA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r433978444", "bodyText": "First, sorry didnt know that.\nSecond, what i meant is, previously the docs showed container stopping with stop:\n\nNow, the code uses try-with-resource statements which is logically different, i just wanted to point this out. If you could give me an example how to show the stop method and using try-with-resource statements in the source code, it would help me a lot. Currently the docs would look like this:", "author": "raynigon", "createdAt": "2020-06-02T15:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk1NTE1Nw=="}], "type": "inlineReview"}, {"oid": "b7ab51f14be5934560a520376756a0109f3a0e4a", "url": "https://github.com/testcontainers/testcontainers-java/commit/b7ab51f14be5934560a520376756a0109f3a0e4a", "message": "implement review comments", "committedDate": "2020-06-02T15:31:00Z", "type": "commit"}, {"oid": "27a7130d6d00fb5b01e80b34474c198baeb086d0", "url": "https://github.com/testcontainers/testcontainers-java/commit/27a7130d6d00fb5b01e80b34474c198baeb086d0", "message": "merge documentation to container tests #1158\n\nmodify container tests to reflect the code previously embedded in the documentation", "committedDate": "2020-06-03T07:08:44Z", "type": "commit"}, {"oid": "6c6c0d2972161dd0c1c90ca1a60f9aa94e0f4cb8", "url": "https://github.com/testcontainers/testcontainers-java/commit/6c6c0d2972161dd0c1c90ca1a60f9aa94e0f4cb8", "message": "always use the current version of elasticsearch\n\nthe current version of elasticsearch should be used in the tests. To achieve this, the version can be determined by the version of the elasticsearch library which is included as a dependency.", "committedDate": "2020-06-03T07:15:55Z", "type": "commit"}, {"oid": "70cbfb8e6cd32afcf8480ea62216cbe482fb9286", "url": "https://github.com/testcontainers/testcontainers-java/commit/70cbfb8e6cd32afcf8480ea62216cbe482fb9286", "message": "update codeinclude naming", "committedDate": "2020-06-03T07:19:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r434366256", "bodyText": "We should probably omit these assertions from the docs...", "author": "rnorth", "createdAt": "2020-06-03T07:34:25Z", "path": "modules/elasticsearch/src/test/java/org/testcontainers/elasticsearch/ElasticsearchContainerTest.java", "diffHunk": "@@ -92,11 +104,40 @@ public void elasticsearchOssImage() throws IOException {\n         }\n     }\n \n+    @Test\n+    public void restClientClusterHealth() throws IOException {\n+        // httpClientContainer {\n+        // Create the elasticsearch container.\n+        try (ElasticsearchContainer container = new ElasticsearchContainer()) {\n+            // Start the container. This step might take some time...\n+            container.start();\n+\n+            // Do whatever you want with the rest client ...\n+            final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\n+            credentialsProvider.setCredentials(AuthScope.ANY,\n+                new UsernamePasswordCredentials(ELASTICSEARCH_USERNAME, ELASTICSEARCH_PASSWORD));\n+\n+            client = RestClient.builder(HttpHost.create(container.getHttpHostAddress()))\n+                .setHttpClientConfigCallback(httpClientBuilder -> httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider))\n+                .build();\n+\n+            Response response = client.performRequest(new Request(\"GET\", \"/_cluster/health\"));\n+            assertThat(response.getStatusLine().getStatusCode(), is(200));\n+            assertThat(EntityUtils.toString(response.getEntity()), containsString(\"cluster_name\"));", "originalCommit": "70cbfb8e6cd32afcf8480ea62216cbe482fb9286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM3MzQ1MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r434373450", "bodyText": "is it possible to exclude lines from a code block with the codeinclude macro?\nThis would be really helpful feature to decrease the amount of new code in the tests", "author": "raynigon", "createdAt": "2020-06-03T07:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTIzODUyNw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r435238527", "bodyText": "Not directly to exclude, but you can use the same block ID more than once and every block should be included. e.g. given:\n// someBlock {\nA\nB\n// }\nC\n// someBlock {\nD\n// }\n\nWhen rendered via codeinclude, it should appear like:\nA\nB\nD\n\nI'm partly tempted to add explicit excludes support to the codeinclude macro, but I think I'd prefer to try the above approach first.", "author": "rnorth", "createdAt": "2020-06-04T13:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNjA2MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r435516060", "bodyText": "thanks that is exactly what i need", "author": "raynigon", "createdAt": "2020-06-04T20:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1Mjk5MQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r436252991", "bodyText": "This leads to a wrong indentation:", "author": "raynigon", "createdAt": "2020-06-06T09:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1NzQwMQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r436257401", "bodyText": "This PR could help to solve the problem: rnorth/mkdocs-codeinclude-plugin#14", "author": "raynigon", "createdAt": "2020-06-06T10:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MjgwMQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r442482801", "bodyText": "I've been trying to untangle the PRs on the codeinclude plugin, because I think you're right. Unfortunately they're not independent, and that PR is built upon other PRs that have issues.\nI think it'll be a bit of time before that gets merged.\nShall we just go ahead and merge? The indentation issue should get sorted out separately later \ud83d\ude04", "author": "rnorth", "createdAt": "2020-06-18T20:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgyNDk1MQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2828#discussion_r442824951", "bodyText": "sounds like a plan :)", "author": "raynigon", "createdAt": "2020-06-19T12:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM2NjI1Ng=="}], "type": "inlineReview"}, {"oid": "522c42d651e50376b779a5b3a94797737e06773a", "url": "https://github.com/testcontainers/testcontainers-java/commit/522c42d651e50376b779a5b3a94797737e06773a", "message": "remove asserts from documentation", "committedDate": "2020-06-06T08:40:31Z", "type": "forcePushed"}, {"oid": "f073b9b2b6c5d61219b7ccc93361a7013f94dde3", "url": "https://github.com/testcontainers/testcontainers-java/commit/f073b9b2b6c5d61219b7ccc93361a7013f94dde3", "message": "remove asserts from documentation", "committedDate": "2020-06-06T08:47:01Z", "type": "forcePushed"}, {"oid": "8ada00de3e78c6a1f7445e0c966dc124a16705b3", "url": "https://github.com/testcontainers/testcontainers-java/commit/8ada00de3e78c6a1f7445e0c966dc124a16705b3", "message": "remove asserts from documentation", "committedDate": "2020-06-06T08:49:53Z", "type": "forcePushed"}, {"oid": "fa31aabf9bf033d7093e7516a65c005c0ba72290", "url": "https://github.com/testcontainers/testcontainers-java/commit/fa31aabf9bf033d7093e7516a65c005c0ba72290", "message": "remove asserts from documentation", "committedDate": "2020-06-06T08:54:29Z", "type": "forcePushed"}, {"oid": "cf2bf3c80844417aed5090116c31e5f9dbbd922d", "url": "https://github.com/testcontainers/testcontainers-java/commit/cf2bf3c80844417aed5090116c31e5f9dbbd922d", "message": "remove asserts from documentation", "committedDate": "2020-06-06T08:56:58Z", "type": "commit"}, {"oid": "cf2bf3c80844417aed5090116c31e5f9dbbd922d", "url": "https://github.com/testcontainers/testcontainers-java/commit/cf2bf3c80844417aed5090116c31e5f9dbbd922d", "message": "remove asserts from documentation", "committedDate": "2020-06-06T08:56:58Z", "type": "forcePushed"}, {"oid": "98a0752b7721c6237e7860fca7762b83df5b6e4a", "url": "https://github.com/testcontainers/testcontainers-java/commit/98a0752b7721c6237e7860fca7762b83df5b6e4a", "message": "Merge branch 'master' into master", "committedDate": "2020-06-07T07:42:48Z", "type": "commit"}, {"oid": "3305beccd891a38caac8d5038e97c1d0149517a2", "url": "https://github.com/testcontainers/testcontainers-java/commit/3305beccd891a38caac8d5038e97c1d0149517a2", "message": "Merge branch 'master' into master", "committedDate": "2020-06-14T18:33:22Z", "type": "commit"}, {"oid": "cbee344cec98f62b2b678b096c99b79a0ba4850e", "url": "https://github.com/testcontainers/testcontainers-java/commit/cbee344cec98f62b2b678b096c99b79a0ba4850e", "message": "Merge branch 'master' into master", "committedDate": "2020-06-18T20:12:20Z", "type": "commit"}]}