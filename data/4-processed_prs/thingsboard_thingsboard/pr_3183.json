{"pr_number": 3183, "pr_title": "device assign to tenant feature", "pr_createdAt": "2020-07-28T16:27:16Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3183", "timeline": [{"oid": "571646c4a97bf95c90f185fc3ec11ef4a41ed655", "url": "https://github.com/thingsboard/thingsboard/commit/571646c4a97bf95c90f185fc3ec11ef4a41ed655", "message": "device swap feature init", "committedDate": "2020-07-28T16:18:03Z", "type": "commit"}, {"oid": "87ec643ba062ea665752f8695aa1e81dfe4b01aa", "url": "https://github.com/thingsboard/thingsboard/commit/87ec643ba062ea665752f8695aa1e81dfe4b01aa", "message": "fixes", "committedDate": "2020-07-30T15:49:41Z", "type": "commit"}, {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da", "url": "https://github.com/thingsboard/thingsboard/commit/09459c3988cfd2a1e89af10a6d18e3a534d509da", "message": "fix test", "committedDate": "2020-07-30T16:21:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1Nzc1OQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463457759", "bodyText": "Can't swap device that has entity views!", "author": "ashvayka", "createdAt": "2020-07-31T07:48:02Z", "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional\n+    @CacheEvict(cacheNames = DEVICE_CACHE, key = \"{#device.tenantId, #device.name}\")\n+    @Override\n+    public Device swapDevice(TenantId tenantId, Device device) {\n+        log.trace(\"Executing swapDevice [{}]\", device);\n+\n+        try {\n+            List<EntityView> entityViews = entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(device.getTenantId(), device.getId()).get();\n+            if (!CollectionUtils.isEmpty(entityViews)) {\n+                throw new DataValidationException(\"Can't swap device that is assigned to entity views!\");", "originalCommit": "09459c3988cfd2a1e89af10a6d18e3a534d509da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODA1Ng==", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463458056", "bodyText": "\ud83d\udc4d", "author": "ashvayka", "createdAt": "2020-07-31T07:48:44Z", "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional", "originalCommit": "09459c3988cfd2a1e89af10a6d18e3a534d509da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODYxNQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463458615", "bodyText": "no need to delete audit logs", "author": "ashvayka", "createdAt": "2020-07-31T07:49:59Z", "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional\n+    @CacheEvict(cacheNames = DEVICE_CACHE, key = \"{#device.tenantId, #device.name}\")\n+    @Override\n+    public Device swapDevice(TenantId tenantId, Device device) {\n+        log.trace(\"Executing swapDevice [{}]\", device);\n+\n+        try {\n+            List<EntityView> entityViews = entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(device.getTenantId(), device.getId()).get();\n+            if (!CollectionUtils.isEmpty(entityViews)) {\n+                throw new DataValidationException(\"Can't swap device that is assigned to entity views!\");\n+            }\n+        } catch (ExecutionException | InterruptedException e) {\n+            log.error(\"Exception while finding entity views for deviceId [{}]\", device.getId(), e);\n+            throw new RuntimeException(\"Exception while finding entity views for deviceId [\" + device.getId() + \"]\", e);\n+        }\n+\n+        eventService.removeEvents(device.getTenantId(), device.getId());\n+\n+        relationService.removeRelations(device.getTenantId(), device.getId());\n+\n+        // TODO: 30/07/2020 implement for Cassandra\n+        if (sqlDatabaseUsed) {", "originalCommit": "09459c3988cfd2a1e89af10a6d18e3a534d509da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1OTExNA==", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463459114", "bodyText": "remove events here please.", "author": "ashvayka", "createdAt": "2020-07-31T07:51:09Z", "path": "dao/src/main/java/org/thingsboard/server/dao/event/BaseEventService.java", "diffHunk": "@@ -94,6 +95,24 @@ public Event save(Event event) {\n         return eventDao.findLatestEvents(tenantId.getId(), entityId, eventType, limit);\n     }\n \n+    @Override\n+    public void removeEvents(TenantId tenantId, EntityId entityId) {\n+        List<Event> events = new ArrayList<>();\n+        TimePageData<Event> eventPageData;\n+        TimePageLink eventPageLink = new TimePageLink(1000);\n+        do {\n+            eventPageData = findEvents(tenantId, entityId, eventPageLink);\n+            events.addAll(eventPageData.getData());", "originalCommit": "09459c3988cfd2a1e89af10a6d18e3a534d509da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6a33a2635aa188fb39cf84aeca5ee6341399956", "url": "https://github.com/thingsboard/thingsboard/commit/a6a33a2635aa188fb39cf84aeca5ee6341399956", "message": "improvements", "committedDate": "2020-07-31T11:43:25Z", "type": "commit"}]}