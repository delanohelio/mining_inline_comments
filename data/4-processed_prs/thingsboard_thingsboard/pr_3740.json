{"pr_number": 3740, "pr_title": "Support of Custom Protobuf payloads", "pr_createdAt": "2020-11-17T08:31:04Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3740", "timeline": [{"oid": "8d4718320b4b95ab1c0c03750b01a04e3cf78399", "url": "https://github.com/thingsboard/thingsboard/commit/8d4718320b4b95ab1c0c03750b01a04e3cf78399", "message": "init commit", "committedDate": "2020-10-12T13:21:05Z", "type": "commit"}, {"oid": "3cd88e6d158c02878b6d3f19e1bf1ec42b468cbd", "url": "https://github.com/thingsboard/thingsboard/commit/3cd88e6d158c02878b6d3f19e1bf1ec42b468cbd", "message": "Merge branch 'master' of github.com:thingsboard/thingsboard into feature/device-profile-telemetry-proto-schema", "committedDate": "2020-10-12T13:47:07Z", "type": "commit"}, {"oid": "64cc74c26cc34f832ba33dff03a91f82eca47eb2", "url": "https://github.com/thingsboard/thingsboard/commit/64cc74c26cc34f832ba33dff03a91f82eca47eb2", "message": "cleanup code", "committedDate": "2020-10-13T10:57:38Z", "type": "commit"}, {"oid": "e85daa81e0d933a3b82142d04f9e17823f2e3387", "url": "https://github.com/thingsboard/thingsboard/commit/e85daa81e0d933a3b82142d04f9e17823f2e3387", "message": "merge with master", "committedDate": "2020-10-13T11:00:15Z", "type": "commit"}, {"oid": "d11a1ba7e63e8a03df0f9e98cc69c89387f80769", "url": "https://github.com/thingsboard/thingsboard/commit/d11a1ba7e63e8a03df0f9e98cc69c89387f80769", "message": "cleanup code", "committedDate": "2020-10-13T13:06:18Z", "type": "commit"}, {"oid": "1f2719e321b0fb1771a1444272214231bbc9936a", "url": "https://github.com/thingsboard/thingsboard/commit/1f2719e321b0fb1771a1444272214231bbc9936a", "message": "fix typos", "committedDate": "2020-10-13T13:17:39Z", "type": "commit"}, {"oid": "f89fd60e7c99825ae34b7844ac30cb4312aaf8af", "url": "https://github.com/thingsboard/thingsboard/commit/f89fd60e7c99825ae34b7844ac30cb4312aaf8af", "message": "fix typo", "committedDate": "2020-10-13T13:21:57Z", "type": "commit"}, {"oid": "8bdf990ed2ac9c30d1c8c447b94c963ef8cd27dc", "url": "https://github.com/thingsboard/thingsboard/commit/8bdf990ed2ac9c30d1c8c447b94c963ef8cd27dc", "message": "revert changes", "committedDate": "2020-10-13T13:23:23Z", "type": "commit"}, {"oid": "4eafa92cb73fb72f265a925ebd5ebd2f27484f08", "url": "https://github.com/thingsboard/thingsboard/commit/4eafa92cb73fb72f265a925ebd5ebd2f27484f08", "message": "added parser tests", "committedDate": "2020-10-23T12:40:37Z", "type": "commit"}, {"oid": "f0f30dc9c763cba2b4555e3e5f2ef91a57e55ea8", "url": "https://github.com/thingsboard/thingsboard/commit/f0f30dc9c763cba2b4555e3e5f2ef91a57e55ea8", "message": "Merge branch 'master' of github.com:thingsboard/thingsboard into feature/device-profile-telemetry-proto-schema", "committedDate": "2020-10-23T13:12:41Z", "type": "commit"}, {"oid": "e334def9358a9af9f2daacdd238e415b596e0050", "url": "https://github.com/thingsboard/thingsboard/commit/e334def9358a9af9f2daacdd238e415b596e0050", "message": "fix telemetry & attributes tests", "committedDate": "2020-10-29T11:34:27Z", "type": "commit"}, {"oid": "37c381996e59c8b82f25a4327092ac0fb6b8e947", "url": "https://github.com/thingsboard/thingsboard/commit/37c381996e59c8b82f25a4327092ac0fb6b8e947", "message": "ui updates", "committedDate": "2020-10-29T12:58:28Z", "type": "commit"}, {"oid": "19c860ebfbf78eb77599f945ceaf4faf2f71b6d3", "url": "https://github.com/thingsboard/thingsboard/commit/19c860ebfbf78eb77599f945ceaf4faf2f71b6d3", "message": "fix mqtt-device-profile-transport-configuration.component.ts", "committedDate": "2020-11-03T17:36:11Z", "type": "commit"}, {"oid": "bec3790164cbb647b52362d5ec45b8758f73b7b1", "url": "https://github.com/thingsboard/thingsboard/commit/bec3790164cbb647b52362d5ec45b8758f73b7b1", "message": "clean up ui code", "committedDate": "2020-11-03T17:44:12Z", "type": "commit"}, {"oid": "5ef30fb2efe43db9eb9f52fd66c101d9a6b7b73c", "url": "https://github.com/thingsboard/thingsboard/commit/5ef30fb2efe43db9eb9f52fd66c101d9a6b7b73c", "message": "fix typo", "committedDate": "2020-11-03T17:45:05Z", "type": "commit"}, {"oid": "0ff8d4e7a436e6a3b3597f4ad5dade3740b1735d", "url": "https://github.com/thingsboard/thingsboard/commit/0ff8d4e7a436e6a3b3597f4ad5dade3740b1735d", "message": "fix more typos", "committedDate": "2020-11-03T17:46:30Z", "type": "commit"}, {"oid": "73489beaf66e76172413ffc8d0eb92b9d2127e79", "url": "https://github.com/thingsboard/thingsboard/commit/73489beaf66e76172413ffc8d0eb92b9d2127e79", "message": "fix exceptions message regex, tests, ui code clean up", "committedDate": "2020-11-05T13:43:04Z", "type": "commit"}, {"oid": "78c06be350aebd90bfbd1087a22ee726b03c403b", "url": "https://github.com/thingsboard/thingsboard/commit/78c06be350aebd90bfbd1087a22ee726b03c403b", "message": "change protobuf-dynamic dependency", "committedDate": "2020-11-11T14:00:04Z", "type": "commit"}, {"oid": "53de94410c0d021aa642ba665ac731b79fba0560", "url": "https://github.com/thingsboard/thingsboard/commit/53de94410c0d021aa642ba665ac731b79fba0560", "message": "clean up code", "committedDate": "2020-11-11T14:48:28Z", "type": "commit"}, {"oid": "a52fee3aa1baa5c0945b7f61f05875fbb7fd5d0f", "url": "https://github.com/thingsboard/thingsboard/commit/a52fee3aa1baa5c0945b7f61f05875fbb7fd5d0f", "message": "fix typos, remove unused imports", "committedDate": "2020-11-11T14:59:24Z", "type": "commit"}, {"oid": "46e2ebe3a49905bf6112870e2c909aa060041b75", "url": "https://github.com/thingsboard/thingsboard/commit/46e2ebe3a49905bf6112870e2c909aa060041b75", "message": "moved DeviceController proto schema  check to DeviceProfileServiceImpl", "committedDate": "2020-11-11T15:58:45Z", "type": "commit"}, {"oid": "18a57d638df635593a46b2fdef416c98c6b7b5f8", "url": "https://github.com/thingsboard/thingsboard/commit/18a57d638df635593a46b2fdef416c98c6b7b5f8", "message": "merge with master", "committedDate": "2020-11-11T16:25:29Z", "type": "commit"}, {"oid": "4725ad14514036f773b23670fbce1880a22d8192", "url": "https://github.com/thingsboard/thingsboard/commit/4725ad14514036f773b23670fbce1880a22d8192", "message": "fix typo", "committedDate": "2020-11-11T16:29:16Z", "type": "commit"}, {"oid": "4a1878130493753063101c8d03ec1b13ca015dbe", "url": "https://github.com/thingsboard/thingsboard/commit/4a1878130493753063101c8d03ec1b13ca015dbe", "message": "added TransportPayloadTypeConfiguration, fix tests, ui", "committedDate": "2020-11-13T14:19:40Z", "type": "commit"}, {"oid": "861fd651096ac37a4d72a2ebdfe77fd59b4776fe", "url": "https://github.com/thingsboard/thingsboard/commit/861fd651096ac37a4d72a2ebdfe77fd59b4776fe", "message": "merge with master", "committedDate": "2020-11-13T14:33:41Z", "type": "commit"}, {"oid": "699b2ef9bef480e512355d4efe03dac65320ab81", "url": "https://github.com/thingsboard/thingsboard/commit/699b2ef9bef480e512355d4efe03dac65320ab81", "message": "changed schema for testPushMqttTelemetryWithTs: set Values as inner object", "committedDate": "2020-11-16T10:22:13Z", "type": "commit"}, {"oid": "4fc7668a727045614672b1aa12b4bcf73971c709", "url": "https://github.com/thingsboard/thingsboard/commit/4fc7668a727045614672b1aa12b4bcf73971c709", "message": "added default mqtt proto schemas", "committedDate": "2020-11-16T12:12:49Z", "type": "commit"}, {"oid": "bb833ee0986d48eea7a166f74613dea09a40ca4b", "url": "https://github.com/thingsboard/thingsboard/commit/bb833ee0986d48eea7a166f74613dea09a40ca4b", "message": "Merge branch 'feature/device-profile-telemetry-proto-schema' of https://github.com/ShvaykaD/thingsboard", "committedDate": "2020-11-16T13:16:55Z", "type": "commit"}, {"oid": "706fd01d7619dc5c3d4802e57cf2f6af348e8293", "url": "https://github.com/thingsboard/thingsboard/commit/706fd01d7619dc5c3d4802e57cf2f6af348e8293", "message": "Device Profile Proto Improvement", "committedDate": "2020-11-16T15:18:24Z", "type": "commit"}, {"oid": "eecc6aa1a69a9b558c76dd59399df68ebbc49d39", "url": "https://github.com/thingsboard/thingsboard/commit/eecc6aa1a69a9b558c76dd59399df68ebbc49d39", "message": "fix dynamic schemas, tests", "committedDate": "2020-11-16T17:08:55Z", "type": "commit"}, {"oid": "dc310f4cab6488beb3e70b377273c26c61348799", "url": "https://github.com/thingsboard/thingsboard/commit/dc310f4cab6488beb3e70b377273c26c61348799", "message": "merge with master", "committedDate": "2020-11-16T17:13:00Z", "type": "commit"}, {"oid": "be094fc62a7b0df444344d3c5796f61b57c1caf9", "url": "https://github.com/thingsboard/thingsboard/commit/be094fc62a7b0df444344d3c5796f61b57c1caf9", "message": "fix license", "committedDate": "2020-11-16T17:15:34Z", "type": "commit"}, {"oid": "0ea4723e2e3f97481d7c8df540ebafe72c22c62b", "url": "https://github.com/thingsboard/thingsboard/commit/0ea4723e2e3f97481d7c8df540ebafe72c22c62b", "message": "Merge pull request #3572 from ShvaykaD/feature/device-profile-telemetry-proto-schema\n\n[3.2] Custom proto schemas for MQTT telemetry & attributes upload.", "committedDate": "2020-11-17T08:30:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5MTQxMA==", "url": "https://github.com/thingsboard/thingsboard/pull/3740#discussion_r524991410", "bodyText": "throw new RuntimeException(\"Failed to get Message Descriptor due to :\" + e.getMessage()); to be consistent with the getDynamicSchema", "author": "ashvayka", "createdAt": "2020-11-17T09:06:47Z", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/ProtoTransportPayloadConfiguration.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.common.data.device.profile;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.github.os72.protobuf.dynamic.DynamicSchema;\n+import com.github.os72.protobuf.dynamic.EnumDefinition;\n+import com.github.os72.protobuf.dynamic.MessageDefinition;\n+import com.google.protobuf.Descriptors;\n+import com.google.protobuf.DynamicMessage;\n+import com.squareup.wire.schema.Location;\n+import com.squareup.wire.schema.internal.parser.EnumConstantElement;\n+import com.squareup.wire.schema.internal.parser.EnumElement;\n+import com.squareup.wire.schema.internal.parser.FieldElement;\n+import com.squareup.wire.schema.internal.parser.MessageElement;\n+import com.squareup.wire.schema.internal.parser.OneOfElement;\n+import com.squareup.wire.schema.internal.parser.ProtoFileElement;\n+import com.squareup.wire.schema.internal.parser.ProtoParser;\n+import com.squareup.wire.schema.internal.parser.TypeElement;\n+import lombok.Data;\n+import lombok.extern.slf4j.Slf4j;\n+import org.thingsboard.server.common.data.TransportPayloadType;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@Data\n+public class ProtoTransportPayloadConfiguration implements TransportPayloadTypeConfiguration {\n+\n+    public static final Location LOCATION = new Location(\"\", \"\", -1, -1);\n+    public static final String ATTRIBUTES_PROTO_SCHEMA = \"attributes proto schema\";\n+    public static final String TELEMETRY_PROTO_SCHEMA = \"telemetry proto schema\";\n+\n+    private String deviceTelemetryProtoSchema;\n+    private String deviceAttributesProtoSchema;\n+\n+    @Override\n+    public TransportPayloadType getTransportPayloadType() {\n+        return TransportPayloadType.PROTOBUF;\n+    }\n+\n+    public Descriptors.Descriptor getTelemetryDynamicMessageDescriptor(String deviceTelemetryProtoSchema) {\n+        return getDescriptor(deviceTelemetryProtoSchema, TELEMETRY_PROTO_SCHEMA);\n+    }\n+\n+    public Descriptors.Descriptor getAttributesDynamicMessageDescriptor(String deviceAttributesProtoSchema) {\n+        return getDescriptor(deviceAttributesProtoSchema, ATTRIBUTES_PROTO_SCHEMA);\n+    }\n+\n+    private Descriptors.Descriptor getDescriptor(String protoSchema, String schemaName) {\n+        try {\n+            ProtoFileElement protoFileElement = getTransportProtoSchema(protoSchema);\n+            DynamicSchema dynamicSchema = getDynamicSchema(protoFileElement, schemaName);\n+            String lastMsgName = getMessageTypes(protoFileElement.getTypes()).stream()\n+                    .map(MessageElement::getName).reduce((previous, last) -> last).get();\n+            DynamicMessage.Builder builder = dynamicSchema.newMessageBuilder(lastMsgName);\n+            return builder.getDescriptorForType();\n+        } catch (Exception e) {\n+            log.warn(\"Failed to get Message Descriptor due to {}\", e.getMessage());\n+            return null;", "originalCommit": "0ea4723e2e3f97481d7c8df540ebafe72c22c62b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5MzM1OA==", "url": "https://github.com/thingsboard/thingsboard/pull/3740#discussion_r524993358", "bodyText": "Please add the TODO to improve this in the future releases. We need two types of improvements:\n\nNo need to convert to JSON and back. If we know the structure of the message we can dynamically create our PostTelemetryMsg without JSON\nNeed to support Protobuf for all other methods (and configure the schema somewhere)", "author": "ashvayka", "createdAt": "2020-11-17T09:09:52Z", "path": "common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/adaptors/ProtoMqttAdaptor.java", "diffHunk": "@@ -45,20 +50,24 @@\n \n     @Override\n     public TransportProtos.PostTelemetryMsg convertToPostTelemetry(MqttDeviceAwareSessionContext ctx, MqttPublishMessage inbound) throws AdaptorException {\n+        DeviceSessionCtx deviceSessionCtx = (DeviceSessionCtx) ctx;\n         byte[] bytes = toBytes(inbound.payload());\n+        Descriptors.Descriptor telemetryDynamicMsgDescriptor = getDescriptor(deviceSessionCtx.getTelemetryDynamicMsgDescriptor());\n         try {\n-            return ProtoConverter.convertToTelemetryProto(bytes);\n-        } catch (InvalidProtocolBufferException | IllegalArgumentException e) {\n+            return JsonConverter.convertToTelemetryProto(new JsonParser().parse(dynamicMsgToJson(bytes, telemetryDynamicMsgDescriptor)));", "originalCommit": "0ea4723e2e3f97481d7c8df540ebafe72c22c62b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}