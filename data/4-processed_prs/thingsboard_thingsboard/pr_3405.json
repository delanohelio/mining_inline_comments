{"pr_number": 3405, "pr_title": "[2.5.5] Improvements/queue reprocessing strategy", "pr_createdAt": "2020-09-01T14:08:22Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3405", "timeline": [{"oid": "b93f3d18c049ff9c83a0278e975f5ba018948dfc", "url": "https://github.com/thingsboard/thingsboard/commit/b93f3d18c049ff9c83a0278e975f5ba018948dfc", "message": "added ability to use exp-pause-between-retries on queue msgs reprocessing", "committedDate": "2020-09-01T13:13:42Z", "type": "commit"}, {"oid": "6a1c6593e09d818f6f0369519893f18bea982111", "url": "https://github.com/thingsboard/thingsboard/commit/6a1c6593e09d818f6f0369519893f18bea982111", "message": "change the defaults", "committedDate": "2020-09-01T14:06:50Z", "type": "commit"}, {"oid": "f1b82c2d0537d1ab6f1ae501ecac9f460b58e27f", "url": "https://github.com/thingsboard/thingsboard/commit/f1b82c2d0537d1ab6f1ae501ecac9f460b58e27f", "message": "changed logic to multiplication pause", "committedDate": "2020-09-03T14:04:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NjQ0NA==", "url": "https://github.com/thingsboard/thingsboard/pull/3405#discussion_r483566444", "bodyText": "you can add this to previous if or remove completely.", "author": "ashvayka", "createdAt": "2020-09-04T11:48:52Z", "path": "application/src/main/java/org/thingsboard/server/service/queue/processing/TbRuleEngineProcessingStrategyFactory.java", "diffHunk": "@@ -108,6 +114,11 @@ public TbRuleEngineProcessingDecision analyze(TbRuleEngineProcessingResult resul\n                         } catch (InterruptedException e) {\n                             throw new RuntimeException(e);\n                         }\n+                        if (multiplyPauseBetweenRetries && maxPauseBetweenRetries > 0) {\n+                            if (pauseBetweenRetries != maxPauseBetweenRetries) {", "originalCommit": "f1b82c2d0537d1ab6f1ae501ecac9f460b58e27f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2Njc5Ng==", "url": "https://github.com/thingsboard/thingsboard/pull/3405#discussion_r483566796", "bodyText": "Maybe\npauseBetweenRetries = Math.min(maxPauseBetweenRetries, pauseBetweenRetries * 2);\n?", "author": "ashvayka", "createdAt": "2020-09-04T11:49:45Z", "path": "application/src/main/java/org/thingsboard/server/service/queue/processing/TbRuleEngineProcessingStrategyFactory.java", "diffHunk": "@@ -108,6 +114,11 @@ public TbRuleEngineProcessingDecision analyze(TbRuleEngineProcessingResult resul\n                         } catch (InterruptedException e) {\n                             throw new RuntimeException(e);\n                         }\n+                        if (multiplyPauseBetweenRetries && maxPauseBetweenRetries > 0) {\n+                            if (pauseBetweenRetries != maxPauseBetweenRetries) {\n+                                pauseBetweenRetries = Math.min(maxPauseBetweenRetries, pauseBetweenRetries * pauseBetweenRetries);", "originalCommit": "f1b82c2d0537d1ab6f1ae501ecac9f460b58e27f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3MjAzMA==", "url": "https://github.com/thingsboard/thingsboard/pull/3405#discussion_r483572030", "bodyText": "@ashvayka sorry for this typo.", "author": "ShvaykaD", "createdAt": "2020-09-04T12:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2Njc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzU2OQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3405#discussion_r483567569", "bodyText": "Maybe we don't need this flag at all? Just check if max-pause-between-retries > pause-between-retries to calculate this.", "author": "ashvayka", "createdAt": "2020-09-04T11:51:27Z", "path": "common/queue/src/main/java/org/thingsboard/server/queue/settings/TbRuleEngineQueueAckStrategyConfiguration.java", "diffHunk": "@@ -24,5 +24,7 @@\n     private int retries;\n     private double failurePercentage;\n     private long pauseBetweenRetries;\n+    private boolean multiplyPauseBetweenRetries;", "originalCommit": "f1b82c2d0537d1ab6f1ae501ecac9f460b58e27f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3MTY3Mw==", "url": "https://github.com/thingsboard/thingsboard/pull/3405#discussion_r483571673", "bodyText": "@ashvayka Ok", "author": "ShvaykaD", "createdAt": "2020-09-04T12:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzU2OQ=="}], "type": "inlineReview"}, {"oid": "9aff0692ae0510117275fdc6a367e55d46d3b628", "url": "https://github.com/thingsboard/thingsboard/commit/9aff0692ae0510117275fdc6a367e55d46d3b628", "message": "clean up code", "committedDate": "2020-09-04T12:47:11Z", "type": "commit"}, {"oid": "ac2a0f51050ce6c7600681da72056f6d003256af", "url": "https://github.com/thingsboard/thingsboard/commit/ac2a0f51050ce6c7600681da72056f6d003256af", "message": "removed unnecessary flag", "committedDate": "2020-09-04T13:13:29Z", "type": "commit"}, {"oid": "70021e7a61be4c9024dc77d30a0dfb66fbd1b45a", "url": "https://github.com/thingsboard/thingsboard/commit/70021e7a61be4c9024dc77d30a0dfb66fbd1b45a", "message": "changed env variable name", "committedDate": "2020-09-04T13:50:50Z", "type": "commit"}, {"oid": "3a19d2c861333dda64198ed443dc97f3af59f5a2", "url": "https://github.com/thingsboard/thingsboard/commit/3a19d2c861333dda64198ed443dc97f3af59f5a2", "message": "changed defaults max-pause-between-retries params", "committedDate": "2020-09-04T14:42:07Z", "type": "commit"}]}