{"pr_number": 3910, "pr_title": "Added ability to return arrays in transformation script node", "pr_createdAt": "2020-12-30T14:10:29Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3910", "timeline": [{"oid": "c6c9d7a343df3103b451d0e4327ede7a1e095c44", "url": "https://github.com/thingsboard/thingsboard/commit/c6c9d7a343df3103b451d0e4327ede7a1e095c44", "message": "Added ability to return arrays in transformation script node", "committedDate": "2020-12-30T14:09:07Z", "type": "commit"}, {"oid": "495520b9e3286bc8183d09e3c4b8ed42dd588326", "url": "https://github.com/thingsboard/thingsboard/commit/495520b9e3286bc8183d09e3c4b8ed42dd588326", "message": "fix typo", "committedDate": "2020-12-30T14:49:43Z", "type": "commit"}, {"oid": "e9399d4ed402a018caadbb6c4bb8d38ee40a538f", "url": "https://github.com/thingsboard/thingsboard/commit/e9399d4ed402a018caadbb6c4bb8d38ee40a538f", "message": "Refactoring", "committedDate": "2020-12-31T10:26:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjUxNjU3Mw==", "url": "https://github.com/thingsboard/thingsboard/pull/3910#discussion_r552516573", "bodyText": "json.size()", "author": "ashvayka", "createdAt": "2021-01-06T11:20:12Z", "path": "application/src/main/java/org/thingsboard/server/service/script/RuleNodeJsScriptEngine.java", "diffHunk": "@@ -116,14 +118,19 @@ public TbMsg executeUpdate(TbMsg msg) throws ScriptException {\n     }\n \n     @Override\n-    public ListenableFuture<TbMsg> executeUpdateAsync(TbMsg msg) {\n+    public ListenableFuture<List<TbMsg>> executeUpdateAsync(TbMsg msg) {\n         ListenableFuture<JsonNode> result = executeScriptAsync(msg);\n         return Futures.transformAsync(result, json -> {\n-            if (!json.isObject()) {\n+            if (json.isObject()) {\n+                return Futures.immediateFuture(Collections.singletonList(unbindMsg(json, msg)));\n+            } else if (json.isArray()){\n+                List<TbMsg> res = new ArrayList<>();", "originalCommit": "e9399d4ed402a018caadbb6c4bb8d38ee40a538f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f873fdc678d05634e0f4716acc8f21c5c61458a", "url": "https://github.com/thingsboard/thingsboard/commit/7f873fdc678d05634e0f4716acc8f21c5c61458a", "message": "Improvements", "committedDate": "2021-01-06T12:24:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjU2MDY3Mw==", "url": "https://github.com/thingsboard/thingsboard/pull/3910#discussion_r552560673", "bodyText": "ctx.ack", "author": "ashvayka", "createdAt": "2021-01-06T12:29:55Z", "path": "rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/transform/TbAbstractTransformNode.java", "diffHunk": "@@ -61,7 +62,20 @@ protected void transformSuccess(TbContext ctx, TbMsg msg, TbMsg m) {\n         }\n     }\n \n-    protected abstract ListenableFuture<TbMsg> transform(TbContext ctx, TbMsg msg);\n+    protected void transformSuccess(TbContext ctx, TbMsg msg, List<TbMsg> msgs) {\n+        if (msgs != null && !msgs.isEmpty()) {\n+            if (msgs.size() == 1) {\n+                ctx.tellSuccess(msgs.get(0));\n+            } else {\n+                TbMsgCallbackWrapper wrapper = new MultipleTbMsgsCallbackWrapper(msgs.size(), msg.getCallback());", "originalCommit": "7f873fdc678d05634e0f4716acc8f21c5c61458a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "38e13bd916a4acc638d0c9c4c1022f9971022655", "url": "https://github.com/thingsboard/thingsboard/commit/38e13bd916a4acc638d0c9c4c1022f9971022655", "message": "Improvements", "committedDate": "2021-01-06T12:37:57Z", "type": "commit"}]}