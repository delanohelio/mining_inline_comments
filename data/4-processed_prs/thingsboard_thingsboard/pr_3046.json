{"pr_number": 3046, "pr_title": "Feature/UUID update", "pr_createdAt": "2020-07-03T09:11:27Z", "pr_url": "https://github.com/thingsboard/thingsboard/pull/3046", "timeline": [{"oid": "bc67dfe12a473de59db532d3e0f54791c857b23d", "url": "https://github.com/thingsboard/thingsboard/commit/bc67dfe12a473de59db532d3e0f54791c857b23d", "message": "added UUID upgrade", "committedDate": "2020-07-03T09:05:05Z", "type": "commit"}, {"oid": "adbfb1bf267ff8a8b5731ecf6dd3936415573ae6", "url": "https://github.com/thingsboard/thingsboard/commit/adbfb1bf267ff8a8b5731ecf6dd3936415573ae6", "message": "refactored UUID upgrade", "committedDate": "2020-07-03T09:05:05Z", "type": "commit"}, {"oid": "9aa087a09d670d7033c007d93af81662cd92c93d", "url": "https://github.com/thingsboard/thingsboard/commit/9aa087a09d670d7033c007d93af81662cd92c93d", "message": "refactored UUID upgrade", "committedDate": "2020-07-03T09:05:05Z", "type": "commit"}, {"oid": "d17ea148f035eac2eedba9a7c62cbff52cf67242", "url": "https://github.com/thingsboard/thingsboard/commit/d17ea148f035eac2eedba9a7c62cbff52cf67242", "message": "refactored schema_update_to_uuid.sql", "committedDate": "2020-07-03T10:01:52Z", "type": "commit"}, {"oid": "7184ba1d89f03b302e6e26dd0d89b0a8cdeb3cf6", "url": "https://github.com/thingsboard/thingsboard/commit/7184ba1d89f03b302e6e26dd0d89b0a8cdeb3cf6", "message": "refactored uuid upgrade and added updating alarm relations.", "committedDate": "2020-07-07T11:12:12Z", "type": "commit"}, {"oid": "8b770cbc96886f92ef4d92d2291dc649e8ac9c4f", "url": "https://github.com/thingsboard/thingsboard/commit/8b770cbc96886f92ef4d92d2291dc649e8ac9c4f", "message": "refactored updating alarm relations.", "committedDate": "2020-07-07T11:23:41Z", "type": "commit"}, {"oid": "4ede5894f76cf715dd1156524d27c171118c5cfc", "url": "https://github.com/thingsboard/thingsboard/commit/4ede5894f76cf715dd1156524d27c171118c5cfc", "message": "refactored updating alarm relations.", "committedDate": "2020-07-07T11:43:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNTk1MQ==", "url": "https://github.com/thingsboard/thingsboard/pull/3046#discussion_r450825951", "bodyText": "Add one more index", "author": "ashvayka", "createdAt": "2020-07-07T12:28:19Z", "path": "application/src/main/data/upgrade/3.0.1/schema_update_to_uuid.sql", "diffHunk": "@@ -21,21 +21,806 @@ DECLARE\n BEGIN\n     bytes := uuid_send(uuid);\n     RETURN\n-                (\n-                            (\n-                                            (get_byte(bytes, 0)::bigint << 24) |\n-                                            (get_byte(bytes, 1)::bigint << 16) |\n-                                            (get_byte(bytes, 2)::bigint <<  8) |\n-                                            (get_byte(bytes, 3)::bigint <<  0)\n-                                ) + (\n-                                    ((get_byte(bytes, 4)::bigint << 8 |\n-                                      get_byte(bytes, 5)::bigint)) << 32\n-                                ) + (\n-                                    (((get_byte(bytes, 6)::bigint & 15) << 8 | get_byte(bytes, 7)::bigint) & 4095) << 48\n-                                ) - 122192928000000000\n-                    ) / 10000::double precision\n-        ;\n+            (\n+                        (\n+                                        (get_byte(bytes, 0)::bigint << 24) |\n+                                        (get_byte(bytes, 1)::bigint << 16) |\n+                                        (get_byte(bytes, 2)::bigint << 8) |\n+                                        (get_byte(bytes, 3)::bigint << 0)\n+                            ) + (\n+                                ((get_byte(bytes, 4)::bigint << 8 |\n+                                  get_byte(bytes, 5)::bigint)) << 32\n+                            ) + (\n+                                (((get_byte(bytes, 6)::bigint & 15) << 8 | get_byte(bytes, 7)::bigint) & 4095) << 48\n+                            ) - 122192928000000000\n+                ) / 10000::double precision;\n END\n $$ LANGUAGE plpgsql\n-    IMMUTABLE PARALLEL SAFE\n+    IMMUTABLE\n+    PARALLEL SAFE\n     RETURNS NULL ON NULL INPUT;\n+\n+\n+CREATE OR REPLACE FUNCTION column_type_to_uuid(table_name varchar, column_name varchar) RETURNS VOID\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    execute format('ALTER TABLE %s RENAME COLUMN %s TO old_%s;', table_name, column_name, column_name);\n+    execute format('ALTER TABLE %s ADD COLUMN %s UUID;', table_name, column_name);\n+    execute format('UPDATE %s SET %s = to_uuid(old_%s) WHERE old_%s is not null;', table_name, column_name, column_name, column_name);\n+    execute format('ALTER TABLE %s DROP COLUMN old_%s;', table_name, column_name);\n+END;\n+$$;\n+\n+CREATE OR REPLACE FUNCTION get_column_type(table_name varchar, column_name varchar, OUT data_type varchar) RETURNS varchar\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    execute (format('SELECT data_type from information_schema.columns where table_name = %L and column_name = %L',\n+                    table_name, column_name)) INTO data_type;\n+END;\n+$$;\n+\n+\n+CREATE OR REPLACE PROCEDURE drop_all_idx()\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    DROP INDEX IF EXISTS idx_alarm_originator_alarm_type;\n+    DROP INDEX IF EXISTS idx_event_type_entity_id;\n+    DROP INDEX IF EXISTS idx_relation_to_id;\n+    DROP INDEX IF EXISTS idx_relation_from_id;\n+    DROP INDEX IF EXISTS idx_device_customer_id;\n+    DROP INDEX IF EXISTS idx_device_customer_id_and_type;\n+    DROP INDEX IF EXISTS idx_device_type;\n+    DROP INDEX IF EXISTS idx_asset_customer_id;\n+    DROP INDEX IF EXISTS idx_asset_customer_id_and_type;\n+    DROP INDEX IF EXISTS idx_asset_type;\n+END;\n+$$;\n+\n+CREATE OR REPLACE PROCEDURE create_all_idx()\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    CREATE INDEX IF NOT EXISTS idx_alarm_originator_alarm_type ON alarm(originator_id, type, start_ts DESC);\n+    CREATE INDEX IF NOT EXISTS idx_event_type_entity_id ON event(tenant_id, event_type, entity_type, entity_id);", "originalCommit": "4ede5894f76cf715dd1156524d27c171118c5cfc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}