{"pr_number": 2552, "pr_title": "Add functions/ocr sample", "pr_createdAt": "2020-04-01T22:31:26Z", "pr_url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552", "timeline": [{"oid": "31c4007a3e7f2aaede9fecebc38b2765026f2d4f", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/31c4007a3e7f2aaede9fecebc38b2765026f2d4f", "message": "Add OCR sample", "committedDate": "2020-04-01T22:24:20Z", "type": "commit"}, {"oid": "69653728fe1c185c9081c9e863c9f0d0be68f753", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/69653728fe1c185c9081c9e863c9f0d0be68f753", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-01T22:31:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MjM3MA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401952370", "bodyText": "1.0.14", "author": "lesv", "createdAt": "2020-04-01T22:42:16Z", "path": "functions/snippets/pom.xml", "diffHunk": "@@ -8,14 +8,14 @@\n   <artifactId>functions-snippets</artifactId>\n   <version>1.0-SNAPSHOT</version>\n \n-  <!--\n-   The parent pom defines common style checks and testing strategies for our samples.\n-   Removing or replacing it should not affect the execution of the samples in anyway.\n- -->\n-  <parent>\n-    <groupId>com.google.cloud.samples</groupId>\n-    <artifactId>shared-configuration</artifactId>\n-    <version>1.0.13</version>\n+  <!--  \n+   The parent pom defines common style checks and testing strategies for our samples. \n+   Removing or replacing it should not affect the execution of the samples in anyway. \n+ -->  \n+  <parent>  \n+    <groupId>com.google.cloud.samples</groupId> \n+    <artifactId>shared-configuration</artifactId> \n+    <version>1.0.13</version> ", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MjgxMw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401962813", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-01T23:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MjM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MjQyNg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401952426", "bodyText": "4.4.0", "author": "lesv", "createdAt": "2020-04-01T22:42:26Z", "path": "functions/snippets/pom.xml", "diffHunk": "@@ -27,7 +27,36 @@\n     <groovy.version>3.0.2</groovy.version>\n   </properties>\n \n+  <dependencyManagement>\n+    <dependencies>\n+      <dependency>\n+        <groupId>com.google.cloud</groupId>\n+        <artifactId>libraries-bom</artifactId>\n+        <version>4.0.0</version>", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2Mjc0Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401962743", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-01T23:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MjQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzI1OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401953258", "bodyText": "I would expect you'd want to [END functions_ocr_process] here and start it just before accept().", "author": "lesv", "createdAt": "2020-04-01T22:44:40Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MjY0Mg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401962642", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-01T23:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDE1Ng==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401954156", "bodyText": "This method seems a bit tiny and pointless as a teaching example - it really only has a single significant line.  I wonder if you might want to do this a bit differently?", "author": "lesv", "createdAt": "2020-04-01T22:47:10Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MTc4Nw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401961787", "bodyText": "I was copying the Node example.\n(Though I agree this might be worth refactoring - detectText is a borderline \"God method\", so maybe we should move the Pub/Sub publishing code to this method instead?)", "author": "ace-n", "createdAt": "2020-04-01T23:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NjA5OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401966098", "bodyText": "Let's keep things simple and only ask the user to follow one method.", "author": "lesv", "createdAt": "2020-04-01T23:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401954426", "bodyText": "Why do we do this?", "author": "lesv", "createdAt": "2020-04-01T22:47:59Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) throws RuntimeException {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse.hasError()) {\n+        LOGGER.severe(\"Error detecting text: \" + visionResponse.getError().getMessage());\n+        return;\n+      }\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDc2OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401954768", "bodyText": "Just because you use a try w/ resources doesn't mean you need to ever catch anything.", "author": "lesv", "createdAt": "2020-04-01T22:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTgxMg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401959812", "bodyText": "The Base BackgroundFunction type in the Functions Framework can only throw subclasses of RuntimeException, which these are not.\n(IntelliJ requires the exception to be addressed in a catch block - even if that block merely ignores the error.)", "author": "ace-n", "createdAt": "2020-04-01T23:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzI5MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401967291", "bodyText": "https://google.github.io/styleguide/javaguide.html#s6.2-caught-exceptions\nAlso see Effective Java v3 Exceptions\n\nItem 69: Use exceptions only for exceptional conditions\nItem 70: Use checked exceptions for recoverable conditions and runtime exceptions for programming errors\nItem 71: Avoid unnecessary use of checked exceptions\nItem 72: Favor the use of standard exceptions\nItem 73: Throw exceptions appropriate to the abstraction\nItem 74: Document all exceptions thrown by each method\nItem 77: Don\u2019t ignore exceptions", "author": "lesv", "createdAt": "2020-04-01T23:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODM5NA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401968394", "bodyText": "What if you just say throws IOException ?", "author": "lesv", "createdAt": "2020-04-01T23:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODY5OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401968698", "bodyText": "Ah - so (some of) these seem more like \"checked\" exceptions.\nIn that case, maybe it would be better to log them and exit the function?", "author": "ace-n", "createdAt": "2020-04-01T23:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjM3Mg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401992372", "bodyText": "Spoke with lesv@ about this - initial thoughts are that the best case would be to add a FunctionException (ala  ServerletException) to the Functions framework interface for handling these type of things.  Would you mind opening an issue for this?\nA reasonable workaround until that is added is log (with Logger.error) in the meantime.", "author": "kurtisvg", "createdAt": "2020-04-02T00:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NDk5OQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402654999", "bodyText": "Please log over RuntimeException everywhere.", "author": "kurtisvg", "createdAt": "2020-04-02T23:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTIyOQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401955229", "bodyText": "Why don't you throw something here?", "author": "lesv", "createdAt": "2020-04-01T22:50:04Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) throws RuntimeException {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse.hasError()) {\n+        LOGGER.severe(\"Error detecting text: \" + visionResponse.getError().getMessage());\n+        return;", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MzQ3MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401963471", "bodyText": "Switched to RuntimeException.", "author": "ace-n", "createdAt": "2020-04-01T23:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTY3OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401955678", "bodyText": "Why?", "author": "lesv", "createdAt": "2020-04-01T22:51:17Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) throws RuntimeException {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse.hasError()) {\n+        LOGGER.severe(\"Error detecting text: \" + visionResponse.getError().getMessage());\n+        return;\n+      }\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+\n+    if (visionResponse == null || !visionResponse.hasFullTextAnnotation()) {\n+      return;\n+    }\n+\n+    String text = visionResponse.getFullTextAnnotation().getText();\n+    LOGGER.info(\"Extracted text from image: \" + text);\n+\n+    // Detect language using the Cloud Translation API\n+    DetectLanguageRequest languageRequest =\n+        DetectLanguageRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setContent(text)\n+            .build();\n+    DetectLanguageResponse languageResponse;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      languageResponse = client.detectLanguage(languageRequest);\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MzUyMg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401963522", "bodyText": "Ditto.", "author": "ace-n", "createdAt": "2020-04-01T23:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTc3MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401955771", "bodyText": "Is this a success?", "author": "lesv", "createdAt": "2020-04-01T22:51:35Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) throws RuntimeException {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse.hasError()) {\n+        LOGGER.severe(\"Error detecting text: \" + visionResponse.getError().getMessage());\n+        return;\n+      }\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+\n+    if (visionResponse == null || !visionResponse.hasFullTextAnnotation()) {\n+      return;", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NDYwNA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401964604", "bodyText": "Added a log statement.\nI'm somewhat reluctant to throw an exception here, as this could be caused by bad user input (as opposed to programmer error.)", "author": "ace-n", "createdAt": "2020-04-01T23:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTkxNw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401955917", "bodyText": "Is this a success?", "author": "lesv", "createdAt": "2020-04-01T22:51:51Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) throws RuntimeException {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse.hasError()) {\n+        LOGGER.severe(\"Error detecting text: \" + visionResponse.getError().getMessage());\n+        return;\n+      }\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+\n+    if (visionResponse == null || !visionResponse.hasFullTextAnnotation()) {\n+      return;\n+    }\n+\n+    String text = visionResponse.getFullTextAnnotation().getText();\n+    LOGGER.info(\"Extracted text from image: \" + text);\n+\n+    // Detect language using the Cloud Translation API\n+    DetectLanguageRequest languageRequest =\n+        DetectLanguageRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setContent(text)\n+            .build();\n+    DetectLanguageResponse languageResponse;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      languageResponse = client.detectLanguage(languageRequest);\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+\n+    if (languageResponse == null || languageResponse.getLanguagesCount() == 0) {\n+      return;", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NDQwNQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401964405", "bodyText": "Added a log statement. (See above comment for more info.)", "author": "ace-n", "createdAt": "2020-04-01T23:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTk4NQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401955985", "bodyText": "Why?", "author": "lesv", "createdAt": "2020-04-01T22:52:04Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) throws RuntimeException {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse.hasError()) {\n+        LOGGER.severe(\"Error detecting text: \" + visionResponse.getError().getMessage());\n+        return;\n+      }\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+\n+    if (visionResponse == null || !visionResponse.hasFullTextAnnotation()) {\n+      return;\n+    }\n+\n+    String text = visionResponse.getFullTextAnnotation().getText();\n+    LOGGER.info(\"Extracted text from image: \" + text);\n+\n+    // Detect language using the Cloud Translation API\n+    DetectLanguageRequest languageRequest =\n+        DetectLanguageRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setContent(text)\n+            .build();\n+    DetectLanguageResponse languageResponse;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      languageResponse = client.detectLanguage(languageRequest);\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+\n+    if (languageResponse == null || languageResponse.getLanguagesCount() == 0) {\n+      return;\n+    }\n+\n+    String languageCode = languageResponse.getLanguages(0).getLanguageCode();\n+    LOGGER.info(String.format(\"Detected language %s for file %s\", languageCode, filename));\n+\n+    // Send a Pub/Sub translation request for every language we're going to translate to\n+    for (String targetLanguage : TO_LANGS) {\n+      LOGGER.info(\"Sending translation request for language \" + targetLanguage);\n+      OcrTranslateApiMessage message = new OcrTranslateApiMessage(text, filename, targetLanguage);\n+      ByteString byteStr = ByteString.copyFrom(message.toPubsubData());\n+      PubsubMessage pubsubApiMessage = PubsubMessage.newBuilder().setData(byteStr).build();\n+      try {\n+        publisher.publish(pubsubApiMessage).get();\n+      } catch (InterruptedException | ExecutionException e) {\n+        // Cast to RuntimeException\n+        throw new RuntimeException(e);\n+      }", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTkzNg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401959936", "bodyText": "See comment above.", "author": "ace-n", "createdAt": "2020-04-01T23:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NTk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NjY0OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401956648", "bodyText": "Why?", "author": "lesv", "createdAt": "2020-04-01T22:53:56Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateApiMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate_pojo]\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.util.Base64;\n+\n+// Object for storing OCR translation requests\n+public class OcrTranslateApiMessage {\n+  private String text;\n+  private String filename;\n+  private String lang;\n+\n+  private static final Gson gson = new Gson();\n+\n+  public OcrTranslateApiMessage(String text, String filename, String lang) {\n+    this.text = text;\n+    this.filename = filename;\n+    this.lang = lang;\n+  }\n+\n+  public String getText() {\n+    return text;\n+  }\n+\n+  public String getFilename() {\n+    return filename;\n+  }\n+\n+  public String getLang() {\n+    return lang;\n+  }", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDQ1MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401960451", "bodyText": "@kurtisvg has a preference for getters/setters - but I can drop these if you'd prefer.", "author": "ace-n", "createdAt": "2020-04-01T23:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NjY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzY0NQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401967645", "bodyText": "Your not using them outside your class, so I'd prefer dropping them, but feel free to ask kurtis about my comment.", "author": "lesv", "createdAt": "2020-04-01T23:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NjY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2OTQzOA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401969438", "bodyText": "Will do. Also, these are used outside the class (e.g. here)", "author": "ace-n", "createdAt": "2020-04-01T23:32:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NjY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NjEyOA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401986128", "bodyText": "Spoke with Les - we should use getters/setter from outside of the class (like where you linked) but make sure to use the internal reference (like in fromPubSubData).", "author": "kurtisvg", "createdAt": "2020-04-02T00:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NjY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1Njk4MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401956981", "bodyText": "Since it's your class, you can access directly.  No reason to use the accessors.", "author": "lesv", "createdAt": "2020-04-01T22:54:46Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateApiMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate_pojo]\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.util.Base64;\n+\n+// Object for storing OCR translation requests\n+public class OcrTranslateApiMessage {\n+  private String text;\n+  private String filename;\n+  private String lang;\n+\n+  private static final Gson gson = new Gson();\n+\n+  public OcrTranslateApiMessage(String text, String filename, String lang) {\n+    this.text = text;\n+    this.filename = filename;\n+    this.lang = lang;\n+  }\n+\n+  public String getText() {\n+    return text;\n+  }\n+\n+  public String getFilename() {\n+    return filename;\n+  }\n+\n+  public String getLang() {\n+    return lang;\n+  }\n+\n+  public static OcrTranslateApiMessage fromPubsubData(byte[] data)\n+      throws IllegalArgumentException {\n+    String jsonStr = new String(Base64.getDecoder().decode(data));\n+    OcrTranslateApiMessage ocrMessage = gson.fromJson(jsonStr, OcrTranslateApiMessage.class);\n+\n+    // Get + verify parameters\n+    String text = ocrMessage.getText();\n+    String filename = ocrMessage.getFilename();\n+    String targetLang = ocrMessage.getLang();", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDIxMw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401960213", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-01T23:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1Njk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzIyNg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401957226", "bodyText": "Why?", "author": "lesv", "createdAt": "2020-04-01T22:55:30Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateText.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslateTextRequest;\n+import com.google.cloud.translate.v3.TranslateTextResponse;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrTranslateText implements BackgroundFunction<PubSubMessage> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String RESULTS_TOPIC_NAME = System.getenv(\"RESULT_TOPIC\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrTranslateText.class.getName());\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+\n+  public OcrTranslateText() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, RESULTS_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(PubSubMessage pubSubMessage, Context context) {\n+    OcrTranslateApiMessage ocrMessage = OcrTranslateApiMessage.fromPubsubData(\n+        pubSubMessage.getData().getBytes());\n+\n+    String targetLang = ocrMessage.getLang();\n+    LOGGER.info(\"Translating text into \" + targetLang);\n+\n+    // Translate text to target language\n+    String text = ocrMessage.getText();\n+    TranslateTextRequest request =\n+        TranslateTextRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setTargetLanguageCode(targetLang)\n+            .addContents(text)\n+            .build();\n+\n+    TranslateTextResponse response;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      response = client.translateText(request);\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+    if (response == null || response.getTranslationsCount() == 0) {\n+      return;\n+    }\n+\n+    String translatedText = response.getTranslations(0).getTranslatedText();\n+    LOGGER.info(\"Translated text: \" + translatedText);\n+\n+    // Send translated text to (subsequent) Pub/Sub topic\n+    String filename = ocrMessage.getFilename();\n+    OcrTranslateApiMessage translateMessage = new OcrTranslateApiMessage(\n+        translatedText, filename, targetLang);\n+    try {\n+      ByteString byteStr = ByteString.copyFrom(translateMessage.toPubsubData());\n+      PubsubMessage pubsubApiMessage = PubsubMessage.newBuilder().setData(byteStr).build();\n+\n+      publisher.publish(pubsubApiMessage).get();\n+      LOGGER.info(\"Text translated to \" + targetLang);\n+    } catch (InterruptedException | ExecutionException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTk4OQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401959989", "bodyText": "Ditto.", "author": "ace-n", "createdAt": "2020-04-01T23:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzIyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzI3MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401957271", "bodyText": "Why?", "author": "lesv", "createdAt": "2020-04-01T22:55:39Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateText.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslateTextRequest;\n+import com.google.cloud.translate.v3.TranslateTextResponse;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrTranslateText implements BackgroundFunction<PubSubMessage> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String RESULTS_TOPIC_NAME = System.getenv(\"RESULT_TOPIC\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrTranslateText.class.getName());\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+\n+  public OcrTranslateText() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, RESULTS_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(PubSubMessage pubSubMessage, Context context) {\n+    OcrTranslateApiMessage ocrMessage = OcrTranslateApiMessage.fromPubsubData(\n+        pubSubMessage.getData().getBytes());\n+\n+    String targetLang = ocrMessage.getLang();\n+    LOGGER.info(\"Translating text into \" + targetLang);\n+\n+    // Translate text to target language\n+    String text = ocrMessage.getText();\n+    TranslateTextRequest request =\n+        TranslateTextRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setTargetLanguageCode(targetLang)\n+            .addContents(text)\n+            .build();\n+\n+    TranslateTextResponse response;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      response = client.translateText(request);\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }", "originalCommit": "69653728fe1c185c9081c9e863c9f0d0be68f753", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDAzMg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401960032", "bodyText": "Ditto.", "author": "ace-n", "createdAt": "2020-04-01T23:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzI3MQ=="}], "type": "inlineReview"}, {"oid": "a18a7e8bcc8467dc24f242fafe6e2407d196a37b", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a18a7e8bcc8467dc24f242fafe6e2407d196a37b", "message": "Address comments", "committedDate": "2020-04-01T23:18:11Z", "type": "commit"}, {"oid": "18bb4561f4c6d2319fa19b8a0df4e3ea667542ff", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/18bb4561f4c6d2319fa19b8a0df4e3ea667542ff", "message": "Merge branch 'gcf-ocr' of http://github.com/GoogleCloudPlatform/java-docs-samples into gcf-ocr", "committedDate": "2020-04-01T23:18:25Z", "type": "commit"}, {"oid": "8d6c2c4224bbe617da24a0cdc97951468b827b4a", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/8d6c2c4224bbe617da24a0cdc97951468b827b4a", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-01T23:20:17Z", "type": "commit"}, {"oid": "c1b2e536a65c7f563f7de0833425a62c56205456", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/c1b2e536a65c7f563f7de0833425a62c56205456", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-01T23:20:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODg2NA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401968864", "bodyText": "This is still very wrong.", "author": "lesv", "createdAt": "2020-04-01T23:30:42Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateText.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslateTextRequest;\n+import com.google.cloud.translate.v3.TranslateTextResponse;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrTranslateText implements BackgroundFunction<PubSubMessage> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String RESULTS_TOPIC_NAME = System.getenv(\"RESULT_TOPIC\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrTranslateText.class.getName());\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+\n+  public OcrTranslateText() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, RESULTS_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(PubSubMessage pubSubMessage, Context context) {\n+    OcrTranslateApiMessage ocrMessage = OcrTranslateApiMessage.fromPubsubData(\n+        pubSubMessage.getData().getBytes());\n+\n+    String targetLang = ocrMessage.getLang();\n+    LOGGER.info(\"Translating text into \" + targetLang);\n+\n+    // Translate text to target language\n+    String text = ocrMessage.getText();\n+    TranslateTextRequest request =\n+        TranslateTextRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setTargetLanguageCode(targetLang)\n+            .addContents(text)\n+            .build();\n+\n+    TranslateTextResponse response;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      response = client.translateText(request);\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }", "originalCommit": "c1b2e536a65c7f563f7de0833425a62c56205456", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3MDUxMw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401970513", "bodyText": "Compiler error: Overridden method accept(...) does not throw IOException\n(This would have to be fixed in the Functions Framework itself. If you'd like, I can file an issue.)", "author": "ace-n", "createdAt": "2020-04-01T23:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODg2NA=="}], "type": "inlineReview"}, {"oid": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-02T00:34:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjkyMg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401992922", "bodyText": "Is there a reason why we are splitting this class into two functions? Seems like it makes it harder to copy/paste", "author": "kurtisvg", "createdAt": "2020-04-02T00:52:43Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+// [END functions_ocr_process]", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0MjQ1Ng==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402642456", "bodyText": "The existing samples do that. (@lesv had similar feedback)\nIf you'd like, I can move the Pub/Sub publishing code to functions_ocr_process since detectText is quite long.", "author": "ace-n", "createdAt": "2020-04-02T22:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NTA5OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r401995098", "bodyText": "We don't need to add unchecked exceptions to the interface\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {\n          \n          \n            \n              public void accept(GcsEvent gcsEvent, Context context) {", "author": "kurtisvg", "createdAt": "2020-04-02T01:00:43Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+// [END functions_ocr_process]\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  // [START functions_ocr_process]\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) throws RuntimeException {", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2NjUzOQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402566539", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-02T19:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NTA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMTg0MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402011841", "bodyText": "This isn't imported from anywhere? Is it supposed to be com.google.pubsub.v1.PubsubMessage?", "author": "kurtisvg", "createdAt": "2020-04-02T02:07:33Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrSaveResult.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_save]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.storage.BlobId;\n+import com.google.cloud.storage.BlobInfo;\n+import com.google.cloud.storage.Storage;\n+import com.google.cloud.storage.StorageOptions;\n+import java.util.logging.Logger;\n+\n+public class OcrSaveResult implements BackgroundFunction<PubSubMessage> {", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMjA5MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402012091", "bodyText": "Any reason not to make this a com.google.pubsub.v1.PubsubMessage instead of byte[]?", "author": "kurtisvg", "createdAt": "2020-04-02T02:08:30Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateApiMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate_pojo]\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.util.Base64;\n+\n+// Object for storing OCR translation requests\n+public class OcrTranslateApiMessage {\n+  private String text;\n+  private String filename;\n+  private String lang;\n+\n+  private static final Gson gson = new Gson();\n+\n+  public OcrTranslateApiMessage(String text, String filename, String lang) {\n+    this.text = text;\n+    this.filename = filename;\n+    this.lang = lang;\n+  }\n+\n+  public String getText() {\n+    return text;\n+  }\n+\n+  public String getFilename() {\n+    return filename;\n+  }\n+\n+  public String getLang() {\n+    return lang;\n+  }\n+\n+  public static OcrTranslateApiMessage fromPubsubData(byte[] data)", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2ODEwOA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402568108", "bodyText": "There's also a PubSubMessage (capitalized s) POJO here, that's necessary for deserializing incoming Pub/Sub events.\n(I tried deserializing into the com.google.pubsub.v1.PubsubMessage type, but the default Gson deserializer couldn't handle it. Longer-term, we should probably write a custom deserializer for this class within the Pub/Sub client library.)\n#fyi @chingor13", "author": "ace-n", "createdAt": "2020-04-02T19:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMjA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMjM1NA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402012354", "bodyText": "Don't need to throw unchecked exceptions", "author": "kurtisvg", "createdAt": "2020-04-02T02:09:24Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateApiMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate_pojo]\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.util.Base64;\n+\n+// Object for storing OCR translation requests\n+public class OcrTranslateApiMessage {\n+  private String text;\n+  private String filename;\n+  private String lang;\n+\n+  private static final Gson gson = new Gson();\n+\n+  public OcrTranslateApiMessage(String text, String filename, String lang) {\n+    this.text = text;\n+    this.filename = filename;\n+    this.lang = lang;\n+  }\n+\n+  public String getText() {\n+    return text;\n+  }\n+\n+  public String getFilename() {\n+    return filename;\n+  }\n+\n+  public String getLang() {\n+    return lang;\n+  }\n+\n+  public static OcrTranslateApiMessage fromPubsubData(byte[] data)\n+      throws IllegalArgumentException {", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4MjI2NQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402582265", "bodyText": "Per your comment below, I moved this into the constructor.", "author": "ace-n", "createdAt": "2020-04-02T20:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMjM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMzMyMA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402013320", "bodyText": "com.google.pubsub.v1.PubsubMessage looks like it has a getData that returns a String. Can you use that instead of decoding?", "author": "kurtisvg", "createdAt": "2020-04-02T02:13:28Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateApiMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate_pojo]\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.util.Base64;\n+\n+// Object for storing OCR translation requests\n+public class OcrTranslateApiMessage {\n+  private String text;\n+  private String filename;\n+  private String lang;\n+\n+  private static final Gson gson = new Gson();\n+\n+  public OcrTranslateApiMessage(String text, String filename, String lang) {\n+    this.text = text;\n+    this.filename = filename;\n+    this.lang = lang;\n+  }\n+\n+  public String getText() {\n+    return text;\n+  }\n+\n+  public String getFilename() {\n+    return filename;\n+  }\n+\n+  public String getLang() {\n+    return lang;\n+  }\n+\n+  public static OcrTranslateApiMessage fromPubsubData(byte[] data)\n+      throws IllegalArgumentException {\n+    String jsonStr = new String(Base64.getDecoder().decode(data));", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4MTM3MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402581371", "bodyText": "See conversation above - it doesn't (yet) work with Cloud Functions' event de-serialization logic.", "author": "ace-n", "createdAt": "2020-04-02T20:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMzMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNDc5MA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402024790", "bodyText": "It's a bit of an anti-pattern to deserialize this and THEN verify it. It's implying that you never want text, filename, targetLang to be null, but it's still possible when you use the regular constructor.\nIt's probably better to move the verification to the constructor and do something like this instead:\nJsonObject json = gson.parseString(jsonStr);\nreturn new OcrTranslateApiMessage(json.get('text'), json.get('filename'), json.get('lang'));", "author": "kurtisvg", "createdAt": "2020-04-02T02:59:15Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateApiMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate_pojo]\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.util.Base64;\n+\n+// Object for storing OCR translation requests\n+public class OcrTranslateApiMessage {\n+  private String text;\n+  private String filename;\n+  private String lang;\n+\n+  private static final Gson gson = new Gson();\n+\n+  public OcrTranslateApiMessage(String text, String filename, String lang) {\n+    this.text = text;\n+    this.filename = filename;\n+    this.lang = lang;\n+  }\n+\n+  public String getText() {\n+    return text;\n+  }\n+\n+  public String getFilename() {\n+    return filename;\n+  }\n+\n+  public String getLang() {\n+    return lang;\n+  }\n+\n+  public static OcrTranslateApiMessage fromPubsubData(byte[] data)\n+      throws IllegalArgumentException {\n+    String jsonStr = new String(Base64.getDecoder().decode(data));\n+    OcrTranslateApiMessage ocrMessage = gson.fromJson(jsonStr, OcrTranslateApiMessage.class);", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4MjQxOQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402582419", "bodyText": "Moved validation into the constructor - PTAL?\n(I opted to keep the fromJson() call here, as I'm assuming that will call the constructor which will in turn handle the validation - LMK if I should replace that with parseString().)", "author": "ace-n", "createdAt": "2020-04-02T20:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNDc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNTQ3NA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402025474", "bodyText": "Any reason not to use com.google.pubsub.v1.PubsubMessage over byte? seems like a weird place to split up the helper functions.", "author": "kurtisvg", "createdAt": "2020-04-02T03:02:07Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateApiMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate_pojo]\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.util.Base64;\n+\n+// Object for storing OCR translation requests\n+public class OcrTranslateApiMessage {\n+  private String text;\n+  private String filename;\n+  private String lang;\n+\n+  private static final Gson gson = new Gson();\n+\n+  public OcrTranslateApiMessage(String text, String filename, String lang) {\n+    this.text = text;\n+    this.filename = filename;\n+    this.lang = lang;\n+  }\n+\n+  public String getText() {\n+    return text;\n+  }\n+\n+  public String getFilename() {\n+    return filename;\n+  }\n+\n+  public String getLang() {\n+    return lang;\n+  }\n+\n+  public static OcrTranslateApiMessage fromPubsubData(byte[] data)\n+      throws IllegalArgumentException {\n+    String jsonStr = new String(Base64.getDecoder().decode(data));\n+    OcrTranslateApiMessage ocrMessage = gson.fromJson(jsonStr, OcrTranslateApiMessage.class);\n+\n+    // Get + verify parameters\n+    String text = ocrMessage.text;\n+    String filename = ocrMessage.filename;\n+    String targetLang = ocrMessage.lang;\n+    if (text == null) {\n+      throw new IllegalArgumentException(\"Missing text parameter\");\n+    }\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing filename parameter\");\n+    }\n+    if (targetLang == null) {\n+      throw new IllegalArgumentException(\"Missing lang parameter\");\n+    }\n+\n+    return ocrMessage;\n+  }\n+\n+  public byte[] toPubsubData() {", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4Mzk2Nw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402583967", "bodyText": "See other comments about this not working with Gson", "author": "ace-n", "createdAt": "2020-04-02T20:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNTQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNTgxNw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402025817", "bodyText": "Any reason not to inline these three variables?", "author": "kurtisvg", "createdAt": "2020-04-02T03:03:33Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrSaveResult.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_save]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.storage.BlobId;\n+import com.google.cloud.storage.BlobInfo;\n+import com.google.cloud.storage.Storage;\n+import com.google.cloud.storage.StorageOptions;\n+import java.util.logging.Logger;\n+\n+public class OcrSaveResult implements BackgroundFunction<PubSubMessage> {\n+  // TODO<developer> set this environment variable\n+  private static final String RESULT_BUCKET = System.getenv(\"RESULT_BUCKET\");\n+\n+  private static final Storage storage = StorageOptions.getDefaultInstance().getService();\n+  private static final Logger LOGGER = Logger.getLogger(OcrSaveResult.class.getName());\n+\n+  @Override\n+  public void accept(PubSubMessage pubSubMessage, Context context) {\n+    OcrTranslateApiMessage ocrMessage = OcrTranslateApiMessage.fromPubsubData(\n+        pubSubMessage.data.getBytes());\n+\n+    String text = ocrMessage.getText();\n+    String filename = ocrMessage.getFilename();\n+    String lang = ocrMessage.getLang();", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5MDg2Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402590863", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-02T20:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNTgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNjE1Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402026153", "bodyText": "Why are we checking if response == null? Does the client actually return that as a result?\nCan we add a comment inside function explaining why it's returning?", "author": "kurtisvg", "createdAt": "2020-04-02T03:04:45Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrTranslateText.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_translate]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslateTextRequest;\n+import com.google.cloud.translate.v3.TranslateTextResponse;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+public class OcrTranslateText implements BackgroundFunction<PubSubMessage> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String RESULTS_TOPIC_NAME = System.getenv(\"RESULT_TOPIC\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrTranslateText.class.getName());\n+  private static Publisher publisher;\n+  private static final Gson gson = new Gson();\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+\n+  public OcrTranslateText() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, RESULTS_TOPIC_NAME)).build();\n+  }\n+\n+  @Override\n+  public void accept(PubSubMessage pubSubMessage, Context context) {\n+    OcrTranslateApiMessage ocrMessage = OcrTranslateApiMessage.fromPubsubData(\n+        pubSubMessage.getData().getBytes());\n+\n+    String targetLang = ocrMessage.getLang();\n+    LOGGER.info(\"Translating text into \" + targetLang);\n+\n+    // Translate text to target language\n+    String text = ocrMessage.getText();\n+    TranslateTextRequest request =\n+        TranslateTextRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setTargetLanguageCode(targetLang)\n+            .addContents(text)\n+            .build();\n+\n+    TranslateTextResponse response;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      response = client.translateText(request);\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+    if (response == null || response.getTranslationsCount() == 0) {", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMDI1MA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402600250", "bodyText": "This was a defensive programming reflex - removed. \ud83d\ude42", "author": "ace-n", "createdAt": "2020-04-02T21:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNjE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNzAyNA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402027024", "bodyText": "Should use either a setter (or constructor) to set these fields.", "author": "kurtisvg", "createdAt": "2020-04-02T03:08:35Z", "path": "functions/snippets/src/test/java/com/example/functions/OcrTests.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.cloud.storage.BlobInfo;\n+import com.google.cloud.storage.Storage;\n+import com.google.cloud.storage.StorageOptions;\n+import com.google.common.testing.TestLogHandler;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.logging.LogRecord;\n+import java.util.logging.Logger;\n+import org.junit.After;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class OcrTests {\n+  private static String FUNCTIONS_BUCKET = \"nodejs-docs-samples-tests\";\n+  private static String RESULT_BUCKET = System.getenv(\"RESULT_BUCKET\");\n+\n+  private static final Logger PROCESS_IMAGE_LOGGER = Logger.getLogger(\n+      OcrProcessImage.class.getName());\n+  private static final Logger SAVE_RESULT_LOGGER = Logger.getLogger(OcrSaveResult.class.getName());\n+  private static final Logger TRANSLATE_TEXT_LOGGER = Logger.getLogger(\n+      OcrTranslateText.class.getName());\n+\n+  private static final TestLogHandler LOG_HANDLER = new TestLogHandler();\n+\n+  private static final Gson gson = new Gson();\n+\n+  private static final Storage storage = StorageOptions.getDefaultInstance().getService();\n+\n+  @BeforeClass\n+  public static void beforeClass() {\n+    PROCESS_IMAGE_LOGGER.addHandler(LOG_HANDLER);\n+    SAVE_RESULT_LOGGER.addHandler(LOG_HANDLER);\n+    TRANSLATE_TEXT_LOGGER.addHandler(LOG_HANDLER);\n+  }\n+\n+  @After\n+  public void afterTest() {\n+    LOG_HANDLER.clear();\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void functionsOcrProcess_shouldValidateParams() throws IOException {\n+    new OcrProcessImage().accept(new GcsEvent(), null);\n+  }\n+\n+  @Test\n+  public void functionsOcrProcess_shouldDetectText() throws IOException {\n+    GcsEvent gcsEvent = new GcsEvent();\n+    gcsEvent.bucket = FUNCTIONS_BUCKET;", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYwMTI3MQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402601271", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-02T21:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyNzAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyODY3Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402028673", "bodyText": "Please use java.time for this instead.  You can use something like Instance.now().minus(5, MINUTES)\nAdditionally, this check doesn't actually verify it worked when run in parallel (as we do with our unit tests).", "author": "kurtisvg", "createdAt": "2020-04-02T03:15:35Z", "path": "functions/snippets/src/test/java/com/example/functions/OcrTests.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.cloud.storage.BlobInfo;\n+import com.google.cloud.storage.Storage;\n+import com.google.cloud.storage.StorageOptions;\n+import com.google.common.testing.TestLogHandler;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.logging.LogRecord;\n+import java.util.logging.Logger;\n+import org.junit.After;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class OcrTests {\n+  private static String FUNCTIONS_BUCKET = \"nodejs-docs-samples-tests\";\n+  private static String RESULT_BUCKET = System.getenv(\"RESULT_BUCKET\");\n+\n+  private static final Logger PROCESS_IMAGE_LOGGER = Logger.getLogger(\n+      OcrProcessImage.class.getName());\n+  private static final Logger SAVE_RESULT_LOGGER = Logger.getLogger(OcrSaveResult.class.getName());\n+  private static final Logger TRANSLATE_TEXT_LOGGER = Logger.getLogger(\n+      OcrTranslateText.class.getName());\n+\n+  private static final TestLogHandler LOG_HANDLER = new TestLogHandler();\n+\n+  private static final Gson gson = new Gson();\n+\n+  private static final Storage storage = StorageOptions.getDefaultInstance().getService();\n+\n+  @BeforeClass\n+  public static void beforeClass() {\n+    PROCESS_IMAGE_LOGGER.addHandler(LOG_HANDLER);\n+    SAVE_RESULT_LOGGER.addHandler(LOG_HANDLER);\n+    TRANSLATE_TEXT_LOGGER.addHandler(LOG_HANDLER);\n+  }\n+\n+  @After\n+  public void afterTest() {\n+    LOG_HANDLER.clear();\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void functionsOcrProcess_shouldValidateParams() throws IOException {\n+    new OcrProcessImage().accept(new GcsEvent(), null);\n+  }\n+\n+  @Test\n+  public void functionsOcrProcess_shouldDetectText() throws IOException {\n+    GcsEvent gcsEvent = new GcsEvent();\n+    gcsEvent.bucket = FUNCTIONS_BUCKET;\n+    gcsEvent.name = \"wakeupcat.jpg\";\n+\n+    new OcrProcessImage().accept(gcsEvent, null);\n+\n+    List<LogRecord> logs = LOG_HANDLER.getStoredLogRecords();\n+    assertThat(logs.get(1).getMessage()).contains(\"Extracted text from image: Wake up human!\");\n+    assertThat(logs.get(2).getMessage()).contains(\"Detected language en for file wakeupcat.jpg\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void functionsOcrTranslate_shouldValidateParams() throws IOException {\n+    PubSubMessage message = new PubSubMessage();\n+    message.data = new String(Base64.getEncoder().encode(\"{}\".getBytes()));\n+\n+    new OcrTranslateText().accept(message, null);\n+  }\n+\n+  @Test\n+  public void functionsOcrTranslate_shouldTranslateText() throws IOException {\n+    String text = \"Wake up human!\";\n+    String filename = \"wakeupcat.jpg\";\n+    String lang = \"es\";\n+\n+    JsonObject dataJson = new JsonObject();\n+    dataJson.addProperty(\"text\", text);\n+    dataJson.addProperty(\"filename\", filename);\n+    dataJson.addProperty(\"lang\", lang);\n+\n+    PubSubMessage message = new PubSubMessage();\n+    message.data = new String(Base64.getEncoder().encode(gson.toJson(dataJson).getBytes()));\n+\n+    new OcrTranslateText().accept(message, null);\n+\n+    List<LogRecord> logs = LOG_HANDLER.getStoredLogRecords();\n+    assertThat(logs.get(1).getMessage()).contains(\"\u00a1Despierta humano!\");\n+    assertThat(logs.get(2).getMessage()).isEqualTo(\"Text translated to es\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void functionsOcrSave_shouldValidateParams() throws IOException {\n+    PubSubMessage message = new PubSubMessage();\n+    message.data = new String(Base64.getEncoder().encode(\"{}\".getBytes()));\n+\n+    new OcrSaveResult().accept(message, null);\n+  }\n+\n+  @Test\n+  public void functionsOcrSave_shouldPublishTranslatedText() throws IOException {\n+    String text = \"Wake up human!\";\n+    String filename = \"wakeupcat.jpg\";\n+    String lang = \"es\";\n+\n+    JsonObject dataJson = new JsonObject();\n+    dataJson.addProperty(\"text\", text);\n+    dataJson.addProperty(\"filename\", filename);\n+    dataJson.addProperty(\"lang\", lang);\n+\n+    PubSubMessage message = new PubSubMessage();\n+    message.data = new String(Base64.getEncoder().encode(gson.toJson(dataJson).getBytes()));\n+\n+    new OcrSaveResult().accept(message, null);\n+\n+    String resultFilename = \"wakeupcat.jpg_to_es.txt\";\n+\n+    // Check log messages\n+    List<LogRecord> logs = LOG_HANDLER.getStoredLogRecords();\n+    String expectedMessage = String.format(\n+        \"Saving result to %s in bucket %s\", resultFilename, RESULT_BUCKET);\n+    assertThat(LOG_HANDLER.getStoredLogRecords().get(1).getMessage()).isEqualTo(expectedMessage);\n+\n+    // Check for (recently) written file\n+    // (Using timestamps instead of exists() saves us a deletion step)\n+    BlobInfo resultBlob = storage.get(RESULT_BUCKET, resultFilename);\n+    Long fiveMinutesAgo = System.currentTimeMillis() - 60000 * 5;", "originalCommit": "a979154ae745e8965a5618727c7b1ba6ee7e2d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYxMzQzNQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402613435", "bodyText": "Replaced this with a UUID'd filename + existence check. \ud83d\ude42\n(The downside is that this also required implementing teardown code.)", "author": "ace-n", "createdAt": "2020-04-02T21:43:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyODY3Mw=="}], "type": "inlineReview"}, {"oid": "3b68ef642b3a4613e69b0119bb4f9e0b4f82e3d6", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/3b68ef642b3a4613e69b0119bb4f9e0b4f82e3d6", "message": "Fix relevant spotbugs errors", "committedDate": "2020-04-02T22:51:48Z", "type": "commit"}, {"oid": "b3c0f914929f41b31c5da0ab9fc259b2291b914b", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b3c0f914929f41b31c5da0ab9fc259b2291b914b", "message": "Address comments", "committedDate": "2020-04-02T22:51:48Z", "type": "commit"}, {"oid": "00c5a1d693bc151d4566ae42a5063cac5f35b2bd", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/00c5a1d693bc151d4566ae42a5063cac5f35b2bd", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-02T22:52:26Z", "type": "commit"}, {"oid": "9ebd755aed8f708e2835a3661e1a7a40f1ba85f7", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/9ebd755aed8f708e2835a3661e1a7a40f1ba85f7", "message": "Fix tests", "committedDate": "2020-04-02T23:13:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NDg5Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402654893", "bodyText": "printStackTrace only goes to stdout\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOGGER.severe(\"Error publishing translation request: \" + e.getMessage());\n          \n          \n            \n                    e.printStackTrace();\n          \n          \n            \n                    LOGGER.log(Level.SEVERE, \"Error publishing translation request: \" + e.getMessage(), e);", "author": "kurtisvg", "createdAt": "2020-04-02T23:32:47Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Logger;\n+\n+// [END functions_ocr_process]\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  // [START functions_ocr_process]\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse == null || !visionResponse.hasFullTextAnnotation()) {\n+        LOGGER.info(String.format(\"Image %s contains no text\", filename));\n+        return;\n+      }\n+\n+      if (visionResponse.hasError()) {\n+        throw new RuntimeException(\n+            \"Error detecting text: \" + visionResponse.getError().getMessage());\n+      }\n+    } catch (IOException e) {\n+      // Cast to RuntimeException\n+      throw new RuntimeException(e);\n+    }\n+\n+    String text = visionResponse.getFullTextAnnotation().getText();\n+    LOGGER.info(\"Extracted text from image: \" + text);\n+\n+    // Detect language using the Cloud Translation API\n+    DetectLanguageRequest languageRequest =\n+        DetectLanguageRequest.newBuilder()\n+            .setParent(LOCATION_NAME.toString())\n+            .setMimeType(\"text/plain\")\n+            .setContent(text)\n+            .build();\n+    DetectLanguageResponse languageResponse;\n+    try (TranslationServiceClient client = TranslationServiceClient.create()) {\n+      languageResponse = client.detectLanguage(languageRequest);\n+    } catch (IOException e) {\n+      // Log error\n+      LOGGER.severe(\"Error detecting language: \" + e.getMessage());\n+      e.printStackTrace();\n+      return;\n+    }\n+\n+    if (languageResponse.getLanguagesCount() == 0) {\n+      LOGGER.info(\"No languages were detected for text: \" + text);\n+      return;\n+    }\n+\n+    String languageCode = languageResponse.getLanguages(0).getLanguageCode();\n+    LOGGER.info(String.format(\"Detected language %s for file %s\", languageCode, filename));\n+\n+    // Send a Pub/Sub translation request for every language we're going to translate to\n+    for (String targetLanguage : TO_LANGS) {\n+      LOGGER.info(\"Sending translation request for language \" + targetLanguage);\n+      OcrTranslateApiMessage message = new OcrTranslateApiMessage(text, filename, targetLanguage);\n+      ByteString byteStr = ByteString.copyFrom(message.toPubsubData());\n+      PubsubMessage pubsubApiMessage = PubsubMessage.newBuilder().setData(byteStr).build();\n+      try {\n+        publisher.publish(pubsubApiMessage).get();\n+      } catch (InterruptedException | ExecutionException e) {\n+        // Log error\n+        LOGGER.severe(\"Error publishing translation request: \" + e.getMessage());\n+        e.printStackTrace();", "originalCommit": "9ebd755aed8f708e2835a3661e1a7a40f1ba85f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NzQxNA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402657414", "bodyText": "(please fix everywhere else)", "author": "kurtisvg", "createdAt": "2020-04-02T23:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NDg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODgyMQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r402668821", "bodyText": "Done.", "author": "ace-n", "createdAt": "2020-04-03T00:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1NDg5Mw=="}], "type": "inlineReview"}, {"oid": "4272f897c403f64aecdd5ae939997bcbeb27d74c", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/4272f897c403f64aecdd5ae939997bcbeb27d74c", "message": "Address comments", "committedDate": "2020-04-03T00:26:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNDM5Mg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r403334392", "bodyText": "nit: Did you mean to downgrade this?", "author": "kurtisvg", "createdAt": "2020-04-03T21:03:16Z", "path": "functions/snippets/pom.xml", "diffHunk": "@@ -124,7 +130,7 @@\n     <dependency>\n       <groupId>com.google.truth</groupId>\n       <artifactId>truth</artifactId>\n-      <version>1.0.1</version>\n+      <version>0.42</version>", "originalCommit": "4272f897c403f64aecdd5ae939997bcbeb27d74c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzODA5Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r403338093", "bodyText": "Oops - fixed!", "author": "ace-n", "createdAt": "2020-04-03T21:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNDM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNTY3OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r403335678", "bodyText": "We shouldn't rewrap errors like this - the visionResponse isn't an IOException.", "author": "kurtisvg", "createdAt": "2020-04-03T21:06:03Z", "path": "functions/snippets/src/main/java/com/example/functions/OcrProcessImage.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_ocr_process]\n+\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.cloud.pubsub.v1.Publisher;\n+import com.google.cloud.translate.v3.DetectLanguageRequest;\n+import com.google.cloud.translate.v3.DetectLanguageResponse;\n+import com.google.cloud.translate.v3.LocationName;\n+import com.google.cloud.translate.v3.TranslationServiceClient;\n+import com.google.cloud.vision.v1.AnnotateImageRequest;\n+import com.google.cloud.vision.v1.AnnotateImageResponse;\n+import com.google.cloud.vision.v1.Feature;\n+import com.google.cloud.vision.v1.Image;\n+import com.google.cloud.vision.v1.ImageAnnotatorClient;\n+import com.google.cloud.vision.v1.ImageSource;\n+import com.google.gson.Gson;\n+import com.google.protobuf.ByteString;\n+import com.google.pubsub.v1.ProjectTopicName;\n+import com.google.pubsub.v1.PubsubMessage;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+// [END functions_ocr_process]\n+\n+public class OcrProcessImage implements BackgroundFunction<GcsEvent> {\n+  // TODO<developer> set these environment variables\n+  private static final String PROJECT_ID = System.getenv(\"GCP_PROJECT\");\n+  private static final String TRANSLATE_TOPIC_NAME = System.getenv(\"TRANSLATE_TOPIC\");\n+  private static final String[] TO_LANGS = System.getenv(\"TO_LANG\").split(\",\");\n+\n+  private static final Logger LOGGER = Logger.getLogger(OcrProcessImage.class.getName());\n+  private static final String LOCATION_NAME = LocationName.of(PROJECT_ID, \"global\").toString();\n+  private Publisher publisher;\n+  private static final Gson gson = new Gson();\n+\n+  public OcrProcessImage() throws IOException {\n+    publisher = Publisher.newBuilder(\n+        ProjectTopicName.of(PROJECT_ID, TRANSLATE_TOPIC_NAME)).build();\n+  }\n+\n+  // [START functions_ocr_process]\n+  @Override\n+  public void accept(GcsEvent gcsEvent, Context context) {\n+\n+    // Validate parameters\n+    String bucket = gcsEvent.getBucket();\n+    if (bucket == null) {\n+      throw new IllegalArgumentException(\"Missing bucket parameter\");\n+    }\n+    String filename = gcsEvent.getName();\n+    if (filename == null) {\n+      throw new IllegalArgumentException(\"Missing name parameter\");\n+    }\n+\n+    detectText(bucket, filename);\n+  }\n+  // [END functions_ocr_process]\n+\n+  // [START functions_ocr_detect]\n+  private void detectText(String bucket, String filename) {\n+    LOGGER.info(\"Looking for text in image \" + filename);\n+\n+    List<AnnotateImageRequest> visionRequests = new ArrayList<>();\n+    String gcsPath = String.format(\"gs://%s/%s\", bucket, filename);\n+\n+    ImageSource imgSource = ImageSource.newBuilder().setGcsImageUri(gcsPath).build();\n+    Image img = Image.newBuilder().setSource(imgSource).build();\n+\n+    Feature textFeature = Feature.newBuilder().setType(Feature.Type.TEXT_DETECTION).build();\n+    AnnotateImageRequest visionRequest =\n+        AnnotateImageRequest.newBuilder().addFeatures(textFeature).setImage(img).build();\n+    visionRequests.add(visionRequest);\n+\n+    // Detect text in an image using the Cloud Vision API\n+    AnnotateImageResponse visionResponse;\n+    try (ImageAnnotatorClient client = ImageAnnotatorClient.create()) {\n+      visionResponse = client.batchAnnotateImages(visionRequests).getResponses(0);\n+      if (visionResponse == null || !visionResponse.hasFullTextAnnotation()) {\n+        LOGGER.info(String.format(\"Image %s contains no text\", filename));\n+        return;\n+      }\n+\n+      if (visionResponse.hasError()) {\n+        // Throw IOException; to be handled by catch block below\n+        throw new IOException(visionResponse.getError().getMessage());", "originalCommit": "4272f897c403f64aecdd5ae939997bcbeb27d74c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzODE3OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2552#discussion_r403338178", "bodyText": "Added a separate logging statement instead - PTAL?", "author": "ace-n", "createdAt": "2020-04-03T21:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNTY3OA=="}], "type": "inlineReview"}, {"oid": "299fced61da01c0ae4b649b4e5d3ee5d36e4c03c", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/299fced61da01c0ae4b649b4e5d3ee5d36e4c03c", "message": "Address comments", "committedDate": "2020-04-03T21:11:19Z", "type": "commit"}, {"oid": "84acc9ca7ccf81bca0decf52e7c7338f987bff27", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/84acc9ca7ccf81bca0decf52e7c7338f987bff27", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-03T21:13:21Z", "type": "commit"}, {"oid": "bad4877d5a5f9a405ffa6dd3bdf7b6a6d12dff3c", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/bad4877d5a5f9a405ffa6dd3bdf7b6a6d12dff3c", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-03T22:28:53Z", "type": "commit"}, {"oid": "01b4a5663dea03fd0f81281f1a123b8fdd20c3e8", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/01b4a5663dea03fd0f81281f1a123b8fdd20c3e8", "message": "Update shared config", "committedDate": "2020-04-03T22:38:42Z", "type": "commit"}, {"oid": "a5724df630ca56fb5a1ca3118f84d21622b35508", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a5724df630ca56fb5a1ca3118f84d21622b35508", "message": "Merge branch 'gcf-ocr' of http://github.com/GoogleCloudPlatform/java-docs-samples into gcf-ocr", "committedDate": "2020-04-03T22:38:53Z", "type": "commit"}, {"oid": "0eaafb25fd1d91739f3db9884566f360dd99c3ac", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/0eaafb25fd1d91739f3db9884566f360dd99c3ac", "message": "Fix checkstyle typo", "committedDate": "2020-04-04T00:26:59Z", "type": "commit"}, {"oid": "289c3a4acfa7e3b2695651d5a0c686fdaca1a543", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/289c3a4acfa7e3b2695651d5a0c686fdaca1a543", "message": "Merge branch 'master' into gcf-ocr", "committedDate": "2020-04-06T00:20:29Z", "type": "commit"}]}