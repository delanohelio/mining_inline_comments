{"pr_number": 2559, "pr_title": "docs: add additional samples for Spanner JDBC", "pr_createdAt": "2020-04-03T17:27:26Z", "pr_url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559", "timeline": [{"oid": "08470fcd1fbd7f1ddd9309f1076c5f54a1ddcfe0", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/08470fcd1fbd7f1ddd9309f1076c5f54a1ddcfe0", "message": "docs: add additional samples for Spanner JDBC", "committedDate": "2020-04-10T05:48:13Z", "type": "commit"}, {"oid": "a3a78b67b9a09fe3eb82bee9434e9626fffae85c", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a3a78b67b9a09fe3eb82bee9434e9626fffae85c", "message": "fix: fix checkstyle problems", "committedDate": "2020-04-10T05:48:13Z", "type": "commit"}, {"oid": "229597f9068ee3f4f69fb0e430a244643bac6cb5", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/229597f9068ee3f4f69fb0e430a244643bac6cb5", "message": "fix: remove code tags", "committedDate": "2020-04-10T05:48:13Z", "type": "commit"}, {"oid": "6f4ffe6fea7e4db3be52e141806fc2c1dc0bf357", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/6f4ffe6fea7e4db3be52e141806fc2c1dc0bf357", "message": "fix: add a small wait to prevent flaky failures", "committedDate": "2020-04-10T05:48:13Z", "type": "commit"}, {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "message": "refactor: follow the current sample style", "committedDate": "2020-04-10T14:13:55Z", "type": "commit"}, {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "message": "refactor: follow the current sample style", "committedDate": "2020-04-10T14:13:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzEwNg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r406867106", "bodyText": "I'm sure there will be text explaining this in the docs, but a comment or two might be helpful here.", "author": "lesv", "createdAt": "2020-04-10T17:45:20Z", "path": "spanner/jdbc/src/main/java/com/example/spanner/jdbc/CreateConnectionWithCustomHostExample.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.spanner.jdbc;\n+\n+import com.google.cloud.spanner.jdbc.CloudSpannerJdbcConnection;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+\n+class CreateConnectionWithCustomHostExample {\n+\n+  static void createConnectionWithCustomHost() throws SQLException {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"my-project\";\n+    String instanceId = \"my-instance\";\n+    String databaseId = \"my-database\";\n+    int port = 9020;\n+    createConnectionWithCustomHost(projectId, instanceId, databaseId, port);\n+  }\n+\n+  @SuppressFBWarnings(\n+      value = \"OBL_UNSATISFIED_OBLIGATION\",\n+      justification = \"https://github.com/spotbugs/spotbugs/issues/293\")\n+  // Creates a JDBC connection to a Cloud Spanner database on a custom host.\n+  static void createConnectionWithCustomHost(\n+      String projectId, String instanceId, String databaseId, int port) throws SQLException {\n+    try (Connection connection =\n+        DriverManager.getConnection(\n+            String.format(\n+                \"jdbc:cloudspanner://localhost:%d/projects/%s/instances/%s/databases/%s\"\n+                    + \"?usePlainText=true\",", "originalCommit": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM2MDU2Ng==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r407360566", "bodyText": "Good point, added a comment explaining the usePlainText property.", "author": "olavloite", "createdAt": "2020-04-13T07:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2ODY4Nw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r406868687", "bodyText": "It appears the assumption is that it will eventually succeed, that might not be true in all cases.  Or is it?", "author": "lesv", "createdAt": "2020-04-10T17:49:26Z", "path": "spanner/jdbc/src/main/java/com/example/spanner/jdbc/TransactionWithRetryLoopExample.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.spanner.jdbc;\n+\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.jdbc.CloudSpannerJdbcConnection;\n+import com.google.cloud.spanner.jdbc.JdbcSqlExceptionFactory.JdbcAbortedException;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+\n+class TransactionWithRetryLoopExample {\n+\n+  static void transactionWithRetryLoop() throws SQLException {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"my-project\";\n+    String instanceId = \"my-instance\";\n+    String databaseId = \"my-database\";\n+    transactionWithRetryLoop(projectId, instanceId, databaseId);\n+  }\n+\n+  static void transactionWithRetryLoop(String projectId, String instanceId, String databaseId)\n+      throws SQLException {\n+    // Create a connection that has automatic retry for aborted transactions disabled.\n+    String connectionUrl =\n+        String.format(\n+            \"jdbc:cloudspanner:/projects/%s/instances/%s/databases/%s\"\n+                + \";retryAbortsInternally=false\",\n+            projectId, instanceId, databaseId);\n+    long singerId = 31;\n+    long albumId = 11;\n+    try (Connection connection = DriverManager.getConnection(connectionUrl)) {\n+      while (true) {\n+        try {\n+          CloudSpannerJdbcConnection spannerConnection =\n+              connection.unwrap(CloudSpannerJdbcConnection.class);\n+          spannerConnection.setAutoCommit(false);\n+          Mutation mutationSingers =\n+              Mutation.newInsertBuilder(\"Singers\")\n+                  .set(\"SingerId\")\n+                  .to(singerId)\n+                  .set(\"FirstName\")\n+                  .to(\"Breanna\")\n+                  .set(\"LastName\")\n+                  .to(\"Fountain\")\n+                  .build();\n+          Mutation mutationAlbums =\n+              Mutation.newInsertBuilder(\"Albums\")\n+                  .set(\"SingerId\")\n+                  .to(singerId)\n+                  .set(\"AlbumId\")\n+                  .to(albumId)\n+                  .set(\"AlbumTitle\")\n+                  .to(\"No discounts\")\n+                  .set(\"MarketingBudget\")\n+                  .to(1000)\n+                  .build();\n+          spannerConnection.bufferedWrite(Arrays.asList(mutationSingers, mutationAlbums));\n+          spannerConnection.commit();\n+          System.out.printf(\n+              \"Transaction committed at [%s]%n\", spannerConnection.getCommitTimestamp().toString());\n+          break;\n+        } catch (JdbcAbortedException e) {\n+          // Transaction aborted, retry.\n+          System.out.println(\"Transaction aborted, starting retry\");\n+        }", "originalCommit": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM1NzU0Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r407357543", "bodyText": "It will always eventually succeed, or fail with a different error than Aborted. The JDBC transactions use a Spanner TransactionManager under the hood, which should be used with a loop like this:\nhttps://github.com/googleapis/java-spanner/blob/c8be7b5d43c01f6170eb02c6e8cc146cb2597ecc/google-cloud-spanner/src/main/java/com/google/cloud/spanner/DatabaseClient.java#L252-L279", "author": "olavloite", "createdAt": "2020-04-13T07:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2ODY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2OTU5NA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r406869594", "bodyText": "I really like this, but I wonder again if an infinite loop is possible here?", "author": "lesv", "createdAt": "2020-04-10T17:51:32Z", "path": "spanner/jdbc/src/main/java/com/example/spanner/jdbc/TransactionWithRetryLoopUsingOnlyJdbcExample.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.spanner.jdbc;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.grpc.Status.Code;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+class TransactionWithRetryLoopUsingOnlyJdbcExample {\n+\n+  static void genericJdbcTransactionWithRetryLoop() throws SQLException {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"my-project\";\n+    String instanceId = \"my-instance\";\n+    String databaseId = \"my-database\";\n+    genericJdbcTransactionWithRetryLoop(projectId, instanceId, databaseId);\n+  }\n+\n+  @SuppressFBWarnings(value = \"SIL_SQL_IN_LOOP\")\n+  static void genericJdbcTransactionWithRetryLoop(\n+      String projectId, String instanceId, String databaseId) throws SQLException {\n+    // Create a connection that has automatic retry for aborted transactions disabled.\n+    String connectionUrl =\n+        String.format(\n+            \"jdbc:cloudspanner:/projects/%s/instances/%s/databases/%s\"\n+                + \";retryAbortsInternally=false\",\n+            projectId, instanceId, databaseId);\n+    long singerId = 32;\n+    try (Connection connection = DriverManager.getConnection(connectionUrl)) {\n+      while (true) {\n+        try {\n+          connection.setAutoCommit(false);\n+          try (PreparedStatement ps =\n+              connection.prepareStatement(\n+                  \"INSERT INTO Singers (SingerId, FirstName, LastName) VALUES (?, ?, ?)\")) {\n+            ps.setLong(1, singerId);\n+            ps.setString(2, \"Marsha\");\n+            ps.setString(3, \"Roberts\");\n+            ps.executeUpdate();\n+          }\n+          connection.commit();\n+          try (Statement statement = connection.createStatement();\n+              ResultSet rs = statement.executeQuery(\"SHOW VARIABLE COMMIT_TIMESTAMP\")) {\n+            if (rs.next()) {\n+              System.out.printf(\n+                  \"Transaction committed at [%s]%n\",\n+                  rs.getTimestamp(\"COMMIT_TIMESTAMP\").toString());\n+            }\n+          }\n+          break;\n+        } catch (SQLException e) {\n+          if (e.getErrorCode() == Code.ABORTED.value()) {\n+            // Transaction aborted, retry.\n+            System.out.println(\"Transaction aborted, starting retry\");\n+          } else {\n+            throw e;\n+          }\n+        }", "originalCommit": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM1Nzg4NQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r407357885", "bodyText": "This will also always eventually succeed or fail with a different error code than Aborted.", "author": "olavloite", "createdAt": "2020-04-13T07:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2OTU5NA=="}], "type": "inlineReview"}, {"oid": "821e05e9573d220e9dc03ebe2441261a786002dc", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/821e05e9573d220e9dc03ebe2441261a786002dc", "message": "fix: add comment for usePlainText", "committedDate": "2020-04-13T08:01:07Z", "type": "commit"}]}