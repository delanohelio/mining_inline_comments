{"pr_number": 4286, "pr_title": "feat(kms): add integrity verification to samples of crypto operations", "pr_createdAt": "2020-11-19T22:20:06Z", "pr_url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286", "timeline": [{"oid": "30accb2a775cd8e611798a1eedac50d9e7eb6d29", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/30accb2a775cd8e611798a1eedac50d9e7eb6d29", "message": "feat(kms): add integrity verification to samples of crypto operations", "committedDate": "2020-11-19T22:06:26Z", "type": "commit"}, {"oid": "7279c3e30e859ee8584894ba7519d730de06300b", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/7279c3e30e859ee8584894ba7519d730de06300b", "message": "Populate plaintextCrc32c in EncryptSymmetric.java", "committedDate": "2020-11-20T02:04:28Z", "type": "commit"}, {"oid": "c075079dbed2916984d5a69b6468a42937ca6403", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/c075079dbed2916984d5a69b6468a42937ca6403", "message": "Fix guava dependency", "committedDate": "2020-11-20T02:13:43Z", "type": "commit"}, {"oid": "1da5ce85afac66aa3e92966ecaed7b3732bab319", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/1da5ce85afac66aa3e92966ecaed7b3732bab319", "message": "Fix build errors", "committedDate": "2020-11-20T16:11:46Z", "type": "commit"}, {"oid": "ca9b00951915c87a587db6ef322e4ac8200e8486", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ca9b00951915c87a587db6ef322e4ac8200e8486", "message": "Fix some more build errors", "committedDate": "2020-11-20T17:51:22Z", "type": "commit"}, {"oid": "50419adfca5b74f956c55c73f9317b80338695d4", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/50419adfca5b74f956c55c73f9317b80338695d4", "message": "Fix Int64Value construction", "committedDate": "2020-11-20T18:09:59Z", "type": "commit"}, {"oid": "12352dfa4e8660677a00a93d55bed282be5bcf79", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/12352dfa4e8660677a00a93d55bed282be5bcf79", "message": "Add protobuf-java dependency", "committedDate": "2020-11-20T18:33:40Z", "type": "commit"}, {"oid": "f542e419e8e954f1e0ba99be4ab1910e59fd4c95", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/f542e419e8e954f1e0ba99be4ab1910e59fd4c95", "message": "fix typo", "committedDate": "2020-11-20T18:40:00Z", "type": "commit"}, {"oid": "b6edef4852a6cbfb465642073d33da7b4bb5224f", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b6edef4852a6cbfb465642073d33da7b4bb5224f", "message": "Test implicit Int64Value construction", "committedDate": "2020-11-20T18:46:10Z", "type": "commit"}, {"oid": "b03a8bf8e948aee7e6b0b2d83b91c0a859275d93", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b03a8bf8e948aee7e6b0b2d83b91c0a859275d93", "message": "Add EncryptResponse integrity verification", "committedDate": "2020-11-20T19:07:28Z", "type": "commit"}, {"oid": "9fab0d40413c343c6d2d244d094619a6880d1c61", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/9fab0d40413c343c6d2d244d094619a6880d1c61", "message": "Deal with long to int implicit conversion", "committedDate": "2020-11-20T19:15:49Z", "type": "commit"}, {"oid": "769f50452bff88b166c7c622999e07d607dd738e", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/769f50452bff88b166c7c622999e07d607dd738e", "message": "One more lossy conversion", "committedDate": "2020-11-20T19:23:20Z", "type": "commit"}, {"oid": "918476715bcb075fd59d85d5526abb07f370a853", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/918476715bcb075fd59d85d5526abb07f370a853", "message": "Test something", "committedDate": "2020-11-20T20:26:14Z", "type": "commit"}, {"oid": "95171b717a7b4c87d73dbc038c57ff98e943229c", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/95171b717a7b4c87d73dbc038c57ff98e943229c", "message": "Fix IllegalStateException caused by fetching Long from HashCode", "committedDate": "2020-11-20T21:00:45Z", "type": "commit"}, {"oid": "6301fc89ad552f7415c78696f6688e9a78d9ed60", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/6301fc89ad552f7415c78696f6688e9a78d9ed60", "message": "Cleanup EncryptSymmetric.java", "committedDate": "2020-11-20T22:34:31Z", "type": "commit"}, {"oid": "28c298101b72d8c9d5aa5c7a99a4ecaa183b1ddd", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/28c298101b72d8c9d5aa5c7a99a4ecaa183b1ddd", "message": "Fix build error", "committedDate": "2020-11-20T22:41:28Z", "type": "commit"}, {"oid": "9de9abacffe1f0b437c393d5024cd9e611095820", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/9de9abacffe1f0b437c393d5024cd9e611095820", "message": "Add print outs to debug ciphertext checksum mismatch", "committedDate": "2020-11-21T02:55:20Z", "type": "commit"}, {"oid": "e77e22cca04a3173e8bed87efc463a7ce1eea2fd", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/e77e22cca04a3173e8bed87efc463a7ce1eea2fd", "message": "Some more debug prints", "committedDate": "2020-11-21T03:12:05Z", "type": "commit"}, {"oid": "30668dcb3a2a3dba62d41d13c26923eba3c528e8", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/30668dcb3a2a3dba62d41d13c26923eba3c528e8", "message": "ugghhh I should really quit already", "committedDate": "2020-11-21T03:19:05Z", "type": "commit"}, {"oid": "749ec0f3ca68d23e1527b070c68972c418f28b80", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/749ec0f3ca68d23e1527b070c68972c418f28b80", "message": "Remove my hardcoded test project", "committedDate": "2020-11-23T14:31:57Z", "type": "commit"}, {"oid": "37a194bd0d3642a655952186b92badd0c98488eb", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/37a194bd0d3642a655952186b92badd0c98488eb", "message": "Remove test plaintext override", "committedDate": "2020-11-23T14:53:31Z", "type": "commit"}, {"oid": "1f5772561f03827a4439e22a4d27c2157032587e", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/1f5772561f03827a4439e22a4d27c2157032587e", "message": "Comment out debug print outs", "committedDate": "2020-11-23T15:02:38Z", "type": "commit"}, {"oid": "604b79bee6956ee55d72dfa5a23f8afc6327d610", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/604b79bee6956ee55d72dfa5a23f8afc6327d610", "message": "Clean up debug print outs", "committedDate": "2020-11-23T15:38:54Z", "type": "commit"}, {"oid": "2a5e72209acc3a829162e885f90df4c456218341", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/2a5e72209acc3a829162e885f90df4c456218341", "message": "Add integrity verification to DecryptSymmetric.java", "committedDate": "2020-11-23T17:10:25Z", "type": "commit"}, {"oid": "8ca4f130b83c2cf35cda2d726fdafcb0ef10065f", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/8ca4f130b83c2cf35cda2d726fdafcb0ef10065f", "message": "Fix imports in DecryptSymmetric.java", "committedDate": "2020-11-23T17:23:49Z", "type": "commit"}, {"oid": "4a003e3d789dbfa982d5576a90d1df4cf06eb09d", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/4a003e3d789dbfa982d5576a90d1df4cf06eb09d", "message": "Add integrity verification to AsymmetricDecrypt", "committedDate": "2020-11-23T17:42:02Z", "type": "commit"}, {"oid": "806d957790fd343771b2428ff7c705b126a1f264", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/806d957790fd343771b2428ff7c705b126a1f264", "message": "Fix build error by adding explicit conversion to string", "committedDate": "2020-11-23T17:56:58Z", "type": "commit"}, {"oid": "6236370a359a5a7ea2cafa9131282e41442596f5", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/6236370a359a5a7ea2cafa9131282e41442596f5", "message": "Add integrity verification to GetPublicKey.java", "committedDate": "2020-11-23T18:13:15Z", "type": "commit"}, {"oid": "1a430e4a5ffc8de3c1cbe14e089e0c0c44f689b2", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/1a430e4a5ffc8de3c1cbe14e089e0c0c44f689b2", "message": "Fix build error", "committedDate": "2020-11-23T18:50:53Z", "type": "commit"}, {"oid": "dacd8c96f08a082ddf3feceae91dc6ca8b690744", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/dacd8c96f08a082ddf3feceae91dc6ca8b690744", "message": "Add integrity verification to SignAsymmetric.java", "committedDate": "2020-11-23T19:17:20Z", "type": "commit"}, {"oid": "6963c4e00b743b4c89a2ef222a2e017da352efcb", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/6963c4e00b743b4c89a2ef222a2e017da352efcb", "message": "Remove response handling from try block to see impact on failing tests", "committedDate": "2020-11-23T19:53:18Z", "type": "commit"}, {"oid": "a41da3854fe3c54fad2a8ba0522d6bce5924ad65", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a41da3854fe3c54fad2a8ba0522d6bce5924ad65", "message": "Fix build error", "committedDate": "2020-11-23T20:00:22Z", "type": "commit"}, {"oid": "77b22c2f7f9f851eee1706fc531524afc780ba30", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/77b22c2f7f9f851eee1706fc531524afc780ba30", "message": "Add -e to mvn command and experiment with prints to STDERR", "committedDate": "2020-11-23T20:17:42Z", "type": "commit"}, {"oid": "b00198e6ab7646e880dc4e2cfc6a7da9219471fb", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b00198e6ab7646e880dc4e2cfc6a7da9219471fb", "message": "Add -Dsurefire.useFile=false to run_tests.sh", "committedDate": "2020-11-23T22:09:46Z", "type": "commit"}, {"oid": "b9b071361b10b195f4191e6f63885958aa236374", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b9b071361b10b195f4191e6f63885958aa236374", "message": "Add -D.failsafe.useFile=false flag to run_tests.sh", "committedDate": "2020-11-23T22:20:36Z", "type": "commit"}, {"oid": "bc866b832d1b627f58549d2b59e4dec1571375ce", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/bc866b832d1b627f58549d2b59e4dec1571375ce", "message": "Add some debug prints", "committedDate": "2020-11-23T22:39:33Z", "type": "commit"}, {"oid": "a69dd25179e19a1937140d50abc7045c4678c974", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a69dd25179e19a1937140d50abc7045c4678c974", "message": "Fix build error", "committedDate": "2020-11-23T22:49:54Z", "type": "commit"}, {"oid": "48d3d418f2cdef44c24f34041a15cc33d5d25374", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/48d3d418f2cdef44c24f34041a15cc33d5d25374", "message": "Adjust string to bytes[] conversion", "committedDate": "2020-11-23T23:00:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1MzUzMg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r529053532", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return (long) Hashing.crc32c().hashBytes(data).asInt();\n          \n          \n            \n                return Hashing.crc32c().hashBytes(data).padToLong();", "author": "shubha-rajan", "createdAt": "2020-11-23T23:05:39Z", "path": "kms/src/main/java/kms/EncryptSymmetric.java", "diffHunk": "@@ -38,20 +45,63 @@ public void encryptSymmetric() throws IOException {\n   // Encrypt data with a given key.\n   public void encryptSymmetric(\n       String projectId, String locationId, String keyRingId, String keyId, String plaintext)\n-      throws IOException {\n+      throws IOException, Exception {\n+\n+    System.err.println(\"TAMJAM1: \" + projectId);\n+\n     // Initialize client that will be used to send requests. This client only\n     // needs to be created once, and can be reused for multiple requests. After\n     // completing all of your requests, call the \"close\" method on the client to\n     // safely clean up any remaining background resources.\n+    EncryptResponse response;\n     try (KeyManagementServiceClient client = KeyManagementServiceClient.create()) {\n-      // Build the key version name from the project, location, key ring, key,\n-      // and key version.\n-      CryptoKeyName keyVersionName = CryptoKeyName.of(projectId, locationId, keyRingId, keyId);\n+      // Build the key name from the project, location, key ring, and key.\n+      CryptoKeyName cryptoKeyName = CryptoKeyName.of(projectId, locationId, keyRingId, keyId);\n+\n+      // Convert plaintext to ByteString.\n+      ByteString plaintextByteString = ByteString.copyFromUtf8(plaintext);\n+\n+      // Optional, but recommended: compute plaintext's CRC32C. See helper below.\n+      long plaintextCrc32c = getCrc32cAsLong(plaintextByteString.toByteArray());\n \n       // Encrypt the plaintext.\n-      EncryptResponse response = client.encrypt(keyVersionName, ByteString.copyFromUtf8(plaintext));\n-      System.out.printf(\"Ciphertext: %s%n\", response.getCiphertext().toStringUtf8());\n+      EncryptRequest request = EncryptRequest.newBuilder()\n+                               .setName(cryptoKeyName.toString())\n+                               .setPlaintext(plaintextByteString)\n+                               .setPlaintextCrc32C(\n+                                   Int64Value.newBuilder().setValue(plaintextCrc32c).build())\n+                               .build();\n+      response = client.encrypt(request);\n+    } catch (Exception e) {\n+      throw e;\n+    }\n+    // Optional, but recommended: perform integrity verification on response.\n+    // For more details on ensuring E2E in-transit integrity to and from Cloud KMS visit:\n+    // https://cloud.google.com/kms/docs/data-integrity-guidelines\n+    System.err.println(\"TAMJAM2\");\n+    if (!response.getVerifiedPlaintextCrc32C()) {\n+      throw new IOException(\"Encrypt: request to server corrupted\");\n     }\n+\n+    // See helper below.\n+    if (!crcMatches(response.getCiphertextCrc32C().getValue(),\n+        response.getCiphertext().toByteArray())) {\n+      String details = String.format(\n+          \"Excpected=%d, Actual=%d, getCrc32cAsLong(test)=%d%n\",\n+          response.getCiphertextCrc32C().getValue(), getCrc32cAsLong(response.getCiphertext().toByteArray()),\n+          getCrc32cAsLong(\"test\"));\n+      throw new IOException(\"Encrypt: response from server corrupted. \" + details);\n+    }\n+\n+    System.out.printf(\"Ciphertext: %s%n\", response.getCiphertext().toStringUtf8());\n+  }\n+\n+  private long getCrc32cAsLong(byte[] data) {\n+    return (long) Hashing.crc32c().hashBytes(data).asInt();", "originalCommit": "a69dd25179e19a1937140d50abc7045c4678c974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1MzY4NA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r529053684", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return (long) Hashing.crc32c().hashBytes(data).asInt();\n          \n          \n            \n                return Hashing.crc32c().hashBytes(data).padToLong();", "author": "shubha-rajan", "createdAt": "2020-11-23T23:06:00Z", "path": "kms/src/main/java/kms/GetPublicKey.java", "diffHunk": "@@ -51,8 +55,30 @@ public void getPublicKey(\n \n       // Get the public key.\n       PublicKey publicKey = client.getPublicKey(keyVersionName);\n+\n+      // Optional, but recommended: perform integrity verification on response.\n+      // For more details on ensuring E2E in-transit integrity to and from Cloud KMS visit:\n+      // https://cloud.google.com/kms/docs/data-integrity-guidelines\n+      if (!publicKey.getName().equals(keyVersionName.toString())) {\n+        throw new IOException(\"GetPublicKey: request to server corrupted\");\n+      }\n+\n+      // See helper below.\n+      if (!crcMatches(publicKey.getPemCrc32C().getValue(),\n+          publicKey.getPemBytes().toByteArray())) {\n+        throw new IOException(\"GetPublicKey: response from server corrupted\");\n+      }\n+\n       System.out.printf(\"Public key: %s%n\", publicKey.getPem());\n     }\n   }\n+\n+  private long getCrc32cAsLong(byte[] data) {\n+    return (long) Hashing.crc32c().hashBytes(data).asInt();", "originalCommit": "a69dd25179e19a1937140d50abc7045c4678c974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1Mzc5Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r529053793", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return (long) Hashing.crc32c().hashBytes(data).asInt();\n          \n          \n            \n                return Hashing.crc32c().hashBytes(data).padToLong();", "author": "shubha-rajan", "createdAt": "2020-11-23T23:06:17Z", "path": "kms/src/main/java/kms/SignAsymmetric.java", "diffHunk": "@@ -70,14 +75,44 @@ public void signAsymmetric(\n       // Build the digest object.\n       Digest digest = Digest.newBuilder().setSha256(ByteString.copyFrom(hash)).build();\n \n+      // Optional, but recommended: compute digest's CRC32C. See helper below.\n+      long digestCrc32c = getCrc32cAsLong(hash);\n+\n       // Sign the digest.\n-      AsymmetricSignResponse result = client.asymmetricSign(keyVersionName, digest);\n+      AsymmetricSignRequest request =\n+          AsymmetricSignRequest.newBuilder()\n+              .setName(keyVersionName.toString())\n+              .setDigest(digest)\n+              .setDigestCrc32C(Int64Value.newBuilder().setValue(digestCrc32c).build())\n+              .build();\n+      AsymmetricSignResponse response = client.asymmetricSign(request);\n+\n+      // Optional, but recommended: perform integrity verification on response.\n+      // For more details on ensuring E2E in-transit integrity to and from Cloud KMS visit:\n+      // https://cloud.google.com/kms/docs/data-integrity-guidelines\n+      if (!response.getVerifiedDigestCrc32C()) {\n+        throw new IOException(\"Encrypt: request to server corrupted\");\n+      }\n+\n+      // See helper below.\n+      if (!crcMatches(response.getSignatureCrc32C().getValue(),\n+          response.getSignature().toByteArray())) {\n+        throw new IOException(\"Encrypt: response from server corrupted\");\n+      }\n \n       // Get the signature.\n-      byte[] signature = result.getSignature().toByteArray();\n+      byte[] signature = response.getSignature().toByteArray();\n \n       System.out.printf(\"Signature %s%n\", signature);\n     }\n   }\n+\n+  private long getCrc32cAsLong(byte[] data) {\n+    return (long) Hashing.crc32c().hashBytes(data).asInt();", "originalCommit": "a69dd25179e19a1937140d50abc7045c4678c974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1NDE0Mg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r529054142", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return (long) Hashing.crc32c().hashBytes(data).asInt();\n          \n          \n            \n                return Hashing.crc32c().hashBytes(data).padToLong();", "author": "shubha-rajan", "createdAt": "2020-11-23T23:07:08Z", "path": "kms/src/main/java/kms/DecryptSymmetric.java", "diffHunk": "@@ -44,14 +51,40 @@ public void decryptSymmetric(\n     // completing all of your requests, call the \"close\" method on the client to\n     // safely clean up any remaining background resources.\n     try (KeyManagementServiceClient client = KeyManagementServiceClient.create()) {\n-      // Build the key version name from the project, location, key ring, and\n-      // key.\n+      // Build the key version from the project, location, key ring, and key.\n       CryptoKeyName keyName = CryptoKeyName.of(projectId, locationId, keyRingId, keyId);\n \n-      // Decrypt the response.\n-      DecryptResponse response = client.decrypt(keyName, ByteString.copyFrom(ciphertext));\n+      // Optional, but recommended: compute ciphertext's CRC32C. See helpers below.\n+      long ceiphertextCrc32c = getCrc32cAsLong(ciphertext);\n+\n+      // Decrypt the ciphertext.\n+      DecryptRequest request =\n+          DecryptRequest.newBuilder()\n+              .setName(keyName.toString())\n+              .setCiphertext(ByteString.copyFrom(ciphertext))\n+              .setCiphertextCrc32C(\n+                  Int64Value.newBuilder().setValue(ceiphertextCrc32c).build())\n+              .build();\n+      DecryptResponse response = client.decrypt(request);\n+\n+      // Optional, but recommended: perform integrity verification on response.\n+      // For more details on ensuring E2E in-transit integrity to and from Cloud KMS visit:\n+      // https://cloud.google.com/kms/docs/data-integrity-guidelines\n+      if (!crcMatches(response.getPlaintextCrc32C().getValue(),\n+          response.getPlaintext().toByteArray())) {\n+        throw new IOException(\"Decrypt: response from server corrupted, getCrc32cAsLong(test)=\" + getCrc32cAsLong(\"test\"));\n+      }\n+\n       System.out.printf(\"Plaintext: %s%n\", response.getPlaintext().toStringUtf8());\n     }\n   }\n+\n+  private long getCrc32cAsLong(byte[] data) {\n+    return (long) Hashing.crc32c().hashBytes(data).asInt();", "originalCommit": "a69dd25179e19a1937140d50abc7045c4678c974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1NDIxNA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r529054214", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return (long) Hashing.crc32c().hashBytes(data).asInt();\n          \n          \n            \n                return Hashing.crc32c().hashBytes(data).padToLong();", "author": "shubha-rajan", "createdAt": "2020-11-23T23:07:21Z", "path": "kms/src/main/java/kms/DecryptAsymmetric.java", "diffHunk": "@@ -56,11 +61,41 @@ public void decryptAsymmetric(\n       CryptoKeyVersionName keyVersionName =\n           CryptoKeyVersionName.of(projectId, locationId, keyRingId, keyId, keyVersionId);\n \n+      // Optional, but recommended: compute ciphertext's CRC32C. See helpers below.\n+      long ceiphertextCrc32c = getCrc32cAsLong(ciphertext);\n+\n       // Decrypt the ciphertext.\n-      AsymmetricDecryptResponse response =\n-          client.asymmetricDecrypt(keyVersionName, ByteString.copyFrom(ciphertext));\n+      AsymmetricDecryptRequest request =\n+          AsymmetricDecryptRequest.newBuilder()\n+              .setName(keyVersionName.toString())\n+              .setCiphertext(ByteString.copyFrom(ciphertext))\n+              .setCiphertextCrc32C(\n+                  Int64Value.newBuilder().setValue(ceiphertextCrc32c).build())\n+              .build();\n+      AsymmetricDecryptResponse response = client.asymmetricDecrypt(request);\n+\n+      // Optional, but recommended: perform integrity verification on response.\n+      // For more details on ensuring E2E in-transit integrity to and from Cloud KMS visit:\n+      // https://cloud.google.com/kms/docs/data-integrity-guidelines\n+      if (!response.getVerifiedCiphertextCrc32C()) {\n+        throw new IOException(\"AsymmetricDecrypt: request to server corrupted\");\n+      }\n+\n+      if (!crcMatches(response.getPlaintextCrc32C().getValue(),\n+          response.getPlaintext().toByteArray())) {\n+        throw new IOException(\"AsymmetricDecrypt: response from server corrupted\");\n+      }\n+\n       System.out.printf(\"Plaintext: %s%n\", response.getPlaintext().toStringUtf8());\n     }\n   }\n+\n+  private long getCrc32cAsLong(byte[] data) {\n+    return (long) Hashing.crc32c().hashBytes(data).asInt();", "originalCommit": "a69dd25179e19a1937140d50abc7045c4678c974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1NDc4MA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r529054780", "bodyText": "Any reason you're using asInt() here? I tried this with padToLong() and the tests started to consistently pass. https://guava.dev/releases/19.0/api/docs/com/google/common/hash/HashCode.html#padToLong()", "author": "shubha-rajan", "createdAt": "2020-11-23T23:08:44Z", "path": "kms/src/main/java/kms/DecryptAsymmetric.java", "diffHunk": "@@ -56,11 +61,41 @@ public void decryptAsymmetric(\n       CryptoKeyVersionName keyVersionName =\n           CryptoKeyVersionName.of(projectId, locationId, keyRingId, keyId, keyVersionId);\n \n+      // Optional, but recommended: compute ciphertext's CRC32C. See helpers below.\n+      long ceiphertextCrc32c = getCrc32cAsLong(ciphertext);\n+\n       // Decrypt the ciphertext.\n-      AsymmetricDecryptResponse response =\n-          client.asymmetricDecrypt(keyVersionName, ByteString.copyFrom(ciphertext));\n+      AsymmetricDecryptRequest request =\n+          AsymmetricDecryptRequest.newBuilder()\n+              .setName(keyVersionName.toString())\n+              .setCiphertext(ByteString.copyFrom(ciphertext))\n+              .setCiphertextCrc32C(\n+                  Int64Value.newBuilder().setValue(ceiphertextCrc32c).build())\n+              .build();\n+      AsymmetricDecryptResponse response = client.asymmetricDecrypt(request);\n+\n+      // Optional, but recommended: perform integrity verification on response.\n+      // For more details on ensuring E2E in-transit integrity to and from Cloud KMS visit:\n+      // https://cloud.google.com/kms/docs/data-integrity-guidelines\n+      if (!response.getVerifiedCiphertextCrc32C()) {\n+        throw new IOException(\"AsymmetricDecrypt: request to server corrupted\");\n+      }\n+\n+      if (!crcMatches(response.getPlaintextCrc32C().getValue(),\n+          response.getPlaintext().toByteArray())) {\n+        throw new IOException(\"AsymmetricDecrypt: response from server corrupted\");\n+      }\n+\n       System.out.printf(\"Plaintext: %s%n\", response.getPlaintext().toStringUtf8());\n     }\n   }\n+\n+  private long getCrc32cAsLong(byte[] data) {\n+    return (long) Hashing.crc32c().hashBytes(data).asInt();", "originalCommit": "a69dd25179e19a1937140d50abc7045c4678c974", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6cbef71947d980bec849aa572ad423dd20dc90ae", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/6cbef71947d980bec849aa572ad423dd20dc90ae", "message": "Try HashCode.padToLong in EncryptSymmetric and DecryptSymmetric", "committedDate": "2020-11-24T00:19:28Z", "type": "commit"}, {"oid": "61fd19cc88222e67cdaf6dfcac59c0b605589fe6", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/61fd19cc88222e67cdaf6dfcac59c0b605589fe6", "message": "Clean up debug traces", "committedDate": "2020-11-24T00:35:25Z", "type": "commit"}, {"oid": "42e0c059ac9d12ef036f9c5a96bdf1878b767579", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/42e0c059ac9d12ef036f9c5a96bdf1878b767579", "message": "Fix compilation issue", "committedDate": "2020-11-24T00:41:32Z", "type": "commit"}, {"oid": "a6deacfcbae09934a05f75e2f82fb9e700b845d0", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a6deacfcbae09934a05f75e2f82fb9e700b845d0", "message": "Clean up some more", "committedDate": "2020-11-24T01:46:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE5NjI3OA==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r529196278", "bodyText": "This spelling error shows up in a few other places. I'd suggest doing a global find/replace\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long ceiphertextCrc32c = getCrc32cAsLong(ciphertext);\n          \n          \n            \n                  long ciphertextCrc32c = getCrc32cAsLong(ciphertext);", "author": "shubha-rajan", "createdAt": "2020-11-24T04:33:57Z", "path": "kms/src/main/java/kms/DecryptAsymmetric.java", "diffHunk": "@@ -56,11 +61,41 @@ public void decryptAsymmetric(\n       CryptoKeyVersionName keyVersionName =\n           CryptoKeyVersionName.of(projectId, locationId, keyRingId, keyId, keyVersionId);\n \n+      // Optional, but recommended: compute ciphertext's CRC32C. See helpers below.\n+      long ceiphertextCrc32c = getCrc32cAsLong(ciphertext);", "originalCommit": "a6deacfcbae09934a05f75e2f82fb9e700b845d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3NDE3OQ==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4286#discussion_r530474179", "bodyText": "Thanks for catching that. Performed a global search/replace.", "author": "iamtamjam", "createdAt": "2020-11-25T15:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE5NjI3OA=="}], "type": "inlineReview"}, {"oid": "1f17d85d2138687d12d2433885aedcbd60da279c", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/1f17d85d2138687d12d2433885aedcbd60da279c", "message": "Fix typo", "committedDate": "2020-11-25T15:47:39Z", "type": "commit"}]}