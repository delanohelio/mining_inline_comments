{"pr_number": 992, "pr_title": "stats: introduce stats client", "pr_createdAt": "2020-07-30T23:11:08Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/992", "timeline": [{"oid": "37370d5e34ef6dd83cc18ad32538897f2ea399e7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/37370d5e34ef6dd83cc18ad32538897f2ea399e7", "message": "update interface\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-07-31T00:07:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzUzMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r463337533", "bodyText": "minor typo s/elemenets/elements/", "author": "goaway", "createdAt": "2020-07-31T00:08:51Z", "path": "library/common/engine.cc", "diffHunk": "@@ -93,6 +93,18 @@ Engine::~Engine() {\n   main_thread_.join();\n }\n \n+void Engine::recordCounter(std::string elemenets, uint64_t count) {", "originalCommit": "37370d5e34ef6dd83cc18ad32538897f2ea399e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzcxNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r463337714", "bodyText": "let's just make the prefix be \"client\" I think", "author": "goaway", "createdAt": "2020-07-31T00:09:23Z", "path": "library/common/engine.cc", "diffHunk": "@@ -93,6 +93,18 @@ Engine::~Engine() {\n   main_thread_.join();\n }\n \n+void Engine::recordCounter(std::string elemenets, uint64_t count) {\n+  if (server_) {\n+    server_->dispatcher().post([this, elemenets, count]() -> void {\n+      std::string client_stats = \"client_stats\";", "originalCommit": "37370d5e34ef6dd83cc18ad32538897f2ea399e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c7d99afec04544315bae76e7b5ad83e841a0dc6d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c7d99afec04544315bae76e7b5ad83e841a0dc6d", "message": "wip\n\nCo-authored-by: Jingwei <57155915+jingwei99@users.noreply.github.com>\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-04T10:30:40Z", "type": "commit"}, {"oid": "8c3c0cd0eaed242db677dcc777838654cc38d802", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8c3c0cd0eaed242db677dcc777838654cc38d802", "message": "update\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-04T10:30:40Z", "type": "commit"}, {"oid": "b804494f898c0656d74822c28e8866ce236b37b1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b804494f898c0656d74822c28e8866ce236b37b1", "message": "update interfaces and implementations\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-04T10:30:40Z", "type": "commit"}, {"oid": "fab1505856a7341f6a2c6a37c5624dd95bba70a2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/fab1505856a7341f6a2c6a37c5624dd95bba70a2", "message": "more files\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-04T10:30:40Z", "type": "commit"}, {"oid": "0213f89234c38e989ce20ffadd644d7f729ebef1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0213f89234c38e989ce20ffadd644d7f729ebef1", "message": "update interface\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-04T10:30:40Z", "type": "commit"}, {"oid": "b54bd6ae2b7c72644f37aa9f7dff9242df14604d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b54bd6ae2b7c72644f37aa9f7dff9242df14604d", "message": "comments\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-04T10:30:40Z", "type": "commit"}, {"oid": "09c6cc1130639c57c4ab74efb96d694b5f0dd032", "url": "https://github.com/envoyproxy/envoy-mobile/commit/09c6cc1130639c57c4ab74efb96d694b5f0dd032", "message": "wip updating Swift interfaces\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-04T10:30:41Z", "type": "commit"}, {"oid": "4ac676ded9c3641d84153af242d97ea87cb146ec", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4ac676ded9c3641d84153af242d97ea87cb146ec", "message": "cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-04T10:31:30Z", "type": "commit"}, {"oid": "4801a0b49c17c9f4e3faed9ebf9dc92cef07ab62", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4801a0b49c17c9f4e3faed9ebf9dc92cef07ab62", "message": "add strong type of element for android\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-04T10:31:30Z", "type": "commit"}, {"oid": "7f71fe512e505ae8ba15572aeb9e20d7290b3eda", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7f71fe512e505ae8ba15572aeb9e20d7290b3eda", "message": "doc for Element\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-04T10:31:30Z", "type": "commit"}, {"oid": "843175a70bc94e84d5c39d87bf434625d9cbe836", "url": "https://github.com/envoyproxy/envoy-mobile/commit/843175a70bc94e84d5c39d87bf434625d9cbe836", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-04T10:33:55Z", "type": "commit"}, {"oid": "843175a70bc94e84d5c39d87bf434625d9cbe836", "url": "https://github.com/envoyproxy/envoy-mobile/commit/843175a70bc94e84d5c39d87bf434625d9cbe836", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-04T10:33:55Z", "type": "forcePushed"}, {"oid": "7d363fbd7c38fa2f67b9f5741f91fdd655a6e670", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7d363fbd7c38fa2f67b9f5741f91fdd655a6e670", "message": "add Swift Element\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-04T20:23:49Z", "type": "commit"}, {"oid": "3ded59b7f4703d4031203fad6e91e6c52a033130", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3ded59b7f4703d4031203fad6e91e6c52a033130", "message": "edit after rebase, forqak android\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-05T16:11:39Z", "type": "commit"}, {"oid": "3ded59b7f4703d4031203fad6e91e6c52a033130", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3ded59b7f4703d4031203fad6e91e6c52a033130", "message": "edit after rebase, forqak android\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-05T16:11:39Z", "type": "forcePushed"}, {"oid": "2d8aa5a5e01b142eccf4decadc819b0524162196", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2d8aa5a5e01b142eccf4decadc819b0524162196", "message": "fix ci (mostly) for android\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-06T01:25:26Z", "type": "commit"}, {"oid": "356390c9fe2f34b336cc2aaeb0f66d3b334fed4d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/356390c9fe2f34b336cc2aaeb0f66d3b334fed4d", "message": "fix up swift Element\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-06T11:28:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MDU1OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466560558", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                engine.getStreamClient().newStreamPrototype()\n          \n          \n            \n                    .setOnResponseHeaders((responseHeaders, endStream) -> {\n          \n          \n            \n                engine.getStreamClient()\n          \n          \n            \n                    .newStreamPrototype()\n          \n          \n            \n                    .setOnResponseHeaders((responseHeaders, endStream) -> {", "author": "buildbreaker", "createdAt": "2020-08-06T17:11:23Z", "path": "examples/java/hello_world/MainActivity.java", "diffHunk": "@@ -76,7 +76,7 @@ private void makeRequest() {\n     RequestHeaders requestHeaders = new RequestHeadersBuilder(RequestMethod.GET, REQUEST_SCHEME,\n                                                               REQUEST_AUTHORITY, REQUEST_PATH)\n                                         .build();\n-    streamClient.newStreamPrototype()\n+    engine.getStreamClient().newStreamPrototype()\n         .setOnResponseHeaders((responseHeaders, endStream) -> {", "originalCommit": "356390c9fe2f34b336cc2aaeb0f66d3b334fed4d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ab5ad2178414c6b512a2fa56f61db73d618ecba", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8ab5ad2178414c6b512a2fa56f61db73d618ecba", "message": "formatting/lint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-06T17:48:17Z", "type": "commit"}, {"oid": "de2891007fedd03e8d099e404573298d13371ad0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/de2891007fedd03e8d099e404573298d13371ad0", "message": "fix iOS example apps\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-06T18:35:01Z", "type": "commit"}, {"oid": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/352fd28fee9f674023da716efcbe0dcea8fdc58c", "message": "fix test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-06T19:36:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1NzI0Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466657247", "bodyText": "I think it'd make sense to group these into a stats subdirectory, similarly to grpc and filters", "author": "rebello95", "createdAt": "2020-08-06T20:07:15Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/BUILD", "diffHunk": "@@ -36,7 +36,11 @@ kt_android_library(\n envoy_mobile_kt_library(\n     name = \"envoy_interfaces_lib\",\n     srcs = glob([\n-        \"EnvoyClient.kt\",\n+        \"Counter.kt\",\n+        \"Element.kt\",", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwOTc3MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467209770", "bodyText": "Sounds good to me.", "author": "goaway", "createdAt": "2020-08-07T18:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1NzI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1Nzk4MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466657981", "bodyText": "Should we provide a default value of 1?", "author": "rebello95", "createdAt": "2020-08-06T20:08:51Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/Counter.kt", "diffHunk": "@@ -0,0 +1,24 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+import java.lang.ref.WeakReference\n+\n+/**\n+ * A stat.\n+ *\n+ * Current the supported stat type is counter, and it can increment.\n+ */\n+class Counter internal constructor(\n+  private val envoyEngine: WeakReference<EnvoyEngine>,\n+  private val elements: List<Element>\n+) {\n+\n+  /**\n+   * Increment the counter by the given count.\n+   */\n+  fun increment(count: Int) {", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MjE1NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466672155", "bodyText": "usually we overload with increment() being increment(1). In favor of that.", "author": "junr03", "createdAt": "2020-08-06T20:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1Nzk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwOTg3Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467209872", "bodyText": "Sounds good.", "author": "goaway", "createdAt": "2020-08-07T18:44:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1Nzk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1ODE4MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466658180", "bodyText": "I assume we will create different types for non-Counter stats, so maybe this docstring can be updated to simply describe the Counter?", "author": "rebello95", "createdAt": "2020-08-06T20:09:20Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/Counter.kt", "diffHunk": "@@ -0,0 +1,24 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+import java.lang.ref.WeakReference\n+\n+/**\n+ * A stat.\n+ *\n+ * Current the supported stat type is counter, and it can increment.", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1ODU0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466658540", "bodyText": "Can you document what the intended value is supposed to be (given the regex below)?", "author": "rebello95", "createdAt": "2020-08-06T20:10:01Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/Element.kt", "diffHunk": "@@ -0,0 +1,16 @@\n+package io.envoyproxy.envoymobile\n+\n+import java.util.regex.Pattern\n+\n+/**\n+ * Element for stats.\n+ */", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1ODc0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466658743", "bodyText": "would it make sense to simply name these streamClient() and statsClient()?", "author": "rebello95", "createdAt": "2020-08-06T20:10:24Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/Engine.kt", "diffHunk": "@@ -0,0 +1,17 @@\n+package io.envoyproxy.envoymobile\n+\n+/**\n+ * The engine for downstream clients to integrate Envoy Mobile\n+ */\n+interface Engine {\n+\n+  /**\n+   *  @return a {@link StreamClient} instance\n+   */\n+  fun getStreamClient(): StreamClient\n+\n+  /**\n+   *  @return a {@link StatsClient} instance\n+   */\n+  fun getStatsClient(): StatsClient", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MDA3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466680077", "bodyText": "@goaway ^", "author": "jingwei99", "createdAt": "2020-08-06T20:53:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1ODc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxMDIwMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467210203", "bodyText": "I'm fine with that.", "author": "goaway", "createdAt": "2020-08-07T18:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1ODc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTE3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466659175", "bodyText": "Similar suggestion here (counter() versus getCounter()?)", "author": "rebello95", "createdAt": "2020-08-06T20:11:20Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/StatsClient.kt", "diffHunk": "@@ -0,0 +1,12 @@\n+package io.envoyproxy.envoymobile\n+\n+/**\n+ * Client used to record timeseries metrics.\n+ */\n+interface StatsClient {\n+\n+  /**\n+   * @return A counter based on the joined elements.\n+   */\n+  fun getCounter(vararg elements: Element): Counter", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxMDU2NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467210564", "bodyText": "Sure, sounds good.", "author": "goaway", "createdAt": "2020-08-07T18:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTY4NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466659684", "bodyText": "Same comments apply to iOS re: grouping and naming", "author": "rebello95", "createdAt": "2020-08-06T20:12:28Z", "path": "library/swift/src/BUILD", "diffHunk": "@@ -5,7 +5,11 @@ licenses([\"notice\"])  # Apache 2\n swift_static_framework(\n     name = \"ios_framework\",\n     srcs = glob([\n-        \"EnvoyClient.swift\",\n+        \"Counter.swift\",\n+        \"Element.swift\",", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTgxNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466659817", "bodyText": "Same docstrings as Android?", "author": "rebello95", "createdAt": "2020-08-06T20:12:44Z", "path": "library/swift/src/Counter.swift", "diffHunk": "@@ -0,0 +1,22 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+@objc\n+public class Counter: NSObject {", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDAzOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466660038", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              internal init(elements: [Element], engine: EnvoyEngine) {\n          \n          \n            \n              init(elements: [Element], engine: EnvoyEngine) {", "author": "rebello95", "createdAt": "2020-08-06T20:13:10Z", "path": "library/swift/src/Counter.swift", "diffHunk": "@@ -0,0 +1,22 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+@objc\n+public class Counter: NSObject {\n+  private let series: String\n+  private weak var engine: EnvoyEngine?\n+\n+  internal init(elements: [Element], engine: EnvoyEngine) {", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDIwMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466660201", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                self.series = elements.map{ $0.description }.joined(separator: \".\")\n          \n          \n            \n                self.series = elements.map { $0.description }.joined(separator: \".\")", "author": "rebello95", "createdAt": "2020-08-06T20:13:30Z", "path": "library/swift/src/Counter.swift", "diffHunk": "@@ -0,0 +1,22 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+@objc\n+public class Counter: NSObject {\n+  private let series: String\n+  private weak var engine: EnvoyEngine?\n+\n+  internal init(elements: [Element], engine: EnvoyEngine) {\n+    self.series = elements.map{ $0.description }.joined(separator: \".\")", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDYyNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466660626", "bodyText": "Why not make value internal? I think using description is fragile since it could break if someone deleted the explicit description override (yet would still compile)", "author": "rebello95", "createdAt": "2020-08-06T20:14:21Z", "path": "library/swift/src/Element.swift", "diffHunk": "@@ -0,0 +1,19 @@\n+import Foundation\n+\n+private let kPattern = \"^[A-Za-z_]+$\"\n+\n+/// Element represents one dot-delimited component of a timeseries name.\n+@objc\n+public final class Element: NSObject, ExpressibleByStringLiteral {\n+  private let value: String\n+\n+  public init(stringLiteral value: String) {\n+    guard value.range(of: kPattern, options: .regularExpression) != nil else {\n+      preconditionFailure(\"Element values must conform to the regex /^[A-Za-z_]+$/.\")\n+    }\n+    self.value = value\n+  }\n+\n+  // CustomStringConvertible\n+  public override var description: String { return value }", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxMTUyMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467211522", "bodyText": "Okay, sure.", "author": "goaway", "createdAt": "2020-08-07T18:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDgxNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466660814", "bodyText": "This needs to be public and is missing docstrings", "author": "rebello95", "createdAt": "2020-08-06T20:14:43Z", "path": "library/swift/src/Counter.swift", "diffHunk": "@@ -0,0 +1,22 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+@objc\n+public class Counter: NSObject {\n+  private let series: String\n+  private weak var engine: EnvoyEngine?\n+\n+  internal init(elements: [Element], engine: EnvoyEngine) {\n+    self.series = elements.map{ $0.description }.joined(separator: \".\")\n+    self.engine = engine\n+    super.init()\n+  }\n+\n+  func increment(count: Int) {", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MTMyMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466661321", "bodyText": "Why are we exposing an Int publicly but requiring an unsigned integer internally? Shouldn't these be the same (in which case we could avoid a cast)?", "author": "rebello95", "createdAt": "2020-08-06T20:15:49Z", "path": "library/swift/src/Counter.swift", "diffHunk": "@@ -0,0 +1,22 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+@objc\n+public class Counter: NSObject {\n+  private let series: String\n+  private weak var engine: EnvoyEngine?\n+\n+  internal init(elements: [Element], engine: EnvoyEngine) {\n+    self.series = elements.map{ $0.description }.joined(separator: \".\")\n+    self.engine = engine\n+    super.init()\n+  }\n+\n+  func increment(count: Int) {\n+    guard let engine = self.engine else {\n+      return\n+    }\n+\n+    engine.recordCounter(self.series, count: numericCast(count))", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3MjQ2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468172467", "bodyText": "My impression is that Swift convention strongly favors treating base numeric types as signed wherever possible. (And in Java/Kotlin, there's basically no alternative.) On the other hand, Envoy is explicit about counters accepting unsigned values only. numericCast imposes strong runtime checks on invalid (in this case, negative) ranges. And this keeps the two platform interfaces aligned.", "author": "goaway", "createdAt": "2020-08-10T20:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MTMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MTQ4Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466661483", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @objc\n          \n          \n            \n            @objcMembers", "author": "rebello95", "createdAt": "2020-08-06T20:16:07Z", "path": "library/swift/src/Counter.swift", "diffHunk": "@@ -0,0 +1,22 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+@objc", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MTY3OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466661679", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @objc\n          \n          \n            \n            @objcMembers", "author": "rebello95", "createdAt": "2020-08-06T20:16:29Z", "path": "library/swift/src/Element.swift", "diffHunk": "@@ -0,0 +1,19 @@\n+import Foundation\n+\n+private let kPattern = \"^[A-Za-z_]+$\"\n+\n+/// Element represents one dot-delimited component of a timeseries name.\n+@objc", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MjAwNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466662004", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  preconditionFailure(\"Element values must conform to the regex /^[A-Za-z_]+$/.\")\n          \n          \n            \n                  preconditionFailure(\"Element values must conform to the regex '\\(kPattern)'\")", "author": "rebello95", "createdAt": "2020-08-06T20:17:05Z", "path": "library/swift/src/Element.swift", "diffHunk": "@@ -0,0 +1,19 @@\n+import Foundation\n+\n+private let kPattern = \"^[A-Za-z_]+$\"\n+\n+/// Element represents one dot-delimited component of a timeseries name.\n+@objc\n+public final class Element: NSObject, ExpressibleByStringLiteral {\n+  private let value: String\n+\n+  public init(stringLiteral value: String) {\n+    guard value.range(of: kPattern, options: .regularExpression) != nil else {\n+      preconditionFailure(\"Element values must conform to the regex /^[A-Za-z_]+$/.\")", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2Mjk3OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466662979", "bodyText": "I'd use a constant here so you don't have to replicate the regex twice (and so they don't deviate over time)", "author": "rebello95", "createdAt": "2020-08-06T20:19:03Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/Element.kt", "diffHunk": "@@ -0,0 +1,16 @@\n+package io.envoyproxy.envoymobile\n+\n+import java.util.regex.Pattern\n+\n+/**\n+ * Element for stats.\n+ */\n+class Element(val element: String) {\n+  init {\n+    if (!Pattern.compile(\"^[A-Za-z_]+\\$\").matcher(element).matches()) {\n+      throw IllegalArgumentException(\n+        \"Element values must conform to the regex /^[A-Za-z_]+$/\"", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3ODMxMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468178310", "bodyText": "clever", "author": "goaway", "createdAt": "2020-08-10T20:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2Mjk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MzMxNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466663314", "bodyText": "missing - parameter elements", "author": "rebello95", "createdAt": "2020-08-06T20:19:47Z", "path": "library/swift/src/StatsClient.swift", "diffHunk": "@@ -0,0 +1,8 @@\n+import Foundation\n+\n+/// Client used to record timeseries metrics.\n+@objc\n+public protocol StatsClient: AnyObject {\n+  /// - returns: A Counter based on the joined elements.", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MzUyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466663525", "bodyText": "This shouldn't be necessary since internal types don't need to be exposed to public objc consumers", "author": "rebello95", "createdAt": "2020-08-06T20:20:12Z", "path": "library/swift/src/StatsClientImpl.swift", "diffHunk": "@@ -0,0 +1,19 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+/// Envoy implementation of StatsClient.\n+@objcMembers", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NDAwMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466664000", "bodyText": "Can we add some tests?", "author": "rebello95", "createdAt": "2020-08-06T20:21:04Z", "path": "library/swift/src/mocks/MockEnvoyEngine.swift", "diffHunk": "@@ -7,6 +7,8 @@ final class MockEnvoyEngine: NSObject {\n   static var onRunWithConfig: ((_ config: EnvoyConfiguration, _ logLevel: String?) -> Void)?\n   /// Closure called when `run(withConfigYAML:)` is called.\n   static var onRunWithYAML: ((_ configYAML: String, _ logLevel: String?) -> Void)?\n+  /// Closure called when `recordCounter(_:count:)` is called.\n+  static var onRecordCounter: ((_ elements: String, _ count: UInt) -> Void)?", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxMjY2OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467212669", "bodyText": "Sure.", "author": "goaway", "createdAt": "2020-08-07T18:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NDAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NDgxMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466664810", "bodyText": "Same here regarding objc", "author": "rebello95", "createdAt": "2020-08-06T20:22:39Z", "path": "library/swift/src/StreamClientImpl.swift", "diffHunk": "@@ -0,0 +1,19 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+/// Envoy implementation of StreamClient.\n+@objcMembers", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NTAxOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466665018", "bodyText": "iOS has a strong ref below, we should keep them consistent (I think a strong ref is what you want here)", "author": "rebello95", "createdAt": "2020-08-06T20:23:06Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/StatsClientImpl.kt", "diffHunk": "@@ -0,0 +1,16 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+import java.lang.ref.WeakReference\n+\n+/**\n+ * Envoy implementation of `StatsClient`.\n+ */\n+internal class StatsClientImpl constructor(\n+  internal val engine: EnvoyEngine\n+) : StatsClient {\n+\n+  override fun getCounter(vararg elements: Element): Counter {\n+    return Counter(WeakReference(engine), elements.asList())", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MjA0OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466682049", "bodyText": "I believe the weak reference is intended. We would not want to have stats spread through the application to necessarily hold the engine alive, right?", "author": "junr03", "createdAt": "2020-08-06T20:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NTAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MzY3NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466683674", "bodyText": "Ah I see, this is passing a weak reference to the Counter, whereas on iOS the Counter itself makes the reference weak. Would it make sense to move WeakReference(engine) into the counter file's constructor to make it clear that it doesn't retain the engine?\nSeparately, I'm wondering if it makes sense to allow counters to retain the engine. Do we want the engine to stick around as long as a consumer is holding on to a counter ref?", "author": "rebello95", "createdAt": "2020-08-06T21:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NTAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4NDI5OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466684299", "bodyText": "Would it make sense to move WeakReference(engine) into the counter file's constructor to make it clear that it doesn't retain the engine?\n\nyea\n\nDo we want the engine to stick around as long as a consumer is holding on to a counter ref?\n\nprobably not, counters could be referenced by feature modules of the platform(iOS/android) code, and we probably don't want the feature modules to (indirectly) hold a strong ref to engine", "author": "jingwei99", "createdAt": "2020-08-06T21:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NTAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MTg2NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468181865", "bodyText": "My intuition right now is that it seems natural for engine clients to strongly retain the engine, but perhaps less so for the artifacts they produce. This has more to do with users of the library being able to implicitly manage the lifecycle of the engine than anything else. I should say that I'm not strongly convinced this is right, but it seems reasonable for now for experimentation.", "author": "goaway", "createdAt": "2020-08-10T20:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NTAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyODI5Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468228297", "bodyText": "Was there a resolution here? Looks like the weak ref is still being passed from this line", "author": "rebello95", "createdAt": "2020-08-10T22:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NTAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MzY3Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466673672", "bodyText": "I'd prefer having a more restrictive rule so that people have to think before their application level stats get emitted.", "author": "junr03", "createdAt": "2020-08-06T20:40:30Z", "path": "library/common/config_template.cc", "diffHunk": "@@ -204,6 +204,9 @@ stats_flush_interval: {{ stats_flush_interval_seconds }}s\n         - safe_regex:\n             google_re2: {}\n             regex: '^http.dispatcher.*'\n+        - safe_regex:\n+            google_re2: {}\n+            regex: '^client.*'", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODg4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466688888", "bodyText": "what rules do you have in mind?\nright now all the elements used for the stats are checked against the regex: ^[A-Za-z_]+\\$", "author": "jingwei99", "createdAt": "2020-08-06T21:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MzY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4ODE4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468188189", "bodyText": "Talked with @junr03, long-term it might make sense to make people specify this in configuration, so that some thought goes into the stats they emit. For now, as a new, experimental interface, this is probably good enough to move forward.", "author": "goaway", "createdAt": "2020-08-10T21:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MzY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NDM4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466674388", "bodyText": "this should be a constant, or CONTRUCT_ON_FIRST_USE", "author": "junr03", "createdAt": "2020-08-06T20:41:58Z", "path": "library/common/engine.cc", "diffHunk": "@@ -93,6 +93,19 @@ Engine::~Engine() {\n   main_thread_.join();\n }\n \n+void Engine::recordCounter(std::string elements, uint64_t count) {\n+  if (server_) {\n+    server_->dispatcher().post([this, elements, count]() -> void {\n+      std::string client = \"client\";", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NDc0Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466674747", "bodyText": "I believe you don't need to explicitly create a string view for passing into a function that expects one", "author": "junr03", "createdAt": "2020-08-06T20:42:43Z", "path": "library/common/engine.cc", "diffHunk": "@@ -93,6 +93,19 @@ Engine::~Engine() {\n   main_thread_.join();\n }\n \n+void Engine::recordCounter(std::string elements, uint64_t count) {\n+  if (server_) {\n+    server_->dispatcher().post([this, elements, count]() -> void {\n+      std::string client = \"client\";\n+      absl::string_view prefix{client};", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4OTEyOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466689128", "bodyText": "will try it out", "author": "jingwei99", "createdAt": "2020-08-06T21:12:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NDc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMzOTUyNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467339524", "bodyText": "update: tried it out, didn't compile", "author": "jingwei99", "createdAt": "2020-08-08T00:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NDc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NTEyOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466675128", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              void recordCounter(std::string elements, uint64_t count);\n          \n          \n            \n              void incCounter(std::string elements, uint64_t count);", "author": "junr03", "createdAt": "2020-08-06T20:43:31Z", "path": "library/common/engine.h", "diffHunk": "@@ -35,6 +35,11 @@ class Engine {\n    */\n   Http::Dispatcher& httpDispatcher();\n \n+  /**\n+   * Increment a counter with a given string of elements and by the given count.\n+   */\n+  void recordCounter(std::string elements, uint64_t count);", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NTkwNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466675907", "bodyText": "same everywhere else. If we are incrementing a counter we should say that in the function's name.", "author": "junr03", "createdAt": "2020-08-06T20:44:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NTEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMzMDk0OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r467330949", "bodyText": "discussed offline and decided we'll go with record for now", "author": "goaway", "createdAt": "2020-08-07T23:51:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NTEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3OTIwNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466679207", "bodyText": "big comment: This is an expensive way to create stats and reserved for dynamic stats created in the hot path in Envoy. I see how we still want to expose this for some application level stats that might be dynamic, but I think we should also think about static stats known at compile time (like crash_count, etc) -- which I think will compose a good chunk of what we want -- that could be statically initialized based on config.", "author": "junr03", "createdAt": "2020-08-06T20:51:31Z", "path": "library/common/engine.cc", "diffHunk": "@@ -93,6 +93,19 @@ Engine::~Engine() {\n   main_thread_.join();\n }\n \n+void Engine::recordCounter(std::string elements, uint64_t count) {\n+  if (server_) {\n+    server_->dispatcher().post([this, elements, count]() -> void {\n+      std::string client = \"client\";\n+      absl::string_view prefix{client};\n+      absl::string_view dynamic_elements{elements};\n+      Stats::Utility::counterFromElements(server_->serverFactoryContext().scope(),", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MjY3MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466682671", "bodyText": "https://github.com/envoyproxy/envoy/blob/master/source/docs/stats.md#dynamic-stat-tokens", "author": "junr03", "createdAt": "2020-08-06T20:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3OTIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE0Nzg2MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468147861", "bodyText": "Based on my reading of the linked doc, the main cost associated with dynamic tokens is that they take up more space and take time to encode - but they don't actually contend locks. It also appears new static tokens can be created via XDS updates, implying this could be an option for us as well as a potential optimization.\nAt present, all our work is on the main thread anyhow, and with dispatched stat updates, they're going to execute exclusively between I/O events regardless. I'd be fine with prominently documenting that this interface is experimental and may have unknown performance implications, but I feel we shouldn't block on that any more than we have other potential performance sinks in our hot path (extra copies, etc.).\nWhat do you think?", "author": "goaway", "createdAt": "2020-08-10T19:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3OTIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5MTUwMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468191501", "bodyText": "Chatted with @junr03, we're going to flag the StatsClient interface as experimental, and move forward, while continuing to investigate potential performance ramifications.", "author": "goaway", "createdAt": "2020-08-10T21:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3OTIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MzkzOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r466683939", "bodyText": "Can we cover this in tests?", "author": "junr03", "createdAt": "2020-08-06T21:01:13Z", "path": "library/common/engine.cc", "diffHunk": "@@ -93,6 +93,19 @@ Engine::~Engine() {\n   main_thread_.join();\n }\n \n+void Engine::recordCounter(std::string elements, uint64_t count) {", "originalCommit": "352fd28fee9f674023da716efcbe0dcea8fdc58c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4ODkwNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468188906", "bodyText": "Adding a ticket to cover testing generally at this layer, will link here.", "author": "goaway", "createdAt": "2020-08-10T21:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwNTAyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468205029", "bodyText": "@goaway don't forget to add this ticket", "author": "junr03", "createdAt": "2020-08-10T21:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ2OTA3OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468469078", "bodyText": "Created (but it's internal).", "author": "goaway", "createdAt": "2020-08-11T10:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MzkzOQ=="}], "type": "inlineReview"}, {"oid": "d977737d9b2abb880326c8b1bfcb336792b92b36", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d977737d9b2abb880326c8b1bfcb336792b92b36", "message": "comments\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-07T22:52:33Z", "type": "commit"}, {"oid": "ec8f26aee08337f092ed1a67561dd1723d7aeab3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ec8f26aee08337f092ed1a67561dd1723d7aeab3", "message": "Merge branch 'main' into jh-ms/stats-poc\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-08T00:01:39Z", "type": "commit"}, {"oid": "bad842212177211e4a893c7b5dc638532c64e09d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bad842212177211e4a893c7b5dc638532c64e09d", "message": "examples\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-08T00:04:57Z", "type": "commit"}, {"oid": "a8d0bbbc59edbb5d9b347e3f8cc3554370061de0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a8d0bbbc59edbb5d9b347e3f8cc3554370061de0", "message": "lint\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-08T00:36:29Z", "type": "commit"}, {"oid": "e75dbebd82e5703f3f8bbc45b9398a8d77a38735", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e75dbebd82e5703f3f8bbc45b9398a8d77a38735", "message": "add Swift tests for StatsClientImpl\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T11:16:08Z", "type": "commit"}, {"oid": "3962e9655fb36f70edc1dee63c503f32160e8052", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3962e9655fb36f70edc1dee63c503f32160e8052", "message": "swiftlint fixes\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T19:39:05Z", "type": "commit"}, {"oid": "827d6930b01ebc47034d94bbb6fe446394db8f30", "url": "https://github.com/envoyproxy/envoy-mobile/commit/827d6930b01ebc47034d94bbb6fe446394db8f30", "message": "fix swift example app\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T19:41:56Z", "type": "commit"}, {"oid": "0a216a5a51411410a2881b17b7781e43c3845c9f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0a216a5a51411410a2881b17b7781e43c3845c9f", "message": "update and align docstrings and comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T20:16:23Z", "type": "commit"}, {"oid": "e89dfa0c347b464f3e5651cf2533d2839e62c841", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e89dfa0c347b464f3e5651cf2533d2839e62c841", "message": "rename stat directory to stats\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T20:30:11Z", "type": "commit"}, {"oid": "9fdaaca2b394686e5ca415abcfd225cc6ced3276", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9fdaaca2b394686e5ca415abcfd225cc6ced3276", "message": "don't override CustomStringConvertible\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T20:35:34Z", "type": "commit"}, {"oid": "d3b575b3cc8d9426684ace77a62cdb292d64b933", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d3b575b3cc8d9426684ace77a62cdb292d64b933", "message": "couple more updates for comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T20:58:43Z", "type": "commit"}, {"oid": "b623969bc5f492c75195e861a3021563c9ae1477", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b623969bc5f492c75195e861a3021563c9ae1477", "message": "make clients be properties on swift Engine\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T21:36:58Z", "type": "commit"}, {"oid": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6ae7be32f03c919e8c0fd77a20449d87a55f5195", "message": "add experimental callout\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-10T21:45:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwOTY4Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468209683", "bodyText": "No non-pod statics (static init fiasco). Moreover what you really want here since this string is known at compile-time is to save a StatName for \"client\" using either a StatNamePool or StatNameManagedStorage. You want to do that in a context object that is created once at process startup and then re-used. Then you have no thread contention issues.", "author": "jmarantz", "createdAt": "2020-08-10T21:59:07Z", "path": "library/common/engine.cc", "diffHunk": "@@ -93,6 +93,19 @@ Engine::~Engine() {\n   main_thread_.join();\n }\n \n+void Engine::recordCounter(std::string elements, uint64_t count) {\n+  if (server_) {\n+    server_->dispatcher().post([this, elements, count]() -> void {\n+      static const std::string client = \"client\";", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyNzc5OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468227798", "bodyText": "Shouldn't these be in stats/ which is captured below with globbing?", "author": "rebello95", "createdAt": "2020-08-10T22:48:42Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/BUILD", "diffHunk": "@@ -52,15 +54,18 @@ envoy_mobile_kt_library(\n         \"ResponseTrailersBuilder.kt\",\n         \"RetryPolicy.kt\",\n         \"RetryPolicyMapper.kt\",\n+        \"StatsClient.kt\",\n+        \"StatsClientImpl.kt\",", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2MzE3MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468263170", "bodyText": "I think these ideally live here, basically in the same level as StreamClient, as the interface Engine.kt exposes a StatsClient and a StreamClient.", "author": "jingwei99", "createdAt": "2020-08-11T00:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyNzc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyODY4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468228688", "bodyText": "Regex is hardcoded 3 places here. Can we use a constant instead so we don't accidentally fail to change one of the usages in the future?", "author": "rebello95", "createdAt": "2020-08-10T22:51:26Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/stats/Element.kt", "diffHunk": "@@ -0,0 +1,18 @@\n+package io.envoyproxy.envoymobile\n+\n+import java.util.regex.Pattern\n+\n+/**\n+ * Element represents one dot-delimited component of a time series name.\n+ *\n+ * Element values must conform to the regex /^[A-Za-z_]+$/.\n+ */\n+class Element(val element: String) {\n+  init {\n+    if (!Pattern.compile(\"^[A-Za-z_]+\\$\").matcher(element).matches()) {\n+      throw IllegalArgumentException(\n+        \"Element values must conform to the regex /^[A-Za-z_]+$/\"", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2MzcxNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468263715", "bodyText": "fair", "author": "jingwei99", "createdAt": "2020-08-11T00:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyODY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyODgxNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468228816", "bodyText": "Same here regarding living in stats/", "author": "rebello95", "createdAt": "2020-08-10T22:51:48Z", "path": "library/swift/src/BUILD", "diffHunk": "@@ -21,15 +23,18 @@ swift_static_framework(\n         \"ResponseTrailersBuilder.swift\",\n         \"RetryPolicy.swift\",\n         \"RetryPolicyMapper.swift\",\n+        \"StatsClient.swift\",\n+        \"StatsClientImpl.swift\",", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2NDA2Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468264063", "bodyText": "same as above, StatsClient and its implementation ideally live at the same level as StreamClient given the Engine.swift interface.", "author": "jingwei99", "createdAt": "2020-08-11T00:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyODgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyODk3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468228975", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// - parameter elements: Elements to identify a counter\n          \n          \n            \n              /// - returns: A Counter based on the joined elements.\n          \n          \n            \n              /// - parameter elements: Elements to identify a counter\n          \n          \n            \n              ///\n          \n          \n            \n              /// - returns: A Counter based on the joined elements.", "author": "rebello95", "createdAt": "2020-08-10T22:52:20Z", "path": "library/swift/src/StatsClient.swift", "diffHunk": "@@ -0,0 +1,12 @@\n+import Foundation\n+\n+/// Client used to record time series metrics.\n+///\n+/// Note: this an experimental interface and is subject to change. The implementation has not been\n+/// optimized, and there may be performance implications in production usage.\n+@objc\n+public protocol StatsClient: AnyObject {\n+  /// - parameter elements: Elements to identify a counter\n+  /// - returns: A Counter based on the joined elements.", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyOTI4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468229289", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class Counter: NSObject {\n          \n          \n            \n            public final class Counter: NSObject {", "author": "rebello95", "createdAt": "2020-08-10T22:53:28Z", "path": "library/swift/src/stats/Counter.swift", "diffHunk": "@@ -0,0 +1,24 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+/// A time series counter.\n+@objcMembers\n+public class Counter: NSObject {", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyOTUxNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468229516", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// Increment the counter by the given count.\n          \n          \n            \n              /// Increment the counter by the given count.\n          \n          \n            \n              ///\n          \n          \n            \n              /// - parameter count: The amount by which to increment the counter.", "author": "rebello95", "createdAt": "2020-08-10T22:54:11Z", "path": "library/swift/src/stats/Counter.swift", "diffHunk": "@@ -0,0 +1,24 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+/// A time series counter.\n+@objcMembers\n+public class Counter: NSObject {\n+  private let series: String\n+  private weak var engine: EnvoyEngine?\n+\n+  init(elements: [Element], engine: EnvoyEngine) {\n+    self.series = elements.map { $0.value }.joined(separator: \".\")\n+    self.engine = engine\n+    super.init()\n+  }\n+\n+  /// Increment the counter by the given count.", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyOTU4Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468229582", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                guard let engine = self.engine else {\n          \n          \n            \n                  return\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                engine.recordCounter(self.series, count: numericCast(count))\n          \n          \n            \n                self.engine?.recordCounter(self.series, count: numericCast(count))", "author": "rebello95", "createdAt": "2020-08-10T22:54:25Z", "path": "library/swift/src/stats/Counter.swift", "diffHunk": "@@ -0,0 +1,24 @@\n+@_implementationOnly import EnvoyEngine\n+import Foundation\n+\n+/// A time series counter.\n+@objcMembers\n+public class Counter: NSObject {\n+  private let series: String\n+  private weak var engine: EnvoyEngine?\n+\n+  init(elements: [Element], engine: EnvoyEngine) {\n+    self.series = elements.map { $0.value }.joined(separator: \".\")\n+    self.engine = engine\n+    super.init()\n+  }\n+\n+  /// Increment the counter by the given count.\n+  public func increment(count: Int = 1) {\n+    guard let engine = self.engine else {\n+      return\n+    }\n+\n+    engine.recordCounter(self.series, count: numericCast(count))", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyOTc0NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468229744", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              internal let value: String\n          \n          \n            \n              let value: String", "author": "rebello95", "createdAt": "2020-08-10T22:54:47Z", "path": "library/swift/src/stats/Element.swift", "diffHunk": "@@ -0,0 +1,17 @@\n+import Foundation\n+\n+private let kPattern = \"^[A-Za-z_]+$\"\n+\n+/// Element represents one dot-delimited component of a time series name.\n+/// Element values must conform to the regex /^[A-Za-z_]+$/.\n+@objcMembers\n+public final class Element: NSObject, ExpressibleByStringLiteral {\n+  internal let value: String", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMDAzNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468230035", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              func testCounterDelegatesToEngine() throws {\n          \n          \n            \n              func testCounterDelegatesToEngine() {", "author": "rebello95", "createdAt": "2020-08-10T22:55:33Z", "path": "library/swift/test/StatsClientImplTests.swift", "diffHunk": "@@ -0,0 +1,53 @@\n+@testable import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class StatsClientImplTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+    MockEnvoyEngine.onRecordCounter = nil\n+  }\n+\n+  func testCounterDelegatesToEngine() throws {", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMDA5Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468230097", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              func testCounterDelegatesToEngineWithCount() throws {\n          \n          \n            \n              func testCounterDelegatesToEngineWithCount() {", "author": "rebello95", "createdAt": "2020-08-10T22:55:44Z", "path": "library/swift/test/StatsClientImplTests.swift", "diffHunk": "@@ -0,0 +1,53 @@\n+@testable import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class StatsClientImplTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+    MockEnvoyEngine.onRecordCounter = nil\n+  }\n+\n+  func testCounterDelegatesToEngine() throws {\n+    var actualSeries: String?\n+    var actualCount: UInt?\n+    MockEnvoyEngine.onRecordCounter = { series, count in\n+      actualSeries = series\n+      actualCount = count\n+    }\n+    let mockEngine = MockEnvoyEngine()\n+    let statsClient = StatsClientImpl(engine: mockEngine)\n+    let counter = statsClient.counter(elements: [\"test\", \"stat\"])\n+    counter.increment()\n+    XCTAssertEqual(actualSeries, \"test.stat\")\n+    XCTAssertEqual(actualCount, 1)\n+  }\n+\n+  func testCounterDelegatesToEngineWithCount() throws {", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMDE3Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468230176", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              func testCounterWeaklyHoldsEngine() throws {\n          \n          \n            \n              func testCounterWeaklyHoldsEngine() {", "author": "rebello95", "createdAt": "2020-08-10T22:56:03Z", "path": "library/swift/test/StatsClientImplTests.swift", "diffHunk": "@@ -0,0 +1,53 @@\n+@testable import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class StatsClientImplTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+    MockEnvoyEngine.onRecordCounter = nil\n+  }\n+\n+  func testCounterDelegatesToEngine() throws {\n+    var actualSeries: String?\n+    var actualCount: UInt?\n+    MockEnvoyEngine.onRecordCounter = { series, count in\n+      actualSeries = series\n+      actualCount = count\n+    }\n+    let mockEngine = MockEnvoyEngine()\n+    let statsClient = StatsClientImpl(engine: mockEngine)\n+    let counter = statsClient.counter(elements: [\"test\", \"stat\"])\n+    counter.increment()\n+    XCTAssertEqual(actualSeries, \"test.stat\")\n+    XCTAssertEqual(actualCount, 1)\n+  }\n+\n+  func testCounterDelegatesToEngineWithCount() throws {\n+    var actualSeries: String?\n+    var actualCount: UInt?\n+    MockEnvoyEngine.onRecordCounter = { series, count in\n+      actualSeries = series\n+      actualCount = count\n+    }\n+    let mockEngine = MockEnvoyEngine()\n+    let statsClient = StatsClientImpl(engine: mockEngine)\n+    let counter = statsClient.counter(elements: [\"test\", \"stat\"])\n+    counter.increment(count: 5)\n+    XCTAssertEqual(actualSeries, \"test.stat\")\n+    XCTAssertEqual(actualCount, 5)\n+  }\n+\n+  func testCounterWeaklyHoldsEngine() throws {", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMDM3Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468230373", "bodyText": "Can we add these tests for Kotlin too?", "author": "rebello95", "createdAt": "2020-08-10T22:56:36Z", "path": "library/swift/test/StatsClientImplTests.swift", "diffHunk": "@@ -0,0 +1,53 @@\n+@testable import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class StatsClientImplTests: XCTestCase {", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMDUxOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468230519", "bodyText": "nit: can we alphabetize these test cases?", "author": "rebello95", "createdAt": "2020-08-10T22:56:56Z", "path": "library/swift/test/BUILD", "diffHunk": "@@ -52,9 +52,19 @@ envoy_mobile_swift_test(\n )\n \n envoy_mobile_swift_test(\n-    name = \"stream_client_builder_tests\",\n+    name = \"engine_builder_tests\",\n     srcs = [\n-        \"StreamClientBuilderTests.swift\",\n+        \"EngineBuilderTests.swift\",\n+    ],\n+    deps = [\n+        \"//library/objective-c:envoy_engine_objc_lib\",\n+    ],\n+)\n+\n+envoy_mobile_swift_test(", "originalCommit": "6ae7be32f03c919e8c0fd77a20449d87a55f5195", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNzAzOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468237039", "bodyText": "thinking out loud: prolly worth adding a lint/pre-commit check for this in the long run", "author": "jingwei99", "createdAt": "2020-08-10T23:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzMDUxOQ=="}], "type": "inlineReview"}, {"oid": "7fc3ec0afd483f96a3033255f9802a58091b5a9d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7fc3ec0afd483f96a3033255f9802a58091b5a9d", "message": "comments\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-11T02:17:22Z", "type": "commit"}, {"oid": "c089d6952d9f4b8e0b0ba58e9ee36e94f71f266c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c089d6952d9f4b8e0b0ba58e9ee36e94f71f266c", "message": "andr\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-08-11T04:39:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyODIzOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/992#discussion_r468728238", "bodyText": "tried to emulate StatsClientImplTests.testCounterWeaklyHoldsEngine, but I wasn't able to get the EnvoyEngine instance garbage collected - as calling System.gc() doesn't guarantee gc.", "author": "jingwei99", "createdAt": "2020-08-11T16:58:15Z", "path": "library/kotlin/test/io/envoyproxy/envoymobile/StatsClientImplTest.kt", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+import org.assertj.core.api.Assertions.assertThat\n+import org.junit.Test\n+import org.mockito.ArgumentCaptor\n+import org.mockito.Mockito.mock\n+import org.mockito.Mockito.verify\n+\n+class StatsClientImplTest {\n+  private var envoyEngine: EnvoyEngine = mock(EnvoyEngine::class.java)\n+\n+  @Test\n+  fun `counter delegates to engine`() {\n+    val statsClient = StatsClientImpl(envoyEngine)\n+    val counter = statsClient.counter(Element(\"test\"), Element(\"stat\"))\n+    counter.increment()\n+    val elementsCaptor = ArgumentCaptor.forClass(String::class.java)\n+    val countCaptor = ArgumentCaptor.forClass(Int::class.java)\n+    verify(envoyEngine).recordCounter(elementsCaptor.capture(), countCaptor.capture())\n+    assertThat(elementsCaptor.getValue()).isEqualTo(\"test.stat\")\n+    assertThat(countCaptor.getValue()).isEqualTo(1)\n+  }\n+\n+  @Test\n+  fun `counter delegates to engine with count`() {\n+    val statsClient = StatsClientImpl(envoyEngine)\n+    val counter = statsClient.counter(Element(\"test\"), Element(\"stat\"))\n+    counter.increment(5)\n+    val elementsCaptor = ArgumentCaptor.forClass(String::class.java)\n+    val countCaptor = ArgumentCaptor.forClass(Int::class.java)\n+    verify(envoyEngine).recordCounter(elementsCaptor.capture(), countCaptor.capture())\n+    assertThat(elementsCaptor.getValue()).isEqualTo(\"test.stat\")\n+    assertThat(countCaptor.getValue()).isEqualTo(5)\n+  }\n+}", "originalCommit": "c089d6952d9f4b8e0b0ba58e9ee36e94f71f266c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}