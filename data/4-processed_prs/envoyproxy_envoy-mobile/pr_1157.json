{"pr_number": 1157, "pr_title": "filters: add buffer demo filter to swift", "pr_createdAt": "2020-10-31T01:06:10Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1157", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1NDE0Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1157#discussion_r515454146", "bodyText": "I think for requests that are headers and trailers (no body), this would crash because self.body is force unwrapped. Should we make body an optional in the declaration as var body: Data??", "author": "rebello95", "createdAt": "2020-10-31T04:29:37Z", "path": "examples/swift/hello_world/BufferDemoFilter.swift", "diffHunk": "@@ -0,0 +1,41 @@\n+import Envoy\n+import Foundation\n+\n+/// Example of a more complex HTTP filter that pauses processing on the response filter chain,\n+/// buffers until the response is complete, then resumes filter iteration while setting a new\n+/// header.\n+final class BufferDemoFilter: ResponseFilter {\n+  private var headers: ResponseHeaders!\n+  private var body: Data!\n+\n+  func onResponseHeaders(_ headers: ResponseHeaders, endStream: Bool)\n+    -> FilterHeadersStatus<ResponseHeaders>\n+  {\n+    self.headers = headers\n+    return .stopIteration\n+  }\n+\n+  func onResponseData(_ data: Data, endStream: Bool) -> FilterDataStatus<ResponseHeaders> {\n+    // Since we request buffering, each invocation will include all data buffered so far.\n+    self.body = data\n+\n+    // If this is the end of the stream, resume processing of the (now fully-buffered) response.\n+    if endStream {\n+      let builder = self.headers.toResponseHeadersBuilder()\n+        .add(name: \"buffer-filter-demo\", value: \"1\")\n+      return .resumeIteration(headers: builder.build(), data: self.body)\n+    }\n+    return .stopIterationAndBuffer\n+  }\n+\n+  func onResponseTrailers(\n+    _ trailers: ResponseTrailers\n+  ) -> FilterTrailersStatus<ResponseHeaders, ResponseTrailers> {\n+    // Trailers imply end of stream; resume processing of the (now fully-buffered) response.\n+    return .resumeIteration(data: self.body, trailers: trailers)", "originalCommit": "d4a5c504a362fc4afae394b1ac83188de2b0cee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3MDY1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1157#discussion_r515470659", "bodyText": "Very good point. Updated.", "author": "goaway", "createdAt": "2020-10-31T08:09:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1NDE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwMTc2MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1157#discussion_r515501760", "bodyText": "I think you forgot to push \ud83d\ude43", "author": "rebello95", "createdAt": "2020-10-31T14:19:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1NDE0Ng=="}], "type": "inlineReview"}, {"oid": "daf31a78a6860fbe655eb5b25ac2b9af5cf4017c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/daf31a78a6860fbe655eb5b25ac2b9af5cf4017c", "message": "filters: add buffer demo filter to swift\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:01:33Z", "type": "commit"}, {"oid": "bc28ab2b90beb89dc9f092cbf8cf317cabbd881d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bc28ab2b90beb89dc9f092cbf8cf317cabbd881d", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:01:33Z", "type": "commit"}, {"oid": "121c3e7f714ca35835459fe83876daa8522023e0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/121c3e7f714ca35835459fe83876daa8522023e0", "message": "make body data optional\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:01:33Z", "type": "commit"}, {"oid": "121c3e7f714ca35835459fe83876daa8522023e0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/121c3e7f714ca35835459fe83876daa8522023e0", "message": "make body data optional\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:01:33Z", "type": "forcePushed"}]}