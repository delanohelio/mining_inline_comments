{"pr_number": 971, "pr_title": "filters: wire data and trailers for iOS", "pr_createdAt": "2020-07-23T10:36:09Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/971", "timeline": [{"oid": "7e583c5fedca2cea2f57da575b10ce47e812fee1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7e583c5fedca2cea2f57da575b10ce47e812fee1", "message": "filters: wire data and trailers for iOS\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-24T03:10:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyMDQ1NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460220454", "bodyText": "I intend to eventually remove this when we have more direct integration coverage of this functionality in CI, based on the approach @junr03 has proposed with the ValidationFilter (name TBD? ExpectationFilter? RequirementsFilter? SatisfactionFilter.).", "author": "goaway", "createdAt": "2020-07-24T18:29:42Z", "path": "examples/swift/hello_world/DemoFilter.swift", "diffHunk": "@@ -17,6 +17,7 @@ struct DemoFilter: ResponseFilter {\n   func setResponseFilterCallbacks(_ callbacks: ResponseFilterCallbacks) {}\n \n   func onResponseData(_ body: Data, endStream: Bool) -> FilterDataStatus {\n+    NSLog(\"Saw data chunk of length \\(body.count)\")", "originalCommit": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1NDI3Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460254272", "bodyText": "sg, do you mind leaving a TODO?\nAssertionFilter? So many options!", "author": "junr03", "createdAt": "2020-07-24T19:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyMDQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxNTkxNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460315915", "bodyText": "StipulationsFilter.", "author": "goaway", "createdAt": "2020-07-24T22:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyMDQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1NzU1NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460257554", "bodyText": "we were always releasing right after the transformation call, right? Now I can't remember why https://github.com/lyft/envoy-mobile/pull/971/files#diff-0fdd94f3084afc47d1b505544703ca0dL41 existed in the first place? i.e there was not a site (is there one in this PR and I am blind to it) where we conditionally released?", "author": "junr03", "createdAt": "2020-07-24T19:51:45Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -95,13 +44,68 @@ static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n   }\n \n   EnvoyHeaders *platformHeaders = to_ios_headers(headers);\n-  release_envoy_headers(headers);", "originalCommit": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxNjQwNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460316404", "bodyText": "It's already gone. I removed the optimization and came up with the flag-based way (that we discussed earlier) to do it (later).", "author": "goaway", "createdAt": "2020-07-24T22:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1NzU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NDc3NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460264774", "bodyText": "Can we use typed keys here instead of id?", "author": "rebello95", "createdAt": "2020-07-24T20:09:01Z", "path": "library/objective-c/EnvoyBridgeUtility.h", "diffHunk": "@@ -0,0 +1,68 @@\n+#import <Foundation/Foundation.h>\n+\n+#import \"library/common/types/c_types.h\"\n+\n+static inline envoy_data toNativeData(NSData *data) {\n+  uint8_t *native_bytes = (uint8_t *)safe_malloc(sizeof(uint8_t) * data.length);\n+  memcpy(native_bytes, data.bytes, data.length);\n+  envoy_data ret = {data.length, native_bytes, free, native_bytes};\n+  return ret;\n+}\n+\n+static inline envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  envoy_data ret = {length, native_string, free, native_string};\n+  return ret;\n+}\n+\n+static inline envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n+  envoy_header_size_t length = 0;\n+  for (id headerKey in headers) {\n+    length += [headers[headerKey] count];\n+  }\n+  envoy_header *header_array = (envoy_header *)safe_malloc(sizeof(envoy_header) * length);\n+  envoy_header_size_t header_index = 0;\n+  for (id headerKey in headers) {\n+    NSArray *headerList = headers[headerKey];\n+    for (id headerValue in headerList) {", "originalCommit": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxNjYzNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460316636", "bodyText": "Yes. In fact, I feel like I already had changed this, but it might have gotten lost in the chain of branches.", "author": "goaway", "createdAt": "2020-07-24T22:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NDc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyOTgxNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460329815", "bodyText": "Ah, I did in the new location, but not the old one where I factored from.", "author": "goaway", "createdAt": "2020-07-24T23:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NDc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NjI1Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460266252", "bodyText": "We had actually dropped this deliberately since it wasn't something we thought was needed yet. What was the reasoning for adding it back? If we want to keep it, we should also add it to the Android interfaces", "author": "rebello95", "createdAt": "2020-07-24T20:12:58Z", "path": "library/swift/src/filters/FilterDataStatus.swift", "diffHunk": "@@ -21,4 +21,17 @@ public enum FilterDataStatus {\n   /// This should be called by filters which must parse a larger block of the incoming data before\n   /// continuing processing.\n   case stopIterationAndBuffer(Data)\n+\n+  /// Do not iterate to any of the remaining filters in the chain, and do not internally buffer\n+  /// data.\n+  ///\n+  /// This filter will continue to be called with new chunks of data.\n+  ///\n+  /// Returning `continue` from `onRequestData()`/`onResponseData()` or calling\n+  /// `continueRequest()`/`continueResponse()` MUST be called when continued filter iteration is\n+  /// desired.\n+  ///\n+  /// This may be called by filters which must parse a larger block of the incoming data before\n+  /// continuing processing, and will handle their own buffering.\n+  case stopIterationNoBuffer", "originalCommit": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxNzM2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460317367", "bodyText": "We discussed earlier, but posting here for posterity - leaving this in potentially eases the path for migrating over platform logic that already does its own buffering, since less code needs to change initially. It also still provides for application logic that for one reason or another must to do its own buffering.", "author": "goaway", "createdAt": "2020-07-24T22:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NjI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NjM0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460266340", "bodyText": "Suggested change", "author": "rebello95", "createdAt": "2020-07-24T20:13:13Z", "path": "library/swift/src/filters/Filter.swift", "diffHunk": "@@ -50,6 +75,32 @@ extension EnvoyHTTPFilter {\n           return [kEnvoyFilterHeadersStatusStopIteration, headers.headers]\n         }\n       }\n+\n+      self.onResponseData = { data, endStream in\n+        let result = responseFilter.onResponseData(data, endStream: endStream)\n+        switch result {\n+        case .continue(let data):\n+          return [kEnvoyFilterDataStatusContinue, data]\n+        case .stopIterationAndBuffer(let data):\n+          return [kEnvoyFilterDataStatusStopIterationAndBuffer, data]\n+        case .stopIterationNoBuffer:\n+          // TODO(goaway): this probably shouldn't return any associated data, but bridge code\n+          // would need to be updated to handle nil. Alternatively, when an unmodified flag is\n+          // added, that could suffice here, too.\n+          return [kEnvoyFilterDataStatusStopIterationNoBuffer, data]\n+        }\n+      }\n+\n+      self.onResponseTrailers = { envoyTrailers in\n+        let result = responseFilter.onResponseTrailers(ResponseTrailers(headers: envoyTrailers))\n+        switch result {\n+        case .continue(let trailers):\n+          return [kEnvoyFilterTrailersStatusContinue, trailers.headers]\n+        case .stopIteration(let trailers):\n+          return [kEnvoyFilterTrailersStatusStopIteration, trailers.headers]\n+        }\n+      }\n+", "originalCommit": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMzMTg2Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460331862", "bodyText": "Missing closing comment */ \ud83d\ude43", "author": "rebello95", "createdAt": "2020-07-24T23:43:45Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/filters/FilterDataStatus.kt", "diffHunk": "@@ -30,4 +30,18 @@ sealed class FilterDataStatus {\n    * continuing processing.\n    */\n   class StopIterationAndBuffer(val data: ByteBuffer) : FilterDataStatus()\n+\n+  /**\n+   * Do not iterate to any of the remaining filters in the chain, and do not internally buffer\n+   * data.\n+   *\n+   * This filter will continue to be called with new chunks of data.\n+   *\n+   * Returning `Continue` from `onRequestData()`/`onResponseData()` or calling\n+   * `continueRequest()`/`continueResponse()` MUST be called when continued filter iteration is\n+   * desired.\n+   *\n+   * This may be called by filters which must parse a larger block of the incoming data before\n+   * continuing processing, and will handle their own buffering.", "originalCommit": "6f3694986bfdba836e15f00974e5d2964db8bde3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMzMzE0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460333143", "bodyText": "\ud83d\ude43", "author": "goaway", "createdAt": "2020-07-24T23:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMzMTg2Mg=="}], "type": "inlineReview"}, {"oid": "dee9d2329d4fad71489bc97cdac016090b6347c6", "url": "https://github.com/envoyproxy/envoy-mobile/commit/dee9d2329d4fad71489bc97cdac016090b6347c6", "message": "filters: wire data and trailers for iOS\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "commit"}, {"oid": "856b043a99fc7a5d67da7ec6aaafc6fdcd57aceb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/856b043a99fc7a5d67da7ec6aaafc6fdcd57aceb", "message": "add output to example app logs\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "commit"}, {"oid": "083af729e54a5f33a6f82f8bce9cbee11bfd0f73", "url": "https://github.com/envoyproxy/envoy-mobile/commit/083af729e54a5f33a6f82f8bce9cbee11bfd0f73", "message": "this one's for you, Jose\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "commit"}, {"oid": "1b9361b2214707bc929ff26a2c5d83884bda2418", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1b9361b2214707bc929ff26a2c5d83884bda2418", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "commit"}, {"oid": "a06c2ef3d35ec143f235f9c56d9cc4d609d9ce04", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a06c2ef3d35ec143f235f9c56d9cc4d609d9ce04", "message": "updates for comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "commit"}, {"oid": "23d841502dc55ee1a41e4a8c5cce7cdff4297924", "url": "https://github.com/envoyproxy/envoy-mobile/commit/23d841502dc55ee1a41e4a8c5cce7cdff4297924", "message": "additional updates for comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "commit"}, {"oid": "ca775c6b3836652cc99fc34511de91b9c26e254b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ca775c6b3836652cc99fc34511de91b9c26e254b", "message": "typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "commit"}, {"oid": "ca775c6b3836652cc99fc34511de91b9c26e254b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ca775c6b3836652cc99fc34511de91b9c26e254b", "message": "typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-25T03:41:58Z", "type": "forcePushed"}]}