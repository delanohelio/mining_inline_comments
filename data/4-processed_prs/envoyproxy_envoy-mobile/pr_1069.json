{"pr_number": 1069, "pr_title": "swift: http acceptance tests with assertion filter", "pr_createdAt": "2020-09-03T18:19:42Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1069", "timeline": [{"oid": "9de4cbb672273998cecdeac3577fe9cc48684ed4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9de4cbb672273998cecdeac3577fe9cc48684ed4", "message": "wip, segfault\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-18T21:53:57Z", "type": "commit"}, {"oid": "907758cd5a5d09bd628decc571acdf5dd49fddb2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/907758cd5a5d09bd628decc571acdf5dd49fddb2", "message": "wip\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-03T18:18:26Z", "type": "commit"}, {"oid": "e53bdf57d434a79f648701387dc48b944949f311", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e53bdf57d434a79f648701387dc48b944949f311", "message": "Merge branch 'main' into swift-tests\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-04T20:48:34Z", "type": "commit"}, {"oid": "eaa3e7d65b94486a6002ba10e06bb854163f9d96", "url": "https://github.com/envoyproxy/envoy-mobile/commit/eaa3e7d65b94486a6002ba10e06bb854163f9d96", "message": "green test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-04T23:08:47Z", "type": "commit"}, {"oid": "237d39f9523d9bd4100c466ac01dfa1bbd08f77f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/237d39f9523d9bd4100c466ac01dfa1bbd08f77f", "message": "lint\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-04T23:12:03Z", "type": "commit"}, {"oid": "6417305edae972382fe3c69a578edac8286152a7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6417305edae972382fe3c69a578edac8286152a7", "message": "actual lint clean\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-04T23:27:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzI5NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r485213295", "bodyText": "This shouldn't be required for ResponseFilter implementations", "author": "rebello95", "createdAt": "2020-09-08T21:44:29Z", "path": "library/swift/test/DemoFilter.swift", "diffHunk": "@@ -0,0 +1,30 @@\n+import Envoy\n+import Foundation\n+\n+struct DemoFilter: ResponseFilter {\n+  func onResponseHeaders(_ headers: ResponseHeaders, endStream: Bool)\n+    -> FilterHeadersStatus<ResponseHeaders>\n+  {\n+    NSLog(\"Adding new header!\")\n+    let builder = headers.toResponseHeadersBuilder()\n+    builder.add(name: \"filter-demo\", value: \"1\")\n+    return .continue(headers: builder.build())\n+  }\n+\n+  func setResponseFilterCallbacks(_ callbacks: ResponseFilterCallbacks) {}", "originalCommit": "6417305edae972382fe3c69a578edac8286152a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzQ0MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r485213441", "bodyText": "Can remove this", "author": "rebello95", "createdAt": "2020-09-08T21:44:48Z", "path": "library/swift/test/BridgeTests.swift", "diffHunk": "@@ -0,0 +1,100 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+private let kMockTemplate = \"\"\"\n+mock_template:\n+- name: mock\n+  stats_domain: {{ stats_domain }}\n+  device_os: {{ device_os }}\n+  connect_timeout: {{ connect_timeout_seconds }}s\n+  dns_refresh_rate: {{ dns_refresh_rate_seconds }}s\n+  dns_failure_refresh_rate:\n+    base_interval: {{ dns_failure_refresh_rate_seconds_base }}s\n+    max_interval: {{ dns_failure_refresh_rate_seconds_max }}s\n+  platform_filter_chain: {{ platform_filter_chain }}\n+  stats_flush_interval: {{ stats_flush_interval_seconds }}s\n+  app_version: {{ app_version }}\n+  app_id: {{ app_id }}\n+  virtual_clusters: {{ virtual_clusters }}\n+\"\"\"\n+\n+private struct TestFilter: Filter {}\n+\n+final class BridgeTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+  }", "originalCommit": "6417305edae972382fe3c69a578edac8286152a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDEwMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r485214103", "bodyText": "We should be using XCTestExpectation rather than NSCondition: https://github.com/lyft/envoy-mobile/blob/06fc24a895cb640408450bc220190c01c3f2f2c0/library/swift/test/EngineBuilderTests.swift#L131", "author": "rebello95", "createdAt": "2020-09-08T21:46:23Z", "path": "library/swift/test/BridgeTests.swift", "diffHunk": "@@ -0,0 +1,100 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+private let kMockTemplate = \"\"\"\n+mock_template:\n+- name: mock\n+  stats_domain: {{ stats_domain }}\n+  device_os: {{ device_os }}\n+  connect_timeout: {{ connect_timeout_seconds }}s\n+  dns_refresh_rate: {{ dns_refresh_rate_seconds }}s\n+  dns_failure_refresh_rate:\n+    base_interval: {{ dns_failure_refresh_rate_seconds_base }}s\n+    max_interval: {{ dns_failure_refresh_rate_seconds_max }}s\n+  platform_filter_chain: {{ platform_filter_chain }}\n+  stats_flush_interval: {{ stats_flush_interval_seconds }}s\n+  app_version: {{ app_version }}\n+  app_id: {{ app_id }}\n+  virtual_clusters: {{ virtual_clusters }}\n+\"\"\"\n+\n+private struct TestFilter: Filter {}\n+\n+final class BridgeTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+  }\n+\n+  func testInitial() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    // swiftlint:disable:next line_length\n+    let assertionFilterType = \"type.googleapis.com/envoymobile.extensions.filters.http.assertion.Assertion\"\n+    let config =\n+    \"\"\"\n+    static_resources:\n+      listeners:\n+      - name: base_api_listener\n+        address:\n+          socket_address:\n+            protocol: TCP\n+            address: 0.0.0.0\n+            port_value: 10000\n+        api_listener:\n+          api_listener:\n+            \"@type\": \\(apiListenerType)\n+            stat_prefix: hcm\n+            route_config:\n+              name: api_router\n+              virtual_hosts:\n+                - name: api\n+                  domains:\n+                    - \"*\"\n+                  routes:\n+                    - match:\n+                        prefix: \"/\"\n+                      direct_response:\n+                        status: 418\n+            http_filters:\n+              - name: envoy.filters.http.assertion\n+                typed_config:\n+                  \"@type\": \\(assertionFilterType)\n+                  match_config:\n+                    http_request_headers_match:\n+                      headers:\n+                        - name: \":authority\"\n+                          exact_match: example.com\n+              - name: envoy.router\n+                typed_config:\n+                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n+    \"\"\"\n+    let cond = NSCondition()", "originalCommit": "6417305edae972382fe3c69a578edac8286152a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDQ0Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r485214446", "bodyText": "We should add some more color to what this is actually testing (test names can be quite verbose which is fine)", "author": "rebello95", "createdAt": "2020-09-08T21:47:15Z", "path": "library/swift/test/BridgeTests.swift", "diffHunk": "@@ -0,0 +1,100 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+private let kMockTemplate = \"\"\"\n+mock_template:\n+- name: mock\n+  stats_domain: {{ stats_domain }}\n+  device_os: {{ device_os }}\n+  connect_timeout: {{ connect_timeout_seconds }}s\n+  dns_refresh_rate: {{ dns_refresh_rate_seconds }}s\n+  dns_failure_refresh_rate:\n+    base_interval: {{ dns_failure_refresh_rate_seconds_base }}s\n+    max_interval: {{ dns_failure_refresh_rate_seconds_max }}s\n+  platform_filter_chain: {{ platform_filter_chain }}\n+  stats_flush_interval: {{ stats_flush_interval_seconds }}s\n+  app_version: {{ app_version }}\n+  app_id: {{ app_id }}\n+  virtual_clusters: {{ virtual_clusters }}\n+\"\"\"\n+\n+private struct TestFilter: Filter {}\n+\n+final class BridgeTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+  }\n+\n+  func testInitial() throws {", "originalCommit": "6417305edae972382fe3c69a578edac8286152a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDU4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r485214589", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    let status = responseHeaders.httpStatus ?? -1\n          \n          \n            \n                     XCTAssertEqual(200, status)\n          \n          \n            \n                     XCTAssertEqual(200, responseHeaders.httpStatus)", "author": "rebello95", "createdAt": "2020-09-08T21:47:32Z", "path": "library/swift/test/BridgeTests.swift", "diffHunk": "@@ -0,0 +1,100 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+private let kMockTemplate = \"\"\"\n+mock_template:\n+- name: mock\n+  stats_domain: {{ stats_domain }}\n+  device_os: {{ device_os }}\n+  connect_timeout: {{ connect_timeout_seconds }}s\n+  dns_refresh_rate: {{ dns_refresh_rate_seconds }}s\n+  dns_failure_refresh_rate:\n+    base_interval: {{ dns_failure_refresh_rate_seconds_base }}s\n+    max_interval: {{ dns_failure_refresh_rate_seconds_max }}s\n+  platform_filter_chain: {{ platform_filter_chain }}\n+  stats_flush_interval: {{ stats_flush_interval_seconds }}s\n+  app_version: {{ app_version }}\n+  app_id: {{ app_id }}\n+  virtual_clusters: {{ virtual_clusters }}\n+\"\"\"\n+\n+private struct TestFilter: Filter {}\n+\n+final class BridgeTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+  }\n+\n+  func testInitial() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    // swiftlint:disable:next line_length\n+    let assertionFilterType = \"type.googleapis.com/envoymobile.extensions.filters.http.assertion.Assertion\"\n+    let config =\n+    \"\"\"\n+    static_resources:\n+      listeners:\n+      - name: base_api_listener\n+        address:\n+          socket_address:\n+            protocol: TCP\n+            address: 0.0.0.0\n+            port_value: 10000\n+        api_listener:\n+          api_listener:\n+            \"@type\": \\(apiListenerType)\n+            stat_prefix: hcm\n+            route_config:\n+              name: api_router\n+              virtual_hosts:\n+                - name: api\n+                  domains:\n+                    - \"*\"\n+                  routes:\n+                    - match:\n+                        prefix: \"/\"\n+                      direct_response:\n+                        status: 418\n+            http_filters:\n+              - name: envoy.filters.http.assertion\n+                typed_config:\n+                  \"@type\": \\(assertionFilterType)\n+                  match_config:\n+                    http_request_headers_match:\n+                      headers:\n+                        - name: \":authority\"\n+                          exact_match: example.com\n+              - name: envoy.router\n+                typed_config:\n+                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n+    \"\"\"\n+    let cond = NSCondition()\n+    let q = DispatchQueue(label: \"test.envoymobile\")\n+    let client = try EngineBuilder(yaml: config)\n+      .addLogLevel(.debug)\n+      .addFilter(factory: DemoFilter.init)\n+      .build()\n+      .streamClient\n+\n+    let requestHeaders = RequestHeadersBuilder(method: .get, scheme: \"https\",\n+                                               authority: \"example.com\", path: \"/test\")\n+      .addUpstreamHttpProtocol(.http2)\n+      .build()\n+    client\n+      .newStreamPrototype()\n+      .setOnResponseHeaders { responseHeaders, _ in\n+        let status = responseHeaders.httpStatus ?? -1\n+         XCTAssertEqual(200, status)", "originalCommit": "6417305edae972382fe3c69a578edac8286152a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDczMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r485214732", "bodyText": "Could probably just use .main", "author": "rebello95", "createdAt": "2020-09-08T21:47:50Z", "path": "library/swift/test/BridgeTests.swift", "diffHunk": "@@ -0,0 +1,100 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+private let kMockTemplate = \"\"\"\n+mock_template:\n+- name: mock\n+  stats_domain: {{ stats_domain }}\n+  device_os: {{ device_os }}\n+  connect_timeout: {{ connect_timeout_seconds }}s\n+  dns_refresh_rate: {{ dns_refresh_rate_seconds }}s\n+  dns_failure_refresh_rate:\n+    base_interval: {{ dns_failure_refresh_rate_seconds_base }}s\n+    max_interval: {{ dns_failure_refresh_rate_seconds_max }}s\n+  platform_filter_chain: {{ platform_filter_chain }}\n+  stats_flush_interval: {{ stats_flush_interval_seconds }}s\n+  app_version: {{ app_version }}\n+  app_id: {{ app_id }}\n+  virtual_clusters: {{ virtual_clusters }}\n+\"\"\"\n+\n+private struct TestFilter: Filter {}\n+\n+final class BridgeTests: XCTestCase {\n+  override func tearDown() {\n+    super.tearDown()\n+  }\n+\n+  func testInitial() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    // swiftlint:disable:next line_length\n+    let assertionFilterType = \"type.googleapis.com/envoymobile.extensions.filters.http.assertion.Assertion\"\n+    let config =\n+    \"\"\"\n+    static_resources:\n+      listeners:\n+      - name: base_api_listener\n+        address:\n+          socket_address:\n+            protocol: TCP\n+            address: 0.0.0.0\n+            port_value: 10000\n+        api_listener:\n+          api_listener:\n+            \"@type\": \\(apiListenerType)\n+            stat_prefix: hcm\n+            route_config:\n+              name: api_router\n+              virtual_hosts:\n+                - name: api\n+                  domains:\n+                    - \"*\"\n+                  routes:\n+                    - match:\n+                        prefix: \"/\"\n+                      direct_response:\n+                        status: 418\n+            http_filters:\n+              - name: envoy.filters.http.assertion\n+                typed_config:\n+                  \"@type\": \\(assertionFilterType)\n+                  match_config:\n+                    http_request_headers_match:\n+                      headers:\n+                        - name: \":authority\"\n+                          exact_match: example.com\n+              - name: envoy.router\n+                typed_config:\n+                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n+    \"\"\"\n+    let cond = NSCondition()\n+    let q = DispatchQueue(label: \"test.envoymobile\")\n+    let client = try EngineBuilder(yaml: config)\n+      .addLogLevel(.debug)\n+      .addFilter(factory: DemoFilter.init)\n+      .build()\n+      .streamClient\n+\n+    let requestHeaders = RequestHeadersBuilder(method: .get, scheme: \"https\",\n+                                               authority: \"example.com\", path: \"/test\")\n+      .addUpstreamHttpProtocol(.http2)\n+      .build()\n+    client\n+      .newStreamPrototype()\n+      .setOnResponseHeaders { responseHeaders, _ in\n+        let status = responseHeaders.httpStatus ?? -1\n+         XCTAssertEqual(200, status)\n+      }\n+      .setOnResponseData { _, endStream in\n+        XCTAssertTrue(endStream)\n+        cond.signal()\n+      }\n+      .start(queue: q)", "originalCommit": "6417305edae972382fe3c69a578edac8286152a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3NjAxMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496876011", "bodyText": "I believe I need to use a different thread for the response to advance the test thread to wait for the expectation. In an earlier draft the test was blocking if I queued on main. I did change some of the test structure, so I can try with main again.", "author": "junr03", "createdAt": "2020-09-29T16:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4NDU0NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496884544", "bodyText": "I guess expectations work differently under the hood than NSCondition. Changed queue back to main successfully.", "author": "junr03", "createdAt": "2020-09-29T16:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDczMg=="}], "type": "inlineReview"}, {"oid": "021dcea578e7d9bbeaef24b929bbd5371ccc19aa", "url": "https://github.com/envoyproxy/envoy-mobile/commit/021dcea578e7d9bbeaef24b929bbd5371ccc19aa", "message": "Merge branch 'main' into swift-tests\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-28T21:37:34Z", "type": "commit"}, {"oid": "ed9d0d8a24466628e6539c5f32b72e8fd87a3207", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ed9d0d8a24466628e6539c5f32b72e8fd87a3207", "message": "full test suite\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-28T23:50:12Z", "type": "commit"}, {"oid": "dabe39ceda24354b560dfb4d775ab1bb18e38df1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/dabe39ceda24354b560dfb4d775ab1bb18e38df1", "message": "done\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T16:22:30Z", "type": "commit"}, {"oid": "bb0f2e50714a0b8a07b6d553379046ac971aa032", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bb0f2e50714a0b8a07b6d553379046ac971aa032", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T16:24:07Z", "type": "commit"}, {"oid": "2c64ae723260ee3c76d8c8a191c3c0e95d2e3c8e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2c64ae723260ee3c76d8c8a191c3c0e95d2e3c8e", "message": "pre-commit\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T16:28:28Z", "type": "commit"}, {"oid": "6308d2ff5a0df953de2c09987f26e03f04ea87e9", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6308d2ff5a0df953de2c09987f26e03f04ea87e9", "message": "change queue\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T16:38:33Z", "type": "commit"}, {"oid": "86467c06c1746475d85104abe03bad3acfb48109", "url": "https://github.com/envoyproxy/envoy-mobile/commit/86467c06c1746475d85104abe03bad3acfb48109", "message": "Merge branch 'main' into swift-tests\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T16:38:56Z", "type": "commit"}, {"oid": "326f349c71c90f31f64f89fcaf9aa7748545693b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/326f349c71c90f31f64f89fcaf9aa7748545693b", "message": "update\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T18:34:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTM5Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496955393", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                self.waitForExpectations(timeout: 1)\n          \n          \n            \n                XCTAssertEqual(XCTWaiter.wait(for: [expectation], timeout: 1), .completed)\n          \n      \n    \n    \n  \n\nI'd replace these with assertions that the result of the wait is actually completed (throughout this PR)", "author": "rebello95", "createdAt": "2020-09-29T18:36:23Z", "path": "library/swift/test/HttpBridgeTests/CancelStreamTest.swift", "diffHunk": "@@ -0,0 +1,57 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class CancelStreamTests: XCTestCase {\n+  func testCancelStream() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    let config =\n+    \"\"\"\n+    static_resources:\n+      listeners:\n+      - name: base_api_listener\n+        address:\n+          socket_address:\n+            protocol: TCP\n+            address: 0.0.0.0\n+            port_value: 10000\n+        api_listener:\n+          api_listener:\n+            \"@type\": \\(apiListenerType)\n+            stat_prefix: hcm\n+            route_config:\n+              name: api_router\n+              virtual_hosts:\n+                - name: api\n+                  domains:\n+                    - \"*\"\n+                  routes:\n+                    - match:\n+                        prefix: \"/\"\n+                      direct_response:\n+                        status: 200\n+            http_filters:\n+              - name: envoy.router\n+                typed_config:\n+                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n+    \"\"\"\n+    let expectation = self.expectation(description: \"Run called with expected cancellation\")\n+    let client = try EngineBuilder(yaml: config)\n+      .addLogLevel(.debug)\n+      .addFilter(factory: DemoFilter.init)\n+      .build()\n+      .streamClient()\n+\n+    client\n+      .newStreamPrototype()\n+      .setOnCancel {\n+         expectation.fulfill()\n+      }\n+      .start()\n+      .cancel()\n+\n+    self.waitForExpectations(timeout: 1)", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTY2Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496955666", "bodyText": "Should we remove these logs?", "author": "rebello95", "createdAt": "2020-09-29T18:36:52Z", "path": "library/swift/test/HttpBridgeTests/DemoFilter.swift", "diffHunk": "@@ -0,0 +1,28 @@\n+import Envoy\n+import Foundation\n+\n+struct DemoFilter: ResponseFilter {\n+  func onResponseHeaders(_ headers: ResponseHeaders, endStream: Bool)\n+    -> FilterHeadersStatus<ResponseHeaders>\n+  {\n+    NSLog(\"Adding new header!\")\n+    let builder = headers.toResponseHeadersBuilder()\n+    builder.add(name: \"filter-demo\", value: \"1\")\n+    return .continue(headers: builder.build())\n+  }\n+\n+  func onResponseData(_ body: Data, endStream: Bool) -> FilterDataStatus<ResponseHeaders> {\n+    // TODO(goaway): Can remove this when we have better integration coverage in place.\n+    NSLog(\"Saw data chunk of length \\(body.count)\")", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTY5OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496955698", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                NSLog(\"Adding new header!\")", "author": "rebello95", "createdAt": "2020-09-29T18:36:56Z", "path": "library/swift/test/HttpBridgeTests/DemoFilter.swift", "diffHunk": "@@ -0,0 +1,28 @@\n+import Envoy\n+import Foundation\n+\n+struct DemoFilter: ResponseFilter {\n+  func onResponseHeaders(_ headers: ResponseHeaders, endStream: Bool)\n+    -> FilterHeadersStatus<ResponseHeaders>\n+  {\n+    NSLog(\"Adding new header!\")", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NzczOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496957738", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This test suite tests end-to-end integration of the platform layer to the core layer's HTTP\n          \n          \n            \n            functionality. It tests both the request side sendHeaders/Data,Close,Cancel; and the response\n          \n          \n            \n            side via all the setOnResponseHeaders/Data,setOnError,setOnCancel.\n          \n          \n            \n            \n          \n          \n            \n            Note: These tests are broke apart into different suites and bazel targets in order to tear down\n          \n          \n            \n            app state --and thus static lifetime objects like the Envoy engine -- between tests. When\n          \n          \n            \n            multiple engine support (https://github.com/lyft/envoy-mobile/issues/332) lands, all of these\n          \n          \n            \n            tests can be collapsed to the same suite/target.\n          \n          \n            \n            \n          \n          \n            \n            TODO: setOnTrailers is not tested as the neither the direct_response pathway, nor the router\n          \n          \n            \n            allow sending trailers programmatically. Add tests once possible.\n          \n          \n            \n            This test suite tests end-to-end integration of the platform layer and the core layer's HTTP\n          \n          \n            \n            functionality. It tests both the request side `send{Headers|Data}`, `close`, `cancel`,\n          \n          \n            \n            as well as the response side via all the` setOnResponse{...}` functions.\n          \n          \n            \n            \n          \n          \n            \n            TODO: These tests are broken apart into different suites and bazel targets in order to tear down\n          \n          \n            \n            app state - and thus static lifetime objects like the Envoy engine - between tests. When\n          \n          \n            \n            multiple engine support (https://github.com/lyft/envoy-mobile/issues/332) lands, all of these\n          \n          \n            \n            tests can be collapsed to the same suite/target.\n          \n          \n            \n            \n          \n          \n            \n            TODO: setOnTrailers is not tested as neither the `direct_response` pathway, nor the router\n          \n          \n            \n            allow sending trailers programmatically. Add tests once possible.", "author": "rebello95", "createdAt": "2020-09-29T18:40:40Z", "path": "library/swift/test/HttpBridgeTests/README.md", "diffHunk": "@@ -0,0 +1,11 @@\n+This test suite tests end-to-end integration of the platform layer to the core layer's HTTP\n+functionality. It tests both the request side sendHeaders/Data,Close,Cancel; and the response\n+side via all the setOnResponseHeaders/Data,setOnError,setOnCancel.\n+\n+Note: These tests are broke apart into different suites and bazel targets in order to tear down\n+app state --and thus static lifetime objects like the Envoy engine -- between tests. When\n+multiple engine support (https://github.com/lyft/envoy-mobile/issues/332) lands, all of these\n+tests can be collapsed to the same suite/target.\n+\n+TODO: setOnTrailers is not tested as the neither the direct_response pathway, nor the router\n+allow sending trailers programmatically. Add tests once possible.", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1ODA5Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496958096", "bodyText": "If you want you could put one of these at the top of the individual file and do // swiftlint:disable line_length", "author": "rebello95", "createdAt": "2020-09-29T18:41:11Z", "path": "library/swift/test/HttpBridgeTests/ReceiveDataTest.swift", "diffHunk": "@@ -0,0 +1,78 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class ReceiveDataTests: XCTestCase {\n+  func testReceiveData() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    // swiftlint:disable:next line_length", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk4MTkyMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496981920", "bodyText": "just want to do these specific lines", "author": "junr03", "createdAt": "2020-09-29T19:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1ODA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1OTQyMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496959423", "bodyText": "We should add a second expectation here and wait for it below as well - there's no validation as-is that this assert is actually called", "author": "rebello95", "createdAt": "2020-09-29T18:43:27Z", "path": "library/swift/test/HttpBridgeTests/ReceiveDataTest.swift", "diffHunk": "@@ -0,0 +1,78 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class ReceiveDataTests: XCTestCase {\n+  func testReceiveData() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    // swiftlint:disable:next line_length\n+    let assertionFilterType = \"type.googleapis.com/envoymobile.extensions.filters.http.assertion.Assertion\"\n+    let config =\n+    \"\"\"\n+    static_resources:\n+      listeners:\n+      - name: base_api_listener\n+        address:\n+          socket_address:\n+            protocol: TCP\n+            address: 0.0.0.0\n+            port_value: 10000\n+        api_listener:\n+          api_listener:\n+            \"@type\": \\(apiListenerType)\n+            stat_prefix: hcm\n+            route_config:\n+              name: api_router\n+              virtual_hosts:\n+                - name: api\n+                  domains:\n+                    - \"*\"\n+                  routes:\n+                    - match:\n+                        prefix: \"/\"\n+                      direct_response:\n+                        status: 200\n+                        body:\n+                          inline_string: response_body\n+            http_filters:\n+              - name: envoy.filters.http.assertion\n+                typed_config:\n+                  \"@type\": \\(assertionFilterType)\n+                  match_config:\n+                    http_request_headers_match:\n+                      headers:\n+                        - name: \":authority\"\n+                          exact_match: example.com\n+              - name: envoy.router\n+                typed_config:\n+                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n+    \"\"\"\n+    let expectation = self.expectation(description: \"Run called with expected data\")\n+    let client = try EngineBuilder(yaml: config)\n+      .addLogLevel(.debug)\n+      .addFilter(factory: DemoFilter.init)\n+      .build()\n+      .streamClient()\n+\n+    let requestHeaders = RequestHeadersBuilder(method: .get, scheme: \"https\",\n+                                               authority: \"example.com\", path: \"/test\")\n+      .addUpstreamHttpProtocol(.http2)\n+      .build()\n+    client\n+      .newStreamPrototype()\n+      .setOnResponseHeaders { responseHeaders, _ in\n+         XCTAssertEqual(200, responseHeaders.httpStatus)", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk4MjcxNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496982717", "bodyText": "How come there isn't? If the expectation below doesn't fulfill then the test will fail. Meaning that if the test finishes, this code must have ran?", "author": "junr03", "createdAt": "2020-09-29T19:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1OTQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAwMjM1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r497002359", "bodyText": "My concern is that it relies on the (hopefully always valid) assumption that onResponseData will always be called after onResponseHeaders (since the expectation being fulfilled is fulfilled upon receiving response data, but nothing is explicitly fulfilled on headers). Adding an expectation here would prevent the theoretical issue of the filter responding with data callbacks but no headers", "author": "rebello95", "createdAt": "2020-09-29T19:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1OTQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1OTY4MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496959681", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    let responseBody = String(decoding: data, as: UTF8.self)\n          \n          \n            \n                    let responseBody = String(data: data, encoding: .utf8)", "author": "rebello95", "createdAt": "2020-09-29T18:43:55Z", "path": "library/swift/test/HttpBridgeTests/ReceiveDataTest.swift", "diffHunk": "@@ -0,0 +1,78 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class ReceiveDataTests: XCTestCase {\n+  func testReceiveData() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    // swiftlint:disable:next line_length\n+    let assertionFilterType = \"type.googleapis.com/envoymobile.extensions.filters.http.assertion.Assertion\"\n+    let config =\n+    \"\"\"\n+    static_resources:\n+      listeners:\n+      - name: base_api_listener\n+        address:\n+          socket_address:\n+            protocol: TCP\n+            address: 0.0.0.0\n+            port_value: 10000\n+        api_listener:\n+          api_listener:\n+            \"@type\": \\(apiListenerType)\n+            stat_prefix: hcm\n+            route_config:\n+              name: api_router\n+              virtual_hosts:\n+                - name: api\n+                  domains:\n+                    - \"*\"\n+                  routes:\n+                    - match:\n+                        prefix: \"/\"\n+                      direct_response:\n+                        status: 200\n+                        body:\n+                          inline_string: response_body\n+            http_filters:\n+              - name: envoy.filters.http.assertion\n+                typed_config:\n+                  \"@type\": \\(assertionFilterType)\n+                  match_config:\n+                    http_request_headers_match:\n+                      headers:\n+                        - name: \":authority\"\n+                          exact_match: example.com\n+              - name: envoy.router\n+                typed_config:\n+                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n+    \"\"\"\n+    let expectation = self.expectation(description: \"Run called with expected data\")\n+    let client = try EngineBuilder(yaml: config)\n+      .addLogLevel(.debug)\n+      .addFilter(factory: DemoFilter.init)\n+      .build()\n+      .streamClient()\n+\n+    let requestHeaders = RequestHeadersBuilder(method: .get, scheme: \"https\",\n+                                               authority: \"example.com\", path: \"/test\")\n+      .addUpstreamHttpProtocol(.http2)\n+      .build()\n+    client\n+      .newStreamPrototype()\n+      .setOnResponseHeaders { responseHeaders, _ in\n+         XCTAssertEqual(200, responseHeaders.httpStatus)\n+      }\n+      .setOnResponseData { data, _ in\n+        let responseBody = String(decoding: data, as: UTF8.self)", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MjI2NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r496962265", "bodyText": "Would it make sense to document lower in the test that Envoy Mobile maps a 503 to an EnvoyError which is what's being tested?", "author": "rebello95", "createdAt": "2020-09-29T18:48:28Z", "path": "library/swift/test/HttpBridgeTests/ReceiveErrorTest.swift", "diffHunk": "@@ -0,0 +1,69 @@\n+import Envoy\n+import EnvoyEngine\n+import Foundation\n+import XCTest\n+\n+final class ReceiveErrorTests: XCTestCase {\n+  func testReceiveError() throws {\n+    // swiftlint:disable:next line_length\n+    let apiListenerType = \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\"\n+    // swiftlint:disable:next line_length\n+    let assertionFilterType = \"type.googleapis.com/envoymobile.extensions.filters.http.assertion.Assertion\"\n+    let config =\n+    \"\"\"\n+    static_resources:\n+      listeners:\n+      - name: base_api_listener\n+        address:\n+          socket_address:\n+            protocol: TCP\n+            address: 0.0.0.0\n+            port_value: 10000\n+        api_listener:\n+          api_listener:\n+            \"@type\": \\(apiListenerType)\n+            stat_prefix: hcm\n+            route_config:\n+              name: api_router\n+              virtual_hosts:\n+                - name: api\n+                  domains:\n+                    - \"*\"\n+                  routes:\n+                    - match:\n+                        prefix: \"/\"\n+                      direct_response:\n+                        status: 503", "originalCommit": "326f349c71c90f31f64f89fcaf9aa7748545693b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33b8bc9a84d44938fe29e9c894b3b9de1167fb34", "url": "https://github.com/envoyproxy/envoy-mobile/commit/33b8bc9a84d44938fe29e9c894b3b9de1167fb34", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T19:30:39Z", "type": "commit"}, {"oid": "b1c8dfa16c6846763f4450253dc97960c92263f2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b1c8dfa16c6846763f4450253dc97960c92263f2", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T20:28:23Z", "type": "commit"}, {"oid": "fad7157babc843855a1d0daa3e14b064580fc9c7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/fad7157babc843855a1d0daa3e14b064580fc9c7", "message": "swiftlint\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-29T21:12:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3OTQ4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1069#discussion_r497079488", "bodyText": "you could also pass enforceOrder: true here if you want", "author": "rebello95", "createdAt": "2020-09-29T21:46:20Z", "path": "library/swift/test/HttpBridgeTests/ReceiveDataTest.swift", "diffHunk": "@@ -60,19 +59,24 @@ final class ReceiveDataTests: XCTestCase {\n                                                authority: \"example.com\", path: \"/test\")\n       .addUpstreamHttpProtocol(.http2)\n       .build()\n+\n+    let headersExpectation = self.expectation(description: \"Run called with expected headers\")\n+    let dataExpectation = self.expectation(description: \"Run called with expected data\")\n+\n     client\n       .newStreamPrototype()\n       .setOnResponseHeaders { responseHeaders, _ in\n          XCTAssertEqual(200, responseHeaders.httpStatus)\n+         headersExpectation.fulfill()\n       }\n       .setOnResponseData { data, _ in\n         let responseBody = String(data: data, encoding: .utf8)\n         XCTAssertEqual(\"response_body\", responseBody)\n-        expectation.fulfill()\n+        dataExpectation.fulfill()\n       }\n       .start()\n       .sendHeaders(requestHeaders, endStream: true)\n \n-    XCTAssertEqual(XCTWaiter.wait(for: [expectation], timeout: 1), .completed)\n+    XCTAssertEqual(XCTWaiter.wait(for: [headersExpectation, dataExpectation], timeout: 1), .completed)", "originalCommit": "b1c8dfa16c6846763f4450253dc97960c92263f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "542240463ba43ddfca47cb05be48834b81c8df42", "url": "https://github.com/envoyproxy/envoy-mobile/commit/542240463ba43ddfca47cb05be48834b81c8df42", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-30T00:30:16Z", "type": "commit"}, {"oid": "7b631152d697554caa0d4224caa4daa34c48289a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7b631152d697554caa0d4224caa4daa34c48289a", "message": "Merge remote-tracking branch 'origin/main' into swift-tests\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-30T18:56:10Z", "type": "commit"}]}