{"pr_number": 697, "pr_title": "upsteam protocol: add the ability to decide what protocol to use for upstream requests", "pr_createdAt": "2020-02-20T06:40:56Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/697", "timeline": [{"oid": "602ecf05492b70aee3bb3e030ca12b4a87fcb1a4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/602ecf05492b70aee3bb3e030ca12b4a87fcb1a4", "message": "upstream protocol: add the ability to use h2\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T06:11:01Z", "type": "commit"}, {"oid": "4b4e7eb8774953ba56be68b5b0f1432687fd1c44", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4b4e7eb8774953ba56be68b5b0f1432687fd1c44", "message": "build files\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T06:12:59Z", "type": "commit"}, {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "message": "examples\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T06:34:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgwODA2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381808068", "bodyText": "I'd suggest moving this out of the constructor, and adding it via a builder method.", "author": "goaway", "createdAt": "2020-02-20T06:45:18Z", "path": "docs/root/api/http.rst", "diffHunk": "@@ -17,15 +17,15 @@ a previously created :ref:`Envoy instance <api_starting_envoy>`.\n \n **Kotlin**::\n \n-  val request = RequestBuilder(RequestMethod.POST, \"https\", \"api.envoyproxy.io\", \"/foo\")\n+  val request = RequestBuilder(RequestMethod.POST, \"https\", \"api.envoyproxy.io\", \"/foo\", upstreamHttpProtocol = UpstreamRequestProtocol.HTTP2)\n     .addRetryPolicy(RetryPolicy(...))\n     .addHeader(\"x-custom-header\", \"foobar\")\n     ...\n     .build()\n \n **Swift**::\n \n-  let request = RequestBuilder(method: .post, scheme: \"https\", authority: \"api.envoyproxy.io\", path: \"/foo\")\n+  let request = RequestBuilder(method: .post, scheme: \"https\", authority: \"api.envoyproxy.io\", path: \"/foo\", upstreamHttpProtocol: .http2)", "originalCommit": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1MjIxMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382152213", "bodyText": "+1 to this suggestion. addUpstreamProtocol?", "author": "rebello95", "createdAt": "2020-02-20T17:36:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgwODA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgwOTQ1OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381809458", "bodyText": "I propose simplifying this with a x-envoy-mobile-force-h2 header. If a header with this name is present assume inferred h2 support, if not, default to h1.", "author": "goaway", "createdAt": "2020-02-20T06:47:51Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -477,19 +477,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};", "originalCommit": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "28b703339f6ee5181f1055f16f69eea7e12a3e7a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/28b703339f6ee5181f1055f16f69eea7e12a3e7a", "message": "uncomment\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T06:49:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgxMDI3Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381810272", "bodyText": "nit: this would actually be one less line of code if you just used literals ;)", "author": "goaway", "createdAt": "2020-02-20T06:49:22Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -477,19 +477,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};\n+const std::string H2Suffix = \"_h2\";\n+const std::string BaseClusterH2 = BaseCluster + H2Suffix;\n+const std::string BaseWlanClusterH2 = BaseWlanCluster + H2Suffix;\n+const std::string BaseWwanClusterH2 = BaseWwanCluster + H2Suffix;", "originalCommit": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgxMTA1Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381811057", "bodyText": "Can drop this enum if we just use a single header to force h2 (which is sort of non-standard anyways and only works with known destinations).", "author": "goaway", "createdAt": "2020-02-20T06:50:40Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/UpstreamHttpProtocol.kt", "diffHunk": "@@ -0,0 +1,9 @@\n+package io.envoyproxy.envoymobile\n+\n+/**\n+ * Available upstream http protocols.\n+ */\n+enum class UpstreamHttpProtocol(internal val stringValue: String) {\n+  HTTP1(\"http1\"),\n+  HTTP2(\"http2\"),\n+}", "originalCommit": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6db464daf997befd9b2b428d50f0fb09b6067a3b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6db464daf997befd9b2b428d50f0fb09b6067a3b", "message": "Merge branch 'master' into h2\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T17:30:14Z", "type": "commit"}, {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6", "url": "https://github.com/envoyproxy/envoy-mobile/commit/088ce93868d7eef83e61f9348b035644ed23d6b6", "message": "fix\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T17:35:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1MzYyMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382153623", "bodyText": "do you think it's worth asserting in the else case if the caller specifies a value that's unsupported?", "author": "rebello95", "createdAt": "2020-02-20T17:39:02Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -478,19 +478,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};\n+const std::string H2Suffix = \"_h2\";\n+const std::string BaseClusterH2 = BaseCluster + H2Suffix;\n+const std::string BaseWlanClusterH2 = BaseWlanCluster + H2Suffix;\n+const std::string BaseWwanClusterH2 = BaseWwanCluster + H2Suffix;\n } // namespace\n \n-void Dispatcher::attachPreferredNetwork(HeaderMap& headers) {\n+void Dispatcher::setDestinationCluster(HeaderMap& headers) {\n+\n+  // Determine upstream protocol. Use http2 if selected for explicitly, otherwise (any other value,\n+  // absence of value) select http1.\n+  // TODO(junr03): once http3 is available this would probably benefit from some sort of struct that\n+  // maps to appropriate cluster names. However, with only two options (http1/2) this suffices.\n+  bool use_h2_cluster{};\n+  const HeaderEntry* entry = headers.get(H2UpstreamHeader);\n+  if (entry) {\n+    if (entry->value() == \"http2\") {\n+      use_h2_cluster = true;\n+    }", "originalCommit": "088ce93868d7eef83e61f9348b035644ed23d6b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1NDAyMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382154020", "bodyText": "nit: I think we should prefer HTTP over Http on all of these, in line with how we use MS for milliseconds over Ms. wdyt?", "author": "rebello95", "createdAt": "2020-02-20T17:39:48Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/Request.kt", "diffHunk": "@@ -7,12 +7,14 @@ package io.envoyproxy.envoymobile\n  * @param scheme The URL scheme for the request (i.e., \"https\").\n  * @param authority The URL authority for the request (i.e., \"api.foo.com\").\n  * @param path The URL path for the request (i.e., \"/foo\").\n+ * @param upstreamHttpProtocol The protcol version to use for upstream requests.\n  */\n data class Request internal constructor(\n     val method: RequestMethod,\n     val scheme: String,\n     val authority: String,\n     val path: String,\n+    val upstreamHttpProtocol: UpstreamHttpProtocol,", "originalCommit": "088ce93868d7eef83e61f9348b035644ed23d6b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMzgyNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382313824", "bodyText": "I feel conflicted because in the envoy codebase we dont use all caps...", "author": "junr03", "createdAt": "2020-02-20T23:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1NDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDczMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382314733", "bodyText": "Eh just leave it I guess", "author": "rebello95", "createdAt": "2020-02-20T23:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1NDAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1NDc2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382154768", "bodyText": "Changing this to a builder as @goaway suggested would allow for reverting a lot of these test changes", "author": "rebello95", "createdAt": "2020-02-20T17:41:10Z", "path": "library/kotlin/test/io/envoyproxy/envoymobile/RequestMapperTest.kt", "diffHunk": "@@ -123,7 +145,7 @@ class RequestMapperTest {\n         perRetryTimeoutMS = 9001)\n     val retryPolicyHeaders = retryPolicy.outboundHeaders()\n \n-    val requestHeaders = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"/foo\")\n+    val requestHeaders = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"/foo\", upstreamHttpProtocol = UpstreamHttpProtocol.HTTP2)", "originalCommit": "088ce93868d7eef83e61f9348b035644ed23d6b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE2MDkyNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382160927", "bodyText": "Yep, I like the suggestion to move out to the builder. It would also make it easier to deprecate if we want to move into an only ALPN-based future when that is supported.", "author": "junr03", "createdAt": "2020-02-20T17:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1NDc2OA=="}], "type": "inlineReview"}, {"oid": "65d757e3f9a5580b5300e03aff214a2ff40db42b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/65d757e3f9a5580b5300e03aff214a2ff40db42b", "message": "move out of constructor\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T21:04:49Z", "type": "commit"}, {"oid": "98522685049351405eabb9607de26f13010a9192", "url": "https://github.com/envoyproxy/envoy-mobile/commit/98522685049351405eabb9607de26f13010a9192", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T21:10:54Z", "type": "commit"}, {"oid": "5e0d1e681c325f1684045e8da8425d67a33ebf36", "url": "https://github.com/envoyproxy/envoy-mobile/commit/5e0d1e681c325f1684045e8da8425d67a33ebf36", "message": "examples\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T21:24:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI2NzQwMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382267402", "bodyText": "moving below for consistent ordering with swift", "author": "junr03", "createdAt": "2020-02-20T21:28:07Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestBuilder.kt", "diffHunk": "@@ -22,16 +22,8 @@ class RequestBuilder(\n   // Retry policy to use for this request.\n   private var retryPolicy: RetryPolicy? = null\n \n-  /**", "originalCommit": "5e0d1e681c325f1684045e8da8425d67a33ebf36", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "059025d7d54a189ce1fc1f8557bc872aaa29052d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/059025d7d54a189ce1fc1f8557bc872aaa29052d", "message": "java\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T21:29:26Z", "type": "commit"}, {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e9f87fcfa9a6a0637523073d027b980d266b731b", "message": "fix\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T21:50:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MTU2NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382281564", "bodyText": "Can we update objc/java too?", "author": "rebello95", "createdAt": "2020-02-20T21:59:46Z", "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -49,7 +49,9 @@ final class ViewController: UITableViewController {\n     let requestID = self.requestCount\n     let request = RequestBuilder(method: .get, scheme: kRequestScheme,\n                                  authority: kRequestAuthority,\n-                                 path: kRequestPath).build()\n+                                 path: kRequestPath, upstreamHttpProtocol: .http2)\n+        .addUpstreamHttpProtocol(.http2)", "originalCommit": "e9f87fcfa9a6a0637523073d027b980d266b731b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMjM5Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382312397", "bodyText": "I intentionally left this with h1 so we have coverage for both paths. I can drop a comment in the examples to make this explicit.", "author": "junr03", "createdAt": "2020-02-20T23:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MTU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDU0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382314543", "bodyText": "Comment would be nice \ud83d\udc4d", "author": "rebello95", "createdAt": "2020-02-20T23:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MTU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4Mjk1NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382282955", "bodyText": "Also seems like this should be use_h2_cluster = entry->value() == \"http2\"", "author": "rebello95", "createdAt": "2020-02-20T22:02:49Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -478,19 +478,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};\n+const std::string H2Suffix = \"_h2\";\n+const std::string BaseClusterH2 = BaseCluster + H2Suffix;\n+const std::string BaseWlanClusterH2 = BaseWlanCluster + H2Suffix;\n+const std::string BaseWwanClusterH2 = BaseWwanCluster + H2Suffix;\n } // namespace\n \n-void Dispatcher::attachPreferredNetwork(HeaderMap& headers) {\n+void Dispatcher::setDestinationCluster(HeaderMap& headers) {\n+\n+  // Determine upstream protocol. Use http2 if selected for explicitly, otherwise (any other value,\n+  // absence of value) select http1.\n+  // TODO(junr03): once http3 is available this would probably benefit from some sort of struct that\n+  // maps to appropriate cluster names. However, with only two options (http1/2) this suffices.\n+  bool use_h2_cluster{};\n+  const HeaderEntry* entry = headers.get(H2UpstreamHeader);\n+  if (entry) {\n+    if (entry->value() == \"http2\") {\n+      use_h2_cluster = true;", "originalCommit": "e9f87fcfa9a6a0637523073d027b980d266b731b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMzM2NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382313365", "bodyText": "I want the else for the assertion. I guess I could do\nuse_h2_cluster = entry->value() == \"http2\"\nif (!use_h2_cluster) { ASSERT(entry->value()->getStringView() == \"http1\"); }\n\nsix of one half a dozen of the other?", "author": "junr03", "createdAt": "2020-02-20T23:19:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4Mjk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxNDY2Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382314662", "bodyText": "I think what you have now is fine", "author": "rebello95", "createdAt": "2020-02-20T23:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4Mjk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MzY3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382283677", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              fun `not adding upstream http protocol should have null body in request`() {\n          \n          \n            \n              fun `not adding upstream http protocol should have null upstream protocol in request`() {", "author": "rebello95", "createdAt": "2020-02-20T22:04:16Z", "path": "library/kotlin/test/io/envoyproxy/envoymobile/RequestBuilderTest.kt", "diffHunk": "@@ -24,6 +24,25 @@ class RequestBuilderTest {\n     assertThat(request.retryPolicy).isNull()\n   }\n \n+  @Test\n+  fun `adding upstream http protocol should have hint present in request`() {\n+\n+    val retryPolicy = RetryPolicy(maxRetryCount = 23, retryOn = listOf(RetryRule.STATUS_5XX, RetryRule.CONNECT_FAILURE), perRetryTimeoutMS = 1234)\n+    val request = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"foo\")\n+        .addUpstreamHttpProtocol(UpstreamHttpProtocol.HTTP2)\n+        .build()\n+\n+    assertThat(request.upstreamHttpProtocol).isEqualTo(UpstreamHttpProtocol.HTTP2)\n+  }\n+\n+  @Test\n+  fun `not adding upstream http protocol should have null body in request`() {", "originalCommit": "e9f87fcfa9a6a0637523073d027b980d266b731b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MzkyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382283929", "bodyText": "I'd probably make this a different test or update the name of the test", "author": "rebello95", "createdAt": "2020-02-20T22:04:52Z", "path": "library/kotlin/test/io/envoyproxy/envoymobile/RequestMapperTest.kt", "diffHunk": "@@ -57,24 +77,29 @@ class RequestMapperTest {\n   fun `invalid semicolon prefixed header keys are filtered out of outbound request headers`() {\n     val requestHeaders = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"/foo\")\n         .addHeader(\":restricted\", \"value\")\n+        .addHeader(\"x-envoy-mobile-test\", \"value\")", "originalCommit": "e9f87fcfa9a6a0637523073d027b980d266b731b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDAzMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382284033", "bodyText": "could use \"restricted headers\" like the other test below", "author": "rebello95", "createdAt": "2020-02-20T22:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MzkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDQ5MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382284491", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            private let kRestrictedHeaderPrefix = [\":\", \"x-envoy-mobile\"]\n          \n          \n            \n            private let kRestrictedHeaderPrefixes = [\":\", \"x-envoy-mobile\"]", "author": "rebello95", "createdAt": "2020-02-20T22:06:11Z", "path": "library/swift/src/RequestMapper.swift", "diffHunk": "@@ -1,4 +1,4 @@\n-private let kRestrictedHeaderPrefix = \":\"\n+private let kRestrictedHeaderPrefix = [\":\", \"x-envoy-mobile\"]", "originalCommit": "e9f87fcfa9a6a0637523073d027b980d266b731b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDcyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382284729", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// String representation of the log level.\n          \n          \n            \n              /// String representation of the protocol.", "author": "rebello95", "createdAt": "2020-02-20T22:06:45Z", "path": "library/swift/src/UpstreamHttpProtocol.swift", "diffHunk": "@@ -0,0 +1,18 @@\n+import Foundation\n+\n+/// Available upstream http protocols.\n+@objc\n+public enum UpstreamHttpProtocol: Int {\n+  case http1\n+  case http2\n+\n+  /// String representation of the log level.", "originalCommit": "e9f87fcfa9a6a0637523073d027b980d266b731b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDc3Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382284772", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            /// Available upstream http protocols.\n          \n          \n            \n            /// Available upstream HTTP protocols.", "author": "rebello95", "createdAt": "2020-02-20T22:06:51Z", "path": "library/swift/src/UpstreamHttpProtocol.swift", "diffHunk": "@@ -0,0 +1,18 @@\n+import Foundation\n+\n+/// Available upstream http protocols.", "originalCommit": "e9f87fcfa9a6a0637523073d027b980d266b731b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "86c55fa72aa6c7383bfa1524958efae8885f209c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/86c55fa72aa6c7383bfa1524958efae8885f209c", "message": "polish\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T23:12:15Z", "type": "commit"}, {"oid": "d4c65c16d3e2e550e1a8b6f1c723faf778b5595e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d4c65c16d3e2e550e1a8b6f1c723faf778b5595e", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T23:15:45Z", "type": "commit"}, {"oid": "1719bfafd1c9aba5d874ee4c5abf699a2b7fa80f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1719bfafd1c9aba5d874ee4c5abf699a2b7fa80f", "message": "example comment\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-20T23:43:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTA3MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382325070", "bodyText": "Up to you but using this might be more readable: !entry.key.startsWith(\":\") && !entry.key.startsWith(\"x-envoy-mobile\")", "author": "rebello95", "createdAt": "2020-02-20T23:52:12Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestMapper.kt", "diffHunk": "@@ -4,13 +4,17 @@ internal fun Request.outboundHeaders(): Map<String, List<String>> {\n   val retryPolicyHeaders = retryPolicy?.outboundHeaders() ?: emptyMap()\n \n   val result = mutableMapOf<String, List<String>>()\n-  result.putAll(headers.filter { entry -> !entry.key.startsWith(\":\") })\n+  result.putAll(headers.filter { entry -> !(entry.key.startsWith(\":\") || entry.key.startsWith(\"x-envoy-mobile\"))})", "originalCommit": "1719bfafd1c9aba5d874ee4c5abf699a2b7fa80f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMzMTM2NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382331364", "bodyText": "I am always ambivalent about which one is more readable. I'll change to kick CI... \ud83d\udca9", "author": "junr03", "createdAt": "2020-02-21T00:13:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMzMTU0Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382331542", "bodyText": "\ud83d\ude2d", "author": "rebello95", "createdAt": "2020-02-21T00:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTA3MA=="}], "type": "inlineReview"}, {"oid": "95cbe86eefa700869ddb2b4601f8d6fd65950e53", "url": "https://github.com/envoyproxy/envoy-mobile/commit/95cbe86eefa700869ddb2b4601f8d6fd65950e53", "message": "demorgans\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-21T00:14:13Z", "type": "commit"}, {"oid": "a30fab9932e3e4bd0af7e08452428e234de461bd", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a30fab9932e3e4bd0af7e08452428e234de461bd", "message": "fix example\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-02-21T17:35:48Z", "type": "commit"}]}