{"pr_number": 1202, "pr_title": "ios: add string accessor API", "pr_createdAt": "2020-12-08T00:04:26Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1202", "timeline": [{"oid": "f4e77f97118d3008a0e07d70d3ad1a1048495b0e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f4e77f97118d3008a0e07d70d3ad1a1048495b0e", "message": "ios: add string accessor API\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-08T00:03:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r537929646", "bodyText": "@rebello95 do I need a swift protocol to be able to useEnvoyStringAccessor objc protocol on user defined accessors?", "author": "junr03", "createdAt": "2020-12-08T00:05:54Z", "path": "examples/swift/hello_world/DemoStringAccessor.swift", "diffHunk": "@@ -0,0 +1,9 @@\n+import Envoy\n+import Foundation\n+\n+/// Example of a simple HTTP filter that adds a response header.\n+struct DemoStringAccessor: EnvoyStringAccessor {", "originalCommit": "f4e77f97118d3008a0e07d70d3ad1a1048495b0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkzNjg4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r537936889", "bodyText": "Sorry can you elaborate? I'm not sure what you're asking", "author": "rebello95", "createdAt": "2020-12-08T00:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4NTExOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r538785118", "bodyText": "The high level question is: I want DemoStringAccessor to implement the EnvoyStringAccessor interface, but I am not sure how to import EnvoyStringAccessor to this file.", "author": "junr03", "createdAt": "2020-12-08T20:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5MTE3OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r538791179", "bodyText": "Ah, you won't be able to do that because we only expose Swift types externally from Envoy.framework. You'd need to declare a public protocol in Swift instead. However, per my comments below I still think we should be registering lambdas/closures instead of a type with a getString() method", "author": "rebello95", "createdAt": "2020-12-08T20:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczMzY2OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r544733669", "bodyText": "@rebello95 finally having the space to come back to this. The idea here is that the EnvoyStringAccessor protocol/interface will eventually be made into a generic getter/setter of arbitrary types across the bridge layer (#1192). So I wanted to have a concrete type rather than free-floating lambdas.\nHowever, I can see us exposing the engine builder API as registering a lambda, and then the objc code builds an object around it. The only friction is that I would need to redo the kotlin code to maintain cross-platform homogeneity.", "author": "junr03", "createdAt": "2020-12-17T01:02:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczODIyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r544738225", "bodyText": "Yea personally I'd opt towards the lambda option since that's more consistent with the other APIs Envoy Mobile exposes today (request/response/stream callbacks, for example), and it solves the ambiguity concern around something called getString(). @buildbreaker do you have thoughts?", "author": "rebello95", "createdAt": "2020-12-17T01:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM3NzM1Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r545377356", "bodyText": "@rebello95 Yeah, I remember chatting with @junr03 on this. He wanted to use an object/class here because it allows us to extend/add more accessors for data. Would you be open to a rename of said object instead?\nOne alternative that I just thought about is if we have a lambda like ()->AccessorObject and have the AccessorObject just be the extensible metadata object.", "author": "buildbreaker", "createdAt": "2020-12-17T20:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyNDQzOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r545424439", "bodyText": "Talked with @junr03 about this a bit more offline (thank you both for responding). I'm ok with this general approach of allowing the consumer to register instances of different types that conform to this relatively generic protocol, assuming the intent is that those types are registered within specific contexts.\nMaybe the naming of this would help improve a bit?\nprotocol EnvoyStringAccessor: NSObject {\n    func envoyStringValue() -> String\n}\nAlso it sounds like Java is currently exposing this interface up to the platform; we should switch that over to Kotlin", "author": "rebello95", "createdAt": "2020-12-17T21:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkyOTY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkzNzI2Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r537937266", "bodyText": "Have we considered registering a lambda/closure that returns a string instead? That'll probably be easier to interact with on the platform layer, since getString() is a little overly generic IMO", "author": "rebello95", "createdAt": "2020-12-08T00:25:17Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -261,6 +268,17 @@ - (int)registerFilterFactory:(EnvoyHTTPFilterFactory *)filterFactory {\n   return kEnvoySuccess;\n }\n \n+- (int)registerStringAccessor:(NSString *)name\n+               stringAccessor:(EnvoyStringAccessor *)stringAccessor {", "originalCommit": "f4e77f97118d3008a0e07d70d3ad1a1048495b0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09e3750d0dad801df45849a5e59ec80c9eb36cb0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/09e3750d0dad801df45849a5e59ec80c9eb36cb0", "message": "Merge branch 'main' into ios-string-accessor\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-17T22:49:27Z", "type": "commit"}, {"oid": "a5e8a9a66e601447a2369718e78f1363ba4fc294", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a5e8a9a66e601447a2369718e78f1363ba4fc294", "message": "type trouble\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-18T01:49:45Z", "type": "commit"}, {"oid": "7db0f01d031ed55c2bd4e15195991a521acb68ee", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7db0f01d031ed55c2bd4e15195991a521acb68ee", "message": "updated\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-19T00:41:49Z", "type": "commit"}, {"oid": "a01d50feb5d75b591e42363f55e10b67c23f2004", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a01d50feb5d75b591e42363f55e10b67c23f2004", "message": "test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-19T01:25:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MDk2OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r546170969", "bodyText": "You could use a for loop here like on line 313 above \ud83e\udd37\ud83c\udffd\u200d\u2642\ufe0f", "author": "rebello95", "createdAt": "2020-12-19T01:30:57Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -297,6 +314,10 @@ - (int)runWithConfig:(EnvoyConfiguration *)config\n     [self registerFilterFactory:filterFactory];\n   }\n \n+  [config.stringAccessors enumerateKeysAndObjectsUsingBlock:^(id name, id accessor, BOOL *stop) {", "originalCommit": "a01d50feb5d75b591e42363f55e10b67c23f2004", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MDk3OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r546170978", "bodyText": "Same here", "author": "rebello95", "createdAt": "2020-12-19T01:31:01Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -313,6 +334,10 @@ - (int)runWithTemplate:(NSString *)yaml\n     [self registerFilterFactory:filterFactory];\n   }\n \n+  [config.stringAccessors enumerateKeysAndObjectsUsingBlock:^(id name, id accessor, BOOL *stop) {", "originalCommit": "a01d50feb5d75b591e42363f55e10b67c23f2004", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTE0Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r546171142", "bodyText": "A better test might be doing XCTAssertEqual(\"hello\", config.stringAccessors. getEnvoyString())", "author": "rebello95", "createdAt": "2020-12-19T01:32:16Z", "path": "library/swift/test/EngineBuilderTests.swift", "diffHunk": "@@ -199,6 +199,20 @@ final class EngineBuilderTests: XCTestCase {\n     self.waitForExpectations(timeout: 0.01)\n   }\n \n+  func testAddingStringAccessorToConfigurationWhenRunningEnvoy() throws {\n+    let expectation = self.expectation(description: \"Run called with expected data\")\n+    MockEnvoyEngine.onRunWithConfig = { config, _ in\n+      XCTAssertEqual(1, config.stringAccessors.count)", "originalCommit": "a01d50feb5d75b591e42363f55e10b67c23f2004", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MTE4MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r546171181", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  .addStringAccessor(name: \"name\", accessor: { return \"hello\"})\n          \n          \n            \n                  .addStringAccessor(name: \"name\", accessor: { \"hello\" })\n          \n      \n    \n    \n  \n\nThis is equivalent if you want", "author": "rebello95", "createdAt": "2020-12-19T01:32:30Z", "path": "library/swift/test/EngineBuilderTests.swift", "diffHunk": "@@ -199,6 +199,20 @@ final class EngineBuilderTests: XCTestCase {\n     self.waitForExpectations(timeout: 0.01)\n   }\n \n+  func testAddingStringAccessorToConfigurationWhenRunningEnvoy() throws {\n+    let expectation = self.expectation(description: \"Run called with expected data\")\n+    MockEnvoyEngine.onRunWithConfig = { config, _ in\n+      XCTAssertEqual(1, config.stringAccessors.count)\n+      expectation.fulfill()\n+    }\n+\n+    _ = try EngineBuilder()\n+      .addEngineType(MockEnvoyEngine.self)\n+      .addStringAccessor(name: \"name\", accessor: { return \"hello\"})", "originalCommit": "a01d50feb5d75b591e42363f55e10b67c23f2004", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b2d74405c81a5954b3d3d3e0dbe69a7eb9721256", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b2d74405c81a5954b3d3d3e0dbe69a7eb9721256", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-19T01:32:58Z", "type": "commit"}, {"oid": "754f1913739cb6507e85b9458ae7d3609a84c34c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/754f1913739cb6507e85b9458ae7d3609a84c34c", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-01-08T19:36:25Z", "type": "commit"}, {"oid": "54ebd895b19e3530d81b1d46cd09701174018a6f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/54ebd895b19e3530d81b1d46cd09701174018a6f", "message": "Merge branch 'main' into ios-string-accessor\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-01-08T19:36:54Z", "type": "commit"}, {"oid": "ac0cecf40ff943fa3f16ed92f5c9579b08925ea4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ac0cecf40ff943fa3f16ed92f5c9579b08925ea4", "message": "test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-01-08T21:50:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4OTcxMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r555289713", "bodyText": "Is this true in the context of a string accessor? Seems like it should be deallocated after usage since this is creating new strings each time it's accessed?", "author": "rebello95", "createdAt": "2021-01-11T19:34:20Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -284,6 +291,16 @@ - (int)registerFilterFactory:(EnvoyHTTPFilterFactory *)filterFactory {\n   return kEnvoySuccess;\n }\n \n+- (int)registerStringAccessor:(NSString *)name accessor:(EnvoyStringAccessor *)accessor {\n+  // TODO(goaway): Everything here leaks, but it's all be tied to the life of the engine.\n+  // This will need to be updated for https://github.com/lyft/envoy-mobile/issues/332", "originalCommit": "ac0cecf40ff943fa3f16ed92f5c9579b08925ea4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM1OTIwNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r555359205", "bodyText": "yeah, still true. The accessor is the object being leaked, and it should be cleaned up.\nThe strings themselves get managed via the existing bridging utilities; the strings get boxed in envoy_data and that gets managed as an envoy buffer, which in turn cleans everything (all the way to the platform layer) when it is destroyed.", "author": "junr03", "createdAt": "2021-01-11T21:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4OTcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM3NjIyNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1202#discussion_r555376227", "bodyText": "got it, sounds good", "author": "rebello95", "createdAt": "2021-01-11T22:18:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4OTcxMw=="}], "type": "inlineReview"}, {"oid": "04e60ea1e447b06fd12c95e934b17f42847d346d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/04e60ea1e447b06fd12c95e934b17f42847d346d", "message": "Merge branch 'main' into ios-string-accessor\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-01-21T17:25:44Z", "type": "commit"}, {"oid": "0b0b5fa651bb2d18d9d0637c9df6aa64fbb11b9b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0b0b5fa651bb2d18d9d0637c9df6aa64fbb11b9b", "message": "const\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-01-22T02:46:36Z", "type": "commit"}, {"oid": "3adeef04e0eb56e1bec743512359016bd012159b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3adeef04e0eb56e1bec743512359016bd012159b", "message": "Merge branch 'main' into ios-string-accessor\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-02-03T19:38:55Z", "type": "commit"}, {"oid": "e304e96660c47ef8496946130b1f11c0df94d16a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e304e96660c47ef8496946130b1f11c0df94d16a", "message": "Merge branch 'main' into ios-string-accessor\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-02-10T19:40:26Z", "type": "commit"}, {"oid": "8003e11fe9bd21754c4a030aaad89e85c0ba6e7b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8003e11fe9bd21754c4a030aaad89e85c0ba6e7b", "message": "test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-02-10T21:49:05Z", "type": "commit"}, {"oid": "2fa38e54f42324d530530dcd8e94a2e7d2ec45ab", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2fa38e54f42324d530530dcd8e94a2e7d2ec45ab", "message": "Revert \"test\"\n\nThis reverts commit 8003e11fe9bd21754c4a030aaad89e85c0ba6e7b.\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2021-02-10T22:57:20Z", "type": "commit"}]}