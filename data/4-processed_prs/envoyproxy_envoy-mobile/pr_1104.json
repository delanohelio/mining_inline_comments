{"pr_number": 1104, "pr_title": "record counter: return envoy_status_t and add interface test", "pr_createdAt": "2020-09-17T01:30:02Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1104", "timeline": [{"oid": "0f2d02e8ac917f78bf2816e20c6230fd7ae42678", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0f2d02e8ac917f78bf2816e20c6230fd7ae42678", "message": "record counter: return envoy_status_t and add interface test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-17T01:26:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk2NDQxMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r489964411", "bodyText": "Since we're here let's add the envoy_engine_t argument as well.", "author": "goaway", "createdAt": "2020-09-17T04:33:01Z", "path": "library/common/engine.h", "diffHunk": "@@ -39,8 +39,9 @@ class Engine {\n    * Increment a counter with a given string of elements and by the given count.\n    * @param elements, joined elements of the timeseries.\n    * @param count, amount to add to the counter.\n+   * @param envoy_status_t, the resulting status of the operation.\n    */\n-  void recordCounter(const std::string& elements, uint64_t count);\n+  envoy_status_t recordCounter(const std::string& elements, uint64_t count);", "originalCommit": "0f2d02e8ac917f78bf2816e20c6230fd7ae42678", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3MTc2NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r490571765", "bodyText": "I wanted to be more selective in this PR and then have that in a subsequent one. wdyt @goaway?", "author": "junr03", "createdAt": "2020-09-17T21:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk2NDQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk2NDYxNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r489964617", "bodyText": "envoy_engine_t arg here too.", "author": "goaway", "createdAt": "2020-09-17T04:33:54Z", "path": "library/common/main_interface.h", "diffHunk": "@@ -98,8 +98,11 @@ envoy_status_t set_preferred_network(envoy_network_t network);\n \n /**\n  * Increment a counter with the given elements and by the given count.\n+ * @param elements, the string that identifies the counter to increment.\n+ * @param count, the count to increment by.\n+ * @param envoy_status_t, the resulting status of the operation.\n  */\n-void record_counter(const char* elements, uint64_t count);\n+envoy_status_t record_counter(const char* elements, uint64_t count);", "originalCommit": "0f2d02e8ac917f78bf2816e20c6230fd7ae42678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "31401e43b12e81b47596a22fc7327189cc2ce895", "url": "https://github.com/envoyproxy/envoy-mobile/commit/31401e43b12e81b47596a22fc7327189cc2ce895", "message": "update\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-17T23:31:35Z", "type": "commit"}, {"oid": "200269156a646f959f27a57faccac6b7ce8c3e8a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/200269156a646f959f27a57faccac6b7ce8c3e8a", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-17T23:31:55Z", "type": "commit"}, {"oid": "2a351a9c11aa07847eea874b14020e54ced6e664", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2a351a9c11aa07847eea874b14020e54ced6e664", "message": "swift tests\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-18T00:32:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNDU1OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r490634558", "bodyText": "@rebello95 I was not able how to import kEnvoySuccess here", "author": "junr03", "createdAt": "2020-09-18T00:33:07Z", "path": "library/swift/test/StatsClientImplTests.swift", "diffHunk": "@@ -19,7 +19,7 @@ final class StatsClientImplTests: XCTestCase {\n     let mockEngine = MockEnvoyEngine()\n     let statsClient = StatsClientImpl(engine: mockEngine)\n     let counter = statsClient.counter(elements: [\"test\", \"stat\"])\n-    counter.increment()\n+    XCTAssertEqual(counter.increment(), 0)", "originalCommit": "2a351a9c11aa07847eea874b14020e54ced6e664", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzQyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r490637429", "bodyText": "If you @testable import EnvoyEngine it should work I believe", "author": "rebello95", "createdAt": "2020-09-18T00:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNDU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzNDkyMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491134922", "bodyText": "worked, thanks!", "author": "junr03", "createdAt": "2020-09-18T18:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNDU1OA=="}], "type": "inlineReview"}, {"oid": "46f0c63db69a3172a71acf99b40578cda0120b8a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/46f0c63db69a3172a71acf99b40578cda0120b8a", "message": "Merge branch 'main' into record-counter\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-18T17:40:13Z", "type": "commit"}, {"oid": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "url": "https://github.com/envoyproxy/envoy-mobile/commit/46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "message": "testing in CI\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-18T17:59:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzODEwMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491138100", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// - returns: A status indicating if the action was successful.\n          \n          \n            \n              public func increment() -> Int32{\n          \n          \n            \n              ///\n          \n          \n            \n              /// - returns: A status indicating if the action was successful.\n          \n          \n            \n              public func increment() -> Int32 {", "author": "rebello95", "createdAt": "2020-09-18T19:03:43Z", "path": "library/swift/src/stats/Counter.swift", "diffHunk": "@@ -4,12 +4,14 @@ import Foundation\n @objc\n public protocol Counter: AnyObject {\n   /// Increment the counter by the given count.\n-  func increment(count: Int)\n+  /// - returns: A status indicating if the action was successful.\n+  func increment(count: Int) -> Int32\n }\n \n extension Counter {\n   /// Increment the counter by 1.\n-  public func increment() {\n+  /// - returns: A status indicating if the action was successful.\n+  public func increment() -> Int32{", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzODI4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491138289", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// - returns: A status indicating if the action was successful.\n          \n          \n            \n              func increment(count: Int) -> Int32\n          \n          \n            \n              ///\n          \n          \n            \n              /// - returns: A status indicating if the action was successful.\n          \n          \n            \n              func increment(count: Int) -> Int32", "author": "rebello95", "createdAt": "2020-09-18T19:04:06Z", "path": "library/swift/src/stats/Counter.swift", "diffHunk": "@@ -4,12 +4,14 @@ import Foundation\n @objc\n public protocol Counter: AnyObject {\n   /// Increment the counter by the given count.\n-  func increment(count: Int)\n+  /// - returns: A status indicating if the action was successful.\n+  func increment(count: Int) -> Int32", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzODQ5OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491138499", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// Increment the counter by the given count.\n          \n          \n            \n              /// Increment the counter by the given count.\n          \n          \n            \n              ///\n          \n          \n            \n              /// - returns: A status indicating if the action was successful.", "author": "rebello95", "createdAt": "2020-09-18T19:04:37Z", "path": "library/swift/src/stats/CounterImpl.swift", "diffHunk": "@@ -14,11 +14,11 @@ class CounterImpl: NSObject, Counter {\n   }\n \n   /// Increment the counter by the given count.", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzODczOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491138739", "bodyText": "Should we use kEnvoySuccess in this file too?", "author": "rebello95", "createdAt": "2020-09-18T19:05:06Z", "path": "library/swift/test/CounterTests.swift", "diffHunk": "@@ -5,13 +5,14 @@ final class CounterTests: XCTestCase {\n     func testConvenientMethodDelegatesToTheMainMethod() {\n         class MockCounterImpl: Counter {\n             var count: Int?\n-            func increment(count: Int) {\n+            func increment(count: Int) -> Int32 {\n                 self.count = count\n+                return 0", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzODgyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491138825", "bodyText": "TODO?", "author": "rebello95", "createdAt": "2020-09-18T19:05:18Z", "path": "test/common/engine_test.cc", "diffHunk": "@@ -49,4 +49,42 @@ TEST_F(EngineTest, EarlyExit) {\n \n   start_stream(0, {});\n }\n+\n+// Move to main_interface_test", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzOTIwMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491139203", "bodyText": "Why is this implemented in Swift but not Kotlin?", "author": "rebello95", "createdAt": "2020-09-18T19:06:11Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/stats/Counter.kt", "diffHunk": "@@ -7,5 +7,6 @@ interface Counter {\n   /**\n    * Increment the counter by the given count.\n    */\n+  // TODO: return A status indicating if the action was successful.", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0MDI3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491140277", "bodyText": "nit: I'd drop this TODO for now - I'm not certain we do want to expose this publicly via a return code. (We can also throw an exception. Or log. Or do nothing.)", "author": "goaway", "createdAt": "2020-09-18T19:08:48Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/stats/Counter.kt", "diffHunk": "@@ -7,5 +7,6 @@ interface Counter {\n   /**\n    * Increment the counter by the given count.\n    */\n+  // TODO: return A status indicating if the action was successful.", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0MDg0OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491140848", "bodyText": "At this layer I'd have it return void. We don't currently expose Envoy return codes beyond the bridge layer elsewhere, and they're only return codes there because of a lack of a platform-agnostic way to signal success, if relevant.", "author": "goaway", "createdAt": "2020-09-18T19:10:03Z", "path": "library/swift/src/stats/Counter.swift", "diffHunk": "@@ -4,12 +4,14 @@ import Foundation\n @objc\n public protocol Counter: AnyObject {\n   /// Increment the counter by the given count.\n-  func increment(count: Int)\n+  /// - returns: A status indicating if the action was successful.\n+  func increment(count: Int) -> Int32", "originalCommit": "46c3de7c59385246e21cfbb5d5dd03f78fef9e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a84716be36e412e2741ef078846baadb453d851d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a84716be36e412e2741ef078846baadb453d851d", "message": "update\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-18T21:03:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5MTk3Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491191972", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// TODO: raise error to platform if the operation is not successful.\n          \n          \n            \n              /// TODO: Potentially signal error to platform if the operation is not successful.\n          \n      \n    \n    \n  \n\nIt's not altogether certain to me that we should raise, though it is an option.", "author": "goaway", "createdAt": "2020-09-18T21:09:31Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/stats/CounterImpl.kt", "diffHunk": "@@ -15,6 +15,7 @@ internal class CounterImpl : Counter {\n     this.elements = elements\n   }\n \n+  /// TODO: raise error to platform if the operation is not successful.", "originalCommit": "a84716be36e412e2741ef078846baadb453d851d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5MjIwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1104#discussion_r491192209", "bodyText": "Same as above.", "author": "goaway", "createdAt": "2020-09-18T21:10:15Z", "path": "library/swift/src/stats/CounterImpl.swift", "diffHunk": "@@ -14,6 +14,7 @@ class CounterImpl: NSObject, Counter {\n   }\n \n   /// Increment the counter by the given count.\n+  /// TODO: raise error to platform if the operation is not successful.", "originalCommit": "a84716be36e412e2741ef078846baadb453d851d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac44ecd518f12a4f4577453d4dccef0167230feb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ac44ecd518f12a4f4577453d4dccef0167230feb", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-18T21:30:13Z", "type": "commit"}]}