{"pr_number": 813, "pr_title": "error handling: add attempt counts to the library's error types", "pr_createdAt": "2020-04-24T23:27:05Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/813", "timeline": [{"oid": "ad3bf7571c04f9202fbdfd5933f689246fb6cfd2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ad3bf7571c04f9202fbdfd5933f689246fb6cfd2", "message": "first pass\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-24T22:37:33Z", "type": "commit"}, {"oid": "b806deb0ca0796296142a0cac8a9a8e468b8d625", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b806deb0ca0796296142a0cac8a9a8e468b8d625", "message": "tests\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-24T23:23:18Z", "type": "commit"}, {"oid": "4be12e39be3e58af6ea3d90c15ab8c14b0cdc676", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4be12e39be3e58af6ea3d90c15ab8c14b0cdc676", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-24T23:24:37Z", "type": "commit"}, {"oid": "19b1e37ba1617934f458e10e779dafe3e69e9275", "url": "https://github.com/envoyproxy/envoy-mobile/commit/19b1e37ba1617934f458e10e779dafe3e69e9275", "message": "swiftlint\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-24T23:31:50Z", "type": "commit"}, {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96", "url": "https://github.com/envoyproxy/envoy-mobile/commit/678e45339f906c82a8f2996716e756e0d10f5e96", "message": "fix\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-24T23:38:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMDgwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414920809", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      val msg = String(\"failed with error after \" + error.attemptCount + \" attempts: \" + error.message)\n          \n          \n            \n                      Log.d(\"MainActivity\", msg)\n          \n          \n            \n                      Log.d(\"MainActivity\", \"failed with error after ${error.attemptCount} attempts: ${error.message}\")", "author": "buildbreaker", "createdAt": "2020-04-24T23:41:32Z", "path": "examples/kotlin/hello_world/MainActivity.kt", "diffHunk": "@@ -103,7 +103,9 @@ class MainActivity : Activity() {\n           Unit\n         }\n         .onError { error ->\n-          recyclerView.post { viewAdapter.add(Failure(\"failed with error \" + error.message)) }\n+          val msg = String(\"failed with error after \" + error.attemptCount + \" attempts: \" + error.message)\n+          Log.d(\"MainActivity\", msg)", "originalCommit": "678e45339f906c82a8f2996716e756e0d10f5e96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEwMDU4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416100589", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      val msg = String(\"failed with error after \" + error.attemptCount + \" attempts: \" + error.message)\n          \n          \n            \n                      Log.d(\"MainActivity\", msg)\n          \n          \n            \n                      val msg = \"failed with error after ${error.attemptCount} attempts: ${error.message}\"\n          \n          \n            \n                      Log.d(\"MainActivity\", msg)", "author": "buildbreaker", "createdAt": "2020-04-27T19:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMDgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMDkyMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414920923", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          String msg = new String(\"failed with error after \" + error.getAttemptCount() +\n          \n          \n            \n                                                  \" attempts: \" + error.getMessage());\n          \n          \n            \n                          Log.d(\"MainActivity\", msg);\n          \n          \n            \n                          Log.d(\"MainActivity\", \"failed with error after \" + error.getAttemptCount() +\n          \n          \n            \n                                                  \" attempts: \" + error.getMessage());", "author": "buildbreaker", "createdAt": "2020-04-24T23:41:49Z", "path": "examples/java/hello_world/MainActivity.java", "diffHunk": "@@ -104,8 +104,10 @@ private void makeRequest() {\n               return Unit.INSTANCE;\n             })\n             .onError((error) -> {\n-              recyclerView.post(\n-                  () -> viewAdapter.add(new Failure(\"failed with error \" + error.getMessage())));\n+              String msg = new String(\"failed with error after \" + error.getAttemptCount() +\n+                                      \" attempts: \" + error.getMessage());\n+              Log.d(\"MainActivity\", msg);", "originalCommit": "678e45339f906c82a8f2996716e756e0d10f5e96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA5ODY4MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416098680", "bodyText": "I want to give the Failure object the same string, though", "author": "junr03", "createdAt": "2020-04-27T19:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMDkyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEwMDM0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416100343", "bodyText": "uhh how about\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          String msg = new String(\"failed with error after \" + error.getAttemptCount() +\n          \n          \n            \n                                                  \" attempts: \" + error.getMessage());\n          \n          \n            \n                          Log.d(\"MainActivity\", msg);\n          \n          \n            \n                          String msg = \"failed with error after \" + error.getAttemptCount() +\n          \n          \n            \n                                                  \" attempts: \" + error.getMessage();\n          \n          \n            \n                          Log.d(\"MainActivity\", msg);\n          \n      \n    \n    \n  \n\nSince the new String() is redundant here", "author": "buildbreaker", "createdAt": "2020-04-27T19:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMDkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMjU0OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414922548", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    failed within Envoy library after \\(error.attemptCount) attempts: \\(error.message)\n          \n          \n            \n                    Request failed after \\(error.attemptCount) attempts: \\(error.message)\n          \n      \n    \n    \n  \n\nTo be consistent with the others", "author": "rebello95", "createdAt": "2020-04-24T23:47:39Z", "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -65,7 +65,9 @@ final class ViewController: UITableViewController {\n         NSLog(\"Response data (\\(requestID)): \\(data.count) bytes\")\n       }\n       .onError { [weak self] error in\n-        let message = \"failed within Envoy library: \\(error.message)\"\n+        let message = \"\"\"\n+        failed within Envoy library after \\(error.attemptCount) attempts: \\(error.message)", "originalCommit": "678e45339f906c82a8f2996716e756e0d10f5e96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyOTgxOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414929818", "bodyText": "Seems like this should probably be 1 technically \ud83e\udd14 it's kind of arbitrary here I suppose since the request could have been retried", "author": "rebello95", "createdAt": "2020-04-25T00:14:29Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/GRPCResponseHandler.kt", "diffHunk": "@@ -123,7 +123,7 @@ class GRPCResponseHandler(\n         val compressionFlag = byteArray[0]\n         // TODO: Support gRPC compression https://github.com/lyft/envoy-mobile/issues/501.\n         if (compressionFlag.compareTo(0) != 0) {\n-          errorClosure(EnvoyError(0, \"Unable to read compressed gRPC response message\"))\n+          errorClosure(EnvoyError(0, \"Unable to read compressed gRPC response message\", 0))", "originalCommit": "678e45339f906c82a8f2996716e756e0d10f5e96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyOTk1MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414929951", "bodyText": "Thi\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param errorCode,    the envoy_error_code_t.\n          \n          \n            \n               * @param errorCode,    the error code.", "author": "rebello95", "createdAt": "2020-04-25T00:15:03Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/JvmCallbackContext.java", "diffHunk": "@@ -127,14 +127,15 @@ public void run() {\n   /**\n    * Dispatches error received from the JNI layer up to the platform.\n    *\n-   * @param message,   the error message.\n-   * @param errorCode, the envoy_error_code_t.\n+   * @param errorCode,    the envoy_error_code_t.", "originalCommit": "678e45339f906c82a8f2996716e756e0d10f5e96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e8a1416fdecac3bcf8846011765d9ca2d31dfc8c", "message": "optional\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-27T22:10:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NTQ0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416185443", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    var message: String\n          \n          \n            \n                    let message: String\n          \n      \n    \n    \n  \n\nCompiler enforces that this is set exactly once here", "author": "rebello95", "createdAt": "2020-04-27T22:13:05Z", "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -65,7 +65,13 @@ final class ViewController: UITableViewController {\n         NSLog(\"Response data (\\(requestID)): \\(data.count) bytes\")\n       }\n       .onError { [weak self] error in\n-        let message = \"failed within Envoy library: \\(error.message)\"\n+        var message: String", "originalCommit": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjI3Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416226276", "bodyText": "I wonder why my local compilation worked? nvm, I understand what you mean now. We are declaring message to be immutable after setting it once.\nSo out of curiosity does swift not initialize on that line? Or does it not count that initialization as setting that variable?", "author": "junr03", "createdAt": "2020-04-27T23:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NTQ0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNjY2NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416226664", "bodyText": "It'll compile, just doesn't need to be mutable", "author": "rebello95", "createdAt": "2020-04-27T23:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NTQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NTYzNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416185636", "bodyText": "What does this change?", "author": "rebello95", "createdAt": "2020-04-27T22:13:27Z", "path": "library/common/jni_interface.cc", "diffHunk": "@@ -209,7 +209,7 @@ static void jvm_on_error(envoy_error error, void* context) {\n   jobject j_context = static_cast<jobject>(context);\n \n   jclass jcls_JvmObserverContext = env->GetObjectClass(j_context);\n-  jmethodID jmid_onError = env->GetMethodID(jcls_JvmObserverContext, \"onError\", \"([BI)V\");\n+  jmethodID jmid_onError = env->GetMethodID(jcls_JvmObserverContext, \"onError\", \"(I[BI)V\");", "originalCommit": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNzY1Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416227653", "bodyText": "The signature of the method. It went from being a void method that took a byte array and an integer to a void method that takes an integer, a byte array, and an integer.", "author": "junr03", "createdAt": "2020-04-27T23:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NTYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NzkyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416187929", "bodyText": "You need to use UInt32(exactly: attemptCount) here to prevent crashes in case attemptCount is out of bounds. If you want, you could then additionally remove the ternary, as UInt32(exactly: attemptCount) will also return nil if the value is negative, but you may also want to keep it for clarity \ud83e\udd37", "author": "rebello95", "createdAt": "2020-04-27T22:18:14Z", "path": "library/swift/src/ResponseHandler.swift", "diffHunk": "@@ -66,8 +66,9 @@ public final class ResponseHandler: NSObject {\n     @escaping (_ error: EnvoyError) -> Void)\n     -> ResponseHandler\n   {\n-    self.underlyingCallbacks.onError = { errorCode, message in\n-      closure(EnvoyError(errorCode: errorCode, message: message, cause: nil))\n+    self.underlyingCallbacks.onError = { errorCode, message, attemptCount in\n+      closure(EnvoyError(errorCode: errorCode, message: message,\n+                         attemptCount: attemptCount < 0 ? nil : UInt32(attemptCount), cause: nil))", "originalCommit": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8881a88f5fae21d955d7abcd41b4768c6e29a2d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d8881a88f5fae21d955d7abcd41b4768c6e29a2d", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-28T00:04:09Z", "type": "commit"}]}