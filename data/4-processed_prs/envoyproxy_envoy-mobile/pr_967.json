{"pr_number": 967, "pr_title": "filters: instantiate filters on a per-stream basis", "pr_createdAt": "2020-07-22T09:31:33Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/967", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MDI4Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r458950287", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              ASSERT(platform_filter_.instance_context, \"init_filter must be called initially\");\n          \n          \n            \n              ASSERT(platform_filter_.instance_context, \"expected initialized filter context\");", "author": "rebello95", "createdAt": "2020-07-22T17:09:52Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -20,18 +20,31 @@ PlatformBridgeFilterConfig::PlatformBridgeFilterConfig(\n           Api::External::retrieveApi(proto_config.platform_filter_name()))) {}\n \n PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config)\n-    : platform_filter_(config->platform_filter()) {}\n+    : platform_filter_(*config->platform_filter()) {\n+  platform_filter_.instance_context = platform_filter_.init_filter(platform_filter_.static_context);\n+\n+  ASSERT(platform_filter_.instance_context, \"init_filter unsuccessful\");\n+}\n+\n+void PlatformBridgeFilter::onDestroy() {\n+  ASSERT(platform_filter_.instance_context, \"init_filter must be called initially\");", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MDk3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r458950977", "bodyText": "Same below. I think this is a bit clearer since technically init_filter can fail per the above assert", "author": "rebello95", "createdAt": "2020-07-22T17:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwMDE2Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459100163", "bodyText": "Sounds good.", "author": "goaway", "createdAt": "2020-07-22T21:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MDI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTc0Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r458951746", "bodyText": "Is this necessary?", "author": "rebello95", "createdAt": "2020-07-22T17:12:14Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -66,40 +62,51 @@ static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n   return (envoy_headers){length, header_array};\n }\n \n+static const void* ios_http_filter_init(const void *context) {\n+  EnvoyHTTPFilterFactory *filterFactory = (__bridge EnvoyHTTPFilterFactory *)context;\n+  EnvoyHTTPFilter *filter = filterFactory.create();\n+  return CFBridgingRetain(filter);\n+}\n+\n static envoy_filter_headers_status\n-ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, void *context) {\n+ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, const void *context) {\n   // TODO(goaway): optimize unmodified case\n-  ios_http_filter_context *c = (ios_http_filter_context *)context;\n-  if (c->filter.onRequestHeaders == nil) {\n+  EnvoyHTTPFilter *filter = (__bridge EnvoyHTTPFilter *)context;\n+  if (filter.onRequestHeaders == nil) {\n     return (envoy_filter_headers_status){/*status*/ kEnvoyFilterHeadersStatusContinue,\n                                          /*headers*/ headers};\n   }\n \n   EnvoyHeaders *platformHeaders = to_ios_headers(headers);\n   release_envoy_headers(headers);\n   // TODO(goaway): consider better solution for compound return\n-  NSArray *result = c->filter.onRequestHeaders(platformHeaders, end_stream);\n+  NSArray *result = filter.onRequestHeaders(platformHeaders, end_stream);\n   return (envoy_filter_headers_status){/*status*/ [result[0] intValue],\n                                        /*headers*/ toNativeHeaders(result[1])};\n }\n \n static envoy_filter_headers_status\n-ios_http_filter_on_response_headers(envoy_headers headers, bool end_stream, void *context) {\n+ios_http_filter_on_response_headers(envoy_headers headers, bool end_stream, const void *context) {\n   // TODO(goaway): optimize unmodified case\n-  ios_http_filter_context *c = (ios_http_filter_context *)context;\n-  if (c->filter.onResponseHeaders == nil) {\n+  EnvoyHTTPFilter *filter = (__bridge EnvoyHTTPFilter *)context;\n+  if (filter.onResponseHeaders == nil) {\n     return (envoy_filter_headers_status){/*status*/ kEnvoyFilterHeadersStatusContinue,\n                                          /*headers*/ headers};\n   }\n \n   EnvoyHeaders *platformHeaders = to_ios_headers(headers);\n   release_envoy_headers(headers);\n   // TODO(goaway): consider better solution for compound return\n-  NSArray *result = c->filter.onResponseHeaders(platformHeaders, end_stream);\n+  NSArray *result = filter.onResponseHeaders(platformHeaders, end_stream);\n   return (envoy_filter_headers_status){/*status*/ [result[0] intValue],\n                                        /*headers*/ toNativeHeaders(result[1])};\n }\n \n+static void ios_http_filter_release(const void *context) {\n+  CFRelease(context);\n+  return;", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwMDk5Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459100993", "bodyText": "The return statement? Technically no, but I guess I tend to err on the side of being explicit.", "author": "goaway", "createdAt": "2020-07-22T21:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MzAxOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r458953018", "bodyText": "I'd probably remove this and just it below using filterType.init()", "author": "rebello95", "createdAt": "2020-07-22T17:14:24Z", "path": "library/swift/src/filters/Filter.swift", "diffHunk": "@@ -4,14 +4,33 @@ import Foundation\n /// Interface representing a filter. See `RequestFilter` and `ResponseFilter` for more details.\n public protocol Filter {\n   /// A unique name for a filter implementation. Needed for extension registration.\n-  var name: String { get }\n+  static var name: String { get }\n+\n+  /// Required initializer for internal creation.\n+  init()\n+}\n+\n+extension Filter {\n+  static func create() -> EnvoyHTTPFilter {\n+    return EnvoyHTTPFilter(filter: Self.init())\n+  }\n+}", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwMTEyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459101129", "bodyText": "Yep, good catch - this is leftover from an earlier approach.", "author": "goaway", "createdAt": "2020-07-22T21:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MzAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwNzcxOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459107718", "bodyText": "should this be a const ref to the struct? Ah nvm, I understand now. Each c++ filter instance gets a fresh copy of the struct, and then changes the instance_context_ pointer to point to whatever the init function returns. But all the other fields in the copied struct refer to static fields.\nCan we spell the model a little bit more in inline comments? For posterity, and for our personal reference.", "author": "junr03", "createdAt": "2020-07-22T21:58:32Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.h", "diffHunk": "@@ -50,7 +53,7 @@ class PlatformBridgeFilter final : public Http::PassThroughFilter {\n private:\n   Http::FilterHeadersStatus onHeaders(Http::HeaderMap& headers, bool end_stream,\n                                       envoy_filter_on_headers_f on_headers);\n-  const envoy_http_filter* platform_filter_;\n+  envoy_http_filter platform_filter_;", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEyMjkwMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459122900", "bodyText": "Good call.", "author": "goaway", "createdAt": "2020-07-22T22:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwNzcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwOTA4NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459109084", "bodyText": "should we use similar verbs between here and the bridge (init)?", "author": "junr03", "createdAt": "2020-07-22T22:01:44Z", "path": "library/objective-c/EnvoyEngine.h", "diffHunk": "@@ -68,14 +68,22 @@ extern const int kEnvoyFilterHeadersStatusStopAllIterationAndBuffer;\n \n @interface EnvoyHTTPFilter : NSObject\n \n-@property (nonatomic, strong) NSString *name;\n-\n @property (nonatomic, strong) NSArray * (^onRequestHeaders)(EnvoyHeaders *headers, BOOL endStream);\n \n @property (nonatomic, strong) NSArray * (^onResponseHeaders)(EnvoyHeaders *headers, BOOL endStream);\n \n @end\n \n+#pragma mark - EnvoyHTTPFilterFactory\n+\n+@interface EnvoyHTTPFilterFactory : NSObject\n+\n+@property (nonatomic, strong) NSString *filterName;\n+\n+@property (nonatomic, strong) EnvoyHTTPFilter * (^create)();", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEyMjY2Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459122662", "bodyText": "I presented the interface to the bridge layer as something like a class/instance, so init made sense. I implemented it at this layer as a split between a factory and an implementation, so create made sense.\nAt least, to me.", "author": "goaway", "createdAt": "2020-07-22T22:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwOTA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExMDk2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459110968", "bodyText": "what does the __bridge in the cast mean?", "author": "junr03", "createdAt": "2020-07-22T22:06:37Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -66,40 +62,51 @@ static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n   return (envoy_headers){length, header_array};\n }\n \n+static const void* ios_http_filter_init(const void *context) {\n+  EnvoyHTTPFilterFactory *filterFactory = (__bridge EnvoyHTTPFilterFactory *)context;\n+  EnvoyHTTPFilter *filter = filterFactory.create();\n+  return CFBridgingRetain(filter);\n+}\n+\n static envoy_filter_headers_status\n-ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, void *context) {\n+ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, const void *context) {\n   // TODO(goaway): optimize unmodified case\n-  ios_http_filter_context *c = (ios_http_filter_context *)context;\n-  if (c->filter.onRequestHeaders == nil) {\n+  EnvoyHTTPFilter *filter = (__bridge EnvoyHTTPFilter *)context;", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEyMjE4NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459122185", "bodyText": "__bridge tells ARC that we're pulling out a retainable object here, but not to actually do anything with the retain count at this point.", "author": "goaway", "createdAt": "2020-07-22T22:35:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExMDk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExMTQ0NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459111444", "bodyText": "how come the pointer doen't need dereference here?", "author": "junr03", "createdAt": "2020-07-22T22:07:48Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -66,40 +62,51 @@ static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n   return (envoy_headers){length, header_array};\n }\n \n+static const void* ios_http_filter_init(const void *context) {\n+  EnvoyHTTPFilterFactory *filterFactory = (__bridge EnvoyHTTPFilterFactory *)context;\n+  EnvoyHTTPFilter *filter = filterFactory.create();\n+  return CFBridgingRetain(filter);\n+}\n+\n static envoy_filter_headers_status\n-ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, void *context) {\n+ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, const void *context) {\n   // TODO(goaway): optimize unmodified case\n-  ios_http_filter_context *c = (ios_http_filter_context *)context;\n-  if (c->filter.onRequestHeaders == nil) {\n+  EnvoyHTTPFilter *filter = (__bridge EnvoyHTTPFilter *)context;\n+  if (filter.onRequestHeaders == nil) {", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEyMTE0Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459121142", "bodyText": "Yeah, seems weird if you've been looking at C++ for a while. Technically speaking we're using shorthand to send an Objective-C message to filter - the expanded syntax would be [filter onRequestHeaders]. This just happens to be what the shorthand looks like.", "author": "goaway", "createdAt": "2020-07-22T22:33:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExMTQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNDc5MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459114791", "bodyText": "I think we talked about it in one of the earlier PRs, but could we delete the duplication and dispatch to common code between request and reply?", "author": "junr03", "createdAt": "2020-07-22T22:16:48Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -66,40 +62,51 @@ static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n   return (envoy_headers){length, header_array};\n }\n \n+static const void* ios_http_filter_init(const void *context) {\n+  EnvoyHTTPFilterFactory *filterFactory = (__bridge EnvoyHTTPFilterFactory *)context;\n+  EnvoyHTTPFilter *filter = filterFactory.create();\n+  return CFBridgingRetain(filter);\n+}\n+\n static envoy_filter_headers_status\n-ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, void *context) {\n+ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, const void *context) {\n   // TODO(goaway): optimize unmodified case\n-  ios_http_filter_context *c = (ios_http_filter_context *)context;\n-  if (c->filter.onRequestHeaders == nil) {\n+  EnvoyHTTPFilter *filter = (__bridge EnvoyHTTPFilter *)context;\n+  if (filter.onRequestHeaders == nil) {\n     return (envoy_filter_headers_status){/*status*/ kEnvoyFilterHeadersStatusContinue,\n                                          /*headers*/ headers};\n   }\n \n   EnvoyHeaders *platformHeaders = to_ios_headers(headers);\n   release_envoy_headers(headers);\n   // TODO(goaway): consider better solution for compound return\n-  NSArray *result = c->filter.onRequestHeaders(platformHeaders, end_stream);\n+  NSArray *result = filter.onRequestHeaders(platformHeaders, end_stream);\n   return (envoy_filter_headers_status){/*status*/ [result[0] intValue],\n                                        /*headers*/ toNativeHeaders(result[1])};\n }\n \n static envoy_filter_headers_status\n-ios_http_filter_on_response_headers(envoy_headers headers, bool end_stream, void *context) {\n+ios_http_filter_on_response_headers(envoy_headers headers, bool end_stream, const void *context) {", "originalCommit": "e37f31065e1ab205385f2dac10785cdc0f2a7ba6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEyMDExNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459120116", "bodyText": "I did delete the (more significant) duplication on that PR (in filter.cc). Here, I'd suggest it's pretty limited. We check if the function's present, map the headers, call the function. I almost feel the extra indirection from factoring here would serve only to complicate the code.", "author": "goaway", "createdAt": "2020-07-22T22:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNDc5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEyMDMwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r459120309", "bodyText": "But I mean, only just almost? If you feel strongly, I can still do it.", "author": "goaway", "createdAt": "2020-07-22T22:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNDc5MQ=="}], "type": "inlineReview"}, {"oid": "c4712ec1ba358524d7b20d9a7b9b7140c9f0c1f6", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c4712ec1ba358524d7b20d9a7b9b7140c9f0c1f6", "message": "filters: instantiate filters on a per-stream basis\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-22T23:31:30Z", "type": "commit"}, {"oid": "c660ed9da21411ad9615f180aa2f59f7bfc79456", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c660ed9da21411ad9615f180aa2f59f7bfc79456", "message": "update example app\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-22T23:31:30Z", "type": "commit"}, {"oid": "3b443fb7acb0ea2847f3d3f9a302e3d07991fae3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3b443fb7acb0ea2847f3d3f9a302e3d07991fae3", "message": "updates for comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-22T23:31:30Z", "type": "commit"}, {"oid": "3a57d22708641b202f18e85b96779f24171e7db4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3a57d22708641b202f18e85b96779f24171e7db4", "message": "fix up on_data\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-22T23:36:19Z", "type": "commit"}, {"oid": "3a57d22708641b202f18e85b96779f24171e7db4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3a57d22708641b202f18e85b96779f24171e7db4", "message": "fix up on_data\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-22T23:36:19Z", "type": "forcePushed"}, {"oid": "c2e4637239e28276062c56bc37cc84fecc32f24d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c2e4637239e28276062c56bc37cc84fecc32f24d", "message": "format fixes\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-23T00:18:20Z", "type": "commit"}, {"oid": "bdc0af67d3e3dd261e62a1d3914bc2382e446868", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bdc0af67d3e3dd261e62a1d3914bc2382e446868", "message": "fix obj-c app and support static implementations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-24T02:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MTcwNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460251707", "bodyText": "Is this a feature we want to support? i.e do we want it to be possible to have static filters? While potentially useful in some cases I worry that giving options might make the entire affair a little more confusing.", "author": "junr03", "createdAt": "2020-07-24T19:38:27Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -21,18 +21,47 @@ PlatformBridgeFilterConfig::PlatformBridgeFilterConfig(\n           Api::External::retrieveApi(proto_config.platform_filter_name()))) {}\n \n PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config)\n-    : platform_filter_(config->platform_filter()) {}\n+    : platform_filter_(*config->platform_filter()) {\n+  // The initialization above sets platform_filter_ to a copy of the struct stored on the config.\n+  // In the typical case, this will represent a filter implementation that needs to be intantiated.\n+  // static_context will contain the necessary platform-specific mechanism to produce a filter\n+  // instance. instance_context will initially be null, but after initialization, set to the\n+  // context needed for actual filter invocations.\n+\n+  // We treat a null initializer as a static implementation.", "originalCommit": "bdc0af67d3e3dd261e62a1d3914bc2382e446868", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2MDEwMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460260100", "bodyText": "I'm primarily interested in supporting it right now because I like the convention of being able to calloc these structs as a safety convention. I wasn't planning on exposing it above this level at this point.\nI agree about not introducing extra complexity, but I also realized it didn't take very much to support it generally here. Assuming we move forward, I will ensure a test covers this case.", "author": "goaway", "createdAt": "2020-07-24T19:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MTcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjE2Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460272166", "bodyText": "I agree with @junr03 that I'd prefer we stick with one approach (instance-based filters) rather than supporting static implementations (even if it's minimal work to add that support). Even if it's not something we bubble up to the public interface, it's still something we'd be implicitly supporting internally and subject to breakage, and I'm not sure I see much value in providing that functionality", "author": "rebello95", "createdAt": "2020-07-24T20:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MTcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjU4Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460272582", "bodyText": "I'm also a little concerned that having this in place might lead us to miss actual problems with instance-based filters (i.e., init_filter being accidentally unset)", "author": "rebello95", "createdAt": "2020-07-24T20:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MTcwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4NDk3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460284977", "bodyText": "Talked to @rebello95 and upon further consideration, I think the two of you make a good point and we should prefer simplicity. I'll switch this over to logging if init_filter isn't provided, and nulling out the rest of the struct for safety.", "author": "goaway", "createdAt": "2020-07-24T20:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MTcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MjA2Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460252063", "bodyText": "can we interpolate the filter name here? Makes for easier crash debugging", "author": "junr03", "createdAt": "2020-07-24T19:39:17Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -21,18 +21,47 @@ PlatformBridgeFilterConfig::PlatformBridgeFilterConfig(\n           Api::External::retrieveApi(proto_config.platform_filter_name()))) {}\n \n PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config)\n-    : platform_filter_(config->platform_filter()) {}\n+    : platform_filter_(*config->platform_filter()) {\n+  // The initialization above sets platform_filter_ to a copy of the struct stored on the config.\n+  // In the typical case, this will represent a filter implementation that needs to be intantiated.\n+  // static_context will contain the necessary platform-specific mechanism to produce a filter\n+  // instance. instance_context will initially be null, but after initialization, set to the\n+  // context needed for actual filter invocations.\n+\n+  // We treat a null initializer as a static implementation.\n+  if (platform_filter_.init_filter == nullptr) {\n+    // Make static context available to invocations, in lieu of instatiated context.\n+    platform_filter_.instance_context = platform_filter_.static_context;\n+    return;\n+  }\n+\n+  // Set the instance_context to the result of the initialization call. Cleanup will ultimately\n+  // occur during in the onDestroy() invocation below.\n+  platform_filter_.instance_context = platform_filter_.init_filter(platform_filter_.static_context);\n+\n+  ASSERT(platform_filter_.instance_context, \"init_filter unsuccessful\");", "originalCommit": "bdc0af67d3e3dd261e62a1d3914bc2382e446868", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2MDYwNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460260605", "bodyText": "Sure.", "author": "goaway", "createdAt": "2020-07-24T19:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MjA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MjQyNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460252424", "bodyText": "I liked being able to tell that reaching a nullptr here was a programming mistake.", "author": "junr03", "createdAt": "2020-07-24T19:40:06Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -21,18 +21,47 @@ PlatformBridgeFilterConfig::PlatformBridgeFilterConfig(\n           Api::External::retrieveApi(proto_config.platform_filter_name()))) {}\n \n PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config)\n-    : platform_filter_(config->platform_filter()) {}\n+    : platform_filter_(*config->platform_filter()) {\n+  // The initialization above sets platform_filter_ to a copy of the struct stored on the config.\n+  // In the typical case, this will represent a filter implementation that needs to be intantiated.\n+  // static_context will contain the necessary platform-specific mechanism to produce a filter\n+  // instance. instance_context will initially be null, but after initialization, set to the\n+  // context needed for actual filter invocations.\n+\n+  // We treat a null initializer as a static implementation.\n+  if (platform_filter_.init_filter == nullptr) {\n+    // Make static context available to invocations, in lieu of instatiated context.\n+    platform_filter_.instance_context = platform_filter_.static_context;\n+    return;\n+  }\n+\n+  // Set the instance_context to the result of the initialization call. Cleanup will ultimately\n+  // occur during in the onDestroy() invocation below.\n+  platform_filter_.instance_context = platform_filter_.init_filter(platform_filter_.static_context);\n+\n+  ASSERT(platform_filter_.instance_context, \"init_filter unsuccessful\");\n+}\n+\n+void PlatformBridgeFilter::onDestroy() {\n+  // Allow nullptr to act as no-op. Also return if nothing was initialized.", "originalCommit": "bdc0af67d3e3dd261e62a1d3914bc2382e446868", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1ODkwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460258909", "bodyText": "The thing is that as long as Envoy adheres to its contract about filter callbacks, the assertion in init_filter will have already been hit.\nI decided the extra assertions really amounted to asserting Envoy adheres to its contract, which is better done by Envoy's own coverage.", "author": "goaway", "createdAt": "2020-07-24T19:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MjQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MzE5OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460273199", "bodyText": "As I alluded above, I also think that it'd be better to treat nullptr as a programming error here rather than allowing for static filters", "author": "rebello95", "createdAt": "2020-07-24T20:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MjQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1MzE5Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460253193", "bodyText": "Awesome this is great.", "author": "junr03", "createdAt": "2020-07-24T19:41:50Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -21,18 +21,47 @@ PlatformBridgeFilterConfig::PlatformBridgeFilterConfig(\n           Api::External::retrieveApi(proto_config.platform_filter_name()))) {}\n \n PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config)\n-    : platform_filter_(config->platform_filter()) {}\n+    : platform_filter_(*config->platform_filter()) {\n+  // The initialization above sets platform_filter_ to a copy of the struct stored on the config.", "originalCommit": "bdc0af67d3e3dd261e62a1d3914bc2382e446868", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "538c8da2d443730d5440dc51c7dadf3b6ef65266", "url": "https://github.com/envoyproxy/envoy-mobile/commit/538c8da2d443730d5440dc51c7dadf3b6ef65266", "message": "update for comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-24T22:25:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxNTU2Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460315566", "bodyText": "Any reason not to make this an ASSERT?", "author": "rebello95", "createdAt": "2020-07-24T22:33:26Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -17,34 +17,37 @@ namespace PlatformBridge {\n \n PlatformBridgeFilterConfig::PlatformBridgeFilterConfig(\n     const envoymobile::extensions::filters::http::platform_bridge::PlatformBridge& proto_config)\n-    : platform_filter_(static_cast<envoy_http_filter*>(\n+    : filter_name_(proto_config.platform_filter_name()),\n+      platform_filter_(static_cast<envoy_http_filter*>(\n           Api::External::retrieveApi(proto_config.platform_filter_name()))) {}\n \n PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config)\n-    : platform_filter_(*config->platform_filter()) {\n+    : filter_name_(config->filter_name()), platform_filter_(*config->platform_filter()) {\n   // The initialization above sets platform_filter_ to a copy of the struct stored on the config.\n   // In the typical case, this will represent a filter implementation that needs to be intantiated.\n   // static_context will contain the necessary platform-specific mechanism to produce a filter\n   // instance. instance_context will initially be null, but after initialization, set to the\n   // context needed for actual filter invocations.\n \n-  // We treat a null initializer as a static implementation.\n+  // If init_filter is missing, zero out the rest of the struct for safety.\n   if (platform_filter_.init_filter == nullptr) {\n-    // Make static context available to invocations, in lieu of instatiated context.\n-    platform_filter_.instance_context = platform_filter_.static_context;\n+    ENVOY_LOG(debug, \"platform bridge filter: missing initializer for {}\", filter_name_);", "originalCommit": "538c8da2d443730d5440dc51c7dadf3b6ef65266", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyMDM2OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/967#discussion_r460320369", "bodyText": "Yeah, calloc as no-op still has way less overhead than an empty implementation. This restricts handling to only that case though (as opposed to the previous general notion of static support).", "author": "goaway", "createdAt": "2020-07-24T22:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxNTU2Ng=="}], "type": "inlineReview"}]}