{"pr_number": 802, "pr_title": "platform: update interfaces for unary/streamed requests", "pr_createdAt": "2020-04-21T00:15:22Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/802", "timeline": [{"oid": "b8e31e29a528a0645e1f7ed2585fb8e58a6fdc27", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b8e31e29a528a0645e1f7ed2585fb8e58a6fdc27", "message": "platform: update interfaces for unary/streamed requests\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-04-21T00:13:00Z", "type": "commit"}, {"oid": "0bb676eaf509d083e2134283623a9b9d153e2f10", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0bb676eaf509d083e2134283623a9b9d153e2f10", "message": "android\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-04-21T23:11:56Z", "type": "commit"}, {"oid": "3a9ebb25b8673a62ee1f942a3a62416d48de1793", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3a9ebb25b8673a62ee1f942a3a62416d48de1793", "message": "Merge remote-tracking branch 'origin/master' into platform-interfaces\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-04-21T23:45:48Z", "type": "commit"}, {"oid": "f7eec1c8f142b0a4f9c0cb99707a19aa65589085", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f7eec1c8f142b0a4f9c0cb99707a19aa65589085", "message": "tests\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-04-22T01:03:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYwMjM5Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/802#discussion_r412602393", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  method: .post, scheme: \"https\", authority: \"www.envoyproxy.io\", path: \"/test\")\n          \n          \n            \n                  method: .post, scheme: \"https\", authority: \"envoyproxy.io\", path: \"/test\")", "author": "buildbreaker", "createdAt": "2020-04-22T01:28:50Z", "path": "library/swift/test/EnvoyClientTests.swift", "diffHunk": "@@ -17,26 +17,163 @@ private final class MockEnvoyEngine: EnvoyEngine {\n }\n \n final class EnvoyClientTests: XCTestCase {\n+  private var envoy: EnvoyClient!\n+\n+  override func setUp() {\n+    super.setUp()\n+    self.envoy = try! EnvoyClientBuilder()\n+      .addEngineType(MockEnvoyEngine.self)\n+      .build()\n+  }\n+\n   override func tearDown() {\n     super.tearDown()\n     MockEnvoyHTTPStream.reset()\n   }\n \n-  func testNonStreamingExtensionSendsRequestDetailsThroughStream() throws {\n-    let requestExpectation = self.expectation(description: \"Sends request\")\n-    let dataExpectation = self.expectation(description: \"Sends data\")\n-    let closeExpectation = self.expectation(description: \"Calls close\")\n+  // MARK: - Streaming\n+\n+  func testStartingAStreamSendsHeaders() {\n+    let expectation = self.expectation(description: \"Sends stream headers\")\n+    let expectedHeaders = [\n+      \"key_1\": [\"value_a\"],\n+      \":method\": [\"POST\"],\n+      \":scheme\": [\"https\"],\n+      \":authority\": [\"www.envoyproxy.io\"],\n+      \":path\": [\"/test\"],\n+    ]\n \n-    let expectedRequest = RequestBuilder(\n-      method: .get, scheme: \"https\", authority: \"www.envoyproxy.io\", path: \"/docs\")\n+    MockEnvoyHTTPStream.onHeaders = { headers, closeStream in\n+      XCTAssertEqual(expectedHeaders, headers)\n+      XCTAssertFalse(closeStream)\n+      expectation.fulfill()\n+    }\n+\n+    let request = RequestBuilder(\n+      method: .post, scheme: \"https\", authority: \"www.envoyproxy.io\", path: \"/test\")\n+      .addHeader(name: \"key_1\", value: \"value_a\")\n       .build()\n-    let expectedData = Data([1, 2, 3])\n-    let expectedTrailers = [\"foo\": [\"bar\", \"baz\"]]\n+    _ = self.envoy.start(request, handler: ResponseHandler())\n+    self.wait(for: [expectation], timeout: 0.1)\n+  }\n+\n+  func testSendingDataOnStreamPassesDataToTheUnderlyingStream() {\n+    let expectation = self.expectation(description: \"Sends stream data\")\n \n+    let expectedData = Data([0x0, 0x1, 0x2])\n+    MockEnvoyHTTPStream.onData = { data, closeStream in\n+      XCTAssertEqual(expectedData, data)\n+      XCTAssertFalse(closeStream)\n+      expectation.fulfill()\n+    }\n+\n+    let request = RequestBuilder(\n+      method: .post, scheme: \"https\", authority: \"www.envoyproxy.io\", path: \"/test\")", "originalCommit": "f7eec1c8f142b0a4f9c0cb99707a19aa65589085", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYwMjQ0NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/802#discussion_r412602444", "bodyText": "?", "author": "buildbreaker", "createdAt": "2020-04-22T01:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYwMjM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY1MjcxNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/802#discussion_r412652716", "bodyText": "If anything I think this would probably be api.envoyproxy.io, but really could be any string for these tests. I'd prefer to leave it as is unless you feel strongly \ud83e\udd37\u200d\u2642\ufe0f", "author": "rebello95", "createdAt": "2020-04-22T04:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYwMjM5Mw=="}], "type": "inlineReview"}]}