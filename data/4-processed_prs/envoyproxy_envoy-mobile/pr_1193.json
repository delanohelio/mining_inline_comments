{"pr_number": 1193, "pr_title": "config: add ability to register native filters", "pr_createdAt": "2020-12-01T22:49:32Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1193", "timeline": [{"oid": "b6328338870895ec674123ae3b0c021593745364", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b6328338870895ec674123ae3b0c021593745364", "message": "config: add ability to register native filters\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-01T21:44:18Z", "type": "commit"}, {"oid": "f87dc124032b5f9ec77fd703ec63485b01e3b9bf", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f87dc124032b5f9ec77fd703ec63485b01e3b9bf", "message": "android building\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-01T22:09:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4MzM3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533783375", "bodyText": "nativeplatformFilterTemplateYAML shouldn't this be nativeFilterTemplateYAML? Also should be documented above because I don't think this is immediately obvious as to what should be passed here (it's a bit of a \"magic\" string)", "author": "rebello95", "createdAt": "2020-12-01T23:08:57Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyConfiguration.java", "diffHunk": "@@ -60,15 +63,23 @@ public EnvoyConfiguration(String statsDomain, int connectTimeoutSeconds, int dns\n    * @throws ConfigurationException, when the template provided is not fully\n    *                                 resolved.\n    */\n-  String resolveTemplate(final String templateYAML, final String filterTemplateYAML) {\n+  String resolveTemplate(final String templateYAML, final String platformFilterTemplateYAML, final String nativeplatformFilterTemplateYAML) {", "originalCommit": "b6328338870895ec674123ae3b0c021593745364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4MzU1Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533783553", "bodyText": "Can you actually elaborate on how this will be used directly? I.e., what will a consumer need to specify to make this work?", "author": "rebello95", "createdAt": "2020-12-01T23:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4MzM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgwODEwNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533808104", "bodyText": "bad find and replace. will fix.", "author": "junr03", "createdAt": "2020-12-02T00:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4MzM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4NTE4MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533785180", "bodyText": "Doesn't this need an order? Two lists or a list of pairs might be a better serialization.", "author": "goaway", "createdAt": "2020-12-01T23:13:08Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyConfiguration.java", "diffHunk": "@@ -38,7 +40,7 @@\n   public EnvoyConfiguration(String statsDomain, int connectTimeoutSeconds, int dnsRefreshSeconds,\n                             int dnsFailureRefreshSecondsBase, int dnsFailureRefreshSecondsMax,\n                             List<EnvoyHTTPFilterFactory> httpFilterFactories, int statsFlushSeconds,\n-                            String appVersion, String appId, String virtualClusters) {\n+                            String appVersion, String appId, String virtualClusters, Map<String, String> nativeFilters) {", "originalCommit": "b6328338870895ec674123ae3b0c021593745364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgwODI0MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533808241", "bodyText": "whoops, used to ordered map in c++. I agree, will fix.", "author": "junr03", "createdAt": "2020-12-02T00:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4NTE4MA=="}], "type": "inlineReview"}, {"oid": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b563cb93fbce017cb6f06947b31bab2ee8e83da4", "message": "ios and comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-02T01:59:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDE1NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533934155", "bodyText": "nit: formatting is off", "author": "rebello95", "createdAt": "2020-12-02T06:53:29Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyConfiguration.java", "diffHunk": "@@ -36,11 +35,13 @@\n    * @param appVersion                   the App Version of the App using this Envoy Client.\n    * @param appId                        the App ID of the App using this Envoy Client.\n    * @param virtualClusters              the JSON list of virtual cluster configs.\n+   * @param nativeFilterChain                the configuration for native filters.", "originalCommit": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDMyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533934325", "bodyText": "It'd be great if we could check in rst docs as well explaining how to use these", "author": "rebello95", "createdAt": "2020-12-02T06:54:00Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyConfiguration.java", "diffHunk": "@@ -51,31 +52,35 @@ public EnvoyConfiguration(String statsDomain, int connectTimeoutSeconds, int dns\n     this.appVersion = appVersion;\n     this.appId = appId;\n     this.virtualClusters = virtualClusters;\n-    this.nativeFilters = nativeFilters;\n+    this.nativeFilterChain = nativeFilterChain;\n   }\n \n   /**\n    * Resolves the provided configuration template using properties on this\n    * configuration.\n    *\n    * @param templateYAML the template configuration to resolve.\n+   * @param platformFilterTemplateYAML helper template to build platform http filters.\n+   * @param nativeFilterTemplateYAML helper template to build native http filters.", "originalCommit": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5MzUxMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r534593512", "bodyText": "these are not intended to be publicly replaced. I am guessing that @goaway added the platform string (and I copied him here) because the jni needs to be called to get the string. Vs. in objc you'll notice these are not params because objc can use the c string.", "author": "junr03", "createdAt": "2020-12-03T01:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwNjg4Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r535206887", "bodyText": "Yep, that's right.", "author": "goaway", "createdAt": "2020-12-03T12:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDYyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533934625", "bodyText": "typedConfig seems like a bit of a misnomer throughout this PR since it's by definition untyped since it's a string.", "author": "rebello95", "createdAt": "2020-12-02T06:54:49Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyNativeFilterConfig.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package io.envoyproxy.envoymobile.engine;\n+\n+/* Datatype used by the EnvoyConfiguration to create a native http filter chain. */\n+public class EnvoyNativeFilterConfig {\n+  public final String name;\n+  public final String typedConfig;\n+\n+  /**\n+   * Create a new instance of the configuration\n+   *\n+   * @param name        the name of the filter.\n+   * @param typedConfig the filter configuration.", "originalCommit": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5NDAwMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r534594001", "bodyText": "using the envoy field name for consistency", "author": "junr03", "createdAt": "2020-12-03T01:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDc1Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533934752", "bodyText": "Is the .class file deliberately being checked in below?", "author": "rebello95", "createdAt": "2020-12-02T06:55:07Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/JniLibrary.java", "diffHunk": "@@ -210,3 +210,4 @@ protected static native int runEngine(long engine, String config, String logLeve\n    *         native filter configuration.\n    */\n   public static native String nativeFilterTemplateString();\n+}", "originalCommit": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5NDE2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r534594167", "bodyText": "accidental", "author": "junr03", "createdAt": "2020-12-03T01:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzODQ3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533938475", "bodyText": "nit: I think it'd be nice to list native/platform filters together in the parameter order", "author": "rebello95", "createdAt": "2020-12-02T07:04:56Z", "path": "library/objective-c/EnvoyConfiguration.m", "diffHunk": "@@ -9,11 +9,12 @@ - (instancetype)initWithStatsDomain:(NSString *)statsDomain\n                   dnsRefreshSeconds:(UInt32)dnsRefreshSeconds\n        dnsFailureRefreshSecondsBase:(UInt32)dnsFailureRefreshSecondsBase\n         dnsFailureRefreshSecondsMax:(UInt32)dnsFailureRefreshSecondsMax\n-                        filterChain:(NSArray<EnvoyHTTPFilterFactory *> *)httpFilterFactories\n+                platformFilterChain:(NSArray<EnvoyHTTPFilterFactory *> *)httpFilterFactories\n                   statsFlushSeconds:(UInt32)statsFlushSeconds\n                          appVersion:(NSString *)appVersion\n                               appId:(NSString *)appId\n-                    virtualClusters:(NSString *)virtualClusters {\n+                    virtualClusters:(NSString *)virtualClusters\n+                  nativeFilterChain:(NSArray<EnvoyNativeFilterConfig *> *)nativeFilterChain {", "originalCommit": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzODcyMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533938721", "bodyText": "docs for these, especially since they're just strings?", "author": "rebello95", "createdAt": "2020-12-02T07:05:37Z", "path": "library/objective-c/EnvoyEngine.h", "diffHunk": "@@ -218,6 +218,15 @@ extern const int kEnvoyFilterResumeStatusResumeIteration;\n \n @end\n \n+#pragma mark - EnvoyNativeFilterConfig\n+\n+@interface EnvoyNativeFilterConfig : NSObject\n+\n+@property (nonatomic, strong) NSString *name;\n+@property (nonatomic, strong) NSString *typedConfig;", "originalCommit": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5NzM1Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r534597353", "bodyText": "doesn't seem like we traditionally add docstrings here? I added them in the EngineBuilder method.", "author": "junr03", "createdAt": "2020-12-03T01:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzODcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5OTAwMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r534599003", "bodyText": "ok if it's in the builder I guess that's sufficient - the reason i called it out here is because it's quite unclear to the reader what a typedConfig should actually contain", "author": "rebello95", "createdAt": "2020-12-03T01:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzODcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzOTMyMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1193#discussion_r533939320", "bodyText": "Why not put this in objective-c since that's where the type is defined and these are primitives? If you want to keep it here, it should be private extension", "author": "rebello95", "createdAt": "2020-12-02T07:07:10Z", "path": "library/swift/src/EngineBuilder.swift", "diffHunk": "@@ -1,6 +1,14 @@\n @_implementationOnly import EnvoyEngine\n import Foundation\n \n+extension EnvoyNativeFilterConfig {", "originalCommit": "b563cb93fbce017cb6f06947b31bab2ee8e83da4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6042da3107d834060064e69e2ad92590d979549f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6042da3107d834060064e69e2ad92590d979549f", "message": "tests\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-03T00:15:08Z", "type": "commit"}, {"oid": "3f812db30573fa1368975e8231352cc8bc951d82", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3f812db30573fa1368975e8231352cc8bc951d82", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-03T00:47:37Z", "type": "commit"}, {"oid": "bfac3ec107b51c7214273a86e99bf6cdf930fad8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bfac3ec107b51c7214273a86e99bf6cdf930fad8", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-03T00:52:54Z", "type": "commit"}, {"oid": "820cbc557133e52caac9314270db700d66abb972", "url": "https://github.com/envoyproxy/envoy-mobile/commit/820cbc557133e52caac9314270db700d66abb972", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-03T02:07:49Z", "type": "commit"}, {"oid": "4c826557f0671cd5a1574c8692033a0f9c24624d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4c826557f0671cd5a1574c8692033a0f9c24624d", "message": "Merge branch 'main' into register-native-filters\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-04T00:45:11Z", "type": "commit"}, {"oid": "a171888a2e20f161cee23ed03aa1ba9f0e0d31d8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a171888a2e20f161cee23ed03aa1ba9f0e0d31d8", "message": "fixes from merge\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-04T01:33:09Z", "type": "commit"}, {"oid": "4aca91ff0a51f3d366f3ac8f94f1073572e05e2f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4aca91ff0a51f3d366f3ac8f94f1073572e05e2f", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-12-04T02:25:38Z", "type": "commit"}]}