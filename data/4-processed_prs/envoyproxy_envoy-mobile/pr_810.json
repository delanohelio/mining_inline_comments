{"pr_number": 810, "pr_title": "kotlin: replace Detekt runner script with Bazel rule", "pr_createdAt": "2020-04-23T04:50:50Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/810", "timeline": [{"oid": "68c8ea51f7bae0feb8a1505fcbd06a2de937fdcb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/68c8ea51f7bae0feb8a1505fcbd06a2de937fdcb", "message": "kotlin: replace Detekt runner script with Bazel rule\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-23T04:39:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r413509050", "bodyText": "Maybe we can just do a global detekt rule and just add it to the top level BUILD file. What do you think about that?", "author": "buildbreaker", "createdAt": "2020-04-23T04:58:03Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/BUILD", "diffHunk": "@@ -60,3 +61,10 @@ envoy_mobile_kt_library(\n         \"//library/java/src/io/envoyproxy/envoymobile/engine:envoy_base_engine_lib\",\n     ],\n )\n+\n+detekt(\n+    name = \"envoy_lib_lint\",\n+    srcs = glob([\"*.kt\"]),\n+    build_upon_default_config = True,\n+    cfgs = [\"//:kotlin_lint_config\"],\n+)", "originalCommit": "68c8ea51f7bae0feb8a1505fcbd06a2de937fdcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDAwNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r413514006", "bodyText": "Do you mean a single target with all Kotlin sources? Certainly will work. However, this gives Bazel a little room to run things in parallel. Thinking about \u2014\u00a0I probably should change the GitHub Actions workflow to query Detekt targets and run them in a single Bazel invocation.", "author": "arturdryomov", "createdAt": "2020-04-23T05:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxNTc2MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r413915760", "bodyText": "Gotcha. That sounds good. There might be a good way for us to hide this in a custom bazel macro in the future too.\nDo you want to do the actions change in this pr as well or are you looking to do it as a follow up?", "author": "buildbreaker", "createdAt": "2020-04-23T15:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3MjczNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414072735", "bodyText": "Just tried to fight the CI. Seems like bazel query evaluates a bit much and fails to resolve swiftc on a Linux machine. Is it possible to resolve this somehow? I\u2019ve looked over different GitHub workflows but saw no difference.", "author": "arturdryomov", "createdAt": "2020-04-23T19:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyNDkwOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414824908", "bodyText": "I'll have to dig deeper to figure out (I end up needing to relearn bazel + ci every time). We can move forward without that niceness change for now.", "author": "buildbreaker", "createdAt": "2020-04-24T19:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI0MTExNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r415241114", "bodyText": "@artem-zinnatullin, do you have ideas how to resolve this? Or a better approach is just not to use bazel query for this at all?", "author": "arturdryomov", "createdAt": "2020-04-26T07:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgyMTA5Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r416821096", "bodyText": "All right, removed bazel query for now, we can tune it in the future with the growing number of Kotlin targets.", "author": "arturdryomov", "createdAt": "2020-04-28T18:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5NzExNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r417897114", "bodyText": "hm, this is not good indeed if query fails depending on OS, there is probably a way to use config_settings to only configure swift if we're running on macOS and then use cquery or something like that\nMaybe @justhecuke, @keith or @kastiglione have some ideas", "author": "artem-zinnatullin", "createdAt": "2020-04-30T10:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE1MzA1MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r418153050", "bodyText": "What's the specific query failure? I expect it's because some of the repository rule setup in rules_swift checks what features your swift version supports, and those fail. I don't think we've had this issue internally since likely even if we weren't using it directly our docker images always had swift installed. It might be worth looking for a related bazel issue, seems like there must be one about this. Note that you also hit problems like this on macOS if you don't have the Android SDK installed", "author": "keith", "createdAt": "2020-04-30T16:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUwOTA1MA=="}], "type": "inlineReview"}, {"oid": "e8d168ecb5e50f279dcaf8c8017d8277d05bd9c9", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e8d168ecb5e50f279dcaf8c8017d8277d05bd9c9", "message": "Change GitHub Actions workflow.\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-23T19:06:24Z", "type": "commit"}, {"oid": "ce3ff74953ceb181d0a5ef952f46ed68782e29ed", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ce3ff74953ceb181d0a5ef952f46ed68782e29ed", "message": "Add compiler declarations.\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-23T19:22:00Z", "type": "commit"}, {"oid": "71f72e005e6b2e254c9e399962d1f3e8345080e6", "url": "https://github.com/envoyproxy/envoy-mobile/commit/71f72e005e6b2e254c9e399962d1f3e8345080e6", "message": "Add path declaration.\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-23T19:29:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTUzMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414095531", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                name = \"hello_envoy_kt_lint\",\n          \n          \n            \n                name = \"hello_envoy_kt_detekt\",", "author": "artem-zinnatullin", "createdAt": "2020-04-23T20:18:16Z", "path": "examples/kotlin/hello_world/BUILD", "diffHunk": "@@ -29,3 +30,10 @@ kt_android_library(\n         \"@androidsdk//com.android.support:recyclerview-v7-25.0.0\",\n     ],\n )\n+\n+detekt(\n+    name = \"hello_envoy_kt_lint\",", "originalCommit": "71f72e005e6b2e254c9e399962d1f3e8345080e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTcyMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414095720", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  - name: 'Run Kotlin Lint'\n          \n          \n            \n                  - name: 'Run Detekt (Kotlin Lint)'", "author": "artem-zinnatullin", "createdAt": "2020-04-23T20:18:38Z", "path": ".github/workflows/format.yml", "diffHunk": "@@ -49,11 +49,15 @@ jobs:\n     name: kotlin_lint\n     runs-on: ubuntu-18.04\n     timeout-minutes: 45\n-    container:\n-      image: openjdk:8-jdk\n     steps:\n       - uses: actions/checkout@v1\n         with:\n           submodules: true\n-      - name: 'Run Kotlin lint'\n-        run: ./ci/kotlin_lint.sh\n+      - name: 'Install dependencies'\n+        run: ./ci/linux_ci_setup.sh\n+      - name: 'Run Kotlin Lint'", "originalCommit": "71f72e005e6b2e254c9e399962d1f3e8345080e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NjU3MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414096570", "bodyText": "The more info about the actual tool we have in the names of things the easier it is to work with for external contributors, ie when they see a Detekt failure but don't know that it's Detekt it might be confusing", "author": "artem-zinnatullin", "createdAt": "2020-04-23T20:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI5NjYzNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414296637", "bodyText": "Let\u2019s hear @buildbreaker. I was under an impression that the Lint tool was intentionally abstracted \u2014\u00a0even the config file is called kotlinlint.yml.", "author": "arturdryomov", "createdAt": "2020-04-24T05:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMzU0OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414823549", "bodyText": "I think it'll be nice to abstract it away. We could do something like Run Kotlin Lint (Detekt)", "author": "buildbreaker", "createdAt": "2020-04-24T19:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg5MTIzNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414891236", "bodyText": "Run Kotlin Lint (Detekt) lgtm, but I'm not blocking on that, use your judgement :)", "author": "artem-zinnatullin", "createdAt": "2020-04-24T22:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgyMDYxNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r416820617", "bodyText": "Replaced with Run Kotlin Lint (Detekt) and Run Swift Lint (SwiftLint) for consistency.", "author": "arturdryomov", "createdAt": "2020-04-28T18:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5NTg5MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/810#discussion_r414095890", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                name = \"envoy_lib_lint\",\n          \n          \n            \n                name = \"envoy_lib_detekt\",", "author": "artem-zinnatullin", "createdAt": "2020-04-23T20:18:54Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/BUILD", "diffHunk": "@@ -60,3 +61,10 @@ envoy_mobile_kt_library(\n         \"//library/java/src/io/envoyproxy/envoymobile/engine:envoy_base_engine_lib\",\n     ],\n )\n+\n+detekt(\n+    name = \"envoy_lib_lint\",", "originalCommit": "71f72e005e6b2e254c9e399962d1f3e8345080e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0a02854e7cb5f615f7111fc0e7dbc7f78f986f3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d0a02854e7cb5f615f7111fc0e7dbc7f78f986f3", "message": "Remove Bazel query.\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-28T18:02:10Z", "type": "commit"}, {"oid": "027fe57ac921bdb8b076d32da287daabf3d28f82", "url": "https://github.com/envoyproxy/envoy-mobile/commit/027fe57ac921bdb8b076d32da287daabf3d28f82", "message": "Return submodules checkout.\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-28T18:12:24Z", "type": "commit"}, {"oid": "46eb56ab4fc19486db79ba351a34f8017f86c2a8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/46eb56ab4fc19486db79ba351a34f8017f86c2a8", "message": "Fix formatting issue.\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-28T18:25:35Z", "type": "commit"}, {"oid": "ead4b5035e236decdff28a85a9ea2adf1c8adf94", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ead4b5035e236decdff28a85a9ea2adf1c8adf94", "message": "Merge branch 'master' into ad/detekt-bazel", "committedDate": "2020-04-28T18:26:41Z", "type": "commit"}, {"oid": "111d2abada5c0f288d080bbd5d873f9717ec09b9", "url": "https://github.com/envoyproxy/envoy-mobile/commit/111d2abada5c0f288d080bbd5d873f9717ec09b9", "message": "Fix multiline invocation.\n\nSigned-off-by: Artur Dryomov <artur.dryomov@gmail.com>", "committedDate": "2020-04-28T18:38:52Z", "type": "commit"}]}