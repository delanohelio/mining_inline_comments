{"pr_number": 1021, "pr_title": "shutdown: create avenues for shutdown out of static de-initialization", "pr_createdAt": "2020-08-11T21:15:42Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1021", "timeline": [{"oid": "14bbbb0e961390615d54c75722b36516f370b5cf", "url": "https://github.com/envoyproxy/envoy-mobile/commit/14bbbb0e961390615d54c75722b36516f370b5cf", "message": "engine testing\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-29T00:22:14Z", "type": "commit"}, {"oid": "273143cd096af223a3271cc0cd8f9eb08819f4d2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/273143cd096af223a3271cc0cd8f9eb08819f4d2", "message": "experiment\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-29T21:21:35Z", "type": "commit"}, {"oid": "95508358fd31bc7bbbb99012a702b246c88f941c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/95508358fd31bc7bbbb99012a702b246c88f941c", "message": "Merge branch 'main' into set-null", "committedDate": "2020-08-11T04:37:03Z", "type": "commit"}, {"oid": "6e88fd3cd5be8ad3ed612560ae9d25a070e29341", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6e88fd3cd5be8ad3ed612560ae9d25a070e29341", "message": "look in linux\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-11T20:21:57Z", "type": "commit"}, {"oid": "93f5fa24d1121ebde10add10bb92705f63761bb9", "url": "https://github.com/envoyproxy/envoy-mobile/commit/93f5fa24d1121ebde10add10bb92705f63761bb9", "message": "join main thread\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-11T20:57:09Z", "type": "commit"}, {"oid": "91f3917ed4b1b75d4d8f430615660b2bc32b5764", "url": "https://github.com/envoyproxy/envoy-mobile/commit/91f3917ed4b1b75d4d8f430615660b2bc32b5764", "message": "clean up\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-11T21:26:48Z", "type": "commit"}, {"oid": "d7daeb3135b04590fa09911c63b16d3f6ef3fdab", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d7daeb3135b04590fa09911c63b16d3f6ef3fdab", "message": "clean up\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-11T21:27:32Z", "type": "commit"}, {"oid": "f5c780411a669fbd74f01433a9212f8337ea921a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f5c780411a669fbd74f01433a9212f8337ea921a", "message": "bring back context\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-11T22:11:42Z", "type": "commit"}, {"oid": "685cad333eb92ca0e6b84407bf113e830d7e8872", "url": "https://github.com/envoyproxy/envoy-mobile/commit/685cad333eb92ca0e6b84407bf113e830d7e8872", "message": "move strong ref\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-12T00:44:25Z", "type": "commit"}, {"oid": "7dda8804c9dbda5976eede757eff03a0bec13c14", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7dda8804c9dbda5976eede757eff03a0bec13c14", "message": "clean up\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-12T01:00:07Z", "type": "commit"}, {"oid": "e9279776dc0332ce4d3fec4fbc15740868b58b80", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e9279776dc0332ce4d3fec4fbc15740868b58b80", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-12T01:00:30Z", "type": "commit"}, {"oid": "6ca9b043709720a2cdb0cee6c0ddbf08a43660f9", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6ca9b043709720a2cdb0cee6c0ddbf08a43660f9", "message": "updates\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-12T22:30:56Z", "type": "commit"}, {"oid": "4378bb17a5f1810a8da643967919cde1443812d3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4378bb17a5f1810a8da643967919cde1443812d3", "message": "stamping and tests, missing context from platform for engine callbacks\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-12T23:58:13Z", "type": "commit"}, {"oid": "f3d8caacee87efe183f27abcb95a3d30b9565f44", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f3d8caacee87efe183f27abcb95a3d30b9565f44", "message": "final touches\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-13T01:17:25Z", "type": "commit"}, {"oid": "2a6cbadc534e4ebdc6575435bd913a8aa1040343", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2a6cbadc534e4ebdc6575435bd913a8aa1040343", "message": "ios and asan failures\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-13T19:04:10Z", "type": "commit"}, {"oid": "4c9950f256e958d467fac99a886b99472bde7959", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4c9950f256e958d467fac99a886b99472bde7959", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-13T20:19:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkwNjczNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r470906734", "bodyText": "Can you provide some motivation here?", "author": "goaway", "createdAt": "2020-08-14T23:44:14Z", "path": "library/common/engine.cc", "diffHunk": "@@ -21,17 +21,21 @@ Engine::Engine(envoy_engine_callbacks callbacks, const char* config, const char*\n   main_thread_ = std::thread(&Engine::run, this, std::string(config), std::string(log_level));\n }\n \n-envoy_status_t Engine::run(std::string config, std::string log_level) {\n+envoy_status_t Engine::run(const std::string config, const std::string log_level) {\n   {\n     Thread::LockGuard lock(mutex_);\n     try {\n-      char* envoy_argv[] = {strdup(\"envoy\"), strdup(\"--config-yaml\"),   strdup(config.c_str()),\n-                            strdup(\"-l\"),    strdup(log_level.c_str()), nullptr};\n+      const std::string name = \"envoy\";\n+      const std::string config_flag = \"--config-yaml\";\n+      const std::string log_flag = \"-l\";\n+      const char* envoy_argv[] = {name.c_str(),     config_flag.c_str(), config.c_str(),\n+                                  log_flag.c_str(), log_level.c_str(),   nullptr};", "originalCommit": "4c9950f256e958d467fac99a886b99472bde7959", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkxNjc2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r470916767", "bodyText": "asan correctly complained about the engine test. the old strdup based implementation was leaking all these strings.", "author": "junr03", "createdAt": "2020-08-15T00:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkwNjczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwODQ0MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r483208441", "bodyText": "We were leaking them intentionally before because we weren't sure how long Envoy needed them to stick around. This is fine though; they're on the stack anyways for the full duration of run.", "author": "goaway", "createdAt": "2020-09-03T19:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkwNjczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkwNzE4MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r470907181", "bodyText": "This comment really applies to the event loop rather than the above calls now.", "author": "goaway", "createdAt": "2020-08-14T23:45:46Z", "path": "library/common/engine.cc", "diffHunk": "@@ -60,13 +64,14 @@ envoy_status_t Engine::run(std::string config, std::string log_level) {\n   // The main run loop must run without holding the mutex, so that the destructor can acquire it.\n   bool run_success = TS_UNCHECKED_READ(main_common_)->run();\n \n-  // The above call is blocking; at this point the event loop has exited.\n-  callbacks_.on_exit();\n-\n   // Ensure destructors run on Envoy's main thread.\n+  http_dispatcher_->exit();\n   postinit_callback_handler_.reset();\n   TS_UNCHECKED_READ(main_common_).reset();\n \n+  // The above call is blocking; at this point the event loop has exited.", "originalCommit": "4c9950f256e958d467fac99a886b99472bde7959", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b309cc73db498d74171b3a7b2d7df9f0964129b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/5b309cc73db498d74171b3a7b2d7df9f0964129b", "message": "update comment placing\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-08-17T21:26:05Z", "type": "commit"}, {"oid": "e1a6f8c65a5d3d6405d8b68ecb8dc178a3692456", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e1a6f8c65a5d3d6405d8b68ecb8dc178a3692456", "message": "Merge branch 'main' into set-null\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-02T23:26:10Z", "type": "commit"}, {"oid": "6cd198cd42df6afdacf011916582aef27ebf010d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6cd198cd42df6afdacf011916582aef27ebf010d", "message": "updates\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-02T23:30:55Z", "type": "commit"}, {"oid": "b0757528016fa83f9a69c9eea4d800ec9dde4142", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b0757528016fa83f9a69c9eea4d800ec9dde4142", "message": "error\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-03T00:26:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMjU2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r482812567", "bodyText": "Won't this terminate the engine on any lifecycle notification? Or are we only registering for backgrounding/shutdown.", "author": "goaway", "createdAt": "2020-09-03T08:46:53Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -193,19 +195,18 @@ - (void)recordCounter:(NSString *)elements count:(NSUInteger)count {\n \n - (void)startObservingLifecycleNotifications {\n   NSNotificationCenter *notificationCenter = [NSNotificationCenter defaultCenter];\n-  [notificationCenter addObserver:self\n-                         selector:@selector(lifecycleDidChangeWithNotification:)\n-                             name:UIApplicationWillResignActiveNotification\n-                           object:nil];\n   [notificationCenter addObserver:self\n                          selector:@selector(lifecycleDidChangeWithNotification:)\n                              name:UIApplicationWillTerminateNotification\n                            object:nil];\n }\n \n - (void)lifecycleDidChangeWithNotification:(NSNotification *)notification {\n-  NSLog(@\"[Envoy] triggering stats flush (%@)\", notification.name);\n-  flush_stats();\n+  NSLog(@\"[Envoy] terminating engine (%@)\", notification.name);\n+  // TODO: ensure this is called with the correct envoy_engine_t once multiple Engine objects can\n+  // be allocated.\n+  // https://github.com/lyft/envoy-mobile/issues/332\n+  terminate_engine(0);", "originalCommit": "b0757528016fa83f9a69c9eea4d800ec9dde4142", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMzE5Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r482813192", "bodyText": "Also, we should have access to the engine handle here. No need to hardcode 0.", "author": "goaway", "createdAt": "2020-09-03T08:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMjU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA5MjAwMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r483092000", "bodyText": "I deleted the observer for UIApplicationWillResignActiveNotification so it will only be on termination. ack on the engine handle, will update.", "author": "junr03", "createdAt": "2020-09-03T16:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMjU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNzM2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r483207367", "bodyText": "I think the notification actually has the lifecycle event on it, so we could be more picky here. My worry is that if someone adds it back in, it won't be obvious they're doing something wrong, and it could cause networking to fail until the app is restarted.", "author": "goaway", "createdAt": "2020-09-03T19:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMjU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMzc2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r482813768", "bodyText": "I agree this ordering makes more sense.", "author": "goaway", "createdAt": "2020-09-03T08:49:02Z", "path": "library/common/engine.cc", "diffHunk": "@@ -60,14 +64,14 @@ envoy_status_t Engine::run(std::string config, std::string log_level) {\n \n   // The main run loop must run without holding the mutex, so that the destructor can acquire it.\n   bool run_success = TS_UNCHECKED_READ(main_common_)->run();\n-\n   // The above call is blocking; at this point the event loop has exited.\n-  callbacks_.on_exit();\n \n   // Ensure destructors run on Envoy's main thread.\n   postinit_callback_handler_.reset();\n   TS_UNCHECKED_READ(main_common_).reset();\n \n+  callbacks_.on_exit(callbacks_.context);", "originalCommit": "b0757528016fa83f9a69c9eea4d800ec9dde4142", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "875224b75cda373f9746dc1dc31b81e47428b45d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/875224b75cda373f9746dc1dc31b81e47428b45d", "message": "engine handle\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-03T16:23:18Z", "type": "commit"}, {"oid": "4710fa5611c326ebe256155e342d84b85751578e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4710fa5611c326ebe256155e342d84b85751578e", "message": "Merge branch 'main' into set-null\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-03T16:23:51Z", "type": "commit"}, {"oid": "6bf2c1e13d2122b17b91fd766235d0c06a8c6222", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6bf2c1e13d2122b17b91fd766235d0c06a8c6222", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-03T19:41:44Z", "type": "commit"}, {"oid": "bbba71dbdf16ca5978dce3a40b12bb3f03dc3082", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bbba71dbdf16ca5978dce3a40b12bb3f03dc3082", "message": "Merge branch 'main' into set-null\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-03T20:45:14Z", "type": "commit"}, {"oid": "ccc55137ab275fa4a09a373516829ff0856e9dae", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ccc55137ab275fa4a09a373516829ff0856e9dae", "message": "build\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-09-03T20:45:39Z", "type": "commit"}]}