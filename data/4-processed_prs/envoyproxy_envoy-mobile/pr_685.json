{"pr_number": 685, "pr_title": "dispatcher: update to use new internal header map types", "pr_createdAt": "2020-02-12T23:43:51Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/685", "timeline": [{"oid": "fff47d5896ca7f1efc429ff300ca9a2048ffae12", "url": "https://github.com/envoyproxy/envoy-mobile/commit/fff47d5896ca7f1efc429ff300ca9a2048ffae12", "message": "dispatcher: update to use new internal header map types\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-12T23:43:31Z", "type": "commit"}, {"oid": "20281666383030ace055b792a99653f59954b836", "url": "https://github.com/envoyproxy/envoy-mobile/commit/20281666383030ace055b792a99653f59954b836", "message": "fix and add tests\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T19:00:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2NzUxMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/685#discussion_r379067513", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @return HeaderMapPtr, the HeaderMap 1:1 transformation of the headers param.\n          \n          \n            \n             * @return RequestHeaderMapPtr, the RequestHeaderMap 1:1 transformation of the headers param.", "author": "rebello95", "createdAt": "2020-02-13T19:21:00Z", "path": "library/common/http/header_utility.h", "diffHunk": "@@ -17,12 +17,20 @@ namespace Utility {\n std::string convertToString(envoy_data s);\n \n /**\n- * Transform envoy_headers to HeaderMap.\n+ * Transform envoy_headers to RequestHeaderMap.\n+ * This function copies the content.\n+ * @param headers, the envoy_headers to transform.\n+ * @return HeaderMapPtr, the HeaderMap 1:1 transformation of the headers param.", "originalCommit": "20281666383030ace055b792a99653f59954b836", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2NzczNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/685#discussion_r379067734", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @return HeaderMapPtr, the HeaderMap 1:1 transformation of the headers param.\n          \n          \n            \n             * @return RequestTrailerMapPtr, the RequestTrailerMap 1:1 transformation of the headers param.", "author": "rebello95", "createdAt": "2020-02-13T19:21:20Z", "path": "library/common/http/header_utility.h", "diffHunk": "@@ -17,12 +17,20 @@ namespace Utility {\n std::string convertToString(envoy_data s);\n \n /**\n- * Transform envoy_headers to HeaderMap.\n+ * Transform envoy_headers to RequestHeaderMap.\n+ * This function copies the content.\n+ * @param headers, the envoy_headers to transform.\n+ * @return HeaderMapPtr, the HeaderMap 1:1 transformation of the headers param.\n+ */\n+RequestHeaderMapPtr toRequestHeaders(envoy_headers headers);\n+\n+/**\n+ * Transform envoy_headers to RequestHeaderMap.\n  * This function copies the content.\n  * @param headers, the envoy_headers to transform.\n  * @return HeaderMapPtr, the HeaderMap 1:1 transformation of the headers param.", "originalCommit": "20281666383030ace055b792a99653f59954b836", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2Nzk5MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/685#discussion_r379067990", "bodyText": "nit: might also make sense to rename headers to trailers now that we have an explicit RequestTrailerMapPtr type", "author": "rebello95", "createdAt": "2020-02-13T19:21:51Z", "path": "library/common/http/header_utility.h", "diffHunk": "@@ -17,12 +17,20 @@ namespace Utility {\n std::string convertToString(envoy_data s);\n \n /**\n- * Transform envoy_headers to HeaderMap.\n+ * Transform envoy_headers to RequestHeaderMap.\n+ * This function copies the content.\n+ * @param headers, the envoy_headers to transform.\n+ * @return HeaderMapPtr, the HeaderMap 1:1 transformation of the headers param.\n+ */\n+RequestHeaderMapPtr toRequestHeaders(envoy_headers headers);\n+\n+/**\n+ * Transform envoy_headers to RequestHeaderMap.\n  * This function copies the content.\n  * @param headers, the envoy_headers to transform.\n  * @return HeaderMapPtr, the HeaderMap 1:1 transformation of the headers param.\n  */\n-HeaderMapPtr toInternalHeaders(envoy_headers headers);\n+RequestTrailerMapPtr toRequestTrailers(envoy_headers headers);", "originalCommit": "20281666383030ace055b792a99653f59954b836", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1Nzg4MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/685#discussion_r379157881", "bodyText": "Thoughts?", "author": "rebello95", "createdAt": "2020-02-13T22:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2Nzk5MA=="}], "type": "inlineReview"}, {"oid": "91211d3acd75a2f53da9032e0697396e32a525b6", "url": "https://github.com/envoyproxy/envoy-mobile/commit/91211d3acd75a2f53da9032e0697396e32a525b6", "message": "fix dispatcher tests\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T19:26:12Z", "type": "commit"}, {"oid": "3849bfb7877ca4f9fb18b30c8be4fbccf3455fa8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3849bfb7877ca4f9fb18b30c8be4fbccf3455fa8", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Mike Schore <mike.schore@gmail.com>\n\nCo-Authored-By: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-02-13T19:31:17Z", "type": "commit"}, {"oid": "de32c5f9db3986d5728fe33fd663c7560e3d4d27", "url": "https://github.com/envoyproxy/envoy-mobile/commit/de32c5f9db3986d5728fe33fd663c7560e3d4d27", "message": "fixes and feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T19:34:25Z", "type": "commit"}, {"oid": "a9f870e5495e1b40b8a0f8111b3eb013389f0f75", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a9f870e5495e1b40b8a0f8111b3eb013389f0f75", "message": "fix\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T19:36:10Z", "type": "commit"}, {"oid": "cd1ec533ea3097dd23ac90ca1e4a1678c91f3756", "url": "https://github.com/envoyproxy/envoy-mobile/commit/cd1ec533ea3097dd23ac90ca1e4a1678c91f3756", "message": "fix integration test and format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T21:58:09Z", "type": "commit"}, {"oid": "3788d981320e05d455de60b73acec9036d3be2dc", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3788d981320e05d455de60b73acec9036d3be2dc", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T22:02:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1Nzg1NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/685#discussion_r379157855", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Transform envoy_headers to RequestHeaderMap.\n          \n          \n            \n             * Transform envoy_headers to RequestTrailerMap.", "author": "rebello95", "createdAt": "2020-02-13T22:34:55Z", "path": "library/common/http/header_utility.h", "diffHunk": "@@ -17,12 +17,20 @@ namespace Utility {\n std::string convertToString(envoy_data s);\n \n /**\n- * Transform envoy_headers to HeaderMap.\n+ * Transform envoy_headers to RequestHeaderMap.\n+ * This function copies the content.\n+ * @param headers, the envoy_headers to transform.\n+ * @return RequestHeaderMapPtr, the RequestHeaderMap 1:1 transformation of the headers param.\n+ */\n+RequestHeaderMapPtr toRequestHeaders(envoy_headers headers);\n+\n+/**\n+ * Transform envoy_headers to RequestHeaderMap.", "originalCommit": "3788d981320e05d455de60b73acec9036d3be2dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1ODg2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/685#discussion_r379158867", "bodyText": "toInternalHeaders doesn't exist anymore", "author": "rebello95", "createdAt": "2020-02-13T22:37:40Z", "path": "test/common/http/header_utility_test.cc", "diffHunk": "@@ -66,6 +75,47 @@ TEST(HeaderDataConstructorTest, FromCToCpp) {\n   delete sentinel;\n }\n \n+TEST(RequestTrailerDataConstructorTest, FromCToCpp) {\n+  // Backing strings for all the envoy_datas in the c_trailers.\n+  std::vector<std::pair<std::string, std::string>> trailers = {\n+      {\"processing-duration-ms\", \"25\"}, {\"response-compression-ratio\", \"0.61\"}};\n+\n+  envoy_header* header_array = new envoy_header[trailers.size()];\n+\n+  uint32_t* sentinel = new uint32_t;\n+  *sentinel = 0;\n+  for (size_t i = 0; i < trailers.size(); i++) {\n+    header_array[i] = {\n+        envoyTestString(trailers[i].first, sentinel),\n+        envoyTestString(trailers[i].second, sentinel),\n+    };\n+  }\n+\n+  envoy_headers c_trailers = {static_cast<envoy_header_size_t>(trailers.size()), header_array};\n+  // This copy is used for assertions given that envoy_trailers are released when toInternalHeaders", "originalCommit": "3788d981320e05d455de60b73acec9036d3be2dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d5a4ec93d3bf8eb0b3d86177b70539eb1eca9e7c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d5a4ec93d3bf8eb0b3d86177b70539eb1eca9e7c", "message": "update header\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T22:38:12Z", "type": "commit"}, {"oid": "4093bcbc40eedb7b990529c4d89577a03cf2b1d7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4093bcbc40eedb7b990529c4d89577a03cf2b1d7", "message": "fix comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-02-13T22:39:37Z", "type": "commit"}]}