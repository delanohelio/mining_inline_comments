{"pr_number": 1090, "pr_title": "filters: support internal buffering", "pr_createdAt": "2020-09-14T12:27:15Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1090", "timeline": [{"oid": "c78f205b015dc735fa156f963e8724aece7185d8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c78f205b015dc735fa156f963e8724aece7185d8", "message": "wip\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-14T20:09:53Z", "type": "forcePushed"}, {"oid": "8e1e61bd68120c066018dfb372321c8dfc72d2b3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8e1e61bd68120c066018dfb372321c8dfc72d2b3", "message": "wip\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-14T20:31:04Z", "type": "forcePushed"}, {"oid": "9edc583005aa42480d4f5d1488d1ced847d01f18", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9edc583005aa42480d4f5d1488d1ced847d01f18", "message": "wip fixing tests\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-15T19:28:27Z", "type": "forcePushed"}, {"oid": "c885cb753a6bcc3c7865a3ef765b2f79a691c7a2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c885cb753a6bcc3c7865a3ef765b2f79a691c7a2", "message": "filters: pass aggregate buffered data to platform\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-16T08:50:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxODU0OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r489718549", "bodyText": "Are we planning to add an error here or will we silently fail?", "author": "buildbreaker", "createdAt": "2020-09-16T19:55:58Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -81,20 +82,59 @@ Http::FilterHeadersStatus PlatformBridgeFilter::onHeaders(Http::HeaderMap& heade\n }\n \n Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool end_stream,\n+                                                    Buffer::Instance* internal_buffer,\n                                                     envoy_filter_on_data_f on_data) {\n   // Allow nullptr to act as no-op.\n   if (on_data == nullptr) {\n     return Http::FilterDataStatus::Continue;\n   }\n \n-  envoy_data in_data = Buffer::Utility::toBridgeData(data);\n+  envoy_data in_data;\n+\n+  if (iteration_mode_ == IterationMode::Stopped && internal_buffer &&\n+      internal_buffer->length() > 0) {\n+    // Pre-emptively buffer data to present aggregate to platform.\n+    internal_buffer->move(data);\n+    in_data = Buffer::Utility::copyToBridgeData(*internal_buffer);\n+  } else {\n+    in_data = Buffer::Utility::copyToBridgeData(data);\n+  }\n+\n   envoy_filter_data_status result = on_data(in_data, end_stream, platform_filter_.instance_context);\n   Http::FilterDataStatus status = static_cast<Http::FilterDataStatus>(result.status);\n+  switch (status) {\n+  case Http::FilterDataStatus::Continue:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Error: iteration must be Resumed first.", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNTE3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r489825177", "bodyText": "Options are to fail the request or crash the app. Neither seems terribly ideal, but perhaps neither is silently failing. I hadn't made up my mind here yet.", "author": "goaway", "createdAt": "2020-09-17T00:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxODU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MDExNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490580115", "bodyText": "Seems like the place for an assertion? i.e the contract is that if the FilterDataStatus is to continue it is a programming error to have the manager's iteration_mode as anything but ongoing?\nRelated. Can we write API docs for the programming contract that these filters have?", "author": "junr03", "createdAt": "2020-09-17T21:46:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxODU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MzMzNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490583335", "bodyText": "^ Yeah, after going through this section in it entirety I think we need some more comments about all the combinations and why we are treating them as we are.", "author": "junr03", "createdAt": "2020-09-17T21:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxODU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEyNjA5NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r491126094", "bodyText": "Agreed about public documentation (there's an issue tracking it) - also this is currently captured in the planning doc I shared when we decided on this behavior. Whether and how it's a programming error is something I'm still ambivalent about. We could also generate an error response, too. Or do nothing here, and let Envoy do whatever it does when requests/responses try to forward invalid state. I'm going to make this a TODO I think for now.", "author": "goaway", "createdAt": "2020-09-18T18:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxODU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxOTQ3MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r489719471", "bodyText": "Do we use the no buffer variant here because the data is being buffered in this filter?", "author": "buildbreaker", "createdAt": "2020-09-16T19:57:42Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -81,20 +82,59 @@ Http::FilterHeadersStatus PlatformBridgeFilter::onHeaders(Http::HeaderMap& heade\n }\n \n Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool end_stream,\n+                                                    Buffer::Instance* internal_buffer,\n                                                     envoy_filter_on_data_f on_data) {\n   // Allow nullptr to act as no-op.\n   if (on_data == nullptr) {\n     return Http::FilterDataStatus::Continue;\n   }\n \n-  envoy_data in_data = Buffer::Utility::toBridgeData(data);\n+  envoy_data in_data;\n+\n+  if (iteration_mode_ == IterationMode::Stopped && internal_buffer &&\n+      internal_buffer->length() > 0) {\n+    // Pre-emptively buffer data to present aggregate to platform.\n+    internal_buffer->move(data);\n+    in_data = Buffer::Utility::copyToBridgeData(*internal_buffer);\n+  } else {\n+    in_data = Buffer::Utility::copyToBridgeData(data);\n+  }\n+\n   envoy_filter_data_status result = on_data(in_data, end_stream, platform_filter_.instance_context);\n   Http::FilterDataStatus status = static_cast<Http::FilterDataStatus>(result.status);\n+  switch (status) {\n+  case Http::FilterDataStatus::Continue:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Error: iteration must be Resumed first.\n+    }\n+    break;\n+  case Http::FilterDataStatus::StopIterationAndBuffer:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Data has already have been buffered.", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNTI1Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r489825257", "bodyText": "Yes, that's correct.", "author": "goaway", "createdAt": "2020-09-17T00:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxOTQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NTY2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490575667", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @param data, the Buffer::Instance to transform.\n          \n          \n            \n             * @param data, the Buffer::Instance to copy from.", "author": "junr03", "createdAt": "2020-09-17T21:35:39Z", "path": "library/common/buffer/utility.h", "diffHunk": "@@ -22,6 +22,13 @@ Buffer::InstancePtr toInternalData(envoy_data data);\n  */\n envoy_data toBridgeData(Buffer::Instance&);\n \n+/**\n+ * Copy from Buffer::Instance to envoy_data.\n+ * @param data, the Buffer::Instance to transform.", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NTc3MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490575770", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @return envoy_data, the 1:1 transformation of the Buffer::Instance param.\n          \n          \n            \n             * @return envoy_data, the 1:1 copy of the Buffer::Instance param.", "author": "junr03", "createdAt": "2020-09-17T21:35:51Z", "path": "library/common/buffer/utility.h", "diffHunk": "@@ -22,6 +22,13 @@ Buffer::InstancePtr toInternalData(envoy_data data);\n  */\n envoy_data toBridgeData(Buffer::Instance&);\n \n+/**\n+ * Copy from Buffer::Instance to envoy_data.\n+ * @param data, the Buffer::Instance to transform.\n+ * @return envoy_data, the 1:1 transformation of the Buffer::Instance param.", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NzY1Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490577653", "bodyText": "nit: The filter manager in envoy defines this as IterationState. Should we keep the same language here?", "author": "junr03", "createdAt": "2020-09-17T21:40:00Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.h", "diffHunk": "@@ -29,6 +29,8 @@ class PlatformBridgeFilterConfig {\n \n typedef std::shared_ptr<PlatformBridgeFilterConfig> PlatformBridgeFilterConfigSharedPtr;\n \n+enum class IterationMode { Ongoing, Stopped };", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3ODMwNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490578305", "bodyText": "Similarly internally Ongoing/Continue?", "author": "junr03", "createdAt": "2020-09-17T21:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NzY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDUwNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490784506", "bodyText": "Given that we now have a Resume status, I felt Ongoing was a bit clearer. Iteration will be ongoing or iteration will be stopped. I'm fine with IterationState though.", "author": "goaway", "createdAt": "2020-09-18T08:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3NzY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3OTAyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490579025", "bodyText": "maybe this will become clear later, but why is this a copy rather than a drain like before?", "author": "junr03", "createdAt": "2020-09-17T21:43:26Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -81,20 +82,59 @@ Http::FilterHeadersStatus PlatformBridgeFilter::onHeaders(Http::HeaderMap& heade\n }\n \n Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool end_stream,\n+                                                    Buffer::Instance* internal_buffer,\n                                                     envoy_filter_on_data_f on_data) {\n   // Allow nullptr to act as no-op.\n   if (on_data == nullptr) {\n     return Http::FilterDataStatus::Continue;\n   }\n \n-  envoy_data in_data = Buffer::Utility::toBridgeData(data);\n+  envoy_data in_data;\n+\n+  if (iteration_mode_ == IterationMode::Stopped && internal_buffer &&\n+      internal_buffer->length() > 0) {\n+    // Pre-emptively buffer data to present aggregate to platform.\n+    internal_buffer->move(data);\n+    in_data = Buffer::Utility::copyToBridgeData(*internal_buffer);\n+  } else {\n+    in_data = Buffer::Utility::copyToBridgeData(data);", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzUwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490783509", "bodyText": "When the buffer is unmodified, we shouldn't be draining Envoy's buffer. Per our discussed API, we now explicitly disallow the buffer to be modified in any state other than Continue or Resume.", "author": "goaway", "createdAt": "2020-09-18T08:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3OTAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzMjg4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r491132888", "bodyText": "There are also other ways we could potentially handle this, but for now, this is expedient and has no real downside since transform was doing a copy anyways.", "author": "goaway", "createdAt": "2020-09-18T18:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3OTAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MDYwNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490580606", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // Data has already have been buffered.\n          \n          \n            \n                  // Data has already have been buffered by the PlatformBridgeFilter.\n          \n      \n    \n    \n  \n\nJust want something more explicit about whose responsibility it is to buffer", "author": "junr03", "createdAt": "2020-09-17T21:47:09Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -81,20 +82,59 @@ Http::FilterHeadersStatus PlatformBridgeFilter::onHeaders(Http::HeaderMap& heade\n }\n \n Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool end_stream,\n+                                                    Buffer::Instance* internal_buffer,\n                                                     envoy_filter_on_data_f on_data) {\n   // Allow nullptr to act as no-op.\n   if (on_data == nullptr) {\n     return Http::FilterDataStatus::Continue;\n   }\n \n-  envoy_data in_data = Buffer::Utility::toBridgeData(data);\n+  envoy_data in_data;\n+\n+  if (iteration_mode_ == IterationMode::Stopped && internal_buffer &&\n+      internal_buffer->length() > 0) {\n+    // Pre-emptively buffer data to present aggregate to platform.\n+    internal_buffer->move(data);\n+    in_data = Buffer::Utility::copyToBridgeData(*internal_buffer);\n+  } else {\n+    in_data = Buffer::Utility::copyToBridgeData(data);\n+  }\n+\n   envoy_filter_data_status result = on_data(in_data, end_stream, platform_filter_.instance_context);\n   Http::FilterDataStatus status = static_cast<Http::FilterDataStatus>(result.status);\n+  switch (status) {\n+  case Http::FilterDataStatus::Continue:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Error: iteration must be Resumed first.\n+    }\n+    break;\n+  case Http::FilterDataStatus::StopIterationAndBuffer:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Data has already have been buffered.", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MTQyNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490581424", "bodyText": "convention is to use NOT_REACHED_GCOVR_EXCL_LINE. You can leave a comment above why the default should not be reached.", "author": "junr03", "createdAt": "2020-09-17T21:48:55Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -81,20 +82,59 @@ Http::FilterHeadersStatus PlatformBridgeFilter::onHeaders(Http::HeaderMap& heade\n }\n \n Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool end_stream,\n+                                                    Buffer::Instance* internal_buffer,\n                                                     envoy_filter_on_data_f on_data) {\n   // Allow nullptr to act as no-op.\n   if (on_data == nullptr) {\n     return Http::FilterDataStatus::Continue;\n   }\n \n-  envoy_data in_data = Buffer::Utility::toBridgeData(data);\n+  envoy_data in_data;\n+\n+  if (iteration_mode_ == IterationMode::Stopped && internal_buffer &&\n+      internal_buffer->length() > 0) {\n+    // Pre-emptively buffer data to present aggregate to platform.\n+    internal_buffer->move(data);\n+    in_data = Buffer::Utility::copyToBridgeData(*internal_buffer);\n+  } else {\n+    in_data = Buffer::Utility::copyToBridgeData(data);\n+  }\n+\n   envoy_filter_data_status result = on_data(in_data, end_stream, platform_filter_.instance_context);\n   Http::FilterDataStatus status = static_cast<Http::FilterDataStatus>(result.status);\n+  switch (status) {\n+  case Http::FilterDataStatus::Continue:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Error: iteration must be Resumed first.\n+    }\n+    break;\n+  case Http::FilterDataStatus::StopIterationAndBuffer:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Data has already have been buffered.\n+      status = Http::FilterDataStatus::StopIterationNoBuffer;\n+    } else {\n+      // Data will be buffered on return.\n+      iteration_mode_ = IterationMode::Stopped;\n+    }\n+    break;\n+  case Http::FilterDataStatus::StopIterationNoBuffer:\n+    // In this context all previously buffered data can/should be dropped.\n+    if (internal_buffer) {\n+      internal_buffer->drain(internal_buffer->length());\n+    }\n+    iteration_mode_ = IterationMode::Stopped;\n+    break;\n+  default:\n+    PANIC(\"unsupported status for platform filters\");", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEzNDkzNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r491134935", "bodyText": "Actually, the default can be reached - we haven't enumerated all statuses Envoy defines, and a truly strange implementation of a filter could try to break things here. I think the assertion is maybe warranted?", "author": "goaway", "createdAt": "2020-09-18T18:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MTQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwNjYzNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r491206634", "bodyText": "@goaway, under the hood NOT_REACHED_GCOVR_EXCL_LINE panics. It doesn't mean that it cannot be reached, it means that if it reaches it is an error.", "author": "junr03", "createdAt": "2020-09-18T21:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MTQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwNTIzMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r492305233", "bodyText": "^ bump on this", "author": "junr03", "createdAt": "2020-09-21T19:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MTQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MzAwMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490583000", "bodyText": "hmmm were we double draining before? Once in toBridge data and once here?", "author": "junr03", "createdAt": "2020-09-17T21:52:39Z", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -81,20 +82,59 @@ Http::FilterHeadersStatus PlatformBridgeFilter::onHeaders(Http::HeaderMap& heade\n }\n \n Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool end_stream,\n+                                                    Buffer::Instance* internal_buffer,\n                                                     envoy_filter_on_data_f on_data) {\n   // Allow nullptr to act as no-op.\n   if (on_data == nullptr) {\n     return Http::FilterDataStatus::Continue;\n   }\n \n-  envoy_data in_data = Buffer::Utility::toBridgeData(data);\n+  envoy_data in_data;\n+\n+  if (iteration_mode_ == IterationMode::Stopped && internal_buffer &&\n+      internal_buffer->length() > 0) {\n+    // Pre-emptively buffer data to present aggregate to platform.\n+    internal_buffer->move(data);\n+    in_data = Buffer::Utility::copyToBridgeData(*internal_buffer);\n+  } else {\n+    in_data = Buffer::Utility::copyToBridgeData(data);\n+  }\n+\n   envoy_filter_data_status result = on_data(in_data, end_stream, platform_filter_.instance_context);\n   Http::FilterDataStatus status = static_cast<Http::FilterDataStatus>(result.status);\n+  switch (status) {\n+  case Http::FilterDataStatus::Continue:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Error: iteration must be Resumed first.\n+    }\n+    break;\n+  case Http::FilterDataStatus::StopIterationAndBuffer:\n+    if (iteration_mode_ == IterationMode::Stopped) {\n+      // Data has already have been buffered.\n+      status = Http::FilterDataStatus::StopIterationNoBuffer;\n+    } else {\n+      // Data will be buffered on return.\n+      iteration_mode_ = IterationMode::Stopped;\n+    }\n+    break;\n+  case Http::FilterDataStatus::StopIterationNoBuffer:\n+    // In this context all previously buffered data can/should be dropped.\n+    if (internal_buffer) {\n+      internal_buffer->drain(internal_buffer->length());\n+    }\n+    iteration_mode_ = IterationMode::Stopped;\n+    break;\n+  default:\n+    PANIC(\"unsupported status for platform filters\");\n+  }\n+\n   // TODO(goaway): Current platform implementations expose immutable data, thus any modification\n   // necessitates a full copy. Add 'modified' bit to determine when we can elide the copy. See also\n   // https://github.com/lyft/envoy-mobile/issues/949 for potential future optimization.\n-  data.drain(data.length());", "originalCommit": "2472fdba601d2a74d6e72aec54cf7de8aef93579", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MjI0MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1090#discussion_r490782241", "bodyText": "Yes, we were double draining before. Which was benign, but not ideal.", "author": "goaway", "createdAt": "2020-09-18T08:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4MzAwMA=="}], "type": "inlineReview"}, {"oid": "b085bc0c0b724f6c70aba75b3688a2b7931516c0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b085bc0c0b724f6c70aba75b3688a2b7931516c0", "message": "filters: pass aggregate buffered data to platform\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "7ad8910931645aaf29255671481c2118a6adcafe", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7ad8910931645aaf29255671481c2118a6adcafe", "message": "fix test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "b63df6dafb963ce4441f3ee2a426bb51b54d5d3a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b63df6dafb963ce4441f3ee2a426bb51b54d5d3a", "message": "add bidirectional support\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "8743a9c887c8e9fe08d94b12b30668c9c70454c2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8743a9c887c8e9fe08d94b12b30668c9c70454c2", "message": "add bidirectional coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "9d144bfa68774815e0e95fa59ae6d4c1e6e007bb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9d144bfa68774815e0e95fa59ae6d4c1e6e007bb", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "b6600c8a9f871a00b95bfcf224a9d4dd37f861c5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b6600c8a9f871a00b95bfcf224a9d4dd37f861c5", "message": "fix asan\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "a73cda4ab4d738a23a824e5bf3de83361f56f66c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a73cda4ab4d738a23a824e5bf3de83361f56f66c", "message": "change mode to state\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "975c3d88fa60aebed71e213366e90a590b8a9f30", "url": "https://github.com/envoyproxy/envoy-mobile/commit/975c3d88fa60aebed71e213366e90a590b8a9f30", "message": "clarify some comments per feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "8c528dd56e8a487ad9d358aef564b58e7bbe8e42", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8c528dd56e8a487ad9d358aef564b58e7bbe8e42", "message": "fix typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "3ffd978bcc8a927d4723ca4df52e75e902669ad8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3ffd978bcc8a927d4723ca4df52e75e902669ad8", "message": "add missing release calls\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "commit"}, {"oid": "3ffd978bcc8a927d4723ca4df52e75e902669ad8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3ffd978bcc8a927d4723ca4df52e75e902669ad8", "message": "add missing release calls\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T02:44:07Z", "type": "forcePushed"}, {"oid": "d1d8f67f0e57991d768d312e7b530bc72d79138e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d1d8f67f0e57991d768d312e7b530bc72d79138e", "message": "kick ci\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-22T03:21:11Z", "type": "commit"}]}