{"pr_number": 771, "pr_title": "stats: add segmentation of stats via virtual clusters", "pr_createdAt": "2020-03-24T21:57:26Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/771", "timeline": [{"oid": "20a9266c3cfa28897d7036d2cb9419eb953f9f33", "url": "https://github.com/envoyproxy/envoy-mobile/commit/20a9266c3cfa28897d7036d2cb9419eb953f9f33", "message": "stats: add segmentation of stats via virtual clusters\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-03-24T21:54:29Z", "type": "commit"}, {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "url": "https://github.com/envoyproxy/envoy-mobile/commit/fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "message": "docs\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-03-24T21:59:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4ODU1Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397488553", "bodyText": "Is there an example if a json_config or is it just a list of strings?", "author": "buildbreaker", "createdAt": "2020-03-24T22:02:03Z", "path": "docs/root/api/starting_envoy.rst", "diffHunk": "@@ -163,6 +163,27 @@ This information is sent as metadata when flushing stats.\n   // Swift\n   builder.addAppId(\"com.mydomain.myapp)\n \n+~~~~~~~~~~~~~~~~~~~~~~\n+``addVirtualClusters``\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+Specify the virtual clusters config for Envoy Mobile's configuration.\n+The configuration is expected as a JSON list.\n+This functionality is used for stat segmentation.\n+\n+.. attention::\n+\n+    This API is non-ideal as it exposes lower-level internals of Envoy than desired by this project.\n+    https://github.com/lyft/envoy-mobile/issues/770 tracks enhancing this API.\n+\n+**Example**::\n+\n+  // Kotlin\n+  builder.addVirtualClusters(\"[{json_config}]\")", "originalCommit": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4OTE5Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397489192", "bodyText": "Definitely agree that we should add an actual example here", "author": "rebello95", "createdAt": "2020-03-24T22:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4ODU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4OTQzMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397489431", "bodyText": "You should be able to use :issue: here", "author": "rebello95", "createdAt": "2020-03-24T22:03:56Z", "path": "docs/root/api/starting_envoy.rst", "diffHunk": "@@ -163,6 +163,27 @@ This information is sent as metadata when flushing stats.\n   // Swift\n   builder.addAppId(\"com.mydomain.myapp)\n \n+~~~~~~~~~~~~~~~~~~~~~~\n+``addVirtualClusters``\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+Specify the virtual clusters config for Envoy Mobile's configuration.\n+The configuration is expected as a JSON list.\n+This functionality is used for stat segmentation.\n+\n+.. attention::\n+\n+    This API is non-ideal as it exposes lower-level internals of Envoy than desired by this project.\n+    https://github.com/lyft/envoy-mobile/issues/770 tracks enhancing this API.", "originalCommit": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4OTc2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397489767", "bodyText": "May be worth specifying more details here (JSON list of virtual clusters?)", "author": "rebello95", "createdAt": "2020-03-24T22:04:35Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyConfiguration.java", "diffHunk": "@@ -23,10 +24,11 @@\n    * @param statsFlushSeconds            interval at which to flush Envoy stats.\n    * @param appVersion                   the App Version of the App using this Envoy Client.\n    * @param appId                        the App ID of the App using this Envoy Client.\n+   * @param virtualClusters              the virtual cluster config.", "originalCommit": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTc1NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397491754", "bodyText": "I'm a little concerned that even though this is temporary, consumers can easily incorrectly add clusters. What do you think about doing something like this:\nprivate var virtualClusters = [String]()\n\nfunc addVirtualCluster(_ virtualCluster: String) -> EnvoyClientBuilder {\n  self.virtualClusters.append(virtualCluster)\n  return self\n}\n\nThen later you can pass it down as \"[\\(self.virtualClusters.joined(separator: \",\")]\"\nWDYT?", "author": "rebello95", "createdAt": "2020-03-24T22:09:05Z", "path": "library/swift/src/EnvoyClientBuilder.swift", "diffHunk": "@@ -20,6 +20,7 @@ public final class EnvoyClientBuilder: NSObject {\n   private var statsFlushSeconds: UInt32 = 60\n   private var appVersion: String = \"unspecified\"\n   private var appId: String = \"unspecified\"\n+  private var virtualClusters: String = \"[]\"", "originalCommit": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNDMzNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397524337", "bodyText": "I'm not sure your proposal gives much additional protection. In general I think the approach I would like to take here is to actually work with the structured config in the bridge/native layer, and expose ergonomic APIs up to the platform. So for instance the API at the platform layer would not be addVirtualClusters which is an implementation detail IMO, but rather addPathSegmentation (or something like that). Because what we are really trying to achieve here is higher dimension observability.", "author": "junr03", "createdAt": "2020-03-24T23:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyNjk2Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397526967", "bodyText": "@junr03  @rebello95 I want to make sure we're in alignment for our objective here. This is all temporary, right? I think we should be more willing to go with what we have now to see how the data looks in the next few days and make adjustments after our beta cut.\nWhat do you think?", "author": "buildbreaker", "createdAt": "2020-03-24T23:40:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUyODgyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397528829", "bodyText": "Yes, 100% agree that this is temporary. Just seems like the suggestion would provide a little more resiliency in the mean time, but this is fine", "author": "rebello95", "createdAt": "2020-03-24T23:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzMjY1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397532659", "bodyText": "yeah, this approach is temporary.", "author": "junr03", "createdAt": "2020-03-24T23:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTc1NA=="}], "type": "inlineReview"}, {"oid": "d14d4c76bbb2c9e5d441c4a36ecf3e3682be87c1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d14d4c76bbb2c9e5d441c4a36ecf3e3682be87c1", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-03-24T23:30:00Z", "type": "commit"}, {"oid": "0e1e9181a10d3874a16edfe22cff9a8fd801d397", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0e1e9181a10d3874a16edfe22cff9a8fd801d397", "message": "update envoy\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-03-25T00:59:43Z", "type": "commit"}, {"oid": "200b923e8924e37424a878c180e38f35b5caed36", "url": "https://github.com/envoyproxy/envoy-mobile/commit/200b923e8924e37424a878c180e38f35b5caed36", "message": "Merge branch 'master' into virtual-clusters\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-03-26T19:07:46Z", "type": "commit"}]}