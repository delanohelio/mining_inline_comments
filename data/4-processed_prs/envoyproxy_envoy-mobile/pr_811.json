{"pr_number": 811, "pr_title": "config: fix max concurrent retries circuit breaker", "pr_createdAt": "2020-04-23T23:41:56Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/811", "timeline": [{"oid": "b31ef17f01a59215d87685065ad1a1fcbd18fb2e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b31ef17f01a59215d87685065ad1a1fcbd18fb2e", "message": "config: fix max concurrent retries circuit breaker\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-23T23:36:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzIyMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/811#discussion_r414207221", "bodyText": "Why not just add a min_retry_concurrency? See:\nhttps://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cluster/circuit_breaker.proto#cluster-circuitbreakers-thresholds-retrybudget", "author": "tonya11en", "createdAt": "2020-04-24T00:14:31Z", "path": "library/common/config_template.cc", "diffHunk": "@@ -74,14 +74,12 @@ const char* config_template = R\"(\n       thresholds:\n         - priority: DEFAULT\n           # n.b: with mobile clients there are scenarios where all concurrent requests might be\n-          # retries (e.g., when the phone goes offline). Therefore, Envoy Mobile allows all concurrent\n-          # requests to be retries by setting the concurrent retry budget to 100%.\n+          # retries (e.g., when the phone goes offline). Therefore, Envoy Mobile allows for the same\n+          # amount of concurrency for retries as the default value for concurrency for requests.\n           # This configuration uses the default for max concurrent requests (1024) because there is\n           # no reasonable scenario where a mobile client should have even close to that many concurrent\n           # requests.\n-          retry_budget:\n-            budget_percent:\n-              value: 100\n+          max_retries: 1024", "originalCommit": "b31ef17f01a59215d87685065ad1a1fcbd18fb2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODE4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/811#discussion_r414208188", "bodyText": "If you just say min_retry_concurrency: 1024 you'll then just have that be the lower bound.", "author": "tonya11en", "createdAt": "2020-04-24T00:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc1MTEzNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/811#discussion_r414751137", "bodyText": "@tonya11en im not sure I see the benefit of having a retry budget if the min is the same as the max requests circuit breaker. In that case the concurrency would be capped at 1024 anyway you dice it.\nWhat would be interesting for this scenario would be a retry budget based on active downstream requests. Because what we want here is to have active retries for potentially 100% of active downstream requests.", "author": "junr03", "createdAt": "2020-04-24T17:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg1NjUwNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/811#discussion_r414856507", "bodyText": "Thanks for the reply below @tonya11en :).\nAny thoughts about retry budgets based on number of concurrent downstream requests?", "author": "junr03", "createdAt": "2020-04-24T20:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzIyMQ=="}], "type": "inlineReview"}, {"oid": "c7a58a416d890fb48370aff00978be22c12e9ea3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c7a58a416d890fb48370aff00978be22c12e9ea3", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-04-24T20:52:26Z", "type": "commit"}]}