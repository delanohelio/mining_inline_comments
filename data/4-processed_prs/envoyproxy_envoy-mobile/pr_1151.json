{"pr_number": 1151, "pr_title": "filters: fix some missing JNI wiring", "pr_createdAt": "2020-10-28T12:29:35Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1151", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513751178", "bodyText": "sorry, I am a bit decontextualized here. Why 3? Can we have a constant?", "author": "junr03", "createdAt": "2020-10-28T20:50:13Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -259,10 +259,18 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onRequestData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;\n+  if (size == 3) {", "originalCommit": "738d22c734d45cdd41d681dc5ec23b31dd3543ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2NjYyNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513766624", "bodyText": "Yeah, this isn't a great check. I'd like to move to fully-bridged types for filter statuses. But this ensures we don't attempt out of bounds access on the array.", "author": "goaway", "createdAt": "2020-10-28T21:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNDcwMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r514614703", "bodyText": "Sure the comment helps. Can we state why 3 here and 4 below? Maybe make them constants?", "author": "junr03", "createdAt": "2020-10-29T22:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgzODgwMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r514838802", "bodyText": "Sure, I'll do that.", "author": "goaway", "createdAt": "2020-10-30T04:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU3MTI1NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r515571255", "bodyText": "Updated with a different and clearer check.", "author": "goaway", "createdAt": "2020-11-01T03:48:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513751584", "bodyText": "Can we create static funcs for the repeated code in these functions?", "author": "junr03", "createdAt": "2020-10-28T20:50:58Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -271,18 +279,27 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   env->DeleteLocalRef(j_data);\n \n   return (envoy_filter_data_status){/*status*/ unboxed_status,\n-                                    /*data*/ native_data};\n+                                    /*data*/ native_data,\n+                                    /*pending_headers*/ pending_headers};\n }\n \n static envoy_filter_data_status jvm_http_filter_on_response_data(envoy_data data, bool end_stream,\n                                                                  const void* context) {\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onResponseData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;", "originalCommit": "738d22c734d45cdd41d681dc5ec23b31dd3543ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2NTA1MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513765050", "bodyText": "I think the common factoring that's already here complicates following the code in this file somewhat, and would hesitate to push it further.", "author": "goaway", "createdAt": "2020-10-28T21:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNTAzOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r514615039", "bodyText": "Not sure I completely agree. But feel free to TIOLI!", "author": "junr03", "createdAt": "2020-10-29T22:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3MTc0MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r515471741", "bodyText": "Thanks, I do appreciate the perspective. I'll think further about how this could be simplified, but for now I'm going to stick with my inclination to leave it. Note there's a great deal of dispatch to common-factored paths already occurring. e.g. the jvm_http_filter_on_response_headers delegates to jvm_on_response_headers, which delegates to jvm_on_headers, which delegates pass_headers, all of which make use of further extracted common utility functions. While this common factoring can serve to encapsulate logic, it also means you need to jump between more locations to follow what's actually happening.", "author": "goaway", "createdAt": "2020-10-31T08:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTY3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513751677", "bodyText": "Same two comments as above", "author": "junr03", "createdAt": "2020-10-28T20:51:12Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -328,39 +346,69 @@ static envoy_filter_trailers_status jvm_http_filter_on_request_trailers(envoy_he\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_trailers(\"onRequestTrailers\", trailers, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobjectArray j_trailers = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n   int unboxed_status = unbox_integer(env, status);\n-  envoy_headers native_headers = to_native_headers(env, j_trailers);\n+  envoy_headers native_trailers = to_native_headers(env, j_trailers);\n+\n+  envoy_headers* pending_headers = nullptr;\n+  envoy_data* pending_data = nullptr;\n+  if (size == 4) {", "originalCommit": "738d22c734d45cdd41d681dc5ec23b31dd3543ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d53cd0e9ba9c93211cb75ec800f489fb553c7094", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d53cd0e9ba9c93211cb75ec800f489fb553c7094", "message": "filters: fix some missing JNI wiring\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:02:57Z", "type": "commit"}, {"oid": "ee899b5cc3a45e34ac8220f05ab7c9daf103e01c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ee899b5cc3a45e34ac8220f05ab7c9daf103e01c", "message": "add comment; fix index\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:02:57Z", "type": "commit"}, {"oid": "bdf81036263f96eded08f48d7d3a29d40bcc8630", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bdf81036263f96eded08f48d7d3a29d40bcc8630", "message": "switch to different (maybe clearer?) check\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:02:57Z", "type": "commit"}, {"oid": "644d53249144a828bce16a0053adfb41eed0b518", "url": "https://github.com/envoyproxy/envoy-mobile/commit/644d53249144a828bce16a0053adfb41eed0b518", "message": "fix declaration ordering\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:02:57Z", "type": "commit"}, {"oid": "644d53249144a828bce16a0053adfb41eed0b518", "url": "https://github.com/envoyproxy/envoy-mobile/commit/644d53249144a828bce16a0053adfb41eed0b518", "message": "fix declaration ordering\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-10-31T19:02:57Z", "type": "forcePushed"}]}