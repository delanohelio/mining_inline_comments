{"pr_number": 1050, "pr_title": "jni: make get_env skip JNI calls for the normal case", "pr_createdAt": "2020-08-26T13:08:56Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1050", "timeline": [{"oid": "68210234f1f4a453c5570b9ad03b1482026fbc29", "url": "https://github.com/envoyproxy/envoy-mobile/commit/68210234f1f4a453c5570b9ad03b1482026fbc29", "message": "jni: make get_env skip JNI calls for the normal case\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-26T13:08:45Z", "type": "commit"}, {"oid": "68210234f1f4a453c5570b9ad03b1482026fbc29", "url": "https://github.com/envoyproxy/envoy-mobile/commit/68210234f1f4a453c5570b9ad03b1482026fbc29", "message": "jni: make get_env skip JNI calls for the normal case\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-26T13:08:45Z", "type": "forcePushed"}, {"oid": "be6d62699df7d46f65467b9404e4bd5e75ba67bb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/be6d62699df7d46f65467b9404e4bd5e75ba67bb", "message": "fix cast\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-26T13:51:26Z", "type": "commit"}, {"oid": "976a63823cc71a589ca4a651505b34e17c393900", "url": "https://github.com/envoyproxy/envoy-mobile/commit/976a63823cc71a589ca4a651505b34e17c393900", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-08-26T13:56:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY0NTM0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050#discussion_r477645345", "bodyText": "Please open issue for adding assertion dependency :)", "author": "buildbreaker", "createdAt": "2020-08-26T23:02:26Z", "path": "library/common/jni/jni_utility.cc", "diffHunk": "@@ -8,24 +8,26 @@\n // NOLINT(namespace-envoy)\n \n static JavaVM* static_jvm = nullptr;\n+static thread_local JNIEnv* local_env = nullptr;\n \n void set_vm(JavaVM* vm) { static_jvm = vm; }\n \n JavaVM* get_vm() { return static_jvm; }\n \n JNIEnv* get_env() {\n-  JNIEnv* env = nullptr;\n-  int get_env_res = static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n-  if (get_env_res == JNI_EDETACHED) {\n-    // TODO(goway): fix logging\n-    // log_write(ANDROID_LOG_VERBOSE, \"[Envoy]\", \"environment is JNI_EDETACHED\");\n+  if (local_env) {\n+    return local_env;\n+  }\n+\n+  jint result = static_jvm->GetEnv(reinterpret_cast<void**>(&local_env), JNI_VERSION);\n+  if (result == JNI_EDETACHED) {\n     // Note: the only thread that should need to be attached is Envoy's engine std::thread.\n-    // TODO: harden this piece of code to make sure that we are only needing to attach Envoy\n-    // engine's std::thread, and that we detach it successfully.\n-    static_jvm->AttachCurrentThread(&env, nullptr);\n-    static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n+    JavaVMAttachArgs args = {JNI_VERSION, \"EnvoyMain\", NULL};\n+    result = static_jvm->AttachCurrentThread(&local_env, &args);\n   }\n-  return env;\n+  // TODO(goaway): add assertions and uncomment\n+  // ASSERT(result == JNI_OK);", "originalCommit": "976a63823cc71a589ca4a651505b34e17c393900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4MDczMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050#discussion_r478680732", "bodyText": "#1054", "author": "goaway", "createdAt": "2020-08-27T20:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY0NTM0NQ=="}], "type": "inlineReview"}]}