{"pr_number": 1072, "pr_title": "assertion filter: add response assertion support", "pr_createdAt": "2020-09-03T22:55:28Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1072", "timeline": [{"oid": "d526559bb72e7e3bcebc5ab9a19e7e8f2f2c3532", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d526559bb72e7e3bcebc5ab9a19e7e8f2f2c3532", "message": "use InternalServerError for failed response assertions\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-09T02:39:28Z", "type": "forcePushed"}, {"oid": "eafaaa4b0b041e1f889dda04403babe094d55316", "url": "https://github.com/envoyproxy/envoy-mobile/commit/eafaaa4b0b041e1f889dda04403babe094d55316", "message": "update failure paths\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T09:20:37Z", "type": "forcePushed"}, {"oid": "23febab69e917d9939e194f203bf67a028a87fbe", "url": "https://github.com/envoyproxy/envoy-mobile/commit/23febab69e917d9939e194f203bf67a028a87fbe", "message": "add coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T23:07:10Z", "type": "forcePushed"}, {"oid": "e85776cdff2ce64b9414e82fac33087f24255df5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e85776cdff2ce64b9414e82fac33087f24255df5", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T23:09:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTU5MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#discussion_r486685590", "bodyText": "same misspell as #1071", "author": "junr03", "createdAt": "2020-09-10T23:20:21Z", "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -133,6 +135,111 @@ Http::FilterTrailersStatus AssertionFilter::decodeTrailers(Http::RequestTrailerM\n   return Http::FilterTrailersStatus::Continue;\n }\n \n+Http::FilterHeadersStatus AssertionFilter::encodeHeaders(Http::ResponseHeaderMap& headers,\n+                                                         bool end_stream) {\n+  config_->rootMatcher().onHttpResponseHeaders(headers, statuses_);\n+  auto& match_status = config_->rootMatcher().matchStatus(statuses_);\n+  if (!match_status.matches_ && !match_status.might_change_status_) {\n+    decoder_callbacks_->sendLocalReply(Http::Code::InternalServerError,\n+                                       \"Response Headers do not match configured expectations\",\n+                                       nullptr, absl::nullopt, \"\");\n+    return Http::FilterHeadersStatus::StopIteration;\n+  }\n+\n+  if (end_stream) {\n+    // Check if there are unsatisfied assertions about stream data.\n+    Buffer::OwnedImpl empty_buffer;\n+    config_->rootMatcher().onResponseBody(empty_buffer, statuses_);\n+    auto& match_status = config_->rootMatcher().matchStatus(statuses_);\n+    if (!match_status.matches_ && !match_status.might_change_status_) {\n+      decoder_callbacks_->sendLocalReply(Http::Code::InternalServerError,\n+                                         \"Response Body does not match configured expectations\",\n+                                         nullptr, absl::nullopt, \"\");\n+      return Http::FilterHeadersStatus::StopIteration;\n+    }\n+\n+    // Check of there are unsatisfied assertions about stream trailers.", "originalCommit": "e85776cdff2ce64b9414e82fac33087f24255df5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTc0OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#discussion_r486685748", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // DIVIDE\n          \n          \n            \n            // Response Pathway\n          \n      \n    \n    \n  \n\n?", "author": "junr03", "createdAt": "2020-09-10T23:20:48Z", "path": "test/common/extensions/filters/http/assertion/assertion_filter_test.cc", "diffHunk": "@@ -263,6 +263,240 @@ TEST_F(AssertionFilterTest, RequestTrailersNoMatch) {\n   EXPECT_EQ(Http::FilterTrailersStatus::StopIteration, filter_->decodeTrailers(request_trailers));\n }\n \n+// DIVIDE", "originalCommit": "e85776cdff2ce64b9414e82fac33087f24255df5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NzY2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#discussion_r486687668", "bodyText": "haha this was for jumping back to here in vim", "author": "goaway", "createdAt": "2020-09-10T23:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTc0OA=="}], "type": "inlineReview"}, {"oid": "1281430fa7be61fe4e1cf7be02bf2135b91b500e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1281430fa7be61fe4e1cf7be02bf2135b91b500e", "message": "typo and cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T23:29:53Z", "type": "forcePushed"}, {"oid": "d9598ca6d8223196cc79ee81fa69da4084a341ee", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d9598ca6d8223196cc79ee81fa69da4084a341ee", "message": "assertion filter: add response assertion support\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "6830b5195c019004a5ed6b29f1481828c0940bcc", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6830b5195c019004a5ed6b29f1481828c0940bcc", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "35cb7f4e21d08978823ab65ac219c1eea5220d80", "url": "https://github.com/envoyproxy/envoy-mobile/commit/35cb7f4e21d08978823ab65ac219c1eea5220d80", "message": "use InternalServerError for failed response assertions\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "1fc0ed145672ba539d6f45c86ae0c9011b7533f8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1fc0ed145672ba539d6f45c86ae0c9011b7533f8", "message": "update failure paths\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "0dd300895f29fa508850bb1ff90d5986b0c25b04", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0dd300895f29fa508850bb1ff90d5986b0c25b04", "message": "small fix\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "b5cc00fe992b6665d0f9baff8867aa8556de0909", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b5cc00fe992b6665d0f9baff8867aa8556de0909", "message": "add coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "e58d0d9aac560692d8988e6d94ca717afad80678", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e58d0d9aac560692d8988e6d94ca717afad80678", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "url": "https://github.com/envoyproxy/envoy-mobile/commit/06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "message": "typo and cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "commit"}, {"oid": "06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "url": "https://github.com/envoyproxy/envoy-mobile/commit/06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "message": "typo and cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-11T17:56:01Z", "type": "forcePushed"}]}