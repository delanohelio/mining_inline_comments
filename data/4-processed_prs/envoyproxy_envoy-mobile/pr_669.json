{"pr_number": 669, "pr_title": "core: prevent race that causes double delete of HCM ActiveStreams", "pr_createdAt": "2020-02-08T02:26:15Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/669", "timeline": [{"oid": "06bfb3f8ab39fcd8a3ebe47febc8cc723d5c0319", "url": "https://github.com/envoyproxy/envoy-mobile/commit/06bfb3f8ab39fcd8a3ebe47febc8cc723d5c0319", "message": "wip\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-07T22:40:42Z", "type": "commit"}, {"oid": "09608b2ce2d1d900b1886b34daa959de44cf7d45", "url": "https://github.com/envoyproxy/envoy-mobile/commit/09608b2ce2d1d900b1886b34daa959de44cf7d45", "message": "test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-08T01:54:10Z", "type": "commit"}, {"oid": "8f166a496cb00a66126478aa4872fa77c223f30b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8f166a496cb00a66126478aa4872fa77c223f30b", "message": "Merge branch 'master' into deletion-race\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-08T01:55:18Z", "type": "commit"}, {"oid": "91b1a099beb37cf5750d7d03291b89806a78ba57", "url": "https://github.com/envoyproxy/envoy-mobile/commit/91b1a099beb37cf5750d7d03291b89806a78ba57", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-08T02:11:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwMDQ0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/669#discussion_r377200440", "bodyText": "nit: pending_cleanup or pending_delete is a little more concise and feels equally expressive in this case. definitely nabd.", "author": "goaway", "createdAt": "2020-02-10T17:15:23Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -31,6 +31,13 @@ Dispatcher::DirectStreamCallbacks::DirectStreamCallbacks(DirectStream& direct_st\n void Dispatcher::DirectStreamCallbacks::encodeHeaders(const HeaderMap& headers, bool end_stream) {\n   ENVOY_LOG(debug, \"[S{}] response headers for stream (end_stream={}):\\n{}\",\n             direct_stream_.stream_handle_, end_stream, headers);\n+\n+  // @see Dispatcher::resetStream's comment on its call to runResetCallbacks.\n+  // Envoy only deferredDeletes the ActiveStream if it was fully closed otherwise it issues a reset.\n+  if (direct_stream_.local_closed_ && end_stream) {\n+    direct_stream_.pending_stream_deferred_delete_ = true;", "originalCommit": "91b1a099beb37cf5750d7d03291b89806a78ba57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxNDI0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/669#discussion_r377214245", "bodyText": "@goaway I wanted to make it clear that it isn't the direct_stream that is pending deletion, but the HCM's active_stream that the direct_stream shadows. I am concerned that direct_stream_.pending_cleanup makes it seem like the direct stream is the one pending cleanup.\nPerhaps hcm_stream_pending_destroy?", "author": "junr03", "createdAt": "2020-02-10T17:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwMDQ0MA=="}], "type": "inlineReview"}, {"oid": "c0b91c77e5244122ba6f367ef9c7308298ac036b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c0b91c77e5244122ba6f367ef9c7308298ac036b", "message": "var name\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-02-10T18:12:40Z", "type": "commit"}]}