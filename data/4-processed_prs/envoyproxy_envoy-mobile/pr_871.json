{"pr_number": 871, "pr_title": "observability: add stream stats to the http dispatcher", "pr_createdAt": "2020-06-01T22:10:41Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/871", "timeline": [{"oid": "7e78629b0e38c0af6eca0194b0427abf8519d627", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7e78629b0e38c0af6eca0194b0427abf8519d627", "message": "observability: add stream stats to the http dispatcher\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-06-01T21:58:31Z", "type": "commit"}, {"oid": "bee32cbaa7147d723adc4ccabd810f65192efa65", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bee32cbaa7147d723adc4ccabd810f65192efa65", "message": "emission\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-06-01T22:09:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTE3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433531175", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // only count the on error if it is dispatchable. Otherwise, the onReset was caused due to a\n          \n          \n            \n                // Only count the on error if it is dispatchable. Otherwise, the onReset was caused due to a", "author": "buildbreaker", "createdAt": "2020-06-01T22:53:43Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -206,6 +219,9 @@ void Dispatcher::DirectStreamCallbacks::onReset() {\n   if (direct_stream_.dispatchable(true)) {\n     ENVOY_LOG(debug, \"[S{}] dispatching to platform remote reset stream\",\n               direct_stream_.stream_handle_);\n+    // only count the on error if it is dispatchable. Otherwise, the onReset was caused due to a", "originalCommit": "bee32cbaa7147d723adc4ccabd810f65192efa65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTU3Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433531576", "bodyText": "Why not just emit the stat here?", "author": "goaway", "createdAt": "2020-06-01T22:55:02Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -33,6 +34,13 @@ void Dispatcher::DirectStreamCallbacks::encodeHeaders(const ResponseHeaderMap& h\n   ENVOY_LOG(debug, \"[S{}] response headers for stream (end_stream={}):\\n{}\",\n             direct_stream_.stream_handle_, end_stream, headers);\n \n+  uint64_t response_status = Utility::getResponseStatus(headers);\n+\n+  // Record received status to report success or failure stat in\n+  // Dispatcher::DirectStreamCallbacks::closeRemote. Not reported here to avoid more complexity with\n+  // checking end stream, and the potential for stream reset, thus resulting in mis-reporting.\n+  observed_success_ = CodeUtility::is2xx(response_status);", "originalCommit": "bee32cbaa7147d723adc4ccabd810f65192efa65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMzMyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433533325", "bodyText": "Looks like this is explained via the docs directly above?", "author": "rebello95", "createdAt": "2020-06-01T23:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMzg0Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433533847", "bodyText": "@junr03 Can correct me if I'm wrong (maybe that'll be best anyway!) but the intent here is to get a high level stat on when the application side is able to receive a success or failure.\nThe reason we don't track it here is because we could run into other stream events where the application side wouldn't necessarily get a \"complete request\" but we'll be tracking a success here.", "author": "buildbreaker", "createdAt": "2020-06-01T23:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzMTc4NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r434031784", "bodyText": "Yep, the intention to not increase here is that we could still receive a reset or a cancel if the on headers call is not final. So instead of increasing in this function in the dispatch block for the terminal case, and in on complete for the other cases I decided to just increase when on complete is dispatched.", "author": "junr03", "createdAt": "2020-06-02T16:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MDk0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r434180940", "bodyText": "I guess what I was getting at is you could emit stream_opened or stream_failed here. If canceled happens later that can still be reported and you (arguably?) have more insight, rather than less, with (maybe?) less complexity since you don't need state. But I guess it all depends on what you actually want captured.\nI missed the comment. :)", "author": "goaway", "createdAt": "2020-06-02T21:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4NDE5MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r434184190", "bodyText": "I probably should have been more clear also - it's not that big a deal, and I am fine with the current approach. was mostly just wondering if the extra state was really necessary.", "author": "goaway", "createdAt": "2020-06-02T21:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNTk4MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433535980", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Set response header status to be non-2xx to test correct stats get charged.\n          \n          \n            \n              // Set response header status to be non-2xx to test that correct stats get charged.", "author": "buildbreaker", "createdAt": "2020-06-01T23:09:58Z", "path": "test/integration/dispatcher_integration_test.cc", "diffHunk": "@@ -177,13 +177,107 @@ TEST_P(DispatcherIntegrationTest, Basic) {\n   ASSERT_EQ(cc.on_headers_calls, 1);\n   ASSERT_EQ(cc.on_data_calls, 2);\n   ASSERT_EQ(cc.on_complete_calls, 1);\n+\n+  test_server_->waitForCounterEq(\"http.dispatcher.stream_success\", 1);\n+}\n+\n+TEST_P(DispatcherIntegrationTest, BasicNon2xx) {\n+  ConditionalInitializer ready_ran;\n+  test_server_->server().dispatcher().post([this, &ready_ran]() -> void {\n+    http_dispatcher_.ready(\n+        test_server_->server().dispatcher(), test_server_->statStore(),\n+        test_server_->server().listenerManager().apiListener()->get().http()->get());\n+    ready_ran.setReady();\n+  });\n+  ready_ran.waitReady();\n+\n+  // Set response header status to be non-2xx to test correct stats get charged.", "originalCommit": "bee32cbaa7147d723adc4ccabd810f65192efa65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNjIxOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433536218", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    test_server_->server().dispatcher(), test_server_->statStore(),\n          \n          \n            \n                    test_server_->server().dispatcher(), \n          \n          \n            \n                    test_server_->statStore(),", "author": "buildbreaker", "createdAt": "2020-06-01T23:10:46Z", "path": "test/integration/dispatcher_integration_test.cc", "diffHunk": "@@ -114,7 +114,7 @@ TEST_P(DispatcherIntegrationTest, Basic) {\n   ConditionalInitializer ready_ran;\n   test_server_->server().dispatcher().post([this, &ready_ran]() -> void {\n     http_dispatcher_.ready(\n-        test_server_->server().dispatcher(),\n+        test_server_->server().dispatcher(), test_server_->statStore(),", "originalCommit": "bee32cbaa7147d723adc4ccabd810f65192efa65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzNzUxNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r434037514", "bodyText": "letting clang-format call the shots", "author": "junr03", "createdAt": "2020-06-02T17:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNjIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNjY1MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433536651", "bodyText": "Maybe we should have a positive case also: Basic2xx?", "author": "buildbreaker", "createdAt": "2020-06-01T23:12:15Z", "path": "test/integration/dispatcher_integration_test.cc", "diffHunk": "@@ -177,13 +177,107 @@ TEST_P(DispatcherIntegrationTest, Basic) {\n   ASSERT_EQ(cc.on_headers_calls, 1);\n   ASSERT_EQ(cc.on_data_calls, 2);\n   ASSERT_EQ(cc.on_complete_calls, 1);\n+\n+  test_server_->waitForCounterEq(\"http.dispatcher.stream_success\", 1);\n+}\n+\n+TEST_P(DispatcherIntegrationTest, BasicNon2xx) {", "originalCommit": "bee32cbaa7147d723adc4ccabd810f65192efa65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNzUzOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433537539", "bodyText": "Do we want a test case to ensure we are incrementing the stats at the appropriate time based on: https://github.com/lyft/envoy-mobile/pull/871/files#r433531576", "author": "buildbreaker", "createdAt": "2020-06-01T23:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNjY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyOTk3NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r434029974", "bodyText": "Maybe we should have a positive case also: Basic2xx?\n\nBasic covers that.", "author": "junr03", "createdAt": "2020-06-02T16:56:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNjY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzMDU0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r434030540", "bodyText": "Do we want a test case to ensure we are incrementing the stats at the appropriate time based on\n\nI believe the race test below does that. Let me double check", "author": "junr03", "createdAt": "2020-06-02T16:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNjY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzMzY1MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r434033650", "bodyText": "https://github.com/lyft/envoy-mobile/pull/871/files/bee32cbaa7147d723adc4ccabd810f65192efa65#diff-bb212e49f4cf7a1c832af632465e1440R339 this test shows that even if we received headers if cancelation won out the race we get the right stat", "author": "junr03", "createdAt": "2020-06-02T17:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNjY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzNzM1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/871#discussion_r433537359", "bodyText": "What do you think about the naming BasicResetsIncrementFailures to help describe what behavior we are trying to exercise here?", "author": "buildbreaker", "createdAt": "2020-06-01T23:14:48Z", "path": "test/integration/dispatcher_integration_test.cc", "diffHunk": "@@ -177,13 +177,107 @@ TEST_P(DispatcherIntegrationTest, Basic) {\n   ASSERT_EQ(cc.on_headers_calls, 1);\n   ASSERT_EQ(cc.on_data_calls, 2);\n   ASSERT_EQ(cc.on_complete_calls, 1);\n+\n+  test_server_->waitForCounterEq(\"http.dispatcher.stream_success\", 1);\n+}\n+\n+TEST_P(DispatcherIntegrationTest, BasicNon2xx) {\n+  ConditionalInitializer ready_ran;\n+  test_server_->server().dispatcher().post([this, &ready_ran]() -> void {\n+    http_dispatcher_.ready(\n+        test_server_->server().dispatcher(), test_server_->statStore(),\n+        test_server_->server().listenerManager().apiListener()->get().http()->get());\n+    ready_ran.setReady();\n+  });\n+  ready_ran.waitReady();\n+\n+  // Set response header status to be non-2xx to test correct stats get charged.\n+  reinterpret_cast<AutonomousUpstream*>(fake_upstreams_.front().get())\n+      ->setResponseHeaders(std::make_unique<Http::TestResponseHeaderMapImpl>(\n+          Http::TestHeaderMapImpl({{\":status\", \"503\"}, {\"content-length\", \"0\"}})));\n+\n+  envoy_stream_t stream = 1;\n+  // Setup bridge_callbacks to handle the response.\n+  envoy_http_callbacks bridge_callbacks;\n+  ConditionalInitializer terminal_callback;\n+  callbacks_called cc = {0, 0, 0, 0, 0, &terminal_callback};\n+  bridge_callbacks.context = &cc;\n+  bridge_callbacks.on_headers = [](envoy_headers, bool, void* context) -> void {\n+    callbacks_called* cc = static_cast<callbacks_called*>(context);\n+    cc->on_headers_calls++;\n+  };\n+  bridge_callbacks.on_complete = [](void* context) -> void {\n+    callbacks_called* cc = static_cast<callbacks_called*>(context);\n+    cc->on_complete_calls++;\n+    cc->terminal_callback->setReady();\n+  };\n+  bridge_callbacks.on_error = [](envoy_error, void* context) -> void {\n+    callbacks_called* cc = static_cast<callbacks_called*>(context);\n+    cc->on_error_calls++;\n+  };\n+\n+  // Build a set of request headers.\n+  Http::TestRequestHeaderMapImpl headers;\n+  HttpTestUtility::addDefaultHeaders(headers);\n+  envoy_headers c_headers = Http::Utility::toBridgeHeaders(headers);\n+\n+  // Create a stream.\n+  EXPECT_EQ(http_dispatcher_.startStream(stream, bridge_callbacks), ENVOY_SUCCESS);\n+  http_dispatcher_.sendHeaders(stream, c_headers, true);\n+\n+  terminal_callback.waitReady();\n+\n+  ASSERT_EQ(cc.on_error_calls, 0);\n+  ASSERT_EQ(cc.on_headers_calls, 1);\n+  ASSERT_EQ(cc.on_complete_calls, 1);\n+\n+  test_server_->waitForCounterEq(\"http.dispatcher.stream_failure\", 1);\n+}\n+\n+TEST_P(DispatcherIntegrationTest, BasicReset) {", "originalCommit": "bee32cbaa7147d723adc4ccabd810f65192efa65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8defca58dd938eea4c3af885fd861d13631e0d18", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8defca58dd938eea4c3af885fd861d13631e0d18", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-06-02T17:10:32Z", "type": "commit"}, {"oid": "25f9e6a7864478ce2e8a1bd2aa927980f9b546ea", "url": "https://github.com/envoyproxy/envoy-mobile/commit/25f9e6a7864478ce2e8a1bd2aa927980f9b546ea", "message": "asan\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-06-02T21:05:37Z", "type": "commit"}, {"oid": "9a9257bb4cdfafc3885d8f27608233a1a97b7c68", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9a9257bb4cdfafc3885d8f27608233a1a97b7c68", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-06-02T21:05:59Z", "type": "commit"}, {"oid": "12503d52b792f2be643fb958e9fdd894e08d9d0f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/12503d52b792f2be643fb958e9fdd894e08d9d0f", "message": "asan\n\nSigned-off-by: Jose Nino <jnino@lyft.com>", "committedDate": "2020-06-02T22:28:29Z", "type": "commit"}]}