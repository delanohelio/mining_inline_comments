{"pr_number": 1172, "pr_title": "core: create LocalErrorFilter to map responses to errors", "pr_createdAt": "2020-11-10T14:18:21Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1172", "timeline": [{"oid": "d521bb36a2c3ac1f351a7b0f5a4c8ab602866e19", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d521bb36a2c3ac1f351a7b0f5a4c8ab602866e19", "message": "typos\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-11-18T18:57:54Z", "type": "forcePushed"}, {"oid": "c8f4a176084c8dcaf563435ac9c4b89dba47b6fb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c8f4a176084c8dcaf563435ac9c4b89dba47b6fb", "message": "core: create LocalErrorFilter to map responses to errors\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-11-30T13:52:23Z", "type": "forcePushed"}, {"oid": "99119c042e9266666b24158de0acff4ac7148fe8", "url": "https://github.com/envoyproxy/envoy-mobile/commit/99119c042e9266666b24158de0acff4ac7148fe8", "message": "core: create LocalErrorFilter to map responses to errors\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-11-30T17:55:57Z", "type": "forcePushed"}, {"oid": "35bfc00d10fbf83c453eb3ff0123afbd8248db5e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/35bfc00d10fbf83c453eb3ff0123afbd8248db5e", "message": "undo java formatting changes\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-05T01:12:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjQ3Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r532916473", "bodyText": "usually done via a runtime field", "author": "junr03", "createdAt": "2020-11-30T21:31:09Z", "path": "library/common/extensions/filters/http/local_error/filter.proto", "diffHunk": "@@ -0,0 +1,7 @@\n+syntax = \"proto3\";\n+\n+package envoymobile.extensions.filters.http.local_error;\n+\n+message LocalError {\n+  bool enabled = 1;", "originalCommit": "aa7b7408a959298f9a7d080400c0d34145388695", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzMzg1Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r538933853", "bodyText": "It is, but I wanted to have at least one configuration value, so I wasn't sure what would happen with an empty config. There are other examples of filters with an enabled boolean.", "author": "goaway", "createdAt": "2020-12-09T01:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MjU3OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r542892578", "bodyText": "Oh if that's the case, then you can just delete. It is fine to have an empty message.", "author": "junr03", "createdAt": "2020-12-14T22:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ4MTU4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r543481589", "bodyText": "Pending this.", "author": "junr03", "createdAt": "2020-12-15T16:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNjQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1NDQ2Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r538754466", "bodyText": "I know this won't surface to the application because we end up mapping to an on error response. But I wonder if we should use a non 2xx code here?", "author": "junr03", "createdAt": "2020-12-08T19:41:33Z", "path": "library/common/extensions/filters/http/local_error/filter.cc", "diffHunk": "@@ -0,0 +1,88 @@\n+#include \"library/common/extensions/filters/http/local_error/filter.h\"\n+\n+#include \"envoy/http/codes.h\"\n+#include \"envoy/server/filter_config.h\"\n+\n+#include \"common/http/codes.h\"\n+#include \"common/http/header_map_impl.h\"\n+#include \"common/http/utility.h\"\n+\n+#include \"library/common/http/headers.h\"\n+#include \"library/common/types/c_types.h\"\n+\n+namespace Envoy {\n+namespace Extensions {\n+namespace HttpFilters {\n+namespace LocalError {\n+\n+LocalErrorFilterConfig::LocalErrorFilterConfig(\n+    const envoymobile::extensions::filters::http::local_error::LocalError& proto_config)\n+    : enabled_(proto_config.enabled()) {}\n+\n+LocalErrorFilter::LocalErrorFilter(LocalErrorFilterConfigSharedPtr config) : config_(config) {}\n+\n+Http::FilterHeadersStatus LocalErrorFilter::encodeHeaders(Http::ResponseHeaderMap& headers,\n+                                                          bool end_stream) {\n+  uint64_t response_status = Http::Utility::getResponseStatus(headers);\n+  bool success = Http::CodeUtility::is2xx(response_status);\n+\n+  // TODO: ***HACK*** currently Envoy sends local replies in cases where an error ought to be\n+  // surfaced via the error path. There are ways we can clean up Envoy's local reply path to\n+  // make this possible, but nothing expedient. For the immediate term this is our only real\n+  // option. See https://github.com/lyft/envoy-mobile/issues/460\n+\n+  // Absence of EnvoyUpstreamServiceTime header implies this is a local reply, which we treat as\n+  // a stream error.\n+  if (!success && headers.get(Http::Headers::get().EnvoyUpstreamServiceTime).empty()) {\n+    ENVOY_LOG(debug, \"intercepted local response\");\n+    processingError_ = true;\n+    headers_ = &headers;\n+    mapLocalResponseToError(headers);\n+    return end_stream ? Http::FilterHeadersStatus::Continue\n+                      : Http::FilterHeadersStatus::StopIteration;\n+  }\n+\n+  return Http::FilterHeadersStatus::Continue;\n+}\n+\n+Http::FilterDataStatus LocalErrorFilter::encodeData(Buffer::Instance& data, bool end_stream) {\n+  if (processingError_) {\n+    // We assume the first (and assumed only) data chunk will be a contextual error message.\n+    ASSERT(end_stream,\n+           \"Local responses must end the stream with a single data frame. If Envoy changes \"\n+           \"this expectation, this code needs to be updated.\");\n+    headers_->addCopy(Http::InternalHeaders::get().ErrorMessage, data.toString());\n+    return Http::FilterDataStatus::Continue;\n+  }\n+\n+  return Http::FilterDataStatus::Continue;\n+}\n+\n+void LocalErrorFilter::mapLocalResponseToError(Http::ResponseHeaderMap& headers) {\n+  // Envoy Mobile surfaces non-200 local responses as errors via callbacks rather than an HTTP\n+  // response. Here that response's \"real\" status code is mapped to an Envoy Mobile error code\n+  // which is passed through the response chain as a header. The status code is updated with\n+  // the sentinel value, 218 (\"This is fine\").\n+  switch (Http::Utility::getResponseStatus(headers)) {\n+  case 408:\n+    headers.addCopy(Http::InternalHeaders::get().ErrorCode, std::to_string(ENVOY_REQUEST_TIMEOUT));\n+    break;\n+  case 413:\n+    headers.addCopy(Http::InternalHeaders::get().ErrorCode,\n+                    std::to_string(ENVOY_BUFFER_LIMIT_EXCEEDED));\n+    break;\n+  case 503:\n+    headers.addCopy(Http::InternalHeaders::get().ErrorCode,\n+                    std::to_string(ENVOY_CONNECTION_FAILURE));\n+    break;\n+  default:\n+    headers.addCopy(Http::InternalHeaders::get().ErrorCode, std::to_string(ENVOY_UNDEFINED_ERROR));\n+  }\n+\n+  headers.setStatus(218);", "originalCommit": "140e26ecac62f1d29f64ced2202551bac4208bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzNTQxNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r538935416", "bodyText": "I went with it because its unique, and currently used by Apache for a similar purpose. I wanted to reduce the odds of it triggering any status code based behavior in other filters. (Long-term I'd prefer not to use a mechanism like this at all, but rather implement a real onError pathway in Envoy's filter chain.)", "author": "goaway", "createdAt": "2020-12-09T01:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1NDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MzU0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r542893545", "bodyText": "Sure. Do we have an open issue to get together thoughts on an error pathway in the HCM? I think it is worth opening at this point.", "author": "junr03", "createdAt": "2020-12-14T22:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1NDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAxMzYwNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r543013607", "bodyText": "#1208", "author": "goaway", "createdAt": "2020-12-15T03:15:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1NDQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1NzE0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r538757145", "bodyText": "related to my comment above re: 218. Should the local error path be counted as success?", "author": "junr03", "createdAt": "2020-12-08T19:45:46Z", "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -35,32 +36,41 @@ void Dispatcher::DirectStreamCallbacks::encodeHeaders(const ResponseHeaderMap& h\n             direct_stream_.stream_handle_, end_stream, headers);\n \n   ASSERT(http_dispatcher_.getStream(direct_stream_.stream_handle_));\n-\n-  uint64_t response_status = Utility::getResponseStatus(headers);\n-  // Track success for later bookkeeping (stream could still be reset).\n-  success_ = CodeUtility::is2xx(response_status);\n-\n   if (end_stream) {\n     closeStream();\n   }\n \n-  // TODO: ***HACK*** currently Envoy sends local replies in cases where an error ought to be\n-  // surfaced via the error path. There are ways we can clean up Envoy's local reply path to\n-  // make this possible, but nothing expedient. For the immediate term this is our only real\n-  // option. See https://github.com/lyft/envoy-mobile/issues/460\n+  uint64_t response_status = Utility::getResponseStatus(headers);\n+\n+  // Presence of internal error header indicates an error that should be surfaced as an\n+  // error callback (rather than an HTTP response).\n+  const auto error_code_header = headers.get(InternalHeaders::get().ErrorCode);\n+  if (!error_code_header.empty()) {\n+    envoy_error_code_t error_code;\n+    bool check = absl::SimpleAtoi(error_code_header[0]->value().getStringView(), &error_code);\n+    RELEASE_ASSERT(check, \"parse error reading error code\");\n+    error_code_ = error_code;\n+\n+    const auto error_message_header = headers.get(InternalHeaders::get().ErrorMessage);\n+    if (!error_message_header.empty()) {\n+      error_message_ =\n+          Buffer::Utility::copyToBridgeData(error_message_header[0]->value().getStringView());\n+    }\n+\n+    uint32_t attempt_count;\n+    if (headers.EnvoyAttemptCount() &&\n+        absl::SimpleAtoi(headers.EnvoyAttemptCount()->value().getStringView(), &attempt_count)) {\n+      error_attempt_count_ = attempt_count;\n+    }\n \n-  // Error path: missing EnvoyUpstreamServiceTime implies this is a local reply, which we treat as\n-  // a stream error.\n-  if (!success_ && headers.get(Headers::get().EnvoyUpstreamServiceTime).empty()) {\n-    ENVOY_LOG(debug, \"[S{}] intercepted local response\", direct_stream_.stream_handle_);\n-    mapLocalResponseToError(headers);\n     if (end_stream) {\n       onError();\n     }\n     return;\n   }\n \n-  // Normal response path.\n+  // Track success for later bookkeeping (stream could still be reset).\n+  success_ = CodeUtility::is2xx(response_status);", "originalCommit": "140e26ecac62f1d29f64ced2202551bac4208bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzNTYxMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r538935612", "bodyText": "It won't be. The function returns a couple lines above.", "author": "goaway", "createdAt": "2020-12-09T01:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1NzE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1OTE0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r538759140", "bodyText": "This is the suite where you are going to add more test? Or are you creating a test suite for the filter? Probably both, right?", "author": "junr03", "createdAt": "2020-12-08T19:49:09Z", "path": "test/common/http/dispatcher_test.cc", "diffHunk": "@@ -773,17 +773,29 @@ TEST_F(DispatcherTest, MultipleStreams) {\n   ASSERT_EQ(cc.on_complete_calls, 1);\n }\n \n-TEST_F(DispatcherTest, EnvoyLocalReply) {\n+TEST_F(DispatcherTest, EnvoyLocalReplyNotAnError) {", "originalCommit": "140e26ecac62f1d29f64ced2202551bac4208bef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzNTgzMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r538935830", "bodyText": "Will add both.", "author": "goaway", "createdAt": "2020-12-09T01:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1OTE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5NDEyNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r542894127", "bodyText": "Per offline discussion it sounds like you will add in subsequent PRs. Do you mind opening issue for that?", "author": "junr03", "createdAt": "2020-12-14T22:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1OTE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNTUxMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1172#discussion_r542915511", "bodyText": "Sure - #1207", "author": "goaway", "createdAt": "2020-12-14T23:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1OTE0MA=="}], "type": "inlineReview"}, {"oid": "dbe5649e719cc467da5f302acd8295070a7dd967", "url": "https://github.com/envoyproxy/envoy-mobile/commit/dbe5649e719cc467da5f302acd8295070a7dd967", "message": "core: create LocalErrorFilter to map responses to errors\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "444ed4b1246a7a531a8d510c9e6d8439598025d5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/444ed4b1246a7a531a8d510c9e6d8439598025d5", "message": "fixing tests\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "667b7bcb8107584af9a0e961900a516f8bb7498b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/667b7bcb8107584af9a0e961900a516f8bb7498b", "message": "swift integration coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "ad0d11ed23a52750e745a6faf19897156441a4df", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ad0d11ed23a52750e745a6faf19897156441a4df", "message": "dispatcher integration coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "56c6663ce9b0a963380304377e7abf1f6d197dac", "url": "https://github.com/envoyproxy/envoy-mobile/commit/56c6663ce9b0a963380304377e7abf1f6d197dac", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "108b10e0e30994ae97cff38977d5d467c1cbcd4b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/108b10e0e30994ae97cff38977d5d467c1cbcd4b", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "470d027dc11d6254cb31bf90a5dbc785fc0fd34c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/470d027dc11d6254cb31bf90a5dbc785fc0fd34c", "message": "undo java formatting changes\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "0b1d6251de9af1c7b5b5f056b4e330856091987e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0b1d6251de9af1c7b5b5f056b4e330856091987e", "message": "asan fix\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "56b0ab4b3d79ceecfee162898a6c41d0a59e730b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/56b0ab4b3d79ceecfee162898a6c41d0a59e730b", "message": "remove enabled flag; fix test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "commit"}, {"oid": "56b0ab4b3d79ceecfee162898a6c41d0a59e730b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/56b0ab4b3d79ceecfee162898a6c41d0a59e730b", "message": "remove enabled flag; fix test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:22:19Z", "type": "forcePushed"}, {"oid": "c72cd8abfc7a494cc4a7b899b4a6c44bffe96dae", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c72cd8abfc7a494cc4a7b899b4a6c44bffe96dae", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-16T18:25:28Z", "type": "commit"}, {"oid": "829e658ded9f71e5005c76fca8940929042604e0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/829e658ded9f71e5005c76fca8940929042604e0", "message": "fix integration test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-17T04:46:56Z", "type": "commit"}]}