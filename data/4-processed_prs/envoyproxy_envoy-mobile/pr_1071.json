{"pr_number": 1071, "pr_title": "assertion filter: update to be pass-through", "pr_createdAt": "2020-09-03T22:04:19Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1071", "timeline": [{"oid": "8ac7d79e2e38e3342b77cbf6e06da7ebd760ee71", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8ac7d79e2e38e3342b77cbf6e06da7ebd760ee71", "message": "assertion filter: update to be pass-through\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-03T22:06:15Z", "type": "commit"}, {"oid": "8ac7d79e2e38e3342b77cbf6e06da7ebd760ee71", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8ac7d79e2e38e3342b77cbf6e06da7ebd760ee71", "message": "assertion filter: update to be pass-through\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-03T22:06:15Z", "type": "forcePushed"}, {"oid": "1d7318b3e18dc5b11b0c41d074dc3dd354b5ae77", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1d7318b3e18dc5b11b0c41d074dc3dd354b5ae77", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-03T22:06:58Z", "type": "commit"}, {"oid": "6cf88929c8043694078c507f0921f860973b9598", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6cf88929c8043694078c507f0921f860973b9598", "message": "fix format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-09T02:38:52Z", "type": "commit"}, {"oid": "981361bd742f151eb8336c9dd8b10ebdef01d92c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/981361bd742f151eb8336c9dd8b10ebdef01d92c", "message": "add validation failure path for incomplete requests\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-09T20:18:35Z", "type": "commit"}, {"oid": "b3b5fe32d81f6ed0825643a464c83f9b68ce5363", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b3b5fe32d81f6ed0825643a464c83f9b68ce5363", "message": "update failure handling and fix tests\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T04:15:50Z", "type": "commit"}, {"oid": "a11c24c1a6ab7d25166b900a4804f88539c4137c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a11c24c1a6ab7d25166b900a4804f88539c4137c", "message": "header order maybe\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T04:29:24Z", "type": "commit"}, {"oid": "0b333e88f21d6753b5c81d2dbb1584e8fbd35701", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0b333e88f21d6753b5c81d2dbb1584e8fbd35701", "message": "fix header order\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T09:08:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0MTA3NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486641074", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n          \n          \n            \n              auto& match_status = config_->rootMatcher().matchStatus(statuses_);", "author": "junr03", "createdAt": "2020-09-10T21:22:14Z", "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -26,53 +28,91 @@ AssertionFilter::AssertionFilter(AssertionFilterConfigSharedPtr config) : config\n Http::FilterHeadersStatus AssertionFilter::decodeHeaders(Http::RequestHeaderMap& headers,\n                                                          bool end_stream) {\n   config_->rootMatcher().onHttpRequestHeaders(headers, statuses_);\n-  if (!config_->rootMatcher().matchStatus(statuses_).matches_) {\n+  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);", "originalCommit": "0b333e88f21d6753b5c81d2dbb1584e8fbd35701", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NTczMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486645733", "bodyText": "same elsewhere", "author": "junr03", "createdAt": "2020-09-10T21:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0MTA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0MTI1NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486641254", "bodyText": "\ud83d\udca1 might_change_status_ I see.", "author": "junr03", "createdAt": "2020-09-10T21:22:41Z", "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -26,53 +28,91 @@ AssertionFilter::AssertionFilter(AssertionFilterConfigSharedPtr config) : config\n Http::FilterHeadersStatus AssertionFilter::decodeHeaders(Http::RequestHeaderMap& headers,\n                                                          bool end_stream) {\n   config_->rootMatcher().onHttpRequestHeaders(headers, statuses_);\n-  if (!config_->rootMatcher().matchStatus(statuses_).matches_) {\n+  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n+  if (!matchStatus.matches_ && !matchStatus.might_change_status_) {", "originalCommit": "0b333e88f21d6753b5c81d2dbb1584e8fbd35701", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0MjgxNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486642814", "bodyText": "I see, so here we would like to see if there were expectations for body and trailers that because this request ended on a headers frame would not match.\nDo you mind adding comments explaining the thought process for posterity?", "author": "junr03", "createdAt": "2020-09-10T21:25:58Z", "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -26,53 +28,91 @@ AssertionFilter::AssertionFilter(AssertionFilterConfigSharedPtr config) : config\n Http::FilterHeadersStatus AssertionFilter::decodeHeaders(Http::RequestHeaderMap& headers,\n                                                          bool end_stream) {\n   config_->rootMatcher().onHttpRequestHeaders(headers, statuses_);\n-  if (!config_->rootMatcher().matchStatus(statuses_).matches_) {\n+  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n+  if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n     decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n                                        \"Request Headers do not match configured expectations\",\n                                        nullptr, absl::nullopt, \"\");\n     return Http::FilterHeadersStatus::StopIteration;\n   }\n \n   if (end_stream) {\n-    decoder_callbacks_->sendLocalReply(Http::Code::OK,\n-                                       \"Request Headers match configured expectations\", nullptr,\n-                                       absl::nullopt, \"\");\n-    return Http::FilterHeadersStatus::StopIteration;\n+    Buffer::OwnedImpl empty_buffer;", "originalCommit": "0b333e88f21d6753b5c81d2dbb1584e8fbd35701", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0Nzg5NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486647894", "bodyText": "We are missing tests for some of  the other combinations e.g, trailer missing in headers, trailer missing in data", "author": "junr03", "createdAt": "2020-09-10T21:37:25Z", "path": "test/common/extensions/filters/http/assertion/assertion_filter_test.cc", "diffHunk": "@@ -126,6 +119,29 @@ TEST_F(AssertionFilterTest, DataNoMatch) {\n   EXPECT_EQ(Http::FilterDataStatus::StopIterationNoBuffer, filter_->decodeData(*body, true));\n }\n \n+TEST_F(AssertionFilterTest, DataMissing) {", "originalCommit": "0b333e88f21d6753b5c81d2dbb1584e8fbd35701", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0ODc2MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486648760", "bodyText": "I think I am confused about why we would catch this here rather than in the decodeData call, is it because the matcher is not completely done with knowing that data will not match until we see an end_stream == true in decodeData, or a decodeTrailers call (implying there is no more data to match?).\nSame as above could we add comments so that the thinking is clear?", "author": "junr03", "createdAt": "2020-09-10T21:39:27Z", "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -26,53 +28,91 @@ AssertionFilter::AssertionFilter(AssertionFilterConfigSharedPtr config) : config\n Http::FilterHeadersStatus AssertionFilter::decodeHeaders(Http::RequestHeaderMap& headers,\n                                                          bool end_stream) {\n   config_->rootMatcher().onHttpRequestHeaders(headers, statuses_);\n-  if (!config_->rootMatcher().matchStatus(statuses_).matches_) {\n+  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n+  if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n     decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n                                        \"Request Headers do not match configured expectations\",\n                                        nullptr, absl::nullopt, \"\");\n     return Http::FilterHeadersStatus::StopIteration;\n   }\n \n   if (end_stream) {\n-    decoder_callbacks_->sendLocalReply(Http::Code::OK,\n-                                       \"Request Headers match configured expectations\", nullptr,\n-                                       absl::nullopt, \"\");\n-    return Http::FilterHeadersStatus::StopIteration;\n+    Buffer::OwnedImpl empty_buffer;\n+    config_->rootMatcher().onRequestBody(empty_buffer, statuses_);\n+    auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n+    if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n+      decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n+                                         \"Request Body does not match configured expectations\",\n+                                         nullptr, absl::nullopt, \"\");\n+      return Http::FilterHeadersStatus::StopIteration;\n+    }\n+\n+    auto empty_trailers = Http::RequestTrailerMapImpl::create();\n+    config_->rootMatcher().onHttpRequestTrailers(*empty_trailers, statuses_);\n+    auto& finalMatchStatus = config_->rootMatcher().matchStatus(statuses_);\n+    if (!finalMatchStatus.matches_ && !finalMatchStatus.might_change_status_) {\n+      decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n+                                         \"Request Trailers do not match configured expectations\",\n+                                         nullptr, absl::nullopt, \"\");\n+      return Http::FilterHeadersStatus::StopIteration;\n+    }\n+    if (!finalMatchStatus.matches_) {\n+      decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n+                                         \"Request Body does not match configured expectations\",\n+                                         nullptr, absl::nullopt, \"\");\n+      return Http::FilterHeadersStatus::StopIteration;\n+    }\n   }\n \n   return Http::FilterHeadersStatus::Continue;\n }\n \n Http::FilterDataStatus AssertionFilter::decodeData(Buffer::Instance& data, bool end_stream) {\n   config_->rootMatcher().onRequestBody(data, statuses_);\n-  if (!config_->rootMatcher().matchStatus(statuses_).matches_) {\n+  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n+  if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n     decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n                                        \"Request Body does not match configured expectations\",\n                                        nullptr, absl::nullopt, \"\");\n     return Http::FilterDataStatus::StopIterationNoBuffer;\n   }\n \n   if (end_stream) {\n-    decoder_callbacks_->sendLocalReply(Http::Code::OK, \"Request Body match configured expectations\",\n-                                       nullptr, absl::nullopt, \"\");\n-    return Http::FilterDataStatus::StopIterationNoBuffer;\n+    auto empty_trailers = Http::RequestTrailerMapImpl::create();\n+    config_->rootMatcher().onHttpRequestTrailers(*empty_trailers, statuses_);\n+    auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n+    if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n+      decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n+                                         \"Request Trailers do not match configured expectations\",\n+                                         nullptr, absl::nullopt, \"\");\n+      return Http::FilterDataStatus::StopIterationNoBuffer;\n+    }\n+    if (!matchStatus.matches_) {\n+      decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n+                                         \"Request Body does not match configured expectations\",\n+                                         nullptr, absl::nullopt, \"\");\n+      return Http::FilterDataStatus::StopIterationNoBuffer;\n+    }\n   }\n-\n   return Http::FilterDataStatus::Continue;\n }\n \n Http::FilterTrailersStatus AssertionFilter::decodeTrailers(Http::RequestTrailerMap& trailers) {\n   config_->rootMatcher().onHttpRequestTrailers(trailers, statuses_);\n-  if (!config_->rootMatcher().matchStatus(statuses_).matches_) {\n+  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n+  if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n     decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n                                        \"Request Trailers do not match configured expectations\",\n                                        nullptr, absl::nullopt, \"\");\n     return Http::FilterTrailersStatus::StopIteration;\n   }\n-\n-  decoder_callbacks_->sendLocalReply(\n-      Http::Code::OK, \"Request Trailers match configured expectations\", nullptr, absl::nullopt, \"\");\n-  return Http::FilterTrailersStatus::StopIteration;\n+  if (!matchStatus.matches_) {", "originalCommit": "0b333e88f21d6753b5c81d2dbb1584e8fbd35701", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "21403e31f1b3205b1db63bbcda54eaf2b6f2ff52", "url": "https://github.com/envoyproxy/envoy-mobile/commit/21403e31f1b3205b1db63bbcda54eaf2b6f2ff52", "message": "add full unit coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T22:45:48Z", "type": "commit"}, {"oid": "440d2c5f91888d07ed1db3252cbb35068ab0f051", "url": "https://github.com/envoyproxy/envoy-mobile/commit/440d2c5f91888d07ed1db3252cbb35068ab0f051", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T23:08:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTA5OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486685098", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Check of there are unsatisfied assertions about stream trailers.\n          \n          \n            \n                // Check if there are unsatisfied assertions about stream trailers.", "author": "junr03", "createdAt": "2020-09-10T23:18:45Z", "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -28,25 +33,27 @@ AssertionFilter::AssertionFilter(AssertionFilterConfigSharedPtr config) : config\n Http::FilterHeadersStatus AssertionFilter::decodeHeaders(Http::RequestHeaderMap& headers,\n                                                          bool end_stream) {\n   config_->rootMatcher().onHttpRequestHeaders(headers, statuses_);\n-  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n-  if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n+  auto& match_status = config_->rootMatcher().matchStatus(statuses_);\n+  if (!match_status.matches_ && !match_status.might_change_status_) {\n     decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n                                        \"Request Headers do not match configured expectations\",\n                                        nullptr, absl::nullopt, \"\");\n     return Http::FilterHeadersStatus::StopIteration;\n   }\n \n   if (end_stream) {\n+    // Check if there are unsatisfied assertions about stream data.\n     Buffer::OwnedImpl empty_buffer;\n     config_->rootMatcher().onRequestBody(empty_buffer, statuses_);\n-    auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n-    if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n+    auto& match_status = config_->rootMatcher().matchStatus(statuses_);\n+    if (!match_status.matches_ && !match_status.might_change_status_) {\n       decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n                                          \"Request Body does not match configured expectations\",\n                                          nullptr, absl::nullopt, \"\");\n       return Http::FilterHeadersStatus::StopIteration;\n     }\n \n+    // Check of there are unsatisfied assertions about stream trailers.", "originalCommit": "440d2c5f91888d07ed1db3252cbb35068ab0f051", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTIyNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1071#discussion_r486685224", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Check of there are unsatisfied assertions about stream trailers.\n          \n          \n            \n                // Check if there are unsatisfied assertions about stream trailers.", "author": "junr03", "createdAt": "2020-09-10T23:19:10Z", "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -69,25 +80,29 @@ Http::FilterHeadersStatus AssertionFilter::decodeHeaders(Http::RequestHeaderMap&\n \n Http::FilterDataStatus AssertionFilter::decodeData(Buffer::Instance& data, bool end_stream) {\n   config_->rootMatcher().onRequestBody(data, statuses_);\n-  auto& matchStatus = config_->rootMatcher().matchStatus(statuses_);\n-  if (!matchStatus.matches_ && !matchStatus.might_change_status_) {\n+  auto& match_status = config_->rootMatcher().matchStatus(statuses_);\n+  if (!match_status.matches_ && !match_status.might_change_status_) {\n     decoder_callbacks_->sendLocalReply(Http::Code::BadRequest,\n                                        \"Request Body does not match configured expectations\",\n                                        nullptr, absl::nullopt, \"\");\n     return Http::FilterDataStatus::StopIterationNoBuffer;\n   }\n \n   if (end_stream) {\n+    // Check of there are unsatisfied assertions about stream trailers.", "originalCommit": "440d2c5f91888d07ed1db3252cbb35068ab0f051", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7871117a08c073cf3ed3cc942cfc14b670d639d7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7871117a08c073cf3ed3cc942cfc14b670d639d7", "message": "typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-09-10T23:28:57Z", "type": "commit"}]}