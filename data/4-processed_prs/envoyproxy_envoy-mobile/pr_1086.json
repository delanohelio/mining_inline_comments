{"pr_number": 1086, "pr_title": "jni: ensure we delete local refs", "pr_createdAt": "2020-09-12T01:18:37Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1086", "timeline": [{"oid": "89ebc7a25e1f146ddbdfe0e998adffdd2715c054", "url": "https://github.com/envoyproxy/envoy-mobile/commit/89ebc7a25e1f146ddbdfe0e998adffdd2715c054", "message": "jni: ensure we delete local refs\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-09-12T01:18:10Z", "type": "commit"}, {"oid": "277cc26d2a4f0851539aefa78a478f6b1afde1e5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/277cc26d2a4f0851539aefa78a478f6b1afde1e5", "message": "space\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-09-12T01:19:13Z", "type": "commit"}, {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a148ed9a3d072c9ceef895653a0e1e76bf98e341", "message": "fix\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-09-12T01:27:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzM4Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487353386", "bodyText": "Exactly one of on_error, on_complete, or on_cancel should be called for every stream. Those should be the only place we delete j_context like this.", "author": "goaway", "createdAt": "2020-09-12T01:59:24Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -133,6 +135,10 @@ static void* jvm_on_headers(const char* method, envoy_headers headers, bool end_\n                                          end_stream ? JNI_TRUE : JNI_FALSE);\n \n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  if (end_stream) {\n+    env->DeleteGlobalRef(j_context);\n+  }\n+", "originalCommit": "a148ed9a3d072c9ceef895653a0e1e76bf98e341", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYyNTU5OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487625598", "bodyText": "Opened #1089", "author": "goaway", "createdAt": "2020-09-14T02:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNzUwMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r488107502", "bodyText": "Oh right, I've forgotten we have an on_complete which is called after a stream successfully finishes", "author": "buildbreaker", "createdAt": "2020-09-14T17:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzUxNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487353517", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              if (end_stream) {\n          \n          \n            \n                env->DeleteGlobalRef(j_context);\n          \n          \n            \n              }", "author": "goaway", "createdAt": "2020-09-12T02:00:22Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -190,6 +210,10 @@ static void* jvm_on_data(const char* method, envoy_data data, bool end_stream, v\n   data.release(data.context);\n   env->DeleteLocalRef(j_data);\n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  if (end_stream) {\n+    env->DeleteGlobalRef(j_context);\n+  }\n+", "originalCommit": "a148ed9a3d072c9ceef895653a0e1e76bf98e341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzU4NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487353585", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              env->DeleteGlobalRef(j_context);", "author": "goaway", "createdAt": "2020-09-12T02:01:11Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -244,6 +282,8 @@ static void* jvm_on_trailers(const char* method, envoy_headers trailers, void* c\n   jobject result = env->CallObjectMethod(j_context, jmid_onTrailers, (jlong)trailers.length);\n \n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  env->DeleteGlobalRef(j_context);\n+", "originalCommit": "a148ed9a3d072c9ceef895653a0e1e76bf98e341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1NDE2MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487354160", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // released automatically. Manual book keeping is required for these methods.\n          \n          \n            \n            // released automatically. Manual bookkeeping is required for these methods.\n          \n      \n    \n    \n  \n\nTrivia: \"bookkeeping\" is the only English word with three pairs of double letters in a row.", "author": "goaway", "createdAt": "2020-09-12T02:06:53Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -116,6 +116,8 @@ static void pass_headers(JNIEnv* env, envoy_headers headers, jobject j_context)\n }\n \n // Platform callback implementation\n+// These methods call jvm methods which means the local references created will not be\n+// released automatically. Manual book keeping is required for these methods.", "originalCommit": "a148ed9a3d072c9ceef895653a0e1e76bf98e341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1NDI0Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487354246", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              if (end_stream) {\n          \n          \n            \n                env->DeleteGlobalRef(j_context);\n          \n          \n            \n              }", "author": "goaway", "createdAt": "2020-09-12T02:07:56Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -133,6 +135,10 @@ static void* jvm_on_headers(const char* method, envoy_headers headers, bool end_\n                                          end_stream ? JNI_TRUE : JNI_FALSE);\n \n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  if (end_stream) {\n+    env->DeleteGlobalRef(j_context);\n+  }\n+", "originalCommit": "a148ed9a3d072c9ceef895653a0e1e76bf98e341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "967e957309ab9d6d7809c155c9555ed42c3ff6b5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/967e957309ab9d6d7809c155c9555ed42c3ff6b5", "message": "fix\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-09-14T17:34:46Z", "type": "commit"}, {"oid": "166cc5b51c2bba82c20a1d0eba483e67d5c11202", "url": "https://github.com/envoyproxy/envoy-mobile/commit/166cc5b51c2bba82c20a1d0eba483e67d5c11202", "message": "spelling\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-09-14T17:35:50Z", "type": "commit"}]}