{"pr_number": 943, "pr_title": "filters: add iOS header support", "pr_createdAt": "2020-07-08T11:10:20Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/943", "timeline": [{"oid": "92a45c8f117b8657d68b5afad3eb505c6b5c924f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/92a45c8f117b8657d68b5afad3eb505c6b5c924f", "message": "register new required extension\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-13T23:11:48Z", "type": "forcePushed"}, {"oid": "c4c3f98e7382c12477c9ac41a6de2492eafcf828", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c4c3f98e7382c12477c9ac41a6de2492eafcf828", "message": "register new required extension\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-14T03:10:55Z", "type": "forcePushed"}, {"oid": "a420c4d830d8fee7bba752904241880a73fdc3bb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a420c4d830d8fee7bba752904241880a73fdc3bb", "message": "fix header path\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-15T05:17:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NzA2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456087068", "bodyText": "Are we able to generate a filter name here (for the user) instead of requiring the implementer to handle the name for the registration?", "author": "buildbreaker", "createdAt": "2020-07-16T21:25:48Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -29,13 +117,33 @@ - (void)dealloc {\n   [[NSNotificationCenter defaultCenter] removeObserver:self];\n }\n \n+- (int)registerFilter:(EnvoyHTTPFilter *)filter {\n+  // TODO(goaway): Everything here leaks, but it's all be tied to the life of the engine.\n+  // This will need to be updated for https://github.com/lyft/envoy-mobile/issues/332\n+  ios_http_filter_context *context = safe_malloc(sizeof(ios_http_filter_context));\n+  CFBridgingRetain(filter);\n+  context->filter = filter;\n+  envoy_http_filter *api = safe_malloc(sizeof(envoy_http_filter));\n+  api->on_request_headers = ios_http_filter_on_request_headers;\n+  api->on_request_data = NULL;\n+  api->on_response_headers = ios_http_filter_on_response_headers;\n+  api->on_response_data = NULL;\n+  api->context = context;\n+  register_platform_api(filter.name.UTF8String, api);", "originalCommit": "b8f24d53814c5a3f9ed2fcc35ab68ed898e32cb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA5MzU4MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456093581", "bodyText": "Yep, that's covered in the dynamic configuration task in the linked issue. @junr03 suggested, and I agreed that we split that into a separate PR.", "author": "goaway", "createdAt": "2020-07-16T21:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NzA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDI5Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456174292", "bodyText": "Can we move this to a different file?", "author": "rebello95", "createdAt": "2020-07-17T01:53:19Z", "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -6,6 +6,29 @@ private let kRequestAuthority = \"api.lyft.com\"\n private let kRequestPath = \"/ping\"\n private let kRequestScheme = \"https\"\n \n+struct PlatformDemoFilter: ResponseFilter {", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4NTYyMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456185622", "bodyText": "Sure, sounds good.", "author": "goaway", "createdAt": "2020-07-17T02:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDQwMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456174403", "bodyText": "Maybe add a TODO here since this'll be removed per https://github.com/lyft/envoy-mobile/pull/943/files#r456093581 I assume?", "author": "rebello95", "createdAt": "2020-07-17T01:53:47Z", "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -6,6 +6,29 @@ private let kRequestAuthority = \"api.lyft.com\"\n private let kRequestPath = \"/ping\"\n private let kRequestScheme = \"https\"\n \n+struct PlatformDemoFilter: ResponseFilter {\n+  let name = \"PlatformStub\"", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4Njc0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456186740", "bodyText": "Sure thing.", "author": "goaway", "createdAt": "2020-07-17T02:41:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDc5Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456174797", "bodyText": "Shouldn't this be registering the PlatformDemoFilter type (or a factory that produces a filter) rather than an instance of the filter? I assume that the lifetime of a filter instance will reflect that of 1 request (and that new filters will be instantiated for each request) like upstream Envoy", "author": "rebello95", "createdAt": "2020-07-17T01:55:13Z", "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -15,7 +38,7 @@ final class ViewController: UITableViewController {\n     super.viewDidLoad()\n     do {\n       NSLog(\"starting Envoy...\")\n-      self.client = try StreamClientBuilder().build()\n+      self.client = try StreamClientBuilder().addFilter(PlatformDemoFilter()).build()", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4NjI0NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456186244", "bodyText": "You're right, the current implementation uses a single long-lived filter instance, which is a departure from upstream Envoy. This approach is definitely simpler to map, but I agree that aligning with upstream Envoy would be nice. Let me think a little bit about what it would take to make filter instances per-stream.", "author": "goaway", "createdAt": "2020-07-17T02:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3MjE1Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456572152", "bodyText": "\ud83d\udc4d I think this is actually a hard requirement for filters in Envoy Mobile. I know a lot of the use cases Lyft has for platform filters today require filters to be per-stream and to act as both request and response filters", "author": "rebello95", "createdAt": "2020-07-17T17:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2ODg0Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456868847", "bodyText": "Per discussion Friday, we'll do this on top of this PR.", "author": "goaway", "createdAt": "2020-07-19T06:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NDc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTMzMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456175330", "bodyText": "Refactor in what way?", "author": "rebello95", "createdAt": "2020-07-17T01:56:44Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -10,6 +11,93 @@ static void ios_on_exit() {\n   NSLog(@\"[Envoy] library is exiting\");\n }\n \n+typedef struct {\n+  __unsafe_unretained EnvoyHTTPFilter *filter;\n+} ios_http_filter_context;\n+\n+// TODO(goaway): refactor and relocate translation", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5MTIzNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456191234", "bodyText": "There's some (egregious) duplication with some of our other mapping code here. It's a little bit tricky to reconcile, because the retain semantics are slightly different. It sure would be nice to though.", "author": "goaway", "createdAt": "2020-07-17T02:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3MjM3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456572375", "bodyText": "Sounds good, maybe make this TODO a bit more descriptive so it doesn't lose context over time", "author": "rebello95", "createdAt": "2020-07-17T17:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY5OTMyMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456699323", "bodyText": "Isn't it the same as https://github.com/lyft/envoy-mobile/blob/2d86a1c052ec97852ac8161c470649290310fde7/library/objective-c/EnvoyHTTPStreamImpl.m#L21?", "author": "junr03", "createdAt": "2020-07-17T22:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2Nzg5NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456867895", "bodyText": "The bridge semantics are a little different; see my comments below. Happy to talk about it more. My inclination is to leave this as a TODO (with extra description per @rebello95's suggestion), and work on a better solution separately. To provide a little bit more context, I'm considering if we need an actual refcount on our structs. It's kind of a bridge I'd like to avoid crossing if possible, but if we're going to avoid it, I do feel it's important to be strict about our release expectations - which we can't yet reconcile here.", "author": "goaway", "createdAt": "2020-07-19T06:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2OTQ2Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456869463", "bodyText": "Updated TODO. Note that some of these TODOs I'd like to address pretty much immediately after core functionality ships. However, as long as they don't affect the public interfaces that Android and iOS applications adhere to, I'm biasing towards getting that functionality shipped so that the apps can be updated independent of under-the-hood improvements. As always, open to discussing.", "author": "goaway", "createdAt": "2020-07-19T06:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTc0NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456175744", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              for (id headerKey in headers) {\n          \n          \n            \n              for (NSString *headerKey in headers) {", "author": "rebello95", "createdAt": "2020-07-17T01:58:14Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -10,6 +11,93 @@ static void ios_on_exit() {\n   NSLog(@\"[Envoy] library is exiting\");\n }\n \n+typedef struct {\n+  __unsafe_unretained EnvoyHTTPFilter *filter;\n+} ios_http_filter_context;\n+\n+// TODO(goaway): refactor and relocate translation\n+static envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  envoy_data ret = {length, native_string, free, native_string};\n+  return ret;\n+}\n+\n+static EnvoyHeaders *to_ios_headers(envoy_headers headers) {\n+  NSMutableDictionary *headerDict = [NSMutableDictionary new];\n+  for (envoy_header_size_t i = 0; i < headers.length; i++) {\n+    envoy_header header = headers.headers[i];\n+    NSString *headerKey = [[NSString alloc] initWithBytes:header.key.bytes\n+                                                   length:header.key.length\n+                                                 encoding:NSUTF8StringEncoding];\n+    NSString *headerValue = [[NSString alloc] initWithBytes:header.value.bytes\n+                                                     length:header.value.length\n+                                                   encoding:NSUTF8StringEncoding];\n+    NSMutableArray *headerValueList = headerDict[headerKey];\n+    if (headerValueList == nil) {\n+      headerValueList = [NSMutableArray new];\n+      headerDict[headerKey] = headerValueList;\n+    }\n+    [headerValueList addObject:headerValue];\n+  }\n+  // TODO(goaway): consider solution that doesn't violate release convention\n+  // Note: We don't call release_envoy_headers because they may not be modified by the filter\n+  return headerDict;\n+}\n+\n+static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n+  envoy_header_size_t length = 0;\n+  for (id headerKey in headers) {", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4NjYzNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456186636", "bodyText": "Yep, you're totally right.", "author": "goaway", "createdAt": "2020-07-17T02:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NTg2Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456175866", "bodyText": "Same here, can we use types instead of using id?", "author": "rebello95", "createdAt": "2020-07-17T01:58:39Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -10,6 +11,93 @@ static void ios_on_exit() {\n   NSLog(@\"[Envoy] library is exiting\");\n }\n \n+typedef struct {\n+  __unsafe_unretained EnvoyHTTPFilter *filter;\n+} ios_http_filter_context;\n+\n+// TODO(goaway): refactor and relocate translation\n+static envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  envoy_data ret = {length, native_string, free, native_string};\n+  return ret;\n+}\n+\n+static EnvoyHeaders *to_ios_headers(envoy_headers headers) {\n+  NSMutableDictionary *headerDict = [NSMutableDictionary new];\n+  for (envoy_header_size_t i = 0; i < headers.length; i++) {\n+    envoy_header header = headers.headers[i];\n+    NSString *headerKey = [[NSString alloc] initWithBytes:header.key.bytes\n+                                                   length:header.key.length\n+                                                 encoding:NSUTF8StringEncoding];\n+    NSString *headerValue = [[NSString alloc] initWithBytes:header.value.bytes\n+                                                     length:header.value.length\n+                                                   encoding:NSUTF8StringEncoding];\n+    NSMutableArray *headerValueList = headerDict[headerKey];\n+    if (headerValueList == nil) {\n+      headerValueList = [NSMutableArray new];\n+      headerDict[headerKey] = headerValueList;\n+    }\n+    [headerValueList addObject:headerValue];\n+  }\n+  // TODO(goaway): consider solution that doesn't violate release convention\n+  // Note: We don't call release_envoy_headers because they may not be modified by the filter\n+  return headerDict;\n+}\n+\n+static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n+  envoy_header_size_t length = 0;\n+  for (id headerKey in headers) {\n+    length += [headers[headerKey] count];\n+  }\n+  envoy_header *header_array = (envoy_header *)safe_malloc(sizeof(envoy_header) * length);\n+  envoy_header_size_t header_index = 0;\n+  for (id headerKey in headers) {\n+    NSArray *headerList = headers[headerKey];\n+    for (id headerValue in headerList) {", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NjEzMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456176131", "bodyText": "Why not actually assert?", "author": "rebello95", "createdAt": "2020-07-17T01:59:40Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -10,6 +11,93 @@ static void ios_on_exit() {\n   NSLog(@\"[Envoy] library is exiting\");\n }\n \n+typedef struct {\n+  __unsafe_unretained EnvoyHTTPFilter *filter;\n+} ios_http_filter_context;\n+\n+// TODO(goaway): refactor and relocate translation\n+static envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  envoy_data ret = {length, native_string, free, native_string};\n+  return ret;\n+}\n+\n+static EnvoyHeaders *to_ios_headers(envoy_headers headers) {\n+  NSMutableDictionary *headerDict = [NSMutableDictionary new];\n+  for (envoy_header_size_t i = 0; i < headers.length; i++) {\n+    envoy_header header = headers.headers[i];\n+    NSString *headerKey = [[NSString alloc] initWithBytes:header.key.bytes\n+                                                   length:header.key.length\n+                                                 encoding:NSUTF8StringEncoding];\n+    NSString *headerValue = [[NSString alloc] initWithBytes:header.value.bytes\n+                                                     length:header.value.length\n+                                                   encoding:NSUTF8StringEncoding];\n+    NSMutableArray *headerValueList = headerDict[headerKey];\n+    if (headerValueList == nil) {\n+      headerValueList = [NSMutableArray new];\n+      headerDict[headerKey] = headerValueList;\n+    }\n+    [headerValueList addObject:headerValue];\n+  }\n+  // TODO(goaway): consider solution that doesn't violate release convention\n+  // Note: We don't call release_envoy_headers because they may not be modified by the filter\n+  return headerDict;\n+}\n+\n+static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n+  envoy_header_size_t length = 0;\n+  for (id headerKey in headers) {\n+    length += [headers[headerKey] count];\n+  }\n+  envoy_header *header_array = (envoy_header *)safe_malloc(sizeof(envoy_header) * length);\n+  envoy_header_size_t header_index = 0;\n+  for (id headerKey in headers) {\n+    NSArray *headerList = headers[headerKey];\n+    for (id headerValue in headerList) {\n+      envoy_header new_header = {toManagedNativeString(headerKey),\n+                                 toManagedNativeString(headerValue)};\n+      header_array[header_index++] = new_header;\n+    }\n+  }\n+  // TODO: ASSERT(header_index == length);", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5MDc5Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456190792", "bodyText": "We haven't actually (at present) introduced a dependency on Envoy's assertion library at this layer.", "author": "goaway", "createdAt": "2020-07-17T02:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NjEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3MjY1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456572659", "bodyText": "Got it. If we want, we could use the native assert, but no strong opinion for now I guess", "author": "rebello95", "createdAt": "2020-07-17T17:19:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NjEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU4ODc0Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456588747", "bodyText": "For sure, we definitely can - we just haven't decided on a convention for this layer yet.", "author": "goaway", "createdAt": "2020-07-17T17:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NjEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2ODI4Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456868287", "bodyText": "Note a native assert won't get compiled out by Envoy's build directives, so it will always crash the app if we hit it. Not saying it's the right or wrong thing to do, but it's just something to consider.", "author": "goaway", "createdAt": "2020-07-19T06:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NjEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NjIyMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456176220", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              envoy_headers ret = {length, header_array};\n          \n          \n            \n              return ret;\n          \n          \n            \n              return envoy_headers{length, header_array};", "author": "rebello95", "createdAt": "2020-07-17T02:00:01Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -10,6 +11,93 @@ static void ios_on_exit() {\n   NSLog(@\"[Envoy] library is exiting\");\n }\n \n+typedef struct {\n+  __unsafe_unretained EnvoyHTTPFilter *filter;\n+} ios_http_filter_context;\n+\n+// TODO(goaway): refactor and relocate translation\n+static envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  envoy_data ret = {length, native_string, free, native_string};\n+  return ret;\n+}\n+\n+static EnvoyHeaders *to_ios_headers(envoy_headers headers) {\n+  NSMutableDictionary *headerDict = [NSMutableDictionary new];\n+  for (envoy_header_size_t i = 0; i < headers.length; i++) {\n+    envoy_header header = headers.headers[i];\n+    NSString *headerKey = [[NSString alloc] initWithBytes:header.key.bytes\n+                                                   length:header.key.length\n+                                                 encoding:NSUTF8StringEncoding];\n+    NSString *headerValue = [[NSString alloc] initWithBytes:header.value.bytes\n+                                                     length:header.value.length\n+                                                   encoding:NSUTF8StringEncoding];\n+    NSMutableArray *headerValueList = headerDict[headerKey];\n+    if (headerValueList == nil) {\n+      headerValueList = [NSMutableArray new];\n+      headerDict[headerKey] = headerValueList;\n+    }\n+    [headerValueList addObject:headerValue];\n+  }\n+  // TODO(goaway): consider solution that doesn't violate release convention\n+  // Note: We don't call release_envoy_headers because they may not be modified by the filter\n+  return headerDict;\n+}\n+\n+static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n+  envoy_header_size_t length = 0;\n+  for (id headerKey in headers) {\n+    length += [headers[headerKey] count];\n+  }\n+  envoy_header *header_array = (envoy_header *)safe_malloc(sizeof(envoy_header) * length);\n+  envoy_header_size_t header_index = 0;\n+  for (id headerKey in headers) {\n+    NSArray *headerList = headers[headerKey];\n+    for (id headerValue in headerList) {\n+      envoy_header new_header = {toManagedNativeString(headerKey),\n+                                 toManagedNativeString(headerValue)};\n+      header_array[header_index++] = new_header;\n+    }\n+  }\n+  // TODO: ASSERT(header_index == length);\n+  envoy_headers ret = {length, header_array};\n+  return ret;", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5MTU4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456191588", "bodyText": "Sure, can't remember why I didn't inline this.", "author": "goaway", "createdAt": "2020-07-17T03:00:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NjIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Njc4MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456176781", "bodyText": "Assuming my comment above about providing an instance of each filter for each request, I think this will become more problematic, no?", "author": "rebello95", "createdAt": "2020-07-17T02:01:56Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -29,13 +117,33 @@ - (void)dealloc {\n   [[NSNotificationCenter defaultCenter] removeObserver:self];\n }\n \n+- (int)registerFilter:(EnvoyHTTPFilter *)filter {\n+  // TODO(goaway): Everything here leaks, but it's all be tied to the life of the engine.\n+  // This will need to be updated for https://github.com/lyft/envoy-mobile/issues/332", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5MTc2OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456191769", "bodyText": "Yes. :)\nIt will need to be solved if/when we go that route.", "author": "goaway", "createdAt": "2020-07-17T03:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Njc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzI5Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456177292", "bodyText": "We should add tests for this new functionality", "author": "rebello95", "createdAt": "2020-07-17T02:04:02Z", "path": "library/swift/test/StreamClientBuilderTests.swift", "diffHunk": "@@ -172,6 +172,7 @@ final class StreamClientBuilderTests: XCTestCase {\n                                     dnsRefreshSeconds: 300,\n                                     dnsFailureRefreshSecondsBase: 400,\n                                     dnsFailureRefreshSecondsMax: 500,\n+                                    filterChain: [],", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5MjAyNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456192025", "bodyText": "Agreed. To some degree the example app acts as an end-to-end integration test (and I actually plan to update it with n explicit check on the filter's effect). But I can look into what level of testing we can do at the unit layer here as well.", "author": "goaway", "createdAt": "2020-07-17T03:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzM1NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456177354", "bodyText": "I'd either remove this or provide an actual description", "author": "rebello95", "createdAt": "2020-07-17T02:04:15Z", "path": "library/swift/src/filters/ResponseFilter.swift", "diffHunk": "@@ -1,7 +1,28 @@\n+@_implementationOnly import EnvoyEngine\n import Foundation\n \n+extension EnvoyHTTPFilter {\n+  /// Initializer", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5MjIzMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456192232", "bodyText": "Sure, I'll elaborate.", "author": "goaway", "createdAt": "2020-07-17T03:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzU5NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456177595", "bodyText": "Can we name these instead of using 0/1?", "author": "rebello95", "createdAt": "2020-07-17T02:05:11Z", "path": "library/swift/src/filters/ResponseFilter.swift", "diffHunk": "@@ -1,7 +1,28 @@\n+@_implementationOnly import EnvoyEngine\n import Foundation\n \n+extension EnvoyHTTPFilter {\n+  /// Initializer\n+  convenience init(responseFilter: ResponseFilter) {\n+    self.init()\n+    self.name = responseFilter.name\n+    self.onResponseHeaders = {\n+      let result = responseFilter.onResponseHeaders(ResponseHeaders(headers: $0), endStream: $1)\n+      switch result {\n+      case .continue(let headers):\n+        return [0, headers.headers]\n+      case .stopIteration(let headers):\n+        return [1, headers.headers]", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4NzI2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456187268", "bodyText": "Yeah, we should. We don't have a great solution for enums across the bridge layer yet, and I had this in place while I thought about it more. But we should at least make them some kind of named constant.", "author": "goaway", "createdAt": "2020-07-17T02:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5MDMxMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456890313", "bodyText": "Okay, I came up with a solution, which is \"don't use enums.\" Using enums, we'd have to declare and map this set of options 4 times over: first, in Envoy, next at the bridge layer (because Envoy's type is c++ and can't be directly exposed), next in objective-c (because the EnvoyEngine header can't have includes due to the clang issue), next in Swift (because the objective-c type doesn't support associated values). We'd also have to create mapping functions between all 4 variants.\nextern  consts can be declared in terms of Envoy's implicit internal values and eliminate all but one mapping.", "author": "goaway", "createdAt": "2020-07-19T10:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg5MDMzNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456890337", "bodyText": "(pushed)", "author": "goaway", "createdAt": "2020-07-19T10:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzY2OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456177668", "bodyText": "nit: let's name these parameters in the opening of the closure", "author": "rebello95", "createdAt": "2020-07-17T02:05:27Z", "path": "library/swift/src/filters/ResponseFilter.swift", "diffHunk": "@@ -1,7 +1,28 @@\n+@_implementationOnly import EnvoyEngine\n import Foundation\n \n+extension EnvoyHTTPFilter {\n+  /// Initializer\n+  convenience init(responseFilter: ResponseFilter) {\n+    self.init()\n+    self.name = responseFilter.name\n+    self.onResponseHeaders = {\n+      let result = responseFilter.onResponseHeaders(ResponseHeaders(headers: $0), endStream: $1)", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4NzM4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456187388", "bodyText": "sgtm", "author": "goaway", "createdAt": "2020-07-17T02:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3NzY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Nzc3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456177775", "bodyText": "Same comments here as below", "author": "rebello95", "createdAt": "2020-07-17T02:05:54Z", "path": "library/swift/src/filters/RequestFilter.swift", "diffHunk": "@@ -1,7 +1,28 @@\n+@_implementationOnly import EnvoyEngine\n import Foundation\n \n+extension EnvoyHTTPFilter {\n+  /// Initializer\n+  convenience init(requestFilter: RequestFilter) {\n+    self.init()\n+    self.name = requestFilter.name\n+    self.onRequestHeaders = {\n+      let result = requestFilter.onRequestHeaders(RequestHeaders(headers: $0), endStream: $1)\n+      switch result {\n+      case .continue(let headers):\n+        return [0, headers.headers]\n+      case .stopIteration(let headers):\n+        return [1, headers.headers]\n+      }\n+    }\n+  }\n+}", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Nzg4NA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456177884", "bodyText": "How will this work for filters that want to act as both request and response filters? As-is, it doesn't look like that's possible since the callbacks are only set on EnvoyHTTPFilter.init", "author": "rebello95", "createdAt": "2020-07-17T02:06:22Z", "path": "library/swift/src/filters/RequestFilter.swift", "diffHunk": "@@ -1,7 +1,28 @@\n+@_implementationOnly import EnvoyEngine\n import Foundation\n \n+extension EnvoyHTTPFilter {\n+  /// Initializer\n+  convenience init(requestFilter: RequestFilter) {", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE4OTM4Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456189386", "bodyText": "Already by the objective-c mapping layer (and everything below) it's actually unified into a bi-directional solution. It's only bifurcated here because it wasn't clear to me here how we'd work with the two disparate interfaces, and I decided to punt on the problem since it wasn't clear to me that the intent was that we'd have filters that implemented both.\nI think I can make things work to allow bi-directional filters with a little tweaking. Since we don't have any usage that necessitates it yet, my slight inclination is to punt on it so we can get something functional onto main and work from there, but I'm open to your thoughts.", "author": "goaway", "createdAt": "2020-07-17T02:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Nzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3NTAzOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456575038", "bodyText": "I don't necessarily want to block the PR on this, but I do think it's required functionality for using these filters in production, and am a little concerned that if we don't fix it early on it'll be more difficult to do as we go further down this route. Thoughts?", "author": "rebello95", "createdAt": "2020-07-17T17:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Nzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2MTYwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456861609", "bodyText": "Just to capture discussion from Friday here, I will be adding support for bi-directionality prior to merging.", "author": "goaway", "createdAt": "2020-07-19T05:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Nzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2Njc4OA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456866788", "bodyText": "Pushed a solution, let me know if you have further thoughts.", "author": "goaway", "createdAt": "2020-07-19T06:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3Nzg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3ODQ3Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456178473", "bodyText": "It looks like this prevents filters from being able to act as both RequestFilter and ResponseFilter conformers. The idea behind the empty Filter protocol in place is to allow registration of a filter, then call its request/response functionality depending on what it conforms to. Should we be doing something like that here?\nPer comments above, I think these should accept closures that create the filters on each request/stream, rather than instances of the filters.", "author": "rebello95", "createdAt": "2020-07-17T02:08:56Z", "path": "library/swift/src/StreamClientBuilder.swift", "diffHunk": "@@ -107,6 +108,28 @@ public final class StreamClientBuilder: NSObject {\n     return self\n   }\n \n+  /// Add HTTP filter for requests sent by this client.\n+  ///\n+  /// - parameter filter: RequestFilter to be invoked for streams.\n+  ///\n+  /// - returns: This builder.\n+  @discardableResult\n+  public func addFilter(_ filter: RequestFilter) -> StreamClientBuilder {\n+    self.filterChain.append(EnvoyHTTPFilter(requestFilter: filter))\n+    return self\n+  }\n+\n+  /// Add HTTP filter for resonses received by this client.\n+  ///\n+  /// - parameter filter: RequestFilter to be invoked for streams.\n+  ///\n+  /// - returns: This builder.\n+  @discardableResult\n+  public func addFilter(_ filter: ResponseFilter) -> StreamClientBuilder {\n+    self.filterChain.append(EnvoyHTTPFilter(responseFilter: filter))\n+    return self\n+  }", "originalCommit": "7a296fdf97f9a24f63fce6dd9821510970bc4f14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE5MDIwNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456190207", "bodyText": "Agreed, see my response above. With a little bit of reflection I think we can achieve that, so I'm open to working that out here, or in a subsequent PR, though my slight preference is for the latter.\nI agree, though I have to think a little bit more about the ramifications to the API and mapping layer. I'm forming an idea of how to do it though - it should be possible.", "author": "goaway", "createdAt": "2020-07-17T02:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3ODQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcwNDkxOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456704919", "bodyText": "re: 2. we should definitely do this per stream instance. And re: 1. do we really need reflection? Can't we have multiple inheritance and have a filter class that is both, and thus calls both request and response addFilter functions as in envoy:\nhttps://github.com/envoyproxy/envoy/blob/bc02b7748a69fd3854f74b9e5bec236b5499f7fd/include/envoy/http/filter.h#L772\nhttps://github.com/envoyproxy/envoy/blob/0c6523c0925d260de41d89002044d0d6271550d0/source/common/http/conn_manager_impl.h#L553", "author": "junr03", "createdAt": "2020-07-17T22:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3ODQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2MTUxMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456861513", "bodyText": "I believe reflection is the way to go, yes. It's true a class can implement multiple interfaces, but even if we declare an interface that conforms to both RequestFilter and ResponseFilter, Swift will not implicitly or automatically cause classes that implement both interfaces to conform to it. So when we go to instantiate bridge type from a generic Filter, we will need to check which interfaces it implements. If we create type-specialized constructors (like I had here), it will be ambiguous to the compiler which it should call.\nThat's the best explanation I can provide here. Happy to discuss more offline.", "author": "goaway", "createdAt": "2020-07-19T05:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3ODQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg2NjY5Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456866696", "bodyText": "For bi-directionality, see the solution I've pushed, and let me know if you have additional thoughts. :)", "author": "goaway", "createdAt": "2020-07-19T06:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE3ODQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY5OTY2NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456699665", "bodyText": "I feel like the user can determine if they are going to modify or not, and this function should release on copy? Or conversely, change the existing API and have the caller bear the responsibility of releasing? In any case, I think we can unify these helpers with the ones in EnvoyHTTPStreamImpl", "author": "junr03", "createdAt": "2020-07-17T22:27:54Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -10,6 +11,91 @@ static void ios_on_exit() {\n   NSLog(@\"[Envoy] library is exiting\");\n }\n \n+typedef struct {\n+  __unsafe_unretained EnvoyHTTPFilter *filter;\n+} ios_http_filter_context;\n+\n+// TODO(goaway): refactor and relocate translation\n+static envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  return (envoy_data){length, native_string, free, native_string};\n+}\n+\n+static EnvoyHeaders *to_ios_headers(envoy_headers headers) {\n+  NSMutableDictionary *headerDict = [NSMutableDictionary new];\n+  for (envoy_header_size_t i = 0; i < headers.length; i++) {\n+    envoy_header header = headers.headers[i];\n+    NSString *headerKey = [[NSString alloc] initWithBytes:header.key.bytes\n+                                                   length:header.key.length\n+                                                 encoding:NSUTF8StringEncoding];\n+    NSString *headerValue = [[NSString alloc] initWithBytes:header.value.bytes\n+                                                     length:header.value.length\n+                                                   encoding:NSUTF8StringEncoding];\n+    NSMutableArray *headerValueList = headerDict[headerKey];\n+    if (headerValueList == nil) {\n+      headerValueList = [NSMutableArray new];\n+      headerDict[headerKey] = headerValueList;\n+    }\n+    [headerValueList addObject:headerValue];\n+  }\n+  // TODO(goaway): consider solution that doesn't violate release convention", "originalCommit": "5b08d0548fb52ead8556ac632ab60b389a86774f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1NDY4Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456854686", "bodyText": "The convention I feel we should maintain is that the callee always releases or passes that responsibility. I don't think it's really possible to invert that, because there's no way for the caller (or returner) to otherwise determine what the callee does with it. This is true for calls going in either direction across the bridge layer.\nWhile I do think we can reconcile the differences here, I added it as a TODO because it felt a little bit extraneous to getting the core functionality in place.", "author": "goaway", "createdAt": "2020-07-19T03:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY5OTY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcwMDg1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456700859", "bodyText": "Is there no tuple type?", "author": "junr03", "createdAt": "2020-07-17T22:32:16Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -10,6 +11,91 @@ static void ios_on_exit() {\n   NSLog(@\"[Envoy] library is exiting\");\n }\n \n+typedef struct {\n+  __unsafe_unretained EnvoyHTTPFilter *filter;\n+} ios_http_filter_context;\n+\n+// TODO(goaway): refactor and relocate translation\n+static envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  return (envoy_data){length, native_string, free, native_string};\n+}\n+\n+static EnvoyHeaders *to_ios_headers(envoy_headers headers) {\n+  NSMutableDictionary *headerDict = [NSMutableDictionary new];\n+  for (envoy_header_size_t i = 0; i < headers.length; i++) {\n+    envoy_header header = headers.headers[i];\n+    NSString *headerKey = [[NSString alloc] initWithBytes:header.key.bytes\n+                                                   length:header.key.length\n+                                                 encoding:NSUTF8StringEncoding];\n+    NSString *headerValue = [[NSString alloc] initWithBytes:header.value.bytes\n+                                                     length:header.value.length\n+                                                   encoding:NSUTF8StringEncoding];\n+    NSMutableArray *headerValueList = headerDict[headerKey];\n+    if (headerValueList == nil) {\n+      headerValueList = [NSMutableArray new];\n+      headerDict[headerKey] = headerValueList;\n+    }\n+    [headerValueList addObject:headerValue];\n+  }\n+  // TODO(goaway): consider solution that doesn't violate release convention\n+  // Note: We don't call release_envoy_headers because they may not be modified by the filter\n+  return headerDict;\n+}\n+\n+static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n+  envoy_header_size_t length = 0;\n+  for (NSString *headerKey in headers) {\n+    length += [headers[headerKey] count];\n+  }\n+  envoy_header *header_array = (envoy_header *)safe_malloc(sizeof(envoy_header) * length);\n+  envoy_header_size_t header_index = 0;\n+  for (NSString *headerKey in headers) {\n+    NSArray *headerList = headers[headerKey];\n+    for (NSString *headerValue in headerList) {\n+      envoy_header new_header = {toManagedNativeString(headerKey),\n+                                 toManagedNativeString(headerValue)};\n+      header_array[header_index++] = new_header;\n+    }\n+  }\n+  // TODO: ASSERT(header_index == length);\n+  return (envoy_headers){length, header_array};\n+}\n+\n+static envoy_filter_headers_status\n+ios_http_filter_on_request_headers(envoy_headers headers, bool end_stream, void *context) {\n+  // TODO(goaway): optimize unmodified case\n+  ios_http_filter_context *c = (ios_http_filter_context *)context;\n+  if (c->filter.onRequestHeaders == nil) {\n+    return (envoy_filter_headers_status){/*status*/ 0, /*headers*/ headers};\n+  }\n+\n+  EnvoyHeaders *platformHeaders = to_ios_headers(headers);\n+  release_envoy_headers(headers);\n+  // TODO(goaway): consider better solution for compound return\n+  NSArray *result = c->filter.onRequestHeaders(platformHeaders, end_stream);", "originalCommit": "5b08d0548fb52ead8556ac632ab60b389a86774f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1NDkzNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456854934", "bodyText": "There is at the core layer, and at the platform layer. I skipped making yet another implementation in between. - While we could re-use the bridge/core type on iOS technically, it will then deviate from what we'll need on Android. It also comes back down to that we don't really have a great way to share enums in a consistent way either - something I would like to come up with a better solution for as well.", "author": "goaway", "createdAt": "2020-07-19T03:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcwMDg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcwMzQ2Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456703462", "bodyText": "following on @rebello95's comment about lifetime. We definitely want a per stream instance of the full chain, like Envoy.\nI wonder if what we can do is: have the api retain a filter factory in its context, and register that. Then the registry can instantiate a filter chain, that the stream retains, and passes that in the context to the static ios_http_filter_on_*_* functions. So we would have two different contexts, and the one here (which retains the factory) leaks, but will eventually be tied/retained to/by the engine instance.", "author": "junr03", "createdAt": "2020-07-17T22:42:33Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -29,13 +115,33 @@ - (void)dealloc {\n   [[NSNotificationCenter defaultCenter] removeObserver:self];\n }\n \n+- (int)registerFilter:(EnvoyHTTPFilter *)filter {\n+  // TODO(goaway): Everything here leaks, but it's all be tied to the life of the engine.\n+  // This will need to be updated for https://github.com/lyft/envoy-mobile/issues/332\n+  ios_http_filter_context *context = safe_malloc(sizeof(ios_http_filter_context));", "originalCommit": "5b08d0548fb52ead8556ac632ab60b389a86774f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1NTI0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456855245", "bodyText": "That's one of the options that I've been considering, but there's some added complexity with the memory management of the instance. We'll need a dealloc hook as well, and we need to guard against the platform implementation living longer than the underlying core instantiation (and more specifically, trying to interact with it after it's gone).\nI've actually been leaning towards a more integrated approach - with the API presenting both an init() and a release() function, the former of which will populate the rest of the function pointers on the struct, and the latter of which will nullify them (and trigger memory-safe cleanup).", "author": "goaway", "createdAt": "2020-07-19T03:53:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcwMzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg1NTM0Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r456855347", "bodyText": "Per our discussion Friday, my current plan is to finish addressing other issues here, land this and build per-stream instantiation on top.", "author": "goaway", "createdAt": "2020-07-19T03:54:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcwMzQ2Mg=="}], "type": "inlineReview"}, {"oid": "10a8f35aa080f03efec7f5fe863878ea41efada5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/10a8f35aa080f03efec7f5fe863878ea41efada5", "message": "wip: rebased ios poc work\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "e8016316bae4c24a4a7cbb27df34f48a62e0fa55", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e8016316bae4c24a4a7cbb27df34f48a62e0fa55", "message": "fix header path\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "57ca90364d080c4997ee5b29d1125b9c8e7c63f7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/57ca90364d080c4997ee5b29d1125b9c8e7c63f7", "message": "update filter arrays with element type\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "9efe34ca487cc9e996ce29d81dd56d749a7ae87c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9efe34ca487cc9e996ce29d81dd56d749a7ae87c", "message": "revert mutability change to swift Header\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "ca31bdf639b219ce4d5d2c5ff3914d5feb250b28", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ca31bdf639b219ce4d5d2c5ff3914d5feb250b28", "message": "cleaned up response path\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "67e59eb280cc9cd5de5a965dc37e951d209eab3d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/67e59eb280cc9cd5de5a965dc37e951d209eab3d", "message": "here we go\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "312093e35d5a6a6cb037dd3db84a927ca03ff867", "url": "https://github.com/envoyproxy/envoy-mobile/commit/312093e35d5a6a6cb037dd3db84a927ca03ff867", "message": "cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "ddbdd678be56f8b865250b400415ebccbcfd4f7a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ddbdd678be56f8b865250b400415ebccbcfd4f7a", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "0b837e51c704c4599f74e9c66053e91c4088d063", "url": "https://github.com/envoyproxy/envoy-mobile/commit/0b837e51c704c4599f74e9c66053e91c4088d063", "message": "more swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "c475fbd59ec34dcafb11c28f4f38ced99c97c1b1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c475fbd59ec34dcafb11c28f4f38ced99c97c1b1", "message": "add array element type\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "6106985f25f61ef0f9c071ee8c2f6bef79f125f5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6106985f25f61ef0f9c071ee8c2f6bef79f125f5", "message": "fix swift tests\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "11ec0567ecf247eab6c6ec781c573ead93db0b24", "url": "https://github.com/envoyproxy/envoy-mobile/commit/11ec0567ecf247eab6c6ec781c573ead93db0b24", "message": "fix typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "39d39d8b50692542fd86ecc7549c5bc37c472b3d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/39d39d8b50692542fd86ecc7549c5bc37c472b3d", "message": "move demo filter\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "e14aa26f28aaa0460da23cbc686167d078071777", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e14aa26f28aaa0460da23cbc686167d078071777", "message": "capture filter-demo header in Swift example app\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "49a8d7621691e28e996cbffb2f9710608f7cb64e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/49a8d7621691e28e996cbffb2f9710608f7cb64e", "message": "add TODO\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "978fd35c8af0ad44dd5f68b7d0b70958a876143a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/978fd35c8af0ad44dd5f68b7d0b70958a876143a", "message": "update types in loop\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "6ab88ca5359a2760aebc9ac83631d3bce84bb7f3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6ab88ca5359a2760aebc9ac83631d3bce84bb7f3", "message": "inline some return values\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "9336510c162da5577c2582f0ecf1b3e12ce7a798", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9336510c162da5577c2582f0ecf1b3e12ce7a798", "message": "add bidirectional support\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "commit"}, {"oid": "9336510c162da5577c2582f0ecf1b3e12ce7a798", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9336510c162da5577c2582f0ecf1b3e12ce7a798", "message": "add bidirectional support\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:15:58Z", "type": "forcePushed"}, {"oid": "af97368474d3a9ad9d1c77d1890c3d159af8ee22", "url": "https://github.com/envoyproxy/envoy-mobile/commit/af97368474d3a9ad9d1c77d1890c3d159af8ee22", "message": "update TODO with additional context\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T06:49:08Z", "type": "commit"}, {"oid": "df9f2945ea5e04121257781e18ce7b387c389f0d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/df9f2945ea5e04121257781e18ce7b387c389f0d", "message": "fix missing import\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T10:14:02Z", "type": "commit"}, {"oid": "c768c577a2febc05b11e0f63bb1c5ab302a09ad2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c768c577a2febc05b11e0f63bb1c5ab302a09ad2", "message": "solution to link filter status declarations across layers\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T10:18:57Z", "type": "commit"}, {"oid": "a561feda7139e6328982964ae181653c64949438", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a561feda7139e6328982964ae181653c64949438", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T10:19:38Z", "type": "commit"}, {"oid": "ca446c444f35399fa843c3273c6838c2e1378c6a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ca446c444f35399fa843c3273c6838c2e1378c6a", "message": "name parameters\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T10:45:48Z", "type": "commit"}, {"oid": "ff07bc36986a53ef7df07f46fccc5594a62bf344", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ff07bc36986a53ef7df07f46fccc5594a62bf344", "message": "fix typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-19T10:58:22Z", "type": "commit"}, {"oid": "d3269118018bd4e493e1606782e747cb89ee9cdc", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d3269118018bd4e493e1606782e747cb89ee9cdc", "message": "improve docstring\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-20T20:37:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwMDc5OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r457700799", "bodyText": "Shouldn't this be an NSMutableArray as the values?", "author": "rebello95", "createdAt": "2020-07-20T21:25:23Z", "path": "library/objective-c/EnvoyEngine.h", "diffHunk": "@@ -7,6 +7,9 @@ NS_ASSUME_NONNULL_BEGIN\n /// A set of headers that may be passed to/from an Envoy stream.\n typedef NSDictionary<NSString *, NSArray<NSString *> *> EnvoyHeaders;\n \n+/// A mutable set of headers that may be passed to/from an Envoy stream.\n+typedef NSMutableDictionary<NSString *, NSArray<NSString *> *> EnvoyMutableHeaders;", "originalCommit": "d3269118018bd4e493e1606782e747cb89ee9cdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5Mzc2Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r457793763", "bodyText": "Sure, sounds good. I was trying to avoid unnecessary reallocations when converting from the immutable type, but honestly I wouldn't be surprised if Apple had a copy-on-write optimization under the hood anyways.", "author": "goaway", "createdAt": "2020-07-21T02:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwMDc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwNTM4MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r457705380", "bodyText": "ENVOY_SUCCESS?", "author": "rebello95", "createdAt": "2020-07-20T21:35:42Z", "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -29,13 +119,33 @@ - (void)dealloc {\n   [[NSNotificationCenter defaultCenter] removeObserver:self];\n }\n \n+- (int)registerFilter:(EnvoyHTTPFilter *)filter {\n+  // TODO(goaway): Everything here leaks, but it's all be tied to the life of the engine.\n+  // This will need to be updated for https://github.com/lyft/envoy-mobile/issues/332\n+  ios_http_filter_context *context = safe_malloc(sizeof(ios_http_filter_context));\n+  CFBridgingRetain(filter);\n+  context->filter = filter;\n+  envoy_http_filter *api = safe_malloc(sizeof(envoy_http_filter));\n+  api->on_request_headers = ios_http_filter_on_request_headers;\n+  api->on_request_data = NULL;\n+  api->on_response_headers = ios_http_filter_on_response_headers;\n+  api->on_response_data = NULL;\n+  api->context = context;\n+  register_platform_api(filter.name.UTF8String, api);\n+  return 0;", "originalCommit": "d3269118018bd4e493e1606782e747cb89ee9cdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MzU0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r457793543", "bodyText": "We don't have the type available on the header here, so we've only used 0 and 1 in this file so far. The extern-based solution I propose in this PR for filter status would work for this as well though, so maybe I can fix this for all the outstanding cases in a subsequent PR?", "author": "goaway", "createdAt": "2020-07-21T02:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwNTM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNjMzOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r457826338", "bodyText": "SGTM", "author": "rebello95", "createdAt": "2020-07-21T04:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwNTM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwNTY3MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r457705670", "bodyText": "Maybe add a todo here since we'll be switching from instance-based filters in a future PR?", "author": "rebello95", "createdAt": "2020-07-20T21:36:20Z", "path": "library/swift/src/StreamClientBuilder.swift", "diffHunk": "@@ -107,6 +108,17 @@ public final class StreamClientBuilder: NSObject {\n     return self\n   }\n \n+  /// Add HTTP filter for requests sent by this client.\n+  ///\n+  /// - parameter filter: RequestFilter to be invoked for streams.\n+  ///\n+  /// - returns: This builder.\n+  @discardableResult\n+  public func addFilter(_ filter: Filter) -> StreamClientBuilder {", "originalCommit": "d3269118018bd4e493e1606782e747cb89ee9cdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc5MzgwNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/943#discussion_r457793806", "bodyText": "Sure thing.", "author": "goaway", "createdAt": "2020-07-21T02:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwNTY3MA=="}], "type": "inlineReview"}, {"oid": "9122546ecd3edc10ccef2ce3a769dff3712f8cd3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9122546ecd3edc10ccef2ce3a769dff3712f8cd3", "message": "final pass\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-07-21T08:16:35Z", "type": "commit"}]}