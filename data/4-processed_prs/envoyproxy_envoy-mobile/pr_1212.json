{"pr_number": 1212, "pr_title": "ios: split comma-delimited header values when creating platform representation", "pr_createdAt": "2020-12-18T12:08:30Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1212", "timeline": [{"oid": "d4f0eb36dfa915ab591c1a0ad823e03af09272b0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d4f0eb36dfa915ab591c1a0ad823e03af09272b0", "message": "ios: split comma-delimited header values when creating platform representation\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-18T12:18:42Z", "type": "commit"}, {"oid": "d4f0eb36dfa915ab591c1a0ad823e03af09272b0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d4f0eb36dfa915ab591c1a0ad823e03af09272b0", "message": "ios: split comma-delimited header values when creating platform representation\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-18T12:18:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NDM5Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1212#discussion_r545854393", "bodyText": "Is this necessary? I assume that envoy doesn't add white spaces, in which case we may more closely preserve the \"original\" content by not trimming", "author": "rebello95", "createdAt": "2020-12-18T14:11:12Z", "path": "library/objective-c/EnvoyBridgeUtility.h", "diffHunk": "@@ -83,12 +83,27 @@ static inline EnvoyHeaders *to_ios_headers(envoy_headers headers) {\n     NSString *headerValue = [[NSString alloc] initWithBytes:header.value.bytes\n                                                      length:header.value.length\n                                                    encoding:NSUTF8StringEncoding];\n+    // Ensure list is present in dictionary value\n     NSMutableArray *headerValueList = headerDict[headerKey];\n     if (headerValueList == nil) {\n       headerValueList = [NSMutableArray new];\n       headerDict[headerKey] = headerValueList;\n     }\n-    [headerValueList addObject:headerValue];\n+\n+    // By convention, these headers disregard the RFC and contain commas single values.\n+    if (headerKey == @\"set-cookie\" ||\n+        headerKey == @\"www-authenticate\" ||\n+        headerKey == @\"proxy-authenticate\") {\n+      [headerValueList addObject:headerValue];\n+    } else {\n+      // Add trimmed, comma-separated values as individual members of the list.\n+      NSArray *newValueList = [headerValue componentsSeparatedByString:@\",\"];\n+      for (NSString *value in newValueList) {\n+        NSString *trimmedValue =\n+          [value stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceCharacterSet]];", "originalCommit": "d4f0eb36dfa915ab591c1a0ad823e03af09272b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk5ODA4MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1212#discussion_r545998080", "bodyText": "It's desirable because comma delimiting may take the form of \",\" or \", \", and both are common. Users will likely find themselves inadvertently failing to match simple string comparisons if leading or trailing spaces are left on that are an artifact of how the header was coalesced and encoded.\nMoreover, the RFCs state that all header values are encoded with optional leading and trailing whitespace, implying one should not treat it as part of the value.", "author": "goaway", "createdAt": "2020-12-18T18:01:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NDM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAwMTA0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1212#discussion_r546001043", "bodyText": "Sounds good. This implementation seems to have warnings when building:\nINFO: From Compiling library/objective-c/EnvoyEngineImpl.m:\nIn file included from library/objective-c/EnvoyEngineImpl.m:2:\n./library/objective-c/EnvoyBridgeUtility.h:94:19: warning: direct comparison of a string literal has undefined behavior [-Wobjc-string-compare]\n    if (headerKey == @\"set-cookie\" || headerKey == @\"www-authenticate\" ||\n                  ^  ~~~~~~~~~~~~~\n./library/objective-c/EnvoyBridgeUtility.h:94:19: note: use 'isEqual:' instead\n    if (headerKey == @\"set-cookie\" || headerKey == @\"www-authenticate\" ||\n                  ^~\n        [          isEqual:       ]\n./library/objective-c/EnvoyBridgeUtility.h:94:49: warning: direct comparison of a string literal has undefined behavior [-Wobjc-string-compare]\n    if (headerKey == @\"set-cookie\" || headerKey == @\"www-authenticate\" ||\n                                                ^  ~~~~~~~~~~~~~~~~~~~\n./library/objective-c/EnvoyBridgeUtility.h:94:49: note: use 'isEqual:' instead\n    if (headerKey == @\"set-cookie\" || headerKey == @\"www-authenticate\" ||\n                                                ^~\n                                      [          isEqual:             ]\n./library/objective-c/EnvoyBridgeUtility.h:95:19: warning: direct comparison of a string literal has undefined behavior [-Wobjc-string-compare]\n        headerKey == @\"proxy-authenticate\") {\n                  ^  ~~~~~~~~~~~~~~~~~~~~~\n./library/objective-c/EnvoyBridgeUtility.h:95:19: note: use 'isEqual:' instead\n        headerKey == @\"proxy-authenticate\") {\n                  ^~\n        [          isEqual:               ]", "author": "rebello95", "createdAt": "2020-12-18T18:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NDM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0NTg2MQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1212#discussion_r546045861", "bodyText": "Switched to caseInsensitiveCompare", "author": "goaway", "createdAt": "2020-12-18T19:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NDM5Mw=="}], "type": "inlineReview"}, {"oid": "3bd31498df220f0bd5c1e8452a2017272afcd99b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3bd31498df220f0bd5c1e8452a2017272afcd99b", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-18T18:03:22Z", "type": "commit"}, {"oid": "2a293cb038ac0fbc967c7d23ab96a1373413b4af", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2a293cb038ac0fbc967c7d23ab96a1373413b4af", "message": "fix string comparison\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-18T19:14:49Z", "type": "commit"}]}