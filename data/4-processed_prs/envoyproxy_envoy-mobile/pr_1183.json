{"pr_number": 1183, "pr_title": "stats: adds metrics sink with ack", "pr_createdAt": "2020-11-14T02:50:30Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1183", "timeline": [{"oid": "e403a78e62383eec358e5095a5a783b307836512", "url": "https://github.com/envoyproxy/envoy-mobile/commit/e403a78e62383eec358e5095a5a783b307836512", "message": "stats: adds metrics sink with ack\n\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2020-12-10T21:48:00Z", "type": "forcePushed"}, {"oid": "8b4e7dfcd19f68452acab7903d120a44c96a64ee", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8b4e7dfcd19f68452acab7903d120a44c96a64ee", "message": "rebase & update\n\nSigned-off-by: Jingwei Hao <jingwei.hao@gmail.com>", "committedDate": "2021-01-14T20:13:51Z", "type": "forcePushed"}, {"oid": "166577c9661ecf7adaec5146f41e5bf7a28dff2d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/166577c9661ecf7adaec5146f41e5bf7a28dff2d", "message": "sign\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2021-01-19T23:57:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjkxNTQxMw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r562915413", "bodyText": "nit: I would make this field 2.\nAlso lets document what this field is for.", "author": "junr03", "createdAt": "2021-01-22T21:16:35Z", "path": "library/common/extensions/stat_sinks/metrics_service/service.proto", "diffHunk": "@@ -0,0 +1,34 @@\n+syntax = \"proto3\";\n+\n+package envoymobile.extensions.stat_sinks.metrics_service;\n+\n+import \"envoy/config/core/v3/base.proto\";\n+import \"metrics.proto\";\n+import \"validate/validate.proto\";\n+\n+service EnvoyMobileMetricsService {\n+  rpc EnvoyMobileStreamMetrics(stream EnvoyMobileStreamMetricsMessage)\n+      returns (stream EnvoyMobileStreamMetricsResponse) {\n+  }\n+}\n+\n+message EnvoyMobileStreamMetricsResponse {\n+  string batch_id = 1;\n+}\n+\n+message EnvoyMobileStreamMetricsMessage {\n+\n+  message Identifier {\n+    // The node sending metrics over the stream.\n+    envoy.config.core.v3.Node node = 1 [(validate.rules).message = {required: true}];\n+  }\n+\n+  // Identifier data effectively is a structured metadata. As a performance optimization this will\n+  // only be sent in the first message on the stream.\n+  Identifier identifier = 1;\n+\n+  // A list of metric entries\n+  repeated io.prometheus.client.MetricFamily envoy_metrics = 2;\n+\n+  string batch_id = 3;", "originalCommit": "166577c9661ecf7adaec5146f41e5bf7a28dff2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk4MTc4MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r562981780", "bodyText": "you mean\nstring batch_id = 2;\nrepeated io.prometheus.client.MetricFamily envoy_metrics = 3;\n\n?\n\ud83d\udc4c on documentation", "author": "jingwei99", "createdAt": "2021-01-23T00:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjkxNTQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzAwMjY3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r563002677", "bodyText": "Yes", "author": "junr03", "createdAt": "2021-01-23T02:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjkxNTQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjkxNjE5Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r562916196", "bodyText": "I am going to put up a PR today to reduce some of the stats we are emitting (and no longer need), as this config effectively doubles the amount of stats emitted", "author": "junr03", "createdAt": "2021-01-22T21:18:04Z", "path": "library/common/config_template.cc", "diffHunk": "@@ -207,6 +207,13 @@ stats_flush_interval: {{ stats_flush_interval_seconds }}s\n       grpc_service:\n         envoy_grpc:\n           cluster_name: stats\n+  - name: envoy.stat_sinks.metrics_service.mobile", "originalCommit": "166577c9661ecf7adaec5146f41e5bf7a28dff2d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODE0NTc0Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r568145743", "bodyText": "comment", "author": "junr03", "createdAt": "2021-02-01T21:18:07Z", "path": "library/common/extensions/stat_sinks/metrics_service/service.proto", "diffHunk": "@@ -0,0 +1,35 @@\n+syntax = \"proto3\";\n+\n+package envoymobile.extensions.stat_sinks.metrics_service;\n+\n+import \"envoy/config/core/v3/base.proto\";\n+import \"metrics.proto\";\n+import \"validate/validate.proto\";\n+\n+service EnvoyMobileMetricsService {\n+  rpc EnvoyMobileStreamMetrics(stream EnvoyMobileStreamMetricsMessage)\n+      returns (stream EnvoyMobileStreamMetricsResponse) {\n+  }\n+}\n+\n+message EnvoyMobileStreamMetricsResponse {\n+  string batch_id = 1;", "originalCommit": "00370f14cda8f6054c38b2f85ad94ed623ec8863", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODE0NTg0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r568145845", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Identifier for the current envoy_metrics batch\n          \n          \n            \n              // Identifier for the current envoy_metrics batch.\n          \n      \n    \n    \n  \n\nSame below.", "author": "junr03", "createdAt": "2021-02-01T21:18:19Z", "path": "library/common/extensions/stat_sinks/metrics_service/service.proto", "diffHunk": "@@ -0,0 +1,35 @@\n+syntax = \"proto3\";\n+\n+package envoymobile.extensions.stat_sinks.metrics_service;\n+\n+import \"envoy/config/core/v3/base.proto\";\n+import \"metrics.proto\";\n+import \"validate/validate.proto\";\n+\n+service EnvoyMobileMetricsService {\n+  rpc EnvoyMobileStreamMetrics(stream EnvoyMobileStreamMetricsMessage)\n+      returns (stream EnvoyMobileStreamMetricsResponse) {\n+  }\n+}\n+\n+message EnvoyMobileStreamMetricsResponse {\n+  string batch_id = 1;\n+}\n+\n+message EnvoyMobileStreamMetricsMessage {\n+\n+  message Identifier {\n+    // The node sending metrics over the stream.\n+    envoy.config.core.v3.Node node = 1 [(validate.rules).message = {required: true}];\n+  }\n+\n+  // Identifier data effectively is a structured metadata. As a performance optimization this will\n+  // only be sent in the first message on the stream.\n+  Identifier identifier = 1;\n+\n+  // Identifier for the current envoy_metrics batch", "originalCommit": "00370f14cda8f6054c38b2f85ad94ed623ec8863", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbe930e55b84a021a9a37daa19d0abf1b398076b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/dbe930e55b84a021a9a37daa19d0abf1b398076b", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2021-02-01T21:58:25Z", "type": "forcePushed"}, {"oid": "71e580310ab761e1c65927d402c09ccd0628ba57", "url": "https://github.com/envoyproxy/envoy-mobile/commit/71e580310ab761e1c65927d402c09ccd0628ba57", "message": "stats: adds metrics sink with ack\n\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2021-02-02T20:51:57Z", "type": "commit"}, {"oid": "cb379f78835ab99b7b97d916b66ce0ecb9e80186", "url": "https://github.com/envoyproxy/envoy-mobile/commit/cb379f78835ab99b7b97d916b66ce0ecb9e80186", "message": "sign\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2021-02-02T20:51:57Z", "type": "commit"}, {"oid": "21520ddd4233140076ceb6f3274039aa1ae353fd", "url": "https://github.com/envoyproxy/envoy-mobile/commit/21520ddd4233140076ceb6f3274039aa1ae353fd", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2021-02-02T20:51:57Z", "type": "commit"}, {"oid": "20988f1852781872c1b30b13d32a093bd83a684d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/20988f1852781872c1b30b13d32a093bd83a684d", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2021-02-02T20:51:57Z", "type": "commit"}, {"oid": "20988f1852781872c1b30b13d32a093bd83a684d", "url": "https://github.com/envoyproxy/envoy-mobile/commit/20988f1852781872c1b30b13d32a093bd83a684d", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>", "committedDate": "2021-02-02T20:51:57Z", "type": "forcePushed"}]}