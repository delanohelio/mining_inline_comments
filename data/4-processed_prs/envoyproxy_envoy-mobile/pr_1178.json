{"pr_number": 1178, "pr_title": "filters: add core and iOS support for on-cancel invocations", "pr_createdAt": "2020-11-12T12:34:45Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1178", "timeline": [{"oid": "7668324fff4038496dead09b7d1b80cd858c4f29", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7668324fff4038496dead09b7d1b80cd858c4f29", "message": "filters: add support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-11-12T12:35:12Z", "type": "forcePushed"}, {"oid": "99d0361148a6f4ee362d4c2ba8c803480eacf583", "url": "https://github.com/envoyproxy/envoy-mobile/commit/99d0361148a6f4ee362d4c2ba8c803480eacf583", "message": "filters: add core and iOS support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-11-18T11:51:44Z", "type": "forcePushed"}, {"oid": "84c736584e9eed0ed1dddd32d903b5d07f2b0861", "url": "https://github.com/envoyproxy/envoy-mobile/commit/84c736584e9eed0ed1dddd32d903b5d07f2b0861", "message": "filters: add core and iOS support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-11-18T11:51:57Z", "type": "forcePushed"}, {"oid": "53a9ce50c2470a4bee713f83c3f6440394a4c230", "url": "https://github.com/envoyproxy/envoy-mobile/commit/53a9ce50c2470a4bee713f83c3f6440394a4c230", "message": "add platform integration test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-02T18:41:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ2OTg1OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#discussion_r535469859", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  self.onCancel = {\n          \n          \n            \n                    responseFilter.onCancel()\n          \n          \n            \n                  }\n          \n          \n            \n                  self.onCancel = responseFilter.onCancel", "author": "rebello95", "createdAt": "2020-12-03T18:15:39Z", "path": "library/swift/src/filters/Filter.swift", "diffHunk": "@@ -104,6 +104,16 @@ extension EnvoyHTTPFilter {\n           ]\n         }\n       }\n+\n+      self.onError = { errorCode, message, attemptCount in\n+        let error = EnvoyError(errorCode: errorCode, message: message,\n+                               attemptCount: UInt32(exactly: attemptCount), cause: nil)\n+        responseFilter.onError(error)\n+      }\n+\n+      self.onCancel = {\n+        responseFilter.onCancel()\n+      }", "originalCommit": "cbab625a9e8218d08f840c421f12c11b1e1c002e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MDY0OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#discussion_r535470649", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  init(expectation: XCTestExpectation) {\n          \n          \n            \n                    self.expectation = expectation\n          \n          \n            \n                  }\n          \n      \n    \n    \n  \n\nThis will work without the explicit init since the type is a struct", "author": "rebello95", "createdAt": "2020-12-03T18:16:33Z", "path": "library/swift/test/HttpBridgeTests/CancelStreamTest.swift", "diffHunk": "@@ -33,25 +35,64 @@ final class CancelStreamTests: XCTestCase {\n                       direct_response:\n                         status: 200\n             http_filters:\n+              - name: envoy.filters.http.platform_bridge\n+                typed_config:\n+                  \"@type\": \\(platformBridgeFilterType)\n+                  platform_filter_name: cancel_validation_filter\n               - name: envoy.router\n                 typed_config:\n                   \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n     \"\"\"\n-    let expectation = self.expectation(description: \"Run called with expected cancellation\")\n+\n+    struct CancelValidationFilter: ResponseFilter {\n+      let expectation: XCTestExpectation\n+\n+      init(expectation: XCTestExpectation) {\n+        self.expectation = expectation\n+      }\n+", "originalCommit": "cbab625a9e8218d08f840c421f12c11b1e1c002e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MTYzNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#discussion_r535471636", "bodyText": "Can we add a test for onError?", "author": "rebello95", "createdAt": "2020-12-03T18:17:38Z", "path": "library/swift/test/HttpBridgeTests/CancelStreamTest.swift", "diffHunk": "@@ -33,25 +35,64 @@ final class CancelStreamTests: XCTestCase {\n                       direct_response:\n                         status: 200\n             http_filters:\n+              - name: envoy.filters.http.platform_bridge\n+                typed_config:\n+                  \"@type\": \\(platformBridgeFilterType)\n+                  platform_filter_name: cancel_validation_filter\n               - name: envoy.router\n                 typed_config:\n                   \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n     \"\"\"\n-    let expectation = self.expectation(description: \"Run called with expected cancellation\")\n+\n+    struct CancelValidationFilter: ResponseFilter {\n+      let expectation: XCTestExpectation\n+\n+      init(expectation: XCTestExpectation) {\n+        self.expectation = expectation\n+      }\n+\n+      func onResponseHeaders(_ headers: ResponseHeaders, endStream: Bool)\n+        -> FilterHeadersStatus<ResponseHeaders>\n+      {\n+        return .continue(headers: headers)\n+      }\n+\n+      func onResponseData(_ body: Data, endStream: Bool) -> FilterDataStatus<ResponseHeaders> {\n+        return .continue(data: body)\n+      }\n+\n+      func onResponseTrailers(_ trailers: ResponseTrailers)\n+          -> FilterTrailersStatus<ResponseHeaders, ResponseTrailers> {\n+        return .continue(trailers: trailers)\n+      }\n+\n+      func onError(_ error: EnvoyError) {}", "originalCommit": "cbab625a9e8218d08f840c421f12c11b1e1c002e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI5ODAyOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#discussion_r536298028", "bodyText": "Support/test added in a separate PR.", "author": "goaway", "createdAt": "2020-12-04T18:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MTYzNg=="}], "type": "inlineReview"}, {"oid": "c4077df71d9eba8a4f18368a3030087961732a1a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c4077df71d9eba8a4f18368a3030087961732a1a", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-04T18:35:08Z", "type": "forcePushed"}, {"oid": "7d317594e17501023c99b43a0a0dd11dc2891584", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7d317594e17501023c99b43a0a0dd11dc2891584", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-08T19:01:41Z", "type": "forcePushed"}, {"oid": "18863487119211a9288f11855fcf9826251cf730", "url": "https://github.com/envoyproxy/envoy-mobile/commit/18863487119211a9288f11855fcf9826251cf730", "message": "filters: add core and iOS support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-10T20:47:18Z", "type": "commit"}, {"oid": "f0c3140fe5a3319224778614167bf7eb8bb92ba7", "url": "https://github.com/envoyproxy/envoy-mobile/commit/f0c3140fe5a3319224778614167bf7eb8bb92ba7", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-10T20:47:18Z", "type": "commit"}, {"oid": "b35f14f429c786cb80407cd7a9c89d86439f24e1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b35f14f429c786cb80407cd7a9c89d86439f24e1", "message": "copy-paste typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-10T20:47:18Z", "type": "commit"}, {"oid": "fc05659c43a8a5e824cfa8ddb96a429747dcdd7e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/fc05659c43a8a5e824cfa8ddb96a429747dcdd7e", "message": "add platform integration test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-10T20:47:18Z", "type": "commit"}, {"oid": "33712e79a2106f2c1decab7443974ce38787e8b1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/33712e79a2106f2c1decab7443974ce38787e8b1", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-10T20:47:18Z", "type": "commit"}, {"oid": "c79026bdf3a94011d72d70ac179db2c3732be900", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c79026bdf3a94011d72d70ac179db2c3732be900", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-10T20:47:18Z", "type": "commit"}, {"oid": "6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "message": "passing test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-13T20:47:54Z", "type": "commit"}, {"oid": "6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "message": "passing test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-13T20:47:54Z", "type": "forcePushed"}, {"oid": "a267ad9f70960fb1c43a7dee46eebbca0df3c25b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a267ad9f70960fb1c43a7dee46eebbca0df3c25b", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>", "committedDate": "2020-12-13T21:03:38Z", "type": "commit"}]}