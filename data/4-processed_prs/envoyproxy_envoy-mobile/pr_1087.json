{"pr_number": 1087, "pr_title": "core/platform: add platform-level postinit callback wiring", "pr_createdAt": "2020-09-12T05:42:56Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/1087", "timeline": [{"oid": "a7a029bc3d98c62aa46e567d799b3f114f6fa40e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/a7a029bc3d98c62aa46e567d799b3f114f6fa40e", "message": "wip\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-12T05:42:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM3MjE2Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1087#discussion_r487372166", "bodyText": "Envoy lints against using system time - I think I'll actually revisit this and avoid doing the timing within the library and simply make the closure void", "author": "rebello95", "createdAt": "2020-09-12T05:43:41Z", "path": "library/common/engine.cc", "diffHunk": "@@ -51,14 +53,23 @@ envoy_status_t Engine::run(const std::string config, const std::string log_level\n     // When we improve synchronous failure handling and/or move to dynamic forwarding, we only need\n     // to wait until the dispatcher is running (and can drain by enqueueing a drain callback on it,\n     // as we did previously).\n+    int64_t start_time = std::chrono::duration_cast<std::chrono::milliseconds>(\n+                             std::chrono::system_clock::now().time_since_epoch())\n+                             .count();", "originalCommit": "a7a029bc3d98c62aa46e567d799b3f114f6fa40e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09fc98a42641c015b20719d120f28be20cc91631", "url": "https://github.com/envoyproxy/envoy-mobile/commit/09fc98a42641c015b20719d120f28be20cc91631", "message": "wip\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-14T18:00:18Z", "type": "commit"}, {"oid": "2442d586b2d7202969729fc806704a79b7cd943c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2442d586b2d7202969729fc806704a79b7cd943c", "message": "changes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-14T22:33:03Z", "type": "commit"}, {"oid": "aa4c3f56706586556b77cfd777f5c1f20c51dcb1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/aa4c3f56706586556b77cfd777f5c1f20c51dcb1", "message": "a stab at it\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-09-14T23:03:29Z", "type": "commit"}, {"oid": "73ba5f67afe0422f310dc791390606d7535b3635", "url": "https://github.com/envoyproxy/envoy-mobile/commit/73ba5f67afe0422f310dc791390606d7535b3635", "message": "Merge remote-tracking branch 'origin/main' into postinit-callbacks\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-14T23:09:48Z", "type": "commit"}, {"oid": "72e45b143c11f77aa43c56d7c3b7a8dd7ff64372", "url": "https://github.com/envoyproxy/envoy-mobile/commit/72e45b143c11f77aa43c56d7c3b7a8dd7ff64372", "message": "fixup\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-14T23:11:29Z", "type": "commit"}, {"oid": "ef32d4b6252703ad3679876a5726077a6159f328", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ef32d4b6252703ad3679876a5726077a6159f328", "message": "more\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>", "committedDate": "2020-09-14T23:30:11Z", "type": "commit"}, {"oid": "ef098c9ca4fdefe93f5e5ecd668f79560b7f336f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ef098c9ca4fdefe93f5e5ecd668f79560b7f336f", "message": "docs/finish ios\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-14T23:57:30Z", "type": "commit"}, {"oid": "8905c97ce4fb4b6f5afd0d34e7975417dd689a1c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8905c97ce4fb4b6f5afd0d34e7975417dd689a1c", "message": "this works\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T20:00:38Z", "type": "commit"}, {"oid": "07f2f8afd66c4c25e0baf7c261621b336ba056d9", "url": "https://github.com/envoyproxy/envoy-mobile/commit/07f2f8afd66c4c25e0baf7c261621b336ba056d9", "message": "checkpoint\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T21:09:53Z", "type": "commit"}, {"oid": "9b0bac6daa3d4774473638897ca562d7ce44827b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9b0bac6daa3d4774473638897ca562d7ce44827b", "message": "kotlin wiring\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T21:55:43Z", "type": "commit"}, {"oid": "d2bfa3610cf51bc4a2409892ee23581fcec40500", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d2bfa3610cf51bc4a2409892ee23581fcec40500", "message": "examples\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T22:08:24Z", "type": "commit"}, {"oid": "bf9a738d954b3578d80c8d78a0fef69290ba9168", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bf9a738d954b3578d80c8d78a0fef69290ba9168", "message": "fixes & cleanup\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T22:14:35Z", "type": "commit"}, {"oid": "814aa93053d2a93540c5658e2fff22da86052424", "url": "https://github.com/envoyproxy/envoy-mobile/commit/814aa93053d2a93540c5658e2fff22da86052424", "message": "Merge remote-tracking branch 'origin/main' into postinit-callbacks\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T22:17:28Z", "type": "commit"}, {"oid": "bfd35e7bcdc658f01f878d22af084debcfdff734", "url": "https://github.com/envoyproxy/envoy-mobile/commit/bfd35e7bcdc658f01f878d22af084debcfdff734", "message": "Update engine_test.cc\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T22:23:56Z", "type": "commit"}, {"oid": "41c3e464d6b1c189dd9215286730e36376b618de", "url": "https://github.com/envoyproxy/envoy-mobile/commit/41c3e464d6b1c189dd9215286730e36376b618de", "message": "Update EngineImpl.kt\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T22:30:28Z", "type": "commit"}, {"oid": "9c29889f14006129ce418a01ef299b922cd06f1e", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9c29889f14006129ce418a01ef299b922cd06f1e", "message": "add cpp test\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T22:58:22Z", "type": "commit"}, {"oid": "6cb967699f7c4584979288dcb0edf15bb9ee5f71", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6cb967699f7c4584979288dcb0edf15bb9ee5f71", "message": "switch ordering in cpp struct\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T23:04:01Z", "type": "commit"}, {"oid": "8e47e4d8df9b0c5b8056321b92c7c1bae81b121c", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8e47e4d8df9b0c5b8056321b92c7c1bae81b121c", "message": "Update MainActivity.java\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-15T23:47:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA5MjEyNw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1087#discussion_r489092127", "bodyText": "\ud83d\udcaf", "author": "buildbreaker", "createdAt": "2020-09-16T00:31:03Z", "path": "library/proguard.txt", "diffHunk": "@@ -11,6 +11,10 @@\n     native <methods>;\n }\n \n+-keep, includedescriptorclasses class io.envoyproxy.envoymobile.engine.types.EnvoyEngineOnSetupComplete {", "originalCommit": "8e47e4d8df9b0c5b8056321b92c7c1bae81b121c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8a0bee55c45b103bacab37e290c338f8b1105ae", "url": "https://github.com/envoyproxy/envoy-mobile/commit/d8a0bee55c45b103bacab37e290c338f8b1105ae", "message": "Update MainActivity.java\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T00:40:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4NTU3NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1087#discussion_r489285575", "bodyText": "What about onEngineRunning?\nThere's a separate, potentially interesting callback point where objects have been initialized, but the main run loop hasn't started and configuration hasn't yet been loaded. onEngineRunning is maybe a little bit more explicit about the juncture to which it refers.", "author": "goaway", "createdAt": "2020-09-16T09:10:46Z", "path": "docs/root/api/starting_envoy.rst", "diffHunk": "@@ -184,6 +184,25 @@ This functionality is used for stat segmentation.\n   // Swift\n   builder.addVirtualClusters(\"[{\\\"name\\\":\\\"vcluster\\\",\\\"headers\\\":[{\\\"name\\\":\\\":path\\\",\\\"exact_match\\\":\\\"/v1/vcluster\\\"}]}]\")\n \n+~~~~~~~~~~~~~~~~~~~~~~\n+``setOnSetupComplete``\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+Specify a closure to be called once Envoy's engine finishes its async initialization/startup.\n+\n+When Envoy is instantiated, its initializer returns before all of its internal configuration\n+completes. This interface provides the ability to observe when Envoy has completed its setup and is\n+ready to start dispatching requests. Any requests sent through Envoy before this setup completes\n+will be queued automatically, and this function is typically used purely for observability.\n+\n+**Example**::\n+\n+  // Kotlin\n+  builder.setOnSetupComplete { /*do something*/ }\n+\n+  // Swift\n+  builder.setOnSetupComplete { /*do something*/ }", "originalCommit": "d8a0bee55c45b103bacab37e290c338f8b1105ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU3MzE5Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1087#discussion_r489573196", "bodyText": "Okay, updated.", "author": "rebello95", "createdAt": "2020-09-16T16:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4NTU3NQ=="}], "type": "inlineReview"}, {"oid": "4391051fc57bee6321ee2a64764e5870e8ab8e5a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4391051fc57bee6321ee2a64764e5870e8ab8e5a", "message": "s/onSetupComplete/onEngineRunning\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T16:32:14Z", "type": "commit"}, {"oid": "2998ec05f390d5f3b81765f6d0dd1ee222a5e836", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2998ec05f390d5f3b81765f6d0dd1ee222a5e836", "message": "s/on_setup_complete/on_engine_running\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T16:32:43Z", "type": "commit"}, {"oid": "ade1a0ea394e61274771457ca042aaaf309b692a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ade1a0ea394e61274771457ca042aaaf309b692a", "message": "cleanup after rename\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T16:35:43Z", "type": "commit"}, {"oid": "ddd33fd8a4c0b2777065e5456d56642eb30e0074", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ddd33fd8a4c0b2777065e5456d56642eb30e0074", "message": "Merge remote-tracking branch 'origin/main' into postinit-callbacks\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T16:36:30Z", "type": "commit"}, {"oid": "638ace67fbc45954538f6caf13bd9ba7d5087134", "url": "https://github.com/envoyproxy/envoy-mobile/commit/638ace67fbc45954538f6caf13bd9ba7d5087134", "message": "fix again.\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T16:37:13Z", "type": "commit"}, {"oid": "4ce9b0d09f1749237b7dd3b9d147e4d14b1008e3", "url": "https://github.com/envoyproxy/envoy-mobile/commit/4ce9b0d09f1749237b7dd3b9d147e4d14b1008e3", "message": "alphabetical.\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T16:39:49Z", "type": "commit"}, {"oid": "7c7fe54245e2d20fb69eaa87e7a29f88a0df8be5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/7c7fe54245e2d20fb69eaa87e7a29f88a0df8be5", "message": "Update engine_test.cc\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T16:41:11Z", "type": "commit"}, {"oid": "604363f42735a6d5de2ffe4b5104a14b0b1c317f", "url": "https://github.com/envoyproxy/envoy-mobile/commit/604363f42735a6d5de2ffe4b5104a14b0b1c317f", "message": "filename\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T17:40:03Z", "type": "commit"}, {"oid": "eb1a2908f6db308c9aea013d2d1c08fbd43a17a2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/eb1a2908f6db308c9aea013d2d1c08fbd43a17a2", "message": "linters\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-09-16T17:55:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0NjkzOA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1087#discussion_r489746938", "bodyText": "Can you put a comment here? This works only because the other current engine callback doesn't use the context, but if others get added and/or when we move to per-instance runs, this will need to be moved.", "author": "goaway", "createdAt": "2020-09-16T20:52:09Z", "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -30,6 +30,20 @@ extern \"C\" JNIEXPORT jlong JNICALL Java_io_envoyproxy_envoymobile_engine_JniLibr\n   return init_engine();\n }\n \n+static void jvm_on_engine_running(void* context) {\n+  __android_log_write(ANDROID_LOG_VERBOSE, \"[Envoy]\", \"jvm_on_engine_running\");\n+\n+  JNIEnv* env = get_env();\n+  jobject j_context = static_cast<jobject>(context);\n+  jclass jcls_JvmonEngineRunningContext = env->GetObjectClass(j_context);\n+  jmethodID jmid_onEngineRunning = env->GetMethodID(\n+      jcls_JvmonEngineRunningContext, \"invokeOnEngineRunning\", \"()Ljava/lang/Object;\");\n+  env->CallObjectMethod(j_context, jmid_onEngineRunning);\n+\n+  env->DeleteLocalRef(jcls_JvmonEngineRunningContext);\n+  env->DeleteGlobalRef(j_context);", "originalCommit": "eb1a2908f6db308c9aea013d2d1c08fbd43a17a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1NTM0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1087#discussion_r489755345", "bodyText": "Sure, will add in a separate PR since this one is green", "author": "rebello95", "createdAt": "2020-09-16T21:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0NjkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1NzAzNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1087#discussion_r489757035", "bodyText": "#1101", "author": "rebello95", "createdAt": "2020-09-16T21:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0NjkzOA=="}], "type": "inlineReview"}]}