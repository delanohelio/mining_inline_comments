{"pr_number": 913, "pr_title": "kotlin: refactor public functionality as precursor to L7 filters", "pr_createdAt": "2020-06-16T22:58:14Z", "pr_url": "https://github.com/envoyproxy/envoy-mobile/pull/913", "timeline": [{"oid": "9ce0487ad2f7a9331d3192fe167bc5546eb1c66a", "url": "https://github.com/envoyproxy/envoy-mobile/commit/9ce0487ad2f7a9331d3192fe167bc5546eb1c66a", "message": "checkpoint\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-16T22:56:36Z", "type": "commit"}, {"oid": "40a587b52237c3a53a8c0f719116f35573090fb0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/40a587b52237c3a53a8c0f719116f35573090fb0", "message": "android compiles\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-17T00:09:43Z", "type": "commit"}, {"oid": "8f150e7f446ee781f26121085f990881b93d17bb", "url": "https://github.com/envoyproxy/envoy-mobile/commit/8f150e7f446ee781f26121085f990881b93d17bb", "message": "updates\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-17T01:21:21Z", "type": "commit"}, {"oid": "774d82899aae3a4ddc28cf1518f99ecf61e0a041", "url": "https://github.com/envoyproxy/envoy-mobile/commit/774d82899aae3a4ddc28cf1518f99ecf61e0a041", "message": "some tests\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-17T03:42:26Z", "type": "commit"}, {"oid": "ba1ce550f0e609e81cef73af5798cc0bef349c5b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/ba1ce550f0e609e81cef73af5798cc0bef349c5b", "message": "ktlint\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-17T16:52:11Z", "type": "commit"}, {"oid": "3760807ad6da4b9b5d387af80d562ce01c80d329", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3760807ad6da4b9b5d387af80d562ce01c80d329", "message": "GRPCRequestBuilderTest\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-17T17:19:37Z", "type": "commit"}, {"oid": "064cb26199c51caf51b549d4883425d51dea424b", "url": "https://github.com/envoyproxy/envoy-mobile/commit/064cb26199c51caf51b549d4883425d51dea424b", "message": "mocks compile\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-17T21:51:48Z", "type": "commit"}, {"oid": "1858c6cef1a5bbb66f5ff30f5e43dd876d870b10", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1858c6cef1a5bbb66f5ff30f5e43dd876d870b10", "message": "some fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-17T23:39:47Z", "type": "commit"}, {"oid": "c143054d32c12c6ee1763689b50647180e1e7ad1", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c143054d32c12c6ee1763689b50647180e1e7ad1", "message": "tests work\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T00:35:52Z", "type": "commit"}, {"oid": "6fc7714fafc71cf3902d2c1ff49a08fe75f72126", "url": "https://github.com/envoyproxy/envoy-mobile/commit/6fc7714fafc71cf3902d2c1ff49a08fe75f72126", "message": "fixups\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T01:03:26Z", "type": "commit"}, {"oid": "cf949d9036f69cb7cb9e6311262576e8a003a866", "url": "https://github.com/envoyproxy/envoy-mobile/commit/cf949d9036f69cb7cb9e6311262576e8a003a866", "message": "Merge remote-tracking branch 'origin/master' into kotlin-filters-m2\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T03:52:56Z", "type": "commit"}, {"oid": "b160cb1984d759117f0cfe4f72759c376a0d7da2", "url": "https://github.com/envoyproxy/envoy-mobile/commit/b160cb1984d759117f0cfe4f72759c376a0d7da2", "message": "fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T04:43:14Z", "type": "commit"}, {"oid": "23cf61ebb84a2d007f30288bc1d82b6b1ddc9ae4", "url": "https://github.com/envoyproxy/envoy-mobile/commit/23cf61ebb84a2d007f30288bc1d82b6b1ddc9ae4", "message": "linter\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T05:11:39Z", "type": "commit"}, {"oid": "11eef0503e17f8acb202bc35101fe801397d72f0", "url": "https://github.com/envoyproxy/envoy-mobile/commit/11eef0503e17f8acb202bc35101fe801397d72f0", "message": "Update RequestHeadersBuilder.kt\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T05:49:01Z", "type": "commit"}, {"oid": "1098580e537f53d7566601489c04a89a437fe596", "url": "https://github.com/envoyproxy/envoy-mobile/commit/1098580e537f53d7566601489c04a89a437fe596", "message": "fixups\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T13:44:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM2NDE0MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442364140", "bodyText": "This change was necessary in order to ensure that mock subclasses of EnvoyHTTPStream don't end up calling JNI at all (doing so caused tests to crash). Instead, the initializer now no longer has the side effect of calling the JNI, and the engine starts the stream via this method (similarly to the ObjC engine here)", "author": "rebello95", "createdAt": "2020-06-18T16:45:47Z", "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyHTTPStream.java", "diffHunk": "@@ -9,14 +9,22 @@\n import java.util.Map;\n \n public class EnvoyHTTPStream {\n-\n   private final long streamHandle;\n   private final JvmCallbackContext callbacksContext;\n \n-  EnvoyHTTPStream(long streamHandle, EnvoyHTTPCallbacks callbacks) {\n+  /**\n+   * Start the stream via the JNI library.\n+   */\n+  void start() { JniLibrary.startStream(streamHandle, callbacksContext); }", "originalCommit": "1098580e537f53d7566601489c04a89a437fe596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b90c5d6ec8942385a2c4b64470fc4a8e7dd1376", "url": "https://github.com/envoyproxy/envoy-mobile/commit/3b90c5d6ec8942385a2c4b64470fc4a8e7dd1376", "message": "Merge remote-tracking branch 'origin/master' into kotlin-filters-m2\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T16:46:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM2NTAxNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442365014", "bodyText": "File was renamed from Envoy, but git didn't recognize this as a rename because there were enough changes in the file", "author": "rebello95", "createdAt": "2020-06-18T16:47:08Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/EnvoyClient.kt", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.envoyproxy.envoymobile", "originalCommit": "1098580e537f53d7566601489c04a89a437fe596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3MzcyMA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442373720", "bodyText": "These are necessary in order to return a RequestHeadersBuilder type rather than a HeadersBuilder", "author": "rebello95", "createdAt": "2020-06-18T17:02:05Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestHeadersBuilder.kt", "diffHunk": "@@ -35,6 +35,26 @@ class RequestHeadersBuilder : HeadersBuilder {\n    */\n   internal constructor(headers: MutableMap<String, MutableList<String>>) : super(headers)\n \n+  override fun add(name: String, value: String): RequestHeadersBuilder {\n+    super.add(name, value)\n+    return this\n+  }\n+\n+  override fun set(name: String, value: MutableList<String>): RequestHeadersBuilder {\n+    super.set(name, value)\n+    return this\n+  }\n+\n+  override fun remove(name: String): RequestHeadersBuilder {\n+    super.remove(name)\n+    return this\n+  }\n+\n+  override fun internalSet(name: String, value: MutableList<String>): RequestHeadersBuilder {\n+    super.internalSet(name, value)\n+    return this\n+  }\n+", "originalCommit": "1098580e537f53d7566601489c04a89a437fe596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3NDAyMg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442374022", "bodyText": "This was a bug caught by the new tests I added \ud83d\ude43", "author": "rebello95", "createdAt": "2020-06-18T17:02:37Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/RetryPolicy.kt", "diffHunk": "@@ -68,7 +67,7 @@ enum class RetryRule(internal val stringValue: String) {\n   companion object {\n     internal fun enumValue(stringRepresentation: String): RetryRule? {\n       return when (stringRepresentation) {\n-        \"status-5xx\" -> STATUS_5XX\n+        \"5xx\" -> STATUS_5XX", "originalCommit": "1098580e537f53d7566601489c04a89a437fe596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3NTEyNg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442375126", "bodyText": "Partly moved from a different file", "author": "rebello95", "createdAt": "2020-06-18T17:04:41Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/StreamCallbacks.kt", "diffHunk": "@@ -0,0 +1,52 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks\n+import java.nio.ByteBuffer\n+import java.util.concurrent.Executor\n+\n+/**\n+ * A collection of platform-level callbacks that are specified by consumers\n+ * who wish to interact with streams.\n+ *\n+ * `StreamCallbacks` are bridged through to `EnvoyHTTPCallbacks` to communicate with the engine.\n+ */\n+internal class StreamCallbacks {\n+  var onHeaders: ((headers: ResponseHeaders, endStream: Boolean) -> Unit)? = null\n+  var onData: ((data: ByteBuffer, endStream: Boolean) -> Unit)? = null\n+  var onTrailers: ((trailers: ResponseTrailers) -> Unit)? = null\n+  var onCancel: (() -> Unit)? = null\n+  var onError: ((error: EnvoyError) -> Unit)? = null\n+}\n+\n+/**\n+ * Class responsible for bridging between the platform-level `StreamCallbacks` and the\n+ * engine's `EnvoyHTTPCallbacks`.\n+ */\n+internal class EnvoyHTTPCallbacksAdapter(", "originalCommit": "1098580e537f53d7566601489c04a89a437fe596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3OTU1Mw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442379553", "bodyText": "Renamed for consistency on both platforms", "author": "rebello95", "createdAt": "2020-06-18T17:12:38Z", "path": "library/swift/src/grpc/GRPCRequestHeadersBuilder.swift", "diffHunk": "@@ -21,14 +21,14 @@ public final class GRPCRequestHeadersBuilder: HeadersBuilder {\n \n   /// Add a specific timeout for the gRPC request. This will be sent in the `grpc-timeout` header.\n   ///\n-  /// - parameter timeoutMS: Timeout, in milliseconds.\n+  /// - parameter timeoutMs: Timeout, in milliseconds.\n   ///\n   /// - returns: This builder.\n   @discardableResult\n-  public func addTimeoutMS(_ timeoutMS: UInt?) -> GRPCRequestHeadersBuilder {\n+  public func addTimeoutMs(_ timeoutMs: UInt?) -> GRPCRequestHeadersBuilder {", "originalCommit": "1098580e537f53d7566601489c04a89a437fe596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3OTYzMQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442379631", "bodyText": "This was missing on master", "author": "rebello95", "createdAt": "2020-06-18T17:12:47Z", "path": "library/swift/src/grpc/GRPCStreamPrototype.swift", "diffHunk": "@@ -96,6 +96,20 @@ public final class GRPCStreamPrototype: NSObject {\n     self.underlyingStream.setOnError(closure: closure)\n     return self\n   }\n+\n+  /// Specify a callback for when the stream is canceled.", "originalCommit": "1098580e537f53d7566601489c04a89a437fe596", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478", "url": "https://github.com/envoyproxy/envoy-mobile/commit/c1ff70a18918427c61a48093f1f1b6209f93e478", "message": "self review\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T17:13:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4Njg3Nw==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442386877", "bodyText": "Is this really needed? Could get rid of these constructors and you'd still be able to call this like:\nEnvoyClient(engine, envoyConfiguration)\n\nOR\nEnvoyClient(engine, configurationYAML  = yaml)", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:25:16Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/EnvoyClient.kt", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyConfiguration\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+\n+/**\n+ * Envoy's implementation of `StreamClient`, buildable using `StreamClientBuilder`.\n+ */\n+internal class EnvoyClient private constructor(\n+  internal val engine: EnvoyEngine,\n+  internal val envoyConfiguration: EnvoyConfiguration?,\n+  internal val configurationYAML: String?,\n+  internal val logLevel: LogLevel\n+) : StreamClient {\n+  constructor(\n+    engine: EnvoyEngine,\n+    envoyConfiguration: EnvoyConfiguration,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, envoyConfiguration, null, logLevel)\n+  constructor(\n+    engine: EnvoyEngine,\n+    configurationYAML: String,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, null, configurationYAML, logLevel)", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MjU5NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442392595", "bodyText": "Fair callout. This was moved from a different file, but if I recall correctly we elected to keep these two constructors to make it clearer that either a yaml configuration or a typed configuration could be specified (i.e., preventing them from passing both values and ignoring one of them). iOS for example: here", "author": "rebello95", "createdAt": "2020-06-18T17:35:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4Njg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4NzU2OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442387569", "bodyText": "can just be:\noverride fun newStreamPrototype() = StreamPrototype(engine)", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:26:32Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/EnvoyClient.kt", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyConfiguration\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+\n+/**\n+ * Envoy's implementation of `StreamClient`, buildable using `StreamClientBuilder`.\n+ */\n+internal class EnvoyClient private constructor(\n+  internal val engine: EnvoyEngine,\n+  internal val envoyConfiguration: EnvoyConfiguration?,\n+  internal val configurationYAML: String?,\n+  internal val logLevel: LogLevel\n+) : StreamClient {\n+  constructor(\n+    engine: EnvoyEngine,\n+    envoyConfiguration: EnvoyConfiguration,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, envoyConfiguration, null, logLevel)\n+  constructor(\n+    engine: EnvoyEngine,\n+    configurationYAML: String,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, null, configurationYAML, logLevel)\n+\n+  init {\n+    if (envoyConfiguration == null) {\n+      engine.runWithConfig(configurationYAML, logLevel.level)\n+    } else {\n+      engine.runWithConfig(envoyConfiguration, logLevel.level)\n+    }\n+  }\n+\n+  override fun newStreamPrototype(): StreamPrototype {\n+    return StreamPrototype(engine)\n+  }", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MzA3MA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442393070", "bodyText": "nice", "author": "rebello95", "createdAt": "2020-06-18T17:35:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4NzU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4ODYwNA==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442388604", "bodyText": "can be:\nprivate fun isRestrictedHeader(name: String) = name.startsWith(\":\") || name.startsWith(\"x-envoy-mobile\")", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:28:10Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/HeadersBuilder.kt", "diffHunk": "@@ -49,8 +55,28 @@ open class HeadersBuilder {\n    *\n    * @return HeadersBuilder, This builder.\n    */\n-  fun remove(name: String): HeadersBuilder {\n+  open fun remove(name: String): HeadersBuilder {\n+    if (isRestrictedHeader(name)) {\n+      return this\n+    }\n     headers.remove(name)\n     return this\n   }\n+\n+  /**\n+   * Allows for setting headers that are not publicly mutable (i.e., restricted headers).\n+   *\n+   * @param name: The header name.\n+   * @param value: The value associated to the header name.\n+   *\n+   * @return HeadersBuilder, This builder.\n+   */\n+  internal open fun internalSet(name: String, value: MutableList<String>): HeadersBuilder {\n+    headers[name] = value\n+    return this\n+  }\n+\n+  private fun isRestrictedHeader(name: String): Boolean {\n+    return name.startsWith(\":\") || name.startsWith(\"x-envoy-mobile\")\n+  }", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MzQ3Mg==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442393472", "bodyText": "TIL \ud83d\udc4d", "author": "rebello95", "createdAt": "2020-06-18T17:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4ODYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MDU4OQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442390589", "bodyText": "can be:\nfun toRequestTrailersBuilder() = RequestTrailersBuilder(this.headers.mapValues { \n    it.value.toMutableList() \n}.toMutableMap())", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:31:28Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestTrailers.kt", "diffHunk": "@@ -11,4 +11,16 @@ class RequestTrailers : Headers {\n    * @param trailers: Headers to set.\n    */\n   internal constructor(trailers: Map<String, List<String>>) : super(trailers)\n+\n+  /**\n+   * Convert the trailers back to a builder for mutation.\n+   *\n+   * @return RequestTrailersBuilder, The new builder.\n+   */\n+  fun toRequestTrailersBuilder(): RequestTrailersBuilder {\n+    return RequestTrailersBuilder(\n+      this.headers.mapValues { it.value.toMutableList() }\n+        .toMutableMap()\n+    )\n+  }", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MjEwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442392109", "bodyText": "would be pretty:\n  fun newGRPCStreamPrototype() = GRPCStreamPrototype(\n    streamClient.newStreamPrototype()\n )", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:34:15Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/grpc/GRPCClient.kt", "diffHunk": "@@ -1,27 +1,23 @@\n package io.envoyproxy.envoymobile\n \n // 1 byte for the compression flag, 4 bytes for the message length (int)\n-const val GRPC_PREFIX_LENGTH = 5\n+internal const val GRPC_PREFIX_LENGTH = 5\n \n /**\n  * Client that supports sending and receiving gRPC traffic.\n  *\n- * @param httpClient The HTTP client to use for gRPC streams.\n+ * @param streamClient The stream client to use for gRPC streams.\n  */\n class GRPCClient(\n-  private val httpClient: HTTPClient\n+  private val streamClient: StreamClient\n ) {\n-\n   /**\n-   * Start a gRPC request with the provided handler.\n-   *\n-   * @param request The outbound gRPC request. See `GRPCRequestBuilder` for creation.\n-   * @param handler Handler for receiving responses.\n+   * Create a new gRPC stream prototype which can be used to start streams.\n    *\n-   * @returns An emitter that can be used for sending more traffic over the stream.\n+   * @return The new gRPC stream prototype.\n    */\n-  fun start(request: Request, grpcResponseHandler: GRPCResponseHandler): GRPCStreamEmitter {\n-    val emitter = httpClient.start(request, grpcResponseHandler.underlyingHandler)\n-    return GRPCStreamEmitter(emitter)\n+  fun newGRPCStreamPrototype(): GRPCStreamPrototype {\n+    val prototype = streamClient.newStreamPrototype()\n+    return GRPCStreamPrototype(prototype)\n   }", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MjUwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442392509", "bodyText": "you know ;)", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:35:00Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/grpc/GRPCRequestHeaders.kt", "diffHunk": "@@ -0,0 +1,22 @@\n+package io.envoyproxy.envoymobile\n+\n+/*\n+ * Headers representing an outbound gRPC request.\n+ */\n+class GRPCRequestHeaders : RequestHeaders {\n+  /**\n+   * Internal constructor used by builders.\n+   *\n+   * @param headers: Headers to set.\n+   */\n+  internal constructor(headers: Map<String, List<String>>) : super(headers)\n+\n+  /**\n+   * Convert the headers back to a builder for mutation.\n+   *\n+   * @return GRPCRequestHeadersBuilder, The new builder.\n+   */\n+  fun toGRPCRequestHeadersBuilder(): GRPCRequestHeadersBuilder {\n+    return GRPCRequestHeadersBuilder(this.headers.mapValues { it.value.toMutableList() }.toMutableMap())\n+  }", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MzM1Ng==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442393356", "bodyText": "this can all be just a few lines.", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:36:31Z", "path": "library/kotlin/src/io/envoyproxy/envoymobile/mocks/MockEnvoyEngine.kt", "diffHunk": "@@ -0,0 +1,23 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyConfiguration\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+import io.envoyproxy.envoymobile.engine.EnvoyHTTPStream\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks\n+\n+/**\n+ * Mock implementation of `EnvoyEngine`. Used internally for testing the bridging layer & mocking.\n+ */\n+internal class MockEnvoyEngine : EnvoyEngine {\n+  override fun runWithConfig(envoyConfiguration: EnvoyConfiguration?, logLevel: String?): Int {\n+    return 0\n+  }\n+\n+  override fun runWithConfig(configurationYAML: String?, logLevel: String?): Int {\n+    return 0\n+  }\n+\n+  override fun startStream(callbacks: EnvoyHTTPCallbacks?): EnvoyHTTPStream {\n+    return MockEnvoyHTTPStream(callbacks!!)\n+  }\n+}", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NTUyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442395529", "bodyText": "would highly recommend using kluent:\nhttps://github.com/MarkusAmshove/Kluent", "author": "johnpaulmckean", "createdAt": "2020-06-18T17:40:46Z", "path": "library/kotlin/test/io/envoyproxy/envoymobile/GRPCRequestHeadersBuilderTest.kt", "diffHunk": "@@ -0,0 +1,69 @@\n+package io.envoyproxy.envoymobile\n+\n+import org.assertj.core.api.Assertions.assertThat\n+import org.junit.Test\n+\n+class GRPCRequestHeadersBuilderTest {", "originalCommit": "c1ff70a18918427c61a48093f1f1b6209f93e478", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NzQwOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442397409", "bodyText": "Might be good for future reference (not sure if @buildbreaker has thoughts, I'm not familiar with it \ud83e\udd37)", "author": "rebello95", "createdAt": "2020-06-18T17:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1Mzg0NQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442453845", "bodyText": "Certainly open to new frameworks which would help. Would you like to file an issue for us to have a conversation about this @johnpaulmckean?", "author": "buildbreaker", "createdAt": "2020-06-18T19:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYwNzcyOQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r444607729", "bodyText": "done.", "author": "johnpaulmckean", "createdAt": "2020-06-24T02:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxMzMwNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r444613305", "bodyText": "Thank you @johnpaulmckean!", "author": "buildbreaker", "createdAt": "2020-06-24T02:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNzYzNQ==", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r444637635", "bodyText": "Thanks! #930 for future reference", "author": "rebello95", "createdAt": "2020-06-24T04:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NTUyOQ=="}], "type": "inlineReview"}, {"oid": "2d5ce6c61eb6ede4ae1328b85831901d24810478", "url": "https://github.com/envoyproxy/envoy-mobile/commit/2d5ce6c61eb6ede4ae1328b85831901d24810478", "message": "CR + running lint fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T17:47:49Z", "type": "commit"}, {"oid": "34a840d3e67d0a6128005b51a66d13d2698d67e5", "url": "https://github.com/envoyproxy/envoy-mobile/commit/34a840d3e67d0a6128005b51a66d13d2698d67e5", "message": "missing overrides\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>", "committedDate": "2020-06-18T18:55:17Z", "type": "commit"}]}