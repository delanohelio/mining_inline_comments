{"pr_number": 26992, "pr_title": "Set detail map as immutable", "pr_createdAt": "2020-11-18T10:08:54Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992", "timeline": [{"oid": "dba2a7fe5d20e0c39120a768ada66156e6945c4d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dba2a7fe5d20e0c39120a768ada66156e6945c4d", "message": "Set detail map as immutable", "committedDate": "2020-11-18T09:38:33Z", "type": "commit"}, {"oid": "d042e7043f64f09138932557b2b7be435000542f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d042e7043f64f09138932557b2b7be435000542f", "message": "Set initial values for detail map while creating", "committedDate": "2020-11-18T10:07:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwOTEyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r527609121", "bodyText": "Can't we use TYPE_ERROR_DETAIL here? This also has to be immutable, right?", "author": "MaryamZi", "createdAt": "2020-11-20T10:49:00Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/api/PredefinedTypes.java", "diffHunk": "@@ -164,9 +164,10 @@\n     public static final ServiceType TYPE_ANY_SERVICE = new BServiceType(TypeConstants.SERVICE, EMPTY_MODULE, 0);\n     public static final HandleType TYPE_HANDLE = new BHandleType(TypeConstants.HANDLE_TNAME, EMPTY_MODULE);\n     public static final UnionType ANYDATA_OR_READONLY = new BUnionType(Arrays.asList(TYPE_ANYDATA, TYPE_READONLY));\n-    public static final MapType TYPE_ERROR_DETAIL = new BMapType(TypeConstants.MAP_TNAME, ANYDATA_OR_READONLY,\n-                                                                 EMPTY_MODULE);\n-    public static final ErrorType TYPE_ERROR = new BErrorType(TypeConstants.ERROR, EMPTY_MODULE, TYPE_ERROR_DETAIL);\n+    public static final Type TYPE_ERROR_DETAIL = ReadOnlyUtils.setImmutableTypeAndGetEffectiveType(\n+                                            new BMapType(TypeConstants.MAP_TNAME, ANYDATA_OR_READONLY, EMPTY_MODULE));\n+    public static final ErrorType TYPE_ERROR = new BErrorType(TypeConstants.ERROR, EMPTY_MODULE,\n+                                            new BMapType(TypeConstants.MAP_TNAME, ANYDATA_OR_READONLY, EMPTY_MODULE));", "originalCommit": "d042e7043f64f09138932557b2b7be435000542f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA4MTM2OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528081369", "bodyText": "In here we set error values as immutable. So if we change error type as immutable we can't do below kind of casting.\ntype CustomErrorData record {\n    string message?;\n    error cause?;\n    int accountID?;\n};\ntype CustomError1 distinct error<CustomErrorData>;\ntype CustomError distinct error<CustomErrorData>;\n\ntype Error CustomError | CustomError1;\n\nclass Foo {\n    public isolated function next() returns record {| int value; |}|Error? {\n\n        CustomError e = CustomError(\"CustomError\", message = \"custom error occured\", accountID = 2);\n        return e;\n        \n    }\n}\n\npublic function main() {\n    Foo val = new;\n    object {\n        public isolated function next() returns record {|int value;|}|error?;} err = <object {\n         public isolated function next() returns record {|int value;|}|error?;}> val;\n}", "author": "chiranSachintha", "createdAt": "2020-11-21T06:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwOTEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA4NDQyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528084421", "bodyText": "All error values/types and their detail values/types have to be immutable. If using the immutable detail here causes something to fail, it's possible that we're creating an error with a non-immutable detail somewhere, which is wrong. Can you check why exactly it fails?", "author": "MaryamZi", "createdAt": "2020-11-21T06:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwOTEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE4MzI3Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528183276", "bodyText": "When creating CustomError1 we are not set detail(CustomErrorData) as immutable. Is it effect when creating values from that type( CustomErrorData) If we set it to immutable.", "author": "chiranSachintha", "createdAt": "2020-11-21T11:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwOTEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ2NzIxOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528467218", "bodyText": "That's wrong, right? When the error value is being created, cloneReadOnly should get called for the detail, so at runtime the detail type should be a subtype of readonly?", "author": "MaryamZi", "createdAt": "2020-11-23T04:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwOTEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1MTEzNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528751135", "bodyText": "As discussed offline, let's have the mutable detail type here for the time-being because that's how we've modeled the errors defined in the source too.", "author": "MaryamZi", "createdAt": "2020-11-23T14:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwOTEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxMzMwMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r527613303", "bodyText": "IMO we shouldn't do this. We should create and pass the initialValues array only if the values are present.", "author": "MaryamZi", "createdAt": "2020-11-20T10:56:56Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/values/MapValueImpl.java", "diffHunk": "@@ -271,6 +271,9 @@ public V put(K key, V value) {\n \n     protected void populateInitialValues(BMapInitialValueEntry[] initialValues) {\n         for (BMapInitialValueEntry initialValue : initialValues) {\n+            if (initialValue == null) {", "originalCommit": "d042e7043f64f09138932557b2b7be435000542f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA4MDk0NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528080945", "bodyText": "I have made a such change because there are some  cases(reale to this) which only the detail become null. Is there any other option to handle this ?", "author": "chiranSachintha", "createdAt": "2020-11-21T06:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxMzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA4MTM0OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528081348", "bodyText": "I think we should refactor that code to create an array of the exact length depending on how many entries there are, instead of always creating an array of length 2.", "author": "MaryamZi", "createdAt": "2020-11-21T06:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxMzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwNzQ4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528607488", "bodyText": "Fixed.", "author": "chiranSachintha", "createdAt": "2020-11-23T10:36:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxMzMwMw=="}], "type": "inlineReview"}, {"oid": "d458ede7b0e4837d82fef679575f7355cde846e3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d458ede7b0e4837d82fef679575f7355cde846e3", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into issue-26545", "committedDate": "2020-11-20T12:12:03Z", "type": "commit"}, {"oid": "b775c465099c335291dc77e369614394c1a875e0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b775c465099c335291dc77e369614394c1a875e0", "message": "Fix review suggestions", "committedDate": "2020-11-23T10:35:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1NDgyMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528754820", "bodyText": "Shall we define a private final variable for new BMapType(TypeConstants.MAP_TNAME, ANYDATA_OR_READONLY, EMPTY_MODULE) and use that in these two types?", "author": "MaryamZi", "createdAt": "2020-11-23T14:46:59Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/api/PredefinedTypes.java", "diffHunk": "@@ -164,9 +164,10 @@\n     public static final ServiceType TYPE_ANY_SERVICE = new BServiceType(TypeConstants.SERVICE, EMPTY_MODULE, 0);\n     public static final HandleType TYPE_HANDLE = new BHandleType(TypeConstants.HANDLE_TNAME, EMPTY_MODULE);\n     public static final UnionType ANYDATA_OR_READONLY = new BUnionType(Arrays.asList(TYPE_ANYDATA, TYPE_READONLY));\n-    public static final MapType TYPE_ERROR_DETAIL = new BMapType(TypeConstants.MAP_TNAME, ANYDATA_OR_READONLY,\n-                                                                 EMPTY_MODULE);\n-    public static final ErrorType TYPE_ERROR = new BErrorType(TypeConstants.ERROR, EMPTY_MODULE, TYPE_ERROR_DETAIL);\n+    public static final Type TYPE_ERROR_DETAIL = ReadOnlyUtils.setImmutableTypeAndGetEffectiveType(\n+                                            new BMapType(TypeConstants.MAP_TNAME, ANYDATA_OR_READONLY, EMPTY_MODULE));", "originalCommit": "b775c465099c335291dc77e369614394c1a875e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgwNjA4NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528806084", "bodyText": "Fixed.", "author": "chiranSachintha", "createdAt": "2020-11-23T15:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1NDgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1NzI0Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528757246", "bodyText": "Shall we extract e.getMessage() and e.getCause() out to variables?", "author": "MaryamZi", "createdAt": "2020-11-23T14:50:16Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/internal/ErrorUtils.java", "diffHunk": "@@ -50,14 +51,28 @@\n      * @return ballerina error\n      */\n     public static ErrorValue createInteropError(Throwable e) {\n-        BMap<BString, Object> detailMap = new MapValueImpl<>(PredefinedTypes.TYPE_ERROR_DETAIL);\n-        if (e.getMessage() != null) {\n-            detailMap.put(ERROR_MESSAGE_FIELD, StringUtils.fromString(e.getMessage()));\n-        }\n-        if (e.getCause() != null) {\n-            detailMap.put(ERROR_CAUSE_FIELD, createError(StringUtils.fromString(e.getCause().getClass().getName()),\n-                                                         StringUtils.fromString(e.getCause().getMessage())));\n+        MappingInitialValueEntry[] initialValues;\n+        if (e.getMessage() != null && e.getCause() != null) {", "originalCommit": "b775c465099c335291dc77e369614394c1a875e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgwNTk3Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528805973", "bodyText": "Fixed", "author": "chiranSachintha", "createdAt": "2020-11-23T15:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1NzI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1OTgxMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528759812", "bodyText": "Wouldn't this lead to the same issue where the entry becomes null?", "author": "MaryamZi", "createdAt": "2020-11-23T14:53:42Z", "path": "bvm/ballerina-runtime/src/main/java/io/ballerina/runtime/api/creators/ErrorCreator.java", "diffHunk": "@@ -105,11 +101,11 @@ public static BError createError(Type type, BString message, BError cause, BMap<\n      * @return new error\n      */\n     public static BError createError(Type type, BString message, BString details) {\n-        MapValueImpl<BString, Object> detailMap =\n-                new MapValueImpl<>(setImmutableTypeAndGetEffectiveType(PredefinedTypes.TYPE_ERROR_DETAIL));\n+        MappingInitialValueEntry[] initialValues = new MappingInitialValueEntry[1];", "originalCommit": "b775c465099c335291dc77e369614394c1a875e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgwNTc3MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528805771", "bodyText": "In here for java exceptions like UnsupportedOperationException, the detail message become null.  But when considering the ballerina error values I think detail cannot become null. I kept the null check for detail value as it was in that manner previously", "author": "chiranSachintha", "createdAt": "2020-11-23T15:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1OTgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgwODc5OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528808799", "bodyText": "Wouldn't the iteration fail in io.ballerina.runtime.internal.values.MapValueImpl#populateInitialValues? If details is null?", "author": "MaryamZi", "createdAt": "2020-11-23T15:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1OTgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg0NTAxOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26992#discussion_r528845018", "bodyText": "It can happen. I have changed this in above mentioned way.", "author": "chiranSachintha", "createdAt": "2020-11-23T16:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc1OTgxMg=="}], "type": "inlineReview"}, {"oid": "596d02e5f328bc44bd7b8db15f9afeaf8ea3a587", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/596d02e5f328bc44bd7b8db15f9afeaf8ea3a587", "message": "Fix review suggestions", "committedDate": "2020-11-23T15:36:36Z", "type": "commit"}, {"oid": "c076fc9c878311dea65f8fce771dfcda3ef74a70", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c076fc9c878311dea65f8fce771dfcda3ef74a70", "message": "Fix review suggestions", "committedDate": "2020-11-23T16:45:13Z", "type": "commit"}, {"oid": "c076fc9c878311dea65f8fce771dfcda3ef74a70", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c076fc9c878311dea65f8fce771dfcda3ef74a70", "message": "Fix review suggestions", "committedDate": "2020-11-23T16:45:13Z", "type": "forcePushed"}]}