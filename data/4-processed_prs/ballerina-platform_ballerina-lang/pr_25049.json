{"pr_number": 25049, "pr_title": "Optimize use of local variables use in BIR", "pr_createdAt": "2020-07-30T11:04:38Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049", "timeline": [{"oid": "9d6431df15e99551191b99425719b10bdce2102f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9d6431df15e99551191b99425719b10bdce2102f", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-07-31T12:01:08Z", "type": "forcePushed"}, {"oid": "4b27c786bb39bcc53a4ed03f34885100bab115c8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4b27c786bb39bcc53a4ed03f34885100bab115c8", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-07-31T12:10:17Z", "type": "forcePushed"}, {"oid": "f37af48e7e7bd0a47dc1d00661616fe8c2ef451b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f37af48e7e7bd0a47dc1d00661616fe8c2ef451b", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-04T04:53:45Z", "type": "forcePushed"}, {"oid": "337cf4f73495b3f0347ded5d5741908b591ef66c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/337cf4f73495b3f0347ded5d5741908b591ef66c", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-04T05:06:10Z", "type": "forcePushed"}, {"oid": "18ae3d8b91f09442a0863e4aa2b8d6bf2cf98822", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/18ae3d8b91f09442a0863e4aa2b8d6bf2cf98822", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-06T05:57:19Z", "type": "forcePushed"}, {"oid": "c1bc59f8431e15bf671c9ae88d3e4f4d29d2f7ea", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c1bc59f8431e15bf671c9ae88d3e4f4d29d2f7ea", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-06T09:27:23Z", "type": "forcePushed"}, {"oid": "27e27c9de233b7b1f91174c772e02b851ee40241", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/27e27c9de233b7b1f91174c772e02b851ee40241", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-07T05:19:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMDIzNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r468700234", "bodyText": "isn't it better to use \"this.variableOptimizer\" here? I always find it to be readable within a constructor", "author": "Kishanthan", "createdAt": "2020-08-11T16:13:44Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/optimizer/BIROptimizer.java", "diffHunk": "@@ -67,6 +68,7 @@ private BIROptimizer(CompilerContext context) {\n         this.rhsTempVarOptimizer = new RHSTempVarOptimizer();\n         this.lhsTempVarOptimizer = new LHSTempVarOptimizer();\n         this.lockOptimizer = new BIRLockOptimizer();\n+        variableOptimizer = new BirVariableOptimizer();", "originalCommit": "27e27c9de233b7b1f91174c772e02b851ee40241", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzODU2Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r468938566", "bodyText": "For me it does not add more clarity(only more code) because already the IDE colors the global parameters differently so it is not at all hard to differentiate. I use this sparingly and only when needed.\nI think it is a personal preference if it is not enforced. (https://stackoverflow.com/questions/5944382/is-it-clearer-to-always-use-this-or-only-when-necessary)", "author": "riyafa", "createdAt": "2020-08-12T00:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMDIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MjIwNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r468992206", "bodyText": "However, if you look at the code above, we have followed a practice. The code you have added follows another practice. Isn't better to follow one single practice throughout?", "author": "Kishanthan", "createdAt": "2020-08-12T04:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMDIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxOTM2Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r469019367", "bodyText": "ack", "author": "riyafa", "createdAt": "2020-08-12T05:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMDIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAyMjAxNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r469022017", "bodyText": "I would prefer without this for all \ud83d\ude42", "author": "riyafa", "createdAt": "2020-08-12T05:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMDIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5Mzc1NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r468993755", "bodyText": "shall we first return if lhsOp is null ?", "author": "Kishanthan", "createdAt": "2020-08-12T04:10:39Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/optimizer/BirVariableOptimizer.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.wso2.ballerinalang.compiler.bir.optimizer;\n+\n+import org.wso2.ballerinalang.compiler.bir.model.BIRAbstractInstruction;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n+import org.wso2.ballerinalang.compiler.bir.model.BIROperand;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRTerminator;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRVisitor;\n+import org.wso2.ballerinalang.compiler.bir.model.InstructionKind;\n+import org.wso2.ballerinalang.compiler.bir.model.VarKind;\n+import org.wso2.ballerinalang.compiler.semantics.model.types.BType;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Optimize variables by reusing temporary variables of the same type.\n+ *\n+ * @since 1.2.1\n+ */\n+public class BirVariableOptimizer extends BIRVisitor {\n+    public void optimizeNode(BIRNode node) {\n+        node.accept(this);\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRPackage birPackage) {\n+        birPackage.typeDefs.forEach(tDef -> tDef.accept(this));\n+        birPackage.functions.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRTypeDefinition birTypeDefinition) {\n+        birTypeDefinition.attachedFuncs.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRFunction birFunction) {\n+        ControlFlowGraph graph = new ControlFlowGraph(birFunction);\n+        LivenessAnalyzer analyzer = new LivenessAnalyzer(graph.getNodes());\n+        Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts = analyzer.getInstructionLiveOuts();\n+        List<BIRNode.BIRVariableDcl> unusedVars = new ArrayList<>();\n+        reuseVars(liveOuts, unusedVars, birFunction);\n+        unusedVars.forEach(var -> birFunction.localVars.remove(var));\n+    }\n+\n+    private void reuseVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                           List<BIRNode.BIRVariableDcl> unusedVars, BIRNode.BIRFunction birFunction) {\n+        List<BIRAbstractInstruction> instructionList = getInstructionList(birFunction);\n+        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars = new HashMap<>();\n+        for (int i = 0; i < instructionList.size(); i++) {\n+            if (instructionList.get(i).getKind() == InstructionKind.XML_SEQ_STORE) {\n+                continue;\n+            }\n+            tryToReuseFromFreeVars(liveOuts, freeVars, instructionList, i, unusedVars);\n+            checkForFreeVars(freeVars, liveOuts, instructionList.get(i));\n+        }\n+    }\n+\n+    private void checkForFreeVars(Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                  Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                  BIRAbstractInstruction instruction) {\n+        for (BIROperand operand : instruction.getRhsOperands()) {\n+            BType type = operand.variableDcl.type;\n+            if (operand.variableDcl.kind == VarKind.TEMP && !liveOuts.get(instruction).contains(operand.variableDcl)) {\n+                if (!freeVars.containsKey(type)) {\n+                    freeVars.put(type, new LinkedList<>());\n+                }\n+                LinkedList<BIRNode.BIRVariableDcl> ls = freeVars.get(type);\n+                ls.add(operand.variableDcl);\n+            }\n+        }\n+    }\n+\n+    private void tryToReuseFromFreeVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                        List<BIRAbstractInstruction> instructionList, int idx,\n+                                        List<BIRNode.BIRVariableDcl> unusedVars) {\n+        BIRAbstractInstruction instruction = instructionList.get(idx);\n+        if (instruction.lhsOp != null) {", "originalCommit": "27e27c9de233b7b1f91174c772e02b851ee40241", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MzkwMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r468993901", "bodyText": "and same here, shall we retunr if defLs is null or empty?", "author": "Kishanthan", "createdAt": "2020-08-12T04:11:25Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/optimizer/BirVariableOptimizer.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.wso2.ballerinalang.compiler.bir.optimizer;\n+\n+import org.wso2.ballerinalang.compiler.bir.model.BIRAbstractInstruction;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n+import org.wso2.ballerinalang.compiler.bir.model.BIROperand;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRTerminator;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRVisitor;\n+import org.wso2.ballerinalang.compiler.bir.model.InstructionKind;\n+import org.wso2.ballerinalang.compiler.bir.model.VarKind;\n+import org.wso2.ballerinalang.compiler.semantics.model.types.BType;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Optimize variables by reusing temporary variables of the same type.\n+ *\n+ * @since 1.2.1\n+ */\n+public class BirVariableOptimizer extends BIRVisitor {\n+    public void optimizeNode(BIRNode node) {\n+        node.accept(this);\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRPackage birPackage) {\n+        birPackage.typeDefs.forEach(tDef -> tDef.accept(this));\n+        birPackage.functions.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRTypeDefinition birTypeDefinition) {\n+        birTypeDefinition.attachedFuncs.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRFunction birFunction) {\n+        ControlFlowGraph graph = new ControlFlowGraph(birFunction);\n+        LivenessAnalyzer analyzer = new LivenessAnalyzer(graph.getNodes());\n+        Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts = analyzer.getInstructionLiveOuts();\n+        List<BIRNode.BIRVariableDcl> unusedVars = new ArrayList<>();\n+        reuseVars(liveOuts, unusedVars, birFunction);\n+        unusedVars.forEach(var -> birFunction.localVars.remove(var));\n+    }\n+\n+    private void reuseVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                           List<BIRNode.BIRVariableDcl> unusedVars, BIRNode.BIRFunction birFunction) {\n+        List<BIRAbstractInstruction> instructionList = getInstructionList(birFunction);\n+        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars = new HashMap<>();\n+        for (int i = 0; i < instructionList.size(); i++) {\n+            if (instructionList.get(i).getKind() == InstructionKind.XML_SEQ_STORE) {\n+                continue;\n+            }\n+            tryToReuseFromFreeVars(liveOuts, freeVars, instructionList, i, unusedVars);\n+            checkForFreeVars(freeVars, liveOuts, instructionList.get(i));\n+        }\n+    }\n+\n+    private void checkForFreeVars(Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                  Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                  BIRAbstractInstruction instruction) {\n+        for (BIROperand operand : instruction.getRhsOperands()) {\n+            BType type = operand.variableDcl.type;\n+            if (operand.variableDcl.kind == VarKind.TEMP && !liveOuts.get(instruction).contains(operand.variableDcl)) {\n+                if (!freeVars.containsKey(type)) {\n+                    freeVars.put(type, new LinkedList<>());\n+                }\n+                LinkedList<BIRNode.BIRVariableDcl> ls = freeVars.get(type);\n+                ls.add(operand.variableDcl);\n+            }\n+        }\n+    }\n+\n+    private void tryToReuseFromFreeVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                        List<BIRAbstractInstruction> instructionList, int idx,\n+                                        List<BIRNode.BIRVariableDcl> unusedVars) {\n+        BIRAbstractInstruction instruction = instructionList.get(idx);\n+        if (instruction.lhsOp != null) {\n+            BType type = instruction.lhsOp.variableDcl.type;\n+            LinkedList<BIRNode.BIRVariableDcl> defLs = freeVars.get(type);\n+            if (defLs != null && !defLs.isEmpty()) {", "originalCommit": "27e27c9de233b7b1f91174c772e02b851ee40241", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5NTA4OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r468995089", "bodyText": "what is idx here?", "author": "Kishanthan", "createdAt": "2020-08-12T04:16:02Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/optimizer/BirVariableOptimizer.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.wso2.ballerinalang.compiler.bir.optimizer;\n+\n+import org.wso2.ballerinalang.compiler.bir.model.BIRAbstractInstruction;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n+import org.wso2.ballerinalang.compiler.bir.model.BIROperand;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRTerminator;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRVisitor;\n+import org.wso2.ballerinalang.compiler.bir.model.InstructionKind;\n+import org.wso2.ballerinalang.compiler.bir.model.VarKind;\n+import org.wso2.ballerinalang.compiler.semantics.model.types.BType;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Optimize variables by reusing temporary variables of the same type.\n+ *\n+ * @since 1.2.1\n+ */\n+public class BirVariableOptimizer extends BIRVisitor {\n+    public void optimizeNode(BIRNode node) {\n+        node.accept(this);\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRPackage birPackage) {\n+        birPackage.typeDefs.forEach(tDef -> tDef.accept(this));\n+        birPackage.functions.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRTypeDefinition birTypeDefinition) {\n+        birTypeDefinition.attachedFuncs.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRFunction birFunction) {\n+        ControlFlowGraph graph = new ControlFlowGraph(birFunction);\n+        LivenessAnalyzer analyzer = new LivenessAnalyzer(graph.getNodes());\n+        Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts = analyzer.getInstructionLiveOuts();\n+        List<BIRNode.BIRVariableDcl> unusedVars = new ArrayList<>();\n+        reuseVars(liveOuts, unusedVars, birFunction);\n+        unusedVars.forEach(var -> birFunction.localVars.remove(var));\n+    }\n+\n+    private void reuseVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                           List<BIRNode.BIRVariableDcl> unusedVars, BIRNode.BIRFunction birFunction) {\n+        List<BIRAbstractInstruction> instructionList = getInstructionList(birFunction);\n+        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars = new HashMap<>();\n+        for (int i = 0; i < instructionList.size(); i++) {\n+            if (instructionList.get(i).getKind() == InstructionKind.XML_SEQ_STORE) {\n+                continue;\n+            }\n+            tryToReuseFromFreeVars(liveOuts, freeVars, instructionList, i, unusedVars);\n+            checkForFreeVars(freeVars, liveOuts, instructionList.get(i));\n+        }\n+    }\n+\n+    private void checkForFreeVars(Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                  Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                  BIRAbstractInstruction instruction) {\n+        for (BIROperand operand : instruction.getRhsOperands()) {\n+            BType type = operand.variableDcl.type;\n+            if (operand.variableDcl.kind == VarKind.TEMP && !liveOuts.get(instruction).contains(operand.variableDcl)) {\n+                if (!freeVars.containsKey(type)) {\n+                    freeVars.put(type, new LinkedList<>());\n+                }\n+                LinkedList<BIRNode.BIRVariableDcl> ls = freeVars.get(type);\n+                ls.add(operand.variableDcl);\n+            }\n+        }\n+    }\n+\n+    private void tryToReuseFromFreeVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                        List<BIRAbstractInstruction> instructionList, int idx,\n+                                        List<BIRNode.BIRVariableDcl> unusedVars) {\n+        BIRAbstractInstruction instruction = instructionList.get(idx);\n+        if (instruction.lhsOp != null) {\n+            BType type = instruction.lhsOp.variableDcl.type;\n+            LinkedList<BIRNode.BIRVariableDcl> defLs = freeVars.get(type);\n+            if (defLs != null && !defLs.isEmpty()) {\n+                BIRNode.BIRVariableDcl newLhsOp = defLs.peek();\n+                BIRNode.BIRVariableDcl oldLhsOp = (instruction).lhsOp.variableDcl;\n+                if (oldLhsOp.kind == VarKind.TEMP && !checkVarUse(instruction, oldLhsOp)) {\n+                    defLs.remove();\n+                    unusedVars.add(oldLhsOp);\n+                    replaceOldOp(instructionList, idx, oldLhsOp, newLhsOp, liveOuts);\n+                    instruction.lhsOp.variableDcl = newLhsOp;\n+                }\n+            }\n+\n+        }\n+    }\n+\n+    private void replaceOldOp(List<BIRAbstractInstruction> ls, int idx, BIRNode.BIRVariableDcl oldLhsOp,", "originalCommit": "27e27c9de233b7b1f91174c772e02b851ee40241", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5NTIxNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r468995216", "bodyText": "and we should use proper name for \"ls\" here.", "author": "Kishanthan", "createdAt": "2020-08-12T04:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5NTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAyMTYyMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r469021620", "bodyText": "idx is the index, I have renamed if unclear", "author": "riyafa", "createdAt": "2020-08-12T05:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5NTA4OQ=="}], "type": "inlineReview"}, {"oid": "0007f770fd5eec0eb3243a7b1320ff0080af6ff9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0007f770fd5eec0eb3243a7b1320ff0080af6ff9", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-12T05:56:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAyMzQyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r469023425", "bodyText": "can we reverse this if and continue the loop?", "author": "Kishanthan", "createdAt": "2020-08-12T06:02:47Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/optimizer/BirVariableOptimizer.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.wso2.ballerinalang.compiler.bir.optimizer;\n+\n+import org.wso2.ballerinalang.compiler.bir.model.BIRAbstractInstruction;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n+import org.wso2.ballerinalang.compiler.bir.model.BIROperand;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRTerminator;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRVisitor;\n+import org.wso2.ballerinalang.compiler.bir.model.InstructionKind;\n+import org.wso2.ballerinalang.compiler.bir.model.VarKind;\n+import org.wso2.ballerinalang.compiler.semantics.model.types.BType;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Optimize variables by reusing temporary variables of the same type.\n+ *\n+ * @since 1.2.1\n+ */\n+public class BirVariableOptimizer extends BIRVisitor {\n+    public void optimizeNode(BIRNode node) {\n+        node.accept(this);\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRPackage birPackage) {\n+        birPackage.typeDefs.forEach(tDef -> tDef.accept(this));\n+        birPackage.functions.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRTypeDefinition birTypeDefinition) {\n+        birTypeDefinition.attachedFuncs.forEach(func -> func.accept(this));\n+    }\n+\n+    @Override\n+    public void visit(BIRNode.BIRFunction birFunction) {\n+        ControlFlowGraph graph = new ControlFlowGraph(birFunction);\n+        LivenessAnalyzer analyzer = new LivenessAnalyzer(graph.getNodes());\n+        Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts = analyzer.getInstructionLiveOuts();\n+        List<BIRNode.BIRVariableDcl> unusedVars = new ArrayList<>();\n+        reuseVars(liveOuts, unusedVars, birFunction);\n+        unusedVars.forEach(var -> birFunction.localVars.remove(var));\n+    }\n+\n+    private void reuseVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                           List<BIRNode.BIRVariableDcl> unusedVars, BIRNode.BIRFunction birFunction) {\n+        List<BIRAbstractInstruction> instructionList = getInstructionList(birFunction);\n+        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars = new HashMap<>();\n+        for (int i = 0; i < instructionList.size(); i++) {\n+            if (instructionList.get(i).getKind() == InstructionKind.XML_SEQ_STORE) {\n+                continue;\n+            }\n+            tryToReuseFromFreeVars(liveOuts, freeVars, instructionList, i, unusedVars);\n+            checkForFreeVars(freeVars, liveOuts, instructionList.get(i));\n+        }\n+    }\n+\n+    private void checkForFreeVars(Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                  Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                  BIRAbstractInstruction instruction) {\n+        for (BIROperand operand : instruction.getRhsOperands()) {\n+            BType type = operand.variableDcl.type;\n+            if (operand.variableDcl.kind == VarKind.TEMP && !liveOuts.get(instruction).contains(operand.variableDcl)) {\n+                if (!freeVars.containsKey(type)) {\n+                    freeVars.put(type, new LinkedList<>());\n+                }\n+                LinkedList<BIRNode.BIRVariableDcl> ls = freeVars.get(type);\n+                ls.add(operand.variableDcl);\n+            }\n+        }\n+    }\n+\n+    private void tryToReuseFromFreeVars(Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts,\n+                                        Map<BType, LinkedList<BIRNode.BIRVariableDcl>> freeVars,\n+                                        List<BIRAbstractInstruction> instructionList, int index,\n+                                        List<BIRNode.BIRVariableDcl> unusedVars) {\n+        BIRAbstractInstruction instruction = instructionList.get(index);\n+        if (instruction.lhsOp == null) {\n+            return;\n+        }\n+        BType type = instruction.lhsOp.variableDcl.type;\n+        LinkedList<BIRNode.BIRVariableDcl> defLs = freeVars.get(type);\n+        if (defLs == null || defLs.isEmpty()) {\n+            return;\n+        }\n+        BIRNode.BIRVariableDcl newLhsOp = defLs.peek();\n+        BIRNode.BIRVariableDcl oldLhsOp = (instruction).lhsOp.variableDcl;\n+        if (oldLhsOp.kind == VarKind.TEMP && !checkVarUse(instruction, oldLhsOp)) {\n+            defLs.remove();\n+            unusedVars.add(oldLhsOp);\n+            replaceOldOp(instructionList, index, oldLhsOp, newLhsOp, liveOuts);\n+            instruction.lhsOp.variableDcl = newLhsOp;\n+        }\n+    }\n+\n+    private void replaceOldOp(List<BIRAbstractInstruction> instructionList, int index, BIRNode.BIRVariableDcl oldLhsOp,\n+                              BIRNode.BIRVariableDcl newLhsOp,\n+                              Map<BIRAbstractInstruction, Set<BIRNode.BIRVariableDcl>> liveOuts) {\n+        for (int i = index + 1; i < instructionList.size(); i++) {\n+            BIRAbstractInstruction instruction = instructionList.get(i);\n+            boolean changed = false;\n+            BIROperand[] operands = instruction.getRhsOperands();\n+            for (BIROperand operand : operands) {\n+                if (operand.variableDcl == oldLhsOp) {\n+                    operand.variableDcl = newLhsOp;\n+                    changed = true;\n+                }\n+            }\n+\n+            if (changed) {", "originalCommit": "0007f770fd5eec0eb3243a7b1320ff0080af6ff9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f5c0a58c751665ad385ded28316766ceb7cb4ede", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f5c0a58c751665ad385ded28316766ceb7cb4ede", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-12T06:06:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5NjU5Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r469096597", "bodyText": "lets remove the version tag for now.", "author": "Kishanthan", "createdAt": "2020-08-12T08:34:05Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/optimizer/ControlFlowGraph.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.wso2.ballerinalang.compiler.bir.optimizer;\n+\n+import org.wso2.ballerinalang.compiler.bir.model.BIRAbstractInstruction;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRTerminator;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The control flow graph that gets created from the bir.\n+ *\n+ * @since 2.0.0", "originalCommit": "f5c0a58c751665ad385ded28316766ceb7cb4ede", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEzODQ3OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25049#discussion_r469138479", "bodyText": "remove this version tag too", "author": "Kishanthan", "createdAt": "2020-08-12T09:44:21Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/optimizer/BirVariableOptimizer.java", "diffHunk": "@@ -0,0 +1,240 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  WSO2 Inc. licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except\n+ *  in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing,\n+ *  software distributed under the License is distributed on an\n+ *  \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ *  KIND, either express or implied.  See the License for the\n+ *  specific language governing permissions and limitations\n+ *  under the License.\n+ */\n+\n+package org.wso2.ballerinalang.compiler.bir.optimizer;\n+\n+import org.wso2.ballerinalang.compiler.bir.model.BIRAbstractInstruction;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRNode;\n+import org.wso2.ballerinalang.compiler.bir.model.BIROperand;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRTerminator;\n+import org.wso2.ballerinalang.compiler.bir.model.BIRVisitor;\n+import org.wso2.ballerinalang.compiler.bir.model.InstructionKind;\n+import org.wso2.ballerinalang.compiler.bir.model.VarKind;\n+import org.wso2.ballerinalang.compiler.semantics.model.types.BType;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Optimize variables by reusing temporary variables of the same type.\n+ *\n+ * @since 1.2.1", "originalCommit": "f5c0a58c751665ad385ded28316766ceb7cb4ede", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d179c440f0daba0ec77712a39c49fe627c2ff36", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6d179c440f0daba0ec77712a39c49fe627c2ff36", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-12T09:50:57Z", "type": "forcePushed"}, {"oid": "f44c381089a4507ddc494be60422ff097861f01c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f44c381089a4507ddc494be60422ff097861f01c", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-12T10:53:48Z", "type": "commit"}, {"oid": "f44c381089a4507ddc494be60422ff097861f01c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f44c381089a4507ddc494be60422ff097861f01c", "message": "Optimize use of local variables use in BIR\n\nThe controlflow graph is created from the BIR and liveness analysis is performed on it. The resulting liveOut values of each instruction is used to optimize the BIR.\n\nResolve https://github.com/ballerina-platform/ballerina-lang/issues/24775 and https://github.com/ballerina-platform/ballerina-lang/issues/23914", "committedDate": "2020-08-12T10:53:48Z", "type": "forcePushed"}]}