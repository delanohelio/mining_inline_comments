{"pr_number": 26465, "pr_title": "Change the formatter API to return an exception", "pr_createdAt": "2020-10-21T10:07:43Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465", "timeline": [{"oid": "b09a0e89472502eccfe0ef0e28d78efedbf57cfe", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b09a0e89472502eccfe0ef0e28d78efedbf57cfe", "message": "Return an exception from the formatter", "committedDate": "2020-10-21T12:39:32Z", "type": "commit"}, {"oid": "37bb184a127d8933d1fcf624c73dfe4d1aa42d06", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/37bb184a127d8933d1fcf624c73dfe4d1aa42d06", "message": "Fix formatting issue", "committedDate": "2020-10-21T12:39:32Z", "type": "commit"}, {"oid": "149a3e43fbb36de07a504c8eb3540e5fcf3bd25d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/149a3e43fbb36de07a504c8eb3540e5fcf3bd25d", "message": "Refactor the exception return in tests", "committedDate": "2020-10-21T12:39:32Z", "type": "commit"}, {"oid": "4ea6a6209c8b0c5033963f2967d1d217d4dca8ab", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4ea6a6209c8b0c5033963f2967d1d217d4dca8ab", "message": "Handle formatting exception in range formatting", "committedDate": "2020-10-21T12:39:32Z", "type": "commit"}, {"oid": "980057402b4e3efb131dade1554bf7e490c232db", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/980057402b4e3efb131dade1554bf7e490c232db", "message": "Refactor the exception handling in formatter cli", "committedDate": "2020-10-21T12:39:32Z", "type": "commit"}, {"oid": "17830fabc72f7290c994367f20add65fa681368e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/17830fabc72f7290c994367f20add65fa681368e", "message": "Add the since annotation", "committedDate": "2020-10-21T12:39:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwNjk1OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r510106959", "bodyText": "Does e.getMessage() always return the source name? Otherwise let's change the exception message", "author": "nadeeshaan", "createdAt": "2020-10-22T12:07:17Z", "path": "misc/formatter/modules/formatter-core/src/main/java/org/ballerinalang/formatter/core/Formatter.java", "diffHunk": "@@ -94,19 +96,20 @@ public static SyntaxTree format(SyntaxTree syntaxTree, LineRange range, Formatti\n      * @param syntaxTree The SyntaxTree which is to be formatted\n      * @param options Formatting options that are to be used when formatting\n      * @return The modified SyntaxTree after formatting changes\n+     * @throws FormatterException Exception caught while formatting\n      */\n-    public static SyntaxTree format(SyntaxTree syntaxTree, FormattingOptions options) {\n+    public static SyntaxTree format(SyntaxTree syntaxTree, FormattingOptions options) throws FormatterException {\n         return modifyTree(syntaxTree, options, null);\n     }\n \n-    private static SyntaxTree modifyTree(SyntaxTree syntaxTree, FormattingOptions options, LineRange range) {\n+    private static SyntaxTree modifyTree(SyntaxTree syntaxTree, FormattingOptions options, LineRange range)\n+            throws FormatterException {\n         FormattingTreeModifier treeModifier = new FormattingTreeModifier(options, range);\n         ModulePartNode modulePartNode = syntaxTree.rootNode();\n         try {\n             return syntaxTree.modifyWith(treeModifier.transform(modulePartNode));\n         } catch (Exception e) {\n-            LOGGER.error(String.format(\"Error while formatting the source: %s\", e.getMessage()));\n-            return syntaxTree;\n+            throw new FormatterException(\"Error while formatting the source: \" + e.getMessage(), e.getCause());", "originalCommit": "51d8b8e78835830fbd6ee4d6635f2f3fc91f2833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2MzkzMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r512463931", "bodyText": "Fixed", "author": "IrushiL", "createdAt": "2020-10-27T07:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwNjk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwODAxOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r510108018", "bodyText": "Are we going to add test cases for these particular negative cases or just ignore them? If ignoring let's remove the commented code", "author": "nadeeshaan", "createdAt": "2020-10-22T12:09:10Z", "path": "misc/formatter/modules/formatter-core/src/test/java/org/ballerinalang/formatter/core/FormatterTest.java", "diffHunk": "@@ -59,8 +59,13 @@ public void test(String source, String sourcePath) throws IOException {\n         String content = getSourceText(sourceFilePath);\n         TextDocument textDocument = TextDocuments.from(content);\n         SyntaxTree syntaxTree = SyntaxTree.from(textDocument);\n-        SyntaxTree newSyntaxTree = Formatter.format(syntaxTree);\n-        Assert.assertEquals(newSyntaxTree.toSourceCode(), getSourceText(assertFilePath));\n+        try {\n+            SyntaxTree newSyntaxTree = Formatter.format(syntaxTree);\n+            Assert.assertEquals(newSyntaxTree.toSourceCode(), getSourceText(assertFilePath));\n+        } catch (FormatterException e) {\n+            // TODO: handle the test cases causing formatting exceptions\n+//            Assert.fail(e.getMessage(), e);", "originalCommit": "51d8b8e78835830fbd6ee4d6635f2f3fc91f2833", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDYxMTA1OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r510611059", "bodyText": "These test cases should ideally be enabled since these are scenarios with no diagnostic issues (positive test cases).\nBut at the moment these are failing due to some parser issues which are yet to be fixed. Once those are fixed this can be enabled, and ideally, these test cases shouldn't fail.", "author": "IrushiL", "createdAt": "2020-10-23T05:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwODAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ4NzU1Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r512487556", "bodyText": "I think its better to fail the test here and disable any-failing tests, if there are issues from the parser.\nOtherwise, any newly failing test would go un-noticed .\nIn the git-issue, we can ask to enable the formatter test as well, once fixed.", "author": "SupunS", "createdAt": "2020-10-27T08:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwODAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI0MTM5NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r513241394", "bodyText": "Done", "author": "IrushiL", "createdAt": "2020-10-28T07:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwODAxOA=="}], "type": "inlineReview"}, {"oid": "dc15a08154385580417da33a4b79feb2a87e9635", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dc15a08154385580417da33a4b79feb2a87e9635", "message": "Fix the error message", "committedDate": "2020-10-27T07:24:23Z", "type": "commit"}, {"oid": "dc15a08154385580417da33a4b79feb2a87e9635", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dc15a08154385580417da33a4b79feb2a87e9635", "message": "Fix the error message", "committedDate": "2020-10-27T07:24:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ4NTY5Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r512485697", "bodyText": "Can directly use content here", "author": "SupunS", "createdAt": "2020-10-27T08:09:42Z", "path": "misc/formatter/modules/formatter-core/src/test/java/org/ballerinalang/formatter/core/FormatterTest.java", "diffHunk": "@@ -74,8 +79,13 @@ public void testParserResources(String sourcePath) throws IOException {\n         TextDocument textDocument = TextDocuments.from(content);\n         SyntaxTree syntaxTree = SyntaxTree.from(textDocument);\n         if (!syntaxTree.hasDiagnostics()) {\n-            SyntaxTree newSyntaxTree = Formatter.format(syntaxTree);\n-            Assert.assertEquals(newSyntaxTree.toSourceCode(), getSourceText(filePath));\n+            try {\n+                SyntaxTree newSyntaxTree = Formatter.format(syntaxTree);\n+                Assert.assertEquals(newSyntaxTree.toSourceCode(), getSourceText(filePath));", "originalCommit": "dc15a08154385580417da33a4b79feb2a87e9635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUzNTUyMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/26465#discussion_r512535520", "bodyText": "Done", "author": "IrushiL", "createdAt": "2020-10-27T09:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ4NTY5Nw=="}], "type": "inlineReview"}, {"oid": "9178fbfe10faf6fbff444c65769b7b4c938fc887", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9178fbfe10faf6fbff444c65769b7b4c938fc887", "message": "Fix review comment", "committedDate": "2020-10-27T09:29:19Z", "type": "commit"}, {"oid": "be2ca832a3e7a357e75214e0ead0c71ad2e2b15e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/be2ca832a3e7a357e75214e0ead0c71ad2e2b15e", "message": "Fix review comment", "committedDate": "2020-10-28T07:56:47Z", "type": "commit"}]}