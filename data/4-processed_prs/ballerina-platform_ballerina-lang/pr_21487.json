{"pr_number": 21487, "pr_title": "Block new strand generation within locks.", "pr_createdAt": "2020-03-05T06:13:50Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMTUzMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388331531", "bodyText": "Shall we validate the error message also?", "author": "MaryamZi", "createdAt": "2020-03-05T14:34:44Z", "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/worker/WorkerTest.java", "diffHunk": "@@ -347,4 +348,16 @@ public void waitInReturn() {\n         Assert.assertEquals(mapResult.get(\"w1\").stringValue(), \"w1\");\n         Assert.assertEquals(mapResult.get(\"w2\").stringValue(), \"w2\");\n     }\n+\n+    @Test(expectedExceptions = BLangRuntimeException.class)\n+    public void testFunctionWithWorkerInsideLock() {\n+        BValue[] returns = BRunUtil.invoke(result, \"testPanicWorkerInsideLock\");\n+    }\n+\n+    @Test\n+    public void testWorkerInsideLock() {\n+        CompileResult result = BCompileUtil.compile(\"test-src/workers/worker-in-lock.bal\");\n+        int index = 0;\n+        BAssertUtil.validateError(result, index++, 4, 20);", "originalCommit": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0NzQwMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388347402", "bodyText": "+1 will do", "author": "dulvinw", "createdAt": "2020-03-05T14:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMTUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMjM5Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388332396", "bodyText": "We can combine the checks right?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (lock != null) {\n          \n          \n            \n                        if (!lock.isLockFree()) {\n          \n          \n            \n                    if (lock != null && !lock.isLockFree()) {", "author": "MaryamZi", "createdAt": "2020-03-05T14:36:03Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BLockStore.java", "diffHunk": "@@ -40,9 +40,18 @@ public void addLockToMap(String lockName) {\n         globalLockMap.put(lockName, new BLock());\n     }\n \n-    public synchronized BLock getLockFromMap(String lockName) {\n+    public BLock getLockFromMap(String lockName) {\n         return globalLockMap.computeIfAbsent(lockName, (k) -> {\n             return new BLock();\n         });\n     }\n+\n+    public void panicIfInLock(String lockName) {\n+        BLock lock = globalLockMap.get(lockName);\n+        if (lock != null) {\n+            if (!lock.isLockFree()) {", "originalCommit": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMzMzMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388333332", "bodyText": "This method is only called in BLockStore.java right? Shall we move the method there?", "author": "MaryamZi", "createdAt": "2020-03-05T14:37:33Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "diffHunk": "@@ -162,6 +163,10 @@ public static ErrorValue createNumericConversionError(Object inputValue, BType i\n                 RuntimeErrors.INCOMPATIBLE_SIMPLE_TYPE_CONVERT_OPERATION, inputType, inputValue, targetType));\n     }\n \n+    public static ErrorValue createAsyncCallInsideLockError() {", "originalCommit": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzQwNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207407", "bodyText": "Fixed", "author": "dulvinw", "createdAt": "2020-03-10T10:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMzMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNDUyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388334525", "bodyText": "Shall we move this constant to BallerinaErrorReasons.java and prefix it with \"{ballerina}\"? (Check BallerinaErrorReasons for examples).\nAnd I guess we should suffix it with \"Error\"?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String ASYNC_CALL_INSIDE_LOCK = \"AsyncCallInsideLock\";\n          \n          \n            \n                public static final String ASYNC_CALL_INSIDE_LOCK = \"AsyncCallInsideLockError\";", "author": "MaryamZi", "createdAt": "2020-03-05T14:39:26Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BallerinaErrors.java", "diffHunk": "@@ -61,6 +61,7 @@\n     public static final String GENERATE_PKG_START = \"___start_\";\n     public static final String GENERATE_PKG_STOP = \"___stop_\";\n     public static final String GENERATE_OBJECT_CLASS_PREFIX = \".$value$\";\n+    public static final String ASYNC_CALL_INSIDE_LOCK = \"AsyncCallInsideLock\";", "originalCommit": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNzkzMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388337933", "bodyText": "Is it correct to do this for all action invocations too? They may or may not be async right?", "author": "MaryamZi", "createdAt": "2020-03-05T14:44:38Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,7 +2000,12 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {", "originalCommit": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0ODA2Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388348063", "bodyText": "I'll recheck and see.", "author": "dulvinw", "createdAt": "2020-03-05T14:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNzkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzI3MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207271", "bodyText": "Fixed", "author": "dulvinw", "createdAt": "2020-03-10T10:05:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzNzkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388340847", "bodyText": "Can we differentiate between this error being cause due to start vs named worker?\nShall we also reword this to something like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              usage of async call ''{0}'' inside of lock statment is prohibited\n          \n          \n            \n              cannot use an async call inside a lock statement\n          \n      \n    \n    \n  \n\nand\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              usage of async call ''{0}'' inside of lock statment is prohibited\n          \n          \n            \n              cannot use a named worker inside a lock statement\n          \n      \n    \n    \n  \n\n@hasithaa, @pubudu91, thoughts?\nThere's a typo in \"statment\" btw.", "author": "MaryamZi", "createdAt": "2020-03-05T14:49:07Z", "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "diffHunk": "@@ -20,6 +20,9 @@\n # Compiler warning messages\n # -------------------------\n \n+error.usage.of.async.call.within.lock.is.prohibited=\\\n+  usage of async call ''{0}'' inside of lock statment is prohibited", "originalCommit": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0Nzg5NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388347895", "bodyText": "In case of start the same thing should happen as well right?", "author": "dulvinw", "createdAt": "2020-03-05T14:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MTc5Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388681797", "bodyText": "+1 to reword. I think having two error messages is good.", "author": "hasithaa", "createdAt": "2020-03-06T02:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNjY5Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388716693", "bodyText": "will fix", "author": "dulvinw", "createdAt": "2020-03-06T05:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MDg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388341158", "bodyText": "Can we add a test for start too?", "author": "MaryamZi", "createdAt": "2020-03-05T14:49:34Z", "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/worker-in-lock.bal", "diffHunk": "@@ -0,0 +1,9 @@\n+function testWorkerInsideLock() {\n+    lock {\n+        fork {", "originalCommit": "ff7f7899cf2b2fb0cc7c9e1f7c400e3f8c8d7c51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0NzMyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388347325", "bodyText": "Will add", "author": "dulvinw", "createdAt": "2020-03-05T14:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MjEyMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388682120", "bodyText": "Also Add test case for nested fork statements.", "author": "hasithaa", "createdAt": "2020-03-06T02:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNjQ5Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388716496", "bodyText": "+1", "author": "dulvinw", "createdAt": "2020-03-06T05:13:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM0MTE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MTMwOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388681309", "bodyText": "Shouldn't this be a recursive check?", "author": "hasithaa", "createdAt": "2020-03-06T02:21:08Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/BLock.java", "diffHunk": "@@ -61,11 +61,11 @@ public synchronized void unlock() {\n         }\n     }\n \n-    private boolean isLockFree() {\n+    public boolean isLockFree() {\n         return this.current.isEmpty();\n     }\n \n-    private boolean lockedBySameContext(Strand ctx) {\n+    public boolean lockedBySameContext(Strand ctx) {\n         return this.current.getLast() == ctx;", "originalCommit": "bf71bd19285a6cde0dde76e424f751ca1a727577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNjQ1Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388716457", "bodyText": "Since we only create a new strand when we hit a worker or start, enough to check the current parent.", "author": "dulvinw", "createdAt": "2020-03-06T05:13:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MTMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MjIyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r388682221", "bodyText": "Make this work for multiple levels.", "author": "hasithaa", "createdAt": "2020-03-06T02:25:01Z", "path": "tests/jballerina-unit-test/src/test/resources/test-src/workers/workers.bal", "diffHunk": "@@ -542,3 +542,15 @@ function waitInReturn() returns any {\n \n     return wait {w1, w2};\n }\n+\n+function testPanicWorkerInsideLock() {\n+    lock {\n+        panicWorkerInsideLock();", "originalCommit": "bf71bd19285a6cde0dde76e424f751ca1a727577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzA4NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207084", "bodyText": "FIxed", "author": "dulvinw", "createdAt": "2020-03-10T10:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MjIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMDkxMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389230912", "bodyText": "A lock-stmt can be written inside another lock-stmt right? In that case, I think we should maintain the previous this.withinLockBlock before setting this.withinLockBlock to true at L1237 and reset the previous value here.\nOr something like the following may not fail?\nfunction testFunc() {\n    lock {\n        lock {\n            \n        }\n\n        fork {\n            worker w1 {\n                \n            }\n        }\n    }\n}", "author": "MaryamZi", "createdAt": "2020-03-07T05:45:41Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1232,9 +1233,10 @@ public void visit(BLangWhile whileNode) {\n     @Override\n     public void visit(BLangLock lockNode) {\n \n-        checkExperimentalFeatureValidity(ExperimentalFeatures.LOCK, lockNode.pos);\n         this.checkStatementExecutionValidity(lockNode);\n+        this.withinLockBlock = true;\n         lockNode.body.stmts.forEach(e -> analyzeNode(e, env));\n+        this.withinLockBlock = false;", "originalCommit": "19c003adb986f632f41df2424e569000e50905c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNzAwOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390207008", "bodyText": "Fixed", "author": "dulvinw", "createdAt": "2020-03-10T10:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMDkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMDk2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389230962", "bodyText": "Do we need a separate method?", "author": "MaryamZi", "createdAt": "2020-03-07T05:46:27Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }\n+        }\n+    }\n+\n+    private void logAsyncCallWithinLockError(BLangInvocation invocationExpr) {", "originalCommit": "19c003adb986f632f41df2424e569000e50905c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTAyNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389231027", "bodyText": "Shall we switch the checks and return early?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (invocationExpr.async && this.withinLockBlock) {\n          \n          \n            \n                            logAsyncCallWithinLockError(invocationExpr);\n          \n          \n            \n                        } else {\n          \n          \n            \n                            validateActionInvocation(invocationExpr.pos, invocationExpr);\n          \n          \n            \n                        }\n          \n          \n            \n                        if (!invocationExpr.async || !this.withinLockBlock) {\n          \n          \n            \n                            validateActionInvocation(invocationExpr.pos, invocationExpr);\n          \n          \n            \n                            return;\n          \n          \n            \n                        }\n          \n          \n            \n                        // log the error here", "author": "MaryamZi", "createdAt": "2020-03-07T05:48:18Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }", "originalCommit": "19c003adb986f632f41df2424e569000e50905c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjkxMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390206910", "bodyText": "Fixed", "author": "dulvinw", "createdAt": "2020-03-10T10:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTQ4Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r389231486", "bodyText": "We can simplify this using a ternary operator?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DiagnosticCode code;\n          \n          \n            \n            \n          \n          \n            \n                    if (invocationExpr.functionPointerInvocation) {\n          \n          \n            \n                        code = DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED;\n          \n          \n            \n                    } else {\n          \n          \n            \n                        code = DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED;\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    dlog.error(invocationExpr.pos, code);\n          \n          \n            \n                    dlog.error(invocationExpr.pos, invocationExpr.functionPointerInvocation ?  \n          \n          \n            \n                               DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED : \n          \n          \n            \n                               DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED);", "author": "MaryamZi", "createdAt": "2020-03-07T05:57:39Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -1998,8 +2000,24 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (invocationExpr.async && this.withinLockBlock) {\n+                logAsyncCallWithinLockError(invocationExpr);\n+            } else {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            }\n+        }\n+    }\n+\n+    private void logAsyncCallWithinLockError(BLangInvocation invocationExpr) {\n+        DiagnosticCode code;\n+\n+        if (invocationExpr.functionPointerInvocation) {\n+            code = DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED;\n+        } else {\n+            code = DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED;\n         }\n+\n+        dlog.error(invocationExpr.pos, code);", "originalCommit": "19c003adb986f632f41df2424e569000e50905c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjgwMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390206802", "bodyText": "Fixed", "author": "dulvinw", "createdAt": "2020-03-10T10:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTQ4Ng=="}], "type": "inlineReview"}, {"oid": "64a667ba7e08bd7c0d3d781bac57cf6772ef43dc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/64a667ba7e08bd7c0d3d781bac57cf6772ef43dc", "message": "Backend changes completed", "committedDate": "2020-03-10T06:52:29Z", "type": "commit"}, {"oid": "61e4b2cf72849c16f7b0ad6240ef75fcb0f0ab09", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/61e4b2cf72849c16f7b0ad6240ef75fcb0f0ab09", "message": "Fix codeanalyzer for identifying asyncalls within locks in compile time", "committedDate": "2020-03-10T06:52:29Z", "type": "commit"}, {"oid": "553b9c0dd42d25a0bcbede4c583d2bfc675404b7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/553b9c0dd42d25a0bcbede4c583d2bfc675404b7", "message": "Fix unit testcases", "committedDate": "2020-03-10T06:52:29Z", "type": "commit"}, {"oid": "661b59bbd0ecb69b745b2fc0e8291d707a8af579", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/661b59bbd0ecb69b745b2fc0e8291d707a8af579", "message": "Fix checkstyle Issue", "committedDate": "2020-03-10T06:52:30Z", "type": "commit"}, {"oid": "16ab7b8ce3556b98ad050fabfda86990c61fe661", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/16ab7b8ce3556b98ad050fabfda86990c61fe661", "message": "Change throwing logic and revert unncessary bal files", "committedDate": "2020-03-10T06:52:30Z", "type": "commit"}, {"oid": "e6e7a1dda8f7a75fc49b3434d169ba89f8af3293", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e6e7a1dda8f7a75fc49b3434d169ba89f8af3293", "message": "Fix review suggestions", "committedDate": "2020-03-10T06:52:30Z", "type": "commit"}, {"oid": "4725ee69896209987b42755e14958c68f12a5641", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4725ee69896209987b42755e14958c68f12a5641", "message": "Fix review suggestions", "committedDate": "2020-03-10T06:52:30Z", "type": "commit"}, {"oid": "4725ee69896209987b42755e14958c68f12a5641", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4725ee69896209987b42755e14958c68f12a5641", "message": "Fix review suggestions", "committedDate": "2020-03-10T06:52:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MDMzMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390150330", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (!invocationExpr.async || !this.withinLockBlock) {\n          \n          \n            \n                        if (invocationExpr.actionInvocation || !this.withinLockBlock) {", "author": "MaryamZi", "createdAt": "2020-03-10T08:18:30Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -2000,7 +2003,14 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (!invocationExpr.async || !this.withinLockBlock) {", "originalCommit": "642b4610edc44cb14579c96e97368e3c1d21ee83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIwNjczMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390206730", "bodyText": "Fixed", "author": "dulvinw", "createdAt": "2020-03-10T10:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MDMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1MDU0OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21487#discussion_r390150549", "bodyText": "Shall we indent these two lines to align with the beginning of invocationExpr.pos?", "author": "MaryamZi", "createdAt": "2020-03-10T08:19:01Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -2000,7 +2003,14 @@ public void visit(BLangInvocation invocationExpr) {\n         }\n \n         if (invocationExpr.actionInvocation || invocationExpr.async) {\n-            validateActionInvocation(invocationExpr.pos, invocationExpr);\n+            if (!invocationExpr.async || !this.withinLockBlock) {\n+                validateActionInvocation(invocationExpr.pos, invocationExpr);\n+                return;\n+            }\n+\n+            dlog.error(invocationExpr.pos, invocationExpr.functionPointerInvocation ? \n+            DiagnosticCode.USAGE_OF_WORKER_WITHIN_LOCK_IS_PROHIBITED : \n+            DiagnosticCode.USAGE_OF_START_WITHIN_LOCK_IS_PROHIBITED);", "originalCommit": "642b4610edc44cb14579c96e97368e3c1d21ee83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f1e5eb6e4d054bc818f71e25e274951fd341c86b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f1e5eb6e4d054bc818f71e25e274951fd341c86b", "message": "Fix review suggestions", "committedDate": "2020-03-10T08:41:30Z", "type": "forcePushed"}, {"oid": "73a27b8abc638044d10051166563f13e6a0abf4d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/73a27b8abc638044d10051166563f13e6a0abf4d", "message": "Fix review suggestions", "committedDate": "2020-03-10T08:42:49Z", "type": "commit"}, {"oid": "73a27b8abc638044d10051166563f13e6a0abf4d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/73a27b8abc638044d10051166563f13e6a0abf4d", "message": "Fix review suggestions", "committedDate": "2020-03-10T08:42:49Z", "type": "forcePushed"}]}