{"pr_number": 20862, "pr_title": "Optimize \"ballerina run\" command execution flow", "pr_createdAt": "2020-02-05T08:17:17Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862", "timeline": [{"oid": "317146dcc2380f456c4ae6b0e508c4cb2128083e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/317146dcc2380f456c4ae6b0e508c4cb2128083e", "message": "Exclude uber jar creation phase from \"ballerina run\" command execution flow", "committedDate": "2020-02-02T10:29:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE1NDIwMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862#discussion_r375154201", "bodyText": "You can use StringJoiner with File.pathSeparator here.\nStringJoiner joiner = new StringJoiner(File.pathSeparator);", "author": "rasika", "createdAt": "2020-02-05T09:50:28Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/RunExecutableTask.java", "diffHunk": "@@ -207,15 +195,16 @@ private void runGeneratedExecutableWithSameClassLoader(BLangPackage executableMo\n         }\n     }\n \n-    private static String getClassPath(ExecutableJar jar) {\n-        String seperator = \":\";\n-        if (OsUtils.isWindows()) {\n-            seperator = \";\";\n-        }\n-        StringBuilder classPath = new StringBuilder(jar.moduleJar.toString());\n-        for (Path path : jar.platformLibs) {\n-            classPath.append(seperator).append(path);\n-        }\n-        return classPath.toString();\n+    private String getAllClassPaths(BLangPackage executableModule, BuildContext buildContext) {\n+        // Since classpath separator depends on the OS type\n+        String separator = OsUtils.isWindows() ? \";\" : \":\";\n+        StringBuilder cp = new StringBuilder();", "originalCommit": "317146dcc2380f456c4ae6b0e508c4cb2128083e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIwMjU4Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862#discussion_r375202586", "bodyText": "@rasika That's a good suggestion! I did a rough timing analysis for both approaches and StringJoiner is slighly faster than StringBuilder in here. Thanks for pointing that out :)", "author": "NipunaRanasinghe", "createdAt": "2020-02-05T11:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE1NDIwMQ=="}], "type": "inlineReview"}, {"oid": "211ca425afe0c515a5a7edb77c62e5b483943ac0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/211ca425afe0c515a5a7edb77c62e5b483943ac0", "message": "Replace StringBuilder with StringJoiner", "committedDate": "2020-02-06T06:02:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA2MjgwNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862#discussion_r378062807", "bodyText": "not found?", "author": "warunalakshitha", "createdAt": "2020-02-12T06:38:14Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/RunExecutableTask.java", "diffHunk": "@@ -64,71 +65,59 @@\n      * @param isInDebugMode Flag to notify whether the executable jar should be run in the debug mode.\n      */\n     public RunExecutableTask(String[] args, boolean isInDebugMode) {\n-        this(null, args);\n+        this(args);\n         this.isInDebugMode = isInDebugMode;\n     }\n \n     /**\n      * Create a task to run an executable from a given path.\n      *\n-     * @param executablePath The path to the executable.\n-     * @param args           Arguments for the executable.\n+     * @param args Arguments for the executable.\n      */\n-    public RunExecutableTask(Path executablePath, String[] args) {\n-        this.executablePath = executablePath;\n+    public RunExecutableTask(String[] args) {\n         this.args = args;\n     }\n \n     @Override\n     public void execute(BuildContext buildContext) {\n         Path sourceRootPath = buildContext.get(BuildContextField.SOURCE_ROOT);\n+\n         BLangPackage executableModule = null;\n-        // set executable path from an executable built on the go\n-        if (null == this.executablePath) {\n-            for (BLangPackage module : buildContext.getModules()) {\n-                if (module.symbol.entryPointExists) {\n-                    this.executablePath = buildContext.getExecutablePathFromTarget(module.packageID);\n-                    executableModule = module;\n-                    break;\n-                }\n+        for (BLangPackage module : buildContext.getModules()) {\n+            if (module.symbol.entryPointExists) {\n+                executableModule = module;\n+                this.executableJarPath = buildContext.getJarPathFromTargetCache(executableModule.packageID);\n+                break;\n             }\n+        }\n \n-            // check if executable found with entry points.\n-            if (null == this.executablePath) {\n-                switch (buildContext.getSourceType()) {\n-                    case SINGLE_BAL_FILE:\n-                        SingleFileContext singleFileContext = buildContext.get(BuildContextField.SOURCE_CONTEXT);\n-                        throw createLauncherException(\"no entry points found in '\" + singleFileContext.getBalFile() +\n-                                \"'.\");\n-                    case SINGLE_MODULE:\n-                        SingleModuleContext singleModuleContext = buildContext.get(BuildContextField.SOURCE_CONTEXT);\n-                        throw createLauncherException(\"no entry points found in '\" +\n-                                singleModuleContext.getModuleName() + \"'.\");\n-                    default:\n-                        throw createLauncherException(\"unknown source type found when running executable.\");\n-                }\n+        // check if any entry points are found.", "originalCommit": "211ca425afe0c515a5a7edb77c62e5b483943ac0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA2MzE3MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862#discussion_r378063171", "bodyText": "Do we need this check. module jar always jar file", "author": "warunalakshitha", "createdAt": "2020-02-12T06:39:36Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/RunExecutableTask.java", "diffHunk": "@@ -64,71 +65,59 @@\n      * @param isInDebugMode Flag to notify whether the executable jar should be run in the debug mode.\n      */\n     public RunExecutableTask(String[] args, boolean isInDebugMode) {\n-        this(null, args);\n+        this(args);\n         this.isInDebugMode = isInDebugMode;\n     }\n \n     /**\n      * Create a task to run an executable from a given path.\n      *\n-     * @param executablePath The path to the executable.\n-     * @param args           Arguments for the executable.\n+     * @param args Arguments for the executable.\n      */\n-    public RunExecutableTask(Path executablePath, String[] args) {\n-        this.executablePath = executablePath;\n+    public RunExecutableTask(String[] args) {\n         this.args = args;\n     }\n \n     @Override\n     public void execute(BuildContext buildContext) {\n         Path sourceRootPath = buildContext.get(BuildContextField.SOURCE_ROOT);\n+\n         BLangPackage executableModule = null;\n-        // set executable path from an executable built on the go\n-        if (null == this.executablePath) {\n-            for (BLangPackage module : buildContext.getModules()) {\n-                if (module.symbol.entryPointExists) {\n-                    this.executablePath = buildContext.getExecutablePathFromTarget(module.packageID);\n-                    executableModule = module;\n-                    break;\n-                }\n+        for (BLangPackage module : buildContext.getModules()) {\n+            if (module.symbol.entryPointExists) {\n+                executableModule = module;\n+                this.executableJarPath = buildContext.getJarPathFromTargetCache(executableModule.packageID);\n+                break;\n             }\n+        }\n \n-            // check if executable found with entry points.\n-            if (null == this.executablePath) {\n-                switch (buildContext.getSourceType()) {\n-                    case SINGLE_BAL_FILE:\n-                        SingleFileContext singleFileContext = buildContext.get(BuildContextField.SOURCE_CONTEXT);\n-                        throw createLauncherException(\"no entry points found in '\" + singleFileContext.getBalFile() +\n-                                \"'.\");\n-                    case SINGLE_MODULE:\n-                        SingleModuleContext singleModuleContext = buildContext.get(BuildContextField.SOURCE_CONTEXT);\n-                        throw createLauncherException(\"no entry points found in '\" +\n-                                singleModuleContext.getModuleName() + \"'.\");\n-                    default:\n-                        throw createLauncherException(\"unknown source type found when running executable.\");\n-                }\n+        // check if any entry points are found.\n+        if (executableModule == null) {\n+            switch (buildContext.getSourceType()) {\n+                case SINGLE_BAL_FILE:\n+                    SingleFileContext singleFileContext = buildContext.get(BuildContextField.SOURCE_CONTEXT);\n+                    throw createLauncherException(String.format(\"no entry points found in '%s'.\",\n+                            singleFileContext.getBalFile()));\n+                case SINGLE_MODULE:\n+                    SingleModuleContext singleModuleContext = buildContext.get(BuildContextField.SOURCE_CONTEXT);\n+                    throw createLauncherException(String.format(\"no entry points found in '%s'.\",\n+                            singleModuleContext.getModuleName()));\n+                default:\n+                    throw createLauncherException(\"unknown source type found when running executable.\");\n             }\n         }\n \n-        if (!this.executablePath.isAbsolute()) {\n-            this.executablePath = sourceRootPath.resolve(executablePath);\n+        // if the executable does not exist.\n+        if (Files.notExists(this.executableJarPath)) {\n+            throw createLauncherException(String.format(\"cannot run '%s' as it does not exist.\",\n+                    executableJarPath.toAbsolutePath().toString()));\n         }\n \n-        // clean up the path and get absolute path\n-        this.executablePath = this.executablePath.toAbsolutePath().normalize();\n-\n-        // if the executable does not exist\n-        if (Files.notExists(this.executablePath)) {\n-            throw createLauncherException(\"cannot run '\" + this.executablePath.toAbsolutePath().toString() +\n-                    \"' as it does not exist.\");\n-        }\n-\n-        // if the executable is not a file and not an extension with .jar\n-        if (!(Files.isRegularFile(this.executablePath) &&\n-                this.executablePath.toString().endsWith(BLANG_COMPILED_JAR_EXT))) {\n-\n-            throw createLauncherException(\"cannot run '\" + this.executablePath.toAbsolutePath().toString() +\n-                    \"' as it is not an executable with .jar extension.\");\n+        // if the executable is not a file and not an extension with .jar.\n+        if (!(Files.isRegularFile(this.executableJarPath) &&\n+                this.executableJarPath.toString().endsWith(BLANG_COMPILED_JAR_EXT))) {", "originalCommit": "211ca425afe0c515a5a7edb77c62e5b483943ac0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyMjUzMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862#discussion_r378122531", "bodyText": "I added the same check we had for the final uber jar(I wasn't sure why we had this at the first place). Anyway if this is redundant for the module jar, we can remove. @Kishanthan WDYT?", "author": "NipunaRanasinghe", "createdAt": "2020-02-12T09:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA2MzE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA2NDI1MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862#discussion_r378064251", "bodyText": "this is module jar i think?", "author": "warunalakshitha", "createdAt": "2020-02-12T06:43:35Z", "path": "cli/ballerina-packerina/src/main/java/org/ballerinalang/packerina/task/RunExecutableTask.java", "diffHunk": "@@ -53,7 +54,7 @@\n public class RunExecutableTask implements Task {\n \n     private final String[] args;\n-    private Path executablePath;\n+    private Path executableJarPath;", "originalCommit": "211ca425afe0c515a5a7edb77c62e5b483943ac0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyMzMzOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20862#discussion_r378123339", "bodyText": "Yeah this is the module executable jar file path. Do you have any alternative suggestions for the var name?", "author": "NipunaRanasinghe", "createdAt": "2020-02-12T09:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA2NDI1MQ=="}], "type": "inlineReview"}, {"oid": "323abab92ce2970e75f4bfc9dc7169d607e742ac", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/323abab92ce2970e75f4bfc9dc7169d607e742ac", "message": "Add review suggestions", "committedDate": "2020-02-13T01:02:19Z", "type": "commit"}, {"oid": "323abab92ce2970e75f4bfc9dc7169d607e742ac", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/323abab92ce2970e75f4bfc9dc7169d607e742ac", "message": "Add review suggestions", "committedDate": "2020-02-13T01:02:19Z", "type": "forcePushed"}, {"oid": "ab9d48c7b8233996ba176486a26025086f1a0743", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ab9d48c7b8233996ba176486a26025086f1a0743", "message": "Merge branch 'ballerina-1.1.x' of https://github.com/ballerina-platform/ballerina-lang into improve-ballerina-run", "committedDate": "2020-02-13T01:03:16Z", "type": "commit"}, {"oid": "e5de60acb4a182063e1a048f4775f5a56ac69667", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e5de60acb4a182063e1a048f4775f5a56ac69667", "message": "Fix log API tests", "committedDate": "2020-02-13T07:20:25Z", "type": "commit"}, {"oid": "e5de60acb4a182063e1a048f4775f5a56ac69667", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e5de60acb4a182063e1a048f4775f5a56ac69667", "message": "Fix log API tests", "committedDate": "2020-02-13T07:20:25Z", "type": "forcePushed"}]}