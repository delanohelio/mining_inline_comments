{"pr_number": 20531, "pr_title": "Support using type `byte` as `json`", "pr_createdAt": "2020-01-06T14:40:40Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyODE4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r363328188", "bodyText": "What is the reason to interchange this else if condition?", "author": "KavinduZoysa", "createdAt": "2020-01-06T14:58:03Z", "path": "stdlib/http/src/main/ballerina/src/http/http_commons.bal", "diffHunk": "@@ -242,10 +242,10 @@ function buildResponse(ResponseMessage message) returns Response {\n         response.setTextPayload(message);\n     } else if (message is xml) {\n         response.setXmlPayload(message);\n-    } else if (message is json) {\n-        response.setJsonPayload(message);\n     } else if (message is byte[]) {\n         response.setBinaryPayload(message);\n+    } else if (message is json) {\n+        response.setJsonPayload(message);", "originalCommit": "32818b96bc8e24be153aea2ba5fabdfe6627c216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMzMzIzNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r363333235", "bodyText": "Take the following code snippet\ntype Person record {\n    \n};\n\npublic function main() {\n   int[] | json | Person value = \"\";\n   if (value is json) {\n       // do something\n   } else if( value is int[]) { // <--- error on this line\n       //do something\n   }\n}\nThe above code snippet prints out the following error.\nPerson' will not be matched to 'int[]'\nThis is because the is json check also captures int[], since int can be used as json.\nAnd when we are in the else clause the type is narrowed to Person.\nThe reason for interchanging else if above is because of this but for type byte[]\nps: please correct me if my understanding is wrong here @MaryamZi  @pubudu91 @rdhananjaya  :)", "author": "irshadnilam", "createdAt": "2020-01-06T15:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyODE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU4ODYwNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r363588604", "bodyText": "Yeah, basically a byte is json, and therefore a byte[] is also json.\nSo, when using the type guard, if the json type test comes before the byte[] type test, the byte[] type test will never be evaluated to true since any byte[] is a json.", "author": "MaryamZi", "createdAt": "2020-01-07T04:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyODE4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDIzNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364060236", "bodyText": "Can we check with the std lib team if this order change is OK? Since this used to be the last case, just to make sure we aren't making the least likely usage the first check.", "author": "MaryamZi", "createdAt": "2020-01-08T04:32:16Z", "path": "stdlib/messaging/nats/src/main/ballerina/src/nats/commons.bal", "diffHunk": "@@ -20,7 +20,9 @@ public type Content byte[] | boolean | string | int | float | decimal | xml | js\n \n function convertData(Content data) returns string | byte[] | error {\n     string | byte[] | error converted;\n-    if (data is boolean) {\n+    if (data is byte[]) {", "originalCommit": "b54bce93d3e6eaebe9f988dd17dad3d3bfc59047", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDg5Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364060892", "bodyText": "@daneshk @aashikam FYA please.", "author": "MaryamZi", "createdAt": "2020-01-08T04:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2NTU2Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364065567", "bodyText": "Order doesn't matter. should be fine", "author": "daneshk", "createdAt": "2020-01-08T05:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDQ1NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364060454", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            function testByteAsJsonVal() returns (json) {\n          \n          \n            \n            function testByteAsJsonVal() returns json {", "author": "MaryamZi", "createdAt": "2020-01-08T04:33:35Z", "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/jsontype/json-value.bal", "diffHunk": "@@ -13,6 +13,12 @@ function testFloatAsJsonVal () returns (json) {\n     return j;\n }\n \n+function testByteAsJsonVal() returns (json) {", "originalCommit": "b54bce93d3e6eaebe9f988dd17dad3d3bfc59047", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA3OTAzMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364079030", "bodyText": "Fixed", "author": "irshadnilam", "createdAt": "2020-01-08T06:24:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDU2MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364060560", "bodyText": "Shall we reformat this bit? Noticed it's off to the int tests too, can you please reformat that too?", "author": "MaryamZi", "createdAt": "2020-01-08T04:34:23Z", "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/byte/byte_as_json_test.bal", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+byte globalByte0 = 0;\n+byte globalByte30 = 30;\n+byte globalByte255 = 255;\n+\n+function testByteAsJson() returns boolean {\n+    byte b0 = 0;\n+    json j0 = b0;\n+    json ig0 = globalByte0;\n+    boolean byte0AsJson = j0 == ig0 && j0 == 0;\n+\n+    byte b30 = 30;\n+    json j30 = takeAJson(b30);\n+    json jg30 = globalByte30;\n+    boolean byte30AsJson = j30 == jg30 && j30 == 30;\n+\n+    byte b255 = 255;\n+    json j255 = b255;\n+    json jg255 = takeAJson(globalByte255);\n+    boolean byte255AsJson = j255 == jg255 && j255 == 255;\n+\n+    return byte0AsJson && byte30AsJson && byte255AsJson;\n+}\n+\n+function takeAJson(json j) returns json {\n+    return j;\n+}\n+\n+function testByteDowncastFromJson() returns boolean {\n+    json j0 = globalByte0;\n+    byte b0 = <byte> j0;\n+\n+    byte bl178 = 178;\n+    json j178 = bl178;\n+    byte b178 = <byte> j178;\n+\n+    json j255 = globalByte255;\n+    byte b255 = <byte> j255;\n+\n+    return b0 == 0 && b178 == 178 && b255 == 255;\n+}\n+\n+function testByteArrayDowncastFromJsonArray() returns boolean {\n+    byte b0 = 0;\n+    byte[] barr = [b0, 1, globalByte255];\n+    json[] jarr = barr;\n+\n+    byte b178 = 178;\n+    jarr.push(b178);\n+\n+    byte[] barr2 = <byte[]> jarr;\n+\n+    return barr2.length() == 4 &&\n+            barr2[0] == 0 && barr2[1] == <byte> 1 && barr2[2] == globalByte255 && barr2[3] == b178;\n+}\n+\n+function testBytesInJsonArray() returns boolean {\n+    byte b0 = 0;\n+    byte b178 = 178;\n+    byte b255 = 255;\n+\n+    json[] arr = [-1, b0, 120, b178, b255, 340];\n+\n+    foreach [int, json][index, val] in arr.enumerate() {\n+\t\tmatch index {\n+\t\t    1 => {\n+\t\t        if val != b0 {\n+\t\t            return false;\n+\t\t        }\n+\t\t    }\n+            3 => {\n+                if val != 178 {\n+                    return false;\n+                }\n+            }\n+            4 => {\n+                if val != b255 {\n+                    return false;\n+                }\n+            }\n+            _ => {\n+                if val != arr[index] {\n+                    return false;\n+                }\n+            }\n+\t\t}\n+\t}\n+\treturn true;", "originalCommit": "b54bce93d3e6eaebe9f988dd17dad3d3bfc59047", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA3OTA1Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364079052", "bodyText": "Fixed", "author": "irshadnilam", "createdAt": "2020-01-08T06:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDc2MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364060760", "bodyText": "Instead of removing this and the tests in https://github.com/ballerina-platform/ballerina-lang/pull/20531/files#diff-17ddc3514c16ada932b765cb849594b1L228, shall we change the tests to use some other non-JSON compatible field?", "author": "MaryamZi", "createdAt": "2020-01-08T04:35:52Z", "path": "tests/jballerina-unit-test/src/test/java/org/ballerinalang/test/expressions/conversion/NativeConversionNegativeTest.java", "diffHunk": "@@ -87,14 +87,6 @@ public void testTupleConversionFail() {\n                 + \"T2]'\");\n     }\n \n-    @Test(description = \"Test converting an unsupported array to json\")", "originalCommit": "b54bce93d3e6eaebe9f988dd17dad3d3bfc59047", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA3OTExOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20531#discussion_r364079118", "bodyText": "Fixed with 091f20e", "author": "irshadnilam", "createdAt": "2020-01-08T06:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDc2MA=="}], "type": "inlineReview"}, {"oid": "b69fd1a7da5f850e7fedbeef86b809e44a74d754", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b69fd1a7da5f850e7fedbeef86b809e44a74d754", "message": "Support using type `byte` as `json`", "committedDate": "2020-01-08T06:17:11Z", "type": "commit"}, {"oid": "f15d4cd8a52daa06990b4b64e2112785ea3cdea7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f15d4cd8a52daa06990b4b64e2112785ea3cdea7", "message": "Add more tests on using byte as json", "committedDate": "2020-01-08T06:22:47Z", "type": "commit"}, {"oid": "091f20ee401e21f690630dd8cf20c16f1e9a1b11", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/091f20ee401e21f690630dd8cf20c16f1e9a1b11", "message": "Fix conversion tests that no longer valid", "committedDate": "2020-01-08T06:22:53Z", "type": "commit"}]}