{"pr_number": 23795, "pr_title": "Make objects a selectively immutable type and add tests", "pr_createdAt": "2020-06-08T08:28:45Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/23795", "timeline": [{"oid": "e85d3d3c28b0e56be551a7f36fa0c3e6c742e8bc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e85d3d3c28b0e56be551a7f36fa0c3e6c742e8bc", "message": "Make objects a selectively immutable type", "committedDate": "2020-05-29T14:43:04Z", "type": "commit"}, {"oid": "18fd5c9d43de5dffe30c13395545d457b2c39800", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/18fd5c9d43de5dffe30c13395545d457b2c39800", "message": "Allow readonly intersections with objects only if abstract", "committedDate": "2020-06-03T11:35:24Z", "type": "commit"}, {"oid": "42eeaa5d70dead9d55544794623c314705e39412", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/42eeaa5d70dead9d55544794623c314705e39412", "message": "Fix field update check for objects and fix tests", "committedDate": "2020-06-03T12:40:09Z", "type": "commit"}, {"oid": "adc595774ab20540aba859318d37d279e4dcfcf0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/adc595774ab20540aba859318d37d279e4dcfcf0", "message": "Fix setting immutable intersecn type and add tests", "committedDate": "2020-06-03T17:28:07Z", "type": "commit"}, {"oid": "553bf42adfc462f7843de441c6ebe39bd43c5880", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/553bf42adfc462f7843de441c6ebe39bd43c5880", "message": "Merge branch 'impl-intersectn-type' of https://github.com/MaryamZi/ballerina into obj-imm-take-2", "committedDate": "2020-06-03T17:29:11Z", "type": "commit"}, {"oid": "dd65b51cf3ebfd086eec550de23310fcdb8f7a14", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dd65b51cf3ebfd086eec550de23310fcdb8f7a14", "message": "Add tests for all readonly field structures being immutable types", "committedDate": "2020-06-04T06:59:39Z", "type": "commit"}, {"oid": "64d992c3b4490efbccfac66e79dda72d7fedbec7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/64d992c3b4490efbccfac66e79dda72d7fedbec7", "message": "Add basic balo tests for selectively immutable types", "committedDate": "2020-06-04T15:15:02Z", "type": "commit"}, {"oid": "36f927cb8433063feafc8abd2031421ad2bcd471", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/36f927cb8433063feafc8abd2031421ad2bcd471", "message": "Create immutable tsymbol only if original tsymbol is not null", "committedDate": "2020-06-05T06:11:56Z", "type": "commit"}, {"oid": "0bec9c889e95fa6b7c17345a085183df369082b1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0bec9c889e95fa6b7c17345a085183df369082b1", "message": "Fix setting immutability in BIRPackageSymbolEnter", "committedDate": "2020-06-05T17:43:12Z", "type": "commit"}, {"oid": "40a17a72c3f7d60e60d6430db2ded9b29cdbf932", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/40a17a72c3f7d60e60d6430db2ded9b29cdbf932", "message": "Prepend module to readonly symbol and add balo tests", "committedDate": "2020-06-06T07:28:55Z", "type": "commit"}, {"oid": "3b502782dd441597f5c2c4de14e1d69f127a9ce3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3b502782dd441597f5c2c4de14e1d69f127a9ce3", "message": "Add immutability test for same named constructs from diff modules", "committedDate": "2020-06-06T12:58:32Z", "type": "commit"}, {"oid": "587c923cb0d598f0d5a87685a56f9e0346e4a5b5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/587c923cb0d598f0d5a87685a56f9e0346e4a5b5", "message": "Merge branch 'impl-intersectn-type' of https://github.com/MaryamZi/ballerina into obj-imm-take-2", "committedDate": "2020-06-07T07:34:21Z", "type": "commit"}, {"oid": "391a9a615e3d34bd1d5dc0e7a5b882106496c24c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/391a9a615e3d34bd1d5dc0e7a5b882106496c24c", "message": "Fix compilation error due to sync", "committedDate": "2020-06-07T08:03:38Z", "type": "commit"}, {"oid": "54da694d046f4225650693e03729c5b10cdde89b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/54da694d046f4225650693e03729c5b10cdde89b", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into obj-imm-take-2", "committedDate": "2020-06-08T17:15:41Z", "type": "commit"}, {"oid": "4dcf6541dcb0a494a22001268f5a3aa4fa35f6f3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4dcf6541dcb0a494a22001268f5a3aa4fa35f6f3", "message": "Fix literal assignment to broad immutable intersection", "committedDate": "2020-06-08T20:14:58Z", "type": "commit"}, {"oid": "bcaabd71212ee6454d0b3986e355dfe02c99750e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bcaabd71212ee6454d0b3986e355dfe02c99750e", "message": "Fix readonly checks for unions", "committedDate": "2020-06-09T13:00:40Z", "type": "commit"}, {"oid": "27908a2d535ebf9cd30adab36dc3d9b2b219244f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/27908a2d535ebf9cd30adab36dc3d9b2b219244f", "message": "Add basic intersection tests", "committedDate": "2020-06-09T13:11:46Z", "type": "commit"}, {"oid": "f89fc8d993c732b3be4f4763c9a55b5c43b823f8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f89fc8d993c732b3be4f4763c9a55b5c43b823f8", "message": "Fix type flags getting overwritten with aliases", "committedDate": "2020-06-09T15:38:05Z", "type": "commit"}, {"oid": "1e19b6841b67b5580cc8accb63a2f5f23e9c7921", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e19b6841b67b5580cc8accb63a2f5f23e9c7921", "message": "Resolve conflicts and merge master", "committedDate": "2020-06-09T16:33:26Z", "type": "commit"}, {"oid": "dfe3e159bbe5b5f217387fab9e8af69aa499f52c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dfe3e159bbe5b5f217387fab9e8af69aa499f52c", "message": "Resolve conflicts and merge master", "committedDate": "2020-06-10T11:05:25Z", "type": "commit"}, {"oid": "d3478c173963eda6c01bbea1733683d690b3c37e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d3478c173963eda6c01bbea1733683d690b3c37e", "message": "Change __init to init in new tests", "committedDate": "2020-06-10T14:54:58Z", "type": "commit"}, {"oid": "6b43c73eb461a192e7735a25c97486edff6ee4f8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6b43c73eb461a192e7735a25c97486edff6ee4f8", "message": "Intro grammar changes for readonly objects", "committedDate": "2020-06-10T16:59:42Z", "type": "commit"}, {"oid": "c37ed3423838aafbe55b900d19cb55fbaeaa172b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c37ed3423838aafbe55b900d19cb55fbaeaa172b", "message": "Fix default values not being set for immutable-typed fields", "committedDate": "2020-06-11T06:16:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYyNTk1Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23795#discussion_r438625952", "bodyText": "IMO using !(A || B) is much readable than (!A && !B)", "author": "rdhananjaya", "createdAt": "2020-06-11T08:29:38Z", "path": "bvm/ballerina-runtime/src/main/java/org/ballerinalang/jvm/TypeChecker.java", "diffHunk": "@@ -1295,6 +1291,21 @@ public static boolean isSelectivelyImmutableType(BType type, Set<BType> unresolv\n \n                 return isInherentlyImmutableType(recordRestType) ||\n                         isSelectivelyImmutableType(recordRestType, unresolvedTypes);\n+            case TypeTags.OBJECT_TYPE_TAG:\n+                BObjectType objectType = (BObjectType) type;\n+\n+                if (!Flags.isFlagOn(objectType.flags, Flags.ABSTRACT)) {\n+                    return false;\n+                }\n+\n+                for (BField field : objectType.getFields().values()) {\n+                    BType fieldType = field.type;\n+                    if (!isInherentlyImmutableType(fieldType) &&", "originalCommit": "1e19b6841b67b5580cc8accb63a2f5f23e9c7921", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc1NzY1Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23795#discussion_r439757656", "bodyText": "I personally find !A && !B more readable, especially when there are few conditions. :D I find it easier to read \"if fieldType is not inherently immutable and is not selectively immutable\".", "author": "MaryamZi", "createdAt": "2020-06-13T18:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYyNTk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc2OTIyNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/23795#discussion_r438769227", "bodyText": "@Kishanthan, this PR introduces some changes to support object/record intersection types, where for something like\nimport ballerina/http;\n\npublic function main() {\n    http:Versioning & readonly v = {};\n}\nthe name of the type of v has a name like (ballerina/http:1.0.0:Versioning & readonly), with / and . in the name, which results in errors. So I've replaced them with _ too.\nI also had to call this method when calculating the type field name (org.wso2.ballerinalang.compiler.bir.codegen.JvmTypeGen#getTypeFieldName), since that too would have these characters.\nDo you see any issue with this change?", "author": "MaryamZi", "createdAt": "2020-06-11T13:10:39Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/bir/codegen/JvmMethodGen.java", "diffHunk": "@@ -1207,7 +1207,8 @@ private static String getFrameClassName(String pkgName, String funcName, BType a\n      * @return cleaned name\n      */\n     static String cleanupTypeName(String name) {\n-\n+        name = name.replace(\"/\", \"_\");\n+        name = name.replace(\".\", \"_\");", "originalCommit": "1e19b6841b67b5580cc8accb63a2f5f23e9c7921", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6fc90de257ffcc0aa111f4e337636b0f7c72a44", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d6fc90de257ffcc0aa111f4e337636b0f7c72a44", "message": "Add support for readonly objects", "committedDate": "2020-06-11T18:46:27Z", "type": "commit"}, {"oid": "3db52acba28b25fcc1df1f1db634f285529f52b9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3db52acba28b25fcc1df1f1db634f285529f52b9", "message": "Add tests", "committedDate": "2020-06-11T20:55:45Z", "type": "commit"}, {"oid": "99dfca690f6a633020d9613deedd6e5839efd4c0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/99dfca690f6a633020d9613deedd6e5839efd4c0", "message": "Resolve conflicts and merge master", "committedDate": "2020-06-11T21:20:19Z", "type": "commit"}, {"oid": "0fe224094cab802358218005006e60c3bfeb02f9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0fe224094cab802358218005006e60c3bfeb02f9", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into obj-imm-take-2", "committedDate": "2020-06-12T05:24:23Z", "type": "commit"}, {"oid": "c115aff5dbef10786ca6a5c3e70527074d721b3e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c115aff5dbef10786ca6a5c3e70527074d721b3e", "message": "Remove unnecessary readonly field compatibility check", "committedDate": "2020-06-12T08:04:33Z", "type": "commit"}, {"oid": "0183b8a4de3589c8d9aa3721883e99fe3e348c6d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0183b8a4de3589c8d9aa3721883e99fe3e348c6d", "message": "Resolve conflicts and merge master", "committedDate": "2020-06-12T08:49:54Z", "type": "commit"}, {"oid": "f2f98cff59a7e96e3afba1bb2fa2a8ab9509caf8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f2f98cff59a7e96e3afba1bb2fa2a8ab9509caf8", "message": "Skip immutability check for parameterized types\nsince the check will be done once the type is resolved.", "committedDate": "2020-06-12T10:34:22Z", "type": "commit"}, {"oid": "8c0a75aeb133943375c86ea734db66b8dc3f07c4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8c0a75aeb133943375c86ea734db66b8dc3f07c4", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into obj-imm-take-2", "committedDate": "2020-06-13T16:49:52Z", "type": "commit"}, {"oid": "78608ca076abdfff8f3196328ec8feffc4324154", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/78608ca076abdfff8f3196328ec8feffc4324154", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into obj-imm-take-2", "committedDate": "2020-06-13T21:04:10Z", "type": "commit"}, {"oid": "003c05b8ec6fc798f5e676aa3d876f2f0b2d0dc9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/003c05b8ec6fc798f5e676aa3d876f2f0b2d0dc9", "message": "Resolve conflicts and merge master", "committedDate": "2020-06-14T04:54:36Z", "type": "commit"}, {"oid": "c9b99bcb74708bd1f7bf7a4763627dcc2c8330a9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c9b99bcb74708bd1f7bf7a4763627dcc2c8330a9", "message": "Temporarily disable tests failing on new parser", "committedDate": "2020-06-14T06:04:10Z", "type": "commit"}]}