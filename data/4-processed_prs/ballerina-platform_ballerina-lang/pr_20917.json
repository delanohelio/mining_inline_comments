{"pr_number": 20917, "pr_title": "Make listener variables final", "pr_createdAt": "2020-02-07T09:23:21Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/20917", "timeline": [{"oid": "b03539571ba11720c55c60affdd6928ec9307377", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b03539571ba11720c55c60affdd6928ec9307377", "message": "Make listener variables final\n\nThis will fix #20892 by flaging listener variables as final\n\nSigned-off-by: KRVPerera <rukshan.viduranga@gmail.com>", "committedDate": "2020-02-08T15:44:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyNTY5MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20917#discussion_r376925691", "bodyText": "Shall we improve the name of the function to reflect what's actually being tested?", "author": "MaryamZi", "createdAt": "2020-02-10T08:44:29Z", "path": "tests/jballerina-unit-test/src/test/resources/test-src/types/finaltypes/final-field-test-negative.bal", "diffHunk": "@@ -71,3 +71,9 @@ function testLocalFinalValueWithoutTypeInitializedFromFunction() {\n function getName() returns string {\n     return \"Ballerina\";\n }\n+\n+listener http:MockListener ml = new http:MockListener(8080);\n+\n+public function testListenerVariable() {", "originalCommit": "b03539571ba11720c55c60affdd6928ec9307377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE0MTcwNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20917#discussion_r377141706", "bodyText": "done", "author": "KRVPerera", "createdAt": "2020-02-10T15:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyNTY5MQ=="}], "type": "inlineReview"}, {"oid": "1f0f11c3648b93a63518f73666d45100902a38e3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1f0f11c3648b93a63518f73666d45100902a38e3", "message": "Give a error for listener/service var reassignment\n\nBoth service and listener variables are implicitly final and compilor\nerror message improved for listeber/service var re-assignment\n\nSigned-off-by: KRVPerera <rukshan.viduranga@gmail.com>", "committedDate": "2020-02-10T15:38:52Z", "type": "forcePushed"}, {"oid": "db35f274c600457ff15e880736942bd90a8e682d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/db35f274c600457ff15e880736942bd90a8e682d", "message": "Give a error for listener/service var reassignment\n\nBoth service and listener variables are implicitly final and compilor\nerror message improved for listeber/service var re-assignment\n\nSigned-off-by: KRVPerera <rukshan.viduranga@gmail.com>", "committedDate": "2020-02-11T00:51:50Z", "type": "forcePushed"}, {"oid": "12a51a244bdf47a9b2f7abe7b7234c9cdf448690", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/12a51a244bdf47a9b2f7abe7b7234c9cdf448690", "message": "Give a error for listener/service var reassignment\n\nBoth service and listener variables are implicitly final and compilor\nerror message improved for listeber/service var re-assignment\n\nSigned-off-by: KRVPerera <rukshan.viduranga@gmail.com>", "committedDate": "2020-02-11T01:33:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzMDgyMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20917#discussion_r378030821", "bodyText": "This is not used anymore. I think safe to remove this.", "author": "hasithaa", "createdAt": "2020-02-12T04:03:31Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "diffHunk": "@@ -2071,6 +2077,7 @@ private void checkConstantAssignment(BLangExpression varRef) {\n         }\n     }\n \n+    // TODO : check if READONLY is used now", "originalCommit": "12a51a244bdf47a9b2f7abe7b7234c9cdf448690", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzMDk5OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20917#discussion_r378030999", "bodyText": "Better to move string literals to constants. Same for Listener as well.", "author": "hasithaa", "createdAt": "2020-02-12T04:04:23Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "diffHunk": "@@ -2062,7 +2062,13 @@ private void checkConstantAssignment(BLangExpression varRef) {\n         Name varName = names.fromIdNode(simpleVarRef.variableName);\n         if (!Names.IGNORE.equals(varName) && env.enclInvokable != env.enclPkg.initFunction) {\n             if ((simpleVarRef.symbol.flags & Flags.FINAL) == Flags.FINAL) {\n-                dlog.error(varRef.pos, DiagnosticCode.CANNOT_ASSIGN_VALUE_FINAL, varRef);\n+                if ((simpleVarRef.symbol.flags & Flags.SERVICE) == Flags.SERVICE) {\n+                    dlog.error(varRef.pos, DiagnosticCode.INVALID_VARIABLE_ASSIGNMENT_FINAL, \"service\", varRef);", "originalCommit": "12a51a244bdf47a9b2f7abe7b7234c9cdf448690", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwMTk2NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20917#discussion_r378101964", "bodyText": "Instead of variable, we can say Listener/Service declaration is final.", "author": "hasithaa", "createdAt": "2020-02-12T08:32:54Z", "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "diffHunk": "@@ -353,6 +353,9 @@ error.no.new.variables.var.assignment=\\\n error.invalid.variable.assignment=\\\n   invalid assignment in variable ''{0}''\n \n+error.invalid.variable.assignment.field.final =\\\n+  invalid assignment: ''{0}'' variable ''{1}'' is final", "originalCommit": "12a51a244bdf47a9b2f7abe7b7234c9cdf448690", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwMjQyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/20917#discussion_r378102425", "bodyText": "Sometimes Service name can be anonymous. (name will start with $) In such cases, avoiding name will be good.", "author": "hasithaa", "createdAt": "2020-02-12T08:34:01Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/SemanticAnalyzer.java", "diffHunk": "@@ -2062,7 +2062,13 @@ private void checkConstantAssignment(BLangExpression varRef) {\n         Name varName = names.fromIdNode(simpleVarRef.variableName);\n         if (!Names.IGNORE.equals(varName) && env.enclInvokable != env.enclPkg.initFunction) {\n             if ((simpleVarRef.symbol.flags & Flags.FINAL) == Flags.FINAL) {\n-                dlog.error(varRef.pos, DiagnosticCode.CANNOT_ASSIGN_VALUE_FINAL, varRef);\n+                if ((simpleVarRef.symbol.flags & Flags.SERVICE) == Flags.SERVICE) {\n+                    dlog.error(varRef.pos, DiagnosticCode.INVALID_VARIABLE_ASSIGNMENT_FINAL, \"service\", varRef);", "originalCommit": "12a51a244bdf47a9b2f7abe7b7234c9cdf448690", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3728ea118df471e1abcbeffc5a80bf7fdb36ede8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3728ea118df471e1abcbeffc5a80bf7fdb36ede8", "message": "Make listener variables final\n\nThis will fix #20892 by flaging listener variables as final\n\nSigned-off-by: KRVPerera <rukshan.viduranga@gmail.com>", "committedDate": "2020-02-12T08:48:23Z", "type": "commit"}, {"oid": "8ded33ea2770951ce5b10bfd5885f1a47bdb6a1d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8ded33ea2770951ce5b10bfd5885f1a47bdb6a1d", "message": "Give a error for listener/service var reassignment\n\nBoth service and listener variables are implicitly final and compilor\nerror message improved for listeber/service var re-assignment\n\nSigned-off-by: KRVPerera <rukshan.viduranga@gmail.com>", "committedDate": "2020-02-12T08:48:23Z", "type": "commit"}, {"oid": "13a4c86abd72dae60708afbe19cd828cea2696b9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/13a4c86abd72dae60708afbe19cd828cea2696b9", "message": "Remove unused READONLY flag from the code", "committedDate": "2020-02-12T09:13:42Z", "type": "commit"}, {"oid": "6e180205c48cf93b86e7cee6ef116d6e2961bfa0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6e180205c48cf93b86e7cee6ef116d6e2961bfa0", "message": "Chane error for listener/service reassignment", "committedDate": "2020-02-12T09:13:42Z", "type": "commit"}, {"oid": "6e180205c48cf93b86e7cee6ef116d6e2961bfa0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6e180205c48cf93b86e7cee6ef116d6e2961bfa0", "message": "Chane error for listener/service reassignment", "committedDate": "2020-02-12T09:13:42Z", "type": "forcePushed"}]}