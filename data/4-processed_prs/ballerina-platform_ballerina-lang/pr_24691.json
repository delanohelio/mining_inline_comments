{"pr_number": 24691, "pr_title": "Add cookie field in the WebSocket config", "pr_createdAt": "2020-07-10T08:08:26Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691", "timeline": [{"oid": "d2f8528818b40f759a1d585b7f62871d7b0d35b0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d2f8528818b40f759a1d585b7f62871d7b0d35b0", "message": "Add the cookie field in the config", "committedDate": "2020-07-10T08:01:11Z", "type": "commit"}, {"oid": "89175bf7dfe631bc0950a4f907a3b502adb87928", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/89175bf7dfe631bc0950a4f907a3b502adb87928", "message": "Add the new line", "committedDate": "2020-07-10T08:04:33Z", "type": "commit"}, {"oid": "81910335405de54f51c8fc5eea261263d2682f67", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/81910335405de54f51c8fc5eea261263d2682f67", "message": "change the description", "committedDate": "2020-07-10T08:11:38Z", "type": "commit"}, {"oid": "d1b2a621c5f91d526ab50c63edc5072e923948d4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d1b2a621c5f91d526ab50c63edc5072e923948d4", "message": "Fix test failure", "committedDate": "2020-07-10T08:47:29Z", "type": "commit"}, {"oid": "4479dd208ae671deedbec5670878ba5f835a3622", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4479dd208ae671deedbec5670878ba5f835a3622", "message": "Merge with master", "committedDate": "2020-07-10T08:54:24Z", "type": "commit"}, {"oid": "c3fc6ae9a9a1c982d6e1212650b94b4e7cff7d89", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c3fc6ae9a9a1c982d6e1212650b94b4e7cff7d89", "message": "Remove white spaces", "committedDate": "2020-07-10T09:11:47Z", "type": "commit"}, {"oid": "6c2e01e241ec533574f09edd023f1d4d1f0217b3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6c2e01e241ec533574f09edd023f1d4d1f0217b3", "message": "Merge https://github.com/ballerina-platform/ballerina-lang", "committedDate": "2020-07-10T10:54:10Z", "type": "commit"}, {"oid": "ca1b034c996bbfbe135ad4178aa813a05a5e950b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ca1b034c996bbfbe135ad4178aa813a05a5e950b", "message": "Fix server core test failures", "committedDate": "2020-07-10T11:48:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNjgxMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455026812", "bodyText": "can this headers be null?", "author": "chamil321", "createdAt": "2020-07-15T12:51:59Z", "path": "stdlib/http/src/main/java/org/ballerinalang/net/http/websocket/WebSocketUtil.java", "diffHunk": "@@ -502,12 +500,31 @@ public static void populateClientConnectorConfig(MapValue<BString, Object> clien\n                 clientEndpointConfig.getBooleanValue(WebSocketConstants.COMPRESSION_ENABLED_CONFIG));\n     }\n \n-    private static Map<String, String> getCustomHeaders(MapValue<BString, Object> headers) {\n+    private static void populateCustomHeaders(MapValue<BString, Object> clientEndpointConfig,\n+                                              WebSocketClientConnectorConfig clientConnectorConfig) {\n         Map<String, String> customHeaders = new HashMap<>();\n-        headers.entrySet().forEach(\n-                entry -> customHeaders.put(entry.getKey().getValue(), headers.get(entry.getKey()).toString())\n-        );\n-        return customHeaders;\n+        @SuppressWarnings(WebSocketConstants.UNCHECKED)\n+        MapValue<BString, Object> headers = (MapValue<BString, Object>) clientEndpointConfig.getMapValue(\n+                WebSocketConstants.CLIENT_CUSTOM_HEADERS_CONFIG);\n+        if (!headers.isEmpty()) {", "originalCommit": "ca1b034c996bbfbe135ad4178aa813a05a5e950b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyODIwNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455528205", "bodyText": "Yes, It can be null as it gets from the WebSocket config", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-07-16T06:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNjgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzNDE3Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455034173", "bodyText": "Why do we need to access payload here as we use getCookies() API to access cookies?", "author": "chamil321", "createdAt": "2020-07-15T13:04:11Z", "path": "tests/jballerina-integration-test/src/test/resources/websocket/src/wsservices/37_cookie_client.bal", "diffHunk": "@@ -0,0 +1,77 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/http;\n+import ballerina/io;\n+import ballerina/log;\n+\n+http:ClientConfiguration clientEPConfig = {\n+    cookieConfig: {\n+        enabled: true\n+    }\n+};\n+\n+@http:WebSocketServiceConfig {\n+}\n+service on new http:Listener(21037) {\n+\n+    resource function onOpen(http:WebSocketCaller wsEp) {\n+        http:Client httpClient = new(\"http://localhost:21036/cookie-demo\", clientEPConfig);\n+\n+        http:Request request = new;\n+\n+        json jsonPart = {\n+            name: \"John\",\n+            password: \"p@ssw0rd\"\n+        };\n+        request.setJsonPayload(jsonPart);\n+\n+        var loginResp = httpClient->post(\"/login\", request);\n+\n+        if (loginResp is http:Response) {\n+            string|error loginMessage = loginResp.getTextPayload();", "originalCommit": "ca1b034c996bbfbe135ad4178aa813a05a5e950b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMzU2NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455523565", "bodyText": "If the server accepts the login request, it will set the string payload in the response. So here, we check whether getting that string in the payload or not", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-07-16T05:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzNDE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzNTM3Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455035372", "bodyText": "Here also, do we need the payload?", "author": "chamil321", "createdAt": "2020-07-15T13:06:05Z", "path": "tests/jballerina-integration-test/src/test/resources/websocket/src/wsservices/38_incorrect_cookie.bal", "diffHunk": "@@ -0,0 +1,64 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/http;\n+import ballerina/io;\n+import ballerina/log;\n+\n+http:ClientConfiguration clientConfig = {\n+    cookieConfig: {\n+        enabled: true\n+    }\n+};\n+\n+@http:WebSocketServiceConfig {\n+}\n+service on new http:Listener(21038) {\n+\n+    resource function onOpen(http:WebSocketCaller wsEp) {\n+        http:Client httpClient = new(\"http://localhost:21036/cookie-demo\", clientConfig);\n+\n+        http:Request request = new;\n+\n+        json jsonPart = {\n+            name: \"John\",\n+            password: \"p@ssw0rd\"\n+        };\n+        request.setJsonPayload(jsonPart);\n+\n+        var loginResp = httpClient->post(\"/login\", request);\n+\n+        if (loginResp is http:Response) {\n+            string|error loginMessage = loginResp.getTextPayload();", "originalCommit": "ca1b034c996bbfbe135ad4178aa813a05a5e950b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMzU3MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455523570", "bodyText": "If the server accepts the login request, it will set the string payload in the response. So here, we check whether getting that string in the payload or not", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-07-16T05:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAzNTM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1OTE2Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455059167", "bodyText": "Shall we make the cookies  an array of Cookie rather than having it as a  map<string>", "author": "chamil321", "createdAt": "2020-07-15T13:40:03Z", "path": "stdlib/http/src/main/ballerina/src/http/websocket/websocket_client.bal", "diffHunk": "@@ -201,7 +223,7 @@ public type WebSocketClientConfiguration record {|\n     int maxFrameSize = 0;\n     boolean webSocketCompressionEnabled = true;\n     int handShakeTimeoutInSeconds = 300;\n-    WebSocketRetryConfig retryConfig?;\n+    map<string> cookies?;", "originalCommit": "ca1b034c996bbfbe135ad4178aa813a05a5e950b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyNDA4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24691#discussion_r455524088", "bodyText": "Fixed in  #24770", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-07-16T05:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1OTE2Nw=="}], "type": "inlineReview"}]}