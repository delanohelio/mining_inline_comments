{"pr_number": 21199, "pr_title": "Enable gRPC command to support oneof using optional fields", "pr_createdAt": "2020-02-21T11:27:48Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxNjUwMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#discussion_r383616503", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {{> message}}{{/each}}{{/if}}\n          \n          \n            \n            {{> message}}{{/each}}{{/if}}", "author": "daneshk", "createdAt": "2020-02-25T01:48:53Z", "path": "stdlib/grpc/src/main/resources/templates/skeleton/message.mustache", "diffHunk": "@@ -1,10 +1,29 @@\n public type {{messageName}} record {|\n     {{#fieldList}}{{fieldType}}{{#isNull defaultValue}}?{{/isNull}}{{fieldLabel}} {{{fieldName}}}{{#isNull defaultValue}} = (){{/isNull}}{{#isNotNull defaultValue}} = {{#equals fieldType \"string\"}}{{#if fieldLabel}}{{defaultValue}}{{else}}\"{{defaultValue}}\"{{/if}}{{/equals}}{{#not_equal fieldType \"string\"}}{{defaultValue}}{{/not_equal}}{{/isNotNull}};\n-    {{/fieldList}}{{#each oneofFieldMap as |value key|}}{{camelcase @key}} {{@key}};\n-    {{/each}}\n+    {{/fieldList ~}}\n+    {{#each oneofFieldMap as |value key|}}{{#each @value}}{{{fieldType}}}{{#isNull defaultValue}}{{/isNull}} {{{fieldName}}}?;\n+    {{/each ~}}\n+{{/each}}\n |};\n-{{#each oneofFieldMap}}\n-{{> oneoffield}}{{/each}}\n-{{#enumList}}\n+{{#if oneofFieldMap}}\n+function isValid{{camelcase messageName}}({{messageName}} r) returns boolean {\n+{{#each oneofFieldMap as |value key|}}    int {{@key}}Count = 0;\n+    {{#each @value}}if !(r?.{{{fieldName}}} is ()) {\n+        {{@key}}Count += 1;\n+    }\n+    {{/each}}\n+{{/each}}    if ({{#each oneofFieldMap as |value key|}}{{#unless @first}}|| {{/unless}}{{@key}}Count > 1 {{/each}}) {\n+        return false;\n+    }\n+    return true;\n+}\n+{{#each oneofFieldMap}}{{#each this}}\n+function set{{messageName}}_{{{camelcase fieldName}}}({{messageName}} r, {{{fieldType}}} {{{fieldName}}}) {\n+    r.{{{fieldName}}} = {{{fieldName}}};\n+    {{#each ../this}}{{#not_equal fieldName ../fieldName}}r.remove(\"{{fieldName}}\");\n+    {{/not_equal}}{{/each}}\n+}{{/each}}\n+{{/each}}\n+{{/if}}{{#enumList}}\n {{> enum}}{{/enumList}}{{#if this.nestedMessageList}}{{#each this.nestedMessageList}}\n {{> message}}{{/each}}{{/if}}", "originalCommit": "ca1173ae7ff6266148258279a0f0d021eac0b7b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczMzE0OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#discussion_r383733149", "bodyText": "fixed in 188fb2a", "author": "BuddhiWathsala", "createdAt": "2020-02-25T08:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxNjUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyMDg2Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#discussion_r383620866", "bodyText": "Shall we move this logic to oneoffield.mustache file? refer that file here", "author": "daneshk", "createdAt": "2020-02-25T02:06:09Z", "path": "stdlib/grpc/src/main/resources/templates/skeleton/message.mustache", "diffHunk": "@@ -1,10 +1,29 @@\n public type {{messageName}} record {|\n     {{#fieldList}}{{fieldType}}{{#isNull defaultValue}}?{{/isNull}}{{fieldLabel}} {{{fieldName}}}{{#isNull defaultValue}} = (){{/isNull}}{{#isNotNull defaultValue}} = {{#equals fieldType \"string\"}}{{#if fieldLabel}}{{defaultValue}}{{else}}\"{{defaultValue}}\"{{/if}}{{/equals}}{{#not_equal fieldType \"string\"}}{{defaultValue}}{{/not_equal}}{{/isNotNull}};\n-    {{/fieldList}}{{#each oneofFieldMap as |value key|}}{{camelcase @key}} {{@key}};\n-    {{/each}}\n+    {{/fieldList ~}}\n+    {{#each oneofFieldMap as |value key|}}{{#each @value}}{{{fieldType}}}{{#isNull defaultValue}}{{/isNull}} {{{fieldName}}}?;\n+    {{/each ~}}\n+{{/each}}\n |};\n-{{#each oneofFieldMap}}\n-{{> oneoffield}}{{/each}}\n-{{#enumList}}\n+{{#if oneofFieldMap}}\n+function isValid{{camelcase messageName}}({{messageName}} r) returns boolean {\n+{{#each oneofFieldMap as |value key|}}    int {{@key}}Count = 0;\n+    {{#each @value}}if !(r?.{{{fieldName}}} is ()) {\n+        {{@key}}Count += 1;\n+    }\n+    {{/each}}\n+{{/each}}    if ({{#each oneofFieldMap as |value key|}}{{#unless @first}}|| {{/unless}}{{@key}}Count > 1 {{/each}}) {\n+        return false;\n+    }\n+    return true;\n+}\n+{{#each oneofFieldMap}}{{#each this}}\n+function set{{messageName}}_{{{camelcase fieldName}}}({{messageName}} r, {{{fieldType}}} {{{fieldName}}}) {\n+    r.{{{fieldName}}} = {{{fieldName}}};\n+    {{#each ../this}}{{#not_equal fieldName ../fieldName}}r.remove(\"{{fieldName}}\");\n+    {{/not_equal}}{{/each}}\n+}{{/each}}\n+{{/each}}", "originalCommit": "ca1173ae7ff6266148258279a0f0d021eac0b7b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczMzI0OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21199#discussion_r383733248", "bodyText": "fixed in 188fb2a", "author": "BuddhiWathsala", "createdAt": "2020-02-25T08:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyMDg2Ng=="}], "type": "inlineReview"}, {"oid": "497a705cd81929246256ae7c9e7a19ca80d19a40", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/497a705cd81929246256ae7c9e7a19ca80d19a40", "message": "set oneofFieldMap as a map of field list", "committedDate": "2020-03-11T05:49:19Z", "type": "commit"}, {"oid": "1baa60a579d30f363e821dcae62736cda70403c5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1baa60a579d30f363e821dcae62736cda70403c5", "message": "change mustache templates to support oneof with optional fields", "committedDate": "2020-03-11T05:49:19Z", "type": "commit"}, {"oid": "158269d20c75086e9fe28fcbfd381a4225c54f84", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/158269d20c75086e9fe28fcbfd381a4225c54f84", "message": "fix the tests", "committedDate": "2020-03-11T05:49:20Z", "type": "commit"}, {"oid": "ec7dd55c0ae1e714ec98389b846a1c3ad89df69b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ec7dd55c0ae1e714ec98389b846a1c3ad89df69b", "message": "remove unnecessary oneof field maps", "committedDate": "2020-03-11T05:49:20Z", "type": "commit"}, {"oid": "e3bd34e99feb49540537f00d526013b9c4d51353", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e3bd34e99feb49540537f00d526013b9c4d51353", "message": "use oneoffield.mustache file as a nested handlebar", "committedDate": "2020-03-11T05:49:20Z", "type": "commit"}, {"oid": "89a3c47d50eeb329538c03ee8f58a64ee733041d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/89a3c47d50eeb329538c03ee8f58a64ee733041d", "message": "change remove to removeIfHasKey", "committedDate": "2020-03-11T05:49:20Z", "type": "commit"}, {"oid": "67a6091953535597a65519d61fa070d6b0545ee3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/67a6091953535597a65519d61fa070d6b0545ee3", "message": "remove tempList", "committedDate": "2020-03-11T06:10:58Z", "type": "commit"}, {"oid": "645878fabecfab5384452c610163bd9ba5fa36e6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/645878fabecfab5384452c610163bd9ba5fa36e6", "message": "fix oneof integration tests", "committedDate": "2020-03-11T15:40:27Z", "type": "commit"}, {"oid": "b207d543473a556e4d62702734feebb3c2d49254", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b207d543473a556e4d62702734feebb3c2d49254", "message": "remove unused imports", "committedDate": "2020-03-11T17:05:12Z", "type": "commit"}]}