{"pr_number": 27508, "pr_title": "[Debugger Expression Evaluation] Enhance function, object method and langlib invocations support using semantic API ", "pr_createdAt": "2020-12-15T17:46:13Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/27508", "timeline": [{"oid": "f53d6b298c38c03149ff01b3c335d73c26239f26", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f53d6b298c38c03149ff01b3c335d73c26239f26", "message": "Integrate semantic API for function invocation evaluation", "committedDate": "2020-12-15T12:01:54Z", "type": "commit"}, {"oid": "6589344630f86d1c3b628b7ef2f8d20fa8a2b207", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6589344630f86d1c3b628b7ef2f8d20fa8a2b207", "message": "Refactor evaluation utils and improve defaultable parameter handling", "committedDate": "2020-12-15T13:46:23Z", "type": "commit"}, {"oid": "e2aebf966c8c7448fb8dc577ddf4df7fa61376c5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e2aebf966c8c7448fb8dc577ddf4df7fa61376c5", "message": "Fix object methods with semantic API support", "committedDate": "2020-12-15T15:04:12Z", "type": "commit"}, {"oid": "5343fcbb2ea28a717f7e2aceefd0bf09c71affd2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5343fcbb2ea28a717f7e2aceefd0bf09c71affd2", "message": "Fix runtime identifier encoding API related issue", "committedDate": "2020-12-15T17:35:37Z", "type": "commit"}, {"oid": "f8c9b0b2ce39e24fc81df43389975abc0b98a495", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f8c9b0b2ce39e24fc81df43389975abc0b98a495", "message": "Improve langlib invocations using semantic API", "committedDate": "2020-12-16T07:09:21Z", "type": "commit"}, {"oid": "0522e4d56077e83b857374ca7f8102b69756aee6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0522e4d56077e83b857374ca7f8102b69756aee6", "message": "Disable failing test scenarios due to a semantic API bug", "committedDate": "2020-12-16T07:10:02Z", "type": "commit"}, {"oid": "0db7f78ed0b9266862090ea47409d50f8e83edbd", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0db7f78ed0b9266862090ea47409d50f8e83edbd", "message": "Remove obsolete utils which extracts lang lib versions from loaded classes", "committedDate": "2020-12-16T07:20:23Z", "type": "commit"}, {"oid": "c482685a47a63c648c467e08f9249717d9bbb828", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c482685a47a63c648c467e08f9249717d9bbb828", "message": "Fix failing tests due to semantic API bugs", "committedDate": "2020-12-16T07:33:49Z", "type": "commit"}, {"oid": "dcab4970c32b9b40e187cd3d49be30a55862e847", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dcab4970c32b9b40e187cd3d49be30a55862e847", "message": "Sync with master and resolve merge conflicts\n\n# Conflicts:\n#\tmisc/debug-adapter/modules/debug-adapter-core/src/main/java/org/ballerinalang/debugadapter/SuspendedContext.java", "committedDate": "2020-12-16T07:40:17Z", "type": "commit"}, {"oid": "aefc37dc1b078de38872baa94c3da206a09b76f3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aefc37dc1b078de38872baa94c3da206a09b76f3", "message": "Resolve more conflicts", "committedDate": "2020-12-16T08:36:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDExMjkxNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27508#discussion_r544112915", "bodyText": "If the goal is to find the function from within the constructs in the module itself, you can use the moduleLevelSymbols() API. It basically retrieves the symbols of all the module-level constructs, including non-public ones.", "author": "pubudu91", "createdAt": "2020-12-16T08:44:06Z", "path": "misc/debug-adapter/modules/debug-adapter-core/src/main/java/org/ballerinalang/debugadapter/evaluation/engine/FunctionInvocationExpressionEvaluator.java", "diffHunk": "@@ -83,69 +87,39 @@ public BExpressionValue evaluate() throws EvaluationException {\n         }\n     }\n \n-    /**\n-     * Searches for a matching jvm method for a given ballerina function using its syntax node and the debug context\n-     * information.\n-     *\n-     * @return the matching JVM method, if available\n-     */\n-    private Optional<GeneratedStaticMethod> findFunctionFromLoadedClasses() {\n-        List<ReferenceType> allClasses = context.getAttachedVm().allClasses();\n-        DebugSourceType sourceType = context.getSourceType();\n-        for (ReferenceType cls : allClasses) {\n-            try {\n-                // Expected class name should end with the file name of the ballerina source, only for single\n-                // ballerina sources. (We cannot be sure about the module context, as we can invoke any method\n-                // defined within the module.)\n-                if (sourceType == DebugSourceType.SINGLE_FILE && !cls.name().endsWith(context.getFileName().get())) {\n-                    continue;\n-                }\n-                // If the sources reside inside a ballerina module/project, generated class name should start with the\n-                // organization name of the ballerina module/project source.\n-                if (sourceType == DebugSourceType.PACKAGE && !cls.name().startsWith(context.getPackageOrg().get())) {\n-                    continue;\n-                }\n-                List<Method> methods = cls.methodsByName(functionName);\n-                for (Method method : methods) {\n-                    // Note - All the ballerina functions are represented as java static methods and all the generated\n-                    // jvm methods contain strand as its first argument.\n-                    if (method.isStatic()) {\n-                        return Optional.of(new GeneratedStaticMethod(context, cls, method));\n-                    }\n-                }\n-            } catch (ClassNotPreparedException ignored) {\n-                // Unprepared classes should be skipped.\n-            }\n+    private Optional<FunctionSymbol> findFunctionWithinModule() {\n+        SemanticModel semanticContext = context.getDebugCompiler().getSemanticInfo();\n+        LinePosition position = LinePosition.from(context.getLineNumber(), 0);\n+        List<Symbol> functionMatches = semanticContext.visibleSymbols(context.getFileNameWithExt().get(), position)", "originalCommit": "dcab4970c32b9b40e187cd3d49be30a55862e847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIxOTEzMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27508#discussion_r544219132", "bodyText": "+1. Changed in e1c2ab6", "author": "NipunaRanasinghe", "createdAt": "2020-12-16T11:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDExMjkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMTE0Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27508#discussion_r544121143", "bodyText": "Same comment as above here.", "author": "pubudu91", "createdAt": "2020-12-16T08:56:23Z", "path": "misc/debug-adapter/modules/debug-adapter-core/src/main/java/org/ballerinalang/debugadapter/evaluation/engine/MethodCallExpressionEvaluator.java", "diffHunk": "@@ -91,6 +113,99 @@ public BExpressionValue evaluate() throws EvaluationException {\n         }\n     }\n \n+    private Value invokeObjectMethod(BVariable resultVar) throws EvaluationException {\n+        boolean isFoundObjectMethod = false;\n+        try {\n+            String className = resultVar.getDapVariable().getValue();\n+            Optional<ClassSymbol> classDef = findClassDefWithinModule(className);\n+            if (classDef.isEmpty()) {\n+                throw new EvaluationException(String.format(EvaluationExceptionKind.CLASS_NOT_FOUND.getString(),\n+                        className));\n+            }\n+\n+            Optional<MethodSymbol> objectMethodDef = findObjectMethodInClass(classDef.get(), methodName);\n+            if (objectMethodDef.isEmpty()) {\n+                throw new EvaluationException(\n+                        String.format(EvaluationExceptionKind.OBJECT_METHOD_NOT_FOUND.getString(),\n+                                syntaxNode.methodName().toString().trim(), className));\n+            }\n+\n+            isFoundObjectMethod = true;\n+            GeneratedInstanceMethod objectMethod = getObjectMethodByName(resultVar, methodName);\n+            objectMethod.setNamedArgValues(generateNamedArgs(context, methodName, objectMethodDef.get().\n+                    typeDescriptor(), argEvaluators));\n+            return objectMethod.invoke();\n+        } catch (EvaluationException e) {\n+            // If the object method is not found, we have to ignore the Evaluation Exception and try find any\n+            // matching lang library functions.\n+            if (isFoundObjectMethod) {\n+                throw e;\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private Value invokeLangLibMethod(BExpressionValue resultVar) throws EvaluationException {\n+\n+        FunctionSymbol langLibFunctionDef = null;\n+        GeneratedStaticMethod langLibMethod = null;\n+\n+        // Tries to use the dedicated lang library functions.\n+        String langLibName = getAssociatedLangLibName(resultVar.getType());\n+        Optional<ModuleSymbol> langLibDef = getLangLibDefinition(context, langLibName);\n+        if (langLibDef.isPresent()) {\n+            Optional<FunctionSymbol> functionDef = getLangLibFunctionDefinition(context, langLibDef.get(), methodName);\n+            if (functionDef.isPresent()) {\n+                String langLibCls = getQualifiedLangLibClassName(langLibDef.get(), langLibName);\n+                langLibFunctionDef = functionDef.get();\n+                langLibMethod = loadLangLibMethod(context, resultVar, langLibCls, methodName);\n+            }\n+        }\n+\n+        // Tries to use \"value\" lang library functions.\n+        if (langLibMethod == null) {\n+            Optional<ModuleSymbol> valueLibDef = getLangLibDefinition(context, LANG_LIB_VALUE);\n+            if (valueLibDef.isEmpty()) {\n+                throw new EvaluationException(String.format(EvaluationExceptionKind.LANG_LIB_NOT_FOUND.getString(),\n+                        LANG_LIB_PACKAGE_PREFIX + langLibName + \", \" + LANG_LIB_PACKAGE_PREFIX + LANG_LIB_VALUE));\n+            }\n+\n+            Optional<FunctionSymbol> functionDef = getLangLibFunctionDefinition(context, valueLibDef.get(), methodName);\n+            if (functionDef.isEmpty()) {\n+                throw new EvaluationException(String.format(EvaluationExceptionKind.LANG_LIB_METHOD_NOT_FOUND.\n+                        getString(), methodName, langLibName));\n+            }\n+\n+            String langLibCls = getQualifiedLangLibClassName(valueLibDef.get(), LANG_LIB_VALUE);\n+            langLibFunctionDef = functionDef.get();\n+            langLibMethod = loadLangLibMethod(context, resultVar, langLibCls, methodName);\n+        }\n+\n+        argEvaluators.add(0, new AbstractMap.SimpleEntry<>(\"\", objectExpressionEvaluator));\n+        FunctionTypeSymbol functionTypeDesc = langLibFunctionDef.typeDescriptor();\n+        Map<String, Value> argValueMap = generateNamedArgs(context, methodName, functionTypeDesc, argEvaluators);\n+        langLibMethod.setNamedArgValues(argValueMap);\n+        return langLibMethod.invoke();\n+    }\n+\n+    private Optional<ClassSymbol> findClassDefWithinModule(String className) {\n+        SemanticModel semanticContext = context.getDebugCompiler().getSemanticInfo();\n+        LinePosition position = LinePosition.from(context.getLineNumber(), 0);\n+\n+        return semanticContext.visibleSymbols(context.getFileNameWithExt().get(), position)", "originalCommit": "dcab4970c32b9b40e187cd3d49be30a55862e847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIxOTE5OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27508#discussion_r544219198", "bodyText": "+1. Changed in e1c2ab6", "author": "NipunaRanasinghe", "createdAt": "2020-12-16T11:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyMTE0Mw=="}], "type": "inlineReview"}, {"oid": "e1c2ab669be7fb1afc32e20ddf56e57933e50d76", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e1c2ab669be7fb1afc32e20ddf56e57933e50d76", "message": "Add review suggestions", "committedDate": "2020-12-16T11:00:43Z", "type": "commit"}]}