{"pr_number": 21476, "pr_title": "Implement get generated keys only if supported by JDBC", "pr_createdAt": "2020-03-04T10:02:16Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476", "timeline": [{"oid": "6b1ac68f03d12320f0b729a65146a0930665c8dc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6b1ac68f03d12320f0b729a65146a0930665c8dc", "message": "Improve the supportsGetGeneratedkey() function\n\nImprove the implementation\n\nChange the error message", "committedDate": "2020-03-04T10:04:42Z", "type": "commit"}, {"oid": "dded750f7cbd57c06da9ce4a6e6ab95151bba783", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/dded750f7cbd57c06da9ce4a6e6ab95151bba783", "message": "Remove unwanted files", "committedDate": "2020-03-04T10:07:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2NjI2Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r387566263", "bodyText": "Why this is a property in ClientConfiguration level? Can't we make it a optional parameter in update action only?", "author": "anupama-pathirage", "createdAt": "2020-03-04T10:10:36Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/types.bal", "diffHunk": "@@ -25,12 +25,15 @@ import ballerinax/java;\n # + poolOptions - Properties for the connection pool configuration. Refer `PoolOptions` for more details\n # + dbOptions - A map of DB specific properties. These properties will have an effect only if the dataSourceClassName is\n #               provided in poolOptions\n+# + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is `true`.\n+#                      It will return auto-generated keys only if supported by JDBC\n public type ClientConfiguration record {|\n     string url = \"\";\n     string username = \"\";\n     string password = \"\";\n     PoolOptions poolOptions?;\n     map<anydata> dbOptions = {};\n+    boolean getGeneratedKeys = false;", "originalCommit": "dded750f7cbd57c06da9ce4a6e6ab95151bba783", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a51708cc7a8bfd913f183f7850b8093e985220a7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a51708cc7a8bfd913f183f7850b8093e985220a7", "message": "Fix the reviewed comment\n\nMake changes in the example\n\nAdd value in the bal file", "committedDate": "2020-03-05T06:19:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwMzA2NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388203064", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is\n          \n          \n            \n                # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if the value is", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:26:08Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,16 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwMzgwNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388203805", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #                      `true`.It will return auto-generated keys only if supported by JDBC\n          \n          \n            \n                #                      `true`. If it is not supported by the used JDBC driver, still it will return `nil`.", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:27:26Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,16 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is\n+    #                      `true`.It will return auto-generated keys only if supported by JDBC", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNDMwMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388204303", "bodyText": "please change similar to above doc comment suggestion", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:28:17Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +80,21 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwNTcxNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388205717", "bodyText": "It seems the parameters are not consistent in this remote function now. The rollbackAllInFailure is a boolean while the next similar parameter getGeneratedKeys is boolean?", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:30:49Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +80,21 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is\n+    #                      `true`.It will return auto-generated keys only if supported by JDBC\n     # + return - A `BatchUpdateResult` with the updated row count and returned error if any. If all the commands\n     #            in the batch have executed successfully, the error will be `nil`. If one or more commands have failed,\n     #            the `returnedError` field will give the corresponding `Error` along with the int[] which\n-    #            contains updated row count or the status returned from each command in the batch.\n+    #            contains updated row count or the status returned from each command in the batch\n     public remote function batchUpdate(@untainted string sqlQuery, boolean rollbackAllInFailure,\n-                                       Param?[]... parameters)\n+                                       boolean? getGeneratedKeys = (), Param?[]... parameters)", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIxMjQzNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388212435", "bodyText": "IMO, instead of boolean? we should use boolean with default value. So for simple update statements which doesn't have parameters, we can specify the sqlQuery only", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:42:57Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,16 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is\n+    #                      `true`.It will return auto-generated keys only if supported by JDBC\n     # + return - `UpdateResult` with the updated row count and key column values,\n     #             else `Error` will be returned if there is an error\n-    public remote function update(@untainted string sqlQuery, Param... parameters)\n-                                  returns UpdateResult|Error {\n+    public remote function update(@untainted string sqlQuery, boolean? getGeneratedKeys = (),", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIxNjQ1Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388216456", "bodyText": "Shall we swap parameters and getGeneratedKeys? Bascially have the same order in the remote function it self.", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:50:21Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,16 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if value is\n+    #                      `true`.It will return auto-generated keys only if supported by JDBC\n     # + return - `UpdateResult` with the updated row count and key column values,\n     #             else `Error` will be returned if there is an error\n-    public remote function update(@untainted string sqlQuery, Param... parameters)\n-                                  returns UpdateResult|Error {\n+    public remote function update(@untainted string sqlQuery, boolean? getGeneratedKeys = (),\n+                                  Param... parameters) returns UpdateResult|Error {\n         if (!self.clientActive) {\n             return self.handleStoppedClientInvocation();\n         }\n-        return nativeUpdate(self, java:fromString(sqlQuery), parameters);\n+        return nativeUpdate(self, java:fromString(sqlQuery), parameters, getGeneratedKeys);", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxODYyNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388418627", "bodyText": "We  can't swap as required parameter not allowed after default-able parameters.\nERROR: ballerinax/java.jdbc:0.0.0::client.bal:132:24:: required parameter not allowed after defaultable parameters", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-05T16:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIxNjQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5MzA0MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388693041", "bodyText": "We don't need to make the parameter defaultable in internal function. because we always have a value for that parameter.", "author": "daneshk", "createdAt": "2020-03-06T03:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIxNjQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIxNzUwMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388217501", "bodyText": "Why only this map is mar as nillable? Why we are not being consistent with UpdateResult record?", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:52:10Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/types.bal", "diffHunk": "@@ -232,7 +232,7 @@ public type UpdateResult record {|\n # + returnedError - The `Error` returned from the remote function in case of a failure\n public type BatchUpdateResult record {|\n     int[] updatedRowCount;\n-    map<anydata[]> generatedKeys;\n+    map<anydata[]>? generatedKeys;", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NTU1NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388775555", "bodyText": "Fixed.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-06T08:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIxNzUwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIyMDQyMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388220422", "bodyText": "What is the reason for appending . at the end instead of the beginning of the line?", "author": "anupama-pathirage", "createdAt": "2020-03-05T10:57:58Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/methods/ExternFunctions.java", "diffHunk": "@@ -72,9 +74,9 @@ public static void createClient(ObjectValue client, MapValue<String, Object> con\n         String dbType = url.split(\":\")[1].toUpperCase(Locale.getDefault());\n \n         SQLDatasource.SQLDatasourceParamsBuilder builder = new SQLDatasource.SQLDatasourceParamsBuilder(dbType);\n-        SQLDatasource.SQLDatasourceParams sqlDatasourceParams = builder.withPoolOptions(poolOptionsWrapper)\n-                .withJdbcUrl(url).withUsername(username).withPassword(password).withDbOptionsMap(dbOptions)\n-                .withIsGlobalDatasource(userProvidedPoolOptionsNotPresent).build();\n+        SQLDatasource.SQLDatasourceParams sqlDatasourceParams = builder.withPoolOptions(poolOptionsWrapper).\n+                withJdbcUrl(url).withUsername(username).withPassword(password).withDbOptionsMap(dbOptions).\n+                withIsGlobalDatasource(userProvidedPoolOptionsNotPresent).build();", "originalCommit": "a51708cc7a8bfd913f183f7850b8093e985220a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "386f5d28bff6c29fba0dd770106c5981f6cd69c5", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/386f5d28bff6c29fba0dd770106c5981f6cd69c5", "message": "Make suggested changes", "committedDate": "2020-03-05T19:11:49Z", "type": "commit"}, {"oid": "3ba0164d1576381c0b6953f54b8565240cba0a63", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3ba0164d1576381c0b6953f54b8565240cba0a63", "message": "Merge https://github.com/ballerina-platform/ballerina-lang into db_get_generated_key", "committedDate": "2020-03-05T19:40:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5MTU0MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388691540", "bodyText": "IMO, a better name for this variable is returnGeneratedKeys", "author": "daneshk", "createdAt": "2020-03-06T03:04:26Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,16 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if the value is\n+    #                      `true`. If it is not supported by the used JDBC driver, still it will return `nil`.\n     # + return - `UpdateResult` with the updated row count and key column values,\n     #             else `Error` will be returned if there is an error\n-    public remote function update(@untainted string sqlQuery, Param... parameters)\n-                                  returns UpdateResult|Error {\n+    public remote function update(@untainted string sqlQuery, boolean getGeneratedKeys = false, Param... parameters)", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5MzI4Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388693287", "bodyText": "Same as above. I think a better name for this variable is returnGeneratedKeys", "author": "daneshk", "createdAt": "2020-03-06T03:12:36Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +80,21 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if the value is\n+    #                      `true`. If it is not supported by the used JDBC driver, still it will return `nil`.\n     # + return - A `BatchUpdateResult` with the updated row count and returned error if any. If all the commands\n     #            in the batch have executed successfully, the error will be `nil`. If one or more commands have failed,\n     #            the `returnedError` field will give the corresponding `Error` along with the int[] which\n-    #            contains updated row count or the status returned from each command in the batch.\n-    public remote function batchUpdate(@untainted string sqlQuery, boolean rollbackAllInFailure,\n-                                       Param?[]... parameters)\n+    #            contains updated row count or the status returned from each command in the batch\n+    public remote function batchUpdate(@untainted string sqlQuery, boolean rollbackAllInFailure = false,\n+                                       boolean getGeneratedKeys = false, Param?[]... parameters)", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5NTU3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388695578", "bodyText": "# + getGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is set to true, auto-generated keys are made available to retrieve when the statement is executed. If the underline JDBC driver does not support it, still it will return `()` value.", "author": "daneshk", "createdAt": "2020-03-06T03:23:42Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +80,21 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + getGeneratedKeys - Allow to retrieves auto-generated keys after a statement has been executed if the value is\n+    #                      `true`. If it is not supported by the used JDBC driver, still it will return `nil`.", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5NzMzNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388697337", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean supportsGetGeneratedKeys = false;\n          \n          \n            \n                private boolean supportGeneratedKeys = false;", "author": "daneshk", "createdAt": "2020-03-06T03:32:23Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/datasource/SQLDatasource.java", "diffHunk": "@@ -50,6 +51,7 @@\n     private AtomicInteger clientCounter = new AtomicInteger(0);\n     private Lock mutex = new ReentrantLock();\n     private boolean poolShutdown = false;\n+    private boolean supportsGetGeneratedKeys = false;", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMTE1OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388711158", "bodyText": "Shall we change this to something like below and use that boolean for other two places? That will avoid taking && twice with the same booleans.\nboolean retrieveGeneratedKeys = isKeyRetrievalSupportedStatement() && getGeneratedKey", "author": "anupama-pathirage", "createdAt": "2020-03-06T04:46:06Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/statement/UpdateStatement.java", "diffHunk": "@@ -74,24 +78,26 @@ public Object execute() {\n             ArrayValue generatedParams = constructParameters(parameters);\n             conn = getDatabaseConnection(strand, client, datasource);\n             String processedQuery = createProcessedQueryString(query, generatedParams);\n-            stmt = conn.prepareStatement(processedQuery, Statement.RETURN_GENERATED_KEYS);\n+\n+            boolean keyRetrievalSupportedStatement = isKeyRetrievalSupportedStatement();", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMTgxMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388711812", "bodyText": "What is the purpose of this method?", "author": "anupama-pathirage", "createdAt": "2020-03-06T04:49:33Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/statement/UpdateStatement.java", "diffHunk": "@@ -133,7 +134,25 @@ private boolean isDdlStatement() {\n         return populatedUpdateResultRecord;\n     }\n \n-    private enum DdlKeyword {\n-        CREATE, ALTER, DROP, TRUNCATE, COMMENT, RENAME\n+    private enum GenKeyStmt {\n+        INSERT, DELETE, UPDATE, MERGE\n+    }\n+\n+    /**\n+     * Check if the statement is one of INSERT, DELETE, UPDATE or MERGE.\n+     */\n+    private boolean isKeyRetrievalSupportedStatement() {\n+        if (datasource.isKeyRetrievalSupported()) {\n+            return Arrays.stream(GenKeyStmt.values()).anyMatch(stmt -> this.query.trim().toUpperCase(Locale.ENGLISH).\n+                    startsWith(stmt.name()));\n+        } else {\n+            ErrorHandlerUtils.printError(\"ERROR: Unable to get keys as JDBC is not supported to retrieve \" +\n+                    \"auto-generated keys from \" + datasource.getDatabaseProductName());\n+            return false;\n+        }\n+    }\n+\n+    public static boolean getGeneratedKey(Object getGeneratedKey) {", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMjM1MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388712351", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        boolean keyRetrievalSupportedStatement = datasource.isKeyRetrievalSupported();\n          \n          \n            \n                        boolean keyRetrievalSupported = datasource.isKeyRetrievalSupported();", "author": "daneshk", "createdAt": "2020-03-06T04:52:32Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/statement/BatchUpdateStatement.java", "diffHunk": "@@ -83,8 +87,8 @@ public BatchUpdateStatement(ObjectValue client, SQLDatasource datasource, String\n         String errorMessagePrefix = \"failed to execute batch update\";\n         try {\n             conn = getDatabaseConnection(strand, client, datasource);\n-            boolean generatedKeyReturningSupported = isGeneratedKeyReturningSupported();\n-            if (generatedKeyReturningSupported) {\n+            boolean keyRetrievalSupportedStatement = datasource.isKeyRetrievalSupported();", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMjQ4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388712488", "bodyText": "Normal practice is boolean returned function name = is + boolean variable name. Can we rename the method name or variable name to follow the same practice?", "author": "anupama-pathirage", "createdAt": "2020-03-06T04:53:22Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/datasource/SQLDatasource.java", "diffHunk": "@@ -119,6 +123,10 @@ public boolean isPoolShutdown() {\n         return poolShutdown;\n     }\n \n+    public boolean isKeyRetrievalSupported() {\n+        return this.supportsGetGeneratedKeys;", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMzQ3Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388713476", "bodyText": "Why do we need to define this constant like this? This is not a jdbc related constant. @daneshk / @wggihan Are we following similar pattern in other modules?", "author": "anupama-pathirage", "createdAt": "2020-03-06T04:58:33Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/Constants.java", "diffHunk": "@@ -165,6 +165,9 @@\n         public static final String MSSQL_SERVER = \"microsoft sql server\";\n     }\n \n+    // Warning suppression\n+    public static final String UNCHECKED = \"unchecked\";", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc2Mzg2Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388763866", "bodyText": "AFAIK, directly using annotation without using this kind of constant in other modules.", "author": "wggihan", "createdAt": "2020-03-06T08:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMzQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNDA2MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388714060", "bodyText": "We cannot rely on this API to check whether DB driver supports get generated keys. Because there is no guarantee that all DB driver implements this function. IMO we should not use this for our internal logic", "author": "daneshk", "createdAt": "2020-03-06T05:01:23Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/datasource/SQLDatasource.java", "diffHunk": "@@ -61,7 +63,9 @@ public SQLDatasource init(SQLDatasourceParams sqlDatasourceParams) {\n             throw ErrorGenerator.getSQLDatabaseError(e);\n         }\n         try (Connection con = getSQLConnection()) {\n-            databaseProductName = con.getMetaData().getDatabaseProductName().toLowerCase(Locale.ENGLISH);\n+            DatabaseMetaData metaData = con.getMetaData();\n+            databaseProductName = metaData.getDatabaseProductName().toLowerCase(Locale.ENGLISH);\n+            this.supportsGetGeneratedKeys = metaData.supportsGetGeneratedKeys();", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNDMxNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388714316", "bodyText": "Instead of this comment, shall we use descriptive name for the function itself. This is the pattern followed for other test cases as well.", "author": "anupama-pathirage", "createdAt": "2020-03-06T05:02:44Z", "path": "stdlib/jdbc/src/test/java/org/ballerinax/jdbc/actions/UpdateTest.java", "diffHunk": "@@ -229,12 +229,24 @@ public void testInsertBoolDataAsIntsAndReturnInts() {\n         Assert.assertEquals(((BInteger) returns[2]).intValue(), 1);\n     }\n \n+    /**\n+     * Test for getting auto-generated key when getGeneratedKey is true and the table doesn't have auto generated key.", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNjA5OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388716098", "bodyText": "Shall we remove checking keyRetrievalSupportedStatement and only rely on value set by the user?\nand pass all the errors we encounter while performing the operation to the user.", "author": "daneshk", "createdAt": "2020-03-06T05:11:36Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/statement/BatchUpdateStatement.java", "diffHunk": "@@ -83,8 +87,8 @@ public BatchUpdateStatement(ObjectValue client, SQLDatasource datasource, String\n         String errorMessagePrefix = \"failed to execute batch update\";\n         try {\n             conn = getDatabaseConnection(strand, client, datasource);\n-            boolean generatedKeyReturningSupported = isGeneratedKeyReturningSupported();\n-            if (generatedKeyReturningSupported) {\n+            boolean keyRetrievalSupportedStatement = datasource.isKeyRetrievalSupported();\n+            if (getGeneratedKey && keyRetrievalSupportedStatement) {", "originalCommit": "3ba0164d1576381c0b6953f54b8565240cba0a63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d1c774a621c60895931bc54f3e7a6abd07cbf11", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9d1c774a621c60895931bc54f3e7a6abd07cbf11", "message": "Merge https://github.com/ballerina-platform/ballerina-lang into db_get_generated_key", "committedDate": "2020-03-06T06:59:31Z", "type": "commit"}, {"oid": "795d8a7c8689ac2af32d13bed5ae811980f957df", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/795d8a7c8689ac2af32d13bed5ae811980f957df", "message": "Improve the implementation", "committedDate": "2020-03-06T08:27:21Z", "type": "commit"}, {"oid": "5ecf0cabaa906d97448341042d4ff83688ad82e4", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5ecf0cabaa906d97448341042d4ff83688ad82e4", "message": "Change variables' name", "committedDate": "2020-03-06T08:41:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzNTkzNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388835934", "bodyText": "Shouldn't it be an error if the underline JDBC driver does not support it?", "author": "anupama-pathirage", "createdAt": "2020-03-06T10:49:41Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,18 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, still it will return `()`", "originalCommit": "5ecf0cabaa906d97448341042d4ff83688ad82e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg0MDk4OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388840989", "bodyText": "+1. we need to send an error if underline JDBC not supported", "author": "daneshk", "createdAt": "2020-03-06T11:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzNTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg0NDI2Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388844263", "bodyText": "Yes, It returns an error  but I forgot to update here.\nI have fixed it.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-06T11:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzNTkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzNjY5OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388836698", "bodyText": "Same as above?", "author": "anupama-pathirage", "createdAt": "2020-03-06T10:51:19Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +82,23 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, still it will return `()`\n+    #                         value", "originalCommit": "5ecf0cabaa906d97448341042d4ff83688ad82e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d623a82ce636b043c49d8075c6ea01963e994a8f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d623a82ce636b043c49d8075c6ea01963e994a8f", "message": "Make changes in the bal file", "committedDate": "2020-03-06T11:05:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3MjAxMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388872011", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #                         is executed. If the underline JDBC driver does not support it, still it will return\n          \n          \n            \n                #                         is executed. If the underline JDBC driver does not support it, it will return", "author": "daneshk", "createdAt": "2020-03-06T12:19:17Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,18 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, still it will return", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3MjI4OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388872289", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #                         is executed. If the underline JDBC driver does not support it, still it will return\n          \n          \n            \n                #                         is executed. If the underline JDBC driver does not support it, it will return", "author": "daneshk", "createdAt": "2020-03-06T12:20:06Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +82,23 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, still it will return", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NDQzMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388874430", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #                         set to true, auto-generated keys are made available to retrieve when the statement\n          \n          \n            \n                #                         set to `true`, auto-generated keys are made available to retrieve when the statement", "author": "anupama-pathirage", "createdAt": "2020-03-06T12:25:49Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,18 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NDU2NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388874565", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #                         an `Error`\n          \n          \n            \n                #                         an `Error`.", "author": "anupama-pathirage", "createdAt": "2020-03-06T12:26:10Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,18 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, still it will return\n+    #                         an `Error`", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NDcyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388874725", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #                         set to true, auto-generated keys are made available to retrieve when the statement\n          \n          \n            \n                #                         set to `true`, auto-generated keys are made available to retrieve when the statement", "author": "anupama-pathirage", "createdAt": "2020-03-06T12:26:33Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +82,23 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NDc3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388874778", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #                         an `Error`\n          \n          \n            \n                #                         an `Error`.", "author": "anupama-pathirage", "createdAt": "2020-03-06T12:26:42Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +82,23 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, still it will return\n+    #                         an `Error`", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NDk5MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388874991", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                #            contains updated row count or the status returned from each command in the batch\n          \n          \n            \n                #            contains updated row count or the status returned from each command in the batch.", "author": "anupama-pathirage", "createdAt": "2020-03-06T12:27:08Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +82,23 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to true, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, still it will return\n+    #                         an `Error`\n     # + return - A `BatchUpdateResult` with the updated row count and returned error if any. If all the commands\n     #            in the batch have executed successfully, the error will be `nil`. If one or more commands have failed,\n     #            the `returnedError` field will give the corresponding `Error` along with the int[] which\n-    #            contains updated row count or the status returned from each command in the batch.\n+    #            contains updated row count or the status returned from each command in the batch", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NTEzNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388875137", "bodyText": "The convention is to use the full stop if we have multiple sentences.", "author": "anupama-pathirage", "createdAt": "2020-03-06T12:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NDk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NjEwMg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388876102", "bodyText": "Can we add a test case for this scenario as well.", "author": "anupama-pathirage", "createdAt": "2020-03-06T12:29:48Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/statement/UpdateStatement.java", "diffHunk": "@@ -70,26 +71,36 @@ public Object execute() {\n         checkAndObserveSQLAction(strand, datasource, query);\n         boolean isInTransaction = strand.isInTransaction();\n         String errorMessagePrefix = \"failed to execute update query: \";\n+        MapValue<String, Object> generatedKeys = new MapValueImpl<>();\n         try {\n             ArrayValue generatedParams = constructParameters(parameters);\n             conn = getDatabaseConnection(strand, client, datasource);\n             String processedQuery = createProcessedQueryString(query, generatedParams);\n-            stmt = conn.prepareStatement(processedQuery, Statement.RETURN_GENERATED_KEYS);\n+\n+            if (returnGeneratedKeys) {\n+                stmt = conn.prepareStatement(processedQuery, PreparedStatement.RETURN_GENERATED_KEYS);\n+            } else {\n+                stmt = conn.prepareStatement(processedQuery);\n+            }\n+\n             ProcessedStatement processedStatement = new ProcessedStatement(conn, stmt, generatedParams,\n                     datasource.getDatabaseProductName());\n             stmt = processedStatement.prepare();\n             int count = stmt.executeUpdate();\n-            MapValue<String, Object> generatedKeys;\n-            if (!isDdlStatement()) {\n-                rs = stmt.getGeneratedKeys();\n-                //This result set contains the auto generated keys.\n-                if (rs.next()) {\n-                    generatedKeys = getGeneratedKeys(rs);\n+            if (returnGeneratedKeys) {\n+                if (isKeyRetrievalSupported()) {\n+                    rs = stmt.getGeneratedKeys();\n+                    //This result set contains the auto generated keys.\n+                    if (rs.next()) {\n+                        generatedKeys = getGeneratedKeys(rs);\n+                    }\n                 } else {\n-                    generatedKeys = new MapValueImpl<>();\n+                    handleErrorOnTransaction(this.strand);\n+                    String message = \"The returnGeneratedKeys only support INSERT, UPDATE, DELETE and MERGE \" +\n+                            \"operations.\";\n+                    checkAndObserveSQLError(strand, \"execute update failed: \" + message);\n+                    return ErrorGenerator.getSQLApplicationError(message);", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM4MTczNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r389381737", "bodyText": "Added.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-08T15:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3NjEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4MTIwNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r388881205", "bodyText": "Why do we need this extra check?", "author": "daneshk", "createdAt": "2020-03-06T12:42:16Z", "path": "stdlib/jdbc/src/main/java/org/ballerinax/jdbc/statement/UpdateStatement.java", "diffHunk": "@@ -70,26 +71,36 @@ public Object execute() {\n         checkAndObserveSQLAction(strand, datasource, query);\n         boolean isInTransaction = strand.isInTransaction();\n         String errorMessagePrefix = \"failed to execute update query: \";\n+        MapValue<String, Object> generatedKeys = new MapValueImpl<>();\n         try {\n             ArrayValue generatedParams = constructParameters(parameters);\n             conn = getDatabaseConnection(strand, client, datasource);\n             String processedQuery = createProcessedQueryString(query, generatedParams);\n-            stmt = conn.prepareStatement(processedQuery, Statement.RETURN_GENERATED_KEYS);\n+\n+            if (returnGeneratedKeys) {\n+                stmt = conn.prepareStatement(processedQuery, PreparedStatement.RETURN_GENERATED_KEYS);\n+            } else {\n+                stmt = conn.prepareStatement(processedQuery);\n+            }\n+\n             ProcessedStatement processedStatement = new ProcessedStatement(conn, stmt, generatedParams,\n                     datasource.getDatabaseProductName());\n             stmt = processedStatement.prepare();\n             int count = stmt.executeUpdate();\n-            MapValue<String, Object> generatedKeys;\n-            if (!isDdlStatement()) {\n-                rs = stmt.getGeneratedKeys();\n-                //This result set contains the auto generated keys.\n-                if (rs.next()) {\n-                    generatedKeys = getGeneratedKeys(rs);\n+            if (returnGeneratedKeys) {\n+                if (isKeyRetrievalSupported()) {", "originalCommit": "d623a82ce636b043c49d8075c6ea01963e994a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM4MTY0NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r389381644", "bodyText": "The returnGeneratedKeys only support INSERT, UPDATE, DELETE and MERGE operations So we need to check if the statement has one of these.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-08T15:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4MTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzMDkyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r389430925", "bodyText": "Do we need specifically handle this? what if we not handled and user set return generated keys for other operation. do we get a meaningful error from the driver?", "author": "daneshk", "createdAt": "2020-03-09T01:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4MTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxOTg5Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390219892", "bodyText": "We haven't got a meaningful error from the driver but got an empty ResultSet. So, I specifically handled this.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-10T10:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4MTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI2MTYzMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390261630", "bodyText": "@daneshk I too think we don't need to explicitly check this. Isn't it a driver or DB dependent thing whether throwing an exception or returning empty result set. Why we are limiting only to the INSERT, DELETE, UPDATE, MERGE since the developer now has the full control to retrieve the generated keys or not.", "author": "anupama-pathirage", "createdAt": "2020-03-10T11:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4MTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzNTI2Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390335267", "bodyText": "Removed it.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-10T14:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4MTIwNQ=="}], "type": "inlineReview"}, {"oid": "7f8f969e23a6e9176ca029ec72cce2590cb75549", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7f8f969e23a6e9176ca029ec72cce2590cb75549", "message": "Merge https://github.com/ballerina-platform/ballerina-lang into db_get_generated_key", "committedDate": "2020-03-08T14:17:43Z", "type": "commit"}, {"oid": "90dac1112bb6177ae3fc4d510624bf055576e0e9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/90dac1112bb6177ae3fc4d510624bf055576e0e9", "message": "Fix suggested changes", "committedDate": "2020-03-08T15:46:34Z", "type": "commit"}, {"oid": "2d526150f5addfdbeb8c63556baa5a98e26ed51c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2d526150f5addfdbeb8c63556baa5a98e26ed51c", "message": "Fix integration test failure", "committedDate": "2020-03-08T18:08:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI1NTYxMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390255610", "bodyText": "Can't we make this a defaultable parameter with default value is false. Then we don't need to append false for simple update statements which doesn't have parameters", "author": "anupama-pathirage", "createdAt": "2020-03-10T11:40:42Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -59,14 +59,17 @@ public type Client client object {\n     #\n     # + sqlQuery - SQL statement to execute\n     # + parameters - The parameters to be passed to the update query\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to `true`, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, it will return an `Error`.\n     # + return - `UpdateResult` with the updated row count and key column values,\n     #             else `Error` will be returned if there is an error\n-    public remote function update(@untainted string sqlQuery, Param... parameters)\n-                                  returns UpdateResult|Error {\n+    public remote function update(@untainted string sqlQuery, boolean returnGeneratedKeys, Param... parameters)", "originalCommit": "2d526150f5addfdbeb8c63556baa5a98e26ed51c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI1NzIyNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390257225", "bodyText": "Same as above. Can't we change the boolean arugments to defaultable parameters?", "author": "anupama-pathirage", "createdAt": "2020-03-10T11:44:04Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +81,22 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to `true`, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, it will return an `Error`.\n     # + return - A `BatchUpdateResult` with the updated row count and returned error if any. If all the commands\n     #            in the batch have executed successfully, the error will be `nil`. If one or more commands have failed,\n     #            the `returnedError` field will give the corresponding `Error` along with the int[] which\n     #            contains updated row count or the status returned from each command in the batch.\n     public remote function batchUpdate(@untainted string sqlQuery, boolean rollbackAllInFailure,\n-                                       Param?[]... parameters)\n+                                       boolean returnGeneratedKeys, Param?[]... parameters)", "originalCommit": "2d526150f5addfdbeb8c63556baa5a98e26ed51c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cd58703e5c603bd46f47dd45300816d5bf2beb57", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cd58703e5c603bd46f47dd45300816d5bf2beb57", "message": "Change the mendatory parameter to a defaultable parameter", "committedDate": "2020-03-10T12:12:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI3NjE1MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390276150", "bodyText": "IMO we should make rollbackAllInFailure also a defaultable parameter.", "author": "anupama-pathirage", "createdAt": "2020-03-10T12:24:07Z", "path": "stdlib/jdbc/src/main/ballerina/src/java.jdbc/client.bal", "diffHunk": "@@ -78,18 +81,22 @@ public type Client client object {\n     #           may or may not continue to process the remaining commands in the batch. This property can be\n     #           used to override this behavior. When it is set to true, if there is a failure in a few commands and\n     #           the JDBC driver continues with the remaining commands, the successfully executed commands in the batch\n-    #           also will get rolled back.\n+    #           also will get rolled back\n+    # + returnGeneratedKeys - Indicate that generated keys should be made available for retrieval. If the value is\n+    #                         set to `true`, auto-generated keys are made available to retrieve when the statement\n+    #                         is executed. If the underline JDBC driver does not support it, it will return an `Error`.\n     # + return - A `BatchUpdateResult` with the updated row count and returned error if any. If all the commands\n     #            in the batch have executed successfully, the error will be `nil`. If one or more commands have failed,\n     #            the `returnedError` field will give the corresponding `Error` along with the int[] which\n     #            contains updated row count or the status returned from each command in the batch.\n     public remote function batchUpdate(@untainted string sqlQuery, boolean rollbackAllInFailure,\n-                                       Param?[]... parameters)\n+                                       boolean returnGeneratedKeys = false, Param?[]... parameters)", "originalCommit": "cd58703e5c603bd46f47dd45300816d5bf2beb57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "644cb2f52b862dbd8a46e4dac5f3d48104921f3c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/644cb2f52b862dbd8a46e4dac5f3d48104921f3c", "message": "Fix review comments", "committedDate": "2020-03-10T13:43:04Z", "type": "commit"}, {"oid": "b991435fedeab740ae1d6d4c1e985744b6e88d4e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b991435fedeab740ae1d6d4c1e985744b6e88d4e", "message": "Remove unwanted changes", "committedDate": "2020-03-10T13:53:35Z", "type": "commit"}, {"oid": "773e6c03d8f6e6ff1d6f499b69271dc672a80924", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/773e6c03d8f6e6ff1d6f499b69271dc672a80924", "message": "Add the bracket", "committedDate": "2020-03-10T14:01:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcxNzczNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390717737", "bodyText": "Why we can't remove passing false? we already have set false as default value", "author": "daneshk", "createdAt": "2020-03-11T02:43:50Z", "path": "examples/jdbc-client-crud-operations/jdbc_client_crud_operations.bal", "diffHunk": "@@ -45,7 +45,7 @@ public function main() {\n     // of the `java.jdbc` module.\n     int age = 24;\n     string name = \"Anne\";\n-    ret = testDB->update(\"INSERT INTO student(age, name) values (?, ?)\",\n+    ret = testDB->update(\"INSERT INTO student(age, name) values (?, ?)\", false,", "originalCommit": "773e6c03d8f6e6ff1d6f499b69271dc672a80924", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc0MDU1Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21476#discussion_r390740557", "bodyText": "If update statement which doesn't have parameters, no need to append false but In this case, update statements have parameters So we need to set that value.", "author": "kalaiyarasiganeshalingam", "createdAt": "2020-03-11T04:30:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcxNzczNw=="}], "type": "inlineReview"}]}