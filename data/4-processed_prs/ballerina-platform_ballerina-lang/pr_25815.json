{"pr_number": 25815, "pr_title": "Fix type checking issue in sort key function", "pr_createdAt": "2020-09-15T11:10:26Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/25815", "timeline": [{"oid": "eab615d130eb68a519a3b493e47185db2b037bd2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/eab615d130eb68a519a3b493e47185db2b037bd2", "message": "Improve array:sort key function type checking", "committedDate": "2020-09-15T11:03:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcxOTU3OQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25815#discussion_r488719579", "bodyText": "Is this correct? Shouldn't we look at the return type?\nI guess the validation for ordered type will still work since we use the expected type as the type of the arrow function and invalid types are detected early on.", "author": "MaryamZi", "createdAt": "2020-09-15T14:36:23Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "diffHunk": "@@ -5406,10 +5406,24 @@ private void checkArrayLibSortFuncArgs(BLangInvocation iExpr) {\n             return;\n         }\n \n-        BLangLambdaFunction keyLambdaFunction = (BLangLambdaFunction) keyFunction;\n-        BType returnType = keyLambdaFunction.function.type.getReturnType();\n+        DiagnosticPos pos;\n+        BType returnType;\n+\n+        if (keyFunction.getKind() == NodeKind.SIMPLE_VARIABLE_REF) {\n+            pos = keyFunction.pos;\n+            returnType = ((BLangSimpleVarRef) keyFunction).type.getReturnType();\n+        } else if (keyFunction.getKind() == NodeKind.ARROW_EXPR) {\n+            BLangArrowFunction arrowFunction = ((BLangArrowFunction) keyFunction);\n+            pos = arrowFunction.params.get(0).pos;\n+            returnType = arrowFunction.params.get(0).type;", "originalCommit": "eab615d130eb68a519a3b493e47185db2b037bd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcyMTMzMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25815#discussion_r488721333", "bodyText": "Also, the following seems to result in a bad, sad error at runtime.\nimport ballerina/lang.array;\n\npublic function main() {\n    int[] arr = [1, 4, 2];\n    int[] sortedArr = arr.sort(array:ASCENDING, (i) => i.toString());\n}", "author": "MaryamZi", "createdAt": "2020-09-15T14:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcxOTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAzODcwOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/25815#discussion_r543038708", "bodyText": "Fixed in #25834", "author": "lasinicl", "createdAt": "2020-12-15T04:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcxOTU3OQ=="}], "type": "inlineReview"}]}