{"pr_number": 27186, "pr_title": "Integrate the Project API changes to Formatter CLI", "pr_createdAt": "2020-11-26T13:24:17Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186", "timeline": [{"oid": "705e2eb77c95f93f4bc1937d4fee3d9ccf0540da", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/705e2eb77c95f93f4bc1937d4fee3d9ccf0540da", "message": "Migrate the formatter cli with Project API changes", "committedDate": "2020-11-26T12:01:10Z", "type": "commit"}, {"oid": "531730be58b79c5411b556aff1b17d79896a255b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/531730be58b79c5411b556aff1b17d79896a255b", "message": "Fix the formatter tests", "committedDate": "2020-11-26T13:21:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDk2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531030962", "bodyText": "The ProjectConstants.TEST_DIR_NAME is removed here since it adds a duplicated tests directory in the path generated. Here, the module.document(documentId).name()) gives the bal file path along with the tests directory.\nE.g. If the .bal file inside the tests directory is main_test.bal the name given by module.document(documentId).name()) would be,\ntests/main_test.bal\nThere weren't other usages found for this method except for the one that is added in this PR.", "author": "IrushiL", "createdAt": "2020-11-26T13:31:15Z", "path": "compiler/ballerina-lang/src/main/java/io/ballerina/projects/directory/BuildProject.java", "diffHunk": "@@ -94,15 +94,10 @@ private BuildProject(ProjectEnvironmentBuilder environmentBuilder, Path projectP\n         for (ModuleId moduleId : currentPackage().moduleIds()) {\n             Module module = currentPackage().module(moduleId);\n             Optional<Path> modulePath = modulePath(moduleId);\n-            if (module.documentIds().contains(documentId)) {\n+            if (module.documentIds().contains(documentId) || module.testDocumentIds().contains(documentId)) {\n                 if (modulePath.isPresent()) {\n                     return Optional.of(modulePath.get().resolve(module.document(documentId).name()));\n                 }\n-            } else if (module.testDocumentIds().contains(documentId)) {\n-                if (modulePath.isPresent()) {\n-                    return Optional.of(modulePath.get()\n-                            .resolve(ProjectConstants.TEST_DIR_NAME).resolve(module.document(documentId).name()));", "originalCommit": "531730be58b79c5411b556aff1b17d79896a255b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMzc3Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531033772", "bodyText": "The duplication happens because we give the document name as TEST_DIR_NAME + \"/\" + documentName + ` to get the proper directory structure within the testable jar creation. Changing this is fine but I doubt it will work on Windows.", "author": "azinneera", "createdAt": "2020-11-26T13:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNzY0NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531037645", "bodyText": "IMO, its safe to split the test document name and resolve the path in an OS independent way.", "author": "azinneera", "createdAt": "2020-11-26T13:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2MjM3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531062378", "bodyText": "Done", "author": "IrushiL", "createdAt": "2020-11-26T14:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNDM5Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531034392", "bodyText": "We dont need this check here. BuildProject.load() will do the validation", "author": "azinneera", "createdAt": "2020-11-26T13:37:14Z", "path": "misc/formatter/modules/formatter-cli/src/main/java/org/ballerinalang/formatter/cli/FormatUtil.java", "diffHunk": "@@ -117,6 +108,11 @@ static void execute(List<String> argList, boolean helpFlag, boolean dryRun, Path\n                 } else {\n                     moduleName = argList.get(0);\n \n+                    // Check whether the given directory is not in a ballerina project.\n+                    if (!FormatUtil.isBallerinaProject(sourceRootPath)) {", "originalCommit": "531730be58b79c5411b556aff1b17d79896a255b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA0MTg4NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531041884", "bodyText": "Done", "author": "IrushiL", "createdAt": "2020-11-26T13:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNDM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNDkxNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531034917", "bodyText": "We need to wrap this with a try-catch to catch the ProjectException", "author": "azinneera", "createdAt": "2020-11-26T13:38:10Z", "path": "misc/formatter/modules/formatter-cli/src/main/java/org/ballerinalang/formatter/cli/FormatUtil.java", "diffHunk": "@@ -130,32 +126,55 @@ static void execute(List<String> argList, boolean helpFlag, boolean dryRun, Path\n                         }\n                     }\n \n-                    // Check whether the given directory is not in a ballerina project.\n-                    if (!FormatUtil.isBallerinaProject(sourceRootPath)) {\n-                        throw LauncherUtils.createLauncherException(Messages.getNotBallerinaProject());\n-                    }\n-                    BLangPackage bLangPackage = FormatUtil\n-                            .compileModule(sourceRootPath, getModuleName(moduleName));\n+                    BuildProject project = BuildProject.load(sourceRootPath, constructBuildOptions());", "originalCommit": "531730be58b79c5411b556aff1b17d79896a255b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA0MjA1Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531042053", "bodyText": "Done", "author": "IrushiL", "createdAt": "2020-11-26T13:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNDkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNTM2Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531035367", "bodyText": "We need to iterate the module ids and get the module", "author": "azinneera", "createdAt": "2020-11-26T13:38:57Z", "path": "misc/formatter/modules/formatter-cli/src/main/java/org/ballerinalang/formatter/cli/FormatUtil.java", "diffHunk": "@@ -130,32 +126,55 @@ static void execute(List<String> argList, boolean helpFlag, boolean dryRun, Path\n                         }\n                     }\n \n-                    // Check whether the given directory is not in a ballerina project.\n-                    if (!FormatUtil.isBallerinaProject(sourceRootPath)) {\n-                        throw LauncherUtils.createLauncherException(Messages.getNotBallerinaProject());\n-                    }\n-                    BLangPackage bLangPackage = FormatUtil\n-                            .compileModule(sourceRootPath, getModuleName(moduleName));\n+                    BuildProject project = BuildProject.load(sourceRootPath, constructBuildOptions());\n+                    Package currentPackage = project.currentPackage();\n+                    Module module = currentPackage.module(ModuleName.from(currentPackage.packageName(),", "originalCommit": "531730be58b79c5411b556aff1b17d79896a255b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzODE0OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531038148", "bodyText": "This is for formatting a single module that is provided as an argument to the formatter command. This approach should be okay right?", "author": "IrushiL", "createdAt": "2020-11-26T13:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNTM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2MjkyOA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531062928", "bodyText": "yes ok, I mistook it", "author": "azinneera", "createdAt": "2020-11-26T14:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNTYwNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531035607", "bodyText": "We can remove this", "author": "azinneera", "createdAt": "2020-11-26T13:39:20Z", "path": "misc/formatter/modules/formatter-cli/src/main/java/org/ballerinalang/formatter/cli/FormatUtil.java", "diffHunk": "@@ -130,32 +126,55 @@ static void execute(List<String> argList, boolean helpFlag, boolean dryRun, Path\n                         }\n                     }\n \n-                    // Check whether the given directory is not in a ballerina project.\n-                    if (!FormatUtil.isBallerinaProject(sourceRootPath)) {\n-                        throw LauncherUtils.createLauncherException(Messages.getNotBallerinaProject());\n-                    }\n-                    BLangPackage bLangPackage = FormatUtil\n-                            .compileModule(sourceRootPath, getModuleName(moduleName));\n+                    BuildProject project = BuildProject.load(sourceRootPath, constructBuildOptions());\n+                    Package currentPackage = project.currentPackage();\n+                    Module module = currentPackage.module(ModuleName.from(currentPackage.packageName(),\n+                            getModuleName(moduleName)));\n \n                     // Iterate and format the ballerina package.\n-                    List<String> formattedFiles = iterateAndFormat(bLangPackage, sourceRootPath, dryRun);\n+                    List<String> formattedFiles = iterateAndFormat(getDocumentPaths(project, module.moduleId()),\n+                            sourceRootPath, dryRun);\n                     generateChangeReport(formattedFiles, dryRun);\n                 }\n             } else {\n-                List<BLangPackage> packages = FormatUtil.compileProject(sourceRootPath);\n-                List<String> formattedFiles = new ArrayList<>();\n-                // Iterate and format all the ballerina packages.\n-                for (BLangPackage bLangPackage : packages) {\n-                    formattedFiles.addAll(iterateAndFormat(bLangPackage, sourceRootPath, dryRun));\n+                // Check whether the given directory is not a ballerina project.\n+                if (!FormatUtil.isBallerinaProject(sourceRootPath)) {", "originalCommit": "531730be58b79c5411b556aff1b17d79896a255b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA0MTI0NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27186#discussion_r531041245", "bodyText": "Here, the reason why this check was done beforehand was because 2 test cases gave an exception with the stack strace as follows:\n        at io.ballerina.projects.internal.environment.BallerinaDistribution.validateBallerinaHomeDir(BallerinaDistribution.java:75)\n        at io.ballerina.projects.internal.environment.BallerinaDistribution.from(BallerinaDistribution.java:58)\n        at io.ballerina.projects.internal.environment.BallerinaDistribution.from(BallerinaDistribution.java:54)\n        at io.ballerina.projects.environment.EnvironmentBuilder.getBallerinaDistribution(EnvironmentBuilder.java:103)\n        at io.ballerina.projects.environment.EnvironmentBuilder.build(EnvironmentBuilder.java:77)\n        at io.ballerina.projects.environment.EnvironmentBuilder.buildDefault(EnvironmentBuilder.java:50)\n        at io.ballerina.projects.ProjectEnvironmentBuilder.getDefaultBuilder(ProjectEnvironmentBuilder.java:49)\n        at io.ballerina.projects.directory.BuildProject.load(BuildProject.java:68)\n        at org.ballerinalang.formatter.cli.FormatUtil.execute(FormatUtil.java:143)\n        at org.ballerinalang.formatter.cli.FormatCmdTest.formatCLINotAProjectTest(FormatCmdTest.java:60)\n\nDebugging a similar scenario gave the following bad sad error.\n[2020-11-26 18:16:47,748] SEVERE {b7a.log.crash} - Invalid Ballerina package directory: /Users/irushi/Desktop/temp2/notAProject, cannot find 'Ballerina.toml' file. \nio.ballerina.projects.ProjectException: Invalid Ballerina package directory: /Users/irushi/Desktop/temp2/notAProject, cannot find 'Ballerina.toml' file.\n\tat io.ballerina.projects.internal.ProjectFiles.validateBuildProjectDirPath(ProjectFiles.java:173)\n\tat io.ballerina.projects.internal.PackageConfigCreator.createBuildProjectConfig(PackageConfigCreator.java:52)\n\tat io.ballerina.projects.directory.BuildProject.load(BuildProject.java:69)\n\tat org.ballerinalang.formatter.cli.FormatUtil.execute(FormatUtil.java:140)\n\tat org.ballerinalang.formatter.cli.FormatCmd.execute(FormatCmd.java:46)\n\tat java.base/java.util.Optional.ifPresent(Optional.java:183)\n\tat org.ballerinalang.tool.Main.main(Main.java:57)", "author": "IrushiL", "createdAt": "2020-11-26T13:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNTYwNw=="}], "type": "inlineReview"}, {"oid": "384de858cb1e741efbe0d809533b9f6a259d0501", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/384de858cb1e741efbe0d809533b9f6a259d0501", "message": "Fix review comments", "committedDate": "2020-11-26T13:57:19Z", "type": "commit"}, {"oid": "aaac3f06e78d639e6f921d02dd0383e4f5ed786f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aaac3f06e78d639e6f921d02dd0383e4f5ed786f", "message": "Fix review comments", "committedDate": "2020-11-26T14:22:39Z", "type": "commit"}, {"oid": "7cb043d79e534d3d24c4664e047742e56235347d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/7cb043d79e534d3d24c4664e047742e56235347d", "message": "Fix checkstyle issue", "committedDate": "2020-11-26T14:32:15Z", "type": "commit"}, {"oid": "666b335690cc92e4f46326d6fd6523d47fd5fb8f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/666b335690cc92e4f46326d6fd6523d47fd5fb8f", "message": "Fix a review comment", "committedDate": "2020-11-26T14:55:11Z", "type": "commit"}]}