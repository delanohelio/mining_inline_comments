{"pr_number": 27391, "pr_title": "Fix object type inclusion", "pr_createdAt": "2020-12-08T19:59:50Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391", "timeline": [{"oid": "1e28890b25cb229f8b06badd5592e6c53bd0b798", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1e28890b25cb229f8b06badd5592e6c53bd0b798", "message": "Disallow inclusion of readonly classes", "committedDate": "2020-12-07T15:56:57Z", "type": "commit"}, {"oid": "f296255426ca329d1577a83ef8c9cc8ccddbb278", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f296255426ca329d1577a83ef8c9cc8ccddbb278", "message": "Fix inclusion with qualifiers\nWith this change the referencing object should have the same isolated, service, and/or client qualifier(s) as the included type(s).", "committedDate": "2020-12-08T08:02:40Z", "type": "commit"}, {"oid": "053152f2ad9ec3e76bb30f6444ff99ab763039e2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/053152f2ad9ec3e76bb30f6444ff99ab763039e2", "message": "Fix object constructor expression with readonly reference", "committedDate": "2020-12-08T19:35:35Z", "type": "commit"}, {"oid": "6c78eb821b9663e2c68cd1e505d38618b4efb703", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6c78eb821b9663e2c68cd1e505d38618b4efb703", "message": "Add tests", "committedDate": "2020-12-08T19:57:30Z", "type": "commit"}, {"oid": "a386b01edf1ad47154744a4f46b45b5a77003d3f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a386b01edf1ad47154744a4f46b45b5a77003d3f", "message": "Resolve conflicts and merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-inclusion", "committedDate": "2020-12-11T03:56:29Z", "type": "commit"}, {"oid": "410c2ea80d4eb2c5d1ec34c9147a981293667d32", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/410c2ea80d4eb2c5d1ec34c9147a981293667d32", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-inclusion", "committedDate": "2020-12-18T15:14:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2MjgxNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391#discussion_r546562814", "bodyText": "Why don't we move last boolean argument logic inside the function handleObjectConstrExprForReadOnly", "author": "KRVPerera", "createdAt": "2020-12-21T08:08:39Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "diffHunk": "@@ -2978,11 +2979,16 @@ public void visit(BLangTypeInit cIExpr) {\n                 if (isObjectConstructorExpr(cIExpr, actualObjectType)) {\n                     BLangClassDefinition classDefForConstructor = getClassDefinitionForObjectConstructorExpr(cIExpr,\n                                                                                                              env);\n+                    List<BLangType> typeRefs = classDefForConstructor.typeRefs;\n \n                     SymbolEnv pkgEnv = symTable.pkgEnvMap.get(env.enclPkg.symbol);\n \n                     if (Symbols.isFlagOn(expType.flags, Flags.READONLY)) {\n-                        handleObjectConstrExprForReadOnlyCET(cIExpr, actualObjectType, classDefForConstructor, pkgEnv);\n+                        handleObjectConstrExprForReadOnly(cIExpr, actualObjectType, classDefForConstructor, pkgEnv,", "originalCommit": "a386b01edf1ad47154744a4f46b45b5a77003d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMTk2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391#discussion_r546631962", "bodyText": "But then we'll have to repeat at least one check, right?", "author": "MaryamZi", "createdAt": "2020-12-21T10:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2MjgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI1OTA0NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391#discussion_r547259045", "bodyText": "yes. Lets not change.", "author": "KRVPerera", "createdAt": "2020-12-22T12:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU2MjgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODA4MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391#discussion_r547218080", "bodyText": "In object constructor type-reference is implemented as a type inclusion. This may be confusing in some scenarios if the error refers to it as \"type inclusion\".", "author": "KRVPerera", "createdAt": "2020-12-22T11:13:37Z", "path": "compiler/ballerina-lang/src/main/resources/compiler.properties", "diffHunk": "@@ -1628,3 +1628,15 @@ error.invalid.isolated.qualifier.on.module.no.init.var.decl=\\\n \n error.binding.pattern.not.yet.supported.in.module.var.decl=\\\n   ''{0}'' binding pattern not yet supported in module variable declaration\n+\n+error.invalid.read.only.class.inclusion.in.object.type.descriptor=\\\n+  object type inclusion cannot be used with a ''readonly class'' in an object type descriptor\n+\n+error.invalid.inclusion.with.mismatched.qualifiers=\\\n+  invalid object type inclusion: missing ''{0}'' qualifier(s) in the referencing object\n+\n+error.invalid.read.only.class.inclusion.in.non.read.only.class=\\", "originalCommit": "a386b01edf1ad47154744a4f46b45b5a77003d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIzNTEwOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391#discussion_r547235109", "bodyText": "This error will only be logged for user-defined classes, not for object constructor expressions.\nIn an object constructor expression, if the type reference is a readonly class, the rules that apply are somewhat the same as those within a readonly class.\ne.g.,\nThe fields become final and the types becomes the types with their read-only bit set.\nreadonly class Foo {\n    int i;\n\n    function init(int i) {\n        self.i = i;\n    }\n}\n\npublic function main() {\n    object { } x =  object Foo { \n        int i = 1;\n        map<string> m = mp; // `mp` should be a subtype of `map<string> & readonly`\n    }; \n}\nIf the type reference is a read-only class, the object constructor's fields have to be readonly compatible.\nreadonly class Foo {\n    int i;\n\n    function init(int i) {\n        self.i = i;\n    }\n}\n\npublic function main() {\n    object { } x =  object Foo { \n        int i = 1;\n        stream<int> str; // can never be a subtype of `readonly`\n\n        function init() {\n            int[] arr = [1, 2, 3, 4];\n            self.str = arr.toStream();\n        }\n    }; \n}\nThe error logged here will be \"invalid field in an object constructor expression with a 'readonly' reference: 'stream' can never be 'readonly'\"\nSpec discussion - ballerina-platform/ballerina-spec#649", "author": "MaryamZi", "createdAt": "2020-12-22T11:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI2MTI3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391#discussion_r547261278", "bodyText": "Sorry for not being clear. Check this example.\nisolated class Foo {\n    int i;\n\n    function init(int i) {\n        self.i = i;\n    }\n}\n\npublic function main() {\n    object { } x =  object Foo { \n        int i = 1;\n    }; \n}\nERROR [t14.bal:(10:28,10:31)] invalid object type inclusion: missing 'isolated' qualifier(s) in the referencing object", "author": "KRVPerera", "createdAt": "2020-12-22T12:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwNjcwMQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27391#discussion_r547306701", "bodyText": "Introduced a separate error for object constructor expressions in d057072.", "author": "MaryamZi", "createdAt": "2020-12-22T14:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODA4MA=="}], "type": "inlineReview"}, {"oid": "32e0cbb1933c5d6ce9020c66598df477c5806b85", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/32e0cbb1933c5d6ce9020c66598df477c5806b85", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-inclusion", "committedDate": "2020-12-22T11:41:31Z", "type": "commit"}, {"oid": "d057072bd1890d037487821568ba20eaf28c3a46", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d057072bd1890d037487821568ba20eaf28c3a46", "message": "Introduce separate error for missing qualifiers in object constructor", "committedDate": "2020-12-22T14:16:03Z", "type": "commit"}, {"oid": "ba260d2cc1c4864f5d20e06175722e976325b979", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ba260d2cc1c4864f5d20e06175722e976325b979", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into fix-inclusion", "committedDate": "2021-01-04T05:09:53Z", "type": "commit"}]}