{"pr_number": 24189, "pr_title": "Extend JWT validator configuration [master]", "pr_createdAt": "2020-06-16T07:41:32Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/24189", "timeline": [{"oid": "1108bcc03f0db77580932972a1e7273b8a1721f7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1108bcc03f0db77580932972a1e7273b8a1721f7", "message": "Improve jwt validator config", "committedDate": "2020-06-16T07:31:10Z", "type": "commit"}, {"oid": "554ae069499771c0ce95239fcb2c2af1b5334fe1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/554ae069499771c0ce95239fcb2c2af1b5334fe1", "message": "Update docs", "committedDate": "2020-06-16T07:36:13Z", "type": "commit"}, {"oid": "8e71c2fab3b84ca5c2465b57856b5ec331116ece", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8e71c2fab3b84ca5c2465b57856b5ec331116ece", "message": "Update test cases", "committedDate": "2020-06-16T07:36:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MjMyNw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24189#discussion_r440652327", "bodyText": "I think we need to move this as else if statement", "author": "daneshk", "createdAt": "2020-06-16T07:47:47Z", "path": "stdlib/jwt/src/main/ballerina/src/jwt/jwt_validator.bal", "diffHunk": "@@ -270,18 +272,21 @@ function validateJwtRecords(string jwt, JwtHeader jwtHeader, JwtPayload jwtPaylo\n     }\n     JwtSigningAlgorithm alg = <JwtSigningAlgorithm>jwtHeader?.alg;  // The `()` value is already validated.\n \n-    JwtTrustStoreConfig|JwksConfig? signatureConfig = config?.signatureConfig;\n-    if (signatureConfig is JwtTrustStoreConfig) {\n-        _ = check validateSignatureByTrustStore(jwt, alg, signatureConfig);\n-    } else if (signatureConfig is JwksConfig) {\n+    JwksConfig? jwksConfig = config?.jwksConfig;\n+    if (jwksConfig is JwksConfig) {\n         string? kid = jwtHeader?.kid;\n         if (kid is string) {\n-            _ = check validateSignatureByJwks(jwt, kid, alg, signatureConfig);\n+            _ = check validateSignatureByJwks(jwt, kid, alg, jwksConfig);\n         } else {\n             return prepareError(\"Key ID (kid) is not provided in JOSE header.\");\n         }\n     }\n \n+    JwtTrustStoreConfig? trustStoreConfig = config?.trustStoreConfig;\n+    if (trustStoreConfig is JwtTrustStoreConfig) {\n+        _ = check validateSignatureByTrustStore(jwt, alg, trustStoreConfig);\n+    }", "originalCommit": "8e71c2fab3b84ca5c2465b57856b5ec331116ece", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY2Mzc2Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24189#discussion_r440663766", "bodyText": "Yes. Otherwise the signature can be validated twice. Fixed with dba0b30", "author": "ldclakmal", "createdAt": "2020-06-16T08:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MjMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxNzg3OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24189#discussion_r440717878", "bodyText": "Shall we check the kid first, code looks like,\nif (kid is string) {\n  if (jwksConfig is JwksConfig) {\n    // validate\n  } else if (trustStoreConfig is JwtTrustStoreConfig) {\n   // validate\n  } else {\n    // error \n }\n} else {\n if (trustStoreConfig is JwtTrustStoreConfig) {\n   // validate\n  } else {\n    // error \n }\n}\ncurrent logic will some cases, I think", "author": "daneshk", "createdAt": "2020-06-16T09:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MjMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5NjcxOQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24189#discussion_r440796719", "bodyText": "Actually, there is a use case to pass the signature validation if, none of the JwksConfig or JwtTrustStoreConfig are provided. And there is another use case where kid is not given, but only JwksConfig is provided, so that we have to return an error message. Considering all, I updated the logic as\nif (jwksConfig is JwksConfig) {\n    if (kid is string) {\n        // validate\n    } else if (trustStoreConfig is JwtTrustStoreConfig) {\n       // validate\n    } else {\n        // return error\n    }\n} else if (trustStoreConfig is JwtTrustStoreConfig) {\n    // validate\n}\n// continue without signature validation\nWDYT?", "author": "ldclakmal", "createdAt": "2020-06-16T12:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MjMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5NzU2MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24189#discussion_r440797560", "bodyText": "Added following test cases which covers all the possibilities.\n  * Test cases for JWT signature validation with TrustStore and JWK based authentication/authorization scenarios.\n  *\n  * The following 8 scenarios are tested here.\n  * T (TRUE) - Parameter/Config is available.\n  * F (FALSE) - Parameter/Config is not available.\n  *\n  * | Scenario |  kid  | JwksConfig | TrustStoreConfig | Test Status |\n  * |----------|-------|------------|------------------|-------------|\n  * |   1      |   T   |     T      |         T        |    PASS     |\n  * |   2      |   T   |     T      |         F        |    PASS     |\n  * |   3      |   T   |     F      |         T        |    PASS     |\n  * |   4      |   T   |     F      |         F        |    PASS     |\n  * |   5      |   F   |     T      |         T        |    PASS     |\n  * |   6      |   F   |     T      |         F        |    FAIL     |\n  * |   7      |   F   |     F      |         T        |    PASS     |\n  * |   8      |   F   |     F      |         F        |    PASS     |\n  *\n  * Additionally, there are 4 more scenarios where kid is available, but it is invalid.\n  * |   9      |   T   |     T      |         T        |    FAIL     |\n  * |  10      |   T   |     T      |         F        |    FAIL     |\n  * |  11      |   T   |     F      |         T        |    PASS     |\n  * |  12      |   T   |     F      |         F        |    PASS     |", "author": "ldclakmal", "createdAt": "2020-06-16T12:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MjMyNw=="}], "type": "inlineReview"}, {"oid": "e01271244dbee2138599cabba063b0d02b9facab", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e01271244dbee2138599cabba063b0d02b9facab", "message": "Fix the signature validation logic", "committedDate": "2020-06-16T10:13:53Z", "type": "commit"}, {"oid": "95b66bbf5e137621b2e67ac52e2cacf98e9df9aa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/95b66bbf5e137621b2e67ac52e2cacf98e9df9aa", "message": "Add integration tests for JWT signature validation", "committedDate": "2020-06-16T11:56:08Z", "type": "commit"}, {"oid": "95b66bbf5e137621b2e67ac52e2cacf98e9df9aa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/95b66bbf5e137621b2e67ac52e2cacf98e9df9aa", "message": "Add integration tests for JWT signature validation", "committedDate": "2020-06-16T11:56:08Z", "type": "forcePushed"}]}