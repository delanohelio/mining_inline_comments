{"pr_number": 24629, "pr_title": "Refactor the runtime InvocationContext", "pr_createdAt": "2020-07-07T11:25:31Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629", "timeline": [{"oid": "cdb9d97a28c2545aef3d97a68ab6abc59b0e3373", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cdb9d97a28c2545aef3d97a68ab6abc59b0e3373", "message": "Refactor the InvocationContext", "committedDate": "2020-07-07T11:18:31Z", "type": "commit"}, {"oid": "8e324c2fd2cff121beafab63ad40f14633e0d6ca", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/8e324c2fd2cff121beafab63ad40f14633e0d6ca", "message": "Fix doc comments", "committedDate": "2020-07-07T11:21:10Z", "type": "commit"}, {"oid": "a638cd18412f7f75eca1088bfef040c76b73c753", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a638cd18412f7f75eca1088bfef040c76b73c753", "message": "Add missing java files", "committedDate": "2020-07-07T11:36:44Z", "type": "commit"}, {"oid": "18cc41111b38c978b3070f7bdb8be4f5dd115171", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/18cc41111b38c978b3070f7bdb8be4f5dd115171", "message": "Introduce a common util function to set the invocation context", "committedDate": "2020-07-08T05:31:35Z", "type": "commit"}, {"oid": "3d4b0c6ed16e053d0f9d21386a59399ad4494d84", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3d4b0c6ed16e053d0f9d21386a59399ad4494d84", "message": "Update documents in module.mds", "committedDate": "2020-07-10T01:08:45Z", "type": "commit"}, {"oid": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/426ea5467f3911ae23d4eba8dbbe204c043170fa", "message": "Remove extra lines", "committedDate": "2020-07-10T01:21:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ1MjYzNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453452635", "bodyText": "Shall we rename this function as follow and move this function to 'auth/invocation_context.bal' ?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public function setAuthInvocationContext(public string? scheme = (), public string? authToken = (),\n          \n          \n            \n            public function setInvocationContext(public string? scheme = (), public string? token = (),", "author": "ldclakmal", "createdAt": "2020-07-13T06:07:08Z", "path": "stdlib/auth/src/main/ballerina/src/auth/utils.bal", "diffHunk": "@@ -72,41 +71,30 @@ public function extractUsernameAndPassword(string credential) returns [string, s\n     }\n }\n \n-# Sets the authentication-related values (scheme, auth token) to the authentication context of the invocation context.\n+# Sets the authentication-related values to the invocation context.\n # ```ballerina\n-# auth:setAuthenticationContext(\"jwt\", \"<credential>\");\n+# auth:setAuthInvocationContext(\"jwt\", \"<credential>\", \"<userID>\", <scopes>, <claims>);\n # ```\n #\n # + scheme - Auth scheme (`JWT`, `LDAP`, `OAuth2`, `Basic`, etc.)\n # + authToken - Auth token (credential)\n-public function setAuthenticationContext(string scheme, string authToken) {\n-    runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-    invocationContext.authenticationContext = {\n-        scheme: scheme,\n-        authToken: authToken\n-    };\n-}\n-\n-# Sets the authentication-related values (user ID, username, scopes, claims) to the principal of the invocation context.\n-#\n-# + userId - User ID of the authenticated user\n-# + username - Username of the authenticated user\n-# + claims - Claims of the authenticated user\n-# + scopes - Authenticated user scopes\n-public function setPrincipal(public string? userId = (), public string? username = (), public string[]? scopes = (),\n-                             public map<any>? claims = ()) {\n-    runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-    if (!(userId is ()) && userId != \"\") {\n-        invocationContext.principal.userId = userId;\n+public function setAuthInvocationContext(public string? scheme = (), public string? authToken = (),", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ1NjkxNQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453456915", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return prepareAuthError(\"Failed to generate OAuth2 token since OAuth2 provider config is not defined and auth token is not defined in the authentication context at invocation context.\");\n          \n          \n            \n                        return prepareAuthError(\"Failed to generate OAuth2 token since OAuth2 provider config is not defined and OAuth2 token is not defined at auth:InvocationContext.\");", "author": "ldclakmal", "createdAt": "2020-07-13T06:21:07Z", "path": "stdlib/oauth2/src/main/ballerina/src/oauth2/outbound_oauth2_provider.bal", "diffHunk": "@@ -91,12 +90,9 @@ public type OutboundOAuth2Provider object {\n     public function generateToken() returns @tainted (string|auth:Error) {\n         GrantTypeConfig? oauth2ProviderConfig = self.oauth2ProviderConfig;\n         if (oauth2ProviderConfig is ()) {\n-            runtime:AuthenticationContext? authContext = runtime:getInvocationContext()?.authenticationContext;\n-            if (authContext is runtime:AuthenticationContext) {\n-                string? authToken = authContext?.authToken;\n-                if (authToken is string) {\n-                    return authToken;\n-                }\n+            string? authToken = auth:getInvocationContext()?.token;\n+            if (authToken is string) {\n+                return authToken;\n             }\n             return prepareAuthError(\"Failed to generate OAuth2 token since OAuth2 provider config is not defined and auth token is not defined in the authentication context at invocation context.\");", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ1NzY2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453457662", "bodyText": "Shall we update as follows, in order to consistent with AUTH_INVOCATION_CONTEXT_PROPERTY?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String INVOCATION_CONTEXT_PROPERTY = \"RuntimeInvocationContext\";\n          \n          \n            \n                private static final String RUNTIME_INVOCATION_CONTEXT_PROPERTY = \"RuntimeInvocationContext\";", "author": "ldclakmal", "createdAt": "2020-07-13T06:23:35Z", "path": "stdlib/runtime-api/src/main/java/org/ballerinalang/stdlib/runtime/nativeimpl/GetInvocationContext.java", "diffHunk": "@@ -41,7 +41,7 @@\n         return getInvocationContextRecord(Scheduler.getStrand());\n     }\n \n-    private static final String INVOCATION_CONTEXT_PROPERTY = \"InvocationContext\";\n+    private static final String INVOCATION_CONTEXT_PROPERTY = \"RuntimeInvocationContext\";", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NDE2Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453754162", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The Invocation Context is a data holder, which is created per request and preserved for a single request-response flow. It comprises of auth related information such as authentication scheme, auth token and authenticated user's id, claims and scopes. \n          \n          \n            \n            The Invocation Context is a data holder, which is created per request and preserved for a single request-response flow. It comprises of auth-related information such as authentication scheme, auth token, and authenticated user's ID, claims, and scopes.", "author": "praneesha", "createdAt": "2020-07-13T15:55:07Z", "path": "stdlib/auth/src/main/ballerina/src/auth/Module.md", "diffHunk": "@@ -1,5 +1,21 @@\n ## Module Overview\n \n-This module provides the default authentication provider configurations, which can be extended to create new authentication providers.\n+This module provides the default authentication provider configurations, which can be extended to create new authentication providers and functions to interact with the `auth:InvocationContext`.\n \n+#### Invocation Context\n+\n+The Invocation Context is a data holder, which is created per request and preserved for a single request-response flow. It comprises of auth related information such as authentication scheme, auth token and authenticated user's id, claims and scopes. ", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NDM1NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453754354", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Retrieve data from invocation context.\n          \n          \n            \n            Retrieve data from the invocation context.", "author": "praneesha", "createdAt": "2020-07-13T15:55:25Z", "path": "stdlib/auth/src/main/ballerina/src/auth/Module.md", "diffHunk": "@@ -1,5 +1,21 @@\n ## Module Overview\n \n-This module provides the default authentication provider configurations, which can be extended to create new authentication providers.\n+This module provides the default authentication provider configurations, which can be extended to create new authentication providers and functions to interact with the `auth:InvocationContext`.\n \n+#### Invocation Context\n+\n+The Invocation Context is a data holder, which is created per request and preserved for a single request-response flow. It comprises of auth related information such as authentication scheme, auth token and authenticated user's id, claims and scopes. \n+\n+The following code snippet shows how to access the `auth:InvocationContext` and how to set the data and retrieve them.\n+\n+Set data to the invocation context.\n+```ballerina\n+auth:InvocationContext invocationContext = auth:getInvocationContext();\n+invocationContext.token = \"eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ\";\n+```\n+\n+Retrieve data from invocation context.", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NjIzNg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453756236", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    string userId = auth:getInvocationContext()?.userId ?: \"\";    // this is already validated at `canProcess` function\n          \n          \n            \n                    string userId = auth:getInvocationContext()?.userId ?: \"\";    // This is already validated in the `canProcess` function.", "author": "praneesha", "createdAt": "2020-07-13T15:58:06Z", "path": "stdlib/http/src/main/ballerina/src/http/auth/authz_handler.bal", "diffHunk": "@@ -63,30 +59,23 @@ public type AuthzHandler object {\n         string resourceName = runtime:getInvocationContext().attributes[RESOURCE_NAME].toString();\n         string requestMethod = runtime:getInvocationContext().attributes[REQUEST_METHOD].toString();\n \n-        runtime:Principal? principal = runtime:getInvocationContext()?.principal;\n-        if (principal is runtime:Principal) {\n-            string username = principal?.username ?: \"\";    // this is already validated at `canProcess` function\n-            string[] userScopes = principal?.scopes ?: [];\n-            string authzCacheKey = generateAuthzCacheKey(username, userScopes, serviceName, resourceName,\n-                                   requestMethod);\n+        string userId = auth:getInvocationContext()?.userId ?: \"\";    // this is already validated at `canProcess` function", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NjM4OA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453756388", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This module provides functions to interact with the ballerina runtime and the runtime invocation context.\n          \n          \n            \n            This module provides functions to interact with the Ballerina runtime and the runtime invocation context.", "author": "praneesha", "createdAt": "2020-07-13T15:58:19Z", "path": "stdlib/runtime-api/src/main/ballerina/src/runtime/Module.md", "diffHunk": "@@ -1,42 +1,29 @@\n ## Module Overview\n \n-This module provides functions to interact with the runtime, the invocation context, and to manage errors.\n+This module provides functions to interact with the ballerina runtime and the runtime invocation context.", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1NjY4MA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r453756680", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Following is the code snippet for pausing the current strand for 1000 milliseconds.\n          \n          \n            \n            The following is the code snippet for pausing the current strand for 1000 milliseconds.", "author": "praneesha", "createdAt": "2020-07-13T15:58:45Z", "path": "stdlib/runtime-api/src/main/ballerina/src/runtime/Module.md", "diffHunk": "@@ -1,42 +1,29 @@\n ## Module Overview\n \n-This module provides functions to interact with the runtime, the invocation context, and to manage errors.\n+This module provides functions to interact with the ballerina runtime and the runtime invocation context.\n \n-### Invocation Context\n+#### Invocation Context\n \n-The Invocation Context is a data holder, which is created per request and preserved for a single request-response flow. It comprises of a unique ID, a `runtime:Principal` instance, which includes user details, a `runtime:AuthenticationContext`, which has the authentication-related details if available, and an attribute map to hold context information.\n+The Invocation Context is a data holder, which is created per request and preserved for a single request-response flow. It comprises of a unique ID and an attribute map to hold the context information.\n \n-The following code snippet shows how to access the `runtime:InvocationContext` and the set of data for the `runtime:Principal` and `runtime:AuthenticationContext`.\n+The following code snippet shows how to access the `runtime:InvocationContext` and how to set the data to the `attributes` map.\n ```ballerina\n runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-\n-runtime:Principal? principal = invocationContext[\"principal\"];\n-if (principal is runtime:Principal) {\n-    // Set the username as \u2018tom\u2019.\n-    principal[\"username\"] = \"tom\";\n-}\n-\n-runtime:AuthenticationContext? authContext = invocationContext[\"authenticationContext\"];\n-if (authContext is runtime:AuthenticationContext) {\n-    // Set the auth scheme.\n-    authContext.scheme = \"jwt\";\n-}\n+invocationContext.attributes[\"SERVICE_NAME\"] = \"HelloService\";\n ```\n \n-The following code snippet shows how to access the `runtime:InvocationContext` and get the data from the `runtime:Principal` and `runtime:AuthenticationContext`,\n+The following code snippet shows how to access the `runtime:InvocationContext` and get the data from the `attributes` map.\n ```ballerina\n runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-runtime:Principal? principal = invocationContext[\"principal\"];\n-if (principal is runtime:Principal) {\n-    // Retrieve the user name.\n-    string? userName = principal[\"username\"];\n-}\n-\n-runtime:AuthenticationContext? authContext = invocationContext[\"authenticationContext\"];\n-if (authContext is runtime:AuthenticationContext) {\n-    // Retrieve the auth scheme.\n-    string? authScheme = authContext[\"scheme\"];\n-}\n+string serviceName = runtime:getInvocationContext().attributes[\"SERVICE_NAME\"].toString();\n+```\n+\n+#### Sleep the current strand\n+\n+Following is the code snippet for pausing the current strand for 1000 milliseconds.", "originalCommit": "426ea5467f3911ae23d4eba8dbbe204c043170fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6107725d8565edafee056efe44067edde30f799", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d6107725d8565edafee056efe44067edde30f799", "message": "Merge branch 'master' of https://github.com/ballerina-lang/ballerina into invocationcontext", "committedDate": "2020-07-15T14:12:14Z", "type": "commit"}, {"oid": "da0dace18fa69da4b3a39dd4a7773e5730d1d8ce", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/da0dace18fa69da4b3a39dd4a7773e5730d1d8ce", "message": "Address review suggestions", "committedDate": "2020-07-15T14:23:06Z", "type": "commit"}, {"oid": "71c791045839df4530e2ffe1358aab9756b3b51a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/71c791045839df4530e2ffe1358aab9756b3b51a", "message": "Apply suggestions from code review\n\nCo-authored-by: praneesha <praneesha@wso2.com>", "committedDate": "2020-07-15T14:39:23Z", "type": "commit"}, {"oid": "71c791045839df4530e2ffe1358aab9756b3b51a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/71c791045839df4530e2ffe1358aab9756b3b51a", "message": "Apply suggestions from code review\n\nCo-authored-by: praneesha <praneesha@wso2.com>", "committedDate": "2020-07-15T14:39:23Z", "type": "forcePushed"}, {"oid": "bf8293c73b5bda46f3d4dea63eb8ab3c44517598", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bf8293c73b5bda46f3d4dea63eb8ab3c44517598", "message": "Add missing documentation", "committedDate": "2020-07-15T14:48:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyODE5NQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r455128195", "bodyText": "Shall we move this function to auth/invocation_context.bal? WDYT?", "author": "ldclakmal", "createdAt": "2020-07-15T15:10:36Z", "path": "stdlib/auth/src/main/ballerina/src/auth/utils.bal", "diffHunk": "@@ -72,41 +71,33 @@ public function extractUsernameAndPassword(string credential) returns [string, s\n     }\n }\n \n-# Sets the authentication-related values (scheme, auth token) to the authentication context of the invocation context.\n+# Sets the authentication-related values to the invocation context.\n # ```ballerina\n-# auth:setAuthenticationContext(\"jwt\", \"<credential>\");\n+# auth:setInvocationContext(\"jwt\", \"<credential>\", \"<userID>\", <scopes>, <claims>);\n # ```\n #\n # + scheme - Auth scheme (`JWT`, `LDAP`, `OAuth2`, `Basic`, etc.)\n-# + authToken - Auth token (credential)\n-public function setAuthenticationContext(string scheme, string authToken) {\n-    runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-    invocationContext.authenticationContext = {\n-        scheme: scheme,\n-        authToken: authToken\n-    };\n-}\n-\n-# Sets the authentication-related values (user ID, username, scopes, claims) to the principal of the invocation context.\n-#\n+# + token - Auth token (credential)\n # + userId - User ID of the authenticated user\n-# + username - Username of the authenticated user\n-# + claims - Claims of the authenticated user\n # + scopes - Authenticated user scopes\n-public function setPrincipal(public string? userId = (), public string? username = (), public string[]? scopes = (),\n-                             public map<any>? claims = ()) {\n-    runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-    if (!(userId is ()) && userId != \"\") {\n-        invocationContext.principal.userId = userId;\n+# + claims - Claims of the authenticated user\n+public function setInvocationContext(public string? scheme = (), public string? token = (),", "originalCommit": "bf8293c73b5bda46f3d4dea63eb8ab3c44517598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE5MzE1Mg==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/24629#discussion_r455193152", "bodyText": "+1", "author": "Bhashinee", "createdAt": "2020-07-15T16:53:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyODE5NQ=="}], "type": "inlineReview"}, {"oid": "94d7f23b884bb042021012361d3b8b3a4348ee7b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/94d7f23b884bb042021012361d3b8b3a4348ee7b", "message": "Address review suggestions", "committedDate": "2020-07-15T16:45:20Z", "type": "commit"}]}