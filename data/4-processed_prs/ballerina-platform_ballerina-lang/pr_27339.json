{"pr_number": 27339, "pr_title": "Fix transaction validating if rollback is used with if condition", "pr_createdAt": "2020-12-04T07:50:04Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/27339", "timeline": [{"oid": "53947e2b59bc73bd2e031867a6cd1724c5684875", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/53947e2b59bc73bd2e031867a6cd1724c5684875", "message": "Fix issue with rollback in if else", "committedDate": "2020-12-04T06:06:30Z", "type": "commit"}, {"oid": "5bdbbf8198b6f6cd3de28a7bfa1d3e82a4a9ad2b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5bdbbf8198b6f6cd3de28a7bfa1d3e82a4a9ad2b", "message": "Change condition", "committedDate": "2020-12-04T08:34:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0NTU2MQ==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27339#discussion_r535945561", "bodyText": "Can you check this fix instead for the else part against the tests\n       analyzeNode(ifStmt.elseStmt, env);\n        boolean elseWithinTrxMode = this.withinTransactionScope;\n        this.statementReturns = ifStmtReturns && this.statementReturns;\n        this.errorThrown = currentErrorThrown && this.errorThrown;\n        this.withinTransactionScope = (!prevTxMode || ifWithinTrxMode || elseWithinTrxMode) && prevTxMode;", "author": "pcnfernando", "createdAt": "2020-12-04T09:10:02Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/CodeAnalyzer.java", "diffHunk": "@@ -817,19 +808,25 @@ public void visit(BLangIf ifStmt) {\n         }\n         boolean ifStmtReturns = this.statementReturns;\n         boolean currentErrorThrown = this.errorThrown;\n+        boolean ifWithinTrxMode = this.withinTransactionScope;\n         this.resetStatementReturns();\n         this.resetErrorThrown();\n+        if (prevTxMode) {\n+            this.resetWithinTrxScopeToTrue();\n+        }\n         if (ifStmt.elseStmt != null) {\n-            if (independentBlocks) {\n-                commitRollbackAllowed = true;\n-                withinTransactionScope = true;\n-            }\n             analyzeNode(ifStmt.elseStmt, env);\n-            if ((prevCommitCount != commitCount) || prevRollbackCount != rollbackCount) {\n-                commitRollbackAllowed = false;\n+            boolean hasVisitedCommitOrRollback = false;", "originalCommit": "5bdbbf8198b6f6cd3de28a7bfa1d3e82a4a9ad2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxNzU4NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/27339#discussion_r536017584", "bodyText": "updated in 0135c17 . fixed the tests in ballerina-platform/module-ballerinai-transaction@cd53c3a", "author": "lasinicl", "createdAt": "2020-12-04T11:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0NTU2MQ=="}], "type": "inlineReview"}, {"oid": "0135c1794ed47e1c5ff350d4b60334f2a40249e3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0135c1794ed47e1c5ff350d4b60334f2a40249e3", "message": "Fix checking for unnecessary conditions", "committedDate": "2020-12-04T10:20:44Z", "type": "commit"}]}