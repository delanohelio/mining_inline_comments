{"pr_number": 21524, "pr_title": "Rewrite stream functionality with ballerina", "pr_createdAt": "2020-03-07T09:52:42Z", "pr_url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524", "timeline": [{"oid": "49bc28347fb4a42c37a4076bed7695b106b832f6", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/49bc28347fb4a42c37a4076bed7695b106b832f6", "message": "Change stream constructor to take an iterable object:runtime changes", "committedDate": "2020-02-26T09:51:47Z", "type": "commit"}, {"oid": "b027fa9d4956f8b55f9879feaccc478316334fde", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b027fa9d4956f8b55f9879feaccc478316334fde", "message": "Add error type support and remove stream construct", "committedDate": "2020-02-27T04:22:46Z", "type": "commit"}, {"oid": "103636445e8b80657b7191ba5ae960e2839d7dc0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/103636445e8b80657b7191ba5ae960e2839d7dc0", "message": "Fix compile errors", "committedDate": "2020-02-27T04:26:25Z", "type": "commit"}, {"oid": "95df9e50fd489056f9fa8ae70c4b465cb41f4f4b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/95df9e50fd489056f9fa8ae70c4b465cb41f4f4b", "message": "Merge with upstream", "committedDate": "2020-02-27T05:09:54Z", "type": "commit"}, {"oid": "2ec56bd19c4844f924af16370f5285de0a3d0c70", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2ec56bd19c4844f924af16370f5285de0a3d0c70", "message": "Refactor code", "committedDate": "2020-02-27T09:43:33Z", "type": "commit"}, {"oid": "381129c6018ef9a9fefd8e50fdc10aba5c8ccdf7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/381129c6018ef9a9fefd8e50fdc10aba5c8ccdf7", "message": "Add implicit stream construct", "committedDate": "2020-02-28T12:47:03Z", "type": "commit"}, {"oid": "c4d4720dc15e347573239ba37acdb840d3346fb0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/c4d4720dc15e347573239ba37acdb840d3346fb0", "message": "Merge upstream", "committedDate": "2020-02-28T12:54:54Z", "type": "commit"}, {"oid": "4908b4f77bf7022084f63191a9af95a8f5fc7017", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4908b4f77bf7022084f63191a9af95a8f5fc7017", "message": "Add explicit stream construct", "committedDate": "2020-03-01T07:49:27Z", "type": "commit"}, {"oid": "1ad1703ef6a6c7a8df59031ab5c2fdcff8ac6299", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1ad1703ef6a6c7a8df59031ab5c2fdcff8ac6299", "message": "Set correct type params for toStream function", "committedDate": "2020-03-02T06:10:34Z", "type": "commit"}, {"oid": "9af26c5baeea5bee1346256b3fe233eacc524ff7", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/9af26c5baeea5bee1346256b3fe233eacc524ff7", "message": "Enable BStreamValue tests", "committedDate": "2020-03-02T08:38:48Z", "type": "commit"}, {"oid": "bac620a844adb32d5f42a3036a4b0c0cafec2a34", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/bac620a844adb32d5f42a3036a4b0c0cafec2a34", "message": "Merge branch 'streams-rewrite' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite", "committedDate": "2020-03-02T08:40:23Z", "type": "commit"}, {"oid": "3e6191c36e6e8a6e7bc13167aad25ed4a4bbbe4b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3e6191c36e6e8a6e7bc13167aad25ed4a4bbbe4b", "message": "Fix stream value type name", "committedDate": "2020-03-02T09:25:53Z", "type": "commit"}, {"oid": "40912a975e20496ef287af240709fa09a35b0375", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/40912a975e20496ef287af240709fa09a35b0375", "message": "Merge branch 'streams-rewrite' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite", "committedDate": "2020-03-02T11:01:11Z", "type": "commit"}, {"oid": "00a8ab6b92a67fb57e20a0bcb97bb92d51102de3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/00a8ab6b92a67fb57e20a0bcb97bb92d51102de3", "message": "Allow user defined error types with streams", "committedDate": "2020-03-03T02:30:02Z", "type": "commit"}, {"oid": "fe7e60f825246f50e2227c6866c7e150e5bef52b", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fe7e60f825246f50e2227c6866c7e150e5bef52b", "message": "Merge branch 'streams-rewrite' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite", "committedDate": "2020-03-03T05:17:44Z", "type": "commit"}, {"oid": "e9076ce93f73259ed068b21fed8b75a81c28e3f2", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/e9076ce93f73259ed068b21fed8b75a81c28e3f2", "message": "Improve type checking for stream type", "committedDate": "2020-03-03T09:03:12Z", "type": "commit"}, {"oid": "d85570685dd638141be493e3cd4bc01d520bcb5a", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/d85570685dd638141be493e3cd4bc01d520bcb5a", "message": "Fix explicit stream definition", "committedDate": "2020-03-04T04:40:53Z", "type": "commit"}, {"oid": "3d8f4393a243ab1506a2c60a8cac54de19eb9574", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3d8f4393a243ab1506a2c60a8cac54de19eb9574", "message": "Add test cases for BStream type", "committedDate": "2020-03-04T09:33:15Z", "type": "commit"}, {"oid": "51c82b76b97eed452ee2c94f486383f9187aa0ff", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/51c82b76b97eed452ee2c94f486383f9187aa0ff", "message": "Remove special check for streams", "committedDate": "2020-03-04T10:18:22Z", "type": "commit"}, {"oid": "f8fd8779b4d19e3f46946bc47f794ac561c8150c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f8fd8779b4d19e3f46946bc47f794ac561c8150c", "message": "Refactor code", "committedDate": "2020-03-04T10:18:42Z", "type": "commit"}, {"oid": "aa16b09ac572719f644daea2d4e6678e77145336", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/aa16b09ac572719f644daea2d4e6678e77145336", "message": "Merge branch 'streams-rewrite' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite", "committedDate": "2020-03-04T10:18:51Z", "type": "commit"}, {"oid": "a8f2591d52248dabd5c93535c7a3daec9893bd84", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a8f2591d52248dabd5c93535c7a3daec9893bd84", "message": "Fix stream tests compilation issues", "committedDate": "2020-03-04T10:32:17Z", "type": "commit"}, {"oid": "830836651e7ab15cfb90ea58cf762df920111dc0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/830836651e7ab15cfb90ea58cf762df920111dc0", "message": "Allow streams to have union of errors", "committedDate": "2020-03-04T14:53:06Z", "type": "commit"}, {"oid": "3e225060ae9da723f3d320a4d6c9dd1c2d253491", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/3e225060ae9da723f3d320a4d6c9dd1c2d253491", "message": "Merge branch 'streams-rewrite' of github.com:ballerina-platform/ballerina-lang into new-stream", "committedDate": "2020-03-04T14:54:02Z", "type": "commit"}, {"oid": "300206a87ef065aac660ca4d3aa9c1eba0e52f46", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/300206a87ef065aac660ca4d3aa9c1eba0e52f46", "message": "Disable streams negative tests", "committedDate": "2020-03-04T15:07:20Z", "type": "commit"}, {"oid": "a6312d1e6115c7914d289792d3ee622fb4bdee17", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a6312d1e6115c7914d289792d3ee622fb4bdee17", "message": "Add close function to stream - initial cut", "committedDate": "2020-03-04T23:27:15Z", "type": "commit"}, {"oid": "2bd9eb8ffe1597be8dbcaa3c116d1569b85438bb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2bd9eb8ffe1597be8dbcaa3c116d1569b85438bb", "message": "Fix taken from https://github.com/ballerina-platform/ballerina-lang/pull/21459", "committedDate": "2020-03-04T23:34:06Z", "type": "commit"}, {"oid": "45c85ed073276c804abbd212999ff2c0c6e4fdf3", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/45c85ed073276c804abbd212999ff2c0c6e4fdf3", "message": "Refactor stream.bal", "committedDate": "2020-03-06T06:43:05Z", "type": "commit"}, {"oid": "cbb78cd4fa96513a4ca5e3c6fd1d7ad5db537b9c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/cbb78cd4fa96513a4ca5e3c6fd1d7ad5db537b9c", "message": "Fix typeParam issue", "committedDate": "2020-03-06T09:44:07Z", "type": "commit"}, {"oid": "0abcf05359bf7be7190c286c718a26e058bd036c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/0abcf05359bf7be7190c286c718a26e058bd036c", "message": "Merge upstream", "committedDate": "2020-03-06T09:52:55Z", "type": "commit"}, {"oid": "f7887dec5240450536b8fb09a69ac33838d9fe6e", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f7887dec5240450536b8fb09a69ac33838d9fe6e", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite\n\n# Conflicts:\n#\tcompiler/ballerina-lang/src/main/java/org/ballerinalang/model/tree/NodeKind.java\n#\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/antlr4/BallerinaParser.java\n#\tlanguage-server/modules/langserver-core/src/main/java/org/ballerinalang/langserver/common/LSNodeVisitor.java", "committedDate": "2020-03-06T10:55:41Z", "type": "commit"}, {"oid": "252b53b5775c973dc1ad0dd12ccf89093cf015cc", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/252b53b5775c973dc1ad0dd12ccf89093cf015cc", "message": "Merge branch 'streams-rewrite' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite", "committedDate": "2020-03-06T10:55:52Z", "type": "commit"}, {"oid": "ccc406303a28558ce056d46a60599ee962b5f6b9", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ccc406303a28558ce056d46a60599ee962b5f6b9", "message": "Merge with master", "committedDate": "2020-03-07T07:24:32Z", "type": "commit"}, {"oid": "fcf8c0e87169da7ad4e8d950ed94ee80d4773247", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/fcf8c0e87169da7ad4e8d950ed94ee80d4773247", "message": "Merge with master", "committedDate": "2020-03-07T07:52:26Z", "type": "commit"}, {"oid": "b0accccfb53f8050f732f55f04db1d56283a9c22", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/b0accccfb53f8050f732f55f04db1d56283a9c22", "message": "Fix lang server core tests", "committedDate": "2020-03-08T04:42:59Z", "type": "commit"}, {"oid": "a71233a0d21e17916303c9b6919b7d2c96c966e8", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/a71233a0d21e17916303c9b6919b7d2c96c966e8", "message": "Refactor comment", "committedDate": "2020-03-08T04:43:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2ODQ0Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r389768447", "bodyText": "Remove the commented line", "author": "mohanvive", "createdAt": "2020-03-09T15:30:31Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeParamAnalyzer.java", "diffHunk": "@@ -531,9 +538,11 @@ private BType getMatchingBoundType(BType expType, SymbolEnv env, HashSet<BType>\n                 return new BMapType(TypeTags.MAP, getMatchingBoundType(constraint, env, resolvedTypes),\n                         symTable.mapType.tsymbol);\n             case TypeTags.STREAM:\n-                BType streamConstraint = ((BStreamType) expType).constraint;\n-                return new BStreamType(TypeTags.STREAM, getMatchingBoundType(streamConstraint, env, resolvedTypes),\n-                                       symTable.streamType.tsymbol);\n+                BType streamConstraint = getMatchingBoundType(((BStreamType) expType).constraint, env, resolvedTypes);\n+//                BType streamErrorType = getMatchingBoundType(((BStreamType) expType).error, env, resolvedTypes);", "originalCommit": "a71233a0d21e17916303c9b6919b7d2c96c966e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2ODk0Mw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r389768943", "bodyText": "Does this change required?", "author": "mohanvive", "createdAt": "2020-03-09T15:31:14Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeParamAnalyzer.java", "diffHunk": "@@ -641,10 +650,6 @@ private BType getMatchingObjectBoundType(BObjectType expType, SymbolEnv env, Has\n     }\n \n     private BType getMatchingOptionalBoundType(BUnionType expType, SymbolEnv env, HashSet<BType> resolvedTypes) {\n-\n-        if (!expType.isNullable() || expType.getMemberTypes().size() != 2) {\n-            return expType;\n-        }", "originalCommit": "a71233a0d21e17916303c9b6919b7d2c96c966e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5OTE0Ng==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390099146", "bodyText": "Yes. This change allows compare all the member types when two union types are compared", "author": "gimantha", "createdAt": "2020-03-10T05:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2ODk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc3MDIxNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r389770214", "bodyText": "Remove the commented code blog.", "author": "mohanvive", "createdAt": "2020-03-09T15:33:07Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/Types.java", "diffHunk": "@@ -1230,10 +1230,14 @@ private boolean checkNextFuncReturnType(BType returnType) {\n             return false;\n         }\n \n-        if (types.size() != 1) {\n-            return false;\n+        if (!types.removeIf(type -> type.tag == TypeTags.ERROR)) {\n+            // return false;\n         }\n \n+//        if (types.size() != 1) {\n+//            return false;\n+//        }", "originalCommit": "a71233a0d21e17916303c9b6919b7d2c96c966e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1NzczMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390157733", "bodyText": "This is required.. Uncommented", "author": "gimantha", "createdAt": "2020-03-10T08:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc3MDIxNA=="}], "type": "inlineReview"}, {"oid": "f3d605382ea89c95ac6306a07a734d5906b4dadf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/f3d605382ea89c95ac6306a07a734d5906b4dadf", "message": "Make stream constraint optional", "committedDate": "2020-03-10T04:30:10Z", "type": "commit"}, {"oid": "2c4efa6a5f5c8c26c33612266a2487f49a31fcdf", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2c4efa6a5f5c8c26c33612266a2487f49a31fcdf", "message": "support stream streamA = new(foo); var streamA = new stream(foo);", "committedDate": "2020-03-10T04:41:46Z", "type": "commit"}, {"oid": "6e40487a24b112e43a47fe3adf7f90678940fb5c", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6e40487a24b112e43a47fe3adf7f90678940fb5c", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite\n\n# Conflicts:\n#\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/antlr4/BallerinaParser.java", "committedDate": "2020-03-10T05:11:05Z", "type": "commit"}, {"oid": "657c38151131b7b2585d230a8775bca2879367ba", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/657c38151131b7b2585d230a8775bca2879367ba", "message": "Refactor imports", "committedDate": "2020-03-10T05:14:04Z", "type": "commit"}, {"oid": "1fd9dc0b7ed9f5c8db432700bbc00d8caff3c040", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/1fd9dc0b7ed9f5c8db432700bbc00d8caff3c040", "message": "Fix git review issues", "committedDate": "2020-03-10T05:16:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwNzI3Nw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390107277", "bodyText": "Check how dependencies work for stream init", "author": "gimantha", "createdAt": "2020-03-10T05:52:37Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/DataflowAnalyzer.java", "diffHunk": "@@ -788,7 +789,8 @@ private void addDependency(BSymbol dependent, BSymbol provider) {\n     @Override\n     public void visit(BLangTypeInit typeInitExpr) {\n         typeInitExpr.argsExpr.forEach(argExpr -> analyzeNode(argExpr, env));\n-        if (this.currDependentSymbol.peek() != null) {\n+        if (this.currDependentSymbol.peek() != null\n+                && (typeInitExpr.type.tag != TypeTags.STREAM)) {", "originalCommit": "1fd9dc0b7ed9f5c8db432700bbc00d8caff3c040", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1ODczMA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390158730", "bodyText": "fixed", "author": "gimantha", "createdAt": "2020-03-10T08:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwNzI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwOTk1NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390109954", "bodyText": "add test cases to cover negative cases", "author": "gimantha", "createdAt": "2020-03-10T06:04:37Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "diffHunk": "@@ -1724,9 +1721,36 @@ public void visit(BLangTypeInit cIExpr) {\n                 }\n                 break;\n             case TypeTags.STREAM:\n-                dlog.error(cIExpr.pos, DiagnosticCode.INVALID_STREAM_CONSTRUCTOR,\n-                           cIExpr.initInvocation.name);\n-                resultType = symTable.semanticError;\n+                if (cIExpr.initInvocation.argExprs.size() != 1) {", "originalCommit": "1fd9dc0b7ed9f5c8db432700bbc00d8caff3c040", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDExMTAxMw==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390111013", "bodyText": "double check - what if user sets ()  for errorType? in stream<constraintType, ErrorType?>", "author": "gimantha", "createdAt": "2020-03-10T06:09:05Z", "path": "compiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/semantics/analyzer/TypeChecker.java", "diffHunk": "@@ -1724,9 +1721,36 @@ public void visit(BLangTypeInit cIExpr) {\n                 }\n                 break;\n             case TypeTags.STREAM:\n-                dlog.error(cIExpr.pos, DiagnosticCode.INVALID_STREAM_CONSTRUCTOR,\n-                           cIExpr.initInvocation.name);\n-                resultType = symTable.semanticError;\n+                if (cIExpr.initInvocation.argExprs.size() != 1) {\n+                    dlog.error(cIExpr.pos, DiagnosticCode.INVALID_STREAM_CONSTRUCTOR, cIExpr.initInvocation.name);\n+                    resultType = symTable.semanticError;\n+                    return;\n+                }\n+\n+                BStreamType actualStreamType = (BStreamType) actualType;", "originalCommit": "1fd9dc0b7ed9f5c8db432700bbc00d8caff3c040", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwNTM0NA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390305344", "bodyText": "created an issue for this.\n#21596", "author": "gimantha", "createdAt": "2020-03-10T13:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDExMTAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyMTIyNA==", "url": "https://github.com/ballerina-platform/ballerina-lang/pull/21524#discussion_r390121224", "bodyText": "return error not the reduced value", "author": "gimantha", "createdAt": "2020-03-10T06:50:56Z", "path": "langlib/lang.stream/src/main/ballerina/src/lang.stream/stream.bal", "diffHunk": "@@ -13,127 +13,189 @@\n // KIND, either express or implied.  See the License for the\n // specific language governing permissions and limitations\n // under the License.\n+\n import ballerina/lang.__internal as internal;\n \n-//TODO: stream<Type, E>, supporting E is not implemented yet.\n-# A type parameter that is a subtype of `anydata|error`.\n+# A type parameter that is a subtype of `any|error`.\n # Has the special semantic that when used in a declaration\n # all uses in the declaration must refer to same type.\n @typeParam\n-type PureType1 anydata | error;\n+type Type any|error;\n \n+# A type parameter that is a subtype of `error`.\n+# Has the special semantic that when used in a declaration\n+# all uses in the declaration must refer to same type.\n @typeParam\n-type PureType2 anydata | error;\n+type ErrorType error?;\n \n+# A type parameter that is a subtype of `any|error`.\n+# Has the special semantic that when used in a declaration\n+# all uses in the declaration must refer to same type.\n @typeParam\n-type Type any | error;\n-\n+type Type1 any|error;\n \n-# Selects the members from an array for which the `func` function returns true.\n+# Selects the members from a stream for which a function returns true.\n #\n-# + strm - The stream\n+# + stm - the stream\n # + func - a predicate to apply to each member to test whether it should be selected\n-# + return - new stream only containing members of `strm` for which `func` evaluates to true\n-public function filter(stream<PureType1> strm, function(PureType1 val) returns boolean func) returns stream<PureType1> {\n-    return stream {\n+# + return - new stream only containing members of `stm` for which `func` evaluates to true\n+public function filter(stream<Type,ErrorType> stm, function(Type val) returns boolean func)\n+   returns stream<Type,ErrorType>  {\n+    object {\n+        public stream<Type, ErrorType> strm;\n+        public any func;\n+\n+        public function __init(stream<Type, ErrorType> strm, function(Type val) returns boolean func) {\n+            self.strm = strm;\n+            self.func = func;\n+        }\n+\n+        public function next() returns record {|Type value;|}|ErrorType? {\n             // while loop is required to continue filtering until we find a value which matches the filter or ().\n             while(true) {\n-                var nextVal = next(strm);\n+                var nextVal = next(self.strm);\n                 if (nextVal is ()) {\n                     return ();\n+                } else if (nextVal is error) {\n+                    return nextVal;\n                 } else {\n                     var value = nextVal?.value;\n+                    function(any|error) returns boolean func = internal:getFilterFunc(self.func);\n                     if (func(value)) {\n                         return nextVal;\n                     }\n                 }\n             }\n             return ();\n-        };\n+        }\n+    } itrObj = new(stm, func);\n+    return internal:construct(internal:getElementType(typeof stm), itrObj);\n }\n \n # Returns the next element in the stream wrapped in a record or () if the stream ends.\n #\n # + strm - The stream\n # + return - If the stream has elements, return the element wrapped in a record with single field called `value`,\n #            otherwise returns ()\n-public function next(stream<PureType1> strm) returns record {| PureType1 value; |}? {\n-    var fp = getGenFunc(strm);\n-    return internal:createClone(fp());\n+public function next(stream<Type, ErrorType> strm) returns record {| Type value; |}|ErrorType? {\n+    abstract object {\n+        public function next() returns record {|Type value;|}|ErrorType?;\n+    } iteratorObj = <abstract object {\n+                            public function next() returns record {|Type value;|}|ErrorType?;\n+                     }>internal:getIteratorObj(strm);\n+    var next1 = iteratorObj.next();\n+    if (next1 is ()) {\n+        return ();\n+    } else if (next1 is error) {\n+        return next1;\n+    } else {\n+        return internal:setNarrowType(internal:getElementType(typeof strm), {value : next1.value});\n+    }\n }\n \n-# Applies a function to each member of a stream and returns a new stream of the results.\n+# Applies a function to each member of a stream and returns a stream of the results.\n #\n-# + strm - The stream\n-# + func - A function to apply to each member\n-# + return - New stream containing result of applying `func` to each member of `strm` in order\n-public function 'map(stream<PureType1> strm, function(PureType1 val) returns PureType2 func) returns stream<PureType2> {\n-    return stream {\n-        var nextVal = next(strm);\n-        if (nextVal is ()) {\n-            return ();\n-        } else {\n-            function(anydata | error) returns anydata | error mappingFunc = func;\n-            var value = mappingFunc(nextVal.value);\n-            return internal:setNarrowType(typeof value, {value : value});\n-        }\n-    };\n+# + stm - the stream\n+# + func - a function to apply to each member\n+# + return - new stream containing result of applying `func` to each member of `stm` in order\n+public function 'map(stream<Type,ErrorType> stm, function(Type val) returns Type1 func)\n+   returns stream<Type1,ErrorType> {\n+    object {\n+       public stream<Type, ErrorType> strm;\n+       public any func;\n+\n+       public function __init(stream<Type, ErrorType> strm, function(Type val) returns Type1 func) {\n+           self.strm = strm;\n+           self.func = func;\n+       }\n+\n+       public function next() returns record {|Type value;|}|ErrorType? {\n+           var nextVal = next(self.strm);\n+           if (nextVal is ()) {\n+               return ();\n+           } else {\n+               function(any | error) returns any | error mappingFunc = internal:getMapFunc(self.func);\n+               if (nextVal is error) {\n+                    return nextVal;\n+               } else {\n+                    var value = mappingFunc(nextVal.value);\n+                    return internal:setNarrowType(typeof value, {value : value});\n+               }\n+           }\n+       }\n+    } iteratorObj = new(stm, func);\n+    return internal:construct(internal:getReturnType(func), iteratorObj);\n }\n \n-# Combines the members of an stream using a combining function.\n+// Refer to issue https://github.com/ballerina-platform/ballerina-lang/issues/21527\n+# Combines the members of a stream using a combining function.\n # The combining function takes the combined value so far and a member of the stream,\n # and returns a new combined value.\n #\n-# + strm - the stream\n+# + stm - the stream\n # + func - combining function\n-# + initial - initial value for the first argument of combining parameter `func`\n-# + return - result of combining the members of `strm` using `func`\n-#\n-# For example\n-# ```\n-# reduce([1, 2, 3].toStream(), function (int total, int n) returns int { return total + n; }, 0)\n-# ```\n-# is the same as `sum(1, 2, 3)`.\n-public function reduce(stream<PureType1> strm, function(Type accum, PureType1 val) returns Type func, Type initial) returns Type {\n+# + initial - initial value for the first argument of combining function\n+# + return - result of combining the members of `stm` using the combining function\n+public function reduce(stream<Type,ErrorType> stm, function(Type1 accum, Type val) returns Type1 func, Type1 initial)\n+   returns Type1|ErrorType {\n     any | error reducedValue = initial;\n     while (true) {\n-        var nextVal = next(strm);\n+        var nextVal = next(stm);\n         if (nextVal is ()) {\n             return reducedValue;\n+        } else if (nextVal is error) {\n+            return reducedValue;", "originalCommit": "1fd9dc0b7ed9f5c8db432700bbc00d8caff3c040", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac4639da161701236524bfc846071e9ced42763d", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/ac4639da161701236524bfc846071e9ced42763d", "message": "Fix git reviews", "committedDate": "2020-03-10T08:42:16Z", "type": "commit"}, {"oid": "4326632d0daabb26a45abc61332ecccef4857b07", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/4326632d0daabb26a45abc61332ecccef4857b07", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite\n\n# Conflicts:\n#\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/antlr4/BallerinaParser.java", "committedDate": "2020-03-10T10:15:18Z", "type": "commit"}, {"oid": "5be6a51490295b7e4a5340d2dab56cf4548aefc0", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/5be6a51490295b7e4a5340d2dab56cf4548aefc0", "message": "Revert change", "committedDate": "2020-03-10T10:15:58Z", "type": "commit"}, {"oid": "15b11e54bcf64ab7ccdb5b0174e50a3b24480c4f", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/15b11e54bcf64ab7ccdb5b0174e50a3b24480c4f", "message": "Refactor imports", "committedDate": "2020-03-10T11:18:57Z", "type": "commit"}, {"oid": "6e679edc8fc85a6a03b6ffa631723adfa212abbb", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/6e679edc8fc85a6a03b6ffa631723adfa212abbb", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite\n\n# Conflicts:\n#\tcompiler/ballerina-lang/src/main/java/org/wso2/ballerinalang/compiler/parser/antlr4/BallerinaParser.java", "committedDate": "2020-03-10T12:50:57Z", "type": "commit"}, {"oid": "2bc85f24c20eb9619ef599121e7f6dda95a0c0c1", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/2bc85f24c20eb9619ef599121e7f6dda95a0c0c1", "message": "Add stream type to JMethodResolver", "committedDate": "2020-03-10T13:04:25Z", "type": "commit"}, {"oid": "30eef82f55676f1c3e19df9e4d47c369c4a85f81", "url": "https://github.com/ballerina-platform/ballerina-lang/commit/30eef82f55676f1c3e19df9e4d47c369c4a85f81", "message": "Merge branch 'master' of https://github.com/ballerina-platform/ballerina-lang into streams-rewrite", "committedDate": "2020-03-10T13:13:57Z", "type": "commit"}]}