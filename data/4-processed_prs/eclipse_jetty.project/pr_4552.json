{"pr_number": 4552, "pr_title": "Fix MethodHandles lookup to support JPMS runtime mode", "pr_createdAt": "2020-02-06T11:33:12Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4552", "timeline": [{"oid": "1046b7f57aa8452668d51abebdb32ad8f3a52f9b", "url": "https://github.com/eclipse/jetty.project/commit/1046b7f57aa8452668d51abebdb32ad8f3a52f9b", "message": "use a lookup dedicated to the target class (webapp classloader) to avoid collision with server classloader\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-02-06T11:35:29Z", "type": "commit"}, {"oid": "1046b7f57aa8452668d51abebdb32ad8f3a52f9b", "url": "https://github.com/eclipse/jetty.project/commit/1046b7f57aa8452668d51abebdb32ad8f3a52f9b", "message": "use a lookup dedicated to the target class (webapp classloader) to avoid collision with server classloader\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-02-06T11:35:29Z", "type": "forcePushed"}, {"oid": "5ab4f66128d69fafb98b826156c79a2c06a74a57", "url": "https://github.com/eclipse/jetty.project/commit/5ab4f66128d69fafb98b826156c79a2c06a74a57", "message": "cleanup war test dependencies\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-02-07T03:08:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5OTc4MA==", "url": "https://github.com/eclipse/jetty.project/pull/4552#discussion_r376299780", "bodyText": "Remove this empty line.", "author": "sbordet", "createdAt": "2020-02-07T09:45:29Z", "path": "tests/test-distribution/src/test/java/org/eclipse/jetty/tests/distribution/DistributionTests.java", "diffHunk": "@@ -401,4 +404,57 @@ public void testWebAppWithProxyAndJPMS() throws Exception\n             }\n         }\n     }\n+\n+    @ParameterizedTest\n+    @ValueSource(strings = {\n+        \"\",\n+        \"--jpms\",\n+    })\n+    public void testSimpleWebAppWithWebsocket(String arg) throws Exception\n+    {\n+        String jettyVersion = System.getProperty(\"jettyVersion\");\n+        DistributionTester distribution = DistributionTester.Builder.newInstance()\n+            .jettyVersion(jettyVersion)\n+            .mavenLocalRepository(System.getProperty(\"mavenRepoPath\"))\n+            .build();\n+        String[] args1 = {\n+            \"--create-startd\",\n+            \"--approve-all-licenses\",\n+            \"--add-to-start=resources,server,http,webapp,deploy,jsp,jmx,servlet,servlets,websocket\"\n+        };\n+        try (DistributionTester.Run run1 = distribution.start(args1))\n+        {\n+            assertTrue(run1.awaitFor(5, TimeUnit.SECONDS));\n+            assertEquals(0, run1.getExitValue());\n+\n+            File war = distribution.resolveArtifact(\"org.eclipse.jetty.tests:test-websocket-webapp:war:\" + jettyVersion);\n+            distribution.installWarFile(war, \"test1\");\n+            distribution.installWarFile(war, \"test2\");\n+\n+            int port = distribution.freePort();\n+            String[] args2 = {\n+                arg,\n+                \"jetty.http.port=\" + port//,\n+                //\"jetty.server.dumpAfterStart=true\"\n+            };\n+            try (DistributionTester.Run run2 = distribution.start(args2))\n+            {\n+                assertTrue(run2.awaitConsoleLogsFor(\"Started Server@\", 10, TimeUnit.SECONDS));\n+                assertFalse(run2.getLogs().stream().anyMatch(s -> s.contains(\"LinkageError\")));\n+\n+                startHttpClient();\n+                ContentResponse response = client.GET(\"http://localhost:\" + port + \"/test1/index.jsp\");\n+                assertEquals(HttpStatus.OK_200, response.getStatus());\n+                assertThat(response.getContentAsString(), containsString(\"Hello\"));\n+                assertThat(response.getContentAsString(), not(containsString(\"<%\")));\n+\n+                client.GET(\"http://localhost:\" + port + \"/test2/index.jsp\");\n+                assertEquals(HttpStatus.OK_200, response.getStatus());\n+                assertThat(response.getContentAsString(), containsString(\"Hello\"));\n+                assertThat(response.getContentAsString(), not(containsString(\"<%\")));\n+", "originalCommit": "5ab4f66128d69fafb98b826156c79a2c06a74a57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5OTg5MA==", "url": "https://github.com/eclipse/jetty.project/pull/4552#discussion_r376299890", "bodyText": "Remove this empty line.", "author": "sbordet", "createdAt": "2020-02-07T09:45:42Z", "path": "tests/test-distribution/src/test/java/org/eclipse/jetty/tests/distribution/DistributionTests.java", "diffHunk": "@@ -401,4 +404,57 @@ public void testWebAppWithProxyAndJPMS() throws Exception\n             }\n         }\n     }\n+\n+    @ParameterizedTest\n+    @ValueSource(strings = {\n+        \"\",\n+        \"--jpms\",\n+    })\n+    public void testSimpleWebAppWithWebsocket(String arg) throws Exception\n+    {\n+        String jettyVersion = System.getProperty(\"jettyVersion\");\n+        DistributionTester distribution = DistributionTester.Builder.newInstance()\n+            .jettyVersion(jettyVersion)\n+            .mavenLocalRepository(System.getProperty(\"mavenRepoPath\"))\n+            .build();\n+        String[] args1 = {\n+            \"--create-startd\",\n+            \"--approve-all-licenses\",\n+            \"--add-to-start=resources,server,http,webapp,deploy,jsp,jmx,servlet,servlets,websocket\"\n+        };\n+        try (DistributionTester.Run run1 = distribution.start(args1))\n+        {\n+            assertTrue(run1.awaitFor(5, TimeUnit.SECONDS));\n+            assertEquals(0, run1.getExitValue());\n+\n+            File war = distribution.resolveArtifact(\"org.eclipse.jetty.tests:test-websocket-webapp:war:\" + jettyVersion);\n+            distribution.installWarFile(war, \"test1\");\n+            distribution.installWarFile(war, \"test2\");\n+\n+            int port = distribution.freePort();\n+            String[] args2 = {\n+                arg,\n+                \"jetty.http.port=\" + port//,\n+                //\"jetty.server.dumpAfterStart=true\"\n+            };\n+            try (DistributionTester.Run run2 = distribution.start(args2))\n+            {\n+                assertTrue(run2.awaitConsoleLogsFor(\"Started Server@\", 10, TimeUnit.SECONDS));\n+                assertFalse(run2.getLogs().stream().anyMatch(s -> s.contains(\"LinkageError\")));\n+\n+                startHttpClient();\n+                ContentResponse response = client.GET(\"http://localhost:\" + port + \"/test1/index.jsp\");\n+                assertEquals(HttpStatus.OK_200, response.getStatus());\n+                assertThat(response.getContentAsString(), containsString(\"Hello\"));\n+                assertThat(response.getContentAsString(), not(containsString(\"<%\")));\n+\n+                client.GET(\"http://localhost:\" + port + \"/test2/index.jsp\");\n+                assertEquals(HttpStatus.OK_200, response.getStatus());\n+                assertThat(response.getContentAsString(), containsString(\"Hello\"));\n+                assertThat(response.getContentAsString(), not(containsString(\"<%\")));\n+\n+            }\n+        }\n+    }\n+", "originalCommit": "5ab4f66128d69fafb98b826156c79a2c06a74a57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMDQ1Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4552#discussion_r376300456", "bodyText": "Seems like something is missing?", "author": "sbordet", "createdAt": "2020-02-07T09:46:52Z", "path": "tests/test-webapps/test-websocket-webapp/src/main/java/org/eclipse/jetty/tests/webapp/websocket/OnCloseServerEndpoint.java", "diffHunk": "@@ -0,0 +1,52 @@\n+//\n+// ========================================================================\n+// Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//\n+// This program and the accompanying materials are made available under\n+// the terms of the Eclipse Public License 2.0 which is available at\n+// https://www.eclipse.org/legal/epl-2.0\n+//\n+// This Source Code may also be made available under the following\n+// Secondary Licenses when the conditions for such availability set\n+// forth in the Eclipse Public License, v. 2.0 are satisfied:\n+// the Apache License v2.0 which is available at\n+// https://www.apache.org/licenses/LICENSE-2.0\n+//\n+// SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+// ========================================================================\n+//\n+\n+package org.eclipse.jetty.tests.webapp.websocket;\n+\n+import java.io.IOException;\n+import javax.websocket.OnClose;\n+import javax.websocket.OnError;\n+import javax.websocket.OnMessage;\n+import javax.websocket.Session;\n+import javax.websocket.server.ServerEndpoint;\n+\n+@ServerEndpoint(\"/onclose/{arg}\")\n+public class OnCloseServerEndpoint\n+{\n+    private static String close = \"\";\n+\n+    @OnMessage\n+    public String echo(String echo)\n+    {\n+        return close + echo;\n+    }\n+\n+    @OnClose\n+    public void onClose(Session session)\n+    {\n+        //", "originalCommit": "5ab4f66128d69fafb98b826156c79a2c06a74a57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMyMTIzMg==", "url": "https://github.com/eclipse/jetty.project/pull/4552#discussion_r376321232", "bodyText": "not really it's just fake classes/method to test deployment", "author": "olamy", "createdAt": "2020-02-07T10:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMDQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMDU3Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4552#discussion_r376300577", "bodyText": "Seems like something is missing?", "author": "sbordet", "createdAt": "2020-02-07T09:47:08Z", "path": "tests/test-webapps/test-websocket-webapp/src/main/java/org/eclipse/jetty/tests/webapp/websocket/OnOpenServerEndpoint.java", "diffHunk": "@@ -0,0 +1,52 @@\n+//\n+// ========================================================================\n+// Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//\n+// This program and the accompanying materials are made available under\n+// the terms of the Eclipse Public License 2.0 which is available at\n+// https://www.eclipse.org/legal/epl-2.0\n+//\n+// This Source Code may also be made available under the following\n+// Secondary Licenses when the conditions for such availability set\n+// forth in the Eclipse Public License, v. 2.0 are satisfied:\n+// the Apache License v2.0 which is available at\n+// https://www.apache.org/licenses/LICENSE-2.0\n+//\n+// SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+// ========================================================================\n+//\n+\n+package org.eclipse.jetty.tests.webapp.websocket;\n+\n+import java.io.IOException;\n+import javax.websocket.OnError;\n+import javax.websocket.OnMessage;\n+import javax.websocket.OnOpen;\n+import javax.websocket.Session;\n+import javax.websocket.server.ServerEndpoint;\n+\n+@ServerEndpoint(\"/onopen/{arg}\")\n+public class OnOpenServerEndpoint\n+{\n+    private static String open = \"\";\n+\n+    @OnMessage\n+    public String echo(String echo)\n+    {\n+        return open + echo;\n+    }\n+\n+    @OnOpen\n+    public void onOpen(Session session)\n+    {\n+        //", "originalCommit": "5ab4f66128d69fafb98b826156c79a2c06a74a57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMyMTMwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4552#discussion_r376321309", "bodyText": "not really it's just fake classes/method to test deployment", "author": "olamy", "createdAt": "2020-02-07T10:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMDU3Nw=="}], "type": "inlineReview"}, {"oid": "3e19d1f016940c0e3089bf221a92f39b9651f26a", "url": "https://github.com/eclipse/jetty.project/commit/3e19d1f016940c0e3089bf221a92f39b9651f26a", "message": "remove empty lines\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-02-07T10:32:15Z", "type": "commit"}, {"oid": "b8473cac819490663741383c02e632c11d0c14ae", "url": "https://github.com/eclipse/jetty.project/commit/b8473cac819490663741383c02e632c11d0c14ae", "message": "make it clear it is a bad websocket webapp only for testing purpose and add a good websocket webapp\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-02-08T06:15:12Z", "type": "commit"}, {"oid": "b3eaaab3eb2a693f1421749fbaa86b02860ae795", "url": "https://github.com/eclipse/jetty.project/commit/b3eaaab3eb2a693f1421749fbaa86b02860ae795", "message": "no need anymore of this dependency\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>", "committedDate": "2020-02-09T00:02:01Z", "type": "commit"}]}