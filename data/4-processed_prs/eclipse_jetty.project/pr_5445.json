{"pr_number": 5445, "pr_title": "ForwardedRequestCustomizer behavior should not be applied to requests without forwarding headers", "pr_createdAt": "2020-10-13T10:13:25Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5445", "timeline": [{"oid": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87", "url": "https://github.com/eclipse/jetty.project/commit/0b646ee6b78c5e4e1dff6ddbf641b839360d8a87", "message": "Issue #5443 - Forwarding Headers are optional\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-13T10:10:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1NDQwMA==", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503854400", "bodyText": "why setting here and not below?", "author": "gregw", "createdAt": "2020-10-13T10:51:52Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -461,81 +461,88 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n \n         // Do a single pass through the header fields as it is a more efficient single iteration.\n         Forwarded forwarded = new Forwarded(request, config);\n+        boolean match = false;\n         for (HttpField field : httpFields)\n         {\n             try\n             {\n                 MethodHandle handle = _handles.get(field.getName());\n                 if (handle != null)\n+                {\n+                    match = true;\n                     handle.invoke(forwarded, field);\n+                }\n             }\n             catch (Throwable t)\n             {\n                 onError(field, t);\n             }\n         }\n \n-        String proto = \"http\";\n-\n-        // Is secure status configured from headers?\n-        if (forwarded.isSecure())\n+        if (match)\n         {\n-            // set default to https\n-            proto = config.getSecureScheme();\n-        }\n+            String proto = \"http\";\n \n-        // Set Scheme from configured protocol\n-        if (forwarded._proto != null)\n-        {\n-            proto = forwarded._proto;\n-            request.setScheme(proto);\n-        }\n+            // Is secure status configured from headers?\n+            if (forwarded.isSecure())\n+            {\n+                // set default to https\n+                proto = config.getSecureScheme();\n+            }\n \n-        // Set authority\n-        String host = null;\n-        int port = -1;\n+            // Set Scheme from configured protocol\n+            if (forwarded._proto != null)\n+            {\n+                proto = forwarded._proto;\n+                request.setScheme(proto);", "originalCommit": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg5MDgxOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503890819", "bodyText": "The forwarded._proto tracking value is set from 3 different scenarios.\n\nX-Forwarded-Proto: <value> header.\nX-Proxied-Https: on sets it to https.\nForwarding: proto=<value> header.\n\nSo this one that you highlighted is correct.\nThe below action is to handle the not-quite-forwarding-headers oddball cases.\n\n  \n    \n      jetty.project/jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java\n    \n    \n        Lines 731 to 743\n      in\n      0b646ee\n    \n    \n    \n    \n\n        \n          \n           Arguments.of(new Request(\"Proxy-Ssl-Id (setSslIsSecure==true)\") \n        \n\n        \n          \n                   .configureCustomizer((customizer) -> customizer.setSslIsSecure(true)) \n        \n\n        \n          \n                   .headers( \n        \n\n        \n          \n                       \"GET / HTTP/1.1\", \n        \n\n        \n          \n                       \"Host: myhost\", \n        \n\n        \n          \n                       \"Proxy-Ssl-Id: 0123456789abcdef\" \n        \n\n        \n          \n                   ), \n        \n\n        \n          \n               new Expectations() \n        \n\n        \n          \n                   .scheme(\"https\").serverName(\"myhost\").serverPort(443) \n        \n\n        \n          \n                   .requestURL(\"https://myhost/\") \n        \n\n        \n          \n                   .remoteAddr(\"0.0.0.0\").remotePort(0) \n        \n\n        \n          \n                   .sslSession(\"0123456789abcdef\") \n        \n\n        \n          \n           ), \n        \n    \n  \n\n\nWhich has the ForwardingRequestCustomizer.setSslIsSecure(true) which should trigger both the proto/scheme to https and the request.setSecure(true) if the Proxy-Ssl-Id or Proxy-auth-cert headers are present.\nLet me see if I can simplify this a bit.", "author": "joakime", "createdAt": "2020-10-13T11:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1NDQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1NTQzMg==", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503855432", "bodyText": "I'm don't think that just because it arrives on the secure port is sufficient to make it secure.  Some ports might do both secure and insecure requests.", "author": "gregw", "createdAt": "2020-10-13T10:53:47Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -461,81 +461,88 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n \n         // Do a single pass through the header fields as it is a more efficient single iteration.\n         Forwarded forwarded = new Forwarded(request, config);\n+        boolean match = false;\n         for (HttpField field : httpFields)\n         {\n             try\n             {\n                 MethodHandle handle = _handles.get(field.getName());\n                 if (handle != null)\n+                {\n+                    match = true;\n                     handle.invoke(forwarded, field);\n+                }\n             }\n             catch (Throwable t)\n             {\n                 onError(field, t);\n             }\n         }\n \n-        String proto = \"http\";\n-\n-        // Is secure status configured from headers?\n-        if (forwarded.isSecure())\n+        if (match)\n         {\n-            // set default to https\n-            proto = config.getSecureScheme();\n-        }\n+            String proto = \"http\";\n \n-        // Set Scheme from configured protocol\n-        if (forwarded._proto != null)\n-        {\n-            proto = forwarded._proto;\n-            request.setScheme(proto);\n-        }\n+            // Is secure status configured from headers?\n+            if (forwarded.isSecure())\n+            {\n+                // set default to https\n+                proto = config.getSecureScheme();\n+            }\n \n-        // Set authority\n-        String host = null;\n-        int port = -1;\n+            // Set Scheme from configured protocol\n+            if (forwarded._proto != null)\n+            {\n+                proto = forwarded._proto;\n+                request.setScheme(proto);\n+            }\n \n-        // Use authority from headers, if configured.\n-        if (forwarded._authority != null)\n-        {\n-            host = forwarded._authority._host;\n-            port = forwarded._authority._port;\n-        }\n+            // Set authority\n+            String host = null;\n+            int port = -1;\n \n-        // Fall back to request metadata if needed.\n-        HttpURI requestURI = request.getMetaData().getURI();\n-        if (host == null)\n-        {\n-            host = requestURI.getHost();\n-        }\n-        if (port == MutableHostPort.UNSET) // is unset by headers\n-        {\n-            port = requestURI.getPort();\n-        }\n-        // Don't change port if port == IMPLIED.\n+            // Use authority from headers, if configured.\n+            if (forwarded._authority != null)\n+            {\n+                host = forwarded._authority._host;\n+                port = forwarded._authority._port;\n+            }\n \n-        // Update authority if different from metadata\n-        if (!host.equalsIgnoreCase(requestURI.getHost()) ||\n-            port != requestURI.getPort())\n-        {\n-            httpFields.put(new HostPortHttpField(host, port));\n-            request.setAuthority(host, port);\n-        }\n+            // Fall back to request metadata if needed.\n+            HttpURI requestURI = request.getMetaData().getURI();\n+            if (host == null)\n+            {\n+                host = requestURI.getHost();\n+            }\n+            if (port == MutableHostPort.UNSET) // is unset by headers\n+            {\n+                port = requestURI.getPort();\n+            }\n+            // Don't change port if port == IMPLIED.\n \n-        // Set secure status\n-        if (forwarded.isSecure() ||\n-            proto.equalsIgnoreCase(config.getSecureScheme()) ||\n-            port == getSecurePort(config))\n-        {\n-            request.setSecure(true);\n-            request.setScheme(proto);\n-        }\n+            // Update authority if different from metadata\n+            if (!host.equalsIgnoreCase(requestURI.getHost()) ||\n+                port != requestURI.getPort())\n+            {\n+                httpFields.put(new HostPortHttpField(host, port));\n+                request.setAuthority(host, port);\n+            }\n \n-        // Set Remote Address\n-        if (forwarded.hasFor())\n-        {\n-            int forPort = forwarded._for._port > 0 ? forwarded._for._port : request.getRemotePort();\n-            request.setRemoteAddr(InetSocketAddress.createUnresolved(forwarded._for._host, forPort));\n+            // Set secure status\n+            if (forwarded.isSecure() ||\n+                proto.equalsIgnoreCase(config.getSecureScheme()) ||\n+                port == getSecurePort(config))", "originalCommit": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2NjU0Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503866542", "bodyText": "I don't think this match logic should be required.   There are many headers and some are orthogonal to others, so the logic below must be robust and can't be gated by a match, which may be for an unrelated header.\nIn the OPs case, proto must not be changed unless there is an explicit header that changes it - either giving a proto or forcing secure.\nPerhaps this match is an optimisation to avoid several ifs below, but I don't think it is necessary as this customizer is typically only deployed when all request will have such a header.", "author": "gregw", "createdAt": "2020-10-13T11:14:25Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -461,81 +461,88 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n \n         // Do a single pass through the header fields as it is a more efficient single iteration.\n         Forwarded forwarded = new Forwarded(request, config);\n+        boolean match = false;\n         for (HttpField field : httpFields)\n         {\n             try\n             {\n                 MethodHandle handle = _handles.get(field.getName());\n                 if (handle != null)\n+                {\n+                    match = true;\n                     handle.invoke(forwarded, field);\n+                }\n             }\n             catch (Throwable t)\n             {\n                 onError(field, t);\n             }\n         }\n \n-        String proto = \"http\";\n-\n-        // Is secure status configured from headers?\n-        if (forwarded.isSecure())\n+        if (match)", "originalCommit": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4MDg4Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503880886", "bodyText": "The match logic here (in jetty-9.4.x) was taken from jetty-10.0.x.\nhttps://github.com/eclipse/jetty.project/blame/jetty-10.0.x/jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java#L464-L482\nThe idea behind it is that if there's no Forwarding headers (even those not-quite-forwarding headers X-Proxied-Https, Proxy-auth-cert, and Proxy-ssl-id that ForwardingRequestCustomizer also pays attention to) then there should be no action taken by ForwardingRequestCustomizer, as the incoming request is not based on forwarding.", "author": "joakime", "createdAt": "2020-10-13T11:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2NjU0Mg=="}], "type": "inlineReview"}, {"oid": "f0681b33ebfaefa7082de5afe615ca01ef49955b", "url": "https://github.com/eclipse/jetty.project/commit/f0681b33ebfaefa7082de5afe615ca01ef49955b", "message": "Issue #5443 - Forwarding Headers are optional\n\n+ Simplify isSecure handling in customize.\n+ Simplify handling of `Proxy-Ssl-Id` header.\n+ Simplify handling of `Proxy-auth-cert` header.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-13T12:03:37Z", "type": "commit"}, {"oid": "abdada05b1d08ade47c1e8e82774fb5a2e98bb26", "url": "https://github.com/eclipse/jetty.project/commit/abdada05b1d08ade47c1e8e82774fb5a2e98bb26", "message": "Issue #5443 - Forwarding Headers are optional\n\n+ Improve / document implied secure scheme behaviors\n  for both `Proxy-Ssl-Id` or `Proxy-auth-cert`\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-13T12:15:38Z", "type": "commit"}, {"oid": "ea1103077cb6938d96ddc1c978c7fad7a5cb39e0", "url": "https://github.com/eclipse/jetty.project/commit/ea1103077cb6938d96ddc1c978c7fad7a5cb39e0", "message": "Issue #5443 - Forwarding Headers are optional\n\n+ Additional tests for HTTP/1.0\n+ Overly complex negative test cases for\n   `X-Forwarded-Proto: http` and\n   `X-Proxied-Https: off`\n+ Failure testcase for `X-Proxied-Https: foo`\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-13T13:20:27Z", "type": "commit"}, {"oid": "457025bc16c5cd6b4a0ecf547fc281df9839af81", "url": "https://github.com/eclipse/jetty.project/commit/457025bc16c5cd6b4a0ecf547fc281df9839af81", "message": "Issue #5443 - Forwarding Headers are optional\n\nAdditional NPE safety checks.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-13T13:24:49Z", "type": "commit"}, {"oid": "0721178007a884d2e4ef4b6ecf238266218e900b", "url": "https://github.com/eclipse/jetty.project/commit/0721178007a884d2e4ef4b6ecf238266218e900b", "message": "Issue #5443 - Forwarding Headers are optional\n\nThe `X-Proxied-Https: off` case should have an implied port\nnot a hardcoded port.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-13T13:31:32Z", "type": "commit"}, {"oid": "89dc16ae0999955699c16b26fbef80d64504c172", "url": "https://github.com/eclipse/jetty.project/commit/89dc16ae0999955699c16b26fbef80d64504c172", "message": "Issue #5443 - Forwarding Headers are optional\n\nCleanup handling of forwarded.authority\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-10-13T15:27:01Z", "type": "commit"}]}