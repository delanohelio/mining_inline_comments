{"pr_number": 5397, "pr_title": "Fixes #5378 Setting Holders during STARTING", "pr_createdAt": "2020-10-05T16:13:44Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5397", "timeline": [{"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "url": "https://github.com/eclipse/jetty.project/commit/9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "message": "Fixes #5378 Setting Holders during STARTING\n\nHolders are now started/initialized if needed by a new utility method", "committedDate": "2020-10-05T16:12:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNjcxNg==", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500136716", "bodyText": "Can we put in some comments about what is really being tested here, which is the various states in which the ServletContextHandler, ServletHandler can be in when a servlet/filter/listener is added.", "author": "janbartel", "createdAt": "2020-10-06T09:31:42Z", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));", "originalCommit": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzMzNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500137335", "bodyText": "Can we also please add tests for all the types of objects: adding servlets, filters and listeners from servlets, filters and listeners to make sure that the jetty apis are doing what we expect", "author": "janbartel", "createdAt": "2020-10-06T09:32:40Z", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/test\");", "originalCommit": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzk2NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500137965", "bodyText": "So this means that in the past, adding a listener when the ServletHandler had already started would not have worked, because it never would have been started or initialized - unless someone also happened to add a filter or servlet mapping.", "author": "janbartel", "createdAt": "2020-10-06T09:33:46Z", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "diffHunk": "@@ -800,10 +823,7 @@ public void addListener(ListenerHolder listener)\n     public void setListeners(ListenerHolder[] listeners)\n     {\n         if (listeners != null)\n-            for (ListenerHolder holder : listeners)\n-            {\n-                holder.setServletHandler(this);\n-            }\n+            initializeHolders(listeners);", "originalCommit": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE5MDM0NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500190345", "bodyText": "yep - 2nd bug!", "author": "gregw", "createdAt": "2020-10-06T11:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzODA1Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500138057", "bodyText": "Delete this line.", "author": "janbartel", "createdAt": "2020-10-06T09:33:58Z", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/test\");\n \n         _server.start();\n \n-\n         String request =\n-            \"GET /hello HTTP/1.0\\n\" +\n+            \"GET /test HTTP/1.0\\n\" +\n             \"Host: localhost\\n\" +\n             \"\\n\";\n         String response = _connector.getResponse(request);\n         assertThat(response, containsString(\"200 OK\"));\n+        assertThat(response, containsString(\"filter: filter\"));\n         assertThat(response, containsString(\"Test\"));\n \n-        handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/*\", EnumSet.of(DispatcherType.REQUEST));\n-        handler.addServletWithMapping(new ServletHolder(new HelloServlet()), \"/hello/*\");\n+\n+        handler.addServletWithMapping(new ServletHolder(new HelloServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/hello/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/hello/*\");\n \n         _server.dumpStdErr();", "originalCommit": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e1e0985833e33a97eacdd972b97825eb21cbac0", "url": "https://github.com/eclipse/jetty.project/commit/9e1e0985833e33a97eacdd972b97825eb21cbac0", "message": "Fixes #5378 Setting Holders during STARTING\n\nHolders are now started/initialized if needed by a new utility method", "committedDate": "2020-10-06T12:51:19Z", "type": "commit"}]}