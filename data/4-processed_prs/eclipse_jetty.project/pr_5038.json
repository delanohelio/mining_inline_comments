{"pr_number": 5038, "pr_title": "Issue #5029 Relative Redirection", "pr_createdAt": "2020-07-09T12:36:43Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5038", "timeline": [{"oid": "c8b8d7493e18399ba4abac153b0f8f22ce93ded4", "url": "https://github.com/eclipse/jetty.project/commit/c8b8d7493e18399ba4abac153b0f8f22ce93ded4", "message": "Issue #5029 Relative Redirection\n\nProvide option to allow relative redirection", "committedDate": "2020-07-09T12:35:41Z", "type": "commit"}, {"oid": "2b599b21c237a5f72b98c3a687ca358571cfe42d", "url": "https://github.com/eclipse/jetty.project/commit/2b599b21c237a5f72b98c3a687ca358571cfe42d", "message": "Issue #5029 Relative Redirection\n\nFixed checkstyle", "committedDate": "2020-07-09T19:20:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzNTE4Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5038#discussion_r452835187", "bodyText": "I don't like the name.\nIt's not whether relative redirects are allowed or not.\nIt's about whether we generate relative redirects or not.\ngenerateRelativeRedirects?\nuseRelativeRedirects?", "author": "sbordet", "createdAt": "2020-07-10T13:14:45Z", "path": "jetty-server/src/main/config/etc/jetty.xml", "diffHunk": "@@ -74,6 +74,7 @@\n       <Set name=\"requestCookieCompliance\"><Call class=\"org.eclipse.jetty.http.CookieCompliance\" name=\"valueOf\"><Arg><Property name=\"jetty.httpConfig.requestCookieCompliance\" deprecated=\"jetty.httpConfig.cookieCompliance\" default=\"RFC6265\"/></Arg></Call></Set>\n       <Set name=\"responseCookieCompliance\"><Call class=\"org.eclipse.jetty.http.CookieCompliance\" name=\"valueOf\"><Arg><Property name=\"jetty.httpConfig.responseCookieCompliance\" default=\"RFC6265\"/></Arg></Call></Set>\n       <Set name=\"multiPartFormDataCompliance\"><Call class=\"org.eclipse.jetty.server.MultiPartFormDataCompliance\" name=\"valueOf\"><Arg><Property name=\"jetty.httpConfig.multiPartFormDataCompliance\" default=\"RFC7578\"/></Arg></Call></Set>\n+      <Set name=\"relativeRedirectionAllowed\"><Property name=\"jetty.httpConfig.relativeRedirectionAllowed\" default=\"false\"/></Set>", "originalCommit": "2b599b21c237a5f72b98c3a687ca358571cfe42d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg0OTEzNw==", "url": "https://github.com/eclipse/jetty.project/pull/5038#discussion_r452849137", "bodyText": "In the existing releases, If the application uses ...\nresponse.sendRedirect(\"/alt/path\"); // becomes an absolute-uri\nresponse.sendRedirect(\"www.machine.com/alt/path\"); // becomes an absolute-uri by adding scheme\nresponse.sendRedirect(\"https://www.machine.com/alt/path\"); // stays an absolute-uri\nWith this change, the default is false, which preserves the behavior.\nIf they set it to true, then the following happens ...\nresponse.sendRedirect(\"/alt/path\"); // no change to whats added, it is sent as `Location: /alt/path`\nresponse.sendRedirect(\"www.machine.com/alt/path\"); // no change to whats added, it is sent as `Location: www.machine.com/alt/path`\nresponse.sendRedirect(\"https://www.machine.com/alt/path\"); // no change to whats added, it is sent as `Location: https://www.machine.com/alt/path`\nPerhaps the name should indicate that Jetty, by default, ensures that the Location header is an absolute-uri, but if we change this configuration, it takes the Location as-is.\nensureAbsoluteUriLocation with a default of true?", "author": "joakime", "createdAt": "2020-07-10T13:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzNTE4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg5ODc1NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5038#discussion_r454898755", "bodyText": "The behaviour is definitely an 'Allow', as it just decides if a passed relative location can be allowed to remain relative.\nIt could be inverted to an ensure (or enforce?) but then isEnsureAbsoluteUriLocation is both a mouthful and doesn't scan.\nAfter chatting  to @sbordet online, I have renamed to relativeRedirectAllowed... but I could be pushed to allowRelativeRedirect if we can stomach isAllowRelativeRedirect ?", "author": "gregw", "createdAt": "2020-07-15T08:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzNTE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzNjI3Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5038#discussion_r452836272", "bodyText": "Is the Servlet specification mandating absolute redirects? Just to be sure that we actually can.", "author": "sbordet", "createdAt": "2020-07-10T13:16:43Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -506,7 +506,9 @@ public void sendRedirect(int code, String location) throws IOException\n \n         if (!URIUtil.hasScheme(location))\n         {\n-            StringBuilder buf = _channel.getRequest().getRootURL();\n+            StringBuilder buf = _channel.getHttpConfiguration().isRelativeRedirectionAllowed()\n+                ? new StringBuilder()\n+                : _channel.getRequest().getRootURL();", "originalCommit": "2b599b21c237a5f72b98c3a687ca358571cfe42d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg5OTIwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5038#discussion_r454899209", "bodyText": "probably, but it was written before RFC7230 and we do absolute by default.  Happy to bend the rules if users configure it to do so.", "author": "gregw", "createdAt": "2020-07-15T08:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzNjI3Mg=="}], "type": "inlineReview"}, {"oid": "4a91f2853c27726aa5d7998db670bd23e0168f77", "url": "https://github.com/eclipse/jetty.project/commit/4a91f2853c27726aa5d7998db670bd23e0168f77", "message": "rename from review", "committedDate": "2020-07-15T08:51:44Z", "type": "commit"}]}