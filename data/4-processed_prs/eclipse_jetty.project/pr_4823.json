{"pr_number": 4823, "pr_title": "Issue #4798 - Recover from Selector Failures", "pr_createdAt": "2020-04-27T21:20:41Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4823", "timeline": [{"oid": "46ad90598c65d127124395db32172f381579a825", "url": "https://github.com/eclipse/jetty.project/commit/46ad90598c65d127124395db32172f381579a825", "message": "Code cleanups.", "committedDate": "2020-04-27T20:57:57Z", "type": "commit"}, {"oid": "952a20f81cabdc046832cb8c519151f148206bbe", "url": "https://github.com/eclipse/jetty.project/commit/952a20f81cabdc046832cb8c519151f148206bbe", "message": "Issue #4798 - Better handling of fatal Selector failures.\n\nImplemented selector recovery by transferring\nall keys to a newly created selector.\n\nUpdated code so that it does not assume that the\nSelectionKey never changes.", "committedDate": "2020-04-27T21:19:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NTg5OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416695899", "bodyText": "Both implementations of this method don't use the oldKey parameter. Use it or drop it?", "author": "lorban", "createdAt": "2020-04-28T15:13:35Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ManagedSelector.java", "diffHunk": "@@ -378,14 +473,25 @@ public String toString()\n          * detected by the {@link ManagedSelector} for this endpoint.\n          *\n          * @return a job that may block or null\n+         * @param key the selected SelectionKey\n          */\n-        Runnable onSelected();\n+        Runnable onSelected(SelectionKey key);\n \n         /**\n          * Callback method invoked when all the keys selected by the\n          * {@link ManagedSelector} for this endpoint have been processed.\n+         * @param key the SelectionKey to update\n+         */\n+        void updateKey(SelectionKey key);\n+\n+        /**\n+         * Callback method invoked when a selectable is transferred\n+         * from one selector to a new selector.\n+         *\n+         * @param oldKey the old SelectionKey\n+         * @param newKey the new SelectionKey\n          */\n-        void updateKey();\n+        void replaceKey(SelectionKey oldKey, SelectionKey newKey);", "originalCommit": "952a20f81cabdc046832cb8c519151f148206bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcwNjA2Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416706066", "bodyText": "I think it is strange to have both replaceKey and to pass in the key to onSelected etc.\nIf you are passing in the key for the main usages, then findKey is probably OK for the remaining cases.\nSo get rid of one mechanism or the other.", "author": "gregw", "createdAt": "2020-04-28T15:26:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NTg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NzA4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416697089", "bodyText": "This class does very little more than ChannelEndPoint Shouldn't the two be merged?", "author": "lorban", "createdAt": "2020-04-28T15:15:05Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/SocketChannelEndPoint.java", "diffHunk": "@@ -18,24 +18,15 @@\n \n package org.eclipse.jetty.io;\n \n-import java.io.IOException;\n-import java.net.InetSocketAddress;\n import java.net.Socket;\n import java.nio.channels.SelectableChannel;\n import java.nio.channels.SelectionKey;\n import java.nio.channels.SocketChannel;\n \n-import org.eclipse.jetty.util.log.Log;\n-import org.eclipse.jetty.util.log.Logger;\n import org.eclipse.jetty.util.thread.Scheduler;\n \n public class SocketChannelEndPoint extends ChannelEndPoint", "originalCommit": "952a20f81cabdc046832cb8c519151f148206bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE5Mjg3Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417192876", "bodyText": "ChannelEndPoint becomes SocketChannelEndPoint, and UnixEndPoint extends SocketChannelEndPoint?\nWe may want to do this in 10, not in 9.4.", "author": "sbordet", "createdAt": "2020-04-29T09:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NzA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NzQyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416697429", "bodyText": "Why disabled?", "author": "lorban", "createdAt": "2020-04-28T15:15:29Z", "path": "tests/test-http-client-transport/src/test/java/org/eclipse/jetty/http/client/AsyncIOServletTest.java", "diffHunk": "@@ -398,6 +399,7 @@ public void onError(Throwable t)\n     @ParameterizedTest\n     @ArgumentsSource(TransportProvider.class)\n     @Tag(\"Unstable\")\n+    @Disabled", "originalCommit": "952a20f81cabdc046832cb8c519151f148206bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE5MzIyMg==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417193222", "bodyText": "Because the test is unstable and fails for reasons unrelated to this change, but it was annoying that it failed randomly.", "author": "sbordet", "createdAt": "2020-04-29T09:46:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NzQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcwNjY0Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416706647", "bodyText": "compute is not really very meaningful", "author": "gregw", "createdAt": "2020-04-28T15:26:56Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ManagedSelector.java", "diffHunk": "@@ -160,22 +145,132 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    void compute(Selector selector, SelectableChannel channel, SelectionKey selectionKey, Consumer<SelectionKey> action)", "originalCommit": "952a20f81cabdc046832cb8c519151f148206bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE5Mzk2Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417193966", "bodyText": "What then? It runs the Consumer given those parameters - similar to Map.compute().", "author": "sbordet", "createdAt": "2020-04-29T09:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcwNjY0Nw=="}], "type": "inlineReview"}, {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b", "url": "https://github.com/eclipse/jetty.project/commit/8c75eeccce81b158c2513ec29f6d6f644735568b", "message": "Issue #4798 - Better handling of fatal Selector failures.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-04-29T09:57:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzOTE5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417239191", "bodyText": "you may as well return the key here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    _selector.runKeyAction(selector, _channel, _key, this::updateKey);\n          \n          \n            \n                    _key = _selector.runKeyAction(selector, _channel, _key, this::updateKey);", "author": "gregw", "createdAt": "2020-04-29T11:17:21Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -357,12 +353,16 @@ public Runnable onSelected()\n         return task;\n     }\n \n+    private void updateKey(Selector selector)\n+    {\n+        _selector.runKeyAction(selector, _channel, _key, this::updateKey);", "originalCommit": "8c75eeccce81b158c2513ec29f6d6f644735568b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5NzI1MA==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417297250", "bodyText": "I don't think it's a good idea to return the key, since it's the Consumer that is supposed to act on the key so there is no point returning it to the caller.", "author": "sbordet", "createdAt": "2020-04-29T13:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzOTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNjExOA==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417416118", "bodyText": "let's get rid of the _key field (as above)", "author": "gregw", "createdAt": "2020-04-29T15:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzOTE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MDE3Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417240173", "bodyText": "This is not used in updateKey(Selector selector)  or is it the other update key?   Eitherway, it is confusing, can we change one of the method names?", "author": "gregw", "createdAt": "2020-04-29T11:19:19Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -94,14 +88,7 @@ public void close()\n         }\n     }\n \n-    private final ManagedSelector.SelectorUpdate _updateKeyAction = new ManagedSelector.SelectorUpdate()\n-    {\n-        @Override\n-        public void update(Selector selector)\n-        {\n-            updateKey();\n-        }\n-    };\n+    private final ManagedSelector.SelectorUpdate _updateKeyAction = this::updateKey;", "originalCommit": "8c75eeccce81b158c2513ec29f6d6f644735568b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5NTAyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417295029", "bodyText": "I don't understand what's confusing? Like before the inner class was calling Selectable.updateKey(), now the method reference is eventually calling Selectable.updateKey() - so it's the same stuff and it's the same task of updating the key.", "author": "sbordet", "createdAt": "2020-04-29T13:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MDE3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxMTg2MA==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417411860", "bodyText": "there are two methods both called updateKey, both are used as method lambdas where you can't see the args without looking elsewhere.  One is set here as a field, the other is passed much later on.    Sorry, it is just confusing and even when I've worked it out, I keep getting reconfused.   Rename one of the methods.", "author": "gregw", "createdAt": "2020-04-29T15:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MDE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MjUyNw==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417242527", "bodyText": "maybe call this one updateKeyAction", "author": "gregw", "createdAt": "2020-04-29T11:24:06Z", "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -357,12 +353,16 @@ public Runnable onSelected()\n         return task;\n     }\n \n+    private void updateKey(Selector selector)", "originalCommit": "8c75eeccce81b158c2513ec29f6d6f644735568b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5NzAyNA==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417297024", "bodyText": "Not sure I agree. This method updates the key, it's not the action. The field is called _updateKeyAction because it's the action that it is submitted to the selector.", "author": "sbordet", "createdAt": "2020-04-29T13:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MjUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNTg2Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417415863", "bodyText": "So the updateKeyAction method is submitted to the selector, which calls us back here and then we call compute on the selector because our _key might be out of date....  All to avoid an array deref in keyFor  !!! I think we are getting too tricky.\nThe other callback pass the key, so we can just use it.  This callback passes the selector, so let's use use keyFor here and get rid of _key field.", "author": "gregw", "createdAt": "2020-04-29T15:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MjUyNw=="}], "type": "inlineReview"}, {"oid": "0a028b663bf8cce5569e3876d6089e2550b35e2e", "url": "https://github.com/eclipse/jetty.project/commit/0a028b663bf8cce5569e3876d6089e2550b35e2e", "message": "Issue #4798 - Better handling of fatal Selector failures.\n\nMore updates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-04-30T08:55:29Z", "type": "commit"}]}