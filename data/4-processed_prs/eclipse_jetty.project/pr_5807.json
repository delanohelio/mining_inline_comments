{"pr_number": 5807, "pr_title": "Cleanup of charset usage in Response", "pr_createdAt": "2020-12-14T04:09:08Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5807", "timeline": [{"oid": "5490b3add4d8e896f365e9922fa70883944d825e", "url": "https://github.com/eclipse/jetty.project/commit/5490b3add4d8e896f365e9922fa70883944d825e", "message": "Issue #5757 - improve javadoc around inferred and assumed charsets\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-07T22:32:26Z", "type": "commit"}, {"oid": "f5fab09498f7c9f4af7deb0ba57389657df85e0c", "url": "https://github.com/eclipse/jetty.project/commit/f5fab09498f7c9f4af7deb0ba57389657df85e0c", "message": "Issue #5757 - cleanup logic around character encoding in Response\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-09T04:25:46Z", "type": "commit"}, {"oid": "908acd59046d9d72e236870aa513a9f5e946b445", "url": "https://github.com/eclipse/jetty.project/commit/908acd59046d9d72e236870aa513a9f5e946b445", "message": "The default iso-8859-1 encoding should be set in the Content-Type.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-14T06:22:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwMTAzMA==", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542201030", "bodyText": "is that the only mechanism to get an inferred type?\nI think it would be best just to say that  the charset is inferred from the content-type and will be added as a parameter to the content-type", "author": "gregw", "createdAt": "2020-12-14T08:38:48Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -103,11 +103,35 @@\n \n     private enum EncodingFrom\n     {\n-        NOT_SET, INFERRED, SET_LOCALE, SET_CONTENT_TYPE, SET_CHARACTER_ENCODING\n+        /**\n+         * Character encoding was not set, or the encoding was cleared with {@code setCharacterEncoding(null)}.\n+         */\n+        NOT_SET,\n+\n+        /**\n+         * Character encoding was not explicitly set but has a default value defined by the {@code encoding.properties} file.\n+         * @see MimeTypes#getInferredEncodings().\n+         */", "originalCommit": "908acd59046d9d72e236870aa513a9f5e946b445", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwMTYxMw==", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542201613", "bodyText": "No, because content-type has already been set, hence we have a mimeType.   We don't need to add the charset as Assumed charsets are never added to the content-type - by definition of what assumed is (otherwise they are inferred).", "author": "gregw", "createdAt": "2020-12-14T08:39:50Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.\n+     * @return the character encoding for this response.\n+     */\n+    private String getCharacterEncoding(boolean setContentType)\n+    {\n+        // First try explicit char encoding.\n+        if (_characterEncoding != null)\n+            return _characterEncoding;\n+\n+        String encoding;\n+\n+        // Try charset from mime type. TODO: should this be added to Content-Type header?", "originalCommit": "908acd59046d9d72e236870aa513a9f5e946b445", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNTMwNw==", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542205307", "bodyText": "probably should mention it only sets inferred and default", "author": "gregw", "createdAt": "2020-12-14T08:45:42Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.", "originalCommit": "908acd59046d9d72e236870aa513a9f5e946b445", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNzMxMg==", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542207312", "bodyText": "Yes - if not set here will never be set", "author": "gregw", "createdAt": "2020-12-14T08:48:44Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.\n+     * @return the character encoding for this response.\n+     */\n+    private String getCharacterEncoding(boolean setContentType)\n+    {\n+        // First try explicit char encoding.\n+        if (_characterEncoding != null)\n+            return _characterEncoding;\n+\n+        String encoding;\n+\n+        // Try charset from mime type. TODO: should this be added to Content-Type header?\n+        if (_mimeType != null && _mimeType.isCharsetAssumed())\n+            return _mimeType.getCharsetString();\n+\n+        // Try charset assumed from content type (assumed charsets are not added to content type header).\n+        encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n+        if (encoding != null)\n+            return encoding;\n+\n+        // Try char set inferred from content type.\n+        encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        if (encoding != null)\n         {\n-            String encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n-            if (encoding != null)\n-                return encoding;\n+            if (setContentType)\n+                setCharacterEncoding(encoding, EncodingFrom.INFERRED);\n+            return encoding;\n+        }\n \n-            encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        // Try any default char encoding for the context. TODO: should this be added to Content-Type header?", "originalCommit": "908acd59046d9d72e236870aa513a9f5e946b445", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNzYwOA==", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542207608", "bodyText": "Not really INFERRED - maybe need a DEFAULT?", "author": "gregw", "createdAt": "2020-12-14T08:49:13Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.\n+     * @return the character encoding for this response.\n+     */\n+    private String getCharacterEncoding(boolean setContentType)\n+    {\n+        // First try explicit char encoding.\n+        if (_characterEncoding != null)\n+            return _characterEncoding;\n+\n+        String encoding;\n+\n+        // Try charset from mime type. TODO: should this be added to Content-Type header?\n+        if (_mimeType != null && _mimeType.isCharsetAssumed())\n+            return _mimeType.getCharsetString();\n+\n+        // Try charset assumed from content type (assumed charsets are not added to content type header).\n+        encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n+        if (encoding != null)\n+            return encoding;\n+\n+        // Try char set inferred from content type.\n+        encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        if (encoding != null)\n         {\n-            String encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n-            if (encoding != null)\n-                return encoding;\n+            if (setContentType)\n+                setCharacterEncoding(encoding, EncodingFrom.INFERRED);\n+            return encoding;\n+        }\n \n-            encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        // Try any default char encoding for the context. TODO: should this be added to Content-Type header?\n+        Context context = _channel.getRequest().getContext();\n+        if (context != null)\n+        {\n+            encoding = context.getResponseCharacterEncoding();\n             if (encoding != null)\n                 return encoding;\n-\n-            Context context = _channel.getRequest().getContext();\n-            if (context != null)\n-            {\n-                encoding = context.getResponseCharacterEncoding();\n-                if (encoding != null)\n-                    return encoding;\n-            }\n-            return StringUtil.__ISO_8859_1;\n         }\n-        return _characterEncoding;\n+\n+        // Fallback to last resort iso-8859-1.\n+        encoding = StringUtil.__ISO_8859_1;\n+        if (setContentType)\n+            setCharacterEncoding(encoding, EncodingFrom.INFERRED);", "originalCommit": "908acd59046d9d72e236870aa513a9f5e946b445", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b13fb8ad1e7ca96e7f6594e4c12099315b0e90de", "url": "https://github.com/eclipse/jetty.project/commit/b13fb8ad1e7ca96e7f6594e4c12099315b0e90de", "message": "Resolve TODOs and other changes from review.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-15T01:21:47Z", "type": "commit"}, {"oid": "88a838fb176eb749764dc897c4f466d648b30d9d", "url": "https://github.com/eclipse/jetty.project/commit/88a838fb176eb749764dc897c4f466d648b30d9d", "message": "Introduce extra enum state for DEFAULT encoding.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-15T02:40:22Z", "type": "commit"}, {"oid": "88a838fb176eb749764dc897c4f466d648b30d9d", "url": "https://github.com/eclipse/jetty.project/commit/88a838fb176eb749764dc897c4f466d648b30d9d", "message": "Introduce extra enum state for DEFAULT encoding.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-12-15T02:40:22Z", "type": "forcePushed"}]}