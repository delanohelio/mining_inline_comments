{"pr_number": 4844, "pr_title": "proxy v2 skip address length bytes when LOCAL command is specified", "pr_createdAt": "2020-05-04T15:47:25Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4844", "timeline": [{"oid": "e857957aa4936b2a1761e7c60785f303df90dda6", "url": "https://github.com/eclipse/jetty.project/commit/e857957aa4936b2a1761e7c60785f303df90dda6", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-05T08:48:06Z", "type": "forcePushed"}, {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd", "url": "https://github.com/eclipse/jetty.project/commit/70f873904a7ad3cd0438e5e514e86042eef866dd", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-05T08:49:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyMzU0Mg==", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420023542", "bodyText": "I don't think this is correct.\nBy this point, the buffer is guaranteed to have at least _length bytes in it, so Math.min() is not necessary.\nFurthermore, I think it's wrong for LOCAL to upgrade the connection (it happens few lines below) - it was probably wrong before too.\nI don't know exactly what needs to be done when receiving a LOCAL command though - perhaps just read and discard until -1. Let's discuss this.", "author": "sbordet", "createdAt": "2020-05-05T10:56:04Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ProxyConnectionFactory.java", "diffHunk": "@@ -662,6 +662,10 @@ private void parseBodyAndUpgrade() throws IOException\n                     if (LOG.isDebugEnabled())\n                         LOG.debug(\"Proxy v2 {} {}\", getEndPoint(), proxyEndPoint.toString());\n                 }\n+                else\n+                {\n+                    _buffer.position(_buffer.position() + Math.min(_buffer.remaining(), _length));", "originalCommit": "70f873904a7ad3cd0438e5e514e86042eef866dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA1MTA4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420051089", "bodyText": "Regarding upgrading: as discussed; the connection should be upgraded and handled normally even when the command is LOCAL.\nRegarding Math.min(), you're right that it's not needed as the buffer is guaranteed to contain at least _length bytes at that point. So I'll remove it.", "author": "lorban", "createdAt": "2020-05-05T11:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyMzU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNDc0MA==", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420024740", "bodyText": "I'm not sure you should get back a 200 OK response for a LOCAL command.", "author": "sbordet", "createdAt": "2020-05-05T10:58:32Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyConnectionTest.java", "diffHunk": "@@ -151,6 +151,39 @@ public void testIPv6V2(RequestProcessor p) throws Exception\n         assertThat(response, Matchers.containsString(\"remote=ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff:12345\"));\n     }\n \n+    @ParameterizedTest\n+    @MethodSource(\"requestProcessors\")\n+    public void testLocalV2(RequestProcessor p) throws Exception\n+    {\n+        String proxy =\n+            // Preamble\n+            \"0D0A0D0A000D0A515549540A\" +\n+\n+                // V2, LOCAL\n+                \"20\" +\n+\n+                // 0x1 : AF_INET    0x1 : STREAM.\n+                \"11\" +\n+\n+                // Address length is 16.\n+                \"0010\" +\n+\n+                // gibberish\n+                \"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF\"\n+            ;\n+        String http = \"GET /path HTTP/1.1\\n\" +\n+            \"Host: server:80\\n\" +\n+            \"Connection: close\\n\" +\n+            \"\\n\";\n+\n+        String response = p.sendRequestWaitingForResponse(TypeUtil.fromHexString(proxy), http.getBytes(StandardCharsets.US_ASCII));", "originalCommit": "70f873904a7ad3cd0438e5e514e86042eef866dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0ODMxMw==", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420048313", "bodyText": "As discussed; the connection should be upgraded and handled normally even when the command is LOCAL.", "author": "lorban", "createdAt": "2020-05-05T11:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNDc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNTE0MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420025141", "bodyText": "I'm not sure a LOCAL command should reply to HTTP requests.", "author": "sbordet", "createdAt": "2020-05-05T10:59:22Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyProtocolTest.java", "diffHunk": "@@ -193,4 +193,81 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n             }\n         }\n     }\n+\n+    @Test\n+    public void testProxyProtocolV2Local() throws Exception\n+    {\n+        start(new AbstractHandler()\n+        {\n+            @Override\n+            public void handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException\n+            {\n+                baseRequest.setHandled(true);\n+            }\n+        });\n+\n+        try (Socket socket = new Socket(\"localhost\", connector.getLocalPort()))\n+        {\n+            String proxy =\n+                // Preamble\n+                \"0D0A0D0A000D0A515549540A\" +\n+\n+                    // V2, LOCAL\n+                    \"20\" +\n+\n+                    // 0x1 : AF_INET    0x1 : STREAM.  Address length is 2*4 + 2*2 = 12 bytes.\n+                    \"11\" +\n+\n+                    // length of remaining header (4+4+2+2+6+3 = 21)\n+                    \"0015\" +\n+\n+                    // uint32_t src_addr; uint32_t dst_addr; uint16_t src_port; uint16_t dst_port;\n+                    \"C0A80001\" +\n+                    \"7f000001\" +\n+                    \"3039\" +\n+                    \"1F90\" +\n+\n+                    // NOOP value 0\n+                    \"040000\" +\n+\n+                    // NOOP value ABCDEF\n+                    \"040003ABCDEF\";\n+\n+            String request1 =\n+                \"GET /1 HTTP/1.1\\r\\n\" +\n+                    \"Host: localhost\\r\\n\" +\n+                    \"\\r\\n\";\n+            OutputStream output = socket.getOutputStream();\n+            output.write(TypeUtil.fromHexString(proxy));\n+            output.write(request1.getBytes(StandardCharsets.UTF_8));\n+            output.flush();\n+\n+            InputStream input = socket.getInputStream();\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(input, StandardCharsets.UTF_8));\n+            String response1 = reader.readLine();\n+            assertTrue(response1.startsWith(\"HTTP/1.1 200 \"));\n+            while (true)\n+            {\n+                if (reader.readLine().isEmpty())\n+                    break;\n+            }", "originalCommit": "70f873904a7ad3cd0438e5e514e86042eef866dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d34cb2598b4199d01a67eba37c800910ac4e409d", "url": "https://github.com/eclipse/jetty.project/commit/d34cb2598b4199d01a67eba37c800910ac4e409d", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-05T11:51:30Z", "type": "commit"}, {"oid": "d34cb2598b4199d01a67eba37c800910ac4e409d", "url": "https://github.com/eclipse/jetty.project/commit/d34cb2598b4199d01a67eba37c800910ac4e409d", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-05T11:51:30Z", "type": "forcePushed"}]}