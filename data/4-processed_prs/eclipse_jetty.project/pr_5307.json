{"pr_number": 5307, "pr_title": "Issue #5304 HTTP2 HostHeader", "pr_createdAt": "2020-09-21T19:15:32Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5307", "timeline": [{"oid": "256c6692dd083ff605065e1abedcccdea8c68e71", "url": "https://github.com/eclipse/jetty.project/commit/256c6692dd083ff605065e1abedcccdea8c68e71", "message": "Issue #5304 HTTP2 HostHeader\n\nUpdated HostHeaderCustomizer to actually add the Host header, either from values passed in the custructor or from the getServerName and getServerPort methods.\n\nThe HttpURI is no longer updated.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-09-21T19:14:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyMDM2NA==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492320364", "bodyText": "Some javadoc here saying this usage will result in using the serverName/serverPort from the Request?", "author": "joakime", "createdAt": "2020-09-21T20:15:22Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -19,30 +19,30 @@\n package org.eclipse.jetty.server;\n \n import java.util.Objects;\n-import javax.servlet.http.HttpServletRequest;\n \n-import org.eclipse.jetty.http.HttpURI;\n+import org.eclipse.jetty.http.HostPortHttpField;\n+import org.eclipse.jetty.http.HttpFields;\n+import org.eclipse.jetty.http.HttpHeader;\n+import org.eclipse.jetty.http.HttpScheme;\n+import org.eclipse.jetty.http.HttpVersion;\n \n /**\n- * Customizes requests that lack the {@code Host} header (for example, HTTP 1.0 requests).\n+ * Adds a missing {@code Host} header (for example, HTTP 1.0 or 2.0 requests).\n  * <p>\n- * In case of HTTP 1.0 requests that lack the {@code Host} header, the application may issue\n- * a redirect, and the {@code Location} header is usually constructed from the {@code Host}\n- * header; if the {@code Host} header is missing, the server may query the connector for its\n- * IP address in order to construct the {@code Location} header, and thus leak to clients\n- * internal IP addresses.\n- * <p>\n- * This {@link HttpConfiguration.Customizer} is configured with a {@code serverName} and\n- * optionally a {@code serverPort}.\n- * If the {@code Host} header is absent, the configured {@code serverName} will be set on\n- * the request so that {@link HttpServletRequest#getServerName()} will return that value,\n- * and likewise for {@code serverPort} and {@link HttpServletRequest#getServerPort()}.\n+ * The host and port may be provided in the constructor or taken from the\n+ * {@link Request#getServerName()} and {@link Request#getServerPort()} methods.\n+ * </p>\n  */\n public class HostHeaderCustomizer implements HttpConfiguration.Customizer\n {\n     private final String serverName;\n     private final int serverPort;\n \n+    public HostHeaderCustomizer()", "originalCommit": "256c6692dd083ff605065e1abedcccdea8c68e71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyMDY1MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492320651", "bodyText": "This forwards to this(String, int) which requires that serverName is not null.", "author": "joakime", "createdAt": "2020-09-21T20:15:56Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -19,30 +19,30 @@\n package org.eclipse.jetty.server;\n \n import java.util.Objects;\n-import javax.servlet.http.HttpServletRequest;\n \n-import org.eclipse.jetty.http.HttpURI;\n+import org.eclipse.jetty.http.HostPortHttpField;\n+import org.eclipse.jetty.http.HttpFields;\n+import org.eclipse.jetty.http.HttpHeader;\n+import org.eclipse.jetty.http.HttpScheme;\n+import org.eclipse.jetty.http.HttpVersion;\n \n /**\n- * Customizes requests that lack the {@code Host} header (for example, HTTP 1.0 requests).\n+ * Adds a missing {@code Host} header (for example, HTTP 1.0 or 2.0 requests).\n  * <p>\n- * In case of HTTP 1.0 requests that lack the {@code Host} header, the application may issue\n- * a redirect, and the {@code Location} header is usually constructed from the {@code Host}\n- * header; if the {@code Host} header is missing, the server may query the connector for its\n- * IP address in order to construct the {@code Location} header, and thus leak to clients\n- * internal IP addresses.\n- * <p>\n- * This {@link HttpConfiguration.Customizer} is configured with a {@code serverName} and\n- * optionally a {@code serverPort}.\n- * If the {@code Host} header is absent, the configured {@code serverName} will be set on\n- * the request so that {@link HttpServletRequest#getServerName()} will return that value,\n- * and likewise for {@code serverPort} and {@link HttpServletRequest#getServerPort()}.\n+ * The host and port may be provided in the constructor or taken from the\n+ * {@link Request#getServerName()} and {@link Request#getServerPort()} methods.\n+ * </p>\n  */\n public class HostHeaderCustomizer implements HttpConfiguration.Customizer\n {\n     private final String serverName;\n     private final int serverPort;\n \n+    public HostHeaderCustomizer()\n+    {\n+        this(null, 0);", "originalCommit": "256c6692dd083ff605065e1abedcccdea8c68e71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "38e694995ca4d76640ef0ee7f8265b9bac86843f", "url": "https://github.com/eclipse/jetty.project/commit/38e694995ca4d76640ef0ee7f8265b9bac86843f", "message": "Issue #5304 HTTP2 HostHeader\n\n + Found and fixed bug in HttpFields\n + Added port normalization support to HttpScheme\n + added test\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-09-22T09:18:51Z", "type": "commit"}, {"oid": "2b25630b1fa18edeecfe61726053a654a586cec7", "url": "https://github.com/eclipse/jetty.project/commit/2b25630b1fa18edeecfe61726053a654a586cec7", "message": "blank line\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-09-22T09:19:50Z", "type": "commit"}, {"oid": "78988713b3ab4c721b155d26558e6fda68365954", "url": "https://github.com/eclipse/jetty.project/commit/78988713b3ab4c721b155d26558e6fda68365954", "message": "Issue #5304 HTTP2 HostHeader\n\n + refixed bug in HttpFields\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-09-22T10:12:38Z", "type": "commit"}, {"oid": "4e93b84ce23341d6e68e360c89e52a39dca006c5", "url": "https://github.com/eclipse/jetty.project/commit/4e93b84ce23341d6e68e360c89e52a39dca006c5", "message": "Issue #5304 HTTP2 HostHeader\n\n + still fixing HttpFields bug\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-09-22T11:43:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MTUwNg==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492681506", "bodyText": "Don't you want to setHttpURI() if the port is normalized in a way that's different then serverPort too?", "author": "joakime", "createdAt": "2020-09-22T12:09:36Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -57,15 +60,26 @@ public HostHeaderCustomizer(String serverName)\n      */\n     public HostHeaderCustomizer(String serverName, int serverPort)\n     {\n-        this.serverName = Objects.requireNonNull(serverName);\n+        this.serverName = serverName;\n         this.serverPort = serverPort;\n     }\n \n     @Override\n     public void customize(Connector connector, HttpConfiguration channelConfig, Request request)\n     {\n-        if (request.getHeader(\"Host\") == null)\n-            // TODO set the field as well?\n-            request.setHttpURI(HttpURI.build(request.getHttpURI()).host(serverName).port(serverPort));\n+        if (request.getHttpVersion() != HttpVersion.HTTP_1_1 && !request.getHttpFields().contains(HttpHeader.HOST))\n+        {\n+            String host = serverName == null ? request.getServerName() : serverName;\n+            int port = HttpScheme.normalizePort(request.getScheme(), serverPort == 0 ? request.getServerPort() : serverPort);\n+\n+            if (serverName != null || serverPort > 0)", "originalCommit": "4e93b84ce23341d6e68e360c89e52a39dca006c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNzA1Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492717056", "bodyText": "My thinking here is that if the serverPort is set, then we will set the port, but will used the normalised version of it.\nSo if they set port 80, but the real port was 8888 we would set the port to 0 not 80", "author": "gregw", "createdAt": "2020-09-22T13:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MTUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MzkwMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492683901", "bodyText": "This looks odd, why is this not httpFields.addAll(request.getHttpFields()); ?\nAlso, doesn't this change the request.getHttpFields() to now be Mutable?\nWhat if this was ...\nHttpFields updated = HttpFields.build(\n   request.getHttpFields(), \n   new HostPortHttpFields(host, port));\nrequest.setHttpFields(updated);\nWhere there is a new method .build(HttpFields original, HttpField ... fields) ?", "author": "joakime", "createdAt": "2020-09-22T12:13:44Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -57,15 +60,26 @@ public HostHeaderCustomizer(String serverName)\n      */\n     public HostHeaderCustomizer(String serverName, int serverPort)\n     {\n-        this.serverName = Objects.requireNonNull(serverName);\n+        this.serverName = serverName;\n         this.serverPort = serverPort;\n     }\n \n     @Override\n     public void customize(Connector connector, HttpConfiguration channelConfig, Request request)\n     {\n-        if (request.getHeader(\"Host\") == null)\n-            // TODO set the field as well?\n-            request.setHttpURI(HttpURI.build(request.getHttpURI()).host(serverName).port(serverPort));\n+        if (request.getHttpVersion() != HttpVersion.HTTP_1_1 && !request.getHttpFields().contains(HttpHeader.HOST))\n+        {\n+            String host = serverName == null ? request.getServerName() : serverName;\n+            int port = HttpScheme.normalizePort(request.getScheme(), serverPort == 0 ? request.getServerPort() : serverPort);\n+\n+            if (serverName != null || serverPort > 0)\n+                request.setHttpURI(HttpURI.build(request.getHttpURI()).authority(host, port));\n+\n+            HttpFields original = request.getHttpFields();\n+            HttpFields.Mutable httpFields = HttpFields.build(original.size() + 1);\n+            httpFields.add(new HostPortHttpField(host, port));\n+            httpFields.add(request.getHttpFields());", "originalCommit": "4e93b84ce23341d6e68e360c89e52a39dca006c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNTk1MA==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492715950", "bodyText": "https://tools.ietf.org/html/rfc7230#section-3.2.2 says Host header should be one of the first headers sent.  I can't imagine too much depending on this, but best to follow recommendations.", "author": "gregw", "createdAt": "2020-09-22T13:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk3MzI5NA==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492973294", "bodyText": "This still changes future requests on request.getHttpFields() to be a HttpFields.Mutable, right?\nI don't think that's desired.", "author": "joakime", "createdAt": "2020-09-22T19:12:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUwNjY3Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r493506677", "bodyText": "https://github.com/eclipse/jetty.project/blob/jetty-10.0.x/jetty-server/src/main/java/org/eclipse/jetty/server/Request.java#L250-L253", "author": "gregw", "createdAt": "2020-09-23T12:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MzkwMQ=="}], "type": "inlineReview"}, {"oid": "c3b765c45f8e2405507d846feedffe6bd09b99f4", "url": "https://github.com/eclipse/jetty.project/commit/c3b765c45f8e2405507d846feedffe6bd09b99f4", "message": "Issue #5304 HTTP2 Host Header\n\nupdates from review", "committedDate": "2020-09-22T12:57:43Z", "type": "commit"}]}