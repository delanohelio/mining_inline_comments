{"pr_number": 5119, "pr_title": "Issue #1337 Use either absolute or relative multipart file location", "pr_createdAt": "2020-08-05T13:27:09Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5119", "timeline": [{"oid": "42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5", "url": "https://github.com/eclipse/jetty.project/commit/42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5", "message": "Issue #1337 Use either absolute or relative multipart file location\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-08-05T13:23:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwOTc1NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r466009755", "bodyText": "This is the only relevant part of this change.\nThe rest is just confusing.", "author": "joakime", "createdAt": "2020-08-05T21:18:01Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -535,20 +541,20 @@ protected void parse()\n         {\n             // sort out the location to which to write the files\n             if (_config.getLocation() == null)\n-                _tmpDir = _contextTmpDir;\n+                _tmpDir = _contextTmpDir.toPath();\n             else if (\"\".equals(_config.getLocation()))\n-                _tmpDir = _contextTmpDir;\n+                _tmpDir = _contextTmpDir.toPath();\n             else\n             {\n-                File f = new File(_config.getLocation());\n-                if (f.isAbsolute())\n-                    _tmpDir = f;\n+                Path location = FileSystems.getDefault().getPath(_config.getLocation());\n+                if (location.isAbsolute())\n+                    _tmpDir = location;\n                 else\n-                    _tmpDir = new File(_contextTmpDir, _config.getLocation());\n+                    _tmpDir = _contextTmpDir.toPath().resolve(location);", "originalCommit": "42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAxMjczMg==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r466012732", "bodyText": "Not sure where's the confusion. Around lines 538 in the parse() method we work out where the tmp directory is so we can write to it if we need to (eg the number of bytes received exceed the configured limit for bytes retained in memory). The location of the tmp directory can be given by the MultiPartConfigElement.location, or, if that has not been configured, I default to the context tmp dir. This code has always been there, I just changed to calculating it as a Path instead of a File.", "author": "janbartel", "createdAt": "2020-08-05T21:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwOTc1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAxODk4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r466018989", "bodyText": "To be clear, the main change is at lines 196-199 where we treat the String argument to Part.write() as either absolute or relative: previously we always treated it as relative.", "author": "janbartel", "createdAt": "2020-08-05T21:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwOTc1NQ=="}], "type": "inlineReview"}, {"oid": "00f198ffba10fb3c79042ef0a73fb0298cd27a3d", "url": "https://github.com/eclipse/jetty.project/commit/00f198ffba10fb3c79042ef0a73fb0298cd27a3d", "message": "Issue #1337 Add comments; add blank line to test\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-08-06T15:10:30Z", "type": "commit"}, {"oid": "bf410704ed0f23c5ac651571511ebba85be43c93", "url": "https://github.com/eclipse/jetty.project/commit/bf410704ed0f23c5ac651571511ebba85be43c93", "message": "Issue #1337 Some changes after review.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-08-07T12:34:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxODgyNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467018825", "bodyText": "You have the same isAbsolute check in both branches below so perhaps do that here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Path p = Path.of(fileName);\n          \n          \n            \n                        \n          \n          \n            \n                        Path p = Path.of(fileName);\n          \n          \n            \n                        p = p.isAbsolute() ? p : _tmpDir.resolve(p);", "author": "gregw", "createdAt": "2020-08-07T12:49:07Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -185,12 +186,17 @@ protected void write(byte[] bytes, int offset, int length) throws IOException\n         @Override\n         public void write(String fileName) throws IOException\n         {\n+            Path p = Path.of(fileName);\n+            ", "originalCommit": "bf410704ed0f23c5ac651571511ebba85be43c93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxOTk2OA==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467019968", "bodyText": "Note that while I know resolve also handles absolute addresses, I do kind of like seeing it explicit in this code, so you can understand it without the need to have deep knowledge of how resolve behaves.   Maybe have a comment to that effect?", "author": "gregw", "createdAt": "2020-08-07T12:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxODgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxODk1NA==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467018954", "bodyText": "move this above", "author": "gregw", "createdAt": "2020-08-07T12:49:24Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -185,12 +186,17 @@ protected void write(byte[] bytes, int offset, int length) throws IOException\n         @Override\n         public void write(String fileName) throws IOException\n         {\n+            Path p = Path.of(fileName);\n+            \n             if (_file == null)\n             {\n                 _temporary = false;\n \n                 // part data is only in the ByteArrayOutputStream and never been written to disk\n-                _file = new File(_tmpDir, fileName);\n+                if (!p.isAbsolute())\n+                    p = _tmpDir.resolve(p);", "originalCommit": "bf410704ed0f23c5ac651571511ebba85be43c93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxOTE1OA==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467019158", "bodyText": "move this absolute check to above", "author": "gregw", "createdAt": "2020-08-07T12:49:48Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -208,7 +214,7 @@ public void write(String fileName) throws IOException\n                 _temporary = false;\n \n                 Path src = _file.toPath();\n-                Path target = src.resolveSibling(fileName);\n+                Path target = (p.isAbsolute() ? p : _tmpDir.resolve(p));", "originalCommit": "bf410704ed0f23c5ac651571511ebba85be43c93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb0a289596c5033d75f781dc557df3ac4b31d6b9", "url": "https://github.com/eclipse/jetty.project/commit/bb0a289596c5033d75f781dc557df3ac4b31d6b9", "message": "Issue #1337 Update after review.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-08-07T12:59:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA0ODc3OA==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467048778", "bodyText": "Note. Path.of(String...) is new for Java 11.\nThe original technique would be Paths.get(String...)\n(Just in case you are using these techniques back in Jetty 9.4..x)", "author": "joakime", "createdAt": "2020-08-07T13:43:23Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -185,12 +186,16 @@ protected void write(byte[] bytes, int offset, int length) throws IOException\n         @Override\n         public void write(String fileName) throws IOException\n         {\n+            Path p = Path.of(fileName);", "originalCommit": "bb0a289596c5033d75f781dc557df3ac4b31d6b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTQ2MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467051461", "bodyText": "Should probably add a test in here to know if the file got deleted (or not).\nThe temp files (note, if the Part was specifically .write(String) then it's no longer a temp file) for a MultiPartFormInputStream should only exist for as long as that MultiPartFormInputStream is live. (ie: if the MPFIS is closed, then the temp files should be deleted), as there's no sane way via the API to access the temporary contents anymore.", "author": "joakime", "createdAt": "2020-08-07T13:47:44Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/MultiPartFormInputStreamTest.java", "diffHunk": "@@ -474,6 +475,77 @@ public void testPartFileNotDeleted() throws Exception\n         assertThat(tptfd.exists(), is(true));  //explicitly written file did not get removed after cleanup\n         tptfd.deleteOnExit(); //clean up test\n     }\n+    \n+    @Test\n+    public void testPartFileAbsolute() throws Exception\n+    {\n+        MultipartConfigElement config = new MultipartConfigElement(_dirname, 1024, 3072, 50);\n+        MultiPartFormInputStream mpis = new MultiPartFormInputStream(new ByteArrayInputStream(createMultipartRequestString(\"tpfa\").getBytes()),\n+            _contentType,\n+            config,\n+            _tmpDir);\n+        mpis.setDeleteOnExit(true);", "originalCommit": "bb0a289596c5033d75f781dc557df3ac4b31d6b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1Mzk3NA==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467053974", "bodyText": "This should be part of the followup PR on cleanup of behavior.", "author": "joakime", "createdAt": "2020-08-07T13:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwMDQ0Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467200442", "bodyText": "Parts that have been written only to temporary files are all deleted when a Request is completed. See https://github.com/eclipse/jetty.project/blob/jetty-10.0.x/jetty-server/src/main/java/org/eclipse/jetty/server/Request.java#L1423 and https://github.com/eclipse/jetty.project/blob/jetty-10.0.x/jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java#L333.", "author": "janbartel", "createdAt": "2020-08-07T18:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyMTI4NA==", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467221284", "bodyText": "Yeah, that seems to be more sane.  Cleanup at the end of the Request.", "author": "joakime", "createdAt": "2020-08-07T19:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTQ2MQ=="}], "type": "inlineReview"}]}