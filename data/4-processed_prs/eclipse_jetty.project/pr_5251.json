{"pr_number": 5251, "pr_title": "Issue #5247 ForwardedRequestCustomizer authority order rework", "pr_createdAt": "2020-09-09T20:22:05Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5251", "timeline": [{"oid": "f74cada660e83b66b1f5b936dd737ad4a674df0d", "url": "https://github.com/eclipse/jetty.project/commit/f74cada660e83b66b1f5b936dd737ad4a674df0d", "message": "Issue #5247 - Priority based ForwardedRequestCustomizer\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-09T19:56:33Z", "type": "commit"}, {"oid": "42803030463cb45819848904ddb5d29495e55350", "url": "https://github.com/eclipse/jetty.project/commit/42803030463cb45819848904ddb5d29495e55350", "message": "Issue #5247 - Document ForwardedRequestCustomizer authority search order\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-09T20:20:21Z", "type": "commit"}, {"oid": "ac42cbd1436f6a161ef03e1ca7f9c4a2bf686933", "url": "https://github.com/eclipse/jetty.project/commit/ac42cbd1436f6a161ef03e1ca7f9c4a2bf686933", "message": "Issue #5247 - Improve testing of ForwardedRequestCustomizer\n\n+ Merge ProxyPass tests from CheckReverseProxyHeadersTest into\n  ForwardedRequestCustomizerTest\n+ Deleted CheckReverseProxyHeadersTest.java\n+ Add more tests for ForcedHost configuration\n+ Updated ForwardedRequestCustomizer to conform to expectations\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-11T16:11:09Z", "type": "commit"}, {"oid": "a2233ce23314978f9f7d628cf4b81517e206deb5", "url": "https://github.com/eclipse/jetty.project/commit/a2233ce23314978f9f7d628cf4b81517e206deb5", "message": "Issue #5247 - Introduce ForwardedRequestCustomizer.Priority enum\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-11T16:17:31Z", "type": "commit"}, {"oid": "59b85b62883ad88f0d48e7cbeeeeefeb845f6f32", "url": "https://github.com/eclipse/jetty.project/commit/59b85b62883ad88f0d48e7cbeeeeefeb845f6f32", "message": "Issue #5247 - Updating Javadoc on ForwardedRequestCustomizer\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-11T16:58:04Z", "type": "commit"}, {"oid": "385b11dc340c2628c5e38d86bf801937cbd71533", "url": "https://github.com/eclipse/jetty.project/commit/385b11dc340c2628c5e38d86bf801937cbd71533", "message": "Issue #5247 - Disable javadoc lint in compact3 build\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-11T17:54:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk1NzgxMw==", "url": "https://github.com/eclipse/jetty.project/pull/5251#discussion_r491957813", "bodyText": "Rather than \"Priority\" I think \"Source\" is a better name for this.  Will make more sense in logging to see something like \"source=XFORWARDED_FOR\".  It also matches a lot of our webapp config stuff where we record the source, which is then used to determine the priority.", "author": "gregw", "createdAt": "2020-09-21T11:06:22Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -516,61 +644,139 @@ private boolean updateForwardedHandle(MethodHandles.Lookup lookup, String header\n         return !_handles.put(headerName, lookup.findVirtual(Forwarded.class, forwardedMethodName, type));\n     }\n \n-    private static class ForcedHostPort extends HostPort\n+    private static class MutableHostPort\n     {\n-        ForcedHostPort(String authority)\n+        public static final int UNSET = -1;\n+        public static final int IMPLIED = 0;\n+\n+        String _host;\n+        Priority _hostPriority = Priority.UNSET;\n+        int _port = UNSET;\n+        Priority _portPriority = Priority.UNSET;\n+\n+        public void setHost(String host, Priority priority)\n         {\n-            super(authority);\n+            if (priority.ordinal() > _hostPriority.ordinal())\n+            {\n+                _host = host;\n+                _hostPriority = priority;\n+            }\n         }\n-    }\n \n-    private static class PossiblyPartialHostPort extends HostPort\n-    {\n-        PossiblyPartialHostPort(String authority)\n+        public void setPort(int port, Priority priority)\n         {\n-            super(authority);\n+            if (priority.ordinal() > _portPriority.ordinal())\n+            {\n+                _port = port;\n+                _portPriority = priority;\n+            }\n         }\n \n-        protected PossiblyPartialHostPort(String host, int port)\n+        public void setHostPort(HostPort hostPort, Priority priority)\n         {\n-            super(host, port);\n+            if (priority.ordinal() > _hostPriority.ordinal())\n+            {\n+                _host = hostPort.getHost();\n+                _hostPriority = priority;\n+            }\n+\n+            int port = hostPort.getPort();\n+            // Is port supplied?\n+            if (port > 0 && priority.ordinal() > _portPriority.ordinal())\n+            {\n+                _port = hostPort.getPort();\n+                _portPriority = priority;\n+            }\n+            // Since we are Host:Port pair, the port could be unspecified\n+            // Meaning it's implied.\n+            // Make sure that we switch the tracked port from unset to implied\n+            else if (_port == UNSET)\n+            {\n+                // set port to implied (with no priority)\n+                _port = IMPLIED;\n+            }\n         }\n-    }\n \n-    private static class PortSetHostPort extends PossiblyPartialHostPort\n-    {\n-        PortSetHostPort(String host, int port)\n+        @Override\n+        public String toString()\n         {\n-            super(host, port);\n+            final StringBuilder sb = new StringBuilder(\"MutableHostPort{\");\n+            sb.append(\"host='\").append(_host).append(\"'/\").append(_hostPriority);\n+            sb.append(\", port=\").append(_port);\n+            sb.append(\"/\").append(_portPriority);\n+            sb.append('}');\n+            return sb.toString();\n         }\n     }\n \n-    private static class Rfc7239HostPort extends HostPort\n+    /**\n+     * Ordered Priority Enum.\n+     * <p>\n+     * Lowest priority first.\n+     * </p>\n+     */\n+    public enum Priority", "originalCommit": "385b11dc340c2628c5e38d86bf801937cbd71533", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2MDIwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5251#discussion_r491960209", "bodyText": "maybe:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    getAuthority().setHost(hostField.getHost(), Priority.FORWARDED);\n          \n          \n            \n                                    getAuthority().setPort(hostField.getPort(), Priority.FORWARDED);\n          \n          \n            \n                                    getAuthority().setHostPort(hostField.getHost(), hostField.getPort(), Priority.FORWARDED);", "author": "gregw", "createdAt": "2020-09-21T11:10:56Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -688,34 +861,71 @@ protected void parsedParam(StringBuffer buffer, int valueLength, int paramName,\n                 switch (name)\n                 {\n                     case \"by\":\n+                    {\n                         if (!getProxyAsAuthority())\n                             break;\n                         if (value.startsWith(\"_\") || \"unknown\".equals(value))\n                             break;\n-                        if (_host == null || !(_host instanceof Rfc7239HostPort))\n-                            _host = new Rfc7239HostPort(value);\n+                        HostPort hostField = new HostPort(value);\n+                        getAuthority().setHost(hostField.getHost(), Priority.FORWARDED);\n+                        getAuthority().setPort(hostField.getPort(), Priority.FORWARDED);", "originalCommit": "385b11dc340c2628c5e38d86bf801937cbd71533", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ebfdf8fc1b9dd4e1a580346ce7437aa64fe44b18", "url": "https://github.com/eclipse/jetty.project/commit/ebfdf8fc1b9dd4e1a580346ce7437aa64fe44b18", "message": "Issue #5247 - Updates from review by greg\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-21T15:34:28Z", "type": "commit"}]}