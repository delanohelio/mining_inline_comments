{"pr_number": 5195, "pr_title": "Issue #5185 - Add DoSFilter Listener to allow extensible behavior", "pr_createdAt": "2020-08-24T14:51:19Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5195", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMTQwMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r475711401", "bodyText": "The comment says we should fall through to throttle the request, but we are not!!   Comments should be \"break to throttle...\"", "author": "gregw", "createdAt": "2020-08-24T15:44:53Z", "path": "jetty-servlets/src/main/java/org/eclipse/jetty/servlets/DoSFilter.java", "diffHunk": "@@ -345,15 +347,15 @@ protected void doFilter(HttpServletRequest request, HttpServletResponse response\n                 case 0:\n                 {\n                     // Fall through to throttle the request.", "originalCommit": "b75fe500380cc331fbe3911ae9438bc039b0b7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNzUwMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r475737501", "bodyText": "We do fall through .. the entire switch statement into the throttling code.\nThe other switch cases (even default) return.", "author": "joakime", "createdAt": "2020-08-24T16:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMTQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0NzczNA==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r475747734", "bodyText": "fall through normally means from one case to the next.   We break the switch to get to the throttling code.\nBut this switch will change entirely if my listener suggestion works :)", "author": "gregw", "createdAt": "2020-08-24T16:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMTQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUyNjI2Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r476526263", "bodyText": "I wouldn't bother with working out a wantedAction and passing that in.\nThe default listener can be made able to see getDelayMs() and thus work out the action itself.   We should just delegate policy, not delegate a policy override.", "author": "gregw", "createdAt": "2020-08-25T15:11:48Z", "path": "jetty-servlets/src/main/java/org/eclipse/jetty/servlets/DoSFilter.java", "diffHunk": "@@ -305,67 +307,80 @@ protected void doFilter(HttpServletRequest request, HttpServletResponse response\n \n         // Look for the rate tracker for this request.\n         RateTracker tracker = (RateTracker)request.getAttribute(__TRACKER);\n-        if (tracker == null)\n+        if (tracker != null)\n+        {\n+            // Redispatched, RateTracker present in request attributes.\n+            throttleRequest(request, response, filterChain, tracker);\n+            return;\n+        }\n+\n+        // This is the first time we have seen this request.\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"Filtering {}\", request);\n+\n+        // Get a rate tracker associated with this request, and record one hit.\n+        tracker = getRateTracker(request);\n+\n+        // Calculate the rate and check if it is over the allowed limit\n+        final boolean overRateLimit = tracker.isRateExceeded(System.currentTimeMillis());\n+\n+        // Pass it through if we are not currently over the rate limit.\n+        if (!overRateLimit)\n         {\n-            // This is the first time we have seen this request.\n             if (LOG.isDebugEnabled())\n-                LOG.debug(\"Filtering {}\", request);\n+                LOG.debug(\"Allowing {}\", request);\n+            doFilterChain(filterChain, request, response);\n+            return;\n+        }\n \n-            // Get a rate tracker associated with this request, and record one hit.\n-            tracker = getRateTracker(request);\n+        // We are over the limit.\n \n-            // Calculate the rate and check if it is over the allowed limit\n-            final boolean overRateLimit = tracker.isRateExceeded(System.currentTimeMillis());\n+        // So either reject it, delay it or throttle it.\n+        long delayMs = getDelayMs();\n+        Action wantedAction;", "originalCommit": "aa59124ac359790d9cd5c6b76ac050b00eb92b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUyNzU3Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r476527576", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        case REJECT:\n          \n          \n            \n                        case ABORT\n          \n          \n            \n                            response.sendError(-1); // causes an abort\n          \n          \n            \n                            break;\n          \n          \n            \n                            \n          \n          \n            \n                        case REJECT:", "author": "gregw", "createdAt": "2020-08-25T15:13:39Z", "path": "jetty-servlets/src/main/java/org/eclipse/jetty/servlets/DoSFilter.java", "diffHunk": "@@ -305,67 +307,80 @@ protected void doFilter(HttpServletRequest request, HttpServletResponse response\n \n         // Look for the rate tracker for this request.\n         RateTracker tracker = (RateTracker)request.getAttribute(__TRACKER);\n-        if (tracker == null)\n+        if (tracker != null)\n+        {\n+            // Redispatched, RateTracker present in request attributes.\n+            throttleRequest(request, response, filterChain, tracker);\n+            return;\n+        }\n+\n+        // This is the first time we have seen this request.\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"Filtering {}\", request);\n+\n+        // Get a rate tracker associated with this request, and record one hit.\n+        tracker = getRateTracker(request);\n+\n+        // Calculate the rate and check if it is over the allowed limit\n+        final boolean overRateLimit = tracker.isRateExceeded(System.currentTimeMillis());\n+\n+        // Pass it through if we are not currently over the rate limit.\n+        if (!overRateLimit)\n         {\n-            // This is the first time we have seen this request.\n             if (LOG.isDebugEnabled())\n-                LOG.debug(\"Filtering {}\", request);\n+                LOG.debug(\"Allowing {}\", request);\n+            doFilterChain(filterChain, request, response);\n+            return;\n+        }\n \n-            // Get a rate tracker associated with this request, and record one hit.\n-            tracker = getRateTracker(request);\n+        // We are over the limit.\n \n-            // Calculate the rate and check if it is over the allowed limit\n-            final boolean overRateLimit = tracker.isRateExceeded(System.currentTimeMillis());\n+        // So either reject it, delay it or throttle it.\n+        long delayMs = getDelayMs();\n+        Action wantedAction;\n+        if (delayMs == -1)\n+            wantedAction = Action.REJECT;\n+        else if (delayMs == 0)\n+            wantedAction = Action.THROTTLE;\n+        else\n+            wantedAction = Action.DELAY;\n \n-            // Pass it through if we are not currently over the rate limit.\n-            if (!overRateLimit)\n-            {\n+        // Ask listener what to perform.\n+        Action action = _listener.onRequestOverLimit(wantedAction, request, this);\n+\n+        // Perform action\n+        boolean insertHeaders = isInsertHeaders();\n+        switch (action)\n+        {\n+            case NO_ACTION:\n                 if (LOG.isDebugEnabled())\n-                    LOG.debug(\"Allowing {}\", request);\n+                    LOG.debug(\"Allowing over-limit request {}\", request);\n                 doFilterChain(filterChain, request, response);\n-                return;\n-            }\n-\n-            // We are over the limit.\n-\n-            // So either reject it, delay it or throttle it.\n-            long delayMs = getDelayMs();\n-            boolean insertHeaders = isInsertHeaders();\n-            switch ((int)delayMs)\n-            {\n-                case -1:\n-                {\n-                    // Reject this request.\n-                    LOG.warn(\"DOS ALERT: Request rejected ip={}, session={}, user={}\", request.getRemoteAddr(), request.getRequestedSessionId(), request.getUserPrincipal());\n-                    if (insertHeaders)\n-                        response.addHeader(\"DoSFilter\", \"unavailable\");\n-                    response.sendError(getTooManyCode());\n-                    return;\n-                }\n-                case 0:\n-                {\n-                    // Fall through to throttle the request.\n-                    LOG.warn(\"DOS ALERT: Request throttled ip={}, session={}, user={}\", request.getRemoteAddr(), request.getRequestedSessionId(), request.getUserPrincipal());\n-                    request.setAttribute(__TRACKER, tracker);\n-                    break;\n-                }\n-                default:\n-                {\n-                    // Insert a delay before throttling the request,\n-                    // using the suspend+timeout mechanism of AsyncContext.\n-                    LOG.warn(\"DOS ALERT: Request delayed={}ms, ip={}, session={}, user={}\", delayMs, request.getRemoteAddr(), request.getRequestedSessionId(), request.getUserPrincipal());\n-                    if (insertHeaders)\n-                        response.addHeader(\"DoSFilter\", \"delayed\");\n-                    request.setAttribute(__TRACKER, tracker);\n-                    AsyncContext asyncContext = request.startAsync();\n-                    if (delayMs > 0)\n-                        asyncContext.setTimeout(delayMs);\n-                    asyncContext.addListener(new DoSTimeoutAsyncListener());\n-                    return;\n-                }\n-            }\n+                break;\n+            case REJECT:", "originalCommit": "aa59124ac359790d9cd5c6b76ac050b00eb92b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUyODcxNA==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r476528714", "bodyText": "I still think we should add ABORT.... maybe even a DELAY_THEN_ABORT action.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    NO_ACTION,\n          \n          \n            \n                    REJECT,\n          \n          \n            \n                    DELAY,\n          \n          \n            \n                    THROTTLE;\n          \n          \n            \n                    NO_ACTION,\n          \n          \n            \n                    ABORT,\n          \n          \n            \n                    REJECT,\n          \n          \n            \n                    DELAY,\n          \n          \n            \n                    THROTTLE;", "author": "gregw", "createdAt": "2020-08-25T15:15:07Z", "path": "jetty-servlets/src/main/java/org/eclipse/jetty/servlets/DoSFilter.java", "diffHunk": "@@ -1369,10 +1406,45 @@ public void onTimeout(AsyncEvent event) throws IOException\n         }\n     }\n \n-    private String createRemotePortId(ServletRequest request)\n+    public enum Action\n     {\n-        String addr = request.getRemoteAddr();\n-        int port = request.getRemotePort();\n-        return addr + \":\" + port;\n+        NO_ACTION,\n+        REJECT,\n+        DELAY,\n+        THROTTLE;", "originalCommit": "aa59124ac359790d9cd5c6b76ac050b00eb92b30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzIyMTUzOA==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r477221538", "bodyText": "I think it would be good to pass in some info about the actual rate here.\nWe can't pass in the tracker, as that API is not that great.....\nI think passing in the type of the tracker, the number of requests and the period over which there were received may be useful.... even if just to put in the warnings.", "author": "gregw", "createdAt": "2020-08-26T11:14:01Z", "path": "jetty-servlets/src/main/java/org/eclipse/jetty/servlets/DoSFilter.java", "diffHunk": "@@ -1369,10 +1402,77 @@ public void onTimeout(AsyncEvent event) throws IOException\n         }\n     }\n \n-    private String createRemotePortId(ServletRequest request)\n+    public enum Action\n     {\n-        String addr = request.getRemoteAddr();\n-        int port = request.getRemotePort();\n-        return addr + \":\" + port;\n+        /**\n+         * No action is taken against the Request, it is allowed to be processed normally.\n+         */\n+        NO_ACTION,\n+        /**\n+         * The request and response is aborted, no response is sent.\n+         */\n+        ABORT,\n+        /**\n+         * The request is rejected by sending an error based on {@link DoSFilter#getTooManyCode()}\n+         */\n+        REJECT,\n+        /**\n+         * The request is delayed based on {@link DoSFilter#getDelayMs()}\n+         */\n+        DELAY,\n+        /**\n+         * The request is throttled.\n+         */\n+        THROTTLE;\n+\n+        /**\n+         * Obtain the Action based on configured {@link DoSFilter#getDelayMs()}\n+         *\n+         * @param delayMs the delay in milliseconds.\n+         * @return the Action proposed.\n+         */\n+        public static Action fromDelay(long delayMs)\n+        {\n+            if (delayMs < 0)\n+                return Action.REJECT;\n+\n+            if (delayMs == 0)\n+                return Action.THROTTLE;\n+\n+            return Action.DELAY;\n+        }\n+    }\n+\n+    /**\n+     * Listener for actions taken against specific requests.\n+     */\n+    public static class Listener\n+    {\n+        /**\n+         * Process the onRequestOverLimit() behavior.\n+         *\n+         * @param request the request that is over the limit\n+         * @param dosFilter the {@link DoSFilter} that this event occurred on\n+         * @return the action to actually perform.\n+         */\n+        public Action onRequestOverLimit(HttpServletRequest request, DoSFilter dosFilter)", "originalCommit": "48b6514ddabf99fcb9018b13127b0cf51157571b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzIyNzU0Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r477227547", "bodyText": "This looks strange.... I know it is the same behaviour as before, but now you have restructured it, I think it  is just wrong to always throttle async dispatched requests.\nI also think it is strange that we can only have a single tracker per request: session or IP or UserID.   We should probably track all three for a single request... but maybe that is another PR... and maybe in 10.", "author": "gregw", "createdAt": "2020-08-26T11:25:30Z", "path": "jetty-servlets/src/main/java/org/eclipse/jetty/servlets/DoSFilter.java", "diffHunk": "@@ -305,67 +307,76 @@ protected void doFilter(HttpServletRequest request, HttpServletResponse response\n \n         // Look for the rate tracker for this request.\n         RateTracker tracker = (RateTracker)request.getAttribute(__TRACKER);\n-        if (tracker == null)\n+        if (tracker != null)\n+        {\n+            // Redispatched, RateTracker present in request attributes.\n+            throttleRequest(request, response, filterChain, tracker);", "originalCommit": "48b6514ddabf99fcb9018b13127b0cf51157571b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEwMTQyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r481101429", "bodyText": "Put '@' hashcode between the name and the '['", "author": "gregw", "createdAt": "2020-09-01T12:32:02Z", "path": "jetty-servlets/src/main/java/org/eclipse/jetty/servlets/DoSFilter.java", "diffHunk": "@@ -1297,17 +1346,66 @@ public String toString()\n         {\n             return \"RateTracker/\" + _id + \"/\" + _type;\n         }\n+\n+        public class Overage implements OverLimit\n+        {\n+            private final Duration duration;\n+            private final long count;\n+\n+            public Overage(Duration dur, long count)\n+            {\n+                this.duration = dur;\n+                this.count = count;\n+            }\n+\n+            @Override\n+            public RateType getRateType()\n+            {\n+                return _type;\n+            }\n+\n+            @Override\n+            public String getRateId()\n+            {\n+                return _id;\n+            }\n+\n+            @Override\n+            public Duration getDuration()\n+            {\n+                return duration;\n+            }\n+\n+            @Override\n+            public long getCount()\n+            {\n+                return count;\n+            }\n+\n+            @Override\n+            public String toString()\n+            {\n+                final StringBuilder sb = new StringBuilder(OverLimit.class.getSimpleName());\n+                sb.append(\"[\");", "originalCommit": "51145cd7cf257229e9a150745a30ad6be55a24e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzMDg5OA==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r481130898", "bodyText": "doh!  working on it ...", "author": "joakime", "createdAt": "2020-09-01T13:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEwMTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ3NzAwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5195#discussion_r482477009", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-09-02T21:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEwMTQyOQ=="}], "type": "inlineReview"}, {"oid": "a8ae3f94769fcbd6db39adb9f6bffac260ad6a39", "url": "https://github.com/eclipse/jetty.project/commit/a8ae3f94769fcbd6db39adb9f6bffac260ad6a39", "message": "Issue #5185 - Add DoSFilter Listener to allow extensible behavior\n\n+ Currently there's no way to respond to rejected/throttled/delayed\n  requests that the DoSFilter impacts.\n  A Listener has been added to allow for any behaviors needed\n  by a user of the DoSFilter on requests that have been\n  impacted by the DoSFilter.\n+ Introducing OverLimit and RateType to DoSFilter internals\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-02T21:13:56Z", "type": "commit"}, {"oid": "a8ae3f94769fcbd6db39adb9f6bffac260ad6a39", "url": "https://github.com/eclipse/jetty.project/commit/a8ae3f94769fcbd6db39adb9f6bffac260ad6a39", "message": "Issue #5185 - Add DoSFilter Listener to allow extensible behavior\n\n+ Currently there's no way to respond to rejected/throttled/delayed\n  requests that the DoSFilter impacts.\n  A Listener has been added to allow for any behaviors needed\n  by a user of the DoSFilter on requests that have been\n  impacted by the DoSFilter.\n+ Introducing OverLimit and RateType to DoSFilter internals\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-02T21:13:56Z", "type": "forcePushed"}]}