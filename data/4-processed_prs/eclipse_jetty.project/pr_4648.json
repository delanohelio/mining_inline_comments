{"pr_number": 4648, "pr_title": "Issue #4645 - ForwardedRequestCustomizer now gives 400 response for bad port values", "pr_createdAt": "2020-03-09T04:29:18Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4648", "timeline": [{"oid": "797d25505b92268f74845ab880f40461ccd17019", "url": "https://github.com/eclipse/jetty.project/commit/797d25505b92268f74845ab880f40461ccd17019", "message": "Issue #4645 - better error message for empty X-Forwarded-Port value\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-03-09T02:01:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNzIwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r389707209", "bodyText": "Perhaps add a new method called parsePort(String rawPort) that does the Integer.parseInt() and also validates the range of values to be sane (port >= 1 && port <= 65535).", "author": "joakime", "createdAt": "2020-03-09T14:06:45Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -639,19 +639,23 @@ else if (_for == null)\n         @SuppressWarnings(\"unused\")\n         public void handlePort(HttpField field)\n         {\n+            String port = getLeftMost(field.getValue());\n+            if (StringUtil.isEmpty(port))\n+                throw new IllegalArgumentException(field.getName() + \" has empty value\");\n+\n             if (!getForwardedPortAsAuthority())\n             {\n                 if (_for == null)\n-                    _for = new PortSetHostPort(_request.getRemoteHost(), Integer.parseInt(getLeftMost(field.getValue())));\n+                    _for = new PortSetHostPort(_request.getRemoteHost(), Integer.parseInt(port));", "originalCommit": "797d25505b92268f74845ab880f40461ccd17019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbd89ce1c79ce38265cf6dac3d9307b94023866c", "url": "https://github.com/eclipse/jetty.project/commit/dbd89ce1c79ce38265cf6dac3d9307b94023866c", "message": "Issue #4645 - validate port range & return 400 on bad forwarded headers\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-03-11T07:31:25Z", "type": "commit"}, {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693", "url": "https://github.com/eclipse/jetty.project/commit/d5ee7b058b04b544af1fb17c1f6ffa1032452693", "message": "Issue #4645 - handle exceptions from all headers\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-03-11T07:41:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTQ4NA==", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390901484", "bodyText": "add the Throwable t as the cause of this exception", "author": "gregw", "createdAt": "2020-03-11T11:17:16Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -420,6 +432,12 @@ else if (forwarded._server != null)\n         }\n     }\n \n+    protected void onError(HttpField field, Throwable t)\n+    {\n+        LOG.warn(\"Exception while processing {}\", field, t);\n+        throw new BadMessageException(\"Bad header value for \" + field.getName());", "originalCommit": "d5ee7b058b04b544af1fb17c1f6ffa1032452693", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkxNDA5Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390914096", "bodyText": "Ok sure, was just being careful of giving away too much information in the response like simone said.", "author": "lachlan-roberts", "createdAt": "2020-03-11T11:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTcxMw==", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390901713", "bodyText": "Don't warn and throw.   Do one or the other.   I think this should just be a debug here.", "author": "gregw", "createdAt": "2020-03-11T11:17:47Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -420,6 +432,12 @@ else if (forwarded._server != null)\n         }\n     }\n \n+    protected void onError(HttpField field, Throwable t)\n+    {\n+        LOG.warn(\"Exception while processing {}\", field, t);", "originalCommit": "d5ee7b058b04b544af1fb17c1f6ffa1032452693", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "633298b5c7dfee8377c59b3f872f81082049cbf3", "url": "https://github.com/eclipse/jetty.project/commit/633298b5c7dfee8377c59b3f872f81082049cbf3", "message": "Issue #4645 - changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-03-11T11:41:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NjQ2Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r391466466", "bodyText": "Sorry but... thinking about this more, can we avoid the double try blocks.  onError has no declared exceptions, so whatever it throws can be thrown from this method.  If it doesn't throw then we continue.  Why the need to wrap with a RuntimeException?", "author": "gregw", "createdAt": "2020-03-12T08:34:11Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -380,9 +381,16 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n         {\n             for (HttpField field : httpFields)\n             {\n-                MethodHandle handle = _handles.get(field.getName());\n-                if (handle != null)\n-                    handle.invoke(forwarded, field);\n+                try\n+                {\n+                    MethodHandle handle = _handles.get(field.getName());\n+                    if (handle != null)\n+                        handle.invoke(forwarded, field);\n+                }\n+                catch (Throwable t)\n+                {\n+                    onError(field, t);", "originalCommit": "633298b5c7dfee8377c59b3f872f81082049cbf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAwNzQxMg==", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r392007412", "bodyText": "oops.. you're right, fixed.", "author": "lachlan-roberts", "createdAt": "2020-03-13T03:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NjQ2Ng=="}], "type": "inlineReview"}, {"oid": "fcbe704b24ec80cf65876f63caad475f8696d3ee", "url": "https://github.com/eclipse/jetty.project/commit/fcbe704b24ec80cf65876f63caad475f8696d3ee", "message": "Issue #4645 - do not wrap exceptions from onError with RuntimeException\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-03-13T02:59:43Z", "type": "commit"}]}