{"pr_number": 5560, "pr_title": "Issue #5539 - Proper StatisticsServlet output format via content negotiation", "pr_createdAt": "2020-11-02T15:52:42Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5560", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3MTk5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516071991", "bodyText": "This is probably a mistake, we shouldn't be second guessing the User-Agent Accept header.", "author": "joakime", "createdAt": "2020-11-02T15:56:59Z", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/StatisticsServlet.java", "diffHunk": "@@ -80,47 +88,150 @@ public void init() throws ServletException\n     }\n \n     @Override\n-    public void doPost(HttpServletRequest sreq, HttpServletResponse sres) throws ServletException, IOException\n+    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n-        doGet(sreq, sres);\n+        doGet(request, response);\n     }\n \n     @Override\n-    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException\n+    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n         if (_statsHandler == null)\n         {\n             LOG.warn(\"Statistics Handler not installed!\");\n-            resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+            response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n             return;\n         }\n         if (_restrictToLocalhost)\n         {\n-            if (!isLoopbackAddress(req.getRemoteAddr()))\n+            if (!isLoopbackAddress(request.getRemoteAddr()))\n             {\n-                resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+                response.sendError(HttpServletResponse.SC_FORBIDDEN);\n                 return;\n             }\n         }\n \n-        if (Boolean.parseBoolean(req.getParameter(\"statsReset\")))\n+        if (Boolean.parseBoolean(request.getParameter(\"statsReset\")))\n         {\n+            response.setStatus(HttpServletResponse.SC_OK);\n             _statsHandler.statsReset();\n             return;\n         }\n \n-        String wantXml = req.getParameter(\"xml\");\n-        if (wantXml == null)\n-            wantXml = req.getParameter(\"XML\");\n+        List<String> acceptable = getOrderedAcceptableMimeTypes(request);\n+\n+        for (String mimeType : acceptable)\n+        {\n+            switch (mimeType)\n+            {\n+                case \"application/json\":\n+                    writeJsonResponse(response);\n+                    return;\n+                case \"text/xml\":\n+                    writeXmlResponse(response);\n+                    return;\n+                case \"text/html\":\n+                    writeHtmlResponse(response);\n+                    return;\n+                case \"text/plain\":\n+                    writeTextResponse(response);\n+                    return;\n+                case \"*/*\":\n+                    String wantXml = request.getParameter(\"xml\");\n+                    if (wantXml == null)\n+                        wantXml = request.getParameter(\"XML\");\n+\n+                    if (Boolean.parseBoolean(wantXml))\n+                    {\n+                        writeXmlResponse(response);\n+                    }\n+                    else\n+                    {\n+                        writeTextResponse(response);\n+                    }\n+                    return;\n+                default:\n+                    if (LOG.isDebugEnabled())\n+                    {\n+                        LOG.debug(\"Ignoring unrecognized mime-type {}\", mimeType);\n+                    }\n+                    break;\n+            }\n+        }\n+        // None of the listed `Accept` mime-types were found.\n+        response.sendError(HttpServletResponse.SC_NOT_ACCEPTABLE);\n+    }\n+\n+    private void writeTextResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/plain\");\n+        CharSequence text = generateResponse(new TextProducer());\n+        response.getWriter().print(text.toString());\n+    }\n+\n+    private void writeHtmlResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/html\");\n+        Writer htmlWriter = new OutputStreamWriter(response.getOutputStream(), UTF_8);\n+        htmlWriter.append(\"<html><head><title>\");\n+        htmlWriter.append(this.getClass().getSimpleName());\n+        htmlWriter.append(\"</title></head><body>\\n\");\n+        CharSequence html = generateResponse(new HtmlProducer());\n+        htmlWriter.append(html.toString());\n+        htmlWriter.append(\"\\n</body></html>\\n\");\n+        htmlWriter.flush();\n+    }\n+\n+    private void writeXmlResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/xml\");\n+        CharSequence xml = generateResponse(new XmlProducer());\n+        response.getWriter().print(xml.toString());\n+    }\n \n-        if (Boolean.parseBoolean(wantXml))\n+    private void writeJsonResponse(HttpServletResponse response) throws IOException\n+    {\n+        // We intentionally don't put \"UTF-8\" into the response headers\n+        // as the rules for application/json state that it should never be\n+        // present on the HTTP Content-Type header.\n+        // It is also true that the application/json mime-type is always UTF-8.\n+        response.setContentType(\"application/json\");\n+        CharSequence json = generateResponse(new JsonProducer());\n+        Writer jsonWriter = new OutputStreamWriter(response.getOutputStream(), UTF_8);\n+        jsonWriter.append(json);\n+        jsonWriter.flush();\n+    }\n+\n+    private List<String> getOrderedAcceptableMimeTypes(HttpServletRequest request)\n+    {\n+        QuotedQualityCSV values = null;\n+        Enumeration<String> enumAccept = request.getHeaders(\"Accept\");\n+        if (enumAccept != null)\n         {\n-            sendXmlResponse(resp);\n+            while (enumAccept.hasMoreElements())\n+            {\n+                String value = enumAccept.nextElement();\n+                if (StringUtil.isNotBlank(value))\n+                {\n+                    if (values == null)\n+                    {\n+                        values = new QuotedQualityCSV(QuotedQualityCSV.MOST_SPECIFIC_MIME_ORDERING);\n+                    }\n+                    values.addValue(value);\n+                }\n+            }\n         }\n-        else\n+\n+        if (values != null)\n         {\n-            sendTextResponse(resp);\n+            return values.getValues();\n         }\n+\n+        // No accept specified, return that we allow ALL mime types\n+        return Collections.singletonList(\"*/*\");", "originalCommit": "178924b8a94b0b9df3aa1423104c4bdca529e6d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExODAzNA==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516118034", "bodyText": "On second though, if the Accept header is missing, this is used in it's place.", "author": "joakime", "createdAt": "2020-11-02T17:00:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3MTk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjkwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516116909", "bodyText": "I think this mechanism is now insufficient.\nInstead I think we need type parameter that can be json,xml, html or plain.\nOnly if their is no type parameter should we look at accepted types\nand finally if there is no preference from the accepted types, we should just send plain.... maybe deprecated support for xml parameter", "author": "gregw", "createdAt": "2020-11-02T16:58:52Z", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/StatisticsServlet.java", "diffHunk": "@@ -80,47 +88,150 @@ public void init() throws ServletException\n     }\n \n     @Override\n-    public void doPost(HttpServletRequest sreq, HttpServletResponse sres) throws ServletException, IOException\n+    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n-        doGet(sreq, sres);\n+        doGet(request, response);\n     }\n \n     @Override\n-    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException\n+    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n         if (_statsHandler == null)\n         {\n             LOG.warn(\"Statistics Handler not installed!\");\n-            resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+            response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n             return;\n         }\n         if (_restrictToLocalhost)\n         {\n-            if (!isLoopbackAddress(req.getRemoteAddr()))\n+            if (!isLoopbackAddress(request.getRemoteAddr()))\n             {\n-                resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+                response.sendError(HttpServletResponse.SC_FORBIDDEN);\n                 return;\n             }\n         }\n \n-        if (Boolean.parseBoolean(req.getParameter(\"statsReset\")))\n+        if (Boolean.parseBoolean(request.getParameter(\"statsReset\")))\n         {\n+            response.setStatus(HttpServletResponse.SC_OK);\n             _statsHandler.statsReset();\n             return;\n         }\n \n-        String wantXml = req.getParameter(\"xml\");\n-        if (wantXml == null)\n-            wantXml = req.getParameter(\"XML\");\n+        List<String> acceptable = getOrderedAcceptableMimeTypes(request);\n+\n+        for (String mimeType : acceptable)\n+        {\n+            switch (mimeType)\n+            {\n+                case \"application/json\":\n+                    writeJsonResponse(response);\n+                    return;\n+                case \"text/xml\":\n+                    writeXmlResponse(response);\n+                    return;\n+                case \"text/html\":\n+                    writeHtmlResponse(response);\n+                    return;\n+                case \"text/plain\":\n+                    writeTextResponse(response);\n+                    return;\n+                case \"*/*\":\n+                    String wantXml = request.getParameter(\"xml\");", "originalCommit": "178924b8a94b0b9df3aa1423104c4bdca529e6d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEyMzAyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516123029", "bodyText": "Pushed a change, is this what you are asking for?", "author": "joakime", "createdAt": "2020-11-02T17:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEyNjE4Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516126186", "bodyText": "I still think there is a need for a parameter as it can be difficult to set the accept header in some clients.", "author": "gregw", "createdAt": "2020-11-02T17:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEzMDM0Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516130347", "bodyText": "I still think there is a need for a parameter as it can be difficult to set the accept header in some clients.\n\nIf that were true, REST wouldn't exist like it does today.\nYou can even set the Accept header on a browser when for asking for content in various ways.", "author": "joakime", "createdAt": "2020-11-02T17:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE0NDExOA==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516144118", "bodyText": "Variation using query parameters incoming ...", "author": "joakime", "createdAt": "2020-11-02T17:35:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MTUyOA==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516151528", "bodyText": "Updated for variation on accept query parameter.", "author": "joakime", "createdAt": "2020-11-02T17:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwNTY4Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r524305682", "bodyText": "@gregw bump, is the new accept query parameter ... uhm ... acceptable to you?", "author": "joakime", "createdAt": "2020-11-16T14:26:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExNjkwOQ=="}], "type": "inlineReview"}, {"oid": "b02c6b1c804cb3dccc93c4450ec109ead09fe86e", "url": "https://github.com/eclipse/jetty.project/commit/b02c6b1c804cb3dccc93c4450ec109ead09fe86e", "message": "Issue #5539 - Proper StatisticsServlet output format via content negotiation\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-02T17:01:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MjA4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516152089", "bodyText": "I added these to troubleshoot the CI build/test failure on these.\nCI is reporting more resources than expected.", "author": "joakime", "createdAt": "2020-11-02T17:49:08Z", "path": "jetty-webapp/src/test/java/org/eclipse/jetty/webapp/WebInfConfigurationTest.java", "diffHunk": "@@ -72,7 +73,7 @@ public void testFindAndFilterContainerPaths()\n         context.setClassLoader(loader);\n         config.findAndFilterContainerPaths(context);\n         List<Resource> containerResources = context.getMetaData().getContainerResources();\n-        assertEquals(1, containerResources.size());\n+        assertEquals(1, containerResources.size(), () -> containerResources.stream().map(Resource::toString).collect(Collectors.joining(\",\", \"[\", \"]\")));", "originalCommit": "99dfdaceea30eb8d9a196dfa6bd6279f7b69f71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5MTcwMg==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r516191702", "bodyText": "Fixed.\nLooks like the container include jar pattern ...\ncontext.setAttribute(WebInfConfiguration.CONTAINER_JAR_PATTERN, \".*/jetty-util-[^/]*\\\\.jar$|.*/jetty-util/target/classes/\");\n... occasionally finds jetty-util-ajax-9.4.34-SNAPSHOT.jar as well.", "author": "joakime", "createdAt": "2020-11-02T19:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MjA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwOTMyNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r524309325", "bodyText": "Use HttpHeader.ACCEPT", "author": "gregw", "createdAt": "2020-11-16T14:31:06Z", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/StatisticsServlet.java", "diffHunk": "@@ -80,47 +101,151 @@ public void init() throws ServletException\n     }\n \n     @Override\n-    public void doPost(HttpServletRequest sreq, HttpServletResponse sres) throws ServletException, IOException\n+    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n-        doGet(sreq, sres);\n+        doGet(request, response);\n     }\n \n     @Override\n-    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException\n+    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n         if (_statsHandler == null)\n         {\n             LOG.warn(\"Statistics Handler not installed!\");\n-            resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+            response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n             return;\n         }\n         if (_restrictToLocalhost)\n         {\n-            if (!isLoopbackAddress(req.getRemoteAddr()))\n+            if (!isLoopbackAddress(request.getRemoteAddr()))\n             {\n-                resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+                response.sendError(HttpServletResponse.SC_FORBIDDEN);\n                 return;\n             }\n         }\n \n-        if (Boolean.parseBoolean(req.getParameter(\"statsReset\")))\n+        if (Boolean.parseBoolean(request.getParameter(\"statsReset\")))\n         {\n+            response.setStatus(HttpServletResponse.SC_OK);\n             _statsHandler.statsReset();\n             return;\n         }\n \n-        String wantXml = req.getParameter(\"xml\");\n-        if (wantXml == null)\n-            wantXml = req.getParameter(\"XML\");\n+        if (request.getParameter(\"xml\") != null)\n+        {\n+            LOG.warn(\"'xml' parameter is deprecated, use 'Accept' request header instead\");\n+        }\n+\n+        List<String> acceptable = getOrderedAcceptableMimeTypes(request);\n \n-        if (Boolean.parseBoolean(wantXml))\n+        for (String mimeType : acceptable)\n         {\n-            sendXmlResponse(resp);\n+            switch (mimeType)\n+            {\n+                case \"application/json\":\n+                    writeJsonResponse(response);\n+                    return;\n+                case \"text/xml\":\n+                    writeXmlResponse(response);\n+                    return;\n+                case \"text/html\":\n+                    writeHtmlResponse(response);\n+                    return;\n+                case \"text/plain\":\n+                case \"*/*\":\n+                    writeTextResponse(response);\n+                    return;\n+                default:\n+                    if (LOG.isDebugEnabled())\n+                    {\n+                        LOG.debug(\"Ignoring unrecognized mime-type {}\", mimeType);\n+                    }\n+                    break;\n+            }\n         }\n-        else\n+        // None of the listed `Accept` mime-types were found.\n+        response.sendError(HttpServletResponse.SC_NOT_ACCEPTABLE);\n+    }\n+\n+    private void writeTextResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/plain\");\n+        CharSequence text = generateResponse(new TextProducer());\n+        response.getWriter().print(text.toString());\n+    }\n+\n+    private void writeHtmlResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/html\");\n+        Writer htmlWriter = new OutputStreamWriter(response.getOutputStream(), UTF_8);\n+        htmlWriter.append(\"<html><head><title>\");\n+        htmlWriter.append(this.getClass().getSimpleName());\n+        htmlWriter.append(\"</title></head><body>\\n\");\n+        CharSequence html = generateResponse(new HtmlProducer());\n+        htmlWriter.append(html.toString());\n+        htmlWriter.append(\"\\n</body></html>\\n\");\n+        htmlWriter.flush();\n+    }\n+\n+    private void writeXmlResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/xml\");\n+        CharSequence xml = generateResponse(new XmlProducer());\n+        response.getWriter().print(xml.toString());\n+    }\n+\n+    private void writeJsonResponse(HttpServletResponse response) throws IOException\n+    {\n+        // We intentionally don't put \"UTF-8\" into the response headers\n+        // as the rules for application/json state that it should never be\n+        // present on the HTTP Content-Type header.\n+        // It is also true that the application/json mime-type is always UTF-8.\n+        response.setContentType(\"application/json\");\n+        CharSequence json = generateResponse(new JsonProducer());\n+        Writer jsonWriter = new OutputStreamWriter(response.getOutputStream(), UTF_8);\n+        jsonWriter.append(json);\n+        jsonWriter.flush();\n+    }\n+\n+    private List<String> getOrderedAcceptableMimeTypes(HttpServletRequest request)\n+    {\n+        QuotedQualityCSV values = null;\n+        Enumeration<String> enumAccept = request.getHeaders(\"Accept\");", "originalCommit": "c4ce84bbe1f2f11651c94db5176db6ef9bab07bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMxNjA3OA==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r524316078", "bodyText": "Not from a Servlet.", "author": "joakime", "createdAt": "2020-11-16T14:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwOTMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMyNDQzNw==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r524324437", "bodyText": "Never mind. I can from this particular servlet.\nBut not against the jetty field apis.", "author": "joakime", "createdAt": "2020-11-16T14:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwOTMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMxMjI2NA==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r524312264", "bodyText": "I think it should be the other way around.  Ie the URI specifies the acceptable type, then it should have precedence, otherwise use the Accept header.\nAlternately allow the accept parameter to be a quoted quality string and just do something like:\n\ufffc        values = new QuotedQualityCSV(QuotedQualityCSV.MOST_SPECIFIC_MIME_ORDERING);\n        values.addValue(request.getParameter(\"accept\"));\n        calues.addValue(all the Accept headers)\nand then let the quality mechanism work out the order.", "author": "gregw", "createdAt": "2020-11-16T14:34:56Z", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/StatisticsServlet.java", "diffHunk": "@@ -80,47 +101,151 @@ public void init() throws ServletException\n     }\n \n     @Override\n-    public void doPost(HttpServletRequest sreq, HttpServletResponse sres) throws ServletException, IOException\n+    public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n-        doGet(sreq, sres);\n+        doGet(request, response);\n     }\n \n     @Override\n-    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException\n+    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException\n     {\n         if (_statsHandler == null)\n         {\n             LOG.warn(\"Statistics Handler not installed!\");\n-            resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+            response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n             return;\n         }\n         if (_restrictToLocalhost)\n         {\n-            if (!isLoopbackAddress(req.getRemoteAddr()))\n+            if (!isLoopbackAddress(request.getRemoteAddr()))\n             {\n-                resp.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n+                response.sendError(HttpServletResponse.SC_FORBIDDEN);\n                 return;\n             }\n         }\n \n-        if (Boolean.parseBoolean(req.getParameter(\"statsReset\")))\n+        if (Boolean.parseBoolean(request.getParameter(\"statsReset\")))\n         {\n+            response.setStatus(HttpServletResponse.SC_OK);\n             _statsHandler.statsReset();\n             return;\n         }\n \n-        String wantXml = req.getParameter(\"xml\");\n-        if (wantXml == null)\n-            wantXml = req.getParameter(\"XML\");\n+        if (request.getParameter(\"xml\") != null)\n+        {\n+            LOG.warn(\"'xml' parameter is deprecated, use 'Accept' request header instead\");\n+        }\n+\n+        List<String> acceptable = getOrderedAcceptableMimeTypes(request);\n \n-        if (Boolean.parseBoolean(wantXml))\n+        for (String mimeType : acceptable)\n         {\n-            sendXmlResponse(resp);\n+            switch (mimeType)\n+            {\n+                case \"application/json\":\n+                    writeJsonResponse(response);\n+                    return;\n+                case \"text/xml\":\n+                    writeXmlResponse(response);\n+                    return;\n+                case \"text/html\":\n+                    writeHtmlResponse(response);\n+                    return;\n+                case \"text/plain\":\n+                case \"*/*\":\n+                    writeTextResponse(response);\n+                    return;\n+                default:\n+                    if (LOG.isDebugEnabled())\n+                    {\n+                        LOG.debug(\"Ignoring unrecognized mime-type {}\", mimeType);\n+                    }\n+                    break;\n+            }\n         }\n-        else\n+        // None of the listed `Accept` mime-types were found.\n+        response.sendError(HttpServletResponse.SC_NOT_ACCEPTABLE);\n+    }\n+\n+    private void writeTextResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/plain\");\n+        CharSequence text = generateResponse(new TextProducer());\n+        response.getWriter().print(text.toString());\n+    }\n+\n+    private void writeHtmlResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/html\");\n+        Writer htmlWriter = new OutputStreamWriter(response.getOutputStream(), UTF_8);\n+        htmlWriter.append(\"<html><head><title>\");\n+        htmlWriter.append(this.getClass().getSimpleName());\n+        htmlWriter.append(\"</title></head><body>\\n\");\n+        CharSequence html = generateResponse(new HtmlProducer());\n+        htmlWriter.append(html.toString());\n+        htmlWriter.append(\"\\n</body></html>\\n\");\n+        htmlWriter.flush();\n+    }\n+\n+    private void writeXmlResponse(HttpServletResponse response) throws IOException\n+    {\n+        response.setCharacterEncoding(\"utf-8\");\n+        response.setContentType(\"text/xml\");\n+        CharSequence xml = generateResponse(new XmlProducer());\n+        response.getWriter().print(xml.toString());\n+    }\n+\n+    private void writeJsonResponse(HttpServletResponse response) throws IOException\n+    {\n+        // We intentionally don't put \"UTF-8\" into the response headers\n+        // as the rules for application/json state that it should never be\n+        // present on the HTTP Content-Type header.\n+        // It is also true that the application/json mime-type is always UTF-8.\n+        response.setContentType(\"application/json\");\n+        CharSequence json = generateResponse(new JsonProducer());\n+        Writer jsonWriter = new OutputStreamWriter(response.getOutputStream(), UTF_8);\n+        jsonWriter.append(json);\n+        jsonWriter.flush();\n+    }\n+\n+    private List<String> getOrderedAcceptableMimeTypes(HttpServletRequest request)\n+    {\n+        QuotedQualityCSV values = null;\n+        Enumeration<String> enumAccept = request.getHeaders(\"Accept\");\n+        if (enumAccept != null)\n+        {\n+            while (enumAccept.hasMoreElements())\n+            {\n+                String value = enumAccept.nextElement();\n+                if (StringUtil.isNotBlank(value))\n+                {\n+                    if (values == null)\n+                    {\n+                        values = new QuotedQualityCSV(QuotedQualityCSV.MOST_SPECIFIC_MIME_ORDERING);\n+                    }\n+                    values.addValue(value);\n+                }\n+            }\n+        }\n+\n+        if (values != null)\n         {\n-            sendTextResponse(resp);\n+            return values.getValues();\n         }\n+\n+        // No accept header specified, try 'accept' parameter (for those clients that are\n+        // so ancient that they cannot set the standard HTTP `Accept` header)\n+        String acceptParameter = request.getParameter(\"accept\");", "originalCommit": "c4ce84bbe1f2f11651c94db5176db6ef9bab07bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzOTM3MA==", "url": "https://github.com/eclipse/jetty.project/pull/5560#discussion_r524339370", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-11-16T15:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMxMjI2NA=="}], "type": "inlineReview"}, {"oid": "5362467e6798815ddf566ae42abea44f383b96bd", "url": "https://github.com/eclipse/jetty.project/commit/5362467e6798815ddf566ae42abea44f383b96bd", "message": "Issue #5539 - Proper StatisticsServlet output format via content negotiation\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:21Z", "type": "commit"}, {"oid": "02f35deeaac1ed056e5c69aedbed73eef582e0d0", "url": "https://github.com/eclipse/jetty.project/commit/02f35deeaac1ed056e5c69aedbed73eef582e0d0", "message": "Issue #5539 - Deprecating 'xml' request parameter in StatisticsServlet\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:21Z", "type": "commit"}, {"oid": "b419db90c5c2186f4f244db47c74cf330d1e1367", "url": "https://github.com/eclipse/jetty.project/commit/b419db90c5c2186f4f244db47c74cf330d1e1367", "message": "Issue #5539 - Cleanup, adding javadoc, etc.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:21Z", "type": "commit"}, {"oid": "cc952f3a3ac4db08e2e5996ea7b08ed01a854133", "url": "https://github.com/eclipse/jetty.project/commit/cc952f3a3ac4db08e2e5996ea7b08ed01a854133", "message": "Issue #5539 - Adding query parameter accept variation\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:22Z", "type": "commit"}, {"oid": "c51127558038f1c6b39e4a7f75bfdec9ac3d9fba", "url": "https://github.com/eclipse/jetty.project/commit/c51127558038f1c6b39e4a7f75bfdec9ac3d9fba", "message": "Provide more detail in test failure on CI\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:22Z", "type": "commit"}, {"oid": "c9440357a732fd465fa8a765827a312e644330e0", "url": "https://github.com/eclipse/jetty.project/commit/c9440357a732fd465fa8a765827a312e644330e0", "message": "Issue #5539 - Fixing javadoc\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:23Z", "type": "commit"}, {"oid": "fd974c474c1175b420e0d187771b3f2eefb15ffe", "url": "https://github.com/eclipse/jetty.project/commit/fd974c474c1175b420e0d187771b3f2eefb15ffe", "message": "Fixing bad Container Include Jar pattern.\n\n+ It was matching on jetty-util-ajax-#.jar as well.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:23Z", "type": "commit"}, {"oid": "770be2dbc3a2fe4430310a2404baed8653a92519", "url": "https://github.com/eclipse/jetty.project/commit/770be2dbc3a2fe4430310a2404baed8653a92519", "message": "Issue #5539 - Adding jetty-util-ajax missing dep to osgi tests\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:23Z", "type": "commit"}, {"oid": "683d9a93497f816e4153a47aec7664cc9f385823", "url": "https://github.com/eclipse/jetty.project/commit/683d9a93497f816e4153a47aec7664cc9f385823", "message": "Issue #5539 - Updating StatisticsServlet accept processing per review\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:24Z", "type": "commit"}, {"oid": "683d9a93497f816e4153a47aec7664cc9f385823", "url": "https://github.com/eclipse/jetty.project/commit/683d9a93497f816e4153a47aec7664cc9f385823", "message": "Issue #5539 - Updating StatisticsServlet accept processing per review\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T15:10:24Z", "type": "forcePushed"}, {"oid": "314c65fb1481eaa578a065ed3b5098d3be013a7a", "url": "https://github.com/eclipse/jetty.project/commit/314c65fb1481eaa578a065ed3b5098d3be013a7a", "message": "Issue #5539 - Adding StatisticsServlet tests in test-distribution\n\n+ Updating module definition for JSON\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-11-16T18:31:28Z", "type": "commit"}]}