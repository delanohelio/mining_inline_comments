{"pr_number": 5031, "pr_title": "Issue #5018 - add WebSocketClient UpgradeRequest timeout to jetty 10", "pr_createdAt": "2020-07-08T08:25:40Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5031", "timeline": [{"oid": "a179535db36de0404c8e4248d0e0d42fe3c4d196", "url": "https://github.com/eclipse/jetty.project/commit/a179535db36de0404c8e4248d0e0d42fe3c4d196", "message": "Issue #5018 - add WebSocketClient UpgradeRequest timeout to jetty 10\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-07-08T08:04:36Z", "type": "commit"}, {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "url": "https://github.com/eclipse/jetty.project/commit/25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "message": "Issue #5018 - add WebSocketClient UpgradeRequest timeout to jetty 10\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-07-08T22:11:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3OTA2OA==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453679068", "bodyText": "Please move this static field to the top of the class and make it private.\nAlso, no need to pass it as parameter to quoteIfNeeded().", "author": "sbordet", "createdAt": "2020-07-13T14:11:53Z", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/ClientUpgradeRequest.java", "diffHunk": "@@ -297,6 +292,25 @@ public void setSession(Object session)\n         throw new UnsupportedOperationException(\"HttpSession not available on Client request\");\n     }\n \n+    /**\n+     * @param timeout the total timeout for the request/response conversation of the WebSocket handshake;\n+     * use zero or a negative value to disable the timeout\n+     * @param unit the timeout unit\n+     */\n+    public void setTimeout(long timeout, TimeUnit unit)\n+    {\n+        this.timeout = unit.toMillis(timeout);\n+    }\n+\n+    /**\n+     * @return the total timeout for this request, in milliseconds;\n+     * zero or negative if the timeout is disabled\n+     */\n+    public long getTimeout()\n+    {\n+        return timeout;\n+    }\n+\n     /**\n      * ABNF from RFC 2616, RFC 822, and RFC 6455 specified characters requiring quoting.\n      */", "originalCommit": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY5MzI3Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453693277", "bodyText": "This suggestion is unrelated to this issue.\nGood for a different PR related to general cleanup tho.", "author": "joakime", "createdAt": "2020-07-13T14:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3OTA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE0MTAzOA==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r454141038", "bodyText": "I will do this in a separate cleanup PR then.", "author": "lachlan-roberts", "createdAt": "2020-07-14T06:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3OTA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDY0Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453680647", "bodyText": "Return the hardcoded value HttpVersion.HTTP_1_1.asString().\nWe don't want to throw if someone calls this method for logging purposes.", "author": "sbordet", "createdAt": "2020-07-13T14:14:24Z", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/ClientUpgradeRequest.java", "diffHunk": "@@ -161,13 +161,13 @@ public String getHost()\n     @Override\n     public String getHttpVersion()\n     {\n-        return httpVersion;\n+        throw new UnsupportedOperationException(\"HttpVersion not available on ClientUpgradeRequest\");", "originalCommit": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwNzE5OA==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453707198", "bodyText": "What if we're doing websocket over HTTP/2?\nI don't think we have enough information available here to know if we are using HTTP/2 or not.\nThe previous implementation of this just returned null for both as there were no setters for it.", "author": "lachlan-roberts", "createdAt": "2020-07-13T14:51:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE4OTQ4OA==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r454189488", "bodyText": "@lachlan-roberts so why there are these 2 methods then? A relic of 9.4.x?\nIf we cannot implement them like you correctly point out, let's remove them.", "author": "sbordet", "createdAt": "2020-07-14T08:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMTExNg==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r454321116", "bodyText": "We need these methods here because this implements the org.eclipse.jetty.websocket.api.UpgradeRequest interface. These methods can be used on the server side, and are implemented on the client after the upgrade once you get it from the Session.", "author": "lachlan-roberts", "createdAt": "2020-07-14T12:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDk2Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453680967", "bodyText": "Return hardcoded HttpMethod.GET.asString().", "author": "sbordet", "createdAt": "2020-07-13T14:14:53Z", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/ClientUpgradeRequest.java", "diffHunk": "@@ -161,13 +161,13 @@ public String getHost()\n     @Override\n     public String getHttpVersion()\n     {\n-        return httpVersion;\n+        throw new UnsupportedOperationException(\"HttpVersion not available on ClientUpgradeRequest\");\n     }\n \n     @Override\n     public String getMethod()\n     {\n-        return method;\n+        throw new UnsupportedOperationException(\"Method not available on ClientUpgradeRequest\");", "originalCommit": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY5NDExMA==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453694110", "bodyText": "Should just remove the .getMethod() entirely, it's always GET", "author": "joakime", "createdAt": "2020-07-13T14:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDk2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE0MjY1Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r454142657", "bodyText": "Same as above, for HTTP/2 this would be CONNECT. So at this stage we don't really know.", "author": "lachlan-roberts", "createdAt": "2020-07-14T06:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDk2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4NDgwNw==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453684807", "bodyText": "You don't need to allocate this CF, just return what whenComplete() returns below.", "author": "sbordet", "createdAt": "2020-07-13T14:20:17Z", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "diffHunk": "@@ -149,9 +149,8 @@ public void onHandshakeResponse(HttpRequest request, HttpResponse response)\n                 }\n             });\n         }\n-        upgradeRequest.setConfiguration(configurationCustomizer);\n-        CompletableFuture<Session> futureSession = new CompletableFuture<>();\n \n+        CompletableFuture<Session> futureSession = new CompletableFuture<>();", "originalCommit": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY5NTIzNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453695235", "bodyText": "That doesn't seem right.\nWe want to return immediately, and let the whenComplete handle the success/exception at a later point in time.", "author": "joakime", "createdAt": "2020-07-13T14:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4NDgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwNTM5OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453705399", "bodyText": "This CF is giving a Jetty WS API Session, and the one with the whenComplete() returns a CoreSession. They're not interchangeable.\nThe core connect is used to complete the future for the jetty ws api connect.", "author": "lachlan-roberts", "createdAt": "2020-07-13T14:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4NDgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwNzY4Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453707683", "bodyText": "@lachlan-roberts CFs can be map()ed to transform their result; or perhaps use CF.handle() rather than whenComplete().", "author": "sbordet", "createdAt": "2020-07-13T14:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4NDgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyMzUyOA==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453723528", "bodyText": "Just looked at that, but I don't think we can map the exception like we are currently doing using CF.handle().", "author": "lachlan-roberts", "createdAt": "2020-07-13T15:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4NDgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczMjQ4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453732489", "bodyText": "@lachlan-roberts good point about the transformation of the exception.\nCode is good as is, returning the CF created on the fly, rather than the one returned by whenComplete().", "author": "sbordet", "createdAt": "2020-07-13T15:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4NDgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4ODQ5Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453688496", "bodyText": "Uh, no. It's a mistake that request.getHeaders() returns a HttpFields.Mutable.\nI'll fix jetty-10.0.x so please rebase this PR.\nThis code should be: headers(fields -> request.getHeaders().forEach(fields::put)).", "author": "sbordet", "createdAt": "2020-07-13T14:25:33Z", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/impl/JettyClientUpgradeRequest.java", "diffHunk": "@@ -53,15 +50,7 @@ public JettyClientUpgradeRequest(WebSocketCoreClient coreClient, UpgradeRequest\n             request.getHeaders().forEach(fields::put);", "originalCommit": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTA4Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453689082", "bodyText": "No need for the comment.", "author": "sbordet", "createdAt": "2020-07-13T14:26:23Z", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/impl/JettyClientUpgradeRequest.java", "diffHunk": "@@ -71,13 +60,8 @@ public JettyClientUpgradeRequest(WebSocketCoreClient coreClient, UpgradeRequest\n                 .map(c -> new ExtensionConfig(c.getName(), c.getParameters()))\n                 .collect(Collectors.toList()));\n \n-            // Copy method from upgradeRequest object\n-            if (request.getMethod() != null)\n-                method(request.getMethod());\n-\n-            // Copy version from upgradeRequest object\n-            if (request.getHttpVersion() != null)\n-                version(HttpVersion.fromString(request.getHttpVersion()));\n+            // Copy timeout from upgradeRequest object", "originalCommit": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcxMDE0NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453710145", "bodyText": "All the other operations in this block have a similar comment. I was trying to fit in with the current style.\nShould I remove all these comments to make it more compact?", "author": "lachlan-roberts", "createdAt": "2020-07-13T14:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcxMjQ0Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453712443", "bodyText": "@lachlan-roberts if the comment just says what the code does, remove it.\nThis one was also rotten, as it was referring to an upgradeRequest object which does not exist in the code.", "author": "sbordet", "createdAt": "2020-07-13T14:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTA4Mg=="}], "type": "inlineReview"}, {"oid": "df34a6269b658f4faf1a06d081fb0c6063677e96", "url": "https://github.com/eclipse/jetty.project/commit/df34a6269b658f4faf1a06d081fb0c6063677e96", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-5018-WebSocketClientRequestTimeout\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-07-14T06:39:23Z", "type": "commit"}, {"oid": "145dcf502ce20fb4231d78c95b53664590142422", "url": "https://github.com/eclipse/jetty.project/commit/145dcf502ce20fb4231d78c95b53664590142422", "message": "cleanups after merge\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-07-14T06:52:50Z", "type": "commit"}]}