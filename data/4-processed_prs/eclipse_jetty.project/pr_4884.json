{"pr_number": 4884, "pr_title": "Refactor PathSpec and fix javax.websocket URI Template matching", "pr_createdAt": "2020-05-18T12:33:37Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4884", "timeline": [{"oid": "de083dce8903611311ae9179968b387c75866979", "url": "https://github.com/eclipse/jetty.project/commit/de083dce8903611311ae9179968b387c75866979", "message": "remove unneeded getRelativePath()\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-18T15:33:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5NDcxNw==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r427194717", "bodyText": "While you're editing this file, could you add a header that describes what a PathSpec is.", "author": "janbartel", "createdAt": "2020-05-19T10:24:40Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/PathSpec.java", "diffHunk": "@@ -18,67 +18,12 @@\n \n package org.eclipse.jetty.http.pathmap;\n \n-/**\n- * The base PathSpec, what all other path specs are based on\n- */\n-public abstract class PathSpec implements Comparable<PathSpec>\n+public interface PathSpec extends Comparable<PathSpec>", "originalCommit": "de083dce8903611311ae9179968b387c75866979", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMwMzQ4OA==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r427303488", "bodyText": "Sure, I'll do it.", "author": "lorban", "createdAt": "2020-05-19T13:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5NDcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5NTkzOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r427195939", "bodyText": "I'm not sure I see the benefit of the Decomposition class? What benefit does it give over and above being just  private fields on the BasePathSpec class?", "author": "janbartel", "createdAt": "2020-05-19T10:26:56Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/BasePathSpec.java", "diffHunk": "@@ -0,0 +1,114 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.http.pathmap;\n+\n+/**\n+ * The base PathSpec, what all other path specs are based on\n+ */\n+public abstract class BasePathSpec implements PathSpec\n+{\n+    protected static class Decomposition", "originalCommit": "de083dce8903611311ae9179968b387c75866979", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0OTQyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r427249429", "bodyText": "OK, I've had an offline conversation with @gregw and I see why you might have introduced the Decomposition class. IMHO the behaviour in the base class is so trivial as to not warrant the complexity of introducing the Decomposition class, so I would ditch the BasePathSpec and have ServletPathSpec, RegexPathSpec directly implement the PathSpec interface.", "author": "janbartel", "createdAt": "2020-05-19T12:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5NTkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMwMzEyNg==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r427303126", "bodyText": "I introduced Decomposition more for the bits in common between RegexPathSpec and UriTemplatePathSpec.\nBut it's getting apparent now that the code has been written that it's not worth it.", "author": "lorban", "createdAt": "2020-05-19T13:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE5NTkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI1NDYwNQ==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r427254605", "bodyText": "I'm not sure it is worthwhile having BasePathSpec and Decomposition.\nI understand they exist to try and achieve some code reuse between the 3 implementations, but ultimately you are creating two new classes just to save duplicating a few simple getters.\nPerhaps a compromise is to keep Decomposition available as a getter on the interface, and then have default methods for the ohter getters.    Or just have an abstract base class and no interface.  Or just duplicate the fields/getters in the impls.\nI'd probably like Decomposition better if it had a better name.... PathSpecComponets??? nah still horrid....", "author": "gregw", "createdAt": "2020-05-19T12:15:24Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/BasePathSpec.java", "diffHunk": "@@ -0,0 +1,114 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.http.pathmap;\n+\n+/**\n+ * The base PathSpec, what all other path specs are based on\n+ */\n+public abstract class BasePathSpec implements PathSpec", "originalCommit": "de083dce8903611311ae9179968b387c75866979", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMwMjE2MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r427302161", "bodyText": "BasePathSpec doesn't do much, but there's a little more in common between RegexPathSpec and UriTemplatePathSpec.\nIt still doesn't justify the Decomposition, though so I'll also duplicate that around.", "author": "lorban", "createdAt": "2020-05-19T13:29:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI1NDYwNQ=="}], "type": "inlineReview"}, {"oid": "043819f58ebb712bd8e17f44333d990c4841dc95", "url": "https://github.com/eclipse/jetty.project/commit/043819f58ebb712bd8e17f44333d990c4841dc95", "message": "get rid of base class and Decomposition\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-19T13:27:18Z", "type": "forcePushed"}, {"oid": "ce12c36baca76b36319decc98c2dcecd8e0f235b", "url": "https://github.com/eclipse/jetty.project/commit/ce12c36baca76b36319decc98c2dcecd8e0f235b", "message": "Issue #4776 - Adding different length tests to WebSocketUriMappingTest\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-20T09:12:27Z", "type": "forcePushed"}, {"oid": "9e630a065d945e435d823a45bd208200a8797c77", "url": "https://github.com/eclipse/jetty.project/commit/9e630a065d945e435d823a45bd208200a8797c77", "message": "Issue #4776 - Adding different length tests to WebSocketUriMappingTest\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-20T09:15:59Z", "type": "forcePushed"}, {"oid": "040c20543b1d55d9b6c6faceb090b24bef8b15c8", "url": "https://github.com/eclipse/jetty.project/commit/040c20543b1d55d9b6c6faceb090b24bef8b15c8", "message": "Issue #4776 - Adding different length tests to WebSocketUriMappingTest\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-20T09:18:10Z", "type": "forcePushed"}, {"oid": "3c7518e9cf5d3dbfb6cc62d2c3d8c5e608cba144", "url": "https://github.com/eclipse/jetty.project/commit/3c7518e9cf5d3dbfb6cc62d2c3d8c5e608cba144", "message": "Issue #4776 - Adding different length tests to WebSocketUriMappingTest\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-20T09:22:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMTYwMg==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r428011602", "bodyText": "Can we think of a better name than LogicalDeclarationComparator? It's a comparator that works for MappedResources based on their PathSpecs .... is it a MappedResourceComparator? Is it a PathSpecComparator? In fact, could it be an anonymous class defined in PathMappings in the constructor for _mappings at line 49? I can't see where it's used anywhere else, but maybe it is?", "author": "janbartel", "createdAt": "2020-05-20T13:30:40Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/LogicalDeclarationComparator.java", "diffHunk": "@@ -0,0 +1,35 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.http.pathmap;\n+\n+import java.util.Comparator;\n+\n+/**\n+ * Sort {@link MappedResource}s by their {@link MappedResource#getPathSpec()} logical declarations.\n+ */\n+public class LogicalDeclarationComparator implements Comparator<MappedResource>", "originalCommit": "3c7518e9cf5d3dbfb6cc62d2c3d8c5e608cba144", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3ODE5NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r428078195", "bodyText": "I think this class should go and be replaced with a lambda in the PathMappings' TreeSet constructor instead.", "author": "lorban", "createdAt": "2020-05-20T14:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMTYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3ODY2OA==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r428078668", "bodyText": "But since this is @joakime 's code, maybe he had something else in mind?", "author": "lorban", "createdAt": "2020-05-20T14:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMTYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4MDQyMw==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r428080423", "bodyText": "If you can make the tests pass then i'm good with any change you want to make.", "author": "joakime", "createdAt": "2020-05-20T14:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMTYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4ODY3MA==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r428088670", "bodyText": "Okay, done.", "author": "lorban", "createdAt": "2020-05-20T15:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMTYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMjY4Mg==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r428012682", "bodyText": "You can delete this line now.", "author": "janbartel", "createdAt": "2020-05-20T13:32:04Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/pathmap/RegexPathSpec.java", "diffHunk": "@@ -56,54 +59,65 @@ public RegexPathSpec(String regex)\n                     break;\n                 case '/':\n                     if (!inGrouping)\n-                    {\n-                        this.pathDepth++;\n-                    }\n+                        pathDepth++;\n                     break;\n                 default:\n-                    if (!inGrouping)\n-                    {\n-                        if (Character.isLetterOrDigit(c))\n-                        {\n-                            signature.append('l'); // literal (exact)\n-                        }\n-                    }\n+                    if (!inGrouping && Character.isLetterOrDigit(c))\n+                        signature.append('l'); // literal (exact)\n                     break;\n             }\n         }\n-        this.pattern = Pattern.compile(pathSpec);\n+        Pattern pattern = Pattern.compile(declaration);\n \n         // Figure out the grouping based on the signature\n         String sig = signature.toString();\n \n+        PathSpecGroup group;\n         if (Pattern.matches(\"^l*$\", sig))\n-        {\n-            this.group = PathSpecGroup.EXACT;\n-        }\n+            group = PathSpecGroup.EXACT;\n         else if (Pattern.matches(\"^l*g+\", sig))\n-        {\n-            this.group = PathSpecGroup.PREFIX_GLOB;\n-        }\n+            group = PathSpecGroup.PREFIX_GLOB;\n         else if (Pattern.matches(\"^g+l+$\", sig))\n-        {\n-            this.group = PathSpecGroup.SUFFIX_GLOB;\n-        }\n+            group = PathSpecGroup.SUFFIX_GLOB;\n         else\n-        {\n-            this.group = PathSpecGroup.MIDDLE_GLOB;\n-        }\n+            group = PathSpecGroup.MIDDLE_GLOB;\n+\n+        //return new RegexDecomposition(declaration, group, pathDepth, specLength, null, null, pattern);", "originalCommit": "3c7518e9cf5d3dbfb6cc62d2c3d8c5e608cba144", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3OTIwNg==", "url": "https://github.com/eclipse/jetty.project/pull/4884#discussion_r428079206", "bodyText": "Indeed, thanks.", "author": "lorban", "createdAt": "2020-05-20T14:54:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMjY4Mg=="}], "type": "inlineReview"}, {"oid": "85a5452f4959899a48c66223b569f6a5e89fb6cb", "url": "https://github.com/eclipse/jetty.project/commit/85a5452f4959899a48c66223b569f6a5e89fb6cb", "message": "Issue #4877 - refactor PathSpec into an interface whose implementations use final fields\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-20T15:03:07Z", "type": "commit"}, {"oid": "aca4958efdb34597e90429bb3471d3e061b90fc9", "url": "https://github.com/eclipse/jetty.project/commit/aca4958efdb34597e90429bb3471d3e061b90fc9", "message": "examples demonstrating websocket path mapping issue\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-05-20T15:03:07Z", "type": "commit"}, {"oid": "00d68e214480d20212391c7639d42281b1c8842f", "url": "https://github.com/eclipse/jetty.project/commit/00d68e214480d20212391c7639d42281b1c8842f", "message": "add extra tests for websocket path mappings\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-05-20T15:03:07Z", "type": "commit"}, {"oid": "79e76544ff565a560ad8fbd066ddaaaf4797e414", "url": "https://github.com/eclipse/jetty.project/commit/79e76544ff565a560ad8fbd066ddaaaf4797e414", "message": "Issue #4776 - UriTemplatePathSpec sorting on simplified path spec.\n\n+ Moved testcase to jetty-http (better place for it)\n+ Introduced simplified path spec to aid in sorting\n+ Made .getMatches(String) return sorted list by best match.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-20T15:05:18Z", "type": "commit"}, {"oid": "0234ead671e33400fad0ab7ce4dbd01b37240245", "url": "https://github.com/eclipse/jetty.project/commit/0234ead671e33400fad0ab7ce4dbd01b37240245", "message": "Issue #4776 - Making PathMappings._mappings use LogicalDeclaration sort\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-20T15:05:18Z", "type": "commit"}, {"oid": "5c2f00c1f5262c7f1d93f4ba0049e16ae6204e25", "url": "https://github.com/eclipse/jetty.project/commit/5c2f00c1f5262c7f1d93f4ba0049e16ae6204e25", "message": "Issue #4776 - Adding different length tests to WebSocketUriMappingTest\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-20T15:05:18Z", "type": "commit"}, {"oid": "e0391a5ea833bc104a700af9d37a748e33ec50aa", "url": "https://github.com/eclipse/jetty.project/commit/e0391a5ea833bc104a700af9d37a748e33ec50aa", "message": "replace LogicalDeclarationComparator with Comparator.comparing\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-20T15:06:17Z", "type": "commit"}, {"oid": "e0391a5ea833bc104a700af9d37a748e33ec50aa", "url": "https://github.com/eclipse/jetty.project/commit/e0391a5ea833bc104a700af9d37a748e33ec50aa", "message": "replace LogicalDeclarationComparator with Comparator.comparing\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>", "committedDate": "2020-05-20T15:06:17Z", "type": "forcePushed"}]}