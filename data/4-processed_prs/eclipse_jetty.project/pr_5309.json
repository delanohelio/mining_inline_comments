{"pr_number": 5309, "pr_title": "Issue #5263 Jetty Home warning", "pr_createdAt": "2020-09-21T21:08:31Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5309", "timeline": [{"oid": "b00ec5a0d67254d0ebafb0364dfed1b6b81ee5b4", "url": "https://github.com/eclipse/jetty.project/commit/b00ec5a0d67254d0ebafb0364dfed1b6b81ee5b4", "message": "Issue #5264 Jetty Home warning\n\nWarn when using jetty home as a jetty base", "committedDate": "2020-09-21T21:07:59Z", "type": "commit"}, {"oid": "3a20ef7f2eee01bfe88f6dabc034f7f4d1a76f95", "url": "https://github.com/eclipse/jetty.project/commit/3a20ef7f2eee01bfe88f6dabc034f7f4d1a76f95", "message": "Merge branch 'jetty-10.0.x' into jetty-10.0.x-5264-jetty-home-warning", "committedDate": "2020-09-22T10:33:46Z", "type": "commit"}, {"oid": "9beb685b37f0118a739d6afe2f07082af8ed77ce", "url": "https://github.com/eclipse/jetty.project/commit/9beb685b37f0118a739d6afe2f07082af8ed77ce", "message": "Issue #5304 HTTP2 HostHeader\n\n + updated more options doco and handling\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-09-22T10:40:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2MTM0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5309#discussion_r492661340", "bodyText": "\"all it is moved ....\" you mean \"all its configuration\"?", "author": "janbartel", "createdAt": "2020-09-22T11:31:02Z", "path": "jetty-start/src/main/resources/org/eclipse/jetty/start/usage.txt", "diffHunk": "@@ -124,15 +124,21 @@ Jetty Module Management:\n                    be generated. An explicit --add-module is required to generate\n                    an ini file.\n \n-                   This option replaces the depecated --add-to-start and --add-to-startd.\n+                   This option replaces the deprecated --add-to-start and --add-to-startd.\n \n   --update-ini     Scan all start.ini and start.d/*.ini files and update\n                    any properties with values specified on the command\n                    line. e.g. --update-ini jetty.http.port=8888\n \n+  --create-start-d\n+                   Create a ${jetty.base}/start.d directory.  If a ${jetty.base}/start.ini\n+                   files exists, then all it is moved into start.d. Using a start.d directory", "originalCommit": "9beb685b37f0118a739d6afe2f07082af8ed77ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2MTYxMA==", "url": "https://github.com/eclipse/jetty.project/pull/5309#discussion_r492661610", "bodyText": "No apostrophe for its.", "author": "janbartel", "createdAt": "2020-09-22T11:31:33Z", "path": "jetty-start/src/main/resources/org/eclipse/jetty/start/usage.txt", "diffHunk": "@@ -124,15 +124,21 @@ Jetty Module Management:\n                    be generated. An explicit --add-module is required to generate\n                    an ini file.\n \n-                   This option replaces the depecated --add-to-start and --add-to-startd.\n+                   This option replaces the deprecated --add-to-start and --add-to-startd.\n \n   --update-ini     Scan all start.ini and start.d/*.ini files and update\n                    any properties with values specified on the command\n                    line. e.g. --update-ini jetty.http.port=8888\n \n+  --create-start-d\n+                   Create a ${jetty.base}/start.d directory.  If a ${jetty.base}/start.ini\n+                   files exists, then all it is moved into start.d. Using a start.d directory\n+                   is the default and this option is only needed to either force the creation of a\n+                   ${jetty.home}/start.d or to move a start.ini file to start.d\n+\n   --create-start-ini\n                    Create a ${jetty.base}/start.ini file.  If a ${jetty.base}/start.d\n-                   directory exists, then all it's contained ini files are concatinated into\n+                   directory exists, then all it's contained ini files are concatenated into", "originalCommit": "9beb685b37f0118a739d6afe2f07082af8ed77ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2MjMwNA==", "url": "https://github.com/eclipse/jetty.project/pull/5309#discussion_r492662304", "bodyText": "Typo: its has no apostrophe.", "author": "janbartel", "createdAt": "2020-09-22T11:33:00Z", "path": "jetty-start/src/main/resources/org/eclipse/jetty/start/usage.txt", "diffHunk": "@@ -124,15 +124,21 @@ Jetty Module Management:\n                    be generated. An explicit --add-module is required to generate", "originalCommit": "9beb685b37f0118a739d6afe2f07082af8ed77ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2OTkyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5309#discussion_r492669929", "bodyText": "yeah it was a typo :)", "author": "gregw", "createdAt": "2020-09-22T11:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2MjMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2NDcwMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5309#discussion_r492664701", "bodyText": "\"Use of both ...\"", "author": "janbartel", "createdAt": "2020-09-22T11:37:42Z", "path": "jetty-start/src/main/java/org/eclipse/jetty/start/BaseBuilder.java", "diffHunk": "@@ -222,72 +227,98 @@ public boolean accept(Path entry) throws IOException\n             }\n         }\n \n-        if (!newlyAdded.isEmpty())\n+        if ((startArgs.isCreateStartD() && (!Files.exists(startd) || Files.exists(startini))) ||\n+            (!newlyAdded.isEmpty() && !Files.exists(startini) && !Files.exists(startd)))\n         {\n-            if (!Files.exists(startini) && !Files.exists(startd) && FS.ensureDirectoryExists(startd))\n+            if (Files.exists(getBaseHome().getBasePath(\"start.jar\")) && !startArgs.isCreateStartD())\n+            {\n+                StartLog.warn(\"creating start.d in ${jetty.home} is not recommended!\");\n+                if (!startArgs.isCreateStartD())\n+                {\n+                    BufferedReader input = new BufferedReader(new InputStreamReader(System.in));\n+                    System.err.printf(\"%nProceed (y/N)? \");\n+                    String response = input.readLine();\n+\n+                    if (Utils.isBlank(response) || !response.toLowerCase(Locale.ENGLISH).startsWith(\"y\"))\n+                        System.exit(1);\n+                }\n+            }\n+\n+            if (FS.ensureDirectoryExists(startd))\n             {\n                 StartLog.info(\"mkdir \" + baseHome.toShortForm(startd));\n                 modified.set(true);\n             }\n \n-            if (Files.exists(startini) && Files.exists(startd))\n-                StartLog.warn(\"Use both %s and %s is deprecated\", getBaseHome().toShortForm(startd), getBaseHome().toShortForm(startini));\n-\n-            boolean useStartD = Files.exists(startd);\n-            builder.set(useStartD ? new StartDirBuilder(this) : new StartIniBuilder(this));\n-            newlyAdded.stream().map(modules::get).forEach(module ->\n+            if (Files.exists(startini) && startArgs.isCreateStartD())\n             {\n-                String ini = null;\n-                try\n+                int ini = 0;\n+                Path startdStartini = startd.resolve(\"start.ini\");\n+                while (Files.exists(startdStartini))\n                 {\n-                    if (module.isSkipFilesValidation())\n-                    {\n-                        StartLog.debug(\"Skipping [files] validation on %s\", module.getName());\n-                    }\n-                    else\n-                    {\n-                        // if (explicitly added and ini file modified)\n-                        if (startArgs.getStartModules().contains(module.getName()))\n-                        {\n-                            ini = builder.get().addModule(module, startArgs.getProperties());\n-                            if (ini != null)\n-                                modified.set(true);\n-                        }\n-                        for (String file : module.getFiles())\n-                        {\n-                            files.add(new FileArg(module, startArgs.getProperties().expand(file)));\n-                        }\n-                    }\n+                    ini++;\n+                    startdStartini = startd.resolve(\"start\" + ini + \".ini\");\n                 }\n-                catch (Exception e)\n+                Files.move(startini, startdStartini);\n+                modified.set(true);\n+            }\n+        }\n+\n+        boolean useStartD = Files.exists(startd);\n+        if (useStartD && Files.exists(startini))\n+            StartLog.warn(\"Use both %s and %s is deprecated\", getBaseHome().toShortForm(startd), getBaseHome().toShortForm(startini));", "originalCommit": "9beb685b37f0118a739d6afe2f07082af8ed77ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2NzIxMA==", "url": "https://github.com/eclipse/jetty.project/pull/5309#discussion_r492667210", "bodyText": "So if you put both --create-startd and --create-start-ini on the command line what would happen? Is it dependent on the ordering on the command line? Should it be an error?", "author": "janbartel", "createdAt": "2020-09-22T11:42:44Z", "path": "jetty-start/src/main/java/org/eclipse/jetty/start/BaseBuilder.java", "diffHunk": "@@ -222,72 +227,98 @@ public boolean accept(Path entry) throws IOException\n             }\n         }\n \n-        if (!newlyAdded.isEmpty())\n+        if ((startArgs.isCreateStartD() && (!Files.exists(startd) || Files.exists(startini))) ||\n+            (!newlyAdded.isEmpty() && !Files.exists(startini) && !Files.exists(startd)))", "originalCommit": "9beb685b37f0118a739d6afe2f07082af8ed77ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY3MDY4Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5309#discussion_r492670683", "bodyText": "No it will first create start.ini and then create start.d and move that start.ini into it.", "author": "gregw", "createdAt": "2020-09-22T11:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2NzIxMA=="}], "type": "inlineReview"}, {"oid": "5d3643e5e49c668586be5eb2511414fb5eafe937", "url": "https://github.com/eclipse/jetty.project/commit/5d3643e5e49c668586be5eb2511414fb5eafe937", "message": "Issue #5264 Jetty Home warning\n\nupdates from review", "committedDate": "2020-09-22T11:50:26Z", "type": "commit"}]}