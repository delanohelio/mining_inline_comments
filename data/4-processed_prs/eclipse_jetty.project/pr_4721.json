{"pr_number": 4721, "pr_title": "Issue #4713 Async dispatch with query.", "pr_createdAt": "2020-03-26T15:10:11Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4721", "timeline": [{"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5", "url": "https://github.com/eclipse/jetty.project/commit/983193071e8f2062e0350cb18b4af0e4e921aff5", "message": "Issue #4713 Async dispatch with query.\n\n+ Preserve the entire URI with query when startAsync(req,res) is used.\n+ merge any query string from dispatch path with either original query or preserved query from forward\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-03-26T12:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNDQxOA==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399134418", "bodyText": "This new boolean parameter requires more brainpower to understand than I'm comfortable with. IMHO it should either be renamed (useProvidedUri?) or documented, or maybe both.", "author": "lorban", "createdAt": "2020-03-27T09:28:08Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AsyncContextEvent.java", "diffHunk": "@@ -25,25 +25,28 @@\n import javax.servlet.ServletRequest;\n import javax.servlet.ServletResponse;\n \n+import org.eclipse.jetty.http.HttpURI;\n import org.eclipse.jetty.server.handler.ContextHandler.Context;\n import org.eclipse.jetty.util.thread.Scheduler;\n \n public class AsyncContextEvent extends AsyncEvent implements Runnable\n {\n     private final Context _context;\n     private final AsyncContextState _asyncContext;\n+    private final HttpURI _providedUri;\n     private volatile HttpChannelState _state;\n     private ServletContext _dispatchContext;\n     private String _dispatchPath;\n     private volatile Scheduler.Task _timeoutTask;\n     private Throwable _throwable;\n \n-    public AsyncContextEvent(Context context, AsyncContextState asyncContext, HttpChannelState state, Request baseRequest, ServletRequest request, ServletResponse response)\n+    public AsyncContextEvent(Context context, AsyncContextState asyncContext, HttpChannelState state, Request baseRequest, ServletRequest request, ServletResponse response, boolean provided)\n     {\n         super(null, request, response, null);\n         _context = context;\n         _asyncContext = asyncContext;\n         _state = state;\n+        _providedUri = provided ? new HttpURI(baseRequest.getHttpURI()) : null;", "originalCommit": "983193071e8f2062e0350cb18b4af0e4e921aff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2MzM4NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400063385", "bodyText": "I'll pass in the URI and call it baseURI.", "author": "gregw", "createdAt": "2020-03-30T09:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNDQxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNTEzMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399135131", "bodyText": "I wonder if you shouldn't keep the old constructor here, and not use an extra boolean argument.", "author": "lorban", "createdAt": "2020-03-27T09:29:18Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2165,7 +2168,7 @@ public AsyncContext startAsync() throws IllegalStateException\n         HttpChannelState state = getHttpChannelState();\n         if (_async == null)\n             _async = new AsyncContextState(state);\n-        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, this, getResponse());\n+        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, this, getResponse(), false);", "originalCommit": "983193071e8f2062e0350cb18b4af0e4e921aff5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNTUzOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399135539", "bodyText": "I wonder if you shouldn't pass the providedUri here instead of a boolean.", "author": "lorban", "createdAt": "2020-03-27T09:30:02Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2178,17 +2181,8 @@ public AsyncContext startAsync(ServletRequest servletRequest, ServletResponse se\n         HttpChannelState state = getHttpChannelState();\n         if (_async == null)\n             _async = new AsyncContextState(state);\n-        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, servletRequest, servletResponse);\n+        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, servletRequest, servletResponse, true);", "originalCommit": "983193071e8f2062e0350cb18b4af0e4e921aff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2MzQ4MA==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400063480", "bodyText": "ack", "author": "gregw", "createdAt": "2020-03-30T09:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNTUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399141916", "bodyText": "Couldn't / shouldn't the code of this branch (as well as the new else one) be moved to URIUtil?", "author": "lorban", "createdAt": "2020-03-27T09:41:04Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2391,7 +2385,7 @@ else if (oldQueryParams == null || oldQueryParams.size() == 0)\n                 setQueryString(oldQuery);\n             else if (oldQuery == null)\n                 setQueryString(newQuery);\n-            else\n+            else if (oldQueryParams.keySet().stream().anyMatch(newQueryParams.keySet()::contains))", "originalCommit": "983193071e8f2062e0350cb18b4af0e4e921aff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NzIxNg==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400067216", "bodyText": "Hmmm  probably.... but now I'm losing confidence that this code is even necessary in the first place!  The actual parameters maps are merged above with:\n            mergedQueryParams = new MultiMap<>(newQueryParams);\n            mergedQueryParams.addAllValues(oldQueryParams);\nSo surely the actual query string itself should be merged with just\n    setQueryString(newQuery + '&' + oldQuery);\nI think I'll try removing that complex logic and see what fails and then check with the TCK if it should or shouldn't fail like that!", "author": "gregw", "createdAt": "2020-03-30T09:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4NDEyMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400084121", "bodyText": "Ugh!  @janbartel just pointed me at #2074 so we dropped the ball on this a bit as we do have different behaviours and we've not chosen one or the other.   I'm going to experiment with the simplest interpretation and see what the TCK says", "author": "gregw", "createdAt": "2020-03-30T10:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4NzUxMA==", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400087510", "bodyText": "Actually cancel that.  I'm going to merge this one as it is mostly unrelated and work on #2074 separately", "author": "gregw", "createdAt": "2020-03-30T10:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg=="}], "type": "inlineReview"}, {"oid": "a74f36c38cd2a1c6d981290dc233eea73d014859", "url": "https://github.com/eclipse/jetty.project/commit/a74f36c38cd2a1c6d981290dc233eea73d014859", "message": "Issue #4713 asyncDispatch with query parameters\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-03-30T10:29:47Z", "type": "commit"}, {"oid": "fd631b0fa9cd05e5286b36eaa05811c9021812ae", "url": "https://github.com/eclipse/jetty.project/commit/fd631b0fa9cd05e5286b36eaa05811c9021812ae", "message": "Merge branch 'jetty-10.0.x' into jetty-10.0.x-4713-asyncDispatchQuery", "committedDate": "2020-03-30T13:16:39Z", "type": "commit"}]}