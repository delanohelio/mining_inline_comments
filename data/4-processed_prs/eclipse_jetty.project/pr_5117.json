{"pr_number": 5117, "pr_title": "Pool class refinements", "pr_createdAt": "2020-08-04T16:25:39Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5117", "timeline": [{"oid": "1436b0c3e2da420cec9d3865072d7ed26a62f186", "url": "https://github.com/eclipse/jetty.project/commit/1436b0c3e2da420cec9d3865072d7ed26a62f186", "message": "Some updates to the new Pool class:\n\n + fixed a race with pending reservations\n + use a pending counter\n + Reservation API to simplify Entry API\n + removed public methods on Entry API", "committedDate": "2020-08-04T16:23:33Z", "type": "commit"}, {"oid": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "url": "https://github.com/eclipse/jetty.project/commit/f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "message": "Some updates to the new Pool class:\n\n + fixed a race with pending reservations\n + use a pending counter\n + Reservation API to simplify Entry API\n + removed public methods on Entry API", "committedDate": "2020-08-05T09:22:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwNTkxNw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465705917", "bodyText": "Nit: \"AtomicInt\" -> \"AtomicInteger\" or it would seem like we have created our own class AtomicInt.", "author": "sbordet", "createdAt": "2020-08-05T12:56:09Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -128,35 +130,42 @@ public final void setMaxUsageCount(int maxUsageCount)\n     }\n \n     /**\n-     * Create a new disabled slot into the pool. The returned entry\n-     * won't be acquirable as long as {@link Entry#enable(Object)}\n-     * has not been called.\n+     * Create a new disabled slot into the pool.\n+     * The returned Reservation holds an entry that will not\n+     * be acquirable until {@link Reservation#enable(Object)} is called.\n+     * Alternately {@link Reservation#acquire(Object)} can be called to\n+     * atomically enable and acquire the entry.\n+     * If a value cannot be created for the slot, then {@link Reservation#remove()}\n+     * must be called to free the slot.\n      *\n      * @param maxReservations the max desired number of reserved entries,\n      * or a negative number to always trigger the reservation of a new entry.\n      * @return a disabled entry that is contained in the pool,\n      * or null if the pool is closed or if the pool already contains\n      * {@link #getMaxEntries()} entries.\n      */\n-    public Entry reserve(int maxReservations)\n+    public Reservation reserve(int maxReservations)\n     {\n-        if (maxReservations >= 0 && getPendingConnectionCount() >= maxReservations)\n-            return null;\n-\n-        lock.lock();\n-        try\n-        {\n-            if (!closed && sharedList.size() < maxEntries)\n-            {\n-                Entry entry = new Entry();\n-                sharedList.add(entry);\n-                return entry;\n-            }\n-            return null;\n-        }\n-        finally\n+        try (Locker.Lock l = locker.lock())\n         {\n-            lock.unlock();\n+            if (closed)\n+                return null;\n+\n+            int space = maxEntries - sharedList.size();\n+            if (space <= 0)\n+                return null;\n+\n+            // The pending count is an AtomicInt that is only ever incremented here with", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxNjc1OA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465716758", "bodyText": "This method is never used, so remove it.", "author": "sbordet", "createdAt": "2020-08-05T13:13:57Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -332,29 +372,105 @@ public String toString()\n         return getClass().getSimpleName() + \" size=\" + sharedList.size() + \" closed=\" + closed + \" entries=\" + sharedList;\n     }\n \n+    /**\n+     * A Reservation of a slot in the Pool\n+     */\n+    public class Reservation\n+    {\n+        private final Entry entry = new Entry();\n+\n+        /**\n+         * @return The reserved {@link Entry}, which will be closed until enabled.\n+         */\n+        public Pool<T>.Entry getEntry()\n+        {\n+            return entry;\n+        }\n+\n+        /** Enable the reserved {@link Entry}.\n+         * Once enabled, the entry is immediately available to be acquired, potentially by\n+         * another thread.  If the caller wishes to acquire the associated entry, they should\n+         * use {@link #acquire(Object)} to atomically enable and acquire.\n+         * @param pooled The pooled item for the entry\n+         */\n+        public void enable(T pooled)\n+        {\n+            enable(pooled, false);\n+        }\n+\n+        /** Enable and acquire the reserved {@link Entry}.\n+         * The associated entry is atomically enabled and acquired, so that no other thread can acquire it and\n+         * the {@link #getEntry()} value may be used by the caller.\n+         * @param pooled The pooled item for the entry\n+         */\n+        public Pool<T>.Entry acquire(T pooled)\n+        {\n+            enable(pooled, true);\n+            return entry;\n+        }\n+\n+        private void enable(T pooled, boolean acquire)\n+        {\n+            Objects.requireNonNull(pooled);\n+            if (entry.state.getHi() != Integer.MIN_VALUE)\n+                throw new IllegalStateException(\"Open entries cannot be enabled : \" + this);\n+            entry.pooled = pooled;\n+            int usage = acquire ? 1 : 0;\n+            if (!entry.state.compareAndSet(Integer.MIN_VALUE, usage, 0, usage))\n+            {\n+                entry.pooled = null;\n+                throw new IllegalStateException(\"Entry cannot be enabled : \" + this);\n+            }\n+            pending.decrementAndGet();\n+        }\n+\n+        /**\n+         * Remove the reservation without enabling.\n+         */\n+        public void remove()\n+        {\n+            Pool.this.remove(entry);\n+        }\n+\n+        @Override\n+        public String toString()\n+        {\n+            return String.format(\"%s@%x{%s}\",\n+                getClass().getName(),\n+                hashCode(),\n+                entry);\n+        }\n+    }\n+\n     public class Entry\n     {\n-        // hi: positive=open/maxUsage counter,negative=closed lo: multiplexing counter\n+        // hi: positive=open/maxUsage counter; negative=closed; MIN_VALUE pending\n+        // lo: multiplexing counter\n         private final AtomicBiInteger state;\n-        private volatile T pooled;\n \n-        public Entry()\n+        // The pooled item.  This is not volatile as it is set once and then never changed.\n+        // Other threads accessing must check the state field above first, so a good before/after\n+        // relationship exists to make a memory barrier.\n+        private T pooled;\n+\n+        Entry()\n         {\n-            this.state = new AtomicBiInteger(-1, 0);\n+            this.state = new AtomicBiInteger(Integer.MIN_VALUE, 0);\n         }\n \n         public T getPooled()\n         {\n             return pooled;\n         }\n \n-        public void enable(T pooled)\n+        /**\n+         * Release the entry.\n+         * This is equivalent to calling {@link Pool#release(Pool.Entry)} passing this entry.\n+         * @return true if released.\n+         */\n+        public boolean release()", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMzY3MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465803671", "bodyText": "It will be once I do my XmlConfiguration PR.\nIt makes sense that an item in the pool that has a reference to it's own entry can release itself without needing to keep a reference to the pool.", "author": "gregw", "createdAt": "2020-08-05T15:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxNjc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMTkwMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466421901", "bodyText": "I'm not sure. Entry is not really an API class now that you have introduced Reservation.\nIt's an opaque mechanism that needs to be exposed, but I think it's more correct to force people to use Pool and Reservationand Attachable rather than Entry.", "author": "sbordet", "createdAt": "2020-08-06T13:43:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxNjc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4NTEzNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466885135", "bodyText": "Entry most definitely is an API class and I have code that pools objects that remember their own Entry.  It is pointless to force them to also remember the pool they came from just so they can call release.... as the Entry already knows its own pool.", "author": "gregw", "createdAt": "2020-08-07T08:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxNjc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcyMTU2MA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465721560", "bodyText": "A Reservation may be concurrently removed while it's being enabled.\nThis code should be converted to the classic while (true) loop and retry in case of failures.\nFurthermore, it needs to account for the closed state (hi==-1) and not enable if it's already closed.\nWhich means enable() should return a boolean that tells whether the enabling could be done.", "author": "sbordet", "createdAt": "2020-08-05T13:21:29Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -332,29 +372,105 @@ public String toString()\n         return getClass().getSimpleName() + \" size=\" + sharedList.size() + \" closed=\" + closed + \" entries=\" + sharedList;\n     }\n \n+    /**\n+     * A Reservation of a slot in the Pool\n+     */\n+    public class Reservation\n+    {\n+        private final Entry entry = new Entry();\n+\n+        /**\n+         * @return The reserved {@link Entry}, which will be closed until enabled.\n+         */\n+        public Pool<T>.Entry getEntry()\n+        {\n+            return entry;\n+        }\n+\n+        /** Enable the reserved {@link Entry}.\n+         * Once enabled, the entry is immediately available to be acquired, potentially by\n+         * another thread.  If the caller wishes to acquire the associated entry, they should\n+         * use {@link #acquire(Object)} to atomically enable and acquire.\n+         * @param pooled The pooled item for the entry\n+         */\n+        public void enable(T pooled)\n+        {\n+            enable(pooled, false);\n+        }\n+\n+        /** Enable and acquire the reserved {@link Entry}.\n+         * The associated entry is atomically enabled and acquired, so that no other thread can acquire it and\n+         * the {@link #getEntry()} value may be used by the caller.\n+         * @param pooled The pooled item for the entry\n+         */\n+        public Pool<T>.Entry acquire(T pooled)\n+        {\n+            enable(pooled, true);\n+            return entry;\n+        }\n+\n+        private void enable(T pooled, boolean acquire)\n+        {\n+            Objects.requireNonNull(pooled);\n+            if (entry.state.getHi() != Integer.MIN_VALUE)\n+                throw new IllegalStateException(\"Open entries cannot be enabled : \" + this);\n+            entry.pooled = pooled;\n+            int usage = acquire ? 1 : 0;\n+            if (!entry.state.compareAndSet(Integer.MIN_VALUE, usage, 0, usage))\n+            {\n+                entry.pooled = null;\n+                throw new IllegalStateException(\"Entry cannot be enabled : \" + this);", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMjE2Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465802162", "bodyText": "Unfortunately this code is just not threadsafe and I can't see how we can make it so without adding a lock.\nThe problem is that if we allow multiple threads to call enable on the reservation, both may pass the MIN_VALUE check and then both will try to set the entry.pooled value.  Only one will win and it may not be the one that wins the CaS race.\nSo currently enable will ISE atomically if anybody else messes with state (of the reserved entry or by closing the pool).  The state of the pooled field is not so well defined for multiple threads.... but I think any app that is racing itself to call enable is just wrong anyway.\nI think ISE is OK for -1 state.... but are you saying that if it is -1, we should noop?       If so, I can do that after a failed CaS, but not in a loop, which will never work because of the pooled field problem.\nI've gone back on forth on this method a lot... I don't like it, but I like it more than a big lock.", "author": "gregw", "createdAt": "2020-08-05T15:14:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcyMTU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxOTU2OA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466419568", "bodyText": "The problem is that if we allow multiple threads to call enable on the reservation\n\nBut we never supported that and I think it's ok - enable() has a natural race with remove() but not with itself.\nIt is possible to write the classic while (true) loop, not care about races with itself, but do care about races with remove() that are natural and should not throw.", "author": "sbordet", "createdAt": "2020-08-06T13:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcyMTU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4NDMyNw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466884327", "bodyText": "The class while (true) loop doesn't work if we throw ISE if the state is not what we expected.", "author": "gregw", "createdAt": "2020-08-07T07:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcyMTU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcyNjcwOA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465726708", "bodyText": "Use getClass().getSimpleName() here.", "author": "sbordet", "createdAt": "2020-08-05T13:29:12Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -332,29 +372,105 @@ public String toString()\n         return getClass().getSimpleName() + \" size=\" + sharedList.size() + \" closed=\" + closed + \" entries=\" + sharedList;\n     }\n \n+    /**\n+     * A Reservation of a slot in the Pool\n+     */\n+    public class Reservation\n+    {\n+        private final Entry entry = new Entry();\n+\n+        /**\n+         * @return The reserved {@link Entry}, which will be closed until enabled.\n+         */\n+        public Pool<T>.Entry getEntry()\n+        {\n+            return entry;\n+        }\n+\n+        /** Enable the reserved {@link Entry}.\n+         * Once enabled, the entry is immediately available to be acquired, potentially by\n+         * another thread.  If the caller wishes to acquire the associated entry, they should\n+         * use {@link #acquire(Object)} to atomically enable and acquire.\n+         * @param pooled The pooled item for the entry\n+         */\n+        public void enable(T pooled)\n+        {\n+            enable(pooled, false);\n+        }\n+\n+        /** Enable and acquire the reserved {@link Entry}.\n+         * The associated entry is atomically enabled and acquired, so that no other thread can acquire it and\n+         * the {@link #getEntry()} value may be used by the caller.\n+         * @param pooled The pooled item for the entry\n+         */\n+        public Pool<T>.Entry acquire(T pooled)\n+        {\n+            enable(pooled, true);\n+            return entry;\n+        }\n+\n+        private void enable(T pooled, boolean acquire)\n+        {\n+            Objects.requireNonNull(pooled);\n+            if (entry.state.getHi() != Integer.MIN_VALUE)\n+                throw new IllegalStateException(\"Open entries cannot be enabled : \" + this);\n+            entry.pooled = pooled;\n+            int usage = acquire ? 1 : 0;\n+            if (!entry.state.compareAndSet(Integer.MIN_VALUE, usage, 0, usage))\n+            {\n+                entry.pooled = null;\n+                throw new IllegalStateException(\"Entry cannot be enabled : \" + this);\n+            }\n+            pending.decrementAndGet();\n+        }\n+\n+        /**\n+         * Remove the reservation without enabling.\n+         */\n+        public void remove()\n+        {\n+            Pool.this.remove(entry);\n+        }\n+\n+        @Override\n+        public String toString()\n+        {\n+            return String.format(\"%s@%x{%s}\",\n+                getClass().getName(),", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczMzAxNw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465733017", "bodyText": "Remove the TODO, as ConnectionPool does not work in this way: by the time we notify the future, the Connection could already be stolen by another thread.", "author": "sbordet", "createdAt": "2020-08-05T13:38:55Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -223,8 +223,8 @@ public void succeeded(Connection connection)\n             {\n                 if (LOG.isDebugEnabled())\n                     LOG.debug(\"Connection {}/{} creation succeeded {}\", pool.size(), pool.getMaxEntries(), connection);\n-                adopt(entry, connection);\n-                future.complete(null);\n+                adopt(reservation, connection);\n+                future.complete(null);  // TODO could this now be a future that passes back the connection?", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczMzQ0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465733440", "bodyText": "I would log the reservation here, not reservation.getEntry().", "author": "sbordet", "createdAt": "2020-08-05T13:39:34Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -246,16 +246,16 @@ protected void proceed()\n         requester.succeeded();\n     }\n \n-    private void adopt(Pool<Connection>.Entry entry, Connection connection)\n+    private void adopt(Pool<Connection>.Reservation reservation, Connection connection)\n     {\n         if (!(connection instanceof Attachable))\n             throw new IllegalArgumentException(\"Invalid connection object: \" + connection);\n         Attachable attachable = (Attachable)connection;\n-        attachable.setAttachment(entry);\n+        attachable.setAttachment(reservation.getEntry());\n         if (LOG.isDebugEnabled())\n-            LOG.debug(\"onCreating {}\", entry);\n+            LOG.debug(\"adopt {} {}\", reservation.getEntry(), connection);", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNzAyNw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465737027", "bodyText": "There are no tests for this new method.\nFurthermore, why does it take an Entry as parameter? I think it should just be a Supplier<T> to create the object as the creator is called within the acquisition process, so the implementation does all the plumbing with the Entry.", "author": "sbordet", "createdAt": "2020-08-05T13:44:45Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -215,6 +224,42 @@ public Entry acquire()\n         return null;\n     }\n \n+    /**\n+     * Utility method to acquire an entry from the pool,\n+     * reserving and creating a new entry if necessary.\n+     *\n+     * @param creator a function to create the pooled value for a reserved entry.\n+     * @return an entry from the pool or null if none is available.\n+     */\n+    public Entry acquire(Function<Entry, T> creator)", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5MzQ1NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465793455", "bodyText": "It takes an entry because it is typical (both our usages) for a two way association to be made between the pooled item and its entry.  This allows the item to pass the entry in the constructor or associate it with an attachment etc.\nI'll add some tests", "author": "gregw", "createdAt": "2020-08-05T15:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNzAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMDExMA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466310110", "bodyText": "I think the two way association with Attachable should be done in this method, and not be a burden of the implementer of the creator lambda.", "author": "sbordet", "createdAt": "2020-08-06T10:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNzAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4MzI5OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466883299", "bodyText": "I don't agree.  There is currently no dependency on Attachable from Pool and nothing that says an Attachable must be used for the association... or even if something is Attachable that it may be so for another reason.", "author": "gregw", "createdAt": "2020-08-07T07:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNzAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5OTA1OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466899059", "bodyText": "Note also that with the Reservation approach, this method is not so important as the API is clear and it is probably less faff to not use this method.   So if we don't really agree on this method, it is OK to just not have it... so long as we have Reservation or something like it.", "author": "gregw", "createdAt": "2020-08-07T08:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNzAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0NTQ0OA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r467745448", "bodyText": "With the Reservation API, it is no longer difficult to call the API directly, so this method is no longer needed.", "author": "gregw", "createdAt": "2020-08-10T08:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNzAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczODIxOA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465738218", "bodyText": "Can we use IO.close() in the loop? I think a warn() here is too much.", "author": "sbordet", "createdAt": "2020-08-05T13:46:27Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -281,17 +326,12 @@ public boolean isClosed()\n     public void close()\n     {\n         List<Entry> copy;\n-        lock.lock();\n-        try\n+        try (Locker.Lock l = locker.lock())\n         {\n             closed = true;\n             copy = new ArrayList<>(sharedList);\n             sharedList.clear();\n         }\n-        finally\n-        {\n-            lock.unlock();\n-        }\n \n         // iterate the copy and close its entries\n         for (Entry entry : copy)", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwNzA3OA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465807078", "bodyText": "Sure.... but should we close any Closeable when it is removed from the pool, or only when the pool is closed?  Perhaps we should close AutoCloseables that are removed from the pool.  Eitherway, need to javadoc this behavior", "author": "gregw", "createdAt": "2020-08-05T15:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczODIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0MjEzOA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465742138", "bodyText": "I think we should call reservation.remove() and rethrow here - same semantic of Map.computeIfAbsent().", "author": "sbordet", "createdAt": "2020-08-05T13:52:18Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -215,6 +224,42 @@ public Entry acquire()\n         return null;\n     }\n \n+    /**\n+     * Utility method to acquire an entry from the pool,\n+     * reserving and creating a new entry if necessary.\n+     *\n+     * @param creator a function to create the pooled value for a reserved entry.\n+     * @return an entry from the pool or null if none is available.\n+     */\n+    public Entry acquire(Function<Entry, T> creator)\n+    {\n+        Entry entry = acquire();\n+        if (entry != null)\n+            return entry;\n+\n+        Reservation reservation = reserve(getMaxEntries());\n+        if (reservation == null)\n+            return null;\n+\n+        T value = null;\n+        try\n+        {\n+            value = creator.apply(reservation.getEntry());\n+        }\n+        catch (Throwable th)\n+        {\n+            LOGGER.warn(th);", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NDIwNw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465794207", "bodyText": "just throw and not warn?   I don't really like log and throw.", "author": "gregw", "createdAt": "2020-08-05T15:03:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0MjEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NDU2Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465744562", "bodyText": "It may be possible that the pool is closed just before the call to this method, so we should return null, which means reservation.acquire() should return a boolean.", "author": "sbordet", "createdAt": "2020-08-05T13:55:47Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -215,6 +224,42 @@ public Entry acquire()\n         return null;\n     }\n \n+    /**\n+     * Utility method to acquire an entry from the pool,\n+     * reserving and creating a new entry if necessary.\n+     *\n+     * @param creator a function to create the pooled value for a reserved entry.\n+     * @return an entry from the pool or null if none is available.\n+     */\n+    public Entry acquire(Function<Entry, T> creator)\n+    {\n+        Entry entry = acquire();\n+        if (entry != null)\n+            return entry;\n+\n+        Reservation reservation = reserve(getMaxEntries());\n+        if (reservation == null)\n+            return null;\n+\n+        T value = null;\n+        try\n+        {\n+            value = creator.apply(reservation.getEntry());\n+        }\n+        catch (Throwable th)\n+        {\n+            LOGGER.warn(th);\n+        }\n+\n+        if (value == null)\n+        {\n+            reservation.remove();\n+            return null;\n+        }\n+\n+        return reservation.acquire(value);", "originalCommit": "f5a35a2eac4ce20b64ba71edcc1800a926cadde4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NzU4Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r465797582", "bodyText": "Currently it throws an ISE, which is what enable did before.  reservation.acquire can't return a boolean because it returns the entry.", "author": "gregw", "createdAt": "2020-08-05T15:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxOTQ2Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466319463", "bodyText": "No, this last return statement should be:\nif (reservation.acquire(value))\n  return reservation.getEntry();\nelse\n  return null;", "author": "sbordet", "createdAt": "2020-08-06T10:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg4Mzc0Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r466883743", "bodyText": "But the acquire will throw ISE if the pool has been closed... just as it did before.", "author": "gregw", "createdAt": "2020-08-07T07:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NDU2Mg=="}], "type": "inlineReview"}, {"oid": "37a9f88fb7f8104364db7856f285460b02781db8", "url": "https://github.com/eclipse/jetty.project/commit/37a9f88fb7f8104364db7856f285460b02781db8", "message": "Updates from review", "committedDate": "2020-08-05T15:17:09Z", "type": "commit"}, {"oid": "be7bb00a2633de913b7014b7b511fee0094c9a15", "url": "https://github.com/eclipse/jetty.project/commit/be7bb00a2633de913b7014b7b511fee0094c9a15", "message": "Updates from review\nTests for cache size and acquire with creator", "committedDate": "2020-08-05T16:44:54Z", "type": "commit"}, {"oid": "2eb669757f63098c41bdcfa34438c9afc9af22cc", "url": "https://github.com/eclipse/jetty.project/commit/2eb669757f63098c41bdcfa34438c9afc9af22cc", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-PoolCleaning", "committedDate": "2020-08-10T07:56:01Z", "type": "commit"}, {"oid": "1ac922b3f4b0a1fe1df0e8606ec70b22805bb5a3", "url": "https://github.com/eclipse/jetty.project/commit/1ac922b3f4b0a1fe1df0e8606ec70b22805bb5a3", "message": "Method no longer required with Reservation", "committedDate": "2020-08-10T08:05:27Z", "type": "commit"}, {"oid": "d8b28e435ac41438cb18c307f6f5257934e99c00", "url": "https://github.com/eclipse/jetty.project/commit/d8b28e435ac41438cb18c307f6f5257934e99c00", "message": "update from the feedback on the feedback of the feedback from the review.\n\nMoved enable to Entry, removed Reservation class and clarified usage in javadoc", "committedDate": "2020-08-10T13:31:31Z", "type": "commit"}, {"oid": "2f32c2b8b1a96237f6f5a7cd82e569813af9ee6f", "url": "https://github.com/eclipse/jetty.project/commit/2f32c2b8b1a96237f6f5a7cd82e569813af9ee6f", "message": "Issue #5095 XmlConfiguration locking  Use pool instead of static shared instance\n\nfixed javadoc", "committedDate": "2020-08-10T15:56:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwMzY4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468003689", "bodyText": "Minor nit: you probably should call reserve(-1) to make it more obvious that you do not want to be limited by the pending/disabled entries count.", "author": "lorban", "createdAt": "2020-08-10T15:46:42Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -215,6 +225,43 @@ public Entry acquire()\n         return null;\n     }\n \n+    /**\n+     * Utility method to acquire an entry from the pool,\n+     * reserving and creating a new entry if necessary.\n+     *\n+     * @param creator a function to create the pooled value for a reserved entry.\n+     * @return an entry from the pool or null if none is available.\n+     */\n+    public Entry acquire(Function<Pool<T>.Entry, T> creator)\n+    {\n+        Entry entry = acquire();\n+        if (entry != null)\n+            return entry;\n+\n+        entry = reserve(getMaxEntries());", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwNTgyMA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468005820", "bodyText": "This test is useless.", "author": "lorban", "createdAt": "2020-08-10T15:50:09Z", "path": "jetty-util/src/test/java/org/eclipse/jetty/util/PoolTest.java", "diffHunk": "@@ -31,16 +35,33 @@\n import static org.hamcrest.Matchers.notNullValue;\n import static org.hamcrest.Matchers.nullValue;\n import static org.hamcrest.Matchers.sameInstance;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n import static org.junit.jupiter.api.Assertions.assertThrows;\n \n public class PoolTest\n {\n+    public static Stream<Object[]> cacheSize()\n+    {\n+        List<Object[]> data = new ArrayList<>();\n+        data.add(new Object[]{0});\n+        data.add(new Object[]{1});\n+        data.add(new Object[]{2});\n+        return data.stream();\n+    }\n \n-    @Test\n-    public void testAcquireRelease()\n+    @ParameterizedTest\n+    @MethodSource(value = \"cacheSize\")\n+    public void testCache(int cacheSize)", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwODM0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468008340", "bodyText": "Why did you remove this test?", "author": "lorban", "createdAt": "2020-08-10T15:53:58Z", "path": "jetty-util/src/test/java/org/eclipse/jetty/util/PoolTest.java", "diffHunk": "@@ -350,35 +419,14 @@ public void testMultiplexRemoveAfterAcquire()\n         assertThat(pool.size(), is(0));\n     }\n \n-    @Test\n-    public void testReleaseThenRemoveNonEnabledEntry()", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwODQxMg==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468008412", "bodyText": "Why did you remove this test?", "author": "lorban", "createdAt": "2020-08-10T15:54:04Z", "path": "jetty-util/src/test/java/org/eclipse/jetty/util/PoolTest.java", "diffHunk": "@@ -350,35 +419,14 @@ public void testMultiplexRemoveAfterAcquire()\n         assertThat(pool.size(), is(0));\n     }\n \n-    @Test\n-    public void testReleaseThenRemoveNonEnabledEntry()\n-    {\n-        Pool<String> pool = new Pool<>(1, 0);\n-        Pool<String>.Entry e = pool.reserve(-1);\n-        assertThat(pool.size(), is(1));\n-        assertThat(pool.release(e), is(false));\n-        assertThat(pool.size(), is(1));\n-        assertThat(pool.remove(e), is(true));\n-        assertThat(pool.size(), is(0));\n-    }\n-\n-    @Test\n-    public void testRemoveNonEnabledEntry()", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwOTc5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468009791", "bodyText": "I don't think the Pool.this. prefix is needed.", "author": "lorban", "createdAt": "2020-08-10T15:56:06Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -215,6 +225,43 @@ public Entry acquire()\n         return null;\n     }\n \n+    /**\n+     * Utility method to acquire an entry from the pool,\n+     * reserving and creating a new entry if necessary.\n+     *\n+     * @param creator a function to create the pooled value for a reserved entry.\n+     * @return an entry from the pool or null if none is available.\n+     */\n+    public Entry acquire(Function<Pool<T>.Entry, T> creator)\n+    {\n+        Entry entry = acquire();\n+        if (entry != null)\n+            return entry;\n+\n+        entry = reserve(getMaxEntries());\n+        if (entry == null)\n+            return null;\n+\n+        T value = null;\n+        try\n+        {\n+            value = creator.apply(entry);\n+        }\n+        catch (Throwable th)\n+        {\n+            Pool.this.remove(entry);", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwOTg1OA==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468009858", "bodyText": "I don't think the Pool.this. prefix is needed.", "author": "lorban", "createdAt": "2020-08-10T15:56:11Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -215,6 +225,43 @@ public Entry acquire()\n         return null;\n     }\n \n+    /**\n+     * Utility method to acquire an entry from the pool,\n+     * reserving and creating a new entry if necessary.\n+     *\n+     * @param creator a function to create the pooled value for a reserved entry.\n+     * @return an entry from the pool or null if none is available.\n+     */\n+    public Entry acquire(Function<Pool<T>.Entry, T> creator)\n+    {\n+        Entry entry = acquire();\n+        if (entry != null)\n+            return entry;\n+\n+        entry = reserve(getMaxEntries());\n+        if (entry == null)\n+            return null;\n+\n+        T value = null;\n+        try\n+        {\n+            value = creator.apply(entry);\n+        }\n+        catch (Throwable th)\n+        {\n+            Pool.this.remove(entry);\n+            throw th;\n+        }\n+\n+        if (value == null)\n+        {\n+            Pool.this.remove(entry);", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0NzA2Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468047067", "bodyText": "No, you can't throw from a Callback - good that adopt() was inlined because I missed it.\nCall failed(new IllegalArgumentException()), as we need to remove the Entry, notify the CF and the requester.", "author": "sbordet", "createdAt": "2020-08-10T16:58:12Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -201,29 +201,30 @@ protected void tryCreate(int maxPending)\n \n     private CompletableFuture<Void> tryCreateReturningFuture(int maxPending)\n     {\n-        CompletableFuture<Void> future = new CompletableFuture<>();\n-\n         if (LOG.isDebugEnabled())\n             LOG.debug(\"tryCreate {}/{} connections {}/{} pending\", pool.size(), pool.getMaxEntries(), getPendingConnectionCount(), maxPending);\n \n-        Pool<Connection>.Reservation reservation = pool.reserve(maxPending);\n-        if (reservation == null)\n-        {\n-            future.complete(null);\n-            return future;\n-        }\n+        Pool<Connection>.Entry entry = pool.reserve(maxPending);\n+        if (entry == null)\n+            return CompletableFuture.completedFuture(null);\n \n         if (LOG.isDebugEnabled())\n             LOG.debug(\"newConnection {}/{} connections {}/{} pending\", pool.size(), pool.getMaxEntries(), getPendingConnectionCount(), maxPending);\n \n+        CompletableFuture<Void> future = new CompletableFuture<>();\n         destination.newConnection(new Promise<Connection>()\n         {\n             @Override\n             public void succeeded(Connection connection)\n             {\n                 if (LOG.isDebugEnabled())\n                     LOG.debug(\"Connection {}/{} creation succeeded {}\", pool.size(), pool.getMaxEntries(), connection);\n-                adopt(reservation, connection);\n+                if (!(connection instanceof Attachable))\n+                    throw new IllegalArgumentException(\"Invalid connection object: \" + connection);", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0OTc5Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5117#discussion_r468049796", "bodyText": "Typo: acquired -> acquire.", "author": "sbordet", "createdAt": "2020-08-10T17:03:04Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -417,6 +381,40 @@ public String toString()\n             this.state = new AtomicBiInteger(Integer.MIN_VALUE, 0);\n         }\n \n+        /** Enable a reserved entry {@link Entry}.\n+         * An entry returned from the {@link #reserve(int)} method must be enabled with this method,\n+         * once and only once, before it is usable by the pool.\n+         * The entry may be enabled and not acquired, in which case it is immediately available to be\n+         * acquired, potentially by another thread; or it can be enabled and acquired atomically so that\n+         * no other thread can acquired it, although the acquire may still fail if the pool has been closed.", "originalCommit": "d8b28e435ac41438cb18c307f6f5257934e99c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f1cf28639c1f32323213da348de348e11f448294", "url": "https://github.com/eclipse/jetty.project/commit/f1cf28639c1f32323213da348de348e11f448294", "message": "Issue #5095 XmlConfiguration locking  Use pool instead of static shared instance\n\nfixed javadoc", "committedDate": "2020-08-11T09:21:21Z", "type": "commit"}, {"oid": "0a699783e27e767d8130b10ac8cc9e6cc536e3b7", "url": "https://github.com/eclipse/jetty.project/commit/0a699783e27e767d8130b10ac8cc9e6cc536e3b7", "message": "Issue #5095 XmlConfiguration locking  Use pool instead of static shared instance\n\nfixed javadoc", "committedDate": "2020-08-11T09:25:00Z", "type": "commit"}, {"oid": "66e988a25f470115a621ea00c544bfa5dd542492", "url": "https://github.com/eclipse/jetty.project/commit/66e988a25f470115a621ea00c544bfa5dd542492", "message": "Issue #5095 XmlConfiguration locking  Use pool instead of static shared instance\n\nupdates from review", "committedDate": "2020-08-11T10:23:07Z", "type": "commit"}]}