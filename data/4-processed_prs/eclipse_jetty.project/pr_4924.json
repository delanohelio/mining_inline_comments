{"pr_number": 4924, "pr_title": "Issue #4923 - restore caching of SSLSession information for SSL Attributes", "pr_createdAt": "2020-05-29T19:29:01Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4924", "timeline": [{"oid": "c1c2c07a5138d8ed8020d17ac07040f0666e5b89", "url": "https://github.com/eclipse/jetty.project/commit/c1c2c07a5138d8ed8020d17ac07040f0666e5b89", "message": "Issue #4923 - restore caching of SSLSession information for SSL Attributes\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-29T18:30:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMTg4Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432731887", "bodyText": "Please rename the class to SslSessionData, and everywhere \"info\" to \"data\". Drop Cached.\nAlso make everything private: fields, methods, etc.", "author": "sbordet", "createdAt": "2020-05-29T20:58:15Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +397,41 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession. Stores the\n+     * effective keySize and the client certificate chain.\n+     */\n+    private static class CachedSslSessionInfo", "originalCommit": "c1c2c07a5138d8ed8020d17ac07040f0666e5b89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDUxOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432744519", "bodyText": "Fixed.", "author": "joakime", "createdAt": "2020-05-29T21:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMTg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMjQ5MA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432732490", "bodyText": "Why Integer? Should be int.", "author": "sbordet", "createdAt": "2020-05-29T20:59:43Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +397,41 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession. Stores the\n+     * effective keySize and the client certificate chain.\n+     */\n+    private static class CachedSslSessionInfo\n+    {\n+        /**\n+         * The name of the SSLSession attribute that will contain any cached information.\n+         */\n+        public static final String ATTR = CachedSslSessionInfo.class.getName();\n+        private final X509Certificate[] _certs;\n+        private final Integer _keySize;\n+        private final String _idStr;\n+\n+        CachedSslSessionInfo(Integer keySize, X509Certificate[] certs, String idStr)", "originalCommit": "c1c2c07a5138d8ed8020d17ac07040f0666e5b89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0MTE3Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432741173", "bodyText": "Came from the old (9.4.28) CachedInfo.\n\n  \n    \n      jetty.project/jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java\n    \n    \n        Lines 360 to 387\n      in\n      ab228fd\n    \n    \n    \n    \n\n        \n          \n           private static class CachedInfo \n        \n\n        \n          \n           { \n        \n\n        \n          \n               private final X509Certificate[] _certs; \n        \n\n        \n          \n               private final Integer _keySize; \n        \n\n        \n          \n               private final String _idStr; \n        \n\n        \n          \n            \n        \n\n        \n          \n               CachedInfo(Integer keySize, X509Certificate[] certs, String idStr) \n        \n\n        \n          \n               { \n        \n\n        \n          \n                   this._keySize = keySize; \n        \n\n        \n          \n                   this._certs = certs; \n        \n\n        \n          \n                   this._idStr = idStr; \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               X509Certificate[] getCerts() \n        \n\n        \n          \n               { \n        \n\n        \n          \n                   return _certs; \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               Integer getKeySize() \n        \n\n        \n          \n               { \n        \n\n        \n          \n                   return _keySize; \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               String getIdStr() \n        \n\n        \n          \n               { \n        \n\n        \n          \n                   return _idStr; \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }", "author": "joakime", "createdAt": "2020-05-29T21:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMjQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDQ3MA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432744470", "bodyText": "Fixed", "author": "joakime", "createdAt": "2020-05-29T21:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMjQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMzMxNg==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432733316", "bodyText": "Keep field declarations in the same order as the constructor parameters and constructor assignments.", "author": "sbordet", "createdAt": "2020-05-29T21:01:36Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +397,41 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession. Stores the\n+     * effective keySize and the client certificate chain.\n+     */\n+    private static class CachedSslSessionInfo\n+    {\n+        /**\n+         * The name of the SSLSession attribute that will contain any cached information.\n+         */\n+        public static final String ATTR = CachedSslSessionInfo.class.getName();\n+        private final X509Certificate[] _certs;\n+        private final Integer _keySize;\n+        private final String _idStr;", "originalCommit": "c1c2c07a5138d8ed8020d17ac07040f0666e5b89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDY1OA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432744658", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-05-29T21:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczMzMxNg=="}], "type": "inlineReview"}, {"oid": "6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "url": "https://github.com/eclipse/jetty.project/commit/6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "message": "Issue #4923 - Applying changes requested in PR\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-29T21:30:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0OTIwNw==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432749207", "bodyText": "int, not Integer.", "author": "sbordet", "createdAt": "2020-05-29T21:42:48Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +400,40 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession.\n+     */\n+    private static class SslSessionData\n+    {\n+        /**\n+         * The name of the SSLSession attribute that will contain this information.\n+         */\n+        private static final String ATTR = SslSessionData.class.getName();\n+        private final Integer _keySize;", "originalCommit": "6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgyODYwMA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432828600", "bodyText": "Isn't Integer better here so it doesn't get boxed on every get?", "author": "gregw", "createdAt": "2020-05-30T10:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0OTIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgzMDg5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432830891", "bodyText": "Ah yes, Integer everywhere - I missed the boxing when returning the attribute, and the keySize values are not cached in Integer (only caches -128 to127).", "author": "sbordet", "createdAt": "2020-05-30T10:39:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0OTIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5OTc3NA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r433199774", "bodyText": "It's Integer everywhere now.", "author": "joakime", "createdAt": "2020-06-01T12:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0OTIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0OTkzMA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432749930", "bodyText": "Put this getter after getKeySize() to be consistent with ordering.", "author": "sbordet", "createdAt": "2020-05-29T21:43:27Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +400,40 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession.\n+     */\n+    private static class SslSessionData\n+    {\n+        /**\n+         * The name of the SSLSession attribute that will contain this information.\n+         */\n+        private static final String ATTR = SslSessionData.class.getName();\n+        private final Integer _keySize;\n+        private final X509Certificate[] _certs;\n+        private final String _idStr;\n+\n+        private SslSessionData(int keySize, X509Certificate[] certs, String idStr)\n+        {\n+            this._keySize = keySize;\n+            this._certs = certs;\n+            this._idStr = idStr;\n+        }\n+\n+        private X509Certificate[] getCerts()", "originalCommit": "6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5OTcwMw==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r433199703", "bodyText": "Moved.", "author": "joakime", "createdAt": "2020-06-01T12:15:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0OTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1MTA3OA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432751078", "bodyText": "information -> data", "author": "sbordet", "createdAt": "2020-05-29T21:44:27Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +400,40 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession.\n+     */\n+    private static class SslSessionData\n+    {\n+        /**\n+         * The name of the SSLSession attribute that will contain this information.", "originalCommit": "6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5OTY0Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r433199643", "bodyText": "This ATTR was removed.", "author": "joakime", "createdAt": "2020-06-01T12:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1MTA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1MTE3OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432751179", "bodyText": "information -> data", "author": "sbordet", "createdAt": "2020-05-29T21:44:33Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +400,40 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession.", "originalCommit": "6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5OTU4NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r433199585", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-06-01T12:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1MTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1MzQzNQ==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432753435", "bodyText": "This method is the only user of SslSessionData.ATTR.\nSo perhaps we don't need the constant in another class.\nWe can do at beginning of method:\nString key = SslSessionData.class.getName()\nand then use key where now we use ATTR.", "author": "sbordet", "createdAt": "2020-05-29T21:46:29Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -363,6 +362,30 @@ public Object getAttribute(String name)\n             return null;\n         }\n \n+        /**\n+         * Get data belonging to the {@link SSLSession}.\n+         *\n+         * @return the SslSessionData\n+         */\n+        private SslSessionData getSslSessionData()\n+        {\n+            SslSessionData sslSessionData = (SslSessionData)_session.getValue(SslSessionData.ATTR);\n+            if (sslSessionData == null)\n+            {\n+                String cipherSuite = _session.getCipherSuite();\n+                int keySize = SslContextFactory.deduceKeyLength(cipherSuite);\n+\n+                X509Certificate[] certs = getCertChain(_request.getHttpChannel().getConnector(), _session);\n+\n+                byte[] bytes = _session.getId();\n+                String idStr = TypeUtil.toHexString(bytes);\n+\n+                sslSessionData = new SslSessionData(keySize, certs, idStr);\n+                _session.putValue(SslSessionData.ATTR, sslSessionData);\n+            }\n+            return sslSessionData;", "originalCommit": "6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5OTQ5MA==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r433199490", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-06-01T12:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc1MzQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgyODY3MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r432828671", "bodyText": "If the _keySize is an Integer then return that here so it doesn't get unboxed and reboxed.\nUse int everywhere or Integer everywhere.", "author": "gregw", "createdAt": "2020-05-30T10:05:03Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/SecureRequestCustomizer.java", "diffHunk": "@@ -377,4 +400,40 @@ public Object getAttribute(String name)\n             return names;\n         }\n     }\n+\n+    /**\n+     * Simple bundle of information that is cached in the SSLSession.\n+     */\n+    private static class SslSessionData\n+    {\n+        /**\n+         * The name of the SSLSession attribute that will contain this information.\n+         */\n+        private static final String ATTR = SslSessionData.class.getName();\n+        private final Integer _keySize;\n+        private final X509Certificate[] _certs;\n+        private final String _idStr;\n+\n+        private SslSessionData(int keySize, X509Certificate[] certs, String idStr)\n+        {\n+            this._keySize = keySize;\n+            this._certs = certs;\n+            this._idStr = idStr;\n+        }\n+\n+        private X509Certificate[] getCerts()\n+        {\n+            return _certs;\n+        }\n+\n+        private int getKeySize()\n+        {\n+            return _keySize;", "originalCommit": "6a953e3a0e0c6a8db40f2a0cc1f56078fcf37457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5ODk5Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4924#discussion_r433198997", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-06-01T12:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgyODY3MQ=="}], "type": "inlineReview"}, {"oid": "b6d24c2396f71ce9420ac51f038fc4191cf4f487", "url": "https://github.com/eclipse/jetty.project/commit/b6d24c2396f71ce9420ac51f038fc4191cf4f487", "message": "Issue #4923 - Applying changes requested in PR\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-06-01T12:13:28Z", "type": "commit"}, {"oid": "f9b75ff1a30ba7ac88db529203f7b6520aa2692c", "url": "https://github.com/eclipse/jetty.project/commit/f9b75ff1a30ba7ac88db529203f7b6520aa2692c", "message": "Issue #4923 - Applying changes requested in PR\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-06-01T12:15:07Z", "type": "commit"}]}