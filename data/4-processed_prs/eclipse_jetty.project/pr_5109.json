{"pr_number": 5109, "pr_title": "Issue #5108 - improve scalability of WebSocket SessionTrackers", "pr_createdAt": "2020-08-03T01:34:23Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5109", "timeline": [{"oid": "d37501dce0c32c939dbe0cdb52fad37fac73c60a", "url": "https://github.com/eclipse/jetty.project/commit/d37501dce0c32c939dbe0cdb52fad37fac73c60a", "message": "Issue #5108 - use HashSet for SessionTrackers to improve scalability\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-03T00:40:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MzM4NA==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464243384", "bodyText": "Using a naked HashSet is way better than CopyOnWriteArraySet.\nHowever, I think you can do even better with Collections.newSetFromMap(new ConcurrentHashMap<>()).\nIn this way, we don't use a lock at all (as CHM will take care of that) and we don't need to do all the work that CopyOnWriteArraySet does.", "author": "sbordet", "createdAt": "2020-08-03T07:38:04Z", "path": "jetty-websocket/javax-websocket-client-impl/src/main/java/org/eclipse/jetty/websocket/jsr356/JsrSessionTracker.java", "diffHunk": "@@ -19,37 +19,47 @@\n package org.eclipse.jetty.websocket.jsr356;\n \n import java.util.Collections;\n+import java.util.HashSet;\n import java.util.Set;\n-import java.util.concurrent.CopyOnWriteArraySet;\n+import javax.websocket.Session;\n \n import org.eclipse.jetty.util.component.AbstractLifeCycle;\n import org.eclipse.jetty.util.component.LifeCycle;\n \n public class JsrSessionTracker extends AbstractLifeCycle implements JsrSessionListener\n {\n-    private CopyOnWriteArraySet<JsrSession> sessions = new CopyOnWriteArraySet<>();\n+    private final Set<JsrSession> sessions = new HashSet<>();", "originalCommit": "d37501dce0c32c939dbe0cdb52fad37fac73c60a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI1MDU2Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464250566", "bodyText": "This could work, then we would then return a live version of the set on getSessions() instead of a copy like we do with this and CopyOnWriteArraySet.\nI was thinking in the future we might need some sort of concurrent state in the SessionTracker, so that when it is being stopped we can make sure no more sessions are added. And for that we would need something like we have here with the synchronized blocks.", "author": "lachlan-roberts", "createdAt": "2020-08-03T07:53:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MzM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI1NDI4MA==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464254280", "bodyText": "@lachlan-roberts you can still return a copy of the list of sessions, to avoid that callers have a direct reference to it - we don't want them doing Session.getSessions().clear().\nSessionTracker is a child bean of ServerContainer or WebSocketClient, so when the container is stopped, no more sessions should be added and SessionTracker could be clear()ed, no?", "author": "sbordet", "createdAt": "2020-08-03T08:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MzM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI2MDM4MA==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464260380", "bodyText": "@sbordet not really,  in jetty-10 we try shut down the ServerContainer using Graceful and close all the open sessions, this is before the container has been stopped and we are still accepting new requests. See PR #4931.", "author": "lachlan-roberts", "createdAt": "2020-08-03T08:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MzM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI2NDU5Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464264593", "bodyText": "Don't worry this is an unrelated issue, I will make the changes you suggested an open an issue for this later.", "author": "lachlan-roberts", "createdAt": "2020-08-03T08:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MzM4NA=="}], "type": "inlineReview"}, {"oid": "85c4fc53350a8162496ed8c79dfc28215e5bb07e", "url": "https://github.com/eclipse/jetty.project/commit/85c4fc53350a8162496ed8c79dfc28215e5bb07e", "message": "Issue #5108 - use set based on ConcurrentHashMap and remove synchronized blocks\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-03T08:26:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzc1OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464313759", "bodyText": "while iterating over the set is thread safe, it doesn't prevent other sessions from being added while you are iterating.  So either you need to ensure that once you are stopping, new sessions can't be added, or you need some outer while (sessions.size()>0) loop.", "author": "gregw", "createdAt": "2020-08-03T09:56:17Z", "path": "jetty-websocket/javax-websocket-client-impl/src/main/java/org/eclipse/jetty/websocket/jsr356/JsrSessionTracker.java", "diffHunk": "@@ -49,7 +51,7 @@ public void onSessionClosed(JsrSession session)\n     @Override\n     protected void doStop() throws Exception\n     {\n-        for (JsrSession session : sessions)\n+        for (Session session : sessions)", "originalCommit": "85c4fc53350a8162496ed8c79dfc28215e5bb07e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQzNTkxMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464435911", "bodyText": "@gregw This is a pre-existing issue and not one that was created by this PR, so maybe better for a different PR. I have reopened #4919 for this issue as well.\nWhat do you think of an approach like this:\nhttps://gist.github.com/lachlan-roberts/6c52d13874628dd3ac5b5ecaaba91123", "author": "lachlan-roberts", "createdAt": "2020-08-03T14:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ5MTc0Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464491742", "bodyText": "That approach kind of invalidates this PR which is using a concurrent set and no locking, so really need an approach that works with concurrency... hence I think that it should be done as part of this PR.", "author": "gregw", "createdAt": "2020-08-03T15:33:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ5MjY4MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464492681", "bodyText": "I think that checking isRunning() before adding is OKish.... but a little racy... which might be able to be handled by again checking isRunning after adding and closing the session just added?", "author": "gregw", "createdAt": "2020-08-03T15:35:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyNDE4Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464524186", "bodyText": "@gregw I think @lachlan-roberts has a point.\nIf we will need to provide a patch to the sponsor, I would rather use the small patch that this PR proposes, rather than a larger patch also encompassing graceful shutdown which is orthogonal to this PR.", "author": "sbordet", "createdAt": "2020-08-03T16:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNTg0NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464925845", "bodyText": "OK - but let's not break the sponsor again with the other PR because the approach suggested was full of locks that could cause the problem again.", "author": "gregw", "createdAt": "2020-08-04T09:35:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzc1OQ=="}], "type": "inlineReview"}]}