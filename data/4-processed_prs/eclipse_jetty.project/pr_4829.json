{"pr_number": 4829, "pr_title": "Issue #4825 - Implement spec requirements for Request.newPushBuilder", "pr_createdAt": "2020-04-29T16:27:14Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4829", "timeline": [{"oid": "2fcf0fd8a7fa0d777d3a82961edaf3e404681c1b", "url": "https://github.com/eclipse/jetty.project/commit/2fcf0fd8a7fa0d777d3a82961edaf3e404681c1b", "message": "Issue #4825 Implement spec requirements for Request.newPushBuilder\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-04-29T11:08:46Z", "type": "commit"}, {"oid": "fa758c25e2f6895b97683874894e4958c8fbb251", "url": "https://github.com/eclipse/jetty.project/commit/fa758c25e2f6895b97683874894e4958c8fbb251", "message": "Issue #4825 Check method for PushBuilder.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-04-29T16:17:39Z", "type": "commit"}, {"oid": "40d316d11ea68989be1e11967673c07c1869f66f", "url": "https://github.com/eclipse/jetty.project/commit/40d316d11ea68989be1e11967673c07c1869f66f", "message": "Issue #4825 Add extra tests for PushBuilder method\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-04-29T16:26:31Z", "type": "commit"}, {"oid": "3fd71839e13738906cd64e63c487b4201c2a4d3f", "url": "https://github.com/eclipse/jetty.project/commit/3fd71839e13738906cd64e63c487b4201c2a4d3f", "message": "Issue #4825 Fix checkstyle problems\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-04-29T16:46:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU3MzcxNQ==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417573715", "bodyText": "Please make this field have the correct case (all upper case).", "author": "sbordet", "createdAt": "2020-04-29T19:56:29Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/PushBuilderImpl.java", "diffHunk": "@@ -39,6 +42,13 @@\n     private static final Logger LOG = LoggerFactory.getLogger(PushBuilderImpl.class);\n \n     private static final HttpField JettyPush = new HttpField(\"x-http2-push\", \"PushBuilder\");", "originalCommit": "3fd71839e13738906cd64e63c487b4201c2a4d3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU3Njk4NA==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417576984", "bodyText": "You can easily coalesce the null-check and the switch into a single if (header == SET_COOKIE).\nHow about SET_COOKIE2 (I'm ok to not consider it, just raising the issue of whether we want to explicitly not consider it).", "author": "sbordet", "createdAt": "2020-04-29T20:02:10Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -410,12 +416,55 @@ public PushBuilder newPushBuilder()\n             id = getRequestedSessionId();\n         }\n \n+        Map<String,String> cookies = new HashMap<>();\n+        Cookie[] existingCookies = getCookies();\n+        if (existingCookies != null)\n+        {        \n+            for (Cookie c: getCookies())\n+            {\n+                cookies.put(c.getName(), c.getValue());\n+            }\n+        }\n+\n+        //Any Set-Cookies that were set on the response must be set as Cookies on the\n+        //PushBuilder, unless the max-age of the cookie is <= 0\n+        HttpFields responseFields = getResponse().getHttpFields();\n+        for (HttpField field : responseFields)\n+        {\n+            HttpHeader header = field.getHeader();\n+            if (header == null)\n+                continue;\n+            switch (header)\n+            {\n+                case SET_COOKIE:", "originalCommit": "3fd71839e13738906cd64e63c487b4201c2a4d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYzODI4Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417638283", "bodyText": "Set-Cookie2 is an actual header from a valid spec.\nhttps://tools.ietf.org/html/rfc2965", "author": "joakime", "createdAt": "2020-04-29T22:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU3Njk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMDk5OA==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417600998", "bodyText": "I'm not sure handling these things at PushBuilder creation is the correct moment to do it.\nIs the TCK testing for this?\nI would rather add cookies, authorization headers, etc. just before the call to push(), to integrate also what the application is providing.\nFor example, if the application calls pushBuilder.addHeader(\"cookie\", \"a=b\") is it added to the ones computed above, or it replaces them, etc.?", "author": "sbordet", "createdAt": "2020-04-29T20:46:44Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -410,12 +416,55 @@ public PushBuilder newPushBuilder()\n             id = getRequestedSessionId();\n         }\n \n+        Map<String,String> cookies = new HashMap<>();\n+        Cookie[] existingCookies = getCookies();\n+        if (existingCookies != null)\n+        {        \n+            for (Cookie c: getCookies())\n+            {\n+                cookies.put(c.getName(), c.getValue());\n+            }\n+        }\n+\n+        //Any Set-Cookies that were set on the response must be set as Cookies on the\n+        //PushBuilder, unless the max-age of the cookie is <= 0\n+        HttpFields responseFields = getResponse().getHttpFields();\n+        for (HttpField field : responseFields)\n+        {\n+            HttpHeader header = field.getHeader();\n+            if (header == null)\n+                continue;\n+            switch (header)\n+            {\n+                case SET_COOKIE:\n+                {\n+                    HttpCookie cookie = ((SetCookieHttpField)field).getHttpCookie();\n+                    if (cookie.getMaxAge() > 0)\n+                        cookies.put(cookie.getName(), cookie.getValue());\n+                    else\n+                        cookies.remove(cookie.getName());\n+                    continue;\n+                }\n+                default:\n+                    continue;\n+            }\n+        }\n+        \n+        if (!cookies.isEmpty())\n+        {\n+            StringBuilder buff = new StringBuilder();\n+            for (Map.Entry<String,String> entry : cookies.entrySet())\n+            {\n+                if (buff.length() > 0)\n+                    buff.append(\"; \");\n+                buff.append(entry.getKey()).append('=').append(entry.getValue());\n+            }\n+            fields.add(new HttpField(HttpHeader.COOKIE, buff.toString()));\n+        }\n+        ", "originalCommit": "3fd71839e13738906cd64e63c487b4201c2a4d3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYyNzEyNg==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417627126", "bodyText": "But the tck test checks that the Cookie header is set on the PushBuilder before push() is called. See https://github.com/eclipse-ee4j/jakartaee-tck/blob/8.0.2/src/com/sun/ts/tests/servlet/spec/serverpush/TestServlet4.java#L48", "author": "janbartel", "createdAt": "2020-04-29T21:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMDk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY0MjI3Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417642276", "bodyText": "But the tck test checks that the Cookie header is set on the PushBuilder before push() is called.\n\nThat is so wrong.\nThen the application calls addHeader(\"Cookie\", ...) completely invalidating the fact that the Cookie header must be only one, so the server will complain that it found 2 Cookie headers.\nAlso, the application may mess with all other headers that you are trying to cope with here.\nI think all this should be done just before push().\nI would challenge the TCK test.", "author": "sbordet", "createdAt": "2020-04-29T22:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMDk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg3ODM1OA==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417878358", "bodyText": "I think servers are forgiving of multiple Cookie headers.  I know we are.\nI think it is reasonable that a pushed request has the same cookies as the source request and some of them may be beyond the knowledge of the app doing the push.\nThe builder is only setting the initial headers and the app is free to change them as it likes, so I think starting with the known cookies is reasonable.", "author": "gregw", "createdAt": "2020-04-30T09:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMDk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NTk2MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r418095961", "bodyText": "All right then.", "author": "sbordet", "createdAt": "2020-04-30T15:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMDk5OA=="}], "type": "inlineReview"}, {"oid": "087d91bd82c16fa42a37fa4d58fca0314552f54e", "url": "https://github.com/eclipse/jetty.project/commit/087d91bd82c16fa42a37fa4d58fca0314552f54e", "message": "Issue #4825 Changes after review\n\nSigned-off-by: Jan Bartel <janb@webtide.com>", "committedDate": "2020-04-29T21:43:31Z", "type": "commit"}]}