{"pr_number": 5634, "pr_title": "Review HTTP/2 GOAWAY handling", "pr_createdAt": "2020-11-10T09:10:42Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5634", "timeline": [{"oid": "62e17da2d02e41ee14148e4d324b60b546e836f3", "url": "https://github.com/eclipse/jetty.project/commit/62e17da2d02e41ee14148e4d324b60b546e836f3", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nMoved stream \"close\" event after returning from listener methods.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T08:56:32Z", "type": "commit"}, {"oid": "0dc28940021755f79afad9930cea6d0437f5199a", "url": "https://github.com/eclipse/jetty.project/commit/0dc28940021755f79afad9930cea6d0437f5199a", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nRefactored reset code in a single place: HTTP2Session.reset().\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T08:56:32Z", "type": "commit"}, {"oid": "206050df7ff2c8d8126310fdad1654a3204d7db4", "url": "https://github.com/eclipse/jetty.project/commit/206050df7ff2c8d8126310fdad1654a3204d7db4", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nRefactored push code in a single place: HTTP2Session.push().\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T08:56:32Z", "type": "commit"}, {"oid": "044052d717c070533493d8ba658a1d211dcc5630", "url": "https://github.com/eclipse/jetty.project/commit/044052d717c070533493d8ba658a1d211dcc5630", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nCode cleanups: removed unnecessary final modifiers and fixed code warnings.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T08:56:33Z", "type": "commit"}, {"oid": "226d616a8a257a711d354b229149207c6f655d2f", "url": "https://github.com/eclipse/jetty.project/commit/226d616a8a257a711d354b229149207c6f655d2f", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nReimplemented close/idle_timeout/stop/onGoAway/input_shutdown following more closely the specification.\n\nIn particular, the semantic of sending a GOAWAY is now to:\n* stop creation of new both local and remote streams\n* record the last processed stream\n* continue processing streams that are pending\n\nThis means that a GOAWAY is \"graceful\" in the sense that it allows for streams to be completed by applications.\n\nThe semantic of stop() and idle timeout is harsher: for pending streams a RST_STREAM is sent to the other peer and they are failed locally.\n\nAdded support for GOAWAY with 2^31-1 lastStreamId.\n\nAdded support for a peer to send and receive multiple GOAWAY frames.\n\nReviewed the stream creation/destruction mechanism so that when the last stream completes after a GOAWAY, proper actions can be run to tear down the connection.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T09:07:19Z", "type": "commit"}, {"oid": "1de622f72fdc315f610b8cebfa5dae716fe492b4", "url": "https://github.com/eclipse/jetty.project/commit/1de622f72fdc315f610b8cebfa5dae716fe492b4", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nUpdates after initial review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T14:25:44Z", "type": "commit"}, {"oid": "a02012fb3e3dcf8e10454843aa91ce21a6fb7626", "url": "https://github.com/eclipse/jetty.project/commit/a02012fb3e3dcf8e10454843aa91ce21a6fb7626", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nFixed logic in onShutdown(): in case of abort the closing action must be\nrun as callback, so it executes at the end of all the other callbacks.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T15:17:32Z", "type": "commit"}, {"oid": "298ddfd722a1aff207afe42f127adfa82a6e5634", "url": "https://github.com/eclipse/jetty.project/commit/298ddfd722a1aff207afe42f127adfa82a6e5634", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nFixed javadocs and TODOs.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-10T16:38:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1Mzg3MA==", "url": "https://github.com/eclipse/jetty.project/pull/5634#discussion_r521553870", "bodyText": "why were these removed?", "author": "gregw", "createdAt": "2020-11-11T18:23:24Z", "path": "jetty-http2/http2-client/src/main/java/org/eclipse/jetty/http2/client/HTTP2ClientConnectionFactory.java", "diffHunk": "@@ -92,20 +92,6 @@ private HTTP2ClientConnection(HTTP2Client client, ByteBufferPool byteBufferPool,\n             this.listener = listener;\n         }\n \n-        @Override\n-        public long getMessagesIn()\n-        {\n-            HTTP2ClientSession session = (HTTP2ClientSession)getSession();\n-            return session.getStreamsOpened();\n-        }\n-\n-        @Override\n-        public long getMessagesOut()\n-        {\n-            HTTP2ClientSession session = (HTTP2ClientSession)getSession();\n-            return session.getStreamsClosed();\n-        }\n-", "originalCommit": "298ddfd722a1aff207afe42f127adfa82a6e5634", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NTUyNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5634#discussion_r521555525", "bodyText": "comment is not correct as you are not directly closing.\nHow is onWriteFailure different to abort?", "author": "gregw", "createdAt": "2020-11-11T18:26:28Z", "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Flusher.java", "diffHunk": "@@ -365,7 +365,7 @@ protected void onCompleteFailure(Throwable x)\n         // If the failure came from within the\n         // flusher, we need to close the connection.\n         if (closed == null)\n-            session.abort(x);\n+            session.onWriteFailure(x);", "originalCommit": "298ddfd722a1aff207afe42f127adfa82a6e5634", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "96e4b38624a4288dc6d176aeead5cde470b3c63a", "url": "https://github.com/eclipse/jetty.project/commit/96e4b38624a4288dc6d176aeead5cde470b3c63a", "message": "Fixes #5633 - Allow to configure HttpClient request authority.\n\nFixed initial session recv window update: it was wrong if the initial value was less than the default value (65535).\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-12T16:13:17Z", "type": "commit"}, {"oid": "dd9bdc7ac376c19ffff6ff927b65c3781da7323c", "url": "https://github.com/eclipse/jetty.project/commit/dd9bdc7ac376c19ffff6ff927b65c3781da7323c", "message": "Fixes #5633 - Allow to configure HttpClient request authority.\n\nUpdated after review.\nAdded more tests.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-12T16:13:36Z", "type": "commit"}, {"oid": "4093af1824a4cad91c1777e8064cd88b92ba35c4", "url": "https://github.com/eclipse/jetty.project/commit/4093af1824a4cad91c1777e8064cd88b92ba35c4", "message": "Issue 5310 - Review HTTP/2 GOAWAY handling.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-18T11:03:35Z", "type": "commit"}]}