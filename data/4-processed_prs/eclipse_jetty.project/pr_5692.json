{"pr_number": 5692, "pr_title": "HttpInput may skip setting fill interest", "pr_createdAt": "2020-11-20T15:53:46Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5692", "timeline": [{"oid": "8edb5cfc24b344971d13bc526ab3f6d658893c53", "url": "https://github.com/eclipse/jetty.project/commit/8edb5cfc24b344971d13bc526ab3f6d658893c53", "message": "Issue #5691 - HttpInput may skip setting fill interest.\n\nCode cleanups and logging improvements.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-20T15:50:24Z", "type": "commit"}, {"oid": "4654335fdbcbb51e2f6981a556c9ab513d82135b", "url": "https://github.com/eclipse/jetty.project/commit/4654335fdbcbb51e2f6981a556c9ab513d82135b", "message": "Fixes #5691 - HttpInput may skip setting fill interest.\n\nHttpInput.run() now uses contentProvider.isReady() to ensure that\nif there is no content, the fill interest is set.\n\nAsyncContentProvider.isReady() is now looping if there is content\nbut it cannot be transformed (e.g. too few gzipped bytes).\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-20T15:52:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg4MjQ2Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r527882467", "bodyText": "I think this method is correct, but I think it would read better as:\npublic boolean isReady()\n{\n    HttpInput.Content content = nextTransformedContent();\n    if (content != null)\n    {\n        // TODO do we really need to call onContentAdded in this case??? I don't think so as we have not called onReadUnready\n        return true;\n    }\n            \n   _httpChannel.getState().onReadUnready();\n    while (_httpChannel.needContent())\n    {\n        HttpInput.Content content = nextTransformedContent();\n        if (content != null)\n        {\n            _httpChannel.getState().onContentAdded();\n            return true;\n        }\n        _httpChannel.getState().onReadUnready();\n    }\n\n    return false;\n}", "author": "gregw", "createdAt": "2020-11-20T18:04:59Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AsyncContentProducer.java", "diffHunk": "@@ -222,24 +222,39 @@ public boolean isReady()\n         if (content == null)\n         {\n             _httpChannel.getState().onReadUnready();\n-            if (_httpChannel.needContent())\n+            while (true)", "originalCommit": "4654335fdbcbb51e2f6981a556c9ab513d82135b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyODAyNA==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r528528024", "bodyText": "@gregw Regarding your TODO, yes you must call onContentAdded in this case. Imagine a servlet calling isReady twice. The first time false is returned but the 2nd time true is returned. If you do not call onContentAdded to switch the state to READY, it'll be stuck at UNREADY which will cause havoc.\nOh, and I also added in the javadoc of ContentProducer.isReady that After this call, state can be either of UNREADY or READY as the state cannot be left IDLE after isReady is called.", "author": "lorban", "createdAt": "2020-11-23T08:17:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg4MjQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzODMyOA==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r528538328", "bodyText": "@lorban But if isReady() has returned false, then regardless of it being called another time there is a scheduling action that will take place behind the scenes to make sure onDataAvailable is called when data becomes available.  Surely it is that action that will call onContentAdded.      Can you write a test case to demonstrate why this call is needed?", "author": "gregw", "createdAt": "2020-11-23T08:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg4MjQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMTEyMw==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r528721123", "bodyText": "I've opened #5704 to track this.", "author": "lorban", "createdAt": "2020-11-23T13:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg4MjQ2Nw=="}], "type": "inlineReview"}, {"oid": "a2c08188119456bd1d739505f3f487fd2eabf1d0", "url": "https://github.com/eclipse/jetty.project/commit/a2c08188119456bd1d739505f3f487fd2eabf1d0", "message": "Merged branch 'jetty-10.0.x' into 'jetty-10.0.x-5691-httpinput_skip_fill_interest'.", "committedDate": "2020-11-20T18:10:55Z", "type": "commit"}, {"oid": "1ac0af4a76a91b6b78627a37e772d51cabe7b363", "url": "https://github.com/eclipse/jetty.project/commit/1ac0af4a76a91b6b78627a37e772d51cabe7b363", "message": "Fixes #5691 - HttpInput may skip setting fill interest.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-11-21T15:40:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4MjYwNA==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r528582604", "bodyText": "Can you add a TODO here to review if this is needed.... or @lorban  can you open an issue to check.  Eitherway, is unrelated to this PR", "author": "gregw", "createdAt": "2020-11-23T09:55:37Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AsyncContentProducer.java", "diffHunk": "@@ -219,39 +219,43 @@ public void reclaim(HttpInput.Content content)\n     public boolean isReady()\n     {\n         HttpInput.Content content = nextTransformedContent();\n-        if (content == null)\n+        if (content != null)\n+        {\n+            if (LOG.isDebugEnabled())\n+                LOG.debug(\"isReady(), got transformed content {} {}\", content, this);\n+            _httpChannel.getState().onContentAdded();", "originalCommit": "1ac0af4a76a91b6b78627a37e772d51cabe7b363", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYyMjY1Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r528622653", "bodyText": "I suspect there's already enough coverage to tell us if omitting the onContentAdded() call here would fail anything, but it's an experiment we ought to do. I've opened #5704 to track this.", "author": "lorban", "createdAt": "2020-11-23T11:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4MjYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4MzczMg==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r528583732", "bodyText": "So @lorban just double checking that we don't need to call onReadUnready in the body of this loop.... because onContentAdded is not called if we loop.", "author": "gregw", "createdAt": "2020-11-23T09:57:22Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AsyncContentProducer.java", "diffHunk": "@@ -219,39 +219,43 @@ public void reclaim(HttpInput.Content content)\n     public boolean isReady()\n     {\n         HttpInput.Content content = nextTransformedContent();\n-        if (content == null)\n+        if (content != null)\n+        {\n+            if (LOG.isDebugEnabled())\n+                LOG.debug(\"isReady(), got transformed content {} {}\", content, this);\n+            _httpChannel.getState().onContentAdded();\n+            return true;\n+        }\n+\n+        _httpChannel.getState().onReadUnready();", "originalCommit": "1ac0af4a76a91b6b78627a37e772d51cabe7b363", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxNzE2NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5692#discussion_r528617165", "bodyText": "onReadUnready has no side effect, it only changes the state to UNREADY.\nWe have to be in UNREADY state before the call to needContent() if it ever returns false, but we do not need to if it returns true. So when needContent() returns true, the transition to UNREADY was unnecessary, but harmless as it gets changed to READY before any other thread can see the state.\nSo calling onReadUnready() in the loop is useless, we just need to make sure we're in UNREADY state before we call needContent() and we're good to go.", "author": "lorban", "createdAt": "2020-11-23T10:53:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4MzczMg=="}], "type": "inlineReview"}]}