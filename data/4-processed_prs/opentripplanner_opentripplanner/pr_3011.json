{"pr_number": 3011, "pr_title": "Otp2 redesign api modes", "pr_createdAt": "2020-03-19T14:19:40Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011", "timeline": [{"oid": "1bde95c009e9c454ca68e330439b6d239adc73bb", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/1bde95c009e9c454ca68e330439b6d239adc73bb", "message": "Move RoutingRequest to request package", "committedDate": "2020-03-19T12:26:43Z", "type": "commit"}, {"oid": "f209ddc23530595f68a5c4403df67f00672fb1db", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f209ddc23530595f68a5c4403df67f00672fb1db", "message": "Add AllowedModes class to RoutingRequest", "committedDate": "2020-03-19T13:49:45Z", "type": "commit"}, {"oid": "6a1be2c006a7e800e60536023b3a86c40b159563", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6a1be2c006a7e800e60536023b3a86c40b159563", "message": "Add AllowedModes to Transmodel API", "committedDate": "2020-03-19T13:50:38Z", "type": "commit"}, {"oid": "2d734688c5ec16961c5d1ed94397966ce83c5b56", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2d734688c5ec16961c5d1ed94397966ce83c5b56", "message": "Rename allowBikeRental to bikeRental on RoutingRequest", "committedDate": "2020-03-19T13:51:46Z", "type": "commit"}, {"oid": "ce156316b26c8d03440747e2f741a7fe23238b82", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ce156316b26c8d03440747e2f741a7fe23238b82", "message": "Extract DirectStreetRouter to its own class and refactor AccessEgress to use its own class", "committedDate": "2020-03-19T13:53:30Z", "type": "commit"}, {"oid": "0dd13284e889d3bd0432910a12d3b4f69e416e9b", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0dd13284e889d3bd0432910a12d3b4f69e416e9b", "message": "Add timeshift methods to Itinerary", "committedDate": "2020-03-19T13:54:03Z", "type": "commit"}, {"oid": "c31b93279a3ace6765a63078781a24da453268b8", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c31b93279a3ace6765a63078781a24da453268b8", "message": "Change TraverseMode to TransitMode in the transit model", "committedDate": "2020-03-19T15:46:54Z", "type": "commit"}, {"oid": "f517179facced4b83dd1115bd21be59d36ecf87a", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f517179facced4b83dd1115bd21be59d36ecf87a", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-03-23T09:15:08Z", "type": "commit"}, {"oid": "00e8d03bbe56b5a0f7038366430d9f5a70c2d534", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/00e8d03bbe56b5a0f7038366430d9f5a70c2d534", "message": "Best effort at mapping QualifiedModes to AllowedModes", "committedDate": "2020-03-23T10:54:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyMTk3NQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r397021975", "bodyText": "Expand javadoc to clarify the distinction between main request and subrequest modes.\nConsider renaming traversemodes to submodes and then rename AllowedModes to something like modes.", "author": "gmellemstrand", "createdAt": "2020-03-24T09:46:27Z", "path": "src/main/java/org/opentripplanner/routing/request/RoutingRequest.java", "diffHunk": "@@ -179,9 +179,23 @@\n     public boolean useRequestedDateTimeInMaxHours = false;\n ", "originalCommit": "f209ddc23530595f68a5c4403df67f00672fb1db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNzEwNQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r397027105", "bodyText": "Check that the correct heuristic is used for the direct street search", "author": "gmellemstrand", "createdAt": "2020-03-24T09:54:32Z", "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/router/street/DirectStreetRouter.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package org.opentripplanner.routing.algorithm.raptor.router.street;\n+\n+import org.opentripplanner.common.geometry.SphericalDistanceLibrary;\n+import org.opentripplanner.model.plan.Itinerary;\n+import org.opentripplanner.routing.algorithm.mapping.GraphPathToItineraryMapper;\n+import org.opentripplanner.routing.algorithm.mapping.ItinerariesHelper;\n+import org.opentripplanner.routing.error.PathNotFoundException;\n+import org.opentripplanner.routing.impl.GraphPathFinder;\n+import org.opentripplanner.routing.request.RoutingRequest;\n+import org.opentripplanner.routing.spt.GraphPath;\n+import org.opentripplanner.standalone.server.Router;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collections;\n+import java.util.List;\n+", "originalCommit": "ce156316b26c8d03440747e2f741a7fe23238b82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyNzI5OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r397127298", "bodyText": "EuclidianRemainingWeightHeuristic is used, so this should be ok.", "author": "gmellemstrand", "createdAt": "2020-03-24T12:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNzEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzMjU1Mw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r397032553", "bodyText": "The AllowedModes is not a good name. The Allowed does not not tell what this is, maybe RoutingRequestModes is better?", "author": "t2gran", "createdAt": "2020-03-24T10:02:51Z", "path": "src/main/java/org/opentripplanner/routing/request/AllowedModes.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package org.opentripplanner.routing.request;\n+\n+import org.opentripplanner.model.TransitMode;\n+\n+import java.util.Set;\n+\n+public class AllowedModes {", "originalCommit": "00e8d03bbe56b5a0f7038366430d9f5a70c2d534", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "739cf9c64b7b7615517547e63a47a361c1ebd9e1", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/739cf9c64b7b7615517547e63a47a361c1ebd9e1", "message": "Rename request modes/streetSubRequestModes parameters and expanded javadoc", "committedDate": "2020-03-24T12:54:48Z", "type": "commit"}, {"oid": "2424ab8aadeeb4333edb22f5afc5ad69138102ee", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2424ab8aadeeb4333edb22f5afc5ad69138102ee", "message": "Remove TraverseMode from REST API", "committedDate": "2020-03-24T13:35:03Z", "type": "commit"}, {"oid": "e2570de10fbb0a837b6cc313fa10e200e3f87000", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e2570de10fbb0a837b6cc313fa10e200e3f87000", "message": "Clean up the TraverseModeSet to not use string parameters in constructor", "committedDate": "2020-03-24T13:51:19Z", "type": "commit"}, {"oid": "d40f0c84e79126acd4d3c10bc5f1f877cffaac21", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d40f0c84e79126acd4d3c10bc5f1f877cffaac21", "message": "Change Qualifier enum to String", "committedDate": "2020-03-24T14:22:43Z", "type": "forcePushed"}, {"oid": "8033d37135b495f5226eff7ff75fb6de25196be2", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/8033d37135b495f5226eff7ff75fb6de25196be2", "message": "Change Qualifier enum to String", "committedDate": "2020-03-24T15:05:55Z", "type": "commit"}, {"oid": "eec7006e7902129351b1331ecf67ab152b6380ab", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/eec7006e7902129351b1331ecf67ab152b6380ab", "message": "Removed unused methods from RoutingRequest", "committedDate": "2020-03-24T15:27:51Z", "type": "commit"}, {"oid": "eec7006e7902129351b1331ecf67ab152b6380ab", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/eec7006e7902129351b1331ecf67ab152b6380ab", "message": "Removed unused methods from RoutingRequest", "committedDate": "2020-03-24T15:27:51Z", "type": "forcePushed"}, {"oid": "8208820b2eadcc908ef0ba0eca016f1ccae00055", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/8208820b2eadcc908ef0ba0eca016f1ccae00055", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-03-25T09:05:49Z", "type": "commit"}, {"oid": "0d182695cff5c8d0c14af5d4a98adacbfa29d8c1", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0d182695cff5c8d0c14af5d4a98adacbfa29d8c1", "message": "Make bikerental work as direct mode", "committedDate": "2020-03-25T11:18:02Z", "type": "commit"}, {"oid": "eab9599de7523277acd827b4fe3df6d4ead7ec26", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/eab9599de7523277acd827b4fe3df6d4ead7ec26", "message": "Update TODOs for StreetModes", "committedDate": "2020-03-25T12:27:42Z", "type": "commit"}, {"oid": "95493e9f7f86c2f801b271a071b894318785f7dd", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/95493e9f7f86c2f801b271a071b894318785f7dd", "message": "Street modes now work for access/egress", "committedDate": "2020-03-25T12:47:50Z", "type": "commit"}, {"oid": "4c3e96e587e8563d8438b5e27a6662a7de59a3f8", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/4c3e96e587e8563d8438b5e27a6662a7de59a3f8", "message": "Update TODOs on StreetMode", "committedDate": "2020-03-25T13:38:54Z", "type": "commit"}, {"oid": "62b8400bc26e71fdf101f845d497f44dda448f70", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/62b8400bc26e71fdf101f845d497f44dda448f70", "message": "Rename allowedModes to modes in Transmodel api", "committedDate": "2020-03-25T14:11:44Z", "type": "commit"}, {"oid": "0427e588adb35750583eea85be283dc28a9e4765", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0427e588adb35750583eea85be283dc28a9e4765", "message": "Rename AllowedModes class to RequestModes", "committedDate": "2020-03-25T14:23:59Z", "type": "commit"}, {"oid": "b9b8748405da45938dd8c025d2c960c650d82283", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b9b8748405da45938dd8c025d2c960c650d82283", "message": "Update TODO for QualifiedModeSet mapping", "committedDate": "2020-03-25T15:07:34Z", "type": "commit"}, {"oid": "b9b8748405da45938dd8c025d2c960c650d82283", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b9b8748405da45938dd8c025d2c960c650d82283", "message": "Update TODO for QualifiedModeSet mapping", "committedDate": "2020-03-25T15:07:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA5OTA1NA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r399099054", "bodyText": "We should do ApiMode mapping in one place.", "author": "t2gran", "createdAt": "2020-03-27T08:21:17Z", "path": "src/main/java/org/opentripplanner/api/model/ApiLeg.java", "diffHunk": "@@ -74,7 +72,7 @@\n      */\n     @XmlAttribute\n     @JsonSerialize\n-    public String mode = TraverseMode.WALK.toString();\n+    public String mode = \"WALK\";", "originalCommit": "b9b8748405da45938dd8c025d2c960c650d82283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4MjMxMw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r408682313", "bodyText": "This is a default value that are set on other fields in this class too. I have now changed it back to how it was, except using the api specific ApiRequestMode enum instead of TraverseMode.", "author": "gmellemstrand", "createdAt": "2020-04-15T08:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA5OTA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwMDU2Mw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r399100563", "bodyText": "Why is these methods removed? They are part of the API.", "author": "t2gran", "createdAt": "2020-03-27T08:24:23Z", "path": "src/main/java/org/opentripplanner/api/model/ApiLeg.java", "diffHunk": "@@ -240,35 +238,4 @@\n     @XmlAttribute\n     @JsonSerialize\n     public Boolean rentedBike;\n-\n-    /**\n-     * Whether this leg is a transit leg or not.\n-     * @return Boolean true if the leg is a transit leg\n-     */\n-    public Boolean isTransitLeg() {\n-        if (mode == null) return null;\n-        else if (mode.equals(TraverseMode.WALK.toString())) return false;\n-        else if (mode.equals(TraverseMode.CAR.toString())) return false;\n-        else if (mode.equals(TraverseMode.BICYCLE.toString())) return false;\n-        else return true;\n-    }\n-\n-    /**\n-     * The leg's duration in seconds\n-     */\n-    @XmlElement\n-    @JsonSerialize\n-    public double getDuration() {\n-        return endTime.getTimeInMillis()/1000.0 - startTime.getTimeInMillis()/1000.0;\n-    }\n-", "originalCommit": "b9b8748405da45938dd8c025d2c960c650d82283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMTIyOA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r399221228", "bodyText": "Added them back", "author": "gmellemstrand", "createdAt": "2020-03-27T12:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwMDU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDcyNg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r399104726", "bodyText": "Why is the Enum removed? It is part of the api and serve as documentation. We want to go in the directon of a more \"type-Safe\" direction, not the oposite way.", "author": "t2gran", "createdAt": "2020-03-27T08:32:59Z", "path": "src/main/java/org/opentripplanner/api/parameter/QualifiedMode.java", "diffHunk": "@@ -1,66 +1,35 @@\n package org.opentripplanner.api.parameter;\n \n import com.google.common.collect.Sets;\n-import org.opentripplanner.routing.core.RoutingRequest;\n-import org.opentripplanner.routing.core.TraverseMode;\n \n import java.io.Serializable;\n-import java.security.InvalidParameterException;\n import java.util.Set;\n \n public class QualifiedMode implements Serializable {\n     private static final long serialVersionUID = 1L;\n     \n-    public final TraverseMode mode;\n-    public final Set<Qualifier> qualifiers = Sets.newHashSet();\n+    public final String mode;\n+    public final Set<String> qualifiers = Sets.newHashSet();", "originalCommit": "b9b8748405da45938dd8c025d2c960c650d82283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4MjYzNw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r408682637", "bodyText": "I have now created new enums that are API specific and added back the type safety.", "author": "gmellemstrand", "createdAt": "2020-04-15T08:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE4NTQ3Mw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r399185473", "bodyText": "AtomicReferences imply multithreading access, use something else to achive the callback thing.", "author": "t2gran", "createdAt": "2020-03-27T11:00:42Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLPlanner.java", "diffHunk": "@@ -240,22 +240,24 @@ private RoutingRequest createRequest(DataFetchingEnvironment environment) {\n         }\n \n         if (hasArgument(environment, \"modes\")) {\n-            // Map modes to comma separated list in string first to be able to reuse logic in QualifiedModeSet\n-            // Remove CABLE_CAR from collection because QualifiedModeSet does not support mapping (splits on '_')\n-            Set<TraverseMode> modes = new HashSet<>(environment.getArgument(\"modes\"));\n-            boolean cableCar = modes.remove(TraverseMode.CABLE_CAR);\n-\n-            String modesAsString = modes.isEmpty() ? \"\" : Joiner.on(\",\").join(modes);\n-            if (!StringUtils.isEmpty(modesAsString)) {\n-                new QualifiedModeSet(modesAsString).applyToRoutingRequest(request);\n-                request.setModes(request.modes);\n-            } else if (cableCar) {\n-                // Clear default modes in case only cable car is selected\n-                request.clearModes();\n-            }\n+            AtomicReference<StreetMode> accessMode = new AtomicReference<>();\n+            AtomicReference<StreetMode> egressMode = new AtomicReference<>();\n+            AtomicReference<StreetMode> directMode = new AtomicReference<>();\n+            AtomicReference<ArrayList<TransitMode>> transitModes = new AtomicReference<>();", "originalCommit": "b9b8748405da45938dd8c025d2c960c650d82283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODczODkzMA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r408738930", "bodyText": "Changed to a simple wrapper instead, to make it clearer.", "author": "gmellemstrand", "createdAt": "2020-04-15T10:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE4NTQ3Mw=="}], "type": "inlineReview"}, {"oid": "6a938dda32c709a937a6c7ff1ed094911ee272c4", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6a938dda32c709a937a6c7ff1ed094911ee272c4", "message": "Reverse remove methods from ApiLeg", "committedDate": "2020-03-27T12:42:29Z", "type": "forcePushed"}, {"oid": "de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "message": "Reverse remove methods from ApiLeg", "committedDate": "2020-03-27T12:45:27Z", "type": "commit"}, {"oid": "de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "message": "Reverse remove methods from ApiLeg", "committedDate": "2020-03-27T12:45:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzMDI1MQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r407230251", "bodyText": "Collections.emptySet returns an immutable set, which makes Set#add used below throw a NPE.", "author": "hannesj", "createdAt": "2020-04-12T17:42:47Z", "path": "src/main/java/org/opentripplanner/api/parameter/QualifiedModeSet.java", "diffHunk": "@@ -29,32 +33,103 @@ public QualifiedModeSet(String s) {\n         }\n     }\n \n-    /**\n-     * Modify an existing routing request, setting fields to reflect these qualified modes.\n-     * This is intended as a temporary solution, and uses the current system of a single mode set,\n-     * accompanied by some flags to help with routing.\n-     */\n-    public void applyToRoutingRequest(RoutingRequest req) {\n+    public RequestModes getRequestModes() {\n+        RequestModes requestModes = new RequestModes(\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            Collections.emptySet()", "originalCommit": "de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzMDQ4Ng==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r407230486", "bodyText": "break is missing here", "author": "hannesj", "createdAt": "2020-04-12T17:44:53Z", "path": "src/main/java/org/opentripplanner/api/parameter/QualifiedModeSet.java", "diffHunk": "@@ -29,32 +33,103 @@ public QualifiedModeSet(String s) {\n         }\n     }\n \n-    /**\n-     * Modify an existing routing request, setting fields to reflect these qualified modes.\n-     * This is intended as a temporary solution, and uses the current system of a single mode set,\n-     * accompanied by some flags to help with routing.\n-     */\n-    public void applyToRoutingRequest(RoutingRequest req) {\n+    public RequestModes getRequestModes() {\n+        RequestModes requestModes = new RequestModes(\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            Collections.emptySet()\n+        );\n \n-        if (qModes.isEmpty()) return;\n+        if (qModes.isEmpty()) return requestModes;\n \n-        /* Start with an empty mode set. */\n-        TraverseModeSet modes = new TraverseModeSet();\n-        req.setModes(modes);\n-        \n-        /* First, copy over all the unqualified modes and see if we are using transit. FIXME HACK */\n+        // Set transit modes\n         for (QualifiedMode qMode : qModes) {\n-            modes.setMode(qMode.mode, true);\n+             switch (qMode.mode) {\n+                 case \"RAIL\":\n+                     requestModes.transitModes.add(TransitMode.RAIL);\n+                     break;\n+                 case \"SUBWAY\":\n+                     requestModes.transitModes.add(TransitMode.SUBWAY);\n+                     break;\n+                 case \"BUS\":\n+                     requestModes.transitModes.add(TransitMode.BUS);\n+                     break;\n+                 case \"TRAM\":\n+                     requestModes.transitModes.add(TransitMode.TRAM);\n+                     break;\n+                 case \"FERRY\":\n+                     requestModes.transitModes.add(TransitMode.FERRY);\n+                     break;\n+                 case \"AIRPLANE\":\n+                     requestModes.transitModes.add(TransitMode.AIRPLANE);\n+                     break;\n+                 case \"CABLE_CAR\":\n+                     requestModes.transitModes.add(TransitMode.CABLE_CAR);", "originalCommit": "de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzMDg5OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r407230898", "bodyText": "Shouldn't this have the default values for transit modes added, now there is no transit modes by default.", "author": "hannesj", "createdAt": "2020-04-12T17:48:11Z", "path": "src/main/java/org/opentripplanner/api/parameter/QualifiedModeSet.java", "diffHunk": "@@ -29,32 +33,103 @@ public QualifiedModeSet(String s) {\n         }\n     }\n \n-    /**\n-     * Modify an existing routing request, setting fields to reflect these qualified modes.\n-     * This is intended as a temporary solution, and uses the current system of a single mode set,\n-     * accompanied by some flags to help with routing.\n-     */\n-    public void applyToRoutingRequest(RoutingRequest req) {\n+    public RequestModes getRequestModes() {\n+        RequestModes requestModes = new RequestModes(\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            Collections.emptySet()\n+        );\n \n-        if (qModes.isEmpty()) return;\n+        if (qModes.isEmpty()) return requestModes;", "originalCommit": "de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2MjUyMg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r408662522", "bodyText": "I haven't looked into how the REST api works in detail, it seems sensible to have it work that way. I am changing it to have a check in the RoutingResource to only set the modes if qModes is not empty. Otherwise it will use the modes from the default RoutingRequest.", "author": "gmellemstrand", "createdAt": "2020-04-15T08:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzMDg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzMDk2MA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r407230960", "bodyText": "This adds all transit modes, when a street-only search is made", "author": "hannesj", "createdAt": "2020-04-12T17:48:34Z", "path": "src/main/java/org/opentripplanner/api/parameter/QualifiedModeSet.java", "diffHunk": "@@ -29,32 +33,103 @@ public QualifiedModeSet(String s) {\n         }\n     }\n \n-    /**\n-     * Modify an existing routing request, setting fields to reflect these qualified modes.\n-     * This is intended as a temporary solution, and uses the current system of a single mode set,\n-     * accompanied by some flags to help with routing.\n-     */\n-    public void applyToRoutingRequest(RoutingRequest req) {\n+    public RequestModes getRequestModes() {\n+        RequestModes requestModes = new RequestModes(\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            StreetMode.WALK,\n+            Collections.emptySet()\n+        );\n \n-        if (qModes.isEmpty()) return;\n+        if (qModes.isEmpty()) return requestModes;\n \n-        /* Start with an empty mode set. */\n-        TraverseModeSet modes = new TraverseModeSet();\n-        req.setModes(modes);\n-        \n-        /* First, copy over all the unqualified modes and see if we are using transit. FIXME HACK */\n+        // Set transit modes\n         for (QualifiedMode qMode : qModes) {\n-            modes.setMode(qMode.mode, true);\n+             switch (qMode.mode) {\n+                 case \"RAIL\":\n+                     requestModes.transitModes.add(TransitMode.RAIL);\n+                     break;\n+                 case \"SUBWAY\":\n+                     requestModes.transitModes.add(TransitMode.SUBWAY);\n+                     break;\n+                 case \"BUS\":\n+                     requestModes.transitModes.add(TransitMode.BUS);\n+                     break;\n+                 case \"TRAM\":\n+                     requestModes.transitModes.add(TransitMode.TRAM);\n+                     break;\n+                 case \"FERRY\":\n+                     requestModes.transitModes.add(TransitMode.FERRY);\n+                     break;\n+                 case \"AIRPLANE\":\n+                     requestModes.transitModes.add(TransitMode.AIRPLANE);\n+                     break;\n+                 case \"CABLE_CAR\":\n+                     requestModes.transitModes.add(TransitMode.CABLE_CAR);\n+                 case \"GONDOLA\":\n+                     requestModes.transitModes.add(TransitMode.GONDOLA);\n+                     break;\n+                 case \"FUNICULAR\":\n+                     requestModes.transitModes.add(TransitMode.FUNICULAR);\n+                     break;\n+             }\n         }\n-        boolean usingTransit = modes.isTransit();\n-        \n-        // We used to always set WALK to true, but this forced walking when someone wanted to use a bike.\n-        // We also want it to be possible to force biking-only (e.g. this is done in some consistency tests).\n-        // TODO clearly define mode semantics: does presence of mode mean it is allowable, preferred... ?\n \n+        if (requestModes.transitModes.isEmpty()) {\n+            requestModes.transitModes = new HashSet<>(Arrays.asList(TransitMode.values()));", "originalCommit": "de93cb9cc98836e57dd1e3e19d1e345a54a3b10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NTEzOA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r408665138", "bodyText": "I will change this. Feel free to change this mapping further, as we are not testing the REST API at Entur and in some cases we do not know the intended functionality.", "author": "gmellemstrand", "createdAt": "2020-04-15T08:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzMDk2MA=="}], "type": "inlineReview"}, {"oid": "ef2824212dc845bfe451b48a12b89f2c856c933e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ef2824212dc845bfe451b48a12b89f2c856c933e", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-04-14T13:46:05Z", "type": "commit"}, {"oid": "147f926bf60fa9970a2fce099219a5dd512c5857", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/147f926bf60fa9970a2fce099219a5dd512c5857", "message": "Changes to REST API suggested by hannesj", "committedDate": "2020-04-15T08:27:08Z", "type": "commit"}, {"oid": "147f926bf60fa9970a2fce099219a5dd512c5857", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/147f926bf60fa9970a2fce099219a5dd512c5857", "message": "Changes to REST API suggested by hannesj", "committedDate": "2020-04-15T08:27:08Z", "type": "forcePushed"}, {"oid": "e34459cee54c8f6c7fbf8cfb35b9a880397d4060", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e34459cee54c8f6c7fbf8cfb35b9a880397d4060", "message": "Changed REST API modes back to enums, but created new api enums separated from the internal model", "committedDate": "2020-04-15T08:50:36Z", "type": "commit"}, {"oid": "e34459cee54c8f6c7fbf8cfb35b9a880397d4060", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e34459cee54c8f6c7fbf8cfb35b9a880397d4060", "message": "Changed REST API modes back to enums, but created new api enums separated from the internal model", "committedDate": "2020-04-15T08:50:36Z", "type": "forcePushed"}, {"oid": "06c077a984e1147fb2f11cae678554b78cd65324", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/06c077a984e1147fb2f11cae678554b78cd65324", "message": "Replace AtomicReference with a simple wrapper", "committedDate": "2020-04-15T09:43:23Z", "type": "commit"}, {"oid": "084199406fc7679863194670ec18682c57bd89f2", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/084199406fc7679863194670ec18682c57bd89f2", "message": "Clean up APIs and added support for not using access/egress", "committedDate": "2020-04-15T12:52:44Z", "type": "commit"}, {"oid": "d44dc936a2ff2cf42b29c33c2d44d4c6f376ee58", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d44dc936a2ff2cf42b29c33c2d44d4c6f376ee58", "message": "Update migration guide", "committedDate": "2020-04-15T13:25:32Z", "type": "commit"}, {"oid": "758ae1a55bafd6a0cee26ae038f53450bd14375a", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/758ae1a55bafd6a0cee26ae038f53450bd14375a", "message": "Set default RequestModes in RoutingRequest constructor", "committedDate": "2020-04-15T14:02:45Z", "type": "commit"}, {"oid": "781d046cb4487f0d716ce68a441c109c10e1966c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/781d046cb4487f0d716ce68a441c109c10e1966c", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-04-15T14:08:43Z", "type": "commit"}, {"oid": "a699b54028a575d119f86c7dffa28716257daf92", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a699b54028a575d119f86c7dffa28716257daf92", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-04-16T07:03:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM3NDcxNA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409374714", "bodyText": "These should be uppercase, or checked against the enum values themselves", "author": "hannesj", "createdAt": "2020-04-16T08:27:43Z", "path": "src/main/java/org/opentripplanner/api/model/ApiLeg.java", "diffHunk": "@@ -247,9 +247,9 @@\n      */\n     public Boolean isTransitLeg() {\n         if (mode == null) return null;\n-        else if (mode.equals(TraverseMode.WALK.toString())) return false;\n-        else if (mode.equals(TraverseMode.CAR.toString())) return false;\n-        else if (mode.equals(TraverseMode.BICYCLE.toString())) return false;\n+        else if (mode.equals(\"Walk\")) return false;", "originalCommit": "a699b54028a575d119f86c7dffa28716257daf92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5NDU0NQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409394545", "bodyText": "This should be fixed when merging with #3031, as it separates out the TraverseMode enum to a new REST API version.", "author": "gmellemstrand", "createdAt": "2020-04-16T08:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM3NDcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxMjUxMQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409612511", "bodyText": "This has been fixed now.", "author": "gmellemstrand", "createdAt": "2020-04-16T14:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM3NDcxNA=="}], "type": "inlineReview"}, {"oid": "555ac31a1f5e33ea485f314cb3da7530015a2ecb", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/555ac31a1f5e33ea485f314cb3da7530015a2ecb", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-04-16T11:16:10Z", "type": "commit"}, {"oid": "d6fb26973ab25c33d617fef24a602b3af626b76c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d6fb26973ab25c33d617fef24a602b3af626b76c", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-04-16T11:16:34Z", "type": "commit"}, {"oid": "874636249afd059e30b90d453178079ec77c98c2", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/874636249afd059e30b90d453178079ec77c98c2", "message": "Added changelog entry", "committedDate": "2020-04-16T11:18:36Z", "type": "commit"}, {"oid": "fdb66a66ee68f12776d96d559414dcd80c99d7a1", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/fdb66a66ee68f12776d96d559414dcd80c99d7a1", "message": "Fix check for transit modes specified before routing transit", "committedDate": "2020-04-16T12:10:10Z", "type": "commit"}, {"oid": "aea244f4ebd831185e0a778c3ae534a94a45cb26", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/aea244f4ebd831185e0a778c3ae534a94a45cb26", "message": "Make fields on InspectorLayer class public to allow json serialization", "committedDate": "2020-04-16T12:54:43Z", "type": "commit"}, {"oid": "5be0c4710e59c6f8dbf16c50db1d3862bb772dc7", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/5be0c4710e59c6f8dbf16c50db1d3862bb772dc7", "message": "Fix check on access/egress mode supported", "committedDate": "2020-04-16T13:32:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1ODgyOA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409058828", "bodyText": "This document is about \"what you have to do if you are using the REST API\", but the above description say no changes. Maybe there is something that was allowed before that does not work now or is there a limited set of combinations? Maybe some combinations map into a given set of mode transitions?", "author": "t2gran", "createdAt": "2020-04-15T18:47:42Z", "path": "docs/OTP2-MigrationGuide.md", "diffHunk": "@@ -30,6 +30,9 @@ These properties changed names from:\n  - `searchWindow` Limit the departure window or arrival window for the routing search.\n  - `boardSlackByMode` How much time boarding a vehicle takes for each given mode.\n  - `alightSlackByMode` How much time alighting a vehicle takes for each given mode.\n+ - `modes` You now have to specify access/egress/direct/transit modes separately. This gives more\n+ fine-grained control of the results. The REST api is unchanged, but is mapped into this structure.\n+ The sandbox Transmodel API allows you to specify the structure directly.", "originalCommit": "781d046cb4487f0d716ce68a441c109c10e1966c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYxOTAzMQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409619031", "bodyText": "I didn't catch that the migration guide was only for the REST API. I will update the description. There are no changes to the REST api itself, but there are changes to the underlying functionality.", "author": "gmellemstrand", "createdAt": "2020-04-16T14:50:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1ODgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyNDE0Mg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409624142", "bodyText": "I see now that it has a heading that says RoutingRequest changes, which is not directly part of the REST API, as it is mapped from the RoutingResource. If the document is intended only for the REST API, maybe the heading should be RoutingResource changes, and that is not changed.", "author": "gmellemstrand", "createdAt": "2020-04-16T14:56:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1ODgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1MTg0NA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r410151844", "bodyText": "I will clarify the doc later, but yes the doc talk only about the REST API and the  RoutingRequest refer to the query parameters on the RoutingService. The target user of the document is a Client developer.", "author": "t2gran", "createdAt": "2020-04-17T11:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1ODgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1MjIxMQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r410152211", "bodyText": "The Transmodel API do not exist in OTP1 so there is no migration guide for that.", "author": "t2gran", "createdAt": "2020-04-17T11:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1ODgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1Mzk3OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r410153978", "bodyText": "That's true. I have changed the documentation to only refer to changes in the REST API.", "author": "gmellemstrand", "createdAt": "2020-04-17T11:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1ODgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDM5MA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409060390", "bodyText": "The GtfsLibrary should operate on the GTFS import, not on the internal model. I have refactored already this in PR #3031.", "author": "t2gran", "createdAt": "2020-04-15T18:50:20Z", "path": "src/ext/java/org/opentripplanner/ext/siri/SiriFuzzyTripMatcher.java", "diffHunk": "@@ -344,7 +344,7 @@ public FeedScopedId getTripId(String vehicleJourney) {\n \n         List<FeedScopedId> matches = new ArrayList<>();\n         for (Trip trip : cachedTripsBySiriId) {\n-            if (GtfsLibrary.getTraverseMode(trip.getRoute()).equals(traverseMode)\n+            if (GtfsLibrary.getTransitMode(trip.getRoute()).equals(traverseMode)", "originalCommit": "781d046cb4487f0d716ce68a441c109c10e1966c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyMDY3OQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r409620679", "bodyText": "This was fixed in the merge", "author": "gmellemstrand", "createdAt": "2020-04-16T14:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDM5MA=="}], "type": "inlineReview"}, {"oid": "d4a422de2bfc0c887da67030aa4be835cdaf538e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d4a422de2bfc0c887da67030aa4be835cdaf538e", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-04-17T09:07:28Z", "type": "commit"}, {"oid": "e87430a60db59397f29c7b4d935bc6aaa6599d23", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e87430a60db59397f29c7b4d935bc6aaa6599d23", "message": "Remove references to the transmodel api in the migration guide", "committedDate": "2020-04-17T11:07:24Z", "type": "commit"}, {"oid": "50c862cf2daec95575d67c76da7d511522e79165", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/50c862cf2daec95575d67c76da7d511522e79165", "message": "Merge branch 'otp2_redesign_api_modes' of github.com:entur/OpenTripPlanner into otp2_redesign_api_modes", "committedDate": "2020-04-17T11:08:07Z", "type": "commit"}, {"oid": "c1c867b0c5d44f2a3cb5839beec2e2aec041ecb5", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c1c867b0c5d44f2a3cb5839beec2e2aec041ecb5", "message": "Allow bicycle as access/egress, transfers will still be walk-only", "committedDate": "2020-04-17T11:21:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5MDU2NQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r410190565", "bodyText": "I do not like the fact that there is a chose of either access/transit/egress or direct, but as long as everyone (Mads) understand that this is a first try and that we will redesign this later i am ok with it. But, we will do this differently when migrating to a schema based API. This is OK for now.", "author": "t2gran", "createdAt": "2020-04-17T12:31:33Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelIndexGraphQLSchema.java", "diffHunk": "@@ -469,6 +477,41 @@ public TransmodelIndexGraphQLSchema(Graph graph, RoutingRequest defaultRequest)\n                         .build())\n                 .build();\n \n+        modesInputType = GraphQLInputObjectType.newInputObject()\n+            .name(\"Modes\")\n+            .description(\"Input format for specifying which modes will be allowed for this search. \"\n+                + \"If this element is not present, it will default to accessMode/egressMode/directMode \"\n+                + \"of foot and all transport modes will be allowed.\")\n+            .field(GraphQLInputObjectField.newInputObjectField()\n+                .name(\"accessMode\")\n+                .description(\"The mode used to get from the origin to the access stops in the transit \"\n+                    + \"network the transit network (first-mile). If the element is not present or null,\"\n+                    + \"only transit that can be immediately boarded from the origin will be used.\")\n+                .type(STREET_MODE)\n+                .build())\n+            .field(GraphQLInputObjectField.newInputObjectField()\n+                .name(\"egressMode\")\n+                .description(\"The mode used to get from the egress stops in the transit network to\"\n+                    + \"the destination (last-mile). If the element is not present or null,\"\n+                    + \"only transit that can immediately arrive at the origin will be used.\")\n+                .type(STREET_MODE)\n+                .build())\n+            .field(GraphQLInputObjectField.newInputObjectField()\n+                .name(\"directMode\")\n+                .description(\"The mode used to get from the origin to the destination directly, \"\n+                    + \"without using the transit network. If the element is not present or null,\"\n+                    + \"direct travel without using transit will be disallowed.\")\n+                .type(STREET_MODE)\n+                .build())\n+            .field(GraphQLInputObjectField.newInputObjectField()\n+                .name(\"transportMode\")\n+                .description(\"The allowed modes for the transit part of the trip. Use an empty list \"\n+                    + \"to disallow transit for this search. If the element is not present or null, \"\n+                    + \"it will default to all transport modes.\")\n+                .type(new GraphQLList(TRANSPORT_MODE))\n+                .build())\n+            .build();\n+", "originalCommit": "c1c867b0c5d44f2a3cb5839beec2e2aec041ecb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI1MjY3Nw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r411252677", "bodyText": "We are not really choosing either or, but both can be specified. What is kind of odd about this structure is that access/egress/transit are tied together, but direct is its own search.", "author": "gmellemstrand", "createdAt": "2020-04-20T10:02:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5MDU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5NDY0MQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r410194641", "bodyText": "We try to keep all lines 100 characters wide, but I am not sure if we should apply it on markdown files. From what I see in the IDE and here on GitHub, it probably better to not do it (both wraps nicely, and Intelij do NOT wrap lines when I try to do auto reformatting). You can do as you like on this one, but we should state something in the developer guideline - I will do that.", "author": "t2gran", "createdAt": "2020-04-17T12:39:43Z", "path": "docs/OTP2-MigrationGuide.md", "diffHunk": "@@ -32,6 +32,7 @@ These properties changed names from:\n  - `searchWindow` Limit the departure window or arrival window for the routing search.\n  - `boardSlackByMode` How much time boarding a vehicle takes for each given mode.\n  - `alightSlackByMode` How much time alighting a vehicle takes for each given mode.\n+ - `modes` The REST API is unchanged, but is mapped into a new structure in the RoutingRequest. This means not all combinations of non-transit modes that was available in OTP1 is available in OTP2.", "originalCommit": "c1c867b0c5d44f2a3cb5839beec2e2aec041ecb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MTI5OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r410371298", "bodyText": "This breaks arriveBy-searches, as orginVertices get set to from on row 145. Either the direction of the routingRequest should be always forward, or the originVertives should be set in to and not from parameter in setRoutingContext .", "author": "hannesj", "createdAt": "2020-04-17T17:36:38Z", "path": "src/main/java/org/opentripplanner/graph_builder/module/NearbyStopFinder.java", "diffHunk": "@@ -138,16 +139,16 @@ public NearbyStopFinder(Graph graph, double radiusMeters, boolean useStreets) {\n     public List<StopAtDistance> findNearbyStopsViaStreets (\n             Set<Vertex> originVertices,\n             boolean reverseDirection,\n-            boolean removeTempEdges\n+            boolean removeTempEdges,\n+            RoutingRequest routingRequest", "originalCommit": "c1c867b0c5d44f2a3cb5839beec2e2aec041ecb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI0NTY3Mw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r411245673", "bodyText": "I have investigated this. What we want is for the access search to always be a forward search, while the egress search should always be an arriveBy search, regardless of the main search being arriveBy or not. The direct street search, however, should be based on whether the main RoutingRequest is arriveBy or not.\nI have pushed a fix with a TODO in the AccessEgressRouter. This gets a bit messy because we have not separated the main search from the street sub search, and it also ties into how the RoutingContext is created. It works now, cleaning up the request structure is something we should do soon.", "author": "gmellemstrand", "createdAt": "2020-04-20T09:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MTI5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NTcwNQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3011#discussion_r411355705", "bodyText": "This seems to be fixed now", "author": "hannesj", "createdAt": "2020-04-20T12:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MTI5OA=="}], "type": "inlineReview"}, {"oid": "a8f9848aacd7caf26350101aa926c86971cee99c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a8f9848aacd7caf26350101aa926c86971cee99c", "message": "Fix arriveBy searches", "committedDate": "2020-04-20T09:48:10Z", "type": "commit"}, {"oid": "d5592b56b6da229a81588008dc52d22574124782", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d5592b56b6da229a81588008dc52d22574124782", "message": "Merge branch 'dev-2.x' into otp2_redesign_api_modes", "committedDate": "2020-04-20T11:18:53Z", "type": "commit"}, {"oid": "6973b00479ad60441dce7d9ebb9b48c5583af0b6", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6973b00479ad60441dce7d9ebb9b48c5583af0b6", "message": "Do not use arriveBy setting from main request when re-traversing edges in itinerary mapper", "committedDate": "2020-04-20T11:36:16Z", "type": "commit"}]}