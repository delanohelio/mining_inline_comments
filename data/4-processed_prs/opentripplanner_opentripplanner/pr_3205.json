{"pr_number": 3205, "pr_title": "Realtime updater optimisations and fixes", "pr_createdAt": "2020-10-05T08:43:30Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205", "timeline": [{"oid": "55c9df3dccce8eb27caa442d886115b6b93b4861", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/55c9df3dccce8eb27caa442d886115b6b93b4861", "message": "Keep generated id on TripPattern, the equals method is based only on matching ids", "committedDate": "2020-10-05T07:23:48Z", "type": "commit"}, {"oid": "3ee03a730c5992f80301488a2df3455a3240c513", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3ee03a730c5992f80301488a2df3455a3240c513", "message": "Purge data only if we have changed date", "committedDate": "2020-10-05T07:23:48Z", "type": "commit"}, {"oid": "64197c0ed66290884c6ab81f725e1b9fe698f939", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/64197c0ed66290884c6ab81f725e1b9fe698f939", "message": "Update Changelog.md", "committedDate": "2020-10-05T07:23:48Z", "type": "commit"}, {"oid": "16c031b5ff80729111eb04c8f015276abfc59128", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/16c031b5ff80729111eb04c8f015276abfc59128", "message": "Add patterns to patternsForStop only if they are coming from real-time updates", "committedDate": "2020-10-05T07:23:48Z", "type": "commit"}, {"oid": "ae82e4ead75ab2fd62b777e4c2585437fcb0e167", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ae82e4ead75ab2fd62b777e4c2585437fcb0e167", "message": "Re-use previous servicesRunningForDate if on the same date", "committedDate": "2020-10-05T07:23:48Z", "type": "commit"}, {"oid": "8363f047c17a3bd30fbd8783a9895fee5b843bfd", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/8363f047c17a3bd30fbd8783a9895fee5b843bfd", "message": "Force usage of SetMultimap, in order to not insert the same TripPattern more than once", "committedDate": "2020-10-05T07:23:48Z", "type": "commit"}, {"oid": "5939c9d1d0629940b35ddbecc943c01f233e31d9", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/5939c9d1d0629940b35ddbecc943c01f233e31d9", "message": "Move expensive calculation of midnight outside loop", "committedDate": "2020-10-05T07:23:48Z", "type": "commit"}, {"oid": "d8afd66107af2c11641b13cdfa0c02841c11ed7f", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/d8afd66107af2c11641b13cdfa0c02841c11ed7f", "message": "Make TransitEntity equals and hashcode non-extendable", "committedDate": "2020-10-05T08:31:50Z", "type": "commit"}, {"oid": "e7398d1964c3aec554a1cc3e7d71bac6254288c5", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e7398d1964c3aec554a1cc3e7d71bac6254288c5", "message": "Merge branch 'dev-2.x' into realtime-optimizations", "committedDate": "2020-10-06T08:32:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNzE5Mg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500117192", "bodyText": "Add final", "author": "t2gran", "createdAt": "2020-10-06T08:59:53Z", "path": "src/main/java/org/opentripplanner/model/Timetable.java", "diffHunk": "@@ -265,6 +264,8 @@ public TripTimes createUpdatedTripTimes(TripUpdate tripUpdate, TimeZone timeZone\n             int numStops = newTimes.getNumStops();\n             Integer delay = null;\n \n+            long today = updateServiceDate.getAsDate(timeZone).getTime() / 1000;", "originalCommit": "e7398d1964c3aec554a1cc3e7d71bac6254288c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExNzk5OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500117998", "bodyText": "Add  a comment to this, why we need a SetMultimap.", "author": "t2gran", "createdAt": "2020-10-06T09:01:11Z", "path": "src/main/java/org/opentripplanner/model/TimetableSnapshot.java", "diffHunk": "@@ -123,7 +122,7 @@ public boolean equals(Object obj) {\n      *\n      * TODO Find a generic way to keep all realtime indexes.\n      */\n-    private Multimap<Stop, TripPattern> patternsForStop = ArrayListMultimap.create();\n+    private SetMultimap<Stop, TripPattern> patternsForStop = HashMultimap.create();", "originalCommit": "e7398d1964c3aec554a1cc3e7d71bac6254288c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDExOTY0MQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500119641", "bodyText": "Add a method to the TripPattern.isCreatedByRealTimeUpdater() : boolean and use it here.", "author": "t2gran", "createdAt": "2020-10-06T09:03:58Z", "path": "src/main/java/org/opentripplanner/model/TimetableSnapshot.java", "diffHunk": "@@ -386,17 +385,22 @@ public String toString() {\n         return timetables.keySet();\n     }\n \n+    /**\n+     * Add the patterns to the stop index, only if they come from a modified pattern\n+     */\n     private void addPatternToIndex(TripPattern tripPattern) {\n-        for (Stop stop: tripPattern.getStops()) {\n-            patternsForStop.put(stop, tripPattern);\n+        if (tripPattern.getOriginalTripPattern() != null) {", "originalCommit": "e7398d1964c3aec554a1cc3e7d71bac6254288c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEyMTE2NA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3205#discussion_r500121164", "bodyText": "This is great! Should  have been done a long  time ago!", "author": "t2gran", "createdAt": "2020-10-06T09:06:24Z", "path": "src/main/java/org/opentripplanner/model/TransitEntity.java", "diffHunk": "@@ -30,7 +30,7 @@ public void setId(T id) {\n      * example after reloading a serialized instance.\n      */\n     @Override\n-    public boolean equals(Object obj) {\n+    final public boolean equals(Object obj) {", "originalCommit": "e7398d1964c3aec554a1cc3e7d71bac6254288c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e2fa33c192e6af4b6d9ca4bcd99d74a1528ed6ce", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e2fa33c192e6af4b6d9ca4bcd99d74a1528ed6ce", "message": "Add setCreatedByRealtimeUpdater", "committedDate": "2020-10-06T09:35:54Z", "type": "commit"}, {"oid": "b76e3c14435c9e8d4b679bd062917ffcd5172924", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b76e3c14435c9e8d4b679bd062917ffcd5172924", "message": "Changes based on comments from the review", "committedDate": "2020-10-06T09:35:54Z", "type": "commit"}]}