{"pr_number": 3104, "pr_title": "Clean-up Itinerary filters, fixing the Pattern loop problem", "pr_createdAt": "2020-06-16T08:54:33Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3104", "timeline": [{"oid": "907ab65056312a2a6926b1db1d11fcc71168c90c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/907ab65056312a2a6926b1db1d11fcc71168c90c", "message": "Log system errors with stacktrace. These errors are critical and should be fixed.\nLogging the cause is critical to be able to fix them - even if this mean opening up\nthe system to security risks.", "committedDate": "2020-06-15T17:18:36Z", "type": "commit"}, {"oid": "727eef52592c7c39961a648d6c0bff505e13c9b0", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/727eef52592c7c39961a648d6c0bff505e13c9b0", "message": "Simplify ToStringBuilder, take away unused list and exclude ignored values, not default values.", "committedDate": "2020-06-15T17:28:11Z", "type": "commit"}, {"oid": "ceb8338af588fa14471d38b5f958e6f95aee82a7", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ceb8338af588fa14471d38b5f958e6f95aee82a7", "message": "Minor bugfix in toString for itinerary.", "committedDate": "2020-06-15T17:32:45Z", "type": "commit"}, {"oid": "de9ea1fc56bb83518e03d3860f54ae5b3bc19a22", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/de9ea1fc56bb83518e03d3860f54ae5b3bc19a22", "message": "Clean code - refactor CostCalculator so the interface is not so specific to the calculation of today's generalized-cost. This will allow us to create other calculators to introduce other criteria later.", "committedDate": "2020-06-15T18:15:27Z", "type": "commit"}, {"oid": "79f11dc3eb3ff48cf395134d0b0a7d9bf4c81139", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/79f11dc3eb3ff48cf395134d0b0a7d9bf4c81139", "message": "- Prepare to configure filter-chain by extracting a parameters interface to be able to inject parameters later.\n- Merge GroupByLegDistanceFilter and ReduceTimeTableVariationFilter into GroupBySimilarLegsFilter.", "committedDate": "2020-06-15T23:48:23Z", "type": "commit"}, {"oid": "3f9f4a379d7637b1bb84f91b5ca0d66af67a3106", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3f9f4a379d7637b1bb84f91b5ca0d66af67a3106", "message": "Make the GroupBySimilarLegsFilter configurable using the `router-config.json`.", "committedDate": "2020-06-16T00:50:09Z", "type": "commit"}, {"oid": "c88d57113454db1c9e3bc522eabac31e04795db1", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c88d57113454db1c9e3bc522eabac31e04795db1", "message": "Merge branch 'dev-2.x' into otp2_trip_to_trip_cost", "committedDate": "2020-06-16T08:55:43Z", "type": "commit"}, {"oid": "435ccc9ed0b9af4a5dc3474fb952091a8e1c7556", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/435ccc9ed0b9af4a5dc3474fb952091a8e1c7556", "message": "Merge branch 'dev-2.x' into otp2_trip_to_trip_cost", "committedDate": "2020-06-18T09:07:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwMzI1NA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3104#discussion_r442103254", "bodyText": "Use the to/from stopIndex, also fix the itinerary mapper.", "author": "t2gran", "createdAt": "2020-06-18T09:44:24Z", "path": "src/main/java/org/opentripplanner/model/plan/Leg.java", "diffHunk": "@@ -244,19 +244,22 @@ public void addAlertPatch(AlertPatch alertPatch) {\n     }\n \n     /**\n-     * Compare to legs to determine if they start and end at the same place and time.\n-     *\n-     * Note! Properties like mode and trip is NOT considered.\n+     * Return {@code true} if to legs ride the same trip(same tripId) and at least part of the\n+     * rides overlap in time.\n      */\n-    public boolean sameStartAndEnd(Leg other) {\n-        if (this == other) { return true; }\n-        return startTime.equals(other.startTime)\n-                && endTime.equals(other.endTime)\n-                && from.sameLocation(other.from)\n-                && to.sameLocation(other.to);\n+    public boolean isPartiallySameTransitLeg(Leg other) {\n+      // Assert both legs are transit legs\n+      if(!isTransitLeg() || !other.isTransitLeg()) { throw new IllegalStateException(); }\n+\n+      // If NOT the same trip, return false\n+      if(!tripId.equals(other.tripId)) { return false; }\n+\n+      // If not riding at least part of the same stretch of the trip.\n+      // If a pattern goes in a loop, this make sure two legs are riding the trip in the same loop.\n+      return startTime.before(other.endTime) && endTime.after(other.startTime);", "originalCommit": "435ccc9ed0b9af4a5dc3474fb952091a8e1c7556", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dcc5ca8c12fef15cc65458e26177746a7faf0f6d", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/dcc5ca8c12fef15cc65458e26177746a7faf0f6d", "message": "Change the code for testing if to legs overlap from using departure/arrival time to using the rout stop index instead. In some cases two sequential stops may have the same departure time, same minute departure.", "committedDate": "2020-06-18T11:53:26Z", "type": "commit"}, {"oid": "fde99e9807ec2882a30335ae2e73410333a51191", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/fde99e9807ec2882a30335ae2e73410333a51191", "message": "Bugfix - The Itinerary mapper did not account for the same departure time for multiple stops in a pattern, it would resolve the stopIndex incorrect. This commit fixes this.", "committedDate": "2020-06-18T14:23:02Z", "type": "commit"}, {"oid": "380c55fc87aad47317896d6f8f024d40465f0f09", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/380c55fc87aad47317896d6f8f024d40465f0f09", "message": "Unit test on Itinerary added, JavaDoc on TestItineraryBuilder, and make sure the place#stopIndex is set in a correct, consistent way in unit-tests.", "committedDate": "2020-06-23T14:31:23Z", "type": "commit"}]}