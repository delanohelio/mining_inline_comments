{"pr_number": 3249, "pr_title": "Otp2 fix added trips", "pr_createdAt": "2020-11-16T10:45:17Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3249", "timeline": [{"oid": "e18e16b6271e6ab4423f8ab32b3debb36d2a6b1e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e18e16b6271e6ab4423f8ab32b3debb36d2a6b1e", "message": "Exposing method to add trips from realtime-data", "committedDate": "2020-11-16T09:47:46Z", "type": "commit"}, {"oid": "934074b6fe92aaef052e57e5a4abf54b2e8e8857", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/934074b6fe92aaef052e57e5a4abf54b2e8e8857", "message": "Fixed timezone-issue when adding trip in realtime", "committedDate": "2020-11-16T10:19:05Z", "type": "commit"}, {"oid": "e1f5e11586358951b9457b425866e01801056fa9", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e1f5e11586358951b9457b425866e01801056fa9", "message": "Actually adding trip to CalendarService", "committedDate": "2020-11-16T10:19:56Z", "type": "commit"}, {"oid": "cf8d61aaa263c6d260258a99bb5050a2b43b1d5e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/cf8d61aaa263c6d260258a99bb5050a2b43b1d5e", "message": "Avoiding null-headsign for added trips", "committedDate": "2020-11-16T10:21:20Z", "type": "commit"}, {"oid": "c8fee9da218c81c8540e5bf0e6922df139646b44", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c8fee9da218c81c8540e5bf0e6922df139646b44", "message": "Updating siri-protobuf-mapper", "committedDate": "2020-12-10T14:48:20Z", "type": "commit"}, {"oid": "2e9aeb67fa550c9a2cab053d25e8c77833cff07d", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2e9aeb67fa550c9a2cab053d25e8c77833cff07d", "message": "Setting Operator and TransitMode for realtime-added trips", "committedDate": "2020-12-10T14:53:52Z", "type": "commit"}, {"oid": "ad3c0c5f9fed7f044b785e15e7e46e07e9cd0b36", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ad3c0c5f9fed7f044b785e15e7e46e07e9cd0b36", "message": "Revert \"Setting Operator and TransitMode for realtime-added trips\"\n\nThis reverts commit 2e9aeb67", "committedDate": "2020-12-11T07:28:49Z", "type": "commit"}, {"oid": "0a07e6b3f3737de013185a4d21755a387137210c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0a07e6b3f3737de013185a4d21755a387137210c", "message": "Setting Operator for realtime-added trips", "committedDate": "2020-12-11T07:32:44Z", "type": "commit"}, {"oid": "0e10bc0ca310caebc274ae47b6a80bae13660f6d", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0e10bc0ca310caebc274ae47b6a80bae13660f6d", "message": "Limit unsafe internal service calendar model. The graph calendar data is not\nintended to be mutable, hence not designed to be thread-safe. But unfortunately\nat some point the calender needed to be changed to add new trip as part of\nrealtime updates. As a result, unsafe code was added and now exist as part of\nthe OTP model. This PR add more unsafe code, but we try to limit it. The added\nunsafe code is documented and linked to issue #3030. Fixing this problem should\nbe done when cleaning up the OTP internal model (issue #3030).", "committedDate": "2020-12-21T18:28:40Z", "type": "commit"}, {"oid": "790fb437e87bddf2e9b3e6277feace3dcf527d34", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/790fb437e87bddf2e9b3e6277feace3dcf527d34", "message": "Merge branch 'dev-2.x' into otp2_fix_added_trips", "committedDate": "2020-12-21T18:30:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5ODE0OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3249#discussion_r547198148", "bodyText": "Clean up this doc: \"non thread-safe\" .. implementation", "author": "t2gran", "createdAt": "2020-12-22T10:31:45Z", "path": "src/main/java/org/opentripplanner/routing/graph/Graph.java", "diffHunk": "@@ -667,6 +667,26 @@ public CalendarService getCalendarService() {\n         return this.calendarService;\n     }\n \n+    /**\n+     * Get or create a serviceId for a given date. This method is used when a new trip is\n+     * added from a realtime data update.\n+     *\n+     * TODO OTP2 - This is NOT THREAD-SAFE and is used in the real-time updaters, we need to fix\n+     *           - this when doing the issue #3030.\n+     *\n+     * @param serviceDate service date for the added service id\n+     */\n+    public FeedScopedId getOrCreateServiceIdForDate(ServiceDate serviceDate) {\n+        // We make an explicit cast here, because we know the type, and we do not want\n+        // to expose the \"unsafe\" method in the {@link CalendarService} interface.", "originalCommit": "790fb437e87bddf2e9b3e6277feace3dcf527d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2a832afc4e5c2435963215289a1de3af2a000dad", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2a832afc4e5c2435963215289a1de3af2a000dad", "message": "review: Clearified the comments on Graph.getOrCreateServiceIdForDate()", "committedDate": "2020-12-22T12:22:07Z", "type": "commit"}, {"oid": "482c2ac819ffa8025e06dfa1d8fb5bf8e7604212", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/482c2ac819ffa8025e06dfa1d8fb5bf8e7604212", "message": "Merge branch 'dev-2.x' into otp2_fix_added_trips", "committedDate": "2020-12-22T12:25:14Z", "type": "commit"}]}