{"pr_number": 1585, "pr_title": "Use ServiceLoader to create SecurityAnalysis", "pr_createdAt": "2020-12-22T13:56:08Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1585", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0Mzc2NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r553943765", "bodyText": "Add a TODO to not forget to rename this class at the end", "author": "mathbagu", "createdAt": "2021-01-08T13:29:48Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysis2.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfig;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ *\n+ * Sensitivity analysis main API. It is a utility class (so with only static methods) used as an entry point for running\n+ * a sensitivity analysis allowing to choose either a specific implementation or just to rely on the default one.\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public final class SecurityAnalysis2 {", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NDYyMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r553944622", "bodyText": "Use LocalComputationManager.getDefault() instead", "author": "mathbagu", "createdAt": "2021-01-08T13:31:43Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysis2.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfig;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ *\n+ * Sensitivity analysis main API. It is a utility class (so with only static methods) used as an entry point for running\n+ * a sensitivity analysis allowing to choose either a specific implementation or just to rely on the default one.\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public final class SecurityAnalysis2 {\n+\n+    private SecurityAnalysis2() {\n+        throw new AssertionError(\"Utility class should not been instantiated\");\n+    }\n+\n+    /**\n+     * A sensitivity analysis runner is responsible for providing convenient methods on top of {@link SecurityAnalysisProvider}:\n+     * several variants of synchronous and asynchronous run with default parameters.\n+     */\n+    public static final class Runner implements Versionable {\n+\n+        private final SecurityAnalysisProvider provider;\n+\n+        private Runner(SecurityAnalysisProvider provider) {\n+            this.provider = Objects.requireNonNull(provider);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network,\n+                                                                  String workingStateId,\n+                                                                  LimitViolationDetector detector,\n+                                                                  LimitViolationFilter filter,\n+                                                                  ComputationManager computationManager,\n+                                                                  SecurityAnalysisParameters parameters,\n+                                                                  ContingenciesProvider contingenciesProvider,\n+                                                                  List<SecurityAnalysisInterceptor> interceptors) {\n+            Objects.requireNonNull(network, \"Network should not be null\");\n+            Objects.requireNonNull(workingStateId, \"WorkingVariantId should not be null\");\n+            Objects.requireNonNull(detector, \"LimitViolation detector should not be null\");\n+            Objects.requireNonNull(filter, \"LimitViolation filter should not be null\");\n+            Objects.requireNonNull(computationManager, \"ComputationManager should not be null\");\n+            Objects.requireNonNull(contingenciesProvider, \"Contingencies provider should not be null\");\n+            Objects.requireNonNull(parameters, \"Sensitivity analysis parameters should not be null\");\n+            Objects.requireNonNull(interceptors, \"Interceptor list should not be null\");\n+            return provider.run(network, workingStateId, detector, filter, computationManager, parameters, contingenciesProvider, interceptors);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network, LimitViolationFilter filter,\n+                                                                  ComputationManager computationManager) {\n+            return runAsync(network, network.getVariantManager().getWorkingVariantId(), new DefaultLimitViolationDetector(), filter, computationManager, SecurityAnalysisParameters.load(), new EmptyContingencyListProvider(), Collections.emptyList());\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network, ComputationManager computationManager) {\n+            return runAsync(network, LimitViolationFilter.load(), computationManager);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network) {\n+            return runAsync(network, new LocalComputationManagerFactory().create());", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTIwMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r553945200", "bodyText": "I think you should remove all the WithLog method: as proposed last time, we would probably return an object that contain the result of the simulation and a report. To be discussed with the others", "author": "mathbagu", "createdAt": "2021-01-08T13:33:03Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysis2.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfig;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ *\n+ * Sensitivity analysis main API. It is a utility class (so with only static methods) used as an entry point for running\n+ * a sensitivity analysis allowing to choose either a specific implementation or just to rely on the default one.\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public final class SecurityAnalysis2 {\n+\n+    private SecurityAnalysis2() {\n+        throw new AssertionError(\"Utility class should not been instantiated\");\n+    }\n+\n+    /**\n+     * A sensitivity analysis runner is responsible for providing convenient methods on top of {@link SecurityAnalysisProvider}:\n+     * several variants of synchronous and asynchronous run with default parameters.\n+     */\n+    public static final class Runner implements Versionable {\n+\n+        private final SecurityAnalysisProvider provider;\n+\n+        private Runner(SecurityAnalysisProvider provider) {\n+            this.provider = Objects.requireNonNull(provider);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network,\n+                                                                  String workingStateId,\n+                                                                  LimitViolationDetector detector,\n+                                                                  LimitViolationFilter filter,\n+                                                                  ComputationManager computationManager,\n+                                                                  SecurityAnalysisParameters parameters,\n+                                                                  ContingenciesProvider contingenciesProvider,\n+                                                                  List<SecurityAnalysisInterceptor> interceptors) {\n+            Objects.requireNonNull(network, \"Network should not be null\");\n+            Objects.requireNonNull(workingStateId, \"WorkingVariantId should not be null\");\n+            Objects.requireNonNull(detector, \"LimitViolation detector should not be null\");\n+            Objects.requireNonNull(filter, \"LimitViolation filter should not be null\");\n+            Objects.requireNonNull(computationManager, \"ComputationManager should not be null\");\n+            Objects.requireNonNull(contingenciesProvider, \"Contingencies provider should not be null\");\n+            Objects.requireNonNull(parameters, \"Sensitivity analysis parameters should not be null\");\n+            Objects.requireNonNull(interceptors, \"Interceptor list should not be null\");\n+            return provider.run(network, workingStateId, detector, filter, computationManager, parameters, contingenciesProvider, interceptors);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network, LimitViolationFilter filter,\n+                                                                  ComputationManager computationManager) {\n+            return runAsync(network, network.getVariantManager().getWorkingVariantId(), new DefaultLimitViolationDetector(), filter, computationManager, SecurityAnalysisParameters.load(), new EmptyContingencyListProvider(), Collections.emptyList());\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network, ComputationManager computationManager) {\n+            return runAsync(network, LimitViolationFilter.load(), computationManager);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network) {\n+            return runAsync(network, new LocalComputationManagerFactory().create());\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResultWithLog> runAsyncWithLog(Network network,\n+                                                                                String workingStateId,\n+                                                                                LimitViolationDetector detector,\n+                                                                                LimitViolationFilter filter,\n+                                                                                ComputationManager computationManager,\n+                                                                                SecurityAnalysisParameters parameters,\n+                                                                                ContingenciesProvider contingenciesProvider,\n+                                                                                List<SecurityAnalysisInterceptor> interceptors) {\n+            Objects.requireNonNull(network, \"Network should not be null\");\n+            Objects.requireNonNull(workingStateId, \"WorkingVariantId should not be null\");\n+            Objects.requireNonNull(detector, \"LimitViolation detector should not be null\");\n+            Objects.requireNonNull(filter, \"LimitViolation filter should not be null\");\n+            Objects.requireNonNull(computationManager, \"ComputationManager should not be null\");\n+            Objects.requireNonNull(contingenciesProvider, \"Contingencies provider should not be null\");\n+            Objects.requireNonNull(parameters, \"Sensitivity analysis parameters should not be null\");\n+            Objects.requireNonNull(interceptors, \"Interceptor list should not be null\");\n+            return provider.runWithLog(network, workingStateId, detector, filter, computationManager, parameters, contingenciesProvider, interceptors);\n+        }", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzMzkyNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559433926", "bodyText": "Isn't it already the purpose of SecurityAnalysisResultWithLog?", "author": "geofjamg", "createdAt": "2021-01-18T09:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzODQ5Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559438497", "bodyText": "Maybe we should just remove SecurityAnalysisResultWithLog and move logBytes to SecurityAnalysisResult (and up to an impl to use it or not) so that the API will be cleaner?", "author": "geofjamg", "createdAt": "2021-01-18T09:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ1MDkwMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559450901", "bodyText": "There was one question with this approach : how do you handle serialization of this ? Do you want to serialize it in the JSON representing the result or not ?", "author": "sylvlecl", "createdAt": "2021-01-18T10:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc1MTUxNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r562751514", "bodyText": "Issue #1602 was created to keep these comments", "author": "tadam50", "createdAt": "2021-01-22T16:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTIwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTgwNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r553945805", "bodyText": "Same remark: I think you can remove this method except if it breaks the compilation", "author": "mathbagu", "createdAt": "2021-01-08T13:34:24Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysisProvider.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ * Security analysis provider\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public interface SecurityAnalysisProvider extends Versionable, PlatformConfigNamedProvider {\n+\n+    /**\n+     * Run an asynchronous single security analysis job.\n+     *\n+     * @param network IIDM network on which the security analysis will be performed\n+     * @param workingVariantId network variant ID on which the analysis will be performed\n+     * @param detector\n+     * @param filter\n+     * @param computationManager\n+     * @param parameters specific security analysis parameters\n+     * @param contingenciesProvider provides list of contingencies\n+     * @param interceptors\n+     * @return a {@link CompletableFuture} on {@link SecurityAnalysisResult} that gathers sensitivity factor values\n+     */\n+    CompletableFuture<SecurityAnalysisResult> run(Network network,\n+                                                  String workingVariantId,\n+                                                  LimitViolationDetector detector,\n+                                                  LimitViolationFilter filter,\n+                                                  ComputationManager computationManager,\n+                                                  SecurityAnalysisParameters parameters,\n+                                                  ContingenciesProvider contingenciesProvider,\n+                                                  List<SecurityAnalysisInterceptor> interceptors);\n+\n+    default CompletableFuture<SecurityAnalysisResultWithLog> runWithLog(Network network,\n+                                                                        String workingVariantId,\n+                                                                        LimitViolationDetector detector,\n+                                                                        LimitViolationFilter filter,\n+                                                                        ComputationManager computationManager,\n+                                                                        SecurityAnalysisParameters parameters,\n+                                                                        ContingenciesProvider contingenciesProvider,\n+                                                                        List<SecurityAnalysisInterceptor> interceptors) {\n+        return run(network, workingVariantId, detector, filter, computationManager, parameters, contingenciesProvider, interceptors).thenApply(r -> new SecurityAnalysisResultWithLog(r, null));\n+    }", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDUwMzYwNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r564503604", "bodyText": "Removed waiting fix of Issue #1602", "author": "tadam50", "createdAt": "2021-01-26T13:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzk0NTk1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r553945952", "bodyText": "Same remark: add a todo/fixme", "author": "mathbagu", "createdAt": "2021-01-08T13:34:41Z", "path": "security-analysis-api/src/test/java/com/powsybl/security/SecurityAnalysis2Test.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.iidm.network.VariantManager;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import static org.junit.Assert.*;\n+\n+/**\n+ * @author Thomas Adam<tadam at silicom.fr>\n+ */\n+public class SecurityAnalysis2Test {", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzNDM1Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559434353", "bodyText": "So in the next PR, the plan is to move the code of SecurityAnalysisImpl in this class?", "author": "geofjamg", "createdAt": "2021-01-18T09:43:38Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysisImplProvider.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.google.auto.service.AutoService;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+@AutoService(SecurityAnalysisProvider.class)\n+public class SecurityAnalysisImplProvider implements SecurityAnalysisProvider {\n+\n+    private static final String PROVIDER_NAME = \"SecurityAnalysisImpl\";\n+    private static final String PROVIDER_VERSION = \"1.0\";\n+\n+    @Override\n+    public CompletableFuture<SecurityAnalysisResult> run(Network network,\n+                                                         String workingVariantId,\n+                                                         LimitViolationDetector detector,\n+                                                         LimitViolationFilter filter,\n+                                                         ComputationManager computationManager,\n+                                                         SecurityAnalysisParameters parameters,\n+                                                         ContingenciesProvider contingenciesProvider,\n+                                                         List<SecurityAnalysisInterceptor> interceptors) {\n+        SecurityAnalysisImpl securityAnalysis = new SecurityAnalysisImpl(network, detector, filter, computationManager);", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzNjU4MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559436581", "bodyText": "For me LimitViolationDetector has nothing to do in the API, because it supposes that violation detection is done on IIDM model. It is not the case for instance in OLF, because violation detection is  done one a more internal data model to speed up performance. I guess it should be the case too, with hades2.\n@sylvlecl i think this is you who add it to the API, do you really need it?", "author": "geofjamg", "createdAt": "2021-01-18T09:46:53Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysisProvider.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ * Security analysis provider\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public interface SecurityAnalysisProvider extends Versionable, PlatformConfigNamedProvider {\n+\n+    /**\n+     * Run an asynchronous single security analysis job.\n+     *\n+     * @param network IIDM network on which the security analysis will be performed\n+     * @param workingVariantId network variant ID on which the analysis will be performed\n+     * @param detector\n+     * @param filter\n+     * @param computationManager\n+     * @param parameters specific security analysis parameters\n+     * @param contingenciesProvider provides list of contingencies\n+     * @param interceptors\n+     * @return a {@link CompletableFuture} on {@link SecurityAnalysisResult} that gathers sensitivity factor values\n+     */\n+    CompletableFuture<SecurityAnalysisResult> run(Network network,\n+                                                  String workingVariantId,\n+                                                  LimitViolationDetector detector,", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ2NzE2NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559467165", "bodyText": "Indeed it's an important component for us, to allow custom violation detection, for example taking into account limit reduction factors based on the branch, the contingency, or the limit itself (acceptable duration ... ).\nA goal of the detector was indeed to try to avoid differences in the way violations are created by different implementations, and to provide the same features to different implementations (like this \"limit reduction factors\" feature).\nIf we don't want to use it here anymore, this kind of processing will need to be done \"externally\" by a calling process, in this case :\n\nwe should be very clear in the javadoc how detection violation should be performed by the implementation (for example, should it provide 1 violation for each exceeded limit, or only 1 for the \"worse\")\na detail to be solved is the fact that for voltage violations, for the moment, we lose the \"bus\" information\nitools security-analysis will lose some functionality, except if we add the possibility to plug in some post-processing", "author": "sylvlecl", "createdAt": "2021-01-18T10:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzNjU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc1MDk0Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r562750943", "bodyText": "Issue #1603 was created to keep these comments", "author": "tadam50", "createdAt": "2021-01-22T16:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzNjU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQyOTAyNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559429027", "bodyText": "Be careful to also update javadoc before merging (sensitivity --> security)", "author": "sylvlecl", "createdAt": "2021-01-18T09:35:30Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysis2.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfig;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ *\n+ * Sensitivity analysis main API. It is a utility class (so with only static methods) used as an entry point for running", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzMjQ0NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559432444", "bodyText": "I have a design interrogation since the LimitViolationDetector was introduced : I think there is an overlap between the roles of the detector and of the filter. Maybe the filter should only be implemented inside the detection (for instance as a detector wrapping another one).\nI just raise this for further thought, I guess it should be part of a PR on its own.", "author": "sylvlecl", "createdAt": "2021-01-18T09:40:37Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysis2.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfig;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ *\n+ * Sensitivity analysis main API. It is a utility class (so with only static methods) used as an entry point for running\n+ * a sensitivity analysis allowing to choose either a specific implementation or just to rely on the default one.\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public final class SecurityAnalysis2 {\n+\n+    private SecurityAnalysis2() {\n+        throw new AssertionError(\"Utility class should not been instantiated\");\n+    }\n+\n+    /**\n+     * A sensitivity analysis runner is responsible for providing convenient methods on top of {@link SecurityAnalysisProvider}:\n+     * several variants of synchronous and asynchronous run with default parameters.\n+     */\n+    public static final class Runner implements Versionable {\n+\n+        private final SecurityAnalysisProvider provider;\n+\n+        private Runner(SecurityAnalysisProvider provider) {\n+            this.provider = Objects.requireNonNull(provider);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network,\n+                                                                  String workingStateId,\n+                                                                  LimitViolationDetector detector,\n+                                                                  LimitViolationFilter filter,", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDUyMTQyNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r564521424", "bodyText": "Issue #1603 was created to keep these comments", "author": "tadam50", "createdAt": "2021-01-26T13:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzMjQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzNzQ0Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559437446", "bodyText": "javadoc to be updated here too", "author": "sylvlecl", "createdAt": "2021-01-18T09:48:04Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysis2.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfig;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ *\n+ * Sensitivity analysis main API. It is a utility class (so with only static methods) used as an entry point for running\n+ * a sensitivity analysis allowing to choose either a specific implementation or just to rely on the default one.\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public final class SecurityAnalysis2 {\n+\n+    private SecurityAnalysis2() {\n+        throw new AssertionError(\"Utility class should not been instantiated\");\n+    }\n+\n+    /**\n+     * A sensitivity analysis runner is responsible for providing convenient methods on top of {@link SecurityAnalysisProvider}:", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQzNzk5Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559437993", "bodyText": "message to be adapted (\"sensitivity\")", "author": "sylvlecl", "createdAt": "2021-01-18T09:48:53Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysis2.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.powsybl.commons.PowsyblException;\n+import com.powsybl.commons.Versionable;\n+import com.powsybl.commons.config.PlatformConfig;\n+import com.powsybl.commons.config.PlatformConfigNamedProvider;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.computation.local.LocalComputationManagerFactory;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.contingency.EmptyContingencyListProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.detectors.DefaultLimitViolationDetector;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ *\n+ * Sensitivity analysis main API. It is a utility class (so with only static methods) used as an entry point for running\n+ * a sensitivity analysis allowing to choose either a specific implementation or just to rely on the default one.\n+ *\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+public final class SecurityAnalysis2 {\n+\n+    private SecurityAnalysis2() {\n+        throw new AssertionError(\"Utility class should not been instantiated\");\n+    }\n+\n+    /**\n+     * A sensitivity analysis runner is responsible for providing convenient methods on top of {@link SecurityAnalysisProvider}:\n+     * several variants of synchronous and asynchronous run with default parameters.\n+     */\n+    public static final class Runner implements Versionable {\n+\n+        private final SecurityAnalysisProvider provider;\n+\n+        private Runner(SecurityAnalysisProvider provider) {\n+            this.provider = Objects.requireNonNull(provider);\n+        }\n+\n+        public CompletableFuture<SecurityAnalysisResult> runAsync(Network network,\n+                                                                  String workingStateId,\n+                                                                  LimitViolationDetector detector,\n+                                                                  LimitViolationFilter filter,\n+                                                                  ComputationManager computationManager,\n+                                                                  SecurityAnalysisParameters parameters,\n+                                                                  ContingenciesProvider contingenciesProvider,\n+                                                                  List<SecurityAnalysisInterceptor> interceptors) {\n+            Objects.requireNonNull(network, \"Network should not be null\");\n+            Objects.requireNonNull(workingStateId, \"WorkingVariantId should not be null\");\n+            Objects.requireNonNull(detector, \"LimitViolation detector should not be null\");\n+            Objects.requireNonNull(filter, \"LimitViolation filter should not be null\");\n+            Objects.requireNonNull(computationManager, \"ComputationManager should not be null\");\n+            Objects.requireNonNull(contingenciesProvider, \"Contingencies provider should not be null\");\n+            Objects.requireNonNull(parameters, \"Sensitivity analysis parameters should not be null\");", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MjAxMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559442013", "bodyText": "Should we seize this opportunity to rename the SecurityAnalysisImpl to something more meaningful, like DefaultSecurityAnalysis or even more explicit LoadFlowBasedSecurityAnalysis  ?\nThe \"impl\" suffix does not seem appropriate if the target is to have multiple implementations (even more when this \"impl\" is not suitable for most users).", "author": "sylvlecl", "createdAt": "2021-01-18T09:55:17Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysisImplProvider.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.google.auto.service.AutoService;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+@AutoService(SecurityAnalysisProvider.class)\n+public class SecurityAnalysisImplProvider implements SecurityAnalysisProvider {", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0NzQ1Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559447453", "bodyText": "Also, is it OK to leave it in the security-analysis-api module ?\nThe consequence is the following: you will always have that implementation in the classpath, which means that if you add another implementation you want to use, you will not be able to rely on the behaviour which allows to configure nothing to use the only implementation in the classpath.", "author": "sylvlecl", "createdAt": "2021-01-18T10:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MjAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ2NzI1NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559467254", "bodyText": "LoadFlowBasedSecurityAnalysis\n\nDefaultSecurityAnalysis would be fine. LoadFlowBasedSecurityAnalysis is maybe not appropriate as even an optimized security analysis is also based on a load flow.", "author": "geofjamg", "createdAt": "2021-01-18T10:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MjAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ2ODE2MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559468160", "bodyText": "Also, is it OK to leave it in the security-analysis-api module ?\nThe consequence is the following: you will always have that implementation in the classpath, which means that if you add another implementation you want to use, you will not be able to rely on the behaviour which allows to configure nothing to use the only implementation in the classpath.\n\nYou are right, it would break the new api design, as it would require to always have the default impl in the config.yml or use .find(\"h2\")", "author": "geofjamg", "createdAt": "2021-01-18T10:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MjAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjY0Njk5NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r562646994", "bodyText": "ManyLoadflowSecurityAnalysis ?", "author": "jonenst", "createdAt": "2021-01-22T13:56:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MjAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc2NjYyNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r562766627", "bodyText": "Issue #1604 was created to keep these comments", "author": "tadam50", "createdAt": "2021-01-22T16:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MjAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ0MjI2Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1585#discussion_r559442266", "bodyText": "See comment about naming", "author": "sylvlecl", "createdAt": "2021-01-18T09:55:37Z", "path": "security-analysis-api/src/main/java/com/powsybl/security/SecurityAnalysisImplProvider.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.security;\n+\n+import com.google.auto.service.AutoService;\n+import com.powsybl.computation.ComputationManager;\n+import com.powsybl.contingency.ContingenciesProvider;\n+import com.powsybl.iidm.network.Network;\n+import com.powsybl.security.interceptors.SecurityAnalysisInterceptor;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+/**\n+ * @author Thomas Adam <tadam at silicom.fr>\n+ */\n+@AutoService(SecurityAnalysisProvider.class)\n+public class SecurityAnalysisImplProvider implements SecurityAnalysisProvider {\n+\n+    private static final String PROVIDER_NAME = \"SecurityAnalysisImpl\";", "originalCommit": "87052ec9bc8131b9305952c3b74d7c5a11e3549a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb9952ee5e32ad1e726d48efdb49359357129bd0", "url": "https://github.com/powsybl/powsybl-core/commit/bb9952ee5e32ad1e726d48efdb49359357129bd0", "message": "Add SecurityAnalysisProvider\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2021-01-22T14:27:25Z", "type": "commit"}, {"oid": "bb9952ee5e32ad1e726d48efdb49359357129bd0", "url": "https://github.com/powsybl/powsybl-core/commit/bb9952ee5e32ad1e726d48efdb49359357129bd0", "message": "Add SecurityAnalysisProvider\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2021-01-22T14:27:25Z", "type": "forcePushed"}, {"oid": "b1b1121335815e0abc6ffa1c6e8c9f0c8408f5c0", "url": "https://github.com/powsybl/powsybl-core/commit/b1b1121335815e0abc6ffa1c6e8c9f0c8408f5c0", "message": "Add FIXME to rename later and fix comments issues\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2021-01-22T16:56:27Z", "type": "commit"}, {"oid": "9d7ede2f75d6d3842d4252bac8b59053f3839345", "url": "https://github.com/powsybl/powsybl-core/commit/9d7ede2f75d6d3842d4252bac8b59053f3839345", "message": "Remove runWithLog method in SecurityAnalysisProvider\n\nSigned-off-by: Thomas ADAM <tadam@silicom.fr>", "committedDate": "2021-01-26T13:18:33Z", "type": "commit"}]}