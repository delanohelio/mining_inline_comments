{"pr_number": 1345, "pr_title": "Dynamic Model Provider", "pr_createdAt": "2020-06-11T06:24:34Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1345", "timeline": [{"oid": "36bd05f3eb730b2ce8be50a5acd9bec3f8f733d1", "url": "https://github.com/powsybl/powsybl-core/commit/36bd05f3eb730b2ce8be50a5acd9bec3f8f733d1", "message": "add Mapping supplier\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-09T13:34:46Z", "type": "commit"}, {"oid": "a4c31ed5dc66c25fb8087d42afb24c402e3151c1", "url": "https://github.com/powsybl/powsybl-core/commit/a4c31ed5dc66c25fb8087d42afb24c402e3151c1", "message": "Merge branch 'master' into dynamic-mapping-provider", "committedDate": "2020-06-11T07:49:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDEzNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438814136", "bodyText": "To be consistent with the curves this class should be named DynamicModelGroovyExtension", "author": "agnesLeroy", "createdAt": "2020-06-11T14:07:57Z", "path": "dynamic-simulation/dynamic-simulation-dsl/src/main/java/com/powsybl/dynamicsimulation/groovy/DynamicModelExtension.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+\n+package com.powsybl.dynamicsimulation.groovy;\n+\n+import com.powsybl.dynamicsimulation.DynamicModel;\n+\n+/**\n+ * @author Marcos de Miguel <demiguelm at aia.es>\n+ */\n+public interface DynamicModelExtension extends GroovyExtension<DynamicModel> {\n+}", "originalCommit": "a4c31ed5dc66c25fb8087d42afb24c402e3151c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzNzI3OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438837279", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-06-11T14:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNTAyMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438815022", "bodyText": "Same remark as above, this class should be named DummyDynamicModelGroovyExtension.", "author": "agnesLeroy", "createdAt": "2020-06-11T14:09:19Z", "path": "dynamic-simulation/dynamic-simulation-dsl/src/test/groovy/com/powsybl/dynamicsimulation/groovy/DummyDynamicModelExtension.groovy", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.dynamicsimulation.groovy\n+\n+import java.util.function.Consumer\n+\n+import com.google.auto.service.AutoService\n+import com.powsybl.dsl.DslException\n+import com.powsybl.dynamicsimulation.DynamicModel\n+\n+/**\n+ * @author Marcos de Miguel <demiguelm at aia.es>\n+ */\n+@AutoService(DynamicModelExtension.class)\n+class DummyDynamicModelExtension implements DynamicModelExtension {\n+\n+    static class DummyDynamicModelSpec {\n+        String id\n+        String parameterSetId\n+        String parameterSetFile\n+        \n+        void id(String id) {\n+            this.id = id\n+        }\n+\n+        void parameterSetId(String parameterSetId) {\n+            this.parameterSetId = parameterSetId\n+        }\n+\n+        void parameterSetFile(String parameterSetFile) {\n+            this.parameterSetFile = parameterSetFile\n+        }\n+    }\n+\n+    void load(Binding binding, Consumer<DynamicModel> consumer) {\n+        binding.dummyDynamicModel = { Closure<Void> closure ->\n+            def cloned = closure.clone()\n+\n+            DummyDynamicModelSpec dynamicModelSpec = new DummyDynamicModelSpec()\n+\n+            cloned.delegate = dynamicModelSpec\n+            cloned()\n+            if (!dynamicModelSpec.id) {\n+                throw new DslException(\"'id' field is not set\")\n+            }\n+            if (!dynamicModelSpec.parameterSetId) {\n+                throw new DslException(\"'parameterSetId' field is not set\")\n+            }\n+            if (!dynamicModelSpec.parameterSetFile) {\n+                throw new DslException(\"'parameterSetFile' field is not set\")\n+            }\n+\n+            consumer.accept(new DummyDynamicModel(dynamicModelSpec.id, dynamicModelSpec.parameterSetId, dynamicModelSpec.parameterSetFile))\n+        }\n+    }\n+}", "originalCommit": "a4c31ed5dc66c25fb8087d42afb24c402e3151c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1OTQ2Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438859466", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-06-11T15:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNTAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyMDAyNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438820025", "bodyText": "Why do we have the parameterSetFile here? I was expecting to have only an Id (that will be either the static Id o the dynamic model Id) and a parameter Id. Am I wrong?", "author": "agnesLeroy", "createdAt": "2020-06-11T14:16:30Z", "path": "dynamic-simulation/dynamic-simulation-dsl/src/test/java/com/powsybl/dynamicsimulation/groovy/DummyDynamicModel.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+\n+package com.powsybl.dynamicsimulation.groovy;\n+\n+import java.util.Objects;\n+\n+import com.powsybl.dynamicsimulation.DynamicModel;\n+\n+/**\n+ * @author Marcos de Miguel <demiguelm at aia.es>\n+ */\n+public class DummyDynamicModel implements DynamicModel {\n+\n+    private final String id;\n+\n+    private final String parameterSetId;\n+\n+    private final String parameterSetFile;", "originalCommit": "a4c31ed5dc66c25fb8087d42afb24c402e3151c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1OTI3MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438859271", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-06-11T15:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyMDAyNQ=="}], "type": "inlineReview"}, {"oid": "37ed7e2005a7055e320bb23324dce911413f1427", "url": "https://github.com/powsybl/powsybl-core/commit/37ed7e2005a7055e320bb23324dce911413f1427", "message": "rename DynamicModelExtension to DynamicModelGroovyExtension\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-11T14:41:52Z", "type": "commit"}, {"oid": "27fa0ee795008fc1e84c5c08e38e1a74c083496a", "url": "https://github.com/powsybl/powsybl-core/commit/27fa0ee795008fc1e84c5c08e38e1a74c083496a", "message": "rename DummyDynamicModelExtension to DummyDynamicModelGroovyExtension\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-11T14:54:29Z", "type": "commit"}, {"oid": "20bafe32614e3fdd69b26fca690637d614820d90", "url": "https://github.com/powsybl/powsybl-core/commit/20bafe32614e3fdd69b26fca690637d614820d90", "message": "remove parameterSetFile from Unit Tests\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-11T15:13:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5Njc2MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438896761", "bodyText": "I'm not sure the name of this class is clear enough: we do not know the purpose of the mapping.\nDo we really want this empty method? Does it make sense to have an empty mapping? It seems to be used in the unit-test, so maybe we should remove this method from the API and move it to the test sources", "author": "mathbagu", "createdAt": "2020-06-11T15:57:12Z", "path": "dynamic-simulation/dynamic-simulation-api/src/main/java/com/powsybl/dynamicsimulation/MappingSupplier.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+\n+package com.powsybl.dynamicsimulation;\n+\n+import java.util.Collections;\n+\n+/**\n+ * @author Marcos de Miguel <demiguelm at aia.es>\n+ */\n+public interface MappingSupplier extends SimulatorInputSupplier<DynamicModel> {\n+\n+    static MappingSupplier empty() {\n+        return network -> Collections.emptyList();\n+    }\n+}", "originalCommit": "20bafe32614e3fdd69b26fca690637d614820d90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxMzU0OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438913548", "bodyText": "Yes I agree it should be moved to the test sources", "author": "agnesLeroy", "createdAt": "2020-06-11T16:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5Njc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzMDQzNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438930436", "bodyText": "Agree on the comments about the name of the class. @mathbagu suggestion of renaming from MappingSupplier to DynamicModelsSupplier is ok for me", "author": "zamarrenolm", "createdAt": "2020-06-11T16:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5Njc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1MzQ5Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r439253497", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-06-12T07:27:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5Njc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5NzU5NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438897595", "bodyText": "Same remark about the name of the class", "author": "mathbagu", "createdAt": "2020-06-11T15:58:25Z", "path": "dynamic-simulation/dynamic-simulation-dsl/src/main/java/com/powsybl/dynamicsimulation/groovy/GroovyMappingSupplier.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+\n+package com.powsybl.dynamicsimulation.groovy;\n+\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.codehaus.groovy.control.CompilerConfiguration;\n+\n+import com.powsybl.dsl.ExpressionDslLoader;\n+import com.powsybl.dsl.GroovyScripts;\n+import com.powsybl.dynamicsimulation.DynamicModel;\n+import com.powsybl.dynamicsimulation.MappingSupplier;\n+import com.powsybl.iidm.network.Network;\n+\n+import groovy.lang.Binding;\n+import groovy.lang.GroovyCodeSource;\n+import groovy.lang.GroovyShell;\n+\n+/**\n+ * @author Marcos de Miguel <demiguelm at aia.es>\n+ */\n+public class GroovyMappingSupplier implements MappingSupplier {", "originalCommit": "20bafe32614e3fdd69b26fca690637d614820d90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1MzU3Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r439253576", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-06-12T07:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5NzU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5ODkyMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438898921", "bodyText": "You should adapt the logger name.", "author": "mathbagu", "createdAt": "2020-06-11T16:00:24Z", "path": "dynamic-simulation/dynamic-simulation-dsl/src/test/resources/mapping.groovy", "diffHunk": "@@ -0,0 +1,25 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+\n+import com.powsybl.iidm.network.Generator\n+import com.powsybl.iidm.network.Load\n+import org.slf4j.Logger\n+import org.slf4j.LoggerFactory\n+\n+Logger logger = LoggerFactory.getLogger(\"com.powsybl.dynamicsimulation.groovy.GroovyCurvesProvider\")", "originalCommit": "20bafe32614e3fdd69b26fca690637d614820d90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NDUyMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r439254520", "bodyText": "Done.\nShould we change \"GroovyCurvesProvider\" to \"GroovyCurvesSupplier\" in curves.groovy?", "author": "marcosmc", "createdAt": "2020-06-12T07:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5ODkyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTIwOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438899209", "bodyText": "we should also change this option's name", "author": "mathbagu", "createdAt": "2020-06-11T16:00:49Z", "path": "dynamic-simulation/dynamic-simulation-tool/src/main/java/com/powsybl/dynamicsimulation/tool/DynamicSimulationTool.java", "diffHunk": "@@ -45,6 +48,7 @@\n public class DynamicSimulationTool implements Tool {\n \n     private static final String CASE_FILE = \"case-file\";\n+    private static final String MAPPING_FILE = \"mapping-file\";", "originalCommit": "20bafe32614e3fdd69b26fca690637d614820d90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NDYwMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r439254603", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-06-12T07:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTQ0Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438899446", "bodyText": "And give more detail in the description", "author": "mathbagu", "createdAt": "2020-06-11T16:01:12Z", "path": "dynamic-simulation/dynamic-simulation-tool/src/main/java/com/powsybl/dynamicsimulation/tool/DynamicSimulationTool.java", "diffHunk": "@@ -78,6 +82,12 @@ public Options getOptions() {\n                     .argName(\"FILE\")\n                     .required()\n                     .build());\n+                options.addOption(Option.builder().longOpt(MAPPING_FILE)\n+                    .desc(\"mapping description as Groovy file\")", "originalCommit": "20bafe32614e3fdd69b26fca690637d614820d90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxNDYyOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438914629", "bodyText": "Would \"Dynamic models description as a Groovy file: defines the dynamic models to be associated to chosen equipments of the network\" be enough?", "author": "agnesLeroy", "createdAt": "2020-06-11T16:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NTExOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r439255119", "bodyText": "Description changed by Agnes proposal", "author": "marcosmc", "createdAt": "2020-06-12T07:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTY1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r438899652", "bodyText": "This option is required so this test is useless.", "author": "mathbagu", "createdAt": "2020-06-11T16:01:32Z", "path": "dynamic-simulation/dynamic-simulation-tool/src/main/java/com/powsybl/dynamicsimulation/tool/DynamicSimulationTool.java", "diffHunk": "@@ -131,6 +141,12 @@ public void run(CommandLine line, ToolRunningContext context) throws Exception {\n \n         DynamicSimulation.Runner runner = DynamicSimulation.find();\n \n+        MappingSupplier mappingSupplier = MappingSupplier.empty();\n+        if (line.hasOption(MAPPING_FILE)) {\n+            Path mappingFile = context.getFileSystem().getPath(line.getOptionValue(MAPPING_FILE));\n+            mappingSupplier = createMappingSupplier(mappingFile, runner.getName());\n+        }", "originalCommit": "20bafe32614e3fdd69b26fca690637d614820d90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NTE5Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1345#discussion_r439255193", "bodyText": "Done", "author": "marcosmc", "createdAt": "2020-06-12T07:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTY1Mg=="}], "type": "inlineReview"}, {"oid": "a7907bba034aea20d4ce5b1e48189775b6b3c972", "url": "https://github.com/powsybl/powsybl-core/commit/a7907bba034aea20d4ce5b1e48189775b6b3c972", "message": "change \"mapping\" to \"dynamicmodel\"\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-12T07:14:20Z", "type": "commit"}, {"oid": "a9c265289c97cbe8179d45d3e5420cc37f612bdd", "url": "https://github.com/powsybl/powsybl-core/commit/a9c265289c97cbe8179d45d3e5420cc37f612bdd", "message": "Fix logger\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-12T07:46:19Z", "type": "commit"}, {"oid": "7f1aa552b9b99c6651a9737cc79f506a83c63865", "url": "https://github.com/powsybl/powsybl-core/commit/7f1aa552b9b99c6651a9737cc79f506a83c63865", "message": "change \"DynamicModelSupplier\" to \"DynamicModelsSupplier\"\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>", "committedDate": "2020-06-14T09:23:11Z", "type": "commit"}, {"oid": "ad14c6ae7564ea06b4d67e6de9f7434a2197ccfc", "url": "https://github.com/powsybl/powsybl-core/commit/ad14c6ae7564ea06b4d67e6de9f7434a2197ccfc", "message": "Fix implementation\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-06-15T09:11:50Z", "type": "commit"}, {"oid": "e6fc4ce74863bf14eccfaed7b85f2d9ad3eb0d85", "url": "https://github.com/powsybl/powsybl-core/commit/e6fc4ce74863bf14eccfaed7b85f2d9ad3eb0d85", "message": "Merge branch 'master' into dynamic-mapping-provider", "committedDate": "2020-06-15T09:14:01Z", "type": "commit"}]}