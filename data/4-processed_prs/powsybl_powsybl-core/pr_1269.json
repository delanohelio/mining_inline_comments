{"pr_number": 1269, "pr_title": "Add contingency extendable DSL extension", "pr_createdAt": "2020-04-09T16:15:58Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1269", "timeline": [{"oid": "7e1e3376392edcbc52c8978fb3bd05b7ae34b48e", "url": "https://github.com/powsybl/powsybl-core/commit/7e1e3376392edcbc52c8978fb3bd05b7ae34b48e", "message": "Add contingency dsl ext\n\nSigned-off-by: Paul Bui-Quang <paul.buiquang@rte-france.com>", "committedDate": "2020-04-09T16:11:36Z", "type": "commit"}, {"oid": "734c70dff2816b982524a5f66fc73429967ee658", "url": "https://github.com/powsybl/powsybl-core/commit/734c70dff2816b982524a5f66fc73429967ee658", "message": "Use directly contingency base spec\n\nSigned-off-by: Paul Bui-Quang <paul.buiquang@rte-france.com>", "committedDate": "2020-04-09T17:05:13Z", "type": "commit"}, {"oid": "734c70dff2816b982524a5f66fc73429967ee658", "url": "https://github.com/powsybl/powsybl-core/commit/734c70dff2816b982524a5f66fc73429967ee658", "message": "Use directly contingency base spec\n\nSigned-off-by: Paul Bui-Quang <paul.buiquang@rte-france.com>", "committedDate": "2020-04-09T17:05:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyMDQ2OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408120468", "bodyText": "I think this files is not necessary with the @AutoService extension ?", "author": "sylvlecl", "createdAt": "2020-04-14T13:06:34Z", "path": "contingency/contingency-dsl/src/test/resources/META-INF/services/com.powsybl.contingency.dsl.ExtendableDslExtension", "diffHunk": "@@ -0,0 +1 @@\n+com.powsybl.contingency.dsl.ProbabilityContingencyDslExtension", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1Nzc4MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408157781", "bodyText": "actually @autoservice didn't work so I put it manually, I guess I forgot to remove the @autoservice annotation", "author": "pl-buiquang", "createdAt": "2020-04-14T13:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyMDQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0NTc1OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408345759", "bodyText": "I remove this file and after a mvn clean it works. I think you remove it.", "author": "mathbagu", "createdAt": "2020-04-14T18:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyMDQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MjYxMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408342610", "bodyText": "Is it really necessary to make this interface generic? I think if we make it generic, this interface is misplaced and should be moved into powsybl-dsl module.", "author": "mathbagu", "createdAt": "2020-04-14T18:20:28Z", "path": "contingency/contingency-dsl/src/main/java/com/powsybl/contingency/dsl/ExtendableDslExtension.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ *\n+ */\n+\n+package com.powsybl.contingency.dsl;\n+\n+import com.powsybl.commons.extensions.Extendable;\n+import com.powsybl.commons.extensions.Extension;\n+import groovy.lang.Binding;\n+import groovy.lang.MetaClass;\n+\n+import java.util.List;\n+\n+/**\n+ * @author Paul Bui-Quang <paul.buiquang at rte-france.com>\n+ */\n+public interface ExtendableDslExtension<E extends Extendable<E>> {\n+\n+    Class<E> getExtendableClass();\n+\n+    void addToSpec(MetaClass extSpecMetaClass, List<Extension<E>> contingencyExtensions, Binding binding);\n+}", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1NjYxNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408756617", "bodyText": "at first i thought this would be usefull for other extendable objects, and i tried to put it in common or dsl, then i stepped back.\nI will put it in the dsl package though unused really since I extend it with specific ContingencyDslExtension now. Should we let it for future use or not ?", "author": "pl-buiquang", "createdAt": "2020-04-15T10:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MjYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MjcyNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408342724", "bodyText": "remove extra semi-colon", "author": "mathbagu", "createdAt": "2020-04-14T18:20:40Z", "path": "contingency/contingency-dsl/src/main/groovy/com/powsybl/contingency/dsl/ContingencyDslLoader.groovy", "diffHunk": "@@ -85,6 +96,9 @@ class ContingencyDslLoader extends DslLoader {\n                 LOGGER.debug(\"Found contingency '{}'\", id)\n                 observer?.contingencyFound(id)\n                 Contingency contingency = new Contingency(id, elements)\n+                extensionList.forEach({ ext ->\n+                    contingency.addExtension(ext.getClass(), ext);", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0Mjg2OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408342868", "bodyText": "Remove extra empty line", "author": "mathbagu", "createdAt": "2020-04-14T18:20:55Z", "path": "contingency/contingency-dsl/src/main/groovy/com/powsybl/contingency/dsl/ContingencyDslLoader.groovy", "diffHunk": "@@ -57,6 +66,8 @@ class ContingencyDslLoader extends DslLoader {\n             if (contingencySpec.equipments.length == 0) {\n                 throw new DslException(\"'equipments' field is empty\")\n             }\n+\n+", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MzI2Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408343267", "bodyText": "We should introduce a ContingencyDslExtension interface to make this code more compact. The generic seems useless.", "author": "mathbagu", "createdAt": "2020-04-14T18:21:36Z", "path": "contingency/contingency-dsl/src/main/groovy/com/powsybl/contingency/dsl/ContingencyDslLoader.groovy", "diffHunk": "@@ -44,11 +46,18 @@ class ContingencyDslLoader extends DslLoader {\n     }\n \n     static void loadDsl(Binding binding, Network network, Consumer<Contingency> consumer, ContingencyDslObserver observer) {\n-\n         // contingencies\n         binding.contingency = { String id, Closure<Void> closure ->\n             def cloned = closure.clone()\n             ContingencySpec contingencySpec = new ContingencySpec()\n+\n+            List<Extension<Contingency>> extensionList = new ArrayList<>();\n+            for (ExtendableDslExtension dslContingencyExtension : ServiceLoader.load(ExtendableDslExtension.class)) {\n+                if (dslContingencyExtension.getExtendableClass().equals(Contingency.class)) {", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MzYyNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408343626", "bodyText": "Coding style: a space is missing at the end of the line, just before the opening brace.", "author": "mathbagu", "createdAt": "2020-04-14T18:22:11Z", "path": "contingency/contingency-dsl/src/test/groovy/com/powsybl/contingency/dsl/ProbabilityContingencyDslExtension.groovy", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ *\n+ */\n+package com.powsybl.contingency.dsl\n+\n+import com.google.auto.service.AutoService\n+import com.powsybl.commons.extensions.Extension\n+import com.powsybl.contingency.Contingency\n+\n+/**\n+ * @author Paul Bui-Quang <paul.buiquang at rte-france.com>\n+ */\n+@AutoService(ExtendableDslExtension.class)\n+class ProbabilityContingencyDslExtension implements ExtendableDslExtension<Contingency>{", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0MzczMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408343733", "bodyText": "Remove this extra semi-colon.", "author": "mathbagu", "createdAt": "2020-04-14T18:22:22Z", "path": "contingency/contingency-dsl/src/test/groovy/com/powsybl/contingency/dsl/ProbabilityContingencyDslExtension.groovy", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ *\n+ */\n+package com.powsybl.contingency.dsl\n+\n+import com.google.auto.service.AutoService\n+import com.powsybl.commons.extensions.Extension\n+import com.powsybl.contingency.Contingency\n+\n+/**\n+ * @author Paul Bui-Quang <paul.buiquang at rte-france.com>\n+ */\n+@AutoService(ExtendableDslExtension.class)\n+class ProbabilityContingencyDslExtension implements ExtendableDslExtension<Contingency>{\n+    @Override\n+    Class<Contingency> getExtendableClass() {\n+        return Contingency.class;", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0Mzg0Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408343843", "bodyText": "Remove this extra semi-colon", "author": "mathbagu", "createdAt": "2020-04-14T18:22:33Z", "path": "contingency/contingency-dsl/src/test/groovy/com/powsybl/contingency/dsl/ProbabilityContingencyDslExtension.groovy", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ *\n+ */\n+package com.powsybl.contingency.dsl\n+\n+import com.google.auto.service.AutoService\n+import com.powsybl.commons.extensions.Extension\n+import com.powsybl.contingency.Contingency\n+\n+/**\n+ * @author Paul Bui-Quang <paul.buiquang at rte-france.com>\n+ */\n+@AutoService(ExtendableDslExtension.class)\n+class ProbabilityContingencyDslExtension implements ExtendableDslExtension<Contingency>{\n+    @Override\n+    Class<Contingency> getExtendableClass() {\n+        return Contingency.class;\n+    }\n+\n+    @Override\n+    void addToSpec(MetaClass extSpecMetaClass, List<Extension<Contingency>> contingencyExtensions, Binding binding) {\n+        ProbabilityContingencyExtension ext = new ProbabilityContingencyExtension();\n+        extSpecMetaClass.probability = { Closure<Void> closure ->\n+            def cloned = closure.clone()\n+            ProbabilitySpec spec = new ProbabilitySpec()\n+            cloned.delegate = spec\n+            cloned()\n+\n+            ext.probabilityBase = spec.base\n+            ext.probabilityTimeSeriesRef = spec.tsName\n+            contingencyExtensions.add(ext);", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0Mzk2MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408343961", "bodyText": "Maybe a double is OK there", "author": "mathbagu", "createdAt": "2020-04-14T18:22:45Z", "path": "contingency/contingency-dsl/src/test/groovy/com/powsybl/contingency/dsl/ProbabilityContingencyDslExtension.groovy", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ *\n+ */\n+package com.powsybl.contingency.dsl\n+\n+import com.google.auto.service.AutoService\n+import com.powsybl.commons.extensions.Extension\n+import com.powsybl.contingency.Contingency\n+\n+/**\n+ * @author Paul Bui-Quang <paul.buiquang at rte-france.com>\n+ */\n+@AutoService(ExtendableDslExtension.class)\n+class ProbabilityContingencyDslExtension implements ExtendableDslExtension<Contingency>{\n+    @Override\n+    Class<Contingency> getExtendableClass() {\n+        return Contingency.class;\n+    }\n+\n+    @Override\n+    void addToSpec(MetaClass extSpecMetaClass, List<Extension<Contingency>> contingencyExtensions, Binding binding) {\n+        ProbabilityContingencyExtension ext = new ProbabilityContingencyExtension();\n+        extSpecMetaClass.probability = { Closure<Void> closure ->\n+            def cloned = closure.clone()\n+            ProbabilitySpec spec = new ProbabilitySpec()\n+            cloned.delegate = spec\n+            cloned()\n+\n+            ext.probabilityBase = spec.base\n+            ext.probabilityTimeSeriesRef = spec.tsName\n+            contingencyExtensions.add(ext);\n+        }\n+    }\n+\n+    static class ProbabilitySpec {\n+        Double base;", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0OTgwMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408749802", "bodyText": "i want it to be nullable, anyway, this is a test and not a real extension", "author": "pl-buiquang", "createdAt": "2020-04-15T10:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0Mzk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0NDcxOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408344719", "bodyText": "It just a detail, but:\n\ncould you indent the code propertly\ncould you add another contingency and check below that there is no extension for the second contingency", "author": "mathbagu", "createdAt": "2020-04-14T18:23:58Z", "path": "contingency/contingency-dsl/src/test/java/com/powsybl/contingency/dsl/GroovyDslContingenciesProviderTest.java", "diffHunk": "@@ -179,4 +179,20 @@ public void withComparison() throws IOException {\n                 .getContingencies(network);\n         assertTrue(contingencies.isEmpty());\n     }\n+\n+    @Test\n+    public void testExtension() throws IOException {\n+        writeToDslFile(\"contingency('test') {\",\n+                \"        equipments 'NHV1_NHV2_1'\",\n+                \"           probability {\",\n+                \"              base 0.1\",\n+                \"              tsName 'myTs'\",\n+                \"           }\",", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0NTE1Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408345153", "bodyText": "Same remark about double", "author": "mathbagu", "createdAt": "2020-04-14T18:24:41Z", "path": "contingency/contingency-dsl/src/test/java/com/powsybl/contingency/dsl/ProbabilityContingencyExtension.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ *\n+ */\n+\n+package com.powsybl.contingency.dsl;\n+\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.contingency.Contingency;\n+\n+/**\n+ * @author Paul Bui-Quang <paul.buiquang at rte-france.com>\n+ */\n+public class ProbabilityContingencyExtension implements Extension<Contingency> {\n+    private Contingency contingency;\n+\n+    private Double probabilityBase = 1.0;", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1NzgxNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408757816", "bodyText": "i want it to be nullable, anyway, this is a test and not a real extension", "author": "pl-buiquang", "createdAt": "2020-04-15T11:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0NTE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM0NDI1Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r409344253", "bodyText": "You have to choose: if it's nullable, you have to be consistent with the getter. If not, you have to change the variable type.\nEven we are in unit test, it's not a good reason to not pay attention the way we are coding.", "author": "mathbagu", "createdAt": "2020-04-16T07:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0NTE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0NTUwMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1269#discussion_r408345502", "bodyText": "Proposal: inherit from AbstractExtension", "author": "mathbagu", "createdAt": "2020-04-14T18:25:15Z", "path": "contingency/contingency-dsl/src/test/java/com/powsybl/contingency/dsl/ProbabilityContingencyExtension.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ *\n+ */\n+\n+package com.powsybl.contingency.dsl;\n+\n+import com.powsybl.commons.extensions.Extension;\n+import com.powsybl.contingency.Contingency;\n+\n+/**\n+ * @author Paul Bui-Quang <paul.buiquang at rte-france.com>\n+ */\n+public class ProbabilityContingencyExtension implements Extension<Contingency> {", "originalCommit": "734c70dff2816b982524a5f66fc73429967ee658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04dabd3d3b30a8d0d2e655252b40a4379afab04d", "url": "https://github.com/powsybl/powsybl-core/commit/04dabd3d3b30a8d0d2e655252b40a4379afab04d", "message": "Review fixes\n\nSigned-off-by: Paul Bui-Quang <paul.buiquang@rte-france.com>", "committedDate": "2020-04-15T10:59:49Z", "type": "commit"}, {"oid": "a1927f90918806f8bd5742cbf61eda095bc5a58a", "url": "https://github.com/powsybl/powsybl-core/commit/a1927f90918806f8bd5742cbf61eda095bc5a58a", "message": "Fix\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-04-16T07:52:14Z", "type": "commit"}, {"oid": "6d30503158be01e65f66a020fd155010635f8cbe", "url": "https://github.com/powsybl/powsybl-core/commit/6d30503158be01e65f66a020fd155010635f8cbe", "message": "Merge branch 'master' into pbq/add_contingency_dsl_ext", "committedDate": "2020-04-16T07:55:51Z", "type": "commit"}]}