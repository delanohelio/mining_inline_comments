{"pr_number": 1357, "pr_title": "DanglingLine with generation attributes", "pr_createdAt": "2020-06-18T14:05:11Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1357", "timeline": [{"oid": "c0a2dcc9f557676379894217b5b340e675a4d83a", "url": "https://github.com/powsybl/powsybl-core/commit/c0a2dcc9f557676379894217b5b340e675a4d83a", "message": "First import of new DanglingLine API + Impl to support voltage regulation.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-18T13:51:28Z", "type": "commit"}, {"oid": "034dfba7d4a491cdd0bd68dbd820b882a4e248e4", "url": "https://github.com/powsybl/powsybl-core/commit/034dfba7d4a491cdd0bd68dbd820b882a4e248e4", "message": "Fix comments.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-18T14:09:48Z", "type": "commit"}, {"oid": "9371b0d83ac3a751ea0ddd9e8d7a6fa736d01937", "url": "https://github.com/powsybl/powsybl-core/commit/9371b0d83ac3a751ea0ddd9e8d7a6fa736d01937", "message": "add default implementations (prevent breaking changes)\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-06-19T09:28:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjczMzMwMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r442733302", "bodyText": "Just a question, why do we use this and not something like regulationType that can be OFF, VOLTAGE and REACTIVE? Here when there is no voltage regulation, how can we know if there is an active or reactive regulation or not at all?", "author": "MioRtia", "createdAt": "2020-06-19T09:29:47Z", "path": "iidm/iidm-api/src/main/java/com/powsybl/iidm/network/DanglingLine.java", "diffHunk": "@@ -92,6 +92,79 @@\n      */\n     DanglingLine setB(double b);\n \n+    /**\n+     * <p>Get the active power setpoint in MW.</p>\n+     * <p>The active power setpoint follows a load sign convention.</p>\n+     * <p>Depends on the working variant.</p>\n+     * @return the reactive power setpoint\n+     */\n+    default double getActivePowerSetpoint() {\n+        return Double.NaN;\n+    }\n+\n+    /**\n+     * <p>Set the active power setpoint in MW.</p>\n+     * <p>Depends on the working variant.</p>\n+     * @param activePowerSetpoint the active power setpoint\n+     * @return this to allow method chaining\n+     */\n+    default DanglingLine setActivePowerSetpoint(double activePowerSetpoint) {\n+        return this;\n+    }\n+\n+    /**\n+     * <p>Get the reactive power setpoint in MVAR.</p>\n+     * <p>The reactive power setpoint follows a load sign convention.</p>\n+     * <p>Depends on the working variant.</p>\n+     * @return the reactive power setpoint\n+     */\n+    default double getReactivePowerSetpoint() {\n+        return Double.NaN;\n+    }\n+\n+    /**\n+     * <p>Set the reactive power setpoint in MVAR.</p>\n+     * <p>Depends on the working variant.</p>\n+     * @param reactivePowerSetpoint the reactive power setpoint\n+     * @return this to allow method chaining\n+     */\n+    default DanglingLine setReactivePowerSetpoint(double reactivePowerSetpoint) {\n+        return this;\n+    }\n+\n+    /**\n+     * Get the voltage regulation status.\n+     */\n+    default boolean isVoltageRegulationOn() {", "originalCommit": "9371b0d83ac3a751ea0ddd9e8d7a6fa736d01937", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgwMTc4Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r442801786", "bodyText": "@zamarrenolm What do you think?", "author": "miovd", "createdAt": "2020-06-19T12:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjczMzMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMDg0Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r443610842", "bodyText": "I think for dangling lines we should consider only voltage regulation, like in generators. In fact, we should duplicate the attributes from the IIDM generator into the dangling line, to highlight the fact that we are adding just an implicit/fictitious generator at the boundary end of the dangling line.", "author": "zamarrenolm", "createdAt": "2020-06-22T14:42:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjczMzMwMg=="}], "type": "inlineReview"}, {"oid": "81eb0f0665d9dab2bcb00b384b1e5272d72156f2", "url": "https://github.com/powsybl/powsybl-core/commit/81eb0f0665d9dab2bcb00b384b1e5272d72156f2", "message": "New proposal after review.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-22T13:00:40Z", "type": "commit"}, {"oid": "b38ce7cbfd9be3a3c341d666664fb49289b5d041", "url": "https://github.com/powsybl/powsybl-core/commit/b38ce7cbfd9be3a3c341d666664fb49289b5d041", "message": "Merge branch 'xnode-with-regulating-capability' of https://github.com/powsybl/powsybl-core into xnode-with-regulating-capability", "committedDate": "2020-06-22T13:12:56Z", "type": "commit"}, {"oid": "370bc22fe0ffcfdd449ce93ca56334c077bab63c", "url": "https://github.com/powsybl/powsybl-core/commit/370bc22fe0ffcfdd449ce93ca56334c077bab63c", "message": "Fix API.\nFirst import of the UCTE conversion.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-22T15:43:27Z", "type": "commit"}, {"oid": "7d26648d1bb53b4b188b7c4d324bffa47924b849", "url": "https://github.com/powsybl/powsybl-core/commit/7d26648d1bb53b4b188b7c4d324bffa47924b849", "message": "Fix.\nImprove UCTE import.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-22T16:35:52Z", "type": "commit"}, {"oid": "39f7e1d9bbfb271156ceddd7192e06fc1187da2c", "url": "https://github.com/powsybl/powsybl-core/commit/39f7e1d9bbfb271156ceddd7192e06fc1187da2c", "message": "consider equivalent injections regulating voltage: define generator-like properties for dangling lines\n\nSigned-off-by: Luma <zamarrenolm@aia.es>", "committedDate": "2020-06-22T18:28:29Z", "type": "commit"}, {"oid": "0d1c815ffddc50ff882d1ff79b87ea0ae317c4b2", "url": "https://github.com/powsybl/powsybl-core/commit/0d1c815ffddc50ff882d1ff79b87ea0ae317c4b2", "message": "Add maxP and mixP attributes to the generation part of the DanglingLine.\nFix UCTE importer.\nFix CGMES conversion.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-24T06:34:38Z", "type": "commit"}, {"oid": "088a70431d47578af825cda7dd4c608876859f33", "url": "https://github.com/powsybl/powsybl-core/commit/088a70431d47578af825cda7dd4c608876859f33", "message": "Fix UCTE export.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-24T07:55:47Z", "type": "commit"}, {"oid": "228963aafced5eeee347860f7b37924c27ce06f8", "url": "https://github.com/powsybl/powsybl-core/commit/228963aafced5eeee347860f7b37924c27ce06f8", "message": "Merge branch 'master' into xnode-with-regulating-capability\n\nSigned-off-by: Luma <zamarrenolm@aia.es>\n\n# Conflicts:\n#\tcgmes/cgmes-conformity/src/test/java/com/powsybl/cgmes/conformity/test/CgmesConformity1ModifiedCatalog.java\n#\tcgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/conformity/modified/CgmesConformity1ModifiedConversionTest.java", "committedDate": "2020-06-25T12:07:09Z", "type": "commit"}, {"oid": "696fd2e53a88f90efb95f8eae39b6b38f837f7b9", "url": "https://github.com/powsybl/powsybl-core/commit/696fd2e53a88f90efb95f8eae39b6b38f837f7b9", "message": "Merge branch 'master' into xnode-with-regulating-capability", "committedDate": "2020-06-26T14:17:10Z", "type": "commit"}, {"oid": "c7a3a4b6ee47b5fdf5cbe55748f872c981f79cf3", "url": "https://github.com/powsybl/powsybl-core/commit/c7a3a4b6ee47b5fdf5cbe55748f872c981f79cf3", "message": "Increase unit test.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-06-26T14:25:10Z", "type": "commit"}, {"oid": "b737c3b46d04aae44765122ce8e7323183ede0e0", "url": "https://github.com/powsybl/powsybl-core/commit/b737c3b46d04aae44765122ce8e7323183ede0e0", "message": "Some corrections: delete zip package + generatorMinP and generatorMaxP defined in DL adder used in DL + added check in DL adder + assert in DL test\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-06-30T08:19:28Z", "type": "commit"}, {"oid": "cc8ed33da6b2955a0aa2e592da942ca3827dec5d", "url": "https://github.com/powsybl/powsybl-core/commit/cc8ed33da6b2955a0aa2e592da942ca3827dec5d", "message": "Refactoring: sub element \"Generation\" in DanglingLine\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-07T15:55:52Z", "type": "commit"}, {"oid": "c2475c41e8966a81bb01c81285e72dc98eb49d2e", "url": "https://github.com/powsybl/powsybl-core/commit/c2475c41e8966a81bb01c81285e72dc98eb49d2e", "message": "Merge branch 'master' into xnode-with-regulating-capability\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>\n\n# Conflicts:\n#\tcgmes/cgmes-conformity/src/test/java/com/powsybl/cgmes/conformity/test/CgmesConformity1ModifiedCatalog.java\n#\tcgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/conformity/modified/CgmesConformity1ModifiedConversionTest.java", "committedDate": "2020-07-07T15:58:10Z", "type": "commit"}, {"oid": "57058d01d381201113543e202d5ff7fc7b84c081", "url": "https://github.com/powsybl/powsybl-core/commit/57058d01d381201113543e202d5ff7fc7b84c081", "message": "Implement XIIDM serialization\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-07T16:33:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2Njg3Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451466872", "bodyText": "Could be write in a single line: nodesEquivalentInjections.computeIfAbsent(node, ls -> new ArrayList<>(2)).add(equivalentInjection);\nWhy do you set the capacity to 2?", "author": "mathbagu", "createdAt": "2020-07-08T11:18:58Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/Boundary.java", "diffHunk": "@@ -70,6 +71,12 @@ public void addLineAtNode(PropertyBag line, String node) {\n         lines.add(line);\n     }\n \n+    public void addEquivalentInjectionAtNode(PropertyBag equivalentInjection, String node) {\n+        List<PropertyBag> equivalentInjections;\n+        equivalentInjections = nodesEquivalentInjections.computeIfAbsent(node, ls -> new ArrayList<>(2));\n+        equivalentInjections.add(equivalentInjection);", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ5MTU3MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451491570", "bodyText": "@annetill Is there a reason? I didn't touch your code here.", "author": "miovd", "createdAt": "2020-07-08T12:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2Njg3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYxMzA5Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451613096", "bodyText": "Rectification: it seems to be @zamarrenolm's code. @zamarrenolm can you tell us why the list capacity is at 2 please?", "author": "miovd", "createdAt": "2020-07-08T15:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2Njg3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NDg4Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r452054887", "bodyText": "Because in a boundary TN, you have 2 EquivalentInjections, one for each IGM.", "author": "annetill", "createdAt": "2020-07-09T08:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2Njg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2NzcyNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451467725", "bodyText": "You should move this line at line 156.", "author": "mathbagu", "createdAt": "2020-07-08T11:20:42Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/ACLineSegmentConversion.java", "diffHunk": "@@ -131,26 +131,43 @@ private void convertDanglingLine(int boundarySide) {\n         // _5150a037-e241-421f-98b2-fe60e5c90303 XQ1-N1\n         // ends in a boundary node where there is no other line,\n         // does not have energy consumer or equivalent injection\n-        if (terminalConnected(boundarySide) && !context.boundary().hasPowerFlow(boundaryNode)) {\n+        if (terminalConnected(boundarySide)\n+                && !context.boundary().hasPowerFlow(boundaryNode)\n+                && context.boundary().equivalentInjectionsAtNode(boundaryNode).isEmpty()) {\n             missing(\"Equipment for modeling consumption/injection at boundary node\");\n         }\n \n         double r = p.asDouble(\"r\");\n         double x = p.asDouble(\"x\");\n         double bch = p.asDouble(\"bch\");\n         double gch = p.asDouble(\"gch\", 0.0);\n-        DanglingLineAdder adder = voltageLevel(modelSide).newDanglingLine()\n+        DanglingLineAdder dlAdder = voltageLevel(modelSide).newDanglingLine()\n                 .setEnsureIdUnicity(false)\n                 .setR(r)\n                 .setX(x)\n                 .setG(gch)\n                 .setB(bch)\n-                .setUcteXnodeCode(findUcteXnodeCode(boundaryNode))\n-                .setP0(f.p())\n-                .setQ0(f.q());\n-        identify(adder);\n-        connect(adder, modelSide);\n-        DanglingLine dl = adder.add();\n+                .setUcteXnodeCode(findUcteXnodeCode(boundaryNode));\n+        identify(dlAdder);\n+        connect(dlAdder, modelSide);\n+        EquivalentInjectionConversion equivalentInjectionConversion = getEquivalentInjectionConversionForDanglingLine(boundaryNode);\n+        DanglingLine dl;\n+        if (equivalentInjectionConversion != null) {\n+            dl = equivalentInjectionConversion.convertOverDanglingLine(dlAdder, f);\n+        } else {\n+            dl = dlAdder.setP0(f.p())\n+                    .setQ0(f.q())\n+                    .add();\n+            dl.newGeneration()\n+                    .setTargetP(0.0)\n+                    .setTargetQ(0.0)\n+                    .setTargetV(Double.NaN)\n+                    .setVoltageRegulationOn(false)\n+                    .add();\n+        }\n+        if (equivalentInjectionConversion != null) {\n+            equivalentInjectionConversion.convertReactiveLimits(dl);", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2OTA4Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451469087", "bodyText": "It's a bit weird: why the generation is not created using the adder, but using the DanglingLine?", "author": "mathbagu", "createdAt": "2020-07-08T11:23:33Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/EquivalentInjectionConversion.java", "diffHunk": "@@ -21,55 +19,128 @@\n \n     private static final String REGULATION_TARGET = \"regulationTarget\";\n \n-    public EquivalentInjectionConversion(PropertyBag sm, Context context) {\n-        super(\"EquivalentInjection\", sm, context);\n+    public EquivalentInjectionConversion(PropertyBag ei, Context context) {\n+        super(\"EquivalentInjection\", ei, context);\n+    }\n+\n+    @Override\n+    public void convertInsideBoundary() {\n+        if (context.config().convertBoundary()) {\n+            if (valid()) {\n+                convert();\n+            }\n+        } else {\n+            // If we find an Equivalent Injection at a boundary\n+            // we will decide later what to do with it\n+            //\n+            // If finally a dangling line is created at the boundary node\n+            // and the equivalent injection is regulating voltage\n+            // we will have to transfer regulating voltage data\n+            // from the equivalent injection to the dangling line\n+            context.boundary().addEquivalentInjectionAtNode(this.p, nodeId());\n+        }\n     }\n \n     @Override\n     public void convert() {\n+        // An equivalent injection found inside a modeling authority data\n+        // will be mapped to a Generator\n+        convertToGenerator();\n+    }\n+\n+    // A dangling line has been created at the boundary node of the equivalent injection\n+    public DanglingLine convertOverDanglingLine(DanglingLineAdder adder, PowerFlow fother) {\n+        Regulation regulation = getRegulation();\n+        DanglingLine dl;\n+        if (regulation.status) {\n+            // If this equivalent injection is regulating voltage,\n+            // map it over the dangling line 'virtual generator'\n+            dl = adder\n+                    .setP0(fother.p())\n+                    .setQ0(fother.q())\n+                    .add();\n+            dl.newGeneration()", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ5MDUxMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451490510", "bodyText": "I used this design (similar to reactive limits for example) because the dangling line object can be consistent without it (contrary to shunt model or T3W's legs for example). Do you think it would be better to put it in DLAdder?", "author": "miovd", "createdAt": "2020-07-08T12:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2OTA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2OTkxNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451469917", "bodyText": "This class should be moved into the DanglingLineAdder?", "author": "mathbagu", "createdAt": "2020-07-08T11:25:14Z", "path": "iidm/iidm-api/src/main/java/com/powsybl/iidm/network/DanglingLine.java", "diffHunk": "@@ -20,9 +20,106 @@\n  * <p>To create a dangling line, see {@link DanglingLineAdder}\n  *\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Anne Tilloy <anne.tilloy at rte-france.com>\n  * @see DanglingLineAdder\n  */\n-public interface DanglingLine extends Injection<DanglingLine> {\n+public interface DanglingLine extends Injection<DanglingLine>, ReactiveLimitsHolder {\n+\n+    interface Generation {\n+        /**\n+         * <p>Get the generator active power target in MW.</p>\n+         * <p>The active power target follows a generator sign convention.</p>\n+         * <p>Depends on the working variant.</p>\n+         * @return the generator active power target\n+         */\n+        double getTargetP();\n+\n+        /**\n+         * <p>Set the generator active power target in MW.</p>\n+         * <p>Depends on the working variant.</p>\n+         * @param targetP the generator active power target\n+         * @return this to allow method chaining\n+         */\n+        Generation setTargetP(double targetP);\n+\n+        /**\n+         * Get the generator maximal active power in MW.\n+         */\n+        double getMaxP();\n+\n+        /**\n+         * Set the generator maximal active power in MW.\n+         */\n+        Generation setMaxP(double maxP);\n+\n+        /**\n+         * Get the generator minimal active power in MW.\n+         */\n+        double getMinP();\n+\n+        /**\n+         * Set the generator minimal active power in MW.\n+         */\n+        Generation setMinP(double minP);\n+\n+        /**\n+         * <p>Get the generator reactive power target in MVAR.</p>\n+         * <p>The generator reactive power target follows a generator sign convention.</p>\n+         * <p>Depends on the working variant.</p>\n+         * @return the generator reactive power target\n+         */\n+        double getTargetQ();\n+\n+        /**\n+         * <p>Set the generator reactive power target in MVAR.</p>\n+         * <p>Depends on the working variant.</p>\n+         * @param targetQ the generator reactive power target\n+         * @return this to allow method chaining\n+         */\n+        Generation setTargetQ(double targetQ);\n+\n+        /**\n+         * Get the generator voltage regulation status.\n+         */\n+        boolean isVoltageRegulationOn();\n+\n+        /**\n+         * Set the generator voltage regulation status.\n+         */\n+        Generation setVoltageRegulationOn(boolean voltageRegulationOn);\n+\n+        /**\n+         * <p>Get the generator voltage target in Kv.</p>\n+         * <p>Depends on the working variant.</p>\n+         * @return the generator voltage target\n+         */\n+        double getTargetV();\n+\n+        /**\n+         * <p>Set the generator voltage target in Kv.</p>\n+         * <p>Depends on the working variant.</p>\n+         * @param targetV the generator voltage target\n+         * @return this to allow method chaining\n+         */\n+        Generation setTargetV(double targetV);\n+    }\n+\n+    interface GenerationAdder {", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MDM2Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451470362", "bodyText": "To be reverted if you do not make any change", "author": "mathbagu", "createdAt": "2020-07-08T11:26:07Z", "path": "iidm/iidm-api/src/main/java/com/powsybl/iidm/network/DanglingLineAdder.java", "diffHunk": "@@ -21,6 +21,7 @@\n  *</pre>\n  *\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Anne Tilloy <anne.tilloy at rte-france.com>", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MDQyNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451470426", "bodyText": "Same remark", "author": "mathbagu", "createdAt": "2020-07-08T11:26:15Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineAdderImpl.java", "diffHunk": "@@ -12,6 +12,8 @@\n /**\n  *\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Anne Tilloy <anne.tilloy at rte-france.com>", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MDk1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451470952", "bodyText": "I think it's not necessary to inherit from MultiVariantObject. If the enclosing object is alreay a MultiVariantObject it could be ok", "author": "mathbagu", "createdAt": "2020-07-08T11:27:17Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineImpl.java", "diffHunk": "@@ -6,18 +6,226 @@\n  */\n package com.powsybl.iidm.network.impl;\n \n-import com.powsybl.iidm.network.CurrentLimitsAdder;\n-import com.powsybl.iidm.network.ConnectableType;\n-import com.powsybl.iidm.network.DanglingLine;\n-import com.powsybl.iidm.network.ValidationUtil;\n+import com.powsybl.commons.util.trove.TBooleanArrayList;\n+import com.powsybl.iidm.network.*;\n import com.powsybl.iidm.network.impl.util.Ref;\n import gnu.trove.list.array.TDoubleArrayList;\n \n /**\n  *\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n  */\n-class DanglingLineImpl extends AbstractConnectable<DanglingLine> implements DanglingLine, CurrentLimitsOwner<Void> {\n+class DanglingLineImpl extends AbstractConnectable<DanglingLine> implements DanglingLine, CurrentLimitsOwner<Void>, ReactiveLimitsOwner {\n+\n+    class GenerationImpl implements Generation, MultiVariantObject {", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ5MTcyOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451491729", "bodyText": "I'll change it", "author": "miovd", "createdAt": "2020-07-08T12:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MDk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MTMwNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451471306", "bodyText": "To be moved into DanglingAdderImpl", "author": "mathbagu", "createdAt": "2020-07-08T11:27:55Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineImpl.java", "diffHunk": "@@ -6,18 +6,226 @@\n  */\n package com.powsybl.iidm.network.impl;\n \n-import com.powsybl.iidm.network.CurrentLimitsAdder;\n-import com.powsybl.iidm.network.ConnectableType;\n-import com.powsybl.iidm.network.DanglingLine;\n-import com.powsybl.iidm.network.ValidationUtil;\n+import com.powsybl.commons.util.trove.TBooleanArrayList;\n+import com.powsybl.iidm.network.*;\n import com.powsybl.iidm.network.impl.util.Ref;\n import gnu.trove.list.array.TDoubleArrayList;\n \n /**\n  *\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n  */\n-class DanglingLineImpl extends AbstractConnectable<DanglingLine> implements DanglingLine, CurrentLimitsOwner<Void> {\n+class DanglingLineImpl extends AbstractConnectable<DanglingLine> implements DanglingLine, CurrentLimitsOwner<Void>, ReactiveLimitsOwner {\n+\n+    class GenerationImpl implements Generation, MultiVariantObject {\n+\n+        private double minP;\n+\n+        private double maxP;\n+\n+        // attributes depending on the variant\n+\n+        private final TDoubleArrayList targetP;\n+\n+        private final TDoubleArrayList targetQ;\n+\n+        private final TBooleanArrayList voltageRegulationOn;\n+\n+        private final TDoubleArrayList targetV;\n+\n+        GenerationImpl(double minP, double maxP, double targetP, double targetQ, boolean voltageRegulationOn, double targetV) {\n+            int variantArraySize = network.get().getVariantManager().getVariantArraySize();\n+            this.targetP = new TDoubleArrayList(variantArraySize);\n+            this.targetQ = new TDoubleArrayList(variantArraySize);\n+            this.voltageRegulationOn = new TBooleanArrayList(variantArraySize);\n+            this.targetV = new TDoubleArrayList(variantArraySize);\n+            this.minP = minP;\n+            this.maxP = maxP;\n+            for (int i = 0; i < variantArraySize; i++) {\n+                this.targetP.add(targetP);\n+                this.targetQ.add(targetQ);\n+                this.voltageRegulationOn.add(voltageRegulationOn);\n+                this.targetV.add(targetV);\n+            }\n+        }\n+\n+        @Override\n+        public double getTargetP() {\n+            return targetP.get(getNetwork().getVariantIndex());\n+        }\n+\n+        @Override\n+        public GenerationImpl setTargetP(double targetP) {\n+            int variantIndex = network.get().getVariantIndex();\n+            double oldValue = this.targetP.set(variantIndex, targetP);\n+            String variantId = network.get().getVariantManager().getVariantId(variantIndex);\n+            notifyUpdate(\"targetP\", variantId, oldValue, targetP);\n+            return this;\n+        }\n+\n+        @Override\n+        public double getMaxP() {\n+            return maxP;\n+        }\n+\n+        @Override\n+        public GenerationImpl setMaxP(double maxP) {\n+            ValidationUtil.checkMaxP(DanglingLineImpl.this, maxP);\n+            ValidationUtil.checkActivePowerLimits(DanglingLineImpl.this, minP, maxP);\n+            double oldValue = this.maxP;\n+            this.maxP = maxP;\n+            notifyUpdate(\"maxP\", oldValue, maxP);\n+            return this;\n+        }\n+\n+        @Override\n+        public double getMinP() {\n+            return minP;\n+        }\n+\n+        @Override\n+        public GenerationImpl setMinP(double minP) {\n+            ValidationUtil.checkMinP(DanglingLineImpl.this, minP);\n+            ValidationUtil.checkActivePowerLimits(DanglingLineImpl.this, minP, maxP);\n+            double oldValue = this.minP;\n+            this.minP = minP;\n+            notifyUpdate(\"minP\", oldValue, minP);\n+            return this;\n+        }\n+\n+        @Override\n+        public double getTargetQ() {\n+            return targetQ.get(getNetwork().getVariantIndex());\n+        }\n+\n+        @Override\n+        public GenerationImpl setTargetQ(double targetQ) {\n+            int variantIndex = network.get().getVariantIndex();\n+            double oldValue = this.targetQ.set(variantIndex, targetQ);\n+            String variantId = network.get().getVariantManager().getVariantId(variantIndex);\n+            notifyUpdate(\"targetQ\", variantId, oldValue, targetQ);\n+            return this;\n+        }\n+\n+        @Override\n+        public boolean isVoltageRegulationOn() {\n+            return voltageRegulationOn.get(getNetwork().getVariantIndex());\n+        }\n+\n+        @Override\n+        public GenerationImpl setVoltageRegulationOn(boolean voltageRegulationOn) {\n+            int variantIndex = getNetwork().getVariantIndex();\n+            boolean oldValue = this.voltageRegulationOn.get(variantIndex);\n+            this.voltageRegulationOn.set(variantIndex, voltageRegulationOn);\n+            String variantId = getNetwork().getVariantManager().getVariantId(variantIndex);\n+            notifyUpdate(\"voltageRegulationOn\", variantId, oldValue, voltageRegulationOn);\n+            return this;\n+        }\n+\n+        @Override\n+        public double getTargetV() {\n+            return this.targetV.get(getNetwork().getVariantIndex());\n+        }\n+\n+        @Override\n+        public GenerationImpl setTargetV(double targetV) {\n+            int variantIndex = getNetwork().getVariantIndex();\n+            double oldValue = this.targetV.set(variantIndex, targetV);\n+            String variantId = getNetwork().getVariantManager().getVariantId(variantIndex);\n+            notifyUpdate(\"targetV\", variantId, oldValue, targetV);\n+            return this;\n+        }\n+\n+        @Override\n+        public void extendVariantArraySize(int initVariantArraySize, int number, int sourceIndex) {\n+            targetP.ensureCapacity(targetP.size() + number);\n+            targetQ.ensureCapacity(targetQ.size() + number);\n+            voltageRegulationOn.ensureCapacity(voltageRegulationOn.size() + number);\n+            targetV.ensureCapacity(targetV.size() + number);\n+            for (int i = 0; i < number; i++) {\n+                targetP.add(targetP.get(sourceIndex));\n+                targetQ.add(targetQ.get(sourceIndex));\n+                voltageRegulationOn.add(voltageRegulationOn.get(sourceIndex));\n+                targetV.add(targetV.get(sourceIndex));\n+            }\n+        }\n+\n+        @Override\n+        public void reduceVariantArraySize(int number) {\n+            targetP.remove(targetP.size() - number, number);\n+            targetQ.remove(targetQ.size() - number, number);\n+            voltageRegulationOn.remove(voltageRegulationOn.size() - number, number);\n+            targetV.remove(targetV.size() - number, number);\n+        }\n+\n+        @Override\n+        public void deleteVariantArrayElement(int index) {\n+            // nothing to do\n+        }\n+\n+        @Override\n+        public void allocateVariantArrayElement(int[] indexes, int sourceIndex) {\n+            for (int index : indexes) {\n+                targetP.set(index, targetP.get(sourceIndex));\n+                targetQ.set(index, targetQ.get(sourceIndex));\n+                voltageRegulationOn.set(index, voltageRegulationOn.get(sourceIndex));\n+                targetV.set(index, targetV.get(sourceIndex));\n+            }\n+        }\n+    }\n+\n+    class GenerationAdderImpl implements GenerationAdder {", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MjMyMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451472321", "bodyText": "Maybe the reactiveLimits should be hold by the generation object: does it make sense to have no generation but a reactiveLimits?", "author": "mathbagu", "createdAt": "2020-07-08T11:30:06Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineImpl.java", "diffHunk": "@@ -31,15 +239,20 @@\n \n     private final String ucteXnodeCode;\n \n+    private GenerationImpl generation;\n+\n     private CurrentLimitsImpl limits;\n \n+    private final ReactiveLimitsHolderImpl reactiveLimits;", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ5MTEyOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451491129", "bodyText": "No, you are right, I am changing it", "author": "miovd", "createdAt": "2020-07-08T12:07:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MjMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3Mzc2NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r451473764", "bodyText": "You should create a generation only if necessary: i.e there is a voltage setpoint or a power generation?", "author": "mathbagu", "createdAt": "2020-07-08T11:33:02Z", "path": "ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteImporter.java", "diffHunk": "@@ -257,6 +247,23 @@ private static void createDanglingLine(UcteLine ucteLine, boolean connected,\n                 .setQ0(q0)\n                 .setUcteXnodeCode(xnode.getCode().toString())\n                 .add();\n+        dl.newGeneration()\n+                .setTargetP(-targetP)\n+                .setTargetQ(-targetQ)\n+                .add();", "originalCommit": "57058d01d381201113543e202d5ff7fc7b84c081", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA2Mzg0OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455063849", "bodyText": "@annetill Are these values used in loadflow even when there is no voltage setpoint and/or power generation?", "author": "miovd", "createdAt": "2020-07-15T13:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3Mzc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTU2OTc1NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455569754", "bodyText": "If the generator is regulating voltage, I use the voltage setpoint, otherwise I use the generator targetQ. From CGMES files, I will most of the time use only P0 and Q0. From UCTE file, I will most of the time have both load part and generation part, as it is described in the input data.", "author": "annetill", "createdAt": "2020-07-16T07:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3Mzc2NA=="}], "type": "inlineReview"}, {"oid": "2b083a1d90e86ec46b9debe6ca0c6f640edb8df2", "url": "https://github.com/powsybl/powsybl-core/commit/2b083a1d90e86ec46b9debe6ca0c6f640edb8df2", "message": "Move reactive limits to DL.generation + small modifications of implementations\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-08T14:27:12Z", "type": "commit"}, {"oid": "8d061939a03e42f0adc0b3f78bb88369bd4235dd", "url": "https://github.com/powsybl/powsybl-core/commit/8d061939a03e42f0adc0b3f78bb88369bd4235dd", "message": "Make code more synthetic\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-15T07:46:43Z", "type": "commit"}, {"oid": "38a012d038a4fb0285e0ae01563f8df0fbad61d8", "url": "https://github.com/powsybl/powsybl-core/commit/38a012d038a4fb0285e0ae01563f8df0fbad61d8", "message": "Small enhancement\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-15T07:53:23Z", "type": "commit"}, {"oid": "482bcd2a1620cd541e91920138e216290d6802a5", "url": "https://github.com/powsybl/powsybl-core/commit/482bcd2a1620cd541e91920138e216290d6802a5", "message": "Merge branch 'master' into xnode-with-regulating-capability", "committedDate": "2020-07-15T12:03:24Z", "type": "commit"}, {"oid": "b68d4ed28becab9544fa7e4fab0214daf4e72330", "url": "https://github.com/powsybl/powsybl-core/commit/b68d4ed28becab9544fa7e4fab0214daf4e72330", "message": "Add a unit test in the UCTE importer.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-07-15T12:53:26Z", "type": "commit"}, {"oid": "6f1d6e45135ccd70543f4931daed04250ac5045b", "url": "https://github.com/powsybl/powsybl-core/commit/6f1d6e45135ccd70543f4931daed04250ac5045b", "message": "Move GenerationAdder inside DanglingLineAdder\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-15T15:30:15Z", "type": "commit"}, {"oid": "1ff6d985e439c8d7924d0fbd33f2c260a908e84f", "url": "https://github.com/powsybl/powsybl-core/commit/1ff6d985e439c8d7924d0fbd33f2c260a908e84f", "message": "Write reactive limits of generation\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T07:54:08Z", "type": "commit"}, {"oid": "c9bba1f919de7cddccdc37217170497871efbcb4", "url": "https://github.com/powsybl/powsybl-core/commit/c9bba1f919de7cddccdc37217170497871efbcb4", "message": "Correction in serialization of reactive limits of dangling line's generation\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T08:30:13Z", "type": "commit"}, {"oid": "2c5a58180db110d122de2b2fcb4ee45a92925ef9", "url": "https://github.com/powsybl/powsybl-core/commit/2c5a58180db110d122de2b2fcb4ee45a92925ef9", "message": "Add tests\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T08:41:19Z", "type": "commit"}, {"oid": "9afe9a74659545986366546622f92c642c311a27", "url": "https://github.com/powsybl/powsybl-core/commit/9afe9a74659545986366546622f92c642c311a27", "message": "Refactor (code smells)\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T08:55:18Z", "type": "commit"}, {"oid": "fcab7d06b95af527efa738b53e993174e69a08d9", "url": "https://github.com/powsybl/powsybl-core/commit/fcab7d06b95af527efa738b53e993174e69a08d9", "message": "Add tests\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T09:13:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MTkxMw==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455661913", "bodyText": "In GeneratorAdderImpl, we check a lot of thing I would expect to find here such as:\n\nValidationUtil.checkMinP(this, minP);\nValidationUtil.checkMaxP(this, maxP);\nValidationUtil.checkActivePowerSetpoint(this, targetP);\nValidationUtil.checkVoltageControl(this, voltageRegulatorOn, targetV, targetQ);", "author": "mathbagu", "createdAt": "2020-07-16T09:45:01Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineAdderImpl.java", "diffHunk": "@@ -12,9 +12,64 @@\n /**\n  *\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Anne Tilloy <anne.tilloy at rte-france.com>\n+ *\n  */\n class DanglingLineAdderImpl extends AbstractInjectionAdder<DanglingLineAdderImpl> implements DanglingLineAdder {\n \n+    class GenerationAdderImpl implements GenerationAdder {\n+\n+        double minP;\n+        double maxP;\n+        double targetP;\n+        double targetQ;\n+        boolean voltageRegulationOn;\n+        double targetV;\n+\n+        @Override\n+        public GenerationAdder setTargetP(double targetP) {\n+            this.targetP = targetP;\n+            return this;\n+        }\n+\n+        @Override\n+        public GenerationAdder setMaxP(double maxP) {\n+            this.maxP = maxP;\n+            return this;\n+        }\n+\n+        @Override\n+        public GenerationAdder setMinP(double minP) {\n+            this.minP = minP;\n+            return this;\n+        }\n+\n+        @Override\n+        public GenerationAdder setTargetQ(double targetQ) {\n+            this.targetQ = targetQ;\n+            return this;\n+        }\n+\n+        @Override\n+        public GenerationAdder setVoltageRegulationOn(boolean voltageRegulationOn) {\n+            this.voltageRegulationOn = voltageRegulationOn;\n+            return this;\n+        }\n+\n+        @Override\n+        public GenerationAdder setTargetV(double targetV) {\n+            this.targetV = targetV;\n+            return this;\n+        }\n+\n+        @Override\n+        public DanglingLineAdder add() {\n+            ValidationUtil.checkActivePowerLimits(DanglingLineAdderImpl.this, minP, maxP);", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTczNjM1NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455736355", "bodyText": "Yes but in this case minP/maxP are not mandatory (which leads to no check), same goes for targets.", "author": "miovd", "createdAt": "2020-07-16T12:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MTkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTczODg2Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455738863", "bodyText": "I am not sure how generation data is actually used in CGMES/UCTE, @annetill do you have any input on this?", "author": "miovd", "createdAt": "2020-07-16T12:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MTkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0OTQ0MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455749441", "bodyText": "Indeed from CGMES and from UCTE, we will create minimal generation part of a dangling line:\n\nSometimes a generation that has only targetQ and targetP ;\nSometimes a generation that has only targetP, targetV and voltageRegulationOn.", "author": "annetill", "createdAt": "2020-07-16T12:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MTkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MjQ1OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455662458", "bodyText": "Same king of remark: why there is no integrity checks in the different setters?", "author": "mathbagu", "createdAt": "2020-07-16T09:45:52Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineImpl.java", "diffHunk": "@@ -19,6 +17,166 @@\n  */\n class DanglingLineImpl extends AbstractConnectable<DanglingLine> implements DanglingLine, CurrentLimitsOwner<Void> {\n \n+    public static class GenerationImpl implements Generation, ReactiveLimitsOwner, Validable {", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MzEyNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455663124", "bodyText": "That's strange: the constructor should have a Generation parameter instead of mixing data and adder?", "author": "mathbagu", "createdAt": "2020-07-16T09:46:58Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineImpl.java", "diffHunk": "@@ -54,6 +215,11 @@\n         this.g = g;\n         this.b = b;\n         this.ucteXnodeCode = ucteXnodeCode;\n+        if (generationAdder != null) {\n+            generation = new GenerationImpl(generationAdder, this);\n+        } else {\n+            generation = null;\n+        }", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTczNzEyNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455737125", "bodyText": "The issue is GenerationImpl cannot be created if the DanglingLineImpl object has not being created... I am a bit bothered by it too but I did not have any better idea.", "author": "miovd", "createdAt": "2020-07-16T12:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MzEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc1OTM4OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455759388", "bodyText": "Okay, I changed a bit the implementation in my last commit and put the same mecanism that with T3W's leg: a generation without a set danglingline is created at first and danglingLine is set when the object is created. It is a bit cleaner.", "author": "miovd", "createdAt": "2020-07-16T12:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2MzEyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2Mzc5Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455663796", "bodyText": "This is not a good design: you should keep only the second constructor. Remove the DanglingLineImpl and male the generation class not static to be able to access to the DanglingLine.", "author": "mathbagu", "createdAt": "2020-07-16T09:48:03Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineImpl.java", "diffHunk": "@@ -19,6 +17,166 @@\n  */\n class DanglingLineImpl extends AbstractConnectable<DanglingLine> implements DanglingLine, CurrentLimitsOwner<Void> {\n \n+    public static class GenerationImpl implements Generation, ReactiveLimitsOwner, Validable {\n+\n+        private final DanglingLineImpl danglingLine;\n+\n+        private final ReactiveLimitsHolderImpl reactiveLimits;\n+\n+        private double minP;\n+\n+        private double maxP;\n+\n+        // attributes depending on the variant\n+\n+        private final TDoubleArrayList targetP;\n+\n+        private final TDoubleArrayList targetQ;\n+\n+        private final TBooleanArrayList voltageRegulationOn;\n+\n+        private final TDoubleArrayList targetV;\n+\n+        GenerationImpl(DanglingLineAdderImpl.GenerationAdderImpl adder, DanglingLineImpl danglingLine) {", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTczOTA3OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455739079", "bodyText": "See my remark on the comment above", "author": "miovd", "createdAt": "2020-07-16T12:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2Mzc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDQ3Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455664473", "bodyText": "Move the variant management in the generation: this is an encapsulation issue, the generation should be in charge of its data.", "author": "mathbagu", "createdAt": "2020-07-16T09:49:18Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/DanglingLineImpl.java", "diffHunk": "@@ -188,13 +359,31 @@ public void extendVariantArraySize(int initVariantArraySize, int number, int sou\n             p0.add(p0.get(sourceIndex));\n             q0.add(q0.get(sourceIndex));\n         }\n+        if (generation != null) {\n+            generation.targetP.ensureCapacity(generation.targetP.size() + number);\n+            generation.targetQ.ensureCapacity(generation.targetQ.size() + number);\n+            generation.voltageRegulationOn.ensureCapacity(generation.voltageRegulationOn.size() + number);\n+            generation.targetV.ensureCapacity(generation.targetV.size() + number);\n+            for (int i = 0; i < number; i++) {\n+                generation.targetP.add(generation.targetP.get(sourceIndex));\n+                generation.targetQ.add(generation.targetQ.get(sourceIndex));\n+                generation.voltageRegulationOn.add(generation.voltageRegulationOn.get(sourceIndex));\n+                generation.targetV.add(generation.targetV.get(sourceIndex));\n+            }\n+        }", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTczNzQ0NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455737444", "bodyText": "Hm, this was what was done at first but I think you told me to change it? Did I miss something?", "author": "miovd", "createdAt": "2020-07-16T12:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NDQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NjM5MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455666391", "bodyText": "Is it correct?", "author": "mathbagu", "createdAt": "2020-07-16T09:52:29Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/DanglingLineXml.java", "diffHunk": "@@ -62,6 +84,11 @@ protected DanglingLineAdder createAdder(VoltageLevel vl) {\n \n     @Override\n     protected DanglingLine readRootElementAttributes(DanglingLineAdder adder, NetworkXmlReaderContext context) {\n+        throw new UnsupportedOperationException();\n+    }", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2ODA0NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455668045", "bodyText": "I'm surprised: this piece of code change a lot. To be checked, but maybe there is a design issue that makes this code complex.", "author": "mathbagu", "createdAt": "2020-07-16T09:55:18Z", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/DanglingLineXml.java", "diffHunk": "@@ -70,26 +97,106 @@ protected DanglingLine readRootElementAttributes(DanglingLineAdder adder, Networ\n         double b = XmlUtil.readDoubleAttribute(context.getReader(), \"b\");\n         String ucteXnodeCode = context.getReader().getAttributeValue(null, \"ucteXnodeCode\");\n         readNodeOrBus(adder, context);\n-        DanglingLine dl = adder.setP0(p0)\n+        adder.setP0(p0)\n                 .setQ0(q0)\n                 .setR(r)\n                 .setX(x)\n                 .setG(g)\n                 .setB(b)\n-                .setUcteXnodeCode(ucteXnodeCode)\n-                .add();\n-        readPQ(null, dl.getTerminal(), context.getReader());\n-        return dl;\n+                .setUcteXnodeCode(ucteXnodeCode);\n+        Map<String, String> properties = new HashMap<>();\n+        double p = XmlUtil.readOptionalDoubleAttribute(context.getReader(), \"p\");\n+        double q = XmlUtil.readOptionalDoubleAttribute(context.getReader(), \"q\");\n+        double[] permanentLimit = new double[1];\n+        permanentLimit[0] = Double.NaN;\n+        Map<Integer, TemporaryLimitXml> temporaryLimits = new HashMap<>();\n+        DanglingLine[] danglingLine = new DanglingLine[1];\n+        boolean[] hasGeneration = new boolean[1];\n+        readUntilEndRootElement(context.getReader(), () -> {\n+            switch (context.getReader().getLocalName()) {\n+                case \"property\":\n+                    String name = context.getReader().getAttributeValue(null, \"name\");\n+                    String value = context.getReader().getAttributeValue(null, \"value\");\n+                    properties.put(name, value);\n+                    break;\n+                case \"currentLimits\":\n+                    permanentLimit[0] = XmlUtil.readOptionalDoubleAttribute(context.getReader(), \"permanentLimit\");\n+                    XmlUtil.readUntilEndElement(\"currentLimits\", context.getReader(), () -> {\n+                        if (\"temporaryLimit\".equals(context.getReader().getLocalName())) {\n+                            String tlName = context.getReader().getAttributeValue(null, \"name\");\n+                            int acceptableDuration = XmlUtil.readOptionalIntegerAttribute(context.getReader(), \"acceptableDuration\", Integer.MAX_VALUE);\n+                            double tlValue = XmlUtil.readOptionalDoubleAttribute(context.getReader(), \"value\", Double.MAX_VALUE);\n+                            boolean fictitious = XmlUtil.readOptionalBoolAttribute(context.getReader(), \"fictitious\", false);\n+                            temporaryLimits.put(acceptableDuration, new TemporaryLimitXml(tlName, tlValue, fictitious));\n+                        }\n+                    });\n+                    break;\n+                case GENERATION:\n+                    IidmXmlUtil.assertMinimumVersion(ROOT_ELEMENT_NAME, GENERATION, IidmXmlUtil.ErrorMessage.NOT_NULL_NOT_SUPPORTED, IidmXmlVersion.V_1_3, context);\n+                    hasGeneration[0] = true;\n+                    danglingLine[0] = readGeneration(adder, context.getReader(), context);\n+                    break;\n+                default:\n+                    throw new PowsyblException(\"Unknown element name <\" + context.getReader().getLocalName() + \"> in <\" + id + \">\");\n+            }\n+        });\n+        if (!hasGeneration[0]) {\n+            danglingLine[0] = adder.add();\n+        }\n+        properties.forEach(danglingLine[0]::setProperty);\n+        danglingLine[0].getTerminal().setP(p).setQ(q);\n+        if (!Double.isNaN(permanentLimit[0]) || !temporaryLimits.isEmpty()) {\n+            CurrentLimitsAdder limitsAdder = danglingLine[0].newCurrentLimits()\n+                    .setPermanentLimit(permanentLimit[0]);\n+            temporaryLimits\n+                    .forEach((acceptableDuration, tl) -> limitsAdder.beginTemporaryLimit()\n+                    .setAcceptableDuration(acceptableDuration)\n+                    .setName(tl.name)\n+                    .setValue(tl.value)\n+                    .setFictitious(tl.fictitious)\n+                    .endTemporaryLimit());\n+            limitsAdder.add();\n+        }\n     }\n \n-    @Override\n-    protected void readSubElements(DanglingLine dl, NetworkXmlReaderContext context) throws XMLStreamException {\n-        readUntilEndRootElement(context.getReader(), () -> {\n-            if (\"currentLimits\".equals(context.getReader().getLocalName())) {\n-                readCurrentLimits(null, dl::newCurrentLimits, context.getReader());\n-            } else {\n-                super.readSubElements(dl, context);\n+    private DanglingLine readGeneration(DanglingLineAdder adder, XMLStreamReader reader, NetworkXmlReaderContext context) throws XMLStreamException {\n+        double minP = XmlUtil.readOptionalDoubleAttribute(reader, \"minP\");\n+        double maxP = XmlUtil.readOptionalDoubleAttribute(reader, \"maxP\");\n+        boolean voltageRegulationOn = XmlUtil.readBoolAttribute(reader, \"voltageRegulationOn\");\n+        double targetP = XmlUtil.readOptionalDoubleAttribute(reader, \"targetP\");\n+        double targetV = XmlUtil.readOptionalDoubleAttribute(reader, \"targetV\");\n+        double targetQ = XmlUtil.readOptionalDoubleAttribute(reader, \"targetQ\");\n+        adder.newGeneration()\n+                .setMinP(minP)\n+                .setMaxP(maxP)\n+                .setVoltageRegulationOn(voltageRegulationOn)\n+                .setTargetP(targetP)\n+                .setTargetV(targetV)\n+                .setTargetQ(targetQ)\n+                .add();\n+        DanglingLine danglingLine = adder.add();\n+        XmlUtil.readUntilEndElement(GENERATION, reader, () -> {\n+            switch (context.getReader().getLocalName()) {\n+                case \"reactiveCapabilityCurve\":\n+                case \"minMaxReactiveLimits\":\n+                    ReactiveLimitsXml.INSTANCE.read(danglingLine.getGeneration(), context);\n+                    break;\n+                default:\n+                    throw new PowsyblException(\"Unknown element name <\" + context.getReader().getLocalName() + \"> in <\" + danglingLine.getId() + \".generation>\");\n             }\n         });\n+        return danglingLine;\n+    }\n+\n+    class TemporaryLimitXml {\n+        private final String name;\n+        private final double value;\n+        private final boolean fictitious;\n+\n+        TemporaryLimitXml(String name, double value, boolean fictitious) {\n+            this.name = name;\n+            this.value = value;\n+            this.fictitious = fictitious;\n+        }", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTczODEwNA==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455738104", "bodyText": "It changes a lot because by moving GenerationAdder in DanglingLineAdder, we now cannot call add() before reading sub elements (similar to what is done in ShuntXml)", "author": "miovd", "createdAt": "2020-07-16T12:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2ODA0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc0OTAyMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455749022", "bodyText": "Do you prefer using attributes in danglingline like for threewindingstransformers?", "author": "miovd", "createdAt": "2020-07-16T12:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2ODA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2OTQ5Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1357#discussion_r455669497", "bodyText": "Should we export the reactive limits even if the voltage regulation is OFF?", "author": "mathbagu", "createdAt": "2020-07-16T09:57:45Z", "path": "ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java", "diffHunk": "@@ -282,6 +282,29 @@ private static void convertXNode(UcteNetwork ucteNetwork, DanglingLine danglingL\n         UcteNode ucteNode = convertXNode(ucteNetwork, xnodeCode, geographicalName, ucteNodeStatus);\n         ucteNode.setActiveLoad((float) danglingLine.getP0());\n         ucteNode.setReactiveLoad((float) danglingLine.getQ0());\n+        double generatorTargetP = danglingLine.getGeneration().getTargetP();\n+        ucteNode.setActivePowerGeneration(Double.isNaN(generatorTargetP) ? 0 : (float) -generatorTargetP);\n+        double generatorTargetQ = danglingLine.getGeneration().getTargetQ();\n+        ucteNode.setReactivePowerGeneration(Double.isNaN(generatorTargetQ) ? 0 : (float) -generatorTargetQ);\n+        if (danglingLine.getGeneration().isVoltageRegulationOn()) {\n+            ucteNode.setVoltageReference((float) danglingLine.getGeneration().getTargetV());\n+            float minP = (float) danglingLine.getGeneration().getMinP();\n+            float maxP = (float) danglingLine.getGeneration().getMaxP();\n+            float minQ = (float) danglingLine.getGeneration().getReactiveLimits().getMinQ(danglingLine.getGeneration().getTargetP());\n+            float maxQ = (float) danglingLine.getGeneration().getReactiveLimits().getMaxQ(danglingLine.getGeneration().getTargetP());\n+            if (minP != -DEFAULT_POWER_LIMIT) {\n+                ucteNode.setMinimumPermissibleActivePowerGeneration(-minP);\n+            }\n+            if (maxP != DEFAULT_POWER_LIMIT) {\n+                ucteNode.setMaximumPermissibleActivePowerGeneration(-maxP);\n+            }\n+            if (minQ != -DEFAULT_POWER_LIMIT) {\n+                ucteNode.setMinimumPermissibleReactivePowerGeneration(-minQ);\n+            }\n+            if (maxQ != DEFAULT_POWER_LIMIT) {\n+                ucteNode.setMaximumPermissibleReactivePowerGeneration(-maxQ);\n+            }\n+        }", "originalCommit": "fcab7d06b95af527efa738b53e993174e69a08d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83bdd1124d31d94ddee9373a7a87430b31520f16", "url": "https://github.com/powsybl/powsybl-core/commit/83bdd1124d31d94ddee9373a7a87430b31520f16", "message": "Change implementation: GenerationImpl is only created with attributes\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T12:47:07Z", "type": "commit"}, {"oid": "85a7fde19b84a2cf264db64970345b6070fe3ae6", "url": "https://github.com/powsybl/powsybl-core/commit/85a7fde19b84a2cf264db64970345b6070fe3ae6", "message": "Change serialization\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T14:49:44Z", "type": "commit"}, {"oid": "15eb255e53393e6ddb36b648078dafdf1476774f", "url": "https://github.com/powsybl/powsybl-core/commit/15eb255e53393e6ddb36b648078dafdf1476774f", "message": "Add checks\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T15:09:08Z", "type": "commit"}, {"oid": "2c0b94b316271f33cdcfbf35c808fd51b5c42fc0", "url": "https://github.com/powsybl/powsybl-core/commit/2c0b94b316271f33cdcfbf35c808fd51b5c42fc0", "message": "move variant management in generation\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-07-16T15:19:57Z", "type": "commit"}, {"oid": "26eafbea5efbdf18f8ea90e1afbe08fe746b25a8", "url": "https://github.com/powsybl/powsybl-core/commit/26eafbea5efbdf18f8ea90e1afbe08fe746b25a8", "message": "Merge branch 'master' into xnode-with-regulating-capability", "committedDate": "2020-07-17T08:01:52Z", "type": "commit"}, {"oid": "fc37501bd3b12828233b020e93f273427ed353ec", "url": "https://github.com/powsybl/powsybl-core/commit/fc37501bd3b12828233b020e93f273427ed353ec", "message": "Merge branch 'master' into xnode-with-regulating-capability", "committedDate": "2020-07-17T08:37:46Z", "type": "commit"}, {"oid": "551bebc90e740abc1dd3511d74bb05ec6170b8ea", "url": "https://github.com/powsybl/powsybl-core/commit/551bebc90e740abc1dd3511d74bb05ec6170b8ea", "message": "Merge branch 'master' into xnode-with-regulating-capability", "committedDate": "2020-07-17T14:01:37Z", "type": "commit"}, {"oid": "60e74796bf3471f20076bf772bc534753195a060", "url": "https://github.com/powsybl/powsybl-core/commit/60e74796bf3471f20076bf772bc534753195a060", "message": "Fix UCTE exporter.\nAdd unit test.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-07-17T15:05:42Z", "type": "commit"}, {"oid": "495debad37625f346ca213bc0e7d5668aae73c91", "url": "https://github.com/powsybl/powsybl-core/commit/495debad37625f346ca213bc0e7d5668aae73c91", "message": "Merge branch 'xnode-with-regulating-capability' of https://github.com/powsybl/powsybl-core into xnode-with-regulating-capability", "committedDate": "2020-07-17T16:24:17Z", "type": "commit"}]}