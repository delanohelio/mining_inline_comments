{"pr_number": 2595, "pr_title": "Fix ghost blocks", "pr_createdAt": "2020-12-05T17:06:05Z", "pr_url": "https://github.com/Slimefun/Slimefun4/pull/2595", "timeline": [{"oid": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "url": "https://github.com/Slimefun/Slimefun4/commit/f4633c528fb2e61529a297bef3c9312e17ea62c2", "message": "Fix ghost blocks", "committedDate": "2020-12-05T16:48:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTQzNA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831434", "bodyText": "Why would you return; here...\nIf this is to prevent the Event from being cancelled, use an if/else structure.", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:54:05Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {\n+                Iterator<ItemStack> item = BlockStorage.check(block).getDrops().iterator();\n+                World world = block.getWorld();\n+                Location loc = block.getLocation();\n+                while (item.hasNext()) {\n+                    world.dropItem(loc, item.next());\n+                }\n+                BlockStorage.clearBlockInfo(block);\n+                return;", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTQ3NA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831474", "bodyText": "Why the iterator...", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:54:14Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {\n+                Iterator<ItemStack> item = BlockStorage.check(block).getDrops().iterator();", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTUxOQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831519", "bodyText": "You cannot drop null or air items, so you would need to check for that.", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:54:30Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {\n+                Iterator<ItemStack> item = BlockStorage.check(block).getDrops().iterator();\n+                World world = block.getWorld();\n+                Location loc = block.getLocation();\n+                while (item.hasNext()) {\n+                    world.dropItem(loc, item.next());", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTU2Mw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831563", "bodyText": "Also *dropItemNaturally", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:54:47Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {\n+                Iterator<ItemStack> item = BlockStorage.check(block).getDrops().iterator();\n+                World world = block.getWorld();\n+                Location loc = block.getLocation();\n+                while (item.hasNext()) {\n+                    world.dropItem(loc, item.next());", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTY4NA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831684", "bodyText": "These two statements can be merged.", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:55:42Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTczMA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831730", "bodyText": "The order of these checks should be swapped for performance reasons.", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:55:56Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTkwMQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831901", "bodyText": "Calling BlockStorage.check() here is completely redundant.\nYou are already doing a check by doing hasBlockInfo() above, this is essentially doing two concurrent operations redundantly, a null check would be more sufficient here.", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:56:55Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {\n+                Iterator<ItemStack> item = BlockStorage.check(block).getDrops().iterator();", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMTk5OQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536831999", "bodyText": "Not really much of a point in making these variables here.", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T17:57:21Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,7 +61,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n+        Block block = e.getBlock();\n+        if (BlockStorage.hasBlockInfo(block)) {\n+            if (e.getBlockReplacedState().getType().isAir()) {\n+                Iterator<ItemStack> item = BlockStorage.check(block).getDrops().iterator();\n+                World world = block.getWorld();\n+                Location loc = block.getLocation();", "originalCommit": "f4633c528fb2e61529a297bef3c9312e17ea62c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ff634c0f5ce91ca4955b43c57c77e0b7c726f7fc", "url": "https://github.com/Slimefun/Slimefun4/commit/ff634c0f5ce91ca4955b43c57c77e0b7c726f7fc", "message": "Make code better", "committedDate": "2020-12-05T19:22:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg3Nzk1Ng==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536877956", "bodyText": "Speaking of which, since you modified this class, feel free to add yourself here.\nSo we know who to contact XD", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T19:28:49Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -38,10 +38,10 @@\n /**\n  * The {@link BlockListener} is responsible for listening to the {@link BlockPlaceEvent}\n  * and {@link BlockBreakEvent}.\n- * \n+ *\n  * @author TheBusyBiscuit\n  * @author Linox\n- * ", "originalCommit": "ff634c0f5ce91ca4955b43c57c77e0b7c726f7fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg3ODQ5OA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536878498", "bodyText": "As stated in a prior review, these two checks should be swapped for performance reason.\nAny BlockStorage operations might be heavy depending on their concurrent behaviour and take a relatively long time to compute, whereas the .isAir() check is very inexpensive.\nSwapping will reduce those heavy lookups to a bare minimum.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Block block = e.getBlock();\n          \n          \n            \n                    SlimefunItem sfItem = BlockStorage.check(block);\n          \n          \n            \n            \n          \n          \n            \n                    if (sfItem != null) {\n          \n          \n            \n                        if (e.getBlockReplacedState().getType().isAir()) {\n          \n          \n            \n                    if (e.getBlockReplacedState().getType().isAir()) {\n          \n          \n            \n                        Block block = e.getBlock();\n          \n          \n            \n                        SlimefunItem sfItem = BlockStorage.check(block);\n          \n          \n            \n            \n          \n          \n            \n                        if (sfItem != null) {", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T19:32:10Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,8 +58,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n-            e.setCancelled(true);\n+        Block block = e.getBlock();\n+        SlimefunItem sfItem = BlockStorage.check(block);\n+\n+        if (sfItem != null) {\n+            if (e.getBlockReplacedState().getType().isAir()) {", "originalCommit": "ff634c0f5ce91ca4955b43c57c77e0b7c726f7fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg3ODUxNg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536878516", "bodyText": "Formatting, also for non-blocks a simple AIR check is sufficient.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (item != null && !item.getType().isAir()) { block.getWorld().dropItemNaturally(block.getLocation(), item); }\n          \n          \n            \n                                if (item != null && item.getType() != Material.AIR) {\n          \n          \n            \n                                    block.getWorld().dropItemNaturally(block.getLocation(), item);\n          \n          \n            \n                                }", "author": "TheBusyBiscuit", "createdAt": "2020-12-05T19:32:13Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,8 +58,18 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n-            e.setCancelled(true);\n+        Block block = e.getBlock();\n+        SlimefunItem sfItem = BlockStorage.check(block);\n+\n+        if (sfItem != null) {\n+            if (e.getBlockReplacedState().getType().isAir()) {\n+                for (ItemStack item : sfItem.getDrops()) {\n+                    if (item != null && !item.getType().isAir()) { block.getWorld().dropItemNaturally(block.getLocation(), item); }", "originalCommit": "ff634c0f5ce91ca4955b43c57c77e0b7c726f7fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg4ODMyMA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r536888320", "bodyText": "Well.... There's multiple different airs now (1.16 api and 1.17 implementation).\nisAir is definitely best to use unless we know 100% that it would be AIR and not something like CAVE_AIR. Your code will check if it isn't AIR but can be CAVE_AIR. Just gonna cause issues\nWe should always be using isAir now", "author": "WalshyDev", "createdAt": "2020-12-05T20:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg3ODUxNg=="}], "type": "inlineReview"}, {"oid": "7afb9b9791e4cd54996e5a566c5a847908d570cb", "url": "https://github.com/Slimefun/Slimefun4/commit/7afb9b9791e4cd54996e5a566c5a847908d570cb", "message": "Implement more suggestions", "committedDate": "2020-12-05T19:51:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MjYzMA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r540072630", "bodyText": "I probably worded that wrongly, the null check is still required here, I simply meant that you could replace .isAir() with a Material.AIR check.\nBut either works tbh.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (!item.getType().isAir()) {\n          \n          \n            \n                                if (item != null && !item.getType().isAir()) {", "author": "TheBusyBiscuit", "createdAt": "2020-12-10T10:56:55Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,8 +59,21 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n-            e.setCancelled(true);\n+        Block block = e.getBlock();\n+\n+        if (e.getBlockReplacedState().getType().isAir()) {\n+            SlimefunItem sfItem = BlockStorage.check(block);\n+\n+            if (sfItem != null) {\n+                for (ItemStack item : sfItem.getDrops()) {\n+                    if (!item.getType().isAir()) {", "originalCommit": "7afb9b9791e4cd54996e5a566c5a847908d570cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NDE2MQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2595#discussion_r540074161", "bodyText": "I would suggest to add a fallback here, because the BlockPlaceEvent will also be called when a Player tries to place the block in the same space as tall grass or other passable materials.\nFor these, we want to cancel it nonetheless as they would need to destroy the block first.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    }\n          \n          \n            \n                    } else if (BlockStorage.hasBlockInfo(e.getBlock())) {\n          \n          \n            \n                        e.setCancelled(true);\n          \n          \n            \n                    }", "author": "TheBusyBiscuit", "createdAt": "2020-12-10T10:59:16Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/listeners/BlockListener.java", "diffHunk": "@@ -58,8 +59,21 @@ public void onBlockPlaceExisting(BlockPlaceEvent e) {\n         // This prevents Players from placing a block where another block already exists\n         // While this can cause ghost blocks it also prevents them from replacing grass\n         // or saplings etc...\n-        if (BlockStorage.hasBlockInfo(e.getBlock())) {\n-            e.setCancelled(true);\n+        Block block = e.getBlock();\n+\n+        if (e.getBlockReplacedState().getType().isAir()) {\n+            SlimefunItem sfItem = BlockStorage.check(block);\n+\n+            if (sfItem != null) {\n+                for (ItemStack item : sfItem.getDrops()) {\n+                    if (!item.getType().isAir()) {\n+                        block.getWorld().dropItemNaturally(block.getLocation(), item);\n+                    }\n+                }\n+                BlockStorage.clearBlockInfo(block);\n+            } else {\n+                e.setCancelled(true);\n+            }\n         }", "originalCommit": "7afb9b9791e4cd54996e5a566c5a847908d570cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "28e5771ca8068576b883e5c2c9ce27278ef0d13c", "url": "https://github.com/Slimefun/Slimefun4/commit/28e5771ca8068576b883e5c2c9ce27278ef0d13c", "message": "Implement more suggestions", "committedDate": "2020-12-10T11:38:31Z", "type": "commit"}]}