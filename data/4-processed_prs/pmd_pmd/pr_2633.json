{"pr_number": 2633, "pr_title": "[core] Fix XMLRenderer encoding issues", "pr_createdAt": "2020-07-05T12:47:21Z", "pr_url": "https://github.com/pmd/pmd/pull/2633", "timeline": [{"oid": "3004e76257d3be73cd272753fff0738593b9aa88", "url": "https://github.com/pmd/pmd/commit/3004e76257d3be73cd272753fff0738593b9aa88", "message": "[core] CPD: Add correct XML 1.0 escaping for code snippets", "committedDate": "2020-07-03T19:11:57Z", "type": "commit"}, {"oid": "3bb091e26d71c10179c2b40f122dd862c843e9a5", "url": "https://github.com/pmd/pmd/commit/3bb091e26d71c10179c2b40f122dd862c843e9a5", "message": "[core] CPD: Also escape filename, explicitly set XML 1.0", "committedDate": "2020-07-05T09:20:17Z", "type": "commit"}, {"oid": "d9279732443f899d05dbec533bbf0ab3aab4fddb", "url": "https://github.com/pmd/pmd/commit/d9279732443f899d05dbec533bbf0ab3aab4fddb", "message": "[core] PMD XMLRenderer - correctly support encoding\n\nThe XMLRenderer uses by default UTF-8 encoding, but the\nwriter uses the system default encoding, which doesn't work\nwell together.\n\nProvide new experimental API Renderer::setReportFile, so that\nrenderer implementations can create their own writers.\nThe default implementation in AbstractRenderer is backwards compatible.", "committedDate": "2020-07-05T12:21:46Z", "type": "commit"}, {"oid": "60f905b0ef01843dde9d43e6ee5cb80b5b6b6a3c", "url": "https://github.com/pmd/pmd/commit/60f905b0ef01843dde9d43e6ee5cb80b5b6b6a3c", "message": "[doc] Update release notes, fixes #2615", "committedDate": "2020-07-05T12:46:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg3Mzg4Ng==", "url": "https://github.com/pmd/pmd/pull/2633#discussion_r449873886", "bodyText": "StringEscapeUtils escape basic chars like \"<\" and remove invalid chars like U+000C. But the DOM impl already escapes \"<\" by itself in attribute values, but doesn't remove invalid chars. In order to avoid double escaping, this escapes it once with StringEscapeUtils and unescapes it again - result is, that only invalid chars are removed (no escaping).", "author": "adangel", "createdAt": "2020-07-05T12:49:20Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/cpd/XMLRenderer.java", "diffHunk": "@@ -119,7 +121,8 @@ private Element addFilesToDuplicationElement(Document doc, Element duplication,\n             mark = iterator.next();\n             final Element file = doc.createElement(\"file\");\n             file.setAttribute(\"line\", String.valueOf(mark.getBeginLine()));\n-            file.setAttribute(\"path\", mark.getFilename());\n+            String filenameXml10 = StringEscapeUtils.unescapeXml(StringEscapeUtils.escapeXml10(mark.getFilename()));", "originalCommit": "60f905b0ef01843dde9d43e6ee5cb80b5b6b6a3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg3NDE2Mg==", "url": "https://github.com/pmd/pmd/pull/2633#discussion_r449874162", "bodyText": "this and a non unicode based encoding like ISO-8859-1 or cp1252 cannot encode codepoints > 255.\nHm... so, we should probably escape chars additionally as soon as c > 0xff, because then you need unicode...", "author": "adangel", "createdAt": "2020-07-05T12:52:18Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/renderers/XMLRenderer.java", "diffHunk": "@@ -179,6 +182,41 @@ private void createTimestampAttr(StringBuilder buffer) {\n                 .append('\"');\n     }\n \n+    @Override\n+    public void setReportFile(String reportFilename) {\n+        String encoding = getProperty(ENCODING);\n+\n+        try {\n+            Charset charset = Charset.forName(encoding);\n+            this.writer = StringUtils.isBlank(reportFilename) ? new OutputStreamWriter(System.out, charset)\n+                    : Files.newBufferedWriter(new File(reportFilename).toPath(), charset);\n+        } catch (IOException | UnsupportedCharsetException e) {\n+            throw new IllegalArgumentException(e);\n+        }\n+    }\n+\n+    /**\n+     * Escape unicode characters for non UTF-8 encodings.\n+     */\n+    private String escape(String text) {\n+        String result = StringEscapeUtils.escapeXml10(text);\n+        String encoding = getProperty(ENCODING);\n+        if (!\"UTF-8\".equalsIgnoreCase(encoding)) {\n+            StringBuilder sb = new StringBuilder(result);\n+            for (int i = 0; i < sb.length(); i++) {\n+                char c = sb.charAt(i);\n+                // surrogate characters are not allowed in XML", "originalCommit": "60f905b0ef01843dde9d43e6ee5cb80b5b6b6a3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0bd9b1db6b5bf2b11859ab2114e8398e2a7d507a", "url": "https://github.com/pmd/pmd/commit/0bd9b1db6b5bf2b11859ab2114e8398e2a7d507a", "message": "[core] XMLRenderer - avoid unmappable characters for non UTF-8 encodings", "committedDate": "2020-07-05T20:10:14Z", "type": "commit"}, {"oid": "53c581b69a0ff78959f97ae29e5a8afb15f4ef9b", "url": "https://github.com/pmd/pmd/commit/53c581b69a0ff78959f97ae29e5a8afb15f4ef9b", "message": "Update pmd-regression-tester", "committedDate": "2020-07-06T19:44:47Z", "type": "commit"}, {"oid": "bb97b693f226c5ddc13c5b8acb274d497f3bbfdd", "url": "https://github.com/pmd/pmd/commit/bb97b693f226c5ddc13c5b8acb274d497f3bbfdd", "message": "Update pmd-regression-tester 1.0.1", "committedDate": "2020-07-08T18:29:26Z", "type": "commit"}, {"oid": "2e006697e0aac3594de2d0df618d0db0e2c5534e", "url": "https://github.com/pmd/pmd/commit/2e006697e0aac3594de2d0df618d0db0e2c5534e", "message": "[core] Refactor XMLRenderer to use XMLStreamWriter\n\nIn order to properly support different encodings, a OutputStream\nis needed. Then Java will take care of unmappaple characters\nand encode them as entities for XML.\n\nFor backwards compatibility, a writer is still created and exposed.", "committedDate": "2020-07-09T08:56:44Z", "type": "commit"}, {"oid": "e6600ec8560d85df738d5622416563f8e3f2fe7d", "url": "https://github.com/pmd/pmd/commit/e6600ec8560d85df738d5622416563f8e3f2fe7d", "message": "[core] Provide StringUtil.removeInvalidXml10Characters\n\nAnd use it in both CPD/PMD XMLRenderers.", "committedDate": "2020-07-09T09:07:06Z", "type": "commit"}, {"oid": "2e9f5ad8978f0c6c12d207a801f24b6816e8cf26", "url": "https://github.com/pmd/pmd/commit/2e9f5ad8978f0c6c12d207a801f24b6816e8cf26", "message": "Merge branch 'master' into issue-2615", "committedDate": "2020-07-20T14:36:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ1MDM4OQ==", "url": "https://github.com/pmd/pmd/pull/2633#discussion_r457450389", "bodyText": "In a mature API, I think this should take a Path argument instead of a string. But then, everything should be updated to be consistent", "author": "oowekyala", "createdAt": "2020-07-20T14:41:20Z", "path": "pmd-core/src/main/java/net/sourceforge/pmd/renderers/Renderer.java", "diffHunk": "@@ -163,4 +164,17 @@\n     void end() throws IOException;\n \n     void flush() throws IOException;\n+\n+    /**\n+     * Sets the filename where the report should be written to. If no filename is provided,\n+     * the renderer should write to stdout.\n+     *\n+     * <p>Implementations must initialize the writer of the renderer.\n+     *\n+     * <p>See {@link AbstractRenderer#setReportFile(String)} for the default impl.\n+     *\n+     * @param reportFilename the filename (optional).\n+     */\n+    @Experimental\n+    void setReportFile(String reportFilename);", "originalCommit": "e6600ec8560d85df738d5622416563f8e3f2fe7d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}