{"pr_number": 2280, "pr_title": "[cs] CPD: Replace C# tokenizer by an Antlr-based one", "pr_createdAt": "2020-02-12T11:08:18Z", "pr_url": "https://github.com/pmd/pmd/pull/2280", "timeline": [{"oid": "659e709f7988a5cda6338d8820bde289a22d5f62", "url": "https://github.com/pmd/pmd/commit/659e709f7988a5cda6338d8820bde289a22d5f62", "message": "Adjusted BaseTokenFilter to allow filtering on more than one token.\n\nWhen filtering tokens, the analyzeToken method can be overriden to access the current token. This can then be used to implement isLanguageSpecificDiscarding. However, it may be desirable to \"look ahead\" and base the decision of whether to filter or not on multiple tokens. In order to support this new use case, a new extension point analyzeTokens is provided, which not only has access to the current token, but can also iterate over the upcoming tokens.\n\nThe functionality of iterating over remaining tokens uses Guava for its implementation. Since pmd-core targets Java 7, the Android flavour of Guava is used. In order to stay consistent with pmd-apex-jorje, this has also been adjusted to the Android flavour. For PMD 7.0, the jre flavour can be used instead.", "committedDate": "2020-02-12T10:12:14Z", "type": "commit"}, {"oid": "bdfbfae231ce437f6c9a6a67e7a313b6295a9632", "url": "https://github.com/pmd/pmd/commit/bdfbfae231ce437f6c9a6a67e7a313b6295a9632", "message": "C# tokenizer is now Antlr-based.\n\nThis is based on the Antlr grammar from https://github.com/antlr/grammars-v4/tree/master/csharp.\n\nThis adds column information for C# and fixes #2139.", "committedDate": "2020-02-12T10:46:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzODczMw==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r378938733", "bodyText": "To avoid the dependency to guava, we can also write\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Iterator<String> iterator = ImmutableList.of(\"a\", \"b\", \"c\").iterator();\n          \n          \n            \n                    Iterator<String> iterator = Collections.unmodifiableList(Arrays.asList(\"a\", \"b\", \"c\")).iterator();", "author": "adangel", "createdAt": "2020-02-13T15:37:25Z", "path": "pmd-core/src/test/java/net/sourceforge/pmd/cpd/token/internal/BaseTokenFilterTest.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/**\n+ * BSD-style license; for more info see http://pmd.sourceforge.net/license.html\n+ */\n+\n+package net.sourceforge.pmd.cpd.token.internal;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ConcurrentModificationException;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+import org.junit.Test;\n+\n+import net.sourceforge.pmd.lang.TokenManager;\n+import net.sourceforge.pmd.lang.ast.GenericToken;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+public class BaseTokenFilterTest {\n+\n+    class StringToken implements GenericToken {\n+\n+        private final String text;\n+\n+        StringToken(final String text) {\n+            this.text = text;\n+        }\n+\n+        @Override\n+        public GenericToken getNext() {\n+            return null;\n+        }\n+\n+        @Override\n+        public GenericToken getPreviousComment() {\n+            return null;\n+        }\n+\n+        @Override\n+        public String getImage() {\n+            return text;\n+        }\n+\n+        @Override\n+        public int getBeginLine() {\n+            return 0;\n+        }\n+\n+        @Override\n+        public int getEndLine() {\n+            return 0;\n+        }\n+\n+        @Override\n+        public int getBeginColumn() {\n+            return 0;\n+        }\n+\n+        @Override\n+        public int getEndColumn() {\n+            return 0;\n+        }\n+    }\n+\n+    class StringTokenManager implements TokenManager {\n+\n+        Iterator<String> iterator = ImmutableList.of(\"a\", \"b\", \"c\").iterator();", "originalCommit": "bdfbfae231ce437f6c9a6a67e7a313b6295a9632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzOTg2NQ==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r378939865", "bodyText": "why android?", "author": "adangel", "createdAt": "2020-02-13T15:38:48Z", "path": "pmd-apex-jorje/pom.xml", "diffHunk": "@@ -81,7 +81,7 @@\n     <dependency>\n         <groupId>com.google.guava</groupId>\n         <artifactId>guava</artifactId>\n-        <version>26.0-jre</version>\n+        <version>26.0-android</version>", "originalCommit": "bdfbfae231ce437f6c9a6a67e7a313b6295a9632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk2OTY1MQ==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r378969651", "bodyText": "For pmd-core, the JRE variant of Guava cannot be used because it requires Java 8. The Android variant, despite the name, only means that JRE7 can be targeted.\nIn order to avoid clashes between pmd-core and pmd-apex-jorje, I also adjusted the latter to use the Android variant. Once PMD targets JRE8, this can be reverted.\nI believe the JRE and Android variants should be mostly equivalent.", "author": "maikelsteneker", "createdAt": "2020-02-13T16:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzOTg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0NDcwNg==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r385044706", "bodyText": "I've reverted this change. It shouldn't be necessary anymore, since pmd-core is no longer using Guava.", "author": "maikelsteneker", "createdAt": "2020-02-27T10:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzOTg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0MDYyMA==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r378940620", "bodyText": "Do we really need this dependency? I think, you added it to use AbstractIterator. Would it be possible to write the RemainingTokensIterator without this?", "author": "adangel", "createdAt": "2020-02-13T15:40:01Z", "path": "pmd-core/pom.xml", "diffHunk": "@@ -186,6 +186,12 @@\n             <artifactId>system-rules</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>", "originalCommit": "bdfbfae231ce437f6c9a6a67e7a313b6295a9632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDQwMw==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r378970403", "bodyText": "The reason was indeed to be able to use the AbstractIterator. In my opinion, this makes the code much more readable. However, if the Guava dependency is undesirable, it should be possible to rewrite the iterator without needing Guava.", "author": "maikelsteneker", "createdAt": "2020-02-13T16:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0MDYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA5NDg0Ng==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r379094846", "bodyText": "Note that the PMD 7 branch has an AbstractIterator class already. I based it off the kotlin stdlib, but it looks like sensibly the same. We could just backport it, I don't think it needs Java 8\n\n  \n    \n      pmd/pmd-core/src/main/java/net/sourceforge/pmd/internal/util/IteratorUtil.java\n    \n    \n         Line 361\n      in\n      01c7b12\n    \n    \n    \n    \n\n        \n          \n           private abstract static class AbstractIterator<T> implements Iterator<T> {", "author": "oowekyala", "createdAt": "2020-02-13T20:15:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0MDYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0NTA3Mw==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r385045073", "bodyText": "@oowekyala Good suggestion! I've backported this class and adjusted my implementation to use it.", "author": "maikelsteneker", "createdAt": "2020-02-27T10:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0MDYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0Mjk5OA==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r378942998", "bodyText": "Can we simply use this? According to the faq https://www.eclipse.org/legal/epl-2.0/faq.php#h.5ucozq4kvv7o we would need the permission from the owner in order to include it here as BSD...", "author": "adangel", "createdAt": "2020-02-13T15:43:35Z", "path": "pmd-cs/src/main/antlr4/net/sourceforge/pmd/lang/cs/antlr4/CSharpLexer.g4", "diffHunk": "@@ -0,0 +1,1105 @@\n+// Eclipse Public License - v 1.0, http://www.eclipse.org/legal/epl-v10.html", "originalCommit": "bdfbfae231ce437f6c9a6a67e7a313b6295a9632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4MDU1OQ==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r378980559", "bodyText": "Regrettably, I didn't realize that this might not be allowed. I'll contact the original author to ask for permission.", "author": "maikelsteneker", "createdAt": "2020-02-13T16:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0Mjk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc2OTI2MA==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r384769260", "bodyText": "I am glad to hear that my grammar is useful in this context. You have my permission.", "author": "ChristianWulf", "createdAt": "2020-02-26T21:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0Mjk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNTA5MA==", "url": "https://github.com/pmd/pmd/pull/2280#discussion_r384805090", "bodyText": "That is great to hear, thank you very much!", "author": "maikelsteneker", "createdAt": "2020-02-26T22:25:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0Mjk5OA=="}], "type": "inlineReview"}, {"oid": "4bd5a159e504b7f92e00e779da214c4ca102f0b8", "url": "https://github.com/pmd/pmd/commit/4bd5a159e504b7f92e00e779da214c4ca102f0b8", "message": "Rewrite to avoid Guava dependency.", "committedDate": "2020-02-27T10:36:28Z", "type": "commit"}]}