{"pr_number": 2631, "pr_title": "[java] NPathComplexity can't handle switch expressions", "pr_createdAt": "2020-07-03T17:59:06Z", "pr_url": "https://github.com/pmd/pmd/pull/2631", "timeline": [{"oid": "db675c37d91e0fdf4b43f1651d485b42264c0451", "url": "https://github.com/pmd/pmd/commit/db675c37d91e0fdf4b43f1651d485b42264c0451", "message": "[java] NPathComplexity can't handle switch expressions\n\nFixes #2625", "committedDate": "2020-07-03T17:57:09Z", "type": "commit"}, {"oid": "25bfb9d90995b72706af8ba30117df92eb55f97b", "url": "https://github.com/pmd/pmd/commit/25bfb9d90995b72706af8ba30117df92eb55f97b", "message": "[java] Support switch labels/rules/expressions for CYCLO", "committedDate": "2020-07-03T17:57:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NTU1MA==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r457465550", "bodyText": "I think, this would ignore the complexity of the block under the default label.\nCorrection: it probably does handle it, since descendants are counted, but a test case would be nice. Here's one that uses a switch expression, which is relevant to the other comment\nclass Foo {\n    void foo(int x) {     // +1\n        foo(switch (x) {\n            default -> {\n                if (a) { // +1\n                    yield 1;\n                } else {\n                    yield 2;\n                }\n            }\n        });\n    }\n}", "author": "oowekyala", "createdAt": "2020-07-20T14:57:45Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/metrics/impl/internal/CycloVisitor.java", "diffHunk": "@@ -65,13 +67,24 @@ public Object visit(ASTSwitchStatement node, Object data) {\n             }\n \n             if (considerBooleanPaths) {\n-                ((MutableInt) data).increment();\n+                ((MutableInt) data).add(label.findChildrenOfType(ASTExpression.class).size());\n             } else if (node.getNumChildren() > 1 + label.getIndexInParent()\n                     && node.getChild(label.getIndexInParent() + 1) instanceof ASTBlockStatement) {\n                 // an empty label is only counted if we count boolean paths\n                 ((MutableInt) data).increment();\n             }\n         }\n+\n+        for (ASTSwitchLabeledRule rule : node.findChildrenOfType(ASTSwitchLabeledRule.class)) {\n+            ASTSwitchLabel label = rule.getFirstChildOfType(ASTSwitchLabel.class);\n+            if (label.isDefault()) {\n+                continue;", "originalCommit": "25bfb9d90995b72706af8ba30117df92eb55f97b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyMTQzOA==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r458321438", "bodyText": "I'll try to add this case on Thursday....", "author": "adangel", "createdAt": "2020-07-21T19:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NTU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NzQwNA==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r457467404", "bodyText": "I see, all this applies only to switch statements? You added support for non-fallthrough switch branches, but this still needs to handle switch expressions", "author": "oowekyala", "createdAt": "2020-07-20T14:59:43Z", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/metrics/impl/internal/CycloVisitor.java", "diffHunk": "@@ -65,13 +67,24 @@ public Object visit(ASTSwitchStatement node, Object data) {\n             }\n \n             if (considerBooleanPaths) {\n-                ((MutableInt) data).increment();\n+                ((MutableInt) data).add(label.findChildrenOfType(ASTExpression.class).size());\n             } else if (node.getNumChildren() > 1 + label.getIndexInParent()\n                     && node.getChild(label.getIndexInParent() + 1) instanceof ASTBlockStatement) {\n                 // an empty label is only counted if we count boolean paths\n                 ((MutableInt) data).increment();\n             }\n         }\n+", "originalCommit": "25bfb9d90995b72706af8ba30117df92eb55f97b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxNDI5Mw==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r459414293", "bodyText": "I think the other test case was not sufficient. Eg the following fails, the complexity of the switch expr is not counted:\nclass Foo {\n    int bar() { return 1; }\n    void foo(int i) {                    // +1\n        int x = switch (i) {\n            case 1, 2, 3 -> bar();  // +3\n            case 4       -> bar();  // +1\n            default -> bar();\n        };\n    }\n}\nI'll push a fix", "author": "oowekyala", "createdAt": "2020-07-23T12:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NzQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MTYyOQ==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r457471629", "bodyText": "Just being picky, the +1 is not for the switch, but for the method block\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    switch (x) {                            // +1\n          \n          \n            \n                    switch (x) {", "author": "oowekyala", "createdAt": "2020-07-20T15:04:16Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/metrics/impl/xml/CycloTest.xml", "diffHunk": "@@ -389,6 +389,71 @@ class Foo {\n         for (int i = 0; i != import1Tokens.length && i != import2Tokens.length; i++) {\n         }\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Multiple switch labels should count each</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 3.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        switch (x) {                 // +1\n+            case 1, 2: foo(); break; // +2\n+            default: bar(); break;\n+        }\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Switch labeled blocks should count</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 5.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        boolean a, b;\n+        switch (x) {                            // +1", "originalCommit": "25bfb9d90995b72706af8ba30117df92eb55f97b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyMDY3Mg==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r458320672", "bodyText": "I think, being picky here, is extremely useful :) This hopefully avoids later questions.... It's important, that the test case is correct (including the comments). So, the \"+1\" should be added to line 427 then?", "author": "adangel", "createdAt": "2020-07-21T18:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MTYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MTg0NA==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r457471844", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                void foo() {\n          \n          \n            \n                void foo() { // +1", "author": "oowekyala", "createdAt": "2020-07-20T15:04:28Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/metrics/impl/xml/CycloTest.xml", "diffHunk": "@@ -389,6 +389,71 @@ class Foo {\n         for (int i = 0; i != import1Tokens.length && i != import2Tokens.length; i++) {\n         }\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Multiple switch labels should count each</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 3.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        switch (x) {                 // +1\n+            case 1, 2: foo(); break; // +2\n+            default: bar(); break;\n+        }\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Switch labeled blocks should count</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 5.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {", "originalCommit": "25bfb9d90995b72706af8ba30117df92eb55f97b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MjcxMA==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r457472710", "bodyText": "Same\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    switch (x) {                // +1\n          \n          \n            \n                    switch (x) {", "author": "oowekyala", "createdAt": "2020-07-20T15:05:24Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/metrics/impl/xml/CycloTest.xml", "diffHunk": "@@ -389,6 +389,71 @@ class Foo {\n         for (int i = 0; i != import1Tokens.length && i != import2Tokens.length; i++) {\n         }\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Multiple switch labels should count each</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 3.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        switch (x) {                 // +1\n+            case 1, 2: foo(); break; // +2\n+            default: bar(); break;\n+        }\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Switch labeled blocks should count</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 5.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        boolean a, b;\n+        switch (x) {                            // +1\n+            case 1, 2 -> { if (a && b) bar(); } // +4\n+            default -> { bar(); }\n+        }\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Switch labeled expressions should count</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 5.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        switch (x) {                // +1", "originalCommit": "25bfb9d90995b72706af8ba30117df92eb55f97b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3MjkzMQ==", "url": "https://github.com/pmd/pmd/pull/2631#discussion_r457472931", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                void foo() {\n          \n          \n            \n                void foo() { // +1", "author": "oowekyala", "createdAt": "2020-07-20T15:05:39Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/metrics/impl/xml/CycloTest.xml", "diffHunk": "@@ -389,6 +389,71 @@ class Foo {\n         for (int i = 0; i != import1Tokens.length && i != import2Tokens.length; i++) {\n         }\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Multiple switch labels should count each</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 3.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        switch (x) {                 // +1\n+            case 1, 2: foo(); break; // +2\n+            default: bar(); break;\n+        }\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Switch labeled blocks should count</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 5.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {\n+        int x=0;\n+        boolean a, b;\n+        switch (x) {                            // +1\n+            case 1, 2 -> { if (a && b) bar(); } // +4\n+            default -> { bar(); }\n+        }\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>Switch labeled expressions should count</description>\n+        <expected-problems>2</expected-problems>\n+        <expected-messages>\n+            <message>'Foo#bar()' has value 1.</message>\n+            <message>'Foo#foo()' has value 5.</message>\n+        </expected-messages>\n+        <code><![CDATA[\n+class Foo {\n+    void bar(){}\n+    void foo() {", "originalCommit": "25bfb9d90995b72706af8ba30117df92eb55f97b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "677bfd4ae4e29fa63d14c23b3719aa8b7af5be5e", "url": "https://github.com/pmd/pmd/commit/677bfd4ae4e29fa63d14c23b3719aa8b7af5be5e", "message": "[java] Added additional test case for CycloMetric\n\nAnd fixed comments in test cases\n\nRefs #2631", "committedDate": "2020-07-23T07:46:50Z", "type": "commit"}, {"oid": "7941d8d6102e41208bff3f18f40b0f54347e8f91", "url": "https://github.com/pmd/pmd/commit/7941d8d6102e41208bff3f18f40b0f54347e8f91", "message": "Merge branch 'master' into issue-2625", "committedDate": "2020-07-23T07:57:57Z", "type": "commit"}, {"oid": "fbeaa5bc748613b13455cfb2a2b65a1d7b5b0928", "url": "https://github.com/pmd/pmd/commit/fbeaa5bc748613b13455cfb2a2b65a1d7b5b0928", "message": "Merge branch 'master' into issue-2625", "committedDate": "2020-07-23T12:26:33Z", "type": "commit"}, {"oid": "9a47d658e690e08b2b73e8f70c088730ff15c551", "url": "https://github.com/pmd/pmd/commit/9a47d658e690e08b2b73e8f70c088730ff15c551", "message": "Handle switch exprs properly", "committedDate": "2020-07-23T12:42:29Z", "type": "commit"}, {"oid": "6a9a834c672dc241053b5aeff5eaa5e199e30746", "url": "https://github.com/pmd/pmd/commit/6a9a834c672dc241053b5aeff5eaa5e199e30746", "message": "Same for NPath", "committedDate": "2020-07-23T12:51:26Z", "type": "commit"}]}