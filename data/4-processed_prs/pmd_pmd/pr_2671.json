{"pr_number": 2671, "pr_title": "[java] CloseResource false positive when resource included in return value", "pr_createdAt": "2020-07-27T17:23:09Z", "pr_url": "https://github.com/pmd/pmd/pull/2671", "timeline": [{"oid": "4bb37593714fa2c0eb7bd305b3b828837b8870b8", "url": "https://github.com/pmd/pmd/commit/4bb37593714fa2c0eb7bd305b3b828837b8870b8", "message": "[java] CloseResource false positive when resource included in return value", "committedDate": "2020-07-27T17:00:45Z", "type": "commit"}, {"oid": "aa3271978ff1b2c114adcb288bec304d4393df98", "url": "https://github.com/pmd/pmd/commit/aa3271978ff1b2c114adcb288bec304d4393df98", "message": "CloseResource: a method call as an allocation argument bug fix", "committedDate": "2020-07-27T20:45:02Z", "type": "commit"}, {"oid": "aa3271978ff1b2c114adcb288bec304d4393df98", "url": "https://github.com/pmd/pmd/commit/aa3271978ff1b2c114adcb288bec304d4393df98", "message": "CloseResource: a method call as an allocation argument bug fix", "committedDate": "2020-07-27T20:45:02Z", "type": "forcePushed"}, {"oid": "58c55d07ed9c9fb73184ac311e99b9cc81928040", "url": "https://github.com/pmd/pmd/commit/58c55d07ed9c9fb73184ac311e99b9cc81928040", "message": "CloseResource: addCloseResourceViolation fix", "committedDate": "2020-07-28T07:58:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MDQxNg==", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r463460416", "bodyText": "I would argue, we should not report this case: If we know, that the underlying stream is a ByteArrayInputStream, then we can ignore the case: ByteArrayInputStream (as well as ByteArrayOutputStream, StringReader/-Writer) - see the property ALLOWED_RESOURCE_TYPES.\nThe only problematic code here is, that close() is called (so the programmer had the intention to close the stream), but it is not done in a finally block.... and only bos is closed and not ois.\nBut as mentioned, since this is a ByteArrayInputStream/OutputStream, it is not problematic, but bad style...\nMaybe we should give that case a special message? -> \"bos is not closed within a finally block, thus might not be closed at all in case of exceptions\".\nNote: You can also assert the violation message, that is produced by the rule with\n        <expected-messages>\n            <message>Ensure that resources like this Connection object are closed after use</message>\n        </expected-messages>\n\nSee also https://pmd.github.io/latest/pmd_userdocs_extending_testing.html", "author": "adangel", "createdAt": "2020-07-31T07:54:17Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -1292,6 +1292,44 @@ public class CloseResourceNullPointer {\n     public void check(UnknownType param) {\n         InputStream in = param;\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>#2470 false-positive at lambda returned from method</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+import java.io.*;\n+import java.util.function.Supplier;\n+public class Foo {\n+    public Supplier<Integer> bar() throws IOException {\n+        InputStream inputStream = new FileInputStream(\"/test.txt\");\n+        return () -> {\n+            try {\n+                return inputStream.read();\n+            } finally {\n+                inputStream.close();\n+            }\n+        };\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>wrapped ByteArrayInputStream false-negative test</description>\n+        <expected-problems>1</expected-problems>\n+        <expected-linenumbers>5</expected-linenumbers>\n+        <code><![CDATA[\n+import java.io.*;\n+public class Foo {\n+    public void bar() {\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream(new byte[10]);\n+        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bos.toByteArray()));", "originalCommit": "58c55d07ed9c9fb73184ac311e99b9cc81928040", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MjAyNA==", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r463462024", "bodyText": "What happens, if the input stream is used in the lamda, but not closed? Could you add another test case?\nimport java.io.*;\nimport java.util.function.Supplier;\npublic class Foo {\n    public Supplier<Integer> bar() {\n        InputStream inputStream = new FileInputStream(\"/test.txt\");\n        return () -> {\n            try {\n                return inputStream.read();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        };\n    }\n}\nHere we should report a violation.", "author": "adangel", "createdAt": "2020-07-31T07:57:50Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -1292,6 +1292,44 @@ public class CloseResourceNullPointer {\n     public void check(UnknownType param) {\n         InputStream in = param;\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>#2470 false-positive at lambda returned from method</description>", "originalCommit": "58c55d07ed9c9fb73184ac311e99b9cc81928040", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee", "url": "https://github.com/pmd/pmd/commit/db8b1aebd378fc46979c8225946ab9d0e370a0ee", "message": "CloseResource: close() should be in finally detection; try-with-resource var wrapping detection; wrapped type resolution fix", "committedDate": "2020-08-03T14:14:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODg4Mw==", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474058883", "bodyText": "hm... doubling the violations here is weird. Do we report these cases twice?", "author": "adangel", "createdAt": "2020-08-20T15:11:36Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -543,7 +543,7 @@ public class Bar {\n \n     <test-code>\n         <description>#1375 CloseResource not detected properly - ok</description>\n-        <expected-problems>1</expected-problems>\n+        <expected-problems>2</expected-problems>", "originalCommit": "db8b1aebd378fc46979c8225946ab9d0e370a0ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTI5Mw==", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474135293", "bodyText": "so, these are the messages:\nn/a:6:\tEnsure that resources like this ResultSet object are closed after use\nn/a:11:\t'rs' is not closed within a finally block, thus might not be closed at all in case of exceptions\nthey kind of mean the same thing: the resultset \"rs\" is maybe not closed after use...", "author": "adangel", "createdAt": "2020-08-20T16:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0MjQ0Mw==", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474142443", "bodyText": "I'll add a check, so that we don't report violations twice for the same variable.", "author": "adangel", "createdAt": "2020-08-20T17:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzMzkyMA==", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474133920", "bodyText": "Ok, we have the following reported problems:\nn/a:8:\tEnsure that resources like this Connection object are closed after use\nn/a:9:\tEnsure that resources like this Statement object are closed after use\nn/a:13:\t'rs' is not closed within a finally block, thus might not be closed at all in case of exceptions\nso that seems ok.", "author": "adangel", "createdAt": "2020-08-20T16:50:50Z", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -377,7 +377,7 @@ public class Test {\n \n     <test-code>\n         <description>#947 CloseResource rule fails if field is marked with annotation</description>\n-        <expected-problems>2</expected-problems>\n+        <expected-problems>3</expected-problems>", "originalCommit": "db8b1aebd378fc46979c8225946ab9d0e370a0ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e1370fac7b1babb781a14b3900ce7f43f2c2194", "url": "https://github.com/pmd/pmd/commit/9e1370fac7b1babb781a14b3900ce7f43f2c2194", "message": "[java] CloseResource - avoid duplicated violations", "committedDate": "2020-08-20T17:07:52Z", "type": "commit"}, {"oid": "61ba8efcc1f056bee8b2774621833b78ed47e8f3", "url": "https://github.com/pmd/pmd/commit/61ba8efcc1f056bee8b2774621833b78ed47e8f3", "message": "[doc] Update release notes, fixes #2470, refs #2671", "committedDate": "2020-08-20T17:10:01Z", "type": "commit"}, {"oid": "0e743cc542fb87910accfa3be324481548606ade", "url": "https://github.com/pmd/pmd/commit/0e743cc542fb87910accfa3be324481548606ade", "message": "Merge branch 'master' into pr-2671", "committedDate": "2020-08-20T17:13:14Z", "type": "commit"}, {"oid": "36f61f44aa83eef19443ff20166fa914966da05b", "url": "https://github.com/pmd/pmd/commit/36f61f44aa83eef19443ff20166fa914966da05b", "message": "[java] CloseResource: fix false positive with close on not closeable", "committedDate": "2020-08-21T07:15:30Z", "type": "commit"}, {"oid": "b73b1e92f3951915cf25b9659e6ba51d4a80c106", "url": "https://github.com/pmd/pmd/commit/b73b1e92f3951915cf25b9659e6ba51d4a80c106", "message": "[java] CloseResource: add new property \"closeNotInFinally\"", "committedDate": "2020-08-21T07:33:24Z", "type": "commit"}]}