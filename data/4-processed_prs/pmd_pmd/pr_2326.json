{"pr_number": 2326, "pr_title": "[plsql] Added XML functions to parser: extract(xml), xml_root and fixed xml_forest", "pr_createdAt": "2020-03-04T14:17:29Z", "pr_url": "https://github.com/pmd/pmd/pull/2326", "timeline": [{"oid": "69025d75228d664e66747c0a1059746220c5d0f4", "url": "https://github.com/pmd/pmd/commit/69025d75228d664e66747c0a1059746220c5d0f4", "message": "extract(xml), xml_root, xml_forest fix", "committedDate": "2020-03-04T14:10:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3ODk2Ng==", "url": "https://github.com/pmd/pmd/pull/2326#discussion_r388178966", "bodyText": "Are you sure, that <AS> is optional? It doesn't look like that in the spec: https://docs.oracle.com/en/database/oracle/oracle-database/18/sqlrf/XMLFOREST.html#GUID-68E5C67E-CE97-4BF8-B7FF-2365E062C363", "author": "adangel", "createdAt": "2020-03-05T09:42:48Z", "path": "pmd-plsql/etc/grammar/PldocAST.jjt", "diffHunk": "@@ -1640,8 +1640,9 @@ ASTFunctionCall FunctionCall() :\n       | LOOKAHEAD({\"XMLCAST\".equalsIgnoreCase(token.getImage())}) \"(\" Expression() <AS> Datatype() \")\"\n       | LOOKAHEAD({\"XMLQUERY\".equalsIgnoreCase(token.getImage())}) \"(\" StringLiteral() [ LOOKAHEAD({isKeyword(\"PASSING\")}) XMLPassingClause() ] <RETURNING> KEYWORD(\"CONTENT\") [ <NULL> <ON> <EMPTY> ] \")\"\n       | LOOKAHEAD({\"CAST\".equalsIgnoreCase(token.getImage())}) \"(\" ( <MULTISET> \"(\" Subquery() \")\" | Expression() ) <AS> Datatype() \")\"\n-      | LOOKAHEAD({\"XMLFOREST\".equalsIgnoreCase(token.getImage())}) \"(\" SqlExpression() [ <AS> ID() ] ( \",\" SqlExpression() [ <AS> ID() ] )* \")\"\n+      | LOOKAHEAD({\"XMLFOREST\".equalsIgnoreCase(token.getImage())}) \"(\" SqlExpression() [ <AS> ] [ ID() ] ( \",\" SqlExpression() [ <AS> ]  [ ID() ] )* \")\"", "originalCommit": "69025d75228d664e66747c0a1059746220c5d0f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5Njk0Mw==", "url": "https://github.com/pmd/pmd/pull/2326#discussion_r388196943", "bodyText": "I'll undo that - all the tests still pass.\nPlease open a separate ticket/PR with a test case, if this should be parsed differently.", "author": "adangel", "createdAt": "2020-03-05T10:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3ODk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNzUyNA==", "url": "https://github.com/pmd/pmd/pull/2326#discussion_r388807524", "bodyText": "Ok, thank you. I had an parsing exception that was resolved by that modification, but it looks like you're right and it shouldn't be optional. I will try to find piece of code that was causing exception and figure out different solution.", "author": "szyman23", "createdAt": "2020-03-06T09:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3ODk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MTgxMg==", "url": "https://github.com/pmd/pmd/pull/2326#discussion_r388191812", "bodyText": "I think, the usage of the SchemaName production here is misleading - it is not a database schema, but a XML schema namespace...\nIt would be a string literal, e.g.\n'xmlns:a=\"http://XXX/AnimalMovement/Response\" xmlns:b=\"http://XXX/AnimalMovementExport\"'\n(example from https://community.oracle.com/thread/719673)\nThe second parameter here (\"Expression()\") is actually the XPath_string, which is also just a String Literal...\nI'll change both to StringLiterals and enhance the node ASTExtractExpression.", "author": "adangel", "createdAt": "2020-03-05T10:05:22Z", "path": "pmd-plsql/etc/grammar/PldocAST.jjt", "diffHunk": "@@ -3240,14 +3241,22 @@ ASTUnaryExpression UnaryExpression(boolean isUnarySign) #UnaryExpression(>1) :\n ASTExtractExpression ExtractExpression() :\n {}\n {\n+    LOOKAHEAD(4)\n     <EXTRACT> \"(\"\n         ( <MONTH> | <YEAR> | <DAY> |<HOUR> | <MINUTE> | <SECOND>\n         | <TIMEZONE_HOUR> | <TIMEZONE_MINUTE>\n         | <TIMEZONE_REGION> | <TIMEZONE_ABBR> )\n     <FROM>\n-        (LOOKAHEAD(2) FunctionCall()\n-        |LOOKAHEAD(2) DateTimeLiteral()\n-        |LOOKAHEAD(1) Name() ) \")\"\n+            (\n+            LOOKAHEAD(FunctionCall()) FunctionCall()\n+            |\n+            LOOKAHEAD(DateTimeLiteral()) DateTimeLiteral()\n+            |\n+            LOOKAHEAD(Name()) Name()\n+            ) \")\"\n+        { return jjtThis ; }\n+    |\n+    LOOKAHEAD(3)  <EXTRACT> \"(\" Argument() \",\" Expression() [\",\" SchemaName() ] \")\"", "originalCommit": "69025d75228d664e66747c0a1059746220c5d0f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIwMDE4Ng==", "url": "https://github.com/pmd/pmd/pull/2326#discussion_r388200186", "bodyText": "The last [\"VALUE\"] needs to be inside the previous brackets starting with [ \",\" KEYWORD(STANDALONE) ]...\nI'll fix that.", "author": "adangel", "createdAt": "2020-03-05T10:20:50Z", "path": "pmd-plsql/etc/grammar/PldocAST.jjt", "diffHunk": "@@ -1640,8 +1640,9 @@ ASTFunctionCall FunctionCall() :\n       | LOOKAHEAD({\"XMLCAST\".equalsIgnoreCase(token.getImage())}) \"(\" Expression() <AS> Datatype() \")\"\n       | LOOKAHEAD({\"XMLQUERY\".equalsIgnoreCase(token.getImage())}) \"(\" StringLiteral() [ LOOKAHEAD({isKeyword(\"PASSING\")}) XMLPassingClause() ] <RETURNING> KEYWORD(\"CONTENT\") [ <NULL> <ON> <EMPTY> ] \")\"\n       | LOOKAHEAD({\"CAST\".equalsIgnoreCase(token.getImage())}) \"(\" ( <MULTISET> \"(\" Subquery() \")\" | Expression() ) <AS> Datatype() \")\"\n-      | LOOKAHEAD({\"XMLFOREST\".equalsIgnoreCase(token.getImage())}) \"(\" SqlExpression() [ <AS> ID() ] ( \",\" SqlExpression() [ <AS> ID() ] )* \")\"\n+      | LOOKAHEAD({\"XMLFOREST\".equalsIgnoreCase(token.getImage())}) \"(\" SqlExpression() [ <AS> ] [ ID() ] ( \",\" SqlExpression() [ <AS> ]  [ ID() ] )* \")\"\n       | LOOKAHEAD({\"XMLELEMENT\".equalsIgnoreCase(token.getImage())}) XMLElement()\n+      | LOOKAHEAD({\"XMLROOT\".equalsIgnoreCase(token.getImage())}) \"(\" Expression() \",\" KEYWORD(\"VERSION\") (LOOKAHEAD(2) ( <NO> \"VALUE\") | Expression() )  [ \",\" KEYWORD(\"STANDALONE\")  ( <YES> | <NO> )] [ \"VALUE\" ]  \")\"", "originalCommit": "69025d75228d664e66747c0a1059746220c5d0f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}