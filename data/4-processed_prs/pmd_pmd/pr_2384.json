{"pr_number": 2384, "pr_title": "[java] Performance improve xpath based rules", "pr_createdAt": "2020-03-27T17:45:19Z", "pr_url": "https://github.com/pmd/pmd/pull/2384", "timeline": [{"oid": "25ef59d5a72dbc6a0c42491131ad891472361e0e", "url": "https://github.com/pmd/pmd/commit/25ef59d5a72dbc6a0c42491131ad891472361e0e", "message": "[java] Performance improve xpath based rules\n\nIf an unbounded path expression like\n\n    //PrimaryExpression[//ClassOrInterfaceDeclaration]\n\nis used, then this will search the whole document again.\nIt will also avoid using rule chain later on, see #2382", "committedDate": "2020-03-27T17:41:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NDIyNA==", "url": "https://github.com/pmd/pmd/pull/2384#discussion_r399454224", "bodyText": "This actually fixes some false-negative when nested classes are in use...\nSee e.g. https://chunk.io/pmd/f0f07b25b93b453e993fa6b0d71b44e6/diff/checkstyle/index.html#A1", "author": "adangel", "createdAt": "2020-03-27T18:14:01Z", "path": "pmd-java/src/main/resources/category/java/design.xml", "diffHunk": "@@ -28,7 +28,7 @@ protected constructor in order to prevent instantiation than make the class misl\n <![CDATA[\n //ClassOrInterfaceDeclaration\n     [@Abstract = 'true']\n-    [count(//MethodDeclaration) + count(//ConstructorDeclaration) = 0]\n+    [count(.//MethodDeclaration) + count(.//ConstructorDeclaration) = 0]", "originalCommit": "25ef59d5a72dbc6a0c42491131ad891472361e0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NDE1Mg==", "url": "https://github.com/pmd/pmd/pull/2384#discussion_r399644152", "bodyText": "This still counts methods of classes nested inside the class under scrutiny. I'll fix this and add those as test cases", "author": "oowekyala", "createdAt": "2020-03-28T10:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NDIyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NTYwMQ==", "url": "https://github.com/pmd/pmd/pull/2384#discussion_r399455601", "bodyText": "These changes now create a new false-negative, see https://chunk.io/pmd/f0f07b25b93b453e993fa6b0d71b44e6/diff/spring-framework/index.html#A1\n... not sure why...", "author": "adangel", "createdAt": "2020-03-27T18:16:36Z", "path": "pmd-java/src/main/resources/category/java/bestpractices.xml", "diffHunk": "@@ -1513,20 +1523,25 @@ by more specific methods, like assertSame, assertNotSame.\n                 <value>\n <![CDATA[\n //PrimaryExpression[\n-    PrimaryPrefix/Name", "originalCommit": "25ef59d5a72dbc6a0c42491131ad891472361e0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1OTI2NA==", "url": "https://github.com/pmd/pmd/pull/2384#discussion_r399459264", "bodyText": "Might be because of typeresolution:\nBefore: ancestor::ClassOrInterfaceDeclaration[//ClassOrInterfaceType[pmd-java:typeIs('junit.framework.TestCase')]]\nAfter: ancestor::ClassOrInterfaceDeclaration[pmd-java:typeIs('junit.framework.TestCase')]\nMaybe we should keep it like this?\nancestor::ClassOrInterfaceDeclaration[ExtendsList/ClassOrInterfaceType[pmd-java:typeIs('junit.framework.TestCase')]]\nIt would only affect if typeresolution doesn't have access to the whole auxclasspath.\nHm... that's not actually the issue here: Before, we found the @Test annotation on the main class in this file and assumed, also the other classes are tests. This is probably not correct, since ExposedInvocationTestBean or TestBean is not a test case....", "author": "adangel", "createdAt": "2020-03-27T18:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NTYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY0NTY1Nw==", "url": "https://github.com/pmd/pmd/pull/2384#discussion_r399645657", "bodyText": "The thing is this rule is not valid only in test classes. It applies to any usage of Assert.assertTrue. Type resolution doesn't give access to which method is invoked, so we try to see if we're in a test class by finding an @Test, to see if a call to a method named assertTrue is really a junit call, instead of a user defined function. This is just a heuristic. Maybe we should change it to check if there are imports for org.junit. (note that in 7.0 we will have an API to get the invoked method and won't need a shady workaround)", "author": "oowekyala", "createdAt": "2020-03-28T10:19:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NTYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgxMzk0Nw==", "url": "https://github.com/pmd/pmd/pull/2384#discussion_r399813947", "bodyText": "Most rules in this area check, that they are analyzing a TestCase/@Test annotated method. But there is one exception: UseAssertTrueInsteadOfAssertEquals does not do this check like the others...\nMaybe it makes sense to don't restrict the rules (like UseAssertSameInsteadOfAssertTrue) to test classes only? That would definitively solve the performance problems with these rules ...", "author": "adangel", "createdAt": "2020-03-29T15:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NTYwMQ=="}], "type": "inlineReview"}, {"oid": "552931d965e4ec0e8ad8263c274e94a8b20bc1de", "url": "https://github.com/pmd/pmd/commit/552931d965e4ec0e8ad8263c274e94a8b20bc1de", "message": "Fix AbstractClassWithoutAnyMethods FN with inner classes", "committedDate": "2020-03-28T10:03:40Z", "type": "commit"}, {"oid": "485fa4ad500c467e258dc5073cd9a4a1ecd4e264", "url": "https://github.com/pmd/pmd/commit/485fa4ad500c467e258dc5073cd9a4a1ecd4e264", "message": "Fix test case name", "committedDate": "2020-03-28T10:06:10Z", "type": "commit"}]}