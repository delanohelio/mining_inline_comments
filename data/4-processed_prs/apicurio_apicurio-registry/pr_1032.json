{"pr_number": 1032, "pr_title": "Initial auth capabilities", "pr_createdAt": "2020-11-25T10:32:48Z", "pr_url": "https://github.com/Apicurio/apicurio-registry/pull/1032", "timeline": [{"oid": "9e194a317741c0027e07e2e58b459a380a668f24", "url": "https://github.com/Apicurio/apicurio-registry/commit/9e194a317741c0027e07e2e58b459a380a668f24", "message": "Remove x argument from verify workflow", "committedDate": "2020-11-27T12:47:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NzQ1OQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/1032#discussion_r532687459", "bodyText": "Can you iterate on this to match the description in the security ADR?  The roles defined there are a bit different than what we have here.  Also you'll need to make sure we're protecting both compatibility APIs as well (ccompat and ibmcompat).", "author": "EricWittmann", "createdAt": "2020-11-30T15:35:43Z", "path": "app/src/main/resources/application.properties", "diffHunk": "@@ -78,3 +78,41 @@ mp.openapi.servers=/api\n %prod.registry.events.kafka.config.enable.idempotence=true\n %prod.registry.events.kafka.config.retries=3\n %prod.registry.events.kafka.config.acks=all\n+\n+#Auth - disabled by default\n+\n+quarkus.oidc.enabled=true\n+quarkus.oidc.tenant-enabled=${AUTH_ENABLED:false}\n+\n+registry.keycloak.url=${KEYCLOAK_URL:https://studio-auth.apicur.io/auth}\n+registry.keycloak.realm=${KEYCLOAK_REALM:apicurio-local}\n+\n+quarkus.oidc.auth-server-url=${registry.keycloak.url}/realms/${registry.keycloak.realm}\n+quarkus.oidc.client-id=${KEYCLOAK_API_CLIENT_ID:registry-api}\n+\n+registry.ui.config.auth.keycloak.url=${registry.keycloak.url}\n+registry.ui.config.auth.keycloak.realm=${registry.keycloak.realm}\n+registry.ui.config.auth.keycloak.clientId=${KEYCLOAK_UI_CLIENT_ID:apicurio-registry}\n+registry.ui.config.auth.keycloak.onLoad=login-required\n+\n+quarkus.http.auth.policy.read-policy.roles-allowed=registry-user,registry-admin\n+quarkus.http.auth.permission.user.enabled=${AUTH_ENABLED:false}\n+quarkus.http.auth.permission.user.paths=/api/*,/public/*,/css/*,/js/*,/robots.txt\n+quarkus.http.auth.permission.user.policy=read-policy\n+quarkus.http.auth.permission.user.methods=GET,HEAD\n+\n+quarkus.http.auth.policy.modify-policy.roles-allowed=registry-admin\n+quarkus.http.auth.permission.admin.enabled=${AUTH_ENABLED:false}\n+quarkus.http.auth.permission.admin.paths=/api/*,/public/*,/css/*,/js/*,/robots.txt\n+quarkus.http.auth.permission.admin.policy=modify-policy\n+quarkus.http.auth.permission.admin.methods=PUT,POST,DELETE,PATCH\n+\n+quarkus.http.auth.permission.permit1.enabled=${AUTH_ENABLED:false}\n+quarkus.http.auth.permission.permit1.paths=/health,/openapi,/metrics/*\n+quarkus.http.auth.permission.permit1.policy=permit\n+quarkus.http.auth.permission.permit1.methods=GET\n+\n+quarkus.http.auth.permission.authenticated.enabled=${AUTH_ENABLED:false}\n+quarkus.http.auth.permission.authenticated.paths=/api/*\n+quarkus.http.auth.permission.authenticated.policy=authenticated", "originalCommit": "9e194a317741c0027e07e2e58b459a380a668f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5ODA0Ng==", "url": "https://github.com/Apicurio/apicurio-registry/pull/1032#discussion_r534098046", "bodyText": "I have adapted the permissions and tested the compatibility APIs.", "author": "carlesarnal", "createdAt": "2020-12-02T11:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2NDAwOQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/1032#discussion_r534464009", "bodyText": "I think there should be 3 roles, no?\n\nRead-Only\nModify allowed (standard access)\nAdmin (same as above + can modify global rules)\n\nI'm not seeing that here yet.", "author": "EricWittmann", "createdAt": "2020-12-02T20:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxNjkxNA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/1032#discussion_r534516914", "bodyText": "I think that you have reviewed an outdated version of the file. I've added the three requires roles. You can see that here", "author": "carlesarnal", "createdAt": "2020-12-02T22:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU3NzQxNg==", "url": "https://github.com/Apicurio/apicurio-registry/pull/1032#discussion_r534577416", "bodyText": "You were right, sorry about that.  I was definitely looking at the old stuff.  My bad.", "author": "EricWittmann", "createdAt": "2020-12-03T00:34:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NzQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwNDMyMQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/1032#discussion_r532704321", "bodyText": "This file should probably be deleted - the kafka variant has been removed.", "author": "EricWittmann", "createdAt": "2020-11-30T15:57:38Z", "path": "storage/kafka/src/test/resources/cluster-test.properties", "diffHunk": "@@ -0,0 +1,6 @@\n+\n+initializer=io.apicurio.registry.storage.util.KafkaServiceInitializer\n+node1.props=-Dquarkus.profile=dev -Dbootstrap.servers=${bootstrap.servers} -Dquarkus.oidc.tenant-enabled=false\n+node2.props=-Dquarkus.profile=dev -Dbootstrap.servers=${bootstrap.servers} -Dquarkus.http.port=8081 -Dquarkus.oidc.tenant-enabled=false\n+end.1=Cluster ID:\n+end.2=Resetting offset for partition storage-topic-0 to offset", "originalCommit": "9e194a317741c0027e07e2e58b459a380a668f24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e2f4655b0349266644fbe1cce26456d772cf849f", "url": "https://github.com/Apicurio/apicurio-registry/commit/e2f4655b0349266644fbe1cce26456d772cf849f", "message": "add the auth branch to the verify workflow", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "a9625b64c80e6bf4e68d10f55a5cf06ee9ef4f3c", "url": "https://github.com/Apicurio/apicurio-registry/commit/a9625b64c80e6bf4e68d10f55a5cf06ee9ef4f3c", "message": "Auth poc 674 (#918)\n\n* Initial auth config for the ui\r\n\r\n* Move keycloak auth impl to app component\r\n\r\n* Parametrize ui auth config\r\n\r\n* Initial backend support for auth\r\n\r\n* Refactor ui auth add auth service\r\n\r\n* Add default auth config\r\n\r\n* Add auth server to test resources\r\n\r\n* Add role management\r\n\r\n* Fix restrictions and add test auth resources\r\n\r\n* Fix rest tests with auth\r\n\r\n* Make client id non optional\r\n\r\n* Auth poc 674 (#704)\r\n\r\n* Initial auth config for the ui\r\n\r\n* Move keycloak auth impl to app component\r\n\r\n* Parametrize ui auth config\r\n\r\n* Initial backend support for auth\r\n\r\n* Refactor ui auth add auth service\r\n\r\n* Add default auth config\r\n\r\n* Adding support for auth for the registry client (#695)\r\n\r\n* Adding support for authorization header with every request & allowing registry client to set the bearer token\r\n\r\n* add auth impl for authprovider like keycloak and send auth token as Authorization header\r\n\r\n* adding keycloak docker maven plugin for auth integration testing:  mvn clean install -Dtest-keycloak -Ddocker\r\n\r\n* update url of keycloak server & add missing bearer string in the gettoken method\r\n\r\n* Added authconfig param in the factory invocation method for registry client & updated authutil to return client with token header\r\n\r\n* Fix properties and tests\r\n\r\n* Setting activeByDefault to true for docker-keycloak profile\r\n\r\n* Add auth to new client and some cleanup\r\n\r\n* Fix mojo tests\r\n\r\n* Fix serde config test\r\n\r\n* Add keycloak profile for testing\r\n\r\n* Fix download registry mojo\r\n\r\n* Add cluster properties\r\n\r\n* Fix security properties\r\n\r\n* Add auth to new client and fix tests\r\n\r\n* Create keycloak based on test property\r\n\r\n* Fix jpa tests\r\n\r\n* Add missing cluster properties\r\n\r\n* Fix tests for kafka storage\r\n\r\n* Fix stream storage tests\r\n\r\n* Fix cluster integration test\r\n\r\n* Add infinispan initializer\r\n\r\n* Fix missing import\r\n\r\n* Remove auth from basic testing\r\n\r\nCo-authored-by: Abhishek koserwal <akoserwa@redhat.com>", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "8515eb8c6434d5dbfaf6777c0b7aa7337184448e", "url": "https://github.com/Apicurio/apicurio-registry/commit/8515eb8c6434d5dbfaf6777c0b7aa7337184448e", "message": "Update cluster-test.properties", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "a23f2f11509e758c7c9bbdb34875e14861a890c5", "url": "https://github.com/Apicurio/apicurio-registry/commit/a23f2f11509e758c7c9bbdb34875e14861a890c5", "message": "Update verify.yaml", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "4e5abc3a2955702996c887a7ff62289d67aec99a", "url": "https://github.com/Apicurio/apicurio-registry/commit/4e5abc3a2955702996c887a7ff62289d67aec99a", "message": "UI auth/keycloak properties now get pushed to the UI properly (#926)", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "3fee65f5851bb8687a22c452321881fef37d6253", "url": "https://github.com/Apicurio/apicurio-registry/commit/3fee65f5851bb8687a22c452321881fef37d6253", "message": "UI auth/keycloak properties now get pushed to the UI properly (#926) (#924)\n\nCo-authored-by: Eric Wittmann <eric.wittmann@gmail.com>", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "6b0aa6752afd54729d75318165cfcfcf927481c1", "url": "https://github.com/Apicurio/apicurio-registry/commit/6b0aa6752afd54729d75318165cfcfcf927481c1", "message": "Remove compatible client", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "6fefeca6e9879aada95015d8a91e9887abb8bcda", "url": "https://github.com/Apicurio/apicurio-registry/commit/6fefeca6e9879aada95015d8a91e9887abb8bcda", "message": "Add support for oauth client credentials flow", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "57159dcc8c6b087a7be811fdd8face10eb40ca53", "url": "https://github.com/Apicurio/apicurio-registry/commit/57159dcc8c6b087a7be811fdd8face10eb40ca53", "message": "Add basic auth strategy", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "09d5d8a27bb34d08536f80e9315631a974be2266", "url": "https://github.com/Apicurio/apicurio-registry/commit/09d5d8a27bb34d08536f80e9315631a974be2266", "message": "Auth poc 674 (#918)\n\n* Initial auth config for the ui\r\n\r\n* Move keycloak auth impl to app component\r\n\r\n* Parametrize ui auth config\r\n\r\n* Initial backend support for auth\r\n\r\n* Refactor ui auth add auth service\r\n\r\n* Add default auth config\r\n\r\n* Add auth server to test resources\r\n\r\n* Add role management\r\n\r\n* Fix restrictions and add test auth resources\r\n\r\n* Fix rest tests with auth\r\n\r\n* Make client id non optional\r\n\r\n* Auth poc 674 (#704)\r\n\r\n* Initial auth config for the ui\r\n\r\n* Move keycloak auth impl to app component\r\n\r\n* Parametrize ui auth config\r\n\r\n* Initial backend support for auth\r\n\r\n* Refactor ui auth add auth service\r\n\r\n* Add default auth config\r\n\r\n* Adding support for auth for the registry client (#695)\r\n\r\n* Adding support for authorization header with every request & allowing registry client to set the bearer token\r\n\r\n* add auth impl for authprovider like keycloak and send auth token as Authorization header\r\n\r\n* adding keycloak docker maven plugin for auth integration testing:  mvn clean install -Dtest-keycloak -Ddocker\r\n\r\n* update url of keycloak server & add missing bearer string in the gettoken method\r\n\r\n* Added authconfig param in the factory invocation method for registry client & updated authutil to return client with token header\r\n\r\n* Fix properties and tests\r\n\r\n* Setting activeByDefault to true for docker-keycloak profile\r\n\r\n* Add auth to new client and some cleanup\r\n\r\n* Fix mojo tests\r\n\r\n* Fix serde config test\r\n\r\n* Add keycloak profile for testing\r\n\r\n* Fix download registry mojo\r\n\r\n* Add cluster properties\r\n\r\n* Fix security properties\r\n\r\n* Add auth to new client and fix tests\r\n\r\n* Create keycloak based on test property\r\n\r\n* Fix jpa tests\r\n\r\n* Add missing cluster properties\r\n\r\n* Fix tests for kafka storage\r\n\r\n* Fix stream storage tests\r\n\r\n* Fix cluster integration test\r\n\r\n* Add infinispan initializer\r\n\r\n* Fix missing import\r\n\r\n* Remove auth from basic testing\r\n\r\nCo-authored-by: Abhishek koserwal <akoserwa@redhat.com>", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "d6991345728fed1744b4c4326eeb71371a069b6d", "url": "https://github.com/Apicurio/apicurio-registry/commit/d6991345728fed1744b4c4326eeb71371a069b6d", "message": "Add auth enabling and disabling capabilities", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "a6227cbdfa61fa42645e2527e13713e3cd0256e5", "url": "https://github.com/Apicurio/apicurio-registry/commit/a6227cbdfa61fa42645e2527e13713e3cd0256e5", "message": "Remove auth branch as a target for the verify workflow", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "8b43480474b243efb491ae8b49100fee6d0c44d0", "url": "https://github.com/Apicurio/apicurio-registry/commit/8b43480474b243efb491ae8b49100fee6d0c44d0", "message": "Adapt auth properties", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "608469b27a34f2536410565caf2ed3ba6bd189bc", "url": "https://github.com/Apicurio/apicurio-registry/commit/608469b27a34f2536410565caf2ed3ba6bd189bc", "message": "Remove auth provider and config", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "d18f12c6942d87ed51f52ccbfc0e16074b0b68b6", "url": "https://github.com/Apicurio/apicurio-registry/commit/d18f12c6942d87ed51f52ccbfc0e16074b0b68b6", "message": "Clean up", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "e0e6db070fdaebe1ceba59490a3794439986e170", "url": "https://github.com/Apicurio/apicurio-registry/commit/e0e6db070fdaebe1ceba59490a3794439986e170", "message": "Remove unnecessary imports", "committedDate": "2020-12-14T09:39:10Z", "type": "commit"}, {"oid": "0417a606b1717ddeb470ba07506c1e857f18b19c", "url": "https://github.com/Apicurio/apicurio-registry/commit/0417a606b1717ddeb470ba07506c1e857f18b19c", "message": "Cleanup", "committedDate": "2020-12-14T09:41:50Z", "type": "commit"}, {"oid": "ec5fb763df7c28d6b382cb322bb85e0ca61ccc16", "url": "https://github.com/Apicurio/apicurio-registry/commit/ec5fb763df7c28d6b382cb322bb85e0ca61ccc16", "message": "Improve security roles", "committedDate": "2020-12-14T09:55:28Z", "type": "commit"}, {"oid": "543fcdaccc4db8d7e950a590a621b7f27fc52222", "url": "https://github.com/Apicurio/apicurio-registry/commit/543fcdaccc4db8d7e950a590a621b7f27fc52222", "message": "Simplified the auth/creds classes a bit (#1041)\n\n* simplified the auth/creds classes a bit\r\n\r\n* Removed some commented-out code", "committedDate": "2020-12-14T09:55:28Z", "type": "commit"}, {"oid": "2576c4faf014095b7c50f7f8fc25342028bcf313", "url": "https://github.com/Apicurio/apicurio-registry/commit/2576c4faf014095b7c50f7f8fc25342028bcf313", "message": "Remove unnecessary files", "committedDate": "2020-12-14T09:55:28Z", "type": "commit"}, {"oid": "70d6baeb7ad908cc054338bd7cd6d4afa2941028", "url": "https://github.com/Apicurio/apicurio-registry/commit/70d6baeb7ad908cc054338bd7cd6d4afa2941028", "message": "Adapt http permissions to match requirements", "committedDate": "2020-12-14T09:55:28Z", "type": "commit"}, {"oid": "425b2e2b170d870473d2494470a307a31eeeb84c", "url": "https://github.com/Apicurio/apicurio-registry/commit/425b2e2b170d870473d2494470a307a31eeeb84c", "message": "Add logout button", "committedDate": "2020-12-14T09:55:28Z", "type": "commit"}, {"oid": "7100a7933f4e0f82d42fae1d139e8156ed58527f", "url": "https://github.com/Apicurio/apicurio-registry/commit/7100a7933f4e0f82d42fae1d139e8156ed58527f", "message": "Cleanup", "committedDate": "2020-12-14T09:55:39Z", "type": "commit"}, {"oid": "aed2065ab70bfb29970bf2807f5008e262e8a9b6", "url": "https://github.com/Apicurio/apicurio-registry/commit/aed2065ab70bfb29970bf2807f5008e262e8a9b6", "message": "Hide logout button when auth is disabled", "committedDate": "2020-12-14T09:55:39Z", "type": "commit"}, {"oid": "a1b6624d61c6fc4872ce985e543e723d23998549", "url": "https://github.com/Apicurio/apicurio-registry/commit/a1b6624d61c6fc4872ce985e543e723d23998549", "message": "Add serdes auth support", "committedDate": "2020-12-14T09:55:39Z", "type": "commit"}, {"oid": "a1b6624d61c6fc4872ce985e543e723d23998549", "url": "https://github.com/Apicurio/apicurio-registry/commit/a1b6624d61c6fc4872ce985e543e723d23998549", "message": "Add serdes auth support", "committedDate": "2020-12-14T09:55:39Z", "type": "forcePushed"}, {"oid": "bfe2a903fa0113e3ad16e2cd6d38e7a7539acbcd", "url": "https://github.com/Apicurio/apicurio-registry/commit/bfe2a903fa0113e3ad16e2cd6d38e7a7539acbcd", "message": "Populate createdBy in map based storages", "committedDate": "2020-12-15T08:53:57Z", "type": "commit"}, {"oid": "5db71dca35fb4393a32cf3a476e84da71d7b1243", "url": "https://github.com/Apicurio/apicurio-registry/commit/5db71dca35fb4393a32cf3a476e84da71d7b1243", "message": "Populate created by in kafka sql storage", "committedDate": "2020-12-15T09:10:32Z", "type": "commit"}, {"oid": "2faeb4922dbd1911a8171d229ff2e0d430186c71", "url": "https://github.com/Apicurio/apicurio-registry/commit/2faeb4922dbd1911a8171d229ff2e0d430186c71", "message": "Populate created by in sql storage", "committedDate": "2020-12-15T09:18:22Z", "type": "commit"}, {"oid": "5087a341ebbc04681492d6f3f592e5950a112821", "url": "https://github.com/Apicurio/apicurio-registry/commit/5087a341ebbc04681492d6f3f592e5950a112821", "message": "merged latest from master", "committedDate": "2020-12-17T18:09:13Z", "type": "commit"}, {"oid": "0fb697bc0a24e65808911cedbec3f93b588a7d50", "url": "https://github.com/Apicurio/apicurio-registry/commit/0fb697bc0a24e65808911cedbec3f93b588a7d50", "message": "updated the UI to support auth use-cases, including disabling some UI elements for users without appropriate permissions (#1095)", "committedDate": "2020-12-21T10:53:50Z", "type": "commit"}, {"oid": "373d2984712afb03155161b1700c08eb38f83974", "url": "https://github.com/Apicurio/apicurio-registry/commit/373d2984712afb03155161b1700c08eb38f83974", "message": "Add streams storage created by support", "committedDate": "2020-12-22T09:36:56Z", "type": "commit"}, {"oid": "ff69261ec4240838b7a94f543b5a877c701db195", "url": "https://github.com/Apicurio/apicurio-registry/commit/ff69261ec4240838b7a94f543b5a877c701db195", "message": "Fix metadata error", "committedDate": "2020-12-22T10:06:11Z", "type": "commit"}, {"oid": "d260814d21bc654bc540a0f0f8376af63bd8af8c", "url": "https://github.com/Apicurio/apicurio-registry/commit/d260814d21bc654bc540a0f0f8376af63bd8af8c", "message": "Remove keycloak admin client library", "committedDate": "2020-12-23T10:38:43Z", "type": "commit"}, {"oid": "a37dbfa32b94e8574746de87260b6efa55c578e4", "url": "https://github.com/Apicurio/apicurio-registry/commit/a37dbfa32b94e8574746de87260b6efa55c578e4", "message": "Auth tests (#1102)\n\n* auth tests\r\n\r\n* fix tests, implement auth exceptions and fix properties\r\n\r\n* fix test deps and improve not authorized error handling\r\n\r\n* improve tests, artifactId\r\n\r\n* fix streams unstable tests (#1125)", "committedDate": "2021-01-07T14:00:21Z", "type": "commit"}, {"oid": "0baf9aff979b62952f65eb85b6d3954fc058cb99", "url": "https://github.com/Apicurio/apicurio-registry/commit/0baf9aff979b62952f65eb85b6d3954fc058cb99", "message": "Merge branch 'master' into 2.0.x-auth", "committedDate": "2021-01-07T14:27:45Z", "type": "commit"}]}