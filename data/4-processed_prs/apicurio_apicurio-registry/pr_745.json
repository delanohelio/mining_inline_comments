{"pr_number": 745, "pr_title": "Enhancements to the release workflow", "pr_createdAt": "2020-08-05T14:25:10Z", "pr_url": "https://github.com/Apicurio/apicurio-registry/pull/745", "timeline": [{"oid": "5db0cd102458b4337832ffb491b5a1e42005a74f", "url": "https://github.com/Apicurio/apicurio-registry/commit/5db0cd102458b4337832ffb491b5a1e42005a74f", "message": "Enhancements to the release workflow\n\nAdd step to tweet about the release\nRetry maven deploy step 3 times\nOther fixes to the flow due to steps introduced for apicurio website changes", "committedDate": "2020-08-05T14:23:55Z", "type": "commit"}, {"oid": "388df72328153280e1447139414d2a1fab002100", "url": "https://github.com/Apicurio/apicurio-registry/commit/388df72328153280e1447139414d2a1fab002100", "message": "Merge branch 'master' into feature/enhance-github-actions-workflow", "committedDate": "2020-08-10T13:23:33Z", "type": "commit"}, {"oid": "727dd5773ea73d0f9cd70323429e685a0ced342a", "url": "https://github.com/Apicurio/apicurio-registry/commit/727dd5773ea73d0f9cd70323429e685a0ced342a", "message": "Merge branch 'master' into feature/enhance-github-actions-workflow", "committedDate": "2020-08-10T15:11:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxNTg4NQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/745#discussion_r468015885", "bodyText": "Can you explain why this works?  I know && can be used to string together multiple commands - but I'm unfamiliar with the gritty details.\nE.g. does this stop trying if the first attempt succeeds?\n@jsenko and @carlesarnal - I would appreciate your thoughts on this.  I'm wondering if a script might be better here.", "author": "EricWittmann", "createdAt": "2020-08-10T16:06:06Z", "path": ".github/workflows/release.yaml", "diffHunk": "@@ -62,22 +57,28 @@ jobs:\n           git branch --set-upstream-to=origin/master\n           git pull\n       - name: Update Release Version ${{steps.metadata.outputs.release-version}}\n-        run: mvn versions:set -DnewVersion=${{steps.metadata.outputs.release-version}} -DgenerateBackupPoms=false -DprocessAllModules=true\n+        run: cd registry && mvn versions:set -DnewVersion=${{steps.metadata.outputs.release-version}} -DgenerateBackupPoms=false -DprocessAllModules=true\n       - name: Build All Variants\n-        run: mvn clean install -Pprod -Pjpa -Pinfinispan -Pkafka -Pstreams -Pasyncmem -DskipTests\n+        run: cd registry && mvn clean install -Pprod -Pjpa -Pinfinispan -Pkafka -Pstreams -Pasyncmem -DskipTests\n       - name: Commit Release Version Change\n         run: |\n+          cd registry\n           git add .\n           git commit -m \"Automated update to Release Version:: ${{steps.metadata.outputs.release-version}}\"\n           git push\n-      - name: Publish to Maven Central\n-        uses: samuelmeuli/action-maven-publish@v1\n-        with:\n-          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}\n-          gpg_passphrase: ${{ secrets.GPG_PASSPHRASE }}\n-          nexus_username: ${{ secrets.OSSRH_USERNAME }}\n-          nexus_password: ${{ secrets.OSSRH_TOKEN }}\n-          maven_goals_phases: deploy --batch-mode -Pprod -Pjpa -Pinfinispan -Pkafka -Pstreams -Pasyncmem -DskipTests -Prelease --settings /home/runner/.m2/settings.xml -DskipTests\n+      - name: Import GPG Key\n+        uses: crazy-max/ghaction-import-gpg@v1\n+        env:\n+          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}\n+          PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }} \n+      - name: Maven Deploy\n+        run: |\n+          cd registry\n+          # Retry 3 times before the steps actually fails\n+          (echo \"===== Maven Deploy Attempt: 1 ====\" && mvn deploy --batch-mode -Pprod -Pjpa -Pinfinispan -Pkafka -Pstreams -Pasyncmem -DskipTests -Prelease --settings /home/runner/.m2/settings.xml -DskipTests) || \\\n+          (echo \"===== Maven Deploy Attempt: 2 ====\" && mvn deploy --batch-mode -Pprod -Pjpa -Pinfinispan -Pkafka -Pstreams -Pasyncmem -DskipTests -Prelease --settings /home/runner/.m2/settings.xml -DskipTests) || \\\n+          (echo \"===== Maven Deploy Attempt: 3 ====\" && mvn deploy --batch-mode -Pprod -Pjpa -Pinfinispan -Pkafka -Pstreams -Pasyncmem -DskipTests -Prelease --settings /home/runner/.m2/settings.xml -DskipTests) || \\\n+          (echo \"==== Maven Deploy Step Failed ====\" && exit 1)", "originalCommit": "727dd5773ea73d0f9cd70323429e685a0ced342a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc0MTk2OQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/745#discussion_r468741969", "bodyText": "@riprasad I realized my confusion here is because you used the && operator between the echo and mvn commands and then you used the || operator after that.  I didn't catch that on first reading and thought/assumed you were using && between each command (which is what I've seen often in e.g. Dockerfiles).  So I was not understanding the code.  But now I do and it makes sense.  The || operator isn't something I've used before but looking at the docs for it it makes sense.", "author": "EricWittmann", "createdAt": "2020-08-11T17:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxNTg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA5NDgxNA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/745#discussion_r469094814", "bodyText": "@EricWittmann Yes, correct!\nSorry for the delayed response though. I always miss mails from Github. I have a filter in place now to have all Github mails in one folder for better visibility and tracking.", "author": "riprasad", "createdAt": "2020-08-12T08:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxNTg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIxMjE0OA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/745#discussion_r469212148", "bodyText": "Thank you, @riprasad - I do the same thing (gmail filter for GH emails).", "author": "EricWittmann", "createdAt": "2020-08-12T12:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxNTg4NQ=="}], "type": "inlineReview"}]}