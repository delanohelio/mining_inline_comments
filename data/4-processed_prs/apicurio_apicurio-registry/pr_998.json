{"pr_number": 998, "pr_title": "Allow client headers modification on a per request basis", "pr_createdAt": "2020-11-10T11:37:56Z", "pr_url": "https://github.com/Apicurio/apicurio-registry/pull/998", "timeline": [{"oid": "0a6de255e7afda8e6192a3002dbd8f8e46816967", "url": "https://github.com/Apicurio/apicurio-registry/commit/0a6de255e7afda8e6192a3002dbd8f8e46816967", "message": "Allow client headers modification on a per request basis", "committedDate": "2020-11-17T10:21:16Z", "type": "commit"}, {"oid": "f0eccca7013a4b221780b7820bc42a6725f82030", "url": "https://github.com/Apicurio/apicurio-registry/commit/f0eccca7013a4b221780b7820bc42a6725f82030", "message": "Use thread local for customize request headers", "committedDate": "2020-11-17T10:21:16Z", "type": "commit"}, {"oid": "2243a4e282598175af4891c3ca8b2cbef4ce211d", "url": "https://github.com/Apicurio/apicurio-registry/commit/2243a4e282598175af4891c3ca8b2cbef4ce211d", "message": "Remove unnecessary dependency", "committedDate": "2020-11-17T10:21:16Z", "type": "commit"}, {"oid": "6f10df25b3d89ce4b9762d2f2e320365907425e4", "url": "https://github.com/Apicurio/apicurio-registry/commit/6f10df25b3d89ce4b9762d2f2e320365907425e4", "message": "Clear headers before actually making the request", "committedDate": "2020-11-17T10:21:16Z", "type": "commit"}, {"oid": "281483e3862945d6cfab1eec10fe548afd97c097", "url": "https://github.com/Apicurio/apicurio-registry/commit/281483e3862945d6cfab1eec10fe548afd97c097", "message": "Add client concurrent calls test", "committedDate": "2020-11-17T10:21:17Z", "type": "commit"}, {"oid": "bd3be8c7a845926684317d5f7cea97f938586e34", "url": "https://github.com/Apicurio/apicurio-registry/commit/bd3be8c7a845926684317d5f7cea97f938586e34", "message": "Add non concurrent client test", "committedDate": "2020-11-17T10:21:17Z", "type": "commit"}, {"oid": "bd3be8c7a845926684317d5f7cea97f938586e34", "url": "https://github.com/Apicurio/apicurio-registry/commit/bd3be8c7a845926684317d5f7cea97f938586e34", "message": "Add non concurrent client test", "committedDate": "2020-11-17T10:21:17Z", "type": "forcePushed"}, {"oid": "30490a92a046cb62765acd9059cb67beb65786d7", "url": "https://github.com/Apicurio/apicurio-registry/commit/30490a92a046cb62765acd9059cb67beb65786d7", "message": "Update JsonSerdeTest.java", "committedDate": "2020-11-17T13:50:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r525171001", "bodyText": "I didn't expect to see this based on our design session on this feature.  I expected setNextRequestHeaders but not getHeaders.  I may be forgetting something... what is the use-case for this?  My recollection is that getHeaders was my (rejected) suggestion for allowing per-request headers.  But I thought we were all in favor of Fabian's idea.", "author": "EricWittmann", "createdAt": "2020-11-17T13:53:45Z", "path": "rest-client/src/main/java/io/apicurio/registry/client/RegistryRestClient.java", "diffHunk": "@@ -145,4 +146,7 @@\n \n     VersionSearchResults searchVersions(String artifactId, Integer offset, Integer limit);\n \n+    void setNextRequestHeaders(Map<String, String> headers);\n+\n+    Map<String, String> getHeaders();", "originalCommit": "30490a92a046cb62765acd9059cb67beb65786d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4Mzg4Ng==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r525183886", "bodyText": "This is Fabian's suggestion with that minor addition of the getHeaders method. The use case I see is to compare the existing headers with the map provided by the user. I just thought that it could be a good addition. I can remove it if you don't agree.", "author": "carlesarnal", "createdAt": "2020-11-17T14:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUwNjAwMQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r525506001", "bodyText": "Who would be doing that comparison?  At what point in the flow/usage of the client?", "author": "EricWittmann", "createdAt": "2020-11-17T20:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg4NDM4MA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r525884380", "bodyText": "If you're reusing threads maybe you want to check the already existing headers before setting new ones. As I said, just thought it could be a good addition, I don't have a strong opinion about this.", "author": "carlesarnal", "createdAt": "2020-11-18T08:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE5MTczNw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r527191737", "bodyText": "@Apicurio/developers Any thoughts on this?", "author": "EricWittmann", "createdAt": "2020-11-19T20:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE5MjMzOA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r527192338", "bodyText": "Now that I understand the purpose, I also don't have a strong opinion on it.  :)", "author": "EricWittmann", "createdAt": "2020-11-19T20:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxNjUzMw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r527616533", "bodyText": "in response to \"If you're reusing threads \" , if I'm not mistaken, the headers are wiped out after every request, so even re-using threads , always, after a request getHeaders will return an empty map, no?\nI thought you added the getHeaders for testing purposes, which I can partly understand ( there are other workarounds for testing the headers)", "author": "famartinrh", "createdAt": "2020-11-20T11:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxOTg5NQ==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r527619895", "bodyText": "anyway, I'm ok with this :)", "author": "famartinrh", "createdAt": "2020-11-20T11:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyMzExOA==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r527623118", "bodyText": "I realized that yesterday after the discussion with Eric. Yes, you're right, even if re-using threads, the headers are wiped out after every request. That leads us to the only use case of the test purpose.", "author": "carlesarnal", "createdAt": "2020-11-20T11:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMTQ0Mg==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r527631442", "bodyText": "for now, we could add some documentation warning that getHeaders method is intended to only be used for testing, and we can work later on removing that method and implement a different testing approach, if we want to do that", "author": "famartinrh", "createdAt": "2020-11-20T11:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MTAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MjEyNw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r525172127", "bodyText": "Is this guaranteed to get called even if the request fails?", "author": "EricWittmann", "createdAt": "2020-11-17T13:55:14Z", "path": "rest-client/src/main/java/io/apicurio/registry/client/request/RequestExecutor.java", "diffHunk": "@@ -18,15 +18,26 @@\n \n import retrofit2.Call;\n \n+import java.util.Map;\n+\n+\n /**\n  * @author Carles Arnal <carles.arnal@redhat.com>\n  */\n public class RequestExecutor {\n \n+    private final ThreadLocal<Map<String, String>> requestHeaders;\n+\n+    public RequestExecutor(ThreadLocal<Map<String, String>> requestHeaders) {\n+        this.requestHeaders = requestHeaders;\n+    }\n+\n     public <T> T execute(Call<T> call) {\n \n         final ResultCallback<T> resultCallback = new ResultCallback<T>();\n \n+        requestHeaders.remove();", "originalCommit": "30490a92a046cb62765acd9059cb67beb65786d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3NzEyMw==", "url": "https://github.com/Apicurio/apicurio-registry/pull/998#discussion_r525177123", "bodyText": "Actually, the request has not been executed at this point. I think that's even better.", "author": "carlesarnal", "createdAt": "2020-11-17T14:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MjEyNw=="}], "type": "inlineReview"}]}