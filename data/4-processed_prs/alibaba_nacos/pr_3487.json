{"pr_number": 3487, "pr_title": "[ISSUE #3486] Fix com.alibaba.nacos.core.code.ControllerMethodsCache will mismatch sometimes", "pr_createdAt": "2020-07-31T06:19:13Z", "pr_url": "https://github.com/alibaba/nacos/pull/3487", "timeline": [{"oid": "f39d39684ea9a7faa4e15cc174a355ee6f6f8c47", "url": "https://github.com/alibaba/nacos/commit/f39d39684ea9a7faa4e15cc174a355ee6f6f8c47", "message": "fix #3486", "committedDate": "2020-07-31T06:15:21Z", "type": "commit"}, {"oid": "9b983b96d640d0979765dd2b31e1bd83d71aaed1", "url": "https://github.com/alibaba/nacos/commit/9b983b96d640d0979765dd2b31e1bd83d71aaed1", "message": "modify code suit checkstyle", "committedDate": "2020-07-31T07:12:11Z", "type": "commit"}, {"oid": "29a12c21f460ce9135c83db448e4cd9f37381d0c", "url": "https://github.com/alibaba/nacos/commit/29a12c21f460ce9135c83db448e4cd9f37381d0c", "message": "add apache licenses", "committedDate": "2020-07-31T09:52:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0ODk4NQ==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r463548985", "bodyText": "1.3.1 has released, so the since should be upper 1.3.1", "author": "KomachiSion", "createdAt": "2020-07-31T11:07:39Z", "path": "core/src/main/java/com/alibaba/nacos/core/auth/RequestMappingInfo.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.core.auth;\n+\n+import com.alibaba.nacos.core.auth.condition.ParamRequestCondition;\n+import com.alibaba.nacos.core.auth.condition.PathRequestCondition;\n+import java.util.Comparator;\n+\n+/**\n+ * Request mapping information. to find the matched method by request\n+ *\n+ * @author horizonzy\n+ * @since 1.3.1", "originalCommit": "29a12c21f460ce9135c83db448e4cd9f37381d0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYwMzc3Mg==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r463603772", "bodyText": "ok.it's temp define to 1.3.2", "author": "horizonzy", "createdAt": "2020-07-31T13:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0ODk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0OTA3Mw==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r463549073", "bodyText": "same problem as above", "author": "KomachiSion", "createdAt": "2020-07-31T11:07:55Z", "path": "core/src/main/java/com/alibaba/nacos/core/auth/condition/ParamRequestCondition.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.core.auth.condition;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+import javax.servlet.http.HttpServletRequest;\n+import org.springframework.util.ObjectUtils;\n+\n+/**\n+ * request param info. {@link org.springframework.web.bind.annotation.RequestMapping#params()}\n+ *\n+ * @author horizonzy\n+ * @since 1.3.1", "originalCommit": "29a12c21f460ce9135c83db448e4cd9f37381d0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU0OTE0OQ==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r463549149", "bodyText": "same problem as above", "author": "KomachiSion", "createdAt": "2020-07-31T11:08:10Z", "path": "core/src/main/java/com/alibaba/nacos/core/auth/condition/PathRequestCondition.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.core.auth.condition;\n+\n+/**\n+ * request path info. method:{@link org.springframework.web.bind.annotation.RequestMapping#method()}\n+ * path: {@link org.springframework.web.bind.annotation.RequestMapping#value()} or {@link\n+ * org.springframework.web.bind.annotation.RequestMapping#value()}\n+ *\n+ * @author horizonzy\n+ * @since 1.3.1", "originalCommit": "29a12c21f460ce9135c83db448e4cd9f37381d0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "168471fb9f2a78b272629134655ab4bb4be858b1", "url": "https://github.com/alibaba/nacos/commit/168471fb9f2a78b272629134655ab4bb4be858b1", "message": "change the publish version of new class", "committedDate": "2020-07-31T13:12:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzMjU1Nw==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r463632557", "bodyText": "The symbol \"-->\" appears multiple times and is recommended as a static fixed variable.", "author": "Maijh97", "createdAt": "2020-07-31T14:07:22Z", "path": "core/src/main/java/com/alibaba/nacos/core/code/ControllerMethodsCache.java", "diffHunk": "@@ -116,34 +173,52 @@ private void parseSubAnnotations(Method method, String classPath) {\n         final PatchMapping patchMapping = method.getAnnotation(PatchMapping.class);\n         \n         if (getMapping != null) {\n-            put(RequestMethod.GET, classPath, getMapping.value(), method);\n+            put(RequestMethod.GET, classPath, getMapping.value(), getMapping.params(), method);\n         }\n         \n         if (postMapping != null) {\n-            put(RequestMethod.POST, classPath, postMapping.value(), method);\n+            put(RequestMethod.POST, classPath, postMapping.value(), postMapping.params(), method);\n         }\n         \n         if (putMapping != null) {\n-            put(RequestMethod.PUT, classPath, putMapping.value(), method);\n+            put(RequestMethod.PUT, classPath, putMapping.value(), putMapping.params(), method);\n         }\n         \n         if (deleteMapping != null) {\n-            put(RequestMethod.DELETE, classPath, deleteMapping.value(), method);\n+            put(RequestMethod.DELETE, classPath, deleteMapping.value(), deleteMapping.params(),\n+                    method);\n         }\n         \n         if (patchMapping != null) {\n-            put(RequestMethod.PATCH, classPath, patchMapping.value(), method);\n+            put(RequestMethod.PATCH, classPath, patchMapping.value(), patchMapping.params(),\n+                    method);\n         }\n         \n     }\n-    \n-    private void put(RequestMethod requestMethod, String classPath, String[] requestPaths, Method method) {\n+\n+    private void put(RequestMethod requestMethod, String classPath, String[] requestPaths,\n+            String[] requestParams, Method method) {\n         if (ArrayUtils.isEmpty(requestPaths)) {\n-            methods.put(requestMethod.name() + \"-->\" + classPath, method);\n+            String urlKey = requestMethod.name() + \"-->\" + classPath;\n+            addUrlAndMethodRelation(urlKey, requestParams, method);\n             return;\n         }\n         for (String requestPath : requestPaths) {\n-            methods.put(requestMethod.name() + \"-->\" + classPath + requestPath, method);\n+            String urlKey = requestMethod.name() + \"-->\" + classPath + requestPath;", "originalCommit": "168471fb9f2a78b272629134655ab4bb4be858b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0NTUwMQ==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r463645501", "bodyText": "it looks better", "author": "horizonzy", "createdAt": "2020-07-31T14:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzMjU1Nw=="}], "type": "inlineReview"}, {"oid": "1722f76a5465b8d687a15d34ce675944e6c966f9", "url": "https://github.com/alibaba/nacos/commit/1722f76a5465b8d687a15d34ce675944e6c966f9", "message": "set the char \"-->\" in interface", "committedDate": "2020-07-31T14:54:39Z", "type": "commit"}, {"oid": "45b904180763d749d82b3f0dc1f901fd488e0c08", "url": "https://github.com/alibaba/nacos/commit/45b904180763d749d82b3f0dc1f901fd488e0c08", "message": "set the char \"-->\" in interface", "committedDate": "2020-07-31T14:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE0OTA1OA==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r464149058", "bodyText": "One blank line between two parameters.", "author": "KomachiSion", "createdAt": "2020-08-03T01:09:57Z", "path": "core/src/main/java/com/alibaba/nacos/core/utils/Constants.java", "diffHunk": "@@ -61,4 +61,5 @@\n     String COMMA_DIVISION = \",\";\n     \n     String NACOS_SERVER_HEADER = \"Nacos-Server\";\n+    String REQUEST_PATH_SEPARATOR = \"-->\";", "originalCommit": "45b904180763d749d82b3f0dc1f901fd488e0c08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE1Mjk3Mg==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r464152972", "bodyText": "One blank line between two parameters.\n\n\nIf possible, can you please add some unit tests\n\nsure", "author": "horizonzy", "createdAt": "2020-08-03T01:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE0OTA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE0OTM5Mg==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r464149392", "bodyText": "do not print stack trace.\nPlease print by logger.", "author": "KomachiSion", "createdAt": "2020-08-03T01:12:10Z", "path": "core/src/main/java/com/alibaba/nacos/core/code/ControllerMethodsCache.java", "diffHunk": "@@ -44,18 +55,65 @@\n     \n     @Value(\"${server.servlet.contextPath:/nacos}\")\n     private String contextPath;\n-    \n-    private ConcurrentMap<String, Method> methods = new ConcurrentHashMap<>();\n-    \n-    public ConcurrentMap<String, Method> getMethods() {\n-        return methods;\n+\n+    private ConcurrentMap<RequestMappingInfo, Method> methods = new ConcurrentHashMap<>();\n+\n+    private final ConcurrentMap<String, List<RequestMappingInfo>> urlLookup = new ConcurrentHashMap<>();\n+\n+    public Method getMethod(HttpServletRequest request) {\n+        String path = getPath(request);\n+        if (path == null) {\n+            return null;\n+        }\n+        String httpMethod = request.getMethod();\n+        String urlKey = httpMethod + REQUEST_PATH_SEPARATOR + path.replace(contextPath, \"\");\n+        List<RequestMappingInfo> requestMappingInfos = urlLookup.get(urlKey);\n+        if (CollectionUtils.isEmpty(requestMappingInfos)) {\n+            return null;\n+        }\n+        List<RequestMappingInfo> matchedInfo = findMatchedInfo(requestMappingInfos, request);\n+        if (CollectionUtils.isEmpty(matchedInfo)) {\n+            return null;\n+        }\n+        RequestMappingInfo bestMatch = matchedInfo.get(0);\n+        if (matchedInfo.size() > 1) {\n+            RequestMappingInfoComparator comparator = new RequestMappingInfoComparator();\n+            matchedInfo.sort(comparator);\n+            bestMatch = matchedInfo.get(0);\n+            RequestMappingInfo secondBestMatch = matchedInfo.get(1);\n+            if (comparator.compare(bestMatch, secondBestMatch) == 0) {\n+                throw new IllegalStateException(\n+                        \"Ambiguous methods mapped for '\" + request.getRequestURI() + \"': {\"\n+                                + bestMatch + \", \" + secondBestMatch\n+                                + \"}\");\n+            }\n+        }\n+        return methods.get(bestMatch);\n     }\n-    \n-    public Method getMethod(String httpMethod, String path) {\n-        String key = httpMethod + \"-->\" + path.replace(contextPath, \"\");\n-        return methods.get(key);\n+\n+    private String getPath(HttpServletRequest request) {\n+        String path = null;\n+        try {\n+            path = new URI(request.getRequestURI()).getPath();\n+        } catch (URISyntaxException e) {\n+            e.printStackTrace();", "originalCommit": "45b904180763d749d82b3f0dc1f901fd488e0c08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "11b742058eb71f29c5c79945e69135cc0c6d9066", "url": "https://github.com/alibaba/nacos/commit/11b742058eb71f29c5c79945e69135cc0c6d9066", "message": "code format", "committedDate": "2020-08-03T01:37:21Z", "type": "commit"}, {"oid": "17919a719942b1c791769f480a012d5d6eaae864", "url": "https://github.com/alibaba/nacos/commit/17919a719942b1c791769f480a012d5d6eaae864", "message": "add unit case of com.alibaba.nacos.core.code.ControllerMethodsCache.getMethod", "committedDate": "2020-08-03T09:30:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQyNjA0OQ==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r465426049", "bodyText": "Sorry, do not change any indent from original\nPlease use nacos code style to reformat code .\ndetail see src/style/codeStyle.md", "author": "KomachiSion", "createdAt": "2020-08-05T01:54:00Z", "path": "core/src/main/java/com/alibaba/nacos/core/code/ControllerMethodsCache.java", "diffHunk": "@@ -101,49 +163,77 @@ public void initClassMethod(Class<?> clazz) {\n                     requestMethods[0] = RequestMethod.GET;\n                 }\n                 for (String methodPath : requestMapping.value()) {\n-                    methods.put(requestMethods[0].name() + \"-->\" + classPath + methodPath, method);\n+                    String urlKey = requestMethods[0].name() + REQUEST_PATH_SEPARATOR + classPath\n+                            + methodPath;\n+                    addUrlAndMethodRelation(urlKey, requestMapping.params(), method);\n                 }\n             }\n         }\n     }\n-    \n+\n     private void parseSubAnnotations(Method method, String classPath) {\n-        \n+\n         final GetMapping getMapping = method.getAnnotation(GetMapping.class);\n         final PostMapping postMapping = method.getAnnotation(PostMapping.class);\n         final PutMapping putMapping = method.getAnnotation(PutMapping.class);\n         final DeleteMapping deleteMapping = method.getAnnotation(DeleteMapping.class);\n         final PatchMapping patchMapping = method.getAnnotation(PatchMapping.class);\n-        \n+", "originalCommit": "17919a719942b1c791769f480a012d5d6eaae864", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYxMDA2Mg==", "url": "https://github.com/alibaba/nacos/pull/3487#discussion_r465610062", "bodyText": "ye.I set the nacos-code-style then format", "author": "horizonzy", "createdAt": "2020-08-05T09:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQyNjA0OQ=="}], "type": "inlineReview"}, {"oid": "c65f6056a8ae16dbfa530f51e9e7f0e9627f64e3", "url": "https://github.com/alibaba/nacos/commit/c65f6056a8ae16dbfa530f51e9e7f0e9627f64e3", "message": "code format follow nacos-code-style", "committedDate": "2020-08-05T09:56:21Z", "type": "commit"}, {"oid": "4ec93dc5ec0dd5876929cf92cf1e7bfcac598118", "url": "https://github.com/alibaba/nacos/commit/4ec93dc5ec0dd5876929cf92cf1e7bfcac598118", "message": "code format follow nacos-code-style", "committedDate": "2020-08-05T09:57:43Z", "type": "commit"}]}