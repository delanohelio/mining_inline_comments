{"pr_number": 3773, "pr_title": "IPv6 support", "pr_createdAt": "2020-09-07T07:40:18Z", "pr_url": "https://github.com/alibaba/nacos/pull/3773", "timeline": [{"oid": "938b8f404792dcf3b12e801d5254c05f12f996e5", "url": "https://github.com/alibaba/nacos/commit/938b8f404792dcf3b12e801d5254c05f12f996e5", "message": "IPv6 support", "committedDate": "2020-09-07T07:13:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI0NDU4Mw==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484244583", "bodyText": "It is best Util class not to depend on Util class.\nI see AddressServerParamCheckUtil only one method, I think it can be merged into IpUtil.", "author": "KomachiSion", "createdAt": "2020-09-07T07:46:50Z", "path": "address/src/main/java/com/alibaba/nacos/address/util/AddressServerParamCheckUtil.java", "diffHunk": "@@ -16,8 +16,7 @@\n \n package com.alibaba.nacos.address.util;\n \n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n+import com.alibaba.nacos.common.utils.IpUtil;", "originalCommit": "938b8f404792dcf3b12e801d5254c05f12f996e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1MzE2NQ==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484253165", "bodyText": "Remove unused codes", "author": "KomachiSion", "createdAt": "2020-09-07T07:55:37Z", "path": "common/src/main/java/com/alibaba/nacos/common/utils/IpUtil.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.utils;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * ip tool.\n+ *\n+ * @author Nacos\n+ */\n+public class IpUtil {\n+    \n+    public static final boolean PREFER_IPV6_ADDRESSES = Boolean.parseBoolean(System.getProperty(\"java.net.preferIPv6Addresses\"));\n+    \n+    public static final String IPV6_START_MARK = \"[\";\n+    \n+    public static final String IPV6_END_MARK = \"]\";\n+    \n+    public static final int SPLIT_IP_PORT_RESULT_LENGTH = 2;\n+    \n+    private static final String LOCAL_HOST_IP_V4 = \"127.0.0.1\";\n+    \n+    private static final String LOCAL_HOST_IP_V6 = \"[::1]\";\n+    \n+    private static Pattern ipv4Pattern = Pattern.compile(\"\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\");\n+    \n+    /**\n+     * get localhost ip.\n+     * @return java.lang.String\n+     */\n+    public static String localHostIp() {\n+        if (PREFER_IPV6_ADDRESSES) {\n+            return LOCAL_HOST_IP_V6;\n+        }\n+        return LOCAL_HOST_IP_V4;\n+    }\n+    \n+    /**\n+     * check whether the ip address is IPv4.\n+     *\n+     * @param addr ip address\n+     * @return boolean\n+     */\n+    public static boolean isIpv4(String addr) {\n+        try {\n+            return InetAddress.getByName(addr).getAddress().length == 4;\n+        } catch (UnknownHostException e) {\n+            return false;\n+        }\n+    }\n+    \n+    /**\n+     * check whether the ip address is IPv6.\n+     *\n+     * @param addr ip address\n+     * @return boolean\n+     */\n+    public static boolean isIpv6(String addr) {\n+        try {\n+            return InetAddress.getByName(addr).getAddress().length == 16;\n+        } catch (UnknownHostException e) {\n+            return false;\n+        }\n+    }\n+    \n+    /**\n+     * check whether the str is ip address (IPv4 or IPv6).\n+     *\n+     * @param addr ip address str\n+     * @return boolean\n+     */\n+    public static boolean isIp(String addr) {\n+        try {\n+            InetAddress.getByName(addr);\n+            return true;\n+        } catch (UnknownHostException e) {\n+            return false;\n+        }\n+    }\n+    \n+    /**\n+     * Check if the address contains a port.\n+     * 2020/9/3 14:53\n+     * @param address address string\n+     * @return boolean\n+     */\n+    public static boolean containsPort(String address) {\n+        return splitIpPortStr(address).length == 2;\n+    }\n+    \n+    /**\n+     * Split IP and port strings, support IPv4 and IPv6, IP in IPv6 must be enclosed with [].\n+     *\n+     * @param str ip and port string\n+     * @return java.lang.String[]\n+     */\n+    public static String[] splitIpPortStr(String str) {\n+        if (StringUtils.isBlank(str)) {\n+            throw new IllegalArgumentException(\"ip and port string cannot be empty!\");\n+        }\n+        String[] serverAddrArr;\n+        if (str.startsWith(IPV6_START_MARK) && StringUtils.containsIgnoreCase(str, IPV6_END_MARK)) {\n+            if (str.endsWith(IPV6_END_MARK)) {\n+                serverAddrArr = new String[1];\n+                serverAddrArr[0] = str;\n+            } else {\n+                serverAddrArr = new String[2];\n+                serverAddrArr[0] = str.substring(0, (str.indexOf(IPV6_END_MARK) + 1));\n+                serverAddrArr[1] = str.substring((str.indexOf(IPV6_END_MARK) + 2));\n+            }\n+            if (!isIpv6(serverAddrArr[0])) {\n+                throw new IllegalArgumentException(\"The IPv6 address(\\\"\" + serverAddrArr[0] + \"\\\") is incorrect.\");\n+            }\n+        } else {\n+            serverAddrArr = str.split(\":\");\n+            if (serverAddrArr.length > SPLIT_IP_PORT_RESULT_LENGTH) {\n+                throw new IllegalArgumentException(\"The IP address(\\\"\" + str\n+                        + \"\\\") is incorrect. If it is an IPv6 address, please use [] to enclose the IP part!\");\n+            }\n+            if (!isIpv4(serverAddrArr[0])) {\n+                throw new IllegalArgumentException(\"The IPv4 address(\\\"\" + serverAddrArr[0] + \"\\\") is incorrect.\");\n+            }\n+        }\n+        return serverAddrArr;\n+    }\n+    \n+    /**\n+     * Resolve the IP from the string containing the IP address.\n+     * @param str string containing IP address\n+     * @return java.lang.String\n+     */\n+    public static String getIpFromString(String str) {\n+        if (StringUtils.isBlank(str)) {\n+            return \"\";\n+        }\n+        String result = \"\";\n+        if (StringUtils.containsIgnoreCase(str, IPV6_START_MARK) && StringUtils.containsIgnoreCase(str, IPV6_END_MARK)) {\n+            result = str.substring(str.indexOf(IPV6_START_MARK), (str.indexOf(IPV6_END_MARK) + 1));\n+            if (!isIpv6(result)) {\n+                result = \"\";\n+                //throw new IllegalArgumentException(\"The IPv6 address(\\\"\" + result + \"\\\") is incorrect.\");", "originalCommit": "938b8f404792dcf3b12e801d5254c05f12f996e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2Mjk2Mg==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484262962", "bodyText": "Is the same behavior when provider without port like 11.11.11.11 ?", "author": "KomachiSion", "createdAt": "2020-09-07T08:09:18Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/Instance.java", "diffHunk": "@@ -117,19 +115,18 @@ public static Instance fromString(String config) {\n         }\n         \n         String provider = ipAddressAttributes[0];\n-        Matcher matcher = IP_PATTERN.matcher(provider);\n-        if (!matcher.matches()) {\n+        String[] providerAddr = IpUtil.splitIpPortStr(provider);\n+        if (providerAddr.length != IpUtil.SPLIT_IP_PORT_RESULT_LENGTH) {\n+            // not ip:port string", "originalCommit": "938b8f404792dcf3b12e801d5254c05f12f996e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2NDc1MA==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484264750", "bodyText": "Can 2 replaced with SPLIT_IP_PORT_RESULT_LENGTH", "author": "KomachiSion", "createdAt": "2020-09-07T08:12:41Z", "path": "common/src/main/java/com/alibaba/nacos/common/utils/IpUtil.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.utils;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * ip tool.\n+ *\n+ * @author Nacos\n+ */\n+public class IpUtil {\n+    \n+    public static final boolean PREFER_IPV6_ADDRESSES = Boolean.parseBoolean(System.getProperty(\"java.net.preferIPv6Addresses\"));\n+    \n+    public static final String IPV6_START_MARK = \"[\";\n+    \n+    public static final String IPV6_END_MARK = \"]\";\n+    \n+    public static final int SPLIT_IP_PORT_RESULT_LENGTH = 2;\n+    \n+    private static final String LOCAL_HOST_IP_V4 = \"127.0.0.1\";\n+    \n+    private static final String LOCAL_HOST_IP_V6 = \"[::1]\";\n+    \n+    private static Pattern ipv4Pattern = Pattern.compile(\"\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\");\n+    \n+    /**\n+     * get localhost ip.\n+     * @return java.lang.String\n+     */\n+    public static String localHostIp() {\n+        if (PREFER_IPV6_ADDRESSES) {\n+            return LOCAL_HOST_IP_V6;\n+        }\n+        return LOCAL_HOST_IP_V4;\n+    }\n+    \n+    /**\n+     * check whether the ip address is IPv4.\n+     *\n+     * @param addr ip address\n+     * @return boolean\n+     */\n+    public static boolean isIpv4(String addr) {\n+        try {\n+            return InetAddress.getByName(addr).getAddress().length == 4;\n+        } catch (UnknownHostException e) {\n+            return false;\n+        }\n+    }\n+    \n+    /**\n+     * check whether the ip address is IPv6.\n+     *\n+     * @param addr ip address\n+     * @return boolean\n+     */\n+    public static boolean isIpv6(String addr) {\n+        try {\n+            return InetAddress.getByName(addr).getAddress().length == 16;\n+        } catch (UnknownHostException e) {\n+            return false;\n+        }\n+    }\n+    \n+    /**\n+     * check whether the str is ip address (IPv4 or IPv6).\n+     *\n+     * @param addr ip address str\n+     * @return boolean\n+     */\n+    public static boolean isIp(String addr) {\n+        try {\n+            InetAddress.getByName(addr);\n+            return true;\n+        } catch (UnknownHostException e) {\n+            return false;\n+        }\n+    }\n+    \n+    /**\n+     * Check if the address contains a port.\n+     * 2020/9/3 14:53\n+     * @param address address string\n+     * @return boolean\n+     */\n+    public static boolean containsPort(String address) {\n+        return splitIpPortStr(address).length == 2;", "originalCommit": "938b8f404792dcf3b12e801d5254c05f12f996e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2NTAzNw==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484265037", "bodyText": "replaced with IpUtil.containPort?", "author": "KomachiSion", "createdAt": "2020-09-07T08:13:10Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -796,7 +797,8 @@ public int getPagedService(String namespaceId, int startPage, int pageSize, Stri\n                 contained = false;\n                 List<Instance> instances = service.allIPs();\n                 for (Instance instance : instances) {\n-                    if (containedInstance.contains(\":\")) {\n+                    String[] containedInstanceIpPort = IpUtil.splitIpPortStr(containedInstance);\n+                    if (containedInstanceIpPort.length == IpUtil.SPLIT_IP_PORT_RESULT_LENGTH) {", "originalCommit": "938b8f404792dcf3b12e801d5254c05f12f996e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dd7aeb6cf52d25b87f6bf11cc7209a8f53ab3707", "url": "https://github.com/alibaba/nacos/commit/dd7aeb6cf52d25b87f6bf11cc7209a8f53ab3707", "message": "AddressServerParamCheckUtil \u5408\u5e76\u5230 IpUtil \u53ca\u4e00\u4e9b\u4fee\u6539", "committedDate": "2020-09-07T08:51:16Z", "type": "commit"}, {"oid": "b4f234d4ebf0d291fc703928a3222ef298c5cbef", "url": "https://github.com/alibaba/nacos/commit/b4f234d4ebf0d291fc703928a3222ef298c5cbef", "message": "\u89e3\u51b3\u9b54\u6cd5\u503c", "committedDate": "2020-09-07T10:01:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM1NTIxMQ==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484355211", "bodyText": "possible for OutOfIndexException\uff1f", "author": "KomachiSion", "createdAt": "2020-09-07T10:51:38Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/Instance.java", "diffHunk": "@@ -117,19 +115,19 @@ public static Instance fromString(String config) {\n         }\n         \n         String provider = ipAddressAttributes[0];\n-        Matcher matcher = IP_PATTERN.matcher(provider);\n-        if (!matcher.matches()) {\n+        String[] providerAddr;\n+        try {\n+            providerAddr = IpUtil.splitIpPortStr(provider);\n+        } catch (Exception ex) {\n             return null;\n         }\n         \n-        int expectedGroupCount = 2;\n-        \n         int port = 0;\n-        if (NumberUtils.isNumber(matcher.group(expectedGroupCount))) {\n-            port = Integer.parseInt(matcher.group(expectedGroupCount));\n+        if (NumberUtils.isNumber(providerAddr[1])) {", "originalCommit": "b4f234d4ebf0d291fc703928a3222ef298c5cbef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb4e17790e68df192a886349c7ecfc745a6c8ad4", "url": "https://github.com/alibaba/nacos/commit/bb4e17790e68df192a886349c7ecfc745a6c8ad4", "message": "\u4fee\u6539\u9690\u60a3", "committedDate": "2020-09-08T01:04:23Z", "type": "commit"}, {"oid": "601f0b4609747c750b0ef70582aadf46e235c8e4", "url": "https://github.com/alibaba/nacos/commit/601f0b4609747c750b0ef70582aadf46e235c8e4", "message": "\u8c03\u6574\u4f7f\u7528\u4e86\u7c7b\u4f3c ip.indexOf(\":\") \u67e5\u627e\u662f\u5426\u6709\u7aef\u53e3\u7684\u5730\u65b9\u7684\u903b\u8f91, \u4e00\u4e9b \":\" \u66ff\u6362\u4e3a\u5e38\u91cf", "committedDate": "2020-09-08T02:07:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxMjczMg==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484612732", "bodyText": "format test method name to describe what situation the method test", "author": "KomachiSion", "createdAt": "2020-09-08T02:10:20Z", "path": "common/src/test/java/com/alibaba/nacos/common/utils/IpUtilTest.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.utils;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.net.InetAddress;\n+import java.net.NetworkInterface;\n+import java.util.Enumeration;\n+\n+/**\n+ * test IpUtil.\n+ * @ClassName: IpUtilTest\n+ * @date 2020/9/3 10:31\n+ */\n+public class IpUtilTest {\n+    \n+    @Test\n+    public void test111(){", "originalCommit": "601f0b4609747c750b0ef70582aadf46e235c8e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxMjc2Mg==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484612762", "bodyText": "remove unused codes", "author": "KomachiSion", "createdAt": "2020-09-08T02:10:29Z", "path": "common/src/test/java/com/alibaba/nacos/common/utils/IpUtilTest.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.utils;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.net.InetAddress;\n+import java.net.NetworkInterface;\n+import java.util.Enumeration;\n+\n+/**\n+ * test IpUtil.\n+ * @ClassName: IpUtilTest\n+ * @date 2020/9/3 10:31\n+ */\n+public class IpUtilTest {\n+    \n+    @Test\n+    public void test111(){\n+        try {\n+            Enumeration<NetworkInterface> en = NetworkInterface.getNetworkInterfaces();\n+            while (en.hasMoreElements()) {\n+                NetworkInterface ni = en.nextElement();\n+                Enumeration<InetAddress> ads = ni.getInetAddresses();\n+                while (ads.hasMoreElements()) {\n+                    InetAddress ip = ads.nextElement();\n+                    System.out.println(ip.getHostAddress());\n+                    // Compatible group does not regulate 11 network segments\n+                    if (!ip.isLoopbackAddress() && ip.getHostAddress().indexOf(\":\") == -1\n+                        /* && ip.isSiteLocalAddress() */) {", "originalCommit": "601f0b4609747c750b0ef70582aadf46e235c8e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "87ab5f16bec8bd640463dbc19e1b8aabb9dd06fc", "url": "https://github.com/alibaba/nacos/commit/87ab5f16bec8bd640463dbc19e1b8aabb9dd06fc", "message": "\u5220\u9664\u65e0\u7528\u6d4b\u8bd5", "committedDate": "2020-09-08T02:17:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxNTM0NA==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484615344", "bodyText": "IpUtil.checkOK(str) I think is better", "author": "chuntaojun", "createdAt": "2020-09-08T02:22:17Z", "path": "address/src/main/java/com/alibaba/nacos/address/controller/AddressServerClusterController.java", "diffHunk": "@@ -87,8 +87,8 @@ public ResponseEntity postCluster(@RequestParam(required = false) String product\n             clusterObj.setHealthChecker(new AbstractHealthChecker.None());\n             serviceManager.createServiceIfAbsent(Constants.DEFAULT_NAMESPACE_ID, serviceName, false, clusterObj);\n             String[] ipArray = addressServerManager.splitIps(ips);\n-            String checkResult = AddressServerParamCheckUtil.checkIps(ipArray);\n-            if (AddressServerParamCheckUtil.CHECK_OK.equals(checkResult)) {\n+            String checkResult = IpUtil.checkIps(ipArray);\n+            if (IpUtil.CHECK_OK.equals(checkResult)) {", "originalCommit": "87ab5f16bec8bd640463dbc19e1b8aabb9dd06fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxNTkxOA==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484615918", "bodyText": "Ip => IP", "author": "chuntaojun", "createdAt": "2020-09-08T02:24:45Z", "path": "common/src/main/java/com/alibaba/nacos/common/tls/SelfHostnameVerifier.java", "diffHunk": "@@ -38,7 +38,7 @@\n     \n     private static ConcurrentHashMap<String, Boolean> hosts = new ConcurrentHashMap<String, Boolean>();\n     \n-    private static final String[] LOCALHOST_HOSTNAME = new String[] {\"localhost\", \"127.0.0.1\"};\n+    private static final String[] LOCALHOST_HOSTNAME = new String[] {\"localhost\", IpUtil.localHostIp()};", "originalCommit": "87ab5f16bec8bd640463dbc19e1b8aabb9dd06fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxNjA3Nw==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484616077", "bodyText": "IpUtil => IPUtil", "author": "chuntaojun", "createdAt": "2020-09-08T02:25:24Z", "path": "common/src/main/java/com/alibaba/nacos/common/utils/IpUtil.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.utils;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * ip tool.\n+ *\n+ * @author Nacos\n+ */\n+public class IpUtil {", "originalCommit": "87ab5f16bec8bd640463dbc19e1b8aabb9dd06fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYyNjA4Mg==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r484626082", "bodyText": "\u8fd9\u79cd\u5730\u65b9\u73b0\u5728\u662f\u4e0d\u662f\u5e94\u8be5\u7528isIp\u66ff\u6362isIpv4\u4e86\uff1f", "author": "wangweizZZ", "createdAt": "2020-09-08T03:08:54Z", "path": "client/src/main/java/com/alibaba/nacos/client/config/utils/ParamUtils.java", "diffHunk": "@@ -190,7 +190,7 @@ public static void checkBetaIps(String betaIps) throws NacosException {\n         }\n         String[] ipsArr = betaIps.split(\",\");\n         for (String ip : ipsArr) {\n-            if (!IpUtils.isIpv4(ip)) {\n+            if (!IpUtil.isIpv4(ip)) {", "originalCommit": "87ab5f16bec8bd640463dbc19e1b8aabb9dd06fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1858bc0649acc0f83beeb943bf15b7b5d79e2615", "url": "https://github.com/alibaba/nacos/commit/1858bc0649acc0f83beeb943bf15b7b5d79e2615", "message": "IpUtil \u6539\u540d \u4e3a IPUtil, \u6d89\u53caIP\u7684\u76f8\u5173\u65b9\u6cd5\u540d\u4fee\u6539,\u6d89\u53ca\u5230\u7684\u8c03\u7528\u4fee\u6539,\u68c0\u6d4bIP\u7684\u5730\u65b9\u8c03\u7528\u7684isIPv4\u6539\u4e3aisIP. \u4fee\u6539\u6d89\u53caIP\u7684\u5b57\u6bb5\u957f\u5ea6\u53ca\u76f8\u5173\u5347\u7ea7\u66f4\u65b0\u7684sql", "committedDate": "2020-09-08T04:40:00Z", "type": "commit"}, {"oid": "a0a63207c88cdc602201c549ac3a11a87d465232", "url": "https://github.com/alibaba/nacos/commit/a0a63207c88cdc602201c549ac3a11a87d465232", "message": "no message", "committedDate": "2020-09-08T05:14:24Z", "type": "commit"}, {"oid": "dbe893465b1e4f7f8feeace364f1c9a8db646b43", "url": "https://github.com/alibaba/nacos/commit/dbe893465b1e4f7f8feeace364f1c9a8db646b43", "message": "no message", "committedDate": "2020-09-08T05:14:43Z", "type": "commit"}, {"oid": "37620a4123c556b396ee2bf0ab85c2deaa1bb9ed", "url": "https://github.com/alibaba/nacos/commit/37620a4123c556b396ee2bf0ab85c2deaa1bb9ed", "message": "no message", "committedDate": "2020-09-08T05:17:57Z", "type": "commit"}, {"oid": "55c38451a863842507da77ce774628239b084494", "url": "https://github.com/alibaba/nacos/commit/55c38451a863842507da77ce774628239b084494", "message": "no message", "committedDate": "2020-09-08T05:18:40Z", "type": "commit"}, {"oid": "44c7ff8a30f47a525266b4ba9d7ecfc1e3e16ec9", "url": "https://github.com/alibaba/nacos/commit/44c7ff8a30f47a525266b4ba9d7ecfc1e3e16ec9", "message": "\u83b7\u53d6\u672c\u673aIP\u65f6,\u5982\u679c\u672c\u673aIP\u662fIPv6\u5e76\u4e14\u5305\u542b\u7f51\u5361\u4fe1\u606f(V6\u5730\u5740\u4e2d\u6700\u540e\u9762\u7684\u767e\u5206\u53f7\u548c\u767e\u5206\u53f7\u540e\u9762\u7684\u5185\u5bb9)\u5219\u53bb\u9664\u7f51\u5361\u4fe1\u606f", "committedDate": "2020-09-09T06:47:18Z", "type": "commit"}, {"oid": "167d47915aca5f862c81ab26e72c07e108746159", "url": "https://github.com/alibaba/nacos/commit/167d47915aca5f862c81ab26e72c07e108746159", "message": "Merge pull request #1 from alibaba/develop\n\n\u66f4\u65b0\u4ee3\u7801", "committedDate": "2020-09-21T02:15:57Z", "type": "commit"}, {"oid": "7ba31524c6c39e482c703c184845e3400d61120e", "url": "https://github.com/alibaba/nacos/commit/7ba31524c6c39e482c703c184845e3400d61120e", "message": "Merge branch 'develop' into support_ipv6\n\n# Conflicts:\n#\tcore/src/main/java/com/alibaba/nacos/core/cluster/MemberUtils.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftProxy.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/healthcheck/ClientBeatCheckTask.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/misc/NamingProxy.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/misc/NetUtils.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/misc/ServerStatusSynchronizer.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/misc/ServiceStatusSynchronizer.java\n#\tsys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "committedDate": "2020-09-21T03:29:22Z", "type": "commit"}, {"oid": "5fe766ae5826e64806901a643d2fbcffd8bb70cb", "url": "https://github.com/alibaba/nacos/commit/5fe766ae5826e64806901a643d2fbcffd8bb70cb", "message": "Merge pull request #2 from alibaba/develop\n\n\u66f4\u65b0\u4ee3\u7801", "committedDate": "2020-10-12T03:13:06Z", "type": "commit"}, {"oid": "9ef561bc017c3dc8bed802ea2e5ccfccf8b8af4c", "url": "https://github.com/alibaba/nacos/commit/9ef561bc017c3dc8bed802ea2e5ccfccf8b8af4c", "message": "Merge pull request #3 from alibaba/develop\n\n\u66f4\u65b0\u4ee3\u7801", "committedDate": "2020-10-13T07:55:09Z", "type": "commit"}, {"oid": "34b53fc23ec15e4bee45f17ee746c00d301205a8", "url": "https://github.com/alibaba/nacos/commit/34b53fc23ec15e4bee45f17ee746c00d301205a8", "message": "Merge pull request #4 from alibaba/develop\n\n\u66f4\u65b0\u4ee3\u7801", "committedDate": "2020-10-17T06:51:52Z", "type": "commit"}, {"oid": "5a3b893365ccd9440fd887ad3b6b3345fc936264", "url": "https://github.com/alibaba/nacos/commit/5a3b893365ccd9440fd887ad3b6b3345fc936264", "message": "Merge branch 'develop' into support_ipv6\n\n# Conflicts:\n#\tnaming/src/main/java/com/alibaba/nacos/naming/misc/NetUtils.java\n#\tsys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "committedDate": "2020-10-17T07:07:21Z", "type": "commit"}, {"oid": "877ebab31199458bf647e88d8601dbe5cc80e585", "url": "https://github.com/alibaba/nacos/commit/877ebab31199458bf647e88d8601dbe5cc80e585", "message": "\u89e3\u51b3 AvoidComplexConditionRule(\u8bf7\u4e0d\u8981\u5728\u6761\u4ef6\u4e2d\u4f7f\u7528\u590d\u6742\u7684\u8868\u8fbe\u5f0f)", "committedDate": "2020-10-17T07:20:13Z", "type": "commit"}, {"oid": "ce519390ecb26ea03cf0b383568aa72e2cca144f", "url": "https://github.com/alibaba/nacos/commit/ce519390ecb26ea03cf0b383568aa72e2cca144f", "message": "\u79fb\u9664\u65e0\u7528\u4ee3\u7801", "committedDate": "2020-10-19T04:07:21Z", "type": "commit"}, {"oid": "1deee2aa15cc5764bf2430ce67a76f1f19e1517d", "url": "https://github.com/alibaba/nacos/commit/1deee2aa15cc5764bf2430ce67a76f1f19e1517d", "message": "Merge pull request #5 from alibaba/develop\n\n\u62c9\u4ee3\u7801", "committedDate": "2020-10-20T06:35:47Z", "type": "commit"}, {"oid": "6db4d53e4ad51cc133fd5296b5abc29a71dd48ff", "url": "https://github.com/alibaba/nacos/commit/6db4d53e4ad51cc133fd5296b5abc29a71dd48ff", "message": "Merge pull request #6 from alibaba/develop\n\n\u66f4\u65b0\u4ee3\u7801", "committedDate": "2020-10-22T03:49:27Z", "type": "commit"}, {"oid": "a34904b430329d30e296abd34ac889c9d20cb32a", "url": "https://github.com/alibaba/nacos/commit/a34904b430329d30e296abd34ac889c9d20cb32a", "message": "Merge branch 'develop' into support_ipv6\n\n# Conflicts:\n#\tnaming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "committedDate": "2020-10-22T06:32:09Z", "type": "commit"}, {"oid": "29e7546a70ab312f0df0cfc1548de9f1179589f4", "url": "https://github.com/alibaba/nacos/commit/29e7546a70ab312f0df0cfc1548de9f1179589f4", "message": "Merge pull request #7 from alibaba/develop\n\n\u66f4\u65b0\u4ee3\u7801", "committedDate": "2020-10-26T03:35:33Z", "type": "commit"}, {"oid": "e9eae1cb8b021cd5dd839e28df3eb699ea4ed572", "url": "https://github.com/alibaba/nacos/commit/e9eae1cb8b021cd5dd839e28df3eb699ea4ed572", "message": "Merge branch 'develop' into support_ipv6", "committedDate": "2020-10-26T03:39:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxNzgyNw==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r498817827", "bodyText": "\u4e3a\u4ec0\u4e48\u8981\u52a0\u8fd9\u4e2a\u5224\u65ad\uff1f", "author": "chuntaojun", "createdAt": "2020-10-02T13:22:52Z", "path": "core/src/main/java/com/alibaba/nacos/core/utils/WebUtils.java", "diffHunk": "@@ -93,6 +93,11 @@ private static String resolveValue(String value, String encoding) {\n         try {\n             value = HttpUtils.decode(new String(value.getBytes(StandardCharsets.UTF_8), encoding), encoding);\n         } catch (UnsupportedEncodingException ignore) {\n+        } catch (Exception ex) {", "originalCommit": "7ba31524c6c39e482c703c184845e3400d61120e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "url": "https://github.com/alibaba/nacos/commit/99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "message": "\u6dfb\u52a0\u6ce8\u91ca", "committedDate": "2020-11-03T08:17:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2MzE4Nw==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r517063187", "bodyText": "Please do not change the code style.", "author": "Maijh97", "createdAt": "2020-11-04T02:26:26Z", "path": "core/src/main/java/com/alibaba/nacos/core/utils/WebUtils.java", "diffHunk": "@@ -42,7 +42,7 @@\n  * @author nkorange\n  */\n public class WebUtils {\n-    \n+", "originalCommit": "99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2NjI2MQ==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r517066261", "bodyText": "Here \":\" can use IPUtil.IP_PORT_SPLITER.", "author": "Maijh97", "createdAt": "2020-11-04T02:38:39Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -955,7 +956,7 @@ public int getPagedService(String namespaceId, int startPage, int pageSize, Stri\n                 contained = false;\n                 List<Instance> instances = service.allIPs();\n                 for (Instance instance : instances) {\n-                    if (containedInstance.contains(\":\")) {\n+                    if (IPUtil.containsPort(containedInstance)) {\n                         if (StringUtils.equals(instance.getIp() + \":\" + instance.getPort(), containedInstance)) {", "originalCommit": "99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2NjI5Ng==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r517066296", "bodyText": "Here \":\" can use IPUtil.IP_PORT_SPLITER.", "author": "Maijh97", "createdAt": "2020-11-04T02:38:48Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/healthcheck/ClientBeatCheckTask.java", "diffHunk": "@@ -135,7 +136,7 @@ private void deleteIp(Instance instance) {\n                     .appendParam(\"ephemeral\", \"true\").appendParam(\"clusterName\", instance.getClusterName())\n                     .appendParam(\"serviceName\", service.getName()).appendParam(\"namespaceId\", service.getNamespaceId());\n             \n-            String url = \"http://127.0.0.1:\" + ApplicationUtils.getPort() + ApplicationUtils.getContextPath()\n+            String url = \"http://\" + IPUtil.localHostIP() + \":\" + ApplicationUtils.getPort() + ApplicationUtils.getContextPath()", "originalCommit": "99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2NjgzNg==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r517066836", "bodyText": "Please do not change the code style.", "author": "Maijh97", "createdAt": "2020-11-04T02:40:58Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -87,20 +81,20 @@ public void run() {\n                 if (StringUtils.isBlank(nacosIP)) {\n                     nacosIP = ApplicationUtils.getProperty(IP_ADDRESS);\n                 }\n-                \n-                boolean illegalIP = !StringUtils.isBlank(nacosIP) && !(isIP(nacosIP) || isDomain(nacosIP));\n-                if (illegalIP) {\n-                    throw new RuntimeException(\"nacos address \" + nacosIP + \" is not ip\");\n+                if (!StringUtils.isBlank(nacosIP)) {\n+                    if (!(IPUtil.isIP(nacosIP) || isDomain(nacosIP))) {\n+                        throw new RuntimeException(\"nacos address \" + nacosIP + \" is not ip\");\n+                    }\n                 }\n                 String tmpSelfIP = nacosIP;\n                 if (StringUtils.isBlank(tmpSelfIP)) {\n                     preferHostnameOverIP = Boolean.getBoolean(SYSTEM_PREFER_HOSTNAME_OVER_IP);\n-                    \n+    ", "originalCommit": "99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2Njg3NA==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r517066874", "bodyText": "Please do not change the code style.", "author": "Maijh97", "createdAt": "2020-11-04T02:41:09Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -87,20 +81,20 @@ public void run() {\n                 if (StringUtils.isBlank(nacosIP)) {\n                     nacosIP = ApplicationUtils.getProperty(IP_ADDRESS);\n                 }\n-                \n-                boolean illegalIP = !StringUtils.isBlank(nacosIP) && !(isIP(nacosIP) || isDomain(nacosIP));\n-                if (illegalIP) {\n-                    throw new RuntimeException(\"nacos address \" + nacosIP + \" is not ip\");\n+                if (!StringUtils.isBlank(nacosIP)) {\n+                    if (!(IPUtil.isIP(nacosIP) || isDomain(nacosIP))) {\n+                        throw new RuntimeException(\"nacos address \" + nacosIP + \" is not ip\");\n+                    }\n                 }\n                 String tmpSelfIP = nacosIP;\n                 if (StringUtils.isBlank(tmpSelfIP)) {\n                     preferHostnameOverIP = Boolean.getBoolean(SYSTEM_PREFER_HOSTNAME_OVER_IP);\n-                    \n+    \n                     if (!preferHostnameOverIP) {\n                         preferHostnameOverIP = Boolean\n                                 .parseBoolean(ApplicationUtils.getProperty(PREFER_HOSTNAME_OVER_IP));\n                     }\n-                    \n+    ", "originalCommit": "99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2ODU4Mg==", "url": "https://github.com/alibaba/nacos/pull/3773#discussion_r517068582", "bodyText": "IPUtil.PREFER_IPV6_ADDRESSES ? address instanceof Inet6Address : address instanceof Inet4Address\nHere is a separate line, which is more readable.", "author": "Maijh97", "createdAt": "2020-11-04T02:48:31Z", "path": "sys/src/main/java/com/alibaba/nacos/sys/utils/InetUtils.java", "diffHunk": "@@ -159,8 +160,9 @@ public static InetAddress findFirstNonLoopbackAddress() {\n                     if (!ignoreInterface(ifc.getDisplayName())) {\n                         for (Enumeration<InetAddress> addrs = ifc.getInetAddresses(); addrs.hasMoreElements(); ) {\n                             InetAddress address = addrs.nextElement();\n-                            if (address instanceof Inet4Address && !address.isLoopbackAddress() && isPreferredAddress(\n-                                    address)) {\n+                            if ((IPUtil.PREFER_IPV6_ADDRESSES ? address instanceof Inet6Address\n+                                    : address instanceof Inet4Address) && !address.isLoopbackAddress()\n+                                    && isPreferredAddress(address)) {", "originalCommit": "99cbf16b1cfa5eb4f22e3a7836c5d35b1911afc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bceff65d438192f2925374fb602491516a6e7e59", "url": "https://github.com/alibaba/nacos/commit/bceff65d438192f2925374fb602491516a6e7e59", "message": "\u8c03\u6574code style, \u8c03\u6574\u83b7\u53d6\u672c\u673aIP\u7684\u903b\u8f91", "committedDate": "2020-11-04T03:40:52Z", "type": "commit"}]}