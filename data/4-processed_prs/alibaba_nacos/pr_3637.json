{"pr_number": 3637, "pr_title": "[ISSUE #3628] set naming client updateTask interval more flexible", "pr_createdAt": "2020-08-19T05:41:20Z", "pr_url": "https://github.com/alibaba/nacos/pull/3637", "timeline": [{"oid": "787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b", "url": "https://github.com/alibaba/nacos/commit/787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b", "message": "1.use server cacheMillis event service deleted\n2.naming client UpdateTask's interval will inc by failCount that connect with server", "committedDate": "2020-08-19T05:23:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcyNDU5NQ==", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472724595", "bodyText": "fail count should not be attribute of ServiceInfo. It should be maintained in UpdateTask.", "author": "KomachiSion", "createdAt": "2020-08-19T05:44:07Z", "path": "api/src/main/java/com/alibaba/nacos/api/naming/pojo/ServiceInfo.java", "diffHunk": "@@ -48,6 +48,8 @@\n     \n     private long cacheMillis = 1000L;\n     \n+    private long failCount = 0L;", "originalCommit": "787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcyNjI1OQ==", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472726259", "bodyText": "The exception delay time should be calculate in catch\nAnd the algorithm should be enhance. Such as double time then last time. And the max delay time is not more than 60s.", "author": "KomachiSion", "createdAt": "2020-08-19T05:46:36Z", "path": "client/src/main/java/com/alibaba/nacos/client/naming/core/HostReactor.java", "diffHunk": "@@ -411,7 +412,7 @@ public void run() {\n                     return;\n                 }\n                 \n-                delayTime = serviceObj.getCacheMillis();\n+                delayTime = serviceObj.getCacheMillis() + Math.min(serviceObj.getFailCount() * 1000L, 10000L);", "originalCommit": "787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcyNjkyMQ==", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472726921", "bodyText": "If updPort > 0 , it should be pushCacheMillis.\nSee the logic in 541 line.", "author": "KomachiSion", "createdAt": "2020-08-19T05:47:36Z", "path": "naming/src/main/java/com/alibaba/nacos/naming/controllers/InstanceController.java", "diffHunk": "@@ -516,21 +516,21 @@ public ObjectNode doSrvIpxt(String namespaceId, String serviceName, String agent\n         ClientInfo clientInfo = new ClientInfo(agent);\n         ObjectNode result = JacksonUtils.createEmptyJsonNode();\n         Service service = serviceManager.getService(namespaceId, serviceName);\n-        \n+        long cacheMillis = switchDomain.getDefaultCacheMillis();", "originalCommit": "787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f21aceb9c4a60a85d0202c5c1b6464a8054b6a78", "url": "https://github.com/alibaba/nacos/commit/f21aceb9c4a60a85d0202c5c1b6464a8054b6a78", "message": "1.move failCount to updateTask\n2.redefine the updateService method name. updateServiceNow -> updateService, wrap updateService in updateServiceNow when first getServiceInfo", "committedDate": "2020-08-19T06:42:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk4ODk0NA==", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472988944", "bodyText": "The implementation may cause delayTime << failCount become negative number when failCount=54.", "author": "KomachiSion", "createdAt": "2020-08-19T12:25:52Z", "path": "client/src/main/java/com/alibaba/nacos/client/naming/core/HostReactor.java", "diffHunk": "@@ -412,12 +419,14 @@ public void run() {\n                 }\n                 \n                 delayTime = serviceObj.getCacheMillis();\n-                \n+                failCount = 0;\n             } catch (Throwable e) {\n+                failCount++;\n                 NAMING_LOGGER.warn(\"[NA] failed to update serviceName: \" + serviceName, e);\n             } finally {\n                 if (delayTime > 0) {\n-                    executor.schedule(this, delayTime, TimeUnit.MILLISECONDS);\n+                    executor.schedule(this, Math.min(delayTime << failCount, DEFAULT_DELAY * 60),", "originalCommit": "f21aceb9c4a60a85d0202c5c1b6464a8054b6a78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0NTM5Mw==", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r473545393", "bodyText": "now, the failCunt cat't limit 6.", "author": "horizonzy", "createdAt": "2020-08-20T02:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk4ODk0NA=="}], "type": "inlineReview"}, {"oid": "7bc65cc2a65d1505274cdaef83653c2faab082ee", "url": "https://github.com/alibaba/nacos/commit/7bc65cc2a65d1505274cdaef83653c2faab082ee", "message": "1.create push client even service is not exist\n2.serviceInfo's hosts is empty or can't connect to server both add the updateTsk interval", "committedDate": "2020-08-20T02:21:14Z", "type": "commit"}, {"oid": "62a635dfb54d05c417a811721370f17125bc007c", "url": "https://github.com/alibaba/nacos/commit/62a635dfb54d05c417a811721370f17125bc007c", "message": "format the indent", "committedDate": "2020-08-20T06:12:34Z", "type": "commit"}]}