{"pr_number": 650, "pr_title": "Support for Locally Present Subroutines", "pr_createdAt": "2020-11-13T13:52:32Z", "pr_url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NzMyOA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r522987328", "bodyText": "if this if (uri) comes first then no need another if, if (!uri)  can be removed", "author": "asatklichov", "createdAt": "2020-11-13T14:33:32Z", "path": "clients/cobol-lsp-vscode-extension/src/services/util/FSUtils.ts", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *   Broadcom, Inc. - initial API and implementation\n+ */\n+\n+import {URL} from \"url\";\n+import * as path from \"path\";\n+import {readdirSync, existsSync} from \"fs\";\n+import {SettingsUtils} from \"./SettingsUtils\";\n+import * as fs from \"fs\";\n+\n+/**\n+ * This method is responsible to return a valid URI without extension if the extension is not provided or an URI\n+ * that contains an allowed extension.\n+ * @param folder is the first part of the URI referred to the folder defined in the setting.json\n+ * @param entityName is the name of entity identified by the LSP server that needs to be found locally\n+ * @param extensions an optional parameter to produce an URI of an allowed extension list, verifying that\n+ * this URI really exists on FS.\n+ *\n+ */\n+export function getURIFrom(folder: string, entityName: string, extensions?: string[]): URL {\n+    if (!extensions) {\n+        const url = new URL(path.join(folder, entityName));\n+        if (existsSync(url)) {\n+            return url;\n+        }\n+    } else {\n+        const fileList = readdirSync(new URL(folder));\n+        for (const extension of extensions) {\n+            const copybookFileWithExtension = (entityName + extension).toUpperCase();\n+            const found = fileList.find(filename => filename.toUpperCase() === copybookFileWithExtension.toUpperCase())\n+            if (found) {\n+                return new URL(path.join(folder, found));\n+            }\n+        }\n+    }\n+}\n+\n+/**\n+ * This function construct an URI from a valid resource provided from the setting configuration\n+ * @param resource represent the file to search within the workspace folder list\n+ * @return an URI representation of the file or undefined if not found\n+ */\n+export function getURIFromResource(resource: string): URL {\n+    for (const workspaceFolder of SettingsUtils.getWorkspacesURI()) {\n+        const uri: URL = new URL(path.join(workspaceFolder, resource));\n+        if (fs.existsSync(uri)) {\n+            return uri;\n+        }\n+    }\n+}\n+\n+/**\n+ * This method scans the list of folders as given input and find the required entity name within the folder.\n+ * If found returns its URI representation\n+ * @param entityName name of the entity asked by the server\n+ * @param targetFolders list of folders from where to search the copybook\n+ * @param extensions list of extensions\n+ */\n+export function searchInWorkspace(entityName: string, targetFolders: string[], extensions: string[]): string {\n+    if (targetFolders) {\n+        const localFolderList: string[] = targetFolders\n+            .map(getURIFromResource)\n+            .filter((url: URL) => url !== undefined)\n+            .map((url: URL) => url.href);\n+        for (const folder of localFolderList) {\n+            let uri: URL = getURIFrom(folder, entityName);\n+            if (!uri) {\n+                uri = getURIFrom(folder, entityName, extensions);\n+            }\n+            if (uri) {", "originalCommit": "eafebbb92b6641dfe6c4d439809ae9b0cfe0b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNTY3NQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r526835675", "bodyText": "Maybe I didn't get you right. It can be like this:\n            let uri: URL = getURIFrom(folder, entityName);\n            if (uri) {\n                return uri.href;\n            }\n            uri = getURIFrom(folder, entityName, extensions);\n\nBut after all the uri can be undefined and I need to check it again before the return.", "author": "grianbrcom", "createdAt": "2020-11-19T12:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NzMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk5OTY3Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r522999676", "bodyText": "Semantically it would make more sense to pass the subroutine list before the mode because the mode in most cases will be the same.", "author": "temanbrcom", "createdAt": "2020-11-13T14:52:29Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/service/delegates/validations/UseCaseUtils.java", "diffHunk": "@@ -188,7 +182,7 @@ public static void waitForDiagnostics(TestLanguageClient client) {\n    * @return the entire analysis result\n    */\n   public static AnalysisResult analyze(String fileName, String text, List<CobolText> copybooks) {\n-    return analyze(fileName, text, copybooks, CopybookProcessingMode.ENABLED);\n+    return analyze(fileName, text, copybooks, CopybookProcessingMode.ENABLED, List.of());", "originalCommit": "eafebbb92b6641dfe6c4d439809ae9b0cfe0b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg0MTgyNQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r526841825", "bodyText": "Yes, you are right.", "author": "grianbrcom", "createdAt": "2020-11-19T12:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk5OTY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1OTY4Ng==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r523059686", "bodyText": "Please, remove the commented-out code", "author": "temanbrcom", "createdAt": "2020-11-13T16:25:12Z", "path": "clients/cobol-lsp-vscode-extension/src/__tests__/extensionTest.spec.ts", "diffHunk": "@@ -90,6 +90,7 @@ const middleware: Middleware = new Middleware(new CopybookURI(profileService), c\n const languageClientService: LanguageClientService = new LanguageClientService(middleware);\n languageClientService.checkPrerequisites = jest.fn(() => Promise.resolve());\n languageClientService.start = jest.fn().mockResolvedValue(true);\n+//languageClientService.addRequestHandler = jest.fn();", "originalCommit": "eafebbb92b6641dfe6c4d439809ae9b0cfe0b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzMDA2Mw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r526830063", "bodyText": "done", "author": "grianbrcom", "createdAt": "2020-11-19T12:18:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1OTY4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3NTM5MA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r523075390", "bodyText": "I see you miss a test for it. Not a big deal though, but we miss coverage here.", "author": "temanbrcom", "createdAt": "2020-11-13T16:49:57Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/delegates/references/SubroutineLocations.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ *\n+ */\n+package com.broadcom.lsp.cobol.service.delegates.references;\n+\n+import com.broadcom.lsp.cobol.service.CobolDocumentModel;\n+import lombok.NonNull;\n+import org.eclipse.lsp4j.Location;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+/** This class is a provider for locations of subroutine defined/used in the document */\n+public class SubroutineLocations implements SemanticLocations {", "originalCommit": "eafebbb92b6641dfe6c4d439809ae9b0cfe0b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjU2OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r526836569", "bodyText": "Done", "author": "grianbrcom", "createdAt": "2020-11-19T12:29:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3NTM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA1MTAwOQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r524051009", "bodyText": "Subroutine errors are expected to point only to the name, so it would be enough to pass only one Locality and do not apply the interval calculation", "author": "temanbrcom", "createdAt": "2020-11-16T09:54:55Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/core/visitor/CobolVisitor.java", "diffHunk": "@@ -594,6 +622,17 @@ private void reportVariableNotDefined(String dataName, Locality start, Locality\n     errors.add(error);\n   }\n \n+  private void reportSubroutineNotDefined(String name, Locality start, Locality stop) {", "originalCommit": "eafebbb92b6641dfe6c4d439809ae9b0cfe0b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjE2OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r526836169", "bodyText": "Good point. Fixed.", "author": "grianbrcom", "createdAt": "2020-11-19T12:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA1MTAwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEzNTMyNA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r524135324", "bodyText": "Should assert also the subroutine definitions", "author": "temanbrcom", "createdAt": "2020-11-16T11:10:56Z", "path": "server/src/test/java/com/broadcom/lsp/cobol/usecases/engine/UseCaseEngine.java", "diffHunk": "@@ -216,6 +245,8 @@ private static void assertResultEquals(AnalysisResult actual, TestData expected)\n     assertResult(\n         \"Section definition:\", expected.getSectionDefinitions(), actual.getSectionDefinitions());\n     assertResult(\"Section usages:\", expected.getSectionUsages(), actual.getSectionUsages());\n+\n+    assertResult(\"Subroutine usage:\", expected.getSubroutineUsages(), actual.getSubroutineUsages());", "originalCommit": "eafebbb92b6641dfe6c4d439809ae9b0cfe0b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1ODM0OQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r526958349", "bodyText": "Done", "author": "grianbrcom", "createdAt": "2020-11-19T15:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEzNTMyNA=="}], "type": "inlineReview"}, {"oid": "f221cc4c86ab409be5a200598e746b11895c6245", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/f221cc4c86ab409be5a200598e746b11895c6245", "message": "feat: Support for Locally Present Subroutines\n\nCloses #582\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-11-19T15:31:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAwOTcwNQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/650#discussion_r527009705", "bodyText": "Missing javadoc", "author": "temanbrcom", "createdAt": "2020-11-19T16:09:52Z", "path": "server/src/main/java/com/broadcom/lsp/cobol/service/delegates/completions/SubroutineCompletion.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ *\n+ */\n+package com.broadcom.lsp.cobol.service.delegates.completions;\n+\n+import com.broadcom.lsp.cobol.service.CobolDocumentModel;\n+import com.broadcom.lsp.cobol.service.SubroutineService;\n+import com.google.inject.Inject;\n+import com.google.inject.Singleton;\n+import lombok.NonNull;\n+import org.eclipse.lsp4j.CompletionItemKind;\n+\n+import java.util.Collection;\n+\n+import static com.broadcom.lsp.cobol.service.delegates.completions.CompletionOrder.SUBROUTINES;\n+\n+@Singleton\n+public class SubroutineCompletion implements Completion {", "originalCommit": "f221cc4c86ab409be5a200598e746b11895c6245", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "559a00c222db83703a2c7cd31e1617d41c70b24e", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/559a00c222db83703a2c7cd31e1617d41c70b24e", "message": "feat: Support for Locally Present Subroutines\n\nCloses #582\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-11-20T13:15:20Z", "type": "forcePushed"}, {"oid": "5d2a1fc6f28b7d9888c7d6e1c908f0915ef2bf7b", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/5d2a1fc6f28b7d9888c7d6e1c908f0915ef2bf7b", "message": "feat: Support for Locally Present Subroutines\n\nCloses #582\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-11-20T13:26:02Z", "type": "forcePushed"}, {"oid": "b30e9b2b8e8d7e0c993855302a2023f9740e5bf1", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/b30e9b2b8e8d7e0c993855302a2023f9740e5bf1", "message": "feat: Support for Locally Present Subroutines\n\nCloses #582\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-11-20T16:40:25Z", "type": "forcePushed"}, {"oid": "cea8e705926b7d3427d041eb0ad404238bb04440", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/cea8e705926b7d3427d041eb0ad404238bb04440", "message": "feat: Support for Locally Present Subroutines\n\nCloses #582\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-11-20T16:43:47Z", "type": "commit"}, {"oid": "cea8e705926b7d3427d041eb0ad404238bb04440", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/cea8e705926b7d3427d041eb0ad404238bb04440", "message": "feat: Support for Locally Present Subroutines\n\nCloses #582\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-11-20T16:43:47Z", "type": "forcePushed"}]}