{"pr_number": 397, "pr_title": "Avoid many error messages for copybook downloading", "pr_createdAt": "2020-06-17T10:38:37Z", "pr_url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NDEwMw==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441494103", "bodyText": "'DoneAnalysisEvent' sounds a little strange, but still applicable. Maybe, something like `AnalysisFinishedEvent' would be more descriptive?", "author": "temanbrcom", "createdAt": "2020-06-17T12:05:43Z", "path": "com.ca.lsp.cobol/lsp-core-domain/src/main/java/com/broadcom/lsp/domain/cobol/event/model/DoneAnalysisEvent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ */\n+\n+package com.broadcom.lsp.domain.cobol.event.model;\n+\n+import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+\n+/**\n+ * This class is a data transfer object that contains the uri of analyzed document.\n+ */\n+@NoArgsConstructor\n+@Data\n+public class DoneAnalysisEvent extends DataEvent{", "originalCommit": "0fc82cadf18fc40613375da3187b25802ed268a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU4OTI3NA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441589274", "bodyText": "I was inspired by the RunAnalysisEvent. In fact, I'm also don't like this name. I'll change it to AnalysisFinishedEvent.", "author": "grianbrcom", "createdAt": "2020-06-17T14:28:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NDEwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU5MjUzMQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441592531", "bodyText": "AnalysisFinishedEvent --> AnalysisCompletionEvent we use Completion term in lsp", "author": "asatklichov", "createdAt": "2020-06-17T14:33:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NDEwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU5NjM1NA==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441596354", "bodyText": "Completion in LSP is only for the autocomplete feature", "author": "temanbrcom", "createdAt": "2020-06-17T14:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NDEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTA2Mg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441495062", "bodyText": "In fact, it more a signal event, not really a data transfer object", "author": "temanbrcom", "createdAt": "2020-06-17T12:07:35Z", "path": "com.ca.lsp.cobol/lsp-core-domain/src/main/java/com/broadcom/lsp/domain/cobol/event/model/DoneAnalysisEvent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ */\n+\n+package com.broadcom.lsp.domain.cobol.event.model;\n+\n+import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+\n+/**\n+ * This class is a data transfer object that contains the uri of analyzed document.", "originalCommit": "0fc82cadf18fc40613375da3187b25802ed268a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU5MDIwMg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441590202", "bodyText": "Make sense.", "author": "grianbrcom", "createdAt": "2020-06-17T14:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUwNzUxMQ==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441507511", "bodyText": "By the agreement, the method Javadoc should start with a verb", "author": "temanbrcom", "createdAt": "2020-06-17T12:30:32Z", "path": "com.ca.lsp.cobol/lsp-service-cobol/src/main/java/com/ca/lsp/cobol/service/CopybookServiceImpl.java", "diffHunk": "@@ -55,11 +63,30 @@ public CopybookServiceImpl(\n     this.files = files;\n \n     dataBus.subscribe(REQUIRED_COPYBOOK_EVENT, this);\n+    dataBus.subscribe(DONE_ANALYSIS_EVENT, this);\n   }\n \n   @Override\n   public void invalidateURICache() {\n     copybookPaths.clear();\n+    copybooksForDownloading.clear();\n+  }\n+\n+  /**\n+   * Depends on DataEvent type it will be handled with appropriate handler:\n+   * {@link #handleRequiredCopybookEvent} or {@link #handleDoneAnalysisEvent}.\n+   *\n+   * @param event must be {@link RequiredCopybookEvent} or {@link DoneAnalysisEvent}", "originalCommit": "0fc82cadf18fc40613375da3187b25802ed268a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1MzI4Mg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441553282", "bodyText": "can we extract this middleware, params, etc. in desc. with 'let' to reuse", "author": "asatklichov", "createdAt": "2020-06-17T13:40:44Z", "path": "clients/cobol-lsp-vscode-extension/src/__tests__/MiddlewareTest.ts", "diffHunk": "@@ -28,20 +28,33 @@ describe(\"Copybook downloader\", () => {\n         const copybookResolverURI: any = {\n             resolveCopybookURI: jest.fn().mockResolvedValue(\"copybookUri\"),\n         };\n-        const middleware = new Middleware(null, copybookResolverURI);\n-        const params = constructParams(\"broadcom-cobol-lsp.copybook.cobFile.bookName\");\n+        const middleware = new Middleware(copybookResolverURI, null);\n+        const params = constructParams(\"broadcom-cobol-lsp.copybook-resolve.cobFile.bookName\");\n         expect(await middleware.handleConfigurationRequest(params, null, null)).toEqual([\"copybookUri\"]);\n         expect(copybookResolverURI.resolveCopybookURI).toHaveBeenCalledWith(\"bookName\", \"cobFile\");\n     });\n     it(\"Handle copybook request for name with dots\", async () => {\n         const copybookResolverURI: any = {\n             resolveCopybookURI: jest.fn().mockResolvedValue(\"copybookUri\"),\n         };\n-        const middleware = new Middleware(null, copybookResolverURI);\n-        const params = constructParams(\"broadcom-cobol-lsp.copybook.USER.CLIST.COB.bookName\");\n+        const middleware = new Middleware(copybookResolverURI, null);", "originalCommit": "0fc82cadf18fc40613375da3187b25802ed268a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU5NzkzNg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441597936", "bodyText": "It could be even a const. Good point.", "author": "grianbrcom", "createdAt": "2020-06-17T14:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1MzI4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1OTIzNg==", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441559236", "bodyText": "Regarding to this, also better to define return type in method declaration explicitly", "author": "asatklichov", "createdAt": "2020-06-17T13:48:41Z", "path": "clients/cobol-lsp-vscode-extension/src/services/Middleware.ts", "diffHunk": "@@ -25,21 +25,28 @@ export class Middleware {\n         return [params.substring(secondDot + 1, lastDot), params.substring(lastDot + 1)];\n     }\n     constructor(\n-        private copybooksPathGenerator: CopybooksPathGenerator,\n-        private copybookResolverURI: CopybookURI) {\n+        private copybookResolverURI: CopybookURI,\n+        private copybookDownloader: CopybookDownloadService) {\n     }\n \n     public async handleConfigurationRequest(\n         params: ConfigurationParams,\n         token: CancellationToken,\n         next: ConfigurationRequest.HandlerSignature) {\n \n-        if (params.items.length === 1) {\n+        if (params.items.length > 0) {\n             const sectionName = params.items[0].section;\n-            if (sectionName.startsWith(\"broadcom-cobol-lsp.copybook\")) {\n+            if (sectionName.startsWith(\"broadcom-cobol-lsp.copybook-resolve\")) {\n                 const [cobolFileName, copybookName] = Middleware.extractFileAndCopybookNames(sectionName);\n                 return [await this.copybookResolverURI.resolveCopybookURI(copybookName, cobolFileName)];\n             }\n+            if (sectionName.startsWith(\"broadcom-cobol-lsp.copybook-download\")) {\n+                for (const item of params.items) {\n+                    const [cobolFileName, copybookName] = Middleware.extractFileAndCopybookNames(item.section);\n+                    this.copybookDownloader.downloadCopybook(cobolFileName, copybookName);\n+                }\n+                return [];", "originalCommit": "0fc82cadf18fc40613375da3187b25802ed268a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e7e394cb319f2b34472d77fd2c843d99c226726", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/2e7e394cb319f2b34472d77fd2c843d99c226726", "message": "fix: Avoid many error messages for copybook downloading #384\n\nThe middleware process two calls: resolve URI and download copybook.\nThe server synchronously resolves URI copybooks, not in the server cache\nduring document analysis. After the scan, the server sends one call to\nmiddleware with a list of copybooks to download.\nDoneAnalysisEvent was added to the databus.\n\nCloses #384\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-06-17T15:15:59Z", "type": "commit"}, {"oid": "2e7e394cb319f2b34472d77fd2c843d99c226726", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/2e7e394cb319f2b34472d77fd2c843d99c226726", "message": "fix: Avoid many error messages for copybook downloading #384\n\nThe middleware process two calls: resolve URI and download copybook.\nThe server synchronously resolves URI copybooks, not in the server cache\nduring document analysis. After the scan, the server sends one call to\nmiddleware with a list of copybooks to download.\nDoneAnalysisEvent was added to the databus.\n\nCloses #384\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>", "committedDate": "2020-06-17T15:15:59Z", "type": "forcePushed"}]}