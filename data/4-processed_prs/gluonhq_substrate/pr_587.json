{"pr_number": 587, "pr_title": "Add permissions to AndroidManifest by scanning Attach services", "pr_createdAt": "2020-05-15T15:13:16Z", "pr_url": "https://github.com/gluonhq/substrate/pull/587", "timeline": [{"oid": "f7ef5c337cbd976cfdf897a8b6bbec6c1ee748af", "url": "https://github.com/gluonhq/substrate/commit/f7ef5c337cbd976cfdf897a8b6bbec6c1ee748af", "message": "Add permissions to AndroidManifest by scanning Attach services", "committedDate": "2020-05-15T15:12:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3Njc1NQ==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426176755", "bodyText": "We had Glisten/Attach logic in Substrate in the past, and while that worked fine, we moved towards removing any external dependency, by using META_INF/Substrate as a way to allow any third party (JavaFX/Glisten/Attach...) pass configuration files to Substrate.\nWhile this can be a complex task, I'd say we move this to each Attach service, using an xml file with the content that should be added to the final AndroidManifest.xml/Info.plist.\nLike:\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<permissions>\n     <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\"/>\n</permissions>\n\nThis will be more flexible to include other nodes, like extra activities or services.\nDoes this make sense?\nThen, in Substrate, we will scan these files, and combine them properly to produce the manifest/plist.", "author": "jperedadnr", "createdAt": "2020-05-16T18:05:55Z", "path": "src/main/java/com/gluonhq/substrate/target/AndroidTargetConfiguration.java", "diffHunk": "@@ -682,4 +685,32 @@ public BuildToolNotFoundException() {\n             super(\"Android build tools not found. Please install it and try again.\");\n         }\n     }\n+\n+    /**\n+     * Scans the classpath and adds permission to AndroidManifest.xml for\n+     * each attach service found.\n+     * @param genManifest Path to the AndroidManifest.xml file\n+     */\n+    private void addRequiredPermissions(Path genManifest) {", "originalCommit": "f7ef5c337cbd976cfdf897a8b6bbec6c1ee748af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE4NTcxMA==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426185710", "bodyText": "+1 on the approach, but probably easier/more consistent if we use .json files (as we do with reflection/jni files)", "author": "johanvos", "createdAt": "2020-05-16T19:56:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3Njc1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIyODg0OQ==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426228849", "bodyText": "@jperedadnr  Good suggestion!", "author": "abhinayagarwal", "createdAt": "2020-05-17T07:37:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3Njc1NQ=="}], "type": "inlineReview"}, {"oid": "0eb75b46d70893ee3bc06daaa9398819b5635b22", "url": "https://github.com/gluonhq/substrate/commit/0eb75b46d70893ee3bc06daaa9398819b5635b22", "message": "Revert \"Add permissions to AndroidManifest by scanning Attach services\"\n\nThis reverts commit f7ef5c33", "committedDate": "2020-05-18T16:43:47Z", "type": "commit"}, {"oid": "53648b88d620e6a0e7c23a4bb26bd2b3243fe5c7", "url": "https://github.com/gluonhq/substrate/commit/53648b88d620e6a0e7c23a4bb26bd2b3243fe5c7", "message": "Add permissions to AndroidManifest by scanning for android-permissions.txt in Attach jars", "committedDate": "2020-05-18T16:46:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODExMA==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426778110", "bodyText": "I assume the third party jar (usually Attach) will have a file with lines like:\n<uses-permission a:name=\"android.permission.CAMERA\"/>\n\nright?\nHowever, I'd say it should only hold the permission itself:\nandroid.permission.CAMERA\n\nAnd Substrate will provide the format: <uses-permission a:name=\" + line + \"/>\nThis has the advantage of not adding a dependency of the namespace (a) to those jars.", "author": "jperedadnr", "createdAt": "2020-05-18T17:15:52Z", "path": "src/main/resources/native/android/AndroidManifest.xml", "diffHunk": "@@ -3,8 +3,7 @@\n     <supports-screens a:xlargeScreens=\"true\"/>\n     <uses-sdk a:minSdkVersion=\"21\" a:targetSdkVersion=\"28\"/>\n     <uses-permission a:name=\"android.permission.INTERNET\"/>\n-    <uses-permission a:name=\"android.permission.READ_EXTERNAL_STORAGE\"/>\n-    <uses-permission a:name=\"android.permission.WRITE_EXTERNAL_STORAGE\"/>\n+    <!-- PERMISSIONS -->", "originalCommit": "53648b88d620e6a0e7c23a4bb26bd2b3243fe5c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5ODYxNA==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426798614", "bodyText": "Done!", "author": "abhinayagarwal", "createdAt": "2020-05-18T17:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwNjE5NQ==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426806195", "bodyText": "Ok, but I don't see the commit?", "author": "jperedadnr", "createdAt": "2020-05-18T18:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwOTQyOA==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426809428", "bodyText": "Oops, git push failed :)\nI have pushed it now.", "author": "abhinayagarwal", "createdAt": "2020-05-18T18:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5MTY5Mw==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426791693", "bodyText": "It is probably necessary to return a list/set of permissions that are not duplicated. There is no guarantee that the jars won't contain duplicates, so probably this is a good place to enforce that?", "author": "jperedadnr", "createdAt": "2020-05-18T17:40:52Z", "path": "src/main/java/com/gluonhq/substrate/config/ConfigResolver.java", "diffHunk": "@@ -156,6 +158,21 @@ public ConfigResolver(String classpath) throws IOException, InterruptedException\n                 .collect(Collectors.toList());\n     }\n \n+    /**\n+     * Walks through the jars in the classpath,\n+     * and looks for META-INF/substrate/config/android-permissions.txt file.\n+     *\n+     * @return a list of permission lines that should be added to the AndroidManifest file\n+     * @throws IOException Exception while reading the permissions file.\n+     */\n+    public Set<String> getAndroidPermissions() throws IOException {\n+        Logger.logDebug(\"Scanning for android permission files\");\n+        return Set.copyOf(scanJars(USER_ANDROID_PERMISSIONS_FILE,", "originalCommit": "53648b88d620e6a0e7c23a4bb26bd2b3243fe5c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5Nzg1OA==", "url": "https://github.com/gluonhq/substrate/pull/587#discussion_r426797858", "bodyText": "Set implies uniqueness in case of multiple equal objects.", "author": "tiainen", "createdAt": "2020-05-18T17:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5MTY5Mw=="}], "type": "inlineReview"}, {"oid": "ccb3d70376731611b4f30848920ea2d8491c5630", "url": "https://github.com/gluonhq/substrate/commit/ccb3d70376731611b4f30848920ea2d8491c5630", "message": "Create XML tags in Substrate", "committedDate": "2020-05-18T17:51:47Z", "type": "commit"}]}