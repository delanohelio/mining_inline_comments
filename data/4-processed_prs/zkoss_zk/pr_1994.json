{"pr_number": 1994, "pr_title": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "pr_createdAt": "2020-05-12T03:19:40Z", "pr_url": "https://github.com/zkoss/zk/pull/1994", "timeline": [{"oid": "a0c0c3b5d0068a066803adac37afb37c769e0f5c", "url": "https://github.com/zkoss/zk/commit/a0c0c3b5d0068a066803adac37afb37c769e0f5c", "message": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "committedDate": "2020-05-12T03:32:02Z", "type": "forcePushed"}, {"oid": "e5890e0b6d2e834d8a79b4689d76a6493963cb02", "url": "https://github.com/zkoss/zk/commit/e5890e0b6d2e834d8a79b4689d76a6493963cb02", "message": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "committedDate": "2020-05-12T04:32:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4OTU2Ng==", "url": "https://github.com/zkoss/zk/pull/1994#discussion_r423589566", "bodyText": "response.statusText", "author": "scribetw", "createdAt": "2020-05-12T09:21:06Z", "path": "zk/src/archive/web/js/zk/au.js", "diffHunk": "@@ -957,22 +948,22 @@ zAu.beforeSend = function (uri, req, dt) {\n \t\t&& (!reqInf.rtags || !reqInf.rtags.onTimer || zk.timerAlive)) // Bug ZK-2720 only timer-keep-alive should reset the timeout\n \t\t\tzAu._resetTimeout();\n \n-\t\tif (zAu.pushReqCmds(reqInf, req)) { //valid response\n+\t\tif (zAu.pushReqCmds(reqInf, response)) { //valid response\n \t\t\t//advance SID to avoid receive the same response twice\n \t\t\tif (sid && ++zAu.seqId > 9999) zAu.seqId = 1;\n \t\t\tzAu.ajaxReqTries = 0;\n \t\t\tzAu.pendingReqInf = null;\n \t\t}\n \t},\n-\t_respFailure: function (req, reqInf, rstatus) {\n+\t_respFailure: function (response, reqInf, rstatus) {\n \t\tvar eru = zAu._errURIs['' + rstatus];\n \t\tif (typeof eru == 'string') {\n \t\t\tzUtl.go(eru);\n \t\t\treturn true;\n \t\t}\n \n \t\tif (typeof zAu.ajaxErrorHandler == 'function') {\n-\t\t\tzAu.ajaxReqTries = zAu.ajaxErrorHandler(req, rstatus, req.statusText, zAu.ajaxReqTries);\n+\t\t\tzAu.ajaxReqTries = zAu.ajaxErrorHandler(response, rstatus, req.statusText, zAu.ajaxReqTries);", "originalCommit": "e5890e0b6d2e834d8a79b4689d76a6493963cb02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5MTg0Nw==", "url": "https://github.com/zkoss/zk/pull/1994#discussion_r423591847", "bodyText": "?", "author": "scribetw", "createdAt": "2020-05-12T09:24:57Z", "path": "zk/src/archive/web/js/zk/au.js", "diffHunk": "@@ -1042,31 +1033,32 @@ zAu.beforeSend = function (uri, req, dt) {\n \t */\n \t//cmd1: null, //jsdoc\n \n-\tpushReqCmds: function (reqInf, req) {\n+\tpushReqCmds: function (reqInf, response) {\n \t\tvar dt = reqInf.dt,\n-\t\t\trt = req.responseText;\n+\t\t\trt = response.responseText;\n \t\tif (!rt) {\n-\t\t\tif (zk.pfmeter) zAu._pfdone(dt, zAu.pfGetIds(req));\n+\t\t\tif (zk.pfmeter) zAu._pfdone(dt, zAu.pfGetIds(response));\n \t\t\treturn false; //invalid\n \t\t}\n \n \t\tvar cmds = [];\n \t\tcmds.rtags = reqInf.rtags;\n \t\tif (zk.pfmeter) {\n \t\t\tcmds.dt = dt;\n-\t\t\tcmds.pfIds = zAu.pfGetIds(req);\n+\t\t\tcmds.pfIds = zAu.pfGetIds(response);\n \t\t}\n \n \t\ttry {\n \t\t\trt = jq.evalJSON(rt);\n \t\t} catch (e) {\n \t\t\tif (e.name == 'SyntaxError') { //ZK-4199: handle json parse error\n \t\t\t\tzAu.showError('FAILED_TO_PARSE_RESPONSE', e.message);\n-\t\t\t\tzk.debugLog(e.message + ', response text:\\n' + req.responseText);\n+\t\t\t\tzk.debugLog(e.message + ', response text:\\n' + rt);\n \t\t\t\treturn false;\n \t\t\t}\n \t\t\tthrow e;\n \t\t}\n+", "originalCommit": "e5890e0b6d2e834d8a79b4689d76a6493963cb02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5MjM3MA==", "url": "https://github.com/zkoss/zk/pull/1994#discussion_r423592370", "bodyText": "?", "author": "scribetw", "createdAt": "2020-05-12T09:25:44Z", "path": "zk/src/archive/web/js/zk/au.js", "diffHunk": "@@ -1042,31 +1033,32 @@ zAu.beforeSend = function (uri, req, dt) {\n \t */\n \t//cmd1: null, //jsdoc\n \n-\tpushReqCmds: function (reqInf, req) {\n+\tpushReqCmds: function (reqInf, response) {\n \t\tvar dt = reqInf.dt,\n-\t\t\trt = req.responseText;\n+\t\t\trt = response.responseText;\n \t\tif (!rt) {\n-\t\t\tif (zk.pfmeter) zAu._pfdone(dt, zAu.pfGetIds(req));\n+\t\t\tif (zk.pfmeter) zAu._pfdone(dt, zAu.pfGetIds(response));\n \t\t\treturn false; //invalid\n \t\t}\n \n \t\tvar cmds = [];\n \t\tcmds.rtags = reqInf.rtags;\n \t\tif (zk.pfmeter) {\n \t\t\tcmds.dt = dt;\n-\t\t\tcmds.pfIds = zAu.pfGetIds(req);\n+\t\t\tcmds.pfIds = zAu.pfGetIds(response);\n \t\t}\n \n \t\ttry {\n \t\t\trt = jq.evalJSON(rt);\n \t\t} catch (e) {\n \t\t\tif (e.name == 'SyntaxError') { //ZK-4199: handle json parse error\n \t\t\t\tzAu.showError('FAILED_TO_PARSE_RESPONSE', e.message);\n-\t\t\t\tzk.debugLog(e.message + ', response text:\\n' + req.responseText);\n+\t\t\t\tzk.debugLog(e.message + ', response text:\\n' + rt);\n \t\t\t\treturn false;\n \t\t\t}\n \t\t\tthrow e;\n \t\t}\n+", "originalCommit": "e5890e0b6d2e834d8a79b4689d76a6493963cb02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5NDQyOA==", "url": "https://github.com/zkoss/zk/pull/1994#discussion_r423594428", "bodyText": "zAu.onError API changes", "author": "scribetw", "createdAt": "2020-05-12T09:28:53Z", "path": "zk/src/archive/web/js/zk/au.js", "diffHunk": "@@ -1138,10 +1130,10 @@ zAu.beforeSend = function (uri, req, dt) {\n \t\t\tsetTimeout(ajaxReqResend2, timeout ? timeout : 0);\n \t\t}\n \t},\n-\tonResponseError: function (req, errCode) {\n+\tonResponseError: function (response, errCode) {\n \t\t//$clone first since it might add or remove onError\n \t\tfor (var errs = _onErrs.$clone(), fn; fn = errs.shift();)\n-\t\t\tif (fn(req, errCode))\n+\t\t\tif (fn(response, errCode))", "originalCommit": "e5890e0b6d2e834d8a79b4689d76a6493963cb02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0f66bc88bfeaa6fa024155569cdf7579c373d2c", "url": "https://github.com/zkoss/zk/commit/c0f66bc88bfeaa6fa024155569cdf7579c373d2c", "message": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "committedDate": "2020-05-13T04:38:52Z", "type": "forcePushed"}, {"oid": "cd859a243334d58e56ca5531bd6e2612b4ace2d6", "url": "https://github.com/zkoss/zk/commit/cd859a243334d58e56ca5531bd6e2612b4ace2d6", "message": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "committedDate": "2020-05-13T04:53:33Z", "type": "forcePushed"}, {"oid": "10a5f819c4471744b95352852599e91f5b7e120f", "url": "https://github.com/zkoss/zk/commit/10a5f819c4471744b95352852599e91f5b7e120f", "message": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "committedDate": "2020-05-13T06:47:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkyODc2Mg==", "url": "https://github.com/zkoss/zk/pull/1994#discussion_r424928762", "bodyText": ".js", "author": "plijyfes", "createdAt": "2020-05-14T07:35:04Z", "path": "zk/src/archive/web/js/zk/ext/promise-polyfill.js", "diffHunk": "@@ -0,0 +1,312 @@\n+/* promise-polyfill.js.ts", "originalCommit": "10a5f819c4471744b95352852599e91f5b7e120f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b361b3ab2e72a4635b5d9148f64fcc7d558c8771", "url": "https://github.com/zkoss/zk/commit/b361b3ab2e72a4635b5d9148f64fcc7d558c8771", "message": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "committedDate": "2020-05-14T08:33:32Z", "type": "commit"}, {"oid": "b361b3ab2e72a4635b5d9148f64fcc7d558c8771", "url": "https://github.com/zkoss/zk/commit/b361b3ab2e72a4635b5d9148f64fcc7d558c8771", "message": "ZK-4175: replace XHR with the fetch() API to allow SSO redirect handling", "committedDate": "2020-05-14T08:33:32Z", "type": "forcePushed"}]}