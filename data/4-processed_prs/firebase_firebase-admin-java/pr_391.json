{"pr_number": 391, "pr_title": "Add tenant-aware token generation and verification.", "pr_createdAt": "2020-04-16T21:19:39Z", "pr_url": "https://github.com/firebase/firebase-admin-java/pull/391", "timeline": [{"oid": "49202754ec5285f189021feaf5a6eeb30715b2c7", "url": "https://github.com/firebase/firebase-admin-java/commit/49202754ec5285f189021feaf5a6eeb30715b2c7", "message": "Work on token generation.", "committedDate": "2020-04-16T19:04:53Z", "type": "commit"}, {"oid": "d48d0c2250afa5d24f4c4b9f4750e5879ba17cd8", "url": "https://github.com/firebase/firebase-admin-java/commit/d48d0c2250afa5d24f4c4b9f4750e5879ba17cd8", "message": "Fix token generation and add verification.", "committedDate": "2020-04-16T21:13:43Z", "type": "commit"}, {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e", "url": "https://github.com/firebase/firebase-admin-java/commit/10ea21551fb5e5b420f809d746c85370d552ce3e", "message": "Rename test for clarity.", "committedDate": "2020-04-16T21:18:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NTEyNg==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412375126", "bodyText": "Session cookies do not support tenants at the moment. We can remove this.", "author": "hiranya911", "createdAt": "2020-04-21T18:02:32Z", "path": "src/main/java/com/google/firebase/auth/FirebaseTokenUtils.java", "diffHunk": "@@ -82,10 +94,16 @@ static FirebaseTokenVerifierImpl createIdTokenVerifier(FirebaseApp app, Clock cl\n         .setJsonFactory(app.getOptions().getJsonFactory())\n         .setPublicKeysManager(publicKeysManager)\n         .setIdTokenVerifier(idTokenVerifier)\n+        .setTenantId(tenantId)\n         .build();\n   }\n \n   static FirebaseTokenVerifierImpl createSessionCookieVerifier(FirebaseApp app, Clock clock) {\n+    return createSessionCookieVerifier(app, clock, null);\n+  }\n+\n+  static FirebaseTokenVerifierImpl createSessionCookieVerifier(", "originalCommit": "10ea21551fb5e5b420f809d746c85370d552ce3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwNjkxOQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413006919", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-22T13:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NTEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412376411", "bodyText": "Following might be a bit more readable:\nif (!Strings.isNullOrEmpty(this.tenantId)) {\n  if (!this.tenantId.equals(tokenTenantId) {\n    // ...\n  }\n}", "author": "hiranya911", "createdAt": "2020-04-21T18:04:26Z", "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = firebaseToken.getTenantId();\n+    if (!Strings.nullToEmpty(tokenTenantId).equals(Strings.nullToEmpty(tenantId))) {", "originalCommit": "10ea21551fb5e5b420f809d746c85370d552ce3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkzODkwMg==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412938902", "bodyText": "That's more readable, yes, but it also behaves differently.\nDon't we want to throw an exception if this.tenantId is null and tokenTenantId is non-empty?", "author": "micahstairs", "createdAt": "2020-04-22T12:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIxNzMzNA==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413217334", "bodyText": "Ah I see your point. What if we do this in the constructor then:\nthis.tenantId = Strings.nullToEmpty(tenantId);\n\nThen during verification you can do !this.tenantId.equals(tokenTenantId).", "author": "hiranya911", "createdAt": "2020-04-22T18:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI5NjA4NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413296084", "bodyText": "Moving Strings.nullToEmpty to the constructor is a good idea.\nBut I think we'd need to do !this.tenantId.equals(Strings.nullToEmpty(tokenTenantId))) or else we'd say there was a mismatch if both were initially null.", "author": "micahstairs", "createdAt": "2020-04-22T20:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwMTc0Nw==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413301747", "bodyText": "I pulled the other Strings.nullToEmpty to the previous line where tokenTenantId is defined. I think this is better now.", "author": "micahstairs", "createdAt": "2020-04-22T20:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412378562", "bodyText": "Might want to push this into a finally block", "author": "hiranya911", "createdAt": "2020-04-21T18:07:27Z", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();", "originalCommit": "10ea21551fb5e5b420f809d746c85370d552ce3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkzMTYxNQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412931615", "bodyText": "There's no existing try block to add the finally block to. Are you suggesting that I wrap the entire \"Create and decode a token with a tenant-aware client\" section with a try (and no catch)?", "author": "micahstairs", "createdAt": "2020-04-22T12:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIxNTI0NQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413215245", "bodyText": "Yes. You will see this pattern being used in a number of existing test cases. See testCustomClaims() for example.", "author": "hiranya911", "createdAt": "2020-04-22T18:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwMTg4NQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413301885", "bodyText": "Okay sounds good! Done.", "author": "micahstairs", "createdAt": "2020-04-22T20:20:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODY2NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412378664", "bodyText": "Same here", "author": "hiranya911", "createdAt": "2020-04-21T18:07:36Z", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();\n+  }\n+\n+  @Test\n+  public void testVerifyTokenWithWrongTenantAwareClient() throws Exception {\n+    // Create tenants to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest1 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName1\");\n+    String tenantId1 = tenantManager.createTenant(tenantCreateRequest1).getTenantId();\n+    Tenant.CreateRequest tenantCreateRequest2 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName2\");\n+    String tenantId2 = tenantManager.createTenant(tenantCreateRequest2).getTenantId();\n+\n+    // Create tenant-aware clients.\n+    TenantAwareFirebaseAuth tenantAwareAuth1 = auth.getTenantManager().getAuthForTenant(tenantId1);\n+    TenantAwareFirebaseAuth tenantAwareAuth2 = auth.getTenantManager().getAuthForTenant(tenantId2);\n+\n+    // Create a token with one client and decode with the other.\n+    String customToken = tenantAwareAuth1.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId1);\n+    try {\n+      tenantAwareAuth2.verifyIdTokenAsync(idToken).get();\n+      fail(\"No error thrown for verifying a token with the wrong tenant-aware client\");\n+    } catch (ExecutionException e) {\n+      assertTrue(e.getCause() instanceof FirebaseAuthException);\n+      assertEquals(FirebaseUserManager.TENANT_ID_MISMATCH,\n+          ((FirebaseAuthException) e.getCause()).getErrorCode());\n+    }\n+\n+    // Delete tenants.\n+    tenantManager.deleteTenantAsync(tenantId1).get();", "originalCommit": "10ea21551fb5e5b420f809d746c85370d552ce3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwNzA2MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413007060", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-22T13:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4MDg0Nw==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412380847", "bodyText": "Can we also have some unit tests in FirebaseTokenVerifierImplTest.", "author": "hiranya911", "createdAt": "2020-04-21T18:10:56Z", "path": "src/test/java/com/google/firebase/auth/internal/FirebaseTokenFactoryTest.java", "diffHunk": "@@ -18,6 +18,7 @@\n \n import static com.google.common.base.Preconditions.checkNotNull;\n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;", "originalCommit": "10ea21551fb5e5b420f809d746c85370d552ce3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwNzE4Ng==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413007186", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-22T13:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4MDg0Nw=="}], "type": "inlineReview"}, {"oid": "d41e59c3244fa764c3cffcffc3a12507e5477dad", "url": "https://github.com/firebase/firebase-admin-java/commit/d41e59c3244fa764c3cffcffc3a12507e5477dad", "message": "Address pull request feedback.", "committedDate": "2020-04-22T13:57:36Z", "type": "commit"}, {"oid": "646f98d29fb674a4d3cc74251edef7fd455e7216", "url": "https://github.com/firebase/firebase-admin-java/commit/646f98d29fb674a4d3cc74251edef7fd455e7216", "message": "Finish addressing feedback.", "committedDate": "2020-04-22T20:18:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwNDY3OA==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413304678", "bodyText": "Nit: nullToEmpty is not strictly needed here, since you call equals on this.tenantId which is never null. But I'll leave it to you decide.", "author": "hiranya911", "createdAt": "2020-04-22T20:25:19Z", "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = Strings.nullToEmpty(firebaseToken.getTenantId());", "originalCommit": "646f98d29fb674a4d3cc74251edef7fd455e7216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMzOTQzMw==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413339433", "bodyText": "We actually do need it or else we'd say there was a mismatch if both were initially null. I confirmed this theory by making the change and watching FirebaseTokenVerifierImplTest.testVerifyToken fail.", "author": "micahstairs", "createdAt": "2020-04-22T21:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwNDY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwOTAzOQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413309039", "bodyText": "You can only create one tenant for this test. For the 2nd tenant use a fake tenant ID string. And to ensure proper clean up you will have to do something like this:\n// create test tenants\ntry {\n   // create token\n   try {\n     // verify token\n   }. catch {\n     // assert\n   }\n} finally {\n  // clean up tenants\n}\n\nYou can move the inner try-catch into a new helper method if this looks too ugly.", "author": "hiranya911", "createdAt": "2020-04-22T20:32:41Z", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,60 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    try {\n+      // Create and decode a token with a tenant-aware client.\n+      TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+      String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+      String idToken = signInWithCustomToken(customToken, tenantId);\n+      FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+      assertEquals(\"user1\", decoded.getUid());\n+      assertEquals(tenantId, decoded.getTenantId());\n+    } finally {\n+      // Delete tenant.\n+      tenantManager.deleteTenantAsync(tenantId).get();\n+    }\n+  }\n+\n+  @Test\n+  public void testVerifyTokenWithWrongTenantAwareClient() throws Exception {\n+    // Create tenants to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest1 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName1\");\n+    String tenantId1 = tenantManager.createTenant(tenantCreateRequest1).getTenantId();\n+    Tenant.CreateRequest tenantCreateRequest2 =", "originalCommit": "646f98d29fb674a4d3cc74251edef7fd455e7216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMzNTM3NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413335374", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-22T21:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwOTAzOQ=="}], "type": "inlineReview"}, {"oid": "dbefc8c275fa735988bf63490a0eda3cfc943630", "url": "https://github.com/firebase/firebase-admin-java/commit/dbefc8c275fa735988bf63490a0eda3cfc943630", "message": "Restructure integration test to ensure that cleanup is done.", "committedDate": "2020-04-22T21:09:48Z", "type": "commit"}]}