{"pr_number": 400, "pr_title": "Add operations to create and delete OIDC provider configs.", "pr_createdAt": "2020-04-28T21:00:59Z", "pr_url": "https://github.com/firebase/firebase-admin-java/pull/400", "timeline": [{"oid": "28e3dc7f50c89bb1dd7604975be1e9fc4a49e26a", "url": "https://github.com/firebase/firebase-admin-java/commit/28e3dc7f50c89bb1dd7604975be1e9fc4a49e26a", "message": "Fix CreateRequest chaining and provider ID extraction.", "committedDate": "2020-04-27T22:03:02Z", "type": "commit"}, {"oid": "65827dc74177636ff83d2d9db5542119aac43a8c", "url": "https://github.com/firebase/firebase-admin-java/commit/65827dc74177636ff83d2d9db5542119aac43a8c", "message": "Fix javadoc comment.", "committedDate": "2020-04-27T22:08:08Z", "type": "commit"}, {"oid": "913e1288d791fc8b60d8c10fe51b529517a7e168", "url": "https://github.com/firebase/firebase-admin-java/commit/913e1288d791fc8b60d8c10fe51b529517a7e168", "message": "Add operations to create and delete OIDC provider configs.", "committedDate": "2020-04-28T20:51:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyMDc2MQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416920761", "bodyText": "I find this mapping strange, however, \"CONFIGURATION_NOT_FOUND\" was already being mapped to \"project-not-found\".\nI've confirmed that the server returns CONFIGURATION_NOT_FOUND if you ask it to delete a provider config ID which doesn't exist.", "author": "micahstairs", "createdAt": "2020-04-28T21:03:17Z", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -65,6 +65,7 @@\n  */\n class FirebaseUserManager {\n \n+  static final String CONFIGURATION_NOT_FOUND = \"project-not-found\";", "originalCommit": "913e1288d791fc8b60d8c10fe51b529517a7e168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzMDI5MQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416930291", "bodyText": "Already mapped where? Looks like it's being added here.", "author": "hiranya911", "createdAt": "2020-04-28T21:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyMDc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0NTAxMg==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416945012", "bodyText": "It was already in the map (.put(\"CONFIGURATION_NOT_FOUND\", \"project-not-found\")), I just gave the constant a name so that it could be referenced.", "author": "micahstairs", "createdAt": "2020-04-28T21:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyMDc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MDE4MQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416960181", "bodyText": "I think we ought to fix it. I don't think any of the existing APIs return this error code, so it should be safe to change it to \"configuration-not-found\".", "author": "hiranya911", "createdAt": "2020-04-28T22:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyMDc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAwOTY1Nw==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r417009657", "bodyText": "Okay! Done.", "author": "micahstairs", "createdAt": "2020-04-29T00:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyMDc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyODEyMw==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416928123", "bodyText": "This is different from the signature proposed in go/firebase-mt-java. That is fine, but we should think if this is the best we can do. In .NET we used a generics-based solution for this. Can we do something similar here? Something like the following:\n<T extends ProviderConfig> T createProviderConfig(ProviderConfig.CreateRequest<T> request)\n\nWDYT?", "author": "hiranya911", "createdAt": "2020-04-28T21:16:32Z", "path": "src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java", "diffHunk": "@@ -945,6 +936,98 @@ protected String execute() throws FirebaseAuthException {\n     };\n   }\n \n+  /**\n+   * Creates a new provider OIDC Auth config with the attributes contained in the specified {@link\n+   * OidcProviderConfig.CreateRequest}.\n+   *\n+   * @param request A non-null {@link OidcProviderConfig.CreateRequest} instance.\n+   * @return An {@link OidcProviderConfig} instance corresponding to the newly created provider\n+   *     config.\n+   * @throws NullPointerException if the provided request is null.\n+   * @throws FirebaseAuthException if an error occurs while creating the provider config.\n+   */\n+  public OidcProviderConfig createOidcProviderConfig(", "originalCommit": "913e1288d791fc8b60d8c10fe51b529517a7e168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk1NzQ4MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416957480", "bodyText": "It's unfortunately not as simple as this. The class signature of AuthProviderConfig is public abstract static class CreateRequest<T extends CreateRequest<T>>, not public abstract static class CreateRequest<T extends AuthProviderConfig<T>>. In order to make this work, I think we'd need to add another (complex) generic type to AuthProviderConfig.CreateRequest. As I mentioned in my PR description, the accumulated complexity outweighed the benefits in my opinion.\nFor more context about why CreateRequest<T extends CreateRequest<T>> is necessary (as opposed to the more intuitive CreateRequest<T extends AuthProviderConfig>), see https://stackoverflow.com/a/17165079.", "author": "micahstairs", "createdAt": "2020-04-28T22:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyODEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MjY0MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416962640", "bodyText": "Wouldn't this work?\nclass CreateRequest<T extends CreateRequest<T>, U extends AuthProviderConfig> {\n \n}", "author": "hiranya911", "createdAt": "2020-04-28T22:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyODEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxMDM2MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r417010360", "bodyText": "Yes, I think that might work. That's the idea I was referring to when I mentioned adding another (complex) generic type to AuthProviderConfig.CreateRequest.\nMy concern is that this makes the external API too complex. Wouldn't this make the signature for createProviderConfig pretty wild?", "author": "micahstairs", "createdAt": "2020-04-29T00:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyODEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMjkxNQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r417022915", "bodyText": "That's a good point. I guess the best we can do in that case is something like:\npublic <T extends ProviderConfig> T createProviderConfig(AbstractCreateRequest<?, T> request)\n\nUsers won't have to worry too much about this as they can simply do createProviderConfig(new OidcProviderConfig.CreateRequest()) most of the time, but createOidcProviderConfig(request) is far simpler to wrap one's head around.\nOk, I think I'm sufficiently convinced. Let's go ahead with separate create methods for the 2 types.", "author": "hiranya911", "createdAt": "2020-04-29T01:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyODEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2OTU4OQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r417369589", "bodyText": "Great! Glad we are on the same page now.", "author": "micahstairs", "createdAt": "2020-04-29T14:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyODEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzMTM4OA==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416931388", "bodyText": "idpConfigMgtBaseUrl", "author": "hiranya911", "createdAt": "2020-04-28T21:22:54Z", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -106,6 +107,7 @@\n   private static final String CLIENT_VERSION_HEADER = \"X-Client-Version\";\n \n   private final String userMgtBaseUrl;\n+  private final String oidpMgtBaseUrl;", "originalCommit": "913e1288d791fc8b60d8c10fe51b529517a7e168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0ODk0NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416948944", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-28T21:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzMTM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzNDQ1MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416934450", "bodyText": "Lets add some assertions here.", "author": "hiranya911", "createdAt": "2020-04-28T21:28:19Z", "path": "src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java", "diffHunk": "@@ -1383,6 +1386,140 @@ public void testUnexpectedHttpError() {\n     }\n   }\n \n+  @Test\n+  public void testCreateOidcProvider() throws Exception {\n+    TestResponseInterceptor interceptor = initializeAppForUserManagement(\n+        TestUtils.loadResource(\"oidc.json\"));\n+    OidcProviderConfig.CreateRequest createRequest =\n+        new OidcProviderConfig.CreateRequest()\n+            .setProviderId(\"oidc.provider-id\")\n+            .setDisplayName(\"DISPLAY_NAME\")\n+            .setEnabled(true)\n+            .setClientId(\"CLIENT_ID\")\n+            .setIssuer(\"https://oidc.com/issuer\");\n+\n+    OidcProviderConfig config = FirebaseAuth.getInstance().createOidcProviderConfig(createRequest);\n+\n+    checkOidcProviderConfig(config);\n+    checkRequestHeaders(interceptor);\n+    checkUrl(interceptor, \"POST\", PROJECT_BASE_URL + \"/oauthIdpConfigs\");\n+    GenericJson parsed = parseRequestContent(interceptor);\n+    assertEquals(\"DISPLAY_NAME\", parsed.get(\"displayName\"));\n+    assertTrue((boolean) parsed.get(\"enabled\"));\n+    assertEquals(\"CLIENT_ID\", parsed.get(\"clientId\"));\n+    assertEquals(\"https://oidc.com/issuer\", parsed.get(\"issuer\"));\n+    GenericUrl url = interceptor.getResponse().getRequest().getUrl();\n+    assertEquals(\"oidc.provider-id\", url.getFirst(\"oauthIdpConfigId\"));\n+  }\n+\n+  @Test\n+  public void testCreateOidcProviderMinimal() throws Exception {\n+    TestResponseInterceptor interceptor = initializeAppForUserManagement(\n+        TestUtils.loadResource(\"oidc.json\"));\n+    // Only the 'enabled' field can be omitted from an OIDC provider config creation request.\n+    OidcProviderConfig.CreateRequest createRequest =\n+        new OidcProviderConfig.CreateRequest()\n+            .setProviderId(\"oidc.provider-id\")\n+            .setDisplayName(\"DISPLAY_NAME\")\n+            .setClientId(\"CLIENT_ID\")\n+            .setIssuer(\"https://oidc.com/issuer\");\n+\n+    FirebaseAuth.getInstance().createOidcProviderConfig(createRequest);", "originalCommit": "913e1288d791fc8b60d8c10fe51b529517a7e168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk1MDg4NQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r416950885", "bodyText": "Done. Initially, I was thinking that the purpose of the test was to ensure that we didn't mistakenly disallow a create request missing \"enabled\", however, now I see that can also make meaningful assertions about the request that we are sending.", "author": "micahstairs", "createdAt": "2020-04-28T22:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzNDQ1MA=="}], "type": "inlineReview"}, {"oid": "79f901477f42f08429c7106201fdf05f03a04871", "url": "https://github.com/firebase/firebase-admin-java/commit/79f901477f42f08429c7106201fdf05f03a04871", "message": "Rename variable and add test assertions.", "committedDate": "2020-04-28T21:57:35Z", "type": "commit"}, {"oid": "2dbd6a6bb83c19b644fe175dcc0d8549f8fcddc5", "url": "https://github.com/firebase/firebase-admin-java/commit/2dbd6a6bb83c19b644fe175dcc0d8549f8fcddc5", "message": "Add a few more test assertions.", "committedDate": "2020-04-28T22:02:11Z", "type": "commit"}, {"oid": "5ae38d330dbaa9d2e5b4e574e9fa507ede303fd9", "url": "https://github.com/firebase/firebase-admin-java/commit/5ae38d330dbaa9d2e5b4e574e9fa507ede303fd9", "message": "Change 'project-not-found' to 'configuration-not-found'.", "committedDate": "2020-04-29T00:46:55Z", "type": "commit"}, {"oid": "5e47744e81cc20c49107644a23f6eb6e572a627c", "url": "https://github.com/firebase/firebase-admin-java/commit/5e47744e81cc20c49107644a23f6eb6e572a627c", "message": "Merge idp-config into micahstairs-create-and-delete-provider-configs", "committedDate": "2020-04-29T14:38:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUzMDU0Nw==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r417530547", "bodyText": "SAML configs are on a different URL path. Better to not append /oauthIdpConfigs to the URL here.", "author": "hiranya911", "createdAt": "2020-04-29T18:40:00Z", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -120,15 +122,18 @@\n         \"Project ID is required to access the auth service. Use a service account credential or \"\n             + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n             + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n-    String tenantId = builder.tenantId;\n-    if (builder.tenantId == null) {\n-      this.userMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    final String idToolkitUrlV1 = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    final String idToolkitUrlV2 = String.format(ID_TOOLKIT_URL, \"v2\", projectId);\n+    final String tenantId = builder.tenantId;\n+    if (tenantId == null) {\n+      this.userMgtBaseUrl = idToolkitUrlV1;\n+      this.idpConfigMgtBaseUrl = idToolkitUrlV2 + \"/oauthIdpConfigs\";\n     } else {\n       checkArgument(!tenantId.isEmpty(), \"tenant ID must not be empty\");\n-      this.userMgtBaseUrl =\n-          String.format(ID_TOOLKIT_URL, \"v1\", projectId) + getTenantUrlSuffix(tenantId);\n+      this.userMgtBaseUrl = idToolkitUrlV1 + getTenantUrlSuffix(tenantId);\n+      this.idpConfigMgtBaseUrl = idToolkitUrlV2 + getTenantUrlSuffix(tenantId) + \"/oauthIdpConfigs\";", "originalCommit": "5e47744e81cc20c49107644a23f6eb6e572a627c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU0MjgyNA==", "url": "https://github.com/firebase/firebase-admin-java/pull/400#discussion_r417542824", "bodyText": "Done.", "author": "micahstairs", "createdAt": "2020-04-29T19:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUzMDU0Nw=="}], "type": "inlineReview"}, {"oid": "5b3cf9e9279a1bd206e0ffda0856076f0ad48a44", "url": "https://github.com/firebase/firebase-admin-java/commit/5b3cf9e9279a1bd206e0ffda0856076f0ad48a44", "message": "Remove '/oauthIdpConfigs' from idpConfigMgtBaseUrl.", "committedDate": "2020-04-29T19:00:18Z", "type": "commit"}]}