{"pr_number": 404, "pr_title": "Add operation to list OIDC provider configs.", "pr_createdAt": "2020-05-04T21:01:57Z", "pr_url": "https://github.com/firebase/firebase-admin-java/pull/404", "timeline": [{"oid": "68edeb3dc1a8f6b143197e32a76ec524431039f6", "url": "https://github.com/firebase/firebase-admin-java/commit/68edeb3dc1a8f6b143197e32a76ec524431039f6", "message": "Add operation to list OIDC provider configs.", "committedDate": "2020-05-04T20:59:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyNzU3Mg==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419727572", "bodyText": "Is 100 the right value to use as a maximum? The Go implementation uses 100 but I don't think the Node implementation has a limit at all. It's not clear what limit the server enforces.", "author": "micahstairs", "createdAt": "2020-05-04T21:04:39Z", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -94,6 +95,7 @@\n       .put(\"INVALID_DYNAMIC_LINK_DOMAIN\", \"invalid-dynamic-link-domain\")\n       .build();\n \n+  static final int MAX_LIST_PROVIDER_CONFIGS_RESULTS = 100;", "originalCommit": "68edeb3dc1a8f6b143197e32a76ec524431039f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1MTc2NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419751764", "bodyText": "Yes 100 is correct.", "author": "hiranya911", "createdAt": "2020-05-04T21:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcyNzU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1NjU3NA==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419756574", "bodyText": "May be just call this Factory and use the full qualified name of ListUsersPage.Factory at callsites?", "author": "hiranya911", "createdAt": "2020-05-04T22:04:18Z", "path": "src/main/java/com/google/firebase/auth/ListUsersPage.java", "diffHunk": "@@ -237,17 +238,17 @@ String getNextPageToken() {\n    * before attempting to load any user data (which is expensive, and hence may be performed\n    * asynchronously on a separate thread).\n    */\n-  static class PageFactory {\n+  static class UserPageFactory {", "originalCommit": "68edeb3dc1a8f6b143197e32a76ec524431039f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4ODIzNg==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419788236", "bodyText": "Good idea!", "author": "micahstairs", "createdAt": "2020-05-04T23:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1NjU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1NzI2Nw==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419757267", "bodyText": "Mention the default maxResults in the docs.", "author": "hiranya911", "createdAt": "2020-05-04T22:05:55Z", "path": "src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java", "diffHunk": "@@ -1058,6 +1060,78 @@ protected OidcProviderConfig execute() throws FirebaseAuthException {\n     };\n   }\n \n+  /**\n+   * Gets a page of OIDC Auth provider configs starting from the specified {@code pageToken}.\n+   *\n+   * @param pageToken A non-empty page token string, or null to retrieve the first page of provider\n+   *     configs.\n+   * @param maxResults Maximum number of provider configs to include in the returned page. This may\n+   *     not exceed 100.\n+   * @return A {@link ListProviderConfigsPage} instance.\n+   * @throws IllegalArgumentException If the specified page token is empty, or max results value is\n+   *     invalid.\n+   * @throws FirebaseAuthException If an error occurs while retrieving user data.\n+   */\n+  public ListProviderConfigsPage<OidcProviderConfig> listOidcProviderConfigs(\n+        @Nullable String pageToken, int maxResults) throws FirebaseAuthException {\n+    return listOidcProviderConfigsOp(pageToken, maxResults).call();\n+  }\n+\n+  /**", "originalCommit": "68edeb3dc1a8f6b143197e32a76ec524431039f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4ODUyNA==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419788524", "bodyText": "Done. I followed the same pattern as in the list user methods.", "author": "micahstairs", "createdAt": "2020-05-04T23:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1NzI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1NzkxOQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419757919", "bodyText": "Lets see if we can keep this as is, or just rename to ListUsersPage.Factory.", "author": "hiranya911", "createdAt": "2020-05-04T22:07:36Z", "path": "src/test/java/com/google/firebase/auth/ListUsersPageTest.java", "diffHunk": "@@ -45,7 +46,7 @@\n   @Test\n   public void testSinglePage() throws FirebaseAuthException, IOException {\n     TestUserSource source = new TestUserSource(3);\n-    ListUsersPage page = new ListUsersPage.PageFactory(source).create();\n+    ListUsersPage page = new UserPageFactory(source).create();", "originalCommit": "68edeb3dc1a8f6b143197e32a76ec524431039f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4ODMxOQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419788319", "bodyText": "Renamed to ListUsersPage.Factory.", "author": "micahstairs", "createdAt": "2020-05-04T23:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1NzkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MDU2Mg==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419760562", "bodyText": "Define a helper to reduce some of this duplication.\nif (checkProviderConfig(providerIds, providerConfig) {\n  collected.incrementAndGet();\n}\n\nprivate boolean checkProviderConfig(List<String> providerIds, OidcProviderConfig config) {\n  \n}", "author": "hiranya911", "createdAt": "2020-05-04T22:14:00Z", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -1066,6 +1066,137 @@ public void testTenantAwareOidcProviderConfigLifecycle() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testListOidcProviderConfigs() throws Exception {\n+    final List<String> providerIds = new ArrayList<>();\n+\n+    try {\n+      // Create provider configs\n+      for (int i = 0; i < 3; i++) {\n+        String providerId = \"oidc.provider-id\" + i;\n+        providerIds.add(providerId);\n+        OidcProviderConfig.CreateRequest createRequest = new OidcProviderConfig.CreateRequest()\n+            .setProviderId(providerId)\n+            .setClientId(\"CLIENT_ID\")\n+            .setIssuer(\"https://oidc.com/issuer\");\n+        auth.createOidcProviderConfig(createRequest);\n+      }\n+\n+      // Test list by batches\n+      final AtomicInteger collected = new AtomicInteger(0);\n+      ListProviderConfigsPage<OidcProviderConfig> page =\n+          auth.listOidcProviderConfigsAsync(null).get();\n+      while (page != null) {\n+        for (OidcProviderConfig providerConfig : page.getValues()) {\n+          if (providerIds.contains(providerConfig.getProviderId())) {\n+            collected.incrementAndGet();\n+            assertEquals(\"CLIENT_ID\", providerConfig.getClientId());\n+            assertEquals(\"https://oidc.com/issuer\", providerConfig.getIssuer());\n+          }\n+        }\n+        page = page.getNextPage();\n+      }\n+      assertEquals(providerIds.size(), collected.get());\n+\n+      // Test iterate all\n+      collected.set(0);\n+      page = auth.listOidcProviderConfigsAsync(null).get();\n+      for (OidcProviderConfig providerConfig : page.iterateAll()) {\n+        if (providerIds.contains(providerConfig.getProviderId())) {\n+          collected.incrementAndGet();\n+          assertEquals(\"CLIENT_ID\", providerConfig.getClientId());", "originalCommit": "68edeb3dc1a8f6b143197e32a76ec524431039f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4ODQxNg==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419788416", "bodyText": "This doesn't save too many lines, but sure.", "author": "micahstairs", "createdAt": "2020-05-04T23:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MDU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MjY5MA==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419762690", "bodyText": "I feel like we are creating so many throw away tenants in these tests. I'd suggest that we move all tenant-aware tests to a new class. We can just create one test tenant in a @BeforeClass and reuse it as much as possible. Will make the overall logic a lot clear that way too.\nBut feel free to do that in a separate PR.", "author": "hiranya911", "createdAt": "2020-05-04T22:19:10Z", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -1066,6 +1066,137 @@ public void testTenantAwareOidcProviderConfigLifecycle() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testListOidcProviderConfigs() throws Exception {\n+    final List<String> providerIds = new ArrayList<>();\n+\n+    try {\n+      // Create provider configs\n+      for (int i = 0; i < 3; i++) {\n+        String providerId = \"oidc.provider-id\" + i;\n+        providerIds.add(providerId);\n+        OidcProviderConfig.CreateRequest createRequest = new OidcProviderConfig.CreateRequest()\n+            .setProviderId(providerId)\n+            .setClientId(\"CLIENT_ID\")\n+            .setIssuer(\"https://oidc.com/issuer\");\n+        auth.createOidcProviderConfig(createRequest);\n+      }\n+\n+      // Test list by batches\n+      final AtomicInteger collected = new AtomicInteger(0);\n+      ListProviderConfigsPage<OidcProviderConfig> page =\n+          auth.listOidcProviderConfigsAsync(null).get();\n+      while (page != null) {\n+        for (OidcProviderConfig providerConfig : page.getValues()) {\n+          if (providerIds.contains(providerConfig.getProviderId())) {\n+            collected.incrementAndGet();\n+            assertEquals(\"CLIENT_ID\", providerConfig.getClientId());\n+            assertEquals(\"https://oidc.com/issuer\", providerConfig.getIssuer());\n+          }\n+        }\n+        page = page.getNextPage();\n+      }\n+      assertEquals(providerIds.size(), collected.get());\n+\n+      // Test iterate all\n+      collected.set(0);\n+      page = auth.listOidcProviderConfigsAsync(null).get();\n+      for (OidcProviderConfig providerConfig : page.iterateAll()) {\n+        if (providerIds.contains(providerConfig.getProviderId())) {\n+          collected.incrementAndGet();\n+          assertEquals(\"CLIENT_ID\", providerConfig.getClientId());\n+          assertEquals(\"https://oidc.com/issuer\", providerConfig.getIssuer());\n+        }\n+      }\n+      assertEquals(providerIds.size(), collected.get());\n+\n+      // Test iterate async\n+      collected.set(0);\n+      final Semaphore semaphore = new Semaphore(0);\n+      final AtomicReference<Throwable> error = new AtomicReference<>();\n+      ApiFuture<ListProviderConfigsPage<OidcProviderConfig>> pageFuture =\n+          auth.listOidcProviderConfigsAsync(null);\n+      ApiFutures.addCallback(\n+          pageFuture,\n+          new ApiFutureCallback<ListProviderConfigsPage<OidcProviderConfig>>() {\n+            @Override\n+            public void onFailure(Throwable t) {\n+              error.set(t);\n+              semaphore.release();\n+            }\n+\n+            @Override\n+            public void onSuccess(ListProviderConfigsPage<OidcProviderConfig> result) {\n+              for (OidcProviderConfig providerConfig : result.iterateAll()) {\n+                if (providerIds.contains(providerConfig.getProviderId())) {\n+                  collected.incrementAndGet();\n+                  assertEquals(\"CLIENT_ID\", providerConfig.getClientId());\n+                  assertEquals(\"https://oidc.com/issuer\", providerConfig.getIssuer());\n+                }\n+              }\n+              semaphore.release();\n+            }\n+          }, MoreExecutors.directExecutor());\n+      semaphore.acquire();\n+      assertEquals(providerIds.size(), collected.get());\n+      assertNull(error.get());\n+    } finally {\n+      // Delete provider configs\n+      for (String providerId : providerIds) {\n+        auth.deleteProviderConfigAsync(providerId).get();\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testTenantAwareListOidcProviderConfigs() throws Exception {", "originalCommit": "68edeb3dc1a8f6b143197e32a76ec524431039f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4NTk3MQ==", "url": "https://github.com/firebase/firebase-admin-java/pull/404#discussion_r419785971", "bodyText": "This is a really good idea! I think this would clean things up a lot. I've added a TODO to address in a separate PR (since it will involve moving quite a bit of code).", "author": "micahstairs", "createdAt": "2020-05-04T23:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MjY5MA=="}], "type": "inlineReview"}, {"oid": "c346de1173d7aacf177039b4cb18525dbb22cbcd", "url": "https://github.com/firebase/firebase-admin-java/commit/c346de1173d7aacf177039b4cb18525dbb22cbcd", "message": "Address pull request feedback.", "committedDate": "2020-05-04T23:34:05Z", "type": "commit"}]}