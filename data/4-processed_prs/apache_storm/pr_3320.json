{"pr_number": 3320, "pr_title": "[STORM-3684] use real compId instead of constant _system for receive-queue V2 metrics", "pr_createdAt": "2020-08-04T19:38:12Z", "pr_url": "https://github.com/apache/storm/pull/3320", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTI0Mg==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465301242", "bodyText": "Is it possible to reuse this.taskToComponent?", "author": "Ethanlm", "createdAt": "2020-08-04T20:08:52Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -717,11 +718,20 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n \n         IWaitStrategy backPressureWaitStrategy = IWaitStrategy.createBackPressureWaitStrategy(topologyConf);\n         Map<List<Long>, JCQueue> receiveQueueMap = new HashMap<>();\n+\n+        Map<Integer, String> taskIdToCompId = StormCommon.stormTaskInfo(topology, topologyConf);", "originalCommit": "8825ed5f881ad30473d6402866794e8b5765b054", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ5MDU1Ng==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465490556", "bodyText": "Yes, updated. Thanks for pointing out.", "author": "RuiLi8080", "createdAt": "2020-08-05T05:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTQxNA==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465301414", "bodyText": "anything specific to this change?", "author": "Ethanlm", "createdAt": "2020-08-04T20:09:10Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -199,7 +200,6 @@ public WorkerState(Map<String, Object> conf,\n         }\n         Collections.sort(localTaskIds);\n         this.topologyConf = topologyConf;\n-        this.topology = ConfigUtils.readSupervisorTopology(conf, topologyId, AdvancedFSOps.make(conf));", "originalCommit": "8825ed5f881ad30473d6402866794e8b5765b054", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ5MDkzOA==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465490938", "bodyText": "I actually updated. Basically mkReceiveQueueMap() function needs to know this.taskToComponent which relies on this.topology. So we need to move them up.", "author": "RuiLi8080", "createdAt": "2020-08-05T05:58:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTQxNA=="}], "type": "inlineReview"}, {"oid": "036e9b37dadc7ca34f1844af6eb2d46742e1329a", "url": "https://github.com/apache/storm/commit/036e9b37dadc7ca34f1844af6eb2d46742e1329a", "message": "[STORM-3684] use real compId instead of constant _system for receive-queue V2 metrics", "committedDate": "2020-08-05T05:52:46Z", "type": "commit"}, {"oid": "036e9b37dadc7ca34f1844af6eb2d46742e1329a", "url": "https://github.com/apache/storm/commit/036e9b37dadc7ca34f1844af6eb2d46742e1329a", "message": "[STORM-3684] use real compId instead of constant _system for receive-queue V2 metrics", "committedDate": "2020-08-05T05:52:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc1NDk4MQ==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465754981", "bodyText": "I would change mkReceiveQueueMap method to include taskToComponent parameter to make this relationship more obvious  (and then we can remove the comment)", "author": "Ethanlm", "createdAt": "2020-08-05T14:10:13Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -186,6 +186,9 @@ public WorkerState(Map<String, Object> conf,\n         this.isWorkerActive = new CountDownLatch(1);\n         this.isTopologyActive = new AtomicBoolean(false);\n         this.stormComponentToDebug = new AtomicReference<>();\n+        this.topology = ConfigUtils.readSupervisorTopology(conf, topologyId, AdvancedFSOps.make(conf));\n+        this.taskToComponent = StormCommon.stormTaskInfo(topology, topologyConf);\n+        // mkReceiveQueueMap relies on taskToComponent which relies on topology above", "originalCommit": "036e9b37dadc7ca34f1844af6eb2d46742e1329a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxNjQ4Nw==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465816487", "bodyText": "SUre", "author": "RuiLi8080", "createdAt": "2020-08-05T15:34:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc1NDk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc1NjkzOA==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465756938", "bodyText": "I would  use SYSTEM_TASK_ID instead of -1", "author": "Ethanlm", "createdAt": "2020-08-05T14:13:03Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -717,11 +719,19 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n \n         IWaitStrategy backPressureWaitStrategy = IWaitStrategy.createBackPressureWaitStrategy(topologyConf);\n         Map<List<Long>, JCQueue> receiveQueueMap = new HashMap<>();\n+\n         for (List<Long> executor : executors) {\n             List<Integer> taskIds = StormCommon.executorIdToTasks(executor);\n+            int taskId = taskIds.get(0);\n+            String compId;\n+            if (taskId == -1) {", "originalCommit": "036e9b37dadc7ca34f1844af6eb2d46742e1329a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgxNjQxOA==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465816418", "bodyText": "Yes, updated", "author": "RuiLi8080", "createdAt": "2020-08-05T15:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc1NjkzOA=="}], "type": "inlineReview"}, {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "url": "https://github.com/apache/storm/commit/bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "message": "address comments", "committedDate": "2020-08-05T15:15:26Z", "type": "commit"}, {"oid": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "url": "https://github.com/apache/storm/commit/bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "message": "address comments", "committedDate": "2020-08-05T15:15:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg1MTk2Mg==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465851962", "bodyText": "Should StormCommon.stormTaskInfo() be addressing this mapping?", "author": "agresch", "createdAt": "2020-08-05T16:28:14Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -717,11 +718,19 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n \n         IWaitStrategy backPressureWaitStrategy = IWaitStrategy.createBackPressureWaitStrategy(topologyConf);\n         Map<List<Long>, JCQueue> receiveQueueMap = new HashMap<>();\n+\n         for (List<Long> executor : executors) {\n             List<Integer> taskIds = StormCommon.executorIdToTasks(executor);\n+            int taskId = taskIds.get(0);\n+            String compId;\n+            if (taskId == Constants.SYSTEM_TASK_ID) {\n+                compId = Constants.SYSTEM_COMPONENT_ID;", "originalCommit": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NDcyMQ==", "url": "https://github.com/apache/storm/pull/3320#discussion_r465864721", "bodyText": "StormCommon.stormTaskInfoImpl() address taskID starting from 1.\nWorkerState.readWorkerExecutors() additionally add Constants.SYSTEM_EXECUTOR_ID (-1) before reading from assignment. This system executor is not present in taskToComponent map.", "author": "RuiLi8080", "createdAt": "2020-08-05T16:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg1MTk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzMzIyNA==", "url": "https://github.com/apache/storm/pull/3320#discussion_r466033224", "bodyText": "nit: space", "author": "Ethanlm", "createdAt": "2020-08-05T22:11:56Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -704,7 +704,8 @@ private Assignment getLocalAssignment(IStormClusterState stormClusterState, Stri\n         }\n     }\n \n-    private Map<List<Long>, JCQueue> mkReceiveQueueMap(Map<String, Object> topologyConf, Set<List<Long>> executors) {\n+    private Map<List<Long>, JCQueue> mkReceiveQueueMap(Map<String, Object> topologyConf,\n+                                                       Set<List<Long>> executors,  Map<Integer, String> taskToComponent) {", "originalCommit": "bf68fa20c95177ff8abe2af6444f6ef4c7777db3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ5NTEwMw==", "url": "https://github.com/apache/storm/pull/3320#discussion_r466495103", "bodyText": "updated", "author": "RuiLi8080", "createdAt": "2020-08-06T15:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzMzIyNA=="}], "type": "inlineReview"}, {"oid": "dbe511a7dbd047524c23167fe8011412b2a9637d", "url": "https://github.com/apache/storm/commit/dbe511a7dbd047524c23167fe8011412b2a9637d", "message": "fix space", "committedDate": "2020-08-06T15:15:12Z", "type": "commit"}]}