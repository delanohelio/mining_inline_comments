{"pr_number": 3302, "pr_title": "[STORM-3666] Validate component name in rebalance command", "pr_createdAt": "2020-07-03T11:19:09Z", "pr_url": "https://github.com/apache/storm/pull/3302", "timeline": [{"oid": "8ac15a02d73232c569e68d392afd59cdd798038f", "url": "https://github.com/apache/storm/commit/8ac15a02d73232c569e68d392afd59cdd798038f", "message": "[STORM-3666] Fix help text for storm.py rebalance --executor option.", "committedDate": "2020-07-03T08:39:19Z", "type": "commit"}, {"oid": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7", "url": "https://github.com/apache/storm/commit/c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7", "message": "[STORM-3666] validate component names in rebalance --executor option.", "committedDate": "2020-07-03T11:06:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTAzMg==", "url": "https://github.com/apache/storm/pull/3302#discussion_r450405032", "bodyText": "This seems redundant", "author": "Ethanlm", "createdAt": "2020-07-06T18:28:07Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -2676,6 +2676,14 @@ private void assertTopoActive(String topoName, boolean expectActive) throws NotA\n         return tryReadTopoConf(topoId, topoCache);\n     }\n \n+    private StormTopology tryReadTopologyFromName(final String topoName) throws NotAliveException,\n+            AuthorizationException, IOException {\n+        IStormClusterState state = stormClusterState;", "originalCommit": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyNTc0NQ==", "url": "https://github.com/apache/storm/pull/3302#discussion_r450425745", "bodyText": "Indeed. But looks like this idiom is widely used in Nimbus.", "author": "bipinprasad", "createdAt": "2020-07-06T19:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTM4MA==", "url": "https://github.com/apache/storm/pull/3302#discussion_r450405380", "bodyText": "This feels more like a IllegalArgumentException?", "author": "Ethanlm", "createdAt": "2020-07-06T18:28:50Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {\n+                    throw new WrappedInvalidTopologyException(String.format(\"Component %s does not exist in topology %s\", comp, topoName));", "originalCommit": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTkzOQ==", "url": "https://github.com/apache/storm/pull/3302#discussion_r450405939", "bodyText": "I noticed below is using WrappedInvalidTopologyException too. So that's fine.", "author": "Ethanlm", "createdAt": "2020-07-06T18:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNTM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA==", "url": "https://github.com/apache/storm/pull/3302#discussion_r450407478", "bodyText": "What does rebalance do with system components like acker and metricConsumers?\nWill users be able to rebalance those?", "author": "Ethanlm", "createdAt": "2020-07-06T18:32:58Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3370,8 +3378,18 @@ public void rebalance(String topoName, RebalanceOptions options)\n             checkAuthorization(topoName, topoConf, operation);\n             // Set principal in RebalanceOptions to nil because users are not suppose to set this\n             options.set_principal(null);\n+            // check if executor counts are correctly specified\n+            StormTopology stormTopology = tryReadTopologyFromName(topoName);\n+            Set<String> comps = new HashSet<>();\n+            comps.addAll(stormTopology.get_spouts().keySet());\n+            comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n-            for (Integer value : execOverrides.values()) {\n+            for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n+                String comp = e.getKey();\n+                Integer value = e.getValue();\n+                if (!comps.contains(comp)) {", "originalCommit": "c9ddff4ebf06fbc1a77b325cdf0e4e738f3b02d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyODA4OQ==", "url": "https://github.com/apache/storm/pull/3302#discussion_r450428089", "bodyText": "This check will preclude rebalancing system components.", "author": "bipinprasad", "createdAt": "2020-07-06T19:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwNjk4NA==", "url": "https://github.com/apache/storm/pull/3302#discussion_r450506984", "bodyText": "We need to be able to rebalance system components.", "author": "Ethanlm", "createdAt": "2020-07-06T22:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3OTQwOQ==", "url": "https://github.com/apache/storm/pull/3302#discussion_r451779409", "bodyText": "Changed to allow system components.", "author": "bipinprasad", "createdAt": "2020-07-08T19:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwNzQ3OA=="}], "type": "inlineReview"}, {"oid": "45e433bde9f72eb678d09f886f5e71bfd5c4d4b8", "url": "https://github.com/apache/storm/commit/45e433bde9f72eb678d09f886f5e71bfd5c4d4b8", "message": "[STORM-3659] Rename long option name in python to be same as that passed through to java as --executor", "committedDate": "2020-07-06T21:30:26Z", "type": "commit"}, {"oid": "7c551f819742e6abb432bd32a7e6af4ae3f94962", "url": "https://github.com/apache/storm/commit/7c551f819742e6abb432bd32a7e6af4ae3f94962", "message": "[STORM-3666] Allow system components to be rebalanced.", "committedDate": "2020-07-08T19:30:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQyMDc0OQ==", "url": "https://github.com/apache/storm/pull/3302#discussion_r452420749", "bodyText": "Maybe we can follow the code at https://github.com/apache/storm/blob/master/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java#L2638-L2639 to get all the components?\nOr maybe use stormBase to avoid recomputation.\nhttps://github.com/apache/storm/blob/master/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java#L1808\nNot sure if there is any concern with using it without testing. Maybe there are some corner cases that need to be taken care of.", "author": "Ethanlm", "createdAt": "2020-07-09T18:48:13Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -3380,16 +3381,21 @@ public void rebalance(String topoName, RebalanceOptions options)\n             options.set_principal(null);\n             // check if executor counts are correctly specified\n             StormTopology stormTopology = tryReadTopologyFromName(topoName);\n-            Set<String> comps = new HashSet<>();\n+            Set<String> comps = new TreeSet<>();\n             comps.addAll(stormTopology.get_spouts().keySet());\n             comps.addAll(stormTopology.get_bolts().keySet());\n             Map<String, Integer> execOverrides = options.is_set_num_executors() ? options.get_num_executors() : Collections.emptyMap();\n             for (Map.Entry<String, Integer> e: execOverrides.entrySet()) {\n                 String comp = e.getKey();\n-                Integer value = e.getValue();\n-                if (!comps.contains(comp)) {\n-                    throw new WrappedInvalidTopologyException(String.format(\"Component %s does not exist in topology %s\", comp, topoName));\n+                // validate non-system component ids\n+                if (!Utils.isSystemId(comp) && !comps.contains(comp)) {", "originalCommit": "7c551f819742e6abb432bd32a7e6af4ae3f94962", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI3NzY2OQ==", "url": "https://github.com/apache/storm/pull/3302#discussion_r467277669", "bodyText": "Never mind. I think it is okay to not check system components for now.", "author": "Ethanlm", "createdAt": "2020-08-07T21:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQyMDc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDQwOA==", "url": "https://github.com/apache/storm/pull/3302#discussion_r452430408", "bodyText": "can be replaced by https://github.com/apache/storm/blob/master/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java#L1793-L1796", "author": "Ethanlm", "createdAt": "2020-07-09T19:06:22Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java", "diffHunk": "@@ -2676,6 +2677,14 @@ private void assertTopoActive(String topoName, boolean expectActive) throws NotA\n         return tryReadTopoConf(topoId, topoCache);\n     }\n \n+    private StormTopology tryReadTopologyFromName(final String topoName) throws NotAliveException,\n+            AuthorizationException, IOException {\n+        IStormClusterState state = stormClusterState;\n+        String topoId = state.getTopoId(topoName)", "originalCommit": "7c551f819742e6abb432bd32a7e6af4ae3f94962", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY0OTc4MA==", "url": "https://github.com/apache/storm/pull/3302#discussion_r489649780", "bodyText": "Replaced.", "author": "bipinprasad", "createdAt": "2020-09-16T18:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQzMDQwOA=="}], "type": "inlineReview"}, {"oid": "34d5a97467f12971edb980e0f8533aa7be66a12d", "url": "https://github.com/apache/storm/commit/34d5a97467f12971edb980e0f8533aa7be66a12d", "message": "[STORM-3666] Use toTopoId() method.", "committedDate": "2020-09-16T18:35:04Z", "type": "commit"}]}