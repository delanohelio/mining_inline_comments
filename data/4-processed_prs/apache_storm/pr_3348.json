{"pr_number": 3348, "pr_title": "[STORM-3711] Fix ARM CI with wrong usage of \"arm64-graviton2\" resources", "pr_createdAt": "2020-11-09T09:12:19Z", "pr_url": "https://github.com/apache/storm/pull/3348", "timeline": [{"oid": "b1452deebeb042a611a7e0bbde5b01ddda0ff1f1", "url": "https://github.com/apache/storm/commit/b1452deebeb042a611a7e0bbde5b01ddda0ff1f1", "message": "Fix the integration tests job failure", "committedDate": "2020-11-19T09:48:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxMTkyNQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r539411925", "bodyText": "The default dist configured above we use is trusty. Should we upgrade the default dist to focal? (it can be a separate work)", "author": "Ethanlm", "createdAt": "2020-12-09T15:39:04Z", "path": ".travis.yml", "diffHunk": "@@ -41,6 +40,48 @@ matrix:\n   include:\n     - arch: s390x\n       jdk: openjdk11\n+    - dist: focal", "originalCommit": "b1452deebeb042a611a7e0bbde5b01ddda0ff1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg4MTYwNQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r539881605", "bodyText": "Currently, the \"arm64-graviton2\" resources are only available in Xenial, Bonic, Focal dists of Ubuntu, please see the Travis doc\uff0c I just picked a lastest version.", "author": "liusheng", "createdAt": "2020-12-10T06:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxMTkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1NjkwNA==", "url": "https://github.com/apache/storm/pull/3348#discussion_r540256904", "bodyText": "Yeah, I was thinking maybe we can simply this by updating \n  \n    \n      storm/.travis.yml\n    \n    \n         Line 28\n      in\n      fe2f710\n    \n    \n    \n    \n\n        \n          \n           dist: trusty", "author": "Ethanlm", "createdAt": "2020-12-10T15:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxMTkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5MzMzOQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r543093339", "bodyText": "OK, let's me try", "author": "liusheng", "createdAt": "2020-12-15T06:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxMTkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNDc3NA==", "url": "https://github.com/apache/storm/pull/3348#discussion_r539414774", "bodyText": "Is it possible to use arm64 directly?\nhttps://docs.travis-ci.com/user/reference/overview/#linux-travisyml-examples", "author": "Ethanlm", "createdAt": "2020-12-09T15:42:15Z", "path": ".travis.yml", "diffHunk": "@@ -41,6 +40,48 @@ matrix:\n   include:\n     - arch: s390x\n       jdk: openjdk11\n+    - dist: focal\n+      group: edge\n+      arch: arm64-graviton2", "originalCommit": "b1452deebeb042a611a7e0bbde5b01ddda0ff1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg4MTU5MA==", "url": "https://github.com/apache/storm/pull/3348#discussion_r539881590", "bodyText": "Hmm,  we have tried using the common arm64 resources, but many modules(especially Integration-Test) are unstable and easy to fail. the new added arm64-graviton is anounced a better performance ARM resources, so switch to use it.\nMaybe we can try back to use the arm64 resources as we have migrated from travis-ci.org to travis-ci.com to see if the problems still occur.", "author": "liusheng", "createdAt": "2020-12-10T06:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNDc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI1ODY2Mw==", "url": "https://github.com/apache/storm/pull/3348#discussion_r540258663", "bodyText": "Can you link to the announcement? It looks like they all should work as indicated in the https://docs.travis-ci.com/user/reference/overview/#linux-travisyml-examples and I don't see performance concerns.\nThe arm64 configuration seems more clean and simple", "author": "Ethanlm", "createdAt": "2020-12-10T15:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNDc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDQzNQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r543094435", "bodyText": "There is not annoucement, just be cause I have tested many times, the ARM CI jobs are very easy to fail due to timeout errors previously. I have tested again in the PR #3361, it looks like now the common arm64 resource is OK to run the ARM CI job :), so let's switch to use the arm64 resources", "author": "liusheng", "createdAt": "2020-12-15T07:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNDc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyMDA4OQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r539420089", "bodyText": "What does group mean here?", "author": "Ethanlm", "createdAt": "2020-12-09T15:48:04Z", "path": ".travis.yml", "diffHunk": "@@ -41,6 +40,48 @@ matrix:\n   include:\n     - arch: s390x\n       jdk: openjdk11\n+    - dist: focal\n+      group: edge", "originalCommit": "b1452deebeb042a611a7e0bbde5b01ddda0ff1f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg4MTU1Nw==", "url": "https://github.com/apache/storm/pull/3348#discussion_r539881557", "bodyText": "sorry, this is unnecessary, my mistake.", "author": "liusheng", "createdAt": "2020-12-10T06:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyMDA4OQ=="}], "type": "inlineReview"}, {"oid": "4338557ef6a5eb0da083508eec0b05ba5518f5cc", "url": "https://github.com/apache/storm/commit/4338557ef6a5eb0da083508eec0b05ba5518f5cc", "message": "Fix ARM CI with wrong usage of \"arm64-graviton2\" resources\n\nIn # apache/storm/pull/3344, we have enabled ARM CI with all Storm\nmodules enabled and switched to use the \"arm64-graviton2\" resources, but\nI have made a mistak that the ARM CI actually still run on x86 than\nARM even the CI job shows the label \"arm64-graviton2\", details can be\nfound in the CI job logs[1]. Because the \"arm64-graviton2\" requires\nexplicit virt: [lxd|vm] tag, see[2].\n\nAddtionally, we have skip the increasing swap space statement in\nintergration test because it will raise error on ARM. And we only\nenabled openjdk11 for ARM jobs because the jdk8 is unsupported, see[3].\n\n[1] https://travis-ci.org/github/apache/storm/jobs/741780900\n[2] https://docs.travis-ci.com/user/multi-cpu-architectures#testing-on-multiple-cpu-architectures\n[3] https://travis-ci.com/github/liusheng/storm/jobs/430934514", "committedDate": "2020-12-15T07:06:15Z", "type": "commit"}, {"oid": "5e8b544e4cb7b18d260d9ba87aff9ff6d1d73b1b", "url": "https://github.com/apache/storm/commit/5e8b544e4cb7b18d260d9ba87aff9ff6d1d73b1b", "message": "Fix the integration tests job failure", "committedDate": "2020-12-15T07:06:15Z", "type": "commit"}, {"oid": "9446eb2b6cdc6c443e87246cf56991f17d4767f1", "url": "https://github.com/apache/storm/commit/9446eb2b6cdc6c443e87246cf56991f17d4767f1", "message": "Switch to use Ubuntu Xenial for running x86 and ARM64 CI", "committedDate": "2020-12-15T07:09:06Z", "type": "commit"}, {"oid": "9446eb2b6cdc6c443e87246cf56991f17d4767f1", "url": "https://github.com/apache/storm/commit/9446eb2b6cdc6c443e87246cf56991f17d4767f1", "message": "Switch to use Ubuntu Xenial for running x86 and ARM64 CI", "committedDate": "2020-12-15T07:09:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MjM3NQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r543452375", "bodyText": "Is this change still needed after the change to arm64 and xenial", "author": "Ethanlm", "createdAt": "2020-12-15T15:37:27Z", "path": "integration-test/run-it.sh", "diffHunk": "@@ -36,10 +36,13 @@ then\n   chmod o+rx /home/travis\n fi\n list_storm_processes || true\n-# increasing swap space so we can run lots of workers\n-sudo dd if=/dev/zero of=/swapfile.img bs=4096 count=1M\n-sudo mkswap /swapfile.img\n-sudo swapon /swapfile.img\n+if [ \"$(uname -m)\" != aarch64 ]; then", "originalCommit": "9446eb2b6cdc6c443e87246cf56991f17d4767f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDAwOTE2OQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r544009169", "bodyText": "yes, there still have problems of swap support on Travis ARM64 resources, you can take a look the error:\nhttps://travis-ci.com/github/apache/storm/jobs/460842259", "author": "liusheng", "createdAt": "2020-12-16T06:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MjM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3NDIxMw==", "url": "https://github.com/apache/storm/pull/3348#discussion_r544374213", "bodyText": "Thanks for validating.\nFor future reference, the log is\n+sudo dd if=/dev/zero of=/swapfile.img bs=4096 count=1M\n1048576+0 records in\n1048576+0 records out\n4294967296 bytes (4.3 GB, 4.0 GiB) copied, 27.2215 s, 158 MB/s\n+sudo mkswap /swapfile.img\nSetting up swapspace version 1, size = 4 GiB (4294963200 bytes)\nno label, UUID=ba655d1c-230e-4feb-a06a-e342c114d7eb\n+sudo swapon /swapfile.img\nswapon: /swapfile.img: insecure permissions 0644, 0600 suggested.\nswapon: /swapfile.img: skipping - it appears to have holes.\nThe command \"if [[ $(uname -m) != 's390x' ]]; then /bin/bash ./dev-tools/travis/travis-script.sh `pwd` $MODULES; fi\" exited with 255.", "author": "Ethanlm", "createdAt": "2020-12-16T15:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MjM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MjU0MA==", "url": "https://github.com/apache/storm/pull/3348#discussion_r543452540", "bodyText": "Is this change still needed after the change to arm64 and xenial", "author": "Ethanlm", "createdAt": "2020-12-15T15:37:38Z", "path": "integration-test/run-it.sh", "diffHunk": "@@ -101,3 +104,7 @@ for i in {1..20} ; do\n done\n list_storm_processes\n mvn test -DfailIfNoTests=false -DskipTests=false -Dstorm.version=${STORM_VERSION} -Dui.url=http://localhost:8744\n+\n+# Kill all storm processes after tests running, otherwise the Travis CI(ARM) will still wait and then fail by\n+# timeout error even though all the tests passed\n+sudo pkill -9 -u storm", "originalCommit": "9446eb2b6cdc6c443e87246cf56991f17d4767f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3ODE1OQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r544378159", "bodyText": "Saw this in your test job  https://travis-ci.com/github/apache/storm/jobs/460903786\nNo output has been received in the last 10m0s, this potentially indicates a stalled build or something wrong with the build itself.\nCheck the details on how to adjust your build configuration on: https://docs.travis-ci.com/user/common-build-problems/#build-times-out-because-no-output-was-received\nThe build has been terminated\n\nIs this what you saw before?", "author": "Ethanlm", "createdAt": "2020-12-16T15:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MjU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczOTUzOQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r544739539", "bodyText": "yes, I have tried again in #3361, you can take a look the CI logs: https://travis-ci.com/github/apache/storm/jobs/460903786\nat the end of the log, even all the intgration tests ran sucessfully, but the job didn't exit immediately and then failed due to timeout.\n0.11s$ rm -rf $HOME/.m2/repository/org/apache/storm\ncache.2\nstore build cache\nDone. Your build exited with 0.\nNo output has been received in the last 10m0s, this potentially indicates a stalled build or something wrong with the build itself.\nCheck the details on how to adjust your build configuration on: https://docs.travis-ci.com/user/common-build-problems/#build-times-out-because-no-output-was-received\nThe build has been terminated", "author": "liusheng", "createdAt": "2020-12-17T01:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MjU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2Nzk1OQ==", "url": "https://github.com/apache/storm/pull/3348#discussion_r544767959", "bodyText": "Thanks", "author": "Ethanlm", "createdAt": "2020-12-17T02:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ1MjU0MA=="}], "type": "inlineReview"}]}