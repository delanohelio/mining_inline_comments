{"pr_number": 3249, "pr_title": "[STORM-3624] Fix race condition when loading scheduler configs", "pr_createdAt": "2020-04-15T21:46:54Z", "pr_url": "https://github.com/apache/storm/pull/3249", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMzA5Mw==", "url": "https://github.com/apache/storm/pull/3249#discussion_r409403093", "bodyText": "Will this terminate the currently running process?", "author": "bipinprasad", "createdAt": "2020-04-16T09:11:30Z", "path": "storm-server/src/main/java/org/apache/storm/scheduler/utils/SchedulerConfigRefresher.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.scheduler.utils;\n+\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.apache.storm.DaemonConfig;\n+import org.apache.storm.StormTimer;\n+import org.apache.storm.utils.ObjectReader;\n+import org.apache.storm.utils.Utils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class SchedulerConfigRefresher<T> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(SchedulerConfigRefresher.class);\n+\n+    private final StormTimer configRefreshTimer;\n+    private AtomicReference<T> schedulerConfigAtomicReference;\n+    private final Reloadable<T> reloader;\n+    private final Map<String, Object> conf;\n+\n+    public SchedulerConfigRefresher(Map<String, Object> conf, Reloadable<T> reloader) {\n+        configRefreshTimer = new StormTimer(\"scheduler-config-refresher\", (t, e) -> {\n+            LOG.error(\"Error while refreshing scheduler config\", e);\n+            Utils.exitProcess(20, \"Error while refreshing scheduler config\");", "originalCommit": "4cfe6bfa2decd26d86f66fda377c0ac50bde02f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU4NjkwOQ==", "url": "https://github.com/apache/storm/pull/3249#discussion_r409586909", "bodyText": "If this thread has any errors, yes.", "author": "Ethanlm", "createdAt": "2020-04-16T14:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQwMzA5Mw=="}], "type": "inlineReview"}, {"oid": "c200be6ae3065a70d143aceefbdcb68a33e37038", "url": "https://github.com/apache/storm/commit/c200be6ae3065a70d143aceefbdcb68a33e37038", "message": "[STORM-3624] Spawn a SchedulerConfigRefresher thread to reload scheduler configs periodically", "committedDate": "2020-04-16T14:09:21Z", "type": "forcePushed"}, {"oid": "4f179cc549dbb8a81797ea4e2fbd0ee252bd29b5", "url": "https://github.com/apache/storm/commit/4f179cc549dbb8a81797ea4e2fbd0ee252bd29b5", "message": "[STORM-3624] Spawn a SchedulerConfigRefresher thread to reload scheduler configs periodically", "committedDate": "2020-04-16T18:00:57Z", "type": "commit"}, {"oid": "0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "url": "https://github.com/apache/storm/commit/0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "message": "[STORM-3624] refresh the cache when schedule() is called instead of spawning a new thread", "committedDate": "2020-04-16T18:02:01Z", "type": "commit"}, {"oid": "0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "url": "https://github.com/apache/storm/commit/0bd449bb8bdae3e01c2300860fbb18c6b8130ef3", "message": "[STORM-3624] refresh the cache when schedule() is called instead of spawning a new thread", "committedDate": "2020-04-16T18:02:01Z", "type": "forcePushed"}, {"oid": "d8d3914585d2e1a634a4006da447dcb950434089", "url": "https://github.com/apache/storm/commit/d8d3914585d2e1a634a4006da447dcb950434089", "message": "[STORM-3624] fix unit test because of SimulatedTime being used", "committedDate": "2020-04-16T19:41:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMzkxMw==", "url": "https://github.com/apache/storm/pull/3249#discussion_r409813913", "bodyText": "Since SchedulerConfigCache is now just a wrapper around loadConfig() method, can the class be removed and loadConfig() be called directly at the beginning of schedule?", "author": "bipinprasad", "createdAt": "2020-04-16T19:59:16Z", "path": "storm-server/src/main/java/org/apache/storm/scheduler/multitenant/MultitenantScheduler.java", "diffHunk": "@@ -30,20 +32,22 @@\n     private static final Logger LOG = LoggerFactory.getLogger(MultitenantScheduler.class);\n     protected IConfigLoader configLoader;\n     private Map<String, Object> conf;\n+    private SchedulerConfigCache<Map<String, Number>> schedulerConfigCache;\n \n     @Override\n     public void prepare(Map<String, Object> conf, StormMetricsRegistry metricsRegistry) {\n         this.conf = conf;\n         configLoader = ConfigLoaderFactoryService.createConfigLoader(conf);\n-\n+        schedulerConfigCache = new SchedulerConfigCache<>(conf, this::loadConfig);", "originalCommit": "d8d3914585d2e1a634a4006da447dcb950434089", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjQ3MQ==", "url": "https://github.com/apache/storm/pull/3249#discussion_r409816471", "bodyText": "There are currently two schedulers (ResourceAwareScheduler, MultitenantScheduler) need to have this logic (caching/refreshing). And maybe in the future a new scheduler or other existing schedulers will want to have configs too.  I keep this class to wrap the logic and to avoid repeat the code in schedulers.", "author": "Ethanlm", "createdAt": "2020-04-16T20:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMzkxMw=="}], "type": "inlineReview"}, {"oid": "a48e96c48624e6aa30b323c5423e35cec473ac2f", "url": "https://github.com/apache/storm/commit/a48e96c48624e6aa30b323c5423e35cec473ac2f", "message": "[STORM-3624] fix unit test because of SimulatedTime being used", "committedDate": "2020-04-16T20:05:27Z", "type": "commit"}, {"oid": "a48e96c48624e6aa30b323c5423e35cec473ac2f", "url": "https://github.com/apache/storm/commit/a48e96c48624e6aa30b323c5423e35cec473ac2f", "message": "[STORM-3624] fix unit test because of SimulatedTime being used", "committedDate": "2020-04-16T20:05:27Z", "type": "forcePushed"}]}