{"pr_number": 3365, "pr_title": "STORM-3727 handle long values for SUPERVISOR_SLOTS_PORTS", "pr_createdAt": "2020-12-21T20:16:40Z", "pr_url": "https://github.com/apache/storm/pull/3365", "timeline": [{"oid": "2ca1bb40b9acd3dcb4eb4cf6fc6e84e34c1ec3e4", "url": "https://github.com/apache/storm/commit/2ca1bb40b9acd3dcb4eb4cf6fc6e84e34c1ec3e4", "message": "STORM-3727 handle long values for SUPERVISOR_SLOTS_PORTS", "committedDate": "2020-12-21T20:14:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk0NDY5Ng==", "url": "https://github.com/apache/storm/pull/3365#discussion_r546944696", "bodyText": "This would may involve rounding or truncation which isn't really what we wanted.\nA port by definition is no larger than 65535. So logically it will be Integers.\nThere is an Integer check here \n  \n    \n      storm/storm-server/src/main/java/org/apache/storm/DaemonConfig.java\n    \n    \n        Lines 742 to 743\n      in\n      6e37072\n    \n    \n    \n    \n\n        \n          \n           @IsListEntryCustom(entryValidatorClasses = { ConfigValidation.IntegerValidator.class, ConfigValidation.PositiveNumberValidator.class }) \n        \n\n        \n          \n           public static final String SUPERVISOR_SLOTS_PORTS = \"supervisor.slots.ports\"; \n        \n    \n  \n\n. Not sure why it was not properly enforced.", "author": "Ethanlm", "createdAt": "2020-12-21T21:44:09Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/supervisor/SupervisorUtils.java", "diffHunk": "@@ -92,8 +92,13 @@ public static String getNumaIdForPort(Integer port, Map<String, Object> supervis\n     }\n \n     public static List<Integer> getSlotsPorts(Map<String, Object> supervisorConf) {\n-        List<Integer> slotsPorts = (List<Integer>) supervisorConf.getOrDefault(DaemonConfig.SUPERVISOR_SLOTS_PORTS,\n+        List<Integer> slotsPorts = new ArrayList<>();\n+        List<Number> ports = (List<Number>) supervisorConf.getOrDefault(DaemonConfig.SUPERVISOR_SLOTS_PORTS,\n                 new ArrayList<>());\n+        for (Number port : ports) {\n+            slotsPorts.add(port.intValue());", "originalCommit": "2ca1bb40b9acd3dcb4eb4cf6fc6e84e34c1ec3e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk1MTkzMg==", "url": "https://github.com/apache/storm/pull/3365#discussion_r546951932", "bodyText": "This is similar to how the code used to be (see https://github.com/apache/storm/blame/69e69d40d5c700465b49f4c23312f974fb2ca1f6/storm-server/src/main/java/org/apache/storm/daemon/supervisor/ReadClusterState.java#L101-L103) before this change: https://github.com/apache/storm/pull/3267/files", "author": "agresch", "createdAt": "2020-12-21T22:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk0NDY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk2OTQ4NQ==", "url": "https://github.com/apache/storm/pull/3365#discussion_r546969485", "bodyText": "How do we reproduce this?\nI changed the port to be a value larger than Integer.MAX_VALUE, the supervisor fails to start\n2020-12-21 22:50:47.009 o.a.s.v.ConfigValidation main [INFO] Will use [class org.apache.storm.DaemonConfig, class org.apache.storm.Config] for validation\n2020-12-21 22:50:47.250 o.a.s.u.Utils main [ERROR] Received error in thread main.. terminating server...\njava.lang.Error: java.lang.IllegalArgumentException: Field SUPERVISOR_SLOTS_PORTS list entry must be an Integer within type range.\n        at org.apache.storm.utils.Utils.handleUncaughtException(Utils.java:664) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.utils.Utils.handleUncaughtException(Utils.java:668) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.utils.Utils.lambda$createDefaultUncaughtExceptionHandler$2(Utils.java:1048) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at java.lang.ThreadGroup.uncaughtException(ThreadGroup.java:1057) [?:1.8.0_262]\n        at java.lang.ThreadGroup.uncaughtException(ThreadGroup.java:1052) [?:1.8.0_262]\n        at java.lang.Thread.dispatchUncaughtException(Thread.java:1959) [?:1.8.0_262]\nCaused by: java.lang.IllegalArgumentException: Field SUPERVISOR_SLOTS_PORTS list entry must be an Integer within type range.\n        at org.apache.storm.validation.ConfigValidation$IntegerValidator.validateInteger(ConfigValidation.java:415) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.validation.ConfigValidation$IntegerValidator.validateField(ConfigValidation.java:401) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.validation.ConfigValidation$ListEntryCustomValidator.validateField(ConfigValidation.java:588) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.validation.ConfigValidation$ListEntryCustomValidator.validateField(ConfigValidation.java:602) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.validation.ConfigValidation.validateField(ConfigValidation.java:167) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.validation.ConfigValidation.validateFields(ConfigValidation.java:215) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.validation.ConfigValidation.validateFields(ConfigValidation.java:189) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.utils.ConfigUtils.readStormConfigImpl(ConfigUtils.java:440) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.utils.ConfigUtils.readStormConfig(ConfigUtils.java:166) ~[storm-client-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.daemon.supervisor.Supervisor.<init>(Supervisor.java:126) ~[storm-server-2.3.0.y.jar:2.3.0-SNAPSHOT]\n        at org.apache.storm.daemon.supervisor.Supervisor.main(Supervisor.java:200) ~[storm-server-2.3.0.y.jar:2.3.0-SNAPSHOT]", "author": "Ethanlm", "createdAt": "2020-12-21T22:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk0NDY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ3MzUxNA==", "url": "https://github.com/apache/storm/pull/3365#discussion_r549473514", "bodyText": "Without this change:\n./bin/storm supervisor -c supervisor.slots.ports=\"[6700]\"\n2020-12-28 14:06:38.860 o.a.s.d.s.Supervisor main [ERROR] Failed to start supervisor\njava.lang.ClassCastException: java.lang.Long cannot be cast to java.lang.Integer\nat org.apache.storm.daemon.supervisor.ReadClusterState.(ReadClusterState.java:101) ~[storm-server-2.3.0-SNAPSHOT.jar:2.3.0-SNAPSHOT]\nat org.apache.storm.daemon.supervisor.Supervisor.launch(Supervisor.java:310) ~[storm-server-2.3.0-SNAPSHOT.jar:2.3.0-SNAPSHOT]\nat org.apache.storm.daemon.supervisor.Supervisor.launchDaemon(Supervisor.java:340) [storm-server-2.3.0-SNAPSHOT.jar:2.3.0-SNAPSHOT]\nat org.apache.storm.daemon.supervisor.Supervisor.main(Supervisor.java:201) [storm-server-2.3.0-SNAPSHOT.jar:2.3.0-SNAPSHOT]", "author": "agresch", "createdAt": "2020-12-28T20:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk0NDY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA0MTU2Mg==", "url": "https://github.com/apache/storm/pull/3365#discussion_r552041562", "bodyText": "Thanks", "author": "Ethanlm", "createdAt": "2021-01-05T16:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk0NDY5Ng=="}], "type": "inlineReview"}]}