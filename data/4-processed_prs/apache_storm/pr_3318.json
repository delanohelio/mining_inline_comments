{"pr_number": 3318, "pr_title": "[STORM-3670] Separate configurations for daemon metric reporters and topology metrics reporters", "pr_createdAt": "2020-08-04T02:51:56Z", "pr_url": "https://github.com/apache/storm/pull/3318", "timeline": [{"oid": "b7241c55f68b8fbf18f089a1f4349f79163109f2", "url": "https://github.com/apache/storm/commit/b7241c55f68b8fbf18f089a1f4349f79163109f2", "message": "[STORM-3670] Separate configurations for daemon metric reporters and topology metrics reporters", "committedDate": "2020-08-04T02:40:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwMzMxMw==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465103313", "bodyText": "I don't see the value in adding the version, I would just remove it.", "author": "agresch", "createdAt": "2020-08-04T14:41:52Z", "path": "docs/metrics_v2.md", "diffHunk": "@@ -72,7 +72,7 @@ public class TupleCountingBolt extends BaseRichBolt {\n  For metrics to be useful they must be *reported*, in other words sent somewhere where they can be consumed and analyzed.\n  That can be as simple as writing them to a log file, sending them to a time series database, or exposing them via JMX.\n  \n- As of Storm 1.2.0 the following metric reporters are supported\n+Since Storm 1.2.0, the following metric reporters are supported", "originalCommit": "b7241c55f68b8fbf18f089a1f4349f79163109f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEyOTQzMw==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465129433", "bodyText": "will do", "author": "Ethanlm", "createdAt": "2020-08-04T15:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwMzMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNTE5MQ==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465105191", "bodyText": "Should these be deprecated if only for backwards compatibility?", "author": "agresch", "createdAt": "2020-08-04T14:44:34Z", "path": "storm-client/src/jvm/org/apache/storm/Config.java", "diffHunk": "@@ -1731,21 +1744,28 @@\n     @IsInteger\n     @IsPositiveNumber\n     public static final String WORKER_BLOB_UPDATE_POLL_INTERVAL_SECS = \"worker.blob.update.poll.interval.secs\";\n+\n     /**\n-     * A specify Locale for daemon metrics reporter plugin. Use the specified IETF BCP 47 language tag string for a Locale.\n+     * Specify the Locale for daemon metrics reporter plugin. Use the specified IETF BCP 47 language tag string for a Locale.\n+     * This config should have been placed in the DaemonConfig class. Keeping it here only for backwards compatibility.\n      */\n     @IsString\n     public static final String STORM_DAEMON_METRICS_REPORTER_PLUGIN_LOCALE = \"storm.daemon.metrics.reporter.plugin.locale\";\n+\n     /**\n-     * A specify rate-unit in TimeUnit to specify reporting frequency for daemon metrics reporter plugin.\n+     * Specify the rate unit in TimeUnit for daemon metrics reporter plugin.\n+     * This config should have been placed in the DaemonConfig class. Keeping it here only for backwards compatibility.\n      */\n     @IsString\n     public static final String STORM_DAEMON_METRICS_REPORTER_PLUGIN_RATE_UNIT = \"storm.daemon.metrics.reporter.plugin.rate.unit\";\n+\n     /**\n-     * A specify duration-unit in TimeUnit to specify reporting window for daemon metrics reporter plugin.\n+     * Specify the duration unit in TimeUnit for daemon metrics reporter plugin.\n+     * This config should have been placed in the DaemonConfig class. Keeping it here only for backwards compatibility.", "originalCommit": "b7241c55f68b8fbf18f089a1f4349f79163109f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEyOTM0NA==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465129344", "bodyText": "We need these configs. But they should sit in DaemonConfig class. I can't simply move it because if any topology invokes it directly, and if we move it and upgrade the cluster, I am afraid that this topology will have ClassNotFoundException.\nI thought about duplicating these configs in DaemonConfig and \"deprecate\" these in Config. I wasn't sure if it is a good idea since it adds two identical sets of configs.\nPlease let me know what your thoughts are", "author": "Ethanlm", "createdAt": "2020-08-04T15:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE2MTA3NQ==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465161075", "bodyText": "I see.  Ideally I probably would duplicate and deprecate these for future removal or file a JIRA to do this another day.", "author": "agresch", "createdAt": "2020-08-04T16:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4NDAyMw==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465184023", "bodyText": "I can make the change", "author": "Ethanlm", "createdAt": "2020-08-04T16:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNTE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3Njg4NA==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465276884", "bodyText": "I reverted the change because nimbus_test.clj is complaining.\nCaused by: java.lang.IllegalStateException: STORM-DAEMON-METRICS-REPORTER-PLUGIN-DURATION-UNIT already refers to: #'org.apache.storm.daemon-config/STORM-DAEMON-METRICS-REPORTER-PLUGIN-DURATION-UNIT in namespace: org.apache.storm.nimbus-test\n\nWill file a JIRA to deal with that once this PR is merged.", "author": "Ethanlm", "createdAt": "2020-08-04T19:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNTE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNzcxOA==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465107718", "bodyText": "Can you add a javadoc indicating why this is a conf vs the others being reporterConf?  Is this a backwards compatibility thing?", "author": "agresch", "createdAt": "2020-08-04T14:47:52Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/metrics/ClientMetricsUtils.java", "diffHunk": "@@ -20,26 +20,31 @@\n \n public class ClientMetricsUtils {\n \n-    public static TimeUnit getMetricsRateUnit(Map<String, Object> topoConf) {\n-        return getTimeUnitForCofig(topoConf, Config.STORM_DAEMON_METRICS_REPORTER_PLUGIN_RATE_UNIT);\n+    private static final String RATE_UNIT = \"rate.unit\";\n+    private static final String DURATION_UNIT = \"duration.unit\";\n+    // Use the specified IETF BCP 47 language tag string for a Locale\n+    private static final String LOCALE = \"locale\";\n+\n+    public static TimeUnit getMetricsRateUnit(Map<String, Object> reporterConf) {\n+        return getTimeUnitForConfig(reporterConf, RATE_UNIT);\n     }\n \n-    public static TimeUnit getMetricsDurationUnit(Map<String, Object> topoConf) {\n-        return getTimeUnitForCofig(topoConf, Config.STORM_DAEMON_METRICS_REPORTER_PLUGIN_DURATION_UNIT);\n+    public static TimeUnit getMetricsDurationUnit(Map<String, Object> reporterConf) {\n+        return getTimeUnitForConfig(reporterConf, DURATION_UNIT);\n     }\n \n-    public static Locale getMetricsReporterLocale(Map<String, Object> topoConf) {\n-        String languageTag = ObjectReader.getString(topoConf.get(Config.STORM_DAEMON_METRICS_REPORTER_PLUGIN_LOCALE), null);\n+    public static Locale getMetricsReporterLocale(Map<String, Object> reporterConf) {\n+        String languageTag = ObjectReader.getString(reporterConf.get(LOCALE), null);\n         if (languageTag != null) {\n             return Locale.forLanguageTag(languageTag);\n         }\n         return null;\n     }\n \n-    private static TimeUnit getTimeUnitForCofig(Map<String, Object> topoConf, String configName) {\n-        String rateUnitString = ObjectReader.getString(topoConf.get(configName), null);\n-        if (rateUnitString != null) {\n-            return TimeUnit.valueOf(rateUnitString);\n+    public static TimeUnit getTimeUnitForConfig(Map<String, Object> conf, String configName) {", "originalCommit": "b7241c55f68b8fbf18f089a1f4349f79163109f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEyNjM5Mg==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465126392", "bodyText": "I can change it to reporterConf for clarity. I make it conf because this is actually a general function so it can be any conf.", "author": "Ethanlm", "createdAt": "2020-08-04T15:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEwNzcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTExMzg2Mg==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465113862", "bodyText": "Unrelated to this PR, but it seems odd this is a metrics util thing rather than belonging to the CSV reporter class.", "author": "agresch", "createdAt": "2020-08-04T14:56:21Z", "path": "storm-server/src/main/java/org/apache/storm/daemon/metrics/MetricsUtils.java", "diffHunk": "@@ -58,10 +61,11 @@ private static PreparableReporter getPreparableReporter(String clazz) {\n         return reporter;\n     }\n \n-    public static File getCsvLogDir(Map<String, Object> topoConf) {\n-        String csvMetricsLogDirectory = ObjectReader.getString(topoConf.get(DaemonConfig.STORM_DAEMON_METRICS_REPORTER_CSV_LOG_DIR), null);\n+    public static File getCsvLogDir(Map<String, Object> daemonConf) {", "originalCommit": "b7241c55f68b8fbf18f089a1f4349f79163109f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTEyNTY4Mw==", "url": "https://github.com/apache/storm/pull/3318#discussion_r465125683", "bodyText": "Yeah, but for compatibility, I can't simply move it. If any topology invokes it directly, and if we move it and upgrade the cluster, this old topology will have ClassNotFoundException.", "author": "Ethanlm", "createdAt": "2020-08-04T15:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTExMzg2Mg=="}], "type": "inlineReview"}, {"oid": "c5c73726a19b22db9c2bd180ea06f3a5663c798a", "url": "https://github.com/apache/storm/commit/c5c73726a19b22db9c2bd180ea06f3a5663c798a", "message": "[STORM-3670] address review comments", "committedDate": "2020-08-04T15:24:29Z", "type": "commit"}, {"oid": "c5c73726a19b22db9c2bd180ea06f3a5663c798a", "url": "https://github.com/apache/storm/commit/c5c73726a19b22db9c2bd180ea06f3a5663c798a", "message": "[STORM-3670] address review comments", "committedDate": "2020-08-04T15:24:29Z", "type": "forcePushed"}, {"oid": "2345dba77d7721db63a283395518db4a4b15aa12", "url": "https://github.com/apache/storm/commit/2345dba77d7721db63a283395518db4a4b15aa12", "message": "[STORM-3670] more comments", "committedDate": "2020-08-04T19:29:15Z", "type": "commit"}]}