{"pr_number": 6587, "pr_title": "feat: DHIS2-9835 user info in comments and notes for Events and Enrollments", "pr_createdAt": "2020-11-06T11:30:43Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6587", "timeline": [{"oid": "2424c196f203e192002bde27133b13a720644e38", "url": "https://github.com/dhis2/dhis2-core/commit/2424c196f203e192002bde27133b13a720644e38", "message": "feat: user info in comments and notes for ProgramInstance and ProgramStageInstance", "committedDate": "2020-11-06T11:28:52Z", "type": "commit"}, {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "url": "https://github.com/dhis2/dhis2-core/commit/8d4c422557ad39161f6a38baba964c11ac8dbd46", "message": "refactor: renamed ProgramStageInstanceUserInfo to UserInfoSnapshot - some formatting", "committedDate": "2020-11-06T11:28:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzMDQzNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519630436", "bodyText": "minor: since this query looks like is only for events, I would rename to PSI_EVENT_QUERY or something like this", "author": "luciano-fiandesio", "createdAt": "2020-11-09T08:32:15Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "diffHunk": "@@ -147,6 +145,27 @@\n @Repository( \"org.hisp.dhis.dxf2.events.event.EventStore\" )\n public class JdbcEventStore implements EventStore\n {\n+\n+    private static final String COMMENT_QUERY =", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkyMDc2Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519920766", "bodyText": "this one is the sub-query for comments, so I'll rename to PSI_EVENT_COMMENT_QUERY", "author": "gnespolino", "createdAt": "2020-11-09T15:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzMDQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNDQ4MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519634481", "bodyText": "Please, remove the additional spaces", "author": "luciano-fiandesio", "createdAt": "2020-11-09T08:39:35Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "diffHunk": "@@ -147,6 +145,27 @@\n @Repository( \"org.hisp.dhis.dxf2.events.event.EventStore\" )\n public class JdbcEventStore implements EventStore\n {\n+\n+    private static final String COMMENT_QUERY =\n+        \"select psic.programstageinstanceid    as psic_id,\" +\n+        \"                           psinote.trackedentitycommentid as psinote_id,\" +", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkxNzAzOQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519917039", "bodyText": "it was to make it more readable, however I'll remove it", "author": "gnespolino", "createdAt": "2020-11-09T15:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNDQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNTI4NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519635285", "bodyText": "This is more like a general issue for all these lastUpdated, created etc. fields: shall we instead use default values at the DB level? What do you think?", "author": "luciano-fiandesio", "createdAt": "2020-11-09T08:40:55Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/converter/NotesConverterService.java", "diffHunk": "@@ -68,8 +69,9 @@ public TrackedEntityComment from( TrackerPreheat preheat, Note note )\n         comment.setAutoFields();\n         comment.setCommentText( note.getValue() );\n \n-        // FIXME: what about the storedBy and lastUpdatedBy -> currently they are set to\n-        // null\n+        comment.setLastUpdatedBy( preheat.getUser() );\n+        comment.setLastUpdated( new Date() );", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkxODM2Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519918362", "bodyText": "yes probably it would be much better to have them out of the box, either by default value in DB or default values during instance creation.", "author": "gnespolino", "createdAt": "2020-11-09T15:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNTI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNzcxNw==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519637717", "bodyText": "Let's add some Javadoc so it's clear what's the intent of this class.", "author": "luciano-fiandesio", "createdAt": "2020-11-09T08:44:53Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/UserInfoSnapshot.java", "diffHunk": "@@ -41,7 +43,7 @@\n \n @NoArgsConstructor", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczNzgwMg==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519737802", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static UserInfoSnapshot of(long id, String code, String uid, String username, String firstName, String surname )\n          \n          \n            \n                public static UserInfoSnapshot of( long id, String code, String uid, String username, String firstName, String surname )", "author": "stian-sandvold", "createdAt": "2020-11-09T11:27:11Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/UserInfoSnapshot.java", "diffHunk": "@@ -93,13 +95,29 @@ public void setSurname( String surname )\n         this.surname = surname;\n     }\n \n-    public static ProgramStageInstanceUserInfo from( User user )\n+    public static UserInfoSnapshot from(User user )\n+    {\n+        return Optional.ofNullable(user)\n+                .map(UserInfoSnapshot::toUserInfoSnapshot)\n+                .orElse(null);\n+    }\n+\n+    private static UserInfoSnapshot toUserInfoSnapshot( User user )\n     {\n-        ProgramStageInstanceUserInfo eventUserInfo = new ProgramStageInstanceUserInfo( user.getUsername(),\n+        UserInfoSnapshot eventUserInfo = new UserInfoSnapshot( user.getUsername(),\n             user.getFirstName(), user.getSurname() );\n         eventUserInfo.setId( user.getId() );\n         eventUserInfo.setCode( user.getCode() );\n         eventUserInfo.setUid( user.getUid() );\n         return eventUserInfo;\n     }\n+\n+    public static UserInfoSnapshot of(long id, String code, String uid, String username, String firstName, String surname )", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczODM4Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519738382", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static PGobject userInfoToJson(UserInfoSnapshot userInfo, ObjectMapper mapper )\n          \n          \n            \n                public static PGobject userInfoToJson( UserInfoSnapshot userInfo, ObjectMapper mapper )", "author": "stian-sandvold", "createdAt": "2020-11-09T11:28:13Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/EventUtils.java", "diffHunk": "@@ -191,27 +191,27 @@ else if ( attributeValues instanceof PGobject )\n     }\n \n     @SneakyThrows\n-    public static PGobject userInfoToJson( ProgramStageInstanceUserInfo userInfo, ObjectMapper mapper )\n+    public static PGobject userInfoToJson(UserInfoSnapshot userInfo, ObjectMapper mapper )", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczODQ1MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519738451", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static UserInfoSnapshot jsonToUserInfo(String userInfoAsString, ObjectMapper mapper )\n          \n          \n            \n                public static UserInfoSnapshot jsonToUserInfo( String userInfoAsString, ObjectMapper mapper )", "author": "stian-sandvold", "createdAt": "2020-11-09T11:28:21Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/EventUtils.java", "diffHunk": "@@ -191,27 +191,27 @@ else if ( attributeValues instanceof PGobject )\n     }\n \n     @SneakyThrows\n-    public static PGobject userInfoToJson( ProgramStageInstanceUserInfo userInfo, ObjectMapper mapper )\n+    public static PGobject userInfoToJson(UserInfoSnapshot userInfo, ObjectMapper mapper )\n     {\n         PGobject jsonbObj = new PGobject();\n         jsonbObj.setType( \"json\" );\n         jsonbObj.setValue( mapper.writeValueAsString( userInfo ) );\n         return jsonbObj;\n     }\n \n-    public static ProgramStageInstanceUserInfo jsonToUserInfo( String userInfoAsString, ObjectMapper mapper )\n+    public static UserInfoSnapshot jsonToUserInfo(String userInfoAsString, ObjectMapper mapper )", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczOTA5OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519739099", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected void updateDataValueUserInfo(EventDataValue dataValue, UserInfoSnapshot userInfo )\n          \n          \n            \n                protected void updateDataValueUserInfo( EventDataValue dataValue, UserInfoSnapshot userInfo )", "author": "stian-sandvold", "createdAt": "2020-11-09T11:29:30Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/importer/update/preprocess/UserInfoUpdatePreProcessor.java", "diffHunk": "@@ -32,19 +32,19 @@\n import org.hisp.dhis.dxf2.events.event.Event;\n import org.hisp.dhis.dxf2.events.importer.shared.preprocess.AbstractUserInfoPreProcessor;\n import org.hisp.dhis.eventdatavalue.EventDataValue;\n-import org.hisp.dhis.program.ProgramStageInstanceUserInfo;\n+import org.hisp.dhis.program.UserInfoSnapshot;\n \n public class UserInfoUpdatePreProcessor extends AbstractUserInfoPreProcessor\n {\n \n     @Override\n-    protected void updateDataValueUserInfo(EventDataValue dataValue, ProgramStageInstanceUserInfo userInfo )\n+    protected void updateDataValueUserInfo(EventDataValue dataValue, UserInfoSnapshot userInfo )", "originalCommit": "8d4c422557ad39161f6a38baba964c11ac8dbd46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e89a8f67ed1990eab30b4190467269af11396e0d", "url": "https://github.com/dhis2/dhis2-core/commit/e89a8f67ed1990eab30b4190467269af11396e0d", "message": "fix: DHIS-9835 - peer review - minor formatting", "committedDate": "2020-11-09T16:04:36Z", "type": "commit"}]}