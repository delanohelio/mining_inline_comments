{"pr_number": 6569, "pr_title": "fix: (2.35) Lazy issue in audit service", "pr_createdAt": "2020-11-04T15:26:40Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6569", "timeline": [{"oid": "5949d8ebe228ff8dd582f066d4d920e0daa460aa", "url": "https://github.com/dhis2/dhis2-core/commit/5949d8ebe228ff8dd582f066d4d920e0daa460aa", "message": "fix: lazy issue in audit service", "committedDate": "2020-11-04T12:42:46Z", "type": "commit"}, {"oid": "3a9dbb5453f38da68e92f871fb7d2ee4b41328bb", "url": "https://github.com/dhis2/dhis2-core/commit/3a9dbb5453f38da68e92f871fb7d2ee4b41328bb", "message": "fix merge error", "committedDate": "2020-11-04T12:43:28Z", "type": "commit"}, {"oid": "27ed7a4b2621c423b2517fb11e80f05590f1448d", "url": "https://github.com/dhis2/dhis2-core/commit/27ed7a4b2621c423b2517fb11e80f05590f1448d", "message": "fix: hibernate lazy exception in audit service", "committedDate": "2020-11-04T12:43:31Z", "type": "commit"}, {"oid": "6c53c91992b7755ba690b2fbb8414da38d35c996", "url": "https://github.com/dhis2/dhis2-core/commit/6c53c91992b7755ba690b2fbb8414da38d35c996", "message": "fix: hibernate lazy exception in audit service", "committedDate": "2020-11-04T13:35:37Z", "type": "commit"}, {"oid": "ab3ef0f965a22ff8e9d436109a900083f23264ba", "url": "https://github.com/dhis2/dhis2-core/commit/ab3ef0f965a22ff8e9d436109a900083f23264ba", "message": "clean up code", "committedDate": "2020-11-04T13:35:54Z", "type": "commit"}, {"oid": "1d29195198ee0b2cd899dbc5d4a60cfd0f4161de", "url": "https://github.com/dhis2/dhis2-core/commit/1d29195198ee0b2cd899dbc5d4a60cfd0f4161de", "message": "clean up codes", "committedDate": "2020-11-04T13:35:54Z", "type": "commit"}, {"oid": "f605e383ec44dd1348f1529bdf2602492e6c61ad", "url": "https://github.com/dhis2/dhis2-core/commit/f605e383ec44dd1348f1529bdf2602492e6c61ad", "message": "clean up code and add test", "committedDate": "2020-11-04T13:35:54Z", "type": "commit"}, {"oid": "3759d091cd122c00f0ee1be326855573fc46ac85", "url": "https://github.com/dhis2/dhis2-core/commit/3759d091cd122c00f0ee1be326855573fc46ac85", "message": "fix: eventDataValue is blank for audit entry", "committedDate": "2020-11-04T13:35:54Z", "type": "commit"}, {"oid": "510fa32c095b59e00d4a3c50ad5d29b163cae923", "url": "https://github.com/dhis2/dhis2-core/commit/510fa32c095b59e00d4a3c50ad5d29b163cae923", "message": "add license", "committedDate": "2020-11-04T13:35:54Z", "type": "commit"}, {"oid": "2498849bd235ed40e592e9e3839f065afb1062a9", "url": "https://github.com/dhis2/dhis2-core/commit/2498849bd235ed40e592e9e3839f065afb1062a9", "message": "fix NPE in AbstractHibernateListener", "committedDate": "2020-11-04T15:25:37Z", "type": "commit"}, {"oid": "4901abb65d7876e2b67218b8224906da80c8c2c9", "url": "https://github.com/dhis2/dhis2-core/commit/4901abb65d7876e2b67218b8224906da80c8c2c9", "message": "fix merge conflict", "committedDate": "2020-11-04T16:12:37Z", "type": "commit"}, {"oid": "24b1e4f4de0a56654f4dbb39e536ede65fbdecc5", "url": "https://github.com/dhis2/dhis2-core/commit/24b1e4f4de0a56654f4dbb39e536ede65fbdecc5", "message": "Fix unit test error", "committedDate": "2020-11-05T11:21:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0ODk2NA==", "url": "https://github.com/dhis2/dhis2-core/pull/6569#discussion_r519748964", "bodyText": "I asked the same in @zubaira 's PR; Why are we using Object, and not Map (as commented) or Serializable?", "author": "stian-sandvold", "createdAt": "2020-11-09T11:47:37Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditableEntity.java", "diffHunk": "@@ -38,5 +38,19 @@\n @AllArgsConstructor\n public class AuditableEntity\n {\n-    private Object entity;\n+    /**\n+     * Class of the AuditableEntity\n+     * It will be used by {@link org.hisp.dhis.artemis.audit.legacy.AuditObjectFactory#collectAuditAttributes(Object)}\n+     */\n+    Class entityClass;\n+\n+    /**\n+     * An object that is ready for serialized by Jackson.\n+     * Means that this object should:\n+     * 1. Only includes referenced properties that are owned by the current Audit Entity. Means that the property's schema has attribute \"owner = true\"\n+     * 2. Do not include any lazy HibernateProxy or PersistentCollection that is not loaded.\n+     * 3. All referenced properties that extend BaseIdentifiableObject should be mapped to only UID string\n+     * This object could be a Map<String, Object>  with key is property name and value is the property value\n+     */\n+    Object serializableObject;", "originalCommit": "4901abb65d7876e2b67218b8224906da80c8c2c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc4Mjg5NA==", "url": "https://github.com/dhis2/dhis2-core/pull/6569#discussion_r519782894", "bodyText": "Map would make more sense as this  serializableObject is almost always Map.", "author": "zubaira", "createdAt": "2020-11-09T12:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0ODk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1NzU4OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6569#discussion_r521157589", "bodyText": "@stian-sandvold  @zubaira In some other places of the code some one could call AuditManager.send() and pass in any Java object.\nThis object will be serialized by objectMapper.writeValueAsString(Object value) which accepts any Java Object and serializes it to a String.\nI'm thinking of making another createAuditEntry funtion in another service where we have the object and session still open. So in that function we don't need to create HibernateProxy or open new session, just need to create an auditable object with correct format. With that , we can ensure to only use Map/Serializable for audit.", "author": "vietnguyen", "createdAt": "2020-11-11T07:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0ODk2NA=="}], "type": "inlineReview"}, {"oid": "0b9abb1fab291eedd7aae91334100f9e2b23f0e7", "url": "https://github.com/dhis2/dhis2-core/commit/0b9abb1fab291eedd7aae91334100f9e2b23f0e7", "message": "fix: support serialize embeddedObject for audit (#6579)\n\n* fix: support serialize embeddedObject for audit\n\n* fix: save audit attributes for non-owner properties", "committedDate": "2020-11-11T08:11:38Z", "type": "commit"}, {"oid": "f52886aca596bbd63fa7c3b7205d9d8b89ea5c1b", "url": "https://github.com/dhis2/dhis2-core/commit/f52886aca596bbd63fa7c3b7205d9d8b89ea5c1b", "message": "fix: api test error", "committedDate": "2020-11-11T08:13:24Z", "type": "commit"}, {"oid": "747e23eae812958f1e273596105cd7340e0e03f3", "url": "https://github.com/dhis2/dhis2-core/commit/747e23eae812958f1e273596105cd7340e0e03f3", "message": "fix; api test error", "committedDate": "2020-11-11T08:13:24Z", "type": "commit"}, {"oid": "10063ef7885e682b546a272665c75bbdaf4eea42", "url": "https://github.com/dhis2/dhis2-core/commit/10063ef7885e682b546a272665c75bbdaf4eea42", "message": "fix: unit test error", "committedDate": "2020-11-11T08:13:24Z", "type": "commit"}, {"oid": "3e91adc350bb07f9d74745489841b764654d01dd", "url": "https://github.com/dhis2/dhis2-core/commit/3e91adc350bb07f9d74745489841b764654d01dd", "message": "fix: api test error", "committedDate": "2020-11-11T08:13:24Z", "type": "commit"}, {"oid": "2e0f1646cc69c640917836338d95b3b334384a81", "url": "https://github.com/dhis2/dhis2-core/commit/2e0f1646cc69c640917836338d95b3b334384a81", "message": "fix: ConcurrentModificationException", "committedDate": "2020-11-11T08:13:24Z", "type": "commit"}, {"oid": "1c98aedd2345856f25e4e7a26d6a1f3ab6cbfea0", "url": "https://github.com/dhis2/dhis2-core/commit/1c98aedd2345856f25e4e7a26d6a1f3ab6cbfea0", "message": "test: adds skipCache param to event import", "committedDate": "2020-11-11T08:13:25Z", "type": "commit"}, {"oid": "f3cffcbca39db8ea49812e5776a489b38099ae09", "url": "https://github.com/dhis2/dhis2-core/commit/f3cffcbca39db8ea49812e5776a489b38099ae09", "message": "clean up code", "committedDate": "2020-11-11T08:13:25Z", "type": "commit"}, {"oid": "b05f7c598d68f07ff2dfe15a18ade486100783d0", "url": "https://github.com/dhis2/dhis2-core/commit/b05f7c598d68f07ff2dfe15a18ade486100783d0", "message": "fix: serialize embedded object for audit", "committedDate": "2020-11-12T05:52:42Z", "type": "commit"}]}