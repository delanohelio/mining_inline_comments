{"pr_number": 4673, "pr_title": "fix: Use Program Indicators to validate orgUnitField", "pr_createdAt": "2020-01-06T16:27:54Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/4673", "timeline": [{"oid": "7f68a3bb966413976e2286925d53107ce23bf262", "url": "https://github.com/dhis2/dhis2-core/commit/7f68a3bb966413976e2286925d53107ce23bf262", "message": "fix: use Prg. Indicators to validate orgUnitField\n\n- DHIS2-7552\n- When validating the orgUnitField value the system now takes in\nconsideration the event that a Program may be null and also checks for\nProgram Indicators. If the EventQueryParams contains Program Indicators,\nthe system runs the same validation against all the Programs associated\nto the Program Indicators. If at least one fails, the entire validation\nfails.", "committedDate": "2020-01-06T16:27:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE4NDIxNw==", "url": "https://github.com/dhis2/dhis2-core/pull/4673#discussion_r364184217", "bodyText": "Since \"if at least one Program Indicator doesn't validate, we fail the validation\", could instead of checking all program indicators just break when we find one program indicator that does not validate?\n(It is needless to check all if we fail at the first false).\nInstead of using arrays we can also rewrite using a stream and anyMatch with a predicate.", "author": "larshelge", "createdAt": "2020-01-08T11:24:57Z", "path": "dhis-2/dhis-services/dhis-service-analytics/src/main/java/org/hisp/dhis/analytics/event/EventQueryParams.java", "diffHunk": "@@ -500,6 +503,33 @@ public boolean orgUnitFieldIsValid()\n             return true;\n         }\n \n+        if ( program != null )\n+        {\n+            return validateProgramHasOrgUnitField( program );\n+        }\n+\n+        if ( !itemProgramIndicators.isEmpty() )\n+        {\n+            boolean[] isValidated = new boolean[itemProgramIndicators.size()];\n+\n+            for ( int i = 0; i < itemProgramIndicators.size(); i++ )\n+            {\n+                ProgramIndicator itemProgramIndicator = itemProgramIndicators.get( i );\n+                Program program = itemProgramIndicator.getProgram();\n+\n+                isValidated[i] = validateProgramHasOrgUnitField( program );\n+\n+            }\n+            // if at least one Program Indicator doesn't validate, fail the validation\n+            return !Booleans.contains( isValidated, false );", "originalCommit": "7f68a3bb966413976e2286925d53107ce23bf262", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE4NjQxNw==", "url": "https://github.com/dhis2/dhis2-core/pull/4673#discussion_r364186417", "bodyText": "yes, absolutely. Is the logic ok, though? I kind of made it up myself. For instance, if all the PI fails shall we considering falling back to the reporting unit?", "author": "luciano-fiandesio", "createdAt": "2020-01-08T11:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE4NDIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5NDg2Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/4673#discussion_r364194866", "bodyText": "Simplified the logic  using stream.anyMatch", "author": "luciano-fiandesio", "createdAt": "2020-01-08T11:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE4NDIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMwMzkyNA==", "url": "https://github.com/dhis2/dhis2-core/pull/4673#discussion_r364303924", "bodyText": "I think the logic makes sense.", "author": "larshelge", "createdAt": "2020-01-08T15:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE4NDIxNw=="}], "type": "inlineReview"}, {"oid": "e84d405937078d7d8cae561bca2c75392e04c425", "url": "https://github.com/dhis2/dhis2-core/commit/e84d405937078d7d8cae561bca2c75392e04c425", "message": "chore: minor refactoring", "committedDate": "2020-01-08T11:52:27Z", "type": "commit"}, {"oid": "beb9acdb92908a79715df88ba4ea78a3fca107f1", "url": "https://github.com/dhis2/dhis2-core/commit/beb9acdb92908a79715df88ba4ea78a3fca107f1", "message": "Update EventQueryParams.java", "committedDate": "2020-01-08T15:53:54Z", "type": "commit"}]}