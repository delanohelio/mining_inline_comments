{"pr_number": 5631, "pr_title": "fix: Indicator filter expression validation", "pr_createdAt": "2020-05-21T10:12:14Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5631", "timeline": [{"oid": "f15d3a3d9f4d13efb2cdc61ef2a4fcbdcd77470c", "url": "https://github.com/dhis2/dhis2-core/commit/f15d3a3d9f4d13efb2cdc61ef2a4fcbdcd77470c", "message": "fix: ProgramIndicator filter expression validation", "committedDate": "2020-05-21T10:09:30Z", "type": "commit"}, {"oid": "7f8d1e430a2f3ebc42dcaf864558120e98258b42", "url": "https://github.com/dhis2/dhis2-core/commit/7f8d1e430a2f3ebc42dcaf864558120e98258b42", "message": "remove comments", "committedDate": "2020-05-21T10:11:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA1NTkyOA==", "url": "https://github.com/dhis2/dhis2-core/pull/5631#discussion_r429055928", "bodyText": "Could you explain the logic here, i.e. we always return the default?", "author": "larshelge", "createdAt": "2020-05-22T05:55:24Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/function/D2HasValue.java", "diffHunk": "@@ -44,7 +45,9 @@\n     @Override\n     public Object getDescription( ExprContext ctx, CommonExpressionVisitor visitor )\n     {\n-        return getProgramArgType( ctx ).getDescription( ctx, visitor );\n+        getProgramArgType( ctx ).getDescription( ctx, visitor );\n+\n+        return DEFAULT_BOOLEAN_VALUE;", "originalCommit": "7f8d1e430a2f3ebc42dcaf864558120e98258b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2ODYyNA==", "url": "https://github.com/dhis2/dhis2-core/pull/5631#discussion_r429068624", "bodyText": "getDescription() function is being used for expression validation and the way it works is all the variables and d2 function are replaced by default values and then the expression is evaluated.", "author": "zubaira", "createdAt": "2020-05-22T06:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA1NTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2OTk1MA==", "url": "https://github.com/dhis2/dhis2-core/pull/5631#discussion_r429069950", "bodyText": "@jimgrace ?", "author": "zubaira", "createdAt": "2020-05-22T06:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA1NTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2ODQ3OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5631#discussion_r429268479", "bodyText": "Zubair's fix looks right to me. The getDescription() method builds a Map of string substitutions to turn an expression into an expression description, for example replace \"#{fbfJHSPpUQD}\" with \"ANC 1st visit\". But what the method returns is a dummy value so the overall expression can be syntax-checked.\nThe ANTLR parsing methods include some type checking. So for example, the first argument to an if() function should be boolean, as in if( test, valueIfTrue, valueIfFalse ). A program indicator filter should also evaluate to a boolean. The D2:HasValue() function should always return a dummy boolean. It was incorrectly trying to return the datatype of the value it was testing.", "author": "jimgrace", "createdAt": "2020-05-22T14:08:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA1NTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg3NzQ4Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/5631#discussion_r430877486", "bodyText": "Thanks for the feedback.", "author": "larshelge", "createdAt": "2020-05-27T06:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA1NTkyOA=="}], "type": "inlineReview"}, {"oid": "5c121facec9201ad3e5fc2c1d38b4a546097960b", "url": "https://github.com/dhis2/dhis2-core/commit/5c121facec9201ad3e5fc2c1d38b4a546097960b", "message": "add unit tests", "committedDate": "2020-05-22T07:41:20Z", "type": "commit"}, {"oid": "6cc793d9aac509cd06749d47627e042ecc3e76a1", "url": "https://github.com/dhis2/dhis2-core/commit/6cc793d9aac509cd06749d47627e042ecc3e76a1", "message": "add tests for different value types", "committedDate": "2020-05-22T07:49:45Z", "type": "commit"}]}