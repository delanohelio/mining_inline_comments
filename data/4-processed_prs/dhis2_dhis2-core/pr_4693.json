{"pr_number": 4693, "pr_title": "feat: Audit Matrix to control auditing", "pr_createdAt": "2020-01-10T12:51:52Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/4693", "timeline": [{"oid": "a68345a935313005cf5e51b07013c091bf708015", "url": "https://github.com/dhis2/dhis2-core/commit/a68345a935313005cf5e51b07013c091bf708015", "message": "chore: formatting", "committedDate": "2020-01-12T09:11:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTMzNw==", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365641337", "bodyText": "Do we still need this?", "author": "mortenoh", "createdAt": "2020-01-13T03:56:34Z", "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/legacy/MetadataAuditConsumer.java", "diffHunk": "@@ -67,7 +67,6 @@ public MetadataAuditConsumer(\n         this.auditService = auditService;\n         this.objectMapper = objectMapper;\n \n-        // TODO remove and replace with Audit Configuration Grid (ACG)\n         this.metadataAuditPersist = Objects.equals( dhisConfig.getProperty( ConfigurationKey.METADATA_AUDIT_PERSIST ), \"on\" );", "originalCommit": "a68345a935313005cf5e51b07013c091bf708015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY4OTgwNg==", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365689806", "bodyText": "Removed", "author": "luciano-fiandesio", "createdAt": "2020-01-13T08:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTU0OA==", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365641548", "bodyText": "Why are we replacing the existing JsonPOJOBuilder approach here? then we don't need to manually add all the properties etc in the JsonCreator", "author": "mortenoh", "createdAt": "2020-01-13T03:58:49Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/Audit.java", "diffHunk": "@@ -80,6 +82,49 @@\n     @JsonProperty\n     private Object data;\n \n+    @JsonIgnore\n+    private AuditableEntity auditableEntity;\n+\n+    /**\n+     * This constructor is used to create an instance of Audit using the 'Builder'\n+     * pattern This should be used by a service that needs to create a new Audit\n+     * entry\n+     */\n+    @Builder( builderClassName = \"AuditBuilder\" )", "originalCommit": "a68345a935313005cf5e51b07013c091bf708015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0Nzc4NA==", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365747784", "bodyText": "Yes, so this is the general idea:\nIf you look at the Audit class, now it contains a new property:\n@JsonIgnore\nprivate AuditableEntity auditableEntity;\n\nThis new property is used to \"delay\" the serialization of the entity to the AuditManager.\nThis property is meant to be used only by a Builder that is actually constructing the object (for instance all the Hibernate listeners).\nThe other property:\n@JsonProperty\n private Object data;\n\nis meant to be used in a constructor only by Jackson.\nSo, my idea was to \"hide\" the .data(...) property of the Builder (because, effectively it should not be used) by adding the first constructor.\nThe second constructor (the one annotated with @JsonCreator and using the data attribute) is only supposed to be used by Jackson.\nI'll remove both constructors, but we just need to be sure that the .data(..) property is not used (unless you know another way, using Jackson +  Lombok)", "author": "luciano-fiandesio", "createdAt": "2020-01-13T11:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4NDQ2Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r366084467", "bodyText": "Ok, I see. Yes, I think the only way to \"hide\" a field currently in a lombok builder is to manually add the builder with the fields we want (sadly this means we have to add new properties in two places).\nCould we make the setter private? with something like @Setter(AccessLevel.PRIVATE) private Object data or maybe we still need it to be public in some places?", "author": "mortenoh", "createdAt": "2020-01-13T23:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTY2Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365641662", "bodyText": "Maybe cleaner to do !auditMatrix.isEnabled(audit) and log/return out if not enabled? so we don't have this extra level of indenting", "author": "mortenoh", "createdAt": "2020-01-13T03:59:53Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditManager.java", "diffHunk": "@@ -37,34 +40,54 @@\n  * @author Morten Olav Hansen <mortenoh@gmail.com>\n  */\n @Component\n+@Slf4j\n public class AuditManager\n {\n     private final AuditProducerSupplier auditProducerSupplier;\n     private final AuditProducerConfiguration config;\n     private final AuditScheduler auditScheduler;\n+    private final AuditMatrix auditMatrix;\n+\n+    private final AuditObjectFactory objectFactory;\n \n     public AuditManager(\n         AuditProducerSupplier auditProducerSupplier,\n         AuditScheduler auditScheduler,\n-        AuditProducerConfiguration config )\n+        AuditProducerConfiguration config,\n+        AuditMatrix auditMatrix, AuditObjectFactory auditObjectFactory )\n     {\n         checkNotNull( auditProducerSupplier );\n         checkNotNull( config );\n+        checkNotNull( auditMatrix );\n+        checkNotNull( auditObjectFactory );\n \n         this.auditProducerSupplier = auditProducerSupplier;\n         this.config = config;\n         this.auditScheduler = auditScheduler;\n+        this.auditMatrix = auditMatrix;\n+        this.objectFactory = auditObjectFactory;\n     }\n \n     public void send( Audit audit )\n     {\n-        if ( config.isUseQueue() )\n+        if ( auditMatrix.isEnabled( audit ) )", "originalCommit": "a68345a935313005cf5e51b07013c091bf708015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY5MDY2OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365690669", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-01-13T08:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTY2Mg=="}], "type": "inlineReview"}, {"oid": "8382b625bf0743c41a13476e97f7bf0d32a81eb5", "url": "https://github.com/dhis2/dhis2-core/commit/8382b625bf0743c41a13476e97f7bf0d32a81eb5", "message": "feat: Audit Matrix to control auditing\n\n(cherry picked from commit 13b6e98503f17d5155d35ef825459f582b330ca3)", "committedDate": "2020-01-15T14:22:57Z", "type": "commit"}, {"oid": "15e85655043748b73085dceee3f9b4617e5e57c4", "url": "https://github.com/dhis2/dhis2-core/commit/15e85655043748b73085dceee3f9b4617e5e57c4", "message": "chore: formatting", "committedDate": "2020-01-15T14:22:57Z", "type": "commit"}, {"oid": "fd2c72caaf71f94ea3108c9f3e58f59a3d0a1426", "url": "https://github.com/dhis2/dhis2-core/commit/fd2c72caaf71f94ea3108c9f3e58f59a3d0a1426", "message": "chore: removed boolean property to persist audit entry", "committedDate": "2020-01-15T14:22:57Z", "type": "commit"}, {"oid": "e731a79e1090f3d7f1fc10c2760c8d5143d4ad39", "url": "https://github.com/dhis2/dhis2-core/commit/e731a79e1090f3d7f1fc10c2760c8d5143d4ad39", "message": "chore: minor", "committedDate": "2020-01-15T14:22:57Z", "type": "commit"}, {"oid": "d1f22daf3f8f3f8d93582ee07211488423364ece", "url": "https://github.com/dhis2/dhis2-core/commit/d1f22daf3f8f3f8d93582ee07211488423364ece", "message": "fix: removed constructors on Audit obj", "committedDate": "2020-01-15T14:22:58Z", "type": "commit"}, {"oid": "d88817e107b91ca8ddc84b139cea003e39eec31b", "url": "https://github.com/dhis2/dhis2-core/commit/d88817e107b91ca8ddc84b139cea003e39eec31b", "message": "chore: comments + removed lombok log annotation", "committedDate": "2020-01-15T14:22:58Z", "type": "commit"}, {"oid": "5b93f30a575563a27581102c06cbb74a0fa7940d", "url": "https://github.com/dhis2/dhis2-core/commit/5b93f30a575563a27581102c06cbb74a0fa7940d", "message": "feat: property based Audit matrix", "committedDate": "2020-01-15T14:22:58Z", "type": "commit"}, {"oid": "5b93f30a575563a27581102c06cbb74a0fa7940d", "url": "https://github.com/dhis2/dhis2-core/commit/5b93f30a575563a27581102c06cbb74a0fa7940d", "message": "feat: property based Audit matrix", "committedDate": "2020-01-15T14:22:58Z", "type": "forcePushed"}, {"oid": "a2b0f33151a4208280f99a94deaa3400a1a3f587", "url": "https://github.com/dhis2/dhis2-core/commit/a2b0f33151a4208280f99a94deaa3400a1a3f587", "message": "chore: code format updates", "committedDate": "2020-01-16T03:26:28Z", "type": "commit"}, {"oid": "1f868377c2af5d7fd4f9be01dd0cfa05539a7b05", "url": "https://github.com/dhis2/dhis2-core/commit/1f868377c2af5d7fd4f9be01dd0cfa05539a7b05", "message": "chore: minor format fixes", "committedDate": "2020-01-16T03:35:22Z", "type": "commit"}, {"oid": "9dae4e8677ce804e9d1fc2e8c3806fe2579c9d59", "url": "https://github.com/dhis2/dhis2-core/commit/9dae4e8677ce804e9d1fc2e8c3806fe2579c9d59", "message": "fix: don't compress is data i s null", "committedDate": "2020-01-16T04:45:15Z", "type": "commit"}]}