{"pr_number": 6145, "pr_title": "fix: [DHIS2-9405] Avoid leaking sensitive sql messages in case of sensitive exceptions like sqlgrammarexceptions etc (master)", "pr_createdAt": "2020-09-14T07:20:29Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6145", "timeline": [{"oid": "7caa6ff6ead7f57ef4824acc04e251d6b2212722", "url": "https://github.com/dhis2/dhis2-core/commit/7caa6ff6ead7f57ef4824acc04e251d6b2212722", "message": "fix: [DHIS2-9405] Avoid leaking sensitive sql messages in case of badsqlgrammarexceptions etc", "committedDate": "2020-09-14T07:08:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyNjU4OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6145#discussion_r487726589", "bodyText": "This Advice is only applied  to MetadataSyncController and MetadataVersionController so the \"sensitive exception\" logic would not be applied to Tracker import - which I guess was the original trigger for this PR.", "author": "luciano-fiandesio", "createdAt": "2020-09-14T08:07:54Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/CrudControllerAdvice.java", "diffHunk": "@@ -84,6 +85,11 @@\n @ControllerAdvice\n public class CrudControllerAdvice", "originalCommit": "7caa6ff6ead7f57ef4824acc04e251d6b2212722", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1MzMyNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6145#discussion_r487853326", "bodyText": "I am confused now. ControllerAdvice is applied globally across all controllers unless explicitly limited correct?\nWhy do you think this only applies to those 2 controllers?\nI have also tested them on TrackedEntityInstanceController  and the exception handlers are handling the exceptions for that as well.", "author": "ameenhere", "createdAt": "2020-09-14T11:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyNjU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2NjA1MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6145#discussion_r487866051", "bodyText": "You are absolutely right:\n\nBy default, the methods in an @ControllerAdvice apply globally to all controllers\n\nI got confused by the fact that we have a couple of controllers extending CrudControllerAdvice, which, could probably be corrected.", "author": "luciano-fiandesio", "createdAt": "2020-09-14T12:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyNjU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2ODYzNA==", "url": "https://github.com/dhis2/dhis2-core/pull/6145#discussion_r487868634", "bodyText": "You  can also consider using the standard Spring exception handler approach, like so:\n@ExceptionHandler({BadSqlGrammarException.class,QueryException.class})\n  public String sensitiveErrorHandler() {\n   \n    return GENERIC_MESSAGE;\n  }", "author": "luciano-fiandesio", "createdAt": "2020-09-14T12:22:22Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/CrudControllerAdvice.java", "diffHunk": "@@ -84,6 +85,11 @@\n @ControllerAdvice\n public class CrudControllerAdvice\n {\n+    //Add sensitive exceptions into this array\n+    private static final Class<?>[] SENSITIVE_EXCEPTIONS = { BadSqlGrammarException.class, org.hibernate.QueryException.class };", "originalCommit": "7caa6ff6ead7f57ef4824acc04e251d6b2212722", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyMjE3NA==", "url": "https://github.com/dhis2/dhis2-core/pull/6145#discussion_r487922174", "bodyText": "I also wanted to handle the cases when these exceptions are nested inside other exceptions. For example CompletionException could have a nested exception  [cause] as BadSqlGrammarException. So wanted to eliminate adding extra exception handlers and then handling it separately for the nested ones.\nDoes that justify my implementation? Feel free to recommend better ways to implement this to handle both cases.", "author": "ameenhere", "createdAt": "2020-09-14T13:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2ODYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2OTgwOA==", "url": "https://github.com/dhis2/dhis2-core/pull/6145#discussion_r489269808", "bodyText": "So I double checked. Spring exception handlers does not catch \"nested exceptions\" if they are not nested by spring itself. So ideally the concrete exception that is actually thrown out the controller is what is handled.\nThe PR currently handles this and can be easily extended to include more sensitive Exceptions as and when needed by adding the exception class into the list.", "author": "ameenhere", "createdAt": "2020-09-16T08:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2ODYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI3NjEyNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6145#discussion_r489276126", "bodyText": "Got it, great that you checked. Then there is not much to discuss, your solution is the perfect approach for this case.", "author": "luciano-fiandesio", "createdAt": "2020-09-16T08:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2ODYzNA=="}], "type": "inlineReview"}, {"oid": "b812e3d817b107f661b58ffbba3cbe2b0bfd1037", "url": "https://github.com/dhis2/dhis2-core/commit/b812e3d817b107f661b58ffbba3cbe2b0bfd1037", "message": "Merge branch 'master' into DHIS2-9405-master", "committedDate": "2020-09-16T07:51:17Z", "type": "commit"}, {"oid": "aa3c42fc0d76c526a8b86b843d98043384cecb29", "url": "https://github.com/dhis2/dhis2-core/commit/aa3c42fc0d76c526a8b86b843d98043384cecb29", "message": "format", "committedDate": "2020-09-16T08:31:52Z", "type": "commit"}]}