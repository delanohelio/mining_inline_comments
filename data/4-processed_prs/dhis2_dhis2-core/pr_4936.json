{"pr_number": 4936, "pr_title": "feat: Add support for idSchemes in new tracker importer", "pr_createdAt": "2020-02-22T11:18:11Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/4936", "timeline": [{"oid": "7c0bfc6489967511005669b7c41de172a98a2785", "url": "https://github.com/dhis2/dhis2-core/commit/7c0bfc6489967511005669b7c41de172a98a2785", "message": "Add support for idSchemes in new tracker importer", "committedDate": "2020-02-22T11:17:44Z", "type": "commit"}, {"oid": "1a791d3f428adb6bd5fd5ae76f2656c57c5c3d6f", "url": "https://github.com/dhis2/dhis2-core/commit/1a791d3f428adb6bd5fd5ae76f2656c57c5c3d6f", "message": "minor cleanup", "committedDate": "2020-02-22T11:22:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEyMTc1Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r383121752", "bodyText": "Wondering it we could instead check  if property's class extends JsonBinaryType\nPeople may forget to add new JsonB type into this list.", "author": "vietnguyen", "createdAt": "2020-02-24T08:04:19Z", "path": "dhis-2/dhis-services/dhis-service-schema/src/main/java/org/hisp/dhis/schema/AbstractPropertyIntrospectorService.java", "diffHunk": "@@ -85,6 +95,18 @@\n         .put( AnalyticalObject.class, BaseAnalyticalObject.class )\n         .build();\n \n+    private static final ImmutableSet<String> JSONB_TYPE_CLASSES = ImmutableSet.<String>builder()\n+        .add( JsonBinaryType.class.getName() )\n+        .add( JsonBinaryPlainStringType.class.getName() )\n+        .add( JsonDeviceRenderTypeMap.class.getName() )\n+        .add( JsonJobParametersType.class.getName() )\n+        .add( JsonListBinaryType.class.getName() )\n+        .add( JsonSetBinaryType.class.getName() )\n+        .add( JsonEventDataValueSetBinaryType.class.getName() )\n+        .add( JsonProgramRuleEvaluationEnvironmentSetBinaryType.class.getName() )\n+        .add( JsonAttributeValueBinaryType.class.getName() )\n+        .build();\n+\n     private final Map<Class<?>, Map<String, Property>> classMapCache = new HashMap<>();", "originalCommit": "1a791d3f428adb6bd5fd5ae76f2656c57c5c3d6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0MDgyMA==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384540820", "bodyText": "I agree with you @vietnguyen . I removed my implementation from this PR, then we can re-implement with your suggestions later :)", "author": "stian-sandvold", "createdAt": "2020-02-26T14:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEyMTc1Mg=="}], "type": "inlineReview"}, {"oid": "11c06f58ab233b4aa82db3b2e9d2ea9cc5a863e4", "url": "https://github.com/dhis2/dhis2-core/commit/11c06f58ab233b4aa82db3b2e9d2ea9cc5a863e4", "message": "Added tests; Added new TrackerIdentifier; Renamed old TrackerIdentifier to TrackerIdScheme", "committedDate": "2020-02-24T16:44:50Z", "type": "commit"}, {"oid": "10bd94a076eca45193589f3886b74518e61134ac", "url": "https://github.com/dhis2/dhis2-core/commit/10bd94a076eca45193589f3886b74518e61134ac", "message": "merged from master", "committedDate": "2020-02-25T22:15:13Z", "type": "commit"}, {"oid": "a4ef3a23be3af05403737a50487e70446df4a6e0", "url": "https://github.com/dhis2/dhis2-core/commit/a4ef3a23be3af05403737a50487e70446df4a6e0", "message": "Merging from master cont.", "committedDate": "2020-02-25T22:42:34Z", "type": "commit"}, {"oid": "492a498b29fbd79e0d3a1080645c0d634704b753", "url": "https://github.com/dhis2/dhis2-core/commit/492a498b29fbd79e0d3a1080645c0d634704b753", "message": "merging cont.", "committedDate": "2020-02-25T22:45:07Z", "type": "commit"}, {"oid": "4e58bdd6742ce69a2ed1150935a96facb44624da", "url": "https://github.com/dhis2/dhis2-core/commit/4e58bdd6742ce69a2ed1150935a96facb44624da", "message": "Cleanup", "committedDate": "2020-02-26T14:43:25Z", "type": "commit"}, {"oid": "b61a1f1c7f9bebd99095dfab08668b8415c08c66", "url": "https://github.com/dhis2/dhis2-core/commit/b61a1f1c7f9bebd99095dfab08668b8415c08c66", "message": "Minor changes based on sonarqube", "committedDate": "2020-02-26T14:47:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwMzA3OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384903079", "bodyText": "What if there is no : in the string.. won't this give error? (the [1] part)", "author": "mortenoh", "createdAt": "2020-02-27T04:05:12Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/DefaultTrackerImportService.java", "diffHunk": "@@ -180,18 +182,61 @@ public TrackerImportParams getParamsFromMap( Map<String, List<String>> parameter\n     // Utility Methods\n     //-----------------------------------------------------------------------------------\n \n+    private TrackerIdentifierParams getTrackerIdentifiers( Map<String, List<String>> parameters )\n+    {\n+        TrackerIdScheme idScheme = getEnumWithDefault( TrackerIdScheme.class, parameters, \"idScheme\", TrackerIdScheme.UID );\n+        TrackerIdScheme orgUnitIdScheme  = getEnumWithDefault( TrackerIdScheme.class, parameters, \"orgUnitIdScheme\", idScheme );\n+        TrackerIdScheme programIdScheme  = getEnumWithDefault( TrackerIdScheme.class, parameters, \"programIdScheme\", idScheme );\n+        TrackerIdScheme programStageIdScheme  = getEnumWithDefault( TrackerIdScheme.class, parameters, \"programStageIdScheme\", idScheme );\n+        TrackerIdScheme dataElementIdScheme  = getEnumWithDefault( TrackerIdScheme.class, parameters, \"dataElementIdScheme\", idScheme );\n+\n+        return TrackerIdentifierParams.builder()\n+            .idScheme( TrackerIdentifier.builder().idScheme( idScheme ).value( getAttributeUidOrNull( parameters, \"idScheme\" ) ).build() )\n+            .orgUnitIdScheme( TrackerIdentifier.builder().idScheme( orgUnitIdScheme ).value( getAttributeUidOrNull( parameters, \"orgUnitIdScheme\" ) ).build() )\n+            .programIdScheme( TrackerIdentifier.builder().idScheme( programIdScheme ).value( getAttributeUidOrNull( parameters, \"programIdScheme\" ) ).build() )\n+            .programStageIdScheme( TrackerIdentifier.builder().idScheme( programStageIdScheme ).value( getAttributeUidOrNull( parameters, \"programStageIdScheme\" ) ).build() )\n+            .dataElementIdScheme( TrackerIdentifier.builder().idScheme( dataElementIdScheme ).value( getAttributeUidOrNull( parameters, \"dataElementIdScheme\" ) ).build() )\n+            .build();\n+    }\n+\n     private <T extends Enum<T>> T getEnumWithDefault( Class<T> enumKlass, Map<String, List<String>> parameters, String key, T defaultValue )\n     {\n         if ( parameters == null || parameters.get( key ) == null || parameters.get( key ).isEmpty() )\n         {\n             return defaultValue;\n         }\n \n+        if ( TrackerIdScheme.class.equals( enumKlass ) && IdScheme.isAttribute( parameters.get( key ).get( 0 ) ) )\n+        {\n+            return Enums.getIfPresent( enumKlass, \"ATTRIBUTE\" ).orNull();\n+        }\n+\n         String value = String.valueOf( parameters.get( key ).get( 0 ) );\n \n         return Enums.getIfPresent( enumKlass, value ).or( defaultValue );\n     }\n \n+    private String getAttributeUidOrNull(Map<String, List<String>> parameters, String key)\n+    {\n+        if ( parameters == null || parameters.get( key ) == null || parameters.get( key ).isEmpty() )\n+        {\n+            return null;\n+        }\n+\n+        if ( IdScheme.isAttribute( parameters.get( key ).get( 0 ) ) )\n+        {\n+            // Get second half of string, separated by ':'\n+            String uid = parameters.get( key ).get( 0 ).split( \":\" )[1];", "originalCommit": "b61a1f1c7f9bebd99095dfab08668b8415c08c66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwMzUzNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384903535", "bodyText": "Null should already be default for strings", "author": "mortenoh", "createdAt": "2020-02-27T04:07:27Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/TrackerIdentifier.java", "diffHunk": "@@ -28,39 +28,56 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n+import lombok.AllArgsConstructor;\n+import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+import org.hisp.dhis.attribute.AttributeValue;\n import org.hisp.dhis.common.IdentifiableObject;\n+import org.hisp.dhis.util.ObjectUtils;\n \n /**\n- * @author Morten Olav Hansen <mortenoh@gmail.com>\n+ * @author Stian Sandvold\n  */\n-public enum TrackerIdentifier\n+\n+@Data\n+@Builder\n+@NoArgsConstructor\n+@AllArgsConstructor\n+public class TrackerIdentifier\n {\n-    /**\n-     * Preheat using UID identifiers.\n-     */\n-    UID,\n+    public final static TrackerIdentifier UID = builder().idScheme( TrackerIdScheme.UID ).build();\n+\n+    public final static TrackerIdentifier CODE = builder().idScheme( TrackerIdScheme.CODE ).build();\n \n-    /**\n-     * Preheat using CODE identifiers.\n-     */\n-    CODE,\n+    public final static TrackerIdentifier AUTO = builder().idScheme( TrackerIdScheme.AUTO ).build();\n \n-    /**\n-     * Find first non-null identifier in order: UID, CODE\n-     */\n-    AUTO;\n+    @Builder.Default\n+    private TrackerIdScheme idScheme = TrackerIdScheme.UID;\n+\n+    @Builder.Default\n+    private String value = null;", "originalCommit": "b61a1f1c7f9bebd99095dfab08668b8415c08c66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk3MDYwMg==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384970602", "bodyText": "Yeah, but compilation fails due to Lombok expecting a value.", "author": "stian-sandvold", "createdAt": "2020-02-27T08:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwMzUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk3NjU5NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384976595", "bodyText": "Oh, ok.. even without @Builder.Default ? because you dont need it unless you want to assign a default value", "author": "mortenoh", "createdAt": "2020-02-27T08:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwMzUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwNTQ2OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384905469", "bodyText": "Have you done any performance testing here? should we also look into adding jsonb indexes?", "author": "mortenoh", "createdAt": "2020-02-27T04:16:55Z", "path": "dhis-2/dhis-support/dhis-support-hibernate/src/main/java/org/hisp/dhis/hibernate/HibernateGenericStore.java", "diffHunk": "@@ -575,6 +576,19 @@ public int getCount()\n         return objects.isEmpty() || (object != null && objects.size() == 1 && object.equals( objects.get( 0 ) ) );\r\n     }\r\n \r\n+    @Override\r\n+    public List<T> getAllByAttributeAndValues( Attribute attribute, List<String> values )\r\n+    {\r\n+        CriteriaBuilder builder = getCriteriaBuilder();\r\n+\r\n+        CriteriaQuery<T> query = builder.createQuery( getClazz() );\r\n+        Root<T> root = query.from( getClazz() );\r\n+        query.select( root );\r\n+        query.where( builder.function( FUNCTION_JSONB_EXTRACT_PATH_TEXT, String.class, root.get( \"attributeValues\" ), builder.literal( attribute.getUid() ), builder.literal( \"value\" ) ).in( values ) );\r", "originalCommit": "b61a1f1c7f9bebd99095dfab08668b8415c08c66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk2MzI1OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384963259", "bodyText": "Last time I couldn't find away to add index, reasons is :\n\n\nGIN index doesn't support those functions jsonb_extract_path_text() , it only supports  jsonb operators  like @>\n\n\nCodes in HibernateGenericStore  need to be generic, so we can't use native sql with jsonb operators, must use JPA query API\n\n\nJPA  query API doesn't support jsonb operators, only postgresql built-in functions like jsonb_extract_path_text(), and it also need to be registered in DhisPostgresDialect\n\n\nregisterFunction( \"jsonb_extract_path_text\", new StandardSQLFunction(\"jsonb_extract_path_text\", StandardBasicTypes.STRING ));", "author": "vietnguyen", "createdAt": "2020-02-27T07:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwNTQ2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk2Nzg0MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384967841", "bodyText": "This is based directly on tehe same query used for attributes in generl :) I think the main performance improvement here would be indexes, which we can look into in the future. It seems like @vietnguyen has already looked into indexes, so maybe we need to wait for better support, or rethink how we query the data.", "author": "stian-sandvold", "createdAt": "2020-02-27T08:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwNTQ2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk5NDI5NA==", "url": "https://github.com/dhis2/dhis2-core/pull/4936#discussion_r384994294", "bodyText": "Ok @vietnguyen I see, we should look into it later also... PostgreSQL keeps getting updated and we might at some point be able to use it (@> is course also available as a function you can use, but i guess thats not really the problem)", "author": "mortenoh", "createdAt": "2020-02-27T09:09:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkwNTQ2OQ=="}], "type": "inlineReview"}, {"oid": "0964925a247fe5f43fb5de45737958804e006af6", "url": "https://github.com/dhis2/dhis2-core/commit/0964925a247fe5f43fb5de45737958804e006af6", "message": "Fixed failing test and made changes according to feedback", "committedDate": "2020-02-27T09:34:19Z", "type": "commit"}]}