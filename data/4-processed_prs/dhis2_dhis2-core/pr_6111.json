{"pr_number": 6111, "pr_title": "feat: require bundled app overrides to be configured with the coreApp flag in the manifest", "pr_createdAt": "2020-09-08T17:51:00Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6111", "timeline": [{"oid": "a1926fcc84acd3d0cfd3dca8fba877dc0554e595", "url": "https://github.com/dhis2/dhis2-core/commit/a1926fcc84acd3d0cfd3dca8fba877dc0554e595", "message": "feat: require bundled app overrides to be configured with the coreApp flag in the manifest", "committedDate": "2020-09-08T17:44:56Z", "type": "commit"}, {"oid": "5af47f58932bed8ff3ef44639b7a6441f7cb1f1f", "url": "https://github.com/dhis2/dhis2-core/commit/5af47f58932bed8ff3ef44639b7a6441f7cb1f1f", "message": "chore: add comment describing core_app property", "committedDate": "2020-09-08T17:53:25Z", "type": "commit"}, {"oid": "5e12106e3081474c322c9479f8d57acf73e1b69c", "url": "https://github.com/dhis2/dhis2-core/commit/5e12106e3081474c322c9479f8d57acf73e1b69c", "message": "refactor: extract app validation logic", "committedDate": "2020-09-08T18:52:42Z", "type": "commit"}, {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4", "url": "https://github.com/dhis2/dhis2-core/commit/e0741fe1c5b320255f81938beefd6ab7eefea6e4", "message": "chore: add details to dhis-web-apps index and json", "committedDate": "2020-09-08T19:50:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2MDc5Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485160793", "bodyText": "I think a better name here is just bundled. The \"is\" prefix is normally avoided in primitive booleans, as \"is\" the regular prefix for get methods. The \"app\" part is implicit since the object is called App.\nThe the getter/setter become isBundled and setBundled.", "author": "larshelge", "createdAt": "2020-09-08T19:54:42Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/appmanager/App.java", "diffHunk": "@@ -95,9 +95,12 @@\n \n     private Set<String> authorities = new HashSet<>();\n \n-    private AppStatus appState = AppStatus.OK;\n+    private boolean coreApp = false;\n \n-    private boolean isBundledApp = false;", "originalCommit": "e0741fe1c5b320255f81938beefd6ab7eefea6e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2Mjc3Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485162777", "bodyText": "@larshelge makes sense.  This line is actually removed, now we only have the getter and setter (previously the variable wasn't set until initialization with a contextPath, which caused problems when trying to evaluate the app at installation time).  Should I update the getter here or leave it as before?", "author": "amcgee", "createdAt": "2020-09-08T19:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2MDc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2NDI2MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485164261", "bodyText": "Ah okay, right. Will be break any clients by making that change? If not, go for it.", "author": "larshelge", "createdAt": "2020-09-08T20:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2MDc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2NjM0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485166342", "bodyText": "I'll have to update all the references to it (there are a few) but doable", "author": "amcgee", "createdAt": "2020-09-08T20:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2MDc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE3MTQ0NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485171445", "bodyText": "Typo: \"muse\" -> \"must\".", "author": "larshelge", "createdAt": "2020-09-08T20:15:37Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/appmanager/JCloudsAppStorageService.java", "diffHunk": "@@ -271,6 +271,63 @@ public void cleanUp()\n         return reservedNamespaces;\n     }\n \n+    private boolean validateApp( App app, Cache<App> appCache )\n+    {\n+        // -----------------------------------------------------------------\n+        // Check if app with same key is currently being deleted (deletion_in_progress)\n+        // -----------------------------------------------------------------\n+        Optional<App> existingApp = appCache.getIfPresent( app.getKey() );\n+        if ( existingApp.isPresent() && existingApp.get().getAppState() == AppStatus.DELETION_IN_PROGRESS )\n+        {\n+            log.error( \"Failed to install app: App with same name is currently being deleted\" );\n+\n+            app.setAppState( AppStatus.DELETION_IN_PROGRESS );\n+            return false;\n+        }\n+\n+        // -----------------------------------------------------------------\n+        // Check for namespace and if it's already taken by another app\n+        // -----------------------------------------------------------------\n+\n+        String namespace = app.getActivities().getDhis().getNamespace();\n+\n+        if ( namespace != null && !namespace.isEmpty() && app.equals( reservedNamespaces.get( namespace ) ) )\n+        {\n+            log.error( String.format( \"Failed to install app '%s': Namespace '%s' already taken.\",\n+                app.getName(), namespace ) );\n+\n+            app.setAppState( AppStatus.NAMESPACE_TAKEN );\n+            return false;\n+        }\n+\n+        // -----------------------------------------------------------------\n+        // Check that, iff this is a bundled app, it is configured as a core app\n+        // -----------------------------------------------------------------\n+\n+        if ( app.getIsBundledApp() != app.getIsCoreApp() )\n+        {\n+            if ( app.getIsBundledApp() )\n+            {\n+                log.error(\n+                    String.format(\n+                        \"Failed to install app '%s': bundled app overrides muse be declared with core_app=true\",", "originalCommit": "e0741fe1c5b320255f81938beefd6ab7eefea6e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE3MjY4Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485172686", "bodyText": "A unit test would be appropriate here, as this code can easily be tested. Method could be made public (or just default modifier). Can wait until after hard freeze.", "author": "larshelge", "createdAt": "2020-09-08T20:18:16Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/appmanager/JCloudsAppStorageService.java", "diffHunk": "@@ -271,6 +271,63 @@ public void cleanUp()\n         return reservedNamespaces;\n     }\n \n+    private boolean validateApp( App app, Cache<App> appCache )", "originalCommit": "e0741fe1c5b320255f81938beefd6ab7eefea6e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9c3a2ae68809ee3c002464f7c680026cac115143", "url": "https://github.com/dhis2/dhis2-core/commit/9c3a2ae68809ee3c002464f7c680026cac115143", "message": "chore: use simpler boolean getters, setters, and properties", "committedDate": "2020-09-08T20:27:34Z", "type": "commit"}]}