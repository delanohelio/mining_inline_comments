{"pr_number": 6333, "pr_title": "fix: lazy issue in audit service", "pr_createdAt": "2020-10-06T07:38:44Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6333", "timeline": [{"oid": "3b9e9510dcaca556f019d3c57b1583eb2eb4c1bd", "url": "https://github.com/dhis2/dhis2-core/commit/3b9e9510dcaca556f019d3c57b1583eb2eb4c1bd", "message": "fix: lazy issue in audit service", "committedDate": "2020-10-06T07:40:33Z", "type": "forcePushed"}, {"oid": "8a618176ff3629395f79a97300be0d07ee66dabf", "url": "https://github.com/dhis2/dhis2-core/commit/8a618176ff3629395f79a97300be0d07ee66dabf", "message": "fix: lazy issue in audit service", "committedDate": "2020-10-06T07:44:32Z", "type": "commit"}, {"oid": "8a618176ff3629395f79a97300be0d07ee66dabf", "url": "https://github.com/dhis2/dhis2-core/commit/8a618176ff3629395f79a97300be0d07ee66dabf", "message": "fix: lazy issue in audit service", "committedDate": "2020-10-06T07:44:32Z", "type": "forcePushed"}, {"oid": "561b148e51acf1a370576929157b4823d53dc79a", "url": "https://github.com/dhis2/dhis2-core/commit/561b148e51acf1a370576929157b4823d53dc79a", "message": "Merge remote-tracking branch 'origin/master' into DHIS2-9467-36-0", "committedDate": "2020-10-06T07:51:18Z", "type": "commit"}, {"oid": "3676b1dbe860824fda5f5eee479753e20288d544", "url": "https://github.com/dhis2/dhis2-core/commit/3676b1dbe860824fda5f5eee479753e20288d544", "message": "fix: hibernate lazy exception in audit service", "committedDate": "2020-10-06T16:58:35Z", "type": "commit"}, {"oid": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "url": "https://github.com/dhis2/dhis2-core/commit/bacb109b521fd07a6eb384a77677fc0d8b54f76d", "message": "clean up code", "committedDate": "2020-10-06T17:02:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc3NzY0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500777642", "bodyText": "you can remove the private modifier, since @Value adds that", "author": "luciano-fiandesio", "createdAt": "2020-10-07T06:55:28Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditableEntity.java", "diffHunk": "@@ -39,4 +39,16 @@\n public class AuditableEntity\n {\n     private Object entity;\n+\n+    private Object serializableObject;", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk2MDk3Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500960972", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-10-07T12:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc3NzY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc3ODM4OA==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500778388", "bodyText": "What is the difference now between entity and serializableObject? Can we get rid of entity? If not, let's add a short Javadoc comment", "author": "luciano-fiandesio", "createdAt": "2020-10-07T06:56:58Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditableEntity.java", "diffHunk": "@@ -39,4 +39,16 @@\n public class AuditableEntity\n {\n     private Object entity;", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2NzgzNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r501467835", "bodyText": "Replaced Object entity with Class entityClass.\nWe need this Class metadata for annotation scanning", "author": "vietnguyen", "createdAt": "2020-10-08T06:05:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc3ODM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc3OTUzMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500779531", "bodyText": "Please, no wildcard import. Also, fix unused imports", "author": "luciano-fiandesio", "createdAt": "2020-10-07T06:59:22Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/listener/AbstractHibernateListener.java", "diffHunk": "@@ -28,23 +28,31 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n-import org.hibernate.LazyInitializationException;\n+import com.sun.tools.rngom.parse.host.Base;\n+import org.hibernate.Hibernate;\n import org.hibernate.Session;\n-import org.hibernate.SessionFactory;\n-import org.hibernate.engine.spi.SessionFactoryImplementor;\n+import org.hibernate.event.spi.*;", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2NzkyMA==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r501467920", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-10-08T06:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc3OTUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTYyNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500781625", "bodyText": "I would move \"down\" these two methods (createAuditEntry) to the sub-classes (PostInsertAuditListener and PostUpdateAuditListener)", "author": "luciano-fiandesio", "createdAt": "2020-10-07T07:03:49Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/listener/AbstractHibernateListener.java", "diffHunk": "@@ -102,63 +109,126 @@ public String getCreatedBy()\n     abstract AuditType getAuditType();\n \n     /**\n-     * Try to initialize all lazy loaded collections of the given Entity before sending\n-     * it to {@link AuditObjectFactory} for serializing to JSON\n-     * @param factory {@link SessionFactoryImplementor}\n-     * @param entity current Entity\n-     * @return the Entity with all collections loaded\n+     * Create Audit entry for update event\n      */\n-    protected Object initHibernateProxy( SessionFactoryImplementor factory, Object entity )\n+    protected Object createAuditEntry( PostUpdateEvent postUpdateEvent )\n     {\n-        Session session = factory.getCurrentSession();\n+        return createAuditEntry( postUpdateEvent.getEntity(), postUpdateEvent.getState(), postUpdateEvent.getSession(), postUpdateEvent.getId(), postUpdateEvent.getPersister() );\n+    }\n+\n+    /**\n+     * Create Audit entry for insert event\n+     */\n+    protected Object createAuditEntry( PostInsertEvent postInsertEvent )", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2Nzk3NA==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r501467974", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-10-08T06:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MTYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MjcxMw==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500782713", "bodyText": "Please fix unused comments, no star import", "author": "luciano-fiandesio", "createdAt": "2020-10-07T07:06:05Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/listener/PostDeleteAuditListener.java", "diffHunk": "@@ -28,20 +28,32 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n+import lombok.SneakyThrows;\n import lombok.extern.slf4j.Slf4j;\n-import org.hibernate.SessionFactory;\n+import org.hibernate.Hibernate;\n+import org.hibernate.collection.spi.PersistentCollection;", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODAwNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r501468006", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-10-08T06:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MjcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MjgxOA==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500782818", "bodyText": "Please fix unused comments, no star import", "author": "luciano-fiandesio", "createdAt": "2020-10-07T07:06:17Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/listener/PostInsertAuditListener.java", "diffHunk": "@@ -28,20 +28,32 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n+import lombok.SneakyThrows;\n import lombok.extern.slf4j.Slf4j;\n-import org.hibernate.SessionFactory;\n+import org.hibernate.Hibernate;", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODAzNw==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r501468037", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-10-08T06:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MjgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MzM3MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500783371", "bodyText": "Please fix unused comments, no star import", "author": "luciano-fiandesio", "createdAt": "2020-10-07T07:07:36Z", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/listener/PostUpdateAuditListener.java", "diffHunk": "@@ -29,19 +29,29 @@\n  */\n \n import lombok.extern.slf4j.Slf4j;", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODA1NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r501468055", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-10-08T06:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MzM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MzYxMA==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r500783610", "bodyText": "Please fix unused comments", "author": "luciano-fiandesio", "createdAt": "2020-10-07T07:08:07Z", "path": "dhis-2/dhis-support/dhis-support-commons/src/main/java/org/hisp/dhis/commons/config/JacksonObjectMapperConfig.java", "diffHunk": "@@ -28,6 +28,17 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n+import java.util.Date;\n+\n+import org.hibernate.SessionFactory;", "originalCommit": "bacb109b521fd07a6eb384a77677fc0d8b54f76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODA3OA==", "url": "https://github.com/dhis2/dhis2-core/pull/6333#discussion_r501468078", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-10-08T06:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDc4MzYxMA=="}], "type": "inlineReview"}, {"oid": "c9c304a32b6a3ee5400952ef394faddc248f5dd9", "url": "https://github.com/dhis2/dhis2-core/commit/c9c304a32b6a3ee5400952ef394faddc248f5dd9", "message": "clean up codes", "committedDate": "2020-10-07T09:31:48Z", "type": "commit"}, {"oid": "df644666b4f408f541f6e8d368e7d230e1cf8d3b", "url": "https://github.com/dhis2/dhis2-core/commit/df644666b4f408f541f6e8d368e7d230e1cf8d3b", "message": "clean up code and add test", "committedDate": "2020-10-08T05:55:38Z", "type": "commit"}, {"oid": "df644666b4f408f541f6e8d368e7d230e1cf8d3b", "url": "https://github.com/dhis2/dhis2-core/commit/df644666b4f408f541f6e8d368e7d230e1cf8d3b", "message": "clean up code and add test", "committedDate": "2020-10-08T05:55:38Z", "type": "forcePushed"}, {"oid": "cd171e3cd1996d564413fac09d815b0c5beaaabf", "url": "https://github.com/dhis2/dhis2-core/commit/cd171e3cd1996d564413fac09d815b0c5beaaabf", "message": "Merge remote-tracking branch 'origin/master' into DHIS2-9467-36-0", "committedDate": "2020-10-08T06:28:52Z", "type": "commit"}, {"oid": "5bfc899916dca27ae66c7cb7f3b970fbbc913fd0", "url": "https://github.com/dhis2/dhis2-core/commit/5bfc899916dca27ae66c7cb7f3b970fbbc913fd0", "message": "fix: eventDataValue is blank for audit entry", "committedDate": "2020-10-08T17:07:37Z", "type": "commit"}, {"oid": "fab058400118c6d96a781b68ae4aaf1d89183041", "url": "https://github.com/dhis2/dhis2-core/commit/fab058400118c6d96a781b68ae4aaf1d89183041", "message": "Merge remote-tracking branch 'origin/master' into DHIS2-9467-36-0", "committedDate": "2020-11-02T14:02:57Z", "type": "commit"}, {"oid": "32f1c6eade7ba2d71899eb0ef5f12d709d27cdb4", "url": "https://github.com/dhis2/dhis2-core/commit/32f1c6eade7ba2d71899eb0ef5f12d709d27cdb4", "message": "add license", "committedDate": "2020-11-04T10:25:02Z", "type": "commit"}]}