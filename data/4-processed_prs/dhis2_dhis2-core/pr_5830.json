{"pr_number": 5830, "pr_title": "fix: Remove the possibility of race conditions while reserving sequential-based generated ids", "pr_createdAt": "2020-07-07T14:56:12Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5830", "timeline": [{"oid": "a03e8b484de3fbbfb237813fac05339930e70d1f", "url": "https://github.com/dhis2/dhis2-core/commit/a03e8b484de3fbbfb237813fac05339930e70d1f", "message": "Added new procedure for removing race conditions, and updated store to reflect the changes", "committedDate": "2020-07-07T14:54:28Z", "type": "commit"}, {"oid": "b33db53fbd8ca97b1c91b7197497ed2b4c708d44", "url": "https://github.com/dhis2/dhis2-core/commit/b33db53fbd8ca97b1c91b7197497ed2b4c708d44", "message": "fix: Update test to integration tests; Update flyway script to account for no row", "committedDate": "2020-07-23T15:47:06Z", "type": "commit"}, {"oid": "2dc26ebff2ec5cd3aee2f8df8fbd7c6838f122b3", "url": "https://github.com/dhis2/dhis2-core/commit/2dc26ebff2ec5cd3aee2f8df8fbd7c6838f122b3", "message": "fix: Change test to integration", "committedDate": "2020-07-23T16:11:32Z", "type": "commit"}, {"oid": "2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776", "url": "https://github.com/dhis2/dhis2-core/commit/2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776", "message": "fix: Add transactional annotation to method", "committedDate": "2020-07-23T16:56:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MDE2OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5830#discussion_r459660169", "bodyText": "I'm a bit worried that this TABLE LOCK - ROW EXCLUSIVE is going to generate a lot of deadlocks under moderate concurrency. I think we should at least test it with a stress test, simulating 50/100 concurrent users.", "author": "luciano-fiandesio", "createdAt": "2020-07-23T18:53:52Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/resources/org/hisp/dhis/db/migration/2.35/V2_35_11__Add_sequentialcounter_procedure.sql", "diffHunk": "@@ -0,0 +1,27 @@\n+CREATE OR REPLACE FUNCTION incrementSequentialCounter(counter_owner text, counter_key text, i integer) RETURNS integer AS $$\n+\tDECLARE\n+\t\t-- Get the initial count, or 0 if it doesnt exist\n+\t\tcurrent_counter integer;\n+\tBEGIN\n+\t\t-- Lock the row, so noone else gets an old count.\n+\t\tLOCK TABLE sequentialnumbercounter IN ROW EXCLUSIVE MODE;", "originalCommit": "2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "70b7a8dae2080e3eb8c7ec550799f4c74d60cd6d", "url": "https://github.com/dhis2/dhis2-core/commit/70b7a8dae2080e3eb8c7ec550799f4c74d60cd6d", "message": "add multithreaded test", "committedDate": "2020-07-23T21:46:42Z", "type": "commit"}, {"oid": "0a919cf52bfd2c2bcacc6d86b54b3053bfe75b69", "url": "https://github.com/dhis2/dhis2-core/commit/0a919cf52bfd2c2bcacc6d86b54b3053bfe75b69", "message": "use different uid for each task during concurrent test for reserved values", "committedDate": "2020-07-24T07:14:54Z", "type": "commit"}, {"oid": "dea251ed257dab522e9fb8ce5373b15bdce2c6f2", "url": "https://github.com/dhis2/dhis2-core/commit/dea251ed257dab522e9fb8ce5373b15bdce2c6f2", "message": "fix assertions", "committedDate": "2020-07-24T07:22:07Z", "type": "commit"}, {"oid": "3b8d48418b0377cfa1d5435121d2c5625d4c4f0e", "url": "https://github.com/dhis2/dhis2-core/commit/3b8d48418b0377cfa1d5435121d2c5625d4c4f0e", "message": "reverted test to use one key/owner across all threads", "committedDate": "2020-07-24T07:34:32Z", "type": "commit"}, {"oid": "142418385f32d131a1b217bf76c9beeaaf0b7ba6", "url": "https://github.com/dhis2/dhis2-core/commit/142418385f32d131a1b217bf76c9beeaaf0b7ba6", "message": "modified SP to execute an upsert while locking on the reserved value row", "committedDate": "2020-07-24T14:08:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MzAzNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5830#discussion_r465063035", "bodyText": "@luciano-fiandesio / @stian-sandvold , please synchronize this Flyway migration version with the others PR's:\n#5876\n#5885", "author": "maikelarabori", "createdAt": "2020-08-04T13:48:38Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/resources/org/hisp/dhis/db/migration/2.35/V2_35_11__Add_sequentialcounter_procedure.sql", "diffHunk": "@@ -0,0 +1,24 @@\n+-- remove primary key on id", "originalCommit": "142418385f32d131a1b217bf76c9beeaaf0b7ba6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6d7cc592b97f9c6fea7adab372476da31c34bf8", "url": "https://github.com/dhis2/dhis2-core/commit/c6d7cc592b97f9c6fea7adab372476da31c34bf8", "message": "Ignore test. Works, but unexplainably is using H2 during github check test", "committedDate": "2020-08-06T09:56:11Z", "type": "commit"}, {"oid": "4151dd6d80ef2905570efde55706f3c2363f5009", "url": "https://github.com/dhis2/dhis2-core/commit/4151dd6d80ef2905570efde55706f3c2363f5009", "message": " Merge with master. Readjusted flyway script version number", "committedDate": "2020-08-06T10:01:02Z", "type": "commit"}, {"oid": "f2b1732f3cde0f16b332cfd50a3b7f16e6164408", "url": "https://github.com/dhis2/dhis2-core/commit/f2b1732f3cde0f16b332cfd50a3b7f16e6164408", "message": "Merge branch 'DHIS2-9146' of github.com:dhis2/dhis2-core into DHIS2-9146", "committedDate": "2020-08-06T10:01:54Z", "type": "commit"}, {"oid": "0a5f52c5ce85e9392c9334e5f209065a1e63c910", "url": "https://github.com/dhis2/dhis2-core/commit/0a5f52c5ce85e9392c9334e5f209065a1e63c910", "message": "fix: Reload periodTypes before test to get right id", "committedDate": "2020-08-06T11:36:09Z", "type": "commit"}]}