{"pr_number": 6384, "pr_title": "fix: Respect sharing setting during event saving", "pr_createdAt": "2020-10-13T07:01:26Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6384", "timeline": [{"oid": "d67c6f1d7757f6712118d94e203b19ddfdb55475", "url": "https://github.com/dhis2/dhis2-core/commit/d67c6f1d7757f6712118d94e203b19ddfdb55475", "message": "fix: Respect sharing setting in event saving", "committedDate": "2020-10-13T06:59:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDAyMg==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r504544022", "bodyText": "Can you add the new argument to the list of Javadoc arguments for the method?", "author": "luciano-fiandesio", "createdAt": "2020-10-14T09:43:42Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/ProgramStageInstanceService.java", "diffHunk": "@@ -170,7 +170,7 @@ ProgramStageInstance createProgramStageInstance( ProgramInstance programInstance\n      * @param singleValue specifies whether the update is a single value update\r\n      */\r\n     void auditDataValuesChangesAndHandleFileDataValues( Set<EventDataValue> newDataValues, Set<EventDataValue> updatedDataValues,Set<EventDataValue> removedDataValues,\r\n-        Map<String, DataElement> dataElementsCache, ProgramStageInstance programStageInstance, boolean singleValue );\r", "originalCommit": "d67c6f1d7757f6712118d94e203b19ddfdb55475", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0ODg0MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r512548841", "bodyText": "yes, just added.", "author": "abyot", "createdAt": "2020-10-27T09:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NTU5NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r504545595", "bodyText": "minor: can you format to respect the 80 chars line length:\nSet<EventDataValue> nonAccessibleDataValues = programStageInstance.getEventDataValues().stream()\n    .filter( dv -> nonAccessibleDataElements.contains( dv.getDataElement() ) )\n    .collect( Collectors.toSet() );", "author": "luciano-fiandesio", "createdAt": "2020-10-14T09:46:04Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/DefaultProgramStageInstanceService.java", "diffHunk": "@@ -310,7 +311,9 @@ public void auditDataValuesChangesAndHandleFileDataValues( Set<EventDataValue> n\n         }\r\n         else\r\n         {\r\n-            programStageInstance.setEventDataValues( updatedOrNewDataValues );\r\n+            Set<EventDataValue> nonAccessibleDataValues = programStageInstance.getEventDataValues().stream().filter( dv -> nonAccessibleDataElements.contains( dv.getDataElement() ) ).collect(  Collectors.toSet() );\r", "originalCommit": "d67c6f1d7757f6712118d94e203b19ddfdb55475", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0ODYxNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r512548616", "bodyText": "yes, applied the style.", "author": "abyot", "createdAt": "2020-10-27T09:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NTU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NzI2Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r504547263", "bodyText": "minor: can you reformat to respect 80 chars length\nprogramStageInstanceService.auditDataValuesChangesAndHandleFileDataValues( newDataValues, updatedDataValues,\n    removedDataValuesDueToEmptyValue, dataElementsCache, nonAccessibleDataElements, programStageInstance,\n    singleValue )", "author": "luciano-fiandesio", "createdAt": "2020-10-14T09:48:46Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/eventdatavalue/DefaultEventDataValueService.java", "diffHunk": "@@ -116,16 +119,32 @@ public void processDataValues( ProgramStageInstance programStageInstance, Event\n             {\n                 // This can happen if a wrong data element identifier is provided\n                 importSummary.getConflicts().add( new ImportConflict( \"dataElement\", dataValue.getDataElement() + \" is not a valid data element\" ) );\n+                continue;\n             }\n-            else if ( validateDataValue( programStageInstance, importOptions.getUser(), dataElement, dataValue.getValue(), importSummary )\n-                && !importOptions.isDryRun() )\n+\n+            if ( validateDataValue( programStageInstance, importOptions.getUser(), dataElement, dataValue.getValue(), importSummary ) )\n             {\n+                accessibleDataElements.add( dataValue.getDataElement() );\n                 prepareDataValueForStorage( dataElementValueMap, dataValue, dataElement, newDataValues, updatedDataValues,\n                     removedDataValuesDueToEmptyValue, storedBy );\n             }\n+            else\n+            {\n+                nonAccessibleDataElements.add( dataValue.getDataElement() );\n+            }\n         }\n \n-        programStageInstanceService.auditDataValuesChangesAndHandleFileDataValues( newDataValues, updatedDataValues, removedDataValuesDueToEmptyValue, dataElementsCache, programStageInstance, singleValue );\n+        Set<String> checkedDataElements = Sets.union( accessibleDataElements, nonAccessibleDataElements );\n+\n+        for ( DataElement dataElement : programStageInstance.getProgramStage().getDataElements() )\n+        {\n+            if ( !checkedDataElements.contains( dataElement.getUid() ) &&  !trackerAccessManager.canWrite( importOptions.getUser(), programStageInstance, dataElement, true ).isEmpty() )\n+            {\n+                nonAccessibleDataElements.add( dataElement.getUid() );\n+            }\n+        }\n+\n+        programStageInstanceService.auditDataValuesChangesAndHandleFileDataValues( newDataValues, updatedDataValues, removedDataValuesDueToEmptyValue, dataElementsCache, nonAccessibleDataElements, programStageInstance, singleValue );", "originalCommit": "d67c6f1d7757f6712118d94e203b19ddfdb55475", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0ODQ3NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r512548475", "bodyText": "done.", "author": "abyot", "createdAt": "2020-10-27T09:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NzI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0ODk1OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r504548959", "bodyText": "the call to trackerAccessManager.canWrite( importOptions.getUser(), programStageInstance, dataElement, true ) is taking place also at line 125 (inside validateDataValue). I understand that this new block of code (from line 137 to 145) is required for the auditing. Can we somehow avoid the call to this canWrite method a second time?", "author": "luciano-fiandesio", "createdAt": "2020-10-14T09:51:30Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/eventdatavalue/DefaultEventDataValueService.java", "diffHunk": "@@ -116,16 +119,32 @@ public void processDataValues( ProgramStageInstance programStageInstance, Event\n             {\n                 // This can happen if a wrong data element identifier is provided\n                 importSummary.getConflicts().add( new ImportConflict( \"dataElement\", dataValue.getDataElement() + \" is not a valid data element\" ) );\n+                continue;\n             }\n-            else if ( validateDataValue( programStageInstance, importOptions.getUser(), dataElement, dataValue.getValue(), importSummary )\n-                && !importOptions.isDryRun() )\n+\n+            if ( validateDataValue( programStageInstance, importOptions.getUser(), dataElement, dataValue.getValue(), importSummary ) )\n             {\n+                accessibleDataElements.add( dataValue.getDataElement() );\n                 prepareDataValueForStorage( dataElementValueMap, dataValue, dataElement, newDataValues, updatedDataValues,\n                     removedDataValuesDueToEmptyValue, storedBy );\n             }\n+            else\n+            {\n+                nonAccessibleDataElements.add( dataValue.getDataElement() );\n+            }\n         }\n \n-        programStageInstanceService.auditDataValuesChangesAndHandleFileDataValues( newDataValues, updatedDataValues, removedDataValuesDueToEmptyValue, dataElementsCache, programStageInstance, singleValue );\n+        Set<String> checkedDataElements = Sets.union( accessibleDataElements, nonAccessibleDataElements );\n+\n+        for ( DataElement dataElement : programStageInstance.getProgramStage().getDataElements() )\n+        {\n+            if ( !checkedDataElements.contains( dataElement.getUid() ) &&  !trackerAccessManager.canWrite( importOptions.getUser(), programStageInstance, dataElement, true ).isEmpty() )", "originalCommit": "d67c6f1d7757f6712118d94e203b19ddfdb55475", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA3OTI2NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6384#discussion_r506079265", "bodyText": "we are not checking canWritefor the same object. otherwise we need to refactor the entire class, because the way it is written today focuses only on the incoming payload. what we are checking the second time (at least in the ACL) is those not in the payload.", "author": "abyot", "createdAt": "2020-10-16T06:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0ODk1OQ=="}], "type": "inlineReview"}, {"oid": "480c42e5bde7ea2e876d5c414ba1943550364537", "url": "https://github.com/dhis2/dhis2-core/commit/480c42e5bde7ea2e876d5c414ba1943550364537", "message": "chore: Code style", "committedDate": "2020-10-27T09:48:28Z", "type": "commit"}]}