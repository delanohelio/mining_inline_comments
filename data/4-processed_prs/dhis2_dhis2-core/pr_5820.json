{"pr_number": 5820, "pr_title": "feat: Moving visualization rows from columns into filters [DHIS2-9106]", "pr_createdAt": "2020-07-03T11:33:53Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5820", "timeline": [{"oid": "7387fc2fe3ed6b05c3fe41c34c13fef2936db8a6", "url": "https://github.com/dhis2/dhis2-core/commit/7387fc2fe3ed6b05c3fe41c34c13fef2936db8a6", "message": "feat: Moving visualization rows from columns into filters [DHIS2-9106]", "committedDate": "2020-07-03T11:31:21Z", "type": "commit"}, {"oid": "bdac6b03154d4bd4b419e973ecc4f60cded2e835", "url": "https://github.com/dhis2/dhis2-core/commit/bdac6b03154d4bd4b419e973ecc4f60cded2e835", "message": "fix: Adding code to reorder the sort_order in columns table [DHIS2-9106]", "committedDate": "2020-07-03T15:08:26Z", "type": "commit"}, {"oid": "4d3df1269355d556ef3e64adb90376e2c14612c7", "url": "https://github.com/dhis2/dhis2-core/commit/4d3df1269355d556ef3e64adb90376e2c14612c7", "message": "Merge branch 'master' of https://github.com/dhis2/dhis2-core into DHIS2-9106", "committedDate": "2020-07-06T12:15:37Z", "type": "commit"}, {"oid": "d6d0b3978c4e1561cf4381fe114568934c384b13", "url": "https://github.com/dhis2/dhis2-core/commit/d6d0b3978c4e1561cf4381fe114568934c384b13", "message": "fix: Replacing SP migration by Java migration [DHIS2-9106]", "committedDate": "2020-07-06T14:53:57Z", "type": "commit"}, {"oid": "dcb89088b60f1c4dea878269c3449a46dada068d", "url": "https://github.com/dhis2/dhis2-core/commit/dcb89088b60f1c4dea878269c3449a46dada068d", "message": "fix: Addressing Sonar issues [DHIS2-9106]", "committedDate": "2020-07-07T07:20:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MDM2Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5820#discussion_r461460362", "bodyText": "typo in method name, \"Filer\" not \"Filter\"", "author": "stian-sandvold", "createdAt": "2020-07-28T09:51:31Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v35/V2_35_11__Visualization_Move_Columns_To_Filters.java", "diffHunk": "@@ -0,0 +1,154 @@\n+package org.hisp.dhis.db.migration.v35;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+public class V2_35_11__Visualization_Move_Columns_To_Filters extends BaseJavaMigration\n+{\n+    @Override\n+    public void migrate( final Context context )\n+        throws SQLException\n+    {\n+        // Select all Visualizations that matches \"type\" equals 'YEAR_OVER_YEAR_COLUMN'\n+        // or 'YEAR_OVER_YEAR_LINE' and \"dimension\" equals 'dx'.\n+        final String sql = \"SELECT visualizationid, dimension, sort_order \"\n+            + \"FROM visualization_columns WHERE visualizationid IN \"\n+            + \"(SELECT v.visualizationid FROM visualization v \"\n+            + \"WHERE UPPER(COALESCE(v.type, '')) = 'YEAR_OVER_YEAR_COLUMN' \"\n+            + \"OR UPPER(COALESCE(v.type, '')) = 'YEAR_OVER_YEAR_LINE') AND LOWER(COALESCE(dimension)) = 'dx'\";\n+\n+        try (final Statement stmt = context.getConnection().createStatement();\n+            final ResultSet rs = stmt.executeQuery( sql ))\n+        {\n+            while ( rs.next() )\n+            {\n+                final long visualizationId = rs.getLong( \"visualizationid\" );\n+                final String dimension = rs.getString( \"dimension\" );\n+                final int sortOrder = rs.getInt( \"sort_order\" );\n+\n+                // Get the greater sort_order, in filters table, for the current Visualization\n+                // id.\n+                int greatVisualizationSortOrder = greaterSortOrderInFiltersTableFor( context,\n+                    rs.getLong( \"visualizationid\" ) );\n+\n+                // Increment the sort order so it can be inserted in the correct position.\n+                greatVisualizationSortOrder++;\n+\n+                // Before inserting the current column into filters table, check if this column\n+                // isn't already present in filters table.\n+                if ( !filtersTableContains( context, visualizationId, dimension ) )\n+                {\n+                    // Insert the current column into filters table.\n+                    insertIntoFilerTable( context, visualizationId, dimension, greatVisualizationSortOrder );\n+\n+                    // Once the columns is copied into filters, remove it from columns table. The\n+                    // \"moving\" process is concluded for this visualization column.\n+                    deleteFromColumnsTable( context, visualizationId, dimension, sortOrder );\n+                }\n+            }\n+        }\n+    }\n+\n+    private int greaterSortOrderInFiltersTableFor( final Context context, final long visualizationId )\n+        throws SQLException\n+    {\n+        final String sql = \"SELECT MAX(sort_order) AS greater_sort_order FROM visualization_filters WHERE visualizationid = ?\";\n+\n+        try (final PreparedStatement ps = context.getConnection().prepareStatement( sql ))\n+        {\n+            ps.setLong( 1, visualizationId );\n+\n+            try (final ResultSet rs = ps.executeQuery())\n+            {\n+                rs.next();\n+                return rs.getInt( \"greater_sort_order\" );\n+            }\n+        }\n+    }\n+\n+    private boolean filtersTableContains( final Context context, final long visualizationId, final String dimension )\n+        throws SQLException\n+    {\n+        final String sql = \"SELECT count(visualizationid) AS vis_counter FROM visualization_filters \"\n+            + \"WHERE visualizationid = ? AND LOWER(dimension) = LOWER(?)\";\n+\n+        try (final PreparedStatement ps = context.getConnection().prepareStatement( sql ))\n+        {\n+            ps.setLong( 1, visualizationId );\n+            ps.setString( 2, dimension );\n+\n+            try (final ResultSet rs = ps.executeQuery())\n+            {\n+                rs.next();\n+                return rs.getInt( \"vis_counter\" ) > 0;\n+            }\n+        }\n+    }\n+\n+    private void insertIntoFilerTable( final Context context, final long visualizationId, final String dimension,", "originalCommit": "dcb89088b60f1c4dea878269c3449a46dada068d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNjM0NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5820#discussion_r462406345", "bodyText": "Done", "author": "maikelarabori", "createdAt": "2020-07-29T15:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MDM2Mg=="}], "type": "inlineReview"}, {"oid": "a8172bd45be214499199ef870eae26e8053d4209", "url": "https://github.com/dhis2/dhis2-core/commit/a8172bd45be214499199ef870eae26e8053d4209", "message": "Merge branch 'master' of https://github.com/dhis2/dhis2-core into DHIS2-9106", "committedDate": "2020-07-28T09:56:44Z", "type": "commit"}, {"oid": "995bc147d7f32ebd4f2c48f0f3b3f6da85dfca28", "url": "https://github.com/dhis2/dhis2-core/commit/995bc147d7f32ebd4f2c48f0f3b3f6da85dfca28", "message": "fix: Method name typo [DHIS2-9106]", "committedDate": "2020-07-28T09:58:37Z", "type": "commit"}]}