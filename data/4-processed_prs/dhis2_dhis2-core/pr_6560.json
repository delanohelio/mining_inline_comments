{"pr_number": 6560, "pr_title": "refactor: Tracker preheat code refactoring", "pr_createdAt": "2020-11-03T07:36:17Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6560", "timeline": [{"oid": "1c83412887069bbf02a15f4b9f9948dda82f14dd", "url": "https://github.com/dhis2/dhis2-core/commit/1c83412887069bbf02a15f4b9f9948dda82f14dd", "message": "refactor: Tracker preheat code refactoring\n\nThis refactor aims at modularizing the pre-heat logic in order to:\n\n- reduce the number of dependencies of the PreheatService\n- simplify (unit) testing of pre-heat logic\n- increase extendibility of the pre-heat logic\n\nMain changes:\n\nReplace the pre-heat \"hooks\" with Suppliers. Each supplier is responsible for pulling data into the `TrackerPreheat` data object.\nSuppliers are dynamically loaded via classpath-scan. Order of execution is available through annotation (supplier Z must run before supplier A).\nAdditionally, a set of \"strategy pattern\" classes have been introduced to replace the large `if` block in the `TrackerPrehat` service.\nThe strategy classes are used to map Tracker domain object (e.g. Enrollment, Program, etc.) to pre-heat logic. The mapping is achieved through an annotation.\nAs for the supplier, also the strategy classes are dynamically load through classpath scanning.", "committedDate": "2020-11-03T10:09:10Z", "type": "commit"}, {"oid": "8ed441fc91b726b80203c00bb37ac60dc9feefac", "url": "https://github.com/dhis2/dhis2-core/commit/8ed441fc91b726b80203c00bb37ac60dc9feefac", "message": "process pre-heat errors", "committedDate": "2020-11-03T10:36:05Z", "type": "commit"}, {"oid": "f1cb854fdb5a26be8edaa69ca792077f802668a7", "url": "https://github.com/dhis2/dhis2-core/commit/f1cb854fdb5a26be8edaa69ca792077f802668a7", "message": "fix: unit test failing", "committedDate": "2020-11-03T13:13:41Z", "type": "commit"}, {"oid": "f1cb854fdb5a26be8edaa69ca792077f802668a7", "url": "https://github.com/dhis2/dhis2-core/commit/f1cb854fdb5a26be8edaa69ca792077f802668a7", "message": "fix: unit test failing", "committedDate": "2020-11-03T13:13:41Z", "type": "forcePushed"}, {"oid": "24c8bed8a1d03fb6db11e23664a280083cd93be7", "url": "https://github.com/dhis2/dhis2-core/commit/24c8bed8a1d03fb6db11e23664a280083cd93be7", "message": "more unit tests", "committedDate": "2020-11-03T13:36:29Z", "type": "commit"}, {"oid": "e5b4dd54ba50209f60a62f9c68060cea0bbb1dfe", "url": "https://github.com/dhis2/dhis2-core/commit/e5b4dd54ba50209f60a62f9c68060cea0bbb1dfe", "message": "fix test", "committedDate": "2020-11-03T14:14:56Z", "type": "commit"}, {"oid": "05c75ea5579b852ca46a99b475b17229f21d66da", "url": "https://github.com/dhis2/dhis2-core/commit/05c75ea5579b852ca46a99b475b17229f21d66da", "message": "Merge remote-tracking branch 'origin/master' into TRACKER-PREHEAT-REFACTOR-master", "committedDate": "2020-11-10T11:15:28Z", "type": "commit"}, {"oid": "9ad544ffb756cdf7c6a8775f778295e7d06ed597", "url": "https://github.com/dhis2/dhis2-core/commit/9ad544ffb756cdf7c6a8775f778295e7d06ed597", "message": "Fix compilation error in test", "committedDate": "2020-11-10T11:38:19Z", "type": "commit"}, {"oid": "ba3d0c65763776306e3b3c9ef501e5f7580544f2", "url": "https://github.com/dhis2/dhis2-core/commit/ba3d0c65763776306e3b3c9ef501e5f7580544f2", "message": "Fixed test", "committedDate": "2020-11-10T11:54:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUxODU3MA==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520518570", "bodyText": "Commented out code", "author": "stian-sandvold", "createdAt": "2020-11-10T12:18:13Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/PreheatClassScanner.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package org.hisp.dhis.tracker.preheat.supplier;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.hisp.dhis.tracker.preheat.supplier.classStrategy.StrategyFor;\n+\n+import io.github.classgraph.AnnotationClassRef;\n+import io.github.classgraph.AnnotationInfo;\n+import io.github.classgraph.ClassGraph;\n+import io.github.classgraph.ClassInfo;\n+import io.github.classgraph.ScanResult;\n+\n+/**\n+ * This class is responsible for creating an associative map where the key is\n+ * the name of a Strategy class and the key is the name of the domain object\n+ * class to cache (based on the {@see StrategyFor} annotation)\n+ * \n+ * @author Luciano Fiandesio\n+ */\n+public class PreheatClassScanner\n+{\n+    public List<String> scanSuppliers()\n+    {\n+        final String pkg = getCurrentPackage();\n+        final String annotation = SupplierDependsOn.class.getName();\n+        try (ScanResult scanResult = new ClassGraph()\n+            // .disableJarScanning()", "originalCommit": "ba3d0c65763776306e3b3c9ef501e5f7580544f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1Njc1MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521256751", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUxODU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyNDU5Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520524597", "bodyText": "Not sure if I'm just not thinking straight, but I'm not sure this for loop does what we want it to?\nSo, I understand it as if we want to sort the list so that dependencies comes in the correct order. IE. if A->B->C, we want to make sure the list follows this.\nHowever, if we have an already ordered list, A->B->C, and C depends on A (which is still true in this order), we swap A and C, ending up out of order? So we need an if statement making sure we only swap when indexOf dependency is higher than current class?", "author": "stian-sandvold", "createdAt": "2020-11-10T12:29:00Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/PreheatClassScanner.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package org.hisp.dhis.tracker.preheat.supplier;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.hisp.dhis.tracker.preheat.supplier.classStrategy.StrategyFor;\n+\n+import io.github.classgraph.AnnotationClassRef;\n+import io.github.classgraph.AnnotationInfo;\n+import io.github.classgraph.ClassGraph;\n+import io.github.classgraph.ClassInfo;\n+import io.github.classgraph.ScanResult;\n+\n+/**\n+ * This class is responsible for creating an associative map where the key is\n+ * the name of a Strategy class and the key is the name of the domain object\n+ * class to cache (based on the {@see StrategyFor} annotation)\n+ * \n+ * @author Luciano Fiandesio\n+ */\n+public class PreheatClassScanner\n+{\n+    public List<String> scanSuppliers()\n+    {\n+        final String pkg = getCurrentPackage();\n+        final String annotation = SupplierDependsOn.class.getName();\n+        try (ScanResult scanResult = new ClassGraph()\n+            // .disableJarScanning()\n+            .enableAllInfo()\n+            .disableNestedJarScanning()\n+            .acceptPackages( pkg )\n+            .scan())\n+        {\n+            List<String> cls = scanResult.getAllClasses().stream()\n+                .filter( c -> c.extendsSuperclass( AbstractPreheatSupplier.class.getName() ) )\n+                .map( ClassInfo::getSimpleName ).collect( Collectors.toList() );\n+\n+            for ( ClassInfo classInfo : scanResult.getClassesWithAnnotation( annotation ) )\n+            {\n+                String dependsOn = getTargetClass( classInfo, annotation );", "originalCommit": "ba3d0c65763776306e3b3c9ef501e5f7580544f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1Njk5OA==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521256998", "bodyText": "Removed entire class-path based logic", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyNDU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzMDAwOA==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520530008", "bodyText": "Entire class is commented out", "author": "stian-sandvold", "createdAt": "2020-11-10T12:38:27Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/UserSupplier.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package org.hisp.dhis.tracker.preheat.supplier;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.hisp.dhis.common.CodeGenerator;\n+import org.hisp.dhis.common.IdentifiableObjectManager;\n+import org.hisp.dhis.tracker.TrackerIdentifier;\n+import org.hisp.dhis.tracker.domain.Event;\n+import org.hisp.dhis.tracker.preheat.TrackerPreheat;\n+import org.hisp.dhis.tracker.preheat.TrackerPreheatParams;\n+import org.hisp.dhis.user.User;\n+import org.springframework.stereotype.Component;\n+\n+import lombok.NonNull;\n+import lombok.RequiredArgsConstructor;\n+\n+/**\n+ * @author Luciano Fiandesio\n+ */\n+@RequiredArgsConstructor\n+@Component", "originalCommit": "ba3d0c65763776306e3b3c9ef501e5f7580544f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1NzE5MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521257191", "bodyText": "False positive :)", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzMDAwOA=="}], "type": "inlineReview"}, {"oid": "e394071a1d2fc0eba487e87963bf70f47a368b60", "url": "https://github.com/dhis2/dhis2-core/commit/e394071a1d2fc0eba487e87963bf70f47a368b60", "message": "Removed class-path scanning for preheat supplier, use standard config\n\nRemoved `getSchemaClass` methods from supplier strategy", "committedDate": "2020-11-10T13:52:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzOTg1MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520639851", "bodyText": "I'm sure it doesn't add much overhead, but if debug isn't enabled maybe we can just skip the creation/starting of it?", "author": "mortenoh", "createdAt": "2020-11-10T15:14:03Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/AbstractPreheatSupplier.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package org.hisp.dhis.tracker.preheat.supplier;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.lang3.time.StopWatch;\n+import org.hisp.dhis.tracker.preheat.TrackerPreheat;\n+import org.hisp.dhis.tracker.preheat.TrackerPreheatParams;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * A {@link PreheatSupplier} subclass can implement this abstract class to\n+ * execute code before and after the supplier has been executed (e.g. timing)\n+ * \n+ * @author Luciano Fiandesio\n+ */\n+@Slf4j\n+public abstract class AbstractPreheatSupplier implements PreheatSupplier\n+{\n+    @Override\n+    public void add( TrackerPreheatParams params, TrackerPreheat preheat )\n+    {\n+        log.debug( \"Executing preheat supplier: {}\", this.getClass().getName() );\n+        StopWatch watch = new StopWatch();", "originalCommit": "e394071a1d2fc0eba487e87963bf70f47a368b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1ODM3Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521258376", "bodyText": "Fixed: added log.isDebugEnabled() to stopwatch logic", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:22:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzOTg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0MTgzMg==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520641832", "bodyText": "newline", "author": "mortenoh", "createdAt": "2020-11-10T15:16:31Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/PreheatStrategyScanner.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.hisp.dhis.tracker.preheat.supplier;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.hisp.dhis.tracker.preheat.supplier.classStrategy.StrategyFor;\n+\n+import io.github.classgraph.AnnotationClassRef;\n+import io.github.classgraph.AnnotationInfo;\n+import io.github.classgraph.ClassGraph;\n+import io.github.classgraph.ClassInfo;\n+import io.github.classgraph.ScanResult;\n+\n+/**\n+ * This class is responsible for creating an associative map where the key is\n+ * the name of a Strategy class and the key is the name of the domain object\n+ * class to cache (based on the {@see StrategyFor} annotation)\n+ * \n+ * @author Luciano Fiandesio\n+ */\n+public class PreheatStrategyScanner\n+{\n+    public Map<String, String> scanSupplierStrategies()\n+    {\n+        Map<String, String> classMap = new HashMap<>();\n+        final String pkg = getCurrentPackage();\n+        final String annotation = StrategyFor.class.getName();", "originalCommit": "e394071a1d2fc0eba487e87963bf70f47a368b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1ODg5Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521258896", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0MTgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0MTk1Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520641957", "bodyText": "newline", "author": "mortenoh", "createdAt": "2020-11-10T15:16:41Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/PreheatStrategyScanner.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.hisp.dhis.tracker.preheat.supplier;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.hisp.dhis.tracker.preheat.supplier.classStrategy.StrategyFor;\n+\n+import io.github.classgraph.AnnotationClassRef;\n+import io.github.classgraph.AnnotationInfo;\n+import io.github.classgraph.ClassGraph;\n+import io.github.classgraph.ClassInfo;\n+import io.github.classgraph.ScanResult;\n+\n+/**\n+ * This class is responsible for creating an associative map where the key is\n+ * the name of a Strategy class and the key is the name of the domain object\n+ * class to cache (based on the {@see StrategyFor} annotation)\n+ * \n+ * @author Luciano Fiandesio\n+ */\n+public class PreheatStrategyScanner\n+{\n+    public Map<String, String> scanSupplierStrategies()\n+    {\n+        Map<String, String> classMap = new HashMap<>();\n+        final String pkg = getCurrentPackage();\n+        final String annotation = StrategyFor.class.getName();\n+        try (ScanResult scanResult = new ClassGraph()\n+            .enableClassInfo()\n+            .acceptPackages( pkg )\n+            .enableAnnotationInfo()\n+            .scan())\n+        {\n+            for ( ClassInfo classInfo : scanResult.getClassesWithAnnotation( annotation ) )\n+            {\n+                classMap.put( getTargetClass( classInfo, annotation ), classInfo.getSimpleName() );\n+            }\n+        }", "originalCommit": "e394071a1d2fc0eba487e87963bf70f47a368b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1ODk0MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521258941", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0MTk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0MjM0OA==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520642348", "bodyText": "newline", "author": "mortenoh", "createdAt": "2020-11-10T15:17:10Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/PreheatStrategyScanner.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.hisp.dhis.tracker.preheat.supplier;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.hisp.dhis.tracker.preheat.supplier.classStrategy.StrategyFor;\n+\n+import io.github.classgraph.AnnotationClassRef;\n+import io.github.classgraph.AnnotationInfo;\n+import io.github.classgraph.ClassGraph;\n+import io.github.classgraph.ClassInfo;\n+import io.github.classgraph.ScanResult;\n+\n+/**\n+ * This class is responsible for creating an associative map where the key is\n+ * the name of a Strategy class and the key is the name of the domain object\n+ * class to cache (based on the {@see StrategyFor} annotation)\n+ * \n+ * @author Luciano Fiandesio\n+ */\n+public class PreheatStrategyScanner\n+{\n+    public Map<String, String> scanSupplierStrategies()\n+    {\n+        Map<String, String> classMap = new HashMap<>();\n+        final String pkg = getCurrentPackage();\n+        final String annotation = StrategyFor.class.getName();\n+        try (ScanResult scanResult = new ClassGraph()\n+            .enableClassInfo()\n+            .acceptPackages( pkg )\n+            .enableAnnotationInfo()\n+            .scan())\n+        {\n+            for ( ClassInfo classInfo : scanResult.getClassesWithAnnotation( annotation ) )\n+            {\n+                classMap.put( getTargetClass( classInfo, annotation ), classInfo.getSimpleName() );\n+            }\n+        }\n+        return classMap;\n+    }\n+\n+    private String getCurrentPackage()\n+    {\n+        return this.getClass().getPackage().getName();\n+    }\n+\n+    private String getTargetClass( ClassInfo classInfo, String annotation )\n+    {\n+        AnnotationInfo annotationInfo = classInfo.getAnnotationInfo( annotation );\n+        AnnotationClassRef klazz = (AnnotationClassRef) annotationInfo.getParameterValues().get( 0 ).getValue();", "originalCommit": "e394071a1d2fc0eba487e87963bf70f47a368b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1OTk2Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521259966", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0MjM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0Nzc0Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r520647747", "bodyText": "newline", "author": "mortenoh", "createdAt": "2020-11-10T15:24:08Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/supplier/classStrategy/AbstractSchemaStrategy.java", "diffHunk": "@@ -0,0 +1,125 @@\n+package org.hisp.dhis.tracker.preheat.supplier.classStrategy;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.util.List;\n+\n+import org.hisp.dhis.attribute.Attribute;\n+import org.hisp.dhis.common.IdentifiableObject;\n+import org.hisp.dhis.common.IdentifiableObjectManager;\n+import org.hisp.dhis.fieldfilter.Defaults;\n+import org.hisp.dhis.query.Query;\n+import org.hisp.dhis.query.QueryService;\n+import org.hisp.dhis.query.Restriction;\n+import org.hisp.dhis.query.Restrictions;\n+import org.hisp.dhis.schema.Schema;\n+import org.hisp.dhis.schema.SchemaService;\n+import org.hisp.dhis.tracker.TrackerIdScheme;\n+import org.hisp.dhis.tracker.TrackerIdentifier;\n+import org.hisp.dhis.tracker.preheat.TrackerPreheat;\n+import org.hisp.dhis.tracker.preheat.TrackerPreheatParams;\n+\n+/**\n+ * Abstract Tracker Preheat strategy that applies to strategies that employ the\n+ * generic {@link QueryService} to fetch data\n+ * \n+ * @author Luciano Fiandesio\n+ */\n+public abstract class AbstractSchemaStrategy implements ClassBasedSupplierStrategy\n+{\n+    protected final SchemaService schemaService;\n+\n+    private final QueryService queryService;\n+\n+    private final IdentifiableObjectManager manager;\n+\n+    public AbstractSchemaStrategy( SchemaService schemaService, QueryService queryService,\n+        IdentifiableObjectManager manager )\n+    {\n+        this.schemaService = schemaService;\n+        this.queryService = queryService;\n+        this.manager = manager;\n+    }\n+\n+    @Override\n+    public void add( TrackerPreheatParams params, List<List<String>> splitList, TrackerPreheat preheat )\n+    {\n+        TrackerIdentifier identifier = params.getIdentifiers().getByClass( getSchemaClass() );\n+        Schema schema = schemaService.getDynamicSchema( getSchemaClass() );\n+\n+        queryForIdentifiableObjects( preheat, schema, identifier, splitList );\n+    }\n+\n+    protected Class<?> getSchemaClass()\n+    {\n+        return getClass().getAnnotation( StrategyFor.class ).value();\n+    }\n+\n+    @SuppressWarnings( \"unchecked\" )\n+    protected void queryForIdentifiableObjects( TrackerPreheat preheat, Schema schema, TrackerIdentifier identifier,\n+        List<List<String>> splitList )\n+    {\n+        TrackerIdScheme idScheme = identifier.getIdScheme();", "originalCommit": "e394071a1d2fc0eba487e87963bf70f47a368b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1OTk0Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6560#discussion_r521259947", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-11-11T10:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY0Nzc0Nw=="}], "type": "inlineReview"}, {"oid": "25a8d13023b860c65c8c84a2ea0bdf49ec1bf658", "url": "https://github.com/dhis2/dhis2-core/commit/25a8d13023b860c65c8c84a2ea0bdf49ec1bf658", "message": "chore: address review comments", "committedDate": "2020-11-11T10:26:35Z", "type": "commit"}]}