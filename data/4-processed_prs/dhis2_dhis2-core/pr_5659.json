{"pr_number": 5659, "pr_title": "fix: Use error codes in analytics API [DHIS2-8964]", "pr_createdAt": "2020-06-02T15:26:55Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5659", "timeline": [{"oid": "300625394d9266348e39a398da593a7d7f84df8e", "url": "https://github.com/dhis2/dhis2-core/commit/300625394d9266348e39a398da593a7d7f84df8e", "message": "Moved visualization to correct package", "committedDate": "2020-05-27T09:42:03Z", "type": "commit"}, {"oid": "745d872c9d75fcbeebba534e228686b14dfbc5ad", "url": "https://github.com/dhis2/dhis2-core/commit/745d872c9d75fcbeebba534e228686b14dfbc5ad", "message": "Cleanup", "committedDate": "2020-05-27T09:45:13Z", "type": "commit"}, {"oid": "8fd1033cd417b6b85ec47d488ebd8dc0e3fc9d44", "url": "https://github.com/dhis2/dhis2-core/commit/8fd1033cd417b6b85ec47d488ebd8dc0e3fc9d44", "message": "Cleanup", "committedDate": "2020-05-27T09:46:30Z", "type": "commit"}, {"oid": "b1e3389924b8a66e9e3c271b6fb1999864c070f5", "url": "https://github.com/dhis2/dhis2-core/commit/b1e3389924b8a66e9e3c271b6fb1999864c070f5", "message": "Merge branch 'master' into lars-dev", "committedDate": "2020-05-28T07:16:47Z", "type": "commit"}, {"oid": "92b097da5a7c99866f211541888db690dfb834f6", "url": "https://github.com/dhis2/dhis2-core/commit/92b097da5a7c99866f211541888db690dfb834f6", "message": "Cleanup", "committedDate": "2020-05-28T07:24:56Z", "type": "commit"}, {"oid": "cad133f7ec2cf2f668e1f656482a188f2f26e0e7", "url": "https://github.com/dhis2/dhis2-core/commit/cad133f7ec2cf2f668e1f656482a188f2f26e0e7", "message": "Merge branch 'master' into lars-dev", "committedDate": "2020-05-28T07:26:28Z", "type": "commit"}, {"oid": "74087ee01f340832bf0b8d7c526c5cd81409b96e", "url": "https://github.com/dhis2/dhis2-core/commit/74087ee01f340832bf0b8d7c526c5cd81409b96e", "message": "Various", "committedDate": "2020-06-02T08:50:32Z", "type": "commit"}, {"oid": "b90dfc2943856bec149044f4c932fd946f8dcd61", "url": "https://github.com/dhis2/dhis2-core/commit/b90dfc2943856bec149044f4c932fd946f8dcd61", "message": "Minor", "committedDate": "2020-06-02T08:56:27Z", "type": "commit"}, {"oid": "5fab7169ecfd55470fc675e7397eaa843f60acfa", "url": "https://github.com/dhis2/dhis2-core/commit/5fab7169ecfd55470fc675e7397eaa843f60acfa", "message": "Minor", "committedDate": "2020-06-02T09:28:25Z", "type": "commit"}, {"oid": "65392137ecfdc17b207c7bf9fa140d259b0af769", "url": "https://github.com/dhis2/dhis2-core/commit/65392137ecfdc17b207c7bf9fa140d259b0af769", "message": "Minor", "committedDate": "2020-06-02T09:30:37Z", "type": "commit"}, {"oid": "b1b6cf84af56eda4764737f70c311bcc861a0b32", "url": "https://github.com/dhis2/dhis2-core/commit/b1b6cf84af56eda4764737f70c311bcc861a0b32", "message": "Merge branch 'master' into lars-dev", "committedDate": "2020-06-02T10:05:46Z", "type": "commit"}, {"oid": "efc1143f9d38899daba1164cdb4321003be16877", "url": "https://github.com/dhis2/dhis2-core/commit/efc1143f9d38899daba1164cdb4321003be16877", "message": "Use error codes in analytics security", "committedDate": "2020-06-02T15:26:30Z", "type": "commit"}, {"oid": "2a3ecc8d91d44acbf652e2888b608935fb2cfbcb", "url": "https://github.com/dhis2/dhis2-core/commit/2a3ecc8d91d44acbf652e2888b608935fb2cfbcb", "message": "Error codes", "committedDate": "2020-06-02T16:05:11Z", "type": "commit"}, {"oid": "72cb841a4d68c5c55ea003c638e1e68cbc764f65", "url": "https://github.com/dhis2/dhis2-core/commit/72cb841a4d68c5c55ea003c638e1e68cbc764f65", "message": "Error codes", "committedDate": "2020-06-02T16:19:26Z", "type": "commit"}, {"oid": "b436334a9f66dfa76fb8a1f76a31ab9d3b3095be", "url": "https://github.com/dhis2/dhis2-core/commit/b436334a9f66dfa76fb8a1f76a31ab9d3b3095be", "message": "Error codes", "committedDate": "2020-06-02T21:26:32Z", "type": "commit"}, {"oid": "45fa2d8efa3b01257dec4ff587fb8416fba1dc49", "url": "https://github.com/dhis2/dhis2-core/commit/45fa2d8efa3b01257dec4ff587fb8416fba1dc49", "message": "Add test", "committedDate": "2020-06-02T21:46:23Z", "type": "commit"}, {"oid": "15809451af699e3200bdab1c4961b559cc6a93ba", "url": "https://github.com/dhis2/dhis2-core/commit/15809451af699e3200bdab1c4961b559cc6a93ba", "message": "test", "committedDate": "2020-06-02T21:54:49Z", "type": "commit"}, {"oid": "3849c2c622320d2bf96465e5fbbe2dcc9b091bed", "url": "https://github.com/dhis2/dhis2-core/commit/3849c2c622320d2bf96465e5fbbe2dcc9b091bed", "message": "Minor", "committedDate": "2020-06-02T22:13:39Z", "type": "commit"}, {"oid": "7a215321bda5b24f60dafac78b528ad1bd0622e9", "url": "https://github.com/dhis2/dhis2-core/commit/7a215321bda5b24f60dafac78b528ad1bd0622e9", "message": "Minor", "committedDate": "2020-06-02T22:27:38Z", "type": "commit"}, {"oid": "6137119d5bfd74cabc17b4cb18ceaf45cc9caabf", "url": "https://github.com/dhis2/dhis2-core/commit/6137119d5bfd74cabc17b4cb18ceaf45cc9caabf", "message": "Added test", "committedDate": "2020-06-03T09:57:27Z", "type": "commit"}, {"oid": "56451b9b8fcb15394786ff04c2097e40bed81b8a", "url": "https://github.com/dhis2/dhis2-core/commit/56451b9b8fcb15394786ff04c2097e40bed81b8a", "message": "Minor", "committedDate": "2020-06-03T09:59:21Z", "type": "commit"}, {"oid": "846ab7405144a46d6baa01ebc13f6466380d6c09", "url": "https://github.com/dhis2/dhis2-core/commit/846ab7405144a46d6baa01ebc13f6466380d6c09", "message": "Minor", "committedDate": "2020-06-03T09:59:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ3NjYzMA==", "url": "https://github.com/dhis2/dhis2-core/pull/5659#discussion_r434476630", "bodyText": "Minor: you can also consider using the ExpectedException Rule, for asserting on exceptions, like so (or use an utility method that operates on the ExpectedException object):\nimport org.hamcrest.CoreMatchers;\nimport org.hamcrest.Matchers;\nimport org.junit.Rule;\nimport org.junit.rules.ExpectedException;\n\n@Rule\n    public ExpectedException exception = ExpectedException.none();\n\n    @Test\n    public void testValidateNoOrgUnits()\n    {\n        OrgUnitQueryParams params = new OrgUnitQueryParams.Builder()\n            .withOrgUnitGroupSets( Lists.newArrayList( createOrganisationUnitGroupSet( 'A' ) ) )\n            .build();\n\n        exception.expectMessage( \"At least one organisation unit must be specified\" );\n        exception.expect( IllegalQueryException.class );\n        exception.reportMissingExceptionWithMessage( \"Expected exception\" );\n        exception.expect( Matchers.hasProperty( \"errorCode\", CoreMatchers.is( ErrorCode.E7300 ) ) );\n\n        subject.validate( params );\n    }", "author": "luciano-fiandesio", "createdAt": "2020-06-03T10:46:01Z", "path": "dhis-2/dhis-services/dhis-service-analytics/src/test/java/org/hisp/dhis/analytics/orgunit/OrgUnitAnalyticsServiceTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+package org.hisp.dhis.analytics.orgunit;\n+\n+import static org.hisp.dhis.analytics.util.AnalyticsTestUtils.assertIllegalQueryEx;\n+\n+import org.hisp.dhis.DhisSpringTest;\n+import org.hisp.dhis.feedback.ErrorCode;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import com.google.common.collect.Lists;\n+\n+/**\n+ * @author Lars Helge Overland\n+ */\n+public class OrgUnitAnalyticsServiceTest\n+    extends DhisSpringTest\n+{\n+    @Autowired\n+    private OrgUnitAnalyticsService subject;\n+\n+    @Test\n+    public void testValidateNoOrgUnits()\n+    {\n+        OrgUnitQueryParams params = new OrgUnitQueryParams.Builder()\n+            .withOrgUnitGroupSets( Lists.newArrayList( createOrganisationUnitGroupSet( 'A' ) ) )\n+            .build();\n+\n+        assertIllegalQueryEx( p -> subject.validate( p ), params, ErrorCode.E7300 );", "originalCommit": "846ab7405144a46d6baa01ebc13f6466380d6c09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ5NzI2Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5659#discussion_r434497262", "bodyText": "Great, I was aware of ExceptedException but not:\nexception.expect( Matchers.hasProperty( \"errorCode\", CoreMatchers.is( ErrorCode.E7300 ) ) );\nThanks!", "author": "larshelge", "createdAt": "2020-06-03T11:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ3NjYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUyODE0Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5659#discussion_r434528147", "bodyText": "Rewrote it now using JUnit/Hamcrest.", "author": "larshelge", "createdAt": "2020-06-03T12:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ3NjYzMA=="}], "type": "inlineReview"}, {"oid": "441729f993b3ef598b34c7e6f4792e9befc0ea88", "url": "https://github.com/dhis2/dhis2-core/commit/441729f993b3ef598b34c7e6f4792e9befc0ea88", "message": "Update test", "committedDate": "2020-06-03T11:42:28Z", "type": "commit"}, {"oid": "8897dedda5fad975ce880cec0678db3094b0a190", "url": "https://github.com/dhis2/dhis2-core/commit/8897dedda5fad975ce880cec0678db3094b0a190", "message": "Javadocs", "committedDate": "2020-06-03T12:26:59Z", "type": "commit"}, {"oid": "3c8dcdbbac9690ba163b4d6635c6cc976419810f", "url": "https://github.com/dhis2/dhis2-core/commit/3c8dcdbbac9690ba163b4d6635c6cc976419810f", "message": "Update test", "committedDate": "2020-06-03T12:29:43Z", "type": "commit"}]}