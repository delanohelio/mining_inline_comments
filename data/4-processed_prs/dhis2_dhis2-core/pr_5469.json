{"pr_number": 5469, "pr_title": "fix: [DHIS2-2652] Block deletion of org unit group and set linked to \u2026", "pr_createdAt": "2020-04-27T10:07:32Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5469", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1MDg2NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r423050865", "bodyText": "For all your SQL, stick with either uppercase or lowercase for SQL keywords :)", "author": "stian-sandvold", "createdAt": "2020-05-11T13:46:16Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "diffHunk": "@@ -129,13 +137,36 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventChart> charts = eventChartService.getAllEventCharts();\n-        \n+\n         for ( EventChart chart : charts )\n         {\n-            if ( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n                 eventChartService.deleteEventChart( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"select count(*) \"", "originalCommit": "2e2b937ba17db359d75841fdbab9270991117b5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1MjMwNA==", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r423052304", "bodyText": "Also, the WHERE on a new line maybe :)?", "author": "stian-sandvold", "createdAt": "2020-05-11T13:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1MDg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3NjE2Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r425176163", "bodyText": "Use explicit join (\"inner join\") to remove ambiguity.", "author": "larshelge", "createdAt": "2020-05-14T14:22:23Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "diffHunk": "@@ -129,13 +137,37 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventChart> charts = eventChartService.getAllEventCharts();\n-        \n+\n         for ( EventChart chart : charts )\n         {\n-            if ( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n                 eventChartService.deleteEventChart( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventchart_orgunitgroupsetdimensions e \"\n+            + \" ON d.orgunitgroupsetdimensionid = e.orgunitgroupsetdimensionid \"\n+            + \" WHERE d.orgunitgroupsetid = \"\n+            + groupSet.getId();\n+\n+        return jdbcTemplate.queryForObject( sql, Integer.class ) == 0 ? null : \"orgunitgroupsetdimension\";\n+    }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroup( OrganisationUnitGroup group )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventchart_orgunitgroupsetdimensions e \"", "originalCommit": "16399b46ec248c13322ac351df5d36838b386e8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4MjMzMw==", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r425182333", "bodyText": "Use lower-case only in SQL statements for consistency.", "author": "larshelge", "createdAt": "2020-05-14T14:30:09Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventreport/EventReportDeletionHandler.java", "diffHunk": "@@ -129,13 +138,36 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventReport> charts = eventReportService.getAllEventReports();\n-        \n+\n         for ( EventReport chart : charts )\n         {\n-            if( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n-               eventReportService.deleteEventReport( chart );\n+                eventReportService.deleteEventReport( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventreport_orgunitgroupsetdimensions e \"", "originalCommit": "16399b46ec248c13322ac351df5d36838b386e8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4", "url": "https://github.com/dhis2/dhis2-core/commit/bc96a0521fbc9fcd91f695a9462405e1240ed8a4", "message": "fix: Delete OU groups and sets using generic deletion handler [DHIS2-2652]", "committedDate": "2020-06-01T13:42:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MTM0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r438191342", "bodyText": "Just asking so that I understand - Do we need to filter out OrganisationUnitGroupSetDimensions, don't we already know they match after doing the query in analytical store with OrganisationUnitGroupSetDimension as the argument?", "author": "larshelge", "createdAt": "2020-06-10T14:59:50Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/common/GenericAnalyticalObjectDeletionHandler.java", "diffHunk": "@@ -96,10 +106,52 @@ public String allowDeletePeriod( Period period )\n     @Override\n     public void deleteOrganisationUnit( OrganisationUnit organisationUnit )\n     {\n-        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit, ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit,\n+            ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+    }\n+\n+    @Override\n+    public void deleteOrganisationUnitGroup( OrganisationUnitGroup organisationUnitGroup )\n+    {\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnitGroup ), organisationUnitGroup,\n+            ( ao, di ) -> {\n+                List<OrganisationUnitGroupSetDimension> dimensionsToDelete = ao.getOrganisationUnitGroupSetDimensions()", "originalCommit": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY3NjgzNA==", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r438676834", "bodyText": "From the store we are retrieving AnalyticalObjects with the provided dimension.\nIn the consumer we are deleting the dimension linked to the group that we are deleting.\nSo we know that in the AnalyticalObject there is something to delete, but we do not want to delete all the dimensions in it.", "author": "enricocolasante", "createdAt": "2020-06-11T10:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MTM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1Mzk2NA==", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r438853964", "bodyText": "Right, makes sense, got it.", "author": "larshelge", "createdAt": "2020-06-11T15:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MTM0Mg=="}], "type": "inlineReview"}, {"oid": "b4823f7f02090115b634353aba9ae54128a6c45e", "url": "https://github.com/dhis2/dhis2-core/commit/b4823f7f02090115b634353aba9ae54128a6c45e", "message": "fix: Delete OU groups and sets using generic deletion handler [DHIS2-2652]", "committedDate": "2020-06-11T10:06:06Z", "type": "commit"}, {"oid": "b4823f7f02090115b634353aba9ae54128a6c45e", "url": "https://github.com/dhis2/dhis2-core/commit/b4823f7f02090115b634353aba9ae54128a6c45e", "message": "fix: Delete OU groups and sets using generic deletion handler [DHIS2-2652]", "committedDate": "2020-06-11T10:06:06Z", "type": "forcePushed"}]}