{"pr_number": 6932, "pr_title": "feat: DHIS2-9084 new tracker import sync endpoint", "pr_createdAt": "2020-12-17T11:46:58Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6932", "timeline": [{"oid": "be41f93497286deb845d297f3389a7999059d153", "url": "https://github.com/dhis2/dhis2-core/commit/be41f93497286deb845d297f3389a7999059d153", "message": "feat: DHIS2-9084 new tracker import sync endpoint", "committedDate": "2020-12-17T11:24:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTAyOTI4MA==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r545029280", "bodyText": "we can decide whether use it like\n/tracker?async=false\n\nor\n/tracker/async\n\nthe latter was suggested by @luciano-fiandesio . Honestly I have no personal preference over the one or the other", "author": "gnespolino", "createdAt": "2020-12-17T11:48:45Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerController.java", "diffHunk": "@@ -124,6 +105,56 @@ public void postJsonTracker( HttpServletRequest request, HttpServletResponse res\n                     .build() ) );\n     }\n \n+    @PostMapping( value = \"\", consumes = MediaType.APPLICATION_JSON_VALUE, params = { \"async=false\" } )", "originalCommit": "be41f93497286deb845d297f3389a7999059d153", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0MzI2MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r545043261", "bodyText": "space after parenthesis", "author": "luciano-fiandesio", "createdAt": "2020-12-17T12:12:51Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerController.java", "diffHunk": "@@ -140,16 +171,7 @@ public TrackerImportReport getJobReport( @PathVariable String uid,\n         HttpServletResponse response )\n         throws HttpStatusCodeException\n     {\n-        TrackerBundleReportMode trackerBundleReportMode;\n-        try\n-        {\n-            trackerBundleReportMode = TrackerBundleReportMode.valueOf( reportMode.toUpperCase() );\n-        }\n-        catch ( IllegalArgumentException e )\n-        {\n-            throw new HttpClientErrorException( HttpStatus.BAD_REQUEST,\n-                \"Value \" + reportMode + \" is not a valid report mode\" );\n-        }\n+        TrackerBundleReportMode trackerBundleReportMode = getTrackerBundleReportMode(reportMode);", "originalCommit": "be41f93497286deb845d297f3389a7999059d153", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE0NjI2Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r545146263", "bodyText": "fixed", "author": "gnespolino", "createdAt": "2020-12-17T14:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0MzI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0Mzc1OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r545043759", "bodyText": "formatting", "author": "luciano-fiandesio", "createdAt": "2020-12-17T12:13:48Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerImportParamsBuilder.java", "diffHunk": "@@ -135,4 +136,40 @@ private static String getAttributeUidOrNull( Map<String, List<String>> parameter\n \n         return null;\n     }\n+\n+    private static TrackerIdentifier bySchemeAndKey( Map<String, List<String>> parameters,\n+                                                     TrackerImportParamKey trackerImportParameterKey,\n+                                                     TrackerIdScheme defaultIdScheme )\n+    {\n+\n+        TrackerIdScheme trackerIdScheme = getEnumWithDefault(\n+                TrackerIdScheme.class,", "originalCommit": "be41f93497286deb845d297f3389a7999059d153", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NDAzMg==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r545044032", "bodyText": "space after parenthesis", "author": "luciano-fiandesio", "createdAt": "2020-12-17T12:14:16Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerImportParamsBuilder.java", "diffHunk": "@@ -135,4 +136,40 @@ private static String getAttributeUidOrNull( Map<String, List<String>> parameter\n \n         return null;\n     }\n+\n+    private static TrackerIdentifier bySchemeAndKey( Map<String, List<String>> parameters,\n+                                                     TrackerImportParamKey trackerImportParameterKey,\n+                                                     TrackerIdScheme defaultIdScheme )\n+    {\n+\n+        TrackerIdScheme trackerIdScheme = getEnumWithDefault(\n+                TrackerIdScheme.class,\n+                parameters,\n+                trackerImportParameterKey,\n+                defaultIdScheme );\n+\n+        return TrackerIdentifier.of( trackerIdScheme, getAttributeUidOrNull( parameters, trackerImportParameterKey ) );\n+    }\n+\n+    enum TrackerImportParamKey\n+    {\n+        VALIDATION_MODE_KEY( \"validationMode\" ),\n+        IMPORT_MODE_KEY( \"importMode\" ),\n+        IMPORT_STRATEGY_KEY( \"importStrategy\" ),\n+        ATOMIC_MODE_KEY( \"atomicMode\" ),\n+        FLUSH_MODE_KEY( \"flushMode\" ),\n+        SKIP_RULE_ENGINE_KEY( \"skipRuleEngine\" ),\n+        ID_SCHEME_KEY( \"idScheme\" ),\n+        ORG_UNIT_ID_SCHEME_KEY( \"orgUnitIdScheme\" ),\n+        PROGRAM_ID_SCHEME_KEY( \"programIdScheme\" ),\n+        PROGRAM_STAGE_ID_SCHEME_KEY( \"programStageIdScheme\" ),\n+        DATA_ELEMENT_ID_SCHEME_KEY( \"dataElementIdScheme\" );\n+\n+        @Getter\n+        private final String key;\n+\n+        TrackerImportParamKey(String key) {", "originalCommit": "be41f93497286deb845d297f3389a7999059d153", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE0NjM5MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r545146391", "bodyText": "fixed", "author": "gnespolino", "createdAt": "2020-12-17T14:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0NDAzMg=="}], "type": "inlineReview"}, {"oid": "a07e7e9b1573095afaf1cdfe933164d5adcc7ec7", "url": "https://github.com/dhis2/dhis2-core/commit/a07e7e9b1573095afaf1cdfe933164d5adcc7ec7", "message": "feat: DHIS2-9084 mockmvc tests added", "committedDate": "2020-12-17T14:47:16Z", "type": "commit"}, {"oid": "d32f78c5b0f62e95bc1ee0a49ca600b7889e30dd", "url": "https://github.com/dhis2/dhis2-core/commit/d32f78c5b0f62e95bc1ee0a49ca600b7889e30dd", "message": "feat: DHIS2-9084 fail test on wrong response in sync invocation", "committedDate": "2020-12-17T14:56:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1NTE2NA==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r546355164", "bodyText": "package declaration is \"usually\" before the copyright statement. I understand its a bit tricky because there are some files which does not follow it. But the norm is before the copyright,", "author": "ameenhere", "createdAt": "2020-12-20T10:16:31Z", "path": "dhis-2/dhis-web/dhis-web-api/src/test/java/org/hisp/dhis/webapi/controller/tracker/TrackerControllerTest.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ *  Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ *  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ *  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ *  ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ *  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ *  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ *\n+ */\n+\n+package org.hisp.dhis.webapi.controller.tracker;", "originalCommit": "d32f78c5b0f62e95bc1ee0a49ca600b7889e30dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU3ODIyNA==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r546578224", "bodyText": "I'll change this, thank you", "author": "gnespolino", "createdAt": "2020-12-21T08:45:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1NTE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1NTMwNA==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r546355304", "bodyText": "Can we remove this if this is no longer required?", "author": "ameenhere", "createdAt": "2020-12-20T10:17:36Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerController.java", "diffHunk": "@@ -80,50 +86,77 @@\n \n     private final Notifier notifier;\n \n-    public TrackerController(\n-        TrackerImportService trackerImportService,\n-        RenderService renderService,\n-        ContextService contextService,\n-        TrackerMessageManager trackerMessageManager,\n-        Notifier notifier )\n-    {\n-        this.trackerImportService = trackerImportService;\n-        this.renderService = renderService;\n-        this.contextService = contextService;\n-        this.trackerMessageManager = trackerMessageManager;\n-        this.notifier = notifier;\n-    }\n-\n     @PostMapping( value = \"\", consumes = MediaType.APPLICATION_JSON_VALUE )\n-//    @PreAuthorize( \"hasRole('ALL') or hasRole('F_TRACKER_IMPORTER_EXPERIMENTAL')\" )\n-    public void postJsonTracker( HttpServletRequest request, HttpServletResponse response, User currentUser )\n+    // @PreAuthorize( \"hasRole('ALL') or hasRole('F_TRACKER_IMPORTER_EXPERIMENTAL')\" )", "originalCommit": "d32f78c5b0f62e95bc1ee0a49ca600b7889e30dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU3ODcyOA==", "url": "https://github.com/dhis2/dhis2-core/pull/6932#discussion_r546578728", "bodyText": "I'm not sure, async endpoint still have this one (commented). SYSTEM user have this permission so maybe we might even keep it still uncommented, or remove at all if not necessary.", "author": "gnespolino", "createdAt": "2020-12-21T08:46:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM1NTMwNA=="}], "type": "inlineReview"}, {"oid": "82bbc5bb9816d2aec3a1a80cf0c2ae01c36c4398", "url": "https://github.com/dhis2/dhis2-core/commit/82bbc5bb9816d2aec3a1a80cf0c2ae01c36c4398", "message": "feat: DHIS2-9084 package before license", "committedDate": "2020-12-21T08:49:20Z", "type": "commit"}]}