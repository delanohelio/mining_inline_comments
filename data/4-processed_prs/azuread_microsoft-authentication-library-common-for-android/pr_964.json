{"pr_number": 964, "pr_title": "Adding \"junk data\" tests to the MSAL Cache", "pr_createdAt": "2020-07-16T18:45:06Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/964", "timeline": [{"oid": "48c0dfd7464534c556a4bd3e206f3e61785bc494", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/48c0dfd7464534c556a4bd3e206f3e61785bc494", "message": "Adding \"junk data\" tests", "committedDate": "2020-07-16T18:38:09Z", "type": "commit"}, {"oid": "9295da14e2430c8d5273a27c6597dd3ad7ef036f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9295da14e2430c8d5273a27c6597dd3ad7ef036f", "message": "Moving consts", "committedDate": "2020-07-16T18:42:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxOTAzOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/964#discussion_r456019039", "bodyText": "Should we check that these have some particular value?", "author": "AdamBJohnsonx", "createdAt": "2020-07-16T19:23:11Z", "path": "common/src/androidTest/java/com/microsoft/identity/common/MsalOAuth2TokenCacheTest.java", "diffHunk": "@@ -344,6 +389,28 @@ public void saveTokensWithAggregationSingleEntry() throws ClientException {\n         assertNotNull(entry.getRefreshToken());\n     }\n \n+    @Test\n+    public void saveTokensWithAggregationSingleEntryWithMalformedDataInCache() throws ClientException {\n+        // Prepopulate the cache with unparseable, junk data\n+        mSharedPreferencesFileManager.putString(JUNK_KEY, JUNK_VALUE);\n+\n+        final List<ICacheRecord> result = loadTestBundleIntoCacheWithAggregation(\n+                defaultTestBundleV2\n+        );\n+\n+        assertEquals(1, result.size());\n+\n+        final ICacheRecord entry = result.get(0);\n+\n+        assertNotNull(entry.getAccount());\n+        assertNotNull(entry.getIdToken());\n+        assertNotNull(entry.getAccessToken());\n+        assertNotNull(entry.getRefreshToken());", "originalCommit": "9295da14e2430c8d5273a27c6597dd3ad7ef036f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA0MzIyMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/964#discussion_r456043223", "bodyText": "Refined in 895c3d2", "author": "iambmelt", "createdAt": "2020-07-16T19:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxOTAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAyMTc0Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/964#discussion_r456021746", "bodyText": "nit: if CredentialType is an enum, then you could replace with a switch.  Also, I think you can provide a string in the fail() method saying why it is failing and assist the poor person viewing the test failure to fix it.", "author": "AdamBJohnsonx", "createdAt": "2020-07-16T19:26:39Z", "path": "common/src/androidTest/java/com/microsoft/identity/common/MsalOAuth2TokenCacheTest.java", "diffHunk": "@@ -294,6 +297,48 @@ public void saveTokens() throws Exception {\n         assertEquals(defaultTestBundleV2.mGeneratedIdToken, ids.get(0));\n     }\n \n+    @Test\n+    public void saveTokensWithMalformedDataInCache() throws Exception {\n+        // Prepopulate the cache with unparseable, junk data\n+        mSharedPreferencesFileManager.putString(JUNK_KEY, JUNK_VALUE);\n+\n+        mOauth2TokenCache.save(\n+                mockStrategy,\n+                mockRequest,\n+                mockResponse\n+        );\n+\n+        final List<AccountRecord> accounts = accountCredentialCache.getAccounts();\n+        assertEquals(1, accounts.size());\n+        assertEquals(defaultTestBundleV2.mGeneratedAccount, accounts.get(0));\n+\n+        final List<Credential> credentials = accountCredentialCache.getCredentials();\n+        assertEquals(3, credentials.size());\n+\n+        final List<Credential> rts = new ArrayList<>();\n+        final List<Credential> ats = new ArrayList<>();\n+        final List<Credential> ids = new ArrayList<>();\n+\n+        for (final Credential credential : credentials) {\n+            if (credential.getCredentialType().equalsIgnoreCase(CredentialType.AccessToken.name())) {\n+                ats.add(credential);\n+            } else if (credential.getCredentialType().equalsIgnoreCase(CredentialType.RefreshToken.name())) {\n+                rts.add(credential);\n+            } else if (credential.getCredentialType().equalsIgnoreCase(CredentialType.IdToken.name())) {\n+                ids.add(credential);\n+            } else {\n+                fail();", "originalCommit": "9295da14e2430c8d5273a27c6597dd3ad7ef036f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA1MDMyMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/964#discussion_r456050321", "bodyText": "Applied changes in 8d37efe, c6044e9", "author": "iambmelt", "createdAt": "2020-07-16T20:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAyMTc0Ng=="}], "type": "inlineReview"}, {"oid": "895c3d2c36748b8a7c40d6664bd472f11d22bf52", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/895c3d2c36748b8a7c40d6664bd472f11d22bf52", "message": "Refining tests for exactness", "committedDate": "2020-07-16T19:58:28Z", "type": "commit"}, {"oid": "8d37efeb340eb3cfe438317e799fa5b3d4320cdb", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/8d37efeb340eb3cfe438317e799fa5b3d4320cdb", "message": "Convert test case to use a switch", "committedDate": "2020-07-16T20:06:26Z", "type": "commit"}, {"oid": "c6044e92dab13397356bce8bdd4a64ccd673704a", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c6044e92dab13397356bce8bdd4a64ccd673704a", "message": "Applying changes to other tests", "committedDate": "2020-07-16T20:12:19Z", "type": "commit"}, {"oid": "ee39d4c1419cae8ad70142799bc215e4aeec91b7", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/ee39d4c1419cae8ad70142799bc215e4aeec91b7", "message": "Slight refactor", "committedDate": "2020-07-16T20:28:26Z", "type": "commit"}]}