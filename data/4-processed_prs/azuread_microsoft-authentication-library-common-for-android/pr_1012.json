{"pr_number": 1012, "pr_title": "An approach to triggering fewer duplicate command errors", "pr_createdAt": "2020-08-25T02:08:22Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012", "timeline": [{"oid": "f2fcb843e26e7cf8fdf3c310446256cdad685fb2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f2fcb843e26e7cf8fdf3c310446256cdad685fb2", "message": "Adds license to file", "committedDate": "2020-08-24T22:07:12Z", "type": "commit"}, {"oid": "d59840edf769ab247252fdfc592dcb2f66581eb6", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d59840edf769ab247252fdfc592dcb2f66581eb6", "message": "Add final + nullability annots to existing impl", "committedDate": "2020-08-24T22:09:38Z", "type": "commit"}, {"oid": "1c3c46739202a019d89a9e66ef0941709a1fbcf0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1c3c46739202a019d89a9e66ef0941709a1fbcf0", "message": "Adds a BiConsumer interface with license infor + javadoc", "committedDate": "2020-08-24T22:14:13Z", "type": "commit"}, {"oid": "20a0728b634cc605781de9516ec2fb6a9e547c24", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/20a0728b634cc605781de9516ec2fb6a9e547c24", "message": "ResultFuture impl", "committedDate": "2020-08-25T01:25:56Z", "type": "commit"}, {"oid": "683b65a8f2922b69fcaa471a98eb42235aa3ca96", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/683b65a8f2922b69fcaa471a98eb42235aa3ca96", "message": "Rename method", "committedDate": "2020-08-25T01:34:56Z", "type": "commit"}, {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b814f9995c4edd5edf8b66ab101f49837f11374f", "message": "Integrates into CommandDispatcher", "committedDate": "2020-08-25T02:06:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDUyOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476564528", "bodyText": "nah.  You can return.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T16:05:49Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {\n+        mException = exception;\n+        mCountDownLatch.countDown();\n \n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(mResult, exception);\n+        }\n     }\n \n-    public void setResult(T result) {\n+    public synchronized void setResult(@Nullable final T result) {\n         mResult = result;\n         mCountDownLatch.countDown();\n+\n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(result, mException);\n+        }\n+    }\n+\n+    public synchronized void whenComplete(@NonNull final BiConsumer<T, Throwable> consumerToAdd) {\n+        if (isDone()) {\n+            consumerToAdd.accept(mResult, mException);\n+        }\n+\n+        // TODO Should we still add the consumer even if the ResultFuture isDone() == true?", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NzA2NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476567064", "bodyText": "Great --  I'll yank that out", "author": "iambmelt", "createdAt": "2020-08-25T16:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2OTk5Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476569992", "bodyText": "40c7fbc", "author": "iambmelt", "createdAt": "2020-08-25T16:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDUyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2Njc0MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476566740", "bodyText": "Remove commented out code", "author": "iambmelt", "createdAt": "2020-08-25T16:08:56Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -73,7 +77,8 @@\n     private static final Object sLock = new Object();\n     private static InteractiveTokenCommand sCommand = null;\n     private static final CommandResultCache sCommandResultCache = new CommandResultCache();\n-    private static final Set<BaseCommand> sExecutingCommands = Collections.synchronizedSet(new HashSet<BaseCommand>());\n+    //private static final Set<BaseCommand> sExecutingCommands = Collections.synchronizedSet(new HashSet<BaseCommand>());", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MTI5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476571290", "bodyText": "6fdb152", "author": "iambmelt", "createdAt": "2020-08-25T16:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2Njc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NzI1MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476567250", "bodyText": "Add javadoc", "author": "iambmelt", "createdAt": "2020-08-25T16:09:43Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {\n+        mException = exception;\n+        mCountDownLatch.countDown();\n \n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(mResult, exception);\n+        }\n     }\n \n-    public void setResult(T result) {\n+    public synchronized void setResult(@Nullable final T result) {\n         mResult = result;\n         mCountDownLatch.countDown();\n+\n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(result, mException);\n+        }\n+    }\n+\n+    public synchronized void whenComplete(@NonNull final BiConsumer<T, Throwable> consumerToAdd) {", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTYwNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476575604", "bodyText": "1d0cfe6", "author": "iambmelt", "createdAt": "2020-08-25T16:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NzI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NzMxMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476567313", "bodyText": "Add javadoc", "author": "iambmelt", "createdAt": "2020-08-25T16:09:48Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTY3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476575674", "bodyText": "1d0cfe6", "author": "iambmelt", "createdAt": "2020-08-25T16:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NzMxMw=="}], "type": "inlineReview"}, {"oid": "40c7fbca336602ea74b7fa06af766c94fb39fc4b", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/40c7fbca336602ea74b7fa06af766c94fb39fc4b", "message": "Resolving TODO", "committedDate": "2020-08-25T16:13:26Z", "type": "commit"}, {"oid": "6fdb1526d5b9562fe6e332faf13e7d41a1813ace", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6fdb1526d5b9562fe6e332faf13e7d41a1813ace", "message": "Removing commented out code", "committedDate": "2020-08-25T16:15:05Z", "type": "commit"}, {"oid": "1d0cfe608fbadb0ae79bde44e49e467f0dc2c371", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1d0cfe608fbadb0ae79bde44e49e467f0dc2c371", "message": "Adds javadoc to ResultFuture", "committedDate": "2020-08-25T16:19:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDgxNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476564816", "bodyText": "At this point, you could drop all references in this list.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T16:06:15Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {\n+        mException = exception;\n+        mCountDownLatch.countDown();\n \n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(mResult, exception);\n+        }\n     }\n \n-    public void setResult(T result) {\n+    public synchronized void setResult(@Nullable final T result) {\n         mResult = result;\n         mCountDownLatch.countDown();\n+\n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(result, mException);\n+        }\n+    }", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4OTY0Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476589646", "bodyText": "47d8fa9", "author": "iambmelt", "createdAt": "2020-08-25T16:44:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2OTEzMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476569132", "bodyText": "I was looking at this, I thought Future threw ExecutionExcepttion as well.  If it does, that's a better throw than runtime below.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T16:12:41Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwOTM3Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476609372", "bodyText": "fae0847\nAdding this checked Exception will require another PR to add try/catch blocks to MSAL so keep an eye out for that once this merges", "author": "iambmelt", "createdAt": "2020-08-25T17:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2OTEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476573270", "bodyText": "OK, this is your tricky synchronization part using concurrentMap.  You don't want to risk overwriting a concurrent writer without synchronizing this entire method.  So you make the result future and it's empty.  You then putIfAbsent into the sExecutingCommandMap.  If it returns null, then it did not populate the map and you add your listener to the future that you created since it was added to the map.  If it returns non-null, then you lost the race and you need add a listener to that future and return, since the command is already running.\nYou mainly run the get first because a get in the map is far cheaper than a putIfAbsent.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T16:19:01Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -87,15 +92,16 @@ public static void submitSilent(@NonNull final BaseCommand command) {\n                 \"Beginning execution of silent command.\"\n         );\n \n-        if (sExecutingCommands.contains(command)) {\n-            new Handler(Looper.getMainLooper()).post(new Runnable() {\n-                @Override\n-                public void run() {\n-                    command.getCallback().onError(new ClientException(ClientException.DUPLICATE_COMMAND, \"The same command was already received and is being processed.\"));\n-                }\n-            });\n-        } else if (command.isEligibleForCaching()) {\n-            sExecutingCommands.add(command);\n+        final Handler handler = new Handler(Looper.getMainLooper());\n+        ResultFuture<CommandResult> future = sExecutingCommandMap.get(command);\n+\n+        if (null != future) {\n+            future.whenComplete(getCommandResultConsumer(command, handler));\n+            return;\n+        } else {\n+            final ResultFuture<CommandResult> resultFuture = new ResultFuture<>();\n+            resultFuture.whenComplete(getCommandResultConsumer(command, handler));\n+            sExecutingCommandMap.put(command, resultFuture);", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyMzE0NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476623145", "bodyText": "If it returns null, then it did not populate the map and you add your listener to the future that you created since it was added to the map. If it returns non-null, then you lost the race and you need add a listener to that future and return, since the command is already running.\n\nThis seems backwards -- wouldn't returning null indicate that I did win? Looking at:\nhttps://developer.android.com/reference/java/util/concurrent/ConcurrentHashMap?hl=en#putIfAbsent(K,%20V)", "author": "iambmelt", "createdAt": "2020-08-25T17:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNDc5Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476624792", "bodyText": "You're right.  And my statement was internally inconsistent, even.  If it returns null, it did populate the map and you add the callback to the future that you created and start execution.  If it returns non-null, add and return.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T17:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNDgyNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476624827", "bodyText": "Think we're saying the same thing?", "author": "iambmelt", "createdAt": "2020-08-25T17:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNjA3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476626074", "bodyText": "Ah gotcha", "author": "iambmelt", "createdAt": "2020-08-25T17:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNjM0OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476626348", "bodyText": "Think we're saying the same thing?\n\nYes.  I'm trying to agree. ;-)", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T17:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzMDU5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476630596", "bodyText": "@AdamBJohnsonx Pushed changes in 98528c6 -- can you spot check me on this commit?", "author": "iambmelt", "createdAt": "2020-08-25T17:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTgyMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476575823", "bodyText": "Well, do we?  Long term, it's a better way of communicating error states.  The contract here is that either you have a result or you have a throwable.  Mostly, the code for these looks like if (t == null) { error handling; return; } result handling;", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T16:22:45Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -139,14 +144,24 @@ public void run() {\n                 Telemetry.getInstance().flush(correlationId);\n                 EstsTelemetry.getInstance().flush(command, commandResult);\n \n-                sExecutingCommands.remove(command);\n-\n                 //Return the result via the callback\n-                returnCommandResult(command, commandResult, handler);\n+                sExecutingCommandMap.remove(command).setResult(commandResult);\n             }\n         });\n     }\n \n+    private static BiConsumer<CommandResult, Throwable> getCommandResultConsumer(\n+            @NonNull final BaseCommand command,\n+            @NonNull final Handler handler) {\n+        return new BiConsumer<CommandResult, Throwable>() {\n+            @Override\n+            public void accept(CommandResult result, Throwable throwable) {\n+                // We can ignore the second (exception) param, not used.", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1MzMwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476653303", "bodyText": "Applied in 91ed0a7", "author": "iambmelt", "createdAt": "2020-08-25T18:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzI4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476583284", "bodyText": "Hm.  OK, so we might want to pass in this executor to whenComplete.  As you may notice, in the event of a complete request, we're going to run the call back on whatever the current thread is running on.  If that's OK, it's more straightforward.  But if we want our callback to run on the silentExecutor thread in the event that the result is already completed by the time we attempt to run it, we probably want to pass this executor into whenComplete to use in the event we hit that case.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T16:34:04Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -87,15 +92,16 @@ public static void submitSilent(@NonNull final BaseCommand command) {\n                 \"Beginning execution of silent command.\"\n         );\n \n-        if (sExecutingCommands.contains(command)) {\n-            new Handler(Looper.getMainLooper()).post(new Runnable() {\n-                @Override\n-                public void run() {\n-                    command.getCallback().onError(new ClientException(ClientException.DUPLICATE_COMMAND, \"The same command was already received and is being processed.\"));\n-                }\n-            });\n-        } else if (command.isEligibleForCaching()) {\n-            sExecutingCommands.add(command);\n+        final Handler handler = new Handler(Looper.getMainLooper());\n+        ResultFuture<CommandResult> future = sExecutingCommandMap.get(command);\n+\n+        if (null != future) {\n+            future.whenComplete(getCommandResultConsumer(command, handler));\n+            return;\n+        } else {\n+            final ResultFuture<CommandResult> resultFuture = new ResultFuture<>();\n+            resultFuture.whenComplete(getCommandResultConsumer(command, handler));\n+            sExecutingCommandMap.put(command, resultFuture);\n         }\n \n         sSilentExecutor.execute(new Runnable() {", "originalCommit": "b814f9995c4edd5edf8b66ab101f49837f11374f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzOTUwMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476639502", "bodyText": "Correct me if I'm wrong here.... I think we want to leave as-is, as calling back on the silentExecutor would be a threading behavioral change", "author": "iambmelt", "createdAt": "2020-08-25T18:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0ODcxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476648714", "bodyText": "returnCommandResult is called by the runnable that was submitted previously, I thought.  Unless it has a way to transfer back to the calling thread, which I don't see, we currently call back from that executor.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T18:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1MDI5Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476650293", "bodyText": "It posts back on the Handler created at ~L94 see:\nhttps://github.com/AzureAD/microsoft-authentication-library-common-for-android/blob/iambmelt/command-sub-fix-905-redux/common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java#L230", "author": "iambmelt", "createdAt": "2020-08-25T18:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1MjAwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476652003", "bodyText": "Wild.  OK, then it doesn't matter. Good - it's simpler like this.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T18:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1Mjc3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476652774", "bodyText": "gg", "author": "iambmelt", "createdAt": "2020-08-25T18:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzI4NA=="}], "type": "inlineReview"}, {"oid": "47d8fa9856e1f784755abe10c2a61311ed78712d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/47d8fa9856e1f784755abe10c2a61311ed78712d", "message": "Clear consumers list after setting result", "committedDate": "2020-08-25T16:43:45Z", "type": "commit"}, {"oid": "fae08476ddf46ae797c5adfd62f1632a4190014a", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/fae08476ddf46ae797c5adfd62f1632a4190014a", "message": "Convert RuntimeException to ExecutionException (Requires MSAL changes)", "committedDate": "2020-08-25T17:14:17Z", "type": "commit"}, {"oid": "98528c6c95c4eefe9d806b5f465bc8965b7f4fcb", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/98528c6c95c4eefe9d806b5f465bc8965b7f4fcb", "message": "Fix for potential threading issue", "committedDate": "2020-08-25T17:46:41Z", "type": "commit"}, {"oid": "906d601b4ea55041efd1f6eae8799f0790ed537d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/906d601b4ea55041efd1f6eae8799f0790ed537d", "message": "Fix spelling in comment", "committedDate": "2020-08-25T17:48:38Z", "type": "commit"}, {"oid": "b908342ba087ef5bccca5e7eb486ea49093da911", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b908342ba087ef5bccca5e7eb486ea49093da911", "message": "Remove duplicative put call", "committedDate": "2020-08-25T18:12:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0ODIwNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476648206", "bodyText": "Don't think you need this.", "author": "AdamBJohnsonx", "createdAt": "2020-08-25T18:19:25Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -87,15 +91,26 @@ public static void submitSilent(@NonNull final BaseCommand command) {\n                 \"Beginning execution of silent command.\"\n         );\n \n-        if (sExecutingCommands.contains(command)) {\n-            new Handler(Looper.getMainLooper()).post(new Runnable() {\n-                @Override\n-                public void run() {\n-                    command.getCallback().onError(new ClientException(ClientException.DUPLICATE_COMMAND, \"The same command was already received and is being processed.\"));\n-                }\n-            });\n-        } else if (command.isEligibleForCaching()) {\n-            sExecutingCommands.add(command);\n+        final Handler handler = new Handler(Looper.getMainLooper());\n+        ResultFuture<CommandResult> future = sExecutingCommandMap.get(command);\n+\n+        if (null != future) {\n+            future.whenComplete(getCommandResultConsumer(command, handler));\n+            return;\n+        } else {\n+            final ResultFuture<CommandResult> resultFuture = new ResultFuture<>();\n+            final ResultFuture<CommandResult> putValue = sExecutingCommandMap.putIfAbsent(command, resultFuture);\n+\n+            if (null == putValue) {\n+                // our value was inserted.\n+                resultFuture.whenComplete(getCommandResultConsumer(command, handler));\n+            } else {\n+                // Our value was not inserted, grab the one that was and hang a new listener off it\n+                putValue.whenComplete(getCommandResultConsumer(command, handler));\n+                return;\n+            }\n+\n+            sExecutingCommandMap.put(command, resultFuture);", "originalCommit": "906d601b4ea55041efd1f6eae8799f0790ed537d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0ODk0Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476648946", "bodyText": "Already removed, just didn't push the change -- it's in b908342", "author": "iambmelt", "createdAt": "2020-08-25T18:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0ODIwNg=="}], "type": "inlineReview"}, {"oid": "7495fa9c7dd03ba71a2244340a7b3b9d82617a35", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7495fa9c7dd03ba71a2244340a7b3b9d82617a35", "message": "Inverting conditional (compacting)", "committedDate": "2020-08-25T18:19:27Z", "type": "commit"}, {"oid": "91ed0a71841cdf4095b7fac398dda2330df16da7", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/91ed0a71841cdf4095b7fac398dda2330df16da7", "message": "Return the throwable to the callback, if nonnull", "committedDate": "2020-08-25T18:26:42Z", "type": "commit"}]}