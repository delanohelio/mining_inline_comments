{"pr_number": 1003, "pr_title": "Android/token manipulation", "pr_createdAt": "2020-08-16T12:36:58Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003", "timeline": [{"oid": "4cb02e76f13a2fc0e6d89e4080330bf8b8b38ef9", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/4cb02e76f13a2fc0e6d89e4080330bf8b8b38ef9", "message": "added utility function for token manipulation", "committedDate": "2020-08-12T16:29:56Z", "type": "commit"}, {"oid": "c8a8de2b534cee95b91b926a4a8d4ec79bf5a931", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c8a8de2b534cee95b91b926a4a8d4ec79bf5a931", "message": "added comments and modify the editTokenSignature method.", "committedDate": "2020-08-12T20:21:33Z", "type": "commit"}, {"oid": "7db0944f08e79309de2d9675d7eaf2c2a23aec17", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7db0944f08e79309de2d9675d7eaf2c2a23aec17", "message": "Merge branch 'dev' into android/token_manipulation", "committedDate": "2020-08-16T12:38:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMwNjc0Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471306746", "bodyText": "nit: small case for 1st letter for SharedPrefName.", "author": "saugup-ms", "createdAt": "2020-08-17T07:59:06Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,159 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    private static boolean isAccessToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.AccessToken;\n+    }\n+\n+    private static boolean isRefreshToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.RefreshToken;\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param SharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String SharedPrefName, Predicate<String> predicate, Function<String, String> editor) {", "originalCommit": "7db0944f08e79309de2d9675d7eaf2c2a23aec17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5OTY0OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471599649", "bodyText": "I have changed the letter in next commit.", "author": "jaiswalh", "createdAt": "2020-08-17T16:34:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMwNjc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMjU1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471312557", "bodyText": "Do you want to add a check if '.' is not found and 3 segments are not there? Put Assert there", "author": "saugup-ms", "createdAt": "2020-08-17T08:10:44Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,159 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    private static boolean isAccessToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.AccessToken;\n+    }\n+\n+    private static boolean isRefreshToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.RefreshToken;\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param SharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String SharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = getSharedPreferences(SharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    private static SharedPreferences getSharedPreferences(final String sharedPrefName) {\n+        final Context context = ApplicationProvider.getApplicationContext();\n+        return context.getSharedPreferences(sharedPrefName, Context.MODE_PRIVATE);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        String signature = segments[segments.length - 1];", "originalCommit": "7db0944f08e79309de2d9675d7eaf2c2a23aec17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMTA1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471601057", "bodyText": "added AssertionError exception whenever string is not segmented into 3 parts by period. \".\".", "author": "jaiswalh", "createdAt": "2020-08-17T16:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMjU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzNDE5OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471334199", "bodyText": "Is there any reason of randomization to 26? It can be any character other than 'a' to 'z'", "author": "saugup-ms", "createdAt": "2020-08-17T08:49:59Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,159 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    private static boolean isAccessToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.AccessToken;\n+    }\n+\n+    private static boolean isRefreshToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.RefreshToken;\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param SharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String SharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = getSharedPreferences(SharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    private static SharedPreferences getSharedPreferences(final String sharedPrefName) {\n+        final Context context = ApplicationProvider.getApplicationContext();\n+        return context.getSharedPreferences(sharedPrefName, Context.MODE_PRIVATE);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        String signature = segments[segments.length - 1];\n+\n+        StringBuilder sb = new StringBuilder(signature);\n+        Random rnd = new Random();\n+        int rndIndex = rnd.nextInt(sb.length());\n+        char charAtRndPosition = sb.charAt(rndIndex);\n+        char rndChar = (char) ('a' + rnd.nextInt(26));", "originalCommit": "7db0944f08e79309de2d9675d7eaf2c2a23aec17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5MDQxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471590410", "bodyText": "anything in base64, right?", "author": "AdamBJohnsonx", "createdAt": "2020-08-17T16:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzNDE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5OTMzNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471599335", "bodyText": "yes, character could vary beyond the \"a to z\" range however our purpose here is to just invalidate the signature and that could be done by changing any one character.", "author": "jaiswalh", "createdAt": "2020-08-17T16:33:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzNDE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzNDkzNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471334935", "bodyText": "Can we avoid this loop? You can change the character at that index directly.", "author": "saugup-ms", "createdAt": "2020-08-17T08:51:20Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,159 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    private static boolean isAccessToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.AccessToken;\n+    }\n+\n+    private static boolean isRefreshToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.RefreshToken;\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param SharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String SharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = getSharedPreferences(SharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    private static SharedPreferences getSharedPreferences(final String sharedPrefName) {\n+        final Context context = ApplicationProvider.getApplicationContext();\n+        return context.getSharedPreferences(sharedPrefName, Context.MODE_PRIVATE);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        String signature = segments[segments.length - 1];\n+\n+        StringBuilder sb = new StringBuilder(signature);\n+        Random rnd = new Random();\n+        int rndIndex = rnd.nextInt(sb.length());\n+        char charAtRndPosition = sb.charAt(rndIndex);\n+        char rndChar = (char) ('a' + rnd.nextInt(26));\n+\n+        while (charAtRndPosition == rndChar) {\n+            rndIndex = rnd.nextInt(sb.length());", "originalCommit": "7db0944f08e79309de2d9675d7eaf2c2a23aec17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMjE4Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471602183", "bodyText": "It has been resolved in next commit. loop has been avoided by adding the next random position in the exiting character.", "author": "jaiswalh", "createdAt": "2020-08-17T16:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMzNDkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzIxNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471603215", "bodyText": "Looks to be the same as this: https://github.com/AzureAD/microsoft-authentication-library-common-for-android/blob/dev/testutils/src/main/java/com/microsoft/identity/internal/testutils/TestUtils.java#L56\nIs there a need to duplicate it?", "author": "shahzaibj", "createdAt": "2020-08-17T16:40:31Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,159 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    private static boolean isAccessToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.AccessToken;\n+    }\n+\n+    private static boolean isRefreshToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.RefreshToken;\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param SharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String SharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = getSharedPreferences(SharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param SharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String SharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(SharedPrefName, predicate, editor);\n+    }\n+\n+    private static SharedPreferences getSharedPreferences(final String sharedPrefName) {\n+        final Context context = ApplicationProvider.getApplicationContext();\n+        return context.getSharedPreferences(sharedPrefName, Context.MODE_PRIVATE);\n+    }", "originalCommit": "7db0944f08e79309de2d9675d7eaf2c2a23aec17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMjcxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471612714", "bodyText": "Methods are private in TestUtils.java file and this file never used therefore I do not understand the purpose this file.", "author": "jaiswalh", "createdAt": "2020-08-17T16:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxNTQ4MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471615480", "bodyText": "It is indeed used. It is currently being used in tests in MSAL and Broker. See this MSAL Test for instance: https://github.com/AzureAD/microsoft-authentication-library-for-android/blob/dev/msal/src/test/java/com/microsoft/identity/client/e2e/tests/network/AcquireTokenNetworkTest.java#L167\nAlso you can make them public if you want.", "author": "shahzaibj", "createdAt": "2020-08-17T17:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY4MDY0OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471680649", "bodyText": "Changes has been made accordingly.", "author": "jaiswalh", "createdAt": "2020-08-17T18:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzY2MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471603660", "bodyText": "Looks to be the same as this: https://github.com/AzureAD/microsoft-authentication-library-common-for-android/blob/dev/testutils/src/main/java/com/microsoft/identity/internal/testutils/TestUtils.java#L52\nIs there a need to duplicate it?", "author": "shahzaibj", "createdAt": "2020-08-17T16:41:18Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,159 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    private static boolean isAccessToken(@NonNull final String cacheKey) {\n+        return SharedPreferencesAccountCredentialCache.getCredentialTypeForCredentialCacheKey(cacheKey) == CredentialType.AccessToken;\n+    }", "originalCommit": "7db0944f08e79309de2d9675d7eaf2c2a23aec17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY4MjE4OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471682188", "bodyText": "Removed duplicate method.", "author": "jaiswalh", "createdAt": "2020-08-17T18:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwMzY2MA=="}], "type": "inlineReview"}, {"oid": "9b89f4c7a8807eb7981b8ae0378501d20effec2d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9b89f4c7a8807eb7981b8ae0378501d20effec2d", "message": "using existing methods in TestUtils to avoid duplication of method.", "committedDate": "2020-08-17T18:22:47Z", "type": "commit"}, {"oid": "980922f81e0922bbc82b8252e614215451f96d2c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/980922f81e0922bbc82b8252e614215451f96d2c", "message": "Merge remote-tracking branch 'origin/android/token_manipulation' into android/token_manipulation", "committedDate": "2020-08-17T18:24:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODE5OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471798199", "bodyText": "A head-of-class javadoc section would be nice-to-have here.", "author": "AdamBJohnsonx", "createdAt": "2020-08-17T21:59:22Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0ODM4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472248384", "bodyText": "Added javadoc section in the next commit.", "author": "jaiswalh", "createdAt": "2020-08-18T14:39:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODM3Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471798372", "bodyText": "public members should have documentation.", "author": "AdamBJohnsonx", "createdAt": "2020-08-17T21:59:52Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0ODcxNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472248717", "bodyText": "Added documentation for the method in the next commit.", "author": "jaiswalh", "createdAt": "2020-08-18T14:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODY4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471798684", "bodyText": "this should probably be public, with appropriate documentation, so that people can implement it.", "author": "AdamBJohnsonx", "createdAt": "2020-08-17T22:00:31Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0OTc4OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472249788", "bodyText": "changed the access type to public so it can be implemented and added documentation for the method in the next commit.", "author": "jaiswalh", "createdAt": "2020-08-18T14:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5OTM0MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471799340", "bodyText": "nit: maybe randomizeCharacterInTokenSignature", "author": "AdamBJohnsonx", "createdAt": "2020-08-17T22:02:12Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1MjM3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472252374", "bodyText": "change the method name.", "author": "jaiswalh", "createdAt": "2020-08-18T14:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5OTM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyODkyNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471928926", "bodyText": "for public method use PascalCasing", "author": "dabbcomputers", "createdAt": "2020-08-18T05:48:18Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1NDk4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472254984", "bodyText": "In java, methods should be verbs, in mixed case with the first letter lowercase, with the first letter of each internal word capitalized.\nis there any reason for using PascalCasing ?", "author": "jaiswalh", "createdAt": "2020-08-18T14:47:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyODkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxMjUwMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472312502", "bodyText": "Please use android java style for java, and C# style for C#.", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyODkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTQwNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471929407", "bodyText": "is it sure that cacheValue will be instance of string? what if it is not? Should we log or fail?", "author": "dabbcomputers", "createdAt": "2020-08-18T05:49:40Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1NTgxNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472255817", "bodyText": "cache value is string when stored in the shared preference therefore we would get string whenever we fetch cache value form the cache.", "author": "jaiswalh", "createdAt": "2020-08-18T14:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM0NzI4Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472347283", "bodyText": "why we are checking it then?", "author": "dabbcomputers", "createdAt": "2020-08-18T17:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MjE4Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472442183", "bodyText": "sharedPeference getall() method returns a Map<String, ?> containing list of key/value pairs representing the preference.\n\"?\" which represent any object therefore the Map maps string key to any possible object value. Here our object is of string because both key/value are string when stored in the shared preference. Moreover check has been added to ensure only tokens(value are of string object) should be fetched.", "author": "jaiswalh", "createdAt": "2020-08-18T19:52:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MzE1OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472443159", "bodyText": "We should probably just let it throw a ClassCastException rather than trying to be clever.  This is a test utility.", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T19:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2NDUyMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472464521", "bodyText": "Make sense. cast cacheValue to string.", "author": "jaiswalh", "createdAt": "2020-08-18T20:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTYzOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471929638", "bodyText": "same PascalCasing for public ones at all places.", "author": "dabbcomputers", "createdAt": "2020-08-18T05:50:16Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1ODAwOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472258009", "bodyText": "n java, methods should be verbs, in mixed case with the first letter lowercase, with the first letter of each internal word capitalized.\nis there any reason for using PascalCasing ?", "author": "jaiswalh", "createdAt": "2020-08-18T14:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxMzY2Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472313663", "bodyText": "Don't use pascal casing.  That's not the correct idiom for java.", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTg3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471929874", "bodyText": "avoid using short forms", "author": "dabbcomputers", "createdAt": "2020-08-18T05:51:02Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 2) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        String signature = segments[segments.length - 1];\n+        StringBuilder sb = new StringBuilder(signature);\n+        Random rnd = new Random();\n+        int rndIndex = rnd.nextInt(sb.length());\n+        char charAtRndPosition = sb.charAt(rndIndex);\n+        char rndChar = (char) ('a' + rnd.nextInt(26));\n+\n+        if (charAtRndPosition == rndChar) {", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1ODQ1MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472258451", "bodyText": "updated the variable name.", "author": "jaiswalh", "createdAt": "2020-08-18T14:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTkzNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471929935", "bodyText": "significant name here", "author": "dabbcomputers", "createdAt": "2020-08-18T05:51:13Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 2) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        String signature = segments[segments.length - 1];\n+        StringBuilder sb = new StringBuilder(signature);", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1OTQ1MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472259451", "bodyText": "updated the name.", "author": "jaiswalh", "createdAt": "2020-08-18T14:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyOTkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkzMDc4OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471930788", "bodyText": "this can go outside 'a' to 'z' range", "author": "dabbcomputers", "createdAt": "2020-08-18T05:54:02Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 2) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        String signature = segments[segments.length - 1];\n+        StringBuilder sb = new StringBuilder(signature);\n+        Random rnd = new Random();\n+        int rndIndex = rnd.nextInt(sb.length());\n+        char charAtRndPosition = sb.charAt(rndIndex);\n+        char rndChar = (char) ('a' + rnd.nextInt(26));\n+\n+        if (charAtRndPosition == rndChar) {\n+            rndChar = (char) (charAtRndPosition + rnd.nextInt(26));", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2MDMxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472260310", "bodyText": "the purpose is to introduce any junk character in place of existing character so to invalidate.\nI have updated the logic to get character from base64 characters only and do not go out of bound.", "author": "jaiswalh", "createdAt": "2020-08-18T14:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkzMDc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkzMTE4MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r471931181", "bodyText": "we know that there will be 2 segment then its better to use index to avoid confusion.", "author": "dabbcomputers", "createdAt": "2020-08-18T05:55:11Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,147 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.cache.SharedPreferencesAccountCredentialCache;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+import com.microsoft.identity.common.internal.dto.CredentialType;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return editTokenSignature(s);\n+        }\n+    };\n+\n+    private interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on taken type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String editTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 2) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        String signature = segments[segments.length - 1];\n+        StringBuilder sb = new StringBuilder(signature);\n+        Random rnd = new Random();\n+        int rndIndex = rnd.nextInt(sb.length());\n+        char charAtRndPosition = sb.charAt(rndIndex);\n+        char rndChar = (char) ('a' + rnd.nextInt(26));\n+\n+        if (charAtRndPosition == rndChar) {\n+            rndChar = (char) (charAtRndPosition + rnd.nextInt(26));\n+        }\n+\n+        sb.setCharAt(rndIndex, rndChar);\n+        segments[segments.length - 1] = sb.toString();", "originalCommit": "980922f81e0922bbc82b8252e614215451f96d2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2MTcxOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472261719", "bodyText": "I have made a mistake here, there would be 3 segments and index 0,1,2 were segments of header, payload and signature respectively. I have updated and used index to avoid confusion.", "author": "jaiswalh", "createdAt": "2020-08-18T14:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkzMTE4MQ=="}], "type": "inlineReview"}, {"oid": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "message": "Added java documentation for the public methods and updated logic of randomizeCharacterInTokenSignature method.", "committedDate": "2020-08-18T15:54:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNjI0Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472316242", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n          \n          \n            \n                public void editAllTokenInCache(@NonNull final String sharedPrefName, @NonNull final Predicate<String> predicate, @NonNull final Function<String, String> editor) {", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:14:23Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyODAzMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472428033", "bodyText": "Added final keyword and NonNull", "author": "jaiswalh", "createdAt": "2020-08-18T19:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNjI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNzI3Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472317277", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n          \n          \n            \n                    SharedPreferences.Editor prefEditor = sharedPref.edit();\n          \n          \n            \n                    Map<String, ?> cacheEntries = sharedPref.getAll();\n          \n          \n            \n                    final SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n          \n          \n            \n                    final SharedPreferences.Editor prefEditor = sharedPref.edit();\n          \n          \n            \n                    final Map<String, ?> cacheEntries = sharedPref.getAll();", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:15:59Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzc5OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427799", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNzI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNzU0Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472317542", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n          \n          \n            \n                    for (final Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:16:23Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzczNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427736", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNzU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNzgxMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472317813", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String keyToEdit = cacheEntry.getKey();\n          \n          \n            \n                        if (predicate.test(keyToEdit)) {\n          \n          \n            \n                            Object cacheValue = cacheEntries.get(keyToEdit);\n          \n          \n            \n                        final String keyToEdit = cacheEntry.getKey();\n          \n          \n            \n                        if (predicate.test(keyToEdit)) {\n          \n          \n            \n                            final Object cacheValue = cacheEntries.get(keyToEdit);", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:16:46Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzY2NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427665", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNzgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODAxMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472318013", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n          \n          \n            \n                                final Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:17:04Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzYxNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427616", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODMwOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472318308", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n          \n          \n            \n                public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, @NonNull final Function<String, String> editor) {", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:17:34Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzU1Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427556", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODUzMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472318532", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Predicate<String> predicate = new Predicate<String>() {\n          \n          \n            \n                    final Predicate<String> predicate = new Predicate<String>() {", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:17:54Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzUxNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427515", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODcxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472318714", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Predicate<String> predicate = new Predicate<String>() {\n          \n          \n            \n                    final Predicate<String> predicate = new Predicate<String>() {", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:18:12Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzQ2Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427466", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODk4Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472318987", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String[] segments = string.split(\".\");\n          \n          \n            \n                    final String[] segments = string.split(\".\");", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:18:37Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String randomizeCharacterInTokenSignature(String string) {\n+        String[] segments = string.split(\".\");", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzQ0Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427442", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxODk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxOTQ2Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472319462", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String signature = segments[2];\n          \n          \n            \n                    final String signature = segments[2];", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:19:23Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String randomizeCharacterInTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 3) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        // segment[2] = signature of token which is the 3rd part of the string.\n+        String signature = segments[2];", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzM1NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427355", "bodyText": "Added final keyword.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxOTQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxOTYxOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472319619", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    StringBuilder signatureBuilder = new StringBuilder(signature);\n          \n          \n            \n                    final StringBuilder signatureBuilder = new StringBuilder(signature);", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:19:36Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String randomizeCharacterInTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 3) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        // segment[2] = signature of token which is the 3rd part of the string.\n+        String signature = segments[2];\n+        StringBuilder signatureBuilder = new StringBuilder(signature);", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzE5Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427197", "bodyText": "updated the file.", "author": "jaiswalh", "createdAt": "2020-08-18T19:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxOTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxOTc5Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472319797", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Random random = new Random();\n          \n          \n            \n                    final Random random = new Random();", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:19:53Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String randomizeCharacterInTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 3) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        // segment[2] = signature of token which is the 3rd part of the string.\n+        String signature = segments[2];\n+        StringBuilder signatureBuilder = new StringBuilder(signature);\n+        Random random = new Random();", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzEzNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427136", "bodyText": "updated the file.", "author": "jaiswalh", "createdAt": "2020-08-18T19:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxOTc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMyMDExOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472320118", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    int index = random.nextInt(signatureBuilder.length());\n          \n          \n            \n                    final int index = random.nextInt(signatureBuilder.length());", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:20:18Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String randomizeCharacterInTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 3) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        // segment[2] = signature of token which is the 3rd part of the string.\n+        String signature = segments[2];\n+        StringBuilder signatureBuilder = new StringBuilder(signature);\n+        Random random = new Random();\n+        int index = random.nextInt(signatureBuilder.length());", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNzA3NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472427075", "bodyText": "updated the file.", "author": "jaiswalh", "createdAt": "2020-08-18T19:22:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMyMDExOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMyMDM3Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472320373", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String base64Chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n          \n          \n            \n                    final String base64Chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";", "author": "AdamBJohnsonx", "createdAt": "2020-08-18T16:20:41Z", "path": "testutils/src/main/java/com/microsoft/identity/internal/testutils/CacheUtils.java", "diffHunk": "@@ -0,0 +1,160 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.internal.testutils;\n+\n+import android.content.SharedPreferences;\n+import android.text.TextUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.arch.core.util.Function;\n+\n+import com.microsoft.identity.common.internal.cache.CacheKeyValueDelegate;\n+import com.microsoft.identity.common.internal.dto.Credential;\n+\n+import java.util.Map;\n+import java.util.Random;\n+\n+\n+/**\n+ * This class provide utility to modify the tokens stored in the cache by providing predicate and Function\n+ * generic interface. This provide caller flexibility to write its own editing functions to modify the tokens\n+ * stored in the cache.\n+ */\n+public class CacheUtils {\n+\n+    private static final CacheKeyValueDelegate CACHE_KEY_VALUE_DELEGATE = new CacheKeyValueDelegate();\n+\n+    /**\n+     * Functional interface for editing signature of the token.\n+     */\n+    public static final Function<String, String> TOKEN_SIGNATURE_EDITOR = new Function<String, String>() {\n+        @Override\n+        public String apply(String s) {\n+            return randomizeCharacterInTokenSignature(s);\n+        }\n+    };\n+\n+    /**\n+     * Generic functional interface to give caller flexibility of code to evaluate on the given\n+     * arguments.\n+     *\n+     * @param <T> input arguments to evaluate.\n+     */\n+    public interface Predicate<T> {\n+        boolean test(T t);\n+    }\n+\n+    /**\n+     * This method will edit all the token specified by the predicate using the  editor\n+     * in the shared preference.\n+     *\n+     * @param sharedPrefName Name of the shared preference where token has been stored.\n+     * @param predicate      Generic functional interface representing function that returns true\n+     *                       or false depending on token type.\n+     * @param editor         Functional interface to have any number of token editing method.\n+     */\n+    public void editAllTokenInCache(@NonNull final String sharedPrefName, Predicate<String> predicate, Function<String, String> editor) {\n+        SharedPreferences sharedPref = TestUtils.getSharedPreferences(sharedPrefName);\n+        SharedPreferences.Editor prefEditor = sharedPref.edit();\n+        Map<String, ?> cacheEntries = sharedPref.getAll();\n+\n+        //get all the key from the cache entry, verify and edit it.\n+        for (Map.Entry<String, ?> cacheEntry : cacheEntries.entrySet()) {\n+            String keyToEdit = cacheEntry.getKey();\n+            if (predicate.test(keyToEdit)) {\n+                Object cacheValue = cacheEntries.get(keyToEdit);\n+                if (cacheValue instanceof String) {\n+                    Credential credential = CACHE_KEY_VALUE_DELEGATE.fromCacheValue((String) cacheValue, Credential.class);\n+                    credential.setSecret(editor.apply(credential.getSecret()));\n+                    prefEditor.putString(keyToEdit, CACHE_KEY_VALUE_DELEGATE.generateCacheValue(credential));\n+                    prefEditor.apply();\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * utility function to edit Access Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllAccessTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isAccessToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * utility function to edit Refresh Token.\n+     *\n+     * @param sharedPrefName Name of the shared preference.\n+     * @param editor         Functional interface for token editing method.\n+     */\n+    public void editAllRefreshTokenInCache(@NonNull final String sharedPrefName, Function<String, String> editor) {\n+        Predicate<String> predicate = new Predicate<String>() {\n+            @Override\n+            public boolean test(String cacheKey) {\n+                return TestUtils.isRefreshToken(cacheKey);\n+            }\n+        };\n+\n+        editAllTokenInCache(sharedPrefName, predicate, editor);\n+    }\n+\n+    /**\n+     * Split the string into 3 segment separated by period \".\" and set the\n+     * random character at the random position in the 3rd segment.\n+     *\n+     * @param string string to be edited.\n+     * @return edited string.\n+     */\n+    private static String randomizeCharacterInTokenSignature(String string) {\n+        String[] segments = string.split(\".\");\n+        if (segments.length != 3) {\n+            throw new AssertionError(\"not JWT\");\n+        }\n+\n+        // segment[2] = signature of token which is the 3rd part of the string.\n+        String signature = segments[2];\n+        StringBuilder signatureBuilder = new StringBuilder(signature);\n+        Random random = new Random();\n+        int index = random.nextInt(signatureBuilder.length());\n+\n+        // get random character from the base64 string.\n+        String base64Chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";", "originalCommit": "c5ecce7cbe58f2b44f0311a6bbaa10d1380a2aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNjkzMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1003#discussion_r472426930", "bodyText": "updated the file.", "author": "jaiswalh", "createdAt": "2020-08-18T19:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMyMDM3Mw=="}], "type": "inlineReview"}, {"oid": "cc186282d1779a5cec52dc6142a69771c082df9c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/cc186282d1779a5cec52dc6142a69771c082df9c", "message": "Added final keyword for the variables used in the file.", "committedDate": "2020-08-18T20:15:40Z", "type": "commit"}, {"oid": "a9f6f2092e19a9fa1b2f6eb2df12c48f9183a8c2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a9f6f2092e19a9fa1b2f6eb2df12c48f9183a8c2", "message": "Merge branch 'dev' into android/token_manipulation", "committedDate": "2020-08-19T06:01:37Z", "type": "commit"}]}