{"pr_number": 1137, "pr_title": "Sends CP version to ESTS and handle WebCP uri.", "pr_createdAt": "2020-11-19T16:57:00Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5NzAyOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r527097028", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public static final String WEBCP_LAUNCH_COMPANY_PORTAL_URL = \"companyportal://enrollment\";\n          \n          \n            \n                    public static final String WEBCP_LAUNCH_COMPANY_PORTAL_URL = BROWSER_EXT_WEB_CP + \"enrollment\";", "author": "AdamBJohnsonx", "createdAt": "2020-11-19T18:12:32Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationConstants.java", "diffHunk": "@@ -1055,6 +1055,16 @@\n          */\n         public static final String BROWSER_EXT_INSTALL_PREFIX = \"msauth://\";\n \n+        /**\n+         * Prefix in the redirect from WebCP.\n+         */\n+        public static final String BROWSER_EXT_WEB_CP = \"companyportal://\";\n+\n+        /**\n+         * Redirect URL from WebCP that should launch the Intune Company Portal app.\n+         */\n+        public static final String WEBCP_LAUNCH_COMPANY_PORTAL_URL = \"companyportal://enrollment\";", "originalCommit": "fda3a321d82619116fe58ca999ee64f6ffa843f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5OTAxMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r527099012", "bodyText": "Update method docs with additional case.", "author": "AdamBJohnsonx", "createdAt": "2020-11-19T18:15:40Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -161,6 +161,9 @@ private boolean handleUrl(final WebView view, final String url) {\n         } else if (isInstallRequestUrl(formattedURL)) {\n             Logger.info(TAG, \"It is an install request\");\n             return processInstallRequest(view, url);\n+        } else if (isWebCpUrl(formattedURL)) {", "originalCommit": "fda3a321d82619116fe58ca999ee64f6ffa843f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5OTM3Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r527099377", "bodyText": "should we write this as a getUriHanlder method that returns a BiFunction that we call to handle the URI and view?\nSo the method then becomes return getUriHandler(formattedUrl).apply(view, url);\nIt's not long enough to really matter.  Nevermind.", "author": "AdamBJohnsonx", "createdAt": "2020-11-19T18:16:17Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -161,6 +161,9 @@ private boolean handleUrl(final WebView view, final String url) {\n         } else if (isInstallRequestUrl(formattedURL)) {\n             Logger.info(TAG, \"It is an install request\");\n             return processInstallRequest(view, url);\n+        } else if (isWebCpUrl(formattedURL)) {\n+            Logger.info(TAG, \"It is a request from WebCP\");\n+            return processWebCpRequest(view, url);", "originalCommit": "fda3a321d82619116fe58ca999ee64f6ffa843f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzExMzMyNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r527113326", "bodyText": "Should we take charge of logging this here, so we can put in the logs the package name we tried to launch?", "author": "AdamBJohnsonx", "createdAt": "2020-11-19T18:39:09Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/AuthorizationRequest.java", "diffHunk": "@@ -221,26 +235,39 @@ public B setClaims(String claims) {\n             return self();\n         }\n \n-        public B setRequestHeaders(HashMap<String, String> requestHeaders){\n+        public B setRequestHeaders(HashMap<String, String> requestHeaders) {\n             mRequestHeaders = requestHeaders;\n             return self();\n         }\n \n         public Builder<B> setWebViewZoomEnabled(boolean webViewZoomEnabled) {\n-            this.webViewZoomEnabled = webViewZoomEnabled;\n+            mWebViewZoomEnabled = webViewZoomEnabled;\n             return self();\n         }\n \n         public Builder<B> setWebViewZoomControlsEnabled(boolean webViewZoomControlsEnabled) {\n-            this.webViewZoomControlsEnabled = webViewZoomControlsEnabled;\n+            mWebViewZoomControlsEnabled = webViewZoomControlsEnabled;\n+            return self();\n+        }\n+\n+        public Builder<B> setCpInstallationDetail(final @NonNull Context context) {\n+            try {\n+                // Do not use COMPANY_PORTAL_APP_PACKAGE_NAME, since we actually want this to be\n+                // CP's package name - not brokerHost's - even in localDebug mode.\n+                final PackageInfo packageInfo =\n+                        context.getPackageManager().getPackageInfo(\"com.microsoft.windowsintune.companyportal\", 0);\n+                mCpVersion = packageInfo.versionName;\n+            } catch (final PackageManager.NameNotFoundException e) {\n+                // CP is not installed. No need to do anything.", "originalCommit": "fda3a321d82619116fe58ca999ee64f6ffa843f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ0NjAwNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r527446004", "bodyText": "I intentionally avoid logging here as this could spam the log file.", "author": "rpdome", "createdAt": "2020-11-20T06:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzExMzMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzExMzU5NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r527113595", "bodyText": "nitpick: make the string a constant.", "author": "AdamBJohnsonx", "createdAt": "2020-11-19T18:39:39Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/AuthorizationRequest.java", "diffHunk": "@@ -221,26 +235,39 @@ public B setClaims(String claims) {\n             return self();\n         }\n \n-        public B setRequestHeaders(HashMap<String, String> requestHeaders){\n+        public B setRequestHeaders(HashMap<String, String> requestHeaders) {\n             mRequestHeaders = requestHeaders;\n             return self();\n         }\n \n         public Builder<B> setWebViewZoomEnabled(boolean webViewZoomEnabled) {\n-            this.webViewZoomEnabled = webViewZoomEnabled;\n+            mWebViewZoomEnabled = webViewZoomEnabled;\n             return self();\n         }\n \n         public Builder<B> setWebViewZoomControlsEnabled(boolean webViewZoomControlsEnabled) {\n-            this.webViewZoomControlsEnabled = webViewZoomControlsEnabled;\n+            mWebViewZoomControlsEnabled = webViewZoomControlsEnabled;\n+            return self();\n+        }\n+\n+        public Builder<B> setCpInstallationDetail(final @NonNull Context context) {\n+            try {\n+                // Do not use COMPANY_PORTAL_APP_PACKAGE_NAME, since we actually want this to be\n+                // CP's package name - not brokerHost's - even in localDebug mode.\n+                final PackageInfo packageInfo =\n+                        context.getPackageManager().getPackageInfo(\"com.microsoft.windowsintune.companyportal\", 0);", "originalCommit": "fda3a321d82619116fe58ca999ee64f6ffa843f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "81b90a1013828450c5144f09f27c11691f035cc7", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/81b90a1013828450c5144f09f27c11691f035cc7", "message": "resolve comments", "committedDate": "2020-11-27T11:41:36Z", "type": "forcePushed"}, {"oid": "3fc4a9b8de82fe41c870a6d34ab4d8ac9870e402", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/3fc4a9b8de82fe41c870a6d34ab4d8ac9870e402", "message": "resolve comments", "committedDate": "2020-12-01T12:38:46Z", "type": "forcePushed"}, {"oid": "a06d8146d828a54ea0ec7e578b3fae7a79e1d674", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a06d8146d828a54ea0ec7e578b3fae7a79e1d674", "message": "resolve comments", "committedDate": "2021-01-08T14:01:15Z", "type": "forcePushed"}, {"oid": "6db3b3e015eaa857dea2c89621b25aa0342c1059", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6db3b3e015eaa857dea2c89621b25aa0342c1059", "message": "WIP", "committedDate": "2021-01-08T20:33:33Z", "type": "commit"}, {"oid": "4592af96f1b4a496f5429420ebd8e289b838840f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/4592af96f1b4a496f5429420ebd8e289b838840f", "message": "changelog", "committedDate": "2021-01-08T20:33:33Z", "type": "commit"}, {"oid": "a13a7d2acacbf208f833c42c99088ab77706e10c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a13a7d2acacbf208f833c42c99088ab77706e10c", "message": "Update common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationConstants.java\n\nCo-authored-by: AdamBJohnsonx <63813613+AdamBJohnsonx@users.noreply.github.com>", "committedDate": "2021-01-08T20:33:33Z", "type": "commit"}, {"oid": "89a8256a19d9b3d58cf5f3ab555431fd309ee565", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/89a8256a19d9b3d58cf5f3ab555431fd309ee565", "message": "resolve comments", "committedDate": "2021-01-08T20:33:33Z", "type": "commit"}, {"oid": "8c75e64af81fd59f0779c07273cfe8c1db2f4ea7", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/8c75e64af81fd59f0779c07273cfe8c1db2f4ea7", "message": "update link", "committedDate": "2021-01-08T20:33:33Z", "type": "commit"}, {"oid": "455a2e9b1e312472aae71863aeadf7030df19003", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/455a2e9b1e312472aae71863aeadf7030df19003", "message": "update link", "committedDate": "2021-01-08T20:33:33Z", "type": "commit"}, {"oid": "455a2e9b1e312472aae71863aeadf7030df19003", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/455a2e9b1e312472aae71863aeadf7030df19003", "message": "update link", "committedDate": "2021-01-08T20:33:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MTA5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r554181096", "bodyText": "This scheme we're using, does this provide a deep link into CompanyPortal?", "author": "AdamBJohnsonx", "createdAt": "2021-01-08T20:42:50Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationConstants.java", "diffHunk": "@@ -1073,6 +1073,16 @@\n          */\n         public static final String BROWSER_EXT_INSTALL_PREFIX = \"msauth://\";\n \n+        /**\n+         * Prefix in the redirect from WebCP.", "originalCommit": "455a2e9b1e312472aae71863aeadf7030df19003", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4NjEzNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r554186135", "bodyText": "In other words, can we say what it does in a comment or a link to a doc?", "author": "AdamBJohnsonx", "createdAt": "2021-01-08T20:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MTA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDc3MTE4NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r554771185", "bodyText": "We steered away from deep linking because any apps can 'declare' the ownership of the link (in such case, Android will let the user choose which app to redirect to - and we don't even want this to happen).\nTherefore, what we do here is to 'look for the pattern' here and launch an intent directly with the app package name. we won't be using the URI directly.", "author": "rpdome", "createdAt": "2021-01-11T06:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MTA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIwNzk5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r555207996", "bodyText": "Again, could we add a comment saying what we're doing and why?", "author": "AdamBJohnsonx", "createdAt": "2021-01-11T17:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MTA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MzczNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r554183735", "bodyText": "I'm assuming that this means that we don't want to link into BrokerHostApp.", "author": "AdamBJohnsonx", "createdAt": "2021-01-08T20:49:05Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -248,19 +256,9 @@ private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull fina\n             //       Until that comes, we'll only handle this in ipphone.\n             if (packageHelper.isPackageInstalledAndEnabled(applicationContext, IPPHONE_APP_PACKAGE_NAME) &&\n                     IPPHONE_APP_SIGNATURE.equals(packageHelper.getCurrentSignatureForPackage(IPPHONE_APP_PACKAGE_NAME)) &&\n-                    packageHelper.isPackageInstalledAndEnabled(applicationContext, COMPANY_PORTAL_APP_PACKAGE_NAME)) {\n+                    packageHelper.isPackageInstalledAndEnabled(applicationContext, COMPANY_PORTAL_PROD_APP_PACKAGE_NAME)) {", "originalCommit": "455a2e9b1e312472aae71863aeadf7030df19003", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDc2MjQ5Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r554762496", "bodyText": "That's correct.", "author": "rpdome", "createdAt": "2021-01-11T05:52:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MzczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIwNjc1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r555206752", "bodyText": "Can we say that here?", "author": "AdamBJohnsonx", "createdAt": "2021-01-11T17:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MzczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4NDU1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r554184552", "bodyText": "do we want to be case-insensitive here?", "author": "AdamBJohnsonx", "createdAt": "2021-01-08T20:51:07Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -296,6 +310,20 @@ private void openLinkInBrowser(final String url) {\n         }\n     }\n \n+    private boolean processWebCpRequest(@NonNull final WebView view, @NonNull final String url) {\n+\n+        view.stopLoading();\n+        \n+        if (url.equalsIgnoreCase(AuthenticationConstants.Broker.WEBCP_LAUNCH_COMPANY_PORTAL_URL)) {", "originalCommit": "455a2e9b1e312472aae71863aeadf7030df19003", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDc2OTU3OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1137#discussion_r554769579", "bodyText": "I'm inclined toward a 'no'.\nWhile we don't really have an agreement on case-sensitivity (it's more like \"I'll give you X and you do Y\"), I don't think client side should break if the server side accidentally ship an upper case bug (we've seen that before).", "author": "rpdome", "createdAt": "2021-01-11T06:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4NDU1Mg=="}], "type": "inlineReview"}]}