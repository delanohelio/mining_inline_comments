{"pr_number": 1092, "pr_title": "[IPC part 3] Refactor AccountManager Strategy.", "pr_createdAt": "2020-10-25T20:41:57Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3MzcxOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512173718", "bodyText": "Should we define ClientException.INVALID_BROKER_INTENT?", "author": "AdamBJohnsonx", "createdAt": "2020-10-26T18:18:48Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -495,13 +498,15 @@\n                 ErrorStrings.UNSUPPORTED_BROKER_VERSION_ERROR_MESSAGE);\n     }\n \n-    public @NonNull Intent getIntentForInteractiveRequestFromResultBundle(@NonNull final Bundle resultBundle) throws ClientException {\n-        final String packageName = resultBundle.getString(BROKER_PACKAGE_NAME);\n-        final String className = resultBundle.getString(BROKER_ACTIVITY_NAME);\n \n+    public @NonNull Intent getIntentForInteractiveRequestFromResultBundle( @NonNull final Bundle resultBundle) throws ClientException {\n+        final Bundle interactiveRequestBundle = extractInteractiveRequestBundleFromResultBundle(resultBundle);\n+\n+        final String packageName = interactiveRequestBundle.getString(BROKER_PACKAGE_NAME);\n+        final String className = interactiveRequestBundle.getString(BROKER_ACTIVITY_NAME);\n         if (StringUtil.isEmpty(packageName) ||\n                 StringUtil.isEmpty(className)) {\n-            throw new ClientException(\"Unexpected error. Content of Authorization Intent's package and class name should not be null.\");\n+            throw new ClientException(ClientException.UNKNOWN_ERROR, \"Content of Authorization Intent's package and class name should not be null.\");", "originalCommit": "fb3c0600fcd935deab9f175a11411d374e81158a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NDU1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512174552", "bodyText": "Under what circumstances will this return null?", "author": "AdamBJohnsonx", "createdAt": "2020-10-26T18:20:13Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/util/ProcessUtil.java", "diffHunk": "@@ -57,8 +60,7 @@ public static boolean isBrokerProcess(@NonNull final Context context) {\n     /**\n      * Returns the running process name.\n      */\n-    @Nullable\n-    private static String getProcessName(@NonNull final Context context) {\n+    private static @Nullable String getProcessName(@NonNull final Context context) {", "originalCommit": "fb3c0600fcd935deab9f175a11411d374e81158a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI0NDMzNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512244336", "bodyText": "when we can't find a matching process id, which should never happen.\nI'm hesitant to throw a RuntimeException here (IllegalStateException?). Maybe that's the right thing to do.", "author": "rpdome", "createdAt": "2020-10-26T20:22:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NDU1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0ODY1NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512348655", "bodyText": "Keeping it the same for now.", "author": "rpdome", "createdAt": "2020-10-27T00:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NDU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NTYzNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512175636", "bodyText": "I'm not sure what the difference would be if we just said if (null != Looper.myLooper()) ?", "author": "AdamBJohnsonx", "createdAt": "2020-10-26T18:21:59Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/util/ProcessUtil.java", "diffHunk": "@@ -72,4 +74,15 @@ private static String getProcessName(@NonNull final Context context) {\n \n         return null;\n     }\n+\n+    /**\n+     * Returns a handler based on the current looper.\n+     */\n+    public static @NonNull Handler getPreferredHandler() {\n+        if (null != Looper.myLooper() && Looper.getMainLooper() != Looper.myLooper()) {", "originalCommit": "fb3c0600fcd935deab9f175a11411d374e81158a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4NTcxNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512185717", "bodyText": "Should we put this into a method on BrokerOperationBundle instead of putting it here?  Maybe putRequestString(key, value) that could contain all of this logic (check if the request bundle is created, create if necessary, add appropriate string under the correct specified key)?", "author": "AdamBJohnsonx", "createdAt": "2020-10-26T18:38:17Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/AccountManagerAddAccountStrategy.java", "diffHunk": "@@ -0,0 +1,103 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.accounts.AccountManager;\n+import android.accounts.AccountManagerFuture;\n+import android.accounts.AuthenticatorException;\n+import android.accounts.OperationCanceledException;\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.adal.internal.AuthenticationConstants;\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.exception.ClientException;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.util.ProcessUtil;\n+\n+import java.io.IOException;\n+\n+/**\n+ * A strategy for communicating with the targeted broker via AccountManager's addAccount().\n+ *\n+ * NOTE: SuppressLint is added because this API requires MANAGE_ACCOUNTS for API<= 22.\n+ * AccountManagerUtil.canUseAccountManagerOperation() will validate that.\n+ * */\n+\n+@SuppressLint(\"MissingPermission\")\n+public class AccountManagerAddAccountStrategy implements IIpcStrategy {\n+    private static final String TAG = AccountManagerAddAccountStrategy.class.getSimpleName();\n+\n+    private final Context mContext;\n+\n+    public AccountManagerAddAccountStrategy(final Context context) {\n+        mContext = context;\n+    }\n+\n+    @Override\n+    @Nullable public Bundle communicateToBroker(@NonNull final BrokerOperationBundle brokerOperationBundle)\n+            throws BaseException {\n+        final String methodName = brokerOperationBundle.getOperation().name();\n+        try {\n+            final AccountManagerFuture<Bundle> resultBundle =\n+                    AccountManager.get(mContext)\n+                            .addAccount(\n+                                    AuthenticationConstants.Broker.BROKER_ACCOUNT_TYPE,\n+                                    AuthenticationConstants.Broker.AUTHTOKEN_TYPE,\n+                                    null,\n+                                    getAccountManagerBundle(brokerOperationBundle),\n+                                    null,\n+                                    null,\n+                                    ProcessUtil.getPreferredHandler());\n+\n+            Logger.verbose(TAG + methodName, \"Received result from broker\");\n+            return resultBundle.getResult();\n+        } catch (final AuthenticatorException | IOException | OperationCanceledException e) {\n+            Logger.error(TAG + methodName, e.getMessage(), e);\n+            throw new BrokerCommunicationException(\"Failed to connect to AccountManager\", e);\n+        }\n+    }\n+\n+    /**\n+     * Packs the response bundle with the account manager key.\n+     */\n+    public Bundle getAccountManagerBundle(@NonNull final BrokerOperationBundle brokerOperationBundle)\n+            throws BrokerCommunicationException {\n+        Bundle requestBundle = brokerOperationBundle.getBundle();\n+        if (requestBundle == null) {\n+            requestBundle = new Bundle();\n+        }\n+\n+        requestBundle.putString(\n+                AuthenticationConstants.Broker.BROKER_ACCOUNT_MANAGER_OPERATION_KEY,\n+                brokerOperationBundle.getAccountManagerAddAccountOperationKey());\n+\n+        return requestBundle;", "originalCommit": "fb3c0600fcd935deab9f175a11411d374e81158a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4NzUzNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512187535", "bodyText": "Is there a way to be explicit about when we want to have this behavior (ONLY when talking over accountManager) rather than implicit, so that it doesn't become an unintended feature?", "author": "AdamBJohnsonx", "createdAt": "2020-10-26T18:41:00Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -510,10 +515,22 @@\n                 packageName,\n                 className\n         );\n-        intent.putExtras(resultBundle);\n+        intent.putExtras(interactiveRequestBundle);\n         return intent;\n     }\n \n+    /**\n+     * AccountManager strategy is currently returning result in a different format compared with the other strategies.\n+     * We should make sure this does NOT happen going forward.\n+     */\n+    public Bundle extractInteractiveRequestBundleFromResultBundle(@NonNull final Bundle resultBundle) {\n+        final Intent interactiveRequestIntent = resultBundle.getParcelable(AccountManager.KEY_INTENT);\n+        if (interactiveRequestIntent != null) {", "originalCommit": "fb3c0600fcd935deab9f175a11411d374e81158a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI0NjY1Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1092#discussion_r512246656", "bodyText": "I actually moved this back from AccountManager Strategy, and the reason is that the ipc strategy itself should not have to care about the content of the payload. It's a bug on our side that sends a different payload for each communication channel.\nthis layer won't/shouldn't be aware of the ipc strategy either (unless we modify the BrokerOperation interface, which I'm not keen of) - so... the answer is no, I can't think of any clean way to handle this.", "author": "rpdome", "createdAt": "2020-10-26T20:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4NzUzNQ=="}], "type": "inlineReview"}, {"oid": "5f5838a67edc4d46584f8c5f528dd818ef50d7fd", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/5f5838a67edc4d46584f8c5f528dd818ef50d7fd", "message": "[Part 3] Refactor AccountManager Strategy", "committedDate": "2020-10-27T03:07:52Z", "type": "commit"}, {"oid": "5f5838a67edc4d46584f8c5f528dd818ef50d7fd", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/5f5838a67edc4d46584f8c5f528dd818ef50d7fd", "message": "[Part 3] Refactor AccountManager Strategy", "committedDate": "2020-10-27T03:07:52Z", "type": "forcePushed"}]}