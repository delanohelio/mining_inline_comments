{"pr_number": 920, "pr_title": "Changes to look for foci RT and use it for FOCI clients for local msal silent requests", "pr_createdAt": "2020-06-01T18:13:52Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920", "timeline": [{"oid": "7a1265962b5bfb6fe7dd7dd27dbfdefff7fd249f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7a1265962b5bfb6fe7dd7dd27dbfdefff7fd249f", "message": "Changes to look for foci RT's for local msal silent authentication", "committedDate": "2020-05-28T21:11:43Z", "type": "commit"}, {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/38521d4fa15e7f1dd3d04cb97c8388903184384d", "message": "Fix pmd", "committedDate": "2020-05-29T01:35:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNjc4Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433416787", "bodyText": "Can I get you to add two tests to the MsalOAuth2TokenCacheTest for this? 1 to test successful retrieval and another to test null when no matches", "author": "iambmelt", "createdAt": "2020-06-01T18:38:26Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,27 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load  FRTs from the cache for an account matching the homeAccountId\n+     * @param homeAccountId : homeAccountId for which FRT is sought\n+     * @return an FRT if available else null.\n+     */\n+    @Nullable\n+    public RefreshTokenRecord getFamilyRefreshTokenForHomeAccountId(@NonNull final String homeAccountId) {", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyOTc3NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434129775", "bodyText": "added tests as suggested", "author": "kreedula", "createdAt": "2020-06-02T19:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNjc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzA3Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433423077", "bodyText": "API breaking change FYI\nWould it be better to make an additive change here?", "author": "iambmelt", "createdAt": "2020-06-01T18:50:06Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -127,25 +128,26 @@\n      *\n      * @param clientId    String of the given client id.\n      * @param redirectUri redirect url string of the given client id.\n-     * @param cacheRecord Foci cache record.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord : refresh token record of FOCI account\n      * @return true if the given client id can use the cached foci token. False, otherwise.\n      * @throws ClientException\n      * @throws IOException\n      */\n-    public static boolean tryFociTokenWithGivenClientId(@NonNull final BrokerOAuth2TokenCache brokerOAuth2TokenCache,\n+    public static boolean tryFociTokenWithGivenClientId(@NonNull final OAuth2TokenCache brokerOAuth2TokenCache,\n                                                         @NonNull final String clientId,\n                                                         @NonNull final String redirectUri,\n-                                                        @NonNull final ICacheRecord cacheRecord)\n+                                                        @NonNull final RefreshTokenRecord refreshTokenRecord,", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ0ODQyNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433448425", "bodyText": "yup, broker uses it too. I made changes on broker , shouldn't have an impact,  but I think it is better to add as an additive to be safe , will make changes", "author": "kreedula", "createdAt": "2020-06-01T19:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyOTU3Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434129572", "bodyText": "added as an additive change", "author": "kreedula", "createdAt": "2020-06-02T19:35:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzUxNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433423514", "bodyText": "Same here it looks like.... another API breaking change I think?", "author": "iambmelt", "createdAt": "2020-06-01T18:50:57Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -617,14 +619,14 @@ public static MicrosoftStsTokenRequest createTokenRequest(@NonNull final String\n         return tokenRequest;\n     }\n \n-    public static MicrosoftStsAuthorizationRequest createAuthRequest(@NonNull final MicrosoftStsOAuth2Strategy strategy,\n-                                                                     @NonNull final ICacheRecord cacheRecord,\n+    private static MicrosoftStsAuthorizationRequest createAuthRequest(@NonNull final MicrosoftStsOAuth2Strategy strategy,", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyOTI5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434129290", "bodyText": "this is just used internally as a helper function, can be private changed the scope to be internal to this class", "author": "kreedula", "createdAt": "2020-06-02T19:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzUxNA=="}], "type": "inlineReview"}, {"oid": "bfab0f7f965c5a515532cca5c351991cff3ea392", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/bfab0f7f965c5a515532cca5c351991cff3ea392", "message": "Addressing comments", "committedDate": "2020-06-02T18:21:53Z", "type": "commit"}, {"oid": "f32ac487d6c5e7a404e749c0b565a49b4292bfb1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f32ac487d6c5e7a404e749c0b565a49b4292bfb1", "message": "Added tests", "committedDate": "2020-06-02T19:29:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNTAxNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433405015", "bodyText": "nano-nit: it's odd that these lines moved.", "author": "AdamBJohnsonx", "createdAt": "2020-06-01T18:15:56Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -60,6 +57,9 @@\n import java.util.List;\n import java.util.Set;\n \n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMTcwNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434821707", "bodyText": "Android studio's  Auto rearrange moved it, so i think was not formatted as AndroidStudio's import format", "author": "kreedula", "createdAt": "2020-06-03T20:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNTAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNzc1OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433407759", "bodyText": "nit: spacing after Load.", "author": "AdamBJohnsonx", "createdAt": "2020-06-01T18:21:13Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,27 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load  FRTs from the cache for an account matching the homeAccountId", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMTg3MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434821870", "bodyText": "Addressed via fff3f7e", "author": "kreedula", "createdAt": "2020-06-03T20:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNzc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwODEyMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433408122", "bodyText": "Why the ':' on refreshTokenRecord but nothing else?", "author": "AdamBJohnsonx", "createdAt": "2020-06-01T18:21:55Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -127,25 +128,26 @@\n      *\n      * @param clientId    String of the given client id.\n      * @param redirectUri redirect url string of the given client id.\n-     * @param cacheRecord Foci cache record.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord : refresh token record of FOCI account", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMjA5NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434822094", "bodyText": "typo, Addressed via fff3f7e", "author": "kreedula", "createdAt": "2020-06-03T20:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwODEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwOTY1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433409657", "bodyText": "Question: I've seen this pattern in the code, and I was wondering why we're not relying on the logger to yank the method out of the call stack from where the log line occurs.", "author": "AdamBJohnsonx", "createdAt": "2020-06-01T18:24:51Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -127,25 +128,26 @@\n      *\n      * @param clientId    String of the given client id.\n      * @param redirectUri redirect url string of the given client id.\n-     * @param cacheRecord Foci cache record.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord : refresh token record of FOCI account\n      * @return true if the given client id can use the cached foci token. False, otherwise.\n      * @throws ClientException\n      * @throws IOException\n      */\n-    public static boolean tryFociTokenWithGivenClientId(@NonNull final BrokerOAuth2TokenCache brokerOAuth2TokenCache,\n+    public static boolean tryFociTokenWithGivenClientId(@NonNull final OAuth2TokenCache brokerOAuth2TokenCache,\n                                                         @NonNull final String clientId,\n                                                         @NonNull final String redirectUri,\n-                                                        @NonNull final ICacheRecord cacheRecord)\n+                                                        @NonNull final RefreshTokenRecord refreshTokenRecord,\n+                                                        @NonNull final IAccountRecord accountRecord)\n             throws ClientException, IOException {\n         final String methodName = \":tryFociTokenWithGivenClientId\";", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMzg0OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434823848", "bodyText": "Currently I believe our logger doesn't have functionality to get method names atleast for logs without stack trace. If we get to that functionality it would be great. To answer your question , it's been a pattern we historically followed, I am not a big fan of it personally too, but we haven't invested any cycles to change this.", "author": "kreedula", "createdAt": "2020-06-03T20:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwOTY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzMDcyMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434830722", "bodyText": "Cool.  I actually tried writing a few things to change the logging stack, but it gets to be a really big change quickly.  I'm curious why we don't use one of the more standard logging frameworks like, say, slf4j, maybe it's binary size?\nAnyway, why I'm concerned a little, from https://developer.android.com/reference/android/util/Log.html :\nthat when you're building the string to pass into Log.d, the compiler uses a StringBuilder and at least three allocations occur: the StringBuilder itself, the buffer, and the String object. Realistically, there is also another buffer allocation and copy, and even more pressure on the gc. That means that if your log message is filtered out, you might be doing significant work and incurring significant overhead.", "author": "AdamBJohnsonx", "createdAt": "2020-06-03T20:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwOTY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzNDI3OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434834278", "bodyText": "IIRC, we looked at doing this awhile back and saw a lot of slowness around using Thread.getStackTrace to inspect the caller function. Now that threading has moved to a background thread this may be less of concern, depending on the internal mechanics of the getStackTrace implementation and runtime (ART vs Dalvik).", "author": "iambmelt", "createdAt": "2020-06-03T20:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwOTY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMzUzOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433413539", "bodyText": "The enclosing method is already Very Long(tm) - should this be a separate method?", "author": "AdamBJohnsonx", "createdAt": "2020-06-01T18:32:11Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +527,41 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            // check for FOCI tokens, if available make a request to service to see if the client id is FOCI and save the tokens\n+            final RefreshTokenRecord refreshTokenRecord = ((MsalOAuth2TokenCache) parameters\n+                    .getOAuth2TokenCache())\n+                    .getFamilyRefreshTokenForHomeAccountId(homeAccountId);\n+\n+            if (refreshTokenRecord != null) {\n+                try {\n+                    TokenCacheItemMigrationAdapter.tryFociTokenWithGivenClientId(\n+                            parameters.getOAuth2TokenCache(),\n+                            parameters.getClientId(),\n+                            parameters.getRedirectUri(),\n+                            refreshTokenRecord,\n+                            parameters.getAccount()\n+                    );\n+\n+                    // Try to look for account again in the cache\n+                    targetAccount = parameters\n+                            .getOAuth2TokenCache()\n+                            .getAccountByLocalAccountId(\n+                                    null,\n+                                    clientId,\n+                                    localAccountId\n+                            );\n+                } catch (IOException e) {\n+                    Logger.warn(TAG,\n+                            \"Error while attempting to validate client: \"\n+                                    + clientId + \" is part of family \" + e.getMessage()\n+                    );\n+                }\n+            } else {\n+                Logger.info(TAG, \"No Foci tokens found for homeAccountId \" + homeAccountId);\n+            }\n+        }\n+", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyNDI3Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434824273", "bodyText": "I'd buy that argument. Addressed via fff3f7e", "author": "kreedula", "createdAt": "2020-06-03T20:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMzUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNDk3Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433414972", "bodyText": "The indentation here is almost deceptive.  Maybe a local reference to the token cache would help.", "author": "AdamBJohnsonx", "createdAt": "2020-06-01T18:34:52Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +527,41 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            // check for FOCI tokens, if available make a request to service to see if the client id is FOCI and save the tokens\n+            final RefreshTokenRecord refreshTokenRecord = ((MsalOAuth2TokenCache) parameters\n+                    .getOAuth2TokenCache())", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyNDYyNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434824624", "bodyText": "fixed it , now taking it has an arg. See fff3f7e", "author": "kreedula", "createdAt": "2020-06-03T20:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNDk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNzM3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433417374", "bodyText": "we didn't rewrite the clientId reference.  Why get it again?", "author": "AdamBJohnsonx", "createdAt": "2020-06-01T18:39:37Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +527,41 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            // check for FOCI tokens, if available make a request to service to see if the client id is FOCI and save the tokens\n+            final RefreshTokenRecord refreshTokenRecord = ((MsalOAuth2TokenCache) parameters\n+                    .getOAuth2TokenCache())\n+                    .getFamilyRefreshTokenForHomeAccountId(homeAccountId);\n+\n+            if (refreshTokenRecord != null) {\n+                try {\n+                    TokenCacheItemMigrationAdapter.tryFociTokenWithGivenClientId(\n+                            parameters.getOAuth2TokenCache(),\n+                            parameters.getClientId(),", "originalCommit": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyNDgwOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434824808", "bodyText": "Good catch, fixed it here : fff3f7e", "author": "kreedula", "createdAt": "2020-06-03T20:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNzM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEzMTY3Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434131672", "bodyText": "When does this return something that's not a RefreshTokenRecord?  If I go look at the code, it only sets credential being returned if it is instanceof RefreshTokenRecord, I think.  It's a private method - should we change the signature?", "author": "AdamBJohnsonx", "createdAt": "2020-06-02T19:39:22Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,27 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load  FRTs from the cache for an account matching the homeAccountId\n+     * @param homeAccountId : homeAccountId for which FRT is sought\n+     * @return an FRT if available else null.\n+     */\n+    @Nullable\n+    public RefreshTokenRecord getFamilyRefreshTokenForHomeAccountId(@NonNull final String homeAccountId) {\n+        final List<AccountRecord> accountRecords = mAccountCredentialCache.getAccounts();\n+\n+        for (AccountRecord accountRecord : accountRecords) {\n+            if (accountRecord.getHomeAccountId().equals(homeAccountId)) {\n+                final Credential rt = getFamilyRefreshTokenForAccount(accountRecord);\n+\n+                if (rt instanceof RefreshTokenRecord) {\n+                    return (RefreshTokenRecord) rt;\n+                }", "originalCommit": "f32ac487d6c5e7a404e749c0b565a49b4292bfb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyNTI1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434825252", "bodyText": "Good point, agree. Addressed via fff3f7e", "author": "kreedula", "createdAt": "2020-06-03T20:10:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEzMTY3Mg=="}], "type": "inlineReview"}, {"oid": "fff3f7e02530a7052cbd302dc428616fff91c435", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/fff3f7e02530a7052cbd302dc428616fff91c435", "message": "Addressing comments", "committedDate": "2020-06-03T19:58:49Z", "type": "commit"}, {"oid": "2851b245067b3adaeed8dc0e99f8ce8ea158ea66", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2851b245067b3adaeed8dc0e99f8ce8ea158ea66", "message": "Merge branch 'dev' into kreedula/msal-foci", "committedDate": "2020-06-03T20:10:34Z", "type": "commit"}, {"oid": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/72f6a15d7557006bcbc3f72d8daf18e7d7b9c195", "message": "Minor typo", "committedDate": "2020-06-03T20:26:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyNjcxNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434826716", "bodyText": "nit: space after cast.", "author": "AdamBJohnsonx", "createdAt": "2020-06-03T20:13:35Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +528,13 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            targetAccount = getAccountWithFRTIfAvailable(\n+                    parameters,\n+                    (MsalOAuth2TokenCache)parameters.getOAuth2TokenCache()", "originalCommit": "2851b245067b3adaeed8dc0e99f8ce8ea158ea66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg2Mzg2Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434863866", "bodyText": "Addressed via : b8f4d0e", "author": "kreedula", "createdAt": "2020-06-03T21:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyNjcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzMzQwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434833403", "bodyText": "nit: inline?", "author": "AdamBJohnsonx", "createdAt": "2020-06-03T20:26:27Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,23 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load FRTs from the cache for an account matching the homeAccountId\n+     * @param homeAccountId : homeAccountId for which FRT is sought\n+     * @return an FRT if available else null.\n+     */\n+    @Nullable\n+    public RefreshTokenRecord getFamilyRefreshTokenForHomeAccountId(@NonNull final String homeAccountId) {\n+        final List<AccountRecord> accountRecords = mAccountCredentialCache.getAccounts();", "originalCommit": "2851b245067b3adaeed8dc0e99f8ce8ea158ea66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg2Mzc0NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434863744", "bodyText": "Addressed via : b8f4d0e", "author": "kreedula", "createdAt": "2020-06-03T21:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzMzQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzODc5OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434838798", "bodyText": "Random comment: I kinda want to write StringUtil.defaultIfEmpty(String a, String b) -> isEmpty(a) ? b : a;", "author": "AdamBJohnsonx", "createdAt": "2020-06-03T20:37:31Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -135,17 +139,40 @@\n     public static boolean tryFociTokenWithGivenClientId(@NonNull final BrokerOAuth2TokenCache brokerOAuth2TokenCache,\n                                                         @NonNull final String clientId,\n                                                         @NonNull final String redirectUri,\n-                                                        @NonNull final ICacheRecord cacheRecord)\n+                                                        @NonNull final ICacheRecord cacheRecord) throws IOException, ClientException {\n+        return tryFociTokenWithGivenClientId(\n+                brokerOAuth2TokenCache,\n+                clientId, redirectUri,\n+                cacheRecord.getRefreshToken(),\n+                cacheRecord.getAccount()\n+        );\n+    }\n+\n+    /**\n+     * Testing whether the given client ID can use the cached foci to refresh token.\n+     *\n+     * @param clientId    String of the given client id.\n+     * @param redirectUri redirect url string of the given client id.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord refresh token record of FOCI account\n+     * @return true if the given client id can use the cached foci token. False, otherwise.\n+     * @throws ClientException\n+     * @throws IOException\n+     */\n+    public static boolean tryFociTokenWithGivenClientId(@NonNull final OAuth2TokenCache brokerOAuth2TokenCache,\n+                                                        @NonNull final String clientId,\n+                                                        @NonNull final String redirectUri,\n+                                                        @NonNull final RefreshTokenRecord refreshTokenRecord,\n+                                                        @NonNull final IAccountRecord accountRecord)\n             throws ClientException, IOException {\n         final String methodName = \":tryFociTokenWithGivenClientId\";\n         final MicrosoftStsOAuth2Configuration config = new MicrosoftStsOAuth2Configuration();\n \n         //Get authority url\n         final Uri.Builder requestUrlBuilder = new Uri.Builder();\n-        final String tenantId = cacheRecord.getAccount().getRealm();\n         requestUrlBuilder.scheme(\"https\")\n-                .authority(cacheRecord.getRefreshToken().getEnvironment())\n-                .appendPath(StringUtil.isEmpty(tenantId) ? ALL_ACCOUNTS_TENANT_ID : tenantId);\n+                .authority(refreshTokenRecord.getEnvironment())\n+                .appendPath(StringUtil.isEmpty(accountRecord.getRealm()) ? ALL_ACCOUNTS_TENANT_ID : accountRecord.getRealm());", "originalCommit": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg0Njk0Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434846946", "bodyText": "OK, we have the token then we make this call.  We stuff it into the datastore as a side effect, then go back to the datastore to pull it out again.  There's probably a reason we don't just return it... but anyway, this method returns a boolean value that we're not checking.  Should we check it?  Should we return the token instead?", "author": "AdamBJohnsonx", "createdAt": "2020-06-03T20:53:15Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -552,6 +562,48 @@ protected AccountRecord getCachedAccountRecord(\n         return targetAccount;\n     }\n \n+    @Nullable\n+    private AccountRecord getAccountWithFRTIfAvailable(@NonNull final SilentTokenCommandParameters parameters,\n+                                                       @NonNull final MsalOAuth2TokenCache msalOAuth2TokenCache){\n+\n+        final String homeAccountId = parameters.getAccount().getHomeAccountId();\n+        final String clientId = parameters.getClientId();\n+\n+        // check for FOCI tokens for the homeAccountId\n+        final RefreshTokenRecord refreshTokenRecord = msalOAuth2TokenCache\n+                .getFamilyRefreshTokenForHomeAccountId(homeAccountId);\n+\n+        if (refreshTokenRecord != null) {\n+            try {\n+                // foci token is available, make a request to service to see if the client id is FOCI and save the tokens\n+                TokenCacheItemMigrationAdapter.tryFociTokenWithGivenClientId(\n+                        parameters.getOAuth2TokenCache(),\n+                        clientId,\n+                        parameters.getRedirectUri(),\n+                        refreshTokenRecord,\n+                        parameters.getAccount()\n+                );", "originalCommit": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg2MjkyMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434862922", "bodyText": "The use case here is:\nWe have a Family Refresh Token for an Microsoft first party client id(Teams for Life here) for this user after he signs in\nNow we get a silent request for this IAccount with another Microsoft first party client id(Teams for Work) - at this point we don't have any account associated with this client id.\nWhat this change enables is, if the user has Family Refresh Token (applicable only for MSFT ), we try to make a dummy silent request in tryFociTokenWithGivenClientId with the FRT, default scopes and the new client id  and if the request succeeds we save the account and tokens for this client id in this cache. The access token here won't be used and will be replaced as it has just the default scopes.\nNow the caller when it looks for the IAccount for this client, it gets one and makes the actual request for an access token for the required scopes passed in using the new RT which was saved.\nThe boolean can be ignored in our case, as we have sufficient logging in tryFociTokenWithGivenClientId to understand if the request succeeds.\nHope this helps", "author": "kreedula", "createdAt": "2020-06-03T21:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg0Njk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4MTIzMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434881231", "bodyText": "Oh, no, thanks for bearing with me.\nOK, so the interesting side effect of tryFociWithGivenClientId is to bind the FRT to the new client id and store these refresh tokens by client id in the cache.  Is it possible to return a non-null AccountRecord from the call to getAccountByLocalAccountId even if the attempt to execute the family token refresh failed with the new client id? It seems like it shouldn't, right now, but that's largely because I'm thinking that the sole purpose of this method is to return an account iff this is a client id that part of the family, and if that was the case the refresh would have succeeded.", "author": "AdamBJohnsonx", "createdAt": "2020-06-03T21:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg0Njk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk0MTMxNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434941315", "bodyText": "yes, not just a side effect, i could say the primary purpose of this tryFociWithGivenClientId is to insert an AccountRecord for the given client, if it's part of FOCI (we determine this by sending a request with FRT and if it succeeds).\nAnd yes, if the token request with FRT failed , we should not get an AccountRecord when getAccountByLocalAccountId is invoked with that client id in this scenerio", "author": "kreedula", "createdAt": "2020-06-04T01:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg0Njk0Ng=="}], "type": "inlineReview"}, {"oid": "b8f4d0ed5b84c37dd34def53aeada19dce3418c0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b8f4d0ed5b84c37dd34def53aeada19dce3418c0", "message": "Minor changes to address comments", "committedDate": "2020-06-03T21:18:10Z", "type": "commit"}, {"oid": "a6674f1c6948fe4b5c93bb341ef0b1ae14aa9b2c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a6674f1c6948fe4b5c93bb341ef0b1ae14aa9b2c", "message": "Merge branch 'dev' into kreedula/msal-foci", "committedDate": "2020-06-03T21:30:02Z", "type": "commit"}]}