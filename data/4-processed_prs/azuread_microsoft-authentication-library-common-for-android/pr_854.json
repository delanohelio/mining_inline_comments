{"pr_number": 854, "pr_title": "Add dual screen support in common", "pr_createdAt": "2020-03-17T00:44:23Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854", "timeline": [{"oid": "7c1cdc9ad3203a5a73ee19ec4fcb9f13a228951a", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7c1cdc9ad3203a5a73ee19ec4fcb9f13a228951a", "message": "Add dual screen support in common", "committedDate": "2020-03-17T00:42:26Z", "type": "commit"}, {"oid": "2adcf7c9d37c56a265b87b0e3acde73a231b7a31", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2adcf7c9d37c56a265b87b0e3acde73a231b7a31", "message": "update configchanges", "committedDate": "2020-03-17T20:26:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1Mzg3Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r393953876", "bodyText": "This seems to early to detect rotation. What if the Activity is created, user leaves, rotates device, and returns?\nDo we need to move this to onResume()?", "author": "iambmelt", "createdAt": "2020-03-17T20:36:30Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/AuthorizationActivity.java", "diffHunk": "@@ -75,6 +102,8 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n                 .setTransitionStyle(FragmentTransaction.TRANSIT_FRAGMENT_FADE)\n                 .replace(R.id.authorization_activity_content, mFragment)\n                 .commit();\n+\n+        adjustLayout();", "originalCommit": "2adcf7c9d37c56a265b87b0e3acde73a231b7a31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NTIzOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r393955239", "bodyText": "Oh, I see there's also a call in onConfigurationChanged()\nI guess this is fine?", "author": "iambmelt", "createdAt": "2020-03-17T20:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1Mzg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjU5OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r393956599", "bodyText": "Can these constraints be defined declaratively in the XML?\nSomething like:\nif (appIsSpannned) {\n    setContentView(R.layout.spanned_authorization_activity);\n} else {\n    setContentView(R.layout.authorization_activity);\n}", "author": "iambmelt", "createdAt": "2020-03-17T20:41:14Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/oauth2/AuthorizationActivity.java", "diffHunk": "@@ -83,4 +112,49 @@ public void onBackPressed() {\n             super.onBackPressed();\n         }\n     }\n+\n+    @Override\n+    public void onConfigurationChanged(Configuration newConfig) {\n+        super.onConfigurationChanged(newConfig);\n+        adjustLayout();\n+    }\n+\n+    private void adjustLayout(){", "originalCommit": "2adcf7c9d37c56a265b87b0e3acde73a231b7a31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5NDU5OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r393994598", "bodyText": "Yes, but we'll need three files for each dual screen activities.\n\nNot spanned.\nSpanned - horizontal.\nSpanned - vertical.\n\nNOTE: after getting this feedback, I realized that the current solution can be made more reusable. Therefore, I made a change to do the following.\n\nCreated a 'dual_screen_layout.xml'.\n\n\nInternally, this contains the 'content' area, and the 'blank' area.\n\n\nMoved adjustLayout() to DualScreenUtil.\n\n\nThis function now takes an activity that uses 'dual_screen_layout.xml'.\nBased on the screen state, it will adjust the 'content' and the 'blank' area appropriately.\n\n\nAny page that needs to support duo will have to do the following\n\n\ncall setContentView(R.layout.dual_screen_layout);\nattach its 'content to be displayed' to the 'content' area of dual_screen_layout.xml.\n\nThis could be a fragment, or a ViewGroup (inflated from another layout)\n\n\ncall DualScreenUtil.adjustLayoutForDualScreenActivity().\n\nThis means I'll be able to reuse this with AuthorizationActivity (Broker/MSAL),  AuthenticationActivity (ADAL), AccountChooserActivity (Broker) and any other Broker pages that might have to support Duo in the future.", "author": "rpdome", "createdAt": "2020-03-17T21:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5NTY4Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r393995682", "bodyText": "@rpdome Overkill to define an Activity subclass that overrides setContentView() for this to support dual-screen?\nJust riffing ideas", "author": "iambmelt", "createdAt": "2020-03-17T22:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5ODMwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r393998303", "bodyText": "That might make it cleaner. Let me try that.", "author": "rpdome", "createdAt": "2020-03-17T22:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyMjczMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r394022733", "bodyText": "@iambmelt  done. Thanks for the suggestion.", "author": "rpdome", "createdAt": "2020-03-17T23:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NjU5OQ=="}], "type": "inlineReview"}, {"oid": "48b90e23b99a10bd25b223815bb5c33db93c4cde", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/48b90e23b99a10bd25b223815bb5c33db93c4cde", "message": "Make dual screen layout reusable", "committedDate": "2020-03-17T21:49:50Z", "type": "commit"}, {"oid": "74cf461a6888b4298f96cdcdceaa6589582917a0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/74cf461a6888b4298f96cdcdceaa6589582917a0", "message": "Merge branch 'dev' into rapong/dualscreen", "committedDate": "2020-03-17T21:58:26Z", "type": "commit"}, {"oid": "1f2bda9b0dc4ebe3766eb22b477a8a5b300110d9", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1f2bda9b0dc4ebe3766eb22b477a8a5b300110d9", "message": "Migrate to DualScreenActivity", "committedDate": "2020-03-17T23:07:08Z", "type": "commit"}, {"oid": "58206e76c0622201277313a6b7d150a07499d136", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/58206e76c0622201277313a6b7d150a07499d136", "message": "Merge branch 'rapong/dualscreen' of https://github.com/AzureAD/microsoft-authentication-library-common-for-android into rapong/dualscreen", "committedDate": "2020-03-17T23:10:04Z", "type": "commit"}, {"oid": "cca7ee984c1d98f43ad1e5ac0d04085dfd80cbe3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/cca7ee984c1d98f43ad1e5ac0d04085dfd80cbe3", "message": "Cleanup", "committedDate": "2020-03-17T23:20:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNjk3Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r394026972", "bodyText": "I don't see the int result defined here. What does 0 mean? Can we javadoc?", "author": "iambmelt", "createdAt": "2020-03-17T23:25:03Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/DualScreenActivity.java", "diffHunk": "@@ -0,0 +1,177 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.ui;\n+\n+import android.app.Activity;\n+import android.content.Context;\n+import android.content.pm.PackageManager;\n+import android.content.res.Configuration;\n+import android.graphics.Rect;\n+import android.view.LayoutInflater;\n+import android.view.Surface;\n+import android.view.WindowManager;\n+import android.widget.RelativeLayout;\n+\n+import androidx.annotation.NonNull;\n+import androidx.constraintlayout.widget.ConstraintLayout;\n+import androidx.constraintlayout.widget.ConstraintSet;\n+import androidx.fragment.app.Fragment;\n+import androidx.fragment.app.FragmentActivity;\n+import androidx.fragment.app.FragmentTransaction;\n+\n+import com.microsoft.device.display.DisplayMask;\n+import com.microsoft.identity.common.R;\n+\n+import java.util.List;\n+\n+// This activity readjusts its child layouts so that they're displayed on both single-screen and dual-screen device correctly.\n+public class DualScreenActivity extends FragmentActivity {\n+\n+    @Override\n+    public void setContentView(int layoutResID) {\n+        initializeContentView();\n+\n+        final RelativeLayout contentLayout = findViewById(com.microsoft.identity.common.R.id.dual_screen_content);\n+        LayoutInflater.from(this).inflate(layoutResID, contentLayout);\n+    }\n+\n+    private void initializeContentView(){\n+        super.setContentView(R.layout.dual_screen_layout);\n+        adjustLayoutForDualScreenActivity();\n+    }\n+\n+    public void setFragment(@NonNull final Fragment fragment) {\n+        initializeContentView();\n+        getSupportFragmentManager()\n+                .beginTransaction()\n+                .setTransitionStyle(FragmentTransaction.TRANSIT_FRAGMENT_FADE)\n+                .replace(R.id.dual_screen_content, fragment)\n+                .commit();\n+    }\n+\n+    @Override\n+    public void onConfigurationChanged(Configuration newConfig) {\n+        super.onConfigurationChanged(newConfig);\n+        adjustLayoutForDualScreenActivity();\n+    }\n+\n+    private void adjustLayoutForDualScreenActivity() {\n+        int rotation = getRotation(this);\n+        boolean isAppSpanned = isAppSpanned(this);\n+        boolean isHorizontal = rotation == Surface.ROTATION_0 || rotation == Surface.ROTATION_180;\n+\n+        final ConstraintSet constraintSet = new ConstraintSet();\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.LEFT, R.id.dual_screen_layout, ConstraintSet.LEFT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.RIGHT, R.id.dual_screen_layout, ConstraintSet.RIGHT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.TOP, R.id.dual_screen_layout, ConstraintSet.TOP, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.BOTTOM, R.id.dual_screen_layout, ConstraintSet.BOTTOM, 0);\n+\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.LEFT, R.id.dual_screen_layout, ConstraintSet.LEFT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.RIGHT, R.id.dual_screen_layout, ConstraintSet.RIGHT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.TOP, R.id.dual_screen_layout, ConstraintSet.TOP, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.BOTTOM, R.id.dual_screen_layout, ConstraintSet.BOTTOM, 0);\n+\n+        if (isAppSpanned) {\n+            if (isHorizontal) {\n+                int duoHingeWidth = getHinge(this, rotation).width() / 2;\n+\n+                // WebView is on the right.\n+                constraintSet.connect(R.id.dual_screen_content, ConstraintSet.LEFT, R.id.vertical_guideline, ConstraintSet.RIGHT, duoHingeWidth);\n+\n+                // Empty view is on the left.\n+                constraintSet.connect(R.id.dual_screen_empty_view, ConstraintSet.RIGHT, R.id.vertical_guideline, ConstraintSet.LEFT, 0);\n+            } else {\n+                int duoHingeWidth = getHinge(this, rotation).height() / 2;\n+\n+                // WebView is on the top.\n+                constraintSet.connect(R.id.dual_screen_content, ConstraintSet.BOTTOM, R.id.horizontal_guideline, ConstraintSet.TOP, duoHingeWidth);\n+\n+                // Empty view is in the bottom.\n+                constraintSet.connect(R.id.dual_screen_empty_view, ConstraintSet.TOP, R.id.horizontal_guideline, ConstraintSet.BOTTOM, 0);\n+            }\n+        } else {\n+            // Shrink empty view. If constraint is not set, then its size will be (0,0).\n+            constraintSet.clear(R.id.dual_screen_empty_view);\n+        }\n+\n+        final ConstraintLayout dualScreenLayout = findViewById(R.id.dual_screen_layout);\n+        dualScreenLayout.setConstraintSet(constraintSet);\n+    }\n+\n+    public boolean isAppSpanned(final Activity activity) {\n+        if (!isDualScreenDevice(activity)) {\n+            return false;\n+        }\n+\n+        int rotation = getRotation(activity);\n+        Rect hinge = getHinge(activity, rotation);\n+        Rect windowRect = getWindowRect(activity);\n+\n+        if (windowRect.width() > 0 && windowRect.height() > 0) {\n+            // The windowRect doesn't intersect hinge\n+            return hinge.intersect(windowRect);\n+        }\n+\n+        return false;\n+    }\n+\n+    public int getRotation(Activity activity) {\n+        WindowManager wm = (WindowManager) activity.getSystemService(Context.WINDOW_SERVICE);\n+        int rotation = 0;", "originalCommit": "cca7ee984c1d98f43ad1e5ac0d04085dfd80cbe3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d3abc8656ea41173aa65aa38c052740241b1a33d", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d3abc8656ea41173aa65aa38c052740241b1a33d", "message": "add comments", "committedDate": "2020-03-17T23:30:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTU0MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r394029541", "bodyText": "why remove keyboardhidden here?", "author": "kreedula", "createdAt": "2020-03-17T23:34:00Z", "path": "common/src/main/AndroidManifest.xml", "diffHunk": "@@ -7,7 +7,7 @@\n     <application>\n         <activity\n             android:name=\"com.microsoft.identity.common.internal.providers.oauth2.AuthorizationActivity\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize\" />", "originalCommit": "d3abc8656ea41173aa65aa38c052740241b1a33d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Njk1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r394046958", "bodyText": "these looks exactly the same as the above 4 statements, is this intended?", "author": "kreedula", "createdAt": "2020-03-18T00:37:57Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/DualScreenUtil.java", "diffHunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.ui;\n+\n+import android.app.Activity;\n+import android.content.Context;\n+import android.content.pm.PackageManager;\n+import android.graphics.Rect;\n+import android.view.Surface;\n+import android.view.WindowManager;\n+\n+import androidx.annotation.NonNull;\n+import androidx.constraintlayout.widget.ConstraintLayout;\n+import androidx.constraintlayout.widget.ConstraintSet;\n+\n+import com.microsoft.device.display.DisplayMask;\n+import com.microsoft.identity.common.R;\n+\n+import java.util.List;\n+\n+// Adapt from https://github.com/microsoft/surface-duo-sdk-samples/blob/master/utils/src/main/java/com/microsoft/device/display/samples/utils/ScreenHelper.java\n+public class DualScreenUtil {\n+\n+    // Given a dual screen activity (an activity which uses R.layout.dual_screen_layout),\n+    // readjust its child layouts so that it's displayed on both single-screen and dual-screen device correct .\n+    public static void adjustLayoutForDualScreenActivity(@NonNull final Activity dualScreenActivity) {\n+        final ConstraintLayout dualScreenLayout = dualScreenActivity.findViewById(R.id.dual_screen_layout);\n+        if (dualScreenLayout == null) {\n+            throw new IllegalArgumentException(\"This is not a dual screen activity. \" +\n+                    \"Dual screen activity must use R.layout.dual_screen_layout.\");\n+        }\n+\n+        int rotation = getRotation(dualScreenActivity);\n+        boolean isAppSpanned = isAppSpanned(dualScreenActivity);\n+        boolean isHorizontal = rotation == Surface.ROTATION_0 || rotation == Surface.ROTATION_180;\n+\n+        final ConstraintSet constraintSet = new ConstraintSet();\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.LEFT, R.id.dual_screen_layout, ConstraintSet.LEFT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.RIGHT, R.id.dual_screen_layout, ConstraintSet.RIGHT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.TOP, R.id.dual_screen_layout, ConstraintSet.TOP, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.BOTTOM, R.id.dual_screen_layout, ConstraintSet.BOTTOM, 0);\n+\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.LEFT, R.id.dual_screen_layout, ConstraintSet.LEFT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.RIGHT, R.id.dual_screen_layout, ConstraintSet.RIGHT, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.TOP, R.id.dual_screen_layout, ConstraintSet.TOP, 0);\n+        constraintSet.connect(R.id.dual_screen_content, ConstraintSet.BOTTOM, R.id.dual_screen_layout, ConstraintSet.BOTTOM, 0);", "originalCommit": "74cf461a6888b4298f96cdcdceaa6589582917a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0OTU1OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/854#discussion_r394049559", "bodyText": "nice catch. \ud83d\ude06", "author": "rpdome", "createdAt": "2020-03-18T00:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Njk1OA=="}], "type": "inlineReview"}, {"oid": "6173ac522d119a713abb3dd912a5bde3cd621bd6", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6173ac522d119a713abb3dd912a5bde3cd621bd6", "message": "Address comments", "committedDate": "2020-03-18T19:21:14Z", "type": "commit"}, {"oid": "4a6b063418c0d5691f6811ce4d87c6bc7c59c0ce", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/4a6b063418c0d5691f6811ce4d87c6bc7c59c0ce", "message": "Merge branch 'dev' into rapong/dualscreen", "committedDate": "2020-03-18T20:44:11Z", "type": "commit"}]}