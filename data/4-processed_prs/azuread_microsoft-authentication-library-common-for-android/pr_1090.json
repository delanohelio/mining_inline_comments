{"pr_number": 1090, "pr_title": "[IPC part 2] Refactor content provider strategy", "pr_createdAt": "2020-10-23T21:58:15Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIwMjQxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511202410", "bodyText": "Do these need to be static?", "author": "AdamBJohnsonx", "createdAt": "2020-10-24T00:02:18Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/ContentProviderStrategy.java", "diffHunk": "@@ -0,0 +1,132 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.content.Context;\n+import android.content.pm.ProviderInfo;\n+import android.database.Cursor;\n+import android.net.Uri;\n+import android.os.Bundle;\n+import android.util.Base64;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.util.ParcelableUtil;\n+\n+import java.util.List;\n+\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.AUTHORITY;\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.CONTENT_SCHEME;\n+\n+/**\n+ * A strategy for communicating with the targeted broker via Content Provider.\n+ */\n+public class ContentProviderStrategy implements IIpcStrategy {\n+\n+    private static final String TAG = ContentProviderStrategy.class.getName();\n+    private final Context mContext;\n+\n+    public ContentProviderStrategy(final Context context) {\n+        mContext = context;\n+    }\n+\n+    @Override\n+    @Nullable public Bundle communicateToBroker(@NonNull BrokerOperationBundle brokerOperationBundle)\n+            throws BaseException {\n+\n+        final String methodName = brokerOperationBundle.getOperation().name();\n+\n+        final Uri uri = getContentProviderURI(\n+                brokerOperationBundle.getTargetBrokerAppPackageName(),\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+        Logger.info(TAG + methodName, \"Request to BrokerContentProvider for uri path \" +\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+\n+        String marshalledRequestString = null;\n+\n+        final Bundle requestBundle = brokerOperationBundle.getBundle();\n+        if (requestBundle != null) {\n+            byte[] marshalledBytes = ParcelableUtil.marshall(requestBundle);\n+            marshalledRequestString = Base64.encodeToString(marshalledBytes, 0);\n+        }\n+\n+        final Cursor cursor = mContext.getContentResolver().query(\n+                uri,\n+                null,\n+                marshalledRequestString,\n+                null,\n+                null\n+        );\n+\n+        if (cursor != null) {\n+            final Bundle resultBundle = cursor.getExtras();\n+            cursor.close();\n+            Logger.info(TAG + methodName, \"Received successful result from Broker Content Provider.\");\n+            return resultBundle;\n+        } else {\n+            final String message = \"Failed to get result from Broker Content Provider, cursor is null\";\n+            Logger.error(TAG + methodName, message, null);\n+            throw new BrokerCommunicationException(message, null);\n+        }\n+    }\n+\n+    /**\n+     * Returns a content provider URI for the given path.\n+     */\n+    private static Uri getContentProviderURI(@NonNull final String activeBrokerPackageName,", "originalCommit": "c5aaa86dcbf2865f432805759509f95843d4c4bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIwMjQ5OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511202499", "bodyText": "Is it important that these are static?", "author": "AdamBJohnsonx", "createdAt": "2020-10-24T00:02:51Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/ContentProviderStrategy.java", "diffHunk": "@@ -0,0 +1,132 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.content.Context;\n+import android.content.pm.ProviderInfo;\n+import android.database.Cursor;\n+import android.net.Uri;\n+import android.os.Bundle;\n+import android.util.Base64;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.util.ParcelableUtil;\n+\n+import java.util.List;\n+\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.AUTHORITY;\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.CONTENT_SCHEME;\n+\n+/**\n+ * A strategy for communicating with the targeted broker via Content Provider.\n+ */\n+public class ContentProviderStrategy implements IIpcStrategy {\n+\n+    private static final String TAG = ContentProviderStrategy.class.getName();\n+    private final Context mContext;\n+\n+    public ContentProviderStrategy(final Context context) {\n+        mContext = context;\n+    }\n+\n+    @Override\n+    @Nullable public Bundle communicateToBroker(@NonNull BrokerOperationBundle brokerOperationBundle)\n+            throws BaseException {\n+\n+        final String methodName = brokerOperationBundle.getOperation().name();\n+\n+        final Uri uri = getContentProviderURI(\n+                brokerOperationBundle.getTargetBrokerAppPackageName(),\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+        Logger.info(TAG + methodName, \"Request to BrokerContentProvider for uri path \" +\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+\n+        String marshalledRequestString = null;\n+\n+        final Bundle requestBundle = brokerOperationBundle.getBundle();\n+        if (requestBundle != null) {\n+            byte[] marshalledBytes = ParcelableUtil.marshall(requestBundle);\n+            marshalledRequestString = Base64.encodeToString(marshalledBytes, 0);\n+        }\n+\n+        final Cursor cursor = mContext.getContentResolver().query(\n+                uri,\n+                null,\n+                marshalledRequestString,\n+                null,\n+                null\n+        );\n+\n+        if (cursor != null) {\n+            final Bundle resultBundle = cursor.getExtras();\n+            cursor.close();\n+            Logger.info(TAG + methodName, \"Received successful result from Broker Content Provider.\");\n+            return resultBundle;\n+        } else {\n+            final String message = \"Failed to get result from Broker Content Provider, cursor is null\";\n+            Logger.error(TAG + methodName, message, null);\n+            throw new BrokerCommunicationException(message, null);\n+        }\n+    }\n+\n+    /**\n+     * Returns a content provider URI for the given path.\n+     */\n+    private static Uri getContentProviderURI(@NonNull final String activeBrokerPackageName,\n+                                             @NonNull final String path) {\n+        final String authority = getContentProviderAuthority(activeBrokerPackageName);\n+        return Uri.parse(CONTENT_SCHEME + authority + path);\n+    }\n+\n+    /**\n+     * Returns content provider authority.\n+     */\n+    private static String getContentProviderAuthority(@NonNull final String activeBrokerPackageName) {", "originalCommit": "c5aaa86dcbf2865f432805759509f95843d4c4bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIwMzA1NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511203055", "bodyText": "Is this message still accurate?", "author": "AdamBJohnsonx", "createdAt": "2020-10-24T00:06:01Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -496,29 +495,12 @@\n                 ErrorStrings.UNSUPPORTED_BROKER_VERSION_ERROR_MESSAGE);\n     }\n \n-    public @NonNull Bundle getBundleFromInteractiveRequestIntent(@NonNull final Intent intent) throws ClientException {\n-        final ComponentName componentName = intent.getComponent();\n-        final Bundle bundle = intent.getExtras();\n-\n-        if (componentName == null || bundle == null) {\n-            throw new ClientException(\"Unexpected error. Content of Authorization Intent should not be null.\");\n-        }\n-\n-        final Bundle resultBundle = new Bundle();\n-        resultBundle.putBundle(BUNDLE, bundle);\n-        resultBundle.putString(PACKAGE_NAME, componentName.getPackageName());\n-        resultBundle.putString(CLASS_NAME, componentName.getClassName());\n-        return resultBundle;\n-    }\n-\n     public @NonNull Intent getIntentForInteractiveRequestFromResultBundle(@NonNull final Bundle resultBundle) throws ClientException {\n-        final String packageName = resultBundle.getString(PACKAGE_NAME);\n-        final String className = resultBundle.getString(CLASS_NAME);\n-        final Bundle bundle = resultBundle.getBundle(BUNDLE);\n+        final String packageName = resultBundle.getString(BROKER_PACKAGE_NAME);\n+        final String className = resultBundle.getString(BROKER_ACTIVITY_NAME);\n \n         if (StringUtil.isEmpty(packageName) ||\n-                StringUtil.isEmpty(className) ||\n-                bundle == null) {\n+                StringUtil.isEmpty(className)) {\n             throw new ClientException(\"Unexpected error. Content of Authorization Intent bundle should not be null.\");", "originalCommit": "c5aaa86dcbf2865f432805759509f95843d4c4bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIwMzg2Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511203867", "bodyText": "It would be convenient to make these non-static, and just configure with a list of them.", "author": "AdamBJohnsonx", "createdAt": "2020-10-24T00:10:38Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/ContentProviderStrategy.java", "diffHunk": "@@ -0,0 +1,132 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.content.Context;\n+import android.content.pm.ProviderInfo;\n+import android.database.Cursor;\n+import android.net.Uri;\n+import android.os.Bundle;\n+import android.util.Base64;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.util.ParcelableUtil;\n+\n+import java.util.List;\n+\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.AUTHORITY;\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.CONTENT_SCHEME;\n+\n+/**\n+ * A strategy for communicating with the targeted broker via Content Provider.\n+ */\n+public class ContentProviderStrategy implements IIpcStrategy {\n+\n+    private static final String TAG = ContentProviderStrategy.class.getName();\n+    private final Context mContext;\n+\n+    public ContentProviderStrategy(final Context context) {\n+        mContext = context;\n+    }\n+\n+    @Override\n+    @Nullable public Bundle communicateToBroker(@NonNull BrokerOperationBundle brokerOperationBundle)\n+            throws BaseException {\n+\n+        final String methodName = brokerOperationBundle.getOperation().name();\n+\n+        final Uri uri = getContentProviderURI(\n+                brokerOperationBundle.getTargetBrokerAppPackageName(),\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+        Logger.info(TAG + methodName, \"Request to BrokerContentProvider for uri path \" +\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+\n+        String marshalledRequestString = null;\n+\n+        final Bundle requestBundle = brokerOperationBundle.getBundle();\n+        if (requestBundle != null) {\n+            byte[] marshalledBytes = ParcelableUtil.marshall(requestBundle);\n+            marshalledRequestString = Base64.encodeToString(marshalledBytes, 0);\n+        }\n+\n+        final Cursor cursor = mContext.getContentResolver().query(\n+                uri,\n+                null,\n+                marshalledRequestString,\n+                null,\n+                null\n+        );\n+\n+        if (cursor != null) {\n+            final Bundle resultBundle = cursor.getExtras();\n+            cursor.close();\n+            Logger.info(TAG + methodName, \"Received successful result from Broker Content Provider.\");\n+            return resultBundle;\n+        } else {\n+            final String message = \"Failed to get result from Broker Content Provider, cursor is null\";\n+            Logger.error(TAG + methodName, message, null);\n+            throw new BrokerCommunicationException(message, null);\n+        }\n+    }\n+\n+    /**\n+     * Returns a content provider URI for the given path.\n+     */\n+    private static Uri getContentProviderURI(@NonNull final String activeBrokerPackageName,\n+                                             @NonNull final String path) {\n+        final String authority = getContentProviderAuthority(activeBrokerPackageName);\n+        return Uri.parse(CONTENT_SCHEME + authority + path);\n+    }\n+\n+    /**\n+     * Returns content provider authority.\n+     */\n+    private static String getContentProviderAuthority(@NonNull final String activeBrokerPackageName) {\n+        return activeBrokerPackageName + \".\" + AUTHORITY;\n+    }\n+\n+    /**\n+     * Returns true of the target package name supports this content provider strategy.\n+     */\n+    public static boolean isBrokerContentProviderAvailable(@NonNull final Context applicationContext,", "originalCommit": "c5aaa86dcbf2865f432805759509f95843d4c4bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "179eee0a98cc2a177cc25f9f3a575f0e036390a2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/179eee0a98cc2a177cc25f9f3a575f0e036390a2", "message": "[Part 2] Refactor Content Provider strategy", "committedDate": "2020-10-24T01:19:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzNzY2MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511237660", "bodyText": "How is the broker going to be specified?", "author": "shahzaibj", "createdAt": "2020-10-24T01:31:34Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/BoundServiceStrategy.java", "diffHunk": "@@ -16,7 +16,7 @@\n import java.util.concurrent.TimeoutException;\n \n /**\n- * A strategy for communicating with the active broker (:auth process) via Bound Service.\n+ * A strategy for communicating with the targeted broker via Bound Service.", "originalCommit": "179eee0a98cc2a177cc25f9f3a575f0e036390a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI0MDIzOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511240238", "bodyText": "BrokerOperationBundle.targetBrokerAppPackageName.", "author": "rpdome", "createdAt": "2020-10-24T01:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzNzY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzODYyNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511238627", "bodyText": "Could these paths be derived out of the operation enum? (so we don't need to have this switch)", "author": "shahzaibj", "createdAt": "2020-10-24T01:33:21Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/BrokerOperationBundle.java", "diffHunk": "@@ -63,11 +69,42 @@\n     @Getter\n     @Nullable final private Bundle bundle;\n \n-//    public String getAccountManagerOperationKey(){\n+    //    public String getAccountManagerOperationKey(){\n //        // TODO\n //    }\n //\n-//    public String getContentProviderUriPath(){\n-//        // TODO\n-//    }\n+    public String getContentProviderPath() throws BrokerCommunicationException {\n+        final String methodName = \":getContentProviderUriPath\";\n+\n+        switch (operation) {\n+            case MSAL_HELLO:\n+                return BrokerContentProvider.HELLO_PATH;\n+\n+            case MSAL_GET_INTENT_FOR_INTERACTIVE_REQUEST:\n+                return BrokerContentProvider.ACQUIRE_TOKEN_INTERACTIVE_PATH;\n+\n+            case MSAL_ACQUIRE_TOKEN_SILENT:\n+                return BrokerContentProvider.ACQUIRE_TOKEN_SILENT_PATH;\n+\n+            case MSAL_GET_ACCOUNTS:\n+                return BrokerContentProvider.GET_ACCOUNTS_PATH;\n+\n+            case MSAL_REMOVE_ACCOUNT:\n+                return BrokerContentProvider.REMOVE_ACCOUNTS_PATH;\n+\n+            case MSAL_GET_DEVICE_MODE:\n+                return BrokerContentProvider.GET_DEVICE_MODE_PATH;\n+\n+            case MSAL_GET_CURRENT_ACCOUNT_IN_SHARED_DEVICE:\n+                return BrokerContentProvider.GET_CURRENT_ACCOUNT_SHARED_DEVICE_PATH;\n+\n+            case MSAL_SIGN_OUT_FROM_SHARED_DEVICE:\n+                return BrokerContentProvider.SIGN_OUT_FROM_SHARED_DEVICE_PATH;", "originalCommit": "179eee0a98cc2a177cc25f9f3a575f0e036390a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI0MTAxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511241010", "bodyText": "not really. the operation could be converted to a content provider path, or account manager key, or something else, depending on the communication mechanism. so it's not a 1:1 relationship.", "author": "rpdome", "createdAt": "2020-10-24T01:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzODYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI0MTg1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511241857", "bodyText": "Yeah what I meant is that should we store each of those mappings inside the enum? (rather than using constants from a different file)", "author": "shahzaibj", "createdAt": "2020-10-24T01:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzODYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI0MjI3OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511242278", "bodyText": "So the operation contains mapping for each communication mechanism", "author": "shahzaibj", "createdAt": "2020-10-24T01:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzODYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI1MTU1NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511251555", "bodyText": "I'd say no, but I don't feel strong on this.\nThe reason is that the same constants are also used on the server (broker) side, and that side should not be aware of these operation object (or it should?)", "author": "rpdome", "createdAt": "2020-10-24T02:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzODYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzOTc2NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511239765", "bodyText": "targetedBrokerPackageName?", "author": "shahzaibj", "createdAt": "2020-10-24T01:35:24Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/ContentProviderStrategy.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.content.Context;\n+import android.content.pm.ProviderInfo;\n+import android.database.Cursor;\n+import android.net.Uri;\n+import android.os.Bundle;\n+import android.util.Base64;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.util.ParcelableUtil;\n+\n+import java.util.List;\n+\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.AUTHORITY;\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.CONTENT_SCHEME;\n+\n+/**\n+ * A strategy for communicating with the targeted broker via Content Provider.\n+ */\n+public class ContentProviderStrategy implements IIpcStrategy {\n+\n+    private static final String TAG = ContentProviderStrategy.class.getName();\n+    private final Context mContext;\n+\n+    public ContentProviderStrategy(final Context context) {\n+        mContext = context;\n+    }\n+\n+    @Override\n+    @Nullable public Bundle communicateToBroker(@NonNull BrokerOperationBundle brokerOperationBundle)\n+            throws BaseException {\n+\n+        final String methodName = brokerOperationBundle.getOperation().name();\n+\n+        final Uri uri = getContentProviderURI(\n+                brokerOperationBundle.getTargetBrokerAppPackageName(),\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+        Logger.info(TAG + methodName, \"Request to BrokerContentProvider for uri path \" +\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+\n+        String marshalledRequestString = null;\n+\n+        final Bundle requestBundle = brokerOperationBundle.getBundle();\n+        if (requestBundle != null) {\n+            byte[] marshalledBytes = ParcelableUtil.marshall(requestBundle);\n+            marshalledRequestString = Base64.encodeToString(marshalledBytes, 0);\n+        }\n+\n+        final Cursor cursor = mContext.getContentResolver().query(\n+                uri,\n+                null,\n+                marshalledRequestString,\n+                null,\n+                null\n+        );\n+\n+        if (cursor != null) {\n+            final Bundle resultBundle = cursor.getExtras();\n+            cursor.close();\n+            Logger.info(TAG + methodName, \"Received successful result from Broker Content Provider.\");\n+            return resultBundle;\n+        } else {\n+            final String message = \"Failed to get result from Broker Content Provider, cursor is null\";\n+            Logger.error(TAG + methodName, message, null);\n+            throw new BrokerCommunicationException(message, null);\n+        }\n+    }\n+\n+    /**\n+     * Returns a content provider URI for the given path.\n+     */\n+    private Uri getContentProviderURI(@NonNull final String activeBrokerPackageName,", "originalCommit": "179eee0a98cc2a177cc25f9f3a575f0e036390a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIzOTk2OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511239969", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String getContentProviderAuthority(@NonNull final String activeBrokerPackageName) {\n          \n          \n            \n                private String getContentProviderAuthority(@NonNull final String targetedBrokerPackageName) {", "author": "shahzaibj", "createdAt": "2020-10-24T01:35:46Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/ContentProviderStrategy.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.content.Context;\n+import android.content.pm.ProviderInfo;\n+import android.database.Cursor;\n+import android.net.Uri;\n+import android.os.Bundle;\n+import android.util.Base64;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.util.ParcelableUtil;\n+\n+import java.util.List;\n+\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.AUTHORITY;\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.CONTENT_SCHEME;\n+\n+/**\n+ * A strategy for communicating with the targeted broker via Content Provider.\n+ */\n+public class ContentProviderStrategy implements IIpcStrategy {\n+\n+    private static final String TAG = ContentProviderStrategy.class.getName();\n+    private final Context mContext;\n+\n+    public ContentProviderStrategy(final Context context) {\n+        mContext = context;\n+    }\n+\n+    @Override\n+    @Nullable public Bundle communicateToBroker(@NonNull BrokerOperationBundle brokerOperationBundle)\n+            throws BaseException {\n+\n+        final String methodName = brokerOperationBundle.getOperation().name();\n+\n+        final Uri uri = getContentProviderURI(\n+                brokerOperationBundle.getTargetBrokerAppPackageName(),\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+        Logger.info(TAG + methodName, \"Request to BrokerContentProvider for uri path \" +\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+\n+        String marshalledRequestString = null;\n+\n+        final Bundle requestBundle = brokerOperationBundle.getBundle();\n+        if (requestBundle != null) {\n+            byte[] marshalledBytes = ParcelableUtil.marshall(requestBundle);\n+            marshalledRequestString = Base64.encodeToString(marshalledBytes, 0);\n+        }\n+\n+        final Cursor cursor = mContext.getContentResolver().query(\n+                uri,\n+                null,\n+                marshalledRequestString,\n+                null,\n+                null\n+        );\n+\n+        if (cursor != null) {\n+            final Bundle resultBundle = cursor.getExtras();\n+            cursor.close();\n+            Logger.info(TAG + methodName, \"Received successful result from Broker Content Provider.\");\n+            return resultBundle;\n+        } else {\n+            final String message = \"Failed to get result from Broker Content Provider, cursor is null\";\n+            Logger.error(TAG + methodName, message, null);\n+            throw new BrokerCommunicationException(message, null);\n+        }\n+    }\n+\n+    /**\n+     * Returns a content provider URI for the given path.\n+     */\n+    private Uri getContentProviderURI(@NonNull final String activeBrokerPackageName,\n+                                      @NonNull final String path) {\n+        final String authority = getContentProviderAuthority(activeBrokerPackageName);\n+        return Uri.parse(CONTENT_SCHEME + authority + path);\n+    }\n+\n+    /**\n+     * Returns content provider authority.\n+     */\n+    private String getContentProviderAuthority(@NonNull final String activeBrokerPackageName) {", "originalCommit": "179eee0a98cc2a177cc25f9f3a575f0e036390a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTI0MDI4NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1090#discussion_r511240284", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns true of the target package name supports this content provider strategy.\n          \n          \n            \n                 * Returns true if the target package name supports this content provider strategy.", "author": "shahzaibj", "createdAt": "2020-10-24T01:36:19Z", "path": "common/src/main/java/com/microsoft/identity/common/internal/broker/ipc/ContentProviderStrategy.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.common.internal.broker.ipc;\n+\n+import android.content.Context;\n+import android.content.pm.ProviderInfo;\n+import android.database.Cursor;\n+import android.net.Uri;\n+import android.os.Bundle;\n+import android.util.Base64;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.microsoft.identity.common.exception.BaseException;\n+import com.microsoft.identity.common.exception.BrokerCommunicationException;\n+import com.microsoft.identity.common.internal.logging.Logger;\n+import com.microsoft.identity.common.internal.util.ParcelableUtil;\n+\n+import java.util.List;\n+\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.AUTHORITY;\n+import static com.microsoft.identity.common.adal.internal.AuthenticationConstants.BrokerContentProvider.CONTENT_SCHEME;\n+\n+/**\n+ * A strategy for communicating with the targeted broker via Content Provider.\n+ */\n+public class ContentProviderStrategy implements IIpcStrategy {\n+\n+    private static final String TAG = ContentProviderStrategy.class.getName();\n+    private final Context mContext;\n+\n+    public ContentProviderStrategy(final Context context) {\n+        mContext = context;\n+    }\n+\n+    @Override\n+    @Nullable public Bundle communicateToBroker(@NonNull BrokerOperationBundle brokerOperationBundle)\n+            throws BaseException {\n+\n+        final String methodName = brokerOperationBundle.getOperation().name();\n+\n+        final Uri uri = getContentProviderURI(\n+                brokerOperationBundle.getTargetBrokerAppPackageName(),\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+        Logger.info(TAG + methodName, \"Request to BrokerContentProvider for uri path \" +\n+                brokerOperationBundle.getContentProviderPath()\n+        );\n+\n+        String marshalledRequestString = null;\n+\n+        final Bundle requestBundle = brokerOperationBundle.getBundle();\n+        if (requestBundle != null) {\n+            byte[] marshalledBytes = ParcelableUtil.marshall(requestBundle);\n+            marshalledRequestString = Base64.encodeToString(marshalledBytes, 0);\n+        }\n+\n+        final Cursor cursor = mContext.getContentResolver().query(\n+                uri,\n+                null,\n+                marshalledRequestString,\n+                null,\n+                null\n+        );\n+\n+        if (cursor != null) {\n+            final Bundle resultBundle = cursor.getExtras();\n+            cursor.close();\n+            Logger.info(TAG + methodName, \"Received successful result from Broker Content Provider.\");\n+            return resultBundle;\n+        } else {\n+            final String message = \"Failed to get result from Broker Content Provider, cursor is null\";\n+            Logger.error(TAG + methodName, message, null);\n+            throw new BrokerCommunicationException(message, null);\n+        }\n+    }\n+\n+    /**\n+     * Returns a content provider URI for the given path.\n+     */\n+    private Uri getContentProviderURI(@NonNull final String activeBrokerPackageName,\n+                                      @NonNull final String path) {\n+        final String authority = getContentProviderAuthority(activeBrokerPackageName);\n+        return Uri.parse(CONTENT_SCHEME + authority + path);\n+    }\n+\n+    /**\n+     * Returns content provider authority.\n+     */\n+    private String getContentProviderAuthority(@NonNull final String activeBrokerPackageName) {\n+        return activeBrokerPackageName + \".\" + AUTHORITY;\n+    }\n+\n+    /**\n+     * Returns true of the target package name supports this content provider strategy.", "originalCommit": "179eee0a98cc2a177cc25f9f3a575f0e036390a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2646c74f724f80a85b8c7d63b7552cd701c62be4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2646c74f724f80a85b8c7d63b7552cd701c62be4", "message": "[Part 2] Refactor Content Provider strategy", "committedDate": "2020-10-24T01:40:30Z", "type": "commit"}, {"oid": "2646c74f724f80a85b8c7d63b7552cd701c62be4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2646c74f724f80a85b8c7d63b7552cd701c62be4", "message": "[Part 2] Refactor Content Provider strategy", "committedDate": "2020-10-24T01:40:30Z", "type": "forcePushed"}]}