{"pr_number": 326, "pr_title": "[Code health] Tidy up fluent Firestore base classes", "pr_createdAt": "2020-01-17T17:12:27Z", "pr_url": "https://github.com/google/ground-android/pull/326", "timeline": [{"oid": "b54d6187c8527b0470c19f38618c1277ed28ab26", "url": "https://github.com/google/ground-android/commit/b54d6187c8527b0470c19f38618c1277ed28ab26", "message": "Move fluent Firestore classes into their own package", "committedDate": "2020-01-17T17:14:12Z", "type": "commit"}, {"oid": "19bfbc8faa367ecb39e250ba7395d21b474ea816", "url": "https://github.com/google/ground-android/commit/19bfbc8faa367ecb39e250ba7395d21b474ea816", "message": "Move fluent Firestore classes to lop level", "committedDate": "2020-01-17T17:14:15Z", "type": "commit"}, {"oid": "e0336e2f7e7d20e1688a14de5c2e59815e1f99e1", "url": "https://github.com/google/ground-android/commit/e0336e2f7e7d20e1688a14de5c2e59815e1f99e1", "message": "Refactore requireActiveNetwork", "committedDate": "2020-01-17T17:14:18Z", "type": "commit"}, {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "url": "https://github.com/google/ground-android/commit/cb4b8625d72969cc63b3ab793df31aa35ef8985e", "message": "All fluent base classes are abstract; remove prefix", "committedDate": "2020-01-17T17:14:20Z", "type": "commit"}, {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "url": "https://github.com/google/ground-android/commit/cb4b8625d72969cc63b3ab793df31aa35ef8985e", "message": "All fluent base classes are abstract; remove prefix", "committedDate": "2020-01-17T17:14:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODI3MA==", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208270", "bodyText": "Why are we providing the context here as a parameter when there's already a method isNetworkAvailable() for the same purpose?", "author": "shobhitagarwal1612", "createdAt": "2020-01-18T05:43:54Z", "path": "gnd/src/main/java/com/google/android/gnd/system/NetworkManager.java", "diffHunk": "@@ -41,6 +44,14 @@ public static boolean isNetworkAvailable(Context context) {\n     return networkInfo != null && networkInfo.isConnected();\n   }\n \n+  /**\n+   * Returns a Completable that completes immediately on subscribe if network is available, or fails\n+   * in error if not.\n+   */\n+  public static Completable requireActiveNetwork(Context context) {", "originalCommit": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2NjQwMw==", "url": "https://github.com/google/ground-android/pull/326#discussion_r371566403", "bodyText": "It's needed because it's used by FluentCollectionReference, which isn't injectable (currently instantiated on demand). Instead, it gets the context from the Firebase API. We could create a Provider with Dagger but that might be overkill for now.", "author": "gino-m", "createdAt": "2020-01-28T01:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODMwOA==", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208308", "bodyText": "2020", "author": "shobhitagarwal1612", "createdAt": "2020-01-18T05:44:55Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/fluent/FluentFirestore.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2018 Google LLC", "originalCommit": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODQxNg==", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208416", "bodyText": "Can we instead call this method reference()?", "author": "shobhitagarwal1612", "createdAt": "2020-01-18T05:47:17Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/fluent/FluentDocumentReference.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.fluent;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.firebase.firestore.DocumentReference;\n+import com.google.firebase.firestore.SetOptions;\n+import com.google.firebase.firestore.WriteBatch;\n+\n+public class FluentDocumentReference {\n+  protected final DocumentReference ref;\n+\n+  protected FluentDocumentReference(DocumentReference ref) {\n+    this.ref = ref;\n+  }\n+\n+  /**\n+   * Adds a request to the specified batch to merge the provided key-value pairs into the remote\n+   * database. If the document does not yet exist, one is created on commit.\n+   */\n+  public void merge(ImmutableMap<String, Object> values, WriteBatch batch) {\n+    batch.set(ref, values, SetOptions.merge());\n+  }\n+\n+  public DocumentReference ref() {", "originalCommit": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2NjQzOA==", "url": "https://github.com/google/ground-android/pull/326#discussion_r371566438", "bodyText": "Done.", "author": "gino-m", "createdAt": "2020-01-28T01:06:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODQ3Ng==", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208476", "bodyText": "Can we call this method reference() instead?", "author": "shobhitagarwal1612", "createdAt": "2020-01-18T05:48:52Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/fluent/FluentCollectionReference.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.fluent;\n+\n+import com.google.android.gnd.system.NetworkManager;\n+import com.google.firebase.firestore.CollectionReference;\n+import com.google.firebase.firestore.DocumentSnapshot;\n+import com.google.firebase.firestore.Query;\n+import durdinapps.rxfirebase2.RxFirestore;\n+import io.reactivex.Completable;\n+import io.reactivex.Single;\n+import java.util.List;\n+import java8.util.function.Function;\n+\n+public abstract class FluentCollectionReference {\n+  protected final CollectionReference ref;\n+\n+  protected FluentCollectionReference(CollectionReference ref) {\n+    this.ref = ref;\n+  }\n+\n+  /**\n+   * Returns a Completable that completes immediately on subscribe if network is available, or fails\n+   * in error if not.\n+   */\n+  private Completable requireActiveNetwork() {\n+    return NetworkManager.requireActiveNetwork(ref.getFirestore().getApp().getApplicationContext());\n+  }\n+\n+  /**\n+   * Runs the specified query, returning a Single containing a List of values created by applying\n+   * the mappingFunction to all results. Fails immediately with an error if an active network is not\n+   * available.\n+   */\n+  protected <T> Single<List<T>> runQuery(\n+      Query query, Function<DocumentSnapshot, T> mappingFunction) {\n+    return requireActiveNetwork()\n+        .andThen(FluentFirestore.toSingleList(RxFirestore.getCollection(query), mappingFunction));\n+  }\n+\n+  public CollectionReference ref() {", "originalCommit": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2NjQ2OQ==", "url": "https://github.com/google/ground-android/pull/326#discussion_r371566469", "bodyText": "Done.", "author": "gino-m", "createdAt": "2020-01-28T01:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODQ3Ng=="}], "type": "inlineReview"}, {"oid": "6b7ccf6715a809a99460e0788570bd2ed3455982", "url": "https://github.com/google/ground-android/commit/6b7ccf6715a809a99460e0788570bd2ed3455982", "message": "Merge branch 'master' into fluent-fs-refactor", "committedDate": "2020-01-27T17:55:27Z", "type": "commit"}, {"oid": "4c038626db8a64127e77cb9292ee6bbe39a60cb3", "url": "https://github.com/google/ground-android/commit/4c038626db8a64127e77cb9292ee6bbe39a60cb3", "message": "Merge branch 'master' into fluent-fs-refactor", "committedDate": "2020-01-27T22:10:24Z", "type": "commit"}, {"oid": "458347df751d3cd6db3b5508ba664f77cb99ecd6", "url": "https://github.com/google/ground-android/commit/458347df751d3cd6db3b5508ba664f77cb99ecd6", "message": "Rename collection ref accessor", "committedDate": "2020-01-28T00:56:08Z", "type": "commit"}, {"oid": "1648efa15a061ba980df04f8f11bbad4c14faace", "url": "https://github.com/google/ground-android/commit/1648efa15a061ba980df04f8f11bbad4c14faace", "message": "Rename document ref accessor", "committedDate": "2020-01-28T00:57:22Z", "type": "commit"}, {"oid": "9d72d592504ccb20bdfd2508868b050159a42656", "url": "https://github.com/google/ground-android/commit/9d72d592504ccb20bdfd2508868b050159a42656", "message": "Rename ref field", "committedDate": "2020-01-28T00:58:07Z", "type": "commit"}, {"oid": "26e56e8c25026a224eaeff73b4d17b1426b6f688", "url": "https://github.com/google/ground-android/commit/26e56e8c25026a224eaeff73b4d17b1426b6f688", "message": "Rename ref field", "committedDate": "2020-01-28T00:58:32Z", "type": "commit"}, {"oid": "39bf958b41e12993d6597965eb1de33ea341ad6a", "url": "https://github.com/google/ground-android/commit/39bf958b41e12993d6597965eb1de33ea341ad6a", "message": "Access ref via accessor", "committedDate": "2020-01-28T01:01:40Z", "type": "commit"}, {"oid": "648f74f5a44dc81475fbe4055a3feb14450376b1", "url": "https://github.com/google/ground-android/commit/648f74f5a44dc81475fbe4055a3feb14450376b1", "message": "Fix copyright year", "committedDate": "2020-01-28T01:02:56Z", "type": "commit"}, {"oid": "8e03605a1cb2b8b2844efe17a5cdb3fafd7a3ec1", "url": "https://github.com/google/ground-android/commit/8e03605a1cb2b8b2844efe17a5cdb3fafd7a3ec1", "message": "Make isNetworkAvailable private", "committedDate": "2020-01-28T01:05:07Z", "type": "commit"}, {"oid": "8f52c195f295ee8dbec9ee877d4faf6d03a24725", "url": "https://github.com/google/ground-android/commit/8f52c195f295ee8dbec9ee877d4faf6d03a24725", "message": "Access Firestore instance via accessor", "committedDate": "2020-01-28T01:10:23Z", "type": "commit"}, {"oid": "a24c910e7131652c505f643d1758bac3746677c8", "url": "https://github.com/google/ground-android/commit/a24c910e7131652c505f643d1758bac3746677c8", "message": "Rename 'fluent' package to 'base'", "committedDate": "2020-01-28T01:12:44Z", "type": "commit"}]}