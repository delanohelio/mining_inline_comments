{"pr_number": 414, "pr_title": "[Notifications] Show notifications when uploading photos", "pr_createdAt": "2020-03-26T14:27:10Z", "pr_url": "https://github.com/google/ground-android/pull/414", "timeline": [{"oid": "fcb5e98049f2abbe8af85491ed47571ef04ef476", "url": "https://github.com/google/ground-android/commit/fcb5e98049f2abbe8af85491ed47571ef04ef476", "message": "Add NotificationManager class\n\n - Test implementation by creating dummy progress notifications", "committedDate": "2020-03-26T10:00:17Z", "type": "commit"}, {"oid": "c93146b950732ddc461d767efbbd433b7e41f909", "url": "https://github.com/google/ground-android/commit/c93146b950732ddc461d767efbbd433b7e41f909", "message": "Add notifications for photo sync operation", "committedDate": "2020-03-26T13:38:26Z", "type": "commit"}, {"oid": "6cdf1b5d4b74dce9b9c90ecd2aeda26f923d1eac", "url": "https://github.com/google/ground-android/commit/6cdf1b5d4b74dce9b9c90ecd2aeda26f923d1eac", "message": "Store upload progress in data model and pass them forward", "committedDate": "2020-03-26T13:53:10Z", "type": "commit"}, {"oid": "ec4661286f53929d332a96648fe36b67c8f5a14d", "url": "https://github.com/google/ground-android/commit/ec4661286f53929d332a96648fe36b67c8f5a14d", "message": "Create model class for storing upload progress info", "committedDate": "2020-03-26T14:13:34Z", "type": "commit"}, {"oid": "c729e740ac18a7b6a1a6743175d34320f0df7247", "url": "https://github.com/google/ground-android/commit/c729e740ac18a7b6a1a6743175d34320f0df7247", "message": "Return flowable from RemoteStorageManager", "committedDate": "2020-03-26T14:15:35Z", "type": "commit"}, {"oid": "0b96ac20b53a710f2351aae7d188ab9b1fd95699", "url": "https://github.com/google/ground-android/commit/0b96ac20b53a710f2351aae7d188ab9b1fd95699", "message": "Send notifications from worker", "committedDate": "2020-03-26T14:15:55Z", "type": "commit"}, {"oid": "c051dca6ee20f9cb70d3f79e65ae89082244722d", "url": "https://github.com/google/ground-android/commit/c051dca6ee20f9cb70d3f79e65ae89082244722d", "message": "Add licenses", "committedDate": "2020-03-26T14:17:08Z", "type": "commit"}, {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f", "url": "https://github.com/google/ground-android/commit/2db0b8a15ec0810679c023dbd656c9783221633f", "message": "Rename variable", "committedDate": "2020-03-26T14:22:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NTU0OQ==", "url": "https://github.com/google/ground-android/pull/414#discussion_r398655549", "bodyText": "Why wrapping with Event? It's used as a \"Wrapper for events passed through streams that should be handled at most once.\". It's primarily used to prevent UIs from showing the same message more than ones. In this case, it seems you'd want to just stream the UploadProgress with Backpressure.LATEST.", "author": "gino-m", "createdAt": "2020-03-26T15:18:00Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/RemoteStorageManager.java", "diffHunk": "@@ -31,5 +32,5 @@\n   Task<Uri> getDownloadUrl(String remoteDestinationPath);\n \n   /** Uploads file to a remote path. */\n-  Completable uploadMediaFromFile(File file, String remoteDestinationPath);\n+  Flowable<Event<UploadProgress>> uploadMediaFromFile(File file, String remoteDestinationPath);", "originalCommit": "2db0b8a15ec0810679c023dbd656c9783221633f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NzAwMA==", "url": "https://github.com/google/ground-android/pull/414#discussion_r398657000", "bodyText": "Instead of calling new directly, consider adding \"static constructor\" methods like UploadProgress.paused() and UploadProgress.inProgress(byteCount, bytesTransferred).", "author": "gino-m", "createdAt": "2020-03-26T15:19:48Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "diffHunk": "@@ -65,27 +68,35 @@ private StorageReference createReference(String path) {\n     return createReference(remoteDestinationPath).getDownloadUrl();\n   }\n \n-  /** Upload file to Firebase Storage. */\n   @Override\n-  public Completable uploadMediaFromFile(File file, String remoteDestinationPath) {\n-    return Completable.create(\n+  public Flowable<Event<UploadProgress>> uploadMediaFromFile(\n+      File file, String remoteDestinationPath) {\n+    return Flowable.create(\n         emitter ->\n             createReference(remoteDestinationPath)\n                 .putFile(Uri.fromFile(file))\n                 .addOnCompleteListener(uploadTask -> emitter.onComplete())\n-                .addOnFailureListener(emitter::onError)\n+                .addOnPausedListener(\n+                    taskSnapshot -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.PAUSED)));", "originalCommit": "2db0b8a15ec0810679c023dbd656c9783221633f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NzQ0OQ==", "url": "https://github.com/google/ground-android/pull/414#discussion_r398657449", "bodyText": "Only use buffer if it's important that downstream subscribers catch every single value. In this case, only the latest value is relevant, so we'd use LATEST.", "author": "gino-m", "createdAt": "2020-03-26T15:20:22Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "diffHunk": "@@ -65,27 +68,35 @@ private StorageReference createReference(String path) {\n     return createReference(remoteDestinationPath).getDownloadUrl();\n   }\n \n-  /** Upload file to Firebase Storage. */\n   @Override\n-  public Completable uploadMediaFromFile(File file, String remoteDestinationPath) {\n-    return Completable.create(\n+  public Flowable<Event<UploadProgress>> uploadMediaFromFile(\n+      File file, String remoteDestinationPath) {\n+    return Flowable.create(\n         emitter ->\n             createReference(remoteDestinationPath)\n                 .putFile(Uri.fromFile(file))\n                 .addOnCompleteListener(uploadTask -> emitter.onComplete())\n-                .addOnFailureListener(emitter::onError)\n+                .addOnPausedListener(\n+                    taskSnapshot -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.PAUSED)));\n+                    })\n+                .addOnFailureListener(\n+                    throwable -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.FAILED)));\n+                      emitter.onError(throwable);\n+                    })\n                 .addOnSuccessListener(\n                     taskSnapshot -> {\n-                      // TODO: taskSnapshot contains metadata that can be displayed after uploading\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.COMPLETED)));\n                     })\n                 .addOnProgressListener(\n-                    taskSnapshot -> {\n-                      // TODO: Display upload status in app or notification\n-                      double completed =\n-                          100.0\n-                              * taskSnapshot.getBytesTransferred()\n-                              / taskSnapshot.getTotalByteCount();\n-                      Timber.d(\"Uploading in progress: %s %f\", remoteDestinationPath, completed);\n-                    }));\n+                    taskSnapshot ->\n+                        emitter.onNext(\n+                            Event.create(\n+                                new UploadProgress(\n+                                    UploadState.IN_PROGRESS,\n+                                    (int) taskSnapshot.getTotalByteCount(),\n+                                    (int) taskSnapshot.getBytesTransferred())))),\n+        BackpressureStrategy.BUFFER);", "originalCommit": "2db0b8a15ec0810679c023dbd656c9783221633f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA==", "url": "https://github.com/google/ground-android/pull/414#discussion_r398658470", "bodyText": "Are we showing a notification for each photo being uploaded? Ideally we'd have a single status bar for sync progress.", "author": "gino-m", "createdAt": "2020-03-26T15:21:37Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -66,7 +72,8 @@ public Result doWork() {\n       try {\n         remoteStorageManager\n             .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n-            .blockingAwait();\n+            .blockingForEach(", "originalCommit": "2db0b8a15ec0810679c023dbd656c9783221633f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MzEwMg==", "url": "https://github.com/google/ground-android/pull/414#discussion_r398683102", "bodyText": "For now, yes. I plan to add notifications to all workers, then move on to refactor PhotoSyncWorker (merge with DataSyncWorker and store mutations in db)", "author": "shobhitagarwal1612", "createdAt": "2020-03-26T15:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3NTc4Ng==", "url": "https://github.com/google/ground-android/pull/414#discussion_r399375786", "bodyText": "I may be wrong, but isn't this fundamentally different than showing a single always-on service UI notification? Won't we be doing a lot of work that will then need to be deleted?", "author": "gino-m", "createdAt": "2020-03-27T16:08:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0MzU0OA==", "url": "https://github.com/google/ground-android/pull/414#discussion_r399443548", "bodyText": "Nope, it's just a matter of changing boolean values to keep it sticky and then reuse the same notification for displaying updates. My idea was to have many eyes look at the code without making too many changes at once. But if you think it's better to do all at once, I can give it a try.", "author": "shobhitagarwal1612", "createdAt": "2020-03-27T17:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg0ODk1Mw==", "url": "https://github.com/google/ground-android/pull/414#discussion_r399848953", "bodyText": "If it's an incremental change then SGTM!", "author": "gino-m", "createdAt": "2020-03-29T20:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}], "type": "inlineReview"}, {"oid": "ac6cb651492d3c39f61e61990c770b8041b0d2bd", "url": "https://github.com/google/ground-android/commit/ac6cb651492d3c39f61e61990c770b8041b0d2bd", "message": "Merge branch 'master' into notifications", "committedDate": "2020-03-26T15:40:39Z", "type": "commit"}, {"oid": "5ac228d24b8cbf03f7850ed266b28f0e12c7d6ab", "url": "https://github.com/google/ground-android/commit/5ac228d24b8cbf03f7850ed266b28f0e12c7d6ab", "message": "Add static methods and cleanup", "committedDate": "2020-03-26T15:49:32Z", "type": "commit"}, {"oid": "f1900b85edb1f55740852a794619a31ef3ff9877", "url": "https://github.com/google/ground-android/commit/f1900b85edb1f55740852a794619a31ef3ff9877", "message": "Use LATEST back-pressure strategy", "committedDate": "2020-03-26T15:50:04Z", "type": "commit"}, {"oid": "0c04b21f24fc4fb3382fad1971a51308e4597bc6", "url": "https://github.com/google/ground-android/commit/0c04b21f24fc4fb3382fad1971a51308e4597bc6", "message": "Unwrap progress events", "committedDate": "2020-03-26T15:54:20Z", "type": "commit"}, {"oid": "a5affdb54e39f8687c50897ba451c4243ca180cd", "url": "https://github.com/google/ground-android/commit/a5affdb54e39f8687c50897ba451c4243ca180cd", "message": "Improve variable names", "committedDate": "2020-03-26T16:03:00Z", "type": "commit"}, {"oid": "13296b8174731634c66924d821cec16f4e69decd", "url": "https://github.com/google/ground-android/commit/13296b8174731634c66924d821cec16f4e69decd", "message": "typo", "committedDate": "2020-03-26T16:03:29Z", "type": "commit"}, {"oid": "c2bdf3ccb9526db0b5ad89178f78d6aacd366e73", "url": "https://github.com/google/ground-android/commit/c2bdf3ccb9526db0b5ad89178f78d6aacd366e73", "message": "Merge branch 'master' into notifications", "committedDate": "2020-03-28T09:25:43Z", "type": "commit"}]}