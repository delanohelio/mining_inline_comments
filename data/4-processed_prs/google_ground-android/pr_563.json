{"pr_number": 563, "pr_title": "[Photos] Refactor uploading photos to remote storage ", "pr_createdAt": "2020-08-13T09:37:28Z", "pr_url": "https://github.com/google/ground-android/pull/563", "timeline": [{"oid": "70bc7b5e242eeb89b2677f985b6ee03698c8c089", "url": "https://github.com/google/ground-android/commit/70bc7b5e242eeb89b2677f985b6ee03698c8c089", "message": "Save original response and field type in ResponseDelta object", "committedDate": "2020-08-13T08:33:28Z", "type": "commit"}, {"oid": "b99db9adeb039d1d531d311462331b0953721c80", "url": "https://github.com/google/ground-android/commit/b99db9adeb039d1d531d311462331b0953721c80", "message": "Add data to fieldType and originalResponse while creating mutation", "committedDate": "2020-08-13T08:34:38Z", "type": "commit"}, {"oid": "dbe62da7de9cfcc5d3d70b53c608f49d6913698f", "url": "https://github.com/google/ground-android/commit/dbe62da7de9cfcc5d3d70b53c608f49d6913698f", "message": "Configure ResponseDeltasTypeConverter to save the new info to db", "committedDate": "2020-08-13T08:35:22Z", "type": "commit"}, {"oid": "fa0e8f009c52121d5a588f3b3e36406843177340", "url": "https://github.com/google/ground-android/commit/fa0e8f009c52121d5a588f3b3e36406843177340", "message": "Replace log with timber", "committedDate": "2020-08-13T08:37:18Z", "type": "commit"}, {"oid": "f8d0ccb57719b325a240b96fbc622d0f840b053f", "url": "https://github.com/google/ground-android/commit/f8d0ccb57719b325a240b96fbc622d0f840b053f", "message": "Add method to delete remote files in RemoteStorageManager", "committedDate": "2020-08-13T09:14:28Z", "type": "commit"}, {"oid": "fe471c86ac733078db7027224d2b3c046e693b34", "url": "https://github.com/google/ground-android/commit/fe471c86ac733078db7027224d2b3c046e693b34", "message": "Remove code for uploading photo from FirestoreDataStore", "committedDate": "2020-08-13T09:15:54Z", "type": "commit"}, {"oid": "d8a80959daafde6d143bafd28db1f79510d2cac9", "url": "https://github.com/google/ground-android/commit/d8a80959daafde6d143bafd28db1f79510d2cac9", "message": "Add delete method to StorageManager", "committedDate": "2020-08-13T09:16:35Z", "type": "commit"}, {"oid": "4e5e498fb4cddb3f5a2bd227905d5d08c4b2908c", "url": "https://github.com/google/ground-android/commit/4e5e498fb4cddb3f5a2bd227905d5d08c4b2908c", "message": "Process photo mutations in LocalMutationSyncWorker\n\n - Do this after successful sync of mutations to remote db\n - Find all deltas for photo type mutations\n - Remove old response and enqueue new ones for uploading", "committedDate": "2020-08-13T09:23:18Z", "type": "commit"}, {"oid": "7c10ca4267c9e7e8f7c03270e654a033bdbc3a93", "url": "https://github.com/google/ground-android/commit/7c10ca4267c9e7e8f7c03270e654a033bdbc3a93", "message": "Fix unit tests\n\n - add dummy values to required fields", "committedDate": "2020-08-13T10:15:03Z", "type": "commit"}, {"oid": "0356487c14ca377b1e094a7e577aba9453bbc002", "url": "https://github.com/google/ground-android/commit/0356487c14ca377b1e094a7e577aba9453bbc002", "message": "Fix missing required fields", "committedDate": "2020-08-13T10:26:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2MzE3OQ==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470163179", "bodyText": "Consider Completable.fromRunnable(() -> ) instead.", "author": "gino-m", "createdAt": "2020-08-13T18:32:53Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +127,54 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields. Delete old\n+   * photo from remote storage and enqueue new photo for upload.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(\n+            mutation ->\n+                Observable.fromIterable(mutation.getResponseDeltas())\n+                    .filter(delta -> delta.getFieldType() == Type.PHOTO)\n+                    .flatMapCompletable(\n+                        delta ->\n+                            enqueuePhotoUpload(delta.getNewResponse())\n+                                .andThen(deleteRemotePhoto(delta.getOriginalResponse()))));\n+  }\n+\n+  /** Enqueue photo for uploading to remote storage. */\n+  private Completable enqueuePhotoUpload(Optional<Response> response) {\n+    return Completable.create(", "originalCommit": "0356487c14ca377b1e094a7e577aba9453bbc002", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ2NTA5OA==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470465098", "bodyText": "Done", "author": "shobhitagarwal1612", "createdAt": "2020-08-14T07:47:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2MzE3OQ=="}], "type": "inlineReview"}, {"oid": "cdd23da09bf16496b8ab278653dfa90952308b55", "url": "https://github.com/google/ground-android/commit/cdd23da09bf16496b8ab278653dfa90952308b55", "message": "Do not remove remote files from client\n\nIt will be handled by the server\nhttps://github.com/google/ground-android/pull/563#issuecomment-673512226", "committedDate": "2020-08-14T07:31:43Z", "type": "commit"}, {"oid": "1b99b557891d56865ff69f707db724cd82682fe1", "url": "https://github.com/google/ground-android/commit/1b99b557891d56865ff69f707db724cd82682fe1", "message": "Remove original response from ResponseDelta", "committedDate": "2020-08-14T07:37:25Z", "type": "commit"}, {"oid": "f400433e24e0d6006fb4ed9a74012aa4fd47b089", "url": "https://github.com/google/ground-android/commit/f400433e24e0d6006fb4ed9a74012aa4fd47b089", "message": "Replace `create()` with `fromRunnable()`", "committedDate": "2020-08-14T07:47:17Z", "type": "commit"}, {"oid": "04cb4bb31ded12f67f5d5f7d6e157f09aadc84c0", "url": "https://github.com/google/ground-android/commit/04cb4bb31ded12f67f5d5f7d6e157f09aadc84c0", "message": "Remove remaining usage of originalResponse", "committedDate": "2020-08-14T07:53:46Z", "type": "commit"}, {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a", "url": "https://github.com/google/ground-android/commit/bff16b4585c46b432ca14b45cfc6601efe9df84a", "message": "Cleanup", "committedDate": "2020-08-14T09:20:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2Njk1MQ==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470666951", "bodyText": "Can we use short camel-cased keys without spaces here to make them more idiomatic JSON? e.g. \"fieldType\" and \"newResponse\"?", "author": "gino-m", "createdAt": "2020-08-14T14:43:04Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/converter/ResponseDeltasTypeConverter.java", "diffHunk": "@@ -32,18 +35,25 @@\n  */\n public class ResponseDeltasTypeConverter {\n \n+  private static final String KEY_FIELD_TYPE = \"field type\";\n+  private static final String KEY_NEW_RESPONSE = \"new response\";", "originalCommit": "bff16b4585c46b432ca14b45cfc6601efe9df84a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzUzNw==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470687537", "bodyText": "Yes, thanks!", "author": "shobhitagarwal1612", "createdAt": "2020-08-14T15:15:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2Njk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2OTM0Ng==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470669346", "bodyText": "Nit: Filter -> Filters", "author": "gino-m", "createdAt": "2020-08-14T14:45:05Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */", "originalCommit": "bff16b4585c46b432ca14b45cfc6601efe9df84a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzQ0MA==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470687440", "bodyText": "Done", "author": "shobhitagarwal1612", "createdAt": "2020-08-14T15:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2OTM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MDg5NQ==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470670895", "bodyText": "isPresent() returns a boolean; wouldn't the next line cause remotePath to be \"true\" or \"false\"?", "author": "gino-m", "createdAt": "2020-08-14T14:46:46Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(\n+            mutation ->\n+                Observable.fromIterable(mutation.getResponseDeltas())\n+                    .filter(delta -> delta.getFieldType() == Type.PHOTO)\n+                    .map(ResponseDelta::getNewResponse)\n+                    .map(Optional::isPresent)", "originalCommit": "bff16b4585c46b432ca14b45cfc6601efe9df84a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzcyNg==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470687726", "bodyText": "Fixed and tested", "author": "shobhitagarwal1612", "createdAt": "2020-08-14T15:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MDg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MjgyOQ==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470672829", "bodyText": "I think this can be simplified, but not sure of the exact syntax.", "author": "gino-m", "createdAt": "2020-08-14T14:50:03Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(\n+            mutation ->\n+                Observable.fromIterable(mutation.getResponseDeltas())\n+                    .filter(delta -> delta.getFieldType() == Type.PHOTO)\n+                    .map(ResponseDelta::getNewResponse)\n+                    .map(Optional::isPresent)\n+                    .map(Object::toString)\n+                    .flatMapCompletable(", "originalCommit": "bff16b4585c46b432ca14b45cfc6601efe9df84a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4Nzg2Nw==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470687867", "bodyText": "Done a478804", "author": "shobhitagarwal1612", "createdAt": "2020-08-14T15:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MjgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3Mjk2Mg==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470672962", "bodyText": "Does flatMapIterable() help here?", "author": "gino-m", "createdAt": "2020-08-14T14:50:16Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(", "originalCommit": "bff16b4585c46b432ca14b45cfc6601efe9df84a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzkzNg==", "url": "https://github.com/google/ground-android/pull/563#discussion_r470687936", "bodyText": "Yes it does a478804", "author": "shobhitagarwal1612", "createdAt": "2020-08-14T15:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3Mjk2Mg=="}], "type": "inlineReview"}, {"oid": "a478804e6c7aaba41a095d8cc19b26ab0d918d7f", "url": "https://github.com/google/ground-android/commit/a478804e6c7aaba41a095d8cc19b26ab0d918d7f", "message": "Simplify RxChain", "committedDate": "2020-08-14T15:10:14Z", "type": "commit"}, {"oid": "1688cdc6af466bccc997582dcbbcdd9cab1ca51b", "url": "https://github.com/google/ground-android/commit/1688cdc6af466bccc997582dcbbcdd9cab1ca51b", "message": "Use camel-cased keys for consistency", "committedDate": "2020-08-14T15:10:44Z", "type": "commit"}]}