{"pr_number": 404, "pr_title": "[Photos] Sync photos to FirebaseStorage using Workers", "pr_createdAt": "2020-03-19T20:32:27Z", "pr_url": "https://github.com/google/ground-android/pull/404", "timeline": [{"oid": "40fa02cdd05ed04c2f8e57be63261076d6f2921f", "url": "https://github.com/google/ground-android/commit/40fa02cdd05ed04c2f8e57be63261076d6f2921f", "message": "Replace log with Timber", "committedDate": "2020-03-19T16:21:57Z", "type": "commit"}, {"oid": "18d07a5502e7a44862870c679ad2b279eb733773", "url": "https://github.com/google/ground-android/commit/18d07a5502e7a44862870c679ad2b279eb733773", "message": "Minor nits", "committedDate": "2020-03-19T19:18:11Z", "type": "commit"}, {"oid": "b6299dc35f878f1dacb3da1d2a0654b8c951a2ef", "url": "https://github.com/google/ground-android/commit/b6299dc35f878f1dacb3da1d2a0654b8c951a2ef", "message": "Move remote path generator to FirestoreStorageManager", "committedDate": "2020-03-19T19:39:17Z", "type": "commit"}, {"oid": "5275c53c85cfc3016ddba7843101f26e1f032bed", "url": "https://github.com/google/ground-android/commit/5275c53c85cfc3016ddba7843101f26e1f032bed", "message": "Add worker for synchronizing photos", "committedDate": "2020-03-19T19:44:17Z", "type": "commit"}, {"oid": "8a27ebc64c9520a33a01063ea6cb9a5639c9aa61", "url": "https://github.com/google/ground-android/commit/8a27ebc64c9520a33a01063ea6cb9a5639c9aa61", "message": "Timber and lambdas nit", "committedDate": "2020-03-19T19:46:54Z", "type": "commit"}, {"oid": "be8d7219747d3ff36629452cf0b9ed65bb182ef2", "url": "https://github.com/google/ground-android/commit/be8d7219747d3ff36629452cf0b9ed65bb182ef2", "message": "Add comments and rename", "committedDate": "2020-03-19T19:52:38Z", "type": "commit"}, {"oid": "16c23acc5b8d25f599c3da3d279a5d29263e210f", "url": "https://github.com/google/ground-android/commit/16c23acc5b8d25f599c3da3d279a5d29263e210f", "message": "Add WorkManager for PhotoSyncWorker", "committedDate": "2020-03-19T20:01:46Z", "type": "commit"}, {"oid": "cd8dfdba0c3145e12b6be4de20e33f7a2a8697c5", "url": "https://github.com/google/ground-android/commit/cd8dfdba0c3145e12b6be4de20e33f7a2a8697c5", "message": "Wire EditObservation with sync worker", "committedDate": "2020-03-19T20:05:58Z", "type": "commit"}, {"oid": "10e4f184605f49f0beac061f8517bb353d169f04", "url": "https://github.com/google/ground-android/commit/10e4f184605f49f0beac061f8517bb353d169f04", "message": "Clean FirebaseStorageManager", "committedDate": "2020-03-19T20:18:45Z", "type": "commit"}, {"oid": "db0637213baaa8c0a77d4757101d98156e8ea0d1", "url": "https://github.com/google/ground-android/commit/db0637213baaa8c0a77d4757101d98156e8ea0d1", "message": "Attach sync RxChain to handlePhoto", "committedDate": "2020-03-19T20:24:19Z", "type": "commit"}, {"oid": "b4a020ad18db09e44f8f68a1fbd96e6f7ea3de4a", "url": "https://github.com/google/ground-android/commit/b4a020ad18db09e44f8f68a1fbd96e6f7ea3de4a", "message": "Fix indentation level", "committedDate": "2020-03-19T20:33:42Z", "type": "commit"}, {"oid": "c9b77f1064d14c60f25ddf9f10c29b10d49d921a", "url": "https://github.com/google/ground-android/commit/c9b77f1064d14c60f25ddf9f10c29b10d49d921a", "message": "Merge branch 'master' into sync-photos", "committedDate": "2020-03-19T20:37:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0NTg0OQ==", "url": "https://github.com/google/ground-android/pull/404#discussion_r395745849", "bodyText": "Sorry just noticing this now, but should this method return a Completable since it's async?", "author": "gino-m", "createdAt": "2020-03-20T16:18:14Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/FirestoreStorageManager.java", "diffHunk": "@@ -40,32 +40,31 @@\n     this.storageReference = storageReference;\n   }\n \n-  /** Returns a reference to the root media dir. */\n-  private StorageReference getRootMediaDir() {\n-    return storageReference.child(MEDIA_ROOT_DIR);\n-  }\n-\n   /**\n-   * Returns a reference to a object under the root media dir.\n+   * Generates destination path for saving the image to Firestore Storage.\n    *\n-   * @param fileName Name of the uploaded media\n+   * <p>/uploaded_media/{project_id}/{form_id}/{feature_id}/{filename.jpg}\n    */\n-  private StorageReference createReference(String fileName) {\n-    return getRootMediaDir().child(fileName);\n+  public static String getRemoteImagePath(\n+      String projectId, String formId, String featureId, String filename) {\n+    return new StringJoiner(File.separator)\n+        .add(MEDIA_ROOT_DIR)\n+        .add(projectId)\n+        .add(formId)\n+        .add(featureId)\n+        .add(filename)\n+        .toString();\n   }\n \n   public Task<Uri> getDownloadUrl(String path) {\n     return storageReference.child(path).getDownloadUrl();\n   }\n \n   /** Upload file to Firebase Storage. */\n-  public String uploadMediaFromFile(File file, String destinationPath) {\n-    StorageReference reference = createReference(destinationPath);\n+  public void uploadMediaFromFile(File file, String destinationPath) {", "originalCommit": "c9b77f1064d14c60f25ddf9f10c29b10d49d921a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0NzU4MA==", "url": "https://github.com/google/ground-android/pull/404#discussion_r395747580", "bodyText": "Fyi, files #408 to revisit allowing user to specific constraints for upload.", "author": "gino-m", "createdAt": "2020-03-20T16:20:59Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorkManager.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.sync;\n+\n+import androidx.work.Constraints;\n+import androidx.work.NetworkType;\n+import androidx.work.OneTimeWorkRequest;\n+import androidx.work.WorkManager;\n+import io.reactivex.Completable;\n+import javax.inject.Inject;\n+import javax.inject.Provider;\n+\n+/** Enqueues photo upload work to be done in the background. */\n+public class PhotoSyncWorkManager {\n+\n+  private static final Constraints CONSTRAINTS =\n+      new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build();", "originalCommit": "c9b77f1064d14c60f25ddf9f10c29b10d49d921a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0NzI3NQ==", "url": "https://github.com/google/ground-android/pull/404#discussion_r395847275", "bodyText": "Ack", "author": "shobhitagarwal1612", "createdAt": "2020-03-20T19:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0NzU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0Nzg1NA==", "url": "https://github.com/google/ground-android/pull/404#discussion_r395747854", "bodyText": "Nit: Change -> chance", "author": "gino-m", "createdAt": "2020-03-20T16:21:24Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorkManager.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.sync;\n+\n+import androidx.work.Constraints;\n+import androidx.work.NetworkType;\n+import androidx.work.OneTimeWorkRequest;\n+import androidx.work.WorkManager;\n+import io.reactivex.Completable;\n+import javax.inject.Inject;\n+import javax.inject.Provider;\n+\n+/** Enqueues photo upload work to be done in the background. */\n+public class PhotoSyncWorkManager {\n+\n+  private static final Constraints CONSTRAINTS =\n+      new Constraints.Builder().setRequiredNetworkType(NetworkType.CONNECTED).build();\n+\n+  /**\n+   * WorkManager is injected via {@code Provider} rather than directly to ensure the {@code\n+   * Application} has a change to initialize it before {@code WorkManager.getInstance()} is called.", "originalCommit": "c9b77f1064d14c60f25ddf9f10c29b10d49d921a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4MDI4NQ==", "url": "https://github.com/google/ground-android/pull/404#discussion_r395780285", "bodyText": "It would seem saving the bitmap to local storage is out of scope of the viewmodel's responsibilities. Ideally both this and the access to the worker would be managed by the storageManager. Could these be moved there, or a TODO added to do so?", "author": "gino-m", "createdAt": "2020-03-20T17:16:07Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -249,33 +249,18 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n   private Completable saveBitmapAndUpdateResponse(Bitmap bitmap, String fieldId)\n       throws IOException {\n     File file = fileUtil.saveBitmap(bitmap, fieldId + \".jpg\");\n-    String destinationPath = getRemoteImagePath(file.getName());\n-\n-    // If offline, Firebase will automatically upload the image when the network\n-    // connectivity is  re-established.\n-    // TODO: Implement offline photo sync using Android Workers and local db\n-    String url = firestoreStorageManager.uploadMediaFromFile(file, destinationPath);\n+    String destinationPath =", "originalCommit": "c9b77f1064d14c60f25ddf9f10c29b10d49d921a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f93e1329bb462278a4718f8bdbcd9f42df9b3677", "url": "https://github.com/google/ground-android/commit/f93e1329bb462278a4718f8bdbcd9f42df9b3677", "message": "Merge branch 'master' into sync-photos", "committedDate": "2020-03-20T17:52:44Z", "type": "commit"}, {"oid": "fceca487d57b5c325fd7b21d39bc535db0071a44", "url": "https://github.com/google/ground-android/commit/fceca487d57b5c325fd7b21d39bc535db0071a44", "message": "Return Completable from FirestoreStorageManager", "committedDate": "2020-03-20T18:52:48Z", "type": "commit"}, {"oid": "8b465b551cad449734ceaff45ddd9a26a7360061", "url": "https://github.com/google/ground-android/commit/8b465b551cad449734ceaff45ddd9a26a7360061", "message": "Define API for remote storage manager", "committedDate": "2020-03-20T19:06:44Z", "type": "commit"}, {"oid": "0c405465aa9fe6dc59a88c19cb2d7b147ee1b4ad", "url": "https://github.com/google/ground-android/commit/0c405465aa9fe6dc59a88c19cb2d7b147ee1b4ad", "message": "Make FirestoreStorageManager implementation of defined API", "committedDate": "2020-03-20T19:07:51Z", "type": "commit"}, {"oid": "9a55fad17f67b23055f992921741480672e5c4be", "url": "https://github.com/google/ground-android/commit/9a55fad17f67b23055f992921741480672e5c4be", "message": "Typo", "committedDate": "2020-03-20T19:09:25Z", "type": "commit"}, {"oid": "4da0626a04996da9ab013d3d45a234dd4be14ff3", "url": "https://github.com/google/ground-android/commit/4da0626a04996da9ab013d3d45a234dd4be14ff3", "message": "Cleanup\n\nMove file save / enqueue to StorageManager", "committedDate": "2020-03-20T19:22:34Z", "type": "commit"}, {"oid": "fc317dae6a6e5918508f8a4710c84e6f10ca9e11", "url": "https://github.com/google/ground-android/commit/fc317dae6a6e5918508f8a4710c84e6f10ca9e11", "message": "Last minute refactor", "committedDate": "2020-03-20T19:28:40Z", "type": "commit"}, {"oid": "cd4721cd807382958f580707d45d0639bc75a845", "url": "https://github.com/google/ground-android/commit/cd4721cd807382958f580707d45d0639bc75a845", "message": "Improve variable names", "committedDate": "2020-03-22T13:37:49Z", "type": "commit"}, {"oid": "27cb7d057167c741f33d03b8a48a21ef22cbd763", "url": "https://github.com/google/ground-android/commit/27cb7d057167c741f33d03b8a48a21ef22cbd763", "message": "Fix method name", "committedDate": "2020-03-22T13:38:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxOTQ5OQ==", "url": "https://github.com/google/ground-android/pull/404#discussion_r396719499", "bodyText": "In a future PR, it might make sense to fail against certain exceptions\u2014not sure precisely what exceptions that function can throw, but I imagine there may be some cases that are unrecoverable, in which case it doesn't make sense to continue retry work.", "author": "scolsen", "createdAt": "2020-03-23T19:55:43Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.sync;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.work.Data;\n+import androidx.work.Worker;\n+import androidx.work.WorkerParameters;\n+import com.google.android.gnd.persistence.remote.RemoteStorageManager;\n+import java.io.File;\n+import timber.log.Timber;\n+\n+/**\n+ * A worker that uploads photos from observations to the FirestoreStorage in the background. The\n+ * source file and remote destination path are provided in a {@link Data} object. This worker should\n+ * only run when the device has a network connection.\n+ */\n+public class PhotoSyncWorker extends Worker {\n+\n+  private static final String SOURCE_FILE_PATH_PARAM_KEY = \"sourceFilePath\";\n+  private static final String DESTINATION_PATH_PARAM_KEY = \"destinationPath\";\n+\n+  private final RemoteStorageManager remoteStorageManager;\n+  private final String localSourcePath;\n+  private final String remoteDestinationPath;\n+\n+  public PhotoSyncWorker(\n+      @NonNull Context context,\n+      @NonNull WorkerParameters workerParams,\n+      RemoteStorageManager remoteStorageManager) {\n+    super(context, workerParams);\n+    this.remoteStorageManager = remoteStorageManager;\n+    this.localSourcePath = workerParams.getInputData().getString(SOURCE_FILE_PATH_PARAM_KEY);\n+    this.remoteDestinationPath = workerParams.getInputData().getString(DESTINATION_PATH_PARAM_KEY);\n+  }\n+\n+  public static Data createInputData(String sourceFilePath, String destinationPath) {\n+    return new Data.Builder()\n+        .putString(SOURCE_FILE_PATH_PARAM_KEY, sourceFilePath)\n+        .putString(DESTINATION_PATH_PARAM_KEY, destinationPath)\n+        .build();\n+  }\n+\n+  @NonNull\n+  @Override\n+  public Result doWork() {\n+    Timber.d(\"Attempting photo sync: %s, %s\", localSourcePath, remoteDestinationPath);\n+    File file = new File(localSourcePath);\n+    if (file.exists()) {\n+      Timber.d(\"Starting photo upload: %s, %s\", localSourcePath, remoteDestinationPath);\n+      try {\n+        remoteStorageManager\n+            .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n+            .blockingAwait();\n+        return Result.success();\n+      } catch (Exception e) {", "originalCommit": "27cb7d057167c741f33d03b8a48a21ef22cbd763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0MTQyNg==", "url": "https://github.com/google/ground-android/pull/404#discussion_r396741426", "bodyText": "Makes sense! Let's open a new bug to keep a track of this", "author": "shobhitagarwal1612", "createdAt": "2020-03-23T20:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxOTQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyMDcxNQ==", "url": "https://github.com/google/ground-android/pull/404#discussion_r396720715", "bodyText": "Should we make this file extension a constant in the Config? Photo EXT or something like that?", "author": "scolsen", "createdAt": "2020-03-23T19:57:54Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -248,34 +239,18 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n \n   private Completable saveBitmapAndUpdateResponse(Bitmap bitmap, String fieldId)\n       throws IOException {\n-    File file = fileUtil.saveBitmap(bitmap, fieldId + \".jpg\");\n-    String destinationPath = getRemoteImagePath(file.getName());\n-\n-    // If offline, Firebase will automatically upload the image when the network\n-    // connectivity is  re-established.\n-    // TODO: Implement offline photo sync using Android Workers and local db\n-    String url = firestoreStorageManager.uploadMediaFromFile(file, destinationPath);\n+    String localFileName = fieldId + \".jpg\";", "originalCommit": "27cb7d057167c741f33d03b8a48a21ef22cbd763", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc0MjU4OQ==", "url": "https://github.com/google/ground-android/pull/404#discussion_r396742589", "bodyText": "Done", "author": "shobhitagarwal1612", "createdAt": "2020-03-23T20:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyMDcxNQ=="}], "type": "inlineReview"}, {"oid": "1f892707eabaa66bea83858950c4c6314de6ff43", "url": "https://github.com/google/ground-android/commit/1f892707eabaa66bea83858950c4c6314de6ff43", "message": "Define photo extension in Config", "committedDate": "2020-03-23T20:39:43Z", "type": "commit"}]}