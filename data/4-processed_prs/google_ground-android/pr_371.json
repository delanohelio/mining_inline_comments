{"pr_number": 371, "pr_title": "[Remote sync] Refactor remote persistence layer", "pr_createdAt": "2020-02-16T16:54:26Z", "pr_url": "https://github.com/google/ground-android/pull/371", "timeline": [{"oid": "edd1982ae6f9e5a4d78b5859fd07fabb4a19e7bc", "url": "https://github.com/google/ground-android/commit/edd1982ae6f9e5a4d78b5859fd07fabb4a19e7bc", "message": "Increase max perm size", "committedDate": "2020-02-11T04:29:39Z", "type": "commit"}, {"oid": "15ffc620272cdd614efb0ade24f7c40f80f029ad", "url": "https://github.com/google/ground-android/commit/15ffc620272cdd614efb0ade24f7c40f80f029ad", "message": "Refactor remote persistency layer for Features", "committedDate": "2020-02-11T04:34:57Z", "type": "commit"}, {"oid": "1aa7f3abb3a11ea067280a7c8cdac9899e8c4d7c", "url": "https://github.com/google/ground-android/commit/1aa7f3abb3a11ea067280a7c8cdac9899e8c4d7c", "message": "Merge branch 'disable-data-class-pmd' into harden-firestore-objects", "committedDate": "2020-02-11T04:36:46Z", "type": "commit"}, {"oid": "982ac036c98eca03bf9cb275d83525b7db924c1f", "url": "https://github.com/google/ground-android/commit/982ac036c98eca03bf9cb275d83525b7db924c1f", "message": "Merge branch 'master' into harden-firestore-objects", "committedDate": "2020-02-12T02:11:26Z", "type": "commit"}, {"oid": "2555c9a6775f6b82d1cb907c170320abe8f0e379", "url": "https://github.com/google/ground-android/commit/2555c9a6775f6b82d1cb907c170320abe8f0e379", "message": "Add missing newline", "committedDate": "2020-02-12T02:11:43Z", "type": "commit"}, {"oid": "aa059f3062dfe0c8a1b155fc669e4886b5352bb3", "url": "https://github.com/google/ground-android/commit/aa059f3062dfe0c8a1b155fc669e4886b5352bb3", "message": "Merge branch 'harden-firestore-objects' of https://github.com/gino-m/ground-android into harden-firestore-objects", "committedDate": "2020-02-12T02:11:52Z", "type": "commit"}, {"oid": "76f08e84e49015057de4cdef8281bb00d92a8035", "url": "https://github.com/google/ground-android/commit/76f08e84e49015057de4cdef8281bb00d92a8035", "message": "Replace \"place\" with \"feature\".", "committedDate": "2020-02-12T02:13:24Z", "type": "commit"}, {"oid": "be5f2f223ea7ca1eabcc1304b71cfd38626cf67c", "url": "https://github.com/google/ground-android/commit/be5f2f223ea7ca1eabcc1304b71cfd38626cf67c", "message": "Implement missing value checks for Features in Firestore", "committedDate": "2020-02-12T03:38:32Z", "type": "commit"}, {"oid": "b56acc31af0ce988d851e6cb142ddbdc2ad4f803", "url": "https://github.com/google/ground-android/commit/b56acc31af0ce988d851e6cb142ddbdc2ad4f803", "message": "More descriptive arg names", "committedDate": "2020-02-12T15:47:41Z", "type": "commit"}, {"oid": "78ffa72333f57be3d2dba31e570a565a60d28721", "url": "https://github.com/google/ground-android/commit/78ffa72333f57be3d2dba31e570a565a60d28721", "message": "Shorter converter name", "committedDate": "2020-02-12T15:48:55Z", "type": "commit"}, {"oid": "937971f5cffad1ef8279f64acebb994cbb682682", "url": "https://github.com/google/ground-android/commit/937971f5cffad1ef8279f64acebb994cbb682682", "message": "Handle Feature deserialization errors downstream", "committedDate": "2020-02-12T16:12:48Z", "type": "commit"}, {"oid": "9df1b8725a920f31146378f04ce0041a3ec1015c", "url": "https://github.com/google/ground-android/commit/9df1b8725a920f31146378f04ce0041a3ec1015c", "message": "Merge branch 'master' into harden-firestore-objects", "committedDate": "2020-02-15T15:44:36Z", "type": "commit"}, {"oid": "eee5979ca2a982f3e57e9ac12e69fe70087b1733", "url": "https://github.com/google/ground-android/commit/eee5979ca2a982f3e57e9ac12e69fe70087b1733", "message": "Update JavaDoc", "committedDate": "2020-02-15T16:30:03Z", "type": "commit"}, {"oid": "a8de127afef1323754c5d8c8f3f589920efa98a0", "url": "https://github.com/google/ground-android/commit/a8de127afef1323754c5d8c8f3f589920efa98a0", "message": "Refactor Firestore observation persistence", "committedDate": "2020-02-16T16:51:44Z", "type": "commit"}, {"oid": "6d349a6a627757e6406426d34eefffed17eb1a42", "url": "https://github.com/google/ground-android/commit/6d349a6a627757e6406426d34eefffed17eb1a42", "message": "Update method visibility", "committedDate": "2020-02-17T20:20:22Z", "type": "commit"}, {"oid": "7a498cf7ae7a0c99b32b0518c4a0511054f214ea", "url": "https://github.com/google/ground-android/commit/7a498cf7ae7a0c99b32b0518c4a0511054f214ea", "message": "Merge branch 'master' of https://github.com/google/ground-android into firestore-cleanup2\n\n# Conflicts:\n#\tgradle.properties", "committedDate": "2020-02-17T20:28:27Z", "type": "commit"}, {"oid": "6b2b988370de9e4deca59821ade391146f795f80", "url": "https://github.com/google/ground-android/commit/6b2b988370de9e4deca59821ade391146f795f80", "message": "Update visibility", "committedDate": "2020-02-17T20:28:43Z", "type": "commit"}, {"oid": "be956f328d78b6ba579304075f8da13203f821d6", "url": "https://github.com/google/ground-android/commit/be956f328d78b6ba579304075f8da13203f821d6", "message": "Handle remote observation conversion errors", "committedDate": "2020-02-17T22:06:03Z", "type": "commit"}, {"oid": "1aa8b64f7b4b0486fe452d52dcb00f78d213ee3d", "url": "https://github.com/google/ground-android/commit/1aa8b64f7b4b0486fe452d52dcb00f78d213ee3d", "message": "Add log text", "committedDate": "2020-02-17T22:10:12Z", "type": "commit"}, {"oid": "319fb80fc01e27bbdc7fd8855acda306eeb0750a", "url": "https://github.com/google/ground-android/commit/319fb80fc01e27bbdc7fd8855acda306eeb0750a", "message": "Handle remote observation mutation errors", "committedDate": "2020-02-17T22:10:57Z", "type": "commit"}, {"oid": "c466a2419952ed05c30a2302b356c9af7e6294dc", "url": "https://github.com/google/ground-android/commit/c466a2419952ed05c30a2302b356c9af7e6294dc", "message": "Refactor remote project deserialization", "committedDate": "2020-02-17T22:45:48Z", "type": "commit"}, {"oid": "34f23d172f762377879f49489c20fb160cca8f54", "url": "https://github.com/google/ground-android/commit/34f23d172f762377879f49489c20fb160cca8f54", "message": "Improve handling of missing remote entities", "committedDate": "2020-02-17T23:00:48Z", "type": "commit"}, {"oid": "977baf4f5abfc27cc198874ae3b75e63151f2369", "url": "https://github.com/google/ground-android/commit/977baf4f5abfc27cc198874ae3b75e63151f2369", "message": "Rename and move AuditInfo remote entity class", "committedDate": "2020-02-17T23:04:40Z", "type": "commit"}, {"oid": "3319e600b8cfddbca92a1473903c01079a789ab2", "url": "https://github.com/google/ground-android/commit/3319e600b8cfddbca92a1473903c01079a789ab2", "message": "Refactor remote persistence of AuditInfo", "committedDate": "2020-02-17T23:12:29Z", "type": "commit"}, {"oid": "4fc32093e25eeb2c836227480cbe1d85e9f18ccd", "url": "https://github.com/google/ground-android/commit/4fc32093e25eeb2c836227480cbe1d85e9f18ccd", "message": "Rename and move user remote nested object class", "committedDate": "2020-02-17T23:13:12Z", "type": "commit"}, {"oid": "53ec85d2bdcb2929388bab730c1c7c23a1e2a4b1", "url": "https://github.com/google/ground-android/commit/53ec85d2bdcb2929388bab730c1c7c23a1e2a4b1", "message": "Refactor remote persistence of nested user objects", "committedDate": "2020-02-17T23:18:55Z", "type": "commit"}, {"oid": "45451337f601d54af0b47a17bada6fe436cfa91b", "url": "https://github.com/google/ground-android/commit/45451337f601d54af0b47a17bada6fe436cfa91b", "message": "Refactor remaining layer and form remote entity classes and converters", "committedDate": "2020-02-17T23:55:46Z", "type": "commit"}, {"oid": "d8605661dde690a7e9d8f49fc719b5eff04a68e9", "url": "https://github.com/google/ground-android/commit/d8605661dde690a7e9d8f49fc719b5eff04a68e9", "message": "Move up common remote datastore classes", "committedDate": "2020-02-18T00:00:43Z", "type": "commit"}, {"oid": "7a748b24b014aa43961735eee5c55a5deb0df577", "url": "https://github.com/google/ground-android/commit/7a748b24b014aa43961735eee5c55a5deb0df577", "message": "Restore checkCode invocation", "committedDate": "2020-02-18T00:10:06Z", "type": "commit"}, {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "url": "https://github.com/google/ground-android/commit/d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "message": "Reduce visibility of members", "committedDate": "2020-02-18T00:26:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2ODE5Mg==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380968192", "bodyText": "Should we use exceptions for this case?\nI'm of the opinion that exceptions are more useful for states that are actually unrecoverable/catastrophic--places where crashing w/ a message + trace is a valid course of action, whereas when we do stuff like ignore or log a potential value we don't care about and otherwise continue running some kind of value wrapper type is more appropriate\u2014it doesn't make much of a difference at the end of the day, so I would bother if you have a different stance on this.", "author": "scolsen", "createdAt": "2020-02-18T22:15:28Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreDataStore.java", "diffHunk": "@@ -91,30 +97,37 @@ public Completable applyMutations(ImmutableCollection<Mutation> mutations, User\n   private Task<?> applyMutationsInternal(ImmutableCollection<Mutation> mutations, User user) {\n     WriteBatch batch = db.batch();\n     for (Mutation mutation : mutations) {\n-      addMutationToBatch(mutation, user, batch);\n+      try {\n+        addMutationToBatch(mutation, user, batch);\n+      } catch (DataStoreException e) {", "originalCommit": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4NjQ5MQ==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380986491", "bodyText": "If exceptions were unrecoverable, then there'd be no need for try/catch. Sun says \"An exception is an event that occurs during the execution of a program that disrupts the normal flow of instructions.\" Issues like these with bad input data prevent the deserialization of remote entities, but don't break the entire app. Where we handle these and how obviously an art and not a science, and I agree sometimes it may make sense to use value wrappers instead of exceptions. But for values that really really need to be there for the data be used (i.e., we're dropping data, the database is corrupt) an exception definitely seems like the right mechanism.\n@dturner in case you have anything to add!", "author": "gino-m", "createdAt": "2020-02-18T22:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2ODE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MjUwNg==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380992506", "bodyText": "That sounds reasonable to me. I'm fine with using them--I think at times they compete with alternatives like returning Result(x)--thanks for the explanation!\nBut i will drop this chart :)", "author": "scolsen", "createdAt": "2020-02-18T23:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2ODE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5NzMxNg==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380997316", "bodyText": "+1, especially when we need a was to propagate errors in streams.\nI haven't seen that before, but at first glance it seems they may be confusing code readability with graph complexity, which I intuitively believe may not be strictly correlated. The abstraction provided by exception propagation could allow you to represent the call stack as a single box, in some sense... but I could be wrong.", "author": "gino-m", "createdAt": "2020-02-18T23:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2ODE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM4MTE0OA==", "url": "https://github.com/google/ground-android/pull/371#discussion_r381381148", "bodyText": "That's a good point! I guess I just think things are easier to reason about the less we mix styles--but it probably is simpler to go with exceptions in certain cases--I just hope doing things on a case-by-case basis doesn't make it more difficult to alter things in the long run. But I think our choices/boundaries are pretty clear right now, so it probably won't be an issue.", "author": "scolsen", "createdAt": "2020-02-19T16:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2ODE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDA1MQ==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380970051", "bodyText": "Is it really a POJO? Doesn't it depend on Firebase?", "author": "scolsen", "createdAt": "2020-02-18T22:19:39Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/AuditInfoConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.android.gnd.model.AuditInfo;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.User;\n+import com.google.firebase.Timestamp;\n+import java.util.Date;\n+import java8.util.Optional;\n+\n+/** Converts between Firestore nested objects and {@link AuditInfo} instances. */\n+class AuditInfoConverter {\n+\n+  /**\n+   * Converts a POJO representing user and timestamp data in Firebase into an equivalent model", "originalCommit": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4ODQxNw==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380988417", "bodyText": "Good question... I think in this case they're still considered POJOs in the general sense in that they implement no special interfaces or external conventions; the annotations only provide hints for Firebase, but they're not required to use or create instances.\n\nThe idea is that if the object (actually class) were a POJO before any annotations were added, and would return to POJO status if the annotations are removed then it can still be considered a POJO. Then the basic object remains a POJO in that it has no special characteristics (such as an implemented interface) that makes it a \"Specialized Java Object\" (SJO or (sic) SoJO).\nhttps://en.wikipedia.org/wiki/Plain_old_Java_object#Definition", "author": "gino-m", "createdAt": "2020-02-18T23:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MTI2NA==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380991264", "bodyText": "Cool, sounds good! Thanks for clarifying.\nMight be best to just drop the term in this case? I don't think it adds much atm -- I think just calling it a converter to/from Firebase representation to the model is clear and effective.", "author": "scolsen", "createdAt": "2020-02-18T23:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5NTc1OA==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380995758", "bodyText": "Done (9f16c32)! I was going to update the comment, but ended up deleting instead, since other converter methods don't have method-level JavaDoc, and what they're doing is mostly clear from the class JavaDoc.", "author": "gino-m", "createdAt": "2020-02-18T23:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDA1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380970936", "bodyText": "If we know the user, shouldn't we ascribe the audit to the user even if the time is somehow unknown?", "author": "scolsen", "createdAt": "2020-02-18T22:21:44Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/AuditInfoConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.android.gnd.model.AuditInfo;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.User;\n+import com.google.firebase.Timestamp;\n+import java.util.Date;\n+import java8.util.Optional;\n+\n+/** Converts between Firestore nested objects and {@link AuditInfo} instances. */\n+class AuditInfoConverter {\n+\n+  /**\n+   * Converts a POJO representing user and timestamp data in Firebase into an equivalent model\n+   * object. This should never be empty in Firebase, but this method returns a default value when\n+   * the input is null to support legacy or corrupt dbs.\n+   */\n+  @NonNull\n+  static AuditInfo toAuditInfo(@Nullable AuditInfoNestedObject doc) {\n+    if (doc == null || doc.getClientTimeMillis() == null) {", "originalCommit": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3NDI1NA==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380974254", "bodyText": "We could also return defaults from the AuditInfoNestedObject getters themselves -- since we're accounting for a peculiarity of firebase and not our model.\nPlus that ensures the work performed by the converter is actual conversion from store values to model values (timestamp->date) and we don't give it the double duty of defining defaults for store values.", "author": "scolsen", "createdAt": "2020-02-18T22:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3NDM5OQ==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380974399", "bodyText": "I don't have a particularly strong opinion on this though, so up to you.", "author": "scolsen", "createdAt": "2020-02-18T22:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MTM1OA==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380991358", "bodyText": "We could also return defaults from the AuditInfoNestedObject getters themselves -- since we're accounting for a peculiarity of firebase and not our model.\n\nThis would split out part of the conversion of remove data, making the conversion harder to debug.\n\nPlus that ensures the work performed by the converter is actual conversion from store values to model values (timestamp->date) and we don't give it the double duty of defining defaults for store values.\n\nI think it makes sense to a canonical representation of what's actually in Firebase separate from the handling of that data. It makes things easier to debug, and consolidates all logic that transforms that data (defaults, fallbacks, or otherwise) into a single place.\n\nIf we know the user, shouldn't we ascribe the audit to the user even if the time is somehow unknown?\n\nActually now that I think about it, an entity without a time should probably just be considered invalid, since it's one of the only identifying attributes of features and observations. Users, on the other hand, could delete their accounts, meaning we would need to delete the user data.", "author": "gino-m", "createdAt": "2020-02-18T23:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MzEzMg==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380993132", "bodyText": "Sounds good!", "author": "scolsen", "createdAt": "2020-02-18T23:17:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5NDk2Ng==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380994966", "bodyText": "Fixed! Relevant patch: ab1b06f", "author": "gino-m", "createdAt": "2020-02-18T23:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3ODA5NA==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380978094", "bodyText": "Is there a reason we don't store formIds on forms themselves?", "author": "scolsen", "createdAt": "2020-02-18T22:39:10Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/FormConverter.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.stream.StreamSupport.stream;\n+\n+import com.google.android.gnd.model.form.Form;\n+\n+/** Converts between Firestore nested objects and {@link Form} instances. */\n+class FormConverter {\n+\n+  static Form toForm(String formId, FormNestedObject obj) {\n+    return Form.newBuilder()\n+        .setId(formId)", "originalCommit": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4OTA0NQ==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380989045", "bodyText": "Because they come from the enclosing map, e.g.\n{\n   'id1234': {\n     // nested object\n   }\n}", "author": "gino-m", "createdAt": "2020-02-18T23:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3ODA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MzE4OQ==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380993189", "bodyText": "I see, thanks!", "author": "scolsen", "createdAt": "2020-02-18T23:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3ODA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDY2Ng==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380980666", "bodyText": "Instead of doing a conversion here, could we just add a single layer of indirection to the DocSnapshots? -- so that their first interior/nested field is the representation of a Project, instead of having them represent the project itself? --or would that be rather fussy/pointless?", "author": "scolsen", "createdAt": "2020-02-18T22:45:14Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/ProjectConverter.java", "diffHunk": "@@ -14,36 +14,28 @@\n  * limitations under the License.\n  */\n \n-package com.google.android.gnd.persistence.remote.firestore;\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n \n import static com.google.android.gnd.util.Localization.getLocalizedMessage;\n \n-import androidx.annotation.Nullable;\n import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.persistence.remote.DataStoreException;\n import com.google.firebase.firestore.DocumentSnapshot;\n-import com.google.firebase.firestore.IgnoreExtraProperties;\n-import java.util.Map;\n import java8.util.Maps;\n \n-@IgnoreExtraProperties\n-public class ProjectDoc {\n-  @Nullable public Map<String, String> title;\n+/** Converts between Firestore documents and {@link Project} instances. */\n+class ProjectConverter {\n \n-  @Nullable public Map<String, String> description;\n-\n-  // TODO: Add AuditInfoDoc for created and lastModified.\n-\n-  @Nullable public Map<String, LayerDoc> featureTypes;\n-\n-  public static Project toObject(DocumentSnapshot doc) {\n-    ProjectDoc pd = doc.toObject(ProjectDoc.class);\n+  static Project toProject(DocumentSnapshot doc) throws DataStoreException {\n+    ProjectDocument pd = doc.toObject(ProjectDocument.class);", "originalCommit": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MzQ0Nw==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380993447", "bodyText": "Based on:\n\nBecause they come from the enclosing map, e.g.\n{\n   'id1234': {\n     // nested object\n   }\n}\n\n\nSeems like it'd be a pain to do what I'm suggesting/asking here", "author": "scolsen", "createdAt": "2020-02-18T23:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5OTk4MA==", "url": "https://github.com/google/ground-android/pull/371#discussion_r380999980", "bodyText": "Firebase client libraries return you DocumentSnapshots; we'd still need to ask the API to convert them to objects for us someplace.", "author": "gino-m", "createdAt": "2020-02-18T23:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwMDcyMg==", "url": "https://github.com/google/ground-android/pull/371#discussion_r381000722", "bodyText": "If we wanted to abstract this I suppose we could define the classes to convert to declaratively in some sort of a registry, then define a standard interface for converters, but that would lead to a of boilerplate, and not allow us to provide custom args to converter methods as we do now, forcing us to propose the args to member variables of hypothetical converter instances. Oy. \ud83d\ude44 Open to other ideas if you had something else in mind though!", "author": "gino-m", "createdAt": "2020-02-18T23:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDY2Ng=="}], "type": "inlineReview"}, {"oid": "43045e6a7e3951db53f00be4fc902718c89a2052", "url": "https://github.com/google/ground-android/commit/43045e6a7e3951db53f00be4fc902718c89a2052", "message": "Merge branch 'master' into firestore-cleanup2", "committedDate": "2020-02-18T23:05:59Z", "type": "commit"}, {"oid": "ab1b06fb643e4de3e4d029cedbc93f575535674d", "url": "https://github.com/google/ground-android/commit/ab1b06fb643e4de3e4d029cedbc93f575535674d", "message": "Fail on missing creation timestamp", "committedDate": "2020-02-18T23:20:08Z", "type": "commit"}, {"oid": "895bbd468329a4aa64fcb8c89d5bc483e8e34556", "url": "https://github.com/google/ground-android/commit/895bbd468329a4aa64fcb8c89d5bc483e8e34556", "message": "Merge remote-tracking branch 'origin/firestore-cleanup2' into firestore-cleanup2", "committedDate": "2020-02-18T23:20:44Z", "type": "commit"}, {"oid": "9f16c32f4670c2d8313c87958891da0063c71c21", "url": "https://github.com/google/ground-android/commit/9f16c32f4670c2d8313c87958891da0063c71c21", "message": "Remove redundant JavaDoc", "committedDate": "2020-02-18T23:25:27Z", "type": "commit"}, {"oid": "3df4f1986c96035cbdbcd1c002f08cedeaaf6163", "url": "https://github.com/google/ground-android/commit/3df4f1986c96035cbdbcd1c002f08cedeaaf6163", "message": "Merge branch 'master' into firestore-cleanup2", "committedDate": "2020-02-19T14:52:47Z", "type": "commit"}, {"oid": "60f8f92f0f5a1e33394bedc7f54eac49c227cde7", "url": "https://github.com/google/ground-android/commit/60f8f92f0f5a1e33394bedc7f54eac49c227cde7", "message": "Merge branch 'master' into firestore-cleanup2", "committedDate": "2020-02-19T22:17:41Z", "type": "commit"}, {"oid": "42a9c8a8dd6b536d19d69be66f46e83fd630a5e2", "url": "https://github.com/google/ground-android/commit/42a9c8a8dd6b536d19d69be66f46e83fd630a5e2", "message": "Remove qualifier from TAG constant", "committedDate": "2020-02-19T22:31:41Z", "type": "commit"}, {"oid": "16fbc894218216d91428cc7e30361e8b1e58090e", "url": "https://github.com/google/ground-android/commit/16fbc894218216d91428cc7e30361e8b1e58090e", "message": "Merge branch 'master' of https://github.com/google/ground-android into firestore-cleanup2", "committedDate": "2020-02-19T22:45:02Z", "type": "commit"}, {"oid": "991d6c76e3403e769890ce4768c31dc70b03ede0", "url": "https://github.com/google/ground-android/commit/991d6c76e3403e769890ce4768c31dc70b03ede0", "message": "Make stack trace more readable.", "committedDate": "2020-02-19T23:15:08Z", "type": "commit"}, {"oid": "e6c22ab44e6176741570d3074824a104b4ad2611", "url": "https://github.com/google/ground-android/commit/e6c22ab44e6176741570d3074824a104b4ad2611", "message": "Add nullness check", "committedDate": "2020-02-19T23:20:31Z", "type": "commit"}, {"oid": "6bf722f58ef3fca00f1459b0cfba85b722119a6e", "url": "https://github.com/google/ground-android/commit/6bf722f58ef3fca00f1459b0cfba85b722119a6e", "message": "Public constructors and accessors for Firestore toObject()", "committedDate": "2020-02-19T23:34:53Z", "type": "commit"}, {"oid": "519025f61dadcebfb74685a7d780988680959280", "url": "https://github.com/google/ground-android/commit/519025f61dadcebfb74685a7d780988680959280", "message": "Merge remote-tracking branch 'origin/firestore-cleanup2' into firestore-cleanup2", "committedDate": "2020-02-19T23:35:04Z", "type": "commit"}]}