{"pr_number": 469, "pr_title": "[Refactor] Refactor edit observation package", "pr_createdAt": "2020-05-14T16:40:14Z", "pr_url": "https://github.com/google/ground-android/pull/469", "timeline": [{"oid": "b281acf41f58b03be3edf20227b414095632c47b", "url": "https://github.com/google/ground-android/commit/b281acf41f58b03be3edf20227b414095632c47b", "message": "Add factory class for generating view bindings", "committedDate": "2020-05-14T11:43:43Z", "type": "commit"}, {"oid": "7b3a6f53c58d2f8a077cb17d4d0d32fc8057017a", "url": "https://github.com/google/ground-android/commit/7b3a6f53c58d2f8a077cb17d4d0d32fc8057017a", "message": "Move inflate calls to factory class", "committedDate": "2020-05-14T12:14:13Z", "type": "commit"}, {"oid": "684e262e6a2e25bd530b279680af63458f06e5d9", "url": "https://github.com/google/ground-android/commit/684e262e6a2e25bd530b279680af63458f06e5d9", "message": "Create custom style for FieldView and refactor", "committedDate": "2020-05-14T12:20:34Z", "type": "commit"}, {"oid": "b98be4fd9e5452d161e03b8c13ed50f2be189376", "url": "https://github.com/google/ground-android/commit/b98be4fd9e5452d161e03b8c13ed50f2be189376", "message": "Remove unused parameter", "committedDate": "2020-05-14T12:22:45Z", "type": "commit"}, {"oid": "0ad7b11457524850affbdc8deede92733d66d4f2", "url": "https://github.com/google/ground-android/commit/0ad7b11457524850affbdc8deede92733d66d4f2", "message": "Add empty view model classes for each ViewDataBinding", "committedDate": "2020-05-14T12:28:01Z", "type": "commit"}, {"oid": "a9583ac4ce945daece26bab38681e93db7f72575", "url": "https://github.com/google/ground-android/commit/a9583ac4ce945daece26bab38681e93db7f72575", "message": "Attach binding to layout during inflate call", "committedDate": "2020-05-14T12:50:34Z", "type": "commit"}, {"oid": "41e99f45d920b534c7ca48be92afb0ca41b6017e", "url": "https://github.com/google/ground-android/commit/41e99f45d920b534c7ca48be92afb0ca41b6017e", "message": "Return ViewModels instead of ViewDataBinding objects", "committedDate": "2020-05-14T13:03:05Z", "type": "commit"}, {"oid": "b57ba8de29678c5666fae6f437b1612980f50fc9", "url": "https://github.com/google/ground-android/commit/b57ba8de29678c5666fae6f437b1612980f50fc9", "message": "Add fields to AbstractFieldViewModel", "committedDate": "2020-05-14T13:40:45Z", "type": "commit"}, {"oid": "5dc0439348c61686b728cac0f851125a08a78192", "url": "https://github.com/google/ground-android/commit/5dc0439348c61686b728cac0f851125a08a78192", "message": "Update constructor of child view models", "committedDate": "2020-05-14T13:42:04Z", "type": "commit"}, {"oid": "37e620b7d3865ddcb43233ef58696b62194a3f9f", "url": "https://github.com/google/ground-android/commit/37e620b7d3865ddcb43233ef58696b62194a3f9f", "message": "Bind text_input_field to it's view model", "committedDate": "2020-05-14T13:49:01Z", "type": "commit"}, {"oid": "17320c53fcc1d0ace3ef674638a11e2f9c23b666", "url": "https://github.com/google/ground-android/commit/17320c53fcc1d0ace3ef674638a11e2f9c23b666", "message": "Bind multiple_choice_input_field to it's view model", "committedDate": "2020-05-14T13:54:22Z", "type": "commit"}, {"oid": "1c2427e16e24fa087c91119c570852ce9b3af77e", "url": "https://github.com/google/ground-android/commit/1c2427e16e24fa087c91119c570852ce9b3af77e", "message": "Bind photo_input_field to it's view model", "committedDate": "2020-05-14T14:00:20Z", "type": "commit"}, {"oid": "0e1e67f57b556392d64683b2a512c7db55bbebbe", "url": "https://github.com/google/ground-android/commit/0e1e67f57b556392d64683b2a512c7db55bbebbe", "message": "Remove unused binding adapters", "committedDate": "2020-05-14T14:02:21Z", "type": "commit"}, {"oid": "ea9459ab576a12bd5c1d32f97ddb6be546af80ff", "url": "https://github.com/google/ground-android/commit/ea9459ab576a12bd5c1d32f97ddb6be546af80ff", "message": "Remove obsolete init call from PhotoFieldViewModel", "committedDate": "2020-05-14T14:03:18Z", "type": "commit"}, {"oid": "16ff72386125e9f685e95654bdea9b391da9cd92", "url": "https://github.com/google/ground-android/commit/16ff72386125e9f685e95654bdea9b391da9cd92", "message": "Subscribe to dialog clicks from PhotoFieldViewModel", "committedDate": "2020-05-14T14:11:23Z", "type": "commit"}, {"oid": "7df1bb5d02e18e21cb2a63f8c19bc450a5c2b368", "url": "https://github.com/google/ground-android/commit/7df1bb5d02e18e21cb2a63f8c19bc450a5c2b368", "message": "Subscribe to dialog clicks from MultipleChoiceViewModel", "committedDate": "2020-05-14T14:14:56Z", "type": "commit"}, {"oid": "1605437ee41fbed50128d1aa1a72d57e87661c32", "url": "https://github.com/google/ground-android/commit/1605437ee41fbed50128d1aa1a72d57e87661c32", "message": "Remove extra check for bottom sheet dialog.\n\n - We need to do this globally and a more generic solution is needed.", "committedDate": "2020-05-14T14:20:06Z", "type": "commit"}, {"oid": "12522f7ea183722b43497c8fd295161dba08106d", "url": "https://github.com/google/ground-android/commit/12522f7ea183722b43497c8fd295161dba08106d", "message": "Use behavior processor for updating response text", "committedDate": "2020-05-14T15:05:24Z", "type": "commit"}, {"oid": "ebf7e28e289dc0026c337c1f1287c325bb1782fd", "url": "https://github.com/google/ground-android/commit/ebf7e28e289dc0026c337c1f1287c325bb1782fd", "message": "Load current response in multiple choice dialog from its view model", "committedDate": "2020-05-14T15:18:34Z", "type": "commit"}, {"oid": "898e94f599eb76b008eb2150fccd02c070ae9c67", "url": "https://github.com/google/ground-android/commit/898e94f599eb76b008eb2150fccd02c070ae9c67", "message": "Update view model responses", "committedDate": "2020-05-14T15:44:32Z", "type": "commit"}, {"oid": "93aac4619adf15bbab84f4766110dc327540f1e6", "url": "https://github.com/google/ground-android/commit/93aac4619adf15bbab84f4766110dc327540f1e6", "message": "Remove unused collection", "committedDate": "2020-05-14T15:45:54Z", "type": "commit"}, {"oid": "028a8a19fa32cd570791e05141cfb44ea64b17bc", "url": "https://github.com/google/ground-android/commit/028a8a19fa32cd570791e05141cfb44ea64b17bc", "message": "Reorder methods in EditObservationFragment", "committedDate": "2020-05-14T16:25:52Z", "type": "commit"}, {"oid": "db6afe7188d9d7a86be102d74ed7b200fa91833b", "url": "https://github.com/google/ground-android/commit/db6afe7188d9d7a86be102d74ed7b200fa91833b", "message": "Null check for photo response", "committedDate": "2020-05-14T17:50:52Z", "type": "commit"}, {"oid": "db6afe7188d9d7a86be102d74ed7b200fa91833b", "url": "https://github.com/google/ground-android/commit/db6afe7188d9d7a86be102d74ed7b200fa91833b", "message": "Null check for photo response", "committedDate": "2020-05-14T17:50:52Z", "type": "forcePushed"}, {"oid": "905803684844eeda27430b4630e389e88e01d208", "url": "https://github.com/google/ground-android/commit/905803684844eeda27430b4630e389e88e01d208", "message": "Remove useless parenthesis", "committedDate": "2020-05-14T17:55:38Z", "type": "commit"}, {"oid": "8e6904b0d96f47ddbf4b72191281e704538f6ca1", "url": "https://github.com/google/ground-android/commit/8e6904b0d96f47ddbf4b72191281e704538f6ca1", "message": "Use generics for creating view binding", "committedDate": "2020-05-15T08:13:40Z", "type": "commit"}, {"oid": "c4ce93140d6f7ac813d2ae372cdcb8397654b28d", "url": "https://github.com/google/ground-android/commit/c4ce93140d6f7ac813d2ae372cdcb8397654b28d", "message": "Remove factory class and create static methods for clarity", "committedDate": "2020-05-15T09:26:12Z", "type": "commit"}, {"oid": "03128d63a26761f507377eabb649221dd4e47480", "url": "https://github.com/google/ground-android/commit/03128d63a26761f507377eabb649221dd4e47480", "message": "Fix error handling", "committedDate": "2020-05-15T10:12:13Z", "type": "commit"}, {"oid": "b8f5a9d6ace9e69a8200d9b3a3c52d7f9e9fd0ad", "url": "https://github.com/google/ground-android/commit/b8f5a9d6ace9e69a8200d9b3a3c52d7f9e9fd0ad", "message": "Create validator class", "committedDate": "2020-05-15T10:39:41Z", "type": "commit"}, {"oid": "e69947d8476a03506d71b4dc5028685523f6fd09", "url": "https://github.com/google/ground-android/commit/e69947d8476a03506d71b4dc5028685523f6fd09", "message": "Remove onFocusChanged. Response and error are updated with each change", "committedDate": "2020-05-15T10:42:55Z", "type": "commit"}, {"oid": "2e1844eeb0521cb61a05a36e3ba684eebfe092d1", "url": "https://github.com/google/ground-android/commit/2e1844eeb0521cb61a05a36e3ba684eebfe092d1", "message": "Refactor EditObservationViewModel to use Validator", "committedDate": "2020-05-16T16:17:15Z", "type": "commit"}, {"oid": "ef021fa6fd27edc330de21f2748217c92aaccf92", "url": "https://github.com/google/ground-android/commit/ef021fa6fd27edc330de21f2748217c92aaccf92", "message": "Make FieldViewModel dumb and set error via fragment", "committedDate": "2020-05-16T16:18:18Z", "type": "commit"}, {"oid": "020589b826ee2dcfd80ed46a53e09daee4d2fc62", "url": "https://github.com/google/ground-android/commit/020589b826ee2dcfd80ed46a53e09daee4d2fc62", "message": "Cleanup", "committedDate": "2020-05-16T16:20:51Z", "type": "commit"}, {"oid": "1fb40016ca4fa4de2f0070238de5cd6fe0610146", "url": "https://github.com/google/ground-android/commit/1fb40016ca4fa4de2f0070238de5cd6fe0610146", "message": "Use field instead of FieldId to prevent extra call", "committedDate": "2020-05-16T16:25:06Z", "type": "commit"}, {"oid": "32a8cd51ceacf8e36d27c0e1a0722b2a9d45c90e", "url": "https://github.com/google/ground-android/commit/32a8cd51ceacf8e36d27c0e1a0722b2a9d45c90e", "message": "Fix checkstyle issues", "committedDate": "2020-05-16T16:27:45Z", "type": "commit"}, {"oid": "6dd53321f39da81340b472d9930836307da6051b", "url": "https://github.com/google/ground-android/commit/6dd53321f39da81340b472d9930836307da6051b", "message": "Invert negation: pmd error", "committedDate": "2020-05-16T16:30:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5ODg1NA==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426298854", "bodyText": "View business logic generally belongs in ViewModels. Any reason not to include this in the AbstractFieldViewModel class?", "author": "gino-m", "createdAt": "2020-05-17T20:00:25Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/ResponseValidator.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.common;\n+\n+import android.content.res.Resources;\n+import com.google.android.gnd.GndApplication;\n+import com.google.android.gnd.R;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class ResponseValidator {", "originalCommit": "6dd53321f39da81340b472d9930836307da6051b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwMzgwNw==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426403807", "bodyText": "There were a couple of reasons to separate it out.\n\n\nRight now, we are only considering if a response is present or not. In future, we'll have to consider a lot of other validations as well (minLen, instanceType, regex, etc.). Having a small class would encourage extensive testing with all possible scenarios.\n\n\nIn the beginning, I moved all of this logic within AFVM, but it was also present in EOVM. So, to prevent duplication, I kept the original code and left it as is in favor of future cleanups. Ideally, the error should be generated and set by AFVM and EOVM should subscribe to the changes.", "author": "shobhitagarwal1612", "createdAt": "2020-05-18T06:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5ODg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3NDI4NQ==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426774285", "bodyText": "There were a couple of reasons to separate it out.\n\nRight now, we are only considering if a response is present or not. In future, we'll have to consider a lot of other validations as well (minLen, instanceType, regex, etc.). Having a small class would encourage extensive testing with all possible scenarios.\n\n\nIn that case, won't we end up with parallel Validator and ViewModel hierarchies for each field type?\n\n\nIn the beginning, I moved all of this logic within AFVM, but it was also present in EOVM. So, to prevent duplication, I kept the original code and left it as is in favor of future cleanups. Ideally, the error should be generated and set by AFVM and EOVM should subscribe to the changes.\n\n\nI see.. so it sounds like it belongs in the individual AFVM?", "author": "gino-m", "createdAt": "2020-05-18T17:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5ODg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzNDM2Ng==", "url": "https://github.com/google/ground-android/pull/469#discussion_r427034366", "bodyText": "In that case, won't we end up with parallel Validator and ViewModel hierarchies for each field type?\n\nI see. So each ViewModel should contain the logic instead of aggregating them in a external class and later mapping them. Sgtm.\n\nI see.. so it sounds like it belongs in the individual AFVM?\n\nYes.", "author": "shobhitagarwal1612", "createdAt": "2020-05-19T05:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5ODg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA0ODE5NA==", "url": "https://github.com/google/ground-android/pull/469#discussion_r427048194", "bodyText": "Done b42aa16", "author": "shobhitagarwal1612", "createdAt": "2020-05-19T06:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5ODg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5ODkzNQ==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426298935", "bodyText": "We've been using Optional instead of null for internal APIs. Can we do the same here for consistency?", "author": "gino-m", "createdAt": "2020-05-17T20:01:17Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/ResponseValidator.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.common;\n+\n+import android.content.res.Resources;\n+import com.google.android.gnd.GndApplication;\n+import com.google.android.gnd.R;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class ResponseValidator {\n+\n+  private final Resources resources;\n+\n+  @Inject\n+  ResponseValidator(GndApplication application) {\n+    this.resources = application.getResources();\n+  }\n+\n+  // TODO: Check valid response values\n+  @Nullable\n+  public String validate(Field field, Optional<Response> response) {", "originalCommit": "6dd53321f39da81340b472d9930836307da6051b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM4MjQ2OA==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426382468", "bodyText": "Thanks! Done 2c82209", "author": "shobhitagarwal1612", "createdAt": "2020-05-18T05:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5ODkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTE1OA==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426299158", "bodyText": "Can you add a TODO to add a reference to Field to Response? We have these associations in other parts of our internal model, so would make sense there as well.", "author": "gino-m", "createdAt": "2020-05-17T20:03:18Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/AbstractFieldViewModel.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n+import androidx.lifecycle.MutableLiveData;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.Single;\n+import io.reactivex.processors.BehaviorProcessor;\n+import java8.util.Optional;\n+\n+public class AbstractFieldViewModel extends AbstractViewModel {\n+\n+  private final LiveData<Optional<Response>> response;\n+  private final LiveData<String> responseText;\n+  private final MutableLiveData<String> error = new MutableLiveData<>();\n+  private final BehaviorProcessor<Optional<Response>> responseSubject = BehaviorProcessor.create();\n+\n+  private Field field;\n+\n+  AbstractFieldViewModel() {\n+    responseText =\n+        LiveDataReactiveStreams.fromPublisher(\n+            responseSubject.distinctUntilChanged().switchMapSingle(this::getDetailsText));\n+    response = LiveDataReactiveStreams.fromPublisher(responseSubject.distinctUntilChanged());\n+  }\n+\n+  void init(Field field, Optional<Response> response) {", "originalCommit": "6dd53321f39da81340b472d9930836307da6051b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMDIwNw==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426300207", "bodyText": "[or if it's an easy change feel free to add it in this PR so that the field UI method signatures can be simplified.]", "author": "gino-m", "createdAt": "2020-05-17T20:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwMDg4Mw==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426400883", "bodyText": "I checked and it is a bit complicated for MultipleChoiceResponse. Added a TODO for now", "author": "shobhitagarwal1612", "createdAt": "2020-05-18T06:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTQ0Ng==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426299446", "bodyText": "Rather than have getViewModelClass and getFieldLayoutId, can we instead have a FieldViewFactory class that will inflate the appropriate view and viewmodel? This fragment can coordinate the returned views by getting their viewmodels with DataBindingUtil. Wdyt?", "author": "gino-m", "createdAt": "2020-05-17T20:06:30Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -65,8 +70,31 @@\n   private SingleSelectDialogFactory singleSelectDialogFactory;\n   private MultiSelectDialogFactory multiSelectDialogFactory;\n \n-  @Nullable private EditObservationBottomSheetBinding addPhotoBottomSheetBinding;\n-  @Nullable private BottomSheetDialog bottomSheetDialog;\n+  private static Class<? extends AbstractFieldViewModel> getViewModelClass(Field.Type fieldType) {", "originalCommit": "6dd53321f39da81340b472d9930836307da6051b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM5NjI5Nw==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426396297", "bodyText": "Great idea! d4a40af", "author": "shobhitagarwal1612", "createdAt": "2020-05-18T06:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTc4MA==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426299780", "bodyText": "Please add Javadoc to classes and relevant public methods.", "author": "gino-m", "createdAt": "2020-05-17T20:10:29Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/AbstractFieldViewModel.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n+import androidx.lifecycle.MutableLiveData;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.Single;\n+import io.reactivex.processors.BehaviorProcessor;\n+import java8.util.Optional;\n+\n+public class AbstractFieldViewModel extends AbstractViewModel {\n+\n+  private final LiveData<Optional<Response>> response;\n+  private final LiveData<String> responseText;\n+  private final MutableLiveData<String> error = new MutableLiveData<>();\n+  private final BehaviorProcessor<Optional<Response>> responseSubject = BehaviorProcessor.create();\n+\n+  private Field field;\n+\n+  AbstractFieldViewModel() {", "originalCommit": "6dd53321f39da81340b472d9930836307da6051b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTg1Nw==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426299857", "bodyText": "Style nit: Please use capital case with final period in comments. Example: \"Please use capital case with final period in comments.\" :)", "author": "gino-m", "createdAt": "2020-05-17T20:11:12Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -119,116 +147,107 @@ private void handleSaveResult(EditObservationViewModel.SaveResult saveResult) {\n     }\n   }\n \n-  private void rebuildForm(Form form) {\n-    formLayout.removeAllViews();\n-    for (Element element : form.getElements()) {\n-      switch (element.getType()) {\n-        case FIELD:\n-          addField(element.getField());\n-          break;\n-        default:\n-          Timber.d(\"%s elements not yet supported\", element.getType());\n-          break;\n-      }\n-    }\n-  }\n+  private <V extends AbstractFieldViewModel> V addFieldViewModel(Field field) {\n+    V fieldViewModel = (V) viewModelFactory.create(getViewModelClass(field.getType()));\n \n-  private void addField(Field field) {\n-    switch (field.getType()) {\n-      case TEXT:\n-        addTextField(field);\n-        break;\n-      case MULTIPLE_CHOICE:\n-        addMultipleChoiceField(field);\n-        break;\n-      case PHOTO:\n-        addPhotoField(field);\n-        break;\n-      default:\n-        Timber.w(\"Unimplemented field type: %s\", field.getType());\n-        break;\n+    // load field and current response\n+    fieldViewModel.init(field, viewModel.getResponse(field.getId()));\n+\n+    // handle UI interactions\n+    if (fieldViewModel instanceof PhotoFieldViewModel) {\n+      observeSelectPhotoClicks((PhotoFieldViewModel) fieldViewModel);\n+    } else if (fieldViewModel instanceof MultipleChoiceFieldViewModel) {\n+      observeMultipleChoiceClicks((MultipleChoiceFieldViewModel) fieldViewModel);\n     }\n-  }\n \n-  private void addTextField(Field field) {\n-    TextInputFieldBinding binding =\n-        TextInputFieldBinding.inflate(getLayoutInflater(), formLayout, false);\n-    binding.setViewModel(viewModel);\n-    binding.setLifecycleOwner(this);\n-    binding.setField(field);\n-    formLayout.addView(binding.getRoot());\n-    assignGeneratedId(binding.getRoot().findViewById(R.id.text_input_edit_text));\n-  }\n+    // subscribe to response updates", "originalCommit": "6dd53321f39da81340b472d9930836307da6051b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTk2MQ==", "url": "https://github.com/google/ground-android/pull/469#discussion_r426299961", "bodyText": "Also please make sure the comment describes something more than what's clear from the code itself. In this case, for example, a comment isn't needed.", "author": "gino-m", "createdAt": "2020-05-17T20:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI5OTg1Nw=="}], "type": "inlineReview"}, {"oid": "2c822095b27bffa876747fecf74f3741cb9bcea8", "url": "https://github.com/google/ground-android/commit/2c822095b27bffa876747fecf74f3741cb9bcea8", "message": "Return Optional<String> instead of String for consistency", "committedDate": "2020-05-18T05:49:32Z", "type": "commit"}, {"oid": "d4a40af5a04f151b666880b94423305b14cdb5b8", "url": "https://github.com/google/ground-android/commit/d4a40af5a04f151b666880b94423305b14cdb5b8", "message": "Move view and VM creation to FieldViewFactory\n\n - Inject Fragment and ViewModelFactory instead of instantiating ourselves\n - Return ViewDataBinding instead of ViewModel. This would allow early failure if any binding doesn't contain the expected view model object.", "committedDate": "2020-05-18T06:33:44Z", "type": "commit"}, {"oid": "aa96c89344d3dd686bcb3d68ada1c1a492ab44fc", "url": "https://github.com/google/ground-android/commit/aa96c89344d3dd686bcb3d68ada1c1a492ab44fc", "message": "Add javadocs and comments", "committedDate": "2020-05-18T06:45:36Z", "type": "commit"}, {"oid": "b0f4243659d6b06c0ddd9e012e838dcac399ff25", "url": "https://github.com/google/ground-android/commit/b0f4243659d6b06c0ddd9e012e838dcac399ff25", "message": "Remove obvious comments", "committedDate": "2020-05-18T06:48:34Z", "type": "commit"}, {"oid": "f53766ebcf486e58389960fbdbea03cbffa14358", "url": "https://github.com/google/ground-android/commit/f53766ebcf486e58389960fbdbea03cbffa14358", "message": "Merge branch 'master' into refactor", "committedDate": "2020-05-18T22:01:43Z", "type": "commit"}, {"oid": "b42aa1649f1876c388103404e7ab136bba459a79", "url": "https://github.com/google/ground-android/commit/b42aa1649f1876c388103404e7ab136bba459a79", "message": "Refactor error handling\n\n - Remove validator class\n - Move logic for set errors to FieldViewModel\n - Clean EditObservationViewModel", "committedDate": "2020-05-19T06:00:19Z", "type": "commit"}]}