{"pr_number": 311, "pr_title": "[Support Photos] Integrate Firebase Storage for uploading photos", "pr_createdAt": "2020-01-14T13:13:21Z", "pr_url": "https://github.com/google/ground-android/pull/311", "timeline": [{"oid": "e61efa6402dce0fe5e18df4158cdc3f6fca32934", "url": "https://github.com/google/ground-android/commit/e61efa6402dce0fe5e18df4158cdc3f6fca32934", "message": "Add firebase storage gradle dependency", "committedDate": "2020-01-16T06:46:18Z", "type": "commit"}, {"oid": "2631bd4b672d49f211fd64a158fdcafe86a3f460", "url": "https://github.com/google/ground-android/commit/2631bd4b672d49f211fd64a158fdcafe86a3f460", "message": "Add MediaUploadManager", "committedDate": "2020-01-16T06:46:18Z", "type": "commit"}, {"oid": "9b86c0b4e63a6fda24a87e653964c13652fe0bec", "url": "https://github.com/google/ground-android/commit/9b86c0b4e63a6fda24a87e653964c13652fe0bec", "message": "Add overloaded methods for uploading via File", "committedDate": "2020-01-16T06:46:18Z", "type": "commit"}, {"oid": "26f058b832cbb0307ca114f13b6243c88ea79b90", "url": "https://github.com/google/ground-android/commit/26f058b832cbb0307ca114f13b6243c88ea79b90", "message": "Cleanup", "committedDate": "2020-01-16T06:46:18Z", "type": "commit"}, {"oid": "3cab8e1181b5ca4e708a2f0598fd9533707a79ed", "url": "https://github.com/google/ground-android/commit/3cab8e1181b5ca4e708a2f0598fd9533707a79ed", "message": "Fetch download link for storing to db after upload", "committedDate": "2020-01-16T06:46:18Z", "type": "commit"}, {"oid": "b4a98a7628def2db3ef4135a17fa5211630b7b02", "url": "https://github.com/google/ground-android/commit/b4a98a7628def2db3ef4135a17fa5211630b7b02", "message": "Revert UI changes", "committedDate": "2020-01-16T06:48:26Z", "type": "forcePushed"}, {"oid": "d31a44184820055fb3fe9c0110475838135dfa40", "url": "https://github.com/google/ground-android/commit/d31a44184820055fb3fe9c0110475838135dfa40", "message": "Add notes", "committedDate": "2020-01-16T06:53:17Z", "type": "commit"}, {"oid": "12c602f6be67efc65b012e8a486ef2373d50f10e", "url": "https://github.com/google/ground-android/commit/12c602f6be67efc65b012e8a486ef2373d50f10e", "message": "Fix variable name and add comments", "committedDate": "2020-01-16T06:59:58Z", "type": "commit"}, {"oid": "12c602f6be67efc65b012e8a486ef2373d50f10e", "url": "https://github.com/google/ground-android/commit/12c602f6be67efc65b012e8a486ef2373d50f10e", "message": "Fix variable name and add comments", "committedDate": "2020-01-16T06:59:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzNzIyNQ==", "url": "https://github.com/google/ground-android/pull/311#discussion_r367537225", "bodyText": "FYI for when you get to this, you can use our util RxTask to convert the task to a Single.", "author": "gino-m", "createdAt": "2020-01-16T16:58:21Z", "path": "gnd/src/main/java/com/google/android/gnd/system/MediaUploadManager.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.graphics.Bitmap;\n+import android.net.Uri;\n+import android.util.Log;\n+import com.google.firebase.storage.FirebaseStorage;\n+import com.google.firebase.storage.StorageReference;\n+import com.google.firebase.storage.UploadTask;\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.Objects;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+// TODO: Add column to Observation table for storing uploaded media urls\n+// TODO: Synced to remote db as well\n+@Singleton\n+public class MediaUploadManager {\n+\n+  private static final String TAG = MediaUploadManager.class.getName();\n+  private static final String MEDIA_ROOT_DIR = \"uploaded_media\";\n+  private final SimpleDateFormat dateFormat =\n+      new SimpleDateFormat(\"yyyyMMddHHmmss\", Locale.getDefault());\n+\n+  @Inject\n+  MediaUploadManager() {}\n+\n+  /** Returns a reference to the default Storage bucket. */\n+  private FirebaseStorage getStorage() {\n+    return FirebaseStorage.getInstance();\n+  }\n+\n+  /** Returns a reference to the root media dir. */\n+  private StorageReference getRootMediaDir() {\n+    return getStorage().getReference().child(MEDIA_ROOT_DIR);\n+  }\n+\n+  /**\n+   * Returns a reference to a object under the root media dir.\n+   *\n+   * @param fileName Name of the uploaded media\n+   */\n+  private StorageReference createReference(String fileName) {\n+    return getRootMediaDir().child(fileName + '-' + getFilenameSuffix());\n+  }\n+\n+  /** Converts current timestamp to a string to be used a suffix for uploading media. */\n+  private String getFilenameSuffix() {\n+    return dateFormat.format(new Date());\n+  }\n+\n+  /**\n+   * Upload file to Firebase Storage.\n+   */\n+  public void uploadMediaFromFile(File file, String fileName) {\n+    StorageReference reference = createReference(fileName);\n+    UploadTask task = reference.putFile(Uri.fromFile(file));\n+\n+    uploadMediaToFirebaseStorage(task, fileName);\n+    fetchDownloadUrl(reference, task);\n+  }\n+\n+  /** Upload bitmap to Firebase Storage. */\n+  public void uploadMediaFromBitmap(Bitmap bitmap, String fileName) {\n+    ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+    bitmap.compress(Bitmap.CompressFormat.JPEG, 100, baos);\n+    byte[] data = baos.toByteArray();\n+\n+    StorageReference reference = createReference(fileName);\n+    UploadTask task = reference.putBytes(data);\n+\n+    uploadMediaToFirebaseStorage(task, fileName);\n+    fetchDownloadUrl(reference, task);\n+  }\n+\n+  private void uploadMediaToFirebaseStorage(UploadTask uploadTask, String fileName) {\n+    // TODO: Create UploadState enum and use RxJava to broadcast upload state globally.", "originalCommit": "12c602f6be67efc65b012e8a486ef2373d50f10e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MjQxNg==", "url": "https://github.com/google/ground-android/pull/311#discussion_r367542416", "bodyText": "Note added", "author": "shobhitagarwal1612", "createdAt": "2020-01-16T17:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzNzIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzODE3Nw==", "url": "https://github.com/google/ground-android/pull/311#discussion_r367538177", "bodyText": "Since this class interacts with the remote data store, and not Android SDK specifically, perhaps it belongs in ..persistence.remote? Also, I'd name it something Firestore specific. Later we'll need to extract a generic interface so that we have an internal API to switch providers if necessary.", "author": "gino-m", "createdAt": "2020-01-16T17:00:02Z", "path": "gnd/src/main/java/com/google/android/gnd/system/MediaUploadManager.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;", "originalCommit": "12c602f6be67efc65b012e8a486ef2373d50f10e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0NDEyNg==", "url": "https://github.com/google/ground-android/pull/311#discussion_r367544126", "bodyText": "Done", "author": "shobhitagarwal1612", "createdAt": "2020-01-16T17:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzODE3Nw=="}], "type": "inlineReview"}, {"oid": "4ca8ec8933ad300690eeca9a76254fdf9eba811f", "url": "https://github.com/google/ground-android/commit/4ca8ec8933ad300690eeca9a76254fdf9eba811f", "message": "Add comment", "committedDate": "2020-01-16T17:08:55Z", "type": "commit"}, {"oid": "253cbfe581dca0b38750269065e5d6b99085ef9d", "url": "https://github.com/google/ground-android/commit/253cbfe581dca0b38750269065e5d6b99085ef9d", "message": "Move to persistence.remote package", "committedDate": "2020-01-16T17:11:20Z", "type": "commit"}, {"oid": "6b8f18b4c33a4c01629bdea3e27b9680b8674bed", "url": "https://github.com/google/ground-android/commit/6b8f18b4c33a4c01629bdea3e27b9680b8674bed", "message": "Merge branch 'master' into integrate-photos", "committedDate": "2020-01-17T05:42:50Z", "type": "commit"}, {"oid": "a402b007277fd502474e1b28d4c5bc88b97bbe0c", "url": "https://github.com/google/ground-android/commit/a402b007277fd502474e1b28d4c5bc88b97bbe0c", "message": "Merge branch 'master' into integrate-photos", "committedDate": "2020-01-17T07:13:57Z", "type": "commit"}, {"oid": "55d9756933a2f3bfff21bec2512efe6f4dc03121", "url": "https://github.com/google/ground-android/commit/55d9756933a2f3bfff21bec2512efe6f4dc03121", "message": "Merge branch 'master' into integrate-photos", "committedDate": "2020-01-17T07:23:18Z", "type": "commit"}]}