{"pr_number": 489, "pr_title": "Fixed Tile Providers", "pr_createdAt": "2020-05-27T21:50:35Z", "pr_url": "https://github.com/google/ground-android/pull/489", "timeline": [{"oid": "11cc6e0b318f1f75a128f4db0f264bf7f2fc9052", "url": "https://github.com/google/ground-android/commit/11cc6e0b318f1f75a128f4db0f264bf7f2fc9052", "message": "Restore 47fdd45 in MapBoxOfflineTileProvider\n\nI made some less than wise changes in the commits following this one,\nwhich caused tile rendering to behave incorrectly (we'd render a tile\nonly at a specific zoom level).\n\nGoing forward, we'll use a different approach and instead spawn tile\nproviders for each mbtiles file we need.", "committedDate": "2020-05-27T18:44:55Z", "type": "commit"}, {"oid": "e0e724a2fb4effb9ce9b882a7612a723d0f39d65", "url": "https://github.com/google/ground-android/commit/e0e724a2fb4effb9ce9b882a7612a723d0f39d65", "message": "Catch database corruption errors", "committedDate": "2020-05-27T21:47:50Z", "type": "commit"}, {"oid": "81ad3789deba3edb2849809f0900c613d9633ae9", "url": "https://github.com/google/ground-android/commit/81ad3789deba3edb2849809f0900c613d9633ae9", "message": "Update map adapter to render mbtiles correctly", "committedDate": "2020-05-27T21:48:15Z", "type": "commit"}, {"oid": "6ed6666e89453a63d671d798ee87b57fed3f5c06", "url": "https://github.com/google/ground-android/commit/6ed6666e89453a63d671d798ee87b57fed3f5c06", "message": "Ensure MapBoxOfflineTileProviders are closed", "committedDate": "2020-06-03T20:47:44Z", "type": "commit"}, {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "url": "https://github.com/google/ground-android/commit/7de2a9acc752fec35b98a1d30dc56acfba86bf32", "message": "Merge branch 'master' of https://github.com/google/ground-android into tile-provider-fix", "committedDate": "2020-06-03T20:48:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4Mzc0MQ==", "url": "https://github.com/google/ground-android/pull/489#discussion_r434883741", "bodyText": "Naming nit: onTileProvider<event/action>", "author": "gino-m", "createdAt": "2020-06-03T22:04:49Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -103,6 +103,11 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n         .flatMap(MapAdapter::getCameraMoves)\n         .as(disposeOnDestroy(this))\n         .subscribe(mapContainerViewModel::onCameraMove);\n+    mapAdapter\n+        .toObservable()\n+        .flatMap(MapAdapter::getTileProviders)\n+        .as(disposeOnDestroy(this))\n+        .subscribe(mapContainerViewModel::onTileProvider);", "originalCommit": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI4OTI0NA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435289244", "bodyText": "I renamed it to queueTileProvider since onTileProviderQueue is ambiguous (not clear whether queue is a continuation of the noun or if it's a verb).", "author": "scolsen", "createdAt": "2020-06-04T14:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4Mzc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI5MTAwMA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435291000", "bodyText": "f9a41a2", "author": "scolsen", "createdAt": "2020-06-04T14:14:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4Mzc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4MzkxNA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r434883914", "bodyText": "Naming: render -> addTileOverlays", "author": "gino-m", "createdAt": "2020-06-03T22:05:13Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -149,7 +154,7 @@ private void onMapReady(MapAdapter map) {\n     addFeatureBtn.setOnClickListener(\n         __ -> homeScreenViewModel.onAddFeatureBtnClick(map.getCameraTarget()));\n     enableLocationLockBtn();\n-    map.renderTileOverlay();\n+    mapContainerViewModel.getMbtiles().observe(this, map::renderTileOverlays);", "originalCommit": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3ODQ1OA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435278458", "bodyText": "57cb7dd", "author": "scolsen", "createdAt": "2020-06-04T13:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4MzkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDI0Mw==", "url": "https://github.com/google/ground-android/pull/489#discussion_r434884243", "bodyText": "mbtilesFilePaths maybe? (since this doesn't actually contain the data)", "author": "gino-m", "createdAt": "2020-06-03T22:06:07Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerViewModel.java", "diffHunk": "@@ -90,6 +98,11 @@\n                 .map(Loadable::value)\n                 .switchMap(this::getFeaturesStream)\n                 .map(MapContainerViewModel::toMapPins));\n+    this.mbtiles =", "originalCommit": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI5MTIyMw==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435291223", "bodyText": "f9a41a2", "author": "scolsen", "createdAt": "2020-06-04T14:14:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDcxMA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r434884710", "bodyText": "Same here: add instead of render", "author": "gino-m", "createdAt": "2020-06-03T22:07:17Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/map/gms/GoogleMapsMapAdapter.java", "diffHunk": "@@ -247,10 +257,21 @@ public LatLngBounds getViewport() {\n   }\n \n   @Override\n-  public void renderTileOverlay() {\n-    try (MapBoxOfflineTileProvider tileProvider =\n-        new MapBoxOfflineTileProvider(context.getFilesDir())) {\n-      map.addTileOverlay(new TileOverlayOptions().tileProvider(tileProvider));\n-    }\n+  public void renderTileOverlays(ImmutableSet<String> mbtilesFiles) {", "originalCommit": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3ODcwMw==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435278703", "bodyText": "57cb7dd", "author": "scolsen", "createdAt": "2020-06-04T13:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDc5MA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r434884790", "bodyText": "Can this inner lambda be extract to its own method for readability?", "author": "gino-m", "createdAt": "2020-06-03T22:07:32Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/map/gms/GoogleMapsMapAdapter.java", "diffHunk": "@@ -247,10 +257,21 @@ public LatLngBounds getViewport() {\n   }\n \n   @Override\n-  public void renderTileOverlay() {\n-    try (MapBoxOfflineTileProvider tileProvider =\n-        new MapBoxOfflineTileProvider(context.getFilesDir())) {\n-      map.addTileOverlay(new TileOverlayOptions().tileProvider(tileProvider));\n-    }\n+  public void renderTileOverlays(ImmutableSet<String> mbtilesFiles) {\n+    stream(mbtilesFiles)\n+        .forEach(\n+            path -> {\n+              File mbtiles = new File(context.getFilesDir(), path);", "originalCommit": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3ODc1NQ==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435278755", "bodyText": "57cb7dd", "author": "scolsen", "createdAt": "2020-06-04T13:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NTA3MA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r434885070", "bodyText": "Could you short circuit exit here instead and Timber.info the fact the the file was not found?", "author": "gino-m", "createdAt": "2020-06-03T22:08:13Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/map/gms/GoogleMapsMapAdapter.java", "diffHunk": "@@ -247,10 +257,21 @@ public LatLngBounds getViewport() {\n   }\n \n   @Override\n-  public void renderTileOverlay() {\n-    try (MapBoxOfflineTileProvider tileProvider =\n-        new MapBoxOfflineTileProvider(context.getFilesDir())) {\n-      map.addTileOverlay(new TileOverlayOptions().tileProvider(tileProvider));\n-    }\n+  public void renderTileOverlays(ImmutableSet<String> mbtilesFiles) {\n+    stream(mbtilesFiles)\n+        .forEach(\n+            path -> {\n+              File mbtiles = new File(context.getFilesDir(), path);\n+              if (mbtiles.exists()) {", "originalCommit": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3ODgzOQ==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435278839", "bodyText": "57cb7dd", "author": "scolsen", "createdAt": "2020-06-04T13:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NTA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NTQ0Nw==", "url": "https://github.com/google/ground-android/pull/489#discussion_r434885447", "bodyText": "Could you kindly add a TODO and Code health task to create our own wrapper interface/impl for these?", "author": "gino-m", "createdAt": "2020-06-03T22:09:15Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerViewModel.java", "diffHunk": "@@ -59,12 +64,15 @@\n   private final Subject<Boolean> locationLockChangeRequests;\n   private final Subject<CameraUpdate> cameraUpdateSubject;\n   private final MutableLiveData<Event<Nil>> showMapTypeSelectorRequests = new MutableLiveData<>();\n+  private final LiveData<ImmutableSet<String>> mbtiles;\n+  private final List<MapBoxOfflineTileProvider> tileProviders = new ArrayList<>();", "originalCommit": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI5MTE1Nw==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435291157", "bodyText": "f9a41a2", "author": "scolsen", "createdAt": "2020-06-04T14:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NTQ0Nw=="}], "type": "inlineReview"}, {"oid": "57cb7dd9d31e68d8c97168a3778b7bcb62c173f7", "url": "https://github.com/google/ground-android/commit/57cb7dd9d31e68d8c97168a3778b7bcb62c173f7", "message": "Refactor renderTileOverlays in MapAdapter\n\n- rename renderTileOverlays -> addTileOverlays\n- convert anonymous lambda into a named helper function\n- short-circuit when tile files aren't found", "committedDate": "2020-06-04T13:55:15Z", "type": "commit"}, {"oid": "f9a41a2650397ca3f118ba6677bb57e2affb43af", "url": "https://github.com/google/ground-android/commit/f9a41a2650397ca3f118ba6677bb57e2affb43af", "message": "Refactor MBTiles handling in MapContainer\n\n- Rename onTileProvider -> queueTileProvider\n- Rename mbtiles -> mbtilesFilePaths\n- Add a TODO to create a generic interface/wrapper for MBtiles providers.", "committedDate": "2020-06-04T14:13:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM2MjgzNA==", "url": "https://github.com/google/ground-android/pull/489#discussion_r435362834", "bodyText": "Not sure queue is the right name here, since it implies an actual queue is being used, and not a stream. In this case \"add\" would be correct, since it's really a deferred add operation, but this can be changed later if we like.", "author": "gino-m", "createdAt": "2020-06-04T15:46:52Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -107,7 +107,7 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n         .toObservable()\n         .flatMap(MapAdapter::getTileProviders)\n         .as(disposeOnDestroy(this))\n-        .subscribe(mapContainerViewModel::onTileProvider);\n+        .subscribe(mapContainerViewModel::queueTileProvider);", "originalCommit": "f9a41a2650397ca3f118ba6677bb57e2affb43af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}