{"pr_number": 6607, "pr_title": "Germline CNV WDLs for WGS", "pr_createdAt": "2020-05-18T15:26:34Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6607", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMzUxMA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r427523510", "bodyText": "Can we keep it named PostprocessGermlineCNVCalls, since it's basically doing same work as before", "author": "asmirnov239", "createdAt": "2020-05-19T18:46:50Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -413,99 +441,82 @@ task ScatterIntervals {\n     }\n }\n \n-task PostprocessGermlineCNVCalls {\n+task BundledPostprocessGermlineCNVCalls {", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNjExMQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428816111", "bodyText": "Yes, WDL tasks are pretty much 1:1 with tools and should just reflect the tool name, if possible.", "author": "samuelklee", "createdAt": "2020-05-21T17:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMzUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4OTM0NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428889345", "bodyText": "Done", "author": "mwalker174", "createdAt": "2020-05-21T20:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMzUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNTkzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r427525930", "bodyText": "Can we change invariants  in the name here and elsewhere to something more explicit -- like bundled_gcnv_posteriors or bundled_gcnv_outputs", "author": "asmirnov239", "createdAt": "2020-05-19T18:50:41Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -413,99 +441,82 @@ task ScatterIntervals {\n     }\n }\n \n-task PostprocessGermlineCNVCalls {\n+task BundledPostprocessGermlineCNVCalls {\n     input {\n-      String entity_id\n-      Array[File] gcnv_calls_tars\n-      Array[File] gcnv_model_tars\n-      Array[File] calling_configs\n-      Array[File] denoising_configs\n-      Array[File] gcnvkernel_version\n-      Array[File] sharded_interval_lists\n-      File contig_ploidy_calls_tar\n-      Array[String]? allosomal_contigs\n-      Int ref_copy_number_autosomal_contigs\n-      Int sample_index\n-      File? gatk4_jar_override\n-\n-      # Runtime parameters\n-      String gatk_docker\n-      Int? mem_gb\n-      Int? disk_space_gb\n-      Boolean use_ssd = false\n-      Int? cpu\n-      Int? preemptible_attempts\n+        File invariants_tar", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNjU0MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428816541", "bodyText": "I agree. I still need to read on to figure out what exactly is being bundled, but the name is not super descriptive...", "author": "samuelklee", "createdAt": "2020-05-21T17:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MDIyOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428890229", "bodyText": "Changed to bundled_gcnv_outputs", "author": "mwalker174", "createdAt": "2020-05-21T20:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNjU5MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r427526591", "bodyText": "What's the reason for calling time here?", "author": "asmirnov239", "createdAt": "2020-05-19T18:51:56Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -413,99 +441,82 @@ task ScatterIntervals {\n     }\n }\n \n-task PostprocessGermlineCNVCalls {\n+task BundledPostprocessGermlineCNVCalls {\n     input {\n-      String entity_id\n-      Array[File] gcnv_calls_tars\n-      Array[File] gcnv_model_tars\n-      Array[File] calling_configs\n-      Array[File] denoising_configs\n-      Array[File] gcnvkernel_version\n-      Array[File] sharded_interval_lists\n-      File contig_ploidy_calls_tar\n-      Array[String]? allosomal_contigs\n-      Int ref_copy_number_autosomal_contigs\n-      Int sample_index\n-      File? gatk4_jar_override\n-\n-      # Runtime parameters\n-      String gatk_docker\n-      Int? mem_gb\n-      Int? disk_space_gb\n-      Boolean use_ssd = false\n-      Int? cpu\n-      Int? preemptible_attempts\n+        File invariants_tar\n+        String entity_id\n+        File contig_ploidy_calls_tar\n+        Array[String]? allosomal_contigs\n+        Int ref_copy_number_autosomal_contigs\n+        Int sample_index\n+        File? gatk4_jar_override\n+\n+        # Runtime parameters\n+        String gatk_docker\n+        Int? mem_gb\n+        Int? disk_space_gb\n+        Boolean use_ssd = false\n+        Int? cpu\n+        Int? preemptible_attempts\n     }\n \n     Int machine_mem_mb = select_first([mem_gb, 7]) * 1000\n     Int command_mem_mb = machine_mem_mb - 1000\n \n+    Float invariants_size = size(invariants_tar, \"GiB\")\n+    Float disk_overhead = 20.0\n+    Float tar_disk_factor= 5.0\n+    Int vm_disk_size = ceil(tar_disk_factor * invariants_size + disk_overhead)\n+\n     String genotyped_intervals_vcf_filename = \"genotyped-intervals-~{entity_id}.vcf.gz\"\n     String genotyped_segments_vcf_filename = \"genotyped-segments-~{entity_id}.vcf.gz\"\n     String denoised_copy_ratios_filename = \"denoised_copy_ratios-~{entity_id}.tsv\"\n \n     Array[String] allosomal_contigs_args = if defined(allosomal_contigs) then prefix(\"--allosomal-contig \", select_first([allosomal_contigs])) else []\n \n     command <<<\n-        set -eu\n-        export GATK_LOCAL_JAR=~{default=\"/root/gatk.jar\" gatk4_jar_override}\n+        set -euo pipefail\n \n-        sharded_interval_lists_array=(~{sep=\" \" sharded_interval_lists})\n+        export GATK_LOCAL_JAR=~{default=\"/root/gatk.jar\" gatk4_jar_override}\n \n         # untar calls to CALLS_0, CALLS_1, etc directories and build the command line\n         # also copy over shard config and interval files\n-        gcnv_calls_tar_array=(~{sep=\" \" gcnv_calls_tars})\n-        calling_configs_array=(~{sep=\" \" calling_configs})\n-        denoising_configs_array=(~{sep=\" \" denoising_configs})\n-        gcnvkernel_version_array=(~{sep=\" \" gcnvkernel_version})\n-        sharded_interval_lists_array=(~{sep=\" \" sharded_interval_lists})\n-        calls_args=\"\"\n-        for index in ${!gcnv_calls_tar_array[@]}; do\n-            gcnv_calls_tar=${gcnv_calls_tar_array[$index]}\n-            mkdir -p CALLS_$index/SAMPLE_~{sample_index}\n-            tar xzf $gcnv_calls_tar -C CALLS_$index/SAMPLE_~{sample_index}\n-            cp ${calling_configs_array[$index]} CALLS_$index/\n-            cp ${denoising_configs_array[$index]} CALLS_$index/\n-            cp ${gcnvkernel_version_array[$index]} CALLS_$index/\n-            cp ${sharded_interval_lists_array[$index]} CALLS_$index/\n-            calls_args=\"$calls_args --calls-shard-path CALLS_$index\"\n-        done\n-\n-        # untar models to MODEL_0, MODEL_1, etc directories and build the command line\n-        gcnv_model_tar_array=(~{sep=\" \" gcnv_model_tars})\n-        model_args=\"\"\n-        for index in ${!gcnv_model_tar_array[@]}; do\n-            gcnv_model_tar=${gcnv_model_tar_array[$index]}\n-            mkdir MODEL_$index\n-            tar xzf $gcnv_model_tar -C MODEL_$index\n-            model_args=\"$model_args --model-shard-path MODEL_$index\"\n+        tar xzf ~{invariants_tar}\n+        rm ~{invariants_tar}\n+        number_of_shards=`find . -name 'CALLS_*' | wc -l`\n+\n+        touch calls_and_model_args.txt\n+        for i in $(seq 0 `expr $number_of_shards - 1`); do\n+            echo \"--calls-shard-path CALLS_$i\" >> calls_and_model_args.txt\n+            echo \"--model-shard-path MODEL_$i\" >> calls_and_model_args.txt\n         done\n \n-        mkdir contig-ploidy-calls\n-        tar xzf ~{contig_ploidy_calls_tar} -C contig-ploidy-calls\n+        mkdir -p extracted-contig-ploidy-calls\n+        tar xzf ~{contig_ploidy_calls_tar} -C extracted-contig-ploidy-calls\n+        rm ~{contig_ploidy_calls_tar}\n \n-        gatk --java-options \"-Xmx~{command_mem_mb}m\" PostprocessGermlineCNVCalls \\\n-            $calls_args \\\n-            $model_args \\\n+        time gatk --java-options \"-Xmx~{command_mem_mb}m\" PostprocessGermlineCNVCalls \\", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MDY3MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428890671", "bodyText": "Looks like a relic from when we were optimizing for wgs. Removed time", "author": "mwalker174", "createdAt": "2020-05-21T20:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNjU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3ODcxOA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r427578718", "bodyText": "We seem to be hitting an error in our Travis gCNV WDL tests -\n The number of entries in the copy-number posterior file for shard 0 does not match the number of entries in the shard interval list (posterior list size: 21, interval list size: 20)\nIs it possible that some mismatch between shards is introduced here?", "author": "asmirnov239", "createdAt": "2020-05-19T20:26:26Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -605,3 +616,122 @@ task CollectModelQualityMetrics {\n         String qc_status_string = read_string(\"qcStatus.txt\")\n     }\n }\n+\n+task BundlePostprocessingInvariants {\n+    input {\n+      Array[File] calls_tars\n+      Array[File] model_tars\n+      Array[File] calling_configs\n+      Array[File] denoising_configs\n+      Array[File] gcnvkernel_version\n+      Array[File] sharded_interval_lists\n+\n+      # Runtime parameters\n+      String docker\n+      Int? mem_gb\n+      Int? disk_space_gb\n+      Boolean use_ssd = false\n+      Int? cpu\n+      Int? preemptible_attempts\n+    }\n+\n+    command <<<\n+        set -euo pipefail\n+        mkdir -p out\n+\n+        calls_files_tar_list=~{write_lines(calls_tars)}\n+        model_files_tar_list=~{write_lines(model_tars)}\n+\n+        calling_configs_list=~{write_lines(calling_configs)}\n+        denoising_configs_list=~{write_lines(denoising_configs)}\n+        gcnvkernel_version_list=~{write_lines(gcnvkernel_version)}\n+        sharded_interval_lists_list=~{write_lines(sharded_interval_lists)}\n+\n+        cat $calls_files_tar_list | sort -V > calls_files_tar_list.sorted\n+        cat $model_files_tar_list | sort -V > model_files_tar_list.sorted\n+\n+        cat $calling_configs_list | sort -V > calling_configs_list.sorted\n+        cat $denoising_configs_list | sort -V > denoising_configs_list.sorted\n+        cat $gcnvkernel_version_list | sort -V > gcnvkernel_version_list.sorted\n+        cat $sharded_interval_lists_list | sort -V > sharded_interval_lists_list.sorted", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxNjE2Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r434016167", "bodyText": "Hm not sure what was happening there, especially since my own tests completed successfully. But my latest changes don't seem to be triggering this error.", "author": "mwalker174", "createdAt": "2020-06-02T16:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3ODcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3OTA2MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r427579061", "bodyText": "Same here for invariant name as above", "author": "asmirnov239", "createdAt": "2020-05-19T20:27:06Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -605,3 +616,122 @@ task CollectModelQualityMetrics {\n         String qc_status_string = read_string(\"qcStatus.txt\")\n     }\n }\n+\n+task BundlePostprocessingInvariants {", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxOTc5Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428819793", "bodyText": "Maybe some comments to indicate what this task is doing.", "author": "samuelklee", "createdAt": "2020-05-21T18:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3OTA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5NzM5Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428897397", "bodyText": "Renamed to BundleCallerOutputs", "author": "mwalker174", "createdAt": "2020-05-21T20:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3OTA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxNjY1MA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r434016650", "bodyText": "Actually in my latest commit this is now a TransposeCallerOutputs", "author": "mwalker174", "createdAt": "2020-06-02T16:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3OTA2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc4NTg5Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428785897", "bodyText": "I might just put this ternary all on one line (or make the style of optional arrays like allosomal-contigs below consistent).", "author": "samuelklee", "createdAt": "2020-05-21T16:59:55Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -201,10 +202,27 @@ task CollectCounts {\n       Int? preemptible_attempts\n     }\n \n+    parameter_meta {\n+      bam: {\n+        localization_optional: true\n+      }\n+      bam_idx: {\n+        localization_optional: true\n+      }\n+    }\n+\n     Int machine_mem_mb = select_first([mem_gb, 7]) * 1000\n     Int command_mem_mb = machine_mem_mb - 1000\n \n     Boolean enable_indexing_ = select_first([enable_indexing, false])\n+    Array[String] disabled_read_filters_arr = if(defined(disabled_read_filters))", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxOTQyNg==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r434019426", "bodyText": "Done", "author": "mwalker174", "createdAt": "2020-06-02T16:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc4NTg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNjkyNA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428816924", "bodyText": "Is this something that should be changed throughout all CNV WDLs?", "author": "samuelklee", "createdAt": "2020-05-21T17:55:40Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -413,99 +441,82 @@ task ScatterIntervals {\n     }\n }\n \n-task PostprocessGermlineCNVCalls {\n+task BundledPostprocessGermlineCNVCalls {\n     input {\n-      String entity_id\n-      Array[File] gcnv_calls_tars\n-      Array[File] gcnv_model_tars\n-      Array[File] calling_configs\n-      Array[File] denoising_configs\n-      Array[File] gcnvkernel_version\n-      Array[File] sharded_interval_lists\n-      File contig_ploidy_calls_tar\n-      Array[String]? allosomal_contigs\n-      Int ref_copy_number_autosomal_contigs\n-      Int sample_index\n-      File? gatk4_jar_override\n-\n-      # Runtime parameters\n-      String gatk_docker\n-      Int? mem_gb\n-      Int? disk_space_gb\n-      Boolean use_ssd = false\n-      Int? cpu\n-      Int? preemptible_attempts\n+        File invariants_tar\n+        String entity_id\n+        File contig_ploidy_calls_tar\n+        Array[String]? allosomal_contigs\n+        Int ref_copy_number_autosomal_contigs\n+        Int sample_index\n+        File? gatk4_jar_override\n+\n+        # Runtime parameters\n+        String gatk_docker\n+        Int? mem_gb\n+        Int? disk_space_gb\n+        Boolean use_ssd = false\n+        Int? cpu\n+        Int? preemptible_attempts\n     }\n \n     Int machine_mem_mb = select_first([mem_gb, 7]) * 1000\n     Int command_mem_mb = machine_mem_mb - 1000\n \n+    Float invariants_size = size(invariants_tar, \"GiB\")\n+    Float disk_overhead = 20.0\n+    Float tar_disk_factor= 5.0\n+    Int vm_disk_size = ceil(tar_disk_factor * invariants_size + disk_overhead)\n+\n     String genotyped_intervals_vcf_filename = \"genotyped-intervals-~{entity_id}.vcf.gz\"\n     String genotyped_segments_vcf_filename = \"genotyped-segments-~{entity_id}.vcf.gz\"\n     String denoised_copy_ratios_filename = \"denoised_copy_ratios-~{entity_id}.tsv\"\n \n     Array[String] allosomal_contigs_args = if defined(allosomal_contigs) then prefix(\"--allosomal-contig \", select_first([allosomal_contigs])) else []\n \n     command <<<\n-        set -eu\n-        export GATK_LOCAL_JAR=~{default=\"/root/gatk.jar\" gatk4_jar_override}\n+        set -euo pipefail", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMTAyOA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r434021028", "bodyText": "It is good practice, although -o pipefail will have no effect in this task since piping isn't used anywhere", "author": "mwalker174", "createdAt": "2020-06-02T16:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNjkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxODM0OA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428818348", "bodyText": "The task name in the comment section header should match the name of the WDL task.", "author": "samuelklee", "createdAt": "2020-05-21T17:58:07Z", "path": "scripts/cnv_wdl/germline/cnv_germline_case_workflow.wdl", "diffHunk": "@@ -111,11 +112,19 @@ workflow CNVGermlineCaseWorkflow {\n       Float? gcnv_caller_external_admixing_rate\n       Boolean? gcnv_disable_annealing\n \n+      ######################################################\n+      #### arguments for BundlePostprocessingInvariants ####\n+      ######################################################\n+      Int? mem_gb_for_bundle_postprocessing_invariants\n+      Int? disk_space_gb_for_bundle_postprocessing_invariants\n+\n       ###################################################\n       #### arguments for PostprocessGermlineCNVCalls ####\n       ###################################################\n       Int ref_copy_number_autosomal_contigs\n       Array[String]? allosomal_contigs\n+      Int? disk_space_gb_for_postprocess_germline_cnv_calls", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyNDUxMg==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r434024512", "bodyText": "Done", "author": "mwalker174", "createdAt": "2020-06-02T16:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxODM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyOTYyOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428829629", "bodyText": "I think the way this is originally done in the gCNV tasks is more robust to the maximum number of samples.", "author": "samuelklee", "createdAt": "2020-05-21T18:18:55Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -605,3 +616,122 @@ task CollectModelQualityMetrics {\n         String qc_status_string = read_string(\"qcStatus.txt\")\n     }\n }\n+\n+task BundlePostprocessingInvariants {\n+    input {\n+      Array[File] calls_tars\n+      Array[File] model_tars\n+      Array[File] calling_configs\n+      Array[File] denoising_configs\n+      Array[File] gcnvkernel_version\n+      Array[File] sharded_interval_lists\n+\n+      # Runtime parameters\n+      String docker\n+      Int? mem_gb\n+      Int? disk_space_gb\n+      Boolean use_ssd = false\n+      Int? cpu\n+      Int? preemptible_attempts\n+    }\n+\n+    command <<<\n+        set -euo pipefail\n+        mkdir -p out\n+\n+        calls_files_tar_list=~{write_lines(calls_tars)}\n+        model_files_tar_list=~{write_lines(model_tars)}\n+\n+        calling_configs_list=~{write_lines(calling_configs)}\n+        denoising_configs_list=~{write_lines(denoising_configs)}\n+        gcnvkernel_version_list=~{write_lines(gcnvkernel_version)}\n+        sharded_interval_lists_list=~{write_lines(sharded_interval_lists)}\n+\n+        cat $calls_files_tar_list | sort -V > calls_files_tar_list.sorted\n+        cat $model_files_tar_list | sort -V > model_files_tar_list.sorted\n+\n+        cat $calling_configs_list | sort -V > calling_configs_list.sorted\n+        cat $denoising_configs_list | sort -V > denoising_configs_list.sorted\n+        cat $gcnvkernel_version_list | sort -V > gcnvkernel_version_list.sorted\n+        cat $sharded_interval_lists_list | sort -V > sharded_interval_lists_list.sorted\n+\n+        paste calls_files_tar_list.sorted model_files_tar_list.sorted calling_configs_list.sorted denoising_configs_list.sorted gcnvkernel_version_list.sorted sharded_interval_lists_list.sorted |\\\n+              awk '{print (NR-1)\"\\t\"$0}' > file_sets.sorted\n+        OIFS=$IFS\n+        IFS=$'\\t'\n+        while read index calls_tar model_tar call_config denoise version intervals; do\n+            mkdir -p out/CALLS_$index\n+            mkdir -p out/MODEL_$index\n+            tar xzf $calls_tar -C out/CALLS_$index\n+            tar xzf $model_tar -C out/MODEL_$index\n+            cp $call_config out/CALLS_$index\n+            cp $denoise out/CALLS_$index\n+            cp $version out/CALLS_$index\n+            cp $intervals out/CALLS_$index\n+            rm $calls_tar $model_tar $call_config $denoise $version $intervals\n+\n+        done < file_sets.sorted\n+        IFS=$OIFS\n+\n+        tar c -C out . | gzip -1 > case-gcnv-postprocessing-invariants.tar.gz\n+        rm -Rf out\n+    >>>\n+\n+    runtime {\n+        docker: docker\n+        memory: select_first([mem_gb, 2]) + \" GiB\"\n+        disks: \"local-disk \" + select_first([disk_space_gb, 150]) + if use_ssd then \" SSD\" else \" HDD\"\n+        cpu: select_first([cpu, 1])\n+        preemptible: select_first([preemptible_attempts, 5])\n+    }\n+\n+    output {\n+        File bundle_tar = \"case-gcnv-postprocessing-invariants.tar.gz\"\n+    }\n+}\n+\n+task ScatterPloidyCallsBySample {\n+    input {\n+      File contig_ploidy_calls_tar\n+      Array[String] samples\n+\n+      # Runtime parameters\n+      String docker\n+      Int? mem_gb\n+      Int? disk_space_gb\n+      Boolean use_ssd = false\n+      Int? cpu\n+      Int? preemptible_attempts\n+    }\n+\n+    Int num_samples = length(samples)\n+    String out_dir = \"calls_renamed\"\n+\n+    command <<<\n+      set -eu\n+\n+      # Extract ploidy calls\n+      mkdir calls\n+      tar xzf ~{contig_ploidy_calls_tar} -C calls/\n+\n+      # Archive call files by sample, renaming so they will be glob'd in order\n+      sample_ids=(~{sep=\" \" samples})\n+      for (( i=0; i<~{num_samples}; i++ ))\n+      do\n+        sample_id=${sample_ids[$i]}\n+        sample_no=`printf %04d $i`", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzMTg2Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428831863", "bodyText": "Also, why is the renaming added to the ploidy calls here, but removed from the gCNV calls? Are those guaranteed to line up?", "author": "samuelklee", "createdAt": "2020-05-21T18:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyOTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyODI4NA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r436828284", "bodyText": "Added dynamic scaling of the sample index padding. I don't think we need sample ids in the call tars since these are only consumed internally. The sample order will be the same between the input bam array and SAMPLE_ subdirectories that gCNV creates, so they will line up.", "author": "mwalker174", "createdAt": "2020-06-08T16:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyOTYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzNDU3Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r428834577", "bodyText": "Does it make sense to flatten some of these quantities?", "author": "samuelklee", "createdAt": "2020-05-21T18:28:00Z", "path": "scripts/cnv_wdl/germline/cnv_germline_case_scattered_workflow.wdl", "diffHunk": "@@ -196,16 +198,16 @@ workflow CNVGermlineCaseScatteredWorkflow {\n \n     output {\n         Array[File] preprocessed_intervals = CNVGermlineCaseWorkflow.preprocessed_intervals\n-        Array[Array[File]] read_counts_entity_id = CNVGermlineCaseWorkflow.read_counts_entity_id\n-        Array[Array[File]] read_counts = CNVGermlineCaseWorkflow.read_counts\n-        Array[File] contig_ploidy_calls_tars = CNVGermlineCaseWorkflow.contig_ploidy_calls_tar\n-        Array[Array[Array[File]]] gcnv_calls_tars = CNVGermlineCaseWorkflow.gcnv_calls_tars\n-        Array[Array[File]] gcnv_tracking_tars = CNVGermlineCaseWorkflow.gcnv_tracking_tars\n-        Array[Array[File]] genotyped_intervals_vcf = CNVGermlineCaseWorkflow.genotyped_intervals_vcf\n-        Array[Array[File]] genotyped_segments_vcf = CNVGermlineCaseWorkflow.genotyped_segments_vcf\n-        Array[Array[File]] qc_status_files = CNVGermlineCaseWorkflow.qc_status_files\n-        Array[Array[String]] qc_status_strings = CNVGermlineCaseWorkflow.qc_status_strings\n-        Array[Array[File]] denoised_copy_ratios = CNVGermlineCaseWorkflow.denoised_copy_ratios\n+        Array[File] read_counts_entity_id = flatten(CNVGermlineCaseWorkflow.read_counts_entity_id)\n+        Array[File] read_counts = flatten(CNVGermlineCaseWorkflow.read_counts)\n+        Array[File] sample_contig_ploidy_calls_tars = flatten(CNVGermlineCaseWorkflow.sample_contig_ploidy_calls_tars)\n+        Array[File] gcnv_calls_tars = flatten(CNVGermlineCaseWorkflow.gcnv_calls_tars)", "originalCommit": "f146f664851417ad76d584d40e8995676fcd8447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMDI1MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r436830251", "bodyText": "You're right I shouldn't flatten sample_contig_ploidy_calls_tars and gcnv_calls_tars, but the rest are sample-wise and will correspond to the size/order of the input bams", "author": "mwalker174", "createdAt": "2020-06-08T16:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzNDU3Nw=="}], "type": "inlineReview"}, {"oid": "3931c8d1c51f5d0efa5cc18a120b275cd1c8407d", "url": "https://github.com/broadinstitute/gatk/commit/3931c8d1c51f5d0efa5cc18a120b275cd1c8407d", "message": "Transpose instead of bundling", "committedDate": "2020-06-01T20:43:33Z", "type": "forcePushed"}, {"oid": "13317db8dce5d7fa1265fb37b222bc63dc3bc7fd", "url": "https://github.com/broadinstitute/gatk/commit/13317db8dce5d7fa1265fb37b222bc63dc3bc7fd", "message": "Fix unflattened output error in CNVGermlineCaseScatteredWorkflow", "committedDate": "2020-06-11T19:42:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzQ2MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r446337461", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                runtime {\n          \n          \n            \n                    docker: docker\n          \n          \n            \n                    memory: select_first([mem_gb, 2]) + \" GiB\"\n          \n          \n            \n                    disks: \"local-disk \" + select_first([disk_space_gb, 150]) + if use_ssd then \" SSD\" else \" HDD\"\n          \n          \n            \n                Int disk_baseline_gb_ = 10\n          \n          \n            \n                Float compression_factor = 10.0\n          \n          \n            \n                Int disk_needed_gb = disk_baseline_gb + ceil(compression_factor * size(gcnv_calls_tars, \"GiB\"))\n          \n          \n            \n                \n          \n          \n            \n                runtime {\n          \n          \n            \n                    docker: docker\n          \n          \n            \n                    memory: select_first([mem_gb, 2]) + \" GiB\"\n          \n          \n            \n                    disks: \"local-disk \" + select_first([disk_space_gb, disk_needed_gb]) + if use_ssd then \" SSD\" else \" HDD\"\n          \n      \n    \n    \n  \n\nI don't see memory being a problem here, but these kinds of tasks have been running of out disk on larger panels. This should be conservative enough without being super wasteful.", "author": "TedBrookings", "createdAt": "2020-06-26T18:13:08Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -605,3 +612,100 @@ task CollectModelQualityMetrics {\n         String qc_status_string = read_string(\"qcStatus.txt\")\n     }\n }\n+\n+task TransposeCallerOutputs {\n+    input {\n+      Array[File] gcnv_calls_tars\n+\n+      # Runtime parameters\n+      String docker\n+      Int? mem_gb\n+      Int? disk_space_gb\n+      Boolean use_ssd = false\n+      Int? cpu\n+      Int? preemptible_attempts\n+    }\n+\n+    command <<<\n+        set -euo pipefail\n+\n+        gcnv_calls_tar_array=(~{sep=\" \" gcnv_calls_tars})\n+        for index in ${!gcnv_calls_tar_array[@]}; do\n+            mkdir CALLS_$index\n+            tar xzf ${gcnv_calls_tar_array[$index]} -C CALLS_$index\n+        done\n+\n+        CURRENT_SAMPLE=0\n+        NUM_SAMPLES=$(ls -d CALLS_0/SAMPLE_* | wc -l)\n+        NUM_DIGITS=${#NUM_SAMPLES}\n+        while [ $CURRENT_SAMPLE -lt $NUM_SAMPLES ]; do\n+            CURRENT_SAMPLE_WITH_LEADING_ZEROS=$(printf \"%0${NUM_DIGITS}d\" $CURRENT_SAMPLE)\n+            tar c CALLS_*/SAMPLE_$CURRENT_SAMPLE | gzip -1 > gcnv-calls-sample-$CURRENT_SAMPLE_WITH_LEADING_ZEROS.tar.gz\n+            let CURRENT_SAMPLE=CURRENT_SAMPLE+1\n+        done\n+\n+        rm -r CALLS_*/SAMPLE_*\n+        tar c CALLS_* | gzip -1 > gcnv-shard-configs.tar.gz\n+    >>>\n+\n+    runtime {\n+        docker: docker\n+        memory: select_first([mem_gb, 2]) + \" GiB\"\n+        disks: \"local-disk \" + select_first([disk_space_gb, 150]) + if use_ssd then \" SSD\" else \" HDD\"", "originalCommit": "13317db8dce5d7fa1265fb37b222bc63dc3bc7fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxODQ5OA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r462418498", "bodyText": "Thanks. This would have been good but it turns out we aren't using this task. It might be useful to have automatic scaling for the rest of the gCNV tasks but I'll leave this for later work.", "author": "mwalker174", "createdAt": "2020-07-29T16:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzQ2MQ=="}], "type": "inlineReview"}, {"oid": "eb99158cc87ca837ccf7ecca023893626dcc8a5e", "url": "https://github.com/broadinstitute/gatk/commit/eb99158cc87ca837ccf7ecca023893626dcc8a5e", "message": "gCNV WDLs for WGS", "committedDate": "2020-07-15T18:22:09Z", "type": "commit"}, {"oid": "a7689b4640228287277787c7e1b4570da1cf4490", "url": "https://github.com/broadinstitute/gatk/commit/a7689b4640228287277787c7e1b4570da1cf4490", "message": "Start addressing reviewer comments", "committedDate": "2020-07-15T18:22:09Z", "type": "commit"}, {"oid": "af0d56f554452607eafcdfdf4efd0fbdc025d5b7", "url": "https://github.com/broadinstitute/gatk/commit/af0d56f554452607eafcdfdf4efd0fbdc025d5b7", "message": "Transpose instead of bundling", "committedDate": "2020-07-15T18:22:09Z", "type": "commit"}, {"oid": "5f2949227728dec920e66f7423850db463474c40", "url": "https://github.com/broadinstitute/gatk/commit/5f2949227728dec920e66f7423850db463474c40", "message": "Address comments; bundle auxiliary calls files", "committedDate": "2020-07-15T18:22:10Z", "type": "commit"}, {"oid": "d29a0051fa080438a69aeb87dcedee70e2f1532f", "url": "https://github.com/broadinstitute/gatk/commit/d29a0051fa080438a69aeb87dcedee70e2f1532f", "message": "Pad sample index in ScatterPloidyCallsBySample", "committedDate": "2020-07-15T18:22:10Z", "type": "commit"}, {"oid": "e00692bc41b3285b65e2313d0bf18e7a8be800e7", "url": "https://github.com/broadinstitute/gatk/commit/e00692bc41b3285b65e2313d0bf18e7a8be800e7", "message": "Fix unflattened output error in CNVGermlineCaseScatteredWorkflow", "committedDate": "2020-07-15T18:22:10Z", "type": "commit"}, {"oid": "70847757def8e187bd3c96cb3d9f86c86de085b4", "url": "https://github.com/broadinstitute/gatk/commit/70847757def8e187bd3c96cb3d9f86c86de085b4", "message": "Revert back to 2d file array", "committedDate": "2020-07-15T18:22:10Z", "type": "commit"}, {"oid": "70847757def8e187bd3c96cb3d9f86c86de085b4", "url": "https://github.com/broadinstitute/gatk/commit/70847757def8e187bd3c96cb3d9f86c86de085b4", "message": "Revert back to 2d file array", "committedDate": "2020-07-15T18:22:10Z", "type": "forcePushed"}, {"oid": "57680ecd55d48bfe4389765952f70e89cdf8e6eb", "url": "https://github.com/broadinstitute/gatk/commit/57680ecd55d48bfe4389765952f70e89cdf8e6eb", "message": "Delete transpose task inputs", "committedDate": "2020-07-29T15:23:59Z", "type": "commit"}, {"oid": "d24b40bb2ea03ab0ba0a07e2615948c13e66991b", "url": "https://github.com/broadinstitute/gatk/commit/d24b40bb2ea03ab0ba0a07e2615948c13e66991b", "message": "Fix minor error", "committedDate": "2020-08-10T14:28:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxMzIzOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r468313239", "bodyText": "Space here for consistency", "author": "asmirnov239", "createdAt": "2020-08-11T04:02:00Z", "path": "scripts/cnv_wdl/cnv_common_tasks.wdl", "diffHunk": "@@ -605,3 +627,51 @@ task CollectModelQualityMetrics {\n         String qc_status_string = read_string(\"qcStatus.txt\")\n     }\n }\n+\n+task ScatterPloidyCallsBySample {\n+    input {\n+      File contig_ploidy_calls_tar\n+      Array[String] samples\n+\n+      # Runtime parameters\n+      String docker\n+      Int? mem_gb\n+      Int? disk_space_gb\n+      Boolean use_ssd = false\n+      Int? cpu\n+      Int? preemptible_attempts\n+    }\n+\n+    Int num_samples = length(samples)\n+    String out_dir = \"calls_renamed\"\n+\n+    command <<<\n+      set -eu\n+\n+      # Extract ploidy calls\n+      mkdir calls\n+      tar xzf ~{contig_ploidy_calls_tar} -C calls/\n+\n+      # Archive call files by sample, renaming so they will be glob'd in order\n+      sample_ids=(~{sep=\" \" samples})\n+      num_samples=~{num_samples}\n+      num_digits=${#num_samples}\n+      for (( i=0; i<~{num_samples}; i++ ))\n+      do\n+        sample_id=${sample_ids[$i]}\n+        padded_sample_index=$(printf \"%0${num_digits}d\" $i)\n+        tar -czf sample_${padded_sample_index}.${sample_id}.contig_ploidy_calls.tar.gz -C calls/SAMPLE_${i} .\n+      done\n+    >>>", "originalCommit": "d24b40bb2ea03ab0ba0a07e2615948c13e66991b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNjQ0Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r468706447", "bodyText": "Done", "author": "mwalker174", "createdAt": "2020-08-11T16:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxMzIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNTg3OA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r468315878", "bodyText": "Can you explain this change? Also, why is it not in cohort mode as well?", "author": "asmirnov239", "createdAt": "2020-08-11T04:13:35Z", "path": "scripts/cnv_wdl/germline/cnv_germline_case_workflow.wdl", "diffHunk": "@@ -314,7 +326,7 @@ task DetermineGermlineContigPloidyCaseMode {\n             --mapping-error-rate ~{default=\"0.01\" mapping_error_rate} \\\n             --sample-psi-scale ~{default=\"0.0001\" sample_psi_scale}\n \n-        tar czf case-contig-ploidy-calls.tar.gz -C ~{output_dir_}/case-calls .\n+        tar c -C ~{output_dir_}/case-calls . | gzip -1 > case-contig-ploidy-calls.tar.gz", "originalCommit": "d24b40bb2ea03ab0ba0a07e2615948c13e66991b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNTkzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6607#discussion_r468705930", "bodyText": "Faster compression with gzip -1 I believe. This is okay in case mode since the calls tars aren't usually kept in storage except as intermediates, so the tradeoff with larger file size doesn't outweigh the cost of compressing/decompressing on VMs.", "author": "mwalker174", "createdAt": "2020-08-11T16:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNTg3OA=="}], "type": "inlineReview"}, {"oid": "aa66473cda7763e62dcea1c1ff1f6d9a04e022f9", "url": "https://github.com/broadinstitute/gatk/commit/aa66473cda7763e62dcea1c1ff1f6d9a04e022f9", "message": "Add space", "committedDate": "2020-08-11T16:23:18Z", "type": "commit"}]}