{"pr_number": 6885, "pr_title": "Exposed Smith-Waterman parameters in HaplotypeCaller, Mutect2, and FilterAlignmentArtifacts.", "pr_createdAt": "2020-10-14T00:27:55Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6885", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTgzMDI5OA==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r681830298", "bodyText": "Here's the aforementioned optimization.", "author": "samuelklee", "createdAt": "2021-08-03T14:45:34Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/read/CigarUtils.java", "diffHunk": "@@ -175,26 +163,21 @@ public static Cigar calculateCigar(final byte[] refSeq, final byte[] altSeq, fin\n \n         //Note: this is a performance optimization.\n         // If two strings are equal (a O(n) check) then it's trivial to get CIGAR for them.\n-        // Furthermore, if their lengths are equal and their element-by-element comparison yields two or fewer mismatches\n-        // it's also a trivial M-only CIGAR, because in order to have equal length one would need at least one insertion and\n-        // one deletion, in which case two substitutions is a better alignment.\n-        if (altSeq.length == refSeq.length){\n-            int mismatchCount = 0;\n-            for (int n = 0; n < refSeq.length && mismatchCount <= 2; n++) {\n-                mismatchCount += (altSeq[n] == refSeq[n] ? 0 : 1);\n-            }\n-            if (mismatchCount <= 2) {\n-                final Cigar matching = new Cigar();\n-                matching.add(new CigarElement(refSeq.length, CigarOperator.MATCH_OR_MISMATCH));\n-                return matching;\n-            }\n+        //TODO: in addressing http://github.com/broadinstitute/gatk/issues/6863,", "originalCommit": "c84a0a5188dd5638350fa7f222a6583147325644", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzQ5MjY3Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r697492676", "bodyText": "Punting, filed #7441. I would like to get a better sense of the applicability and impact of this optimization---from the original issue, seems like it's only relevant for non-hardware SW?", "author": "samuelklee", "createdAt": "2021-08-27T14:35:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTgzMDI5OA=="}], "type": "inlineReview"}, {"oid": "667bd5d5d2fca7a3ffa0db973c0683e6a32d443a", "url": "https://github.com/broadinstitute/gatk/commit/667bd5d5d2fca7a3ffa0db973c0683e6a32d443a", "message": "expose through AssemblyBasedCallerArgumentCollection", "committedDate": "2021-08-03T17:33:16Z", "type": "forcePushed"}, {"oid": "036b9affc125aa024e9fa3db04ff2f0a25059003", "url": "https://github.com/broadinstitute/gatk/commit/036b9affc125aa024e9fa3db04ff2f0a25059003", "message": "missed some SWParameters in ReadThreadingGraphUnitTest in the rebase", "committedDate": "2021-08-10T20:21:33Z", "type": "forcePushed"}, {"oid": "ec927130a22558eef799d1e898bb0c5fbb1db6f6", "url": "https://github.com/broadinstitute/gatk/commit/ec927130a22558eef799d1e898bb0c5fbb1db6f6", "message": "added integration tests for HC and M2", "committedDate": "2021-08-11T18:41:25Z", "type": "forcePushed"}, {"oid": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "url": "https://github.com/broadinstitute/gatk/commit/b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "message": "added integration tests for HC and M2", "committedDate": "2021-08-11T19:14:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzEwNTk5MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r687105991", "bodyText": "Reminder to fix this and analogous parameter docs up, if needed.", "author": "samuelklee", "createdAt": "2021-08-11T19:15:55Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/readthreading/AbstractReadThreadingGraph.java", "diffHunk": "@@ -656,14 +653,14 @@ int mergeDanglingHead(final DanglingChainMergeHelper danglingHeadMergeResult) {\n      * Generates the CIGAR string from the Smith-Waterman alignment of the dangling path (where the\n      * provided vertex is the sink) and the reference path.\n      *\n-     * @param aligner\n      * @param vertex      the sink of the dangling chain\n      * @param pruneFactor the prune factor to use in ignoring chain pieces if edge multiplicity is < pruneFactor\n      * @param recoverAll  recover even branches with forks\n+     * @param danglingTailSWParameters", "originalCommit": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjgyODkzMw==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r696828933", "bodyText": "Just another reminder to fix this doc.", "author": "fleharty", "createdAt": "2021-08-26T17:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzEwNTk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzQ4Mjk5MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r697482991", "bodyText": "Just removed it; looks like param docs aren't exhaustive in this class.", "author": "samuelklee", "createdAt": "2021-08-27T14:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzEwNTk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzEwNzE4Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r687107187", "bodyText": "SmithWaterman -> Smith-Waterman", "author": "samuelklee", "createdAt": "2021-08-11T19:17:57Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/readthreading/ReadThreadingAssembler.java", "diffHunk": "@@ -300,13 +305,14 @@ private void assembleGraphsAndExpandKmersGivenHaplotypes(final Haplotype refHapl\n      * @param activeRegionWindow    window of the active region (without padding)\n      * @param resultSet             (can be null) the results set into which to deposit discovered haplotypes\n      * @param aligner               SmithWaterman aligner to use for aligning the discovered haplotype to the reference haplotype\n+     * @param haplotypeToReferenceSWParameters SmithWaterman parameters to use for aligning the discovered haplotype to the reference haplotype", "originalCommit": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjgzMjQzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r696832430", "bodyText": "For consistency, make sure you get line 307 too", "author": "fleharty", "createdAt": "2021-08-26T17:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzEwNzE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NzE3MjA1Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r687172057", "bodyText": "Not sure if we really wanted to keep this around...but I took it out.", "author": "samuelklee", "createdAt": "2021-08-11T20:34:39Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/read/AlignmentUtils.java", "diffHunk": "@@ -91,9 +92,6 @@ public static GATKRead createReadAlignedToRef(final GATKRead originalRead,\n         // whether left-alignment shifted the start position.\n         final int readStartOnReferenceHaplotype = readStartOnReferenceHaplotype(rightPaddedHaplotypeVsRefCigar, readToHaplotypeSWAlignment.getAlignmentOffset());\n \n-\n-        //final int readStartOnReference = referenceStart + haplotype.getAlignmentStartHapwrtRef() + readStartOnHaplotype;", "originalCommit": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg0NTg4Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r696845882", "bodyText": "You can be brutally honest if you like and say, \"These parameters have not been rigorously optimized\"\nbut I'll leave that decision to you.", "author": "fleharty", "createdAt": "2021-08-26T17:40:21Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/smithwaterman/SmithWatermanAlignmentConstants.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.broadinstitute.hellbender.utils.smithwaterman;\n+\n+import org.broadinstitute.gatk.nativebindings.smithwaterman.SWParameters;\n+import org.broadinstitute.hellbender.tools.walkers.haplotypecaller.readthreading.AbstractReadThreadingGraph;\n+import org.broadinstitute.hellbender.utils.read.AlignmentUtils;\n+import org.broadinstitute.hellbender.utils.read.CigarUtils;\n+\n+/**\n+ * This class collects the various {@link SWParameters} that are used for various alignment procedures.\n+ * It is likely that these parameters have not been rigorously optimized.", "originalCommit": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzQ4ODI4OA==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r697488288", "bodyText": "Let's be generous and leave room for doubt. Perhaps our definitions of \"rigorous\" and \"optimized\" have improved over the years...", "author": "samuelklee", "createdAt": "2021-08-27T14:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg0NTg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg0ODUzNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r696848535", "bodyText": "The NEW_SW_PARAMETERS have now been around for 6 years, is it time to rename this?", "author": "fleharty", "createdAt": "2021-08-26T17:44:11Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/smithwaterman/SmithWatermanAlignmentConstants.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.broadinstitute.hellbender.utils.smithwaterman;\n+\n+import org.broadinstitute.gatk.nativebindings.smithwaterman.SWParameters;\n+import org.broadinstitute.hellbender.tools.walkers.haplotypecaller.readthreading.AbstractReadThreadingGraph;\n+import org.broadinstitute.hellbender.utils.read.AlignmentUtils;\n+import org.broadinstitute.hellbender.utils.read.CigarUtils;\n+\n+/**\n+ * This class collects the various {@link SWParameters} that are used for various alignment procedures.\n+ * It is likely that these parameters have not been rigorously optimized.\n+ * Documentation is also somewhat lacking, but we preserve any original comments that may have accompanied each set.\n+ * See also some relevant issues and comments:\n+ *  <p>\n+ *      <a href=\"http://github.com/broadinstitute/gatk/issues/2498\">http://github.com/broadinstitute/gatk/issues/2498</a>\n+ *      <a href=\"http://github.com/broadinstitute/gatk/issues/5564\">http://github.com/broadinstitute/gatk/issues/5564</a>\n+ *      <a href=\"http://github.com/broadinstitute/gatk/pull/4858#discussion_r194048530\">http://github.com/broadinstitute/gatk/pull/4858#discussion_r194048530</a>\n+ *  </p>\n+ */\n+public final class SmithWatermanAlignmentConstants {\n+    private SmithWatermanAlignmentConstants() {}\n+\n+    /**\n+     * {@code ORIGINAL_DEFAULT} is only used in test code. It is worth noting that these tests are somewhat insensitive\n+     * to the particular values used; (e.g., the majority pass if {@link SmithWatermanAlignmentConstants#STANDARD_NGS}\n+     * is substituted, and all pass if {@link SmithWatermanAlignmentConstants#NEW_SW_PARAMETERS} is substituted).\n+     *\n+     * Original comments:\n+     *      match=1, mismatch = -1/3, gap=-(1+k/3)\n+     */\n+    public static final SWParameters ORIGINAL_DEFAULT = new SWParameters(3, -1, -4, -3);\n+\n+    /**\n+     * {@code STANDARD_NGS} is the default for {@link AbstractReadThreadingGraph} methods for the recovery of dangling heads/tails.\n+     *\n+     * Original comments:\n+     *      none\n+     */\n+    public static final SWParameters STANDARD_NGS = new SWParameters(25, -50, -110, -6);\n+\n+    /**\n+     * {@code NEW_SW_PARAMETERS} is the default for {@link CigarUtils#calculateCigar} for haplotype-to-reference alignment.", "originalCommit": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzQ4ODg4MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r697488881", "bodyText": "I'm going to leave names as is for now to avoid further confusion. However, I do think it's worth renaming everything if/when we consolidate.", "author": "samuelklee", "createdAt": "2021-08-27T14:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg0ODUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg1ODA4Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r696858083", "bodyText": "Why did you chose to use AVX_LOGLESS_CACHING rather than LOGLESS_CACHING?", "author": "fleharty", "createdAt": "2021-08-26T17:57:25Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerIntegrationTest.java", "diffHunk": "@@ -130,6 +130,49 @@ public void testLinkedDebruijnModeIsConsistentWithPastResults(final String input\n         }\n     }\n \n+    /**\n+     * Test that exposure and modification of Smith-Waterman parameters that were previously constants is consistent with past results (over non-complicated data).\n+     * Expected outputs were generated by changing previously hardcoded constants in the previous commit to the exposed values below.\n+     * See https://github.com/broadinstitute/gatk/pull/6885.\n+     */\n+    @Test(dataProvider=\"HaplotypeCallerTestInputs\")\n+    public void testExposureOfSmithWatermanParametersIsConsistentWithPastResults(final String inputFileName, final String referenceFileName) throws Exception {\n+        Utils.resetRandomGenerator();\n+\n+        final File output = createTempFile(\"testExposureOfSmithWatermanParametersIsConsistentWithPastResults\", \".vcf\");\n+        final File expected = new File(TEST_FILES_DIR, \"expected.testExposureOfSmithWatermanParameters.HC.gatk4.vcf\");\n+\n+        final String outputPath = UPDATE_EXACT_MATCH_EXPECTED_OUTPUTS ? expected.getAbsolutePath() : output.getAbsolutePath();\n+\n+        final String[] args = {\n+                \"-I\", inputFileName,\n+                \"-R\", referenceFileName,\n+                \"-L\", \"20:10000000-10100000\",\n+                \"-O\", outputPath,\n+                \"-pairHMM\", \"AVX_LOGLESS_CACHING\",", "originalCommit": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzQ4ODk4Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r697488982", "bodyText": "See below.", "author": "samuelklee", "createdAt": "2021-08-27T14:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg1ODA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg4OTE2Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r696889162", "bodyText": "I suggest using the non AVX... LOGLESS_CACHING instead.\nbecause of this...\n/* Optimized AVX implementation of LOGLESS_CACHING called through JNI. Throws if AVX is not available */", "author": "fleharty", "createdAt": "2021-08-26T18:41:49Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/mutect/Mutect2IntegrationTest.java", "diffHunk": "@@ -927,6 +928,51 @@ public void testFilteringHeaders() {\n         }\n     }\n \n+\n+    @DataProvider(name=\"ExposureOfSmithWatermanParametersTestInputs\")\n+    public Object[][] getExposureOfSmithWatermanParametersTestInputs() {\n+        return new Object[][] {\n+                {NA12878_20_21_WGS_bam, b37_reference_20_21}\n+        };\n+    }\n+\n+    /**\n+     * See {@link org.broadinstitute.hellbender.tools.walkers.haplotypecaller.HaplotypeCallerIntegrationTest#testExposureOfSmithWatermanParametersIsConsistentWithPastResults}.\n+     */\n+    @Test(dataProvider=\"ExposureOfSmithWatermanParametersTestInputs\")\n+    public void testExposureOfSmithWatermanParametersIsConsistentWithPastResults(final String inputFileName, final String referenceFileName) throws Exception {\n+        Utils.resetRandomGenerator();\n+\n+        final File output = createTempFile(\"testExposureOfSmithWatermanParametersIsConsistentWithPastResults\", \".vcf\");\n+        final File expected = new File(toolsTestDir + \"mutect\", \"expected.testExposureOfSmithWatermanParameters.M2.gatk4.vcf\");\n+\n+        final String outputPath = output.getAbsolutePath();\n+\n+        final String[] args = {\n+                \"-I\", inputFileName,\n+                \"-R\", referenceFileName,\n+                \"-L\", \"20:10000000-10100000\",\n+                \"-O\", outputPath,\n+                \"-pairHMM\", \"AVX_LOGLESS_CACHING\",", "originalCommit": "b2b4feab78ef1c18b0f6e272f9b5b5bc55d9fb7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzQ4OTA2MA==", "url": "https://github.com/broadinstitute/gatk/pull/6885#discussion_r697489060", "bodyText": "Same.", "author": "samuelklee", "createdAt": "2021-08-27T14:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5Njg4OTE2Mg=="}], "type": "inlineReview"}, {"oid": "e56a31aa725bab3822f0e0669ec3a505a951d651", "url": "https://github.com/broadinstitute/gatk/commit/e56a31aa725bab3822f0e0669ec3a505a951d651", "message": "extracted constants, added docs, added TSV methods and tests", "committedDate": "2021-08-27T14:19:20Z", "type": "commit"}, {"oid": "a77f83f92e530ed8ecbde68bacaf9e6cfd250c56", "url": "https://github.com/broadinstitute/gatk/commit/a77f83f92e530ed8ecbde68bacaf9e6cfd250c56", "message": "bubbled up ALIGNMENT_TO_BEST_HAPLOTYPE_SW_PARAMETERS", "committedDate": "2021-08-27T14:19:20Z", "type": "commit"}, {"oid": "fbc01611c27a0ca00d45d106140966f1337772eb", "url": "https://github.com/broadinstitute/gatk/commit/fbc01611c27a0ca00d45d106140966f1337772eb", "message": "bubbled up ORIGINAL_DEFAULT", "committedDate": "2021-08-27T14:19:20Z", "type": "commit"}, {"oid": "a1d5f7ef35b08158dcf08d878618eeb3638c88fa", "url": "https://github.com/broadinstitute/gatk/commit/a1d5f7ef35b08158dcf08d878618eeb3638c88fa", "message": "bubbled up NEW_SW_PARAMETERS and reverted calculateCigar optimization", "committedDate": "2021-08-27T14:19:20Z", "type": "commit"}, {"oid": "5626de6c3446454db616e00242a8c476944720b3", "url": "https://github.com/broadinstitute/gatk/commit/5626de6c3446454db616e00242a8c476944720b3", "message": "bubbled up STANDARD_NGS", "committedDate": "2021-08-27T14:19:20Z", "type": "commit"}, {"oid": "900070df097d6fc8123700df550ec72d75dcf8b1", "url": "https://github.com/broadinstitute/gatk/commit/900070df097d6fc8123700df550ec72d75dcf8b1", "message": "exposed parameters through AssemblyBasedCallerArgumentCollection", "committedDate": "2021-08-27T14:19:20Z", "type": "commit"}, {"oid": "3eb7ebab88dde425a69434330658136417ab2d0e", "url": "https://github.com/broadinstitute/gatk/commit/3eb7ebab88dde425a69434330658136417ab2d0e", "message": "rebased with some fixups", "committedDate": "2021-08-27T14:19:20Z", "type": "commit"}, {"oid": "29a096152b1bd57f9c46e894ceb8a9fafdcbac98", "url": "https://github.com/broadinstitute/gatk/commit/29a096152b1bd57f9c46e894ceb8a9fafdcbac98", "message": "replaced TSV input of args with explicit args", "committedDate": "2021-08-27T14:19:21Z", "type": "commit"}, {"oid": "d0724f24af11d2156691374851a80205dfd5e2b3", "url": "https://github.com/broadinstitute/gatk/commit/d0724f24af11d2156691374851a80205dfd5e2b3", "message": "added integration tests for HC and M2", "committedDate": "2021-08-27T14:19:21Z", "type": "commit"}, {"oid": "e09b81102e666d3d3d1241754dc7c4ea887f1afd", "url": "https://github.com/broadinstitute/gatk/commit/e09b81102e666d3d3d1241754dc7c4ea887f1afd", "message": "addressed review comments", "committedDate": "2021-08-27T14:38:33Z", "type": "commit"}, {"oid": "e09b81102e666d3d3d1241754dc7c4ea887f1afd", "url": "https://github.com/broadinstitute/gatk/commit/e09b81102e666d3d3d1241754dc7c4ea887f1afd", "message": "addressed review comments", "committedDate": "2021-08-27T14:38:33Z", "type": "forcePushed"}]}