{"pr_number": 6641, "pr_title": "Enable CRAMs in RevertSamSpark", "pr_createdAt": "2020-06-05T21:18:29Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6641", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2MzAxNw==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438263017", "bodyText": "Remove commented-out code", "author": "droazen", "createdAt": "2020-06-10T16:39:08Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/spark/RevertSamSparkIntegrationTest.java", "diffHunk": "@@ -214,24 +239,35 @@ private void verifyPositiveResults(\n         }\n     }\n \n-    @Test\n-    public void testSanitizeAndDeduplicateRecords() throws Exception {\n-        final File input  = BaseTest.createTempFile(\"test-input-santize-and-deduplicate-records\", \".sam\");\n-        final File output = BaseTest.createTempFile(\"test-output-santize-and-deduplicate-records\", \".sam\");\n+    @DataProvider\n+    public Object[][] getFileTypes(){\n+        return new Object[][] {\n+//                {\".sam\"\"},\n+//                {RevertSam.FileType.bam},\n+//                {RevertSam.FileType.cram},", "originalCommit": "44f8efe51232617cfcfedfe5ad29219a6c620498", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4MzQzNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438383435", "bodyText": "woops", "author": "lbergelson", "createdAt": "2020-06-10T20:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2MzAxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0NjM0Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r441146347", "bodyText": "done", "author": "lbergelson", "createdAt": "2020-06-16T21:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2MzAxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2NTM2OA==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438265368", "bodyText": "This is fine, but should we also add some tests with \"non-basic\" / less trivial bams and crams? Also, we might want to have an explicit test for a cram with an embedded reference.", "author": "droazen", "createdAt": "2020-06-10T16:43:00Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/spark/RevertSamSparkIntegrationTest.java", "diffHunk": "@@ -20,14 +21,16 @@\n @Test(groups = \"Spark\")\n public class RevertSamSparkIntegrationTest extends CommandLineProgramTest {\n \n-    private static List<String> defaultAttributesToClearPlusXT = new ArrayList<String>() {\n+    private static final List<String> defaultAttributesToClearPlusXT = new ArrayList<String>() {\n         private static final long serialVersionUID = 1L;\n         {\n         addAll(RevertSamSpark.DEFAULT_ATTRIBUTES_TO_CLEAR);\n         add(\"XT\");\n     }};\n \n     private final File basicSamToRevert = getTestFile(\"revert_sam_basic.sam\");\n+    private final File basicBamToRevert = getTestFile(\"revert_sam_basic.bam\");\n+    private final File basicCramToRevert = getTestFile(\"revert_sam_basic.cram\");", "originalCommit": "44f8efe51232617cfcfedfe5ad29219a6c620498", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4MzMzMQ==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438383331", "bodyText": "Crams with embedded references currently do not work.", "author": "lbergelson", "createdAt": "2020-06-10T20:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2NTM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4MzU0NA==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438383544", "bodyText": "As james said \"we have as many tests as picard does for their tool\"", "author": "lbergelson", "createdAt": "2020-06-10T20:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2NTM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4NDUzOA==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438384538", "bodyText": "Do we understand why embedded references aren't working? The last HTSJDK release claims that they are now supported (for reading, at least).", "author": "droazen", "createdAt": "2020-06-10T20:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2NTM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyMzc2Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438423763", "bodyText": "Yes.   There are explicit guards in our code that prevent reading crams without references.  We need to remove them but I didn't do that in this pr.", "author": "lbergelson", "createdAt": "2020-06-10T21:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2NTM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MzA0NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438273045", "bodyText": "Update the tool docs to mention that it will also take cram files.", "author": "jamesemery", "createdAt": "2020-06-10T16:56:05Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/spark/RevertSamSpark.java", "diffHunk": "@@ -503,9 +503,8 @@ static String getDefaultExtension(final GATKPathSpecifier inputPath, final FileT\n         if (setting == FileType.dynamic) {\n             if (inputPath.isSam()) {\n                 return FileExtensions.SAM;\n-            }\n-            if (inputPath.isCram()) {\n-                throw new UserException.UnimplementedFeature(\"Input file is a cram. This is currently unsupported for this tool\");\n+            } else if(inputPath.isCram()){", "originalCommit": "44f8efe51232617cfcfedfe5ad29219a6c620498", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0NTc4OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r441145789", "bodyText": "done", "author": "lbergelson", "createdAt": "2020-06-16T21:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MzA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4NjM0Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r438386342", "bodyText": "It might be useful to include in this array of test various output types, like cram and bam. Take this one with a grain of salt as I'm not sure its necessarily the job of THIS tool to test writing functionality for cram.", "author": "jamesemery", "createdAt": "2020-06-10T20:22:38Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/spark/RevertSamSparkIntegrationTest.java", "diffHunk": "@@ -44,45 +47,57 @@\n     @DataProvider(name=\"positiveTestData\")\n     public Object[][] positiveTestData() {\n         return new Object[][] {\n-                {null, false, false, true, true, null, null, Collections.EMPTY_LIST},\n-                {SAMFileHeader.SortOrder.queryname, false, false, true, false, \"Hey,Dad!\", null, defaultAttributesToClearPlusXT},\n-                {null, true, false, false, false, \"Hey,Dad!\", \"NewLibraryName\", defaultAttributesToClearPlusXT},\n-                {null, true, true, false, false, null, null, Collections.EMPTY_LIST}\n+                {basicSamToRevert, null, false, false, true, true, null, null, Collections.EMPTY_LIST},\n+                {basicSamToRevert, SAMFileHeader.SortOrder.queryname, false, false, true, false, \"Hey,Dad!\", null, defaultAttributesToClearPlusXT},\n+                {basicSamToRevert, null, true, false, false, false, \"Hey,Dad!\", \"NewLibraryName\", defaultAttributesToClearPlusXT},\n+                {basicSamToRevert, null, true, true, false, false, null, null, Collections.EMPTY_LIST},\n+\n+                {basicBamToRevert, null, false, false, true, true, null, null, Collections.EMPTY_LIST},\n+                {basicBamToRevert, SAMFileHeader.SortOrder.queryname, false, false, true, false, \"Hey,Dad!\", null, defaultAttributesToClearPlusXT},\n+                {basicBamToRevert, null, true, false, false, false, \"Hey,Dad!\", \"NewLibraryName\", defaultAttributesToClearPlusXT},\n+                {basicBamToRevert, null, true, true, false, false, null, null, Collections.EMPTY_LIST},\n+\n+                {basicCramToRevert, null, false, false, true, true, null, null, Collections.EMPTY_LIST},\n+                {basicCramToRevert, SAMFileHeader.SortOrder.queryname, false, false, true, false, \"Hey,Dad!\", null, defaultAttributesToClearPlusXT},\n+                {basicCramToRevert, null, true, false, false, false, \"Hey,Dad!\", \"NewLibraryName\", defaultAttributesToClearPlusXT},\n+                {basicCramToRevert, null, true, true, false, false, null, null, Collections.EMPTY_LIST}\n         };\n     }\n \n     @Test(dataProvider= \"positiveTestData\")\n-    public void basicPositiveTests(final SAMFileHeader.SortOrder so, final boolean removeDuplicates, final boolean removeAlignmentInfo,\n+    public void basicPositiveTests(final File input, final SAMFileHeader.SortOrder so, final boolean removeDuplicates, final boolean removeAlignmentInfo,\n                                    final boolean restoreOriginalQualities, final boolean outputByReadGroup, final String sample, final String library,\n                                    final List<String> attributesToClear) throws Exception {\n \n         final File output = outputByReadGroup ? Files.createTempDirectory(\"picardRevertSamSparkTest\").toFile() : BaseTest.createTempFile(\"reverted\", \".sam\");\n-        File output0 = new File(output.getPath()+\"/0.sam\");\n-        File output1 = new File(output.getPath()+\"/1.sam\");\n-        File output2 = new File(output.getPath()+\"/2.sam\");\n-        File output3 = new File(output.getPath()+\"/3.sam\");\n+        final File output0 = new File(output.getPath()+\"/0.sam\");", "originalCommit": "44f8efe51232617cfcfedfe5ad29219a6c620498", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0NjAwNA==", "url": "https://github.com/broadinstitute/gatk/pull/6641#discussion_r441146004", "bodyText": "I'm going to pass on this one for now.", "author": "lbergelson", "createdAt": "2020-06-16T21:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4NjM0Mg=="}], "type": "inlineReview"}, {"oid": "9f9c671168019e0393cd315bd7ebac57945e16c6", "url": "https://github.com/broadinstitute/gatk/commit/9f9c671168019e0393cd315bd7ebac57945e16c6", "message": "Enable CRAMs in RevertSamSpark", "committedDate": "2020-06-16T21:12:17Z", "type": "commit"}, {"oid": "6c3aff489cc8d15c2ce1db0ca7363b25e0f3ae5d", "url": "https://github.com/broadinstitute/gatk/commit/6c3aff489cc8d15c2ce1db0ca7363b25e0f3ae5d", "message": "respond to review comments", "committedDate": "2020-06-16T21:19:17Z", "type": "commit"}, {"oid": "6c3aff489cc8d15c2ce1db0ca7363b25e0f3ae5d", "url": "https://github.com/broadinstitute/gatk/commit/6c3aff489cc8d15c2ce1db0ca7363b25e0f3ae5d", "message": "respond to review comments", "committedDate": "2020-06-16T21:19:17Z", "type": "forcePushed"}]}