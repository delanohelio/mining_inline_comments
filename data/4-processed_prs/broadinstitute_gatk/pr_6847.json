{"pr_number": 6847, "pr_title": "ah-6766-NPE", "pr_createdAt": "2020-09-24T20:12:49Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6847", "timeline": [{"oid": "32805e15ac05616000e66985e9e70a429eb48abc", "url": "https://github.com/broadinstitute/gatk/commit/32805e15ac05616000e66985e9e70a429eb48abc", "message": "revert code back to previous code that did not throw NPE. Add 2 unit tests to guard against this.", "committedDate": "2020-09-24T20:11:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4OTE0Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6847#discussion_r498989147", "bodyText": "Since you are reverting this method back to a version that handles nulls, I think you should remove the perAlleleValues.values().removeIf(Objects::isNull); line you added to computeSBAnnotation() above as well, for consistency with the pre-bug behavior.", "author": "droazen", "createdAt": "2020-10-02T18:38:23Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/annotator/allelespecific/StrandBiasUtils.java", "diffHunk": "@@ -38,21 +38,37 @@\n      * @param perAlleleValues forward and reverse read counts for each allele\n      * @return a String appropriate to use for annotating a GVCF\n      */\n-    protected static String makeRawAnnotationString(final List<Allele> vcAlleles, final Map<Allele, List<Integer>> perAlleleValues) {\n-        final List<String> alleleStrings = vcAlleles.stream()\n-                // does not replace a null value with zero list - only if the key is not in the map\n-                .map(a -> perAlleleValues.getOrDefault(a, ZERO_LIST))\n-                .map(StrandBiasUtils::encode)\n-                .collect(Collectors.toList());\n-        return String.join(AnnotationUtils.ALLELE_SPECIFIC_RAW_DELIM, alleleStrings);\n-\n+    public static String makeRawAnnotationString(final List<Allele> vcAlleles, final Map<Allele, List<Integer>> perAlleleValues) {", "originalCommit": "32805e15ac05616000e66985e9e70a429eb48abc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTI4Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6847#discussion_r499281287", "bodyText": "reverted to previous code", "author": "ahaessly", "createdAt": "2020-10-04T19:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4OTE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk5NDIxMA==", "url": "https://github.com/broadinstitute/gatk/pull/6847#discussion_r498994210", "bodyText": "Give the test a more specific name: testCombineRawDataNullPointerExceptionIssue6766()", "author": "droazen", "createdAt": "2020-10-02T18:49:49Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/annotator/allelespecific/AS_StrandBiasTestUnitTest.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package org.broadinstitute.hellbender.tools.walkers.annotator.allelespecific;\n+\n+import htsjdk.variant.variantcontext.*;\n+import org.broadinstitute.hellbender.GATKBaseTest;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AS_StrandBiasTestUnitTest extends GATKBaseTest {\n+\n+    private static final Allele REF = Allele.create(\"T\", true);\n+    private static final Allele ALT = Allele.create(\"A\", false);\n+\n+    /**\n+     * Test for issue #6766\n+     */\n+    @Test\n+    public void testCombineRawData() {", "originalCommit": "32805e15ac05616000e66985e9e70a429eb48abc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk5NTk4Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6847#discussion_r498995987", "bodyText": "Can you confirm that with the previous version of the StrandBiasUtils methods we do get a NullPointerException here?", "author": "droazen", "createdAt": "2020-10-02T18:53:35Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/annotator/allelespecific/AS_StrandBiasTestUnitTest.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package org.broadinstitute.hellbender.tools.walkers.annotator.allelespecific;\n+\n+import htsjdk.variant.variantcontext.*;\n+import org.broadinstitute.hellbender.GATKBaseTest;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AS_StrandBiasTestUnitTest extends GATKBaseTest {\n+\n+    private static final Allele REF = Allele.create(\"T\", true);\n+    private static final Allele ALT = Allele.create(\"A\", false);\n+\n+    /**\n+     * Test for issue #6766\n+     */\n+    @Test\n+    public void testCombineRawData() {\n+        final List<Allele> vcAlleles = Arrays.asList(REF, ALT);\n+        final List<ReducibleAnnotationData<?>> combinedVCdata = new ArrayList<>();\n+        // The commented out code would be a normal way to create the combinedVCdata, but this did not reproduce the null pointer exception\n+        // we are testing for. The following one line did even though that probably would not occur if reading in from a gvcf.\n+//        ReducibleAnnotationData<List<Integer>> data = new ReducibleAnnotationData<>(null);\n+//        data.putAttribute(ALT, Arrays.asList(33640, 10));\n+//        data.putAttribute(REF, Arrays.asList(1,2));\n+//        combinedVCdata.add(data);\n+\n+        // This set SB data for \".\" (i.e. the missing allele)\n+        combinedVCdata.add(new ReducibleAnnotationData<>(\"36000,10\"));  //10 MQ60 reads\n+\n+        AS_StrandBiasTest annotator = new AS_StrandOddsRatio();\n+\n+        try {\n+            final Map<String, Object> combined = annotator.combineRawData(vcAlleles, combinedVCdata);\n+            final String combinedListString = (String) combined.get(annotator.getPrimaryRawKey());\n+            // These are both 0 because we did not set any SB data for either allele\n+            Assert.assertEquals(combinedListString, \"0,0|0,0\");\n+        } catch (NullPointerException npe) {\n+            Assert.fail(\"This code should not be throwing a NullPointerException\");", "originalCommit": "32805e15ac05616000e66985e9e70a429eb48abc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk5Njk5Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6847#discussion_r498996993", "bodyText": "Give this one a more specific name too: testMakeRawAnnotationStringsNullPointerExceptionIssue6766()", "author": "droazen", "createdAt": "2020-10-02T18:55:45Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/annotator/allelespecific/StrandBiasUtilsUnitTest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.broadinstitute.hellbender.tools.walkers.annotator.allelespecific;\n+\n+import htsjdk.variant.variantcontext.*;\n+import org.broadinstitute.hellbender.GATKBaseTest;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+import java.util.*;\n+\n+public class StrandBiasUtilsUnitTest extends GATKBaseTest {\n+\n+    private final String sample1 = \"NA1\";\n+    private static final String CONTIG = \"1\";\n+\n+    private static final Allele REF = Allele.create(\"T\", true);\n+    private static final Allele ALT = Allele.create(\"A\", false);\n+\n+    private VariantContext makeVC(final long position) {\n+        final GenotypesContext testGC = GenotypesContext.create(2);\n+        // sample1 -> A/T with GQ 30\n+        testGC.add(new GenotypeBuilder(sample1).alleles(Arrays.asList(REF, ALT)).GQ(30).make());\n+\n+        return (new VariantContextBuilder())\n+                .alleles(Arrays.asList(REF, ALT)).chr(CONTIG).start(position).stop(position).genotypes(testGC).make();\n+    }\n+\n+    /**\n+     * Test for issue #6766\n+     */\n+    @Test\n+    public void testMakeRawAnnotationStrings() {", "originalCommit": "32805e15ac05616000e66985e9e70a429eb48abc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk5NzQxOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6847#discussion_r498997419", "bodyText": "Same question here: did the NullPointerException get triggered with the previous version of StrandBiasUtils?", "author": "droazen", "createdAt": "2020-10-02T18:56:40Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/annotator/allelespecific/StrandBiasUtilsUnitTest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.broadinstitute.hellbender.tools.walkers.annotator.allelespecific;\n+\n+import htsjdk.variant.variantcontext.*;\n+import org.broadinstitute.hellbender.GATKBaseTest;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+import java.util.*;\n+\n+public class StrandBiasUtilsUnitTest extends GATKBaseTest {\n+\n+    private final String sample1 = \"NA1\";\n+    private static final String CONTIG = \"1\";\n+\n+    private static final Allele REF = Allele.create(\"T\", true);\n+    private static final Allele ALT = Allele.create(\"A\", false);\n+\n+    private VariantContext makeVC(final long position) {\n+        final GenotypesContext testGC = GenotypesContext.create(2);\n+        // sample1 -> A/T with GQ 30\n+        testGC.add(new GenotypeBuilder(sample1).alleles(Arrays.asList(REF, ALT)).GQ(30).make());\n+\n+        return (new VariantContextBuilder())\n+                .alleles(Arrays.asList(REF, ALT)).chr(CONTIG).start(position).stop(position).genotypes(testGC).make();\n+    }\n+\n+    /**\n+     * Test for issue #6766\n+     */\n+    @Test\n+    public void testMakeRawAnnotationStrings() {\n+        VariantContext vc = makeVC(1);\n+        Map<Allele, List<Integer>> perAlleleValues = new LinkedHashMap<>();\n+        perAlleleValues.put(REF, Arrays.asList(2, 5));\n+        perAlleleValues.put(ALT, null);\n+        try {\n+            StrandBiasUtils.makeRawAnnotationString(vc.getAlleles(), perAlleleValues);\n+        } catch (NullPointerException npe) {\n+            Assert.fail(\"This code should not be throwing a NullPointerException\");", "originalCommit": "32805e15ac05616000e66985e9e70a429eb48abc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aeed4b6256fc9bc5e18807bdea5b0975ff1d92d1", "url": "https://github.com/broadinstitute/gatk/commit/aeed4b6256fc9bc5e18807bdea5b0975ff1d92d1", "message": "update from PR feeback", "committedDate": "2020-10-04T19:47:31Z", "type": "commit"}]}