{"pr_number": 6625, "pr_title": "- ContextCovariate assumes that all non-ACGT bases in the read are N'\u2026", "pr_createdAt": "2020-05-28T21:45:04Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6625", "timeline": [{"oid": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "url": "https://github.com/broadinstitute/gatk/commit/46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "message": "- ContextCovariate assumes that all non-ACGT bases in the read are N's and this might actually be wrong.\n- fixes this assumption\n- add tests\n- modify tests so that they use actually random bases and not just AAAAAA bases....", "committedDate": "2020-05-28T21:37:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwODM2NA==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432708364", "bodyText": "Can you fix the inaccurate comment above that if the first key was -1 then there was an N in the context?\nAlso, BaseUtils.simpleBaseToBaseIndex() will return 0 for '*' -- is this something we need to care about here?", "author": "droazen", "createdAt": "2020-05-29T20:02:04Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariate.java", "diffHunk": "@@ -188,7 +188,7 @@ private static IntList contextWith(final byte[] bases, final int contextSize, fi\n             currentKey = 0;\n             currentNPenalty = contextSize - 1;\n             int offset = newBaseOffset;\n-            while (bases[currentNPenalty] != 'N') {\n+            while (BaseUtils.simpleBaseToBaseIndex(bases[currentNPenalty]) != -1) {", "originalCommit": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwMzk4Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432803986", "bodyText": "for some reason we assume that * == A in this context...not sure how that helps....but if someone has a '*' in their non-empty read, God help them....", "author": "yfarjoun", "createdAt": "2020-05-30T02:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwODM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwOTgyMg==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432709822", "bodyText": "I reiterate my fear (expressed in person) that even if we make ContextCovariate able to handle (or at least not crash on) non-ACGT bases, there will be other parts of BQSR that can't handle them. We should wait until this branch has a successful run on the sample(s) that revealed this problem before merging.", "author": "droazen", "createdAt": "2020-05-29T20:05:18Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariate.java", "diffHunk": "@@ -188,7 +188,7 @@ private static IntList contextWith(final byte[] bases, final int contextSize, fi\n             currentKey = 0;\n             currentNPenalty = contextSize - 1;\n             int offset = newBaseOffset;\n-            while (bases[currentNPenalty] != 'N') {\n+            while (BaseUtils.simpleBaseToBaseIndex(bases[currentNPenalty]) != -1) {\n                 final int baseIndex = BaseUtils.simpleBaseToBaseIndex(bases[currentNPenalty]);\n                 currentKey |= (baseIndex << offset);\n                 offset -= 2;", "originalCommit": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNDAyOA==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432804028", "bodyText": "agreed. the production team has this branch and is running the failed sample against it.", "author": "yfarjoun", "createdAt": "2020-05-30T03:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwOTgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxMTEyNA==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432711124", "bodyText": "All tests that generate random data using the rng returned by Utils.getRandomGenerator() should call Utils.resetRandomGenerator() at the top to make them deterministic/repeatable (I know this is not your problem, but since you're in here...)", "author": "droazen", "createdAt": "2020-05-29T20:08:22Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariateUnitTest.java", "diffHunk": "@@ -34,7 +35,8 @@ public void testSimpleContexts() {\n         final SAMFileHeader header = ArtificialReadUtils.createArtificialSamHeader();\n \n         for(int i = 0; i < 10; i++) {\n-            final GATKRead read = ArtificialReadUtils.createRandomRead(header, 1000);\n+            final GATKRead read = ArtificialReadUtils.createRandomRead(header, 1000,false);", "originalCommit": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxMjM2Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432712363", "bodyText": "Call Utils.resetRandomGenerator() first", "author": "droazen", "createdAt": "2020-05-29T20:11:12Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariateUnitTest.java", "diffHunk": "@@ -46,12 +48,42 @@ public void testSimpleContexts() {\n         }\n     }\n \n-    public static void verifyCovariateArray(int[][] values, int contextSize, GATKRead read, Covariate contextCovariate, final byte lowQualTail) {\n+\n+    private static void verifyCovariateArray(final int[][] values, final int contextSize, final GATKRead read, final Covariate contextCovariate, final byte lowQualTail) {\n         for (int i = 0; i < values.length; i++) {\n             Assert.assertEquals(contextCovariate.formatKey(values[i][0]), expectedContext(read, i, contextSize, lowQualTail), \"offset \" + i);\n         }\n     }\n \n+    @DataProvider\n+    Iterator<Object[]> AnnoyingReads() {\n+        final List<Object[]> tests = new ArrayList<>();\n+        for (final byte base : \"NBACGTUMLA\".getBytes()) {\n+            for (int i = 0; i < 10; i++) {\n+                tests.add(new Object[]{base, i});\n+            }\n+        }\n+        return tests.iterator();\n+    }\n+\n+    @Test(dataProvider = \"AnnoyingReads\")\n+    public void testContextsAnnoyingReads(final byte base, final int i) {\n+        final Random rnd = Utils.getRandomGenerator();", "originalCommit": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNDA3OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432804079", "bodyText": "should I do that once, in the setup, or in test?", "author": "yfarjoun", "createdAt": "2020-05-30T03:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxMjM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxMzU1NA==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432713554", "bodyText": "Maybe instead of randomizing the strand, the DataProvider should just have an additional loop over {true, false} for the strand to systematically test the possibilities.", "author": "droazen", "createdAt": "2020-05-29T20:14:00Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariateUnitTest.java", "diffHunk": "@@ -46,12 +48,42 @@ public void testSimpleContexts() {\n         }\n     }\n \n-    public static void verifyCovariateArray(int[][] values, int contextSize, GATKRead read, Covariate contextCovariate, final byte lowQualTail) {\n+\n+    private static void verifyCovariateArray(final int[][] values, final int contextSize, final GATKRead read, final Covariate contextCovariate, final byte lowQualTail) {\n         for (int i = 0; i < values.length; i++) {\n             Assert.assertEquals(contextCovariate.formatKey(values[i][0]), expectedContext(read, i, contextSize, lowQualTail), \"offset \" + i);\n         }\n     }\n \n+    @DataProvider\n+    Iterator<Object[]> AnnoyingReads() {\n+        final List<Object[]> tests = new ArrayList<>();\n+        for (final byte base : \"NBACGTUMLA\".getBytes()) {\n+            for (int i = 0; i < 10; i++) {\n+                tests.add(new Object[]{base, i});\n+            }\n+        }\n+        return tests.iterator();\n+    }\n+\n+    @Test(dataProvider = \"AnnoyingReads\")\n+    public void testContextsAnnoyingReads(final byte base, final int i) {\n+        final Random rnd = Utils.getRandomGenerator();\n+        final SAMFileHeader header = ArtificialReadUtils.createArtificialSamHeader();\n+        final GATKRead read = ArtificialReadUtils.createRandomRead(header, 10,false);\n+        read.getBasesNoCopy()[i] = base;\n+\n+        read.setIsReverseStrand(rnd.nextBoolean());", "originalCommit": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNDExNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432804115", "bodyText": "hey, I just copied what was done above...but OK.", "author": "yfarjoun", "createdAt": "2020-05-30T03:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxMzU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxNDQ3Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432714477", "bodyText": "I think it's worth having a couple of test cases that have more than one \"annoying base.\" Won't the code you patched behave differently in the case of 1 non-ACGT base vs. the case of 2 non-ACGT bases?", "author": "droazen", "createdAt": "2020-05-29T20:16:16Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariateUnitTest.java", "diffHunk": "@@ -46,12 +48,42 @@ public void testSimpleContexts() {\n         }\n     }\n \n-    public static void verifyCovariateArray(int[][] values, int contextSize, GATKRead read, Covariate contextCovariate, final byte lowQualTail) {\n+\n+    private static void verifyCovariateArray(final int[][] values, final int contextSize, final GATKRead read, final Covariate contextCovariate, final byte lowQualTail) {\n         for (int i = 0; i < values.length; i++) {\n             Assert.assertEquals(contextCovariate.formatKey(values[i][0]), expectedContext(read, i, contextSize, lowQualTail), \"offset \" + i);\n         }\n     }\n \n+    @DataProvider\n+    Iterator<Object[]> AnnoyingReads() {\n+        final List<Object[]> tests = new ArrayList<>();\n+        for (final byte base : \"NBACGTUMLA\".getBytes()) {\n+            for (int i = 0; i < 10; i++) {\n+                tests.add(new Object[]{base, i});\n+            }\n+        }\n+        return tests.iterator();\n+    }\n+\n+    @Test(dataProvider = \"AnnoyingReads\")\n+    public void testContextsAnnoyingReads(final byte base, final int i) {\n+        final Random rnd = Utils.getRandomGenerator();\n+        final SAMFileHeader header = ArtificialReadUtils.createArtificialSamHeader();\n+        final GATKRead read = ArtificialReadUtils.createRandomRead(header, 10,false);\n+        read.getBasesNoCopy()[i] = base;", "originalCommit": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNTA1NA==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432805054", "bodyText": "ok.", "author": "yfarjoun", "createdAt": "2020-05-30T03:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxNDQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxNDkwNw==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432714907", "bodyText": "Have you confirmed that this test case fails without your patch?", "author": "droazen", "createdAt": "2020-05-29T20:17:19Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariateUnitTest.java", "diffHunk": "@@ -46,12 +48,42 @@ public void testSimpleContexts() {\n         }\n     }\n \n-    public static void verifyCovariateArray(int[][] values, int contextSize, GATKRead read, Covariate contextCovariate, final byte lowQualTail) {\n+\n+    private static void verifyCovariateArray(final int[][] values, final int contextSize, final GATKRead read, final Covariate contextCovariate, final byte lowQualTail) {\n         for (int i = 0; i < values.length; i++) {\n             Assert.assertEquals(contextCovariate.formatKey(values[i][0]), expectedContext(read, i, contextSize, lowQualTail), \"offset \" + i);\n         }\n     }\n \n+    @DataProvider\n+    Iterator<Object[]> AnnoyingReads() {\n+        final List<Object[]> tests = new ArrayList<>();\n+        for (final byte base : \"NBACGTUMLA\".getBytes()) {\n+            for (int i = 0; i < 10; i++) {\n+                tests.add(new Object[]{base, i});\n+            }\n+        }\n+        return tests.iterator();\n+    }\n+\n+    @Test(dataProvider = \"AnnoyingReads\")\n+    public void testContextsAnnoyingReads(final byte base, final int i) {\n+        final Random rnd = Utils.getRandomGenerator();\n+        final SAMFileHeader header = ArtificialReadUtils.createArtificialSamHeader();\n+        final GATKRead read = ArtificialReadUtils.createRandomRead(header, 10,false);\n+        read.getBasesNoCopy()[i] = base;\n+\n+        read.setIsReverseStrand(rnd.nextBoolean());\n+        final GATKRead clippedRead = ReadClipper.clipLowQualEnds(read, RAC.LOW_QUAL_TAIL, ClippingRepresentation.WRITE_NS);\n+        final ReadCovariates readCovariates = new ReadCovariates(read.getLength(), 1, new CovariateKeyCache());\n+        covariate.recordValues(read, header, readCovariates, true);\n+\n+        verifyCovariateArray(readCovariates.getMismatchesKeySet(), RAC.MISMATCHES_CONTEXT_SIZE, clippedRead, covariate, RAC.LOW_QUAL_TAIL);\n+        verifyCovariateArray(readCovariates.getInsertionsKeySet(), RAC.INDELS_CONTEXT_SIZE, clippedRead, covariate, RAC.LOW_QUAL_TAIL);\n+        verifyCovariateArray(readCovariates.getDeletionsKeySet(), RAC.INDELS_CONTEXT_SIZE, clippedRead, covariate, RAC.LOW_QUAL_TAIL);", "originalCommit": "46ef842a65b48742eff3b4e2d00bbfdb0ad119e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjgwNTA2MA==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r432805060", "bodyText": "yes.", "author": "yfarjoun", "createdAt": "2020-05-30T03:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxNDkwNw=="}], "type": "inlineReview"}, {"oid": "b3045305933128ffc8bed9edaaeafe523b26767a", "url": "https://github.com/broadinstitute/gatk/commit/b3045305933128ffc8bed9edaaeafe523b26767a", "message": "responding to review comments.", "committedDate": "2020-05-30T03:16:57Z", "type": "commit"}, {"oid": "80a2d3af837bd2e18d93c94eb1520270d5cd466f", "url": "https://github.com/broadinstitute/gatk/commit/80a2d3af837bd2e18d93c94eb1520270d5cd466f", "message": "responding to review comments.", "committedDate": "2020-05-30T03:17:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY4NzE0NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r441687145", "bodyText": "I don't think the randomness really adds much value in this DataProvider. Since the individual IUPAC bases are not treated differently by the code, scrambling their relative order doesn't make much difference once you've proved that we can handle each one -- and despite having 100 random cases I think we're actually still missing important test cases that are worth covering.\nRecommend rewriting this DataProvider to eliminate the randomness completely and substituting just the following curated list of test cases instead:\n\nA string of all IUPAC bases (positive strand)\nA string of all IUPAC bases (negative strand)\nA string that starts with an ACGT base, then has a mix of ACGT and IUPAC bases (positive strand)\nA string that starts with an ACGT base, then has a mix of ACGT and IUPAC bases (negative strand)\nA string that starts with an IUPAC base, then has a mix of ACGT and IUPAC bases (positive strand)\nA string that starts with an IUPAC base, then has a mix of ACGT and IUPAC bases (negative strand)\nA string that ends with an ACGT base, and has a mix of ACGT and IUPAC bases (positive strand)\nA string that ends with an ACGT base, and has a mix of ACGT and IUPAC bases (negative strand)\nA string that ends with an IUPAC base, and has a mix of ACGT and IUPAC bases (positive strand)\nA string that ends with an IUPAC base, and has a mix of ACGT and IUPAC bases (negative strand)", "author": "droazen", "createdAt": "2020-06-17T16:50:34Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariateUnitTest.java", "diffHunk": "@@ -46,12 +50,54 @@ public void testSimpleContexts() {\n         }\n     }\n \n-    public static void verifyCovariateArray(int[][] values, int contextSize, GATKRead read, Covariate contextCovariate, final byte lowQualTail) {\n+\n+    private static void verifyCovariateArray(final int[][] values, final int contextSize, final GATKRead read, final Covariate contextCovariate, final byte lowQualTail) {\n         for (int i = 0; i < values.length; i++) {\n             Assert.assertEquals(contextCovariate.formatKey(values[i][0]), expectedContext(read, i, contextSize, lowQualTail), \"offset \" + i);\n         }\n     }\n \n+    @DataProvider\n+    Iterator<Object[]> AnnoyingReads() {\n+        final String IUPAC_bases = \"NBTRML\";\n+        final int readLength = 1000;\n+        final double pStop = 0.02;\n+        final int nTests = 100;\n+        final List<Object[]> tests = new ArrayList<>();\n+\n+        final Random randomGenerator = Utils.getRandomGenerator();\n+        for (int i = 0; i < nTests; i++) {\n+            final List<Byte> bases = new ArrayList<>();\n+            final List<Integer> positions = new ArrayList<>();\n+            while (randomGenerator.nextDouble() > pStop) {\n+                bases.add(IUPAC_bases.getBytes()[randomGenerator.nextInt(IUPAC_bases.length())]);\n+                positions.add(randomGenerator.nextInt(readLength));\n+            }\n+            tests.add(new Object[]{bases, positions, randomGenerator.nextBoolean(), readLength});\n+        }", "originalCommit": "80a2d3af837bd2e18d93c94eb1520270d5cd466f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "23da86f4640de66b4d3627b8c5b30c46d6137eac", "url": "https://github.com/broadinstitute/gatk/commit/23da86f4640de66b4d3627b8c5b30c46d6137eac", "message": "responding to review comments.", "committedDate": "2020-06-23T18:40:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MjcyMQ==", "url": "https://github.com/broadinstitute/gatk/pull/6625#discussion_r445082721", "bodyText": "This string has some ACGT bases in it, despite being described as \"A string of all IUPAC bases\". I think the \"all IUPAC\" case is definitely worth covering here...", "author": "droazen", "createdAt": "2020-06-24T18:16:16Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/recalibration/covariates/ContextCovariateUnitTest.java", "diffHunk": "@@ -46,52 +51,97 @@ public void testSimpleContexts() {\n         }\n     }\n \n-    public static void verifyCovariateArray(int[][] values, int contextSize, GATKRead read, Covariate contextCovariate, final byte lowQualTail) {\n+    private static void verifyCovariateArray(final int[][] values, final int contextSize, final GATKRead read, final Covariate contextCovariate, final byte lowQualTail) {\n         for (int i = 0; i < values.length; i++) {\n             Assert.assertEquals(contextCovariate.formatKey(values[i][0]), expectedContext(read, i, contextSize, lowQualTail), \"offset \" + i);\n         }\n     }\n \n-    @DataProvider(name=\"strandedBytes\")\n+    @DataProvider\n+    Iterator<Object[]> AnnoyingReads() {\n+        final SAMFileHeader header = ArtificialReadUtils.createArtificialSamHeader();\n+\n+        final String[] bases = new String[] {\n+//           A string of all IUPAC bases\n+                \"NBTRMLNACMGRSVTWYHKDBNABTRMLNBTRML\",", "originalCommit": "23da86f4640de66b4d3627b8c5b30c46d6137eac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "25a21de12427b35e6f24720ae4c8c7b1e9eedec8", "url": "https://github.com/broadinstitute/gatk/commit/25a21de12427b35e6f24720ae4c8c7b1e9eedec8", "message": "opps. some ACGT bases slipped through", "committedDate": "2020-08-12T17:22:07Z", "type": "commit"}]}