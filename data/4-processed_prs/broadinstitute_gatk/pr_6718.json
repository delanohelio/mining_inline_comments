{"pr_number": 6718, "pr_title": "Another round of URI changes.", "pr_createdAt": "2020-07-21T21:25:55Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6718", "timeline": [{"oid": "89fe9c3d61b52bbdf6ea57d43367f46759fdb2cd", "url": "https://github.com/broadinstitute/gatk/commit/89fe9c3d61b52bbdf6ea57d43367f46759fdb2cd", "message": "Repair imports.", "committedDate": "2020-08-24T12:45:45Z", "type": "forcePushed"}, {"oid": "e252b4583d74eee26bbf75718e7b90d665a11657", "url": "https://github.com/broadinstitute/gatk/commit/e252b4583d74eee26bbf75718e7b90d665a11657", "message": "Repair imports.", "committedDate": "2020-09-09T20:16:00Z", "type": "forcePushed"}, {"oid": "92f8f0c4a41d92ed6315b9162cfb3c62d39c094c", "url": "https://github.com/broadinstitute/gatk/commit/92f8f0c4a41d92ed6315b9162cfb3c62d39c094c", "message": "Repair imports.", "committedDate": "2020-09-09T21:17:40Z", "type": "forcePushed"}, {"oid": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "url": "https://github.com/broadinstitute/gatk/commit/ce925329b4d8da2b29840b881811b822fbe0f2c7", "message": "Repair imports.", "committedDate": "2020-09-21T17:06:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNTc3OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r492915779", "bodyText": "This else clause specifically covers the file case -- non-local files should be caught by the else if (getScheme() != null && !getScheme().equals(\"file\")) clause above. Can you confirm that this change is correct and won't result in introducing file:// URIs into codepaths that can't handle them?", "author": "droazen", "createdAt": "2020-09-22T17:35:49Z", "path": "src/main/java/org/broadinstitute/hellbender/engine/FeatureInput.java", "diffHunk": "@@ -123,7 +122,7 @@ private String makeIntoAbsolutePath() {\n         } else if (getScheme() != null && !getScheme().equals(\"file\")) { // local files always have a \"file\" scheme\n             return toPath().toAbsolutePath().toUri().toString();\n         } else {\n-            return new File(getURI()).getAbsolutePath();\n+            return getURI().getPath();", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk2NTY4OA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495965688", "bodyText": "Yes, this is exactly the pattern to ensure that this never returns a string containing a scheme. getPath returns only the path component of the URI, and the GATKPath constructor always \"absolutizes\" a relative file path that has no protocol scheme into an absolute file path URI during construction.", "author": "cmnbroad", "createdAt": "2020-09-28T14:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNTc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwMTIxNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495201215", "bodyText": "We've gone from converting to absolute path to using the raw input String here -- can't we continue to absolutize the path if necessary?", "author": "droazen", "createdAt": "2020-09-25T19:54:09Z", "path": "src/main/java/org/broadinstitute/hellbender/engine/FeatureWalker.java", "diffHunk": "@@ -55,16 +55,16 @@ protected final void onStartup() {\n \n     @SuppressWarnings(\"unchecked\")\n     private void initializeDrivingFeatures() {\n-        final File drivingFile = getDrivingFeatureFile();\n-        final FeatureCodec<? extends Feature, ?> codec = FeatureManager.getCodecForFile(drivingFile.toPath());\n+        final GATKPath drivingPath = getDrivingFeaturePath();\n+        final FeatureCodec<? extends Feature, ?> codec = FeatureManager.getCodecForFile(drivingPath.toPath());\n         if (isAcceptableFeatureType(codec.getFeatureType())) {\n-            drivingFeatures = new FeatureDataSource<>(new FeatureInput<>(drivingFile.getAbsolutePath()), FeatureDataSource.DEFAULT_QUERY_LOOKAHEAD_BASES, null, cloudPrefetchBuffer, cloudIndexPrefetchBuffer, referenceArguments.getReferencePath());\n+            drivingFeatures = new FeatureDataSource<>(new FeatureInput<>(drivingPath.getRawInputString()), FeatureDataSource.DEFAULT_QUERY_LOOKAHEAD_BASES, null, cloudPrefetchBuffer, cloudIndexPrefetchBuffer, referenceArguments.getReferencePath());\n \n-            final FeatureInput<F> drivingFeaturesInput = new FeatureInput<>(drivingFile.getAbsolutePath(), \"drivingFeatureFile\");\n+            final FeatureInput<F> drivingFeaturesInput = new FeatureInput<>(drivingPath.getRawInputString(), \"drivingFeatureFile\");", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4MDcyNg==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495980726", "bodyText": "Its admittedly not obvious, but file paths are still absolutized. FeatureInput is-a GATKPath, so it absolutizes relative paths in it's constructor as described above.\nI'm trying to get rid of the intermediate File semantics, but it would probably be a bit less confounding  if I instead added a FeatureInput(GATKPath) constructor and used that here as new FeatureInput<>(drivingPath,...) ? Let me know what you think.", "author": "cmnbroad", "createdAt": "2020-09-28T14:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwMTIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwMzQ2Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495203463", "bodyText": "Aren't argument tags part of the argument name these days, not the argument value?", "author": "droazen", "createdAt": "2020-09-25T19:59:09Z", "path": "src/main/java/org/broadinstitute/hellbender/engine/MultiVariantWalker.java", "diffHunk": "@@ -63,7 +63,8 @@ protected MultiVariantInputArgumentCollection getMultiVariantInputArgumentCollec\n     protected void initializeDrivingVariants() {\n         multiVariantInputArgumentCollection.getDrivingVariantPaths().stream().forEach(\n                 f -> {\n-                    FeatureInput<VariantContext> featureInput = new FeatureInput<>(f);\n+                    // use getRawInputString() on the original GATKPath here to ensure that we propagate any argument tags\n+                    FeatureInput<VariantContext> featureInput = new FeatureInput<>(f.getRawInputString());", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4MzgzMw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495983833", "bodyText": "Oh - good point. I guess that answers the question of whether we need a FeatureInput(GATKPath) constructor.", "author": "cmnbroad", "createdAt": "2020-09-28T14:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwMzQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2NzM4OA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496967388", "bodyText": "I added a copy constructor to GATKPath, along with a FeatureInput(GATKPath) constructor, and used that here and below.\nFeatureInput can be dramatically simplified once there are no more call sites that use the constructors that take Strings (ie., it no longer needs to have overloads that take tag maps, or even names, since they can/should be propagated though GATKPath). I started going down that path but it quickly cascaded to lots of changes, so for now I'm doing the minimum and reserving those changes for a separate PR.", "author": "cmnbroad", "createdAt": "2020-09-29T18:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwMzQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNDEwNw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495204107", "bodyText": "Same question: aren't the argument tags no longer part of the argument values?", "author": "droazen", "createdAt": "2020-09-25T20:00:31Z", "path": "src/main/java/org/broadinstitute/hellbender/engine/VariantWalker.java", "diffHunk": "@@ -50,7 +50,8 @@ protected final void onStartup() {\n \n     @Override\n     protected void initializeDrivingVariants() {\n-        drivingVariantsFeatureInput = new FeatureInput<>(drivingVariantFile, \"drivingVariantFile\");\n+        // use getRawInputString() on the original GATKPath here to ensure that we propagate any argument tags\n+        drivingVariantsFeatureInput = new FeatureInput<>(drivingVariantFile.getRawInputString(), \"drivingVariantFile\");", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNDcyOA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495204728", "bodyText": "Oh dear, I didn't realize this tool was still in the GATK -- it should really be removed....", "author": "droazen", "createdAt": "2020-09-25T20:02:02Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/FixCallSetSampleOrdering.java", "diffHunk": "@@ -45,7 +45,7 @@\n     @Argument(fullName = GenomicsDBImport.SAMPLE_NAME_MAP_LONG_NAME,", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1MDUzOA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496150538", "bodyText": "I went to remove it but GenomicsDB depends on code in this tool's class, so instead I made a ticket.", "author": "cmnbroad", "createdAt": "2020-09-28T18:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNDcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNjQ3OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495206479", "bodyText": "If we're no longer calling methods that throw IOException, then I think we need to call checkError() manually on the PrintWriter to check whether an error occurred....", "author": "droazen", "createdAt": "2020-09-25T20:06:19Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/GetSampleName.java", "diffHunk": "@@ -95,12 +93,10 @@ public void onTraversalStart() {\n             throw new UserException.BadInput(\"The given bam input has no sample names.\");\n         }\n \n-        try (final FileWriter fileWriter = new FileWriter(outputSampleNameFile, false)) {\n+        try (final PrintWriter fileWriter = new PrintWriter(outputSampleNameFile.getOutputStream(), false)) {\n             final String rawSample = sampleNames.get(0);\n             final String outputSample = urlEncode ? IOUtils.urlEncode(rawSample) : rawSample;\n             fileWriter.write(outputSample);\n-        } catch (final IOException ioe) {\n-            throw new UserException(\"Could not write file.\", ioe);", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1Njc3Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496156776", "bodyText": "So after reviewing this, I think you're right in this case that we need to call checkError now, since we went from FileWriter (throws IOException) to PrintWriter(does not).", "author": "cmnbroad", "createdAt": "2020-09-28T18:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNjQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2NzIzNw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496167237", "bodyText": "Actually, even better I think is to restore the catch block and switch to OutputStreamWriter, which propagates IOExceptions.", "author": "cmnbroad", "createdAt": "2020-09-28T18:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNjQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNzAzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495207030", "bodyText": "Same issue here -- need to check the error state of the PrintWriter. If exceptions are being suppressed internally in the writer then you're supposed to call checkError(), I believe.", "author": "droazen", "createdAt": "2020-09-25T20:07:45Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/PrintReadsHeader.java", "diffHunk": "@@ -33,11 +32,9 @@ public boolean requiresReads() {\n     public void traverse() {\n         final SAMFileHeader bamHeader = getHeaderForReads();\n \n-        try ( final PrintWriter outputWriter = new PrintWriter(outputFile) ) {\n+        try ( final PrintWriter outputWriter = new PrintWriter(outputFile.getOutputStream()) ) {\n             final SAMTextHeaderCodec codec = new SAMTextHeaderCodec();\n             codec.encode(outputWriter, bamHeader);\n-        } catch (FileNotFoundException e ) {\n-            throw new UserException.CouldNotCreateOutputFile(\"Error writing reads header to \" + outputFile, e);", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1ODAyNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496158025", "bodyText": "Right - in this case I think we should always have been calling checkError, independent of the change in this PR, since we were always using PrintWriter (the GATKPath getOutputStream does handle IOException). So I think the right thing to do here is to add the checkError call.", "author": "cmnbroad", "createdAt": "2020-09-28T18:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2OTY2NA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496169664", "bodyText": "Also switching this to OutputStreamWriter to eliminate the need to call checkError.", "author": "cmnbroad", "createdAt": "2020-09-28T19:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNzAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwODcwOA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495208708", "bodyText": "If we're no longer calling methods that throw IOException, then how are I/O errors being handled? PrintStream also seems to have a checkError() method...but in general it would be preferable to call methods that throw IOException instead of methods that swallow the exception and set an error flag.", "author": "droazen", "createdAt": "2020-09-25T20:11:48Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/bqsr/BaseRecalibrator.java", "diffHunk": "@@ -216,11 +216,8 @@ private void quantizeQualityScores() {\n     }\n \n     private void generateReport() {\n-        try ( PrintStream recalTableStream = new PrintStream(recalTableFile) ) {\n+        try ( PrintStream recalTableStream = new PrintStream(recalTableFile.getOutputStream()) ) {\n             RecalUtils.outputRecalibrationReport(recalTableStream, recalArgs, quantizationInfo, recalibrationEngine.getFinalRecalibrationTables(), recalibrationEngine.getCovariates());\n         }\n-        catch (final IOException e) {\n-            throw new UserException.CouldNotCreateOutputFile(recalTableFile, e);", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1OTI2Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496159266", "bodyText": "Same with this one - it should always have had the checkError call.", "author": "cmnbroad", "createdAt": "2020-09-28T18:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwODcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxMzMwMA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496713300", "bodyText": "I'm adding a checkError call locally to check the success of the newly added PrintStream(InputStream) constructor. The entire rest of RecalUtils already has this same issue (not callng checkError), so I've added an item to the uri ticket since to keep this PR from expanding too much.", "author": "cmnbroad", "createdAt": "2020-09-29T13:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwODcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTYyNw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495209627", "bodyText": "Here too we need to handle errors during stream creation. If IOException is no longer thrown then I guess we have to call checkError()? (unless you can find a better option -- it would be preferable to be able to catch IOException like before)", "author": "droazen", "createdAt": "2020-09-25T20:14:07Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerEngine.java", "diffHunk": "@@ -165,11 +165,7 @@ public HaplotypeCallerEngine(final HaplotypeCallerArgumentCollection hcArgs, Ass\n         forceCallingAllelesPresent = hcArgs.alleles != null;\n         initialize(createBamOutIndex, createBamOutMD5);\n         if (hcArgs.assemblyStateOutput != null) {\n-            try {\n-                assemblyDebugOutStream = new PrintStream(Files.newOutputStream(IOUtils.getPath(hcArgs.assemblyStateOutput)));\n-            } catch (IOException e) {\n-                throw new UserException.CouldNotCreateOutputFile(hcArgs.assemblyStateOutput, \"Provided argument for assembly debug graph location could not be created\");\n-            }\n+            assemblyDebugOutStream = new PrintStream(hcArgs.assemblyStateOutput.getOutputStream());", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxNzYyMA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496717620", "bodyText": "For this one, I'll change assemblyDebugOutStream to be an OutputStreamWriter, with appropriate catch clauses where its used (note that the OutputStreamWrite(stream) constructor only throws Error).", "author": "cmnbroad", "createdAt": "2020-09-29T13:30:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMTU2NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495211565", "bodyText": "Why isn't outFile itself converted to GATKPath in this tool? (it's still a File)", "author": "droazen", "createdAt": "2020-09-25T20:18:54Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/varianteval/VariantEval.java", "diffHunk": "@@ -755,7 +755,7 @@ else if (ve instanceof MetricsCollection)\n                 metricsCollection.setData(compOverlap.concordantRate, indelSummary.n_SNPs, countVariants.nSNPs, indelSummary.n_indels, multiallelicSummary.nIndels, indelSummary.insertion_to_deletion_ratio, countVariants.insertionDeletionRatio, tiTvVariantEvaluator.tiTvRatio);\n         }\n \n-        try (PrintStream out = IOUtils.makePrintStreamMaybeGzipped(outFile)){\n+        try (PrintStream out = IOUtils.makePrintStreamMaybeGzipped(new GATKPath(outFile.getAbsolutePath()))) {", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1ODU3OA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496758578", "bodyText": "Only because changing it causes a cascade of issues. There is another tool that subclasses this one (!) and uses outFile with GATKReport. So I was leaving that change for a separate PR that fixes GATKReport.", "author": "cmnbroad", "createdAt": "2020-09-29T14:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMjUwNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495212505", "bodyText": "This is java.io.File, not java.nio.File", "author": "droazen", "createdAt": "2020-09-25T20:21:04Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/vqsr/CNNScoreVariants.java", "diffHunk": "@@ -221,7 +219,7 @@\n     private int windowStart = windowSize / 2;\n     private boolean waitforBatchCompletion = false;\n \n-    private File scoreFile;\n+    private File scoreFile; // use java.nio.File here because python code needs to write to this", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1Mjk5Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496752996", "bodyText": "Oh right - fixed.", "author": "cmnbroad", "createdAt": "2020-09-29T14:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMjUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMjkxNw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495212917", "bodyText": "No way around this?", "author": "droazen", "createdAt": "2020-09-25T20:22:01Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/vqsr/VariantRecalibrator.java", "diffHunk": "@@ -199,10 +198,10 @@\n     @Argument(fullName= StandardArgumentDefinitions.OUTPUT_LONG_NAME,\n             shortName=StandardArgumentDefinitions.OUTPUT_SHORT_NAME,\n             doc=\"The output recal file used by ApplyRecalibration\", optional=false)\n-    private String output;\n+    private GATKPath output;\n \n     @Argument(fullName=\"tranches-file\", doc=\"The output tranches file used by ApplyRecalibration\", optional=false)\n-    private String TRANCHES_FILE;\n+    private File TRANCHES_FILE; // not GATKPath since this name must be accessible to R code", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0NDYzNA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496744634", "bodyText": "Maybe, but I didn't want to address that in this PR since I think there are other places where we have this same issue. So I'll add fixing the R code as a bullet point in the uri task ticket.", "author": "cmnbroad", "createdAt": "2020-09-29T14:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMjkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMzgxNw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495213817", "bodyText": "Handle errors on the PrintStream (by checkError() if that's the only way...)", "author": "droazen", "createdAt": "2020-09-25T20:24:17Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/vqsr/VariantRecalibrator.java", "diffHunk": "@@ -653,10 +655,8 @@ public Object onTraversalSuccess() {\n                     if (goodModel.failedToConverge) {\n                         if (outputModel != null) {\n                             final GATKReport report = writeModelReport(goodModel, null, USE_ANNOTATIONS);\n-                            try (final PrintStream modelReportStream = new PrintStream(outputModel)) {\n+                            try (final PrintStream modelReportStream = new PrintStream(outputModel.getOutputStream())) {\n                                 report.print(modelReportStream);\n-                            } catch (FileNotFoundException e) {\n-                                throw new UserException.CouldNotCreateOutputFile(\"File: (\" + outputModel + \")\", e);", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjczMTc2Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496731766", "bodyText": "Here I added a checkError call. GATKReport still has(/had) issues, but I added fixing that as an item to the uri ticket, since it will require changes in a bunch of places.", "author": "cmnbroad", "createdAt": "2020-09-29T13:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMzgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMzkxNg==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495213916", "bodyText": "Handle errors on the PrintStream", "author": "droazen", "createdAt": "2020-09-25T20:24:34Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/vqsr/VariantRecalibrator.java", "diffHunk": "@@ -680,10 +680,8 @@ public Object onTraversalSuccess() {\n \n                 if (outputModel != null) {\n                     final GATKReport report = writeModelReport(goodModel, badModel, USE_ANNOTATIONS);\n-                    try (final PrintStream modelReportStream = new PrintStream(outputModel)) {\n+                    try (final PrintStream modelReportStream = new PrintStream(outputModel.getOutputStream())) {\n                         report.print(modelReportStream);\n-                    } catch (FileNotFoundException e) {\n-                        throw new UserException.CouldNotCreateOutputFile(\"File: (\" + outputModel + \")\", e);", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjczMjc2OA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496732768", "bodyText": "Added a local checkError call, same as above.", "author": "cmnbroad", "createdAt": "2020-09-29T13:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMzkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxNDYxNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r495214615", "bodyText": "Will this constructor throw IOException if there's an error, or suppress the error?", "author": "droazen", "createdAt": "2020-09-25T20:26:07Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/io/IOUtils.java", "diffHunk": "@@ -646,11 +646,11 @@ public static File createFifoFile(final Path fifoFilePath, final boolean overwri\n     /**\n      * Makes a print stream for a file, gzipping on the fly if the file's name ends with '.gz'.\n      */\n-    public static PrintStream makePrintStreamMaybeGzipped(File file) throws IOException {\n-        if (file.getPath().endsWith(\".gz\")) {\n-            return new PrintStream(new GZIPOutputStream(new FileOutputStream(file)));\n+    public static PrintStream makePrintStreamMaybeGzipped(GATKPath filePath) throws IOException {\n+        if (filePath.hasExtension(\".gz\")) {\n+            return new PrintStream(new GZIPOutputStream(filePath.getOutputStream()));\n         } else {\n-            return new PrintStream(file);\n+            return new PrintStream(filePath.getOutputStream());", "originalCommit": "ce925329b4d8da2b29840b881811b822fbe0f2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MTA0MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r496741041", "bodyText": "Suppress. I'm adding a local checkError call to this call site. I've added a separate bullet point to #6610 to replace all usages of PrintStream with OutputStreamWriter, since all of the code that uses this PrintStream isn't detecting errors.", "author": "cmnbroad", "createdAt": "2020-09-29T13:59:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxNDYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5OTA5OA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516899098", "bodyText": "Comment is inaccurate -- this constructor is public, not package access", "author": "droazen", "createdAt": "2020-11-03T19:16:25Z", "path": "src/main/java/org/broadinstitute/hellbender/engine/FeatureInput.java", "diffHunk": "@@ -71,6 +73,39 @@\n         Utils.nonNull(rawArgumentValue, \"rawArgumentValue\");\n     }\n \n+    /**\n+     * Construct a FeatureInput from a GATKPath argument value.\n+     *\n+     * @param gatkPath an existing GATKPath object\n+     *\n+     * This constructor is meant to be called only by the engine and test classes,\n+     * which is why it has package access.", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA3NDc0Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520074746", "bodyText": "Fixed.", "author": "cmnbroad", "createdAt": "2020-11-09T19:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5OTA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5OTMzOA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516899338", "bodyText": "Here too the comment is wrong -- this constructor is public", "author": "droazen", "createdAt": "2020-11-03T19:16:52Z", "path": "src/main/java/org/broadinstitute/hellbender/engine/FeatureInput.java", "diffHunk": "@@ -71,6 +73,39 @@\n         Utils.nonNull(rawArgumentValue, \"rawArgumentValue\");\n     }\n \n+    /**\n+     * Construct a FeatureInput from a GATKPath argument value.\n+     *\n+     * @param gatkPath an existing GATKPath object\n+     *\n+     * This constructor is meant to be called only by the engine and test classes,\n+     * which is why it has package access.\n+     */\n+    public FeatureInput(final GATKPath gatkPath) {\n+        super(gatkPath);\n+    }\n+\n+    /**\n+     * Construct a FeatureInput from a GATKPath argument value.\n+     *\n+     * @param gatkPath an existing GATKPath object\n+     *\n+     * This constructor is meant to be called only by the engine and test classes,\n+     * which is why it has package access.", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA3NDc5NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520074795", "bodyText": "Fixed.", "author": "cmnbroad", "createdAt": "2020-11-09T19:43:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5OTMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNDM0NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516904345", "bodyText": "The PrintStream constructor can still end up throwing an exception, which we should handle (especially in an example tool like this). If you look at the implementation of PrintStream, you can see that the constructor ultimately ends up creating an OutputStreamWriter, which can throw...", "author": "droazen", "createdAt": "2020-11-03T19:26:27Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/examples/ExampleAssemblyRegionWalker.java", "diffHunk": "@@ -45,12 +42,7 @@ public AssemblyRegionEvaluator assemblyRegionEvaluator() {\n \n     @Override\n     public void onTraversalStart() {\n-        try {\n-            outputStream = outputFile != null ? new PrintStream(outputFile) : System.out;\n-        }\n-        catch ( final FileNotFoundException e ) {\n-            throw new UserException.CouldNotCreateOutputFile(outputFile, e);\n-        }\n+        outputStream = outputFile != null ? new PrintStream(outputFile.getOutputStream()) : System.out;", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5NDg0Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520094847", "bodyText": "I added back in a catch block for Exception since there are no checked exceptions thrown (though that won't catch the Error explicitly thrown by OutputStreamWriter).", "author": "cmnbroad", "createdAt": "2020-11-09T20:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNDM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMTI4MA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520731280", "bodyText": "Can/should we explicitly catch the Error here (and in other places where OutputStreamWriter is used)?", "author": "droazen", "createdAt": "2020-11-10T17:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNDM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1MjI1OA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520752258", "bodyText": "I thought catching Error was generally discouraged, so its seems like bad form, especially in sample code. I think if we really want to do it right we should eliminate the use of  PrintStream - those classes seem sketchy around.", "author": "cmnbroad", "createdAt": "2020-11-10T17:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNDM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1MzQ1MA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520753450", "bodyText": "@cmnbroad I think it's ok to catch Error just to wrap it in a nicer exception type (ie., UserException). I believe what's discouraged is catching Error and then attempting to recover from it.", "author": "droazen", "createdAt": "2020-11-10T17:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNDM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNzE1NA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516907154", "bodyText": "The OutputStreamWriter constructor can throw -- we should catch any exceptions thrown by it, and wrap within a UserException as before.", "author": "droazen", "createdAt": "2020-11-03T19:31:24Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerEngine.java", "diffHunk": "@@ -165,11 +164,7 @@ public HaplotypeCallerEngine(final HaplotypeCallerArgumentCollection hcArgs, Ass\n         forceCallingAllelesPresent = hcArgs.alleles != null;\n         initialize(createBamOutIndex, createBamOutMD5);\n         if (hcArgs.assemblyStateOutput != null) {\n-            try {\n-                assemblyDebugOutStream = new PrintStream(Files.newOutputStream(IOUtils.getPath(hcArgs.assemblyStateOutput)));\n-            } catch (IOException e) {\n-                throw new UserException.CouldNotCreateOutputFile(hcArgs.assemblyStateOutput, \"Provided argument for assembly debug graph location could not be created\");\n-            }\n+            assemblyDebugOutStream = new OutputStreamWriter(hcArgs.assemblyStateOutput.getOutputStream());", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwODg5MA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516908890", "bodyText": "You've switched from calling println() (which writes a newline to the stream) to calling write() (which I don't believe writes a newline).", "author": "droazen", "createdAt": "2020-11-03T19:34:37Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerEngine.java", "diffHunk": "@@ -531,19 +526,28 @@ public ActivityProfileState isActive( final AlignmentContext context, final Refe\n         }\n \n         if (assemblyDebugOutStream != null) {\n-            assemblyDebugOutStream.println(\"\\n\\n\\n\\n\"+region.getSpan()+\"\\nNumber of reads in region: \" + region.getReads().size() + \"     they are:\");\n-            for (GATKRead read : region.getReads()) {\n-                assemblyDebugOutStream.println(read.getName() + \"   \" + read.convertToSAMRecord(region.getHeader()).getFlags());\n+            try {\n+                assemblyDebugOutStream.write(\"\\n\\n\\n\\n\" + region.getSpan() + \"\\nNumber of reads in region: \" + region.getReads().size() + \"     they are:\");\n+                for (GATKRead read : region.getReads()) {\n+                    assemblyDebugOutStream.write(read.getName() + \"   \" + read.convertToSAMRecord(region.getHeader()).getFlags());", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5NzM3NA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520097374", "bodyText": "Oh yeah right - fixed.", "author": "cmnbroad", "createdAt": "2020-11-09T20:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwODg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwOTE1NA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516909154", "bodyText": "fix indentation here", "author": "droazen", "createdAt": "2020-11-03T19:35:06Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerEngine.java", "diffHunk": "@@ -531,19 +526,28 @@ public ActivityProfileState isActive( final AlignmentContext context, final Refe\n         }\n \n         if (assemblyDebugOutStream != null) {\n-            assemblyDebugOutStream.println(\"\\n\\n\\n\\n\"+region.getSpan()+\"\\nNumber of reads in region: \" + region.getReads().size() + \"     they are:\");\n-            for (GATKRead read : region.getReads()) {\n-                assemblyDebugOutStream.println(read.getName() + \"   \" + read.convertToSAMRecord(region.getHeader()).getFlags());\n+            try {\n+                assemblyDebugOutStream.write(\"\\n\\n\\n\\n\" + region.getSpan() + \"\\nNumber of reads in region: \" + region.getReads().size() + \"     they are:\");\n+                for (GATKRead read : region.getReads()) {\n+                    assemblyDebugOutStream.write(read.getName() + \"   \" + read.convertToSAMRecord(region.getHeader()).getFlags());\n+                }\n+            } catch (IOException e) {\n+                throw new UserException(\"Error writing to debug output stream\", e);\n             }\n-        }\n+    }\n \n-        // run the local assembler, getting back a collection of information on how we should proceed\n+\n+    // run the local assembler, getting back a collection of information on how we should proceed", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5NzQzNw==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520097437", "bodyText": "Fixed.", "author": "cmnbroad", "createdAt": "2020-11-09T20:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwOTE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwOTMwOA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516909308", "bodyText": "Here too you've switched from calling println() (which writes a newline to the stream) to calling write() (which I don't believe writes a newline).", "author": "droazen", "createdAt": "2020-11-03T19:35:22Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerEngine.java", "diffHunk": "@@ -531,19 +526,28 @@ public ActivityProfileState isActive( final AlignmentContext context, final Refe\n         }\n \n         if (assemblyDebugOutStream != null) {\n-            assemblyDebugOutStream.println(\"\\n\\n\\n\\n\"+region.getSpan()+\"\\nNumber of reads in region: \" + region.getReads().size() + \"     they are:\");\n-            for (GATKRead read : region.getReads()) {\n-                assemblyDebugOutStream.println(read.getName() + \"   \" + read.convertToSAMRecord(region.getHeader()).getFlags());\n+            try {\n+                assemblyDebugOutStream.write(\"\\n\\n\\n\\n\" + region.getSpan() + \"\\nNumber of reads in region: \" + region.getReads().size() + \"     they are:\");\n+                for (GATKRead read : region.getReads()) {\n+                    assemblyDebugOutStream.write(read.getName() + \"   \" + read.convertToSAMRecord(region.getHeader()).getFlags());\n+                }\n+            } catch (IOException e) {\n+                throw new UserException(\"Error writing to debug output stream\", e);\n             }\n-        }\n+    }\n \n-        // run the local assembler, getting back a collection of information on how we should proceed\n+\n+    // run the local assembler, getting back a collection of information on how we should proceed\n         final AssemblyResultSet untrimmedAssemblyResult =  AssemblyBasedCallerUtils.assembleReads(region, givenAlleles, hcArgs, readsHeader, samplesList, logger, referenceReader, assemblyEngine, aligner, !hcArgs.doNotCorrectOverlappingBaseQualities);\n \n         if (assemblyDebugOutStream != null) {\n-            assemblyDebugOutStream.println(\"\\nThere were \" + untrimmedAssemblyResult.getHaplotypeList().size() + \" haplotypes found. Here they are:\");\n-            for (String haplotype : untrimmedAssemblyResult.getHaplotypeList().stream().map(haplotype -> haplotype.toString()).sorted().collect(Collectors.toList())) {\n-                assemblyDebugOutStream.println(haplotype);\n+            try {\n+                assemblyDebugOutStream.write(\"\\nThere were \" + untrimmedAssemblyResult.getHaplotypeList().size() + \" haplotypes found. Here they are:\");\n+                for (String haplotype : untrimmedAssemblyResult.getHaplotypeList().stream().map(haplotype -> haplotype.toString()).sorted().collect(Collectors.toList())) {\n+                    assemblyDebugOutStream.write(haplotype);", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5NzUwOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520097509", "bodyText": "Fixed.", "author": "cmnbroad", "createdAt": "2020-11-09T20:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwOTMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwOTYyMQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516909621", "bodyText": "closingdebug -> closing debug", "author": "droazen", "createdAt": "2020-11-03T19:35:58Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerEngine.java", "diffHunk": "@@ -714,7 +718,11 @@ public void shutdown() {\n         }\n \n         if (assemblyDebugOutStream != null) {\n-            assemblyDebugOutStream.close();\n+            try {\n+                assemblyDebugOutStream.close();\n+            } catch (IOException e) {\n+                throw new UserException(\"Error closingdebug output stream\", e);", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5NzU3NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520097575", "bodyText": "Done.", "author": "cmnbroad", "createdAt": "2020-11-09T20:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwOTYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxMzA4MA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516913080", "bodyText": "You need to call checkError() after print(), since print() can also set the error flag.", "author": "droazen", "createdAt": "2020-11-03T19:42:19Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/vqsr/VariantRecalibrator.java", "diffHunk": "@@ -653,10 +655,11 @@ public Object onTraversalSuccess() {\n                     if (goodModel.failedToConverge) {\n                         if (outputModel != null) {\n                             final GATKReport report = writeModelReport(goodModel, null, USE_ANNOTATIONS);\n-                            try (final PrintStream modelReportStream = new PrintStream(outputModel)) {\n+                            try (final PrintStream modelReportStream = new PrintStream(outputModel.getOutputStream())) {\n+                                if (modelReportStream.checkError()) {\n+                                    throw new UserException.CouldNotCreateOutputFile(outputModel, \"I/O stream error writing to report output\");\n+                                }\n                                 report.print(modelReportStream);", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxMzcwNA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516913704", "bodyText": "Also, as noted above the PrintStream constructor internally creates an OutputStreamWriter, which can throw an exception. We should catch that exception and wrap in a UserException", "author": "droazen", "createdAt": "2020-11-03T19:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxMzA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEwODg2OA==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r520108868", "bodyText": "Done - moved to a separate private method to consolidate the two call sites with this problem. Its still kind of awkward though - we really need to fix GATKReport (which is already included in the list in #6610).", "author": "cmnbroad", "createdAt": "2020-11-09T20:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxMzA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxNDA0MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6718#discussion_r516914041", "bodyText": "Same problems here -- need to call checkError() after print(), not before, and need to handle the exception that can be thrown by the PrintStream constructor", "author": "droazen", "createdAt": "2020-11-03T19:44:10Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/vqsr/VariantRecalibrator.java", "diffHunk": "@@ -680,10 +683,11 @@ public Object onTraversalSuccess() {\n \n                 if (outputModel != null) {\n                     final GATKReport report = writeModelReport(goodModel, badModel, USE_ANNOTATIONS);\n-                    try (final PrintStream modelReportStream = new PrintStream(outputModel)) {\n+                    try (final PrintStream modelReportStream = new PrintStream(outputModel.getOutputStream())) {\n+                        if (modelReportStream.checkError()) {\n+                            throw new UserException.CouldNotCreateOutputFile(outputModel, \"I/O stream error writing to report output\");\n+                        }\n                         report.print(modelReportStream);", "originalCommit": "d507ac3aec3aae01f2c1f9a420bf009fea0b485e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "261561db338bebb705046d0e9629805ca6f61dde", "url": "https://github.com/broadinstitute/gatk/commit/261561db338bebb705046d0e9629805ca6f61dde", "message": "GATKPath migration for VCF inputs and outputs. WIP.", "committedDate": "2020-11-16T16:34:03Z", "type": "commit"}, {"oid": "f655fc281df34ec0436a8e5b883536be07740bb7", "url": "https://github.com/broadinstitute/gatk/commit/f655fc281df34ec0436a8e5b883536be07740bb7", "message": "GATKPath migration for sample, pedigree files and annotations.", "committedDate": "2020-11-16T16:34:03Z", "type": "commit"}, {"oid": "dbb05350ecbe6b4a4e09da3d1369a1197d717bb5", "url": "https://github.com/broadinstitute/gatk/commit/dbb05350ecbe6b4a4e09da3d1369a1197d717bb5", "message": "GATKPath for more tools inputs and outputs.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "d0fba630f5f079d3a5c7fb7824164a86a7784f23", "url": "https://github.com/broadinstitute/gatk/commit/d0fba630f5f079d3a5c7fb7824164a86a7784f23", "message": "Stash temp WIP.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "ba7bf419c370c58ce08a136afa81a1ee870dcc9d", "url": "https://github.com/broadinstitute/gatk/commit/ba7bf419c370c58ce08a136afa81a1ee870dcc9d", "message": "More updates.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "886e360ebfba2ffc79ac86a2317fed6334d1a814", "url": "https://github.com/broadinstitute/gatk/commit/886e360ebfba2ffc79ac86a2317fed6334d1a814", "message": "Update ReferenceUtils.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "3613b4df22d3c0b5c36451347c310b72c559078e", "url": "https://github.com/broadinstitute/gatk/commit/3613b4df22d3c0b5c36451347c310b72c559078e", "message": "Repair imports.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "759337d5123ba4287f7ab6ecac869ed8b7f9a2b8", "url": "https://github.com/broadinstitute/gatk/commit/759337d5123ba4287f7ab6ecac869ed8b7f9a2b8", "message": "Fix IOException handling issues raised in code review.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "b849e2f9b09fba9850b3f61d3f55285697465a46", "url": "https://github.com/broadinstitute/gatk/commit/b849e2f9b09fba9850b3f61d3f55285697465a46", "message": "Fix comment in CNNScoreVariants.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "53c9c26cec71fe0d4f9d58acc65d6dfab7cfe6d6", "url": "https://github.com/broadinstitute/gatk/commit/53c9c26cec71fe0d4f9d58acc65d6dfab7cfe6d6", "message": "Add GATKPath copy constructor.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "c2239cdb6d27e552f5f41e7a48d8200ada780048", "url": "https://github.com/broadinstitute/gatk/commit/c2239cdb6d27e552f5f41e7a48d8200ada780048", "message": "Update FeatureInput to use the GATKPath copy constructor.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "f05549bd26d5e88b111baac84a2396eff2253949", "url": "https://github.com/broadinstitute/gatk/commit/f05549bd26d5e88b111baac84a2396eff2253949", "message": "Add serialVersionUID to test code.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "d07e45ed9141579d7622fc13660295863fd3d38d", "url": "https://github.com/broadinstitute/gatk/commit/d07e45ed9141579d7622fc13660295863fd3d38d", "message": "More code review comments.", "committedDate": "2020-11-16T16:34:04Z", "type": "commit"}, {"oid": "d07e45ed9141579d7622fc13660295863fd3d38d", "url": "https://github.com/broadinstitute/gatk/commit/d07e45ed9141579d7622fc13660295863fd3d38d", "message": "More code review comments.", "committedDate": "2020-11-16T16:34:04Z", "type": "forcePushed"}]}