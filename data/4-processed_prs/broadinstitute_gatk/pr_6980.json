{"pr_number": 6980, "pr_title": "Added a script to publish GATK tool WDLs for each release", "pr_createdAt": "2020-11-25T17:56:30Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6980", "timeline": [{"oid": "e40548dfb73c18746d0ebf3b31b22b5f85d5b9af", "url": "https://github.com/broadinstitute/gatk/commit/e40548dfb73c18746d0ebf3b31b22b5f85d5b9af", "message": "Added a script to publish GATK tool WDLs for each release", "committedDate": "2020-11-25T17:46:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU1NTk2Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6980#discussion_r530555962", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #!/bin/bash\n          \n          \n            \n            #!/usr/bin/env bash", "author": "jonn-smith", "createdAt": "2020-11-25T17:58:44Z", "path": "scripts/publish_gatk_tool_wdls.sh", "diffHunk": "@@ -0,0 +1,113 @@\n+#!/bin/bash", "originalCommit": "e40548dfb73c18746d0ebf3b31b22b5f85d5b9af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1MjAyMw==", "url": "https://github.com/broadinstitute/gatk/pull/6980#discussion_r530652023", "bodyText": "To do this sort of thing I usually recommend trapping error/exit signals as well, but this is probably fine for now.", "author": "jonn-smith", "createdAt": "2020-11-25T21:30:21Z", "path": "scripts/publish_gatk_tool_wdls.sh", "diffHunk": "@@ -0,0 +1,113 @@\n+#!/bin/bash\n+#\n+# A script to generate the GATK tool WDLs for a specified GATK release, and publish them\n+# to the GATK tool WDL github repository broadinstitute/gatk-tool-wdls.\n+#\n+# Must be run from the root of a GATK clone.\n+#\n+# Usage: bash scripts/publish_gatk_tool_wdls.sh <gatk_version_tag>\n+#\n+# Eg.,   bash scripts/publish_gatk_tool_wdls.sh 4.1.9.0\n+#\n+# The specified GATK version will also be used to tag the WDLs themselves in\n+# broadinstitute/gatk-tool-wdls\n+#\n+\n+if [ $# -ne 1 ]; then\n+  echo \"Usage: $0 <gatk_version_tag>\"\n+  exit 1\n+fi\n+\n+GATK_VERSION=\"$1\"\n+GATK_CLONE_ROOT=$( pwd )\n+GATK_WDL_REPO=\"git@github.com:broadinstitute/gatk-tool-wdls.git\"\n+WDL_STAGING_AREA=\"wdl_staging_area\"\n+WDL_GEN_DIR=\"build/docs/wdlGen\"\n+DOCKSTORE_YML=\".dockstore.yml\"\n+\n+function cleanup() {", "originalCommit": "e40548dfb73c18746d0ebf3b31b22b5f85d5b9af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1NDY0NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6980#discussion_r530654645", "bodyText": "This seems a little dangerous to do without first somehow having a confirmation with the user that this is going to happen.\nYou can add this function at the top and the following block of code to code to line 57 to add an annoying confirmation request:\n# Get an answer from the user in as annoying a method as possible.\n# Example:\n#  getAnswerFromUser \"Are you sure you want to CLEAR the listed records? \" 'Yes No' answer \nfunction getAnswerFromUser()\n{\n  local prompt=\"${1}\" \n  local acceptableValues=\"${2}\"\n  local responseVar=\"${3}\" \n\n  local haveGoodValue=false\n  while ! ${haveGoodValue} ; do\n    read -p \"${prompt} [$( echo ${acceptableValues} | tr ' ' '/' )] : \" ${responseVar}\n\n    for okVal in ${acceptableValues} ; do\n      if [[ \"$( echo ${!responseVar} | tr a-z A-Z)\" == \"$( echo ${okVal} | tr a-z A-Z)\" ]] ; then\n        haveGoodValue=true\n      fi  \n    done\n\n    ! ${haveGoodValue} && error \"Please enter one of the following: $( echo ${acceptableValues} | tr ' ' '/' )\" && error \"\"\n  done\n}\n\ngetAnswerFromUser \"${0}: Are you sure you want to build the documentation for GATK version: ${GATK_VERSION} and publish the results to the internet?\" 'Yes No' answer \nif [[ \"${answer}\" != \"Yes\" ]] ; then\n    fatal_error \"${0}: User Aborted.\"\nfi", "author": "jonn-smith", "createdAt": "2020-11-25T21:37:20Z", "path": "scripts/publish_gatk_tool_wdls.sh", "diffHunk": "@@ -0,0 +1,113 @@\n+#!/bin/bash\n+#\n+# A script to generate the GATK tool WDLs for a specified GATK release, and publish them\n+# to the GATK tool WDL github repository broadinstitute/gatk-tool-wdls.\n+#\n+# Must be run from the root of a GATK clone.\n+#\n+# Usage: bash scripts/publish_gatk_tool_wdls.sh <gatk_version_tag>\n+#\n+# Eg.,   bash scripts/publish_gatk_tool_wdls.sh 4.1.9.0\n+#\n+# The specified GATK version will also be used to tag the WDLs themselves in\n+# broadinstitute/gatk-tool-wdls\n+#\n+\n+if [ $# -ne 1 ]; then\n+  echo \"Usage: $0 <gatk_version_tag>\"\n+  exit 1\n+fi\n+\n+GATK_VERSION=\"$1\"\n+GATK_CLONE_ROOT=$( pwd )\n+GATK_WDL_REPO=\"git@github.com:broadinstitute/gatk-tool-wdls.git\"\n+WDL_STAGING_AREA=\"wdl_staging_area\"\n+WDL_GEN_DIR=\"build/docs/wdlGen\"\n+DOCKSTORE_YML=\".dockstore.yml\"\n+\n+function cleanup() {\n+  cd \"${GATK_CLONE_ROOT}\"\n+  rm -rf \"${WDL_STAGING_AREA}\"\n+}\n+\n+function fatal_error() {\n+  echo \"$1\" 1>&2\n+  cleanup\n+  exit 1\n+}\n+\n+function generate_dockstore_yml() {\n+  local WDL_DIR=\"$1\"\n+  local YML_FILE=\"$2\"\n+\n+  printf \"version: 1.2\\n\" > \"${YML_FILE}\"\n+  printf \"workflows:\\n\" >> \"${YML_FILE}\"\n+\n+  for wdl in ${WDL_DIR}/*.wdl; do\n+    local WDL_NAME=$( basename \"${wdl}\" .wdl )\n+    local WDL_JSON=\"${WDL_NAME}Inputs.json\"\n+\n+    printf \"   - name: %s\\n\" \"${WDL_NAME}\" >> \"${YML_FILE}\"\n+    printf \"     subclass: WDL\\n\" >> \"${YML_FILE}\"\n+    printf \"     primaryDescriptorPath: %s\\n\" \"/${WDL_DIR}/${WDL_NAME}.wdl\" >> \"${YML_FILE}\"\n+    printf \"     testParameterFiles:\\n\" >> \"${YML_FILE}\"\n+    printf \"     -  %s\\n\" \"/${WDL_DIR}/${WDL_JSON}\" >> \"${YML_FILE}\"\n+  done\n+}\n+\n+# Checkout the GATK version for which we are publishing WDLs\n+echo \"$0: Checking out GATK version ${GATK_VERSION}\"\n+git checkout -f \"${GATK_VERSION}\"\n+if [ $? -ne 0 ]; then\n+  fatal_error \"Failed to checkout GATK version ${GATK_VERSION}\"\n+fi\n+\n+# Get a fresh clone of the GATK WDL repo, and delete all existing WDLs\n+echo \"$0: Cloning ${GATK_WDL_REPO} into ${WDL_STAGING_AREA}\"\n+cleanup\n+git clone \"${GATK_WDL_REPO}\" \"${WDL_STAGING_AREA}\"\n+if [ $? -ne 0 ]; then\n+  fatal_error \"Failed to clone GATK WDL repo ${GATK_WDL_REPO}\"\n+fi\n+\n+rm -rf \"${WDL_STAGING_AREA}/wdls\"\n+mkdir \"${WDL_STAGING_AREA}/wdls\"\n+\n+# Generate the GATK WDLs, copy into our clone of the WDL repo, and delete the test WDLs\n+echo \"$0: Running GATK WDL generation\"\n+./gradlew clean gatkWDLGen\n+if [ $? -ne 0 ]; then\n+  fatal_error \"Unable to generate the GATK tool WDLs\"\n+fi\n+\n+echo \"$0: Copying WDLs to staging area\"\n+cp ${WDL_GEN_DIR}/* \"${WDL_STAGING_AREA}/wdls\"\n+rm -f ${WDL_STAGING_AREA}/wdls/*Test.wdl\n+rm -f ${WDL_STAGING_AREA}/wdls/*TestInputs.json\n+rm -f ${WDL_STAGING_AREA}/wdls/*.html\n+\n+# Switch to the root of our WDL staging clone, and add the WDLs we just generated to git\n+cd \"${WDL_STAGING_AREA}\"\n+git add wdls/*\n+\n+# Regenerate the .dockstore.yml file\n+echo \"$0: Generating .dockstore.yml\"\n+rm -f \"${DOCKSTORE_YML}\"\n+generate_dockstore_yml wdls \"${DOCKSTORE_YML}\"\n+git add \"${DOCKSTORE_YML}\"\n+\n+# Commit, tag, and push the WDLs\n+echo \"$0: Pushing to github\"\n+git commit -a -m \"Version ${GATK_VERSION} of the GATK tool WDLs\"\n+git tag -a -f -m \"Version ${GATK_VERSION} of the GATK tool WDLs\" \"${GATK_VERSION}\"\n+git push -f --tags origin HEAD:master", "originalCommit": "e40548dfb73c18746d0ebf3b31b22b5f85d5b9af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1NzE0Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6980#discussion_r530657143", "bodyText": "Nevermind this one - I didn't realize this was designed to be non-interactive.", "author": "jonn-smith", "createdAt": "2020-11-25T21:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1NDY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1NzQzMg==", "url": "https://github.com/broadinstitute/gatk/pull/6980#discussion_r530657432", "bodyText": "Normally I'd agree, but in this case this script will be run by an automated process during releases, not manually by users.", "author": "droazen", "createdAt": "2020-11-25T21:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1NDY0NQ=="}], "type": "inlineReview"}]}