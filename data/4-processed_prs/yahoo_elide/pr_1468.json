{"pr_number": 1468, "pr_title": "Disable Aggregation DataStore by default", "pr_createdAt": "2020-07-27T20:24:34Z", "pr_url": "https://github.com/yahoo/elide/pull/1468", "timeline": [{"oid": "699491f3fe0268ebb63471e9f2038f367f9aee1f", "url": "https://github.com/yahoo/elide/commit/699491f3fe0268ebb63471e9f2038f367f9aee1f", "message": "Elide Standalone: Disable Aggregation DataStore by default", "committedDate": "2020-07-28T13:25:58Z", "type": "commit"}, {"oid": "699491f3fe0268ebb63471e9f2038f367f9aee1f", "url": "https://github.com/yahoo/elide/commit/699491f3fe0268ebb63471e9f2038f367f9aee1f", "message": "Elide Standalone: Disable Aggregation DataStore by default", "committedDate": "2020-07-28T13:25:58Z", "type": "forcePushed"}, {"oid": "57bf092e5fd3d32cb17239d328d74a2b189cc5ec", "url": "https://github.com/yahoo/elide/commit/57bf092e5fd3d32cb17239d328d74a2b189cc5ec", "message": "Elide Springboot: Disable Aggregation DataStore by default", "committedDate": "2020-07-28T18:41:09Z", "type": "commit"}, {"oid": "0506887baef1d083c370f1fd33e3ad7b422e7d09", "url": "https://github.com/yahoo/elide/commit/0506887baef1d083c370f1fd33e3ad7b422e7d09", "message": "Elide Springboot: Integration Test for Disable Aggregation DataStore by default", "committedDate": "2020-07-28T21:05:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MTAxMg==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461891012", "bodyText": "Remove commented code.", "author": "moizarafat", "createdAt": "2020-07-28T21:29:34Z", "path": "elide-spring/elide-spring-boot-autoconfigure/src/main/java/com/yahoo/elide/spring/config/ElideDynamicConfiguration.java", "diffHunk": "@@ -44,7 +44,8 @@\n @Slf4j\n @Configuration\n @EnableConfigurationProperties(ElideConfigProperties.class)\n-@ConditionalOnExpression(\"${elide.dynamic-config.enabled:false}\")\n+//@ConditionalOnExpression(\"${elide.dynamic-config.enabled}\")", "originalCommit": "0506887baef1d083c370f1fd33e3ad7b422e7d09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MTU4MA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461891580", "bodyText": "Instead of reusing ControllerProperties, we should create a new properties file.", "author": "moizarafat", "createdAt": "2020-07-28T21:30:40Z", "path": "elide-spring/elide-spring-boot-autoconfigure/src/main/java/com/yahoo/elide/spring/config/ElideConfigProperties.java", "diffHunk": "@@ -43,6 +43,11 @@\n      */\n     private DynamicConfigProperties dynamicConfig;\n \n+    /**\n+     * Settings for the Aggregation Store.\n+     */\n+    private ControllerProperties aggregationStore;", "originalCommit": "0506887baef1d083c370f1fd33e3ad7b422e7d09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5NTc3Mw==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461895773", "bodyText": "Sure.", "author": "rishi-aga", "createdAt": "2020-07-28T21:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MTU4MA=="}], "type": "inlineReview"}, {"oid": "2d57168846e3decdfc9de64d2eec76037d272d34", "url": "https://github.com/yahoo/elide/commit/2d57168846e3decdfc9de64d2eec76037d272d34", "message": "Review Comments", "committedDate": "2020-07-28T21:39:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5MTk0Ng==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461991946", "bodyText": "you can just return jpaDataStore", "author": "moizarafat", "createdAt": "2020-07-29T01:55:27Z", "path": "elide-spring/elide-spring-boot-autoconfigure/src/main/java/com/yahoo/elide/spring/config/ElideAutoConfiguration.java", "diffHunk": "@@ -185,29 +191,35 @@ public QueryEngine buildQueryEngine(EntityManagerFactory entityManagerFactory,\n     @ConditionalOnMissingBean\n     @DependsOn({\"buildQueryLogger\"})\n     public DataStore buildDataStore(EntityManagerFactory entityManagerFactory,\n-                                    QueryEngine queryEngine,\n+                                    ObjectProvider<QueryEngine> queryEngine,\n                                     ObjectProvider<ElideDynamicEntityCompiler> dynamicCompiler,\n                                     ElideConfigProperties settings,\n                                     @Autowired(required = false) Cache cache,\n                                     @Autowired(required = false) QueryLogger querylogger)\n             throws ClassNotFoundException {\n-        AggregationDataStore.AggregationDataStoreBuilder aggregationDataStoreBuilder = AggregationDataStore.builder()\n-                .queryEngine(queryEngine);\n-        if (isDynamicConfigEnabled(settings)) {\n-            ElideDynamicEntityCompiler compiler = dynamicCompiler.getIfAvailable();\n-            Set<Class<?>> annotatedClass = compiler.findAnnotatedClasses(FromTable.class);\n-            annotatedClass.addAll(compiler.findAnnotatedClasses(FromSubquery.class));\n-            aggregationDataStoreBuilder.dynamicCompiledClasses(annotatedClass);\n-        }\n-        aggregationDataStoreBuilder.cache(cache);\n-        aggregationDataStoreBuilder.queryLogger(querylogger);\n-        AggregationDataStore aggregationDataStore = aggregationDataStoreBuilder.build();\n \n         JpaDataStore jpaDataStore = new JpaDataStore(entityManagerFactory::createEntityManager,\n                                                      (em) -> { return new NonJtaTransaction(em, txCancel); });\n \n-        // meta data store needs to be put at first to populate meta data models\n-        return new MultiplexManager(jpaDataStore, queryEngine.getMetaDataStore(), aggregationDataStore);\n+        if (isAggregationStoreEnabled(settings)) {\n+            AggregationDataStore.AggregationDataStoreBuilder aggregationDataStoreBuilder =\n+                            AggregationDataStore.builder().queryEngine(queryEngine.getIfAvailable());\n+            if (isDynamicConfigEnabled(settings)) {\n+                ElideDynamicEntityCompiler compiler = dynamicCompiler.getIfAvailable();\n+                Set<Class<?>> annotatedClass = compiler.findAnnotatedClasses(FromTable.class);\n+                annotatedClass.addAll(compiler.findAnnotatedClasses(FromSubquery.class));\n+                aggregationDataStoreBuilder.dynamicCompiledClasses(annotatedClass);\n+            }\n+            aggregationDataStoreBuilder.cache(cache);\n+            aggregationDataStoreBuilder.queryLogger(querylogger);\n+            AggregationDataStore aggregationDataStore = aggregationDataStoreBuilder.build();\n+\n+            // meta data store needs to be put at first to populate meta data models\n+            return new MultiplexManager(jpaDataStore, queryEngine.getIfAvailable().getMetaDataStore(),\n+                            aggregationDataStore);\n+        }\n+\n+        return new MultiplexManager(jpaDataStore);", "originalCommit": "2d57168846e3decdfc9de64d2eec76037d272d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM2NzY5Ng==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462367696", "bodyText": "sure.", "author": "rishi-aga", "createdAt": "2020-07-29T15:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5MTk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5NzUyNA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461997524", "bodyText": "2020", "author": "moizarafat", "createdAt": "2020-07-29T02:15:54Z", "path": "elide-spring/elide-spring-boot-autoconfigure/src/test/java/example/tests/DisableAggStoreControllerTest.java", "diffHunk": "@@ -0,0 +1,418 @@\n+/*\n+ * Copyright 2019, Yahoo Inc.", "originalCommit": "2d57168846e3decdfc9de64d2eec76037d272d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5NzkxOQ==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461997919", "bodyText": "Since this class is exact replica of ControllerTest with few minor differences. I suggest we have ControllerBaseTest class with all the common test cases and ControllerTest and DisableAggStoreControllerTest will both inherit this class and add any unique test cases. This would keep making updates to test cases easier.", "author": "moizarafat", "createdAt": "2020-07-29T02:17:12Z", "path": "elide-spring/elide-spring-boot-autoconfigure/src/test/java/example/tests/DisableAggStoreControllerTest.java", "diffHunk": "@@ -0,0 +1,418 @@\n+/*\n+ * Copyright 2019, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package example.tests;\n+\n+import static com.yahoo.elide.contrib.testhelpers.graphql.GraphQLDSL.argument;\n+import static com.yahoo.elide.contrib.testhelpers.graphql.GraphQLDSL.arguments;\n+import static com.yahoo.elide.contrib.testhelpers.graphql.GraphQLDSL.field;\n+import static com.yahoo.elide.contrib.testhelpers.graphql.GraphQLDSL.query;\n+import static com.yahoo.elide.contrib.testhelpers.graphql.GraphQLDSL.selection;\n+import static com.yahoo.elide.contrib.testhelpers.graphql.GraphQLDSL.selections;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.attr;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.attributes;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.data;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.datum;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.id;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.linkage;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.patchOperation;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.patchSet;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.relation;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.relationships;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.resource;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.type;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.elements.PatchOperationType.add;\n+import static io.restassured.RestAssured.given;\n+import static io.restassured.RestAssured.when;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.containsInAnyOrder;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+import com.yahoo.elide.contrib.testhelpers.graphql.GraphQLDSL;\n+import com.yahoo.elide.core.HttpStatus;\n+import com.yahoo.elide.spring.controllers.JsonApiController;\n+import example.models.jpa.ArtifactGroup;\n+\n+import org.junit.jupiter.api.Test;\n+import org.springframework.test.context.jdbc.Sql;\n+import org.springframework.test.context.jdbc.SqlMergeMode;\n+\n+import java.io.IOException;\n+import javax.ws.rs.core.MediaType;\n+\n+/**\n+ * Example functional test.\n+ */\n+@SqlMergeMode(SqlMergeMode.MergeMode.MERGE)\n+@Sql(executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD,\n+        statements = \"INSERT INTO ArtifactGroup (name, commonName, description, deprecated) VALUES\\n\"\n+                + \"\\t\\t('com.example.repository','Example Repository','The code for this project', false);\")\n+@Sql(executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD,\n+        statements = \"DELETE FROM ArtifactVersion; DELETE FROM ArtifactProduct; DELETE FROM ArtifactGroup;\")\n+public class DisableAggStoreControllerTest extends DisableAggStoreIntegrationTest {", "originalCommit": "2d57168846e3decdfc9de64d2eec76037d272d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM2OTM5MQ==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462369391", "bodyText": "changed to DisableAggStoreControllerTest inheriting and overriding from ControllerTest. I can pass profile in sub class so removing DisableAggStoreIntegrationTest.", "author": "rishi-aga", "createdAt": "2020-07-29T15:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5NzkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5ODgwMg==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461998802", "bodyText": "you can just return jpaDataStore", "author": "moizarafat", "createdAt": "2020-07-29T02:20:37Z", "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -400,13 +409,19 @@ default Cache getQueryCache() {\n      * @param entityManagerFactory EntityManagerFactory object.\n      * @return EntityDictionary object initialized.\n      */\n-    default DataStore getDataStore(MetaDataStore metaDataStore, AggregationDataStore aggregationDataStore,\n-            EntityManagerFactory entityManagerFactory) {\n+    default DataStore getDataStore(Optional<MetaDataStore> metaDataStore,\n+            Optional<AggregationDataStore> aggregationDataStore, EntityManagerFactory entityManagerFactory) {\n         DataStore jpaDataStore = new JpaDataStore(\n                 () -> { return entityManagerFactory.createEntityManager(); },\n                 (em) -> { return new NonJtaTransaction(em, TXCANCEL); });\n \n-        DataStore dataStore = new MultiplexManager(jpaDataStore, metaDataStore, aggregationDataStore);\n+        DataStore dataStore = null;\n+\n+        if (enableAggregationDataStore()) {\n+            dataStore = new MultiplexManager(jpaDataStore, metaDataStore.get(), aggregationDataStore.get());\n+        } else {\n+            dataStore = new MultiplexManager(jpaDataStore);", "originalCommit": "2d57168846e3decdfc9de64d2eec76037d272d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM2OTY1MQ==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462369651", "bodyText": "sure.", "author": "rishi-aga", "createdAt": "2020-07-29T15:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5ODgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5OTUzOQ==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r461999539", "bodyText": "Can this extend ElideStandaloneTest as is ? and just override init and swaggerDocumentTest cases?", "author": "moizarafat", "createdAt": "2020-07-29T02:23:44Z", "path": "elide-standalone/src/test/java/example/ElideStandaloneDisableAggregationDataStoreTest.java", "diffHunk": "@@ -0,0 +1,296 @@\n+/*\n+ * Copyright 2018, Oath Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package example;\n+\n+import static com.yahoo.elide.Elide.JSONAPI_CONTENT_TYPE;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.attr;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.attributes;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.data;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.datum;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.id;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.resource;\n+import static com.yahoo.elide.contrib.testhelpers.jsonapi.JsonApiDSL.type;\n+import static io.restassured.RestAssured.given;\n+import static io.restassured.RestAssured.when;\n+import static org.hamcrest.CoreMatchers.equalTo;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.hamcrest.Matchers.containsInAnyOrder;\n+import static org.hamcrest.Matchers.hasKey;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+import com.yahoo.elide.async.service.AsyncQueryDAO;\n+import com.yahoo.elide.standalone.ElideStandalone;\n+import com.yahoo.elide.standalone.config.ElideStandaloneSettings;\n+import example.models.Post;\n+import org.apache.http.HttpStatus;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+\n+import io.restassured.response.Response;\n+\n+import java.util.Properties;\n+\n+import javax.ws.rs.core.MediaType;\n+\n+/**\n+ * Tests ElideStandalone starts and works.\n+ */\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+public class ElideStandaloneDisableAggregationDataStoreTest {", "originalCommit": "2d57168846e3decdfc9de64d2eec76037d272d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3MDI5MA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462370290", "bodyText": "Updated. Had to override testJsonAPIPost also.", "author": "rishi-aga", "createdAt": "2020-07-29T15:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk5OTUzOQ=="}], "type": "inlineReview"}, {"oid": "c711c630d9c32d77b5be805514d1af221a6252bf", "url": "https://github.com/yahoo/elide/commit/c711c630d9c32d77b5be805514d1af221a6252bf", "message": "Reuse Unit Tests", "committedDate": "2020-07-29T15:04:33Z", "type": "commit"}, {"oid": "78ffbcb7d565fe9cda1e2949ea1a5febb88401db", "url": "https://github.com/yahoo/elide/commit/78ffbcb7d565fe9cda1e2949ea1a5febb88401db", "message": "Checkstyle fixes", "committedDate": "2020-07-29T15:14:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNjkzOQ==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462406939", "bodyText": "What is the benefit of changing the bean argument from a QueryEngine to a function which returns a QueryEngine?", "author": "aklish", "createdAt": "2020-07-29T15:54:23Z", "path": "elide-spring/elide-spring-boot-autoconfigure/src/main/java/com/yahoo/elide/spring/config/ElideAutoConfiguration.java", "diffHunk": "@@ -185,29 +191,35 @@ public QueryEngine buildQueryEngine(EntityManagerFactory entityManagerFactory,\n     @ConditionalOnMissingBean\n     @DependsOn({\"buildQueryLogger\"})\n     public DataStore buildDataStore(EntityManagerFactory entityManagerFactory,\n-                                    QueryEngine queryEngine,\n+                                    ObjectProvider<QueryEngine> queryEngine,", "originalCommit": "78ffbcb7d565fe9cda1e2949ea1a5febb88401db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwODE0NA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462408144", "bodyText": "This method seems to have two mechanisms for optional bean arguments (required = false) and the ObjectProvider.  I think the former might be the \"Spring way\"", "author": "aklish", "createdAt": "2020-07-29T15:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNjkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwMDM0NA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462500344", "bodyText": "QueryEngine bean is not created if aggregation store is disabled, so its optional now.\nReplaced ObjectProvider with (required = false) for both queryEngine and compiler to make it consistent.", "author": "rishi-aga", "createdAt": "2020-07-29T18:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwNjkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwOTQxNA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462409414", "bodyText": "Was this intended to have tests?", "author": "aklish", "createdAt": "2020-07-29T15:57:45Z", "path": "elide-spring/elide-spring-boot-autoconfigure/src/test/java/example/tests/DisableAggStoreAsyncTest.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package example.tests;\n+\n+import org.springframework.test.context.ActiveProfiles;\n+\n+/**\n+ * Executes Async tests with Aggregation Store disabled.\n+ */\n+@ActiveProfiles(\"disableAggStore\")\n+public class DisableAggStoreAsyncTest extends AsyncTest {\n+", "originalCommit": "78ffbcb7d565fe9cda1e2949ea1a5febb88401db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxNzI2NA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462417264", "bodyText": "No. Ensures existing async tests pass with aggregation store disabled.", "author": "rishi-aga", "createdAt": "2020-07-29T16:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQwOTQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxMzM1Mw==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462413353", "bodyText": "If the enableAggregationDataStore is enabled, but the aggregation store or metadata store is not provided, we need a good way to alert the user to their configuration error.\nInstead of using so many optionals, I'm wondering if we should provide different getDataStore methods with different required parameters (that we use Precondition to check are non-null).  Elide can call the right one depending on what is enabled/disabled.", "author": "aklish", "createdAt": "2020-07-29T16:03:17Z", "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -400,35 +409,41 @@ default Cache getQueryCache() {\n      * @param entityManagerFactory EntityManagerFactory object.\n      * @return EntityDictionary object initialized.\n      */\n-    default DataStore getDataStore(MetaDataStore metaDataStore, AggregationDataStore aggregationDataStore,\n-            EntityManagerFactory entityManagerFactory) {\n+    default DataStore getDataStore(Optional<MetaDataStore> metaDataStore,\n+            Optional<AggregationDataStore> aggregationDataStore, EntityManagerFactory entityManagerFactory) {\n         DataStore jpaDataStore = new JpaDataStore(\n                 () -> { return entityManagerFactory.createEntityManager(); },\n                 (em) -> { return new NonJtaTransaction(em, TXCANCEL); });\n \n-        DataStore dataStore = new MultiplexManager(jpaDataStore, metaDataStore, aggregationDataStore);\n-\n-        return dataStore;\n+        return (enableAggregationDataStore())\n+                        ? new MultiplexManager(jpaDataStore, metaDataStore.get(), aggregationDataStore.get())", "originalCommit": "78ffbcb7d565fe9cda1e2949ea1a5febb88401db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2MjYxOA==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r462562618", "bodyText": "overloaded getDataStore method to avoid Optionals", "author": "rishi-aga", "createdAt": "2020-07-29T20:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxMzM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1NzIwMg==", "url": "https://github.com/yahoo/elide/pull/1468#discussion_r463157202", "bodyText": "Added null check for metadata store and aggregation store. Without these checks also application was failing to start by giving NPE during queryEngine.init and populateEntityDictionary methods.", "author": "rishi-aga", "createdAt": "2020-07-30T17:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQxMzM1Mw=="}], "type": "inlineReview"}, {"oid": "2a2d2b332a8959c6f1a915eda5cc3f26729b91b3", "url": "https://github.com/yahoo/elide/commit/2a2d2b332a8959c6f1a915eda5cc3f26729b91b3", "message": "Replace ObjectProvider for optional beans", "committedDate": "2020-07-29T18:25:27Z", "type": "commit"}, {"oid": "92c4ae9c98ab6431d39cec7b446cd019708c82e1", "url": "https://github.com/yahoo/elide/commit/92c4ae9c98ab6431d39cec7b446cd019708c82e1", "message": "Use ConditionalOnProperty for optional beans", "committedDate": "2020-07-29T19:33:31Z", "type": "commit"}, {"oid": "bdf0fe23ac06188e6661b57c4804ceb21890c84f", "url": "https://github.com/yahoo/elide/commit/bdf0fe23ac06188e6661b57c4804ceb21890c84f", "message": "Overload getDataStore method to avoid Optionals", "committedDate": "2020-07-29T19:54:54Z", "type": "commit"}, {"oid": "2df1d1398c6200a313753246e58fe9231d7e5a3b", "url": "https://github.com/yahoo/elide/commit/2df1d1398c6200a313753246e58fe9231d7e5a3b", "message": "Add check for missing datastore", "committedDate": "2020-07-30T17:24:46Z", "type": "commit"}]}