{"pr_number": 1565, "pr_title": "Dynamic Config Inheritance", "pr_createdAt": "2020-09-30T16:39:31Z", "pr_url": "https://github.com/yahoo/elide/pull/1565", "timeline": [{"oid": "387c0556cb527e091c2dd55a43e3b73f773a7aa8", "url": "https://github.com/yahoo/elide/commit/387c0556cb527e091c2dd55a43e3b73f773a7aa8", "message": "override flag", "committedDate": "2020-09-30T16:37:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxOTI2OQ==", "url": "https://github.com/yahoo/elide/pull/1565#discussion_r497719269", "bodyText": "Should we throw an error here?", "author": "moizarafat", "createdAt": "2020-09-30T18:33:56Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -117,13 +117,78 @@ public void readAndValidateConfigs() throws IOException {\n         this.setDbVariables(readVariableConfig(Config.DBVARIABLE));\n         this.elideSQLDBConfig.setDbconfigs(readDbConfig());\n         this.elideTableConfig.setTables(readTableConfig());\n+        populateInheritanceHierarchy();\n         validateRequiredConfigsProvided();\n         validateNameUniqueness(this.elideSQLDBConfig.getDbconfigs());\n         validateNameUniqueness(this.elideTableConfig.getTables());\n         validateSqlInTableConfig(this.elideTableConfig);\n         validateJoinedTablesDBConnectionName(this.elideTableConfig);\n     }\n \n+    private void populateInheritanceHierarchy() {\n+        for (Table table : this.elideTableConfig.getTables()) {\n+            Set<Table> parentTables = getParents(table);\n+            if (parentTables.size() > 0) {\n+//                table.setInheritanceHierarchy(parentTables);\n+                flagMeasuresToOverride(table, parentTables);\n+                flagDimensionsToOverride(table, parentTables);\n+            }\n+        }\n+    }\n+\n+    private void flagMeasuresToOverride(Table table, Set<Table> parentTables) {\n+        Set<String> parentClassMeasures = new HashSet<>();\n+        parentTables.forEach(obj -> {\n+            obj.getMeasures().forEach(measure -> {\n+                parentClassMeasures.add(measure.getName());\n+            });\n+        });\n+\n+        for (Measure measure : table.getMeasures()) {\n+            if (parentClassMeasures.contains(measure.getName())) {\n+                measure.setOverride(true);\n+            }\n+        }\n+    }\n+\n+    private void flagDimensionsToOverride(Table table, Set<Table> parentTables) {\n+        Set<String> parentClassDimensions = new HashSet<>();\n+        parentTables.forEach(obj -> {\n+            obj.getDimensions().forEach(dimension -> {\n+                parentClassDimensions.add(dimension.getName());\n+            });\n+        });\n+\n+        for (Dimension dimension : table.getDimensions()) {\n+            if (parentClassDimensions.contains(dimension.getName())) {\n+                dimension.setOverride(true);\n+            }\n+        }\n+    }\n+\n+    private Set<Table> getParents(Table table) {\n+        Set<Table> parentTables = new HashSet<>();\n+        while (table != null && !table.getExtend().equals(\"\")) {\n+            Table parent = getTableByName(table.getExtend());\n+            parentTables.add(parent);\n+            table = parent;\n+        }\n+        return parentTables;\n+    }\n+\n+    private Table getTableByName(String tableName) {\n+        for (Table table : this.elideTableConfig.getTables()) {\n+            if (table.getName().equals(tableName)) {\n+                return table;\n+            }\n+            else {\n+                log.warn(\"Table \" + tableName + \" is not defined in Dynamic Config.\");", "originalCommit": "387c0556cb527e091c2dd55a43e3b73f773a7aa8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMDQzNA==", "url": "https://github.com/yahoo/elide/pull/1565#discussion_r497720434", "bodyText": "else where we call this method, we should have a null check on the return value.", "author": "moizarafat", "createdAt": "2020-09-30T18:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxOTI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxOTY4NQ==", "url": "https://github.com/yahoo/elide/pull/1565#discussion_r497719685", "bodyText": "Remove commented code.", "author": "moizarafat", "createdAt": "2020-09-30T18:34:41Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -117,13 +117,78 @@ public void readAndValidateConfigs() throws IOException {\n         this.setDbVariables(readVariableConfig(Config.DBVARIABLE));\n         this.elideSQLDBConfig.setDbconfigs(readDbConfig());\n         this.elideTableConfig.setTables(readTableConfig());\n+        populateInheritanceHierarchy();\n         validateRequiredConfigsProvided();\n         validateNameUniqueness(this.elideSQLDBConfig.getDbconfigs());\n         validateNameUniqueness(this.elideTableConfig.getTables());\n         validateSqlInTableConfig(this.elideTableConfig);\n         validateJoinedTablesDBConnectionName(this.elideTableConfig);\n     }\n \n+    private void populateInheritanceHierarchy() {\n+        for (Table table : this.elideTableConfig.getTables()) {\n+            Set<Table> parentTables = getParents(table);\n+            if (parentTables.size() > 0) {\n+//                table.setInheritanceHierarchy(parentTables);", "originalCommit": "387c0556cb527e091c2dd55a43e3b73f773a7aa8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczMjUzOQ==", "url": "https://github.com/yahoo/elide/pull/1565#discussion_r497732539", "bodyText": "I believe this will be reverted back", "author": "moizarafat", "createdAt": "2020-09-30T18:57:43Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/test/java/com/yahoo/elide/contrib/dynamicconfighelpers/parser/handlebars/HandlebarsHydratorTest.java", "diffHunk": "@@ -307,10 +307,14 @@\n     private HandlebarsHydrator hydrator;\n \n     @BeforeAll\n-    public void setup() throws IOException {\n+    public void setup() {\n         hydrator = new HandlebarsHydrator();\n         testClass = new DynamicConfigValidator(CONFIG_PATH);\n-        testClass.readAndValidateConfigs();\n+        try {\n+            testClass.readAndValidateConfigs();\n+        } catch (IOException e) {\n+            e.printStackTrace();", "originalCommit": "387c0556cb527e091c2dd55a43e3b73f773a7aa8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczMjY4OA==", "url": "https://github.com/yahoo/elide/pull/1565#discussion_r497732688", "bodyText": "remove commented code.", "author": "moizarafat", "createdAt": "2020-09-30T18:57:57Z", "path": "elide-contrib/elide-dynamic-config-helpers/src/test/java/com/yahoo/elide/contrib/dynamicconfighelpers/parser/handlebars/HandlebarsHydratorTest.java", "diffHunk": "@@ -332,6 +336,15 @@ public void testTableHydration() throws IOException {\n         assertEquals(VALID_TABLE_CLASS, tableClasses.get(VALID_TABLE_JAVA_NAME));\n     }\n \n+    @Test\n+    public void testChildTableHydration() throws IOException {\n+\n+        Map<String, String> tableClasses = hydrator.hydrateTableTemplate(testClass.getElideTableConfig());\n+\n+        assertTrue(tableClasses.keySet().contains(\"PlayerStatsChild\"));\n+//        assertEquals(VALID_TABLE_CLASS, tableClasses.get(\"PlayerStatsChild\"));", "originalCommit": "387c0556cb527e091c2dd55a43e3b73f773a7aa8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9809f4a595c071db9cb907328b4801b159ed6c59", "url": "https://github.com/yahoo/elide/commit/9809f4a595c071db9cb907328b4801b159ed6c59", "message": "handlebar template", "committedDate": "2020-09-30T21:14:56Z", "type": "commit"}, {"oid": "315111679b4e42ffaf0639c494cb0f98de2f76ca", "url": "https://github.com/yahoo/elide/commit/315111679b4e42ffaf0639c494cb0f98de2f76ca", "message": "handlebar updates", "committedDate": "2020-10-01T03:52:00Z", "type": "commit"}, {"oid": "5750dd6ebbdb0f1c21462545c94d2adeb96ad318", "url": "https://github.com/yahoo/elide/commit/5750dd6ebbdb0f1c21462545c94d2adeb96ad318", "message": "remove sop", "committedDate": "2020-10-01T04:13:35Z", "type": "commit"}, {"oid": "a74edb74ce9a190eed2f475dda8106557c1073af", "url": "https://github.com/yahoo/elide/commit/a74edb74ce9a190eed2f475dda8106557c1073af", "message": "test override flg", "committedDate": "2020-10-01T04:16:57Z", "type": "commit"}, {"oid": "080d014a9d2a09a6e901a45d4e8d320c3bf27175", "url": "https://github.com/yahoo/elide/commit/080d014a9d2a09a6e901a45d4e8d320c3bf27175", "message": "minor", "committedDate": "2020-10-01T04:19:45Z", "type": "commit"}, {"oid": "42d6d7cd8664ae048d4fb39e1209cfb3d1320218", "url": "https://github.com/yahoo/elide/commit/42d6d7cd8664ae048d4fb39e1209cfb3d1320218", "message": "update spring core version", "committedDate": "2020-10-01T17:11:09Z", "type": "commit"}]}