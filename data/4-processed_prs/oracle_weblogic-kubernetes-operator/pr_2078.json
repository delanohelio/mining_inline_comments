{"pr_number": 2078, "pr_title": "Fix domain lib", "pr_createdAt": "2020-11-30T16:09:05Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2078", "timeline": [{"oid": "7dc555f7e3e7583de0970c4cb1eafaa905a25449", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7dc555f7e3e7583de0970c4cb1eafaa905a25449", "message": "fix domainLibraries in archive not properly handled in MII", "committedDate": "2020-11-30T15:53:42Z", "type": "commit"}, {"oid": "1d7b7a3d731c9e19e826933fa45d48e7a0d43652", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1d7b7a3d731c9e19e826933fa45d48e7a0d43652", "message": "fix domainLibraries not properly handled in MII", "committedDate": "2020-11-30T15:54:11Z", "type": "commit"}, {"oid": "b51d4408d57ff28ef48ed74499121b35c3e3d52a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b51d4408d57ff28ef48ed74499121b35c3e3d52a", "message": "comment only", "committedDate": "2020-11-30T16:08:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0MDgyMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2078#discussion_r533540823", "bodyText": "Should this code check to see if there are any unexpected files in the wlsdeploy dir once the mv is complete?\n\n\n\nI am not sure if this is necessary, the archive contains jar files in that location. If they put something wrong over there and if it causes problem starting the server then they should see it in the server log. Unless WDT has a command just to extract the libraries according to the model - it doesn't check much other than matching the path in the archive.\n\nIf the domain lib files aren't normally in an image archive, this will always generate an error message to stderr - which is confusing to see in a WL server pod log file.\nIf it's an error not to have domain lib files in an image archive, and the files are missing, then (a) the error will be a relatively hidden and cryptic 'wlsdeploy/domainLibraries/* not found' error on stderr in a WL pod log - not an ERROR trace message, and (b) since 'set -e' isn't on, the error will be ignored.\nSo if  problem is possible but it's not always expected to have these files, then it'd be helpful to skip the flatten if there are no files in the directory.  Or if the the files must always be there, then the introspector job should verify that it exists and emit a helpful error before the WL pods start. or  to have the introspector check for this (since it's harder to diagnose issues that are generated at the WL Server level...)", "author": "tbarnes-us", "createdAt": "2020-12-01T16:17:44Z", "path": "operator/src/main/resources/scripts/startServer.sh", "diffHunk": "@@ -221,7 +221,9 @@ function prepareMIIServer() {\n         # expand the archive domain libraries to the domain lib\n         cd ${DOMAIN_HOME}/lib || return 1\n         ${JAVA_HOME}/bin/jar xf ${IMG_ARCHIVES_ROOTDIR}/${file} wlsdeploy/domainLibraries/\n-\n+        # Flatten the jars to the domain lib root\n+        mv wlsdeploy/domainLibraries/* .\n+        rm -fr wlsdeploy/", "originalCommit": "b51d4408d57ff28ef48ed74499121b35c3e3d52a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU5MDUwMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2078#discussion_r533590501", "bodyText": "I agreed is not very common to use domain/lib,  at first I thought you are referring to checking what type of files are in the directory and whether they are valid jar files.  I have added check for directory existence before moving the files.", "author": "jshum2479", "createdAt": "2020-12-01T17:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0MDgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY4NTY0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2078#discussion_r533685647", "bodyText": "Looks good.", "author": "tbarnes-us", "createdAt": "2020-12-01T20:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0MDgyMw=="}], "type": "inlineReview"}, {"oid": "f34e8fc511bf78c23c93c9584a61c8193526eb9d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f34e8fc511bf78c23c93c9584a61c8193526eb9d", "message": "add check for directory existence", "committedDate": "2020-12-01T17:17:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY2MjgyNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2078#discussion_r533662825", "bodyText": "It looks like the if check at line 230 belongs directly after line 224.", "author": "tbarnes-us", "createdAt": "2020-12-01T19:21:49Z", "path": "operator/src/main/resources/scripts/startServer.sh", "diffHunk": "@@ -215,13 +215,18 @@ function prepareMIIServer() {\n     trace  SEVERE \"Domain Source Type is FromModel, cannot create ${DOMAIN_HOME}/lib \"\n     return 1\n   fi\n+  local WLSDEPLOY_DOMAINLIB=\"wlsdeploy/domainLibraries\"\n \n   for file in $(sort_files ${IMG_ARCHIVES_ROOTDIR} \"*.zip\")\n     do\n         # expand the archive domain libraries to the domain lib\n         cd ${DOMAIN_HOME}/lib || return 1\n-        ${JAVA_HOME}/bin/jar xf ${IMG_ARCHIVES_ROOTDIR}/${file} wlsdeploy/domainLibraries/\n-\n+        ${JAVA_HOME}/bin/jar xf ${IMG_ARCHIVES_ROOTDIR}/${file} ${WLSDEPLOY_DOMAINLIB}\n+        # Flatten the jars to the domain lib root\n+        if [ -d ${WLSDEPLOY_DOMAINLIB} ] && [ \"$(ls -A ${WLSDEPLOY_DOMAINLIB})\" ] ; then\n+          mv ${WLSDEPLOY_DOMAINLIB}/* .\n+          rm -fr wlsdeploy/\n+        fi\n         if [ $? -ne 0 ] ; then", "originalCommit": "f34e8fc511bf78c23c93c9584a61c8193526eb9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY2NDE5Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2078#discussion_r533664193", "bodyText": "should this call to rm -fr happen regardless of whether the domain lib was found in the wlsdeploy directory?", "author": "tbarnes-us", "createdAt": "2020-12-01T19:24:13Z", "path": "operator/src/main/resources/scripts/startServer.sh", "diffHunk": "@@ -215,13 +215,18 @@ function prepareMIIServer() {\n     trace  SEVERE \"Domain Source Type is FromModel, cannot create ${DOMAIN_HOME}/lib \"\n     return 1\n   fi\n+  local WLSDEPLOY_DOMAINLIB=\"wlsdeploy/domainLibraries\"\n \n   for file in $(sort_files ${IMG_ARCHIVES_ROOTDIR} \"*.zip\")\n     do\n         # expand the archive domain libraries to the domain lib\n         cd ${DOMAIN_HOME}/lib || return 1\n-        ${JAVA_HOME}/bin/jar xf ${IMG_ARCHIVES_ROOTDIR}/${file} wlsdeploy/domainLibraries/\n-\n+        ${JAVA_HOME}/bin/jar xf ${IMG_ARCHIVES_ROOTDIR}/${file} ${WLSDEPLOY_DOMAINLIB}\n+        # Flatten the jars to the domain lib root\n+        if [ -d ${WLSDEPLOY_DOMAINLIB} ] && [ \"$(ls -A ${WLSDEPLOY_DOMAINLIB})\" ] ; then\n+          mv ${WLSDEPLOY_DOMAINLIB}/* .\n+          rm -fr wlsdeploy/", "originalCommit": "f34e8fc511bf78c23c93c9584a61c8193526eb9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fb188a9eb08fd8cb586b0f8075416862df859116", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fb188a9eb08fd8cb586b0f8075416862df859116", "message": "fix condition check orders", "committedDate": "2020-12-01T20:17:54Z", "type": "commit"}, {"oid": "793650e02b6a3588cabb780cf435c566e00cfcdb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/793650e02b6a3588cabb780cf435c566e00cfcdb", "message": "minor fixes", "committedDate": "2020-12-01T21:03:00Z", "type": "commit"}]}