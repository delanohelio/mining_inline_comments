{"pr_number": 1626, "pr_title": "Script to run new integration tests against a \"kind\" cluster", "pr_createdAt": "2020-05-05T22:30:11Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626", "timeline": [{"oid": "6390523256e5819ce96d8f3a661864125273c6e1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6390523256e5819ce96d8f3a661864125273c6e1", "message": "Run new integration tests with Kind", "committedDate": "2020-05-05T19:35:31Z", "type": "commit"}, {"oid": "8e2cc4f052dddd1a0211e6edccc9e8a6d8a162a7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8e2cc4f052dddd1a0211e6edccc9e8a6d8a162a7", "message": "Mark as executable", "committedDate": "2020-05-05T19:40:46Z", "type": "commit"}, {"oid": "8d7bd9a39c27fdd8d2943c37c4f3ec9ec24c6d78", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8d7bd9a39c27fdd8d2943c37c4f3ec9ec24c6d78", "message": "Fix typos", "committedDate": "2020-05-05T19:51:48Z", "type": "commit"}, {"oid": "01dbda974123c14d89ce9cbfc033840e32852dfa", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/01dbda974123c14d89ce9cbfc033840e32852dfa", "message": "Work in progress", "committedDate": "2020-05-05T20:57:38Z", "type": "commit"}, {"oid": "339149dcce6c9455bece59f704d17727676c512b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/339149dcce6c9455bece59f704d17727676c512b", "message": "Improved Docker registry", "committedDate": "2020-05-05T21:02:21Z", "type": "commit"}, {"oid": "7e19d58619db577d87f9b63d6eef6dac18607bf5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7e19d58619db577d87f9b63d6eef6dac18607bf5", "message": "Restory worker", "committedDate": "2020-05-05T21:09:55Z", "type": "commit"}, {"oid": "d1d38fb879847135216a4cc759ade67bd82f0d34", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d1d38fb879847135216a4cc759ade67bd82f0d34", "message": "Set JAVA_HOME variable if missing", "committedDate": "2020-05-05T22:16:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDA3Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420504073", "bodyText": "copyright notice", "author": "markxnelson", "createdAt": "2020-05-06T01:47:18Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/bin/bash", "originalCommit": "d1d38fb879847135216a4cc759ade67bd82f0d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgwNzQyMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420807423", "bodyText": "Ugh, okay... that's embarrassing. Thanks.", "author": "rjeberhard", "createdAt": "2020-05-06T13:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgzOTAyMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420839022", "bodyText": "2019?", "author": "markxnelson", "createdAt": "2020-05-06T14:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5MzE3NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420893175", "bodyText": "More coffee needed... Thanks for having my back.  I'm not with it today.", "author": "rjeberhard", "createdAt": "2020-05-06T15:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDI5NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420504294", "bodyText": "maybe we could print a usage message and stop, rather than arbitrarily chose this location?", "author": "markxnelson", "createdAt": "2020-05-06T01:48:26Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/bin/bash\n+set -o errexit\n+\n+if [[ -z \"$WORKSPACE\" ]]; then\n+  kinddir=\"/scratch/$USER/kindtest\"", "originalCommit": "d1d38fb879847135216a4cc759ade67bd82f0d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgwODE5MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420808190", "bodyText": "I was trying to have a useful default when running on your own machine.  I think that is still valuable.  I can make another argument.", "author": "rjeberhard", "createdAt": "2020-05-06T13:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDM2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420504362", "bodyText": "does it matter it is was already there?", "author": "markxnelson", "createdAt": "2020-05-06T01:48:49Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/bin/bash\n+set -o errexit\n+\n+if [[ -z \"$WORKSPACE\" ]]; then\n+  kinddir=\"/scratch/$USER/kindtest\"\n+else\n+  kinddir=\"${WORKSPACE}/logdir/${BUILD_TAG}\"\n+fi\n+mkdir -m777 -p \"${kinddir}\"", "originalCommit": "d1d38fb879847135216a4cc759ade67bd82f0d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgwODYyNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420808627", "bodyText": "No, I'm actually okay with that.  I'd like to be able to run repeatedly on my local box.", "author": "rjeberhard", "createdAt": "2020-05-06T13:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDU2OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420504568", "bodyText": "should this have --name ${KIND_CLUSTER_NAME}?", "author": "markxnelson", "createdAt": "2020-05-06T01:49:38Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/bin/bash\n+set -o errexit\n+\n+if [[ -z \"$WORKSPACE\" ]]; then\n+  kinddir=\"/scratch/$USER/kindtest\"\n+else\n+  kinddir=\"${WORKSPACE}/logdir/${BUILD_TAG}\"\n+fi\n+mkdir -m777 -p \"${kinddir}\"\n+export RESULT_ROOT=\"${kinddir}/wl_k8s_test_results\"\n+if [ -d \"$RESULT_ROOT\" ]; then\n+  rm -Rf \"$RESULT_ROOT/*\"\n+else\n+  mkdir -m777 \"$RESULT_ROOT\"\n+fi\n+\n+export PV_ROOT=\"${kinddir}/k8s-pvroot\"\n+if [ -d \"$PV_ROOT\" ]; then\n+  rm -Rf \"$PV_ROOT/*\"\n+else\n+  mkdir -m777 \"$PV_ROOT\"\n+fi\n+\n+echo 'Remove old cluster (if any)...'\n+kind delete cluster", "originalCommit": "d1d38fb879847135216a4cc759ade67bd82f0d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDc5Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420504797", "bodyText": "make this a param? from a list of \"approved\" ones?", "author": "markxnelson", "createdAt": "2020-05-06T01:50:32Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/bin/bash\n+set -o errexit\n+\n+if [[ -z \"$WORKSPACE\" ]]; then\n+  kinddir=\"/scratch/$USER/kindtest\"\n+else\n+  kinddir=\"${WORKSPACE}/logdir/${BUILD_TAG}\"\n+fi\n+mkdir -m777 -p \"${kinddir}\"\n+export RESULT_ROOT=\"${kinddir}/wl_k8s_test_results\"\n+if [ -d \"$RESULT_ROOT\" ]; then\n+  rm -Rf \"$RESULT_ROOT/*\"\n+else\n+  mkdir -m777 \"$RESULT_ROOT\"\n+fi\n+\n+export PV_ROOT=\"${kinddir}/k8s-pvroot\"\n+if [ -d \"$PV_ROOT\" ]; then\n+  rm -Rf \"$PV_ROOT/*\"\n+else\n+  mkdir -m777 \"$PV_ROOT\"\n+fi\n+\n+echo 'Remove old cluster (if any)...'\n+kind delete cluster\n+\n+# desired cluster name; default is \"kind\"\n+KIND_CLUSTER_NAME=\"${KIND_CLUSTER_NAME:-kind}\"\n+\n+kind_version=$(kind version)\n+kind_network='kind'\n+reg_name='kind-registry'\n+reg_port='5000'\n+case \"${kind_version}\" in\n+  \"kind v0.7.\"* | \"kind v0.6.\"* | \"kind v0.5.\"*)\n+    kind_network='bridge'\n+    ;;\n+esac\n+\n+echo 'Create registry container unless it already exists'\n+running=\"$(docker inspect -f '{{.State.Running}}' \"${reg_name}\" 2>/dev/null || true)\"\n+if [ \"${running}\" != 'true' ]; then\n+  docker run \\\n+    -d --restart=always -p \"${reg_port}:5000\" --name \"${reg_name}\" \\\n+    registry:2\n+fi\n+\n+reg_host=\"${reg_name}\"\n+if [ \"${kind_network}\" = \"bridge\" ]; then\n+    reg_host=\"$(docker inspect -f '{{.NetworkSettings.IPAddress}}' \"${reg_name}\")\"\n+fi\n+echo \"Registry Host: ${reg_host}\"\n+\n+echo 'Create a cluster with the local registry enabled in containerd'\n+kind_version='v1.15.7@sha256:e2df133f80ef633c53c0200114fce2ed5e1f6947477dbc83261a6a921169488d'", "originalCommit": "d1d38fb879847135216a4cc759ade67bd82f0d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjE4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420792185", "bodyText": "agreed... working on that now.  I needed this once I was testing against 1.16.", "author": "rjeberhard", "createdAt": "2020-05-06T13:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDg4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420504884", "bodyText": "do we need to expose 6443 or any node ports?", "author": "markxnelson", "createdAt": "2020-05-06T01:50:58Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/bin/bash\n+set -o errexit\n+\n+if [[ -z \"$WORKSPACE\" ]]; then\n+  kinddir=\"/scratch/$USER/kindtest\"\n+else\n+  kinddir=\"${WORKSPACE}/logdir/${BUILD_TAG}\"\n+fi\n+mkdir -m777 -p \"${kinddir}\"\n+export RESULT_ROOT=\"${kinddir}/wl_k8s_test_results\"\n+if [ -d \"$RESULT_ROOT\" ]; then\n+  rm -Rf \"$RESULT_ROOT/*\"\n+else\n+  mkdir -m777 \"$RESULT_ROOT\"\n+fi\n+\n+export PV_ROOT=\"${kinddir}/k8s-pvroot\"\n+if [ -d \"$PV_ROOT\" ]; then\n+  rm -Rf \"$PV_ROOT/*\"\n+else\n+  mkdir -m777 \"$PV_ROOT\"\n+fi\n+\n+echo 'Remove old cluster (if any)...'\n+kind delete cluster\n+\n+# desired cluster name; default is \"kind\"\n+KIND_CLUSTER_NAME=\"${KIND_CLUSTER_NAME:-kind}\"\n+\n+kind_version=$(kind version)\n+kind_network='kind'\n+reg_name='kind-registry'\n+reg_port='5000'\n+case \"${kind_version}\" in\n+  \"kind v0.7.\"* | \"kind v0.6.\"* | \"kind v0.5.\"*)\n+    kind_network='bridge'\n+    ;;\n+esac\n+\n+echo 'Create registry container unless it already exists'\n+running=\"$(docker inspect -f '{{.State.Running}}' \"${reg_name}\" 2>/dev/null || true)\"\n+if [ \"${running}\" != 'true' ]; then\n+  docker run \\\n+    -d --restart=always -p \"${reg_port}:5000\" --name \"${reg_name}\" \\\n+    registry:2\n+fi\n+\n+reg_host=\"${reg_name}\"\n+if [ \"${kind_network}\" = \"bridge\" ]; then\n+    reg_host=\"$(docker inspect -f '{{.NetworkSettings.IPAddress}}' \"${reg_name}\")\"\n+fi\n+echo \"Registry Host: ${reg_host}\"\n+\n+echo 'Create a cluster with the local registry enabled in containerd'\n+kind_version='v1.15.7@sha256:e2df133f80ef633c53c0200114fce2ed5e1f6947477dbc83261a6a921169488d'\n+cat <<EOF | kind create cluster --name \"${KIND_CLUSTER_NAME}\" --config=-\n+kind: Cluster\n+apiVersion: kind.x-k8s.io/v1alpha4\n+containerdConfigPatches:\n+- |-\n+  [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"localhost:${reg_port}\"]\n+    endpoint = [\"http://${reg_host}:${reg_port}\"]\n+nodes:\n+  - role: control-plane\n+    image: kindest/node:${kind_version}\n+  - role: worker\n+    image: kindest/node:${kind_version}\n+    extraMounts:", "originalCommit": "d1d38fb879847135216a4cc759ade67bd82f0d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjQ2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420792462", "bodyText": "no, not on Linux.  The kind documentation says that it's automatic for Linux networking.", "author": "rjeberhard", "createdAt": "2020-05-06T13:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgzOTE2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420839160", "bodyText": "ok cool", "author": "markxnelson", "createdAt": "2020-05-06T14:32:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDk2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420504969", "bodyText": "shouldn't this use your cluster name var?", "author": "markxnelson", "createdAt": "2020-05-06T01:51:26Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/bin/bash\n+set -o errexit\n+\n+if [[ -z \"$WORKSPACE\" ]]; then\n+  kinddir=\"/scratch/$USER/kindtest\"\n+else\n+  kinddir=\"${WORKSPACE}/logdir/${BUILD_TAG}\"\n+fi\n+mkdir -m777 -p \"${kinddir}\"\n+export RESULT_ROOT=\"${kinddir}/wl_k8s_test_results\"\n+if [ -d \"$RESULT_ROOT\" ]; then\n+  rm -Rf \"$RESULT_ROOT/*\"\n+else\n+  mkdir -m777 \"$RESULT_ROOT\"\n+fi\n+\n+export PV_ROOT=\"${kinddir}/k8s-pvroot\"\n+if [ -d \"$PV_ROOT\" ]; then\n+  rm -Rf \"$PV_ROOT/*\"\n+else\n+  mkdir -m777 \"$PV_ROOT\"\n+fi\n+\n+echo 'Remove old cluster (if any)...'\n+kind delete cluster\n+\n+# desired cluster name; default is \"kind\"\n+KIND_CLUSTER_NAME=\"${KIND_CLUSTER_NAME:-kind}\"\n+\n+kind_version=$(kind version)\n+kind_network='kind'\n+reg_name='kind-registry'\n+reg_port='5000'\n+case \"${kind_version}\" in\n+  \"kind v0.7.\"* | \"kind v0.6.\"* | \"kind v0.5.\"*)\n+    kind_network='bridge'\n+    ;;\n+esac\n+\n+echo 'Create registry container unless it already exists'\n+running=\"$(docker inspect -f '{{.State.Running}}' \"${reg_name}\" 2>/dev/null || true)\"\n+if [ \"${running}\" != 'true' ]; then\n+  docker run \\\n+    -d --restart=always -p \"${reg_port}:5000\" --name \"${reg_name}\" \\\n+    registry:2\n+fi\n+\n+reg_host=\"${reg_name}\"\n+if [ \"${kind_network}\" = \"bridge\" ]; then\n+    reg_host=\"$(docker inspect -f '{{.NetworkSettings.IPAddress}}' \"${reg_name}\")\"\n+fi\n+echo \"Registry Host: ${reg_host}\"\n+\n+echo 'Create a cluster with the local registry enabled in containerd'\n+kind_version='v1.15.7@sha256:e2df133f80ef633c53c0200114fce2ed5e1f6947477dbc83261a6a921169488d'\n+cat <<EOF | kind create cluster --name \"${KIND_CLUSTER_NAME}\" --config=-\n+kind: Cluster\n+apiVersion: kind.x-k8s.io/v1alpha4\n+containerdConfigPatches:\n+- |-\n+  [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"localhost:${reg_port}\"]\n+    endpoint = [\"http://${reg_host}:${reg_port}\"]\n+nodes:\n+  - role: control-plane\n+    image: kindest/node:${kind_version}\n+  - role: worker\n+    image: kindest/node:${kind_version}\n+    extraMounts:\n+      - hostPath: ${PV_ROOT}\n+        containerPath: ${PV_ROOT}\n+EOF\n+\n+kubectl cluster-info --context kind-kind", "originalCommit": "d1d38fb879847135216a4cc759ade67bd82f0d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5MjY0OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420792649", "bodyText": "Yes, it should.  thanks.", "author": "rjeberhard", "createdAt": "2020-05-06T13:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwNDk2OQ=="}], "type": "inlineReview"}, {"oid": "9a6dd427e75f12f64ae56b2908800be932e0727f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9a6dd427e75f12f64ae56b2908800be932e0727f", "message": "Support WIT specific JAVA_HOME", "committedDate": "2020-05-06T13:03:45Z", "type": "commit"}, {"oid": "349504f2bd599e310d088193d3a6a8967328943b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/349504f2bd599e310d088193d3a6a8967328943b", "message": "Support different versions and review comments", "committedDate": "2020-05-06T14:14:15Z", "type": "commit"}, {"oid": "7bf04d2d3e85f563164e89d24203baaf75d2445c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7bf04d2d3e85f563164e89d24203baaf75d2445c", "message": "Update other file", "committedDate": "2020-05-06T14:22:51Z", "type": "commit"}, {"oid": "90d2290d3e17dae90646fa5ab41f29409a197d25", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/90d2290d3e17dae90646fa5ab41f29409a197d25", "message": "Fix grep", "committedDate": "2020-05-06T14:23:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MTkwOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420851909", "bodyText": "This one is supposed to get the nodes from kind cluster or localhost kubernetes cluster ?", "author": "sankarpn", "createdAt": "2020-05-06T14:48:27Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,143 @@\n+#!/bin/bash\n+# Copyright (c) 2019, 2020, Oracle Corporation and/or its affiliates.\n+# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+set -o errexit\n+\n+script=\"${BASH_SOURCE[0]}\"\n+scriptDir=\"$( cd \"$( dirname \"${script}\" )\" && pwd )\"\n+\n+function usage {\n+  echo \"usage: ${script} [-v <version>] [-n <name>] [-o <directory>] [-h]\"\n+  echo \"  -v Kubernetes version (optional) \"\n+  echo \"      (default: 1.15.11, supported values: 1.18, 1.18.2, 1.17, 1.17.5, 1.16, 1.16.9, 1.15, 1.15.11, 1.14, 1.14.10) \"\n+  echo \"  -n Kind cluster name (optional) \"\n+  echo \"      (default: kind) \"\n+  echo \"  -o Output directory (optional) \"\n+  echo \"      (default: \\${WORKSPACE}/logdir/\\${BUILD_TAG}, if \\${WORKSPACE} defined, else /scratch/\\$USER/kindtest) \"\n+  echo \"  -h Help\"\n+  exit $1\n+}\n+\n+k8s_version=\"1.15.11\"\n+kind_name=\"kind\"\n+if [[ -z \"$WORKSPACE\" ]]; then\n+  outdir=\"/scratch/$USER/kindtest\"\n+else\n+  outdir=\"${WORKSPACE}/logdir/${BUILD_TAG}\"\n+fi\n+\n+while getopts \":h:n:o:v:\" opt; do\n+  case $opt in\n+    v) k8s_version=\"${OPTARG}\"\n+    ;;\n+    n) kind_name=\"${OPTARG}\"\n+    ;;\n+    o) outdir=\"${OPTARG}\"\n+    ;;\n+    h) usage 0\n+    ;;\n+    *) usage 1\n+    ;;\n+  esac\n+done\n+\n+function versionprop {\n+  grep \"${1}=\" \"${scriptDir}/kindversions.properties\"|cut -d'=' -f2\n+}\n+\n+kind_image=$(versionprop \"${k8s_version}\")\n+if [ -z \"$kind_image\" ]; then\n+  echo \"Unsupported Kubernetes version: ${k8s_version}\"\n+  exit 1\n+fi\n+\n+mkdir -m777 -p \"${outdir}\"\n+export RESULT_ROOT=\"${outdir}/wl_k8s_test_results\"\n+if [ -d \"$RESULT_ROOT\" ]; then\n+  rm -Rf \"$RESULT_ROOT/*\"\n+else\n+  mkdir -m777 \"$RESULT_ROOT\"\n+fi\n+\n+export PV_ROOT=\"${outdir}/k8s-pvroot\"\n+if [ -d \"$PV_ROOT\" ]; then\n+  rm -Rf \"$PV_ROOT/*\"\n+else\n+  mkdir -m777 \"$PV_ROOT\"\n+fi\n+\n+echo 'Remove old cluster (if any)...'\n+kind delete cluster --name ${kind_name}\n+\n+kind_version=$(kind version)\n+kind_network='kind'\n+reg_name='kind-registry'\n+reg_port='5000'\n+case \"${kind_version}\" in\n+  \"kind v0.7.\"* | \"kind v0.6.\"* | \"kind v0.5.\"*)\n+    kind_network='bridge'\n+    ;;\n+esac\n+\n+echo 'Create registry container unless it already exists'\n+running=\"$(docker inspect -f '{{.State.Running}}' \"${reg_name}\" 2>/dev/null || true)\"\n+if [ \"${running}\" != 'true' ]; then\n+  docker run \\\n+    -d --restart=always -p \"${reg_port}:5000\" --name \"${reg_name}\" \\\n+    registry:2\n+fi\n+\n+reg_host=\"${reg_name}\"\n+if [ \"${kind_network}\" = \"bridge\" ]; then\n+    reg_host=\"$(docker inspect -f '{{.NetworkSettings.IPAddress}}' \"${reg_name}\")\"\n+fi\n+echo \"Registry Host: ${reg_host}\"\n+\n+echo 'Create a cluster with the local registry enabled in containerd'\n+cat <<EOF | kind create cluster --name \"${kind_name}\" --config=-\n+kind: Cluster\n+apiVersion: kind.x-k8s.io/v1alpha4\n+containerdConfigPatches:\n+- |-\n+  [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"localhost:${reg_port}\"]\n+    endpoint = [\"http://${reg_host}:${reg_port}\"]\n+nodes:\n+  - role: control-plane\n+    image: ${kind_image}\n+  - role: worker\n+    image: ${kind_image}\n+    extraMounts:\n+      - hostPath: ${PV_ROOT}\n+        containerPath: ${PV_ROOT}\n+EOF\n+\n+kubectl cluster-info --context \"kind-${kind_name}\"\n+kubectl get node -o wide", "originalCommit": "90d2290d3e17dae90646fa5ab41f29409a197d25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5NjY1OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420896659", "bodyText": "This gets the nodes from the kind cluster.  The call above (line 114) sets the current context to the kind cluster.  All kubectl calls after this will be to the kind cluster until a different context is set.", "author": "rjeberhard", "createdAt": "2020-05-06T15:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MTkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwODg3NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r420908874", "bodyText": "Got it. command cluster-info is kind of misleading :-(", "author": "sankarpn", "createdAt": "2020-05-06T16:02:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MTkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgxNzczNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r421817737", "bodyText": "oh yeah i did not notice that, a kubectl config set-context  might be clearer, but not a biggie, if it works, fair enough", "author": "markxnelson", "createdAt": "2020-05-07T21:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MTkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgxODY1NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r421818655", "bodyText": "I'm happy to switch it... I used this command because after you create a kind cluster, the tool prints out this command as the suggested way to select the cluster's context.", "author": "rjeberhard", "createdAt": "2020-05-07T21:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MTkwOQ=="}], "type": "inlineReview"}, {"oid": "c56a58319a81b501d347c54d867674309b9d55bc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c56a58319a81b501d347c54d867674309b9d55bc", "message": "Review comments", "committedDate": "2020-05-06T16:19:27Z", "type": "commit"}, {"oid": "5b644631d3e6a4f4db58dca730b07d4486c7d17d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5b644631d3e6a4f4db58dca730b07d4486c7d17d", "message": "Merge branch 'newkindtest' of https://github.com/oracle/weblogic-kubernetes-operator into newkindtest", "committedDate": "2020-05-06T16:19:35Z", "type": "commit"}, {"oid": "021f75ba8e51677a16d032bb8958fc5fd4dd27a6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/021f75ba8e51677a16d032bb8958fc5fd4dd27a6", "message": "Show how to install", "committedDate": "2020-05-06T16:26:49Z", "type": "commit"}, {"oid": "206c7959edeba8c1e3d19b64037be43c26b58064", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/206c7959edeba8c1e3d19b64037be43c26b58064", "message": "Use kubeconfig option", "committedDate": "2020-05-06T19:50:06Z", "type": "commit"}, {"oid": "e31b10ddd1dbff8581030e1c029969630cccafe1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e31b10ddd1dbff8581030e1c029969630cccafe1", "message": "Clarify how to access cluster", "committedDate": "2020-05-06T20:13:05Z", "type": "commit"}, {"oid": "464565c470588f64b1c0d2c0e42bab31a866d823", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/464565c470588f64b1c0d2c0e42bab31a866d823", "message": "Use kubeconfig option for delete", "committedDate": "2020-05-06T20:55:40Z", "type": "commit"}, {"oid": "0a96dd8bb844e2875d35e2e9e1446073fb7406d8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0a96dd8bb844e2875d35e2e9e1446073fb7406d8", "message": "Merge remote-tracking branch 'origin/develop' into newkindtest", "committedDate": "2020-05-07T11:37:55Z", "type": "commit"}, {"oid": "b9c42075242226999b9e9999db26b44b744e051d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b9c42075242226999b9e9999db26b44b744e051d", "message": "Merge remote-tracking branch 'origin/develop' into newkindtest", "committedDate": "2020-05-07T20:51:19Z", "type": "commit"}, {"oid": "d91c444a7f862ed1eab6283a4ff6b91b82cc737c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d91c444a7f862ed1eab6283a4ff6b91b82cc737c", "message": "Fix up NGINX test", "committedDate": "2020-05-07T20:57:44Z", "type": "commit"}, {"oid": "3f0023c3823c58279fa5059fb9174b6414a2537a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3f0023c3823c58279fa5059fb9174b6414a2537a", "message": "Add test filter option", "committedDate": "2020-05-07T21:49:22Z", "type": "commit"}, {"oid": "cf9e4f704246f9c8ca30dbddb352289bd2e7f95b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cf9e4f704246f9c8ca30dbddb352289bd2e7f95b", "message": "Remove unnecessary directories", "committedDate": "2020-05-07T22:36:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEzODE1Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1626#discussion_r422138157", "bodyText": "RESULT_ROOT is set just above,  but never-the-less an rm -rf $ENV/* of env var looks a bit like playing with fire to me.  A \"set -u\" would make it a little safer maybe.  Putting the 'wl_k8s_test_results' string directly  in the rm expression makes it even safer IMO.  Ditto for PV_ROOT below.  This reduces chance that a future change  to the env var logic could leave a crater in the file system.", "author": "tbarnes-us", "createdAt": "2020-05-08T13:19:53Z", "path": "kindtest.sh", "diffHunk": "@@ -0,0 +1,187 @@\n+#!/bin/bash\n+# Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+#\n+# This script provisions a Kubernetes cluster using Kind (https://kind.sigs.k8s.io/) and runs the new\n+# integration test suite against that cluster.\n+#\n+# To install Kind:\n+#    curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.8.0/kind-$(uname)-amd64\n+#    chmod +x ./kind\n+#    mv ./kind /some-dir-in-your-PATH/kind\n+#\n+# Kind creates Kubernetes nodes on your local box by running each node as a Docker container. This\n+# makes it very easy to setup and tear down clusters. Presently, this script creates a cluster with a\n+# master node and a worker node. Each node will run the same Kubernetes version. Future enhancements to\n+# this script could allow for the configuration of a different number of nodes or for nodes to run a\n+# differing set of Kubernetes versions.\n+#\n+# Kind nodes do not have access to the Docker repository on the local machine. Therefore this script works\n+# around this limitation by running a Docker registry in a Docker container and connecting the networks so\n+# that the Kubernetes nodes have visibility to the registry. When you run tests, you will see that Docker\n+# images are pushed to this local registry and then are pulled to the Kubernetes nodes as needed.\n+# You can see the images on a node by running: \"docker exec -it kind-worker crictl images\" where kind-worker\n+# is the name of the Docker container.\n+#\n+# As of May 6, 2020, the tests are clean on Kubernetes 1.16 with the following JDK workarounds:\n+# 1. Maven must be run with OpenJDK 11.0.7, available here: https://github.com/AdoptOpenJDK/openjdk11-upstream-binaries/releases/download/jdk-11.0.7%2B10/OpenJDK11U-jdk_x64_linux_11.0.7_10.tar.gz\n+#    This is because of a critical bug fix. Unfortunately, the Oracle JDK 11.0.7 release was based on an earlier build and doesn't have the fix.\n+# 2. The WebLogic Image Tool will not accept an OpenJDK JDK. Set WIT_JAVA_HOME to an Oracle JDK Java Home.\n+#    For example, \"export WIT_JAVA_HOME=/usr/java/jdk-11.0.7\" before running this script.\n+#\n+# If you want to access the cluster, use \"kubectl cluster-info --context kind-kind\" where the trailing \"kind\" is the value of the \"-n\" argument.\n+set -o errexit\n+\n+script=\"${BASH_SOURCE[0]}\"\n+scriptDir=\"$( cd \"$( dirname \"${script}\" )\" && pwd )\"\n+\n+function usage {\n+  echo \"usage: ${script} [-v <version>] [-n <name>] [-o <directory>] [-t <tests>] [-h]\"\n+  echo \"  -v Kubernetes version (optional) \"\n+  echo \"      (default: 1.15.11, supported values: 1.18, 1.18.2, 1.17, 1.17.5, 1.16, 1.16.9, 1.15, 1.15.11, 1.14, 1.14.10) \"\n+  echo \"  -n Kind cluster name (optional) \"\n+  echo \"      (default: kind) \"\n+  echo \"  -o Output directory (optional) \"\n+  echo \"      (default: \\${WORKSPACE}/logdir/\\${BUILD_TAG}, if \\${WORKSPACE} defined, else /scratch/\\${USER}/kindtest) \"\n+  echo \"  -t Test filter (optional) \"\n+  echo \"      (default: **/It*) \"\n+  echo \"  -h Help\"\n+  exit $1\n+}\n+\n+k8s_version=\"1.15.11\"\n+kind_name=\"kind\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+  outdir=\"/scratch/${USER}/kindtest\"\n+else\n+  outdir=\"${WORKSPACE}/logdir/${BUILD_TAG}\"\n+fi\n+test_filter=\"**/It*\"\n+\n+while getopts \":h:n:o:t:v:\" opt; do\n+  case $opt in\n+    v) k8s_version=\"${OPTARG}\"\n+    ;;\n+    n) kind_name=\"${OPTARG}\"\n+    ;;\n+    o) outdir=\"${OPTARG}\"\n+    ;;\n+    t) test_filter=\"${OPTARG}\"\n+    ;;\n+    h) usage 0\n+    ;;\n+    *) usage 1\n+    ;;\n+  esac\n+done\n+\n+function versionprop {\n+  grep \"${1}=\" \"${scriptDir}/kindversions.properties\"|cut -d'=' -f2\n+}\n+\n+kind_image=$(versionprop \"${k8s_version}\")\n+if [ -z \"${kind_image}\" ]; then\n+  echo \"Unsupported Kubernetes version: ${k8s_version}\"\n+  exit 1\n+fi\n+\n+echo \"Using Kubernetes version: ${k8s_version}\"\n+\n+mkdir -m777 -p \"${outdir}\"\n+export RESULT_ROOT=\"${outdir}/wl_k8s_test_results\"\n+if [ -d \"${RESULT_ROOT}\" ]; then\n+  rm -Rf \"${RESULT_ROOT}/*\"", "originalCommit": "cf9e4f704246f9c8ca30dbddb352289bd2e7f95b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}