{"pr_number": 1879, "pr_title": "owls-83918 an idle domain's resource version should stay unchanged", "pr_createdAt": "2020-08-19T13:22:19Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879", "timeline": [{"oid": "ccf7401c31215a62b32331e8d196cfdd79c2b904", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ccf7401c31215a62b32331e8d196cfdd79c2b904", "message": "In recheck code path only continue if spec changes", "committedDate": "2020-08-18T15:48:45Z", "type": "commit"}, {"oid": "330eac1bd28e98a892af08820b0a30c5198c23fd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/330eac1bd28e98a892af08820b0a30c5198c23fd", "message": "Merge remote-tracking branch 'origin/develop' into owls83918-resource-version", "committedDate": "2020-08-19T01:19:49Z", "type": "commit"}, {"oid": "24f025773c2e7f49ed5c2ec4b5a359f8cf1ff7ec", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/24f025773c2e7f49ed5c2ec4b5a359f8cf1ff7ec", "message": "Minor change", "committedDate": "2020-08-19T02:30:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAzMjMyNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r473032327", "bodyText": "Why compute absent up here, if it is used below? Unless there is a very good reason, it should be computed when you need it - you can even remove the local variable that way.", "author": "russgold", "createdAt": "2020-08-19T13:33:23Z", "path": "operator/src/main/java/oracle/kubernetes/operator/Main.java", "diffHunk": "@@ -840,6 +840,7 @@ public NextAction onSuccess(Packet packet, CallResponse<DomainList> callResponse\n         for (Domain dom : callResponse.getResult().getItems()) {\n           String domainUid = dom.getDomainUid();\n           domainUids.add(domainUid);\n+          boolean absent = dpis.get(domainUid) == null;", "originalCommit": "24f025773c2e7f49ed5c2ec4b5a359f8cf1ff7ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA1NjA0NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r473056045", "bodyText": "The line after the current assignment will change the content of the map, therefore we need to catch the old value before it.", "author": "doxiao", "createdAt": "2020-08-19T14:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAzMjMyNw=="}], "type": "inlineReview"}, {"oid": "51aeac25cdf9ba06a4b60e4d5051b2b2949cab66", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/51aeac25cdf9ba06a4b60e4d5051b2b2949cab66", "message": "only add progressing condition when something is really happening to the domain", "committedDate": "2020-08-20T00:42:06Z", "type": "commit"}, {"oid": "4401bca50bc2365c5f5a88db638b472593167d6e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4401bca50bc2365c5f5a88db638b472593167d6e", "message": "cleanup", "committedDate": "2020-08-20T00:55:05Z", "type": "commit"}, {"oid": "a71072defe5a68e3d57030fe26b7eef74ab5caa4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a71072defe5a68e3d57030fe26b7eef74ab5caa4", "message": "populate state and healht when needed", "committedDate": "2020-08-23T00:34:16Z", "type": "commit"}, {"oid": "588e7151f1f403f1195a1839f6c7f055e7548def", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/588e7151f1f403f1195a1839f6c7f055e7548def", "message": "Merge remote-tracking branch 'origin/owls83918-resource-version' into resource-version-fix", "committedDate": "2020-08-23T00:35:47Z", "type": "commit"}, {"oid": "608cde06709a061e0f6734eb9c67bf31678bd5df", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/608cde06709a061e0f6734eb9c67bf31678bd5df", "message": "Work in progress", "committedDate": "2020-08-23T01:06:53Z", "type": "commit"}, {"oid": "b769e3387320497bf09caa095a252d265055773a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b769e3387320497bf09caa095a252d265055773a", "message": "debug", "committedDate": "2020-08-23T01:34:50Z", "type": "commit"}, {"oid": "17daf3e9d95233832ff6167bd349927799612f92", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/17daf3e9d95233832ff6167bd349927799612f92", "message": "debug", "committedDate": "2020-08-23T12:04:04Z", "type": "commit"}, {"oid": "ce883d53711ba7312705be8c74d4b524d043bfc9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ce883d53711ba7312705be8c74d4b524d043bfc9", "message": "more debugging", "committedDate": "2020-08-24T03:18:26Z", "type": "commit"}, {"oid": "a7d1ef07888a9b2452e363f476195b780d94e8ef", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a7d1ef07888a9b2452e363f476195b780d94e8ef", "message": "remove debugging", "committedDate": "2020-08-24T15:34:38Z", "type": "commit"}, {"oid": "81846ab45ff1700cefca6339f580246d579be0b4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/81846ab45ff1700cefca6339f580246d579be0b4", "message": "remove debugging", "committedDate": "2020-08-24T15:37:22Z", "type": "commit"}, {"oid": "ad4d062302f6d9f193bf960bf5dc9f9816ab1b49", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ad4d062302f6d9f193bf960bf5dc9f9816ab1b49", "message": "cleanup", "committedDate": "2020-08-24T15:38:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk1MDE5OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r475950198", "bodyText": "would the domain status be updated when we stop a server, or scale down a cluster?", "author": "alai8", "createdAt": "2020-08-24T23:17:14Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/PodStepContext.java", "diffHunk": "@@ -330,9 +332,11 @@ private Step patchCurrentPod(V1Pod currentPod, Step next) {\n     KubernetesUtils.addPatches(\n         patchBuilder, \"/metadata/annotations/\", getAnnotations(currentPod), getPodAnnotations());\n \n-    return new CallBuilder()\n-        .patchPodAsync(getPodName(), getNamespace(), getDomainUid(),\n-            new V1Patch(patchBuilder.build().toString()), patchResponse(next));\n+    return Step.chain(", "originalCommit": "ad4d062302f6d9f193bf960bf5dc9f9816ab1b49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5OTQ3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r476499472", "bodyText": "Once the domain is started, the operator periodically checks the server's state and health condition, and update the domain status/condition accordingly. Right now, we don't have a progressing REASON for cluster scaling down; the condition we are adding here is for managed server starting only.\nI am looking into the scaling down code path to see if we need to add additional Progressing step or not.", "author": "doxiao", "createdAt": "2020-08-25T14:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk1MDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyMjQ1Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r476622457", "bodyText": "I added ProgressingStep to scaling down code path to match what we had without the changes in this PR. I thought about adding a new reason (for example \"managedServersScalingDown\") for this, but I decided to use what we used before this change. Ryan, your thoughts on this?", "author": "doxiao", "createdAt": "2020-08-25T17:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk1MDE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEwNTA4OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r476105089", "bodyText": "Should these be ConcurrentHashMap instead of regular HashMap?", "author": "ankedia", "createdAt": "2020-08-25T03:13:46Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -669,6 +671,23 @@ private void internalMakeRightDomainPresence() {\n             willInterrupt);\n     }\n \n+    private void populateServerStateHealthFromDomain(Packet packet) {\n+      Map<String, ServerHealth> serverHealth = new HashMap<String, ServerHealth>();\n+      Map<String, String> serverState = new HashMap<String, String>();", "originalCommit": "ad4d062302f6d9f193bf960bf5dc9f9816ab1b49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ4NzMwNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r476487307", "bodyText": "yes, good catch! Changed to ConcurrentHashMap.", "author": "doxiao", "createdAt": "2020-08-25T14:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEwNTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU0MTU2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r476541563", "bodyText": "I'm trying to understand the reason for adding populateServerStateHealthFromDomain() method. It looks like SERVER_STATE_MAP and SERVER_HEALTH_MAP are also created/added later in runDomainPlan -> createSteps -> createDomainUpPlan -> DomainStatusStep -> scheduleDomainStatusUpdating . Did I miss something?", "author": "ankedia", "createdAt": "2020-08-25T15:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEwNTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2ODgwOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r476568809", "bodyText": "The scheduleDomainStatusUpdating creates a new packet for periodically domain status update, which is not the same packet that operator creates here in internalMakeRightDomainPresence.", "author": "doxiao", "createdAt": "2020-08-25T16:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEwNTA4OQ=="}], "type": "inlineReview"}, {"oid": "67a7cebb4691007c54d4f59d637e14fc7a50dbfe", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/67a7cebb4691007c54d4f59d637e14fc7a50dbfe", "message": "Fix patchPod handling and change HashMap to ConcurrentHashMap", "committedDate": "2020-08-25T13:30:48Z", "type": "commit"}, {"oid": "f9b8b92aa3aaffaa163298e537579da732f6ac22", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f9b8b92aa3aaffaa163298e537579da732f6ac22", "message": "Add ProgressingStep on scaling down", "committedDate": "2020-08-25T17:26:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg1MDE5MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r476850190", "bodyText": "I understand that the ProgressingStep is a private static class, but I think it is better to have this method to unit test code.", "author": "alai8", "createdAt": "2020-08-25T23:22:56Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainStatusUpdater.java", "diffHunk": "@@ -611,6 +611,16 @@ void modifyStatus(DomainStatus status) {\n     }\n   }\n \n+  /**\n+   * A utility method for unit testing.\n+   */\n+  public static Step excludeProgressingStep(Step step) {", "originalCommit": "f9b8b92aa3aaffaa163298e537579da732f6ac22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDExOTIwMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r480119201", "bodyText": "I initially had this method in the test code, and made the ProcessingStep public. I changed to the current implementation because I slightly preferred keeping the class private. But I am okay with either approach.", "author": "doxiao", "createdAt": "2020-08-31T13:10:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg1MDE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNTkxOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r477335918", "bodyText": "Aren't we already updating these maps in ServerStatusReader? Why copy the logic to here?", "author": "russgold", "createdAt": "2020-08-26T14:16:02Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -669,6 +671,27 @@ private void internalMakeRightDomainPresence() {\n             willInterrupt);\n     }\n \n+    private void populateServerStateHealthFromDomain(Packet packet) {", "originalCommit": "f9b8b92aa3aaffaa163298e537579da732f6ac22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzNzg2OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r480137868", "bodyText": "The domain status contains DomainConditions and ServerStatus. The ServerStatus contains the WebLogic servers' state and health information, which is updated based on what is in the two maps (serverState and serverHealth) in the packet. The domain conditions are only handled by the domain status update steps in DomainStatusUpdater.\nPrior to the code change in this PR, the server status update is already triggered from two code paths: make-right code path and ServerStatusReader/update  code path (see the places where the DomainStatusUpdater.createStatusUpdateStep is called). If I understand the logic correctly, the update in the make-right is to record possible cluster scale-up and scale-down changes. The update in the ServerStatusReader is to record state/health changes on the WebLogic server processes. The two code paths do NOT share the same packet instances and the contents. The ServerStatusReader populates the maps based on the responses that the reader gets, and add them to the packet. The make-right code does not populate the maps,  and therefore no maps are added to the packet. As a result, when the operator does a full recheck of an idle domain (running but no activities), the make-right code path will update the domain status to remove the server state and health, and the next update from the ServerStatusReader will update the states and health again, and put the actual state and health back. This behavior will repeat due to the periodical ServerStatusReader server status update logic and make-right full recheck logic, thus the domain version number keeps to be bumped up.\nThe solution in this PR is to populate the packet in the make-right code path with the current known state/health that the operator gets from the domain object, so that the logic starts with the correct initial server status.\nI agree that it is hard to unit test the combined behavior and end results from the code paths. I have been trying to find a way to test only the make-right code path instead, for example checking if the maps in the packet are populated correctly.", "author": "doxiao", "createdAt": "2020-08-31T13:40:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNTkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0MDcxMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r480140713", "bodyText": "Could the make-right code path simply leave the per-server status alone by copying the content from the current status, if any?", "author": "rjeberhard", "createdAt": "2020-08-31T13:44:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNTkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0NDE0NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r480144145", "bodyText": "A better solution, then, would probably be to encapsulate the logic, possibly in the ServerStatus itself. Both paths could then use that logic, and it could be unit-testable.", "author": "russgold", "createdAt": "2020-08-31T13:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNTkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0Njg3OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r480146878", "bodyText": "@rjeberhard That is the change in the PR does; get the current status from the domain object. We need to populate the maps in the packet with those status contents because the remaining logic around this uses that information to determine the behavior.", "author": "doxiao", "createdAt": "2020-08-31T13:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNTkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0OTYwMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r480149602", "bodyText": "@russgold are you suggesting that both code paths read the status from the servers, and populate the maps with the responses?  Readers reaches out to each servers to get its state and health information, and I am not sure if we would want to do that in the make-right code path.", "author": "doxiao", "createdAt": "2020-08-31T13:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNTkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwNzQyNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r480207425", "bodyText": "I'm suggesting that both paths do what they need to do, but that the logic be encapsulated in ServerStatus, where it can be unit tested.", "author": "russgold", "createdAt": "2020-08-31T15:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNTkxOA=="}], "type": "inlineReview"}, {"oid": "19aed9af3f3557b09508a45eaa97fea218fec528", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/19aed9af3f3557b09508a45eaa97fea218fec528", "message": "Address review comments", "committedDate": "2020-09-01T15:31:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0NjAzOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r481346038", "bodyText": "Wouldn't it make sense to add the new step into createSteps, in the branch where we aren't shutting down the domain?", "author": "russgold", "createdAt": "2020-09-01T18:27:48Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -659,12 +703,11 @@ private void internalMakeRightDomainPresence() {\n               Component.createFor(liveInfo, delegate.getVersion(),\n                   PodAwaiterStepFactory.class, delegate.getPodAwaiterStepFactory(getNamespace()),\n                   V1SubjectRulesReviewStatus.class, delegate.getSubjectRulesReviewStatus(getNamespace())));\n-\n       runDomainPlan(\n             getDomain(),\n             getDomainUid(),\n             getNamespace(),\n-            new StepAndPacket(createSteps(), packet),\n+            new StepAndPacket(createPopulatePacketServerMapsStep(createSteps()), packet),", "originalCommit": "19aed9af3f3557b09508a45eaa97fea218fec528", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4MjMyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r481382324", "bodyText": "I thought about that, but noticed that createSteps is called in other places outside of the make-right code path.", "author": "doxiao", "createdAt": "2020-09-01T19:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0NjAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4NjQzNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r481386434", "bodyText": "Only in the case where createSteps is called from the make-right code path (internalMakeRightDomainPresence method), the packet does not already have the server maps;", "author": "doxiao", "createdAt": "2020-09-01T19:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0NjAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4ODU4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1879#discussion_r481388585", "bodyText": "Then pull that whole line,\nnew StepAndPacket(createPopulatePacketServerMapsStep(createSteps()), packet)\n\ninto its own method, such as createDomainPlanSteps. There is otherwise too much going on in that code block.", "author": "russgold", "createdAt": "2020-09-01T19:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0NjAzOA=="}], "type": "inlineReview"}, {"oid": "457c5bb9d7598a5797298d41c01d76303b265b0a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/457c5bb9d7598a5797298d41c01d76303b265b0a", "message": "Review comment", "committedDate": "2020-09-01T19:55:09Z", "type": "commit"}, {"oid": "ba2cfc23c32ab4cc9b4d38e4595906fb9b82b2e2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ba2cfc23c32ab4cc9b4d38e4595906fb9b82b2e2", "message": "Merge remote-tracking branch 'origin/develop' into owls83918-resource-version", "committedDate": "2020-09-01T19:57:43Z", "type": "commit"}]}