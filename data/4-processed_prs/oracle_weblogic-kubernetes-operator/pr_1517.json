{"pr_number": 1517, "pr_title": "Enhance Helm chart deletion Logic in cleanup.sh Script  ", "pr_createdAt": "2020-03-30T23:03:40Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517", "timeline": [{"oid": "0ac4258fb8ece9425368c5b6295e13ad93530391", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0ac4258fb8ece9425368c5b6295e13ad93530391", "message": "Enhance the clean up Script to support Helm 2/3", "committedDate": "2020-03-30T22:01:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkzMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400547932", "bodyText": "I suspect this should be:\nhelm list --all-namespaces | grep -v NAME | awk '{print $2}' | sort -u\nWe only want to iterate through each namespace once.", "author": "tbarnes-us", "createdAt": "2020-03-30T23:08:38Z", "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`", "originalCommit": "0ac4258fb8ece9425368c5b6295e13ad93530391", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0OTczMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400549731", "bodyText": "nice suggestion. will implement change in next commit", "author": "anpanigr", "createdAt": "2020-03-30T23:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1MDYzMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400550632", "bodyText": "i am assuming that the above command does not yield a ns unless there's at least one helm release in the ns", "author": "tbarnes-us", "createdAt": "2020-03-30T23:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400547901", "bodyText": "The loop is still here", "author": "markxnelson", "createdAt": "2020-03-30T23:08:33Z", "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -523,32 +523,38 @@ if [ -x \"$(command -v helm)\" ]; then\n   [[ $? == 1 ]] && HELM_VERSION=V3\n   echo \"Detected Helm Version [$(helm version --short --client)]\"\n   echo @@ `timestamp` Deleting installed helm charts\n-  namespaces=`kubectl get ns | grep -v NAME | awk '{ print $1 }'`\n-  for ns in $namespaces\n-  do \n+  if [ \"$HELM_VERSION\" == \"V2\" ]; then\n+   helm list --short | while read helm_name; do\n    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-     (\n+   (\n      set -x\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         helm delete --purge  $helm_name\n-       else \n-         helm uninstall $helm_name -n $ns \n-       fi\n-     done\n-     )\n+     helm delete --purge  $helm_name\n+    )\n    else\n-     (\n-     helm list --short --namespace $ns | while read helm_name; do\n-       if [ \"$HELM_VERSION\" == \"V2\" ]; then\n-         echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+     echo @@ `timestamp` Info: DRYRUN: helm delete --purge  $helm_name\n+   fi\n+   done\n+  fi\n+\n+  if [ \"$HELM_VERSION\" == \"V3\" ]; then\n+   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n+   for ns in $namespaces\n+   do \n+     echo \"Looking for helm lists in namesapce $ns\"", "originalCommit": "0ac4258fb8ece9425368c5b6295e13ad93530391", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0ODY3MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400548670", "bodyText": "namespaces variable will store only the namespace(s) that has a helm deployment not all the namespaces in entire k8s", "author": "anpanigr", "createdAt": "2020-03-30T23:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0ODkxMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400548911", "bodyText": "The loop here is OK IMO, as long as we only iterate through each NS once, and only iterate through NS that contain a helm, per my previous comment.", "author": "tbarnes-us", "createdAt": "2020-03-30T23:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0OTU3Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400549576", "bodyText": "But if you want to further optimize, iterate through the output of the first all-namespace command in a single \"big loop\"\nover each entire line, where the commands within loop parse out the ns from the current line and parses out the helm name from the same line.", "author": "tbarnes-us", "createdAt": "2020-03-30T23:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzkwMQ=="}], "type": "inlineReview"}, {"oid": "12fc7703b5a84c816851f953fec892049744b199", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/12fc7703b5a84c816851f953fec892049744b199", "message": "Addressed the review comment", "committedDate": "2020-03-31T00:39:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3ODI3Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1517#discussion_r400578273", "bodyText": "Change \"helm uninstall \" to \"set -x ; helm uninstall \".  In my testing it turns out that the outer scoped set -x is suppressed by teh the system call scope, so you need one inside the system call scope too.", "author": "tbarnes-us", "createdAt": "2020-03-31T00:47:05Z", "path": "src/integration-tests/bash/cleanup.sh", "diffHunk": "@@ -537,23 +537,15 @@ if [ -x \"$(command -v helm)\" ]; then\n   fi\n \n   if [ \"$HELM_VERSION\" == \"V3\" ]; then\n-   namespaces=`helm list --all-namespaces | grep -v NAME | awk '{print $2}'`\n-   for ns in $namespaces\n-   do \n-     echo \"Looking for helm lists in namesapce $ns\"\n-     helm_names=`helm list --short -n $ns`\n-     for helm_name in $helm_names\n-     do \n-        if [ ! \"$DRY_RUN\" = \"true\" ]; then\n-        (\n-          set -x\n-          helm uninstall $helm_name -n $ns\n-        )\n-       else \n-         echo @@ `timestamp` Info: DRYRUN: helm uninstall $helm_name -n $ns\n-       fi\n-     done\n-   done\n+    if [ ! \"$DRY_RUN\" = \"true\" ]; then\n+    (\n+      set -x\n+      helm list --all-namespaces | grep -v NAME | awk '{system(\"helm uninstall \" $1 \" --namespace \" $2)}'", "originalCommit": "12fc7703b5a84c816851f953fec892049744b199", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}