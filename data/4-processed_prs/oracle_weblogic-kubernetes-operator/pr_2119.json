{"pr_number": 2119, "pr_title": "Owls86455 add event when operator start/stop watching a namespace", "pr_createdAt": "2020-12-24T14:38:29Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119", "timeline": [{"oid": "9f917f15f93180e003cce219a2dc6fb1885d339a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9f917f15f93180e003cce219a2dc6fb1885d339a", "message": "add namespace events and initial unit test", "committedDate": "2020-12-21T20:07:57Z", "type": "commit"}, {"oid": "2051a75f86774554267d833ff13a6e25ee341e37", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2051a75f86774554267d833ff13a6e25ee341e37", "message": "initial doc changes", "committedDate": "2020-12-22T14:27:32Z", "type": "commit"}, {"oid": "05524e3a482ac73d6d8a26a2187bc095728af631", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/05524e3a482ac73d6d8a26a2187bc095728af631", "message": "Merge remote-tracking branch 'origin/develop' into owls86455-ns-event", "committedDate": "2020-12-22T15:24:52Z", "type": "commit"}, {"oid": "09a562a21cc1e9fbdc7325f811a0b669ce52bea4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/09a562a21cc1e9fbdc7325f811a0b669ce52bea4", "message": "fix involved Object namespace plus more unit tests", "committedDate": "2020-12-23T01:37:44Z", "type": "commit"}, {"oid": "fc8695c156665a3399960956fe501a39789009a6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fc8695c156665a3399960956fe501a39789009a6", "message": "more code changes and unit tests", "committedDate": "2020-12-23T03:49:20Z", "type": "commit"}, {"oid": "f0482ef1a029d867a69c5b50b205ab4ca48a19f9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f0482ef1a029d867a69c5b50b205ab4ca48a19f9", "message": "refactoring and more unit tests and doc", "committedDate": "2020-12-23T17:57:44Z", "type": "commit"}, {"oid": "c81a771d508a84552b90992480cb92ca4cfdc158", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c81a771d508a84552b90992480cb92ca4cfdc158", "message": "more doc", "committedDate": "2020-12-23T19:01:51Z", "type": "commit"}, {"oid": "dd5fcb43ab482b6d03c4e040bcb2bee22deddce6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/dd5fcb43ab482b6d03c4e040bcb2bee22deddce6", "message": "minor adjustment", "committedDate": "2020-12-23T21:08:13Z", "type": "commit"}, {"oid": "7e4e0517e44f5aba9079d7d7050faad33a993b91", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7e4e0517e44f5aba9079d7d7050faad33a993b91", "message": "minor changes to unit tests", "committedDate": "2020-12-24T03:51:46Z", "type": "commit"}, {"oid": "d3b223659feb7a7c326a3a3a199580335bc1eca6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d3b223659feb7a7c326a3a3a199580335bc1eca6", "message": "change event reason text", "committedDate": "2020-12-24T05:07:03Z", "type": "commit"}, {"oid": "914d4faaaf8294a2343a858d821093eef4f436c5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/914d4faaaf8294a2343a858d821093eef4f436c5", "message": "minor unit test change", "committedDate": "2020-12-24T06:15:16Z", "type": "commit"}, {"oid": "363aa36b239088b6d95fa0b281f31dae0aa5206b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/363aa36b239088b6d95fa0b281f31dae0aa5206b", "message": "Merge remote-tracking branch 'origin/develop' into owls86455-ns-event", "committedDate": "2020-12-24T14:03:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MDgxNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548550817", "bodyText": "This is needlessly long and hard to follow. I would suggest extracting both the condition and the body of the if, and then turning it into an else if clause, and then putting back the else for the last alternative.", "author": "russgold", "createdAt": "2020-12-24T14:52:45Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainRecheck.java", "diffHunk": "@@ -207,11 +210,19 @@ Step startNamespaceSteps(String ns) {\n     @Override\n     public NextAction apply(Packet packet) {\n       NamespaceStatus nss = domainNamespaces.getNamespaceStatus(ns);\n-      if (fullRecheck || !nss.isNamespaceStarting().getAndSet(true)) {\n+      if (fullRecheck) {\n         return doNext(packet);\n-      } else {\n-        return doEnd(packet);\n       }\n+\n+      if (!nss.isNamespaceStarting().getAndSet(true)) {", "originalCommit": "363aa36b239088b6d95fa0b281f31dae0aa5206b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY0MTM3Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548641376", "bodyText": "done", "author": "doxiao", "createdAt": "2020-12-24T17:29:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MDgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MTE4OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548551189", "bodyText": "Please extract the logic for creating these steps into its own method.", "author": "russgold", "createdAt": "2020-12-24T14:54:08Z", "path": "operator/src/main/java/oracle/kubernetes/operator/Namespaces.java", "diffHunk": "@@ -231,8 +230,42 @@ public NamespaceListAfterStep(DomainNamespaces domainNamespaces) {\n     public NextAction apply(Packet packet) {\n       NamespaceValidationContext validationContext = new NamespaceValidationContext(packet);\n       getNonNullConfiguredDomainNamespaces().forEach(validationContext::validateConfiguredNamespace);\n+      List<StepAndPacket> nsStopEventSteps =", "originalCommit": "363aa36b239088b6d95fa0b281f31dae0aa5206b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY0MTI5Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548641292", "bodyText": "done", "author": "doxiao", "createdAt": "2020-12-24T17:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MTE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MTkxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548551914", "bodyText": "Please extract the expression against which you're comparing the namespace into its own method.", "author": "russgold", "createdAt": "2020-12-24T14:56:53Z", "path": "operator/src/test/java/oracle/kubernetes/operator/EventTestUtils.java", "diffHunk": "@@ -0,0 +1,171 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.kubernetes.operator;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import javax.validation.constraints.NotNull;\n+\n+import io.kubernetes.client.openapi.models.V1Event;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1ObjectReference;\n+import oracle.kubernetes.operator.helpers.KubernetesTestSupport;\n+\n+import static oracle.kubernetes.operator.EventConstants.WEBLOGIC_OPERATOR_COMPONENT;\n+\n+public class EventTestUtils {\n+  private static List<V1Event> getEventsMatchesReason(@NotNull List<V1Event> events, String reason) {\n+    return events.stream().filter(event -> reasonMatches(event, reason)).collect(Collectors.toList());\n+  }\n+\n+  /**\n+   * Whether an there is an event matches the given reason and namespace.\n+   *\n+   * @param events a list of events\n+   * @param reason the reason to match\n+   * @param namespace the namespace to match\n+   * @return true if there is a matching event\n+   */\n+  public static boolean containsEventWithNamespace(@NotNull List<V1Event> events, String reason, String namespace) {\n+    return namespace.equals(getEventsMatchesReason(events, reason).stream()", "originalCommit": "363aa36b239088b6d95fa0b281f31dae0aa5206b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY0MTIwNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548641204", "bodyText": "modified", "author": "doxiao", "createdAt": "2020-12-24T17:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MTkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MjQxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548552410", "bodyText": "Please rename the method getEventsMatchesReason as getEventsWithReason", "author": "russgold", "createdAt": "2020-12-24T14:59:04Z", "path": "operator/src/test/java/oracle/kubernetes/operator/EventTestUtils.java", "diffHunk": "@@ -0,0 +1,171 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.kubernetes.operator;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import javax.validation.constraints.NotNull;\n+\n+import io.kubernetes.client.openapi.models.V1Event;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1ObjectReference;\n+import oracle.kubernetes.operator.helpers.KubernetesTestSupport;\n+\n+import static oracle.kubernetes.operator.EventConstants.WEBLOGIC_OPERATOR_COMPONENT;\n+\n+public class EventTestUtils {\n+  private static List<V1Event> getEventsMatchesReason(@NotNull List<V1Event> events, String reason) {", "originalCommit": "363aa36b239088b6d95fa0b281f31dae0aa5206b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY0MDgwOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548640809", "bodyText": "renamed", "author": "doxiao", "createdAt": "2020-12-24T17:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MjQxMA=="}], "type": "inlineReview"}, {"oid": "eab0d51edbef63e3bd6a652acf2dae2384034133", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/eab0d51edbef63e3bd6a652acf2dae2384034133", "message": "address review comments", "committedDate": "2020-12-24T16:43:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODYxMjg5Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548612892", "bodyText": "Should we remove the coredns events from here?", "author": "alai8", "createdAt": "2020-12-24T16:46:56Z", "path": "docs-source/content/userguide/managing-domains/domain-events.md", "diffHunk": "@@ -278,65 +280,117 @@ Events:  <none>\n \n ```\n \n+Example of a `NamespaceWatchingStarted` event:\n+\n+```none\n+Name:             sample-domain1-ns.NamespaceWatchingStarted.1608734146651\n+Namespace:        sample-domain1-ns\n+Labels:           weblogic.createdByOperator=true\n+Annotations:      <none>\n+API Version:      v1\n+Event Time:       <nil>\n+First Timestamp:  <nil>\n+Involved Object:\n+  Kind:          Namespace\n+  Name:          sample-domain1-ns\n+  Namespace:     sample-domain1-ns\n+Kind:            Event\n+Last Timestamp:  2020-12-23T14:35:46Z\n+Message:         Started watching namespace sample-domain1-ns\n+Metadata:\n+  Creation Timestamp:  2020-12-23T14:35:46Z\n+  Resource Version:    1330665\n+  Self Link:           /api/v1/namespaces/sample-domain1-ns/events/sample-domain1-ns.NamespaceWatchingStarted.1608734146651\n+  UID:                 aaa5b073-56cf-4f9b-8c2b-0e471b2303ef\n+Reason:                NamespaceWatchingStarted\n+Reporting Component:   weblogic.operator\n+Reporting Instance:    weblogic-operator-7c5577bb75-9nz59\n+Source:\n+Type:    Normal\n+Events:  <none>\n+\n+```\n+\n+Example of a `NamespaceWatchingStopped` event:\n+```none\n+Name:             sample-domain2-ns.NamespaceWatchingStopped.1608742207204\n+Namespace:        sample-domain2-ns\n+Labels:           weblogic.createdByOperator=true\n+Annotations:      <none>\n+API Version:      v1\n+Event Time:       <nil>\n+First Timestamp:  <nil>\n+Involved Object:\n+  Kind:          Namespace\n+  Name:          sample-domain2-ns\n+  Namespace:     sample-domain2-ns\n+Kind:            Event\n+Last Timestamp:  2020-12-23T16:50:07Z\n+Message:         Stopped watching namespace sample-domain2-ns\n+Metadata:\n+  Creation Timestamp:  2020-12-23T16:50:07Z\n+  Resource Version:    1340607\n+  Self Link:           /api/v1/namespaces/sample-domain2-ns/events/sample-domain2-ns.NamespaceWatchingStopped.1608742207204\n+  UID:                 d7c2ebb2-c8a0-4387-a30e-91caeae86c0e\n+Reason:                NamespaceWatchingStopped\n+Reporting Component:   weblogic.operator\n+Reporting Instance:    weblogic-operator-568fbd78bb-2gx9w\n+Source:\n+Type:    Normal\n+Events:  <none>\n+\n+```\n+\n Example of domain processing completed after failure and retries:\n \n The scenario is that the operator initially failed to process the domain resource because the specified image was missing, and then completed the processing during a retry after the image was recreated.\n Note that this is not a full list of events; some of the events that are generated by the Kubernetes server have been removed to make the list less cluttered.\n \n ```none\n-\n-LAST SEEN   TYPE      REASON                      OBJECT                                  MESSAGE\n-5m30s       Normal    DomainProcessingStarting    domain/sample-domain1                   Creating or updating Kubernetes presence for WebLogic Domain with UID sample-domain1\n-5m30s       Normal    Scheduled                   pod/sample-domain1-introspector-jlxsj   Successfully assigned sample-domain1-ns/sample-domain1-introspector-jlxsj to doxiao-1\n-5m27s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login', the processing will be retried if required\n-5m14s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: Back-off pulling image \"domain-home-in-image:12.2.1.4\", the processing will be retried if required\n-5m2s        Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login', the processing will be retried if required\n-4m50s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: Back-off pulling image \"domain-home-in-image:12.2.1.4\", the processing will be retried if required\n-4m50s       Normal    Pulling                     pod/sample-domain1-introspector-jlxsj   Pulling image \"domain-home-in-image:12.2.1.4\"\n-4m49s       Warning   Failed                      pod/sample-domain1-introspector-jlxsj   Error: ErrImagePull\n-4m49s       Warning   Failed                      pod/sample-domain1-introspector-jlxsj   Failed to pull image \"domain-home-in-image:12.2.1.4\": rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login'\n-4m34s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login', the processing will be retried if required\n-4m20s       Normal    BackOff                     pod/sample-domain1-introspector-jlxsj   Back-off pulling image \"domain-home-in-image:12.2.1.4\"\n-4m20s       Warning   Failed                      pod/sample-domain1-introspector-jlxsj   Error: ImagePullBackOff\n-4m20s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: Back-off pulling image \"domain-home-in-image:12.2.1.4\", the processing will be retried if required\n-3m49s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login', the processing will be retried if required\n-3m36s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: Back-off pulling image \"domain-home-in-image:12.2.1.4\", the processing will be retried if required\n-2m30s       Warning   DeadlineExceeded            job/sample-domain1-introspector         Job was active longer than specified deadline\n-2m30s       Normal    SuccessfulDelete            job/sample-domain1-introspector         Deleted pod: sample-domain1-introspector-jlxsj\n-2m30s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: Back-off pulling image \"domain-home-in-image:12.2.1.4\", the processing will be retried if required\n-2m29s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: Job sample-domain1-introspector failed due to reason: DeadlineExceeded. ActiveDeadlineSeconds of the job is configured with 180 seconds. The job was started 180 seconds ago. Ensure all domain dependencies have been deployed (any secrets, config-maps, PVs, and PVCs that the domain resource references). Use kubectl describe for the job and its pod for more job failure information. The job may be retried by the operator up to 5 times with longer ActiveDeadlineSeconds value in each subsequent retry. Use tuning parameter domainPresenceFailureRetryMaxCount to configure max retries., the processing will be retried if required\n-2m20s       Normal    DomainProcessingRetrying    domain/sample-domain1                   Retrying the processing of domain resource sample-domain1 after one or more failed attempts\n-2m18s       Normal    Scheduled                   pod/sample-domain1-introspector-6227v   Successfully assigned sample-domain1-ns/sample-domain1-introspector-6227v to doxiao-1\n-2m18s       Normal    SuccessfulCreate            job/sample-domain1-introspector         Created pod: sample-domain1-introspector-6227v\n-2m18s       Normal    DomainProcessingStarting    domain/sample-domain1                   Creating or updating Kubernetes presence for WebLogic Domain with UID sample-domain1\n-2m15s       Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login', the processing will be retried if required\n-2m1s        Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: Back-off pulling image \"domain-home-in-image:12.2.1.4\", the processing will be retried if required\n-2m1s        Normal    Pulling                     pod/sample-domain1-introspector-6227v   Pulling image \"domain-home-in-image:12.2.1.4\"\n-2m          Warning   Failed                      pod/sample-domain1-introspector-6227v   Failed to pull image \"domain-home-in-image:12.2.1.4\": rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login'\n-2m          Warning   Failed                      pod/sample-domain1-introspector-6227v   Error: ErrImagePull\n-107s        Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login', the processing will be retried if required\n-107s        Warning   Failed                      pod/sample-domain1-introspector-6227v   Error: ImagePullBackOff\n-107s        Normal    BackOff                     pod/sample-domain1-introspector-6227v   Back-off pulling image \"domain-home-in-image:12.2.1.4\"\n-103s        Normal    DomainChanged               domain/sample-domain1                   Domain resource sample-domain1 was changed\n-102s        Warning   DomainProcessingFailed      domain/sample-domain1                   Failed to complete processing domain resource sample-domain1 due to: rpc error: code = Unknown desc = pull access denied for domain-home-in-image, repository does not exist or may require 'docker login', the processing will be retried if required\n-99s         Normal    Scheduled                   pod/sample-domain1-introspector-fqzjv   Successfully assigned sample-domain1-ns/sample-domain1-introspector-fqzjv to doxiao-1\n-99s         Normal    DomainProcessingStarting    domain/sample-domain1                   Creating or updating Kubernetes presence for WebLogic Domain with UID sample-domain1\n-99s         Normal    SuccessfulCreate            job/sample-domain1-introspector         Created pod: sample-domain1-introspector-fqzjv\n-98s         Normal    Created                     pod/sample-domain1-introspector-fqzjv   Created container sample-domain1-introspector\n-98s         Normal    Pulled                      pod/sample-domain1-introspector-fqzjv   Container image \"domain-home-in-image:12.2.1.4\" already present on machine\n-98s         Normal    Started                     pod/sample-domain1-introspector-fqzjv   Started container sample-domain1-introspector\n-78s         Normal    Scheduled                   pod/sample-domain1-admin-server         Successfully assigned sample-domain1-ns/sample-domain1-admin-server to doxiao-1\n-77s         Normal    Created                     pod/sample-domain1-admin-server         Created container weblogic-server\n-77s         Normal    Started                     pod/sample-domain1-admin-server         Started container weblogic-server\n-77s         Normal    Pulled                      pod/sample-domain1-admin-server         Container image \"domain-home-in-image:12.2.1.4\" already present on machine\n-45s         Normal    DomainProcessingCompleted   domain/sample-domain1                   Successfully completed processing domain resource sample-domain1\n-45s         Normal    Scheduled                   pod/sample-domain1-managed-server2      Successfully assigned sample-domain1-ns/sample-domain1-managed-server2 to doxiao-1\n-45s         Normal    Scheduled                   pod/sample-domain1-managed-server1      Successfully assigned sample-domain1-ns/sample-domain1-managed-server1 to doxiao-1\n-44s         Normal    Started                     pod/sample-domain1-managed-server2      Started container weblogic-server\n-44s         Normal    Started                     pod/sample-domain1-managed-server1      Started container weblogic-server\n-44s         Normal    Created                     pod/sample-domain1-managed-server2      Created container weblogic-server\n-44s         Normal    Pulled                      pod/sample-domain1-managed-server2      Container image \"domain-home-in-image:12.2.1.4\" already present on machine\n-44s         Normal    Pulled                      pod/sample-domain1-managed-server1      Container image \"domain-home-in-image:12.2.1.4\" already present on machine\n-44s         Normal    Created                     pod/sample-domain1-managed-server1      Created container weblogic-server\n-\n-```\n+sample-domain1-ns             13m         Normal    NamespaceWatchingStarted    namespace/sample-domain1-ns               Started watching namespace sample-domain1-ns\n+kube-system                   13m         Normal    Pulling                     pod/coredns-5d4dd4b4db-qxs7l              Pulling image \"k8s.gcr.io/coredns:1.3.1\"", "originalCommit": "363aa36b239088b6d95fa0b281f31dae0aa5206b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY0MDYwMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548640601", "bodyText": "yes. removed.", "author": "doxiao", "createdAt": "2020-12-24T17:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODYxMjg5Mg=="}], "type": "inlineReview"}, {"oid": "16d6ee4a9af02ef1f498da2e8aa6faee759083ee", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/16d6ee4a9af02ef1f498da2e8aa6faee759083ee", "message": "minor change", "committedDate": "2020-12-24T16:47:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODYzMjM3NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548632374", "bodyText": "extra \"an\" in \"Whether an there\"? Same in other methods in this new class.", "author": "alai8", "createdAt": "2020-12-24T17:15:52Z", "path": "operator/src/test/java/oracle/kubernetes/operator/EventTestUtils.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.kubernetes.operator;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import javax.validation.constraints.NotNull;\n+\n+import io.kubernetes.client.openapi.models.V1Event;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1ObjectReference;\n+import oracle.kubernetes.operator.helpers.KubernetesTestSupport;\n+\n+import static oracle.kubernetes.operator.EventConstants.WEBLOGIC_OPERATOR_COMPONENT;\n+\n+public class EventTestUtils {\n+  private static List<V1Event> getEventsWithReason(@NotNull List<V1Event> events, String reason) {\n+    return events.stream().filter(event -> reasonMatches(event, reason)).collect(Collectors.toList());\n+  }\n+\n+  /**\n+   * Whether an there is an event matches the given reason and namespace.", "originalCommit": "16d6ee4a9af02ef1f498da2e8aa6faee759083ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY0MDY3OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548640678", "bodyText": "fixed.", "author": "doxiao", "createdAt": "2020-12-24T17:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODYzMjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY0MjQzOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548642439", "bodyText": "there are a few other methods with the same typo", "author": "alai8", "createdAt": "2020-12-24T17:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODYzMjM3NA=="}], "type": "inlineReview"}, {"oid": "2b2993592b27dd8c3112b20e43d127bc3b49e8d8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2b2993592b27dd8c3112b20e43d127bc3b49e8d8", "message": "remove kube-system events from example", "committedDate": "2020-12-24T17:24:05Z", "type": "commit"}, {"oid": "10577939a1483ef55a6d15b5d56b3967785d0727", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/10577939a1483ef55a6d15b5d56b3967785d0727", "message": "javadoc", "committedDate": "2020-12-24T17:26:21Z", "type": "commit"}, {"oid": "f0f15ff1bfa2236c2f494e0c97fc695e4a8614bb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f0f15ff1bfa2236c2f494e0c97fc695e4a8614bb", "message": "javadoc", "committedDate": "2020-12-24T17:27:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODcyMzM0NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548723344", "bodyText": "Should this method be called isNamespaceNotStarting() since it checks for negative condition?", "author": "ankedia", "createdAt": "2020-12-24T19:30:29Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainRecheck.java", "diffHunk": "@@ -207,12 +210,24 @@ Step startNamespaceSteps(String ns) {\n     @Override\n     public NextAction apply(Packet packet) {\n       NamespaceStatus nss = domainNamespaces.getNamespaceStatus(ns);\n-      if (fullRecheck || !nss.isNamespaceStarting().getAndSet(true)) {\n+      if (fullRecheck) {\n         return doNext(packet);\n+      } else if (isNamespaceStarting(nss)) {\n+        return doNext(addEventStep(), packet);\n       } else {\n         return doEnd(packet);\n       }\n     }\n+\n+    private Step addEventStep() {\n+      return Step.chain(\n+          EventHelper.createEventStep(new EventData(NAMESPACE_WATCHING_STARTED).namespace(ns).resourceName(ns)),\n+          getNext());\n+    }\n+\n+    private boolean isNamespaceStarting(NamespaceStatus nss) {", "originalCommit": "f0f15ff1bfa2236c2f494e0c97fc695e4a8614bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc0MDg0Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548740846", "bodyText": "it detects if the namespace's isStarting boolean has just been changed from false to true, indicating it is starting right now.", "author": "doxiao", "createdAt": "2020-12-24T19:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODcyMzM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc0MjU2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r548742562", "bodyText": "changed it to isNamespaceStartingChangedToTrue to avoid confusion.", "author": "doxiao", "createdAt": "2020-12-24T20:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODcyMzM0NA=="}], "type": "inlineReview"}, {"oid": "044b23f162c3aa56ef0a2dcc3708df8df0030c92", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/044b23f162c3aa56ef0a2dcc3708df8df0030c92", "message": "change method names", "committedDate": "2020-12-24T20:08:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5NjI2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551296260", "bodyText": "has started to watch -> has started watching\nhas stopped to watch -> has stopped watching", "author": "rosemarymarano", "createdAt": "2021-01-04T12:45:22Z", "path": "docs-source/content/userguide/managing-domains/domain-events.md", "diffHunk": "@@ -30,24 +30,26 @@ The operator generates these event types, which indicate the following:\n  *  `DomainProcessingCompleted`:  The operator successfully completed the processing of a domain resource.\n  *  `DomainProcessingAborted`:  The operator stopped processing a domain when the operator encountered a fatal error or a failure that persisted after the specified maximum number of retries.\n  *  `DomainValidationError`:  A validation error or warning is found in a domain resource. Please refer to the event message for details.\n+ *  `NamespaceWatchingStarted`: The operator has started to watch for domains in a namespace.\n+ *  `NamespaceWatchingStopped`: The operator has stopped to watch for domains in a namespace.", "originalCommit": "044b23f162c3aa56ef0a2dcc3708df8df0030c92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5Nzg0Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551297842", "bodyText": "the kind of the Kubernetes resource -> (suggestion, if correct) the type of the Kubernetes resource", "author": "rosemarymarano", "createdAt": "2021-01-04T12:48:34Z", "path": "docs-source/content/userguide/managing-domains/domain-events.md", "diffHunk": "@@ -30,24 +30,26 @@ The operator generates these event types, which indicate the following:\n  *  `DomainProcessingCompleted`:  The operator successfully completed the processing of a domain resource.\n  *  `DomainProcessingAborted`:  The operator stopped processing a domain when the operator encountered a fatal error or a failure that persisted after the specified maximum number of retries.\n  *  `DomainValidationError`:  A validation error or warning is found in a domain resource. Please refer to the event message for details.\n+ *  `NamespaceWatchingStarted`: The operator has started to watch for domains in a namespace.\n+ *  `NamespaceWatchingStopped`: The operator has stopped to watch for domains in a namespace.\n \n #### Operator-generated event details\n \n Each operator-generated event contains the following fields:\n  *  `metadata`\n     *  `namespace`:  Same as the domain resource namespace.\n-    *  `labels`:   `weblogic.createdByOperator=true` and `weblogic.domainUID=<domainUID>`.\n+    *  `labels`:   `weblogic.createdByOperator=true` and, for a domain event, `weblogic.domainUID=<domainUID>`.\n  *  `type`:  String field that describes the type of the event. Possible values are `Normal` or `Warning`.\n  *  `reportingComponent`:  String that describes the component that reports the event. The value is `weblogic.operator` for all operator-generated events.\n  *  `reportingInstance`:  String that describes the instance that reports the event. The value is the Kubernetes pod name of the operator instance that generates the event.\n  *  `lastTimestamp`:  `DateTime` field that presents the timestamp of the last occurrence of this event.\n  *  `reason`:  Short, machine understandable string that gives the reason for the transition to the object's current status.\n  *  `message`:  String that describes the details of the event.\n  *  `involvedObject`:  `V1ObjectReference` object that describes the Kubernetes resources with which this event is associated.\n-    *  `name`:  String that describes the name of the domain resource, which is the `domainUID`.\n-    *  `namespace`:  String that describes the namespace of the event, which is the namespace of the domain resource.\n-    *  `kind`:  String that describes the kind of the Kubernetes resource with which this event is associated. The value is `Domain` for all operator-generated events.\n-    *  `apiVersion`:  String that describes the `apiVersion` of the involved object, which is the `apiVersion` of the domain resource, for example, `weblogic.oracle/v8`.\n+    *  `name`:  String that describes the name of the resource, either a domain resource, in which case the name is the `domainUID`, or a namespace, in which case the name is the name of the namespace.\n+    *  `namespace`:  String that describes the namespace of the event, which is the namespace of the domain resource for a domain event.\n+    *  `kind`:  String that describes the kind of the Kubernetes resource with which this event is associated. The value is `Domain` for a domain event, and `Namespace` for a namespace event.", "originalCommit": "044b23f162c3aa56ef0a2dcc3708df8df0030c92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "221312bf078346ee85684b7f8fb30ba06d9f84a5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/221312bf078346ee85684b7f8fb30ba06d9f84a5", "message": "address review comments in doc", "committedDate": "2021-01-04T14:19:51Z", "type": "commit"}, {"oid": "5563d4dd82270180620476dc5a73492be96ee214", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5563d4dd82270180620476dc5a73492be96ee214", "message": "fine tuning of test util", "committedDate": "2021-01-04T14:48:06Z", "type": "commit"}, {"oid": "9e4d30bdf5aeadbc1e22a3c54629b7b462d9a03d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9e4d30bdf5aeadbc1e22a3c54629b7b462d9a03d", "message": "more minor changes to test util", "committedDate": "2021-01-04T15:09:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM3NDA3Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551374077", "bodyText": "Minor suggestion:\nChange the Overview's This document describes Kubernetes events that the operator generates about domain resources that it manages, during key points of its domain processing workflow.  to something like This document describes Kubernetes events that the operator generates about resources that it manages, during key points of its domain and namespace processing workflow.", "author": "tbarnes-us", "createdAt": "2021-01-04T15:10:08Z", "path": "docs-source/content/userguide/managing-domains/domain-events.md", "diffHunk": "@@ -30,24 +30,26 @@ The operator generates these event types, which indicate the following:\n  *  `DomainProcessingCompleted`:  The operator successfully completed the processing of a domain resource.\n  *  `DomainProcessingAborted`:  The operator stopped processing a domain when the operator encountered a fatal error or a failure that persisted after the specified maximum number of retries.\n  *  `DomainValidationError`:  A validation error or warning is found in a domain resource. Please refer to the event message for details.\n+ *  `NamespaceWatchingStarted`: The operator has started watching for domains in a namespace.\n+ *  `NamespaceWatchingStopped`: The operator has stopped watching for domains in a namespace.", "originalCommit": "5563d4dd82270180620476dc5a73492be96ee214", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f1bfe733939b14e37dd2b38a189819cdd04ef041", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f1bfe733939b14e37dd2b38a189819cdd04ef041", "message": "doc changes", "committedDate": "2021-01-04T15:19:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0MjcyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551542728", "bodyText": "The name of this method is problematic, as it explains how it is implemented, rather than what behavior it provides. I presume that the intent is that the namespace should be started? And that it only happens once?\nIf so, maybe something like, shouldStartNamespace would be better. Better still would be to put that method on DomainNamespaces in order to start hiding the implementation of the flag.", "author": "russgold", "createdAt": "2021-01-04T20:12:54Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainRecheck.java", "diffHunk": "@@ -207,12 +210,24 @@ Step startNamespaceSteps(String ns) {\n     @Override\n     public NextAction apply(Packet packet) {\n       NamespaceStatus nss = domainNamespaces.getNamespaceStatus(ns);\n-      if (fullRecheck || !nss.isNamespaceStarting().getAndSet(true)) {\n+      if (fullRecheck) {\n         return doNext(packet);\n+      } else if (isNamespaceStartingChangedToTrue(nss)) {\n+        return doNext(addNSWatchingStartingEventStep(), packet);\n       } else {\n         return doEnd(packet);\n       }\n     }\n+\n+    private Step addNSWatchingStartingEventStep() {\n+      return Step.chain(\n+          EventHelper.createEventStep(new EventData(NAMESPACE_WATCHING_STARTED).namespace(ns).resourceName(ns)),\n+          getNext());\n+    }\n+\n+    private boolean isNamespaceStartingChangedToTrue(NamespaceStatus nss) {", "originalCommit": "f1bfe733939b14e37dd2b38a189819cdd04ef041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU1Mjk3NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551552974", "bodyText": "Did you mean to move the method (after rename it) to DomainStatus (instead of DomainnNamespaces) class?", "author": "doxiao", "createdAt": "2021-01-04T20:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0MjcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2MjQ1OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551562458", "bodyText": "I think I understand what you meant now. thanks.", "author": "doxiao", "createdAt": "2021-01-04T20:53:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0MjcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0ODgxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551548810", "bodyText": "It's not clear to me what is happening here. What are you asserting? Why are you doing it in a loop?\nFor complex assertions, there are a number of strategies, including creating a custom matcher.", "author": "russgold", "createdAt": "2021-01-04T20:24:09Z", "path": "operator/src/test/java/oracle/kubernetes/operator/MainTest.java", "diffHunk": "@@ -570,6 +576,141 @@ public void afterNamespaceAdded_scriptConfigMapIsDefined() {\n     assertThat(getScriptMap(ns), notNullValue());\n   }\n \n+  @Test\n+  public void withNamespaceList_onCreateStartNamespacesStep_nsWatchStartedEventCreatedWithExpectedMessage() {\n+    defineSelectionStrategy(SelectionStrategy.List);\n+    HelmAccessStub.defineVariable(HelmAccess.OPERATOR_DOMAIN_NAMESPACES,\n+        String.join(\",\", NS_WEBLOGIC1, NS_WEBLOGIC2, NS_WEBLOGIC3));\n+    testSupport.defineResources(NAMESPACE_WEBLOGIC1, NAMESPACE_WEBLOGIC2, NAMESPACE_WEBLOGIC3,\n+        NAMESPACE_WEBLOGIC4, NAMESPACE_WEBLOGIC5);\n+\n+    List<String> namespaces = Arrays.asList(NS_WEBLOGIC1, NS_WEBLOGIC2, NS_WEBLOGIC3);\n+    testSupport.runSteps(\n+        createDomainRecheck().createStartNamespacesStep(namespaces));\n+\n+    for (String ns: namespaces) {\n+      MatcherAssert.assertThat(\"Event NAMESPACE_WATCHING_STARTED message\",\n+          EventTestUtils.containsEventWithMessage(getEvents(testSupport),", "originalCommit": "f1bfe733939b14e37dd2b38a189819cdd04ef041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2MTUwOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2119#discussion_r551561508", "bodyText": "it is to verify that the operator generates an event for each of the namespaces that are supposed to be started.", "author": "doxiao", "createdAt": "2021-01-04T20:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU0ODgxMA=="}], "type": "inlineReview"}, {"oid": "103408533f8377022abaa495869b85299ab6fb18", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/103408533f8377022abaa495869b85299ab6fb18", "message": "refactoring to address new comments", "committedDate": "2021-01-04T21:52:47Z", "type": "commit"}, {"oid": "8c75565e6da44d7a1a3720b151fea4de3a7d012b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8c75565e6da44d7a1a3720b151fea4de3a7d012b", "message": "copyright", "committedDate": "2021-01-04T22:19:28Z", "type": "commit"}, {"oid": "6ee7e8d3d9c3cbf563e0d4021856261e4868927d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6ee7e8d3d9c3cbf563e0d4021856261e4868927d", "message": "correct test assert text", "committedDate": "2021-01-04T22:57:23Z", "type": "commit"}]}