{"pr_number": 2095, "pr_title": "Split MII zips across Config Maps", "pr_createdAt": "2020-12-10T16:36:40Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095", "timeline": [{"oid": "8e3fb5ddd16228a7bd51a5a5b1eff07016e0da6e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8e3fb5ddd16228a7bd51a5a5b1eff07016e0da6e", "message": "Create plugin for running bash unit tests", "committedDate": "2020-12-10T15:55:44Z", "type": "commit"}, {"oid": "34e966a47aefc4cc44559c82e4a126b2ade6e838", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/34e966a47aefc4cc44559c82e4a126b2ade6e838", "message": "Support splitting encoded zips across multiple config maps", "committedDate": "2020-12-10T16:01:07Z", "type": "commit"}, {"oid": "1d2cb146476385e6996d54c36830b96914e126b8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1d2cb146476385e6996d54c36830b96914e126b8", "message": "Update implementation docs to mention additional config maps", "committedDate": "2020-12-10T19:51:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4MDM5OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095#discussion_r541080399", "bodyText": "It'd be helpful to have a high level explanation of the encoding approach in this comment (the 'range' file's purpose, and the directory structure when it's not '0 0'...).", "author": "tbarnes-us", "createdAt": "2020-12-11T16:44:11Z", "path": "operator/src/main/resources/scripts/modelInImage.sh", "diffHunk": "@@ -514,6 +515,71 @@ function createModelDomain() {\n   trace \"Exiting createModelDomain\"\n }\n \n+\n+# Expands into the root directory the MII domain configuration, stored in one or more config maps\n+function restoreDomainConfig() {\n+  restoreEncodedTar \"domainzip.secure\" || return 1\n+\n+  chmod +x ${DOMAIN_HOME}/bin/*.sh ${DOMAIN_HOME}/*.sh  || return 1\n+}\n+\n+# Expands into the root directory the MII primordial domain, stored in one or more config maps\n+function restorePrimordialDomain() {\n+  restoreEncodedTar \"primordial_domainzip.secure\" || return 1\n+}\n+\n+# Restores the specified directory, targz'ed and stored in one or more config maps after base 64 encoding", "originalCommit": "1d2cb146476385e6996d54c36830b96914e126b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MzQ1MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095#discussion_r541093450", "bodyText": "With your suggested change, I no longer need the range file, so I will remove the Java code that creates it.", "author": "russgold", "createdAt": "2020-12-11T17:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4MDM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4NjI3OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095#discussion_r541086278", "bodyText": "Alternatively: cat ${OPERATOR_ROOT}/introspector*/${1} > /tmp/domain.secure.", "author": "tbarnes-us", "createdAt": "2020-12-11T16:52:54Z", "path": "operator/src/main/resources/scripts/modelInImage.sh", "diffHunk": "@@ -514,6 +515,71 @@ function createModelDomain() {\n   trace \"Exiting createModelDomain\"\n }\n \n+\n+# Expands into the root directory the MII domain configuration, stored in one or more config maps\n+function restoreDomainConfig() {\n+  restoreEncodedTar \"domainzip.secure\" || return 1\n+\n+  chmod +x ${DOMAIN_HOME}/bin/*.sh ${DOMAIN_HOME}/*.sh  || return 1\n+}\n+\n+# Expands into the root directory the MII primordial domain, stored in one or more config maps\n+function restorePrimordialDomain() {\n+  restoreEncodedTar \"primordial_domainzip.secure\" || return 1\n+}\n+\n+# Restores the specified directory, targz'ed and stored in one or more config maps after base 64 encoding\n+# args:\n+# $1 the name of the encoded file in the config map\n+function restoreEncodedTar() {\n+  cd / || return 1\n+  indexRange=\"$(getIndexRange $1)\"\n+  # shellcheck disable=SC2046\n+  cat $(buildConfigMapElements $1 $indexRange) > /tmp/domain.secure", "originalCommit": "1d2cb146476385e6996d54c36830b96914e126b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MTgyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095#discussion_r541091824", "bodyText": "Thanks. That both simplifies the code and eliminates the need for the additional functions and their tests.", "author": "russgold", "createdAt": "2020-12-11T17:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4NjI3OA=="}], "type": "inlineReview"}, {"oid": "ccd44f38811ea7bc7fe92c15da7114c7512e377a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ccd44f38811ea7bc7fe92c15da7114c7512e377a", "message": "simplify joining split archives", "committedDate": "2020-12-11T16:59:27Z", "type": "commit"}, {"oid": "aafd19d61e3ad5fb69405fca1302a720e6d19c32", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/aafd19d61e3ad5fb69405fca1302a720e6d19c32", "message": "delete unusued functions", "committedDate": "2020-12-11T17:00:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5ODc3Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095#discussion_r541098777", "bodyText": "@jshum2479 This is unrelated to Russ' enhancement, but shouldn't the old /tmp file be removed upon success? I assume it takes up a good amount of space.\ntar -xzf /tmp/domain.tar.gz || return 1\nrm /tmp/domain.tar.gz", "author": "tbarnes-us", "createdAt": "2020-12-11T17:12:21Z", "path": "operator/src/main/resources/scripts/modelInImage.sh", "diffHunk": "@@ -514,6 +515,31 @@ function createModelDomain() {\n   trace \"Exiting createModelDomain\"\n }\n \n+\n+# Expands into the root directory the MII domain configuration, stored in one or more config maps\n+function restoreDomainConfig() {\n+  restoreEncodedTar \"domainzip.secure\" || return 1\n+\n+  chmod +x ${DOMAIN_HOME}/bin/*.sh ${DOMAIN_HOME}/*.sh  || return 1\n+}\n+\n+# Expands into the root directory the MII primordial domain, stored in one or more config maps\n+function restorePrimordialDomain() {\n+  restoreEncodedTar \"primordial_domainzip.secure\" || return 1\n+}\n+\n+# Restores the specified directory, targz'ed and stored in one or more config maps after base 64 encoding\n+# args:\n+# $1 the name of the encoded file in the config map\n+function restoreEncodedTar() {\n+  cd / || return 1\n+  cat ${OPERATOR_ROOT}/introspector*/${1} > /tmp/domain.secure\n+  base64 -d \"/tmp/domain.secure\" > /tmp/domain.tar.gz || return 1\n+\n+  tar -xzf /tmp/domain.tar.gz || return 1", "originalCommit": "aafd19d61e3ad5fb69405fca1302a720e6d19c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc2NzgyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095#discussion_r542767824", "bodyText": "modelInImage only affects the introspect pod which will go away anyway,  but since this method will be called in startServer.sh, we should clean up the specific file.", "author": "jshum2479", "createdAt": "2020-12-14T20:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5ODc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5OTQyMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2095#discussion_r541099423", "bodyText": "Append || return 1 to the cat...  (not strictly needed as the next line will fail if the cat fails)", "author": "tbarnes-us", "createdAt": "2020-12-11T17:13:25Z", "path": "operator/src/main/resources/scripts/modelInImage.sh", "diffHunk": "@@ -514,6 +515,31 @@ function createModelDomain() {\n   trace \"Exiting createModelDomain\"\n }\n \n+\n+# Expands into the root directory the MII domain configuration, stored in one or more config maps\n+function restoreDomainConfig() {\n+  restoreEncodedTar \"domainzip.secure\" || return 1\n+\n+  chmod +x ${DOMAIN_HOME}/bin/*.sh ${DOMAIN_HOME}/*.sh  || return 1\n+}\n+\n+# Expands into the root directory the MII primordial domain, stored in one or more config maps\n+function restorePrimordialDomain() {\n+  restoreEncodedTar \"primordial_domainzip.secure\" || return 1\n+}\n+\n+# Restores the specified directory, targz'ed and stored in one or more config maps after base 64 encoding\n+# args:\n+# $1 the name of the encoded file in the config map\n+function restoreEncodedTar() {\n+  cd / || return 1\n+  cat ${OPERATOR_ROOT}/introspector*/${1} > /tmp/domain.secure", "originalCommit": "aafd19d61e3ad5fb69405fca1302a720e6d19c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "56b8abc94be48029e7f3d1d7b6b0be18859a2025", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/56b8abc94be48029e7f3d1d7b6b0be18859a2025", "message": "Remove unused functionality", "committedDate": "2020-12-11T17:32:29Z", "type": "commit"}]}