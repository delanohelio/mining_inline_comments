{"pr_number": 1745, "pr_title": "Changes to fix retry logic and recover gracefully from lack of RBAC for CRD", "pr_createdAt": "2020-06-18T00:00:31Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745", "timeline": [{"oid": "fe4d5dae194350ece8936aacf4ee5d5e2c605a45", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fe4d5dae194350ece8936aacf4ee5d5e2c605a45", "message": "Changes to fix retry logic and recover gracefully from lack of RBAC for CRD", "committedDate": "2020-06-17T22:37:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyMjUxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442222514", "bodyText": "So the functionality change is that we never retry on a create CRD failure? If so, you need to change the names of the tests you modified, since they assert that the retry will happen.", "author": "russgold", "createdAt": "2020-06-18T13:24:26Z", "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/CrdHelperTest.java", "diffHunk": "@@ -179,9 +180,7 @@ public void whenNoCrd_retryOnFailure() {\n \n     Step scriptCrdStep = CrdHelper.createDomainCrdStep(KUBERNETES_VERSION_15, null);\n     testSupport.runSteps(scriptCrdStep);\n-", "originalCommit": "fe4d5dae194350ece8936aacf4ee5d5e2c605a45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMzg4Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442433883", "bodyText": "We still retry on create CRD failure. The functionality change is to log a failure message in onFailureNoRetry method when operator doesn't have permission to create CRD (status code 401) and continue to next step . Some customers want to manage their own CRD and don't want operator to fail if it doesn't have permission to create/update/patch CRD.\nI have changed the name of test method to reflect this and also added back one of the previous assertion. The only change is to assert that CRD creation failure message is logged instead of verifying throwable.", "author": "ankedia", "createdAt": "2020-06-18T18:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyMjUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyMjkxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442222914", "bodyText": "As above, the test no longer does what its name says it does.", "author": "russgold", "createdAt": "2020-06-18T13:24:57Z", "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/CrdHelperTest.java", "diffHunk": "@@ -242,8 +241,7 @@ public void whenReplaceFails_scheduleRetry() {\n     Step scriptCrdStep = CrdHelper.createDomainCrdStep(KUBERNETES_VERSION_16, null);\n     testSupport.runSteps(scriptCrdStep);\n \n-    testSupport.verifyCompletionThrowable(FailureStatusSourceException.class);", "originalCommit": "fe4d5dae194350ece8936aacf4ee5d5e2c605a45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNDczNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442434736", "bodyText": "I have changed the name of test method to reflect current purpose and also added back one of the previous assertion. The only change is to assert that CRD replace failure message is logged instead of verifying throwable.", "author": "ankedia", "createdAt": "2020-06-18T18:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyMjkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyMzQ4MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442223481", "bodyText": "This is changed behavior and there is no corresponding unit test.", "author": "russgold", "createdAt": "2020-06-18T13:25:48Z", "path": "operator/src/main/java/oracle/kubernetes/operator/calls/AsyncRequestStep.java", "diffHunk": "@@ -377,14 +377,18 @@ public NextAction doPotentialRetry(Step conflictStep, Packet packet, int statusC\n         }\n \n         NextAction na = new NextAction();", "originalCommit": "fe4d5dae194350ece8936aacf4ee5d5e2c605a45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MDgzOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442540839", "bodyText": "Just to clarify - changed behavior is to fix a bug as retry logic was not working as intended. I have added unit tests multipleFailedCallbackNoRetriesLeft_verifyCompletionThrowable() and multipleFailedCallbackRetriesLeft_nextStepAppliedWithValue() in AsyncRequestStepTest to cover this changed behavior.", "author": "ankedia", "createdAt": "2020-06-18T22:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyMzQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNTAyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442235024", "bodyText": "This conditional has now become complex enough that it should probably be broken out into another method. I would recommend changing it to } else if (retriesLeft() && isRestartableConflict(conflictStep, status)) {\nwhere you also have:```\nprivate isRestartableConflict(Step conflictStep, int status) {\n  return conflictStep != null && status == 409;\n}```\n\nThis would also allow you to move the comment explain optimistic locking failures to just above the new method", "author": "russgold", "createdAt": "2020-06-18T13:42:20Z", "path": "operator/src/main/java/oracle/kubernetes/operator/calls/AsyncRequestStep.java", "diffHunk": "@@ -377,14 +377,18 @@ public NextAction doPotentialRetry(Step conflictStep, Packet packet, int statusC\n         }\n \n         NextAction na = new NextAction();\n-        if (statusCode == 0 && retryCount <= maxRetryCount) {\n-          na.invoke(Optional.ofNullable(conflictStep).orElse(retryStep), packet);\n-        } else {\n-          LOGGER.finer(MessageKeys.ASYNC_RETRY, identityHash(), String.valueOf(waitTime));\n-          na.delay(retryStep, packet, waitTime, TimeUnit.MILLISECONDS);\n+        if (retryCount <= maxRetryCount) {\n+          if (statusCode == 0) {\n+            na.invoke(retryStep, packet);\n+          } else {\n+            LOGGER.finer(MessageKeys.ASYNC_RETRY, identityHash(), String.valueOf(waitTime));\n+            na.delay(retryStep, packet, waitTime, TimeUnit.MILLISECONDS);\n+          }\n+          return na;\n         }\n-        return na;\n-      } else if (statusCode == 409 /* Conflict */ && conflictStep != null) {\n+      } else if (statusCode == 409 /* Conflict */", "originalCommit": "fe4d5dae194350ece8936aacf4ee5d5e2c605a45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNTE4Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442435186", "bodyText": "I have made the suggested changes, please review, Thanks.", "author": "ankedia", "createdAt": "2020-06-18T18:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNTAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNzQ0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442237447", "bodyText": "We're now testing this condition tries, so it is worth breaking it out into its own method:```\nprivate boolean retriesLeft() {\n  return retryCount <= maxRetryCount;\n};```\n\nIn addition, rather than using a nested if, negate the above condition and make it the first branch if an if-else if-else sequence, that simply returns na.", "author": "russgold", "createdAt": "2020-06-18T13:45:44Z", "path": "operator/src/main/java/oracle/kubernetes/operator/calls/AsyncRequestStep.java", "diffHunk": "@@ -377,14 +377,18 @@ public NextAction doPotentialRetry(Step conflictStep, Packet packet, int statusC\n         }\n \n         NextAction na = new NextAction();\n-        if (statusCode == 0 && retryCount <= maxRetryCount) {\n-          na.invoke(Optional.ofNullable(conflictStep).orElse(retryStep), packet);\n-        } else {\n-          LOGGER.finer(MessageKeys.ASYNC_RETRY, identityHash(), String.valueOf(waitTime));\n-          na.delay(retryStep, packet, waitTime, TimeUnit.MILLISECONDS);\n+        if (retryCount <= maxRetryCount) {", "originalCommit": "fe4d5dae194350ece8936aacf4ee5d5e2c605a45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNTMyMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442435320", "bodyText": "I have made the suggested changes, please review, Thanks.", "author": "ankedia", "createdAt": "2020-06-18T18:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNzQ0Nw=="}], "type": "inlineReview"}, {"oid": "60eb0baf535335ee37cfd35cad4e2f0bb304af4f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/60eb0baf535335ee37cfd35cad4e2f0bb304af4f", "message": "Changes based on review comment and further testing", "committedDate": "2020-06-18T18:43:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTU2NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442511565", "bodyText": "This is new functionality without a unit test", "author": "russgold", "createdAt": "2020-06-18T21:25:49Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/CrdHelper.java", "diffHunk": "@@ -559,6 +561,13 @@ public NextAction onSuccess(\n         LOGGER.info(MessageKeys.CREATING_CRD, callResponse);\n         return doNext(packet);\n       }\n+", "originalCommit": "60eb0baf535335ee37cfd35cad4e2f0bb304af4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDA2Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442544066", "bodyText": "I have added \"whenNoCrd_retryOnFailureAndLogFailedMessageInOnFailureNoRetry()\" test to cover this scenario. Please let me know if more unit tests needs to be added. Thanks.", "author": "ankedia", "createdAt": "2020-06-18T22:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTc1OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442511759", "bodyText": "New functionality without a unit test", "author": "russgold", "createdAt": "2020-06-18T21:26:16Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/CrdHelper.java", "diffHunk": "@@ -597,6 +613,15 @@ public NextAction onSuccess(\n         LOGGER.info(MessageKeys.CREATING_CRD, callResponse);\n         return doNext(packet);\n       }\n+\n+      @Override\n+      protected NextAction onFailureNoRetry(Packet packet, CallResponse<V1CustomResourceDefinition> callResponse) {", "originalCommit": "60eb0baf535335ee37cfd35cad4e2f0bb304af4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDUwOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442544508", "bodyText": "I have added whenReplaceFails_scheduleRetryAndLogFailedMessageInOnFailureNoRetry() unit test to cover this.", "author": "ankedia", "createdAt": "2020-06-18T22:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA1Njk5OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r443056998", "bodyText": "I have added a new unit test \"whenReplaceFailsThrowsStreamException_scheduleRetryAndLogFailedMessageInOnFailureNoRetry\"  for StreamResetException check .", "author": "ankedia", "createdAt": "2020-06-19T21:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTgyNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442511826", "bodyText": "New functionality without a unit test", "author": "russgold", "createdAt": "2020-06-18T21:26:24Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/CrdHelper.java", "diffHunk": "@@ -616,6 +641,15 @@ public NextAction onSuccess(\n         LOGGER.info(MessageKeys.CREATING_CRD, callResponse);\n         return doNext(packet);\n       }\n+\n+      @Override\n+      protected NextAction onFailureNoRetry(Packet packet, CallResponse<V1beta1CustomResourceDefinition> callResponse) {", "originalCommit": "60eb0baf535335ee37cfd35cad4e2f0bb304af4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NTEwMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442545103", "bodyText": "I think this is covered by whenBetaCrdReplaceFails_scheduleRetryAndLogFailedMessageInOnFailureNoRetry() unit test. Please let me know if more tests needs to be added.", "author": "ankedia", "createdAt": "2020-06-18T22:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA1NzE3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r443057172", "bodyText": "I have added a new unit test whenBetaCrdReplaceThrowsStreamResetException_scheduleRetryAndLogFailedMessageInOnFailureNoRetry() for StreamResetException check.", "author": "ankedia", "createdAt": "2020-06-19T21:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTg5MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442511891", "bodyText": "New functionality without a unit test", "author": "russgold", "createdAt": "2020-06-18T21:26:32Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/ResponseStep.java", "diffHunk": "@@ -151,8 +151,11 @@ public NextAction onFailure(Packet packet, CallResponse<T> callResponse) {\n    * @return Next action for fiber processing, which may be a retry\n    */\n   public NextAction onFailure(Step conflictStep, Packet packet, CallResponse<T> callResponse) {\n-    return Optional.ofNullable(doPotentialRetry(conflictStep, packet, callResponse))\n-        .orElse(onFailureNoRetry(packet, callResponse));\n+    Optional<NextAction> optionalNextAction =", "originalCommit": "60eb0baf535335ee37cfd35cad4e2f0bb304af4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzOTY1Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1745#discussion_r442539652", "bodyText": "This is a bug fix and not a new functionality. Previously, \"onFailureNoRetry()\" method in orElse clause was getting called even when Optional.ofNullable(doPotentialRetry()) returned a non-empty Optional. The change is to make sure that onFailureNoRetry() is called only when Optional.ofNullable(doPotentialRetry()) returns empty optional.", "author": "ankedia", "createdAt": "2020-06-18T22:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMTg5MQ=="}], "type": "inlineReview"}, {"oid": "27641171b485e82547443aef12b83599b51c17e0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/27641171b485e82547443aef12b83599b51c17e0", "message": "added unit tests for changed functionality", "committedDate": "2020-06-18T22:35:54Z", "type": "commit"}, {"oid": "25621ffbad9dba47fc85634a4eeb583b3678ac31", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/25621ffbad9dba47fc85634a4eeb583b3678ac31", "message": "Added new unit tests for StreamResetException check in onFailureNoRetry of replace CRD in CrdHelper", "committedDate": "2020-06-19T21:43:56Z", "type": "commit"}, {"oid": "78c9c4c4e3a80e50879a0cfeeea9a3d488c21408", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/78c9c4c4e3a80e50879a0cfeeea9a3d488c21408", "message": "remove unused dependency", "committedDate": "2020-06-22T14:50:06Z", "type": "commit"}, {"oid": "53e78ec98c3cb7304b5e9a46aa1fda197ede4981", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/53e78ec98c3cb7304b5e9a46aa1fda197ede4981", "message": "added unit tests", "committedDate": "2020-06-23T13:44:06Z", "type": "commit"}, {"oid": "bdf6ef61f22db1092253a0a6ef127e63de376199", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bdf6ef61f22db1092253a0a6ef127e63de376199", "message": "Support scheduled item adding to schedule", "committedDate": "2020-06-23T17:15:04Z", "type": "commit"}, {"oid": "2c24feba0e8fd46fdb6f6f9a2db2764f4edd4401", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2c24feba0e8fd46fdb6f6f9a2db2764f4edd4401", "message": "Added unit tests for status code 504 (server timeout) and test exceeding retry count", "committedDate": "2020-06-23T19:15:28Z", "type": "commit"}, {"oid": "dfdf794c6fa3278ac519b84b1415ce66267fdcbf", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/dfdf794c6fa3278ac519b84b1415ce66267fdcbf", "message": "fix test name", "committedDate": "2020-06-23T20:02:49Z", "type": "commit"}]}