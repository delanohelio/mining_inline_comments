{"pr_number": 2067, "pr_title": "Add data source online updates to the Update 4 MII sample.", "pr_createdAt": "2020-11-20T21:50:51Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067", "timeline": [{"oid": "47d91c9bd3b99d9b819f00e2acac95c75133925d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/47d91c9bd3b99d9b819f00e2acac95c75133925d", "message": "Add data source online updates to the Update 4 MII sample.", "committedDate": "2020-11-20T21:47:11Z", "type": "commit"}, {"oid": "51849883c0067bc526a5f5df581834bb6e4164f8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/51849883c0067bc526a5f5df581834bb6e4164f8", "message": "minor doc update", "committedDate": "2020-11-20T22:05:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NzU1OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r527997559", "bodyText": "Should we add \"and a domain restart (roll)\" for update 3 as in update 1?", "author": "alai8", "createdAt": "2020-11-20T22:09:27Z", "path": "docs-source/content/samples/simple/domains/model-in-image/_index.md", "diffHunk": "@@ -14,14 +14,15 @@ description: \"Sample for supplying a WebLogic Deploy Tooling (WDT) model that th\n      - [Sample directory structure](#sample-directory-structure)\n      - [Ensuring your Kubernetes cluster can access images](#ensuring-your-kubernetes-cluster-can-access-images)\n    - [References](#references)\n-   - [Prerequisites for all domain types]({{< relref \"/samples/simple/domains/model-in-image/prerequisites#prerequisites-for-all-domain-types\" >}})\n-   - [Additional prerequisites for JRF domains]({{< relref \"/samples/simple/domains/model-in-image/prerequisites#additional-prerequisites-for-jrf-domains\" >}})\n-   - [Initial]({{< relref \"/samples/simple/domains/model-in-image/initial.md\" >}}) use case: An initial WebLogic domain\n-   - [Update 1]({{< relref \"/samples/simple/domains/model-in-image/update1.md\" >}}): Dynamically adding a data source using a model ConfigMap\n-   - [Update 2]({{< relref \"/samples/simple/domains/model-in-image/update2.md\" >}}): Deploying an additional domain\n-   - [Update 3]({{< relref \"/samples/simple/domains/model-in-image/update3.md\" >}}): Updating an application in an image\n-   - [Update 4]({{< relref \"/samples/simple/domains/model-in-image/update4.md\" >}}): Dynamically update Work Manager Threads Constraints configurations using a model ConfigMap without restarting servers\n-   - [Cleanup]({{< relref \"/samples/simple/domains/model-in-image/cleanup.md\" >}})\n+   - Sample steps\n+     - [Prerequisites for all domain types]({{< relref \"/samples/simple/domains/model-in-image/prerequisites#prerequisites-for-all-domain-types\" >}})\n+     - [Additional prerequisites for JRF domains]({{< relref \"/samples/simple/domains/model-in-image/prerequisites#additional-prerequisites-for-jrf-domains\" >}})\n+     - [Initial]({{< relref \"/samples/simple/domains/model-in-image/initial.md\" >}}) use case: An initial WebLogic domain\n+     - [Update 1]({{< relref \"/samples/simple/domains/model-in-image/update1.md\" >}}): Dynamically adding a data source using a model ConfigMap and a domain restart (roll)\n+     - [Update 2]({{< relref \"/samples/simple/domains/model-in-image/update2.md\" >}}): Deploying an additional domain\n+     - [Update 3]({{< relref \"/samples/simple/domains/model-in-image/update3.md\" >}}): Updating an application in an image", "originalCommit": "51849883c0067bc526a5f5df581834bb6e4164f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA4NTM5Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528085396", "bodyText": "Sure. Done.", "author": "tbarnes-us", "createdAt": "2020-11-21T06:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NzU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5OTA2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r527999060", "bodyText": "I checked this file in accidentally and will remove it.  It's implicitly updated when you start the DB using the DB sample...", "author": "tbarnes-us", "createdAt": "2020-11-20T22:13:27Z", "path": "kubernetes/samples/scripts/create-oracle-db-service/common/oracle.db.yaml", "diffHunk": "@@ -71,4 +71,4 @@ spec:\n       securityContext: {}", "originalCommit": "51849883c0067bc526a5f5df581834bb6e4164f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTEwNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528001107", "bodyText": "should this commented line be removed?", "author": "alai8", "createdAt": "2020-11-20T22:18:54Z", "path": "kubernetes/samples/scripts/create-weblogic-domain/model-in-image/utils/wl-pod-wait.sh", "diffHunk": "@@ -172,6 +176,32 @@ function print_table() {\n   done\n }\n \n+#\n+# get domain value specified by $1:\n+#   for example '.spec.introspectVersion' or '.spec.restartVersion'\n+# and place result in the env var named by $2\n+# if expected>0 and echo an Error and exit script non-zero\n+#\n+function getDomainValue() {\n+  local attvalue\n+  local ljpath=\"{$1}\"\n+  local __retvar=$2\n+  set +e\n+  attvalue=$(kubectl -n ${DOMAIN_NAMESPACE} get domain ${DOMAIN_UID} -o=jsonpath=\"$ljpath\" 2>&1)\n+  # attvalue=$(kubectl -n ${DOMAIN_NAMESPACE} get domain ${DOMAIN_UID} -o=jpath='{.spec.restartVersion}' 2>&1)", "originalCommit": "51849883c0067bc526a5f5df581834bb6e4164f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA4NTY3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528085679", "bodyText": "Yes. Done.", "author": "tbarnes-us", "createdAt": "2020-11-21T06:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTg4MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528001880", "bodyText": "Looks like I doubled the http_proxy entry - I will fix.", "author": "tbarnes-us", "createdAt": "2020-11-20T22:20:54Z", "path": "src/integration-tests/model-in-image/mii-sample-wrapper/README", "diffHunk": "@@ -78,8 +78,20 @@ INCLUDE_MODEL_CONFIGMAP ::: Tell sample to include a configuration.model.configM\n   in the domain resource, and to add a configuration.model.secrets reference\n   to a secret that's used by the configMap. Also used by './create-secrets.sh' to\n   deploy a secret the configMap uses. \n+  See also CORRECTED_DATASOURCE_SECRET.\n   Valid values are 'false' (default), and 'true'.\n \n+CORRECTED_DATASOURCE_SECRET ::: Use correct values in datasource secret\n+  The DS secret is used by the configMap's DS to point to a DB.\n+  It's deliberately incorrect by default so the sample\n+  can demonstrate dynamically updating the DS params using online.\n+  See also INCLUDE_MODEL_CONFIGMAP.\n+  Valid values are 'false' (default), and 'true'.\n+\n+http_proxy https_proxy ::: Proxies\n+  If running behind a proxy, then set as needed to allow curl access\n+  to github.com. Used by 'stage-tooling.sh'.\n+", "originalCommit": "51849883c0067bc526a5f5df581834bb6e4164f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTkyOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528001929", "bodyText": "duplicate", "author": "alai8", "createdAt": "2020-11-20T22:21:05Z", "path": "src/integration-tests/model-in-image/mii-sample-wrapper/README", "diffHunk": "@@ -78,8 +78,20 @@ INCLUDE_MODEL_CONFIGMAP ::: Tell sample to include a configuration.model.configM\n   in the domain resource, and to add a configuration.model.secrets reference\n   to a secret that's used by the configMap. Also used by './create-secrets.sh' to\n   deploy a secret the configMap uses. \n+  See also CORRECTED_DATASOURCE_SECRET.\n   Valid values are 'false' (default), and 'true'.\n \n+CORRECTED_DATASOURCE_SECRET ::: Use correct values in datasource secret\n+  The DS secret is used by the configMap's DS to point to a DB.\n+  It's deliberately incorrect by default so the sample\n+  can demonstrate dynamically updating the DS params using online.\n+  See also INCLUDE_MODEL_CONFIGMAP.\n+  Valid values are 'false' (default), and 'true'.\n+\n+http_proxy https_proxy ::: Proxies", "originalCommit": "51849883c0067bc526a5f5df581834bb6e4164f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA4NjA3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528086079", "bodyText": "Unduplicated. Done.", "author": "tbarnes-us", "createdAt": "2020-11-21T06:40:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwNjQ5Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528006493", "bodyText": "if [ $corrected_datasource_secret = \"true\" ]; then\n    export CORRECTED_DATASOURCE_SECRET=true\nfi\n\nshould be replaced with\nexport CORRECTED_DATASOURCE_SECRET=$corrected_datasource_secret", "author": "tbarnes-us", "createdAt": "2020-11-20T22:34:30Z", "path": "src/integration-tests/model-in-image/mii-sample-wrapper/generate-sample-doc.sh", "diffHunk": "@@ -132,6 +137,9 @@ for phase in initial update1 update2 update3 update4; do\n   if [ $configmap != \"None\" ]; then\n     export INCLUDE_MODEL_CONFIGMAP=true\n   fi\n+  if [ $corrected_datasource_secret = \"true\" ]; then\n+    export CORRECTED_DATASOURCE_SECRET=true", "originalCommit": "51849883c0067bc526a5f5df581834bb6e4164f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwODg3MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528008871", "bodyText": "yes, this is better, but what it was before would also work", "author": "alai8", "createdAt": "2020-11-20T22:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwNjQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA1NTcyMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528055723", "bodyText": "the kubectl edit command could use a little more help - provide the following snippet (substitute JRF for WLS for the JRF path):\n  configuration:\n    model:\n      configMap: sample-domain1-wdt-config-map\n      domainType: WLS\n      onlineUpdate:\n        enabled: true\n      runtimeEncryptionSecret: sample-domain1-runtime-encryption-secret", "author": "tbarnes-us", "createdAt": "2020-11-21T02:21:49Z", "path": "docs-source/content/samples/simple/domains/model-in-image/update4.md", "diffHunk": "@@ -54,6 +57,31 @@ Here are the steps:\n      - To make it obvious which ConfigMap belong to which domains.\n      - To make it easier to clean up a domain. Typical cleanup scripts use the `weblogic.domainUID` label as a convenience for finding all resources associated with a domain.\n \n+1. Update the data source secret that you created in the Update 1 use case with a correct URL, a correct password, as well as with an increased maximum pool capacity:\n+\n+   ```\n+   $ kubectl -n sample-domain1-ns delete secret sample-domain1-datasource-secret\n+   $ kubectl -n sample-domain1-ns create secret generic \\\n+      sample-domain1-datasource-secret \\\n+      --from-literal='user=sys as sysdba' \\\n+      --from-literal='password=Oradoc_db1' \\\n+      --from-literal='max-capacity=10' \\\n+      --from-literal='url=jdbc:oracle:thin:@oracle-db.default.svc.cluster.local:1521/devpdb.k8s'\n+   $ kubectl -n sample-domain1-ns label  secret \\\n+      sample-domain1-datasource-secret \\\n+      weblogic.domainUID=sample-domain1\n+   ```\n+\n+1. Optionally start the database.\n+\n+    - If the database is running, then the sample application that we will run at the end of this step will verify that your updates to the data source secret took effect.\n+\n+    - If you are taking the `JRF` path through the sample, then the database will already be running. \n+\n+    - If you are taking the `WLS` path through the sample, then you can deploy the database by:\n+      - Following the the first step in [Set up and initialize an infrastructure database]({{< relref \"/samples/simple/domains/model-in-image/prerequisites.md#set-up-and-initialize-an-infrastructure-database\" >}}). This step is titled `Ensure that you have access to the database image, and then create a deployment`.\n+      - You can skip the remaining steps (they are only needed for `JRF`).\n+", "originalCommit": "51849883c0067bc526a5f5df581834bb6e4164f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA1NTkyMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/2067#discussion_r528055922", "bodyText": "Also, the patch command should use 'true' not \"true\".", "author": "tbarnes-us", "createdAt": "2020-11-21T02:24:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA1NTcyMw=="}], "type": "inlineReview"}, {"oid": "278989b724f02de845dcfaa6d9d93f63f948b56f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/278989b724f02de845dcfaa6d9d93f63f948b56f", "message": "MII Sample Update 4 use case - Online data source updates", "committedDate": "2020-11-21T06:31:59Z", "type": "commit"}]}