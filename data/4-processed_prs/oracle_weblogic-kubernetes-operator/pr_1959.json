{"pr_number": 1959, "pr_title": "Adding test to verify image update for WLS domain ", "pr_createdAt": "2020-09-29T22:05:26Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959", "timeline": [{"oid": "22ecb6d138840766f9dd1a5a0c76e060b332d4b2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/22ecb6d138840766f9dd1a5a0c76e060b332d4b2", "message": "first cut for image update", "committedDate": "2020-09-25T16:14:52Z", "type": "commit"}, {"oid": "bb7832684069635a1452e029431b21f05c9e9ee0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bb7832684069635a1452e029431b21f05c9e9ee0", "message": "Merge remote-tracking branch 'origin/develop' into imageupdate", "committedDate": "2020-09-29T14:39:48Z", "type": "commit"}, {"oid": "a7d21a31ce6d33b232b1462d5cc87aac2e3a555c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a7d21a31ce6d33b232b1462d5cc87aac2e3a555c", "message": "minor change", "committedDate": "2020-09-29T14:53:27Z", "type": "commit"}, {"oid": "57b7bcae9eb8d6de69e895c37586579f5c3b57fd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/57b7bcae9eb8d6de69e895c37586579f5c3b57fd", "message": "refactor the code after syncing to the latest develop branch", "committedDate": "2020-09-29T16:44:00Z", "type": "commit"}, {"oid": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/53cc9efc8d0c916c3de450986e0971f3e8d5b570", "message": "edit the log message", "committedDate": "2020-09-29T16:49:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5MzU0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497093548", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Verify the admin server is accessible and cluster member is healthy\n          \n          \n            \n               * Verify the admin server is accessible and cluster members are healthy", "author": "sankarpn", "createdAt": "2020-09-29T22:19:05Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIntrospectVersion.java", "diffHunk": "@@ -848,6 +858,83 @@ public void testCreateNewCluster() {\n \n   }\n \n+  /**\n+   * Modify the domain scope property\n+   * From: \"image: container-registry.oracle.com/middleware/weblogic:12.2.1.4\" to\n+   * To: \"image: container-registry.oracle.com/middleware/weblogic:14.1.1.0-11\"\n+   * Verify all the pods are restarted and back to ready state\n+   * Verify the admin server is accessible and cluster member is healthy", "originalCommit": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1OTkzNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497659936", "bodyText": "Done", "author": "maggiehe00", "createdAt": "2020-09-30T16:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5MzU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDA5Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497094097", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertNotNull(domain1.getSpec(), domain1 + \"/spec is null\");\n          \n          \n            \n                assertNotNull(domain1.getSpec(), domain1 + \" /spec is null\");", "author": "sankarpn", "createdAt": "2020-09-29T22:20:24Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIntrospectVersion.java", "diffHunk": "@@ -848,6 +858,83 @@ public void testCreateNewCluster() {\n \n   }\n \n+  /**\n+   * Modify the domain scope property\n+   * From: \"image: container-registry.oracle.com/middleware/weblogic:12.2.1.4\" to\n+   * To: \"image: container-registry.oracle.com/middleware/weblogic:14.1.1.0-11\"\n+   * Verify all the pods are restarted and back to ready state\n+   * Verify the admin server is accessible and cluster member is healthy\n+   */\n+  @Order(5)\n+  @Test\n+  @DisplayName(\"Verify server pods are restarted by updating image name\")\n+  @Slow\n+  public void testUpdateImageName() {\n+\n+    final String domainNamespace = introDomainNamespace;\n+\n+    final String adminServerName = \"admin-server\";\n+    final String adminServerPodName = domainUid + \"-\" + adminServerName;\n+    final String managedServerNameBase = \"cl2-ms-\";\n+    String managedServerPodNamePrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+    final int replicaCount = 2;\n+\n+    List<String> managedServerNames = new ArrayList<String>();\n+    for (int i = 1; i <= replicaCount; i++) {\n+      managedServerNames.add(managedServerNameBase + i);\n+    }\n+\n+    // get the original domain resource before update\n+    Domain domain1 = assertDoesNotThrow(() -> getDomainCustomResource(domainUid, domainNamespace),\n+        String.format(\"getDomainCustomResource failed with ApiException when tried to get domain %s in namespace %s\",\n+            domainUid, domainNamespace));\n+    assertNotNull(domain1, \"Got null domain resource\");\n+    assertNotNull(domain1.getSpec(), domain1 + \"/spec is null\");", "originalCommit": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY2MDEwNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497660106", "bodyText": "Done", "author": "maggiehe00", "createdAt": "2020-09-30T16:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDQ2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497094469", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                logger.info(\"Original domain image name is: {0}\", imageName);\n          \n          \n            \n                logger.info(\"Currently used domain image name is: {0}\", imageName);", "author": "sankarpn", "createdAt": "2020-09-29T22:21:15Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIntrospectVersion.java", "diffHunk": "@@ -848,6 +858,83 @@ public void testCreateNewCluster() {\n \n   }\n \n+  /**\n+   * Modify the domain scope property\n+   * From: \"image: container-registry.oracle.com/middleware/weblogic:12.2.1.4\" to\n+   * To: \"image: container-registry.oracle.com/middleware/weblogic:14.1.1.0-11\"\n+   * Verify all the pods are restarted and back to ready state\n+   * Verify the admin server is accessible and cluster member is healthy\n+   */\n+  @Order(5)\n+  @Test\n+  @DisplayName(\"Verify server pods are restarted by updating image name\")\n+  @Slow\n+  public void testUpdateImageName() {\n+\n+    final String domainNamespace = introDomainNamespace;\n+\n+    final String adminServerName = \"admin-server\";\n+    final String adminServerPodName = domainUid + \"-\" + adminServerName;\n+    final String managedServerNameBase = \"cl2-ms-\";\n+    String managedServerPodNamePrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+    final int replicaCount = 2;\n+\n+    List<String> managedServerNames = new ArrayList<String>();\n+    for (int i = 1; i <= replicaCount; i++) {\n+      managedServerNames.add(managedServerNameBase + i);\n+    }\n+\n+    // get the original domain resource before update\n+    Domain domain1 = assertDoesNotThrow(() -> getDomainCustomResource(domainUid, domainNamespace),\n+        String.format(\"getDomainCustomResource failed with ApiException when tried to get domain %s in namespace %s\",\n+            domainUid, domainNamespace));\n+    assertNotNull(domain1, \"Got null domain resource\");\n+    assertNotNull(domain1.getSpec(), domain1 + \"/spec is null\");\n+\n+    // get the map with server pods and their original creation timestamps\n+    podsWithTimeStamps = getPodsWithTimeStamps(domainNamespace, adminServerPodName, managedServerPodNamePrefix,\n+        replicaCount);\n+\n+    //print out the original image name\n+    String imageName = domain1.getSpec().getImage();\n+    logger.info(\"Original domain image name is: {0}\", imageName);", "originalCommit": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY2MDE5OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497660199", "bodyText": "Done", "author": "maggiehe00", "createdAt": "2020-09-30T16:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDg4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497094884", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertTrue(cmPatched, \"patchDomainCustomResource(imageUpdate) failed\");\n          \n          \n            \n                assertTrue(patchDomainResource(domainUid, domainNamespace, patchStr), \"patchDomainCustomResource(imageUpdate) failed\");", "author": "sankarpn", "createdAt": "2020-09-29T22:22:25Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIntrospectVersion.java", "diffHunk": "@@ -848,6 +858,83 @@ public void testCreateNewCluster() {\n \n   }\n \n+  /**\n+   * Modify the domain scope property\n+   * From: \"image: container-registry.oracle.com/middleware/weblogic:12.2.1.4\" to\n+   * To: \"image: container-registry.oracle.com/middleware/weblogic:14.1.1.0-11\"\n+   * Verify all the pods are restarted and back to ready state\n+   * Verify the admin server is accessible and cluster member is healthy\n+   */\n+  @Order(5)\n+  @Test\n+  @DisplayName(\"Verify server pods are restarted by updating image name\")\n+  @Slow\n+  public void testUpdateImageName() {\n+\n+    final String domainNamespace = introDomainNamespace;\n+\n+    final String adminServerName = \"admin-server\";\n+    final String adminServerPodName = domainUid + \"-\" + adminServerName;\n+    final String managedServerNameBase = \"cl2-ms-\";\n+    String managedServerPodNamePrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+    final int replicaCount = 2;\n+\n+    List<String> managedServerNames = new ArrayList<String>();\n+    for (int i = 1; i <= replicaCount; i++) {\n+      managedServerNames.add(managedServerNameBase + i);\n+    }\n+\n+    // get the original domain resource before update\n+    Domain domain1 = assertDoesNotThrow(() -> getDomainCustomResource(domainUid, domainNamespace),\n+        String.format(\"getDomainCustomResource failed with ApiException when tried to get domain %s in namespace %s\",\n+            domainUid, domainNamespace));\n+    assertNotNull(domain1, \"Got null domain resource\");\n+    assertNotNull(domain1.getSpec(), domain1 + \"/spec is null\");\n+\n+    // get the map with server pods and their original creation timestamps\n+    podsWithTimeStamps = getPodsWithTimeStamps(domainNamespace, adminServerPodName, managedServerPodNamePrefix,\n+        replicaCount);\n+\n+    //print out the original image name\n+    String imageName = domain1.getSpec().getImage();\n+    logger.info(\"Original domain image name is: {0}\", imageName);\n+\n+    //change image name to imageUpdate\n+    StringBuffer patchStr = null;\n+    patchStr = new StringBuffer(\"[{\");\n+    patchStr.append(\"\\\"op\\\": \\\"replace\\\",\")\n+        .append(\" \\\"path\\\": \\\"/spec/image\\\",\")\n+        .append(\"\\\"value\\\": \\\"\")\n+        .append(imageUpdate)\n+        .append(\"\\\"}]\");\n+    logger.info(\"PatchStr for imageUpdate: {0}\", patchStr.toString());\n+\n+    boolean cmPatched = patchDomainResource(domainUid, domainNamespace, patchStr);\n+    assertTrue(cmPatched, \"patchDomainCustomResource(imageUpdate) failed\");", "originalCommit": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY2MDI3Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497660276", "bodyText": "Done", "author": "maggiehe00", "createdAt": "2020-09-30T16:53:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NTAzNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497095037", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertNotNull(domain1.getSpec(), domain1 + \"/spec is null\");\n          \n          \n            \n                assertNotNull(domain1.getSpec(), domain1 + \" /spec is null\");", "author": "sankarpn", "createdAt": "2020-09-29T22:22:49Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIntrospectVersion.java", "diffHunk": "@@ -848,6 +858,83 @@ public void testCreateNewCluster() {\n \n   }\n \n+  /**\n+   * Modify the domain scope property\n+   * From: \"image: container-registry.oracle.com/middleware/weblogic:12.2.1.4\" to\n+   * To: \"image: container-registry.oracle.com/middleware/weblogic:14.1.1.0-11\"\n+   * Verify all the pods are restarted and back to ready state\n+   * Verify the admin server is accessible and cluster member is healthy\n+   */\n+  @Order(5)\n+  @Test\n+  @DisplayName(\"Verify server pods are restarted by updating image name\")\n+  @Slow\n+  public void testUpdateImageName() {\n+\n+    final String domainNamespace = introDomainNamespace;\n+\n+    final String adminServerName = \"admin-server\";\n+    final String adminServerPodName = domainUid + \"-\" + adminServerName;\n+    final String managedServerNameBase = \"cl2-ms-\";\n+    String managedServerPodNamePrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+    final int replicaCount = 2;\n+\n+    List<String> managedServerNames = new ArrayList<String>();\n+    for (int i = 1; i <= replicaCount; i++) {\n+      managedServerNames.add(managedServerNameBase + i);\n+    }\n+\n+    // get the original domain resource before update\n+    Domain domain1 = assertDoesNotThrow(() -> getDomainCustomResource(domainUid, domainNamespace),\n+        String.format(\"getDomainCustomResource failed with ApiException when tried to get domain %s in namespace %s\",\n+            domainUid, domainNamespace));\n+    assertNotNull(domain1, \"Got null domain resource\");\n+    assertNotNull(domain1.getSpec(), domain1 + \"/spec is null\");\n+\n+    // get the map with server pods and their original creation timestamps\n+    podsWithTimeStamps = getPodsWithTimeStamps(domainNamespace, adminServerPodName, managedServerPodNamePrefix,\n+        replicaCount);\n+\n+    //print out the original image name\n+    String imageName = domain1.getSpec().getImage();\n+    logger.info(\"Original domain image name is: {0}\", imageName);\n+\n+    //change image name to imageUpdate\n+    StringBuffer patchStr = null;\n+    patchStr = new StringBuffer(\"[{\");\n+    patchStr.append(\"\\\"op\\\": \\\"replace\\\",\")\n+        .append(\" \\\"path\\\": \\\"/spec/image\\\",\")\n+        .append(\"\\\"value\\\": \\\"\")\n+        .append(imageUpdate)\n+        .append(\"\\\"}]\");\n+    logger.info(\"PatchStr for imageUpdate: {0}\", patchStr.toString());\n+\n+    boolean cmPatched = patchDomainResource(domainUid, domainNamespace, patchStr);\n+    assertTrue(cmPatched, \"patchDomainCustomResource(imageUpdate) failed\");\n+\n+    domain1 = assertDoesNotThrow(() -> getDomainCustomResource(domainUid, domainNamespace),\n+        String.format(\"getDomainCustomResource failed with ApiException when tried to get domain %s in namespace %s\",\n+            domainUid, domainNamespace));\n+    assertNotNull(domain1, \"Got null domain resource after patching\");\n+    assertNotNull(domain1.getSpec(), domain1 + \"/spec is null\");", "originalCommit": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY2MDM2Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497660367", "bodyText": "Done", "author": "maggiehe00", "createdAt": "2020-09-30T16:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NTAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDQ2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497094462", "bodyText": "Remove this tag @slow. It is not being used", "author": "anpanigr", "createdAt": "2020-09-29T22:21:15Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIntrospectVersion.java", "diffHunk": "@@ -848,6 +858,83 @@ public void testCreateNewCluster() {\n \n   }\n \n+  /**\n+   * Modify the domain scope property\n+   * From: \"image: container-registry.oracle.com/middleware/weblogic:12.2.1.4\" to\n+   * To: \"image: container-registry.oracle.com/middleware/weblogic:14.1.1.0-11\"\n+   * Verify all the pods are restarted and back to ready state\n+   * Verify the admin server is accessible and cluster member is healthy\n+   */\n+  @Order(5)\n+  @Test\n+  @DisplayName(\"Verify server pods are restarted by updating image name\")\n+  @Slow", "originalCommit": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY2MDQ0NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497660444", "bodyText": "Done", "author": "maggiehe00", "createdAt": "2020-09-30T16:54:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NDQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NTY1MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497095650", "bodyText": "Can it be moved to utility class. This is being used in many tests when we verify a domain restart.", "author": "anpanigr", "createdAt": "2020-09-29T22:24:23Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIntrospectVersion.java", "diffHunk": "@@ -944,6 +1031,26 @@ private static void verifyMemberHealth(String adminServerPodName, List<String> m\n         });\n   }\n \n+  private Map getPodsWithTimeStamps(String domainNamespace, String adminServerPodName,", "originalCommit": "53cc9efc8d0c916c3de450986e0971f3e8d5b570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY2MDUxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1959#discussion_r497660514", "bodyText": "Done", "author": "maggiehe00", "createdAt": "2020-09-30T16:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NTY1MA=="}], "type": "inlineReview"}, {"oid": "e871b162932e42b1c89a1a5142a7fc505a85aea2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e871b162932e42b1c89a1a5142a7fc505a85aea2", "message": "address the review comments", "committedDate": "2020-09-30T16:50:46Z", "type": "commit"}, {"oid": "d893b61c9008997ba0ef24122d31625db1eb7d4e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d893b61c9008997ba0ef24122d31625db1eb7d4e", "message": "remove the extra line", "committedDate": "2020-09-30T19:09:22Z", "type": "commit"}, {"oid": "07c1df74cd9770bb4b81e0174efa2f96cf84878b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/07c1df74cd9770bb4b81e0174efa2f96cf84878b", "message": "Merge remote-tracking branch 'origin/develop' into imageupdate", "committedDate": "2020-09-30T19:10:36Z", "type": "commit"}]}