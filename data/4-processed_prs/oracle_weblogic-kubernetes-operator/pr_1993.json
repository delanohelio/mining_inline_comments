{"pr_number": 1993, "pr_title": "cross domain transaction recovery", "pr_createdAt": "2020-10-15T13:16:07Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993", "timeline": [{"oid": "5693a9fb24b78c708074821bf54e4c5245520a15", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5693a9fb24b78c708074821bf54e4c5245520a15", "message": "test for crossdomaintransaction with TMAfterTLogBeforeCommitExit", "committedDate": "2020-10-13T19:30:37Z", "type": "commit"}, {"oid": "590fafe893afe45cd59400f8bca582f47106fac1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/590fafe893afe45cd59400f8bca582f47106fac1", "message": "update image name", "committedDate": "2020-10-13T19:41:37Z", "type": "commit"}, {"oid": "b62db480f7ebd564638813f519df2e0cc108606d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b62db480f7ebd564638813f519df2e0cc108606d", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into cdtfailinject", "committedDate": "2020-10-13T19:43:05Z", "type": "commit"}, {"oid": "d381b06e424c1ad10f27badbb445c710ec62c0bc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d381b06e424c1ad10f27badbb445c710ec62c0bc", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into cdtfailinject", "committedDate": "2020-10-14T13:09:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY3NDU5NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505674595", "bodyText": "You don't need to lookup the datasource again here.  Getting the connection under a global tx will cause the JDBC resource to be enlisted in the tx.", "author": "ajsomogyi", "createdAt": "2020-10-15T16:22:29Z", "path": "integration-tests/src/test/resources/apps/cdtservlet/src/application/CdtTxServlet.java", "diffHunk": "@@ -0,0 +1,249 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package application;\n+\n+import java.io.IOException;\n+import java.io.PrintWriter;\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Hashtable;\n+import javax.jms.ConnectionFactory;\n+import javax.jms.Destination;\n+import javax.jms.JMSContext;\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServlet;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.transaction.SystemException;\n+import javax.transaction.xa.Xid;\n+\n+import weblogic.transaction.Transaction;\n+import weblogic.transaction.TransactionHelper;\n+import weblogic.transaction.TransactionManager;\n+\n+import static java.lang.Thread.sleep;\n+     \n+public class CdtTxServlet extends HttpServlet {\n+  private static final long serialVersionUID = 1L;\n+  private TransactionManager tm = (TransactionManager)\n+      TransactionHelper.getTransactionHelper().getTransactionManager();\n+  PrintWriter out = null;\n+\n+  /**\n+   * Handles the HTTP <code>GET</code> method.\n+   * Servlet send a message to a local queue and a remote (different domain) DB in distributed tx\n+   *\n+   * @param request  servlet request\n+   * @param response servlet response\n+   * @throws ServletException if a servlet-specific error occurs\n+   * @throws IOException      if an I/O error occurs\n+   */\n+  protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n+    //PrintWriter out = response.getWriter();\n+    out = response.getWriter();\n+    System.out.println(\"in cdttxservlet doGet method\");\n+\n+    String nsParam = request.getParameter(\"namespaces\");\n+    if (nsParam == null) {\n+      return;\n+    }\n+    String[] namespace = nsParam.split(\",\");\n+\n+    String domain1NsParam = namespace[0];\n+    String domain2NsParam = namespace[1];\n+    System.out.println(\"in cdttxservlet doGet method - domain1NsParam = \" + domain1NsParam);\n+    System.out.println(\"in cdttxservlet doGet method - domain2NsParam = \" + domain2NsParam);\n+\n+    String domain2Url = \"t3://domain2-managed-server1.\" + domain2NsParam + \",\"\n+        + \"domain2-managed-server2.\" + domain2NsParam + \":8001\";\n+    String tableName = \"cdt_table\";\n+    java.sql.Connection conn;\n+    Destination d;\n+    Context ctx;\n+    JMSContext context;\n+\n+    try {\n+      DateFormat dateFormat = new SimpleDateFormat(\"yyyy/MM/dd HH:mm:ss\");\n+      java.util.Date date = new java.util.Date();\n+      System.out.println(\"Today Time [\" + dateFormat.format(date) + \"]\");\n+      out.println(\"Today Time [\" + dateFormat.format(date) + \"]\");\n+      out.println(\"\");\n+\n+      Hashtable h1 = new Hashtable();\n+      h1.put(Context.INITIAL_CONTEXT_FACTORY,\n+          \"weblogic.jndi.WLInitialContextFactory\");\n+      String providerUrl = \"t3://domain1-managed-server1.\" + domain1NsParam + \",\"\n+          + \"domain1-managed-server2.\" + domain1NsParam + \":8001\";\n+      System.out.println(\"BR: providerUrl = \" + providerUrl);\n+      h1.put(Context.PROVIDER_URL, providerUrl);\n+\n+      //Get the context from domain1. This is where JMS Queue is configured\n+      ctx = new InitialContext(h1);\n+      System.out.println(\"Got Local InitialContext [\" + ctx + \"]\");\n+      out.println(\"Got Local InitialContext [\" + ctx + \"]\");\n+\n+      ConnectionFactory qcf = (ConnectionFactory) ctx.lookup(\"weblogic.jms.XAConnectionFactory\");\n+      d = (Destination) ctx.lookup(\"jms/testCdtUniformQueue\");\n+      System.out.println(\"Got Local JMS Destination \" + d);\n+      out.println(\"Got Local JMS Destination \" + d);\n+      context = qcf.createContext();\n+\n+      //Get context from domain2. This is where JDBC DS is configured\n+      out.println(\"Getting Remote Context from \" + domain2Url);\n+      Hashtable h = new Hashtable();\n+      h.put(Context.INITIAL_CONTEXT_FACTORY,\n+          \"weblogic.jndi.WLInitialContextFactory\");\n+      h.put(Context.PROVIDER_URL, domain2Url);\n+\n+      Context ctx2 = new InitialContext(h);\n+      System.out.println(\"Got Remote InitialContext [\" + ctx2 + \"]\");\n+      out.println(\"Got Remote InitialContext [\" + ctx2 + \"]\");\n+\n+      javax.sql.DataSource ds = (javax.sql.DataSource) ctx2.lookup(\"jdbc/TestCdtDataSource\");\n+      System.out.println(\"Got ds from context - \" + ds);\n+      out.println(\"Got ds from context - \" + ds);\n+      conn = ds.getConnection();\n+      System.out.println(\"Got connection to datasource - \" + conn);\n+      out.println(\"Got connection to datasource - \" + conn);\n+\n+      //create a table in the DB\n+      createTable(conn, tableName);\n+\n+      try {\n+        tm.begin();\n+        Transaction tx = (Transaction) tm.getTransaction();\n+        Xid xid = tx.getXID();\n+        System.out.println(\"xid=\" + xid);\n+        tx.setProperty(\"TMAfterTLogBeforeCommitExit\", Boolean.TRUE);\n+\n+        ds = (javax.sql.DataSource) ctx2.lookup(\"jdbc/TestCdtDataSource\");", "originalCommit": "d381b06e424c1ad10f27badbb445c710ec62c0bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgyOTY4Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505829682", "bodyText": "Fixed", "author": "bhavaniravichandran", "createdAt": "2020-10-15T20:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY3NDU5NQ=="}], "type": "inlineReview"}, {"oid": "5345084be0c03a8172593de8f47ed84aebe2b0a5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5345084be0c03a8172593de8f47ed84aebe2b0a5", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into cdtfailinject", "committedDate": "2020-10-15T19:33:36Z", "type": "commit"}, {"oid": "888672d4b995449206988a69f058861768a17d08", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/888672d4b995449206988a69f058861768a17d08", "message": "update after Alex's review comment and develop", "committedDate": "2020-10-15T20:39:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4MzgwOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505883808", "bodyText": "Modify the description - Check cross domain transaction recovery works", "author": "anpanigr", "createdAt": "2020-10-15T21:49:20Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItCrossDomainTransaction.java", "diffHunk": "@@ -246,6 +303,41 @@ public void testCrossDomainTransaction() {\n \n   }\n \n+  /*\n+   * This test verifies cross domain transaction is successful and able to re-establish connection when\n+   * one domain is shutdown. domain in image using wdt is used to create 2 domains in different namespaces.\n+   * A servlet is deployed to the admin server of domain1. This servlet starts a transaction with\n+   * TMAfterTLogBeforeCommitExit transaction property set. Sends a message to a JMS queue and also inserts\n+   * data into oracleDB table. The coordinator (server in domain2) should exit before commit and the domain1\n+   * admin server should be able to establish connection with domain2 and the transaction should commit.\n+   *\n+   */\n+  @Test\n+  @DisplayName(\"Check cross domain transaction works\")", "originalCommit": "888672d4b995449206988a69f058861768a17d08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNDY4OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506534688", "bodyText": "Done", "author": "bhavaniravichandran", "createdAt": "2020-10-16T15:17:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4MzgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjA3Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505886077", "bodyText": "Here the coordinator server on domain2 is re-started to recover the transaction. Am I right ?", "author": "anpanigr", "createdAt": "2020-10-15T21:52:42Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItCrossDomainTransaction.java", "diffHunk": "@@ -246,6 +303,41 @@ public void testCrossDomainTransaction() {\n \n   }\n \n+  /*\n+   * This test verifies cross domain transaction is successful and able to re-establish connection when\n+   * one domain is shutdown. domain in image using wdt is used to create 2 domains in different namespaces.\n+   * A servlet is deployed to the admin server of domain1. This servlet starts a transaction with\n+   * TMAfterTLogBeforeCommitExit transaction property set. Sends a message to a JMS queue and also inserts\n+   * data into oracleDB table. The coordinator (server in domain2) should exit before commit and the domain1\n+   * admin server should be able to establish connection with domain2 and the transaction should commit.", "originalCommit": "888672d4b995449206988a69f058861768a17d08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5NjkyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506496928", "bodyText": "Are you asking if I am restarting the server in the test? No. The server is shutdown and restarts - no user intervention necessary.", "author": "bhavaniravichandran", "createdAt": "2020-10-16T14:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjA3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNDc5NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506534794", "bodyText": "Fixed", "author": "bhavaniravichandran", "createdAt": "2020-10-16T15:17:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjYxOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505886619", "bodyText": "domain in image using wdt is used -> Domain In Image Model with WDT is used to create", "author": "anpanigr", "createdAt": "2020-10-15T21:54:06Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItCrossDomainTransaction.java", "diffHunk": "@@ -246,6 +303,41 @@ public void testCrossDomainTransaction() {\n \n   }\n \n+  /*\n+   * This test verifies cross domain transaction is successful and able to re-establish connection when\n+   * one domain is shutdown. domain in image using wdt is used to create 2 domains in different namespaces.", "originalCommit": "888672d4b995449206988a69f058861768a17d08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5Njg3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506496872", "bodyText": "No, it is domain in image with wdt.", "author": "bhavaniravichandran", "createdAt": "2020-10-16T14:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwODc2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506508769", "bodyText": "Just change the sentence which starts with a lower case letter.", "author": "anpanigr", "createdAt": "2020-10-16T14:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNDk1OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506534958", "bodyText": "fixed", "author": "bhavaniravichandran", "createdAt": "2020-10-16T15:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODEwNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505888107", "bodyText": "Modify the description --> Check cross domain transaction recovery with istio works", "author": "anpanigr", "createdAt": "2020-10-15T21:57:48Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/ItIstioCrossDomainTransaction.java", "diffHunk": "@@ -290,6 +346,38 @@ public void testIstioCrossDomainTransaction() {\n \n   }\n \n+  /*\n+   * This test verifies cross domain transaction with Istio is successful and able to re-establish connection when\n+   * one domain is shutdown. domain in image using wdt is used to create 2 domains in different namespaces.\n+   * A servlet is deployed to the admin server of domain1. This servlet starts a transaction with\n+   * TMAfterTLogBeforeCommitExit transaction property set. Sends a message to a JMS queue and also inserts\n+   * data into oracleDB table. The coordinator (server in domain2) should exit before commit and the domain1\n+   * admin server should be able to establish connection with domain2 and the transaction should commit.\n+   */\n+\n+  @Test\n+  @Order(2)\n+  @DisplayName(\"Check cross domain transaction works\")", "originalCommit": "888672d4b995449206988a69f058861768a17d08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODU2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505888560", "bodyText": "remove commented code", "author": "anpanigr", "createdAt": "2020-10-15T21:59:00Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/CommonTestUtils.java", "diffHunk": "@@ -1740,21 +1740,21 @@ public static String createMiiImageAndVerify(String miiImageNameBase,\n    * is needed to be updated with a property that has been created by the framework, it is copied\n    * onto RESULT_ROOT and updated. Hence the altModelDir. Call this method to create a domain home in image.\n    * @param imageNameBase - base image name used in local or to construct image name in repository\n-   * @param wdtModelFile - model file used to build the image\n-   * @param appName - application to be added to the image\n+   * @param wdtModelList - model file used to build the image\n+   * @param appSrcDirList - application to be added to the image\n    * @param modelPropFile - property file to be used with the model file above\n    * @param altModelDir - directory where the property file is found if not in the default MODEL_DIR\n    * @return image name with tag\n    */\n   public static String createImageAndVerify(String imageNameBase,\n-                                            String wdtModelFile,\n-                                            String appName,\n+                                            List<String> wdtModelList,\n+                                            List<String> appSrcDirList,\n                                             String modelPropFile,\n                                             String altModelDir,\n                                             String domainHome) {\n \n-    final List<String> wdtModelList = Collections.singletonList(MODEL_DIR + \"/\" + wdtModelFile);\n-    final List<String> appSrcDirList = Collections.singletonList(appName);\n+    //final List<String> wdtModelList = Collections.singletonList(MODEL_DIR + \"/\" + wdtModelFile);", "originalCommit": "888672d4b995449206988a69f058861768a17d08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNTAyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506535024", "bodyText": "done", "author": "bhavaniravichandran", "createdAt": "2020-10-16T15:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5MjIxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505892214", "bodyText": "remove commented code", "author": "anpanigr", "createdAt": "2020-10-15T22:08:25Z", "path": "integration-tests/src/test/resources/wdt-models/model-cdt-jdbc.yaml", "diffHunk": "@@ -0,0 +1,26 @@\n+# Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+resources:\n+  JDBCSystemResource:\n+    TestCdtDataSource:\n+      Target: 'cluster-1'\n+      JdbcResource:\n+        JDBCConnectionPoolParams:\n+          InitialCapacity: 0\n+          MinCapacity: 0\n+          MaxCapacity: 15\n+          TestTableName: SQL SELECT 1\n+        JDBCDataSourceParams:\n+          GlobalTransactionsProtocol: TwoPhaseCommit\n+          #GlobalTransactionsProtocol: LoggingLastResource\n+          RowPrefetchSize: 200\n+          JNDIName: jdbc/TestCdtDataSource\n+        JDBCDriverParams:\n+          URL: 'jdbc:oracle:thin:@//@@PROP:K8S_NODEPORT_HOST@@:@@PROP:DBPORT@@/devpdb.k8s'\n+          PasswordEncrypted: 'Oradoc_db1'\n+          #DriverName: com.mysql.cj.jdbc.MysqlXADataSource", "originalCommit": "888672d4b995449206988a69f058861768a17d08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNTEyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506535124", "bodyText": "done", "author": "bhavaniravichandran", "createdAt": "2020-10-16T15:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5MjIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5NDAwOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r505894009", "bodyText": "Check the message  body , to see if the body contains the same message string.", "author": "anpanigr", "createdAt": "2020-10-15T22:13:07Z", "path": "integration-tests/src/test/resources/apps/cdtservlet/src/application/CdtTxServlet.java", "diffHunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package application;\n+\n+import java.io.IOException;\n+import java.io.PrintWriter;\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Hashtable;\n+import javax.jms.ConnectionFactory;\n+import javax.jms.Destination;\n+import javax.jms.JMSContext;\n+import javax.naming.Context;\n+import javax.naming.InitialContext;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServlet;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.transaction.SystemException;\n+import javax.transaction.xa.Xid;\n+\n+import weblogic.transaction.Transaction;\n+import weblogic.transaction.TransactionHelper;\n+import weblogic.transaction.TransactionManager;\n+\n+import static java.lang.Thread.sleep;\n+     \n+public class CdtTxServlet extends HttpServlet {\n+  private static final long serialVersionUID = 1L;\n+  private TransactionManager tm = (TransactionManager)\n+      TransactionHelper.getTransactionHelper().getTransactionManager();\n+  PrintWriter out = null;\n+\n+  /**\n+   * Handles the HTTP <code>GET</code> method.\n+   * Servlet send a message to a local queue and a remote (different domain) DB in distributed tx\n+   *\n+   * @param request  servlet request\n+   * @param response servlet response\n+   * @throws ServletException if a servlet-specific error occurs\n+   * @throws IOException      if an I/O error occurs\n+   */\n+  protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n+    //PrintWriter out = response.getWriter();\n+    out = response.getWriter();\n+    System.out.println(\"in cdttxservlet doGet method\");\n+\n+    String nsParam = request.getParameter(\"namespaces\");\n+    if (nsParam == null) {\n+      return;\n+    }\n+    String[] namespace = nsParam.split(\",\");\n+\n+    String domain1NsParam = namespace[0];\n+    String domain2NsParam = namespace[1];\n+    System.out.println(\"in cdttxservlet doGet method - domain1NsParam = \" + domain1NsParam);\n+    System.out.println(\"in cdttxservlet doGet method - domain2NsParam = \" + domain2NsParam);\n+\n+    String domain2Url = \"t3://domain2-managed-server1.\" + domain2NsParam + \",\"\n+        + \"domain2-managed-server2.\" + domain2NsParam + \":8001\";\n+    String tableName = \"cdt_table\";\n+    java.sql.Connection conn;\n+    Destination d;\n+    Context ctx;\n+    JMSContext context;\n+\n+    try {\n+      DateFormat dateFormat = new SimpleDateFormat(\"yyyy/MM/dd HH:mm:ss\");\n+      java.util.Date date = new java.util.Date();\n+      System.out.println(\"Today Time [\" + dateFormat.format(date) + \"]\");\n+      out.println(\"Today Time [\" + dateFormat.format(date) + \"]\");\n+      out.println(\"\");\n+\n+      Hashtable h1 = new Hashtable();\n+      h1.put(Context.INITIAL_CONTEXT_FACTORY,\n+          \"weblogic.jndi.WLInitialContextFactory\");\n+      String providerUrl = \"t3://domain1-managed-server1.\" + domain1NsParam + \",\"\n+          + \"domain1-managed-server2.\" + domain1NsParam + \":8001\";\n+      System.out.println(\"BR: providerUrl = \" + providerUrl);\n+      h1.put(Context.PROVIDER_URL, providerUrl);\n+\n+      //Get the context from domain1. This is where JMS Queue is configured\n+      ctx = new InitialContext(h1);\n+      System.out.println(\"Got Local InitialContext [\" + ctx + \"]\");\n+      out.println(\"Got Local InitialContext [\" + ctx + \"]\");\n+\n+      ConnectionFactory qcf = (ConnectionFactory) ctx.lookup(\"weblogic.jms.XAConnectionFactory\");\n+      d = (Destination) ctx.lookup(\"jms/testCdtUniformQueue\");\n+      System.out.println(\"Got Local JMS Destination \" + d);\n+      out.println(\"Got Local JMS Destination \" + d);\n+      context = qcf.createContext();\n+\n+      //Get context from domain2. This is where JDBC DS is configured\n+      out.println(\"Getting Remote Context from \" + domain2Url);\n+      Hashtable h = new Hashtable();\n+      h.put(Context.INITIAL_CONTEXT_FACTORY,\n+          \"weblogic.jndi.WLInitialContextFactory\");\n+      h.put(Context.PROVIDER_URL, domain2Url);\n+\n+      Context ctx2 = new InitialContext(h);\n+      System.out.println(\"Got Remote InitialContext [\" + ctx2 + \"]\");\n+      out.println(\"Got Remote InitialContext [\" + ctx2 + \"]\");\n+\n+      javax.sql.DataSource ds = (javax.sql.DataSource) ctx2.lookup(\"jdbc/TestCdtDataSource\");\n+      System.out.println(\"Got ds from context - \" + ds);\n+      out.println(\"Got ds from context - \" + ds);\n+      conn = ds.getConnection();\n+      System.out.println(\"Got connection to datasource - \" + conn);\n+      out.println(\"Got connection to datasource - \" + conn);\n+\n+      //create a table in the DB\n+      createTable(conn, tableName);\n+\n+      try {\n+        tm.begin();\n+        Transaction tx = (Transaction) tm.getTransaction();\n+        Xid xid = tx.getXID();\n+        System.out.println(\"xid=\" + xid);\n+        tx.setProperty(\"TMAfterTLogBeforeCommitExit\", Boolean.TRUE);\n+        \n+        Connection conn1 = ds.getConnection();\n+        System.out.println(\"Got connection to datasource - \" + conn1);\n+        out.println(\"Got connection to datasource - \" + conn1);\n+        insertData(conn1, tableName);\n+        System.out.println(\"CdTXServlet: Inserted data\");\n+        out.println(\"CdTXServlet: Inserted data\");\n+        context.createProducer().send(d, \"(D1) A Transcated JMS Message\");\n+        System.out.println(\"CdTXServlet: sent message to jms queue\");\n+        out.println(\"CdTXServlet: sent message to jms queue\");\n+\n+        System.out.println(\"tx.toString() = \" + tx.toString());\n+        out.println(\"tx.toString() = \" + tx.toString());\n+\n+        tm.commit();\n+      } catch (SystemException se) {\n+        if (!(se.toString().contains(\"weblogic.rjvm.PeerGoneException\"))) {\n+          throw se;\n+        }\n+        System.out.println(\"CdTXServlet: Got PeerGoneException \" + se);\n+        out.println(\"CdTXServlet:Exception got - \" + se.toString());\n+        out.println(\"CdTXServlet: got PeerGoneException as expected\");\n+      }\n+\n+      out.println(\"Message Delivered in Distributed Transcation\");\n+\n+      sleep(30);\n+\n+      String body = context.createConsumer(d).receiveBody(String.class);", "originalCommit": "888672d4b995449206988a69f058861768a17d08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNTM4Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1993#discussion_r506535382", "bodyText": "fixed.", "author": "bhavaniravichandran", "createdAt": "2020-10-16T15:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5NDAwOQ=="}], "type": "inlineReview"}, {"oid": "392c61935ab15e7309052890bf858a059c18437d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/392c61935ab15e7309052890bf858a059c18437d", "message": "update after review comments", "committedDate": "2020-10-16T15:15:25Z", "type": "commit"}, {"oid": "d472003a08bcaeb3b718587ee9f52499881c694e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d472003a08bcaeb3b718587ee9f52499881c694e", "message": "fix checkstyle violation", "committedDate": "2020-10-16T18:12:59Z", "type": "commit"}, {"oid": "5014d3e4992df33116448ea0af84ce5888b921c2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5014d3e4992df33116448ea0af84ce5888b921c2", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into cdtfailinject", "committedDate": "2020-10-16T18:13:51Z", "type": "commit"}]}