{"pr_number": 1832, "pr_title": "Changes for OWLS-82011 to reflect introspector status in domain status", "pr_createdAt": "2020-07-23T22:05:29Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832", "timeline": [{"oid": "824ed804fca6987eb4d8f681ef4f154862024b65", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/824ed804fca6987eb4d8f681ef4f154862024b65", "message": "Changes for OWLS-82011 to reflect introspector status in domain status", "committedDate": "2020-07-23T21:47:00Z", "type": "commit"}, {"oid": "16da37b2048e8fdcb6581d49cbe6e618c215d9c1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/16da37b2048e8fdcb6581d49cbe6e618c215d9c1", "message": "change method name", "committedDate": "2020-07-23T22:01:28Z", "type": "commit"}, {"oid": "aa56cae469d971dede5c1063dbcac706b635ac69", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/aa56cae469d971dede5c1063dbcac706b635ac69", "message": "Code refactoring", "committedDate": "2020-07-24T03:25:58Z", "type": "commit"}, {"oid": "e5ead73b926b9ea825d2b3c77631afefac9d27fc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e5ead73b926b9ea825d2b3c77631afefac9d27fc", "message": "cleanup debug message", "committedDate": "2020-07-24T03:35:17Z", "type": "commit"}, {"oid": "53169c5b6a177556408073f0246c58b96ea60bc8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/53169c5b6a177556408073f0246c58b96ea60bc8", "message": "Remove unused method", "committedDate": "2020-07-24T03:42:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwMjYzNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r460102635", "bodyText": "What do these statuses indicate? I'd have thought that once you selected a status, that indicated what had to be updated in the domain status - and yet this seems to do a fair bit of additional processing. Can you explain your approach?", "author": "russgold", "createdAt": "2020-07-24T14:51:37Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -974,42 +980,86 @@ public NextAction apply(Packet packet) {\n   }\n \n   private static class DomainStatusUpdate {\n-    private final Domain domain;\n     private final V1Pod pod;\n     private final String domainUid;\n+    private DomainProcessorDelegate delegate = null;\n+    private DomainPresenceInfo info = null;\n+    private PodWatcher.PodStatus podStatus;\n \n-    DomainStatusUpdate(Domain domain, V1Pod pod, String domainUid) {\n-      this.domain = domain;\n+    DomainStatusUpdate(V1Pod pod, String domainUid, DomainProcessorDelegate delegate,\n+                       DomainPresenceInfo info, PodWatcher.PodStatus podStatus) {\n       this.pod = pod;\n       this.domainUid = domainUid;\n+      this.delegate = delegate;\n+      this.info = info;\n+      this.podStatus = podStatus;\n     }\n \n-    public void invoke() {\n-      Optional.ofNullable(getMatchingContainerStatus())\n-            .map(V1ContainerStatus::getState)\n-            .map(V1ContainerState::getWaiting)\n-            .ifPresent(waiting -> updateStatus(waiting.getReason(), waiting.getMessage()));\n-    }\n-\n-    private void updateStatus(String reason, String message) {\n-      if (reason == null || message == null) {\n-        return;\n+    private void invoke() {\n+      switch (podStatus) {\n+        case PHASE_FAILED:", "originalCommit": "53169c5b6a177556408073f0246c58b96ea60bc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEyNjA4Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r460126082", "bodyText": "Unfortunately Kubernetes seem to have different way of dealing with various failures and reason/message for failure is captured in different json stanza/object.\n\n\nThe UNSCHEDULABLE status indicates that pod can't be scheduled and is in pending state (for e.g. due to missing pv/c). The reason/message for this condition is captured in pod conditions which is part of pod status.\n\n\nThe WAITING_NON_NULL_MESSAGE indicates that pod container is stuck in waiting state (for e.g. to due to image pull error). The reason/message for this is captured in waiting state object in container statuses which is part of pod status.\n\n\nThe PHASE_FAILED status indicates that pod has failed due to timeout (Deadline exceeded). In this case both conditions and container statuses in pod status are null (pls see below). The pod status phase is \"Failed\" and reason/message is captured directly as part of pod status.\nV1PodStatus:\n{\nconditions: null\ncontainerStatuses: [class V1ContainerStatus {\ncontainerID: docker://b823ffd3fe05d101b22529485ce9d946b652631487e8ce82e94f2e8ec1c2acb0\nimage: model-in-image-1:v1\nimageID: docker://sha256:1cb49428989aec3007cd887d5b31cbf8da6fa0da30998e03d2ebec29ed4bf5ec\nlastState: class V1ContainerState {\nrunning: null\nterminated: null\nwaiting: null\n}\nname: domain1-introspect-domain-job\nready: false\nrestartCount: 0\nstarted: null\nstate: class V1ContainerState {\nrunning: class V1ContainerStateRunning {\nstartedAt: 2020-07-23T23:07:08.000Z\n}\nterminated: null\nwaiting: null\n}\n}]\nephemeralContainerStatuses: null\nhostIP: null\ninitContainerStatuses: null\nmessage: Pod was active on the node longer than the specified deadline\nnominatedNodeName: null\nphase: Failed\npodIP: 192.168.4.110\npodIPs: null\nqosClass: Burstable\nreason: DeadlineExceeded\nstartTime: 2020-07-23T23:07:07.000Z\n}\n\n\nThere are other cases where pod/container is terminated due to error and reason/message is captured in terminated state in container statuses which is part of pod status. This is indicated by TERMINATED_ERROR_REASON.\n\n\nEarlier logic was updating domain status unconditionally with reason/message from waiting state of container statuses which is part of pod status after receiving pod added/modified watch event.\nAdditionally, there's job watcher and pod watcher and both of them update domain status. We might have to decide which one gets higher priority or if we can update domain status only in pod watcher based on additional testing and results of integration tests.", "author": "ankedia", "createdAt": "2020-07-24T15:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwMjYzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNDI1OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r461114259", "bodyText": "I was hoping for a simple way to make this more readable, but I don't see one that is obvious. I may want to revisit in the future.", "author": "russgold", "createdAt": "2020-07-27T19:20:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwMjYzNQ=="}], "type": "inlineReview"}, {"oid": "da40befb32a253fd195ebaa9ff4acdd636298501", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/da40befb32a253fd195ebaa9ff4acdd636298501", "message": "Added check to terminate fiber when intro job fails with BackoffLimitExceeded (which happens when intro job times out due to DeadlineExceeded).", "committedDate": "2020-07-24T23:04:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNTUzNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r461115534", "bodyText": "Is there some reason not to create this progressing state in the bringManagedServersUp method?", "author": "russgold", "createdAt": "2020-07-27T19:22:52Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -784,12 +787,15 @@ public void onThrowable(Packet packet, Throwable throwable) {\n \n   Step createDomainUpPlan(DomainPresenceInfo info) {\n     Step managedServerStrategy =\n-        bringManagedServersUp(DomainStatusUpdater.createEndProgressingStep(new TailStep()));\n+        Step.chain(\n+            DomainStatusUpdater.createProgressingStep(MANAGED_SERVERS_STARTING_PROGRESS_REASON, true, null),", "originalCommit": "da40befb32a253fd195ebaa9ff4acdd636298501", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1NTQxMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r461155412", "bodyText": "There is no particular reason. I will make the change to create progressing state in bringManagedServersUp like this. Thanks.\n  private static Step bringManagedServersUp(Step next) {\n    return DomainStatusUpdater.createProgressingStep(MANAGED_SERVERS_STARTING_PROGRESS_REASON, true,\n            new ManagedServersUpStep(next));\n  }", "author": "ankedia", "createdAt": "2020-07-27T20:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNTUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNTkyNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r461115925", "bodyText": "This branch creates the FailedStep. Where is it being run?", "author": "russgold", "createdAt": "2020-07-27T19:23:42Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -974,42 +980,86 @@ public NextAction apply(Packet packet) {\n   }\n \n   private static class DomainStatusUpdate {\n-    private final Domain domain;\n     private final V1Pod pod;\n     private final String domainUid;\n+    private DomainProcessorDelegate delegate = null;\n+    private DomainPresenceInfo info = null;\n+    private PodWatcher.PodStatus podStatus;\n \n-    DomainStatusUpdate(Domain domain, V1Pod pod, String domainUid) {\n-      this.domain = domain;\n+    DomainStatusUpdate(V1Pod pod, String domainUid, DomainProcessorDelegate delegate,\n+                       DomainPresenceInfo info, PodWatcher.PodStatus podStatus) {\n       this.pod = pod;\n       this.domainUid = domainUid;\n+      this.delegate = delegate;\n+      this.info = info;\n+      this.podStatus = podStatus;\n     }\n \n-    public void invoke() {\n-      Optional.ofNullable(getMatchingContainerStatus())\n-            .map(V1ContainerStatus::getState)\n-            .map(V1ContainerState::getWaiting)\n-            .ifPresent(waiting -> updateStatus(waiting.getReason(), waiting.getMessage()));\n-    }\n-\n-    private void updateStatus(String reason, String message) {\n-      if (reason == null || message == null) {\n-        return;\n+    private void invoke() {\n+      switch (podStatus) {\n+        case PHASE_FAILED:\n+          DomainStatusUpdater.createFailedStep(", "originalCommit": "da40befb32a253fd195ebaa9ff4acdd636298501", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1NTU4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r461155584", "bodyText": "Thanks for catching this, I meant to run it with \"delegate.runSteps\" and missed it. I will change it like this =>\n          delegate.runSteps(\n                  DomainStatusUpdater.createFailedStep(\n                          info, pod.getStatus().getReason(), pod.getStatus().getMessage(), null));", "author": "ankedia", "createdAt": "2020-07-27T20:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNTkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzMTUwNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r461531506", "bodyText": "That suggests that you are missing a unit test. If you had the test, it would have caught it.", "author": "russgold", "createdAt": "2020-07-28T12:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNTkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU1MzI2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1832#discussion_r461553260", "bodyText": "Added unit test IntrospectionStatusTest.whenIntrospectorJobPodPhaseFailed_patchDomain() to cover this. Thanks.", "author": "ankedia", "createdAt": "2020-07-28T12:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNTkyNQ=="}], "type": "inlineReview"}, {"oid": "3c2a486e3fda7b218b43ee97ff146d8a27dc5ef9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3c2a486e3fda7b218b43ee97ff146d8a27dc5ef9", "message": "implement review comment suggestions", "committedDate": "2020-07-27T21:34:01Z", "type": "commit"}, {"oid": "e36ed1de633ac306c91abf3a431ebca20e2a6195", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e36ed1de633ac306c91abf3a431ebca20e2a6195", "message": "added unit test for introspector pod phase failed", "committedDate": "2020-07-28T12:47:48Z", "type": "commit"}]}