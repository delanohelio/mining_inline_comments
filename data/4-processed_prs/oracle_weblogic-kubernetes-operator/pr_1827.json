{"pr_number": 1827, "pr_title": "Mirror introspector log to a rotating file in 'log home' (if configured)", "pr_createdAt": "2020-07-20T22:54:34Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827", "timeline": [{"oid": "d5f53b31f6783d714cd310db7d4178abf78d9bd1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d5f53b31f6783d714cd310db7d4178abf78d9bd1", "message": "Mirror introspector log to a rotating file in 'log home' (if configured)", "committedDate": "2020-07-20T22:51:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczNzU0MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r457737541", "bodyText": "Implementation note: MAX_INTROSPECTOR_LOG_FILES is internal for now - there are no plans to document this env var.  Default is 10.", "author": "tbarnes-us", "createdAt": "2020-07-20T22:56:23Z", "path": "operator/src/main/resources/scripts/introspectDomain.sh", "diffHunk": "@@ -61,21 +68,68 @@ function createFolder {\n   fi\n }\n \n-trace \"Introspecting the domain\"\n+#\n+# setup MII functions in case this is a MII domain\n+#\n+\n+source ${SCRIPTPATH}/modelInImage.sh\n+[ $? -ne 0 ] && trace SEVERE \"Error sourcing ${SCRIPTPATH}/modelInImage.sh\" && exit 1\n+\n+#\n+# setup introspector log file\n+#\n+\n+traceDirs before LOG_HOME\n+\n+if [ ! -z \"${LOG_HOME}\" ] && [ ! -d \"${LOG_HOME}\" ]; then\n+  trace \"Creating log home directory: '${LOG_HOME}'\"\n+  createFolder ${LOG_HOME}\n+fi\n+\n+ilog_dir=\"${LOG_HOME:-/tmp}\"\n+ilog_timestamp=\"$(date --utc '+%Y-%m-%d_%H.%M.%S')\"\n+ilog_prefix=\"${ilog_dir}/introspector_script\"\n+ilog_file=\"${ilog_prefix}_${ilog_timestamp}_.out\"\n+ilog_max=${MAX_INTROSPECTOR_LOG_FILES:-10}\n+", "originalCommit": "d5f53b31f6783d714cd310db7d4178abf78d9bd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczODAxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r457738010", "bodyText": "Implementation note: There are no plans to document INTROSPECTOR_LOG_FILE_MODE - default is 'tee'.", "author": "tbarnes-us", "createdAt": "2020-07-20T22:57:49Z", "path": "operator/src/main/resources/scripts/introspectDomain.sh", "diffHunk": "@@ -142,58 +189,78 @@ if [ ${DOMAIN_SOURCE_TYPE} == \"FromModel\" ]; then\n     createWLDomain || exit 1\n     created_domain=$DOMAIN_CREATED\n     trace \"Create domain return code = \" ${created_domain}\n-else\n+  else\n     created_domain=1\n-fi\n-\n-traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII CREATE DOMAIN END\" \n-\n+  fi\n \n-# check DOMAIN_HOME for a config/config.xml, reset DOMAIN_HOME if needed\n+  traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII CREATE DOMAIN END\" \n \n-exportEffectiveDomainHome || exit 1\n+  # check DOMAIN_HOME for a config/config.xml, reset DOMAIN_HOME if needed\n \n-# list potentially interesting env-vars and dirs after they're updated by export.*Homes\n+  exportEffectiveDomainHome || exit 1\n \n-traceEnv after\n-traceDirs after\n+  # list potentially interesting env-vars and dirs after they're updated by export.*Homes\n \n-# check if we're using a supported WebLogic version\n-# (the check  will log a message if it fails)\n+  traceEnv after\n+  traceDirs after DOMAIN_HOME DATA_HOME\n \n-checkWebLogicVersion || exit 1\n+  # check if we're using a supported WebLogic version\n+  # (the check  will log a message if it fails)\n \n-# start node manager\n-# run instrospector wlst script\n-if [ ${created_domain} -ne 0 ]; then\n+  checkWebLogicVersion || exit 1\n \n+  # start node manager\n+  # run instrospector wlst script\n+  if [ ${created_domain} -ne 0 ]; then\n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII NM START\" \n \n-    # start node manager -why ??\n+    # introspectDomain.py uses an NM to setup credentials for the server NMs\n+    #  (see 'nmConnect' in introspectDomain.py)\n     trace \"Starting node manager\"\n     ${SCRIPTPATH}/startNodeManager.sh || exit 1\n \n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII NM END\" \n-\n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII MD5 START\"\n-\n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII NM END\" \n-\n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII MD5 START\"\n \n     # put domain secret's md5 cksum in file '/tmp/DomainSecret.md5'\n     # the introspector wlst script and WL server pods will use this value\n     generateDomainSecretMD5File '/tmp/DomainSecret.md5' || exit 1\n \n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' MII MD5 END\"\n-\n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' INTROSPECT START\"\n \n     trace \"Running introspector WLST script ${SCRIPTPATH}/introspectDomain.py\"\n     ${SCRIPTPATH}/wlst.sh ${SCRIPTPATH}/introspectDomain.py || exit 1\n \n     traceTiming \"INTROSPECTOR '${DOMAIN_UID}' INTROSPECT END\"\n-fi\n-trace \"Domain introspection complete\"\n+  fi\n+  trace \"Domain introspection complete\"\n+}\n \n-exit 0\n+# we have different log file modes in case we need to revert 'tee' mode\n+\n+case \"${INTROSPECTOR_LOG_FILE_MODE:-tee}\" in", "originalCommit": "d5f53b31f6783d714cd310db7d4178abf78d9bd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4318ef0a31f921ef6c3ce6e73372a4c47bada40f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4318ef0a31f921ef6c3ce6e73372a4c47bada40f", "message": "minor fix", "committedDate": "2020-07-20T22:59:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0NjkwNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r457746906", "bodyText": "Implementation note:  When the introspector java parses out a SEVERE it includes everything after the SEVERE up to the next trace statement.  (So the 'cat' above is included in the SEVERE just before it.)", "author": "tbarnes-us", "createdAt": "2020-07-20T23:25:29Z", "path": "operator/src/main/resources/scripts/modelInImage.sh", "diffHunk": "@@ -532,8 +532,8 @@ function diff_model() {\n     org.python.util.jython \\\n     ${SCRIPTPATH}/model_diff.py $1 $2 > ${WDT_OUTPUT} 2>&1\n   if [ $? -ne 0 ] ; then\n-    trace SEVERE \"Failed to compare models. Check logs for error.\"\n-    trace SEVERE \"$(cat ${WDT_OUTPUT})\"\n+    trace SEVERE \"Failed to compare models. Check logs for error. Comparison output:\"\n+    cat ${WDT_OUTPUT}", "originalCommit": "4318ef0a31f921ef6c3ce6e73372a4c47bada40f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0NzM1OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r457747358", "bodyText": "Implementation note: we no longer need to check if LOG_HOME is set and/or do the 'cp' because the calling script is now logging the entire output of this script.", "author": "tbarnes-us", "createdAt": "2020-07-20T23:26:50Z", "path": "operator/src/main/resources/scripts/modelInImage.sh", "diffHunk": "@@ -648,11 +648,8 @@ function generateMergedModel() {\n     ${archive_list} ${variable_list}  -domain_type ${WDT_DOMAIN_TYPE}  > ${WDT_OUTPUT}\n   ret=$?\n   if [ $ret -ne 0 ]; then\n-    trace SEVERE \"WDT Failed: Validate Model Failed \"\n-    if [ -d ${LOG_HOME} ] && [ ! -z ${LOG_HOME} ] ; then\n-      cp  ${WDT_OUTPUT} ${LOG_HOME}/introspectJob_validateDomain.log\n-    fi\n-    trace SEVERE \"$(cat ${WDT_OUTPUT})\"\n+    trace SEVERE \"WDT Failed: Validate Model Failed:\"\n+    cat ${WDT_OUTPUT}", "originalCommit": "4318ef0a31f921ef6c3ce6e73372a4c47bada40f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bafd971a22911b889614b0dc85f4137ef92d7668", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bafd971a22911b889614b0dc85f4137ef92d7668", "message": "remove comment", "committedDate": "2020-07-20T23:28:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1Nzg5NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r458257895", "bodyText": "Is it the intention for the introspector logs to end with '_' before .out?", "author": "lennyphan", "createdAt": "2020-07-21T17:12:25Z", "path": "operator/src/main/resources/scripts/introspectDomain.sh", "diffHunk": "@@ -61,21 +68,68 @@ function createFolder {\n   fi\n }\n \n-trace \"Introspecting the domain\"\n+#\n+# setup MII functions in case this is a MII domain\n+#\n+\n+source ${SCRIPTPATH}/modelInImage.sh\n+[ $? -ne 0 ] && trace SEVERE \"Error sourcing ${SCRIPTPATH}/modelInImage.sh\" && exit 1\n+\n+#\n+# setup introspector log file\n+#\n+\n+traceDirs before LOG_HOME\n+\n+if [ ! -z \"${LOG_HOME}\" ] && [ ! -d \"${LOG_HOME}\" ]; then\n+  trace \"Creating log home directory: '${LOG_HOME}'\"\n+  createFolder ${LOG_HOME}\n+fi\n+\n+ilog_dir=\"${LOG_HOME:-/tmp}\"\n+ilog_timestamp=\"$(date --utc '+%Y-%m-%d_%H.%M.%S')\"\n+ilog_prefix=\"${ilog_dir}/introspector_script\"\n+ilog_file=\"${ilog_prefix}_${ilog_timestamp}_.out\"", "originalCommit": "bafd971a22911b889614b0dc85f4137ef92d7668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMwMTAxNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r458301014", "bodyText": "Yes - I found it made the generated file name more readable.", "author": "tbarnes-us", "createdAt": "2020-07-21T18:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1Nzg5NQ=="}], "type": "inlineReview"}, {"oid": "0ed4ce541e20821886f8133741253a7d5ad4f5ce", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0ed4ce541e20821886f8133741253a7d5ad4f5ce", "message": "doc that logHome includes introspector out", "committedDate": "2020-07-21T18:22:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMwMzgyMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r458303823", "bodyText": "introspector -> introspector out?", "author": "alai8", "createdAt": "2020-07-21T18:28:52Z", "path": "docs-source/content/samples/simple/domains/domain-home-in-image/_index.md", "diffHunk": "@@ -210,7 +210,7 @@ spec:\n   includeServerOutInPodLog: true\n   # Whether to enable log home\n   # logHomeEnabled: false\n-  # The in-pod location for domain log, server logs, server out, and Node Manager log files\n+  # The in-pod location for domain log, server logs, server out, introspector, and Node Manager log files", "originalCommit": "0ed4ce541e20821886f8133741253a7d5ad4f5ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNDc2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r458324763", "bodyText": "missed this one on line 213.", "author": "lennyphan", "createdAt": "2020-07-21T19:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMwMzgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1NjE3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r458356172", "bodyText": "fixed", "author": "tbarnes-us", "createdAt": "2020-07-21T20:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMwMzgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNjk2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r458326963", "bodyText": ".out?", "author": "lennyphan", "createdAt": "2020-07-21T19:10:13Z", "path": "kubernetes/hands-on-lab/domain.yaml", "diffHunk": "@@ -47,8 +47,8 @@ spec:\n   # If you want to use a mounted volume as the log home, i.e. to persist logs outside the container, then\n   # uncomment this and set it to `true`:\n   # logHomeEnabled: false\n-  # The in-pod name of the directory to store the domain, node manager, server logs, and server .out\n-  # files in.\n+  # The in-pod name of the directory to store the domain, node manager, server logs, server .out,\n+  # and introspector out files in.", "originalCommit": "0ed4ce541e20821886f8133741253a7d5ad4f5ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1NjQ3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1827#discussion_r458356479", "bodyText": "fixed", "author": "tbarnes-us", "createdAt": "2020-07-21T20:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNjk2Mw=="}], "type": "inlineReview"}, {"oid": "8a096fb642e414d5f066d8c593b057b3d5214a36", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8a096fb642e414d5f066d8c593b057b3d5214a36", "message": "minor doc update", "committedDate": "2020-07-21T19:58:49Z", "type": "commit"}, {"oid": "a7fc7cbc18fe0580f639551cb6db958bccb088b5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a7fc7cbc18fe0580f639551cb6db958bccb088b5", "message": "minor doc update", "committedDate": "2020-07-21T20:03:48Z", "type": "commit"}]}