{"pr_number": 1764, "pr_title": "Owls 82147", "pr_createdAt": "2020-06-24T20:41:09Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764", "timeline": [{"oid": "30c576940742eb07bd324b3bb05b114ea2d8a8c2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/30c576940742eb07bd324b3bb05b114ea2d8a8c2", "message": "Detect env var change during MII re-instrospect (MD5 check).", "committedDate": "2020-06-24T20:34:23Z", "type": "commit"}, {"oid": "3858434834cef7fceaf855dc8a9f6a783d87aa03", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3858434834cef7fceaf855dc8a9f6a783d87aa03", "message": "Merge remote-tracking branch 'origin/owls_82785' into owls_82785-owls_82147", "committedDate": "2020-06-24T20:36:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIxODg1Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445218857", "bodyText": "Is the name of the environment variable alone sufficient, no need to have the value?", "author": "jshum2479", "createdAt": "2020-06-24T23:05:37Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/JobHelper.java", "diffHunk": "@@ -294,6 +294,16 @@ private String getAsServiceName() {\n         addEnvVar(vars, ServerEnvVars.DATA_HOME, dataHome);\n       }\n \n+      // Populate env var list used by the MII introspector job's 'short circuit' MD5\n+      // check. To prevent a false trip of the circuit breaker, the list must be the\n+      // same regardless of whether domainTopology == null.\n+      StringBuffer sb = new StringBuffer(vars.size() * 32);\n+      for (V1EnvVar var : vars) {\n+        sb.append(var.getName()).append(',');", "originalCommit": "3858434834cef7fceaf855dc8a9f6a783d87aa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNTMzOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445225338", "bodyText": "Yes, the name alone is sufficient.  The 'modelInImage.sh' MD5 check iterates over the names and gets the values directly from the env vars.", "author": "tbarnes-us", "createdAt": "2020-06-24T23:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIxODg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMTUwOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445221508", "bodyText": "We can probably enhance WDT to take file.", "author": "jshum2479", "createdAt": "2020-06-24T23:14:13Z", "path": "operator/src/main/resources/scripts/modelInImage.sh", "diffHunk": "@@ -245,6 +245,7 @@ function buildWDTParams_MD5() {\n          \" but the secret does not have this key.\"\n       exit 1\n     else\n+      # TBD code review comment: pass credentials via filename instead of risking putting them in an env var", "originalCommit": "3858434834cef7fceaf855dc8a9f6a783d87aa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNDc5OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445224799", "bodyText": "OK - I'll leave the comment here as a reminder.", "author": "tbarnes-us", "createdAt": "2020-06-24T23:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMTUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0NjQ3MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445246471", "bodyText": "I think Tom added that for a reason. At one point in early stage of MII,  I use it for dynamic update - i.e. the job pod will use wlst online to update configuration.  That's one reason I can think of.  util.sh also has a function using it.", "author": "jshum2479", "createdAt": "2020-06-25T00:41:29Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/JobHelper.java", "diffHunk": "@@ -305,10 +315,6 @@ private String getAsServiceName() {\n           addEnvVar(vars, \"ADMIN_PORT_SECURE\", \"true\");\n         }\n         addEnvVar(vars, \"AS_SERVICE_NAME\", getAsServiceName());\n-\n-        // TBD Tom Barnes, Johnny Shum", "originalCommit": "3858434834cef7fceaf855dc8a9f6a783d87aa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU5NTczMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445595732", "bodyText": "I have the same recollection - and agree that the comment seems outdated now.\nPlease resolve the comment if you're OK with its removal.", "author": "tbarnes-us", "createdAt": "2020-06-25T14:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0NjQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4Njc0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445486747", "bodyText": "The method name implies that it is only matching the name, but it is actually matching the name and value. It should be named in a way that makes it clear what is happening. Simple \"envVar\" would probably be a more readable choice.", "author": "russgold", "createdAt": "2020-06-25T11:22:12Z", "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/Matchers.java", "diffHunk": "@@ -165,29 +170,63 @@ public void describeTo(Description description) {\n   }\n \n   static class EnvVarMatcher extends TypeSafeDiagnosingMatcher<V1EnvVar> {\n+    private static final String DONTCARE = \"SENTINEL_DONT_CARE\";\n     private final String expectedName;\n+    private final String expectedValueRegEx;\n \n     private EnvVarMatcher(String expectedName) {\n       this.expectedName = expectedName;\n+      this.expectedValueRegEx = DONTCARE;\n+    }\n+\n+    private EnvVarMatcher(String expectedName, String expectedValueRegEx) {\n+      this.expectedName = expectedName;\n+      this.expectedValueRegEx = expectedValueRegEx;\n     }\n \n     static EnvVarMatcher envVarWithName(@Nonnull String name) {\n       return new EnvVarMatcher(name);\n     }\n \n+    static EnvVarMatcher envVarWithName(@Nonnull String name, String value) {", "originalCommit": "3858434834cef7fceaf855dc8a9f6a783d87aa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwNzM2Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r446007367", "bodyText": "Changed to hasEnvVarRegEx(str,str), this corresponds with hasEnvVar(str,str) above...", "author": "tbarnes-us", "createdAt": "2020-06-26T07:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4Njc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5MTk4Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445491982", "bodyText": "So this is the name of an environment variable whose value is a comma-separated list of environment variable names? That's far from obvious. At the very least, please include a Javadoc comment explaining that.", "author": "russgold", "createdAt": "2020-06-25T11:33:26Z", "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java", "diffHunk": "@@ -78,6 +79,7 @@\n   private static final String DOMAIN_UID = \"JobHelperTestDomain\";\n   private static final String RAW_VALUE_1 = \"find uid1 at $(DOMAIN_HOME)\";\n   private static final String END_VALUE_1 = \"find uid1 at /u01/oracle/user_projects/domains\";\n+  private static final String OSEV = \"OPERATOR_SUPPLIED_ENV_VARS\";", "originalCommit": "3858434834cef7fceaf855dc8a9f6a783d87aa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4MDAzNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445980037", "bodyText": "Done.", "author": "tbarnes-us", "createdAt": "2020-06-26T05:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5MTk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5OTE5OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445499198", "bodyText": "\"hasEnvVarContains\" is a confusing name. It is not checking to see if it has a \"envVarContains,\" but rather whether the special env var OSEV includes the specified name in a list, correct? I had to do a fair amount of searching through the code even to come up with that suggestion.\nI would suggest then, that the actual test needs to be explicit. That is, fetch the envVar and check its contents. Among other things, you are testing that this envVar does not contain an entry for the admin user and password, but the matcher not(hasEnvVarContains(OSEV, \"ADMIN_PASSWORD\")) could easily be satisfied if there is no envVar whose name matches OSEV.\nTo make it easier to read, I would suggest an assertion such as:\nassertThat(getOSEVValues(), allOf(hasItem(configMapKeyRefEnvVar.getName()), etc.\nwhere getOSEVValues() returns a (possibly empty) list of the names in the OSEV variable.", "author": "russgold", "createdAt": "2020-06-25T11:48:27Z", "path": "operator/src/test/java/oracle/kubernetes/operator/helpers/JobHelperTest.java", "diffHunk": "@@ -351,6 +392,13 @@ public void whenAdminServerHasValueFromEnvironmentItems_introspectorPodStartupWi\n             hasItem(configMapKeyRefEnvVar),\n             hasItem(secretKeyRefEnvVar),\n             hasItem(fieldRefEnvVar)));\n+\n+    assertThat(", "originalCommit": "3858434834cef7fceaf855dc8a9f6a783d87aa03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk3ODMxNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445978316", "bodyText": "I'm not quite grokking, can you make this change?", "author": "tbarnes-us", "createdAt": "2020-06-26T05:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5OTE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk3ODY2MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445978661", "bodyText": "Or suggest the exact code you're thinking about?", "author": "tbarnes-us", "createdAt": "2020-06-26T05:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5OTE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4MzI4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r445983285", "bodyText": "I will fix the 'not'.\nAs for changing to 'getOSEVValues' ... pattern instead of leveraging the Matcher and hasEnvVarContains, can we leave the matcher in place as is, and instead, can you suggest a better name for 'hasEnvVarContains'?  I agree the matcher is confusing - but, on the other hand (1) the matcher was already confusing - that's its nature - i just expanded its purpose slightly, (2) the matcher lets us have more clear error messages when/if the assertion fails.", "author": "tbarnes-us", "createdAt": "2020-06-26T06:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5OTE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwNjU5NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1764#discussion_r446006594", "bodyText": "I made changes - not same as you asked - but hopefully clear enough. Please re-review.", "author": "tbarnes-us", "createdAt": "2020-06-26T07:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5OTE5OA=="}], "type": "inlineReview"}, {"oid": "a27c3feff38adde8282a55e8ec214cf3ce849cdf", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a27c3feff38adde8282a55e8ec214cf3ce849cdf", "message": "Merge remote-tracking branch 'origin/owls_82785' into owls_82785-owls_82147", "committedDate": "2020-06-25T15:20:20Z", "type": "commit"}, {"oid": "6ba48b5806f5516e74e65490d0617bc5eee2c3d5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6ba48b5806f5516e74e65490d0617bc5eee2c3d5", "message": "Merge remote-tracking branch 'origin/owls_82785' into owls_82785-owls_82147", "committedDate": "2020-06-25T20:06:18Z", "type": "commit"}, {"oid": "99b242d0e4d0b1e5a62779741b7fac8778b92ea9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/99b242d0e4d0b1e5a62779741b7fac8778b92ea9", "message": "minor changes: change env var name, add comment", "committedDate": "2020-06-26T05:25:38Z", "type": "commit"}, {"oid": "aefdbf95d7f95aa68263005dd96569026b791efe", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/aefdbf95d7f95aa68263005dd96569026b791efe", "message": "minor change: change method name", "committedDate": "2020-06-26T05:51:40Z", "type": "commit"}, {"oid": "f821ce508f69570c5628cc9ce7225207dbf066b6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f821ce508f69570c5628cc9ce7225207dbf066b6", "message": "minor changes: unit test helper renames, etc", "committedDate": "2020-06-26T07:07:54Z", "type": "commit"}]}