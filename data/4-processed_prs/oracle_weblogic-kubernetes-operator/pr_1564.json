{"pr_number": 1564, "pr_title": "Created a new PR for PV and PVC addition because of merge conflict", "pr_createdAt": "2020-04-14T21:27:07Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564", "timeline": [{"oid": "68d1fca55d438c54e5c27982fc7602621ee4b2b2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/68d1fca55d438c54e5c27982fc7602621ee4b2b2", "message": "Created a new PR for PV and PVC addition because of merge conflict", "committedDate": "2020-04-14T21:21:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDE2NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r408774164", "bodyText": "failed? or succeeded?", "author": "markxnelson", "createdAt": "2020-04-15T11:34:08Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItSimpleDomainValidation.java", "diffHunk": "@@ -48,6 +55,51 @@ public void testCreatingDomain() {\n             .metadata(new V1ObjectMeta().namespace(namespace).name(serviceAccountName))));\n     logger.info(\"Created service account: {0}\", serviceAccount.getMetadata().getName());\n \n+    // create persistent volume and persistent volume claim\n+    final String pvcName = domainUID + \"-pvc\"; // name of the persistent volume claim\n+    final String pvName = domainUID + \"-pv\"; // name of the persistent volume\n+\n+    V1PersistentVolumeClaim v1pvc = new V1PersistentVolumeClaim()\n+        .spec(new V1PersistentVolumeClaimSpec()\n+            .addAccessModesItem(\"ReadWriteMany\")\n+            .storageClassName(domainUID + \"-weblogic-domain-storage-class\")\n+            .volumeName(domainUID + \"-weblogic-pv\")\n+            .resources(new V1ResourceRequirements()\n+                .putRequestsItem(\"storage\", Quantity.fromString(\"10Gi\"))))\n+        .metadata(new V1ObjectMetaBuilder()\n+            .withName(pvcName)\n+            .withNamespace(namespace)\n+            .build()\n+            .putLabelsItem(\"weblogic.resourceVersion\", \"domain-v2\")\n+            .putLabelsItem(\"weblogic.domainUID\", domainUID));\n+\n+    boolean success = assertDoesNotThrow(\n+        () -> TestActions.createPersistentVolumeClaim(v1pvc),\n+        \"Persistent volume claim creation failed, look at the log for failure ApiException responsebody\"\n+    );\n+    assertTrue(success, \"PersistentVolumeClaim creation failed\");", "originalCommit": "68d1fca55d438c54e5c27982fc7602621ee4b2b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3MDY2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r408970669", "bodyText": "Assert that the supplied condition is true.\nFails with the supplied failure message.", "author": "sankarpn", "createdAt": "2020-04-15T16:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2OTkwMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r409069903", "bodyText": "This looks right.  Mark, what would you prefer?  It's asserting that success is true and then providing a message for when that assertion is violated.", "author": "rjeberhard", "createdAt": "2020-04-15T19:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExMTI1OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r409111258", "bodyText": "ok got it. sorry it's a pain to have to remember the different types of asserts :(", "author": "markxnelson", "createdAt": "2020-04-15T20:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDU1Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r408774553", "bodyText": "it would be better to catch the exception and check it, and what is \"look at the log\"? what log? where? get the details and print them out here yourself", "author": "markxnelson", "createdAt": "2020-04-15T11:34:53Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItSimpleDomainValidation.java", "diffHunk": "@@ -48,6 +55,51 @@ public void testCreatingDomain() {\n             .metadata(new V1ObjectMeta().namespace(namespace).name(serviceAccountName))));\n     logger.info(\"Created service account: {0}\", serviceAccount.getMetadata().getName());\n \n+    // create persistent volume and persistent volume claim\n+    final String pvcName = domainUID + \"-pvc\"; // name of the persistent volume claim\n+    final String pvName = domainUID + \"-pv\"; // name of the persistent volume\n+\n+    V1PersistentVolumeClaim v1pvc = new V1PersistentVolumeClaim()\n+        .spec(new V1PersistentVolumeClaimSpec()\n+            .addAccessModesItem(\"ReadWriteMany\")\n+            .storageClassName(domainUID + \"-weblogic-domain-storage-class\")\n+            .volumeName(domainUID + \"-weblogic-pv\")\n+            .resources(new V1ResourceRequirements()\n+                .putRequestsItem(\"storage\", Quantity.fromString(\"10Gi\"))))\n+        .metadata(new V1ObjectMetaBuilder()\n+            .withName(pvcName)\n+            .withNamespace(namespace)\n+            .build()\n+            .putLabelsItem(\"weblogic.resourceVersion\", \"domain-v2\")\n+            .putLabelsItem(\"weblogic.domainUID\", domainUID));\n+\n+    boolean success = assertDoesNotThrow(\n+        () -> TestActions.createPersistentVolumeClaim(v1pvc),\n+        \"Persistent volume claim creation failed, look at the log for failure ApiException responsebody\"", "originalCommit": "68d1fca55d438c54e5c27982fc7602621ee4b2b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3NTkxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r408975910", "bodyText": "The final call to create pvc/pv \"Kubernetes.createPersistentVolumeClaim(v1pvc)\" will log ApiException messages as severe in the console. That is addressed in PR #1562\nWhen this messages is printed\n\"Persistent volume claim creation failed, look at the log for failure ApiException responsebody\"\nThe reason for the failure will be just above few lines in the console log. I can change the message to include \"look at the console log\" if that helps.\nSo which way you want to check ?\nassertDoesNotThrow(\n() -> TestActions.createPersistentVolumeClaim(v1pvc),\n\"Persistent volume claim creation failed, \"\n+ \"look at the above log messages for failure reason in ApiException responsebody\");\n(or)\ntry{\nTestActions.createPersistentVolumeClaim(v1pvc);\nlogger.info(\"PersistentVolumeClaim {0} created\", pvcName);\n} catch (ApiException ex) {\nlogger.severe(\"PersistentVolumeClaim {0} creation failed.\", pvcName);\nlogger.severe(ex.getResponseBody());\nfail(String.format(\"PersistentVolumeClaim {0} creation failed\", pvcName));\n}", "author": "sankarpn", "createdAt": "2020-04-15T16:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA0ODc3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r409048779", "bodyText": "This is how it will fail.\n<04-15-2020 18:27:03>  <oracle.weblogic.kubernetes.ItSimpleDomainValidation testCreatingDomain> \n<04-15-2020 18:27:03>  <oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes createPvc> <{\"kind\":\"Status\",\"apiVersion\":\"v1\",\"metadata\":{},\"status\":\"Failure\",\"message\":\"persistentvolumeclaims \"domain1-pvc\" already exists\",\"reason\":\"AlreadyExists\",\"details\":{\"name\":\"domain1-pvc\",\"kind\":\"persistentvolumeclaims\"},\"code\":409}\n\n\n<04-15-2020 18:27:03>  <oracle.weblogic.kubernetes.extensions.Timing afterTestExecution> <Method [testCreatingDomain] took 978 ms.>\n<04-15-2020 18:27:03>  <oracle.weblogic.kubernetes.extensions.LoggedTest afterEachTest> <Finished executing [Create a domain] in oracle.weblogic.kubernetes.ItSimpleDomainValidation.testCreatingDomain()>\n[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 1.026 s <<< FAILURE! - in oracle.weblogic.kubernetes.ItSimpleDomainValidation\n[ERROR] testCreatingDomain  Time elapsed: 1.02 s  <<< FAILURE!\norg.opentest4j.AssertionFailedError: Persistent volume claim creation failed, look at the above log messages for failure reason in ApiException responsebody ==> Unexpected exception thrown: io.kubernetes.client.openapi.ApiException\nat org.junit.jupiter.api.AssertDoesNotThrow.createAssertionFailedError(AssertDoesNotThrow.java:83)\nat org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:76)\nat org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:63)\nat org.junit.jupiter.api.Assertions.assertDoesNotThrow(Assertions.java:3086)\nat oracle.weblogic.kubernetes.ItSimpleDomainValidation.testCreatingDomain(ItSimpleDomainValidation.java:97)\nat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\nat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)", "author": "sankarpn", "createdAt": "2020-04-15T18:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDY2NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1564#discussion_r408774665", "bodyText": "same", "author": "markxnelson", "createdAt": "2020-04-15T11:35:06Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItSimpleDomainValidation.java", "diffHunk": "@@ -48,6 +55,51 @@ public void testCreatingDomain() {\n             .metadata(new V1ObjectMeta().namespace(namespace).name(serviceAccountName))));\n     logger.info(\"Created service account: {0}\", serviceAccount.getMetadata().getName());\n \n+    // create persistent volume and persistent volume claim\n+    final String pvcName = domainUID + \"-pvc\"; // name of the persistent volume claim\n+    final String pvName = domainUID + \"-pv\"; // name of the persistent volume\n+\n+    V1PersistentVolumeClaim v1pvc = new V1PersistentVolumeClaim()\n+        .spec(new V1PersistentVolumeClaimSpec()\n+            .addAccessModesItem(\"ReadWriteMany\")\n+            .storageClassName(domainUID + \"-weblogic-domain-storage-class\")\n+            .volumeName(domainUID + \"-weblogic-pv\")\n+            .resources(new V1ResourceRequirements()\n+                .putRequestsItem(\"storage\", Quantity.fromString(\"10Gi\"))))\n+        .metadata(new V1ObjectMetaBuilder()\n+            .withName(pvcName)\n+            .withNamespace(namespace)\n+            .build()\n+            .putLabelsItem(\"weblogic.resourceVersion\", \"domain-v2\")\n+            .putLabelsItem(\"weblogic.domainUID\", domainUID));\n+\n+    boolean success = assertDoesNotThrow(\n+        () -> TestActions.createPersistentVolumeClaim(v1pvc),\n+        \"Persistent volume claim creation failed, look at the log for failure ApiException responsebody\"\n+    );\n+    assertTrue(success, \"PersistentVolumeClaim creation failed\");\n+\n+    V1PersistentVolume v1pv = new V1PersistentVolume()\n+        .spec(new V1PersistentVolumeSpec()\n+            .addAccessModesItem(\"ReadWriteMany\")\n+            .storageClassName(domainUID + \"-weblogic-domain-storage-class\")\n+            .volumeMode(\"Filesystem\")\n+            .putCapacityItem(\"storage\", Quantity.fromString(\"10Gi\"))\n+            .persistentVolumeReclaimPolicy(\"Recycle\")\n+            .hostPath(new V1HostPathVolumeSource()\n+                .path(System.getProperty(\"java.io.tmpdir\") + domainUID + \"-persistentVolume\")))\n+                .metadata(new V1ObjectMetaBuilder()\n+            .withName(pvName)\n+            .withNamespace(namespace)\n+            .build()\n+            .putLabelsItem(\"weblogic.resourceVersion\", \"domain-v2\")\n+            .putLabelsItem(\"weblogic.domainUID\", domainUID));\n+    success = assertDoesNotThrow(\n+        () -> TestActions.createPersistentVolume(v1pv),\n+        \"Persistent volume creation failed, look at the log for failure ApiException responsebody\"", "originalCommit": "68d1fca55d438c54e5c27982fc7602621ee4b2b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7dd4de496fa4db5a847377ec4269fe26b20343b4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7dd4de496fa4db5a847377ec4269fe26b20343b4", "message": "Merge branch 'develop' into pv-addition-changes", "committedDate": "2020-04-15T15:20:55Z", "type": "commit"}, {"oid": "0a4a33e5a2f56c95efd9d8bf4ca272f2bf9dccab", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0a4a33e5a2f56c95efd9d8bf4ca272f2bf9dccab", "message": "Changes messages to be little bit more clear", "committedDate": "2020-04-15T20:17:36Z", "type": "commit"}, {"oid": "40f23384058a5fe27edf834f3f49c7cc822df87a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/40f23384058a5fe27edf834f3f49c7cc822df87a", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into pv-addition-changes", "committedDate": "2020-04-15T20:27:04Z", "type": "commit"}]}