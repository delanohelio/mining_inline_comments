{"pr_number": 1990, "pr_title": "OWLS 84741: Scaling failed on Jenkins when setting Dedicated to true & io.kubernetes.client.openapi.ApiException: Not Found", "pr_createdAt": "2020-10-14T17:13:31Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990", "timeline": [{"oid": "6065ec9e873a6bd8884877309ad4f78811ef81cb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6065ec9e873a6bd8884877309ad4f78811ef81cb", "message": "Use REST client's access token for authentication and authorization", "committedDate": "2020-10-12T22:45:26Z", "type": "commit"}, {"oid": "9af2a9c3334aaade4fdc4aefbdb9c4a69a8ba723", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9af2a9c3334aaade4fdc4aefbdb9c4a69a8ba723", "message": "Enable testDedicatedModeSameNamespaceScale", "committedDate": "2020-10-13T19:12:08Z", "type": "commit"}, {"oid": "3cbf21375e0ea27d955c5a2b0347c99c026bd1f0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3cbf21375e0ea27d955c5a2b0347c99c026bd1f0", "message": "Add patch permissions to rolebinding", "committedDate": "2020-10-14T00:08:02Z", "type": "commit"}, {"oid": "43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "message": "Code cleanup", "committedDate": "2020-10-14T16:23:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyODUyMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r505128520", "bodyText": "Please try to avoid reflection in tests. We set statics this way in tests because it allows us to deal with dependency injection, and those should be relatively rare cases. Changing instance fields this way, though, is hard to read and very apt to lead to surprising results. If we need to set the field in a test, create a setter for it and comment that it is intended for unit testing.\nIn this case, I would even recommend a fluent interface, so you could do something like:\n  RestBackendImpl restBackendImpl = new RestBackendImpl(\"\", \"\", Collections.singletonList(NS))\n                                          .withAuthorizationProxy(authorizationProxyStub);\n\n\nIt would make the test easier to read.", "author": "russgold", "createdAt": "2020-10-15T02:34:28Z", "path": "operator/src/test/java/oracle/kubernetes/operator/rest/RestBackendImplTest.java", "diffHunk": "@@ -326,6 +335,74 @@ public void verify_getWlsDomainConfig_doesNotReturnNull_whenScanIsNull() {\n     assertThat(wlsDomainConfig, notNullValue());\n   }\n \n+  @Test\n+  public void verify_initializeCallBuilder_withAccessToken_userInfoIsNull() {\n+    RestBackendImpl restBackendImpl = new RestBackendImpl(\"\", \"\", Collections.singletonList(NS));\n+    assertThat(restBackendImpl.getUserInfo(), nullValue());\n+  }\n+\n+  @Test\n+  public void verify_initializeCallBuilder_withTokenReview_userInfoNotNull() {\n+    RestBackEndStub restBackEndStub = new RestBackEndStub(\"\", \"\", Collections.singletonList(NS));\n+    assertThat(restBackEndStub.getUserInfo(), notNullValue());\n+  }\n+\n+  @Test\n+  public void verify_authorizationCheck_notCalled_whenAuthenticateWithTokenReviewIsFalse()\n+      throws NoSuchFieldException, IllegalAccessException {\n+    RestBackendImpl restBackendImpl = new RestBackendImpl(\"\", \"\", Collections.singletonList(NS));\n+    AuthorizationProxyStub authorizationProxyStub = new AuthorizationProxyStub();\n+    Field nameField = restBackendImpl.getClass()", "originalCommit": "43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0NzAyMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r509747021", "bodyText": "Changed to more fluent interface per recommendation.", "author": "lennyphan", "createdAt": "2020-10-21T22:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyODUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEyOTQ5Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r505129492", "bodyText": "You can improve these test names. There is no need to say verify, for example, as all tests do verification of something. I have found a useful convention is something like: \"whenCONDITION_EXPECTATION\". I make it a point to have at most one underscore in test names, just to separate logical parts.\nSo this one could be, for example, whenUsingTokenReview_configureApiClient", "author": "russgold", "createdAt": "2020-10-15T02:38:01Z", "path": "operator/src/test/java/oracle/kubernetes/operator/rest/RestBackendImplTest.java", "diffHunk": "@@ -326,6 +335,74 @@ public void verify_getWlsDomainConfig_doesNotReturnNull_whenScanIsNull() {\n     assertThat(wlsDomainConfig, notNullValue());\n   }\n \n+  @Test\n+  public void verify_initializeCallBuilder_withAccessToken_userInfoIsNull() {\n+    RestBackendImpl restBackendImpl = new RestBackendImpl(\"\", \"\", Collections.singletonList(NS));\n+    assertThat(restBackendImpl.getUserInfo(), nullValue());\n+  }\n+\n+  @Test\n+  public void verify_initializeCallBuilder_withTokenReview_userInfoNotNull() {\n+    RestBackEndStub restBackEndStub = new RestBackEndStub(\"\", \"\", Collections.singletonList(NS));\n+    assertThat(restBackEndStub.getUserInfo(), notNullValue());\n+  }\n+\n+  @Test\n+  public void verify_authorizationCheck_notCalled_whenAuthenticateWithTokenReviewIsFalse()\n+      throws NoSuchFieldException, IllegalAccessException {\n+    RestBackendImpl restBackendImpl = new RestBackendImpl(\"\", \"\", Collections.singletonList(NS));\n+    AuthorizationProxyStub authorizationProxyStub = new AuthorizationProxyStub();\n+    Field nameField = restBackendImpl.getClass()\n+        .getDeclaredField(\"atz\");\n+    nameField.setAccessible(true);\n+\n+    nameField.set(restBackendImpl, authorizationProxyStub);\n+    restBackendImpl.getClusters(NAME1);\n+    assertThat(authorizationProxyStub.atzCheck, is(false));\n+  }\n+\n+  @Test\n+  public void verify_authorizationCheck_isCalled_whenAuthenticateWithTokenReviewIsTrue()\n+      throws NoSuchFieldException, IllegalAccessException {\n+    RestBackEndStub restBackEndStub = new RestBackEndStub(\"\", \"\", Collections.singletonList(NS));\n+    AuthorizationProxyStub authorizationProxyStub = new AuthorizationProxyStub();\n+    Field nameField = restBackEndStub.getClass()\n+        .getSuperclass()\n+        .getDeclaredField(\"atz\");\n+    nameField.setAccessible(true);\n+\n+    nameField.set(restBackEndStub, authorizationProxyStub);\n+    restBackEndStub.getClusters(NAME1);\n+    assertThat(authorizationProxyStub.atzCheck, is(true));\n+  }\n+\n+  @Test\n+  public void verify_apiClient_configured_with_AccessTokenAuthentication()\n+      throws IllegalAccessException {\n+    RestBackendImpl restBackendImpl = new RestBackendImpl(\"\", \"1234\", Collections.singletonList(NS));\n+    CallBuilder callBuilder = getValue(restBackendImpl, \"callBuilder\");\n+    ClientPool pool = getValue(callBuilder, \"helper\");\n+    ApiClient apiClient = pool.take();\n+    Authentication authentication = apiClient.getAuthentication(\"BearerToken\");\n+    assertThat(authentication instanceof ApiKeyAuth, is(true));\n+    String apiKey = ((ApiKeyAuth) authentication).getApiKey();\n+    assertThat(apiKey, is(\"1234\"));\n+  }\n+\n+  @Test\n+  public void verify_apiClient_configured_whenAuthenticateWithTokenReviewIsTrue()", "originalCommit": "43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzMDg3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r505130872", "bodyText": "Where is this environment variable defined? Is it in Helm? If so, prefer the HelmAccess class. There is already a HelmAccessStub to facilitate unit testing.", "author": "russgold", "createdAt": "2020-10-15T02:42:45Z", "path": "operator/src/main/java/oracle/kubernetes/operator/rest/RestBackendImpl.java", "diffHunk": "@@ -417,6 +450,15 @@ private WebApplicationException createWebApplicationException(int status, String\n     return new WebApplicationException(rb.build());\n   }\n \n+  protected boolean authenticateWithTokenReview() {\n+    return \"true\".equalsIgnoreCase(Optional.ofNullable(getEnvVariable.apply(\"TOKEN_REVIEW_AUTHENTICATION\"))", "originalCommit": "43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMDM1MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r505900350", "bodyText": "Please look at what Dongbo did in #1979. There the pattern is that there are values that can be passed to the Helm chart that preserve the pre-existing behavior. The chart puts the value into the operator's ConfigMap, which can then be accessed through the TuningParameters. Note: the Java code needs to handle the variable's not being present as it won't be present on a Helm upgrade.", "author": "rjeberhard", "createdAt": "2020-10-15T22:29:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzMDg3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjAyMDE5Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r506020192", "bodyText": "Just to confirm Ryan, from looking at Dongbo's change, you want the property that controls the new vs old behavior to be defined the values.yaml of the Operator's helm chart and this will then be copied to the Operator's configmap which then can be accessed from TuningParameters? The property won't be defined as an environment variable nor system property.", "author": "lennyphan", "createdAt": "2020-10-16T03:17:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzMDg3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTEwOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r507825108", "bodyText": "That's correct.", "author": "rjeberhard", "createdAt": "2020-10-19T15:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzMDg3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0NzMzOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r509747338", "bodyText": "Change to use TuningParameters.", "author": "lennyphan", "createdAt": "2020-10-21T22:14:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzMDg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzNjEwMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r505136102", "bodyText": "It would probably be cleaner to add a fluent method to CallBuilder that would allow you to say something like:\n  new CallBuilder().withAuthentication(new AccessTokenAuthentication(accessToken))\n\nIf the authentication is null, you'd get the current behavior. That would allow this logic to be moved into CallBuilder, where it really belongs. This isn't a REST thing.\nBut this whole bit of code seems needlessly complex. Find a way to simplify it, please.", "author": "russgold", "createdAt": "2020-10-15T03:01:14Z", "path": "operator/src/main/java/oracle/kubernetes/operator/rest/RestBackendImpl.java", "diffHunk": "@@ -89,13 +97,38 @@\n   RestBackendImpl(String principal, String accessToken, Collection<String> domainNamespaces) {\n     LOGGER.entering(principal, domainNamespaces);\n     this.principal = principal;\n-    userInfo = authenticate(accessToken);\n+    initializeCallBuilder(accessToken);\n     this.domainNamespaces = domainNamespaces;\n     LOGGER.exiting();\n   }\n \n+  private void initializeCallBuilder(String accessToken) {", "originalCommit": "43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0OTUwOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r509749508", "bodyText": "moved AccessTokenAuthentication logic CallBuilder as suggested.  Isolated to callbuilder as that's where it's more suited and relevant.", "author": "lennyphan", "createdAt": "2020-10-21T22:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzNjEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzNjQwNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r505136407", "bodyText": "Seems an odd place to break this method. Can it really not fit on one line?", "author": "russgold", "createdAt": "2020-10-15T03:02:25Z", "path": "operator/src/test/java/oracle/kubernetes/operator/rest/RestBackendImplTest.java", "diffHunk": "@@ -334,10 +411,86 @@ private void setupScanCache() {\n     config = configSupport.createDomainConfig();\n   }\n \n+  @SuppressWarnings(\"unchecked\")\n+  public static <T> T getValue(Object object, String fieldName) throws IllegalAccessException {\n+    return (T) getValue(object, getField(object.getClass(), fieldName));\n+  }\n+\n+  private static Object getValue(Object object, Field field) throws IllegalAccessException {\n+    boolean wasAccessible = field.isAccessible();\n+    try {\n+      field.setAccessible(true);\n+      return field.get(object);\n+    } finally {\n+      field.setAccessible(wasAccessible);\n+    }\n+  }\n+\n+  private static Field getField(Class<?> aaClass, String fieldName) {\n+    assert aaClass != null : \"No such field '\" + fieldName + \"'\";\n+\n+    try {\n+      return aaClass.getDeclaredField(fieldName);\n+    } catch (NoSuchFieldException e) {\n+      return getField(aaClass.getSuperclass(), fieldName);\n+    }\n+  }\n+\n   private class TopologyRetrieverStub implements TopologyRetriever {\n     @Override\n     public WlsDomainConfig getWlsDomainConfig(String ns, String domainUid) {\n       return config;\n     }\n   }\n+\n+  private class RestBackEndStub extends RestBackendImpl {\n+\n+    /**\n+     * Construct a RestBackendImpl that is used to handle one WebLogic operator REST request.\n+     *\n+     * @param principal        is the name of the Kubernetes user to use when calling the Kubernetes\n+     *                         REST api.\n+     * @param accessToken      is the access token of the Kubernetes service account of the client\n+     *                         calling the WebLogic operator REST api.\n+     * @param domainNamespaces a list of Kubernetes namepaces that contain domains that the WebLogic\n+     */\n+    RestBackEndStub(String principal, String accessToken,", "originalCommit": "43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0OTY1MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r509749651", "bodyText": "Fixed.", "author": "lennyphan", "createdAt": "2020-10-21T22:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzNjQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5Nzk1Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r505897956", "bodyText": "We are adding a required role verb (this seems correct), but reminds me that we need to document this requirement in the scaling and/or RBAC documentation. Similarly, we need to document how to create the correct roles and role bindings so that the service account used with the scaling API has the necessary permissions.", "author": "rjeberhard", "createdAt": "2020-10-15T22:23:35Z", "path": "integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/Domain.java", "diffHunk": "@@ -534,6 +534,7 @@ private static boolean createRbacApiObjectsForWLDFScript(String domainNamespace,\n               .addResourcesItem(\"domains\")\n               .addVerbsItem(\"get\")\n               .addVerbsItem(\"list\")\n+              .addVerbsItem(\"patch\")", "originalCommit": "43c8e0ef1369599d9dc77c539f9e6dd9ef176ee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMzgwMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510333803", "bodyText": "Updated documentation in /userguide/managing-operators/using-the-operator/using-helm.md, /userguide/managing-operators/using-the-operator/the-rest-api.md, /userguide/managing-domains/domain-lifecycle/scaling.md, and /kubernetes/charts/weblogic-operator/values.yaml", "author": "lennyphan", "createdAt": "2020-10-22T17:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5Nzk1Ng=="}], "type": "inlineReview"}, {"oid": "23294dafcd9fccd9f4caea6717c226b95a66dcf0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/23294dafcd9fccd9f4caea6717c226b95a66dcf0", "message": "Changes from initial code review", "committedDate": "2020-10-16T18:36:07Z", "type": "commit"}, {"oid": "d7f774a7489106831f0fc5d7b73b2cf220817394", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d7f774a7489106831f0fc5d7b73b2cf220817394", "message": "Merge remote-tracking branch 'origin/develop' into OWLS-84741\n\nMerge latest from develop", "committedDate": "2020-10-16T18:41:21Z", "type": "commit"}, {"oid": "ba8a35ae74ecf3aec77229a361dbd04d88ccab1d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ba8a35ae74ecf3aec77229a361dbd04d88ccab1d", "message": "Use TuningParameters to acccess property to control Operator's REST API authentiction and authorization implementation", "committedDate": "2020-10-16T21:55:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzczNTUyNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r507735527", "bodyText": "\"The default value is false.\" would be a good thing to note.", "author": "russgold", "createdAt": "2020-10-19T13:15:16Z", "path": "kubernetes/charts/weblogic-operator/values.yaml", "diffHunk": "@@ -191,3 +191,9 @@ externalServiceNameSuffix: \"-ext\"\n # cluster size.\n # The default value is true.\n clusterSizePaddingValidationEnabled: true\n+\n+# tokenReviewAuthentication specifies whether the the operator's REST API should use\n+#   1. Kubernetes token review API for authenticating users, and\n+#   2. Kubernetes subject access review API for authorizing a user's operation (get, list,\n+#      patch, etc) on a resource.\n+#tokenReviewAuthentication: false", "originalCommit": "ba8a35ae74ecf3aec77229a361dbd04d88ccab1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzODM0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r508838347", "bodyText": "This leaves ambiguous the meaning of \"false.\" Would you please update this to describe that when the value is false that the caller's bearer token will be delegated so that the update to the Domain resource is done using the caller's privileges?", "author": "rjeberhard", "createdAt": "2020-10-20T21:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzczNTUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzNDE5Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510334196", "bodyText": "updated with description.", "author": "lennyphan", "createdAt": "2020-10-22T17:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzczNTUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc2MzE3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r507763172", "bodyText": "We've been using the Guava method\nStrings.isNullOrEmpty()\n\nfor cases like this.", "author": "russgold", "createdAt": "2020-10-19T13:51:54Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/CallBuilder.java", "diffHunk": "@@ -1907,4 +1910,31 @@ private Call readPodLogAsync(\n   private CancellableCall wrap(Call call) {\n     return new CallWrapper(call);\n   }\n+\n+  public ClientPool getClientPool() {\n+    return this.helper;\n+  }\n+\n+  /**\n+   * Create AccessTokenAuthentication component for authenticating user represented by\n+   * the given token.\n+   * @param accessToken - User's Bearer token\n+   * @return - this CallBuilder instance\n+   */\n+  public CallBuilder withAuthentication(String accessToken) {\n+    if (accessToken != null && !accessToken.isEmpty()) {", "originalCommit": "ba8a35ae74ecf3aec77229a361dbd04d88ccab1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzNDM3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510334372", "bodyText": "Changed to use Guava method.", "author": "lennyphan", "createdAt": "2020-10-22T17:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc2MzE3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc3NDU3Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r507774577", "bodyText": "typo: \"when\" rather than \"vwhen\"", "author": "russgold", "createdAt": "2020-10-19T14:04:52Z", "path": "operator/src/test/java/oracle/kubernetes/operator/rest/RestBackendImplTest.java", "diffHunk": "@@ -336,66 +335,52 @@ public void verify_getWlsDomainConfig_doesNotReturnNull_whenScanIsNull() {\n   }\n \n   @Test\n-  public void verify_initializeCallBuilder_withAccessToken_userInfoIsNull() {\n-    RestBackendImpl restBackendImpl = new RestBackendImpl(\"\", \"\", Collections.singletonList(NS));\n-    assertThat(restBackendImpl.getUserInfo(), nullValue());\n+  public void vwhenUsingAccessToken_userInfoIsNull() {", "originalCommit": "ba8a35ae74ecf3aec77229a361dbd04d88ccab1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzNDQ5MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510334490", "bodyText": "fixed typo", "author": "lennyphan", "createdAt": "2020-10-22T17:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc3NDU3Nw=="}], "type": "inlineReview"}, {"oid": "8a8dad53070fe3190a43747f5a0f324729d5bf6a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8a8dad53070fe3190a43747f5a0f324729d5bf6a", "message": "Code review changes", "committedDate": "2020-10-19T21:43:32Z", "type": "commit"}, {"oid": "6e1df5a5a2f398b8487d00b72b6938e720b131a8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6e1df5a5a2f398b8487d00b72b6938e720b131a8", "message": "merge latest from develop", "committedDate": "2020-10-21T17:15:56Z", "type": "commit"}, {"oid": "086f1679215656995a753d1e431b9376f35cae38", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/086f1679215656995a753d1e431b9376f35cae38", "message": "documentation updates", "committedDate": "2020-10-21T22:09:19Z", "type": "commit"}, {"oid": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bf48df15fbc6c5ba9b80596ff53bec882ee57324", "message": "document patch verb", "committedDate": "2020-10-22T02:50:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwMjk3NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510102974", "bodyText": "associated to -> associated with\nresource, you'll -> resource, then you'll", "author": "rosemarymarano", "createdAt": "2020-10-22T12:00:19Z", "path": "docs-source/content/userguide/managing-domains/domain-lifecycle/scaling.md", "diffHunk": "@@ -87,8 +87,27 @@ For example, when using `curl`:\n curl -v -k -H X-Requested-By:MyClient -H Content-Type:application/json -H Accept:application/json -H \"Authorization:Bearer ...\" -d '{ \"managedServerCount\": 3 }' https://.../scaling\n ```\n \n-If you omit the header, you'll get a `400 (bad request)` response. If you omit the Bearer Authentication header, then you'll get a `401 (Unauthorized)` response.\n+If you omit the header, you'll get a `400 (bad request)` response. If you omit the Bearer Authentication header, then you'll get a `401 (Unauthorized)` response.  If the service account or user associated to the `Bearer` token does not have permission to `patch` the WebLogic domain resource, you'll get a `403 (Forbidden)` response.", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzNDk4OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510334989", "bodyText": "Fixed all review comments on documentation.", "author": "lennyphan", "createdAt": "2020-10-22T17:26:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwMjk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwMzQwMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510103400", "bodyText": "associated to -> associated with", "author": "rosemarymarano", "createdAt": "2020-10-22T12:01:05Z", "path": "docs-source/content/userguide/managing-domains/domain-lifecycle/scaling.md", "diffHunk": "@@ -87,8 +87,27 @@ For example, when using `curl`:\n curl -v -k -H X-Requested-By:MyClient -H Content-Type:application/json -H Accept:application/json -H \"Authorization:Bearer ...\" -d '{ \"managedServerCount\": 3 }' https://.../scaling\n ```\n \n-If you omit the header, you'll get a `400 (bad request)` response. If you omit the Bearer Authentication header, then you'll get a `401 (Unauthorized)` response.\n+If you omit the header, you'll get a `400 (bad request)` response. If you omit the Bearer Authentication header, then you'll get a `401 (Unauthorized)` response.  If the service account or user associated to the `Bearer` token does not have permission to `patch` the WebLogic domain resource, you'll get a `403 (Forbidden)` response.\n \n+{{% notice note %}}\n+To resolve a `403 (Forbidden)` response, when calling the operator's REST scaling API, you may need to add the `patch` request verb to the cluster role associated to the WebLogic `domains` resource.", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwNjM0OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510106349", "bodyText": "operator would perform ->operator performed\nAPI's -> APIs, (no apostrophe, add a comma)\nand then update -> and then updated\nNow the operator will, by default, use -> Now, by default, the operator will use\nCaller's bearer token -> caller's bearer token\nCaller's privileges -> caller's privileges", "author": "rosemarymarano", "createdAt": "2020-10-22T12:06:13Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/the-rest-api.md", "diffHunk": "@@ -14,7 +14,12 @@ You can access most of the REST services using `GET`, for example:\n * To obtain a list of domains, send a `GET` request to the URL `/operator/latest/domains`\n * To obtain a list of clusters in a domain, send a `GET` request to the URL `/operator/latest/domains/<domainUID>/clusters`\n \n-All of the REST services require authentication.  Callers must pass in a valid token header and a CA certificate file.  Callers should pass in the `Accept:/application/json` header.\n+All of the REST services require authentication.  Callers must pass in a valid token header and a CA certificate file.  In previous operator versions, the operator would perform authentication and authorization checks using the Kubernetes token review and subject access review API's and then update the Domain resource using the operator's privileges.  Now the operator will, by default, use the Caller's bearer token to perform the underlying update to the Domain resource using the Caller's privileges and thus delegating authentication and authorization checks directly to the Kubernetes API Server (see [REST interface configuration]({{< relref \"/userguide/managing-operators/using-the-operator/using-helm.md#rest-interface-configuration\" >}})).  ", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExMzY0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510113648", "bodyText": "When scaling up or scaling down a WebLogic cluster, through the operator's REST services, -> When using the operator's REST services to scale up or down a WebLogic cluster,\nCaller's bearer token -> caller's bearer token (is there a reason that Caller is capitalized?)", "author": "rosemarymarano", "createdAt": "2020-10-22T12:18:45Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/the-rest-api.md", "diffHunk": "@@ -14,7 +14,12 @@ You can access most of the REST services using `GET`, for example:\n * To obtain a list of domains, send a `GET` request to the URL `/operator/latest/domains`\n * To obtain a list of clusters in a domain, send a `GET` request to the URL `/operator/latest/domains/<domainUID>/clusters`\n \n-All of the REST services require authentication.  Callers must pass in a valid token header and a CA certificate file.  Callers should pass in the `Accept:/application/json` header.\n+All of the REST services require authentication.  Callers must pass in a valid token header and a CA certificate file.  In previous operator versions, the operator would perform authentication and authorization checks using the Kubernetes token review and subject access review API's and then update the Domain resource using the operator's privileges.  Now the operator will, by default, use the Caller's bearer token to perform the underlying update to the Domain resource using the Caller's privileges and thus delegating authentication and authorization checks directly to the Kubernetes API Server (see [REST interface configuration]({{< relref \"/userguide/managing-operators/using-the-operator/using-helm.md#rest-interface-configuration\" >}})).  \n+{{% notice note %}}\n+When scaling up or scaling down a WebLogic cluster, through the operator's REST services, you may need to grant `patch` access to the user or service account associated with the Caller's bearer token. This can be done with an RBAC ClusterRoleBinding between the user or service account and the ClusterRole that defines the permissions for the WebLogic `domains` resource.", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExNTIwMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510115203", "bodyText": "tokenReviewAuthentication, if set to true, specifies -> If set to true, tokenReviewAuthentication specifies\nshould use -> should use:\n@lennyphan Is the following meant to be a numbered list, in other words, does tokenReviewAuthentication do each step in order? If so, keep it numbered. If not, then change it to a bulleted list.", "author": "rosemarymarano", "createdAt": "2020-10-22T12:21:11Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/using-helm.md", "diffHunk": "@@ -468,7 +468,21 @@ Example:\n ```\n externalOperatorKey: QmFnIEF0dHJpYnV0ZXMKICAgIGZyaWVuZGx5TmFtZTogd2VibG9naWMtb3B ...\n ```\n-\n+##### `tokenReviewAuthentication`\n+tokenReviewAuthentication, if set to `true`, specifies whether the the operator's REST API should use", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExOTQzMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510119431", "bodyText": "Remove this from the sentence: (comma), and", "author": "rosemarymarano", "createdAt": "2020-10-22T12:27:46Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/using-helm.md", "diffHunk": "@@ -468,7 +468,21 @@ Example:\n ```\n externalOperatorKey: QmFnIEF0dHJpYnV0ZXMKICAgIGZyaWVuZGx5TmFtZTogd2VibG9naWMtb3B ...\n ```\n-\n+##### `tokenReviewAuthentication`\n+tokenReviewAuthentication, if set to `true`, specifies whether the the operator's REST API should use\n+   1. Kubernetes token review API for authenticating users, and", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyMDA1Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510120057", "bodyText": "get, list, patch, etc -> get, list, patch, and such (code font, surround with back ticks)", "author": "rosemarymarano", "createdAt": "2020-10-22T12:28:43Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/using-helm.md", "diffHunk": "@@ -468,7 +468,21 @@ Example:\n ```\n externalOperatorKey: QmFnIEF0dHJpYnV0ZXMKICAgIGZyaWVuZGx5TmFtZTogd2VibG9naWMtb3B ...\n ```\n-\n+##### `tokenReviewAuthentication`\n+tokenReviewAuthentication, if set to `true`, specifies whether the the operator's REST API should use\n+   1. Kubernetes token review API for authenticating users, and\n+   2. Kubernetes subject access review API for authorizing a user's operation (get, list,\n+      patch, etc) on a resource.", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyMDYyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510120628", "bodyText": "This parameter, if set to false, will use -> If set to false, this parameter will use", "author": "rosemarymarano", "createdAt": "2020-10-22T12:29:38Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/using-helm.md", "diffHunk": "@@ -468,7 +468,21 @@ Example:\n ```\n externalOperatorKey: QmFnIEF0dHJpYnV0ZXMKICAgIGZyaWVuZGx5TmFtZTogd2VibG9naWMtb3B ...\n ```\n-\n+##### `tokenReviewAuthentication`\n+tokenReviewAuthentication, if set to `true`, specifies whether the the operator's REST API should use\n+   1. Kubernetes token review API for authenticating users, and\n+   2. Kubernetes subject access review API for authorizing a user's operation (get, list,\n+      patch, etc) on a resource.\n+   3. Update the Domain resource using the operator's privileges.\n+ This parameter, if set to `false`, will use the caller's bearer token for any update", "originalCommit": "bf48df15fbc6c5ba9b80596ff53bec882ee57324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67d85006a5d024349f7c22dd973356bec2384c32", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/67d85006a5d024349f7c22dd973356bec2384c32", "message": "documentation changes based on review", "committedDate": "2020-10-22T17:20:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MjgzMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510392831", "bodyText": "tokenReviewAuthentication specifies -> tokenReviewAuthentication (code font) specifies", "author": "rosemarymarano", "createdAt": "2020-10-22T19:06:06Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/using-helm.md", "diffHunk": "@@ -469,12 +469,13 @@ Example:\n externalOperatorKey: QmFnIEF0dHJpYnV0ZXMKICAgIGZyaWVuZGx5TmFtZTogd2VibG9naWMtb3B ...\n ```\n ##### `tokenReviewAuthentication`\n-tokenReviewAuthentication, if set to `true`, specifies whether the the operator's REST API should use\n-   1. Kubernetes token review API for authenticating users, and\n-   2. Kubernetes subject access review API for authorizing a user's operation (get, list,\n-      patch, etc) on a resource.\n-   3. Update the Domain resource using the operator's privileges.\n- This parameter, if set to `false`, will use the caller's bearer token for any update\n+If set to `true`, tokenReviewAuthentication specifies whether the the operator's REST API should use:", "originalCommit": "67d85006a5d024349f7c22dd973356bec2384c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MzY0Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1990#discussion_r510393642", "bodyText": "get, list, patch, -> get, list, patch, (code font, surround with back ticks)", "author": "rosemarymarano", "createdAt": "2020-10-22T19:07:20Z", "path": "docs-source/content/userguide/managing-operators/using-the-operator/using-helm.md", "diffHunk": "@@ -469,12 +469,13 @@ Example:\n externalOperatorKey: QmFnIEF0dHJpYnV0ZXMKICAgIGZyaWVuZGx5TmFtZTogd2VibG9naWMtb3B ...\n ```\n ##### `tokenReviewAuthentication`\n-tokenReviewAuthentication, if set to `true`, specifies whether the the operator's REST API should use\n-   1. Kubernetes token review API for authenticating users, and\n-   2. Kubernetes subject access review API for authorizing a user's operation (get, list,\n-      patch, etc) on a resource.\n-   3. Update the Domain resource using the operator's privileges.\n- This parameter, if set to `false`, will use the caller's bearer token for any update\n+If set to `true`, tokenReviewAuthentication specifies whether the the operator's REST API should use:\n+   * Kubernetes token review API for authenticating users and\n+   * Kubernetes subject access review API for authorizing a user's operation (get, list,\n+      patch, and such) on a resource.", "originalCommit": "67d85006a5d024349f7c22dd973356bec2384c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "245e0fc451450831d04741f3afe6a0b5c077a720", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/245e0fc451450831d04741f3afe6a0b5c077a720", "message": "use code font for appropriate parameters", "committedDate": "2020-10-22T19:19:56Z", "type": "commit"}]}