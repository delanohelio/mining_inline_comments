{"pr_number": 542, "pr_title": "[OC-665] Externalize menu configuration from bundle", "pr_createdAt": "2020-10-20T08:37:22Z", "pr_url": "https://github.com/opfab/operatorfabric-core/pull/542", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM1ODU0MA==", "url": "https://github.com/opfab/operatorfabric-core/pull/542#discussion_r508358540", "bodyText": "alias /usr/share/nginx/html/opfab/ui-menu.json;", "author": "freddidierRTE", "createdAt": "2020-10-20T09:42:03Z", "path": "config/docker/ngnix.conf", "diffHunk": "@@ -36,6 +36,9 @@ server {\n   location /config/web-ui.json {\n     alias /usr/share/nginx/html/opfab/web-ui.json;\n   }\n+  location /config/ui-menu.json {\n+    alias /usr/share/nginx/html/opfab/web-ui.json;", "originalCommit": "4d4738d72f3a892da6be3d1cf536e2c2331e17e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM2MzI1MQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/542#discussion_r508363251", "bodyText": "Put it in a method called LoadTranslationForMenu() and call it from loadTranslationAndLaunchAuthenticationProcess method", "author": "freddidierRTE", "createdAt": "2020-10-20T09:49:06Z", "path": "ui/main/src/app/app.component.ts", "diffHunk": "@@ -70,7 +71,14 @@ export class AppComponent implements OnInit {\n       console.error('Impossible to load configuration file web-ui.json', err);\n       return caught;\n     }));\n+    this.configService.loadMenuTranslations().subscribe(locales => locales.forEach(locale =>\n+      this.translateService.setTranslation(locale.language, locale.i18n, true)))\n+    catchError((err, caught) => {\n+      console.error('Impossible to load configuration file ui-menu.json', err);\n+      return caught;\n+    });\n   }\n+", "originalCommit": "4d4738d72f3a892da6be3d1cf536e2c2331e17e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM2NDU0MA==", "url": "https://github.com/opfab/operatorfabric-core/pull/542#discussion_r508364540", "bodyText": "We do not make test coverge , remove all /* istanbul ignore next */", "author": "freddidierRTE", "createdAt": "2020-10-20T09:51:07Z", "path": "ui/main/src/app/model/menu.model.ts", "diffHunk": "@@ -0,0 +1,60 @@\n+/* Copyright (c) 2018-2020, RTE (http://www.rte-france.com)\n+ * See AUTHORS.txt\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ * SPDX-License-Identifier: MPL-2.0\n+ * This file is part of the OperatorFabric project.\n+ */\n+\n+import { I18n } from './i18n.model';\n+\n+\n+export class Menu {\n+    /* istanbul ignore next */\n+    constructor(\n+        readonly id: string,\n+        readonly label: string,\n+        readonly entries: MenuEntry[]) {\n+    }\n+}\n+\n+export class MenuEntry {\n+\n+    linkType: MenuEntryLinkTypeEnum = MenuEntryLinkTypeEnum.BOTH;\n+\n+    /* istanbul ignore next */\n+    constructor(\n+        readonly id: string,\n+        readonly label: string,\n+        readonly url: string,\n+        linkType?: MenuEntryLinkTypeEnum\n+    ) {\n+    }\n+}\n+\n+export enum MenuEntryLinkTypeEnum {\n+    TAB = 'TAB',\n+    IFRAME = 'IFRAME',\n+    BOTH = 'BOTH'\n+}\n+\n+\n+\n+export class Locale {\n+    /* istanbul ignore next */\n+    constructor(\n+        readonly language: string,\n+        readonly i18n: I18n) {\n+\n+        }\n+}\n+    \n+export class MenuConfig {\n+    /* istanbul ignore next */\n+    constructor(\n+        readonly menus: Menu[],\n+        readonly locales: Locale[]) {\n+\n+        }\n+}", "originalCommit": "4d4738d72f3a892da6be3d1cf536e2c2331e17e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyOTIwNw==", "url": "https://github.com/opfab/operatorfabric-core/pull/542#discussion_r508429207", "bodyText": "Add the same in config/docker/docker-compose.yml", "author": "freddidierRTE", "createdAt": "2020-10-20T11:39:24Z", "path": "config/dev/docker-compose.yml", "diffHunk": "@@ -33,6 +33,7 @@ services:\n     volumes:\n       - \"./favicon.ico:/usr/share/nginx/html/favicon.ico\"\n       - \"./web-ui.json:/usr/share/nginx/html/opfab/web-ui.json\"\n+      - \"./ui-menu.json:/usr/share/nginx/html/opfab/ui-menu.json\"", "originalCommit": "4d4738d72f3a892da6be3d1cf536e2c2331e17e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyOTgzMw==", "url": "https://github.com/opfab/operatorfabric-core/pull/542#discussion_r508429833", "bodyText": "Duplicate this configuration file in config/docker", "author": "freddidierRTE", "createdAt": "2020-10-20T11:40:26Z", "path": "config/dev/ui-menu.json", "diffHunk": "@@ -0,0 +1,80 @@\n+{\n+  \"menus\": [\n+    {\n+      \"id\": \"menu1\",\n+      \"label\": \"title.single\",\n+      \"entries\": [\n+        {\n+          \"id\": \"uid test 0\",\n+          \"url\": \"https://opfab.github.io/\",\n+          \"label\": \"entry.single\",\n+          \"linkType\": \"BOTH\"\n+        }\n+      ]\n+    },\n+    {\n+      \"id\": \"menu2\",\n+      \"label\": \"title.multi\",\n+      \"entries\": [\n+        {\n+          \"id\": \"uid test 1\",\n+          \"url\": \"https://opfab.github.io/\",\n+          \"label\": \"entry.entry1\",\n+          \"linkType\": \"BOTH\"\n+        },\n+        {\n+          \"id\": \"uid test 2\",\n+          \"url\": \"https://www.lfenergy.org/\",\n+          \"label\": \"entry.entry2\",\n+          \"linkType\": \"BOTH\"\n+        }\n+      ]\n+    }\n+  ],\n+  \"locales\": [\n+    {\n+      \"language\": \"en\",\n+      \"i18n\": {\n+        \"menu1\": {\n+          \"title\": {\n+            \"single\": \"First menu\"\n+          },\n+          \"entry\": {\n+            \"single\": \"Single menu entry\"\n+          }\n+        },\n+        \"menu2\": {\n+          \"title\": {\n+            \"multi\": \"Second menu\"\n+          },\n+          \"entry\": {\n+            \"entry1\": \"First menu entry\",\n+            \"entry2\": \"Second menu entry\"\n+          }\n+        }\n+      }\n+    },\n+    {\n+      \"language\": \"fr\",\n+      \"i18n\": {\n+        \"menu1\": {\n+          \"title\": {\n+            \"single\": \"Premiere menu\"\n+          },\n+          \"entry\": {\n+            \"single\": \"Unique menu entry\"\n+          }\n+        },\n+        \"menu2\": {\n+          \"title\": {\n+            \"multi\": \"Deuxieme menu\"\n+          },\n+          \"entry\": {\n+            \"entry1\": \"Premiere menu entry\",\n+            \"entry2\": \"Deuxieme menu entry\"\n+          }\n+        }\n+      }\n+    }\n+  ]\n+}", "originalCommit": "4d4738d72f3a892da6be3d1cf536e2c2331e17e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQzNDk2NQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/542#discussion_r508434965", "bodyText": "You do not need to query the back here . Just memorize the result when you first load the menu via computeMenu", "author": "freddidierRTE", "createdAt": "2020-10-20T11:49:35Z", "path": "ui/main/src/app/services/config.service.ts", "diffHunk": "@@ -42,4 +43,44 @@ export class ConfigService {\n         }\n         return result;\n     }\n+\n+    loadMenuTranslations(): Observable<Locale[]> {\n+        return this.httpClient.get<MenuConfig>(`${environment.urls.menuConfig}`).pipe(\n+            map(config => config.locales)\n+        );\n+    }\n+\n+    computeMenu(): Observable<Menu[]> {\n+        return this.httpClient.get<MenuConfig>(`${environment.urls.menuConfig}`).pipe(\n+            map(config => this.processMenuConfig(config)\n+            )\n+        );\n+    }\n+\n+    queryMenuEntryURL(id: string, menuEntryId: string): Observable<string> {\n+        return this.httpClient.get<MenuConfig>(`${environment.urls.menuConfig}`).pipe(\n+            switchMap(config => {\n+                const menu = config.menus.find(m => m.id === id);\n+\n+                const entry = menu.entries.filter(e => e.id === menuEntryId);\n+                if (entry.length === 1) {\n+                    return entry;\n+                } else {\n+                    throwError(new Error('No such menu entry.'));\n+                }\n+            }),\n+            catchError((err, caught) => {\n+                console.log(new Date().toISOString(),err);\n+                return throwError(err);\n+            }),\n+            map(menuEntry => menuEntry.url)\n+        );", "originalCommit": "4d4738d72f3a892da6be3d1cf536e2c2331e17e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8b8d4aafffba71991e4cb8de6ecf901a8e14fcb9", "url": "https://github.com/opfab/operatorfabric-core/commit/8b8d4aafffba71991e4cb8de6ecf901a8e14fcb9", "message": "[OC-665] Externalize menu confguration from bundle", "committedDate": "2020-10-21T13:14:20Z", "type": "forcePushed"}, {"oid": "cf0b69337918611bc28bad56157249e9a6897861", "url": "https://github.com/opfab/operatorfabric-core/commit/cf0b69337918611bc28bad56157249e9a6897861", "message": "[OC-665] Externalize menu confguration from bundle", "committedDate": "2020-10-22T14:49:19Z", "type": "forcePushed"}, {"oid": "23037f76004b96c27c41e434e71947e194d1d4f2", "url": "https://github.com/opfab/operatorfabric-core/commit/23037f76004b96c27c41e434e71947e194d1d4f2", "message": "[OC-665] Externalize menu confguration from bundle", "committedDate": "2020-10-23T14:14:49Z", "type": "commit"}, {"oid": "23037f76004b96c27c41e434e71947e194d1d4f2", "url": "https://github.com/opfab/operatorfabric-core/commit/23037f76004b96c27c41e434e71947e194d1d4f2", "message": "[OC-665] Externalize menu confguration from bundle", "committedDate": "2020-10-23T14:14:49Z", "type": "forcePushed"}]}