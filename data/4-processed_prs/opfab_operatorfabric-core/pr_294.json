{"pr_number": 294, "pr_title": "[OC-748] Remove button log in using keyCloak", "pr_createdAt": "2020-05-12T14:32:51Z", "pr_url": "https://github.com/opfab/operatorfabric-core/pull/294", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2Mzg0MQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r423863841", "bodyText": "As it is, authentication.service.spec.ts doesn't have any actual tests left, which is unusual for a spec file. If we want to keep the AuthenticationImportHelperForSpecs helper, maybe we could move it somewhere else? In authentication.service.ts or one of the global helper files ?", "author": "AlexGuironnetRTE", "createdAt": "2020-05-12T16:19:13Z", "path": "ui/main/src/app/services/authentication/authentication.service.spec.ts", "diffHunk": "@@ -5,502 +5,20 @@\n  * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n  */\n \n-\n-import {TestBed} from '@angular/core/testing';\n-\n import {\n     AuthenticationService,\n-    AuthObject,\n-    CheckTokenResponse, ImplicitAuthenticationHandler,\n-    isInTheFuture,\n-    LocalStorageAuthContent,\n-    PasswordOrCodeAuthenticationHandler\n } from './authentication.service';\n-import {HttpClientTestingModule, HttpTestingController} from '@angular/common/http/testing';\n-import {\n-    ImplicitlyAuthenticated,\n-    PayloadForSuccessfulAuthentication,\n-    UnAuthenticationFromImplicitFlow,\n-    UnableToRefreshOrGetToken\n-} from '@ofActions/authentication.actions';\n-import {Guid} from 'guid-typescript';\n-import {getPositiveRandomNumberWithinRange, getRandomAlphanumericValue} from '@tests/helpers';\n import {GuidService} from '@ofServices/guid.service';\n-import {Store, StoreModule} from '@ngrx/store';\n-import {appReducer} from '@ofStore/index';\n-import {environment} from '@env/environment';\n import {\n     OAuthLogger,\n     OAuthService,\n     UrlHelperService,\n     EventType as OauthEventType,\n-    OAuthSuccessEvent\n } from 'angular-oauth2-oidc';\n-import createSpyObj = jasmine.createSpyObj;\n-import {create} from \"domain\";\n-import any = jasmine.any;\n \n \n export const AuthenticationImportHelperForSpecs = [AuthenticationService,", "originalCommit": "390d9340a3cdd84d2cf804ee34f49114c9b53ac1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxOTU2OQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r424219569", "bodyText": "You are right , i will move it global helper file", "author": "freddidierRTE", "createdAt": "2020-05-13T07:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2Mzg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2NjI2Mg==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r423866262", "bodyText": "Why is AuthenticationImportHelperForSpecs no longer needed in this test file and others (cards etc.) ?", "author": "AlexGuironnetRTE", "createdAt": "2020-05-12T16:22:42Z", "path": "ui/main/src/app/modules/archives/archive.component.spec.ts", "diffHunk": "@@ -46,8 +45,7 @@ describe('ArchivesComponent', () => {\n             ],\n             providers: [\n                 {provide: Store, useClass: Store},\n-                {provide: RouterStateSerializer, useClass: CustomRouterStateSerializer},\n-                AuthenticationImportHelperForSpecs", "originalCommit": "390d9340a3cdd84d2cf804ee34f49114c9b53ac1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxOTIyMg==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r424219222", "bodyText": "I think it was never needed ( a copy/paste i presume ? )", "author": "freddidierRTE", "createdAt": "2020-05-13T07:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2NjI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MTUwNg==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r424241506", "bodyText": "Probably... we've done a lot of it in frontend unit tests unfortunately", "author": "AlexGuironnetRTE", "createdAt": "2020-05-13T07:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2NjI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwMzcxNw==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r424003717", "bodyText": "Why delete all tests for app component (even those unrelated to feature)? Were they too brittle ?", "author": "AlexGuironnetRTE", "createdAt": "2020-05-12T20:10:17Z", "path": "ui/main/src/app/app.component.spec.ts", "diffHunk": "@@ -1,178 +0,0 @@\n-/* Copyright (c) 2020, RTE (http://www.rte-france.com)", "originalCommit": "390d9340a3cdd84d2cf804ee34f49114c9b53ac1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyMDkwOA==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r424220908", "bodyText": "To remove button ,i needed to modify the way authentication is done and refactor the app.component . After that refactor ,unit testing of this component is not needed.\nThis is linked with our new strategy to limit useless unit tests in frontend", "author": "freddidierRTE", "createdAt": "2020-05-13T07:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwMzcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwNDcwNg==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r424004706", "bodyText": "This means expiration date is checked every 5s ?\nIf so a named constant might be better.", "author": "AlexGuironnetRTE", "createdAt": "2020-05-12T20:12:18Z", "path": "ui/main/src/app/services/authentication/authentication.service.ts", "diffHunk": "@@ -96,31 +106,41 @@ export class AuthenticationService {\n      */\n     instantiateAuthModeHandler(mode: string): AuthenticationModeHandler {\n         if (mode.toLowerCase() === 'implicit') {\n-            this.instantiateImplicitFlowConfiguration();\n-            return new ImplicitAuthenticationHandler(this, this.store, sessionStorage);\n+            this.implicitConf = {...this.implicitConf, issuer: this.delegateUrl, clientId: this.clientId,clearHashAfterLogin: false};\n+            return new ImplicitAuthenticationHandler(this, this.store, sessionStorage,this.oauthService,this.guidService,this.router,this.implicitConf,);\n         }\n         return new PasswordOrCodeAuthenticationHandler(this, this.store);\n     }\n \n+\n+    regularCheckTokenValidity() {\n+        if (this.verifyExpirationDate()) {\n+            setTimeout(() => {\n+                this.regularCheckTokenValidity();\n+            }, 5000);", "originalCommit": "390d9340a3cdd84d2cf804ee34f49114c9b53ac1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyMjcwOQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/294#discussion_r424222709", "bodyText": "Yes , i will add a constant", "author": "freddidierRTE", "createdAt": "2020-05-13T07:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwNDcwNg=="}], "type": "inlineReview"}, {"oid": "5e8aea93bb61010a664e18261df38faa856714c3", "url": "https://github.com/opfab/operatorfabric-core/commit/5e8aea93bb61010a664e18261df38faa856714c3", "message": "[OC-748] Remove button log in using keyCloak", "committedDate": "2020-05-13T08:56:57Z", "type": "commit"}, {"oid": "5e8aea93bb61010a664e18261df38faa856714c3", "url": "https://github.com/opfab/operatorfabric-core/commit/5e8aea93bb61010a664e18261df38faa856714c3", "message": "[OC-748] Remove button log in using keyCloak", "committedDate": "2020-05-13T08:56:57Z", "type": "forcePushed"}]}