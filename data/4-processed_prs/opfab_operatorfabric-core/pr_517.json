{"pr_number": 517, "pr_title": "[OC-1092] Delete a card from the UI", "pr_createdAt": "2020-10-08T18:29:12Z", "pr_url": "https://github.com/opfab/operatorfabric-core/pull/517", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MTI5Mg==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502251292", "bodyText": "Generate just one card", "author": "freddidierRTE", "createdAt": "2020-10-09T07:53:54Z", "path": "services/core/cards-publication/src/test/java/org/lfenergy/operatorfabric/cards/publication/controllers/CardControllerShould.java", "diffHunk": "@@ -133,6 +133,19 @@ void keepTheCardRepository_Untouched_when_ARandomId_isGiven() {\n \n     }\n \n+    @Test\n+    void deleteUserCardWithUnauthenticatedUser() throws Exception {\n+\n+        EasyRandom randomGenerator = instantiateEasyRandom();\n+\n+        int numberOfCards = 10;", "originalCommit": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyNDE4Ng==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502524186", "bodyText": "Done", "author": "vlo-rte", "createdAt": "2020-10-09T15:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MTI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MzUzMA==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502253530", "bodyText": "Delete all the created card at the end", "author": "freddidierRTE", "createdAt": "2020-10-09T07:58:14Z", "path": "src/test/api/karate/cards/deleteUserCard.feature", "diffHunk": "@@ -0,0 +1,238 @@\n+Feature: deleteUserCards tests\r\n+\r\n+  Background:\r\n+   #Getting token for admin and tso1-operator user calling getToken.feature\r\n+    * def signIn = call read('../common/getToken.feature') { username: 'admin'}\r\n+    * def authToken = signIn.authToken\r\n+    * def signInAsTSO = call read('../common/getToken.feature') { username: 'tso1-operator'}\r\n+    * def authTokenAsTSO = signInAsTSO.authToken\r\n+\r\n+    * def groupKarate =\r\n+\"\"\"\r\n+{\r\n+  \"id\" : \"groupKarateDeleteUserCards\",\r\n+  \"name\" : \"groupKarate name\",\r\n+  \"description\" : \"groupKarate description\"\r\n+}\r\n+\"\"\"\r\n+\r\n+\r\n+    * def perimeter =\r\n+\"\"\"\r\n+{\r\n+  \"id\" : \"perimeterKarateDeleteUserCards\",\r\n+  \"process\" : \"processDeleteUserCard\",\r\n+  \"stateRights\" : [\r\n+      {\r\n+        \"state\" : \"state1\",\r\n+        \"right\" : \"ReceiveAndWrite\"\r\n+      },\r\n+      {\r\n+        \"state\" : \"state2\",\r\n+        \"right\" : \"Receive\"\r\n+      }\r\n+  ]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def tso1operatorArray =\r\n+\"\"\"\r\n+[   \"tso1-operator\"\r\n+]\r\n+\"\"\"\r\n+    * def groupArray =\r\n+\"\"\"\r\n+[   \"groupKarateDeleteUserCards\"\r\n+]\r\n+\"\"\"\r\n+\r\n+  Scenario: Create groupKarate\r\n+    Given url opfabUrl + 'users/groups'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request groupKarate\r\n+    When method post\r\n+    Then match response.description == groupKarate.description\r\n+    And match response.name == groupKarate.name\r\n+    And match response.id == groupKarate.id\r\n+\r\n+\r\n+  Scenario: Add tso1-operator to groupKarate\r\n+    Given url opfabUrl + 'users/groups/' + groupKarate.id + '/users'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request tso1operatorArray\r\n+    When method patch\r\n+    And status 200\r\n+\r\n+\r\n+  Scenario: Create perimeter\r\n+    Given url opfabUrl + 'users/perimeters'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request perimeter\r\n+    When method post\r\n+\r\n+\r\n+  Scenario: Put groupKarate for perimeter\r\n+    Given url opfabUrl + 'users/perimeters/'+ perimeter.id + '/groups'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request groupArray\r\n+    When method put\r\n+    Then status 200\r\n+\r\n+\r\n+  Scenario: Push user card\r\n+    * def cardForDeleteOk =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"ENTITY1\",\r\n+\t\"publisherType\" : \"ENTITY\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardOk\",\r\n+\t\"state\": \"state1\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def cardForDeleteForbidden1 =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"publisherKarate\",\r\n+\t\"publisherType\" : \"EXTERNAL\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardForbidden1\",\r\n+\t\"state\": \"state1\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def cardForDeleteForbidden2 =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"ENTITY2\",\r\n+\t\"publisherType\" : \"ENTITY\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardForbidden2\",\r\n+\t\"state\": \"state1\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def cardForDeleteForbidden3 =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"ENTITY1\",\r\n+\t\"publisherType\" : \"ENTITY\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardForbidden3\",\r\n+\t\"state\": \"state2\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+# Push cardForDeleteOk\r\n+  Given url opfabPublishCardUrl + 'cards'\r\n+  And request cardForDeleteOk\r\n+  When method post\r\n+  Then status 201\r\n+  And match response.count == 1\r\n+\r\n+\r\n+# Push cardForDeleteForbidden1\r\n+  Given url opfabPublishCardUrl + 'cards'\r\n+  And request cardForDeleteForbidden1\r\n+  When method post\r\n+  Then status 201\r\n+  And match response.count == 1\r\n+\r\n+# Push cardForDeleteForbidden2\r\n+   Given url opfabPublishCardUrl + 'cards'\r\n+   And request cardForDeleteForbidden2\r\n+   When method post\r\n+   Then status 201\r\n+   And match response.count == 1\r\n+\r\n+\r\n+# Push cardForDeleteForbidden3\r\n+   Given url opfabPublishCardUrl + 'cards'\r\n+   And request cardForDeleteForbidden3\r\n+   When method post\r\n+   Then status 201\r\n+   And match response.count == 1\r\n+\r\n+\r\n+  Scenario: delete user card with no authentication, expected response 401\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardOk'\r\n+    When method delete\r\n+    Then status 401\r\n+\r\n+\r\n+  Scenario: Delete user card for a non-existent card, expected response 404\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/NonExistentUserCard'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 404\r\n+\r\n+\r\n+  Scenario: delete card not published by an entity, expected response 403\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardForbidden1'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 403\r\n+\r\n+\r\n+  Scenario: delete user card not published by an entity of the user, expected response 403\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardForbidden2'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 403\r\n+\r\n+\r\n+  Scenario: delete user card with no Write access for process/state for the user, expected response 403\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardForbidden3'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 403\r\n+\r\n+\r\n+  Scenario: delete user card, expected response 200\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardOk'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 200\r\n+\r\n+\r\n+  Scenario: delete the perimeter previously created\r\n+    Given url opfabUrl + 'users/perimeters/' + perimeter.id\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    When method delete\r\n+    Then status 200\r\n+\r\n+\r\n+  Scenario: delete the group previously created\r\n+    Given url opfabUrl + 'users/groups/' + groupKarate.id\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    When method delete\r\n+    Then status 200", "originalCommit": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzMTY0MQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502531641", "bodyText": "Done", "author": "vlo-rte", "createdAt": "2020-10-09T16:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MzUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM2ODA0Mw==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502368043", "bodyText": "Put this translation under userCard", "author": "freddidierRTE", "createdAt": "2020-10-09T11:38:10Z", "path": "ui/main/src/assets/i18n/en.json", "diffHunk": "@@ -144,7 +144,15 @@\n   \"button\": {\n     \"ok\": \"OK\",\n     \"cancel\": \"Cancel\",\n-    \"reset\": \"Reset\"\n+    \"reset\": \"Reset\",\n+    \"delete\": \"Delete\"\n+  },\n+  \"deleteCard\": {\n+    \"doYouReallyWant\": \"Do you really want to delete this card ?\",\n+    \"cardDeletedWithNoError\": \"Card deleted\",\n+    \"error\": {\n+      \"impossibleToDeleteCard\": \"Impossible to delete card for technical reasons\"\n+    }", "originalCommit": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzNDk4NQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502534985", "bodyText": "Done", "author": "vlo-rte", "createdAt": "2020-10-09T16:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM2ODA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3NDQ5OA==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502374498", "bodyText": "Remove this comment redundant with the code", "author": "freddidierRTE", "createdAt": "2020-10-09T11:52:13Z", "path": "services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/CardProcessingService.java", "diffHunk": "@@ -245,6 +270,22 @@ public void deleteCards(List<CardPublicationData> cardPublicationData) {\n         return deletedCard;\n     }\n \n+    public boolean isUserAllowedToDeleteThisCard(CardPublicationData card, CurrentUserWithPerimeters user) {\n+        List<ComputedPerimeter> perimetersOfTheUserList = user.getComputedPerimeters();\n+        List<String>            entitiesOfTheUserList   = user.getUserData().getEntities();\n+\n+        if ((card.getPublisherType() == PublisherTypeEnum.ENTITY) &&    //1st check : card.publisherType == ENTITY", "originalCommit": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzNjkzMg==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502536932", "bodyText": "As discussed, I've put the comments above the method.", "author": "vlo-rte", "createdAt": "2020-10-09T16:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3NDQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ1MzU1OQ==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502453559", "bodyText": "add here  a message in the card", "author": "freddidierRTE", "createdAt": "2020-10-09T14:08:43Z", "path": "ui/main/src/app/modules/cards/components/detail/detail.component.ts", "diffHunk": "@@ -488,6 +532,35 @@ export class DetailComponent implements OnChanges, OnInit, OnDestroy, AfterViewC\n         }\n     }\n \n+    confirmDeleteCard(): void {\n+        this.cardService.deleteCard(this.card)\n+            .subscribe(\n+                resp => {\n+                    this.messageAfterDeletingCard = '';\n+                    const status = resp.status;\n+                    if (status === 200) {\n+                        this.messageAfterDeletingCard = 'deleteCard.cardDeletedWithNoError';\n+                    } else {\n+                        console.log('Impossible to delete card , error status from service : ', status);\n+                        this.messageAfterDeletingCard = 'deleteCard.error.impossibleToDeleteCard';\n+                    }\n+\n+                    this.modalRef.close();\n+                    this.closeDetails();\n+                    this.displayDeleteResult = true;\n+                },\n+                err => {\n+                    console.error('Error when deleting card :', err);\n+                    this.modalRef.close();", "originalCommit": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEwNjY0Mw==", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r503106643", "bodyText": "Adding of 2 popups to display the result of deleting card.\nDone", "author": "vlo-rte", "createdAt": "2020-10-12T07:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ1MzU1OQ=="}], "type": "inlineReview"}, {"oid": "ab350e28ca417fa71d50a0625933a83130137110", "url": "https://github.com/opfab/operatorfabric-core/commit/ab350e28ca417fa71d50a0625933a83130137110", "message": "[OC-1092] adding of 2 popups for result of deleting card", "committedDate": "2020-10-12T07:54:54Z", "type": "forcePushed"}, {"oid": "193520e8202436f95927dfb87c1d0e4a70006d55", "url": "https://github.com/opfab/operatorfabric-core/commit/193520e8202436f95927dfb87c1d0e4a70006d55", "message": "[OC-1092] Delete a card from the UI", "committedDate": "2020-10-12T08:00:26Z", "type": "forcePushed"}, {"oid": "5a21fe31658174b59464f5ea6f40c59820edd989", "url": "https://github.com/opfab/operatorfabric-core/commit/5a21fe31658174b59464f5ea6f40c59820edd989", "message": "[OC-1092] Delete a card from the UI", "committedDate": "2020-10-12T08:34:08Z", "type": "commit"}, {"oid": "5a21fe31658174b59464f5ea6f40c59820edd989", "url": "https://github.com/opfab/operatorfabric-core/commit/5a21fe31658174b59464f5ea6f40c59820edd989", "message": "[OC-1092] Delete a card from the UI", "committedDate": "2020-10-12T08:34:08Z", "type": "forcePushed"}, {"oid": "456cec44f748b07e4964253692906dfb14acc813", "url": "https://github.com/opfab/operatorfabric-core/commit/456cec44f748b07e4964253692906dfb14acc813", "message": "Merge branch 'develop' into OC-1092", "committedDate": "2020-10-12T12:49:23Z", "type": "commit"}]}