{"pr_number": 9281, "pr_title": "KAFKA-10478: Allow duplicated ports in advertised.listeners", "pr_createdAt": "2020-09-12T15:16:17Z", "pr_url": "https://github.com/apache/kafka/pull/9281", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1ODY4Nw==", "url": "https://github.com/apache/kafka/pull/9281#discussion_r492058687", "bodyText": "I would suggest to use named parameter or an enum for the booleans to improve readability.", "author": "viktorsomogyi", "createdAt": "2020-09-21T13:47:58Z", "path": "core/src/main/scala/kafka/server/KafkaConfig.scala", "diffHunk": "@@ -1686,9 +1686,9 @@ class KafkaConfig(val props: java.util.Map[_, _], doLog: Boolean, dynamicConfigO\n   def advertisedListeners: Seq[EndPoint] = {\n     val advertisedListenersProp = getString(KafkaConfig.AdvertisedListenersProp)\n     if (advertisedListenersProp != null)\n-      CoreUtils.listenerListToEndPoints(advertisedListenersProp, listenerSecurityProtocolMap)\n+      CoreUtils.listenerListToEndPoints(advertisedListenersProp, listenerSecurityProtocolMap, false)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY3MDcxNA==", "url": "https://github.com/apache/kafka/pull/9281#discussion_r494670714", "bodyText": "Updated", "author": "asdaraujo", "createdAt": "2020-09-24T23:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1ODY4Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwOTI2MQ==", "url": "https://github.com/apache/kafka/pull/9281#discussion_r498109261", "bodyText": "Can we use something like:\nassertTrue(caught.getMessage.contains(\"Each listener must have a different port\"))\n\nThat way we don't need to import hamcrest and only use junit.\nThis can be applied to all assertThat() added in this PR", "author": "mimaison", "createdAt": "2020-10-01T09:31:22Z", "path": "core/src/test/scala/unit/kafka/server/KafkaConfigTest.scala", "diffHunk": "@@ -218,16 +220,26 @@ class KafkaConfigTest {\n     props.put(KafkaConfig.ZkConnectProp, \"localhost:2181\")\n \n     // listeners with duplicate port\n-    props.put(KafkaConfig.ListenersProp, \"PLAINTEXT://localhost:9091,TRACE://localhost:9091\")\n-    assertFalse(isValidKafkaConfig(props))\n+    props.put(KafkaConfig.ListenersProp, \"PLAINTEXT://localhost:9091,SSL://localhost:9091\")\n+    var caught = intercept[IllegalArgumentException] { KafkaConfig.fromProps(props) }\n+    assertThat(caught.getMessage(), containsString(\"Each listener must have a different port\"))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwMjQ1Mw==", "url": "https://github.com/apache/kafka/pull/9281#discussion_r498402453", "bodyText": "Nice. I'll change that.", "author": "asdaraujo", "createdAt": "2020-10-01T17:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwOTI2MQ=="}], "type": "inlineReview"}, {"oid": "0a3fc36829164e4556794d813ead649c33c9dd9e", "url": "https://github.com/apache/kafka/commit/0a3fc36829164e4556794d813ead649c33c9dd9e", "message": "KAFKA-10478: Allow duplicated ports in advertised.listeners\n\nRemove the requirement for unique port numbers for the advertised.listener parameters.\nThis restriction makes for the listeners parameter but there's not reason to apply the\nsame logic for advertised.listeners.\n\nBeing able to do this opens possibilities for some practical applications when using\nKerberos authentication. For example, when configuring Kafka using Kerberos authentication\nand a Load Balancer we need to have two SASL_SSL listeners: (A) one running with the\nkafka/hostname principal and (B) another using kafka/lb_name, which is necessary for\nproper authentication when using the LB FQDN. After bootstrap, though, the client receives\nthe brokers' addresses with the actual host FQDNs advertised by the brokers. To connect\nto the brokerd using the hostnames the client must connect to the listener A to be able to\nauthenticate successfully with Kerberos.\n\nAuthor: Andre Araujo <asdaraujo@gmail.com>", "committedDate": "2020-10-01T17:31:26Z", "type": "commit"}, {"oid": "0a3fc36829164e4556794d813ead649c33c9dd9e", "url": "https://github.com/apache/kafka/commit/0a3fc36829164e4556794d813ead649c33c9dd9e", "message": "KAFKA-10478: Allow duplicated ports in advertised.listeners\n\nRemove the requirement for unique port numbers for the advertised.listener parameters.\nThis restriction makes for the listeners parameter but there's not reason to apply the\nsame logic for advertised.listeners.\n\nBeing able to do this opens possibilities for some practical applications when using\nKerberos authentication. For example, when configuring Kafka using Kerberos authentication\nand a Load Balancer we need to have two SASL_SSL listeners: (A) one running with the\nkafka/hostname principal and (B) another using kafka/lb_name, which is necessary for\nproper authentication when using the LB FQDN. After bootstrap, though, the client receives\nthe brokers' addresses with the actual host FQDNs advertised by the brokers. To connect\nto the brokerd using the hostnames the client must connect to the listener A to be able to\nauthenticate successfully with Kerberos.\n\nAuthor: Andre Araujo <asdaraujo@gmail.com>", "committedDate": "2020-10-01T17:31:26Z", "type": "forcePushed"}]}