{"pr_number": 9499, "pr_title": "KAFKA-10470: Zstd upgrade and buffering", "pr_createdAt": "2020-10-26T03:19:44Z", "pr_url": "https://github.com/apache/kafka/pull/9499", "timeline": [{"oid": "8429ffc6860291f98de7a5d81f33c33688e7a6b3", "url": "https://github.com/apache/kafka/commit/8429ffc6860291f98de7a5d81f33c33688e7a6b3", "message": "Use new version of zstd-jni", "committedDate": "2020-10-26T01:24:16Z", "type": "commit"}, {"oid": "9bf3dce45cce37680abdfba17ad85d625987cea1", "url": "https://github.com/apache/kafka/commit/9bf3dce45cce37680abdfba17ad85d625987cea1", "message": "add buffering for zstd-jni", "committedDate": "2020-10-26T01:24:32Z", "type": "commit"}, {"oid": "87d625fd38e79df43053e4812820cfe53e928757", "url": "https://github.com/apache/kafka/commit/87d625fd38e79df43053e4812820cfe53e928757", "message": "remove gzip-specific comments", "committedDate": "2020-10-26T03:26:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNjI5OQ==", "url": "https://github.com/apache/kafka/pull/9499#discussion_r511726299", "bodyText": "Is BufferedOutputStream good to other compression also?", "author": "chia7712", "createdAt": "2020-10-26T05:29:12Z", "path": "clients/src/main/java/org/apache/kafka/common/record/CompressionType.java", "diffHunk": "@@ -119,7 +119,9 @@ public InputStream wrapForInput(ByteBuffer inputBuffer, byte messageVersion, Buf\n         @Override\n         public OutputStream wrapForOutput(ByteBufferOutputStream buffer, byte messageVersion) {\n             try {\n-                return (OutputStream) ZstdConstructors.OUTPUT.invoke(buffer);\n+                // Set input buffer (uncompressed) to 16 KB (none by default) to ensure reasonable performance\n+                // in cases where the caller passes a small number of bytes to write (potentially a single byte)\n+                return new BufferedOutputStream((OutputStream) ZstdConstructors.OUTPUT.invoke(buffer), 16 * 1024);", "originalCommit": "87d625fd38e79df43053e4812820cfe53e928757", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA0NTc2OA==", "url": "https://github.com/apache/kafka/pull/9499#discussion_r512045768", "bodyText": "This should be safe. It is used already in this file to wrap the GZIPOutputStream which also does not buffer uncompressed data prior to compression.", "author": "yuzawa-san", "createdAt": "2020-10-26T15:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNjI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1NDAzNw==", "url": "https://github.com/apache/kafka/pull/9499#discussion_r512054037", "bodyText": "This change means we are using the recycling buffer pool, right? I think we should be passing our own buffer pool.", "author": "ijuma", "createdAt": "2020-10-26T15:32:53Z", "path": "gradle/dependencies.gradle", "diffHunk": "@@ -116,7 +116,7 @@ versions += [\n   testRetryPlugin: \"1.1.6\",\n   zinc: \"1.3.5\",\n   zookeeper: \"3.5.8\",\n-  zstd: \"1.4.5-6\"\n+  zstd: \"1.4.5-8\"", "originalCommit": "87d625fd38e79df43053e4812820cfe53e928757", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1NjAwMw==", "url": "https://github.com/apache/kafka/pull/9499#discussion_r512056003", "bodyText": "Ah, you explained this in the PR description. Let me think about that.", "author": "ijuma", "createdAt": "2020-10-26T15:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1NDAzNw=="}], "type": "inlineReview"}, {"oid": "9d827c512ea72fb786e43071d411bcce07b386b8", "url": "https://github.com/apache/kafka/commit/9d827c512ea72fb786e43071d411bcce07b386b8", "message": "use newer zstd-jni", "committedDate": "2020-10-26T19:24:05Z", "type": "commit"}, {"oid": "ba2ae15b6b3ecad33d1805bd24d9bb34c4965e4e", "url": "https://github.com/apache/kafka/commit/ba2ae15b6b3ecad33d1805bd24d9bb34c4965e4e", "message": "Merge remote-tracking branch 'upstream/trunk' into zstd-optimizations", "committedDate": "2020-10-27T13:24:56Z", "type": "commit"}, {"oid": "6161454f1ef73aa9e0e143d10d815be3063c5e3b", "url": "https://github.com/apache/kafka/commit/6161454f1ef73aa9e0e143d10d815be3063c5e3b", "message": "Merge remote-tracking branch 'upstream/trunk' into zstd-optimizations", "committedDate": "2020-11-10T13:57:56Z", "type": "commit"}, {"oid": "f7b3621ec19f75cd6f647ec2575f09c631be5fde", "url": "https://github.com/apache/kafka/commit/f7b3621ec19f75cd6f647ec2575f09c631be5fde", "message": "Update dependencies.gradle", "committedDate": "2020-11-10T14:22:18Z", "type": "commit"}, {"oid": "8a99ce230f5da5f299073fd6a2bbf1d288feeaad", "url": "https://github.com/apache/kafka/commit/8a99ce230f5da5f299073fd6a2bbf1d288feeaad", "message": "Merge remote-tracking branch 'upstream/trunk' into zstd-optimizations", "committedDate": "2020-11-10T15:13:46Z", "type": "commit"}]}