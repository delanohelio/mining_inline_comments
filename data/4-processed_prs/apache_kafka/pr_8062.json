{"pr_number": 8062, "pr_title": "KAFKA-9498; Topic validation during the topic creation triggers unnecessary TopicChange events", "pr_createdAt": "2020-02-07T20:55:03Z", "pr_url": "https://github.com/apache/kafka/pull/8062", "timeline": [{"oid": "4e9a92ad19cf0c64ca873bde0e1a930442bb57e4", "url": "https://github.com/apache/kafka/commit/4e9a92ad19cf0c64ca873bde0e1a930442bb57e4", "message": "KAFKA-9498; Topic validation during the creation trigger unnecessary TopicChange events", "committedDate": "2020-02-07T20:53:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDE1Nw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r376690157", "bodyText": "Overloads like this are generally not done in Scala since you can use default arguments. But maybe it's best to explicit here.", "author": "ijuma", "createdAt": "2020-02-08T05:52:55Z", "path": "core/src/main/scala/kafka/zk/KafkaZkClient.scala", "diffHunk": "@@ -457,18 +457,25 @@ class KafkaZkClient private[zk] (zooKeeperClient: ZooKeeperClient, isSecure: Boo\n \n   /**\n    * Gets all topics in the cluster.\n+   * @param registerWatch indicates if a what must be registered or not\n    * @return sequence of topics in the cluster.\n    */\n-  def getAllTopicsInCluster: Set[String] = {\n-    val getChildrenResponse = retryRequestUntilConnected(GetChildrenRequest(TopicsZNode.path))\n+  def getAllTopicsInCluster(registerWatch: Boolean): Set[String] = {\n+    val getChildrenResponse = retryRequestUntilConnected(\n+      GetChildrenRequest(TopicsZNode.path, registerWatch))\n     getChildrenResponse.resultCode match {\n       case Code.OK => getChildrenResponse.children.toSet\n       case Code.NONODE => Set.empty\n       case _ => throw getChildrenResponse.resultException.get\n     }\n-\n   }\n \n+  /**\n+   * Gets all topics in the cluster. It does not register a watch.\n+   * @return sequence of topics in the cluster.\n+   */\n+  def getAllTopicsInCluster(): Set[String] = getAllTopicsInCluster(false)", "originalCommit": "4e9a92ad19cf0c64ca873bde0e1a930442bb57e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkxNjA2Mw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r376916063", "bodyText": "Right. I have kept this method one because it is called from Java as well where default arguments do not work.", "author": "dajac", "createdAt": "2020-02-10T08:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5NzM1Mw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r378397353", "bodyText": "What Java code?", "author": "ijuma", "createdAt": "2020-02-12T17:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzQzNw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r378417437", "bodyText": "It is used in org.apache.kafka.streams.integration.utils.EmbeddedKafkaCluster.", "author": "dajac", "createdAt": "2020-02-12T17:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQyMTI1Ng==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r378421256", "bodyText": "We could use the other method there and pass false but I felt that it is more convenient like this.", "author": "dajac", "createdAt": "2020-02-12T18:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MjMyOA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r378742328", "bodyText": "I have removed it finally. It is cleaner.", "author": "dajac", "createdAt": "2020-02-13T09:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDIzNg==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r376690236", "bodyText": "This seems unnecessary given where we use this a few lines above.", "author": "ijuma", "createdAt": "2020-02-08T05:54:38Z", "path": "core/src/main/scala/kafka/zookeeper/ZooKeeperClient.scala", "diffHunk": "@@ -497,45 +497,61 @@ sealed trait AsyncRequest {\n   type Response <: AsyncResponse\n   def path: String\n   def ctx: Option[Any]\n+  def registerWatch: Boolean", "originalCommit": "4e9a92ad19cf0c64ca873bde0e1a930442bb57e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkxNjI1NA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r376916254", "bodyText": "I agree. I have removed it.", "author": "dajac", "createdAt": "2020-02-10T08:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MDIzNg=="}], "type": "inlineReview"}, {"oid": "5496c7a4972e21eccfc3ec902afb125c1556f5fe", "url": "https://github.com/apache/kafka/commit/5496c7a4972e21eccfc3ec902afb125c1556f5fe", "message": "simplify implementation", "committedDate": "2020-02-10T08:06:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Nzk5MA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r378397990", "bodyText": "I would remove the default since it has serious implications. It should be chosen explicitly.", "author": "ijuma", "createdAt": "2020-02-12T17:21:53Z", "path": "core/src/main/scala/kafka/zookeeper/ZooKeeperClient.scala", "diffHunk": "@@ -528,7 +528,7 @@ case class SetAclRequest(path: String, acl: Seq[ACL], version: Int, ctx: Option[\n   type Response = SetAclResponse\n }\n \n-case class GetChildrenRequest(path: String, ctx: Option[Any] = None) extends AsyncRequest {\n+case class GetChildrenRequest(path: String, registerWatch: Boolean = true, ctx: Option[Any] = None) extends AsyncRequest {", "originalCommit": "5496c7a4972e21eccfc3ec902afb125c1556f5fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxNzYwMA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r378417600", "bodyText": "That's a fair point. Let me remove it.", "author": "dajac", "createdAt": "2020-02-12T17:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM5Nzk5MA=="}], "type": "inlineReview"}, {"oid": "167db190cb4a33c092d8aa690b0224dd2572555b", "url": "https://github.com/apache/kafka/commit/167db190cb4a33c092d8aa690b0224dd2572555b", "message": "refactor", "committedDate": "2020-02-13T09:15:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMTY5OQ==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r381431699", "bodyText": "Do we need the // ?", "author": "junrao", "createdAt": "2020-02-19T17:34:05Z", "path": "core/src/main/scala/kafka/zk/KafkaZkClient.scala", "diffHunk": "@@ -457,18 +457,25 @@ class KafkaZkClient private[zk] (zooKeeperClient: ZooKeeperClient, isSecure: Boo\n \n   /**\n    * Gets all topics in the cluster.\n+   * @param registerWatch indicates if a what must be registered or not\n    * @return sequence of topics in the cluster.\n    */\n-  def getAllTopicsInCluster: Set[String] = {\n-    val getChildrenResponse = retryRequestUntilConnected(GetChildrenRequest(TopicsZNode.path))\n+  def getAllTopicsInCluster(registerWatch: Boolean = false): Set[String] = {\n+    val getChildrenResponse = retryRequestUntilConnected(\n+      GetChildrenRequest(TopicsZNode.path, registerWatch))\n     getChildrenResponse.resultCode match {\n       case Code.OK => getChildrenResponse.children.toSet\n       case Code.NONODE => Set.empty\n       case _ => throw getChildrenResponse.resultException.get\n     }\n-\n   }\n \n+  /**\n+   * Gets all topics in the cluster. It does not register a watch.\n+   * @return sequence of topics in the cluster.\n+   */\n+//  def getAllTopicsInCluster(): Set[String] = getAllTopicsInCluster(false)", "originalCommit": "167db190cb4a33c092d8aa690b0224dd2572555b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNjMwMg==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382226302", "bodyText": "I have removed it entirely as it is not used.", "author": "dajac", "createdAt": "2020-02-20T19:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMTY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzNzgwNA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r381437804", "bodyText": "what => watch?", "author": "junrao", "createdAt": "2020-02-19T17:44:44Z", "path": "core/src/main/scala/kafka/zk/KafkaZkClient.scala", "diffHunk": "@@ -457,18 +457,25 @@ class KafkaZkClient private[zk] (zooKeeperClient: ZooKeeperClient, isSecure: Boo\n \n   /**\n    * Gets all topics in the cluster.\n+   * @param registerWatch indicates if a what must be registered or not", "originalCommit": "167db190cb4a33c092d8aa690b0224dd2572555b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1NDA1NQ==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r381454055", "bodyText": "This means this unit test always needs to wait for 5 secs? That's probably too long.", "author": "junrao", "createdAt": "2020-02-19T18:14:17Z", "path": "core/src/test/scala/unit/kafka/zookeeper/ZooKeeperClientTest.scala", "diffHunk": "@@ -421,13 +421,39 @@ class ZooKeeperClientTest extends ZooKeeperTestHarness {\n     val createResponse = zooKeeperClient.handleRequest(CreateRequest(mockPath, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n     assertEquals(\"Response code for create should be OK\", Code.OK, createResponse.resultCode)\n     zooKeeperClient.registerZNodeChildChangeHandler(zNodeChildChangeHandler)\n-    val getChildrenResponse = zooKeeperClient.handleRequest(GetChildrenRequest(mockPath))\n+    val getChildrenResponse = zooKeeperClient.handleRequest(GetChildrenRequest(mockPath, registerWatch = true))\n     assertEquals(\"Response code for getChildren should be OK\", Code.OK, getChildrenResponse.resultCode)\n     val createResponseChild1 = zooKeeperClient.handleRequest(CreateRequest(child1Path, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n     assertEquals(\"Response code for create child1 should be OK\", Code.OK, createResponseChild1.resultCode)\n     assertTrue(\"Failed to receive child change notification\", zNodeChildChangeHandlerCountDownLatch.await(5, TimeUnit.SECONDS))\n   }\n \n+  @Test\n+  def testZNodeChildChangeHandlerForChildChangeNotTriggered(): Unit = {\n+    import scala.collection.JavaConverters._\n+    val zNodeChildChangeHandlerCountDownLatch = new CountDownLatch(1)\n+    val zNodeChildChangeHandler = new ZNodeChildChangeHandler {\n+      override def handleChildChange(): Unit = {\n+        zNodeChildChangeHandlerCountDownLatch.countDown()\n+      }\n+      override val path: String = mockPath\n+    }\n+\n+    val child1 = \"child1\"\n+    val child1Path = mockPath + \"/\" + child1\n+    val createResponse = zooKeeperClient.handleRequest(\n+      CreateRequest(mockPath, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    assertEquals(\"Response code for create should be OK\", Code.OK, createResponse.resultCode)\n+    zooKeeperClient.registerZNodeChildChangeHandler(zNodeChildChangeHandler)\n+    val getChildrenResponse = zooKeeperClient.handleRequest(GetChildrenRequest(mockPath, registerWatch = false))\n+    assertEquals(\"Response code for getChildren should be OK\", Code.OK, getChildrenResponse.resultCode)\n+    val createResponseChild1 = zooKeeperClient.handleRequest(\n+      CreateRequest(child1Path, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    assertEquals(\"Response code for create child1 should be OK\", Code.OK, createResponseChild1.resultCode)\n+    assertFalse(\"Child change notification received\",\n+      zNodeChildChangeHandlerCountDownLatch.await(5, TimeUnit.SECONDS))", "originalCommit": "167db190cb4a33c092d8aa690b0224dd2572555b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNjU3Ng==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382226576", "bodyText": "Correct. I have reduced it to 1s.", "author": "dajac", "createdAt": "2020-02-20T19:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1NDA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1NjU4Nw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r381456587", "bodyText": "This means this unit test always needs to wait for 5 secs? That's probably too long.", "author": "junrao", "createdAt": "2020-02-19T18:18:44Z", "path": "core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala", "diffHunk": "@@ -194,7 +194,56 @@ class KafkaZkClientTest extends ZooKeeperTestHarness {\n \n     zkClient.createTopicAssignment(topic2, secondAssignment)\n \n-    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster.toSet)\n+    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster())\n+  }\n+\n+  @Test\n+  def testGetAllTopicsInClusterTriggersWatch(): Unit = {\n+    zkClient.createTopLevelPaths()\n+    val latch = registerChildChangeHandler(1)\n+\n+    // Listing all the topics and register the watch\n+    assertTrue(zkClient.getAllTopicsInCluster(true).isEmpty)\n+\n+    // Verifies that listing all topics without registering the watch does\n+    // not interfere with the previous registered watcher\n+    assertTrue(zkClient.getAllTopicsInCluster(false).isEmpty)\n+\n+    zkClient.createTopicAssignment(topic1, Map.empty)\n+\n+    assertTrue(\"Failed to receive watch notification\",\n+      latch.await(5, TimeUnit.SECONDS))\n+\n+    assertTrue(zkClient.topicExists(topic1))\n+  }\n+\n+  @Test\n+  def testGetAllTopicsInClusterDoesNotTriggerWatch(): Unit = {\n+    zkClient.createTopLevelPaths()\n+    val latch = registerChildChangeHandler(1)\n+\n+    // Listing all the topics and don't register the watch\n+    assertTrue(zkClient.getAllTopicsInCluster(false).isEmpty)\n+\n+    zkClient.createTopicAssignment(topic1, Map.empty)\n+\n+    assertFalse(\"Received watch notification\",", "originalCommit": "167db190cb4a33c092d8aa690b0224dd2572555b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNjcyMA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382226720", "bodyText": "Correct. I have reduced it to 1s.", "author": "dajac", "createdAt": "2020-02-20T20:00:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1NjU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1NjkwMw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r381456903", "bodyText": "Could this method be private?", "author": "junrao", "createdAt": "2020-02-19T18:19:16Z", "path": "core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala", "diffHunk": "@@ -194,7 +194,56 @@ class KafkaZkClientTest extends ZooKeeperTestHarness {\n \n     zkClient.createTopicAssignment(topic2, secondAssignment)\n \n-    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster.toSet)\n+    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster())\n+  }\n+\n+  @Test\n+  def testGetAllTopicsInClusterTriggersWatch(): Unit = {\n+    zkClient.createTopLevelPaths()\n+    val latch = registerChildChangeHandler(1)\n+\n+    // Listing all the topics and register the watch\n+    assertTrue(zkClient.getAllTopicsInCluster(true).isEmpty)\n+\n+    // Verifies that listing all topics without registering the watch does\n+    // not interfere with the previous registered watcher\n+    assertTrue(zkClient.getAllTopicsInCluster(false).isEmpty)\n+\n+    zkClient.createTopicAssignment(topic1, Map.empty)\n+\n+    assertTrue(\"Failed to receive watch notification\",\n+      latch.await(5, TimeUnit.SECONDS))\n+\n+    assertTrue(zkClient.topicExists(topic1))\n+  }\n+\n+  @Test\n+  def testGetAllTopicsInClusterDoesNotTriggerWatch(): Unit = {\n+    zkClient.createTopLevelPaths()\n+    val latch = registerChildChangeHandler(1)\n+\n+    // Listing all the topics and don't register the watch\n+    assertTrue(zkClient.getAllTopicsInCluster(false).isEmpty)\n+\n+    zkClient.createTopicAssignment(topic1, Map.empty)\n+\n+    assertFalse(\"Received watch notification\",\n+      latch.await(5, TimeUnit.SECONDS))\n+\n+    assertTrue(zkClient.topicExists(topic1))\n+  }\n+\n+  def registerChildChangeHandler(count: Int): CountDownLatch = {", "originalCommit": "167db190cb4a33c092d8aa690b0224dd2572555b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNjgxMQ==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382226811", "bodyText": "Yes. Changed.", "author": "dajac", "createdAt": "2020-02-20T20:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1NjkwMw=="}], "type": "inlineReview"}, {"oid": "a20cc84408c7fa5a2e7aeba1cebedcf953a8952a", "url": "https://github.com/apache/kafka/commit/a20cc84408c7fa5a2e7aeba1cebedcf953a8952a", "message": "Address Jun's comments", "committedDate": "2020-02-20T19:58:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwMjEyMw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382302123", "bodyText": "A unit test always taking 1 sec is still long. Could we reduce this to 100ms?", "author": "junrao", "createdAt": "2020-02-20T22:48:07Z", "path": "core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala", "diffHunk": "@@ -194,7 +194,56 @@ class KafkaZkClientTest extends ZooKeeperTestHarness {\n \n     zkClient.createTopicAssignment(topic2, secondAssignment)\n \n-    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster.toSet)\n+    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster())\n+  }\n+\n+  @Test\n+  def testGetAllTopicsInClusterTriggersWatch(): Unit = {\n+    zkClient.createTopLevelPaths()\n+    val latch = registerChildChangeHandler(1)\n+\n+    // Listing all the topics and register the watch\n+    assertTrue(zkClient.getAllTopicsInCluster(true).isEmpty)\n+\n+    // Verifies that listing all topics without registering the watch does\n+    // not interfere with the previous registered watcher\n+    assertTrue(zkClient.getAllTopicsInCluster(false).isEmpty)\n+\n+    zkClient.createTopicAssignment(topic1, Map.empty)\n+\n+    assertTrue(\"Failed to receive watch notification\",\n+      latch.await(1, TimeUnit.SECONDS))\n+\n+    assertTrue(zkClient.topicExists(topic1))\n+  }\n+\n+  @Test\n+  def testGetAllTopicsInClusterDoesNotTriggerWatch(): Unit = {\n+    zkClient.createTopLevelPaths()\n+    val latch = registerChildChangeHandler(1)\n+\n+    // Listing all the topics and don't register the watch\n+    assertTrue(zkClient.getAllTopicsInCluster(false).isEmpty)\n+\n+    zkClient.createTopicAssignment(topic1, Map.empty)\n+\n+    assertFalse(\"Received watch notification\",\n+      latch.await(1, TimeUnit.SECONDS))", "originalCommit": "a20cc84408c7fa5a2e7aeba1cebedcf953a8952a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ1MTIxNQ==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382451215", "bodyText": "I did few runs locally with 100ms and it seems to work. I have reduces it to 100ms.", "author": "dajac", "createdAt": "2020-02-21T08:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwMjEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwMjE4Ng==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382302186", "bodyText": "A unit test always taking 1 sec is still long. Could we reduce this to 100ms?", "author": "junrao", "createdAt": "2020-02-20T22:48:17Z", "path": "core/src/test/scala/unit/kafka/zookeeper/ZooKeeperClientTest.scala", "diffHunk": "@@ -418,14 +418,43 @@ class ZooKeeperClientTest extends ZooKeeperTestHarness {\n \n     val child1 = \"child1\"\n     val child1Path = mockPath + \"/\" + child1\n-    val createResponse = zooKeeperClient.handleRequest(CreateRequest(mockPath, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    val createResponse = zooKeeperClient.handleRequest(\n+      CreateRequest(mockPath, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    assertEquals(\"Response code for create should be OK\", Code.OK, createResponse.resultCode)\n+    zooKeeperClient.registerZNodeChildChangeHandler(zNodeChildChangeHandler)\n+    val getChildrenResponse = zooKeeperClient.handleRequest(GetChildrenRequest(mockPath, registerWatch = true))\n+    assertEquals(\"Response code for getChildren should be OK\", Code.OK, getChildrenResponse.resultCode)\n+    val createResponseChild1 = zooKeeperClient.handleRequest(\n+      CreateRequest(child1Path, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    assertEquals(\"Response code for create child1 should be OK\", Code.OK, createResponseChild1.resultCode)\n+    assertTrue(\"Failed to receive child change notification\",\n+      zNodeChildChangeHandlerCountDownLatch.await(1, TimeUnit.SECONDS))\n+  }\n+\n+  @Test\n+  def testZNodeChildChangeHandlerForChildChangeNotTriggered(): Unit = {\n+    import scala.collection.JavaConverters._\n+    val zNodeChildChangeHandlerCountDownLatch = new CountDownLatch(1)\n+    val zNodeChildChangeHandler = new ZNodeChildChangeHandler {\n+      override def handleChildChange(): Unit = {\n+        zNodeChildChangeHandlerCountDownLatch.countDown()\n+      }\n+      override val path: String = mockPath\n+    }\n+\n+    val child1 = \"child1\"\n+    val child1Path = mockPath + \"/\" + child1\n+    val createResponse = zooKeeperClient.handleRequest(\n+      CreateRequest(mockPath, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n     assertEquals(\"Response code for create should be OK\", Code.OK, createResponse.resultCode)\n     zooKeeperClient.registerZNodeChildChangeHandler(zNodeChildChangeHandler)\n-    val getChildrenResponse = zooKeeperClient.handleRequest(GetChildrenRequest(mockPath))\n+    val getChildrenResponse = zooKeeperClient.handleRequest(GetChildrenRequest(mockPath, registerWatch = false))\n     assertEquals(\"Response code for getChildren should be OK\", Code.OK, getChildrenResponse.resultCode)\n-    val createResponseChild1 = zooKeeperClient.handleRequest(CreateRequest(child1Path, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    val createResponseChild1 = zooKeeperClient.handleRequest(\n+      CreateRequest(child1Path, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n     assertEquals(\"Response code for create child1 should be OK\", Code.OK, createResponseChild1.resultCode)\n-    assertTrue(\"Failed to receive child change notification\", zNodeChildChangeHandlerCountDownLatch.await(5, TimeUnit.SECONDS))\n+    assertFalse(\"Child change notification received\",", "originalCommit": "a20cc84408c7fa5a2e7aeba1cebedcf953a8952a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ1MTI0MA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382451240", "bodyText": "I did few runs locally with 100ms and it seems to work. I have reduces it to 100ms.", "author": "dajac", "createdAt": "2020-02-21T08:26:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwMjE4Ng=="}], "type": "inlineReview"}, {"oid": "10a31622b4890cf3ceb8d82066f08c5f10813c39", "url": "https://github.com/apache/kafka/commit/10a31622b4890cf3ceb8d82066f08c5f10813c39", "message": "Tweak timeouts", "committedDate": "2020-02-21T08:24:57Z", "type": "commit"}, {"oid": "d372dc6547dbee59b7037c61a1b7361ecc9137f6", "url": "https://github.com/apache/kafka/commit/d372dc6547dbee59b7037c61a1b7361ecc9137f6", "message": "fixup", "committedDate": "2020-02-21T09:37:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY4NDQxMw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382684413", "bodyText": "In this case, normally the test will complete well below the timeout. So, we could set the timeout to be sth more generous like 5 secs to avoid flakiness.\nIn the other cases where the test always wait for the timeout, then we want to set the timeout to a much smaller value to control the testing time.", "author": "junrao", "createdAt": "2020-02-21T16:38:28Z", "path": "core/src/test/scala/unit/kafka/zk/KafkaZkClientTest.scala", "diffHunk": "@@ -194,7 +194,56 @@ class KafkaZkClientTest extends ZooKeeperTestHarness {\n \n     zkClient.createTopicAssignment(topic2, secondAssignment)\n \n-    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster.toSet)\n+    assertEquals(Set(topic1, topic2), zkClient.getAllTopicsInCluster())\n+  }\n+\n+  @Test\n+  def testGetAllTopicsInClusterTriggersWatch(): Unit = {\n+    zkClient.createTopLevelPaths()\n+    val latch = registerChildChangeHandler(1)\n+\n+    // Listing all the topics and register the watch\n+    assertTrue(zkClient.getAllTopicsInCluster(true).isEmpty)\n+\n+    // Verifies that listing all topics without registering the watch does\n+    // not interfere with the previous registered watcher\n+    assertTrue(zkClient.getAllTopicsInCluster(false).isEmpty)\n+\n+    zkClient.createTopicAssignment(topic1, Map.empty)\n+\n+    assertTrue(\"Failed to receive watch notification\",\n+      latch.await(100, TimeUnit.MILLISECONDS))", "originalCommit": "d372dc6547dbee59b7037c61a1b7361ecc9137f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5ODk4NA==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382698984", "bodyText": "Right. My mistake. I put them on par while trying various timeouts in order to avoid putting a value too low. I did not pay attention that I forgot to change them back.", "author": "dajac", "createdAt": "2020-02-21T17:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY4NDQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY4NDkzMw==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382684933", "bodyText": "This is another case where we can set a more generous timeout.", "author": "junrao", "createdAt": "2020-02-21T16:39:30Z", "path": "core/src/test/scala/unit/kafka/zookeeper/ZooKeeperClientTest.scala", "diffHunk": "@@ -418,14 +418,43 @@ class ZooKeeperClientTest extends ZooKeeperTestHarness {\n \n     val child1 = \"child1\"\n     val child1Path = mockPath + \"/\" + child1\n-    val createResponse = zooKeeperClient.handleRequest(CreateRequest(mockPath, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    val createResponse = zooKeeperClient.handleRequest(\n+      CreateRequest(mockPath, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    assertEquals(\"Response code for create should be OK\", Code.OK, createResponse.resultCode)\n+    zooKeeperClient.registerZNodeChildChangeHandler(zNodeChildChangeHandler)\n+    val getChildrenResponse = zooKeeperClient.handleRequest(GetChildrenRequest(mockPath, registerWatch = true))\n+    assertEquals(\"Response code for getChildren should be OK\", Code.OK, getChildrenResponse.resultCode)\n+    val createResponseChild1 = zooKeeperClient.handleRequest(\n+      CreateRequest(child1Path, Array.empty[Byte], ZooDefs.Ids.OPEN_ACL_UNSAFE.asScala, CreateMode.PERSISTENT))\n+    assertEquals(\"Response code for create child1 should be OK\", Code.OK, createResponseChild1.resultCode)\n+    assertTrue(\"Failed to receive child change notification\",\n+      zNodeChildChangeHandlerCountDownLatch.await(100, TimeUnit.MILLISECONDS))", "originalCommit": "d372dc6547dbee59b7037c61a1b7361ecc9137f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5OTA0OQ==", "url": "https://github.com/apache/kafka/pull/8062#discussion_r382699049", "bodyText": "Done.", "author": "dajac", "createdAt": "2020-02-21T17:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY4NDkzMw=="}], "type": "inlineReview"}, {"oid": "121563432c3413d213007d3cc42171ae5afd3c0c", "url": "https://github.com/apache/kafka/commit/121563432c3413d213007d3cc42171ae5afd3c0c", "message": "change timeouts", "committedDate": "2020-02-21T17:01:38Z", "type": "commit"}]}