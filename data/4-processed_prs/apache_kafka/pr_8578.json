{"pr_number": 8578, "pr_title": "KAFKA-9875: Make integration tests more resilient", "pr_createdAt": "2020-04-28T22:46:53Z", "pr_url": "https://github.com/apache/kafka/pull/8578", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2OTcxMw==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r416969713", "bodyText": "I've standardized all the usages to be just \"app\", followed by the generated name, since the generated name contains the same information that we previously hand-wrote into the prefix or suffix. All we really need to do is ensure that the app id won't collide with a group name that we might use in a verification consumer, for example. For that reason, I've never used the generated name \"plain\", but always scoped it to the usage (app id, group id, input topic, etc.).\nIt's not super important to apply these ideas universally, but I felt it would make it easier to write more tests like it in the future if I just made a full pass on all the tests to make them all look the same.", "author": "vvcephei", "createdAt": "2020-04-28T22:48:29Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/GlobalThreadShutDownOrderTest.java", "diffHunk": "@@ -101,8 +102,8 @@ public void before() throws Exception {\n         builder = new StreamsBuilder();\n         createTopics();\n         streamsConfiguration = new Properties();\n-        final String applicationId = \"global-thread-shutdown-test\" + testName.getMethodName();\n-        streamsConfiguration.put(StreamsConfig.APPLICATION_ID_CONFIG, applicationId);\n+        final String safeTestName = safeUniqueTestName(getClass(), testName);\n+        streamsConfiguration.put(StreamsConfig.APPLICATION_ID_CONFIG, \"app-\" + safeTestName);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MTAyNQ==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r416971025", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    streamsConfiguration.put(StreamsConfig.APPLICATION_ID_CONFIG, \"lag-fetch-\" + safeTestName);\n          \n          \n            \n                    streamsConfiguration.put(StreamsConfig.APPLICATION_ID_CONFIG, \"app-\" + safeTestName);", "author": "vvcephei", "createdAt": "2020-04-28T22:51:49Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/LagFetchIntegrationTest.java", "diffHunk": "@@ -88,16 +89,17 @@\n     private String stateStoreName;\n \n     @Rule\n-    public TestName name = new TestName();\n+    public TestName testName = new TestName();\n \n     @Before\n     public void before() {\n-        inputTopicName = \"input-topic-\" + name.getMethodName();\n-        outputTopicName = \"output-topic-\" + name.getMethodName();\n-        stateStoreName = \"lagfetch-test-store\" + name.getMethodName();\n+        final String safeTestName = safeUniqueTestName(getClass(), testName);\n+        inputTopicName = \"input-topic-\" + safeTestName;\n+        outputTopicName = \"output-topic-\" + safeTestName;\n+        stateStoreName = \"lagfetch-test-store\" + safeTestName;\n \n         streamsConfiguration = new Properties();\n-        streamsConfiguration.put(StreamsConfig.APPLICATION_ID_CONFIG, \"lag-fetch-\" + name.getMethodName());\n+        streamsConfiguration.put(StreamsConfig.APPLICATION_ID_CONFIG, \"lag-fetch-\" + safeTestName);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MjU3NQ==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r416972575", "bodyText": "This is really the fix for KAFKA-9875. The other change just hopefully reduces the probability that ignoring the exceptions could cause subsequent failures (e.g., if the topics don't get deleted before the next test, at least the next one will have different topic names).\nI've verified that all usages of this method are ok to ignore potential exceptions. Namely, as long as the test logic itself doesn't want to ensure that any topics got deleted, and as long as this method is the last line in the method, then it should be fine just to ignore failures here.\nI also considered just deleting the method, but if it does succeed, then it leaves less garbage around for subsequent tests, so it feels better to at least attempt a cleanup.", "author": "vvcephei", "createdAt": "2020-04-28T22:56:13Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/IntegrationTestUtils.java", "diffHunk": "@@ -145,12 +162,12 @@ public static void cleanStateBeforeTest(final EmbeddedKafkaCluster cluster, fina\n         }\n     }\n \n-    public static void cleanStateAfterTest(final EmbeddedKafkaCluster cluster, final KafkaStreams driver) {\n-        driver.cleanUp();\n+    public static void quietlyCleanStateAfterTest(final EmbeddedKafkaCluster cluster, final KafkaStreams driver) {\n         try {\n+            driver.cleanUp();\n             cluster.deleteAllTopicsAndWait(DEFAULT_TIMEOUT);\n-        } catch (final InterruptedException e) {\n-            throw new RuntimeException(e);\n+        } catch (final RuntimeException | InterruptedException e) {\n+            LOG.warn(\"Ignoring failure to clean test state\", e);\n         }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxMzk4Mw==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417013983", "bodyText": "req: Actually deleting topics after test is critical for some tests: I've encountered some cases where the same topics are reused mistakenly across different test cases within the single class. But I feel that it is better to put the topic deletion in the @after function while leaving cleanUp() as part of the test function itself.", "author": "guozhangwang", "createdAt": "2020-04-29T01:05:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NDcxMw==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417044713", "bodyText": "I share your concern, but I'm not sure about the conclusion.\nYes, if there is state (such as a topic) that leaks from one test to the next, it can certainly cause difficult-to-debug failures. However, there are multiple things we can do to prevent/mitigate it:\n\ndelete state after tests (not to leave any garbage behind)\ndelete state before the tests (to ensure a clean slate for the test)\nchoose unique names for all resources of each test (this is where the other part of this PR comes in)\n\nAny one of these should be sufficient to prevent state from leaking in between tests, and most of these tests do all three. In other words, we have 3x redundancy guarding against such test pollution. If you look at all three of these measures, the clean up after tests is actually the most optional, since tests can't tolerate failures in the clean up before (because it also creates necessary topics), and choosing unique topic names per test is bulletproof and easy to fix (once we know what the problem is).\nWhether the cleanup is part of the test or in the @After method, the outcome is the same, if the method throws an exception, the test will fail. The downside of After is that it requires you to store the topic names in mutable class-level fields, which actually makes it more awkward to choose unique names per test.", "author": "vvcephei", "createdAt": "2020-04-29T03:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU1ODA3OQ==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417558079", "bodyText": "Sounds good. I think this is convincing :)", "author": "guozhangwang", "createdAt": "2020-04-29T19:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MjU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU1ODUyOA==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417558528", "bodyText": "Whew! :)", "author": "vvcephei", "createdAt": "2020-04-29T19:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MjU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3MjcwMA==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r416972700", "bodyText": "just fixing the formatting.", "author": "vvcephei", "createdAt": "2020-04-28T22:56:33Z", "path": "streams/src/test/java/org/apache/kafka/test/StreamsTestUtils.java", "diffHunk": "@@ -106,7 +106,9 @@ public static void startKafkaStreamsAndWaitForRunningState(final KafkaStreams ka\n         kafkaStreams.start();\n         assertThat(\n             \"KafkaStreams did not transit to RUNNING state within \" + timeoutMs + \" milli seconds.\",\n-            countDownLatch.await(timeoutMs, TimeUnit.MILLISECONDS), equalTo(true));\n+            countDownLatch.await(timeoutMs, TimeUnit.MILLISECONDS),\n+            equalTo(true)\n+        );", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNDg3MQ==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417014871", "bodyText": "Somewhere else it is set as \"group-\" + safeTestName, is this change intentional?", "author": "guozhangwang", "createdAt": "2020-04-29T01:08:47Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/LagFetchIntegrationTest.java", "diffHunk": "@@ -106,7 +108,7 @@ public void before() {\n \n         consumerConfiguration = new Properties();\n         consumerConfiguration.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, CLUSTER.bootstrapServers());\n-        consumerConfiguration.setProperty(ConsumerConfig.GROUP_ID_CONFIG, name.getMethodName() + \"-consumer\");\n+        consumerConfiguration.setProperty(ConsumerConfig.GROUP_ID_CONFIG, safeTestName + \"-consumer\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NzA1NA==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417047054", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    consumerConfiguration.setProperty(ConsumerConfig.GROUP_ID_CONFIG, safeTestName + \"-consumer\");\n          \n          \n            \n                    consumerConfiguration.setProperty(ConsumerConfig.GROUP_ID_CONFIG, \"group-\" + safeTestName);\n          \n      \n    \n    \n  \n\nNo, I just got tired of messing with every tests' idiosyncrasies.", "author": "vvcephei", "createdAt": "2020-04-29T03:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNDg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTU2Mg==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417015562", "bodyText": "Is it safer to encode the appID as part of the dir path to avoid collision?", "author": "guozhangwang", "createdAt": "2020-04-29T01:11:29Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/OptimizedKTableIntegrationTest.java", "diffHunk": "@@ -215,13 +216,13 @@ public void onRestoreEnd(final TopicPartition topicPartition, final String store\n     }\n \n     private Properties streamsConfiguration() {\n-        final String applicationId = \"streamsApp\";\n+        final String safeTestName = safeUniqueTestName(getClass(), testName);\n         final Properties config = new Properties();\n         config.put(StreamsConfig.TOPOLOGY_OPTIMIZATION, StreamsConfig.OPTIMIZE);\n-        config.put(StreamsConfig.APPLICATION_ID_CONFIG, applicationId + name.getMethodName());\n+        config.put(StreamsConfig.APPLICATION_ID_CONFIG, \"app-\" + safeTestName);\n         config.put(StreamsConfig.APPLICATION_SERVER_CONFIG, \"localhost:\" + (++port));\n         config.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, cluster.bootstrapServers());\n-        config.put(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory(applicationId).getPath());\n+        config.put(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0MDIwMg==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417040202", "bodyText": "I wavered on this point, but each time you call tempDirectory, it should give you a completely new directory:\n     * Create a temporary relative directory in the default temporary-file directory with the given prefix.\n     *\n     * @param prefix The prefix of the temporary directory, if null using \"kafka-\" as default prefix\n\nSo the prefix seems to be nice only for documenting which test a directory is for, not for enforcing any kind of test/directory uniqueness. I felt like it added more noise than value, so I just dropped all the prefixes.", "author": "vvcephei", "createdAt": "2020-04-29T02:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU1ODYwNQ==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417558605", "bodyText": "Yeah I was thinking about debugging purposes as well. If it is more noise the usefulness, I'm fine with dropping it.", "author": "guozhangwang", "createdAt": "2020-04-29T19:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTgyMA==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417015820", "bodyText": "nit: we can put kafkaStreams in a try block.", "author": "guozhangwang", "createdAt": "2020-04-29T01:12:31Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/ResetPartitionTimeIntegrationTest.java", "diffHunk": "@@ -156,7 +157,7 @@ public void shouldPreservePartitionTimeOnKafkaStreamRestart() {\n             assertThat(lastRecordedTimestamp, is(5000L));\n         } finally {\n             kafkaStreams.close();\n-            cleanStateAfterTest(CLUSTER, kafkaStreams);\n+            quietlyCleanStateAfterTest(CLUSTER, kafkaStreams);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA0NjYyNA==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417046624", "bodyText": "Unfortunately, we generally can't use try-with-resources for these tests, since that makes the kafkaStreams reference out of scope for the finally block. We'd have to allow a reference to kafkaStreams to escape the try {} block to reference it either in finally or in an After method, which is just as messy as it currently is, if not more.", "author": "vvcephei", "createdAt": "2020-04-29T03:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNjA4Mg==", "url": "https://github.com/apache/kafka/pull/8578#discussion_r417016082", "bodyText": "nit: ditto here, we can put driver in the try block. And ditto elsewhere.", "author": "guozhangwang", "createdAt": "2020-04-29T01:13:37Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/SuppressionDurabilityIntegrationTest.java", "diffHunk": "@@ -243,7 +251,7 @@ public void shouldRecoverBufferAfterShutdown() {\n \n         } finally {\n             driver.close();\n-            cleanStateAfterTest(CLUSTER, driver);\n+            quietlyCleanStateAfterTest(CLUSTER, driver);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1884686387a8af57d0123deead442c98529239d5", "url": "https://github.com/apache/kafka/commit/1884686387a8af57d0123deead442c98529239d5", "message": "KAFKA-9875: Make integration tests more resilient", "committedDate": "2020-04-29T19:48:39Z", "type": "commit"}]}