{"pr_number": 8018, "pr_title": "KAFKA-9480: Fix bug that prevented to measure task-level process-rate", "pr_createdAt": "2020-01-29T04:31:43Z", "pr_url": "https://github.com/apache/kafka/pull/8018", "timeline": [{"oid": "fe38b6f75fe12bed65b7c8efadc7d7bb41523e4a", "url": "https://github.com/apache/kafka/commit/fe38b6f75fe12bed65b7c8efadc7d7bb41523e4a", "message": "KAFKA-9480: Fix bug that prevented to measure task-level process-rate", "committedDate": "2020-01-29T04:27:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NDc0MA==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r372184740", "bodyText": "Had to make this public to verify parents in the unit test.", "author": "cadonna", "createdAt": "2020-01-29T04:33:07Z", "path": "clients/src/main/java/org/apache/kafka/common/metrics/Sensor.java", "diffHunk": "@@ -135,7 +135,7 @@ public String name() {\n         return this.name;\n     }\n \n-    List<Sensor> parents() {\n+    public List<Sensor> parents() {", "originalCommit": "fe38b6f75fe12bed65b7c8efadc7d7bb41523e4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NTcyOA==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r372185728", "bodyText": "This is the fix. If the parent class ProcessorNode is initialised before the the actual sensor node an empty sensor without parent is created in ProcessorNode#init() due to backwards compatibility. Thus, on source nodes we need to first call the initialisation of the source node before we call the initialisation in the parent class.", "author": "cadonna", "createdAt": "2020-01-29T04:39:34Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/SourceNode.java", "diffHunk": "@@ -66,14 +66,14 @@ V deserializeValue(final String topic, final Headers headers, final byte[] data)\n     @SuppressWarnings(\"unchecked\")\n     @Override\n     public void init(final InternalProcessorContext context) {\n-        super.init(context);\n-        this.context = context;\n         processAtSourceSensor = ProcessorNodeMetrics.processorAtSourceSensorOrForwardSensor(\n             Thread.currentThread().getName(),\n             context.taskId().toString(),\n             context.currentNode().name(),\n             context.metrics()\n         );\n+        super.init(context);\n+        this.context = context;\n ", "originalCommit": "fe38b6f75fe12bed65b7c8efadc7d7bb41523e4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwNjQyMA==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r375506420", "bodyText": "I think it's worth to add a comment about this (even if we have a test now)", "author": "mjsax", "createdAt": "2020-02-05T21:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NTcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI5MTMxNA==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r377291314", "bodyText": "Done", "author": "cadonna", "createdAt": "2020-02-10T20:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NTcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NTk0Ng==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r372185946", "bodyText": "This verification tests the correct wiring of the node-level sensor with its task-level sensor.", "author": "cadonna", "createdAt": "2020-01-29T04:40:53Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/SourceNodeTest.java", "diffHunk": "@@ -112,6 +115,14 @@ private void shouldExposeProcessMetrics(final String builtInMetricsVersion) {\n             final String parentGroupName = \"stream-task-metrics\";\n             assertTrue(StreamsTestUtils.containsMetric(metrics, \"process-rate\", parentGroupName, metricTags));\n             assertTrue(StreamsTestUtils.containsMetric(metrics, \"process-total\", parentGroupName, metricTags));\n+\n+            final String sensorNamePrefix = \"internal.\" + threadId + \".task.\" + context.taskId().toString();\n+            final Sensor processSensor =\n+                metrics.getSensor(sensorNamePrefix + \".node.\" + context.currentNode().name() + \".s.process\");\n+            assertThat(\n+                processSensor.parents().stream().map(Sensor::name).collect(Collectors.toList()),\n+                contains(sensorNamePrefix + \".s.process\")\n+            );", "originalCommit": "fe38b6f75fe12bed65b7c8efadc7d7bb41523e4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6332a238cc2986ca4aa76d1c50534d41aac3cf50", "url": "https://github.com/apache/kafka/commit/6332a238cc2986ca4aa76d1c50534d41aac3cf50", "message": "Add accessor for `Sensor`'s package-private members", "committedDate": "2020-01-31T20:53:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4MzEyMQ==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r373683121", "bodyText": "This accessor enables the unit test to access package-private member parents() of class Sensor without the need to modify Sensor's public API. (kudos to @vvcephei for the idea)", "author": "cadonna", "createdAt": "2020-01-31T21:00:37Z", "path": "streams/src/test/java/org/apache/kafka/common/metrics/SensorAccessor.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.metrics;\n+", "originalCommit": "6332a238cc2986ca4aa76d1c50534d41aac3cf50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAzNDY3NA==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r376034674", "bodyText": "o.a.k.common.metrics is considered a semi-public package, do we have to make this package?", "author": "guozhangwang", "createdAt": "2020-02-06T19:25:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4MzEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI5MjYwOQ==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r377292609", "bodyText": "Does semi-public package mean, we do not need a KIP to change it? My first push to this PR just made parents() public instead of package-private. Afterwards I realized that Sensor is a public API.", "author": "cadonna", "createdAt": "2020-02-10T20:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4MzEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxNTc2NQ==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r377315765", "bodyText": "Actually I think I'm wrong: checking https://kafka.apache.org/24/javadoc/index.html here the o.a.k.common.metrics is not listed, only Metric and MetricName under o.a.k.common are listed in javadocs. So this should be fine.", "author": "guozhangwang", "createdAt": "2020-02-10T21:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4MzEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUxOTI5Nw==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r377519297", "bodyText": "But wouldn't that mean, I could simply make parents() public without the need of the accessor class?", "author": "cadonna", "createdAt": "2020-02-11T09:28:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4MzEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg1MzU2OA==", "url": "https://github.com/apache/kafka/pull/8018#discussion_r377853568", "bodyText": "Yeah I think that's right: Sensor is not a public API either.", "author": "guozhangwang", "createdAt": "2020-02-11T19:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4MzEyMQ=="}], "type": "inlineReview"}, {"oid": "daa04a720cd4f87476195c2c93d2d28c22a34529", "url": "https://github.com/apache/kafka/commit/daa04a720cd4f87476195c2c93d2d28c22a34529", "message": "Add comment reagrding the order of initialization", "committedDate": "2020-02-10T20:12:49Z", "type": "commit"}]}