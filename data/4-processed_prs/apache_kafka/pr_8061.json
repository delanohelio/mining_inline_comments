{"pr_number": 8061, "pr_title": "KAFKA-9517: Fix default serdes with FK join", "pr_createdAt": "2020-02-07T19:30:45Z", "pr_url": "https://github.com/apache/kafka/pull/8061", "timeline": [{"oid": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "url": "https://github.com/apache/kafka/commit/0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "message": "KAFKA-9517: Fix default serdes with FK join", "committedDate": "2020-02-07T19:28:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3MDU4Mw==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376570583", "bodyText": "FK Join serialization utilities face the same challenge that we previously addressed in Changed(De)Serializer. Namely, that the wrapper (de)serializer is constructed during topology building, before the default serdes are available from config, so it needs to have a mechanism for updating the inner serde at run time, once the default serde is available.\nFK Join actually introduces several of these wrapper serdes, so rather than just pile on extra type-check branches, I created the concept of a (De)Serializer that wraps potentially null (De)Serializers. In the case that the inner serde is null, it could be set (once) to the default serde.", "author": "vvcephei", "createdAt": "2020-02-07T19:37:24Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/SinkNode.java", "diffHunk": "@@ -66,10 +66,10 @@ public void init(final InternalProcessorContext context) {\n             valSerializer = (Serializer<V>) context.valueSerde().serializer();\n         }\n \n-        // if value serializers are for {@code Change} values, set the inner serializer when necessary\n-        if (valSerializer instanceof ChangedSerializer &&\n-                ((ChangedSerializer) valSerializer).inner() == null) {\n-            ((ChangedSerializer) valSerializer).setInner(context.valueSerde().serializer());\n+        // if value serializers are internal wrapping serializers that may need to be given the default serializer\n+        // then pass it the default one from the context\n+        if (valSerializer instanceof WrappingNullableSerializer) {\n+            ((WrappingNullableSerializer) valSerializer).setIfUnset(context.valueSerde().serializer());", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3MTAxNw==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376571017", "bodyText": "Having generalized this concept, I'm switching Changed(De)Serializer over to the general strategy.", "author": "vvcephei", "createdAt": "2020-02-07T19:38:17Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/ChangedDeserializer.java", "diffHunk": "@@ -35,8 +36,11 @@ public ChangedDeserializer(final Deserializer<T> inner) {\n         return inner;\n     }\n \n-    public void setInner(final Deserializer<T> inner) {\n-        this.inner = inner;\n+    @Override\n+    public void setIfUnset(final Deserializer<T> defaultDeserializer) {\n+        if (inner == null) {\n+            inner = Objects.requireNonNull(defaultDeserializer, \"defaultDeserializer cannot be null\");\n+        }", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3MTY4Nw==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376571687", "bodyText": "In addition to the \"wrapping serializer\" change, there were several places where we would directly throw an NPE while attempting to get the serializer from the current DSL operator's nullable valSerde.", "author": "vvcephei", "createdAt": "2020-02-07T19:39:50Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java", "diffHunk": "@@ -969,7 +969,7 @@ boolean sendingOldValueEnabled() {\n                     foreignKeyExtractor,\n                     foreignKeySerde,\n                     subscriptionTopicName,\n-                    valSerde.serializer(),\n+                    valSerde == null ? null : valSerde.serializer(),", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3MjI4OQ==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376572289", "bodyText": "This is a mixin that we can add to any internal serde that wraps external serdes, all of which are nullable at topology-build time, and would need to be set to the default serde later from the ProcessorContext.", "author": "vvcephei", "createdAt": "2020-02-07T19:41:19Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/WrappingNullableSerializer.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.kstream.internals;\n+\n+import org.apache.kafka.common.serialization.Serializer;\n+\n+public interface WrappingNullableSerializer<Outer, Inner> extends Serializer<Outer> {\n+    void setIfUnset(final Serializer<Inner> defaultSerializer);\n+}", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3Mjc1NA==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376572754", "bodyText": "In addition to the other issues I've pointed out, we also have a few places where we didn't account for nullability in the processors themselves.", "author": "vvcephei", "createdAt": "2020-02-07T19:42:24Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/foreignkeyjoin/ForeignJoinSubscriptionSendProcessorSupplier.java", "diffHunk": "@@ -77,6 +77,9 @@ public void init(final ProcessorContext context) {\n             if (foreignKeySerializer == null) {\n                 foreignKeySerializer = (Serializer<KO>) context.keySerde().serializer();\n             }\n+            if (valueSerializer == null ) {\n+                valueSerializer = (Serializer<V>) context.valueSerde().serializer();\n+            }", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3MzM4OQ==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376573389", "bodyText": "The shema object isn't a Serde, but it's similar in that it wraps nullable user-provided (de)serializers, so it also needs to allow defaulting.", "author": "vvcephei", "createdAt": "2020-02-07T19:43:55Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/foreignkeyjoin/SubscriptionStoreReceiveProcessorSupplier.java", "diffHunk": "@@ -68,6 +68,8 @@ public void init(final ProcessorContext context) {\n                     internalProcessorContext.metrics()\n                 );\n                 store = internalProcessorContext.getStateStore(storeBuilder);\n+\n+                keySchema.init(context);", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3MzcxMw==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376573713", "bodyText": "Added this test in a separate class because the other tests are parameterized, but this one doesn't need to be.", "author": "vvcephei", "createdAt": "2020-02-07T19:44:43Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDefaultSerdeTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.integration;\n+\n+import org.apache.kafka.common.serialization.Serdes;\n+import org.apache.kafka.common.serialization.StringDeserializer;\n+import org.apache.kafka.common.serialization.StringSerializer;\n+import org.apache.kafka.streams.StreamsBuilder;\n+import org.apache.kafka.streams.StreamsConfig;\n+import org.apache.kafka.streams.TestInputTopic;\n+import org.apache.kafka.streams.TestOutputTopic;\n+import org.apache.kafka.streams.TopologyTestDriver;\n+import org.apache.kafka.streams.kstream.KTable;\n+import org.apache.kafka.streams.kstream.Materialized;\n+import org.junit.Test;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+public class KTableKTableForeignKeyJoinDefaultSerdeTest {", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3NDAyMQ==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376574021", "bodyText": "Pretty straightforward test; just make sure we can process some data end-to-end while relying on the default (de)serializer.", "author": "vvcephei", "createdAt": "2020-02-07T19:45:20Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDefaultSerdeTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.integration;\n+\n+import org.apache.kafka.common.serialization.Serdes;\n+import org.apache.kafka.common.serialization.StringDeserializer;\n+import org.apache.kafka.common.serialization.StringSerializer;\n+import org.apache.kafka.streams.StreamsBuilder;\n+import org.apache.kafka.streams.StreamsConfig;\n+import org.apache.kafka.streams.TestInputTopic;\n+import org.apache.kafka.streams.TestOutputTopic;\n+import org.apache.kafka.streams.TopologyTestDriver;\n+import org.apache.kafka.streams.kstream.KTable;\n+import org.apache.kafka.streams.kstream.Materialized;\n+import org.junit.Test;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+public class KTableKTableForeignKeyJoinDefaultSerdeTest {\n+    @Test\n+    public void shouldWorkWithDefaultSerdes() {", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3NDI1Ng==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376574256", "bodyText": "Suggested change", "author": "vvcephei", "createdAt": "2020-02-07T19:45:49Z", "path": "streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "diffHunk": "@@ -1209,7 +1209,7 @@ private void pipeInput(final String topic, final String key, final Long value, f\n         testDriver.pipeRecord(topic, new TestRecord<>(key, value, null, time),\n                 new StringSerializer(), new LongSerializer(), null);\n     }\n-    \n+", "originalCommit": "0deebc6cfdf2d1d3b7c8a2977a1d7966420a440d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afcf118a061d41d4ec1d8f7b582c757b87a19096", "url": "https://github.com/apache/kafka/commit/afcf118a061d41d4ec1d8f7b582c757b87a19096", "message": "Update streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "committedDate": "2020-02-07T19:47:06Z", "type": "commit"}, {"oid": "dd4f945ad1beaca21ca18c073b4fa4ec5cd8a10b", "url": "https://github.com/apache/kafka/commit/dd4f945ad1beaca21ca18c073b4fa4ec5cd8a10b", "message": "formatting fix", "committedDate": "2020-02-07T22:06:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNTQxOQ==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376815419", "bodyText": "Thanks for the test @vvcephei.  Just for a sanity check, what do think about adding some additional tests where we do some permutations with default vs. provided serdes.  For example Table 1 provides serdes via consumed but writes using defaults etc.", "author": "bbejeck", "createdAt": "2020-02-09T21:06:56Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinDefaultSerdeTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.streams.integration;\n+\n+import org.apache.kafka.common.serialization.Serdes;\n+import org.apache.kafka.common.serialization.StringDeserializer;\n+import org.apache.kafka.common.serialization.StringSerializer;\n+import org.apache.kafka.streams.StreamsBuilder;\n+import org.apache.kafka.streams.StreamsConfig;\n+import org.apache.kafka.streams.TestInputTopic;\n+import org.apache.kafka.streams.TestOutputTopic;\n+import org.apache.kafka.streams.TopologyTestDriver;\n+import org.apache.kafka.streams.kstream.KTable;\n+import org.apache.kafka.streams.kstream.Materialized;\n+import org.junit.Test;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+public class KTableKTableForeignKeyJoinDefaultSerdeTest {", "originalCommit": "dd4f945ad1beaca21ca18c073b4fa4ec5cd8a10b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjM3MQ==", "url": "https://github.com/apache/kafka/pull/8061#discussion_r376816371", "bodyText": "Thanks for the review! Sure, that seems like a good idea.", "author": "vvcephei", "createdAt": "2020-02-09T21:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNTQxOQ=="}], "type": "inlineReview"}, {"oid": "2cc13e38696e382a69943a86d77dcdb5826d1ce8", "url": "https://github.com/apache/kafka/commit/2cc13e38696e382a69943a86d77dcdb5826d1ce8", "message": "add extra test cases", "committedDate": "2020-02-09T21:28:47Z", "type": "commit"}]}