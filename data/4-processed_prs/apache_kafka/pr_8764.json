{"pr_number": 8764, "pr_title": "KAFKA-10049: Fixed FKJ bug where wrapped serdes are set incorrectly when using default StreamsConfig serdes", "pr_createdAt": "2020-05-31T14:48:35Z", "pr_url": "https://github.com/apache/kafka/pull/8764", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NDE2MQ==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433284161", "bodyText": "Please use the safeTestName", "author": "vvcephei", "createdAt": "2020-06-01T14:56:05Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinMaterializationIntegrationTest.java", "diffHunk": "@@ -77,11 +83,12 @@ public KTableKTableForeignKeyJoinMaterializationIntegrationTest(final boolean ma\n     @Before\n     public void before() {\n         final String safeTestName = safeUniqueTestName(getClass(), testName);\n-        streamsConfig = mkProperties(mkMap(\n-            mkEntry(StreamsConfig.APPLICATION_ID_CONFIG, \"app-\" + safeTestName),\n-            mkEntry(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, \"asdf:0000\"),\n-            mkEntry(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath())\n-        ));\n+        streamsConfig = new Properties();\n+        streamsConfig.put(StreamsConfig.APPLICATION_ID_CONFIG, \"my-stream-processing-application-2\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NTMzMg==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433285332", "bodyText": "Hey @bellemare , do we need to add a new test? It looks like this condition was intended to be covered already in KTableKTableForeignKeyJoinScenarioTest . Should we just fix that test instead?", "author": "vvcephei", "createdAt": "2020-06-01T14:57:59Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyJoinMaterializationIntegrationTest.java", "diffHunk": "@@ -94,15 +101,49 @@ public void before() {\n         );\n     }\n \n+    @Test\n+    public void shouldEmitRecordWhenJoiningWithDefaultSerdes() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4Njg1NQ==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433486855", "bodyText": "Okay, will check.", "author": "bellemare", "createdAt": "2020-06-01T20:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NTMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg4NjQ0MQ==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r435886441", "bodyText": "@vvcephei Just getting back to this now. Before I rework KTableKTableForeignKeyJoinScenarioTest:\nI can keep it simple and try something like:\nKTable<String, Long> aTable\nKTable<Long, Integer> bTable\nOr I can go ahead and use the JSONSerde, User, and Foo classes. I think the former will suffice for coverage purposes, but I like the latter because it may better reflect real-life use-cases (and I usually look to the tests myself to show me how to use a function). Thoughts on this before I refactor?", "author": "bellemare", "createdAt": "2020-06-05T12:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NTMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3ODgxOA==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r436278818", "bodyText": "Went with \"keep it simple\" basic Integer and String.", "author": "bellemare", "createdAt": "2020-06-06T15:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NTMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NjQxOA==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433486418", "bodyText": "@guozhangwang This is 1/2 of the areas that needed the fix. The valueSerde was being passed into the underlying Serde, despite it really needing the keySerde.", "author": "bellemare", "createdAt": "2020-06-01T20:58:40Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/SinkNode.java", "diffHunk": "@@ -66,10 +66,13 @@ public void init(final InternalProcessorContext context) {\n             valSerializer = (Serializer<V>) context.valueSerde().serializer();\n         }\n \n-        // if value serializers are internal wrapping serializers that may need to be given the default serializer\n+        // if serializers are internal wrapping serializers that may need to be given the default serializer\n         // then pass it the default one from the context\n         if (valSerializer instanceof WrappingNullableSerializer) {\n-            ((WrappingNullableSerializer) valSerializer).setIfUnset(context.valueSerde().serializer());\n+            ((WrappingNullableSerializer) valSerializer).setIfUnset(", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NjU3Mw==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433486573", "bodyText": "@guozhangwang This is 2/2 of the areas that needed the fix. Same thing, the valueSerde was being passed into the underlying Serde, despite it really needing the keySerde.", "author": "bellemare", "createdAt": "2020-06-01T20:59:00Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/SourceNode.java", "diffHunk": "@@ -87,10 +87,13 @@ public void init(final InternalProcessorContext context) {\n             this.valDeserializer = (Deserializer<V>) context.valueSerde().deserializer();\n         }\n \n-        // if value deserializers are internal wrapping deserializers that may need to be given the default\n+        // if deserializers are internal wrapping deserializers that may need to be given the default\n         // then pass it the default one from the context\n         if (valDeserializer instanceof WrappingNullableDeserializer) {\n-            ((WrappingNullableDeserializer) valDeserializer).setIfUnset(context.valueSerde().deserializer());\n+            ((WrappingNullableDeserializer) valDeserializer).setIfUnset(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMTczNw==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433531737", "bodyText": "Ack, thanks!", "author": "guozhangwang", "createdAt": "2020-06-01T22:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NjU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NzAzMQ==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433487031", "bodyText": "@guozhangwang , this (and L128) is the \"actual fix\". Previously, the actual default serde we would pass in was the value serde (in SinkNode/SourceNode), but this one particular serde needs the key serde. If you look at the other serdes that changed in this diff, you'll note that they all actually do need the value serde. Only this one is different.", "author": "vvcephei", "createdAt": "2020-06-01T20:59:49Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/internals/foreignkeyjoin/SubscriptionWrapperSerde.java", "diffHunk": "@@ -63,9 +63,9 @@ public SubscriptionWrapperSerde(final Supplier<String> primaryKeySerializationPs\n         }\n \n         @Override\n-        public void setIfUnset(final Serializer<K> defaultSerializer) {\n+        public void setIfUnset(final Serializer<K> defaultKeySerializer, final Serializer<Void> defaultValueSerializer) {\n             if (primaryKeySerializer == null) {\n-                primaryKeySerializer = Objects.requireNonNull(defaultSerializer, \"defaultSerializer cannot be null\");\n+                primaryKeySerializer = Objects.requireNonNull(defaultKeySerializer);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NzYwMA==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r433487600", "bodyText": "Oh, hah. Looks like you beat me to it, @bellemare  :)", "author": "vvcephei", "createdAt": "2020-06-01T21:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NzAzMQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1Nzc1Nw==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r436857757", "bodyText": "Might be nice for demonstration purposes if the two records actually have different keys. Maybe:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        aTopic.pipeInput(1, \"1-alpha\");\n          \n          \n            \n                        bTopic.pipeInput(1, \"beta\");\n          \n          \n            \n                        aTopic.pipeInput(1, \"999-alpha\");\n          \n          \n            \n                        bTopic.pipeInput(999, \"beta\");", "author": "vvcephei", "createdAt": "2020-06-08T17:03:13Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableKTableForeignKeyJoinScenarioTest.java", "diffHunk": "@@ -243,17 +244,17 @@ private void validateTopologyCanProcessData(final StreamsBuilder builder) {\n         final String safeTestName = safeUniqueTestName(getClass(), testName);\n         config.setProperty(StreamsConfig.APPLICATION_ID_CONFIG, \"dummy-\" + safeTestName);\n         config.setProperty(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, \"dummy\");\n-        config.setProperty(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.StringSerde.class.getName());\n+        config.setProperty(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.IntegerSerde.class.getName());\n         config.setProperty(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.StringSerde.class.getName());\n         config.setProperty(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getAbsolutePath());\n         try (final TopologyTestDriver topologyTestDriver = new TopologyTestDriver(builder.build(), config)) {\n-            final TestInputTopic<String, String> aTopic = topologyTestDriver.createInputTopic(\"A\", new StringSerializer(), new StringSerializer());\n-            final TestInputTopic<String, String> bTopic = topologyTestDriver.createInputTopic(\"B\", new StringSerializer(), new StringSerializer());\n-            final TestOutputTopic<String, String> output = topologyTestDriver.createOutputTopic(\"output\", new StringDeserializer(), new StringDeserializer());\n-            aTopic.pipeInput(\"a1\", \"b1-alpha\");\n-            bTopic.pipeInput(\"b1\", \"beta\");\n-            final Map<String, String> x = output.readKeyValuesToMap();\n-            assertThat(x, is(Collections.singletonMap(\"a1\", \"(b1-alpha,(b1-alpha,beta))\")));\n+            final TestInputTopic<Integer, String> aTopic = topologyTestDriver.createInputTopic(\"A\", new IntegerSerializer(), new StringSerializer());\n+            final TestInputTopic<Integer, String> bTopic = topologyTestDriver.createInputTopic(\"B\", new IntegerSerializer(), new StringSerializer());\n+            final TestOutputTopic<Integer, String> output = topologyTestDriver.createOutputTopic(\"output\", new IntegerDeserializer(), new StringDeserializer());\n+            aTopic.pipeInput(1, \"1-alpha\");\n+            bTopic.pipeInput(1, \"beta\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3MTg2Mg==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r436871862", "bodyText": "Agreed. Good catch.", "author": "bellemare", "createdAt": "2020-06-08T17:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1Nzc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyMzQ0MQ==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r437523441", "bodyText": "bump (it looks like this didn't get changed)", "author": "vvcephei", "createdAt": "2020-06-09T15:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1Nzc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2MDA4NQ==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r437560085", "bodyText": "I swear I know how to read... T_T", "author": "bellemare", "createdAt": "2020-06-09T16:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1Nzc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1ODkzOQ==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r436858939", "bodyText": "It'd be better to avoid reformatting code to change indentation settings. AFAIK, in Streams at least, we tend to use indents of 4 spaces.", "author": "vvcephei", "createdAt": "2020-06-08T17:04:43Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableKTableForeignKeyJoinScenarioTest.java", "diffHunk": "@@ -181,60 +182,60 @@ public void shouldWorkWithDefaultAndProducedSerdes() {\n     public void shouldUseExpectedTopicsWithSerde() {\n         final String applicationId = \"ktable-ktable-joinOnForeignKey\";\n         final Properties streamsConfig = mkProperties(mkMap(\n-            mkEntry(StreamsConfig.APPLICATION_ID_CONFIG, applicationId),\n-            mkEntry(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, \"asdf:0000\"),\n-            mkEntry(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath())\n+                mkEntry(StreamsConfig.APPLICATION_ID_CONFIG, applicationId),\n+                mkEntry(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, \"asdf:0000\"),\n+                mkEntry(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath())\n         ));\n \n         final UniqueTopicSerdeScope serdeScope = new UniqueTopicSerdeScope();\n         final StreamsBuilder builder = new StreamsBuilder();\n \n-        final KTable<String, String> left = builder.table(\n-            LEFT_TABLE,\n-            Consumed.with(serdeScope.decorateSerde(Serdes.String(), streamsConfig, true),\n-                          serdeScope.decorateSerde(Serdes.String(), streamsConfig, false))\n+        final KTable<Integer, String> left = builder.table(\n+                LEFT_TABLE,\n+                Consumed.with(serdeScope.decorateSerde(Serdes.Integer(), streamsConfig, true),\n+                        serdeScope.decorateSerde(Serdes.String(), streamsConfig, false))\n         );\n-        final KTable<String, String> right = builder.table(\n-            RIGHT_TABLE,\n-            Consumed.with(serdeScope.decorateSerde(Serdes.String(), streamsConfig, true),\n-                          serdeScope.decorateSerde(Serdes.String(), streamsConfig, false))\n+        final KTable<Integer, String> right = builder.table(\n+                RIGHT_TABLE,\n+                Consumed.with(serdeScope.decorateSerde(Serdes.Integer(), streamsConfig, true),\n+                        serdeScope.decorateSerde(Serdes.String(), streamsConfig, false))\n         );\n \n         left.join(\n-            right,\n-            value -> value.split(\"\\\\|\")[1],\n-            (value1, value2) -> \"(\" + value1 + \",\" + value2 + \")\",\n-            Materialized.with(null, serdeScope.decorateSerde(Serdes.String(), streamsConfig, false)\n-            ))\n-            .toStream()\n-            .to(OUTPUT);\n+                right,\n+                value -> Integer.parseInt(value.split(\"\\\\|\")[1]),\n+                (value1, value2) -> \"(\" + value1 + \",\" + value2 + \")\",\n+                Materialized.with(null, serdeScope.decorateSerde(Serdes.String(), streamsConfig, false)\n+                ))\n+                .toStream()\n+                .to(OUTPUT);\n \n \n         final Topology topology = builder.build(streamsConfig);\n         try (final TopologyTestDriver driver = new TopologyTestDriver(topology, streamsConfig)) {\n-            final TestInputTopic<String, String> leftInput = driver.createInputTopic(LEFT_TABLE, new StringSerializer(), new StringSerializer());\n-            final TestInputTopic<String, String> rightInput = driver.createInputTopic(RIGHT_TABLE, new StringSerializer(), new StringSerializer());\n-            leftInput.pipeInput(\"lhs1\", \"lhsValue1|rhs1\");\n-            rightInput.pipeInput(\"rhs1\", \"rhsValue1\");\n+            final TestInputTopic<Integer, String> leftInput = driver.createInputTopic(LEFT_TABLE, new IntegerSerializer(), new StringSerializer());\n+            final TestInputTopic<Integer, String> rightInput = driver.createInputTopic(RIGHT_TABLE, new IntegerSerializer(), new StringSerializer());\n+            leftInput.pipeInput(2, \"lhsValue1|1\");\n+            rightInput.pipeInput(1, \"rhsValue1\");\n         }\n         // verifying primarily that no extra pseudo-topics were used, but it's nice to also verify the rest of the\n         // topics our serdes serialize data for\n         assertThat(serdeScope.registeredTopics(), is(mkSet(\n-            // expected pseudo-topics\n-            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-fk--key\",\n-            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-pk--key\",\n-            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-vh--value\",\n-            // internal topics\n-            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic--key\",\n-            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-RESPONSE-0000000014-topic--key\",\n-            applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-RESPONSE-0000000014-topic--value\",\n-            applicationId + \"-left_table-STATE-STORE-0000000000-changelog--key\",\n-            applicationId + \"-left_table-STATE-STORE-0000000000-changelog--value\",\n-            applicationId + \"-right_table-STATE-STORE-0000000003-changelog--key\",\n-            applicationId + \"-right_table-STATE-STORE-0000000003-changelog--value\",\n-            // output topics\n-            \"output-topic--key\",\n-            \"output-topic--value\"\n+                // expected pseudo-topics\n+                applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-fk--key\",\n+                applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-pk--key\",\n+                applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic-vh--value\",\n+                // internal topics\n+                applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-REGISTRATION-0000000006-topic--key\",\n+                applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-RESPONSE-0000000014-topic--key\",\n+                applicationId + \"-KTABLE-FK-JOIN-SUBSCRIPTION-RESPONSE-0000000014-topic--value\",\n+                applicationId + \"-left_table-STATE-STORE-0000000000-changelog--key\",\n+                applicationId + \"-left_table-STATE-STORE-0000000000-changelog--value\",\n+                applicationId + \"-right_table-STATE-STORE-0000000003-changelog--key\",\n+                applicationId + \"-right_table-STATE-STORE-0000000003-changelog--value\",\n+                // output topics\n+                \"output-topic--key\",\n+                \"output-topic--value\"", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3MjE0Mw==", "url": "https://github.com/apache/kafka/pull/8764#discussion_r436872143", "bodyText": "Right, sorry, my bad.", "author": "bellemare", "createdAt": "2020-06-08T17:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1ODkzOQ=="}], "type": "inlineReview"}, {"oid": "29a5395a888b6ac5f16d8f602f9066d439f5a991", "url": "https://github.com/apache/kafka/commit/29a5395a888b6ac5f16d8f602f9066d439f5a991", "message": "KAFKA-10049: Fixed FKJ bug where wrapped serdes are set incorrectly when using default StreamsConfig serdes", "committedDate": "2020-06-08T22:44:26Z", "type": "commit"}, {"oid": "29a5395a888b6ac5f16d8f602f9066d439f5a991", "url": "https://github.com/apache/kafka/commit/29a5395a888b6ac5f16d8f602f9066d439f5a991", "message": "KAFKA-10049: Fixed FKJ bug where wrapped serdes are set incorrectly when using default StreamsConfig serdes", "committedDate": "2020-06-08T22:44:26Z", "type": "forcePushed"}, {"oid": "e47f1948d6e43857ce87a6207c78eb0e363152fe", "url": "https://github.com/apache/kafka/commit/e47f1948d6e43857ce87a6207c78eb0e363152fe", "message": "KAFKA-10049: Changed primary key from 1 to 999 to further clarify the join mechanisms", "committedDate": "2020-06-09T16:28:36Z", "type": "commit"}]}