{"pr_number": 9573, "pr_title": "KAFKA-10693: Close quota managers created in tests", "pr_createdAt": "2020-11-06T22:43:17Z", "pr_url": "https://github.com/apache/kafka/pull/9573", "timeline": [{"oid": "8bbbbeb8771cfe1a518556ce9cdd9420988471e9", "url": "https://github.com/apache/kafka/commit/8bbbbeb8771cfe1a518556ce9cdd9420988471e9", "message": "Close quota managers", "committedDate": "2020-11-06T22:41:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyMDY2NQ==", "url": "https://github.com/apache/kafka/pull/9573#discussion_r519620665", "bodyText": "nit: We should check that quotaManager is not null. We can also do it for replicaManager above.", "author": "dajac", "createdAt": "2020-11-09T08:13:41Z", "path": "core/src/test/scala/unit/kafka/server/IsrExpirationTest.scala", "diffHunk": "@@ -62,14 +64,16 @@ class IsrExpirationTest {\n     EasyMock.replay(logManager)\n \n     alterIsrManager = TestUtils.createAlterIsrManager()\n+    quotaManager = QuotaFactory.instantiate(configs.head, metrics, time, \"\")\n     replicaManager = new ReplicaManager(configs.head, metrics, time, null, null, logManager, new AtomicBoolean(false),\n-      QuotaFactory.instantiate(configs.head, metrics, time, \"\"), new BrokerTopicStats, new MetadataCache(configs.head.brokerId),\n+      quotaManager, new BrokerTopicStats, new MetadataCache(configs.head.brokerId),\n       new LogDirFailureChannel(configs.head.logDirs.size), alterIsrManager)\n   }\n \n   @After\n   def tearDown(): Unit = {\n     replicaManager.shutdown(false)\n+    quotaManager.shutdown()", "originalCommit": "8bbbbeb8771cfe1a518556ce9cdd9420988471e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyMzI5MA==", "url": "https://github.com/apache/kafka/pull/9573#discussion_r519623290", "bodyText": "nit: Could we get rid of quota?", "author": "dajac", "createdAt": "2020-11-09T08:19:04Z", "path": "core/src/test/scala/unit/kafka/server/ReplicaManagerTest.scala", "diffHunk": "@@ -1506,7 +1508,7 @@ class ReplicaManagerTest {\n       purgatoryName = \"ElectLeader\", timer, reaperEnabled = false)\n \n     // Mock network client to show leader offset of 5\n-    val quota = QuotaFactory.instantiate(config, metrics, time, \"\")\n+    val quota = quotaManager", "originalCommit": "8bbbbeb8771cfe1a518556ce9cdd9420988471e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3Mzk1NA==", "url": "https://github.com/apache/kafka/pull/9573#discussion_r519873954", "bodyText": "this is needed to avoid method variable name collision with the ReplicationQuotaManager in the overriden createReplicaFetcherManager a little bit further down in the test.", "author": "splett2", "createdAt": "2020-11-09T14:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyMzI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkyMjAzOA==", "url": "https://github.com/apache/kafka/pull/9573#discussion_r519922038", "bodyText": "Could we rename quotaManager used in createReplicaFetcherManager to replicationQuotaManager and use quotaManager as the global one everywhere?", "author": "dajac", "createdAt": "2020-11-09T15:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyMzI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyMzU0NA==", "url": "https://github.com/apache/kafka/pull/9573#discussion_r519623544", "bodyText": "Should we check that quotaManager is not null?", "author": "dajac", "createdAt": "2020-11-09T08:19:32Z", "path": "core/src/test/scala/unit/kafka/server/ReplicaManagerTest.scala", "diffHunk": "@@ -79,22 +81,24 @@ class ReplicaManagerTest {\n     EasyMock.expect(kafkaZkClient.getEntityConfigs(EasyMock.anyString(), EasyMock.anyString())).andReturn(new Properties()).anyTimes()\n     EasyMock.replay(kafkaZkClient)\n \n+    val props = TestUtils.createBrokerConfig(1, TestUtils.MockZkConnect)\n+    config = KafkaConfig.fromProps(props)\n     alterIsrManager = EasyMock.createMock(classOf[AlterIsrManager])\n+    quotaManager = QuotaFactory.instantiate(config, metrics, time, \"\")\n   }\n \n   @After\n   def tearDown(): Unit = {\n     TestUtils.clearYammerMetrics()\n+    quotaManager.shutdown()", "originalCommit": "8bbbbeb8771cfe1a518556ce9cdd9420988471e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyMzk5OQ==", "url": "https://github.com/apache/kafka/pull/9573#discussion_r519623999", "bodyText": "We should check non null in both cases.", "author": "dajac", "createdAt": "2020-11-09T08:20:25Z", "path": "core/src/test/scala/unit/kafka/server/epoch/OffsetsForLeaderEpochTest.scala", "diffHunk": "@@ -112,4 +120,11 @@ class OffsetsForLeaderEpochTest {\n     //Then\n     assertEquals(new EpochEndOffset(Errors.UNKNOWN_TOPIC_OR_PARTITION, UNDEFINED_EPOCH, UNDEFINED_EPOCH_OFFSET), response(tp))\n   }\n+\n+  @After\n+  def tearDown(): Unit = {\n+    replicaManager.shutdown(checkpointHW = false)\n+    quotaManager.shutdown()", "originalCommit": "8bbbbeb8771cfe1a518556ce9cdd9420988471e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "019f9ab48c289abfb03a66b2ec0c060a4459d348", "url": "https://github.com/apache/kafka/commit/019f9ab48c289abfb03a66b2ec0c060a4459d348", "message": "check null, remove some other uses of quotafactory", "committedDate": "2020-11-09T15:19:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5NDM4Ng==", "url": "https://github.com/apache/kafka/pull/9573#discussion_r519894386", "bodyText": "the two replica managers are intended to be separate. I used the same quota manager for both to avoid polluting the method signature/diff. The tests using this utility function don't rely on any quota manager behavior, so I felt this was okay.", "author": "splett2", "createdAt": "2020-11-09T15:22:32Z", "path": "core/src/test/scala/unit/kafka/server/ReplicaManagerTest.scala", "diffHunk": "@@ -1894,10 +1894,10 @@ class ReplicaManagerTest {\n \n     // each replica manager is for a broker\n     val rm0 = new ReplicaManager(config0, metrics, time, kafkaZkClient, new MockScheduler(time), mockLogMgr0,\n-      new AtomicBoolean(false), QuotaFactory.instantiate(config0, metrics, time, \"\"),\n+      new AtomicBoolean(false), quotaManager,\n       brokerTopicStats1, metadataCache0, new LogDirFailureChannel(config0.logDirs.size), alterIsrManager)\n     val rm1 = new ReplicaManager(config1, metrics, time, kafkaZkClient, new MockScheduler(time), mockLogMgr1,\n-      new AtomicBoolean(false), QuotaFactory.instantiate(config1, metrics, time, \"\"),\n+      new AtomicBoolean(false), quotaManager,", "originalCommit": "019f9ab48c289abfb03a66b2ec0c060a4459d348", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d76b30a075d1a14624eb99904f0c249f2b3dc67", "url": "https://github.com/apache/kafka/commit/2d76b30a075d1a14624eb99904f0c249f2b3dc67", "message": "rename param", "committedDate": "2020-11-09T16:21:07Z", "type": "commit"}]}