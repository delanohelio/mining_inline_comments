{"pr_number": 9238, "pr_title": "KAFKA-10444: Configure PR builds via Jenkinsfile", "pr_createdAt": "2020-09-01T15:16:26Z", "pr_url": "https://github.com/apache/kafka/pull/9238", "timeline": [{"oid": "5dffd2f4103b7a09ddd9476ad48da2ac8fca6358", "url": "https://github.com/apache/kafka/commit/5dffd2f4103b7a09ddd9476ad48da2ac8fca6358", "message": "Add Jenkinsfile", "committedDate": "2020-09-01T15:14:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQxNzk1NA==", "url": "https://github.com/apache/kafka/pull/9238#discussion_r481417954", "bodyText": "for Java 14 -> for Java 15", "author": "chia7712", "createdAt": "2020-09-01T20:40:37Z", "path": "Jenkinsfile", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ *\n+ *  Licensed to the Apache Software Foundation (ASF) under one or more\n+ *  contributor license agreements.  See the NOTICE file distributed with\n+ *  this work for additional information regarding copyright ownership.\n+ *  The ASF licenses this file to You under the Apache License, Version 2.0\n+ *  (the \"License\"); you may not use this file except in compliance with\n+ *  the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+def setupGradle() {\n+  // Delete gradle cache to workaround cache corruption bugs, see KAFKA-3167\n+  dir('.gradle') {\n+    deleteDir()\n+  }\n+  sh './gradlew -version'\n+}\n+\n+def doValidation() {\n+  sh '''\n+    ./gradlew -PscalaVersion=$SCALA_VERSION clean compileJava compileScala compileTestJava compileTestScala \\\n+        spotlessScalaCheck checkstyleMain checkstyleTest spotbugsMain rat \\\n+        --profile --no-daemon --continue -PxmlSpotBugsReport=true\n+  '''\n+}\n+\n+def doTest() {\n+  sh '''\n+    ./gradlew -PscalaVersion=$SCALA_VERSION unitTest integrationTest \\\n+        --profile --no-daemon --continue -PtestLoggingEvents=started,passed,skipped,failed \\\n+        -PignoreFailures=true -PmaxParallelForks=2 -PmaxTestRetries=1 -PmaxTestRetryFailures=5\n+  '''\n+  junit '**/build/test-results/**/TEST-*.xml'\n+}\n+\n+def doStreamsArchetype() {\n+  echo 'Verify that Kafka Streams archetype compiles'\n+\n+  sh '''\n+    ./gradlew streams:install clients:install connect:json:install connect:api:install \\\n+         || { echo 'Could not install kafka-streams.jar (and dependencies) locally`'; exit 1; }\n+  '''\n+\n+  sh '''\n+    version=`grep \"^version=\" gradle.properties | cut -d= -f 2` \\\n+        || { echo 'Could not get version from `gradle.properties`'; exit 1; }\n+  '''\n+\n+  dir('streams/quickstart') {\n+    sh '''\n+      mvn clean install -Dgpg.skip  \\\n+          || { echo 'Could not `mvn install` streams quickstart archetype'; exit 1; }\n+    '''\n+\n+    sh '''\n+      mkdir test-streams-archetype && cd test-streams-archetype \\\n+          || { echo 'Could not create test directory for stream quickstart archetype'; exit 1; }\n+    '''\n+\n+    sh '''\n+      echo \"Y\" | mvn archetype:generate \\\n+          -DarchetypeCatalog=local \\\n+          -DarchetypeGroupId=org.apache.kafka \\\n+          -DarchetypeArtifactId=streams-quickstart-java \\\n+          -DarchetypeVersion=$version \\\n+          -DgroupId=streams.examples \\\n+          -DartifactId=streams.examples \\\n+          -Dversion=0.1 \\\n+          -Dpackage=myapps \\\n+          || { echo 'Could not create new project using streams quickstart archetype'; exit 1; }\n+    '''\n+\n+    dir('streams.examples') {\n+      sh '''\n+        mvn compile \\\n+            || { echo 'Could not compile streams quickstart archetype project'; exit 1; }\n+      '''\n+    }\n+  }\n+}\n+\n+def tryStreamsArchetype() {\n+  try {\n+    doStreamsArchetype()\n+  } catch(err) {\n+    echo 'Failed to build Kafka Streams archetype, marking this build UNSTABLE'\n+    currentBuild.result = 'UNSTABLE'\n+  }\n+}\n+\n+\n+pipeline {\n+  agent none\n+  stages {\n+    stage('Build') {\n+      parallel {\n+        stage('JDK 8') {\n+          agent { label 'ubuntu' }\n+          tools {\n+            jdk 'JDK 1.8 (latest)'\n+            maven 'Maven 3.6.3'\n+          }\n+          options {\n+            timeout(time: 8, unit: 'HOURS') \n+            timestamps()\n+          }\n+          environment {\n+            SCALA_VERSION=2.12\n+          }\n+          steps {\n+            setupGradle()\n+            doValidation()\n+            doTest()\n+            tryStreamsArchetype()\n+          }\n+        }\n+\n+        stage('JDK 11') {\n+          agent { label 'ubuntu' }\n+          tools {\n+            jdk 'JDK 11 (latest)'\n+          }\n+          options {\n+            timeout(time: 8, unit: 'HOURS') \n+            timestamps()\n+          }\n+          environment {\n+            SCALA_VERSION=2.13\n+          }\n+          steps {\n+            setupGradle()\n+            doValidation()\n+            doTest()\n+            echo 'Skipping Kafka Streams archetype test for Java 11'\n+          }\n+        }\n+       \n+        stage('JDK 15') {\n+          agent { label 'ubuntu' }\n+          tools {\n+            jdk 'JDK 15 (latest)'\n+          }\n+          options {\n+            timeout(time: 8, unit: 'HOURS') \n+            timestamps()\n+          }\n+          environment {\n+            SCALA_VERSION=2.13\n+          }\n+          steps {\n+            setupGradle()\n+            doValidation()\n+            doTest()\n+            echo 'Skipping Kafka Streams archetype test for Java 14'", "originalCommit": "5dffd2f4103b7a09ddd9476ad48da2ac8fca6358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzNjQzMA==", "url": "https://github.com/apache/kafka/pull/9238#discussion_r481436430", "bodyText": "Should this new option be supported by test task?", "author": "chia7712", "createdAt": "2020-09-01T21:16:09Z", "path": "build.gradle", "diffHunk": "@@ -336,6 +337,7 @@ subprojects {\n \n   task integrationTest(type: Test, dependsOn: compileJava) {\n     maxParallelForks = userMaxForks ?: Runtime.runtime.availableProcessors()\n+    ignoreFailures = userIgnoreFailures", "originalCommit": "5dffd2f4103b7a09ddd9476ad48da2ac8fca6358", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a685414db7b41c9a0d2e1552b8be1a062fa7ab59", "url": "https://github.com/apache/kafka/commit/a685414db7b41c9a0d2e1552b8be1a062fa7ab59", "message": "Additional feedback from PR", "committedDate": "2020-09-01T21:52:42Z", "type": "commit"}]}