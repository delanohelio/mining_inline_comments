{"pr_number": 9684, "pr_title": "KAFKA-10764: Add support for returning topic IDs on create, supplying topic IDs for delete", "pr_createdAt": "2020-12-04T00:19:12Z", "pr_url": "https://github.com/apache/kafka/pull/9684", "timeline": [{"oid": "f983256d5bae1c354bfb0fb84ee8f08ff4989896", "url": "https://github.com/apache/kafka/commit/f983256d5bae1c354bfb0fb84ee8f08ff4989896", "message": "Returns topic ID in CreateTopicsResponse", "committedDate": "2020-12-01T17:38:45Z", "type": "commit"}, {"oid": "8b14ab47fe4ef3b7b0418ab125eda17ebc96e506", "url": "https://github.com/apache/kafka/commit/8b14ab47fe4ef3b7b0418ab125eda17ebc96e506", "message": "DeleteTopicsRequest allows for specifying topic IDs", "committedDate": "2020-12-03T22:31:10Z", "type": "commit"}, {"oid": "b8c1a0a8c8c7e33e7d260835c11b0590384c8e3e", "url": "https://github.com/apache/kafka/commit/b8c1a0a8c8c7e33e7d260835c11b0590384c8e3e", "message": "Fix some typos, correctly add/remove topic Ids in MockAdminClient, fix comments", "committedDate": "2020-12-04T00:11:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0MzkxMg==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r535743912", "bodyText": "If going to ZK here is too slow, another option is to provide a callback to adminManager.createTopics which can be called after createTopicWithAssignment. This callback would add the topic ID to the result. The idea is that createTopicWithAssignment (and writeTopicPartitionAssignment) would return the topic ID to avoid an extra call to ZK. I wasn't sure which option was better.", "author": "jolshan", "createdAt": "2020-12-04T00:22:19Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -1896,6 +1896,11 @@ class KafkaApis(val requestChannel: RequestChannel,\n               .setTopicConfigErrorCode(Errors.NONE.code)\n           }\n         }\n+        val topicIds = zkClient.getTopicIdsForTopics(results.asScala.map(result => result.name()).toSet)", "originalCommit": "b8c1a0a8c8c7e33e7d260835c11b0590384c8e3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMwOTk4NQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r546309985", "bodyText": "I think we can remove support for zk when using topic-id since KIP-500 will remove zk, also ping @rajinisivaram to have a look.", "author": "dengziming", "createdAt": "2020-12-20T02:24:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0MzkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQwNjQzMw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r546406433", "bodyText": "Currently the KIP-516 work relies on ZK for storing the topic IDs. I think we will need to make some more changes when KIP-500 fully removes ZK", "author": "jolshan", "createdAt": "2020-12-20T17:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0MzkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzODE3Mw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550838173", "bodyText": "Here could we use controllerContext since createTopicRep is handled at the active controller.", "author": "dengziming", "createdAt": "2021-01-02T03:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0MzkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1Mjc3Nw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r546852777", "bodyText": "I noticed all these comments say \"If broker version doesn't support replication factor in the response...\" should each actually say whatever the method is returning (numPartitions, topicId, etc.)", "author": "jolshan", "createdAt": "2020-12-21T18:08:04Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/CreateTopicsResult.java", "diffHunk": "@@ -68,6 +69,19 @@ protected CreateTopicsResult(Map<String, KafkaFuture<TopicMetadataAndConfig>> fu\n         return futures.get(topic).thenApply(TopicMetadataAndConfig::config);\n     }\n \n+    /**\n+     * Returns a future that provides topic ID for the topic when the request completes.\n+     * <p>\n+     * If broker version doesn't support replication factor in the response, throw\n+     * {@link org.apache.kafka.common.errors.UnsupportedVersionException}.\n+     * If broker returned an error for topic configs, throw appropriate exception. For example,\n+     * {@link org.apache.kafka.common.errors.TopicAuthorizationException} is thrown if user does not\n+     * have permission to describe topic configs.\n+     */\n+    public KafkaFuture<Uuid> topicId(String topic) {\n+        return futures.get(topic).thenApply(TopicMetadataAndConfig::topicId);\n+    }\n+    \n     /**\n      * Returns a future that provides number of partitions in the topic when the request completes.", "originalCommit": "b8c1a0a8c8c7e33e7d260835c11b0590384c8e3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg2NjUzMA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564866530", "bodyText": "In the create result, we wouldn't see UnsupportedVersionException for topicId() just because topic ids are not enabled, would we?", "author": "rajinisivaram", "createdAt": "2021-01-26T22:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1Mjc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkwODQ4Ng==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564908486", "bodyText": "I think we could either do that or just return Uuid.ZERO_UUID", "author": "jolshan", "createdAt": "2021-01-26T23:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1Mjc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTE5MDU3Nw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r565190577", "bodyText": "Returning Uuid.ZERO_UUID should be fine. The comment just seems odd, I am not sure why we have it that way in the other methods.", "author": "rajinisivaram", "createdAt": "2021-01-27T10:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1Mjc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ0ODUxNA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r565448514", "bodyText": "I thought it was odd too.", "author": "jolshan", "createdAt": "2021-01-27T16:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1Mjc3Nw=="}], "type": "inlineReview"}, {"oid": "bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "url": "https://github.com/apache/kafka/commit/bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "message": "Fixes to json files and handling in KafkaApis", "committedDate": "2020-12-22T19:29:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNjg2Mg==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550836862", "bodyText": "nit: getDataResponses.map(xxx).filter(.isDefined).map(.get) can be replaced by getDataResponses.flatMap(xxx)", "author": "dengziming", "createdAt": "2021-01-02T03:18:56Z", "path": "core/src/main/scala/kafka/zk/KafkaZkClient.scala", "diffHunk": "@@ -621,10 +621,10 @@ class KafkaZkClient private[zk] (zooKeeperClient: ZooKeeperClient, isSecure: Boo\n         case Code.NONODE => None\n         case _ => throw getDataResponse.resultException.get\n       }\n-    }.map(_.get)\n-      .map(topicIdAssignment => (topicIdAssignment.topic,\n-        topicIdAssignment.topicId.getOrElse(\n-          throw new IllegalStateException(\"Topic \" + topicIdAssignment.topic + \" does not have a topic ID.\"))))\n+    }.filter(_.isDefined)", "originalCommit": "bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwNDk2Mw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550904963", "bodyText": "This will change soon with the new PR I'll be opening tomorrow that gates topic IDs behind IBP 2.8.", "author": "jolshan", "createdAt": "2021-01-02T17:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNjg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwNjMyNQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550906325", "bodyText": "Decided to just open it now. https://github.com/apache/kafka/pull/9814/files", "author": "jolshan", "createdAt": "2021-01-02T18:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNjg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNjk5MA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550836990", "bodyText": "Why is topic name nullable but topicId not? do you mean we will fill all delete requests with a topicId before sending a request?", "author": "dengziming", "createdAt": "2021-01-02T03:21:41Z", "path": "clients/src/main/resources/common/message/DeleteTopicsRequest.json", "diffHunk": "@@ -23,10 +23,17 @@\n   //\n   // Version 5 adds ErrorMessage in the response and may return a THROTTLING_QUOTA_EXCEEDED error\n   // in the response if the topics deletion is throttled (KIP-599).\n-  \"validVersions\": \"0-5\",\n+  //\n+  // Version 6 reorganizes topics, adds topic IDs and allows topic names to be null.\n+  \"validVersions\": \"0-6\",\n   \"flexibleVersions\": \"4+\",\n   \"fields\": [\n-    { \"name\": \"TopicNames\", \"type\": \"[]string\", \"versions\": \"0+\", \"entityType\": \"topicName\",\n+    { \"name\": \"Topics\", \"type\": \"[]DeleteTopicState\", \"versions\": \"6+\", \"about\": \"The name or topic ID of the topic\",\n+      \"fields\": [\n+        {\"name\": \"Name\", \"type\": \"string\", \"versions\": \"6+\", \"nullableVersions\": \"6+\", \"about\": \"The topic name\"},", "originalCommit": "bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwNTA4MQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550905081", "bodyText": "We will use the zero UUID to represent null as described in the KIP.", "author": "jolshan", "createdAt": "2021-01-02T17:57:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNjk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNzE0Ng==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550837146", "bodyText": "Should this be UnknownTopicIdException?", "author": "dengziming", "createdAt": "2021-01-02T03:24:08Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -1623,6 +1625,32 @@ public DeleteTopicsResult deleteTopics(final Collection<String> topicNames,\n         return new DeleteTopicsResult(new HashMap<>(topicFutures));\n     }\n \n+    @Override\n+    public DeleteTopicsWithIdsResult deleteTopicsWithIds(final Collection<Uuid> topicIds,\n+                                           final DeleteTopicsOptions options) {\n+        final Map<Uuid, KafkaFutureImpl<Void>> topicFutures = new HashMap<>(topicIds.size());\n+        final List<Uuid> validTopicIds = new ArrayList<>(topicIds.size());\n+        for (Uuid topicId : topicIds) {\n+            if (topicId.equals(Uuid.ZERO_UUID)) {\n+                KafkaFutureImpl<Void> future = new KafkaFutureImpl<>();\n+                future.completeExceptionally(new InvalidTopicException(\"The given topic ID '\" +", "originalCommit": "bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwNTEwNg==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550905106", "bodyText": "That makes sense.", "author": "jolshan", "createdAt": "2021-01-02T17:57:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNzE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNzI3OA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550837278", "bodyText": "here we'd better use result.topicId() since we are using topicId.", "author": "dengziming", "createdAt": "2021-01-02T03:25:53Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -1694,6 +1722,79 @@ void handleFailure(Throwable throwable) {\n             }\n         };\n     }\n+   \n+    private Call getDeleteTopicsWithIdsCall(final DeleteTopicsOptions options,\n+                                     final Map<Uuid, KafkaFutureImpl<Void>> futures,\n+                                     final List<Uuid> topicIds,\n+                                     final Map<Uuid, ThrottlingQuotaExceededException> quotaExceededExceptions,\n+                                     final long now,\n+                                     final long deadline) {\n+        return new Call(\"deleteTopics\", deadline, new ControllerNodeProvider()) {\n+            @Override\n+            DeleteTopicsRequest.Builder createRequest(int timeoutMs) {\n+                return new DeleteTopicsRequest.Builder(\n+                        new DeleteTopicsRequestData()\n+                                .setTopics(topicIds.stream().map(\n+                                    topic -> new DeleteTopicState().setTopicId(topic)).collect(Collectors.toList()))\n+                                .setTimeoutMs(timeoutMs));\n+            }\n+\n+            @Override\n+            void handleResponse(AbstractResponse abstractResponse) {\n+                // Check for controller change\n+                handleNotControllerError(abstractResponse);\n+                // Handle server responses for particular topics.\n+                final DeleteTopicsResponse response = (DeleteTopicsResponse) abstractResponse;\n+                final List<Uuid> retryTopics = new ArrayList<>();\n+                final Map<Uuid, ThrottlingQuotaExceededException> retryTopicQuotaExceededExceptions = new HashMap<>();\n+                for (DeletableTopicResult result : response.data().responses()) {\n+                    KafkaFutureImpl<Void> future = futures.get(result.topicId());\n+                    if (future == null) {\n+                        log.warn(\"Server response mentioned unknown topic {}\", result.name());", "originalCommit": "bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNzc2OA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550837768", "bodyText": "if topic.name() == null, a NEP will throw here.", "author": "dengziming", "createdAt": "2021-01-02T03:33:30Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/DeleteTopicsRequest.java", "diffHunk": "@@ -39,8 +45,25 @@ public Builder(DeleteTopicsRequestData data) {\n \n         @Override\n         public DeleteTopicsRequest build(short version) {\n+            if (version >= 6 && data.topicNames().size() != 0) {\n+                data.setTopics(groupByTopic(data.topicNames()));\n+            } else if (version >= 6) {\n+                for (DeleteTopicState topic : data.topics()) {\n+                    if (topic.name().equals(\"\")) {", "originalCommit": "bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwNTI3OA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550905278", "bodyText": "Good point. I think I was assuming the default is the empty string, but someone could set the data field to null.", "author": "jolshan", "createdAt": "2021-01-02T17:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNzc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzOTY0Mw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550839643", "bodyText": "According to the kip, we will use topicId firstly and topic name will be used only if topicId is ZERO, but you just use the topic name even topicId is not ZERO here?", "author": "dengziming", "createdAt": "2021-01-02T03:59:19Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -1981,29 +1986,39 @@ class KafkaApis(val requestChannel: RequestChannel,\n     val results = new DeletableTopicResultCollection(deleteTopicRequest.data.topicNames.size)\n     val toDelete = mutable.Set[String]()\n     if (!controller.isActive) {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(Errors.NOT_CONTROLLER.code))\n       }\n       sendResponseCallback(results)\n     } else if (!config.deleteTopicEnable) {\n       val error = if (request.context.apiVersion < 3) Errors.INVALID_REQUEST else Errors.TOPIC_DELETION_DISABLED\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(error.code))\n       }\n       sendResponseCallback(results)\n     } else {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n+        val name = if (topic.name() != null) topic.name() ", "originalCommit": "bd593cf7dbd2e230fbc8d2adea2dc6adc354b8fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwNTY1NA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r550905654", "bodyText": "I'm setting both topic ID and name here for the result since we will return with both, but if you look at the code below, it handles topic ID errors first. From then on, I'm not sure if it makes a difference. I suppose I could check if the topic ID is zero rather than if the name is null, but right now the code paths either set topic ID and name to null or set topic name and topic ID to zero UUID. So for now, those do equivalent things.", "author": "jolshan", "createdAt": "2021-01-02T18:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzOTY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ3NTk2MQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r551475961", "bodyText": "I'll switch to checking for zero UUID for now.", "author": "jolshan", "createdAt": "2021-01-04T18:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzOTY0Mw=="}], "type": "inlineReview"}, {"oid": "7f2ebfbd4a77d290526a680a7b6b6d8730926d4b", "url": "https://github.com/apache/kafka/commit/7f2ebfbd4a77d290526a680a7b6b6d8730926d4b", "message": "Addressed comments, added handling for older IBPs", "committedDate": "2021-01-05T02:19:38Z", "type": "commit"}, {"oid": "4489573eb59577123bc6bd98b4b844c346b0eeb6", "url": "https://github.com/apache/kafka/commit/4489573eb59577123bc6bd98b4b844c346b0eeb6", "message": "Merge branch 'trunk' into KAFKA-10764", "committedDate": "2021-01-05T16:40:33Z", "type": "commit"}, {"oid": "4489573eb59577123bc6bd98b4b844c346b0eeb6", "url": "https://github.com/apache/kafka/commit/4489573eb59577123bc6bd98b4b844c346b0eeb6", "message": "Merge branch 'trunk' into KAFKA-10764", "committedDate": "2021-01-05T16:40:33Z", "type": "forcePushed"}, {"oid": "f1a56cc363a9dec14789332acec891c57ce020d6", "url": "https://github.com/apache/kafka/commit/f1a56cc363a9dec14789332acec891c57ce020d6", "message": "Added to a simple createtopics request test", "committedDate": "2021-01-06T00:42:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg1NjE3Ng==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r552856176", "bodyText": "This is incorrect. Should be removed until 2.8 PR is added.", "author": "jolshan", "createdAt": "2021-01-06T17:50:15Z", "path": "core/src/test/scala/unit/kafka/server/DeleteTopicsRequestTest.scala", "diffHunk": "@@ -132,6 +133,25 @@ class DeleteTopicsRequestTest extends BaseRequestTest {\n     validateTopicIsDeleted(timeoutTopic)\n   }\n \n+  @Test\n+  def testErrorDeleteTopicRequestsOnOldVersions(): Unit = {", "originalCommit": "7f2ebfbd4a77d290526a680a7b6b6d8730926d4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afe594afbe39bc4d61d1be947a5568cbb7e34d57", "url": "https://github.com/apache/kafka/commit/afe594afbe39bc4d61d1be947a5568cbb7e34d57", "message": "Removed incorrect test and added error message to clarify unsupported version exception\n Please enter the commit message for your changes. Lines starting", "committedDate": "2021-01-06T21:38:32Z", "type": "forcePushed"}, {"oid": "0dfd4ee84a3e76ce5153816c9e875bcaccac2929", "url": "https://github.com/apache/kafka/commit/0dfd4ee84a3e76ce5153816c9e875bcaccac2929", "message": "Removed incorrect test and added error message to clarify unsupported version exception", "committedDate": "2021-01-06T21:44:37Z", "type": "commit"}, {"oid": "0dfd4ee84a3e76ce5153816c9e875bcaccac2929", "url": "https://github.com/apache/kafka/commit/0dfd4ee84a3e76ce5153816c9e875bcaccac2929", "message": "Removed incorrect test and added error message to clarify unsupported version exception", "committedDate": "2021-01-06T21:44:37Z", "type": "forcePushed"}, {"oid": "f2ef75850d8807dd835cbd4715a60cacdc9c1cc4", "url": "https://github.com/apache/kafka/commit/f2ef75850d8807dd835cbd4715a60cacdc9c1cc4", "message": "Merge branch 'trunk' of github.com:apache/kafka into KAFKA-10764", "committedDate": "2021-01-21T19:14:45Z", "type": "commit"}, {"oid": "40175b371eca4e00b862d127786aece1e5fef02b", "url": "https://github.com/apache/kafka/commit/40175b371eca4e00b862d127786aece1e5fef02b", "message": "Cleanups, added tests for older IBP version", "committedDate": "2021-01-21T22:16:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg2Nzg4Mw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564867883", "bodyText": "nit: indentation", "author": "rajinisivaram", "createdAt": "2021-01-26T22:09:12Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -1625,6 +1628,32 @@ public DeleteTopicsResult deleteTopics(final Collection<String> topicNames,\n         return new DeleteTopicsResult(new HashMap<>(topicFutures));\n     }\n \n+    @Override\n+    public DeleteTopicsWithIdsResult deleteTopicsWithIds(final Collection<Uuid> topicIds,\n+                                           final DeleteTopicsOptions options) {", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg2OTUyNw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564869527", "bodyText": "nit: indentation", "author": "rajinisivaram", "createdAt": "2021-01-26T22:12:30Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -1696,6 +1725,79 @@ void handleFailure(Throwable throwable) {\n             }\n         };\n     }\n+   \n+    private Call getDeleteTopicsWithIdsCall(final DeleteTopicsOptions options,\n+                                     final Map<Uuid, KafkaFutureImpl<Void>> futures,", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg3MjIzOQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564872239", "bodyText": "nit: isEmpty() instead of .size()?", "author": "rajinisivaram", "createdAt": "2021-01-26T22:17:50Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/DeleteTopicsRequest.java", "diffHunk": "@@ -36,8 +42,25 @@ public Builder(DeleteTopicsRequestData data) {\n \n         @Override\n         public DeleteTopicsRequest build(short version) {\n+            if (version >= 6 && data.topicNames().size() != 0) {", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg3NjkwOA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564876908", "bodyText": "IBP < 2.8 for UNSUPPORTED_VERSION?", "author": "rajinisivaram", "createdAt": "2021-01-26T22:27:14Z", "path": "clients/src/main/resources/common/message/DeleteTopicsResponse.json", "diffHunk": "@@ -27,15 +27,20 @@\n   //\n   // Version 5 adds ErrorMessage in the response and may return a THROTTLING_QUOTA_EXCEEDED error\n   // in the response if the topics deletion is throttled (KIP-599).\n-  \"validVersions\": \"0-5\",\n+  //\n+  // Version 6 adds topic ID to responses. An UNSUPPORTED_VERSION error code will be returned when attempting to\n+  // delete using topic IDs when IBP > 2.8. UNKNOWN_TOPIC_ID error code will be returned when IBP is at least 2.8, but", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg3ODk5OQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564878999", "bodyText": "Doesn't really matter for this test, but perhaps we could use UNKNOWN_TOPIC_ID (multiple tests below)?", "author": "rajinisivaram", "createdAt": "2021-01-26T22:31:07Z", "path": "clients/src/test/java/org/apache/kafka/clients/admin/KafkaAdminClientTest.java", "diffHunk": "@@ -919,6 +973,36 @@ public void testDeleteTopicsRetryThrottlingExceptionWhenEnabled() throws Excepti\n             assertNull(result.values().get(\"topic1\").get());\n             assertNull(result.values().get(\"topic2\").get());\n             TestUtils.assertFutureThrows(result.values().get(\"topic3\"), TopicExistsException.class);\n+            \n+            // With topic IDs\n+            Uuid topicId1 = Uuid.randomUuid();\n+            Uuid topicId2 = Uuid.randomUuid();\n+            Uuid topicId3 = Uuid.randomUuid();\n+            \n+            env.kafkaClient().prepareResponse(\n+                    expectDeleteTopicsRequestWithTopicIds(topicId1, topicId2, topicId3),\n+                    prepareDeleteTopicsResponse(1000,\n+                            deletableTopicResultWithId(topicId1, Errors.NONE),\n+                            deletableTopicResultWithId(topicId2, Errors.THROTTLING_QUOTA_EXCEEDED),\n+                            deletableTopicResultWithId(topicId3, Errors.TOPIC_ALREADY_EXISTS)));", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4MzgzNg==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564883836", "bodyText": "Can't we populate topic id in AdminManager similar to other metadata in the result?", "author": "rajinisivaram", "createdAt": "2021-01-26T22:40:37Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -1843,6 +1843,8 @@ class KafkaApis(val requestChannel: RequestChannel,\n               .setNumPartitions(-1)\n               .setReplicationFactor(-1)\n               .setTopicConfigErrorCode(Errors.NONE.code)\n+          } else {\n+            result.setTopicId(controller.controllerContext.topicIds.getOrElse(result.name(), Uuid.ZERO_UUID))", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc4MzkyMQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r565783921", "bodyText": "I've added something like this to ZkAdminManager. Let me know if it makes sense.", "author": "jolshan", "createdAt": "2021-01-28T02:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4MzgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4NTcxNA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564885714", "bodyText": "We can move this one line above and use topicIdSpecified  in the line above", "author": "rajinisivaram", "createdAt": "2021-01-26T22:44:37Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -1930,29 +1932,43 @@ class KafkaApis(val requestChannel: RequestChannel,\n     val results = new DeletableTopicResultCollection(deleteTopicRequest.data.topicNames.size)\n     val toDelete = mutable.Set[String]()\n     if (!controller.isActive) {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(Errors.NOT_CONTROLLER.code))\n       }\n       sendResponseCallback(results)\n     } else if (!config.deleteTopicEnable) {\n       val error = if (request.context.apiVersion < 3) Errors.INVALID_REQUEST else Errors.TOPIC_DELETION_DISABLED\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(error.code))\n       }\n       sendResponseCallback(results)\n     } else {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n+        val name = if (topic.topicId().equals(Uuid.ZERO_UUID)) topic.name()\n+          else controller.controllerContext.topicNames.getOrElse(topic.topicId(), null)\n         results.add(new DeletableTopicResult()\n-          .setName(topic))\n+          .setName(name)\n+          .setTopicId(topic.topicId()))\n       }\n       val authorizedTopics = authHelper.filterByAuthorized(request.context, DELETE, TOPIC,\n         results.asScala)(_.name)\n       results.forEach { topic =>\n-         if (!authorizedTopics.contains(topic.name))\n+         val foundTopicId = !topic.topicId().equals(Uuid.ZERO_UUID) && topic.name() != null\n+         val topicIdSpecified = !topic.topicId().equals(Uuid.ZERO_UUID)", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTU5MTcxMw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r565591713", "bodyText": "Thinking on this more, I can simplify the line. Especially if I make changes with the code above.", "author": "jolshan", "createdAt": "2021-01-27T19:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4NTcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4NjA3OA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564886078", "bodyText": "We can use topic.topicId == Uuid.ZERO_UUID in Scala instead of equals. (a couple of places below too)", "author": "rajinisivaram", "createdAt": "2021-01-26T22:45:25Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -1930,29 +1932,43 @@ class KafkaApis(val requestChannel: RequestChannel,\n     val results = new DeletableTopicResultCollection(deleteTopicRequest.data.topicNames.size)\n     val toDelete = mutable.Set[String]()\n     if (!controller.isActive) {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(Errors.NOT_CONTROLLER.code))\n       }\n       sendResponseCallback(results)\n     } else if (!config.deleteTopicEnable) {\n       val error = if (request.context.apiVersion < 3) Errors.INVALID_REQUEST else Errors.TOPIC_DELETION_DISABLED\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(error.code))\n       }\n       sendResponseCallback(results)\n     } else {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n+        val name = if (topic.topicId().equals(Uuid.ZERO_UUID)) topic.name()", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4ODg3Ng==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564888876", "bodyText": "What happens if both topic id and topic name are provided in the request?", "author": "rajinisivaram", "createdAt": "2021-01-26T22:50:52Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -1930,29 +1932,43 @@ class KafkaApis(val requestChannel: RequestChannel,\n     val results = new DeletableTopicResultCollection(deleteTopicRequest.data.topicNames.size)\n     val toDelete = mutable.Set[String]()\n     if (!controller.isActive) {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(Errors.NOT_CONTROLLER.code))\n       }\n       sendResponseCallback(results)\n     } else if (!config.deleteTopicEnable) {\n       val error = if (request.context.apiVersion < 3) Errors.INVALID_REQUEST else Errors.TOPIC_DELETION_DISABLED\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n         results.add(new DeletableTopicResult()\n-          .setName(topic)\n+          .setName(topic.name())\n+          .setTopicId(topic.topicId())\n           .setErrorCode(error.code))\n       }\n       sendResponseCallback(results)\n     } else {\n-      deleteTopicRequest.data.topicNames.forEach { topic =>\n+      deleteTopicRequest.topics().forEach { topic =>\n+        val name = if (topic.topicId().equals(Uuid.ZERO_UUID)) topic.name()\n+          else controller.controllerContext.topicNames.getOrElse(topic.topicId(), null)", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkxNDUzNw==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564914537", "bodyText": "The way the requests are built, it is not possible to provide both. But if this somehow happened, we would want to use topic IDs as specified in the KIP.", "author": "jolshan", "createdAt": "2021-01-26T23:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4ODg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTE5Mjg4NA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r565192884", "bodyText": "Java clients won't specify both, but the protocol allows it right? Perhaps we could throw InvalidRequestException?", "author": "rajinisivaram", "createdAt": "2021-01-27T10:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4ODg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ0ODE5Mg==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r565448192", "bodyText": "Good idea.", "author": "jolshan", "createdAt": "2021-01-27T16:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg4ODg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg5MDczMA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564890730", "bodyText": "We could revert changes to this file since there aren't any real changes?", "author": "rajinisivaram", "createdAt": "2021-01-26T22:54:53Z", "path": "core/src/test/scala/unit/kafka/server/BaseRequestTest.scala", "diffHunk": "@@ -21,6 +21,7 @@ import java.io.{DataInputStream, DataOutputStream}\n import java.net.Socket\n import java.nio.ByteBuffer\n import java.util.Properties\n+", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg5NjEyOA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r564896128", "bodyText": "This could move to the previous line, so the identation doesn't look odd", "author": "rajinisivaram", "createdAt": "2021-01-26T23:02:06Z", "path": "core/src/test/scala/unit/kafka/server/MetadataRequestIBPTest/TopicIdWithOldInterBrokerProtocolTest.scala", "diffHunk": "@@ -59,8 +61,56 @@ class TopicIdWithOldInterBrokerProtocolTest extends BaseRequestTest {\n     }\n   }\n \n+  @Test\n+  def testDeleteTopicsWithOldIBP(): Unit = {\n+    val timeout = 10000\n+    createTopic(\"topic-3\", 5, 2)\n+    createTopic(\"topic-4\", 1, 2)\n+    val request = new DeleteTopicsRequest.Builder(\n+      new DeleteTopicsRequestData()\n+        .setTopicNames(Arrays.asList(\"topic-3\", \"topic-4\"))\n+        .setTimeoutMs(timeout)).build()\n+    val resp = sendDeleteTopicsRequest(request)\n+    val error = resp.errorCounts.asScala.find(_._1 != Errors.NONE)\n+    assertTrue(error.isEmpty, s\"There should be no errors, found ${resp.data.responses.asScala}\")\n+    request.data.topicNames.forEach { topic =>\n+      validateTopicIsDeleted(topic)\n+    }\n+    resp.data.responses.forEach { response =>\n+      assertEquals(Uuid.ZERO_UUID, response.topicId())\n+    }\n+  }\n+\n+  @Test\n+  def testDeleteTopicsWithOldIBPUsingIDs(): Unit = {\n+    val timeout = 10000\n+    createTopic(\"topic-7\", 3, 2)\n+    createTopic(\"topic-6\", 1, 2)\n+    val ids = Map(\"topic-7\" -> Uuid.randomUuid(), \"topic-6\" -> Uuid.randomUuid())\n+    val request = new DeleteTopicsRequest.Builder(\n+      new DeleteTopicsRequestData()\n+        .setTopics(Arrays.asList(new DeleteTopicState().setTopicId(ids(\"topic-7\")),\n+          new DeleteTopicState().setTopicId(ids(\"topic-6\"))\n+        )\n+        ).setTimeoutMs(timeout)).build()", "originalCommit": "40175b371eca4e00b862d127786aece1e5fef02b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4754e27edb1f3c3969dcbcf28feb6b1eb5b5bfc", "url": "https://github.com/apache/kafka/commit/d4754e27edb1f3c3969dcbcf28feb6b1eb5b5bfc", "message": "Addressed comments--moved topic ID in create to ZkAdminManager, updated authorization logic", "committedDate": "2021-01-28T02:45:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ0MjI5NQ==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r566442295", "bodyText": "We use kafka.server for the other unit tests in this directory, so we should do the same here (in Scala, the package name doesn't need to match the directory structure).", "author": "rajinisivaram", "createdAt": "2021-01-28T22:11:57Z", "path": "core/src/test/scala/unit/kafka/server/TopicIdWithOldInterBrokerProtocolTest.scala", "diffHunk": "@@ -15,12 +15,13 @@\n  * limitations under the License.\n  */\n \n-package kafka.server\n+package unit.kafka.server", "originalCommit": "d4754e27edb1f3c3969dcbcf28feb6b1eb5b5bfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ4NzI4OA==", "url": "https://github.com/apache/kafka/pull/9684#discussion_r566487288", "bodyText": "Got it.", "author": "jolshan", "createdAt": "2021-01-28T23:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ0MjI5NQ=="}], "type": "inlineReview"}, {"oid": "46b109da445a5a2d51096c4033334e3aeb42a56e", "url": "https://github.com/apache/kafka/commit/46b109da445a5a2d51096c4033334e3aeb42a56e", "message": "fix package name", "committedDate": "2021-01-29T02:45:56Z", "type": "commit"}]}