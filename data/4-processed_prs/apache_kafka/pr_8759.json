{"pr_number": 8759, "pr_title": "KAFKA-10066: TestOutputTopic should pass record headers into deserializers", "pr_createdAt": "2020-05-29T23:18:26Z", "pr_url": "https://github.com/apache/kafka/pull/8759", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMTQ0Nw==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r432901447", "bodyText": "DeSerializers -> Deserializers", "author": "abbccdda", "createdAt": "2020-05-31T01:42:22Z", "path": "streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "diffHunk": "@@ -711,6 +715,56 @@ public void shouldUseSourceSpecificDeserializers() {\n         assertThat(result2.getValue(), equalTo(source2Value));\n     }\n \n+    @Test\n+    public void shouldPassRecordHeadersIntoDeSerializers() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NTA5Nw==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r433055097", "bodyText": "The capital S was on purpose; it's short for IntoDeserializersAndSerializers", "author": "mjsax", "createdAt": "2020-06-01T06:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMTYxOA==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r432901618", "bodyText": "It seems like we are just verifying the headers are deserialized. Should we just use mock deserializers? Moreover, we could build a customized boolean deserializer which outputs true when the header is provided, or false otherwise.", "author": "abbccdda", "createdAt": "2020-05-31T01:46:21Z", "path": "streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "diffHunk": "@@ -711,6 +715,56 @@ public void shouldUseSourceSpecificDeserializers() {\n         assertThat(result2.getValue(), equalTo(source2Value));\n     }\n \n+    @Test\n+    public void shouldPassRecordHeadersIntoDeSerializers() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NTk5NA==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r433055994", "bodyText": "We don't verify that header are deserialized -- we just verify that the right function is called, that hands the header into the deserializer (ie, to allow used to read them as metadata).\nI guess we should use mocks for the deserializers, but not for the serializers. Thus, not using mocks make the test use the same patter for both what seems \"nicer\".\n\nMoreover, we could build a customized boolean deserializer which outputs true when the header is provided, or false otherwise.\n\nWould this make the test simpler? I personally doubt it.", "author": "mjsax", "createdAt": "2020-06-01T06:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMTYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxOTIxMQ==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r432919211", "bodyText": "Nice finding!\nhttps://github.com/apache/kafka/blob/trunk/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java#L805 has similar issue. Should we fix it as well?", "author": "chia7712", "createdAt": "2020-05-31T07:34:26Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -906,8 +906,8 @@ public void advanceWallClockTime(final Duration advance) {\n         if (record == null) {\n             throw new NoSuchElementException(\"Empty topic: \" + topic);\n         }\n-        final K key = keyDeserializer.deserialize(record.topic(), record.key());\n-        final V value = valueDeserializer.deserialize(record.topic(), record.value());\n+        final K key = keyDeserializer.deserialize(record.topic(), record.headers(), record.key());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NDg4NQ==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r433054885", "bodyText": "readOutput is deprecated. Thus not sure if it's worth to fix?", "author": "mjsax", "createdAt": "2020-06-01T05:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxOTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2NDc3Ng==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r433364776", "bodyText": "Thus not sure if it's worth to fix?\n\nPersonally, what we should add to readOutput is \"deprecation\" rather than \"a bug\". Hence, it is worthwhile to fix if the fix does not break anything.", "author": "chia7712", "createdAt": "2020-06-01T16:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxOTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU2NDc5OA==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r433564798", "bodyText": "Not sure if I can follow? readOutput is marked as deprecated: https://github.com/apache/kafka/blob/trunk/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java#L797\nI can still fix it on the side, but nobody should use it any longer and thus the gain seems minimal.", "author": "mjsax", "createdAt": "2020-06-02T00:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxOTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NjUwMQ==", "url": "https://github.com/apache/kafka/pull/8759#discussion_r433596501", "bodyText": "but nobody should use it any longer and thus the gain seems minimal.\n\nYou are right. The benefit is too low.", "author": "chia7712", "createdAt": "2020-06-02T03:10:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkxOTIxMQ=="}], "type": "inlineReview"}, {"oid": "c8ec9ea0e9ec25cf8b6dca3f0f70d16616ac3dd8", "url": "https://github.com/apache/kafka/commit/c8ec9ea0e9ec25cf8b6dca3f0f70d16616ac3dd8", "message": "KAFKA-10066: TestOutputTopic should pass record headers into\ndeserializers", "committedDate": "2020-06-03T23:25:28Z", "type": "commit"}, {"oid": "e58a0c440b5134b89e5819f101014eed770f23a3", "url": "https://github.com/apache/kafka/commit/e58a0c440b5134b89e5819f101014eed770f23a3", "message": "Unify test", "committedDate": "2020-06-03T23:25:28Z", "type": "commit"}, {"oid": "2f2515c43d3b4c1f79bf2aefc66c307bc49c4968", "url": "https://github.com/apache/kafka/commit/2f2515c43d3b4c1f79bf2aefc66c307bc49c4968", "message": "foo", "committedDate": "2020-06-03T23:25:28Z", "type": "commit"}, {"oid": "ef08ac87f441f8defeb04773b74e963d2efdcd79", "url": "https://github.com/apache/kafka/commit/ef08ac87f441f8defeb04773b74e963d2efdcd79", "message": "Fix checkstyle", "committedDate": "2020-06-03T23:25:28Z", "type": "commit"}, {"oid": "6e3563fd71c4d46ac92d75078af447662f493178", "url": "https://github.com/apache/kafka/commit/6e3563fd71c4d46ac92d75078af447662f493178", "message": "Github comment", "committedDate": "2020-06-03T23:25:28Z", "type": "commit"}, {"oid": "32ec931acb26e0d51934da157ee131ee3c53f0e9", "url": "https://github.com/apache/kafka/commit/32ec931acb26e0d51934da157ee131ee3c53f0e9", "message": "Rename test", "committedDate": "2020-06-03T23:25:28Z", "type": "commit"}, {"oid": "32ec931acb26e0d51934da157ee131ee3c53f0e9", "url": "https://github.com/apache/kafka/commit/32ec931acb26e0d51934da157ee131ee3c53f0e9", "message": "Rename test", "committedDate": "2020-06-03T23:25:28Z", "type": "forcePushed"}]}