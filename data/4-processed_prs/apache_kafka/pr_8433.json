{"pr_number": 8433, "pr_title": "MINOR: Should cleanup the tasks after dirty close", "pr_createdAt": "2020-04-06T16:43:40Z", "pr_url": "https://github.com/apache/kafka/pull/8433", "timeline": [{"oid": "57198a99bd29ab0955b59ee0457d24c13fc12a0c", "url": "https://github.com/apache/kafka/commit/57198a99bd29ab0955b59ee0457d24c13fc12a0c", "message": "cleanup after task close", "committedDate": "2020-04-06T16:40:08Z", "type": "commit"}, {"oid": "5e3ab130c795ff49e85fc7b2f6810766ae67e9a3", "url": "https://github.com/apache/kafka/commit/5e3ab130c795ff49e85fc7b2f6810766ae67e9a3", "message": "test", "committedDate": "2020-04-06T16:41:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2ODk1Mg==", "url": "https://github.com/apache/kafka/pull/8433#discussion_r404368952", "bodyText": "It seems like this would have initially appeared unnecessary because we already removed it on L230 when we first put it into the dirtyTasks map. But what appears to have happened is that we actually got an exception during commit, and added some more tasks in L252-L253, which were not removed from the task map.\nWhat is the overall algorithm here? Offhand, it seems like we should only remove the task after we know it is closed, which means we should delete the iterator.remove(); on L230 and keep the line you've added here, along with adding a similar line between L264-265 (after closeClean). I'm also wondering if we should really do closeDirty on L271, or just add it to dirtyTasks. If we keep it there, then we also need to remove it from the task map at that location.", "author": "vvcephei", "createdAt": "2020-04-06T20:30:39Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -277,6 +277,7 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n         for (final Task task : dirtyTasks) {\n             task.closeDirty();\n             cleanUpTaskProducer(task, taskCloseExceptions);\n+            tasks.remove(task.id());", "originalCommit": "5e3ab130c795ff49e85fc7b2f6810766ae67e9a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3MTkxOA==", "url": "https://github.com/apache/kafka/pull/8433#discussion_r404371918", "bodyText": "Thanks for the question @vvcephei , the overall algorithm is like we are adding more tasks into the dirty task list to cleanup on L252-253, as the whole pre-commit + commit section fails. I could see that doing a separate removal here is misleading, so I will try to move this logic up to the catch block where we actually augment the dirtyTasks map.", "author": "abbccdda", "createdAt": "2020-04-06T20:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2ODk1Mg=="}], "type": "inlineReview"}, {"oid": "ce24e16051e2dcf5301064192c1cc78a72ccb5bd", "url": "https://github.com/apache/kafka/commit/ce24e16051e2dcf5301064192c1cc78a72ccb5bd", "message": "make the removal logic closer to the dirtyTask struct change", "committedDate": "2020-04-06T20:49:44Z", "type": "commit"}, {"oid": "b5c7843c39c57f235009c1098e088f854ace13cf", "url": "https://github.com/apache/kafka/commit/b5c7843c39c57f235009c1098e088f854ace13cf", "message": "apply remove task only after close", "committedDate": "2020-04-06T22:24:30Z", "type": "commit"}]}