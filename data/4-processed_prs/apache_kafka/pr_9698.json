{"pr_number": 9698, "pr_title": "KAFKA-10811: Correct the MirrorConnectorsIntegrationTest to correctly mask the exit procedures", "pr_createdAt": "2020-12-04T23:51:48Z", "pr_url": "https://github.com/apache/kafka/pull/9698", "timeline": [{"oid": "c70a58cce688f94627d4d39d0e360955f3a35971", "url": "https://github.com/apache/kafka/commit/c70a58cce688f94627d4d39d0e360955f3a35971", "message": "KAFKA-10811: Correct the MirrorConnectorsIntegrationTest to correctly mask the exit procedures\n\nNormally the `EmbeddedConnectCluster` class masks the `Exit` procedures using within the Connect worker. This normally works great when a single instance of the embedded cluster is used. However, the `MirrorConnectorsIntegrationTest` uses two `EmbeddedConnectCluster` instances, and when the first one is stopped it would reset the (static) exit procedures, and any problems during shutdown of the second embedded Connect cluster would cause the worker to shut down the JVM running the tests.\n\nInstead, the `MirrorConnectorsIntegrationTest` class should mask the `Exit` procedures and instruct the `EmbeddedConnectClusters` instances (via the existing builder method) to not mask the procedures.", "committedDate": "2020-12-06T16:47:55Z", "type": "commit"}, {"oid": "c70a58cce688f94627d4d39d0e360955f3a35971", "url": "https://github.com/apache/kafka/commit/c70a58cce688f94627d4d39d0e360955f3a35971", "message": "KAFKA-10811: Correct the MirrorConnectorsIntegrationTest to correctly mask the exit procedures\n\nNormally the `EmbeddedConnectCluster` class masks the `Exit` procedures using within the Connect worker. This normally works great when a single instance of the embedded cluster is used. However, the `MirrorConnectorsIntegrationTest` uses two `EmbeddedConnectCluster` instances, and when the first one is stopped it would reset the (static) exit procedures, and any problems during shutdown of the second embedded Connect cluster would cause the worker to shut down the JVM running the tests.\n\nInstead, the `MirrorConnectorsIntegrationTest` class should mask the `Exit` procedures and instruct the `EmbeddedConnectClusters` instances (via the existing builder method) to not mask the procedures.", "committedDate": "2020-12-06T16:47:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMDg3NQ==", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537230875", "bodyText": "It seems exitProcedure and haltProcedure can be local variable", "author": "chia7712", "createdAt": "2020-12-07T04:55:48Z", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "diffHunk": "@@ -75,14 +74,45 @@\n     private static final int RECORD_CONSUME_DURATION_MS = 20_000;\n     private static final int OFFSET_SYNC_DURATION_MS = 30_000;\n \n-    private final AtomicBoolean exited = new AtomicBoolean(false);\n+    private volatile boolean shuttingDown;\n     private Map<String, String> mm2Props;\n     private MirrorMakerConfig mm2Config;\n     private EmbeddedConnectCluster primary;\n     private EmbeddedConnectCluster backup;\n \n+    private Exit.Procedure exitProcedure;", "originalCommit": "c70a58cce688f94627d4d39d0e360955f3a35971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5ODgxMA==", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537598810", "bodyText": "Perhaps, but the log messages for each is different, so IMO it's better to keep them separate.", "author": "rhauch", "createdAt": "2020-12-07T15:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMDg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMzAyNA==", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537233024", "bodyText": "How about using Utils.closeQuietly to replace this nested try-block?", "author": "chia7712", "createdAt": "2020-12-07T05:02:58Z", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorsIntegrationTest.java", "diffHunk": "@@ -194,20 +224,27 @@ private void waitUntilMirrorMakerIsRunning(EmbeddedConnectCluster connectCluster\n \n     @After\n     public void close() {\n-        for (String x : primary.connectors()) {\n-            primary.deleteConnector(x);\n-        }\n-        for (String x : backup.connectors()) {\n-            backup.deleteConnector(x);\n-        }\n-        deleteAllTopics(primary.kafka());\n-        deleteAllTopics(backup.kafka());\n-        primary.stop();\n-        backup.stop();\n         try {\n-            assertFalse(exited.get());\n+            for (String x : primary.connectors()) {\n+                primary.deleteConnector(x);\n+            }\n+            for (String x : backup.connectors()) {\n+                backup.deleteConnector(x);\n+            }\n+            deleteAllTopics(primary.kafka());\n+            deleteAllTopics(backup.kafka());\n         } finally {\n-            Exit.resetExitProcedure();\n+            shuttingDown = true;\n+            try {\n+                try {\n+                    primary.stop();", "originalCommit": "c70a58cce688f94627d4d39d0e360955f3a35971", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5OTcwNA==", "url": "https://github.com/apache/kafka/pull/9698#discussion_r537599704", "bodyText": "EmbeddedConnectCluster is not AutoCloseable, which means we can't use that. Since this PR is to fix broken builds, I'd like to minimize the additional changes, so I'll issue a followup PR.", "author": "rhauch", "createdAt": "2020-12-07T15:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzMzAyNA=="}], "type": "inlineReview"}]}