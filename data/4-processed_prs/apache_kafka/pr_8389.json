{"pr_number": 8389, "pr_title": "KAFKA-9777; Remove txn purgatory to fix race condition on txn completion", "pr_createdAt": "2020-03-30T17:45:24Z", "pr_url": "https://github.com/apache/kafka/pull/8389", "timeline": [{"oid": "ac3163042c25f6d7f37ffe7a518d87ffc8713216", "url": "https://github.com/apache/kafka/commit/ac3163042c25f6d7f37ffe7a518d87ffc8713216", "message": "KAFKA-9777; Remove txn purgatory to fix race condition on txn completion", "committedDate": "2020-03-30T17:34:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMDA1Mw==", "url": "https://github.com/apache/kafka/pull/8389#discussion_r400410053", "bodyText": "Since this is used for both CompleteCommit and CompleteAbort, perhaps it's clearer to name it PendingCompleteTxn?", "author": "junrao", "createdAt": "2020-03-30T18:38:01Z", "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala", "diffHunk": "@@ -373,19 +402,17 @@ class TransactionMarkerChannelManager(config: KafkaConfig,\n   }\n \n   def removeMarkersForTxnId(transactionalId: String): Unit = {\n-    // we do not need to clear the queue since it should have\n-    // already been drained by the sender thread\n-    txnMarkerPurgatory.cancelForKey(transactionalId)\n+    transactionsWithPendingMarkers.remove(transactionalId)\n   }\n \n   def completeSendMarkersForTxnId(transactionalId: String): Unit = {\n-    txnMarkerPurgatory.checkAndComplete(transactionalId)\n+    maybeWriteTxnCompletion(transactionalId)\n   }\n }\n \n case class TxnIdAndMarkerEntry(txnId: String, txnMarkerEntry: TxnMarkerEntry)\n \n-case class TxnLogAppend(transactionalId: String, coordinatorEpoch: Int, txnMetadata: TransactionMetadata, newMetadata: TxnTransitMetadata) {\n+case class PendingCommitTxn(transactionalId: String, coordinatorEpoch: Int, txnMetadata: TransactionMetadata, newMetadata: TxnTransitMetadata) {", "originalCommit": "ac3163042c25f6d7f37ffe7a518d87ffc8713216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ0NzE4OQ==", "url": "https://github.com/apache/kafka/pull/8389#discussion_r400447189", "bodyText": "Yes, good idea. I think \"complete\" was the word I was looking for.", "author": "hachikuji", "createdAt": "2020-03-30T19:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQxMDA1Mw=="}], "type": "inlineReview"}, {"oid": "88b8b0fa10695bbcbbc40a554a2977481b31f8be", "url": "https://github.com/apache/kafka/commit/88b8b0fa10695bbcbbc40a554a2977481b31f8be", "message": "PendingCommitTxn -> PendingCompleteTxn", "committedDate": "2020-03-30T20:37:07Z", "type": "commit"}, {"oid": "2ffe6c0ec012debb77e9053048551ccf2416bdb9", "url": "https://github.com/apache/kafka/commit/2ffe6c0ec012debb77e9053048551ccf2416bdb9", "message": "Add new concurrency test case to reproduce bug", "committedDate": "2020-03-30T22:34:12Z", "type": "commit"}, {"oid": "2ffe6c0ec012debb77e9053048551ccf2416bdb9", "url": "https://github.com/apache/kafka/commit/2ffe6c0ec012debb77e9053048551ccf2416bdb9", "message": "Add new concurrency test case to reproduce bug", "committedDate": "2020-03-30T22:34:12Z", "type": "forcePushed"}]}