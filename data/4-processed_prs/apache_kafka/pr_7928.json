{"pr_number": 7928, "pr_title": "KAFKA-9152; Improve Sensor Retrieval", "pr_createdAt": "2020-01-10T16:13:44Z", "pr_url": "https://github.com/apache/kafka/pull/7928", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDgxOA==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r368764818", "bodyText": "Although, you simplified this code, you did not apply all simplifications I proposed in PR #7914. I think you can even simplify this code further as shown here:\nreturn Optional.ofNullable(metrics.getSensor(fullSensorName)).orElseGet(() -> {\n    threadLevelSensors.computeIfAbsent(key, ignored -> new LinkedList<>()).push(fullSensorName);\n    return metrics.sensor(fullSensorName, recordingLevel, parents);\n});\n\nThis simplification can be applied also to the other methods below.\nIf you have any concerns about this simplifications please share your thoughts.", "author": "cadonna", "createdAt": "2020-01-21T00:17:17Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java", "diffHunk": "@@ -210,11 +211,13 @@ public final Sensor threadLevelSensor(final String threadId,\n                                           final Sensor... parents) {\n         final String key = threadSensorPrefix(threadId);\n         synchronized (threadLevelSensors) {\n-            threadLevelSensors.putIfAbsent(key, new LinkedList<>());\n             final String fullSensorName = key + SENSOR_NAME_DELIMITER + sensorName;\n-            final Sensor sensor = metrics.sensor(fullSensorName, recordingLevel, parents);\n-            threadLevelSensors.get(key).push(fullSensorName);\n-            return sensor;\n+            return Optional.ofNullable(metrics.getSensor(fullSensorName))\n+                    .orElseGet(() -> {\n+                        threadLevelSensors.putIfAbsent(key, new LinkedList<>());\n+                        threadLevelSensors.get(key).push(fullSensorName);\n+                        return metrics.sensor(fullSensorName, recordingLevel, parents);\n+                    });", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA0MDE3Mw==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369040173", "bodyText": "oh good!!", "author": "highluck", "createdAt": "2020-01-21T14:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NDgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Nzg1Mg==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r368767852", "bodyText": "There several issues with this test:\n\nFirst of all the test fails.\nAccording to the name of the test you want to verify threadLevelSensor(), but you call taskLevelSensor().\nSince the Metrics mock always returns the same sensor, it does not make sense to compare the sensors that are returned by the different calls to threadLevelSensor(). Such a verification will always be true. You should rather verify if method sensor() is not called on the Metrics mock. For example, the following two setups could replace setupGetSensorTest():\n\n    private void setupGetNewSensorTest(final Metrics metrics,\n                                       final String level,\n                                       final RecordingLevel recordingLevel) {\n        final String fullSensorName = fullSensorName(level);\n        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n        final Sensor[] parents = {};\n        expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n        replay(metrics);\n    }\n\n    private void setupGetExistingSensorTest(final Metrics metrics,\n                                            final String level,\n                                            final RecordingLevel recordingLevel) {\n        final String fullSensorName = fullSensorName(level);\n        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n        replay(metrics);\n    }\n\nand the following two tests would replace shouldGetTaskLevelSensor():\n    @Test\n    public void shouldGetNewThreadLevelSensor() {\n        final Metrics metrics = mock(Metrics.class);\n        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n        setupGetNewSensorTest(metrics, THREAD_ID, recordingLevel);\n        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n\n        final Sensor actualSensor = streamsMetrics.threadLevelSensor(THREAD_ID, sensorName1, recordingLevel);\n\n        verify(metrics);\n        assertThat(actualSensor, is(equalToObject(sensor)));\n    }\n\n    @Test\n    public void shouldGetExistingThreadLevelSensor() {\n        final Metrics metrics = mock(Metrics.class);\n        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n        setupGetExistingSensorTest(metrics, THREAD_ID, recordingLevel);\n        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n\n        final Sensor actualSensor = streamsMetrics.threadLevelSensor(THREAD_ID, sensorName1, recordingLevel);\n\n        verify(metrics);\n        assertThat(actualSensor, is(equalToObject(sensor)));\n    }\n\nSimilar is true for the other tests below.", "author": "cadonna", "createdAt": "2020-01-21T00:38:19Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -203,6 +204,78 @@ private void setupGetSensorTest(final Metrics metrics,\n         replay(metrics);\n     }\n \n+    @Test\n+    public void shouldGetSameThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetSensorTest(metrics, THREAD_ID, recordingLevel);\n+\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor preSensor = streamsMetrics.taskLevelSensor(THREAD_ID, TASK_ID, sensorName1, recordingLevel);\n+        final Sensor afterSensor = streamsMetrics.taskLevelSensor(THREAD_ID, TASK_ID, sensorName1, recordingLevel);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(THREAD_ID, TASK_ID, sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+        assertThat(preSensor, is(equalToObject(afterSensor)));\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyMjIzMA==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369122230", "bodyText": "Please use 4 spaces instead of 8 for indentation. Same applies to the changes below.", "author": "cadonna", "createdAt": "2020-01-21T16:55:03Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImpl.java", "diffHunk": "@@ -210,11 +211,12 @@ public final Sensor threadLevelSensor(final String threadId,\n                                           final Sensor... parents) {\n         final String key = threadSensorPrefix(threadId);\n         synchronized (threadLevelSensors) {\n-            threadLevelSensors.putIfAbsent(key, new LinkedList<>());\n             final String fullSensorName = key + SENSOR_NAME_DELIMITER + sensorName;\n-            final Sensor sensor = metrics.sensor(fullSensorName, recordingLevel, parents);\n-            threadLevelSensors.get(key).push(fullSensorName);\n-            return sensor;\n+            return Optional.ofNullable(metrics.getSensor(fullSensorName))\n+                    .orElseGet(() -> {\n+                        threadLevelSensors.computeIfAbsent(key, ignored -> new LinkedList<>()).push(fullSensorName);\n+                        return metrics.sensor(fullSensorName, recordingLevel, parents);\n+                    });", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyNzA0OQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369127049", "bodyText": "If a line is too long, either move right hand side of assignment to a new line. If it is still too long put each argument and the closing parenthesis on its own line. Examples are:\nfinal Sensor actualSensor = \n    streamsMetrics.storeLevelSensor(THREAD_ID, storeName, TASK_ID, sensorName1, recordingLevel);\n\nand\nfinal Sensor actualSensor = streamsMetrics.storeLevelSensor(\n    THREAD_ID, \n    storeName, \n    TASK_ID, \n    sensorName1, \n    recordingLevel\n);\n\nIn this case please use the former.\nPlease check also the other changes for too long lines.", "author": "cadonna", "createdAt": "2020-01-21T17:02:59Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -203,6 +203,171 @@ private void setupGetSensorTest(final Metrics metrics,\n         replay(metrics);\n     }\n \n+\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName =\n+            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n+        final Sensor[] parents = {};\n+        expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName =\n+            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    @Test\n+    public void shouldGetNewThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(THREAD_ID, sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(THREAD_ID, sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetNewTaskLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID + \".task.\" + TASK_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(THREAD_ID, TASK_ID, sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingTaskLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID + \".task.\" + TASK_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(THREAD_ID, TASK_ID,  sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetNewStoreLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID + \".task.\" + storeName + SENSOR_PREFIX_DELIMITER\n+            + storeName + SENSOR_PREFIX_DELIMITER + TASK_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.storeLevelSensor(THREAD_ID, storeName, TASK_ID,\n+            sensorName1, recordingLevel);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyNzUyOA==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369127528", "bodyText": "This line is too long. Please move streamsMetrics.storeLevelSensor() to new line.", "author": "cadonna", "createdAt": "2020-01-21T17:03:52Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -203,6 +203,171 @@ private void setupGetSensorTest(final Metrics metrics,\n         replay(metrics);\n     }\n \n+\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName =\n+            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n+        final Sensor[] parents = {};\n+        expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName =\n+            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    @Test\n+    public void shouldGetNewThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(THREAD_ID, sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(THREAD_ID, sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetNewTaskLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID + \".task.\" + TASK_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(THREAD_ID, TASK_ID, sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingTaskLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID + \".task.\" + TASK_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(THREAD_ID, TASK_ID,  sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetNewStoreLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID + \".task.\" + storeName + SENSOR_PREFIX_DELIMITER\n+            + storeName + SENSOR_PREFIX_DELIMITER + TASK_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.storeLevelSensor(THREAD_ID, storeName, TASK_ID,\n+            sensorName1, recordingLevel);\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingStoreLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID + \".task.\" + storeName + SENSOR_PREFIX_DELIMITER\n+            + storeName + SENSOR_PREFIX_DELIMITER + TASK_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.storeLevelSensor(THREAD_ID, storeName, TASK_ID,  sensorName1, recordingLevel);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0Njk0OQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369146949", "bodyText": "Please extract this to its own method since the same code is also used on line 220.", "author": "cadonna", "createdAt": "2020-01-21T17:43:15Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -203,6 +203,171 @@ private void setupGetSensorTest(final Metrics metrics,\n         replay(metrics);\n     }\n \n+\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName =\n+            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE0ODA4MQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369148081", "bodyText": "This test replaces shouldGetThreadLevelSensor(). Thus, you can safely remove shouldGetThreadLevelSensor().", "author": "cadonna", "createdAt": "2020-01-21T17:45:34Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -203,6 +203,171 @@ private void setupGetSensorTest(final Metrics metrics,\n         replay(metrics);\n     }\n \n+\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName =\n+            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n+        final Sensor[] parents = {};\n+        expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName =\n+            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    @Test\n+    public void shouldGetNewThreadLevelSensor() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMTQ3MQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369331471", "bodyText": "This should be private not public.", "author": "cadonna", "createdAt": "2020-01-22T01:31:53Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -203,6 +203,221 @@ private void setupGetSensorTest(final Metrics metrics,\n         replay(metrics);\n     }\n \n+\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n+        final Sensor[] parents = {};\n+        expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    public String fullSensorName(String level) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzOTEzNQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369339135", "bodyText": "Please reformat as follows:\nsetupGetNewSensorTest(\n    metrics, \n    THREAD_ID + \".task.\" + storeName + SENSOR_PREFIX_DELIMITER + storeName + SENSOR_PREFIX_DELIMITER \n    + TASK_ID, \n    recordingLevel\n);\n\nThis applies also to the other locations where the second argument is too long for the line, i.e., lines 322, 343, 364, 385, 406.\nSorry if I missed that in my previous review.", "author": "cadonna", "createdAt": "2020-01-22T02:07:14Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -203,6 +203,221 @@ private void setupGetSensorTest(final Metrics metrics,\n         replay(metrics);\n     }\n \n+\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n+        final Sensor[] parents = {};\n+        expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    public String fullSensorName(String level) {\n+        return INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    }\n+\n+    @Test\n+    public void shouldGetNewThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(\n+            THREAD_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(\n+            THREAD_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetNewTaskLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID + \".task.\" + TASK_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(\n+            THREAD_ID,\n+            TASK_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingTaskLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID + \".task.\" + TASK_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(\n+            THREAD_ID,\n+            TASK_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetNewStoreLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID + \".task.\" + storeName + SENSOR_PREFIX_DELIMITER\n+            + storeName + SENSOR_PREFIX_DELIMITER + TASK_ID, recordingLevel);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5OTY4Ng==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369799686", "bodyText": "Should be final here.", "author": "bbejeck", "createdAt": "2020-01-22T20:59:25Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -193,16 +193,235 @@ private void addSensorsOnAllLevels(final Metrics metrics, final StreamsMetricsIm\n         streamsMetrics.storeLevelSensor(THREAD_ID, TASK_ID, storeName, sensorName2, RecordingLevel.INFO);\n     }\n \n-    private void setupGetSensorTest(final Metrics metrics,\n-                                    final String level,\n-                                    final RecordingLevel recordingLevel) {\n-        final String fullSensorName =\n-            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n         final Sensor[] parents = {};\n         expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n         replay(metrics);\n     }\n \n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private String fullSensorName(String level) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTU1OQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369811559", "bodyText": "Why is(equalToObject(sensor))) and not just is(sensor)?", "author": "bbejeck", "createdAt": "2020-01-22T21:25:09Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -193,16 +193,235 @@ private void addSensorsOnAllLevels(final Metrics metrics, final StreamsMetricsIm\n         streamsMetrics.storeLevelSensor(THREAD_ID, TASK_ID, storeName, sensorName2, RecordingLevel.INFO);\n     }\n \n-    private void setupGetSensorTest(final Metrics metrics,\n-                                    final String level,\n-                                    final RecordingLevel recordingLevel) {\n-        final String fullSensorName =\n-            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n         final Sensor[] parents = {};\n         expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n         replay(metrics);\n     }\n \n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private String fullSensorName(String level) {\n+        return INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    }\n+\n+    @Test\n+    public void shouldGetNewThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(\n+            THREAD_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgzMTY0Nw==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369831647", "bodyText": "That is on me. In this verification it is important to check for reference equality, because you want that threadLevelSensor() returns the sensor that is registered in the Metrics object or that was created by Metrics#sensor().", "author": "cadonna", "createdAt": "2020-01-22T22:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgzNTU5NQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369835595", "bodyText": "Yeah, I get that we want to make sure the same instance is returned.  But since Sensor doesn't override equals, is(sensor) should still do an instance equality check.  It's really a minor point, so I don't care too much if we keep it as is.", "author": "bbejeck", "createdAt": "2020-01-22T22:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgzNjY5Ng==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369836696", "bodyText": "I used equalToObject() because it makes the intent more explicit.", "author": "cadonna", "createdAt": "2020-01-22T22:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgzNzc1OA==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369837758", "bodyText": "Fair enough, let's just leave it as is then.  Thanks for the explanation.", "author": "bbejeck", "createdAt": "2020-01-22T22:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTYzMA==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369811630", "bodyText": "same here", "author": "bbejeck", "createdAt": "2020-01-22T21:25:18Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -193,16 +193,235 @@ private void addSensorsOnAllLevels(final Metrics metrics, final StreamsMetricsIm\n         streamsMetrics.storeLevelSensor(THREAD_ID, TASK_ID, storeName, sensorName2, RecordingLevel.INFO);\n     }\n \n-    private void setupGetSensorTest(final Metrics metrics,\n-                                    final String level,\n-                                    final RecordingLevel recordingLevel) {\n-        final String fullSensorName =\n-            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n         final Sensor[] parents = {};\n         expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n         replay(metrics);\n     }\n \n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private String fullSensorName(String level) {\n+        return INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    }\n+\n+    @Test\n+    public void shouldGetNewThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(\n+            THREAD_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(\n+            THREAD_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgxMTcyOQ==", "url": "https://github.com/apache/kafka/pull/7928#discussion_r369811729", "bodyText": "ditto and same for tests below, I won't repeat this comment.", "author": "bbejeck", "createdAt": "2020-01-22T21:25:28Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/metrics/StreamsMetricsImplTest.java", "diffHunk": "@@ -193,16 +193,235 @@ private void addSensorsOnAllLevels(final Metrics metrics, final StreamsMetricsIm\n         streamsMetrics.storeLevelSensor(THREAD_ID, TASK_ID, storeName, sensorName2, RecordingLevel.INFO);\n     }\n \n-    private void setupGetSensorTest(final Metrics metrics,\n-                                    final String level,\n-                                    final RecordingLevel recordingLevel) {\n-        final String fullSensorName =\n-            INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    private void setupGetNewSensorTest(final Metrics metrics,\n+                                       final String level,\n+                                       final RecordingLevel recordingLevel) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(null);\n         final Sensor[] parents = {};\n         expect(metrics.sensor(fullSensorName, recordingLevel, parents)).andReturn(sensor);\n         replay(metrics);\n     }\n \n+    private void setupGetExistingSensorTest(final Metrics metrics,\n+                                            final String level) {\n+        final String fullSensorName = fullSensorName(level);\n+        expect(metrics.getSensor(fullSensorName)).andStubReturn(sensor);\n+        replay(metrics);\n+    }\n+\n+    private String fullSensorName(String level) {\n+        return INTERNAL_PREFIX + SENSOR_PREFIX_DELIMITER + level + SENSOR_NAME_DELIMITER + sensorName1;\n+    }\n+\n+    @Test\n+    public void shouldGetNewThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(\n+            THREAD_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetExistingThreadLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetExistingSensorTest(metrics, THREAD_ID);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.threadLevelSensor(\n+            THREAD_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));\n+    }\n+\n+    @Test\n+    public void shouldGetNewTaskLevelSensor() {\n+        final Metrics metrics = mock(Metrics.class);\n+        final RecordingLevel recordingLevel = RecordingLevel.INFO;\n+        setupGetNewSensorTest(metrics, THREAD_ID + \".task.\" + TASK_ID, recordingLevel);\n+        final StreamsMetricsImpl streamsMetrics = new StreamsMetricsImpl(metrics, CLIENT_ID, VERSION);\n+\n+        final Sensor actualSensor = streamsMetrics.taskLevelSensor(\n+            THREAD_ID,\n+            TASK_ID,\n+            sensorName1,\n+            recordingLevel\n+        );\n+\n+        verify(metrics);\n+        assertThat(actualSensor, is(equalToObject(sensor)));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e55a741929fa33f80b0a4bfe2bbc34942be8bb84", "url": "https://github.com/apache/kafka/commit/e55a741929fa33f80b0a4bfe2bbc34942be8bb84", "message": "KAFKA-9152; Improve Sensor Retrieval", "committedDate": "2020-01-22T23:42:31Z", "type": "commit"}, {"oid": "e55a741929fa33f80b0a4bfe2bbc34942be8bb84", "url": "https://github.com/apache/kafka/commit/e55a741929fa33f80b0a4bfe2bbc34942be8bb84", "message": "KAFKA-9152; Improve Sensor Retrieval", "committedDate": "2020-01-22T23:42:31Z", "type": "forcePushed"}]}