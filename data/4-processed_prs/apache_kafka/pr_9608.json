{"pr_number": 9608, "pr_title": "MINOR: Enable testLogCleanerStats", "pr_createdAt": "2020-11-18T01:27:24Z", "pr_url": "https://github.com/apache/kafka/pull/9608", "timeline": [{"oid": "1eaa27403f22c841af3915110a7eae5a36d5dabf", "url": "https://github.com/apache/kafka/commit/1eaa27403f22c841af3915110a7eae5a36d5dabf", "message": "Enable and fix up testLogCleanerStats", "committedDate": "2020-11-18T01:20:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0NjM1Ng==", "url": "https://github.com/apache/kafka/pull/9608#discussion_r525646356", "bodyText": "Sorry, but we have several identical comments in other test cases. Are those comments also wrong?", "author": "hachikuji", "createdAt": "2020-11-18T02:02:44Z", "path": "core/src/test/scala/unit/kafka/log/LogCleanerTest.scala", "diffHunk": "@@ -815,9 +815,10 @@ class LogCleanerTest {\n                (0 until leo.toInt by 2).forall(!keys.contains(_)))\n   }\n \n+  @Test\n   def testLogCleanerStats(): Unit = {\n-    // because loadFactor is 0.75, this means we can fit 2 messages in the map\n-    val cleaner = makeCleaner(2)\n+    // because loadFactor is 0.75, this means we can fit 3 messages in the map", "originalCommit": "1eaa27403f22c841af3915110a7eae5a36d5dabf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxMjI4OA==", "url": "https://github.com/apache/kafka/pull/9608#discussion_r526412288", "bodyText": "I took a look at the testPartialSegmentClean which also uses makeCleaner(2), and noticed it does multiple clean attempts since it keeps filling its map, so the logic of the tests are ok. I think the comments are misleading, I traced the code to LogCleaner.buildOffsetMapForSegment , and there's this line:\nval maxDesiredMapSize = (map.slots * this.dupBufferLoadFactor).toInt\n\nSo we will only be able to put one offset in the map, and won't attempt to put anything else after that one even if it's the same key. I am going to change the comments", "author": "mattwong949", "createdAt": "2020-11-18T20:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0NjM1Ng=="}], "type": "inlineReview"}, {"oid": "25d73843e301a0063da23d44f2de78863b5d16a0", "url": "https://github.com/apache/kafka/commit/25d73843e301a0063da23d44f2de78863b5d16a0", "message": "Fix comment", "committedDate": "2020-11-18T20:57:19Z", "type": "commit"}, {"oid": "f1e28982f952ac4b1c97fb9aa32f0b037f330bfa", "url": "https://github.com/apache/kafka/commit/f1e28982f952ac4b1c97fb9aa32f0b037f330bfa", "message": "Make test more readable", "committedDate": "2020-11-18T21:02:44Z", "type": "commit"}]}