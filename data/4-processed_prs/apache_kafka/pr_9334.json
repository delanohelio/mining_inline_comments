{"pr_number": 9334, "pr_title": "KAFKA-10516; Disable automatic retry of `THROTTLING_QUOTA_EXCEEDED` errors in the `kafka-topics` command (KIP-599)", "pr_createdAt": "2020-09-24T08:47:58Z", "pr_url": "https://github.com/apache/kafka/pull/9334", "timeline": [{"oid": "944fed587e6db03786f8c0d30b2dc1d7156b8fd0", "url": "https://github.com/apache/kafka/commit/944fed587e6db03786f8c0d30b2dc1d7156b8fd0", "message": "DeleteTopicsResponse's ErrorMessage must be null by default otherwise clients do not fallback to the default error message.", "committedDate": "2020-09-23T14:13:47Z", "type": "commit"}, {"oid": "d76fc60ffc314be5425f99fcc8516a679a4326d6", "url": "https://github.com/apache/kafka/commit/d76fc60ffc314be5425f99fcc8516a679a4326d6", "message": "Disable automatic retry of ThrottlingQuotaExceededException in `kafka-topics` command", "committedDate": "2020-09-24T08:42:38Z", "type": "commit"}, {"oid": "abefd506b997f414227fa57fe83a07bd557dfb46", "url": "https://github.com/apache/kafka/commit/abefd506b997f414227fa57fe83a07bd557dfb46", "message": "checkstyle :)", "committedDate": "2020-09-24T09:55:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxMDEyMQ==", "url": "https://github.com/apache/kafka/pull/9334#discussion_r494510121", "bodyText": "Couldn't we just use error(message, e)?", "author": "rajinisivaram", "createdAt": "2020-09-24T18:03:27Z", "path": "core/src/main/scala/kafka/admin/TopicCommand.scala", "diffHunk": "@@ -69,16 +71,26 @@ object TopicCommand extends Logging {\n       else if (opts.hasDeleteOption)\n         topicService.deleteTopic(opts)\n     } catch {\n+      case e: ExecutionException =>\n+        if (e.getCause != null)\n+          printException(e.getCause)\n+        else\n+          printException(e)\n+        exitCode = 1\n       case e: Throwable =>\n-        println(\"Error while executing topic command : \" + e.getMessage)\n-        error(Utils.stackTrace(e))\n+        printException(e)\n         exitCode = 1\n     } finally {\n       topicService.close()\n       Exit.exit(exitCode)\n     }\n   }\n \n+  private def printException(e: Throwable): Unit = {\n+    println(\"Error while executing topic command : \" + e.getMessage)\n+    error(Utils.stackTrace(e))", "originalCommit": "abefd506b997f414227fa57fe83a07bd557dfb46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxNTE2OA==", "url": "https://github.com/apache/kafka/pull/9334#discussion_r494815168", "bodyText": "Do you mean using error(message, e) to replace both println and error? I think that we are using 'printlnhere in order to print the message to stdout without any logger related stuff and regardless of how the logger is configured. Changing to usingerror(message, e)would break this and potentially break existing application due to introducing the logger related stuff for that message. I think that we should keepprintln` here.\nHowever, I wonder if using error is appropriate here as it basically prints a stacktrace for every errors. The UX does not look good. Would it make sense to use debug instead? The message of the exception is printed anyway and I don't think that the stacktrace provides much to regular users. WDYT?", "author": "dajac", "createdAt": "2020-09-25T07:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxMDEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzNzU1Ng==", "url": "https://github.com/apache/kafka/pull/9334#discussion_r494837556", "bodyText": "Sorry, I should have been more clear. I just meant, why do we call Utils.stackTrace(e)) when error(message, e) gives you a stack trace for free. In terms of changing from error to debug, I think we include stack track in other commands. But each command seems to use something different. ConfigCommand, for example, doesn't print stacktrace for config exceptions. It logs both the error message and stacktrace to stderr. AclCommand prints for everything to stdout. Let's just keep error for now and maybe open a JIRA to improve and make tools consistent later?", "author": "rajinisivaram", "createdAt": "2020-09-25T08:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxMDEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg1NjQ1MQ==", "url": "https://github.com/apache/kafka/pull/9334#discussion_r494856451", "bodyText": "That's a very good question. I guess that we did so in order to just print out the stacktrace without the message. Otherwise, we would have the error message printed out by the println, followed by the same message printed out by logger, followed by the stacktrace. Having the message twice is not necessary. I had a quick look at other commands and we do so everywhere.\nI will open a JIRA to make tools more consistent. Good idea.", "author": "dajac", "createdAt": "2020-09-25T09:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxMDEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUyNzUwMw==", "url": "https://github.com/apache/kafka/pull/9334#discussion_r494527503", "bodyText": "May be worth importing org.mockito.Mockito._ and  org.mockito.ArgumentMatchers._ to avoid repeating the class name everywhere.", "author": "rajinisivaram", "createdAt": "2020-09-24T18:30:28Z", "path": "core/src/test/scala/unit/kafka/admin/TopicCommandWithAdminClientTest.scala", "diffHunk": "@@ -844,4 +851,72 @@ class TopicCommandWithAdminClientTest extends KafkaServerTestHarness with Loggin\n     assertEquals(2, rows.size)\n     rows(0).startsWith(s\"Topic:$testTopicName\\tPartitionCount:1\")\n   }\n+\n+  @Test\n+  def testCreateTopicDoesNotRetryThrottlingQuotaExceededException(): Unit = {\n+    val adminClient = Mockito.mock(classOf[Admin])\n+    val topicService = AdminClientTopicService(adminClient)\n+\n+    val result = AdminClientTestUtils.createTopicsResult(testTopicName, Errors.THROTTLING_QUOTA_EXCEEDED.exception())\n+    Mockito.when(adminClient.createTopics(ArgumentMatchers.any(), ArgumentMatchers.any())).thenReturn(result)", "originalCommit": "abefd506b997f414227fa57fe83a07bd557dfb46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgxMDc2OQ==", "url": "https://github.com/apache/kafka/pull/9334#discussion_r494810769", "bodyText": "That makes sense. I had to introduce an alias for ArgumentMatchers.eq to not conflict with eq. I went with eqThat to remain inline with argThat.", "author": "dajac", "createdAt": "2020-09-25T07:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUyNzUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUyODM4MA==", "url": "https://github.com/apache/kafka/pull/9334#discussion_r494528380", "bodyText": "We could just use Optional.empty instead of creating in Scala and converting?", "author": "rajinisivaram", "createdAt": "2020-09-24T18:31:16Z", "path": "core/src/test/scala/unit/kafka/admin/TopicCommandWithAdminClientTest.scala", "diffHunk": "@@ -844,4 +851,72 @@ class TopicCommandWithAdminClientTest extends KafkaServerTestHarness with Loggin\n     assertEquals(2, rows.size)\n     rows(0).startsWith(s\"Topic:$testTopicName\\tPartitionCount:1\")\n   }\n+\n+  @Test\n+  def testCreateTopicDoesNotRetryThrottlingQuotaExceededException(): Unit = {\n+    val adminClient = Mockito.mock(classOf[Admin])\n+    val topicService = AdminClientTopicService(adminClient)\n+\n+    val result = AdminClientTestUtils.createTopicsResult(testTopicName, Errors.THROTTLING_QUOTA_EXCEEDED.exception())\n+    Mockito.when(adminClient.createTopics(ArgumentMatchers.any(), ArgumentMatchers.any())).thenReturn(result)\n+\n+    assertThrows(classOf[ThrottlingQuotaExceededException],\n+      () => topicService.createTopic(new TopicCommandOptions(Array(\"--topic\", testTopicName))))\n+\n+    val expectedNewTopic = new NewTopic(testTopicName, Option.empty[Integer].asJava, Option.empty[java.lang.Short].asJava)", "originalCommit": "abefd506b997f414227fa57fe83a07bd557dfb46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac04463df97aad9ca5f2b8ce959ed1e9c5de17ec", "url": "https://github.com/apache/kafka/commit/ac04463df97aad9ca5f2b8ce959ed1e9c5de17ec", "message": "Address Rajini's feedback", "committedDate": "2020-09-25T07:49:05Z", "type": "commit"}]}