{"pr_number": 9284, "pr_title": "KAFKA-10479 Throw exception if users try to update configs of existen\u2026", "pr_createdAt": "2020-09-14T14:10:10Z", "pr_url": "https://github.com/apache/kafka/pull/9284", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ0OTk0Nw==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r490449947", "bodyText": "Right, this line does not work correctly as of present.", "author": "dongjinleekr", "createdAt": "2020-09-17T17:54:09Z", "path": "core/src/main/scala/kafka/server/DynamicBrokerConfig.scala", "diffHunk": "@@ -910,6 +903,11 @@ class DynamicListenerConfig(server: KafkaServer) extends BrokerReconfigurable wi\n     if (!newListeners.keySet.subsetOf(newConfig.listenerSecurityProtocolMap.keySet))\n       throw new ConfigException(s\"Listeners '$newListeners' must be subset of listener map '${newConfig.listenerSecurityProtocolMap}'\")\n     newListeners.keySet.intersect(oldListeners.keySet).foreach { listenerName =>\n+      def immutableListenerConfigs(kafkaConfig: KafkaConfig, prefix: String): Map[String, AnyRef] = {\n+        kafkaConfig.originals.asScala.filter { case (key, _) =>\n+          key.startsWith(prefix) && !DynamicSecurityConfigs.contains(key)\n+        }\n+      }\n       val prefix = listenerName.configPrefix\n       val newListenerProps = immutableListenerConfigs(newConfig, prefix)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495973438", "bodyText": "Does it really break compatibility? It seems like the previous behavior wasn't working as intended anyway.", "author": "ijuma", "createdAt": "2020-09-28T14:16:18Z", "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not\n+        worth keeping since that behavior is unintended. see\n+        <a href=\"https://github.com/apache/kafka/pull/9284\">KAFKA-10479</a> for more discussion.\n+        see <code>DynamicBrokerConfig.DynamicSecurityConfigs</code> and <code>SocketServer.ListenerReconfigurableConfigs</code>\n+        for reconfigurable configs of existent listeners.\n+    </li>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4MzI4Mw==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495983283", "bodyText": "Does it really break compatibility? It seems like the previous behavior wasn't working as intended anyway.\n\nIt seems to me the APIs behavior is changed so the compatibility is broken.\nFor example, the code which is used to change non-reconfigurable configs gets exception now so users have to write something to handle \"new\" exception. Of course, that case should be very rare so mentioning this in docs/upgrade.html is enough to this incompatible change.", "author": "chia7712", "createdAt": "2020-09-28T14:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4ODE1Mw==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495988153", "bodyText": "I know what you're saying, but this change aligns the implementation with the specified behavior. The previous behavior was a bug as it failed to report an error even though it did not change the config dynamically.", "author": "ijuma", "createdAt": "2020-09-28T14:36:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5MjE2OQ==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495992169", "bodyText": "The previous behavior was a bug as it failed to report an error even though it did not change the config dynamically.\n\nok. it makes sense. I will remove this comment from docs/upgrade.html", "author": "chia7712", "createdAt": "2020-09-28T14:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxMTczNA==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496011734", "bodyText": "I think we should keep the comment, I was suggesting we tweak the description.", "author": "ijuma", "createdAt": "2020-09-28T15:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxMzEzNw==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496013137", "bodyText": "I think we should keep the comment, I was suggesting we tweak the description.\n\ngot it.", "author": "chia7712", "createdAt": "2020-09-28T15:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3MzQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3NDA5OA==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495974098", "bodyText": "It is possible to update configs of existing listeners if they are dynamic, right?", "author": "ijuma", "createdAt": "2020-09-28T14:17:18Z", "path": "core/src/test/scala/unit/kafka/server/DynamicBrokerConfigTest.scala", "diffHunk": "@@ -327,10 +327,12 @@ class DynamicBrokerConfigTest {\n     EasyMock.replay(kafkaServer)\n \n     props.put(KafkaConfig.ListenersProp, \"PLAINTEXT://hostname:9092,SASL_PLAINTEXT://hostname:9093\")\n-    val newConfig = KafkaConfig(props)\n+    new DynamicListenerConfig(kafkaServer).validateReconfiguration(KafkaConfig(props))\n \n+    // it is illegal to update configs of existent listeners\n+    props.put(\"listener.name.plaintext.you.should.not.pass\", \"failure\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4Mzc2OA==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r495983768", "bodyText": "you are right. I will revise the comment.", "author": "chia7712", "createdAt": "2020-09-28T14:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3NDA5OA=="}], "type": "inlineReview"}, {"oid": "d72c27970bbefd380ee18964948ee06b302a7ad8", "url": "https://github.com/apache/kafka/commit/d72c27970bbefd380ee18964948ee06b302a7ad8", "message": "KAFKA-10479 Throw exception if users try to update configs of existent listeners", "committedDate": "2020-09-28T15:26:43Z", "type": "commit"}, {"oid": "ca3d11de2afcf498a8e815fece433762e7aaa057", "url": "https://github.com/apache/kafka/commit/ca3d11de2afcf498a8e815fece433762e7aaa057", "message": "exclude configurable configs", "committedDate": "2020-09-28T15:26:43Z", "type": "commit"}, {"oid": "877cbe5b3eb6dfc671c4bb7c13b445afb1e666de", "url": "https://github.com/apache/kafka/commit/877cbe5b3eb6dfc671c4bb7c13b445afb1e666de", "message": "mention this PR in docs/upgrade.html", "committedDate": "2020-09-28T15:26:43Z", "type": "commit"}, {"oid": "efb8f2883f15c27afe2f91b9b3496aeb8e9fb0c3", "url": "https://github.com/apache/kafka/commit/efb8f2883f15c27afe2f91b9b3496aeb8e9fb0c3", "message": "tweak comment", "committedDate": "2020-09-28T15:41:26Z", "type": "commit"}, {"oid": "efb8f2883f15c27afe2f91b9b3496aeb8e9fb0c3", "url": "https://github.com/apache/kafka/commit/efb8f2883f15c27afe2f91b9b3496aeb8e9fb0c3", "message": "tweak comment", "committedDate": "2020-09-28T15:41:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NzI3NA==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496287274", "bodyText": "nit: can we take out the sentence about behavior compatibility. I think it is enough to say that the previous behavior was unintended.", "author": "hachikuji", "createdAt": "2020-09-28T23:19:39Z", "path": "docs/upgrade.html", "diffHunk": "@@ -27,6 +27,14 @@ <h5><a id=\"upgrade_270_notable\" href=\"#upgrade_270_notable\">Notable changes in 2\n         <code>default.api.timeout.ms</code>, and Kafka Streams' new <code>task.timeout.ms</code> parameters instead.\n         Note that parameter <code>retry.backoff.ms</code> is not impacted by this change.\n     </li>\n+    <li>Altering non-reconfigurable configs of existent listeners causes <code>InvalidRequestException</code>.\n+        By contrast, the previous behavior would have caused the updated configuration to be persisted, but it wouldn't\n+        take effect until the broker was restarted. This change breaks behavior compatibility but the old behavior is not", "originalCommit": "877cbe5b3eb6dfc671c4bb7c13b445afb1e666de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM0MDYzMg==", "url": "https://github.com/apache/kafka/pull/9284#discussion_r496340632", "bodyText": "I had deleted the sentence about behavior compatibility :)", "author": "chia7712", "createdAt": "2020-09-29T02:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4NzI3NA=="}], "type": "inlineReview"}, {"oid": "9d7b08752bf8ffc5ad9dcc012ff001f5c7169189", "url": "https://github.com/apache/kafka/commit/9d7b08752bf8ffc5ad9dcc012ff001f5c7169189", "message": "Minor message tweak in upgrade notes\n\nRemoved the comment about the old behavior not being worth maintaining", "committedDate": "2020-09-29T18:36:11Z", "type": "commit"}]}