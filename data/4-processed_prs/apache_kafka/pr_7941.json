{"pr_number": 7941, "pr_title": "KAFKA-9181; Maintain clean separation between local and group subscriptions in consumer's SubscriptionState", "pr_createdAt": "2020-01-12T16:51:09Z", "pr_url": "https://github.com/apache/kafka/pull/7941", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMjU2MA==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r366102560", "bodyText": "Do we need this? Seems like we have access to the SubscriptionState object already in the test case.", "author": "hachikuji", "createdAt": "2020-01-14T00:39:40Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java", "diffHunk": "@@ -1386,4 +1387,8 @@ public void invoke() {\n     RebalanceProtocol getProtocol() {\n         return protocol;\n     }\n+\n+    SubscriptionState subscriptions() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjExMzMwMw==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r366113303", "bodyText": "I'm confused about a couple things. First, if a subscription changes while we are in the middle of a rebalance, do we need to call onJoinPrepare again? With the old semantics, we probably didn't need to because we revoked everything, but with \"cooperative\" rebalancing, perhaps we should?  cc @guozhangwang\nThe second thing is that it seems surprising that we raise auth errors from the \"group subscription.\" If consumer 1 has subscribed to \"A\" and consumer 2 has subscribed to \"B,\" I probably wouldn't expect to get any auth errors for topic \"B\" from consumer 1. So maybe we should be ignoring auth errors not part of subscription()? Not sure if that is straightforward or if there are any additional implications.", "author": "hachikuji", "createdAt": "2020-01-14T01:25:24Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java", "diffHunk": "@@ -211,6 +211,7 @@ public String protocolType() {\n     protected JoinGroupRequestData.JoinGroupRequestProtocolCollection metadata() {\n         log.debug(\"Joining group with current subscription: {}\", subscriptions.subscription());\n         this.joinedSubscription = subscriptions.subscription();\n+        subscriptions.resetGroupSubscription();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUwOTM3Mg==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r366509372", "bodyText": "@hachikuji Thanks for the review. If we decide that we always need to do onJoinPrepare, then we won't need this fix.\nIt is odd to propagate authorization failures from the group subscription since that feels more like an implementation detail. But at the same time, if we don't get metadata for some topics, is there any point in adding topics from group subscription to the ConsumerMetadata? We probably need to update javadoc for poll() if we don't change the current behaviour.", "author": "rajinisivaram", "createdAt": "2020-01-14T18:45:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjExMzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4MjMxMg==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r367082312", "bodyText": "Regarding the first question, if a subscription changes while we are in the middle of a rebalance we would call onPartitionsRevoked immediately on those still-assigned partitions that are not part of the new subscription any more, and for the returned assignment we check if they match our join-subscription and if not we trigger another rebalance (this is pre-429). So I think we still do not need to re-trigger onJoinPrepare when subscription changes in the middle.", "author": "guozhangwang", "createdAt": "2020-01-15T20:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjExMzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4NDIyMA==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r367784220", "bodyText": "@rajinisivaram I think I understand the problem a little better now and I'm coming around to the approach in this PR. It does make sense to me to reset the group subscription at the time that we set joinedSubscription in ConsumerCoordinator. Then I guess my only question is whether we still need to reset it inside onJoinPrepare as well?\nAnother (possibly worse) idea I had is to change the implementation of resetGroupSubscription. Perhaps instead of setting it equal to the current local subscription, we should set it to null or empty. We could try to maintain a cleaner separation between the local and group subscriptions. We would then need to update ConsumerMetadata to work with both the local and group subscription.", "author": "hachikuji", "createdAt": "2020-01-17T06:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjExMzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyMDIzOA==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r369620238", "bodyText": "@hachikuji Thanks for the reviews. I pushed two commits. The first one just removes reset from onJoinPrepare since we don't need it any more. I also wanted to try out your suggestion of maintaining clean separation between local and group subscriptions. The last commit does this. Do you think it is worth making that change?", "author": "rajinisivaram", "createdAt": "2020-01-22T15:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjExMzMwMw=="}], "type": "inlineReview"}, {"oid": "63aa4e38d29862618e934a49a5671dee3ad2463d", "url": "https://github.com/apache/kafka/commit/63aa4e38d29862618e934a49a5671dee3ad2463d", "message": "KAFKA-9181; Ensure SubscriptionState.groupSubscription is updated even if onJoinPrepare not invoked after subscribe", "committedDate": "2020-01-22T12:44:18Z", "type": "commit"}, {"oid": "4384fbce029ab8431d82263bfb1c6079e69e6a81", "url": "https://github.com/apache/kafka/commit/4384fbce029ab8431d82263bfb1c6079e69e6a81", "message": "Address review comment", "committedDate": "2020-01-22T12:44:18Z", "type": "commit"}, {"oid": "797aa7c527de1ea635fa045aec4ea53693e38792", "url": "https://github.com/apache/kafka/commit/797aa7c527de1ea635fa045aec4ea53693e38792", "message": "Address review comment", "committedDate": "2020-01-22T14:43:45Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "6f574eaaa40d40b530808a50ced0f328012ade99", "url": "https://github.com/apache/kafka/commit/6f574eaaa40d40b530808a50ced0f328012ade99", "message": "Don't include subscription topics in `groupSubscription`", "committedDate": "2020-01-22T15:12:46Z", "type": "commit"}, {"oid": "6f574eaaa40d40b530808a50ced0f328012ade99", "url": "https://github.com/apache/kafka/commit/6f574eaaa40d40b530808a50ced0f328012ade99", "message": "Don't include subscription topics in `groupSubscription`", "committedDate": "2020-01-22T15:12:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczNDkwMQ==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r369734901", "bodyText": "It might borderline overkill, but I'm considering if we could avoid the copy here with logic like the following:\nif (!groupSubscription.isEmpty())\n  return groupSubscription;\nelse\n  return subscription;\n\nBasically relying on the the group subscription being a superset of the local subscription when it is defined.", "author": "hachikuji", "createdAt": "2020-01-22T18:41:28Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/SubscriptionState.java", "diffHunk": "@@ -335,22 +329,24 @@ synchronized boolean matchesSubscribedPattern(String topic) {\n     }\n \n     /**\n-     * Get the subscription for the group. For the leader, this will include the union of the\n-     * subscriptions of all group members. For followers, it is just that member's subscription.\n-     * This is used when querying topic metadata to detect the metadata changes which would\n+     * Get the subcription topics for which metadata is required . For the leader, this will include\n+     * the union of the subscriptions of all group members. For followers, it is just that member's\n+     * subscription. This is used when querying topic metadata to detect the metadata changes which would\n      * require rebalancing. The leader fetches metadata for all topics in the group so that it\n      * can do the partition assignment (which requires at least partition counts for all topics\n      * to be assigned).\n      *\n      * @return The union of all subscribed topics in the group if this member is the leader\n      *   of the current generation; otherwise it returns the same set as {@link #subscription()}\n      */\n-    synchronized Set<String> groupSubscription() {\n-        return this.groupSubscription;\n+    synchronized Set<String> metadataTopics() {\n+        Set<String> topics = new HashSet<>(groupSubscription);", "originalCommit": "6f574eaaa40d40b530808a50ced0f328012ade99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc4ODc1MQ==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r369788751", "bodyText": "@hachikuji Thanks for the review, updated. I had to update one unit test since it wasn't using a superset for group subscription, but think that is ok.", "author": "rajinisivaram", "createdAt": "2020-01-22T20:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczNDkwMQ=="}], "type": "inlineReview"}, {"oid": "57765e11ecfa34b51048e1f1c361ecf1ab63dbd2", "url": "https://github.com/apache/kafka/commit/57765e11ecfa34b51048e1f1c361ecf1ab63dbd2", "message": "Address review comment", "committedDate": "2020-01-22T20:28:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxOTI3OQ==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r370219279", "bodyText": "I guess we could restore this location with the change to the group subscription maintenance? I don't feel too strongly since the new location works also.", "author": "hachikuji", "createdAt": "2020-01-23T16:22:43Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java", "diffHunk": "@@ -689,7 +690,6 @@ protected void onJoinPrepare(int generation, String memberId) {\n         }\n \n         isLeader = false;\n-        subscriptions.resetGroupSubscription();", "originalCommit": "57765e11ecfa34b51048e1f1c361ecf1ab63dbd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyODgxNg==", "url": "https://github.com/apache/kafka/pull/7941#discussion_r370228816", "bodyText": "@hachikuji Thanks for the review. Restored this so that the only change from this PR is the clean separation of group and local subscriptions", "author": "rajinisivaram", "createdAt": "2020-01-23T16:38:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIxOTI3OQ=="}], "type": "inlineReview"}, {"oid": "18a4917904d5aa779ec590d682afeb5d746f03a0", "url": "https://github.com/apache/kafka/commit/18a4917904d5aa779ec590d682afeb5d746f03a0", "message": "Address review comment", "committedDate": "2020-01-23T16:35:22Z", "type": "commit"}]}