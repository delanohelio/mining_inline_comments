{"pr_number": 9174, "pr_title": "KAFKA-10395: relax output topic check in TTD to work with dynamic routing", "pr_createdAt": "2020-08-13T01:11:47Z", "pr_url": "https://github.com/apache/kafka/pull/9174", "timeline": [{"oid": "c83ca9516943de7c622c4816df8d64410cd05adf", "url": "https://github.com/apache/kafka/commit/c83ca9516943de7c622c4816df8d64410cd05adf", "message": "relax check to just a warning, add test coverage", "committedDate": "2020-08-13T01:08:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcxMjM0NA==", "url": "https://github.com/apache/kafka/pull/9174#discussion_r469712344", "bodyText": "nit: could avoid the last space after is correct.", "author": "abbccdda", "createdAt": "2020-08-13T05:52:59Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -805,10 +805,10 @@ public void advanceWallClockTime(final Duration advance) {\n \n     private Queue<ProducerRecord<byte[], byte[]>> getRecordsQueue(final String topicName) {\n         final Queue<ProducerRecord<byte[], byte[]>> outputRecords = outputRecordsByTopic.get(topicName);\n-        if (outputRecords == null) {\n-            if (!processorTopology.sinkTopics().contains(topicName)) {\n-                throw new IllegalArgumentException(\"Unknown topic: \" + topicName);\n-            }\n+        if (outputRecords == null && !processorTopology.sinkTopics().contains(topicName)) {\n+            log.warn(\"Unrecognized topic: {}, this can occur if dynamic routing is used and no output has been \"\n+                         + \"sent to this topic yet. If not using a TopicNameExtractor, check that the output topic \"\n+                         + \"is correct. \", topicName);", "originalCommit": "c83ca9516943de7c622c4816df8d64410cd05adf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcxMzE3NQ==", "url": "https://github.com/apache/kafka/pull/9174#discussion_r469713175", "bodyText": "Seems good enough as a bug fix, but I was wondering whether we could detect the dynamic topic is configured or not to make sure we are not actually allowing some other bugs to catch in TTD", "author": "abbccdda", "createdAt": "2020-08-13T05:55:13Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -805,10 +805,10 @@ public void advanceWallClockTime(final Duration advance) {\n \n     private Queue<ProducerRecord<byte[], byte[]>> getRecordsQueue(final String topicName) {\n         final Queue<ProducerRecord<byte[], byte[]>> outputRecords = outputRecordsByTopic.get(topicName);\n-        if (outputRecords == null) {\n-            if (!processorTopology.sinkTopics().contains(topicName)) {\n-                throw new IllegalArgumentException(\"Unknown topic: \" + topicName);\n-            }\n+        if (outputRecords == null && !processorTopology.sinkTopics().contains(topicName)) {", "originalCommit": "c83ca9516943de7c622c4816df8d64410cd05adf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDEzNDEzNg==", "url": "https://github.com/apache/kafka/pull/9174#discussion_r470134136", "bodyText": "What do you mean by \"configured\"? My understanding is that topics don't actually even \"exist\" in the TTD, we just use a MockProducer and grab output records from its history to enqueue in the outputRecordsByTopic map. So if an output topic hasn't been sent to yet, there's no way to say whether it does or does not exist", "author": "ableegoldman", "createdAt": "2020-08-13T17:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcxMzE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5MzU3OA==", "url": "https://github.com/apache/kafka/pull/9174#discussion_r470193578", "bodyText": "We could detect if the processorTopology contains only StaticTopicNameExtractors and still throw in that case if the topic name isn't in the topology.", "author": "vvcephei", "createdAt": "2020-08-13T19:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcxMzE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3NDI5MQ==", "url": "https://github.com/apache/kafka/pull/9174#discussion_r470374291", "bodyText": "Yeah, that's a good point. Took a quick look at this and personally I feel it's not worth it to add even more things for the internal topology to track. But it wouldn't really add any complexity so if this is a big concern I can go ahead and add in a flag to watch out for any non-static TopicNameExtractors", "author": "ableegoldman", "createdAt": "2020-08-14T02:21:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcxMzE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0Mjg5MA==", "url": "https://github.com/apache/kafka/pull/9174#discussion_r472242890", "bodyText": "Ok, let's just keep it in our back pocket for now.", "author": "vvcephei", "createdAt": "2020-08-18T14:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcxMzE3NQ=="}], "type": "inlineReview"}, {"oid": "8edc8f4720b89ef6e246dd3ed0b194a4eec8ea83", "url": "https://github.com/apache/kafka/commit/8edc8f4720b89ef6e246dd3ed0b194a4eec8ea83", "message": "fix test and remove extra space", "committedDate": "2020-08-13T17:37:21Z", "type": "commit"}]}