{"pr_number": 8322, "pr_title": "MINOR: Restore and global consumers should never have group.instance.id", "pr_createdAt": "2020-03-20T20:51:02Z", "pr_url": "https://github.com/apache/kafka/pull/8322", "timeline": [{"oid": "ff02bf5d3756d4209531ab46b70c9e0f6a4e455c", "url": "https://github.com/apache/kafka/commit/ff02bf5d3756d4209531ab46b70c9e0f6a4e455c", "message": "one pass", "committedDate": "2020-03-20T20:47:48Z", "type": "commit"}, {"oid": "144ebda3bdb196fc2d9dd1a5f6c1bfb9d94ef8c1", "url": "https://github.com/apache/kafka/commit/144ebda3bdb196fc2d9dd1a5f6c1bfb9d94ef8c1", "message": "checkstyle", "committedDate": "2020-03-20T21:38:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwNTc3Ng==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r395905776", "bodyText": "The restore consumer should never hit this error. Hence, I am wondering if we actually need this test? Does it make sense to test for something that will/should never happen?\nWe should rather have a test that the restore consumer is never configured with an group.instance.id config if we don't have such a test.", "author": "mjsax", "createdAt": "2020-03-20T21:51:46Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreChangelogReaderTest.java", "diffHunk": "@@ -943,6 +946,31 @@ public void shouldThrowIfRestoreCallbackThrows() {\n         assertEquals(kaboom, thrown.getCause());\n     }\n \n+    @Test\n+    public void shouldThrowIfRestoreGetInstanceFenced() {", "originalCommit": "144ebda3bdb196fc2d9dd1a5f6c1bfb9d94ef8c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwNzg0MQ==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r395907841", "bodyText": "Actually we do not forbid users to set instance.id in restore.consumer, it's just that since restore consumer never uses subscribe it would not join-group and hence should not get this exception ever -- so personally I agree with you that this test is not very significant by itself but just to tighten the logic in case the restore consumer calls subscribe (mistakenly?) later.", "author": "guozhangwang", "createdAt": "2020-03-20T21:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwNTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMjEzMA==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r395912130", "bodyText": "Should we improve StreamsConfig#getRestoreConsumerConfigs() (and also for global consumer) accordingly, to remove group.instance.id if set and log a INFO message? (Plus a corresponding test?)\nWe can of course still keep this test. But if we test that we don't catch FencedInstanceIdException on the restore consumer, should we add corresponding tests for the main and global consumer, too?", "author": "mjsax", "createdAt": "2020-03-20T22:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwNTc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzMzk4Mg==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r395933982", "bodyText": "I'm more inclined to @mjsax idea here, we should probably just ensure no instance.id being set for restore consumer in the config level, instead of doing a unit test.", "author": "abbccdda", "createdAt": "2020-03-20T23:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwNTc3Ng=="}], "type": "inlineReview"}, {"oid": "1e5c4d024816069397539ce427c0f5a42571b15d", "url": "https://github.com/apache/kafka/commit/1e5c4d024816069397539ce427c0f5a42571b15d", "message": "rebase from trunk", "committedDate": "2020-03-23T17:34:47Z", "type": "commit"}, {"oid": "160acd197340ef183ea5af15f34ef9790a67b70b", "url": "https://github.com/apache/kafka/commit/160acd197340ef183ea5af15f34ef9790a67b70b", "message": "do not allow instance id in restore and global consumer", "committedDate": "2020-03-23T18:05:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NDgxNA==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396694814", "bodyText": "Should this be GROUP_INSTANCE_ID_CONFIG ?", "author": "mjsax", "createdAt": "2020-03-23T19:14:19Z", "path": "streams/src/test/java/org/apache/kafka/streams/StreamsConfigTest.java", "diffHunk": "@@ -185,8 +195,10 @@ public void consumerConfigShouldContainAdminClientConfigsForRetriesAndRetryBackO\n     public void testGetMainConsumerConfigsWithMainConsumerOverridenPrefix() {\n         props.put(StreamsConfig.consumerPrefix(ConsumerConfig.MAX_POLL_RECORDS_CONFIG), \"5\");\n         props.put(StreamsConfig.mainConsumerPrefix(ConsumerConfig.MAX_POLL_RECORDS_CONFIG), \"50\");\n+        props.put(StreamsConfig.mainConsumerPrefix(ConsumerConfig.GROUP_ID_CONFIG), \"another-id\");", "originalCommit": "160acd197340ef183ea5af15f34ef9790a67b70b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2OTQwMA==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396769400", "bodyText": "This is a piggy-backed test coverage not directly related to the PR --- I wanted to make sure that whatever user specified group id is always overridden by the streams itself.", "author": "guozhangwang", "createdAt": "2020-03-23T21:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NDgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMTg5MQ==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396831891", "bodyText": "Ack.\nShould we test that the GROUP_INSTANCE_ID is set correctly based on the user config for the main consumer (or do we have a test for this already?)", "author": "mjsax", "createdAt": "2020-03-24T00:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NDgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NjM3OA==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396696378", "bodyText": "Why do we need this 3 lines? Setting the config without prefix would set it for all consumers anyway?\nIf you want to test the overwrite with prefix, should it be it's own test?", "author": "mjsax", "createdAt": "2020-03-23T19:17:10Z", "path": "streams/src/test/java/org/apache/kafka/streams/StreamsConfigTest.java", "diffHunk": "@@ -141,9 +141,19 @@ public void testGetConsumerConfigs() {\n     @Test\n     public void testGetGroupInstanceIdConfigs() {\n         props.put(ConsumerConfig.GROUP_INSTANCE_ID_CONFIG, \"group-instance-id\");\n+        props.put(StreamsConfig.mainConsumerPrefix(ConsumerConfig.GROUP_INSTANCE_ID_CONFIG), \"group-instance-id-1\");\n+        props.put(StreamsConfig.restoreConsumerPrefix(ConsumerConfig.GROUP_INSTANCE_ID_CONFIG), \"group-instance-id-2\");\n+        props.put(StreamsConfig.globalConsumerPrefix(ConsumerConfig.GROUP_INSTANCE_ID_CONFIG), \"group-instance-id-3\");", "originalCommit": "160acd197340ef183ea5af15f34ef9790a67b70b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2ODUyMg==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396768522", "bodyText": "I want to check that no prefix would take effects here -- note I used different values for different overrides, so if it is violated we know which prefix introduced the violation.", "author": "guozhangwang", "createdAt": "2020-03-23T21:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NjM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMjAyMw==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396832023", "bodyText": "Ack", "author": "mjsax", "createdAt": "2020-03-24T00:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5NjM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Nzk1OQ==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396697959", "bodyText": "Side note: We actually have NON_CONFIGURABLE_CONSUMER_DEFAULT_CONFIGS (similar for producer and EOS). I am wondering, if we should add a similar pattern for the restore and global consumer (might be good enough as a follow up PR though; or at least create a ticket for now?). This include logging a WARNING if a user tries to set it?", "author": "mjsax", "createdAt": "2020-03-23T19:19:56Z", "path": "streams/src/main/java/org/apache/kafka/streams/StreamsConfig.java", "diffHunk": "@@ -1199,6 +1199,9 @@ private void verifyMaxInFlightRequestPerConnection(final Object maxInFlightReque\n \n         // no need to set group id for a restore consumer\n         baseConsumerProps.remove(ConsumerConfig.GROUP_ID_CONFIG);\n+        // no need to set instance id for a restore consumer\n+        baseConsumerProps.remove(ConsumerConfig.GROUP_INSTANCE_ID_CONFIG);", "originalCommit": "160acd197340ef183ea5af15f34ef9790a67b70b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc2ODg5MA==", "url": "https://github.com/apache/kafka/pull/8322#discussion_r396768890", "bodyText": "Yeah I think that's a good idea, can be done in another PR.", "author": "guozhangwang", "createdAt": "2020-03-23T21:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Nzk1OQ=="}], "type": "inlineReview"}]}