{"pr_number": 8310, "pr_title": "HOTFIX: fix flaky StateDirectoryTest.shouldReturnEmptyArrayIfListFile\u2026", "pr_createdAt": "2020-03-17T13:34:06Z", "pr_url": "https://github.com/apache/kafka/pull/8310", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDgzNQ==", "url": "https://github.com/apache/kafka/pull/8310#discussion_r393980835", "bodyText": "We don't want to remove the stateDir entirely, because then stateDir.exists will return false and we won't actually call listFiles which is what this test is trying to test. Can we just rename to \"state-renamed\" + TestUtils.randomString(5)? Or, clean up the previous contents at the beginning of the test?\nThat said, cleanUp should be called after every test, so there shouldn't be any left over state...right? cc/ @guozhangwang", "author": "ableegoldman", "createdAt": "2020-03-17T21:27:28Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StateDirectoryTest.java", "diffHunk": "@@ -329,7 +329,8 @@ public void shouldReturnEmptyArrayIfListFilesReturnsNull() {\n             time, true);\n         appDir = new File(stateDir, applicationId);\n \n-        assertTrue(stateDir.renameTo(new File(TestUtils.IO_TMP_DIR, \"state-renamed\")));\n+        // make stateDir disappear", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4NTk5Nw==", "url": "https://github.com/apache/kafka/pull/8310#discussion_r393985997", "bodyText": "That's true, but I suspect that this leftover folder is not from this test suite but likely from others? I think the right fix here should be to check which test (highly doubt it is one of the StateDirectoryTest because of cleanup ) has this leftover and fix that one instead.", "author": "guozhangwang", "createdAt": "2020-03-17T21:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTIyNg==", "url": "https://github.com/apache/kafka/pull/8310#discussion_r394029226", "bodyText": "Hm...we actually create a new stateDir with 5 random characters so that seems pretty unlikely.\n@chia7712 For now we can just add a + TestUtils.randomString(5) to the renamed name to fix the flakyness. In fact we can actually remove everything before stateDir.rename in this test, it's identical to what's done in @Before. I think it's leftover from a different approach to writing this test.", "author": "ableegoldman", "createdAt": "2020-03-17T23:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA4MjAyMw==", "url": "https://github.com/apache/kafka/pull/8310#discussion_r394082023", "bodyText": "@guozhangwang @ableegoldman thanks for feedback! I understand the purpose of this test case now.\n\nThat said, cleanUp should be called after every test, so there shouldn't be any left over state...right?\nThat's true, but I suspect that this leftover folder is not from this test suite but likely from others?\n\nnot really. java File is an immutable object so the renameTo does not change the file point. (see https://docs.oracle.com/javase/7/docs/api/java/io/File.html?is-external=true).\n\nWe don't want to remove the stateDir entirely, because then stateDir.exists will return false and we won't actually call listFiles which is what this test is trying to test.\n\nAs file is immutable, stateDir.exists returns false after renaming.\nIt seems to me the solution is to remove all files in StateDirectory.stageDir instead of renaming. It fix following issues.\n\nthe stage dir is not deleted by after()\nstateDir.exists return false as origin file is existent", "author": "chia7712", "createdAt": "2020-03-18T03:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5MDk5NA==", "url": "https://github.com/apache/kafka/pull/8310#discussion_r394090994", "bodyText": "@chia7712 @ableegoldman I think about this case a bit more, and I think maybe we can refactor this test by creating the stateDir as a file and not a directory, so that stateDir.exists would return true while listFiles would return null. WDYT?", "author": "guozhangwang", "createdAt": "2020-03-18T03:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5MTk5OA==", "url": "https://github.com/apache/kafka/pull/8310#discussion_r394091998", "bodyText": "ok. I was confused by the inconsistent naming. the folder in StateDirectory should be called appDir rather than stateDir\n    public StateDirectory(final StreamsConfig config, final Time time, final boolean hasPersistentStores) {\n        final String stateDirName = config.getString(StreamsConfig.STATE_DIR_CONFIG);\n        final File baseDir = new File(stateDirName);\n         ...\n        stateDir = new File(baseDir, appId);\n        ...\n    }\nCorrect my previous comments :(\nthe targets I have to address are shown below.\n\nmake sure the stateDir in StateDirectory points to nothing in order to make listFiles return null.\nmake sure the stateDir in test case is deleted by after", "author": "chia7712", "createdAt": "2020-03-18T03:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5NzU2Mg==", "url": "https://github.com/apache/kafka/pull/8310#discussion_r394097562", "bodyText": "I think about this case a bit more, and I think maybe we can refactor this test by creating the stateDir as a file and not a directory, so that stateDir.exists would return true while listFiles would return null. WDYT?\n\nyep. that is what I have done :)", "author": "chia7712", "createdAt": "2020-03-18T04:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MDgzNQ=="}], "type": "inlineReview"}, {"oid": "81a7328bf46bb055bfb5ce23799fd19885d53cb8", "url": "https://github.com/apache/kafka/commit/81a7328bf46bb055bfb5ce23799fd19885d53cb8", "message": "HOTFIX: fix flaky StateDirectoryTest.shouldReturnEmptyArrayIfListFilesReturnsNull", "committedDate": "2020-03-18T04:02:08Z", "type": "commit"}, {"oid": "81a7328bf46bb055bfb5ce23799fd19885d53cb8", "url": "https://github.com/apache/kafka/commit/81a7328bf46bb055bfb5ce23799fd19885d53cb8", "message": "HOTFIX: fix flaky StateDirectoryTest.shouldReturnEmptyArrayIfListFilesReturnsNull", "committedDate": "2020-03-18T04:02:08Z", "type": "forcePushed"}]}