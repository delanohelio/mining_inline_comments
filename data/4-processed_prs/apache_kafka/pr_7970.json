{"pr_number": 7970, "pr_title": "KAFKA-9338; Fetch session should cache request leader epoch", "pr_createdAt": "2020-01-16T06:58:06Z", "pr_url": "https://github.com/apache/kafka/pull/7970", "timeline": [{"oid": "006492904d26dac2662166cb39748999cd51b216", "url": "https://github.com/apache/kafka/commit/006492904d26dac2662166cb39748999cd51b216", "message": "KAFKA-9338; Fetch session should cache request leader epoch", "committedDate": "2020-01-16T06:55:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2Mzk1NQ==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367463955", "bodyText": "Does this test fail without the fix?", "author": "ijuma", "createdAt": "2020-01-16T14:57:10Z", "path": "core/src/test/scala/unit/kafka/server/FetchRequestTest.scala", "diffHunk": "@@ -248,6 +248,55 @@ class FetchRequestTest extends BaseRequestTest {\n     assertResponseErrorForEpoch(Errors.FENCED_LEADER_EPOCH, followerId, Optional.of(secondLeaderEpoch - 1))\n   }\n \n+  @Test\n+  def testEpochValidationWithinFetchSession(): Unit = {", "originalCommit": "006492904d26dac2662166cb39748999cd51b216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUxMTkyNQ==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367511925", "bodyText": "Yes", "author": "hachikuji", "createdAt": "2020-01-16T16:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2Mzk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyMTI2OA==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367521268", "bodyText": "The decision not to use TopicPartition was actually deliberate here.  TP has an extra \"hash\" field which we don't need, which would add 4 bytes of overhead per partition.  It also adds the overhead of a Java object, which is probably at least 8 bytes per partition.", "author": "cmccabe", "createdAt": "2020-01-16T16:31:09Z", "path": "core/src/main/scala/kafka/server/FetchSession.scala", "diffHunk": "@@ -71,49 +71,46 @@ object FetchSession {\n   * Note that fetcherLogStartOffset is the LSO of the follower performing the fetch, whereas\n   * localLogStartOffset is the log start offset of the partition on this broker.\n   */\n-class CachedPartition(val topic: String,\n-                      val partition: Int,\n+class CachedPartition(val topicPartition: TopicPartition,\n                       var maxBytes: Int,\n                       var fetchOffset: Long,\n                       var highWatermark: Long,\n+                      var leaderEpoch: Optional[Integer],\n                       var fetcherLogStartOffset: Long,\n                       var localLogStartOffset: Long)\n     extends ImplicitLinkedHashCollection.Element {\n \n   var cachedNext: Int = ImplicitLinkedHashCollection.INVALID_INDEX\n   var cachedPrev: Int = ImplicitLinkedHashCollection.INVALID_INDEX\n \n-  override def next = cachedNext\n-  override def setNext(next: Int) = this.cachedNext = next\n-  override def prev = cachedPrev\n-  override def setPrev(prev: Int) = this.cachedPrev = prev\n+  override def next: Int = cachedNext\n+  override def setNext(next: Int): Unit = this.cachedNext = next\n+  override def prev: Int = cachedPrev\n+  override def setPrev(prev: Int): Unit = this.cachedPrev = prev\n \n   def this(topic: String, partition: Int) =\n-    this(topic, partition, -1, -1, -1, -1, -1)\n+    this(new TopicPartition(topic, partition), -1, -1, -1, Optional.empty(), -1, -1)", "originalCommit": "006492904d26dac2662166cb39748999cd51b216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzNTA0NA==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367535044", "bodyText": "Ok, I'll revert this change and add a comment.", "author": "hachikuji", "createdAt": "2020-01-16T16:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyMTI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0NzM3NA==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367547374", "bodyText": "There already was a comment (which I had ignored \ud83d\ude1d ).", "author": "hachikuji", "createdAt": "2020-01-16T17:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyMTI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNjYxOQ==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367526619", "bodyText": "It seems like rather than use None for older fetch requests, we could just initialize the leaderEpoch to the current leader epoch.  That way, we could at least detect epoch changes.  Although we'd have to figure out how to handle the error-- probably just by dropping the session.", "author": "cmccabe", "createdAt": "2020-01-16T16:40:11Z", "path": "core/src/main/scala/kafka/server/FetchSession.scala", "diffHunk": "@@ -71,49 +71,46 @@ object FetchSession {\n   * Note that fetcherLogStartOffset is the LSO of the follower performing the fetch, whereas\n   * localLogStartOffset is the log start offset of the partition on this broker.\n   */\n-class CachedPartition(val topic: String,\n-                      val partition: Int,\n+class CachedPartition(val topicPartition: TopicPartition,\n                       var maxBytes: Int,\n                       var fetchOffset: Long,\n                       var highWatermark: Long,\n+                      var leaderEpoch: Optional[Integer],", "originalCommit": "006492904d26dac2662166cb39748999cd51b216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0OTg0NA==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367549844", "bodyText": "Can you elaborate a little bit? I think the validation only has value if it comes from the client making the request.", "author": "hachikuji", "createdAt": "2020-01-16T17:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU1NjU4OA==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r367556588", "bodyText": "Discussed offline. It's an interesting thought. The problem is we don't have an error that would force a follower to go through the truncation phase. We could force a retry and we could drop the session, but the follower would still be able to continue.", "author": "hachikuji", "createdAt": "2020-01-16T17:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwMDI4NA==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r368100284", "bodyText": "Can we file a separate JIRA for this idea?", "author": "ijuma", "createdAt": "2020-01-17T19:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwOTc1OQ==", "url": "https://github.com/apache/kafka/pull/7970#discussion_r368109759", "bodyText": "Thinking about this more, I'm not sure it's worth it.  Without true leader epoch awareness in the client, we don't have a way to force the client to refresh metadata and use a different leader, which is what we would need here.  So maybe my initial idea was a bit half-baked-- sorry.", "author": "cmccabe", "createdAt": "2020-01-17T19:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNjYxOQ=="}], "type": "inlineReview"}, {"oid": "18e1837c95a3d1082205b965121fedcce78c63ff", "url": "https://github.com/apache/kafka/commit/18e1837c95a3d1082205b965121fedcce78c63ff", "message": "Revert change to FetchSession TopicPartition", "committedDate": "2020-01-16T17:02:59Z", "type": "commit"}, {"oid": "3fdddbb25403d2e5f5a60579a9514d62c26ef753", "url": "https://github.com/apache/kafka/commit/3fdddbb25403d2e5f5a60579a9514d62c26ef753", "message": "More efficient equals implementation", "committedDate": "2020-01-16T17:53:30Z", "type": "commit"}, {"oid": "3fdddbb25403d2e5f5a60579a9514d62c26ef753", "url": "https://github.com/apache/kafka/commit/3fdddbb25403d2e5f5a60579a9514d62c26ef753", "message": "More efficient equals implementation", "committedDate": "2020-01-16T17:53:30Z", "type": "forcePushed"}, {"oid": "accca8208544725928f00dda822d160c1f4be048", "url": "https://github.com/apache/kafka/commit/accca8208544725928f00dda822d160c1f4be048", "message": "Use || instead of `if`", "committedDate": "2020-01-16T18:31:26Z", "type": "commit"}]}