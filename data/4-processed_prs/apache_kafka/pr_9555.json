{"pr_number": 9555, "pr_title": "KAFKA-10673: Cache inter broker listener name used in connection quotas", "pr_createdAt": "2020-11-04T04:45:55Z", "pr_url": "https://github.com/apache/kafka/pull/9555", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2OTI0MA==", "url": "https://github.com/apache/kafka/pull/9555#discussion_r518269240", "bodyText": "Good point and definitely agree that config.interBrokerListenerName could be expensive as we call it several times per accepting a new connection.\nThe issue here is that interBrokerListenerName is a dynamic config. So, you will need to update the cached value on changes to that config; similar how we notify ConnectionQuotas about config changes from SocketServer.reconfigure().", "author": "apovzner", "createdAt": "2020-11-05T18:24:45Z", "path": "core/src/main/scala/kafka/network/SocketServer.scala", "diffHunk": "@@ -1189,6 +1189,7 @@ class ConnectionQuotas(config: KafkaConfig, time: Time, metrics: Metrics) extend\n   @volatile private var defaultMaxConnectionsPerIp: Int = config.maxConnectionsPerIp\n   @volatile private var maxConnectionsPerIpOverrides = config.maxConnectionsPerIpOverrides.map { case (host, count) => (InetAddress.getByName(host), count) }\n   @volatile private var brokerMaxConnections = config.maxConnections\n+  @volatile private var interBrokerListenerName = config.interBrokerListenerName", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4MzYwMA==", "url": "https://github.com/apache/kafka/pull/9555#discussion_r518283600", "bodyText": "interBrokerListenerName is apparently not a dynamic config.\nsee DynamicBrokerReconfigurationTest.testAdvertisedListenerUpdate\n...\n    // Verify updating inter-broker listener\n    val props = new Properties\n    props.put(KafkaConfig.InterBrokerListenerNameProp, SecureExternal)\n    try {\n      reconfigureServers(props, perBrokerConfig = true, (KafkaConfig.InterBrokerListenerNameProp, SecureExternal))\n      fail(\"Inter-broker listener cannot be dynamically updated\")\n   }\n\nI don't think we allow updating inter broker listener at all, so I think we can remove the test I added. I actually wasn't sure if we allowed it or not, but the code seems to suggest that it isn't.", "author": "splett2", "createdAt": "2020-11-05T18:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2OTI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMyNzkyOA==", "url": "https://github.com/apache/kafka/pull/9555#discussion_r518327928", "bodyText": "You are right -- I saw that test and thought it was a dynamic config, but the test was verifying that it cannot be updated. I see now that KIP-226 lists that as future work, cool.", "author": "apovzner", "createdAt": "2020-11-05T19:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2OTI0MA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "0379cb6470fb9b6494bd5839b88205663abb9fef", "url": "https://github.com/apache/kafka/commit/0379cb6470fb9b6494bd5839b88205663abb9fef", "message": "Cache interbroker listener name", "committedDate": "2020-11-05T19:18:03Z", "type": "commit"}, {"oid": "0379cb6470fb9b6494bd5839b88205663abb9fef", "url": "https://github.com/apache/kafka/commit/0379cb6470fb9b6494bd5839b88205663abb9fef", "message": "Cache interbroker listener name", "committedDate": "2020-11-05T19:18:03Z", "type": "forcePushed"}]}