{"pr_number": 8394, "pr_title": "KAFKA-8107; Flaky Test kafka.api.ClientIdQuotaTest.testQuotaOverrideDelete", "pr_createdAt": "2020-03-31T15:19:59Z", "pr_url": "https://github.com/apache/kafka/pull/8394", "timeline": [{"oid": "d9ffed64e1b51316ace6e630b4ccb608d39f7eda", "url": "https://github.com/apache/kafka/commit/d9ffed64e1b51316ace6e630b4ccb608d39f7eda", "message": "KAFKA-8107; Flaky Test kafka.api.ClientIdQuotaTest.testQuotaOverrideDelete", "committedDate": "2020-03-31T15:18:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4OTI4Ng==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r401389286", "bodyText": "Why do we use Long.MaxValue here and Int.MaxValue in the base class?", "author": "ijuma", "createdAt": "2020-04-01T06:45:36Z", "path": "core/src/test/scala/integration/kafka/api/ClientIdQuotaTest.scala", "diffHunk": "@@ -26,6 +26,10 @@ class ClientIdQuotaTest extends BaseQuotaTest {\n   override def producerClientId = \"QuotasTestProducer-!@#$%^&*()\"\n   override def consumerClientId = \"QuotasTestConsumer-!@#$%^&*()\"\n \n+  // The test does not setup a default request limit and thus default to Long.MaxValue\n+  // which is the default value used when a quota does not exist.\n+  override def defaultRequestQuota: Double = Long.MaxValue\n+", "originalCommit": "d9ffed64e1b51316ace6e630b4ccb608d39f7eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMjE0MQ==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r401402141", "bodyText": "When the quota limit does not exist, Long.MaxValue is returned by default: https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/ClientQuotaManager.scala#L329. As ClientIdQuotaTest does not set the request quota at all, Long.MaxValue is the expected value. This is the default quota when not defined.\nWhereas, the other tests relying on the base class uses Int.MaxValue as a default. It is an arbitrary value here. Any other values which are high enough would work as well.", "author": "dajac", "createdAt": "2020-04-01T07:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4OTI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwNDg0Ng==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r401404846", "bodyText": "The PR description only mentions the wait for quota change. It would be good to explain the reason for this change there too.", "author": "ijuma", "createdAt": "2020-04-01T07:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4OTI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyODc4NQ==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r401728785", "bodyText": "I have complemented the description.", "author": "dajac", "createdAt": "2020-04-01T16:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4OTI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMDg5NQ==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r401930895", "bodyText": "I don't think val defaultRequestQuota = Int.MaxValue in BaseQuotaTest is supposed to be some special value which is different from unlimited quota. It would not be in any case, even if other tests explicitly set request quota to this value.  I think we should change  val defaultRequestQuota = Int.MaxValue in BaseQuotaTest to be Long.MaxValue as well and not have this override in ClientIdQuotaTest. Otherwise, we are making it even more confusing and harder to debug later.", "author": "apovzner", "createdAt": "2020-04-01T21:49:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4OTI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjExNg==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r402962116", "bodyText": "if Int.MaxValue wasn't used for a specific reason, it is indeed better to use Long.MaxValue in all cases.", "author": "dajac", "createdAt": "2020-04-03T12:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4OTI4Ng=="}], "type": "inlineReview"}, {"oid": "5b044647ab82055a61520c33f43b11057f030fc7", "url": "https://github.com/apache/kafka/commit/5b044647ab82055a61520c33f43b11057f030fc7", "message": "Address comments", "committedDate": "2020-04-03T12:12:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzcyMw==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r404813723", "bodyText": "Can you please add a toDouble call here? This silent conversion triggers a warning in Scala 2.13.", "author": "ijuma", "createdAt": "2020-04-07T13:35:53Z", "path": "core/src/test/scala/integration/kafka/api/BaseQuotaTest.scala", "diffHunk": "@@ -57,9 +57,9 @@ abstract class BaseQuotaTest extends IntegrationTestHarness {\n   this.consumerConfig.setProperty(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, \"0\")\n \n   // Low enough quota that a producer sending a small payload in a tight loop should get throttled\n-  val defaultProducerQuota = 8000\n-  val defaultConsumerQuota = 2500\n-  val defaultRequestQuota = Int.MaxValue\n+  val defaultProducerQuota: Long = 8000\n+  val defaultConsumerQuota: Long = 2500\n+  val defaultRequestQuota: Double = Long.MaxValue", "originalCommit": "5b044647ab82055a61520c33f43b11057f030fc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTE0OA==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r404815148", "bodyText": "Same for other cases where we are passing a Long when a Double is expected.", "author": "ijuma", "createdAt": "2020-04-07T13:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzcyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwNjAwNg==", "url": "https://github.com/apache/kafka/pull/8394#discussion_r404906006", "bodyText": "Sure, done.", "author": "dajac", "createdAt": "2020-04-07T15:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzcyMw=="}], "type": "inlineReview"}, {"oid": "33a35b8ac4655d749e342f73c1ad2862ddb10d11", "url": "https://github.com/apache/kafka/commit/33a35b8ac4655d749e342f73c1ad2862ddb10d11", "message": "Address comments", "committedDate": "2020-04-07T15:34:06Z", "type": "commit"}]}