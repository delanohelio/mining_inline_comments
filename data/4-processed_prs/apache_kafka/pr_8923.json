{"pr_number": 8923, "pr_title": "KAFKA-6435: KIP-623 Add internal topics option to streamResetter", "pr_createdAt": "2020-06-24T20:04:27Z", "pr_url": "https://github.com/apache/kafka/pull/8923", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEyNzA1Mw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r466127053", "bodyText": "We could refactor out a helper function here.", "author": "abbccdda", "createdAt": "2020-08-06T03:41:23Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -646,22 +655,68 @@ private boolean isIntermediateTopic(final String topic) {\n         return options.valuesOf(intermediateTopicsOption).contains(topic);\n     }\n \n-    private void maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n-        System.out.println(\"Deleting all internal/auto-created topics for application \" + options.valueOf(applicationIdOption));\n+    private int maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n+        if (!options.valuesOf(internalTopicsOption).isEmpty()) {\n+            return maybeDeleteSpecifiedInternalTopics(adminClient, dryRun);\n+        } else {\n+            return maybeDeleteInferredInternalTopics(adminClient, dryRun);\n+        }\n+    }\n+\n+    private int maybeDeleteSpecifiedInternalTopics(final Admin adminClient, final boolean dryRun) {\n+        final List<String> internalTopics = options.valuesOf(internalTopicsOption);\n+        int topicNotFound = EXIT_CODE_SUCCESS;\n+\n+        final List<String> topicsToDelete = new ArrayList<>();\n+        final List<String> notFoundInternalTopics = new ArrayList<>();\n+\n+        System.out.println(\"Deleting specified internal/auto-created topics \" + internalTopics);\n+        for (final String topic : internalTopics) {\n+            if (allTopics.contains(topic) && isInferredInternalTopic(topic)) {\n+                topicsToDelete.add(topic);\n+            } else {\n+                notFoundInternalTopics.add(topic);\n+            }\n+        }\n+\n+        if (!notFoundInternalTopics.isEmpty()) {\n+            System.out.println(\"Following topics were not detected as internal, skipping them\");\n+            for (final String topic : notFoundInternalTopics) {\n+                System.out.println(\"Topic: \" + topic);\n+            }\n+            topicNotFound = EXIT_CODE_ERROR;\n+        }\n+\n+        System.out.println(\"Following internal topics will be deleted for application \" + options.valueOf(applicationIdOption));\n+        for (final String topic : topicsToDelete) {\n+            System.out.println(\"Topic: \" + topic);\n+        }\n+\n+        if (!dryRun) {\n+            doDelete(topicsToDelete, adminClient);\n+        }\n+        System.out.println(\"Done.\");\n+        return topicNotFound;\n+    }\n+\n+    private int maybeDeleteInferredInternalTopics(final Admin adminClient, final boolean dryRun) {\n         final List<String> topicsToDelete = new ArrayList<>();\n         for (final String listing : allTopics) {\n-            if (isInternalTopic(listing)) {\n-                if (!dryRun) {\n-                    topicsToDelete.add(listing);\n-                } else {\n-                    System.out.println(\"Topic: \" + listing);\n-                }\n+            if (isInferredInternalTopic(listing)) {\n+                topicsToDelete.add(listing);\n             }\n         }\n+\n+        System.out.println(\"Following inferred internal/auto-created topics will be deleted for application \" + options.valueOf(applicationIdOption));\n+        for (final String topic : topicsToDelete) {\n+            System.out.println(\"Topic: \" + topic);\n+        }\n+\n         if (!dryRun) {\n             doDelete(topicsToDelete, adminClient);\n         }\n         System.out.println(\"Done.\");\n+        return EXIT_CODE_SUCCESS;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEyOTk3OA==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r466129978", "bodyText": "for html changes, it is recommended to include a screenshot of the built website. Please refer to https://cwiki.apache.org/confluence/display/KAFKA/Setup+Kafka+Website+on+Local+Apache+Server", "author": "abbccdda", "createdAt": "2020-08-06T03:53:04Z", "path": "docs/streams/developer-guide/app-reset-tool.html", "diffHunk": "@@ -77,6 +77,7 @@\n         <div class=\"section\" id=\"step-1-run-the-application-reset-tool\">\n             <h2>Step 1: Run the application reset tool<a class=\"headerlink\" href=\"#step-1-run-the-application-reset-tool\" title=\"Permalink to this headline\"></a></h2>\n             <p>Invoke the application reset tool from the command line</p>\n+            <p>Warning! This tool makes irreversible changes to your application. It is strongly recommended that you run this once with --dry-run to preview your changes before making them.</p>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcyMjYxMw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r469722613", "bodyText": "\ud83d\udc4d  here's a screenshot for this portion:", "author": "JoelWee", "createdAt": "2020-08-13T06:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEyOTk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMzg5MA==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r466133890", "bodyText": "could use assertFalse", "author": "abbccdda", "createdAt": "2020-08-06T04:08:39Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/AbstractResetIntegrationTest.java", "diffHunk": "@@ -262,6 +263,52 @@ public void shouldNotAllowToResetWhenIntermediateTopicAbsent() throws Exception\n         Assert.assertEquals(1, exitCode);\n     }\n \n+    void shouldNotAllowToResetWhenSpecifiedInternalTopicAbsent() throws Exception {\n+        appID = testId + \"-not-reset-without-intermediate-topic\";\n+        final String[] parameters = new String[]{\n+            \"--application-id\", appID,\n+            \"--bootstrap-servers\", cluster.bootstrapServers(),\n+            \"--internal-topics\", NON_EXISTING_TOPIC,\n+            \"--execute\"\n+        };\n+        final Properties cleanUpConfig = new Properties();\n+        cleanUpConfig.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, 100);\n+        cleanUpConfig.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, \"\" + CLEANUP_CONSUMER_TIMEOUT);\n+\n+        final int exitCode = new StreamsResetter().run(parameters, cleanUpConfig);\n+        Assert.assertEquals(1, exitCode);\n+    }\n+\n+    void testResetWhenInternalTopicsAreSpecified() throws Exception {\n+        final boolean useRepartitioned = true;\n+\n+        appID = testId + \"-with-internal-topics-option\";\n+        streamsConfig.put(StreamsConfig.APPLICATION_ID_CONFIG, appID);\n+\n+        // RUN\n+        streams = new KafkaStreams(setupTopologyWithIntermediateTopic(useRepartitioned, OUTPUT_TOPIC_2), streamsConfig);\n+        streams.start();\n+        IntegrationTestUtils.waitUntilMinKeyValueRecordsReceived(resultConsumerConfig, OUTPUT_TOPIC, 10);\n+\n+        streams.close();\n+        waitForEmptyConsumerGroup(adminClient, appID, TIMEOUT_MULTIPLIER * STREAMS_CONSUMER_TIMEOUT);\n+\n+        // RESET\n+        streams.cleanUp();\n+\n+        final List<String> internalTopics = cluster.getAllTopicsInCluster().stream()\n+                .filter(topic -> topic.startsWith(appID + \"-\"))\n+                .collect(Collectors.toList());\n+        final boolean cleanResult = tryCleanGlobal(!useRepartitioned,\n+                \"--internal-topics\",\n+                String.join(\",\", internalTopics.subList(1, internalTopics.size())) + \",\" + OUTPUT_TOPIC);\n+        Assert.assertEquals(false, cleanResult); // Reset will give error code since output topic is not a valid internal topic", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNDAyOA==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r466134028", "bodyText": "Could just use false", "author": "abbccdda", "createdAt": "2020-08-06T04:09:19Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/AbstractResetIntegrationTest.java", "diffHunk": "@@ -262,6 +263,52 @@ public void shouldNotAllowToResetWhenIntermediateTopicAbsent() throws Exception\n         Assert.assertEquals(1, exitCode);\n     }\n \n+    void shouldNotAllowToResetWhenSpecifiedInternalTopicAbsent() throws Exception {\n+        appID = testId + \"-not-reset-without-intermediate-topic\";\n+        final String[] parameters = new String[]{\n+            \"--application-id\", appID,\n+            \"--bootstrap-servers\", cluster.bootstrapServers(),\n+            \"--internal-topics\", NON_EXISTING_TOPIC,\n+            \"--execute\"\n+        };\n+        final Properties cleanUpConfig = new Properties();\n+        cleanUpConfig.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, 100);\n+        cleanUpConfig.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, \"\" + CLEANUP_CONSUMER_TIMEOUT);\n+\n+        final int exitCode = new StreamsResetter().run(parameters, cleanUpConfig);\n+        Assert.assertEquals(1, exitCode);\n+    }\n+\n+    void testResetWhenInternalTopicsAreSpecified() throws Exception {\n+        final boolean useRepartitioned = true;\n+\n+        appID = testId + \"-with-internal-topics-option\";\n+        streamsConfig.put(StreamsConfig.APPLICATION_ID_CONFIG, appID);\n+\n+        // RUN\n+        streams = new KafkaStreams(setupTopologyWithIntermediateTopic(useRepartitioned, OUTPUT_TOPIC_2), streamsConfig);\n+        streams.start();\n+        IntegrationTestUtils.waitUntilMinKeyValueRecordsReceived(resultConsumerConfig, OUTPUT_TOPIC, 10);\n+\n+        streams.close();\n+        waitForEmptyConsumerGroup(adminClient, appID, TIMEOUT_MULTIPLIER * STREAMS_CONSUMER_TIMEOUT);\n+\n+        // RESET\n+        streams.cleanUp();\n+\n+        final List<String> internalTopics = cluster.getAllTopicsInCluster().stream()\n+                .filter(topic -> topic.startsWith(appID + \"-\"))\n+                .collect(Collectors.toList());\n+        final boolean cleanResult = tryCleanGlobal(!useRepartitioned,", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNTI4NA==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r466135284", "bodyText": "Could we print all topics in one line, instead of multiple?", "author": "abbccdda", "createdAt": "2020-08-06T04:14:23Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -646,22 +655,68 @@ private boolean isIntermediateTopic(final String topic) {\n         return options.valuesOf(intermediateTopicsOption).contains(topic);\n     }\n \n-    private void maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n-        System.out.println(\"Deleting all internal/auto-created topics for application \" + options.valueOf(applicationIdOption));\n+    private int maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n+        if (!options.valuesOf(internalTopicsOption).isEmpty()) {\n+            return maybeDeleteSpecifiedInternalTopics(adminClient, dryRun);\n+        } else {\n+            return maybeDeleteInferredInternalTopics(adminClient, dryRun);\n+        }\n+    }\n+\n+    private int maybeDeleteSpecifiedInternalTopics(final Admin adminClient, final boolean dryRun) {\n+        final List<String> internalTopics = options.valuesOf(internalTopicsOption);\n+        int topicNotFound = EXIT_CODE_SUCCESS;\n+\n+        final List<String> topicsToDelete = new ArrayList<>();\n+        final List<String> notFoundInternalTopics = new ArrayList<>();\n+\n+        System.out.println(\"Deleting specified internal/auto-created topics \" + internalTopics);\n+        for (final String topic : internalTopics) {\n+            if (allTopics.contains(topic) && isInferredInternalTopic(topic)) {\n+                topicsToDelete.add(topic);\n+            } else {\n+                notFoundInternalTopics.add(topic);\n+            }\n+        }\n+\n+        if (!notFoundInternalTopics.isEmpty()) {\n+            System.out.println(\"Following topics were not detected as internal, skipping them\");\n+            for (final String topic : notFoundInternalTopics) {\n+                System.out.println(\"Topic: \" + topic);\n+            }\n+            topicNotFound = EXIT_CODE_ERROR;\n+        }\n+\n+        System.out.println(\"Following internal topics will be deleted for application \" + options.valueOf(applicationIdOption));\n+        for (final String topic : topicsToDelete) {\n+            System.out.println(\"Topic: \" + topic);\n+        }\n+\n+        if (!dryRun) {\n+            doDelete(topicsToDelete, adminClient);\n+        }\n+        System.out.println(\"Done.\");\n+        return topicNotFound;\n+    }\n+\n+    private int maybeDeleteInferredInternalTopics(final Admin adminClient, final boolean dryRun) {\n         final List<String> topicsToDelete = new ArrayList<>();\n         for (final String listing : allTopics) {\n-            if (isInternalTopic(listing)) {\n-                if (!dryRun) {\n-                    topicsToDelete.add(listing);\n-                } else {\n-                    System.out.println(\"Topic: \" + listing);\n-                }\n+            if (isInferredInternalTopic(listing)) {\n+                topicsToDelete.add(listing);\n             }\n         }\n+\n+        System.out.println(\"Following inferred internal/auto-created topics will be deleted for application \" + options.valueOf(applicationIdOption));\n+        for (final String topic : topicsToDelete) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNjI1NA==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r466136254", "bodyText": "Should we throw exception here to stop the run or just skip the not found topics?", "author": "abbccdda", "createdAt": "2020-08-06T04:18:31Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -646,22 +655,68 @@ private boolean isIntermediateTopic(final String topic) {\n         return options.valuesOf(intermediateTopicsOption).contains(topic);\n     }\n \n-    private void maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n-        System.out.println(\"Deleting all internal/auto-created topics for application \" + options.valueOf(applicationIdOption));\n+    private int maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n+        if (!options.valuesOf(internalTopicsOption).isEmpty()) {\n+            return maybeDeleteSpecifiedInternalTopics(adminClient, dryRun);\n+        } else {\n+            return maybeDeleteInferredInternalTopics(adminClient, dryRun);\n+        }\n+    }\n+\n+    private int maybeDeleteSpecifiedInternalTopics(final Admin adminClient, final boolean dryRun) {\n+        final List<String> internalTopics = options.valuesOf(internalTopicsOption);\n+        int topicNotFound = EXIT_CODE_SUCCESS;\n+\n+        final List<String> topicsToDelete = new ArrayList<>();\n+        final List<String> notFoundInternalTopics = new ArrayList<>();\n+\n+        System.out.println(\"Deleting specified internal/auto-created topics \" + internalTopics);\n+        for (final String topic : internalTopics) {\n+            if (allTopics.contains(topic) && isInferredInternalTopic(topic)) {\n+                topicsToDelete.add(topic);\n+            } else {\n+                notFoundInternalTopics.add(topic);\n+            }\n+        }\n+\n+        if (!notFoundInternalTopics.isEmpty()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcyNTc5Ng==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r469725796", "bodyText": "I would prefer to throw an exception, since it's likely that the user has made a mistake. I've implemented this now", "author": "JoelWee", "createdAt": "2020-08-13T06:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNjI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNjY3Nw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r466136677", "bodyText": "should we do check both exit codes and decide whether to return 0 or 1?", "author": "abbccdda", "createdAt": "2020-08-06T04:20:20Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -167,7 +171,7 @@ public int run(final String[] args,\n             final HashMap<Object, Object> consumerConfig = new HashMap<>(config);\n             consumerConfig.putAll(properties);\n             exitCode = maybeResetInputAndSeekToEndIntermediateTopicOffsets(consumerConfig, dryRun);\n-            maybeDeleteInternalTopics(adminClient, dryRun);\n+            exitCode |= maybeDeleteInternalTopics(adminClient, dryRun);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcyMzI1MQ==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r469723251", "bodyText": "Yep. Currently it returns 1 if either exitCode is 1, and 0 otherwise. Or should we do something else?", "author": "JoelWee", "createdAt": "2020-08-13T06:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNjY3Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTcyMjYzOQ==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r469722639", "bodyText": "screenshot of this portion:", "author": "JoelWee", "createdAt": "2020-08-13T06:23:19Z", "path": "docs/streams/developer-guide/app-reset-tool.html", "diffHunk": "@@ -106,6 +107,11 @@ <h2>Step 1: Run the application reset tool<a class=\"headerlink\" href=\"#step-1-ru\n                                         topics <span class=\"o\">(</span>topics used in the through<span class=\"o\">()</span>\n                                         method<span class=\"o\">)</span>. For these topics, the tool\n                                         will skip to the end.\n+--internal-topics &lt;String: list&gt;      Comma-separated list of internal topics\n+                                        to delete. Must be a subset of the\n+                                        internal topics marked for deletion by\n+                                        the default behaviour (do a dry-run without\n+                                        this option to view these topics).", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "265838480db8e0fdc1f6c25c5829dc2bfe12414e", "url": "https://github.com/apache/kafka/commit/265838480db8e0fdc1f6c25c5829dc2bfe12414e", "message": "KAFKA-6435: Add internal topics option to streamResetter", "committedDate": "2020-08-16T08:22:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDE2NjgwMg==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r614166802", "bodyText": "unnecessary whitespace change", "author": "wcarlson5", "createdAt": "2021-04-15T15:22:26Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -248,7 +257,7 @@ private void parseArguments(final String[] args) {\n             .ofType(String.class)\n             .describedAs(\"file name\");\n         forceOption = optionParser.accepts(\"force\", \"Force the removal of members of the consumer group (intended to remove stopped members if a long session timeout was used). \" +\n-                \"Make sure to shut down all stream applications when this option is specified to avoid unexpected rebalances.\");", "originalCommit": "265838480db8e0fdc1f6c25c5829dc2bfe12414e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDE2NzA0MA==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r614167040", "bodyText": "line is too long", "author": "wcarlson5", "createdAt": "2021-04-15T15:22:45Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -225,6 +229,11 @@ private void parseArguments(final String[] args) {\n             .ofType(String.class)\n             .withValuesSeparatedBy(',')\n             .describedAs(\"list\");\n+        internalTopicsOption = optionParser.accepts(\"internal-topics\", \"Comma-separated list of internal topics to delete. Must be a subset of the internal topics marked for deletion by the default behaviour (do a dry-run without this option to view these topics).\")", "originalCommit": "265838480db8e0fdc1f6c25c5829dc2bfe12414e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDE3NDg3Ng==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r614174876", "bodyText": "something like inferredInternalTopics.containsAll(specifiedInternalTopics) might be easier to understand here", "author": "wcarlson5", "createdAt": "2021-04-15T15:32:05Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -642,22 +651,38 @@ private boolean isIntermediateTopic(final String topic) {\n         return options.valuesOf(intermediateTopicsOption).contains(topic);\n     }\n \n-    private void maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n-        System.out.println(\"Deleting all internal/auto-created topics for application \" + options.valueOf(applicationIdOption));\n-        final List<String> topicsToDelete = new ArrayList<>();\n-        for (final String listing : allTopics) {\n-            if (isInternalTopic(listing)) {\n-                if (!dryRun) {\n-                    topicsToDelete.add(listing);\n-                } else {\n-                    System.out.println(\"Topic: \" + listing);\n-                }\n+    private int maybeDeleteInternalTopics(final Admin adminClient, final boolean dryRun) {\n+        final List<String> inferredInternalTopics = allTopics.stream()\n+                .filter(this::isInferredInternalTopic)\n+                .collect(Collectors.toList());\n+        final List<String> specifiedInternalTopics = options.valuesOf(internalTopicsOption);\n+        final List<String> topicsToDelete;\n+\n+        if (!specifiedInternalTopics.isEmpty()) {\n+            final List<String> notFoundInternalTopics = specifiedInternalTopics.stream()\n+                    .filter(topic -> !inferredInternalTopics.contains(topic))\n+                    .collect(Collectors.toList());\n+            if (!notFoundInternalTopics.isEmpty()) {", "originalCommit": "265838480db8e0fdc1f6c25c5829dc2bfe12414e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0ec0b82f87b9546eb5b28588d6820cfb7eab3a6", "url": "https://github.com/apache/kafka/commit/f0ec0b82f87b9546eb5b28588d6820cfb7eab3a6", "message": "KAFKA-6435: Add internal topics option to streamResetter", "committedDate": "2021-04-22T10:44:53Z", "type": "forcePushed"}, {"oid": "a673068e75e78c714bf6effd0ea2f8d87b8a59f6", "url": "https://github.com/apache/kafka/commit/a673068e75e78c714bf6effd0ea2f8d87b8a59f6", "message": "KAFKA-6435: Add internal topics option to streamResetter", "committedDate": "2021-04-22T11:06:26Z", "type": "commit"}, {"oid": "a673068e75e78c714bf6effd0ea2f8d87b8a59f6", "url": "https://github.com/apache/kafka/commit/a673068e75e78c714bf6effd0ea2f8d87b8a59f6", "message": "KAFKA-6435: Add internal topics option to streamResetter", "committedDate": "2021-04-22T11:06:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDYzNTc4Mw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r620635783", "bodyText": "You don't need to repeat this line, it's just printing an example of running the app reset tool for the line above (Invoke the application reset tool from the command line)", "author": "ableegoldman", "createdAt": "2021-04-26T20:45:08Z", "path": "docs/streams/developer-guide/app-reset-tool.html", "diffHunk": "@@ -78,6 +78,9 @@\n             <h2>Step 1: Run the application reset tool<a class=\"headerlink\" href=\"#step-1-run-the-application-reset-tool\" title=\"Permalink to this headline\"></a></h2>\n             <p>Invoke the application reset tool from the command line</p>\n             <div class=\"highlight-bash\"><div class=\"highlight\"><pre><span></span><code>&lt;path-to-kafka&gt;/bin/kafka-streams-application-reset</code></pre></div>\n+            <p>Warning! This tool makes irreversible changes to your application. It is strongly recommended that you run this once with <code class=\"docutils literal\"><span class=\"pre\">--dry-run</span></code> to preview your changes before making them.</p>\n+            <div class=\"highlight-bash\"><div class=\"highlight\"><pre><span></span>&lt;path-to-kafka&gt;/bin/kafka-streams-application-reset", "originalCommit": "a673068e75e78c714bf6effd0ea2f8d87b8a59f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTUzNzkwMw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r621537903", "bodyText": "Thanks! Have updated this now to look like:", "author": "JoelWee", "createdAt": "2021-04-27T19:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDYzNTc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDYzOTQ4Nw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r620639487", "bodyText": "nit: we should also filter for internal topics specifically, like what's done in StreamsResetter#matchesInternalTopicFormat. Actually you can probably just invoke that method directly for the filter here (it can be made static if necessary)", "author": "ableegoldman", "createdAt": "2021-04-26T20:50:51Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/AbstractResetIntegrationTest.java", "diffHunk": "@@ -205,6 +206,34 @@ private void add10InputElements() {\n         }\n     }\n \n+    @Test\n+    public void testResetWhenInternalTopicsAreSpecified() throws Exception {\n+        final String appID = IntegrationTestUtils.safeUniqueTestName(getClass(), testName);\n+        streamsConfig.put(StreamsConfig.APPLICATION_ID_CONFIG, appID);\n+\n+        // RUN\n+        streams = new KafkaStreams(setupTopologyWithIntermediateTopic(true, OUTPUT_TOPIC_2), streamsConfig);\n+        streams.start();\n+        IntegrationTestUtils.waitUntilMinKeyValueRecordsReceived(resultConsumerConfig, OUTPUT_TOPIC, 10);\n+\n+        streams.close();\n+        waitForEmptyConsumerGroup(adminClient, appID, TIMEOUT_MULTIPLIER * STREAMS_CONSUMER_TIMEOUT);\n+\n+        // RESET\n+        streams.cleanUp();\n+\n+        final List<String> internalTopics = cluster.getAllTopicsInCluster().stream()\n+                .filter(topic -> topic.startsWith(appID + \"-\"))", "originalCommit": "a673068e75e78c714bf6effd0ea2f8d87b8a59f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTUzODUyOA==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r621538528", "bodyText": "done now :)", "author": "JoelWee", "createdAt": "2021-04-27T19:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDYzOTQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDY0NTg2NQ==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r620645865", "bodyText": "Just wondering, why put this test here instead of in AbstractResetIntegrationTest?", "author": "ableegoldman", "createdAt": "2021-04-26T21:00:34Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/ResetIntegrationTest.java", "diffHunk": "@@ -151,6 +151,22 @@ public void shouldNotAllowToResetWhenIntermediateTopicAbsent() {\n         Assert.assertEquals(1, exitCode);\n     }\n \n+    @Test\n+    public void shouldNotAllowToResetWhenSpecifiedInternalTopicAbsent() {", "originalCommit": "a673068e75e78c714bf6effd0ea2f8d87b8a59f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDY0ODUwNw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r620648507", "bodyText": "Also, can we add a test like this but for the case where the topic does exist but just isn't a subset of inferred internal topics?", "author": "ableegoldman", "createdAt": "2021-04-26T21:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDY0NTg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTU0MjM5Mw==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r621542393", "bodyText": "It seems more natural to group it together with the other shouldNotAllowToResetWhen... tests. E.g. shouldNotAllowToResetWhenIntermediateTopicAbsent, shouldNotAllowToResetWhenInputTopicAbsent, etc.\nHappy to shift it over to AbstractResetIntegrationTest.java", "author": "JoelWee", "createdAt": "2021-04-27T19:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDY0NTg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTY2NTYzOQ==", "url": "https://github.com/apache/kafka/pull/8923#discussion_r621665639", "bodyText": "Hah, maybe I should have asked why are all of those tests not also in AbstractResetIntegrationTest. Seems like almost everything that applies here would also be good to test in the SSL version of the test (which AFAICT is the only other one to extend the AbstractResetIntegrationTest).\nBut I'm ok with leaving it as is, and maybe we can just look into this as followup work unless there is a good reason for them to be where they are (which I can't think of but my imagination is not endless)", "author": "ableegoldman", "createdAt": "2021-04-27T22:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDY0NTg2NQ=="}], "type": "inlineReview"}, {"oid": "7479f201610e7e5d41a5e246a80a94aa9cbf7737", "url": "https://github.com/apache/kafka/commit/7479f201610e7e5d41a5e246a80a94aa9cbf7737", "message": "KAFKA-6435: Clean up code and improve tests", "committedDate": "2021-04-27T19:27:58Z", "type": "commit"}]}