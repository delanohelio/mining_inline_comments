{"pr_number": 8554, "pr_title": "KAFKA-9919: Add logging to KafkaBasedLog::readToLogEnd", "pr_createdAt": "2020-04-25T22:24:30Z", "pr_url": "https://github.com/apache/kafka/pull/8554", "timeline": [{"oid": "f5c01409225987bd05d105bfa3a34d16adbce576", "url": "https://github.com/apache/kafka/commit/f5c01409225987bd05d105bfa3a34d16adbce576", "message": "KAFKA-9919: Add logging to KafkaBasedLog::readToLogEnd", "committedDate": "2020-04-25T22:17:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1NDI0MQ==", "url": "https://github.com/apache/kafka/pull/8554#discussion_r417054241", "bodyText": "unboxing will happen in the comparison in the if branch anyways, so probably better to do it early declaring the type long here.", "author": "kkonstantine", "createdAt": "2020-04-29T04:00:28Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -281,9 +281,18 @@ private void readToLogEnd() {\n             Iterator<Map.Entry<TopicPartition, Long>> it = endOffsets.entrySet().iterator();\n             while (it.hasNext()) {\n                 Map.Entry<TopicPartition, Long> entry = it.next();\n-                if (consumer.position(entry.getKey()) >= entry.getValue())\n+                TopicPartition topicPartition = entry.getKey();\n+                Long endOffset = entry.getValue();", "originalCommit": "f5c01409225987bd05d105bfa3a34d16adbce576", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MDgwNg==", "url": "https://github.com/apache/kafka/pull/8554#discussion_r417070806", "bodyText": "Fair enough; added.", "author": "C0urante", "createdAt": "2020-04-29T05:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1NDI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1NTE5OQ==", "url": "https://github.com/apache/kafka/pull/8554#discussion_r417055199", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                log.trace(\n          \n          \n            \n                                    \"Behind end offset {} for {}; last-consumed offset is {}\",\n          \n          \n            \n                                    endOffset,\n          \n          \n            \n                                    topicPartition,\n          \n          \n            \n                                    lastConsumedOffset);\n          \n          \n            \n                                log.trace(\"Behind end offset {} for {}; last-consumed offset is {}\",\n          \n          \n            \n                                        endOffset, topicPartition, lastConsumedOffset);\n          \n      \n    \n    \n  \n\nnit: multiline calls don't need to be on their own line in AK and tab is equal to 4 spaces (here we need 2 tabs)", "author": "kkonstantine", "createdAt": "2020-04-29T04:04:42Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -281,9 +281,18 @@ private void readToLogEnd() {\n             Iterator<Map.Entry<TopicPartition, Long>> it = endOffsets.entrySet().iterator();\n             while (it.hasNext()) {\n                 Map.Entry<TopicPartition, Long> entry = it.next();\n-                if (consumer.position(entry.getKey()) >= entry.getValue())\n+                TopicPartition topicPartition = entry.getKey();\n+                Long endOffset = entry.getValue();\n+                long lastConsumedOffset = consumer.position(topicPartition);\n+                if (lastConsumedOffset >= endOffset) {\n+                    log.trace(\"Reached end offset {} for {}\", endOffset, topicPartition);\n                     it.remove();\n-                else {\n+                } else {\n+                    log.trace(\n+                        \"Behind end offset {} for {}; last-consumed offset is {}\",\n+                        endOffset,\n+                        topicPartition,\n+                        lastConsumedOffset);", "originalCommit": "f5c01409225987bd05d105bfa3a34d16adbce576", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1NzEyNg==", "url": "https://github.com/apache/kafka/pull/8554#discussion_r417057126", "bodyText": "Similar to the above, seeing a message that says read might be easier to read in context than consumed.\nHow about:\nBehind end offset {} for {}; last-read offset is {}", "author": "kkonstantine", "createdAt": "2020-04-29T04:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1NTE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA1NTg4NQ==", "url": "https://github.com/apache/kafka/pull/8554#discussion_r417055885", "bodyText": "given that the previous messages say \"Reading to ...\" maybe it would make sense to say:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                log.trace(\"Reached end offset {} for {}\", endOffset, topicPartition);\n          \n          \n            \n                                log.trace(\"Read to end offset {} for {}\", endOffset, topicPartition);", "author": "kkonstantine", "createdAt": "2020-04-29T04:07:37Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -281,9 +281,18 @@ private void readToLogEnd() {\n             Iterator<Map.Entry<TopicPartition, Long>> it = endOffsets.entrySet().iterator();\n             while (it.hasNext()) {\n                 Map.Entry<TopicPartition, Long> entry = it.next();\n-                if (consumer.position(entry.getKey()) >= entry.getValue())\n+                TopicPartition topicPartition = entry.getKey();\n+                Long endOffset = entry.getValue();\n+                long lastConsumedOffset = consumer.position(topicPartition);\n+                if (lastConsumedOffset >= endOffset) {\n+                    log.trace(\"Reached end offset {} for {}\", endOffset, topicPartition);", "originalCommit": "f5c01409225987bd05d105bfa3a34d16adbce576", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a66f1fc87a66add15c77a52fa0a7b02b8ff6df3", "url": "https://github.com/apache/kafka/commit/8a66f1fc87a66add15c77a52fa0a7b02b8ff6df3", "message": "KAFKA-9919: Apply suggestions from code review\n\nCo-Authored-By: Konstantine Karantasis <konstantine@confluent.io>", "committedDate": "2020-04-29T05:12:29Z", "type": "commit"}, {"oid": "36c8e2c976828d7ef5d64bfac81de386b5a9a275", "url": "https://github.com/apache/kafka/commit/36c8e2c976828d7ef5d64bfac81de386b5a9a275", "message": "KAFKA-9919: Address code review", "committedDate": "2020-04-29T05:13:24Z", "type": "commit"}]}