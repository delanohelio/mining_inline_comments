{"pr_number": 9729, "pr_title": "KAFKA-10839: improve consumer group coordinator unavailable message", "pr_createdAt": "2020-12-10T23:32:43Z", "pr_url": "https://github.com/apache/kafka/pull/9729", "timeline": [{"oid": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "url": "https://github.com/apache/kafka/commit/1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "message": "KAFKA-10839: improve consumer group coordinator unavailable message", "committedDate": "2020-12-10T23:19:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODUxMA==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r540578510", "bodyText": "These messages feel a bit smelly", "author": "lbradstreet", "createdAt": "2020-12-10T23:33:06Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1355,7 +1362,7 @@ public void run() {\n                         } else if (heartbeat.sessionTimeoutExpired(now)) {\n                             // the session timeout has expired without seeing a successful heartbeat, so we should\n                             // probably make sure the coordinator is still healthy.\n-                            markCoordinatorUnknown();\n+                            markCoordinatorUnknown(\"session timed out without heartbeat\");", "originalCommit": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxODAyNA==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541218024", "bodyText": "Seems ok. Maybe \"without receiving a successful heartbeat response\"?", "author": "hachikuji", "createdAt": "2020-12-11T19:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyNDg2OQ==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541424869", "bodyText": "Done", "author": "lbradstreet", "createdAt": "2020-12-11T23:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODU5OA==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r540578598", "bodyText": "Should this be extracted into a constant?", "author": "lbradstreet", "createdAt": "2020-12-10T23:33:23Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -257,7 +257,7 @@ protected synchronized boolean ensureCoordinatorReady(final Timer timer) {\n             } else if (coordinator != null && client.isUnavailable(coordinator)) {\n                 // we found the coordinator, but the connection has failed, so mark\n                 // it dead and backoff before retrying discovery\n-                markCoordinatorUnknown();\n+                markCoordinatorUnknown(\"coordinator unavailable\");", "originalCommit": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxMzIxNQ==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541213215", "bodyText": "I'm ok with it. This is just informational and the literal value is easier to read.", "author": "hachikuji", "createdAt": "2020-12-11T19:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNjg4OA==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541216888", "bodyText": "Wonder if we can use the name of the error. Some of the messages will read awkwardly in the log message", "author": "hachikuji", "createdAt": "2020-12-11T19:50:09Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -890,13 +890,20 @@ private synchronized Node coordinator() {\n         return this.coordinator;\n     }\n \n-    protected synchronized void markCoordinatorUnknown() {\n-        markCoordinatorUnknown(false);\n+\n+    protected synchronized void markCoordinatorUnknown(Errors error) {\n+        markCoordinatorUnknown(false, \"error response {}\" + error.message());", "originalCommit": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQwMDk4NQ==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541400985", "bodyText": "Oops, that was what I was trying to do.", "author": "lbradstreet", "createdAt": "2020-12-11T23:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNjg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyNDk2Mg==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541424962", "bodyText": "Done", "author": "lbradstreet", "createdAt": "2020-12-11T23:47:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNjg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNzQwMQ==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541217401", "bodyText": "nit: \"Rediscovery will be attempted\"", "author": "hachikuji", "createdAt": "2020-12-11T19:50:44Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -890,13 +890,20 @@ private synchronized Node coordinator() {\n         return this.coordinator;\n     }\n \n-    protected synchronized void markCoordinatorUnknown() {\n-        markCoordinatorUnknown(false);\n+\n+    protected synchronized void markCoordinatorUnknown(Errors error) {\n+        markCoordinatorUnknown(false, \"error response {}\" + error.message());\n+    }\n+\n+    protected synchronized void markCoordinatorUnknown(String cause) {\n+        markCoordinatorUnknown(false, cause);\n     }\n \n-    protected synchronized void markCoordinatorUnknown(boolean isDisconnected) {\n+    protected synchronized void markCoordinatorUnknown(boolean isDisconnected, String cause) {\n         if (this.coordinator != null) {\n-            log.info(\"Group coordinator {} is unavailable or invalid, will attempt rediscovery\", this.coordinator);\n+            log.info(\"Group coordinator {} is unavailable or invalid due to cause: {}.\"\n+                    + \"isDisconnected: {}. Rediscovery will attempted.\", this.coordinator,", "originalCommit": "1cbf6fcca5ccb4482611b187ab17f90e7d6bf1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyNTA1Ng==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541425056", "bodyText": "done", "author": "lbradstreet", "createdAt": "2020-12-11T23:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNzQwMQ=="}], "type": "inlineReview"}, {"oid": "2a828d54bc1fde597e353afdf28a5b05985e1033", "url": "https://github.com/apache/kafka/commit/2a828d54bc1fde597e353afdf28a5b05985e1033", "message": "Address feedback", "committedDate": "2020-12-11T23:43:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyNTM0NA==", "url": "https://github.com/apache/kafka/pull/9729#discussion_r541425344", "bodyText": "Needs fixing", "author": "lbradstreet", "createdAt": "2020-12-11T23:48:26Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinator.java", "diffHunk": "@@ -1311,7 +1311,7 @@ public void handle(OffsetFetchResponse response, RequestFuture<Map<TopicPartitio\n                     future.raise(error);\n                 } else if (error == Errors.NOT_COORDINATOR) {\n                     // re-discover the coordinator and retry\n-                    markCoordinatorUnknown();\n+                    markCoordinatorUnknown(error.message());", "originalCommit": "2a828d54bc1fde597e353afdf28a5b05985e1033", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7e06e0f5464a6eac918f4aa2693e7a797f2dfd75", "url": "https://github.com/apache/kafka/commit/7e06e0f5464a6eac918f4aa2693e7a797f2dfd75", "message": "Pass errors correctly", "committedDate": "2020-12-11T23:49:52Z", "type": "commit"}]}