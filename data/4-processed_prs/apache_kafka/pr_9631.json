{"pr_number": 9631, "pr_title": "KAFKA-9672: Leader with ISR as a superset of replicas", "pr_createdAt": "2020-11-20T20:26:39Z", "pr_url": "https://github.com/apache/kafka/pull/9631", "timeline": [{"oid": "65b9ebdb978fc2a964e77649bf27fa5cc0480396", "url": "https://github.com/apache/kafka/commit/65b9ebdb978fc2a964e77649bf27fa5cc0480396", "message": "KAFKA-9672: Leader with ISR as a superset of replicas\n\nIt is possible for the the controller to send LeaderAndIsr requests with\nan ISR that contains ids not in the replica set. This is used during\nreassignment so that the partition leader doesn't add replicas back to\nthe ISR. This is needed because the controller updates ZK and the\nreplicas through two rounds:\n\n1. The first round of ZK updates and LeaderAndIsr requests shrinks the ISR.\n\n2. The second round of ZK updates and LeaderAndIsr requests shrinks the replica\nset.\n\nThis could be avoided by doing 1. and 2. in one round. Unfortunately the\ncurrent controller implementation makes that non-trivial.\n\nThis commit changes the leader to allow the state where the ISR contains\nids that are not in the replica set and to remove such ids from the ISR\nif required.", "committedDate": "2020-11-20T20:16:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MDU0Ng==", "url": "https://github.com/apache/kafka/pull/9631#discussion_r529070546", "bodyText": "For the reassignment case, once the controller shrinks the assigned replica set, the next step is for the controller to remove the remove replica from ISR and bump up the leader epoch. The shrunk isr will then be propagated to the leader. With fold(true), we allow to leader to shrink ISR immediately. This might be ok, but is unnecessary work since the controller will be doing that soon.\nAnother option is to use fold(false). This way, the leader won't shrink the removed replica from ISR. Only the controller will do.", "author": "junrao", "createdAt": "2020-11-23T23:49:22Z", "path": "core/src/main/scala/kafka/cluster/Partition.scala", "diffHunk": "@@ -947,9 +947,10 @@ class Partition(val topicPartition: TopicPartition,\n                                   leaderEndOffset: Long,\n                                   currentTimeMs: Long,\n                                   maxLagMs: Long): Boolean = {\n-    val followerReplica = getReplicaOrException(replicaId)\n-    followerReplica.logEndOffset != leaderEndOffset &&\n-      (currentTimeMs - followerReplica.lastCaughtUpTimeMs) > maxLagMs\n+    getReplica(replicaId).fold(true) { followerReplica =>", "originalCommit": "65b9ebdb978fc2a964e77649bf27fa5cc0480396", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEwNTk5MA==", "url": "https://github.com/apache/kafka/pull/9631#discussion_r529105990", "bodyText": "Thanks for the review!\n\nThis might be ok, but is unnecessary work since the controller will be doing that soon.\n\nAccording to some users and the report from KAFKA-9672, it looks like under some conditions the controller is writing to ZK that it removed the replica from the assignment but not from the ISR. I am unable to reproduce this or convince myself from the code on how this can happen.\nI was thinking of defensively letting the leader also remove the replica from the ISR so that Kafka can recover from this case. If the leader is not allowed to do this then ack=all produce messages will continue to fail.\nWhat do you think @junrao?", "author": "jsancio", "createdAt": "2020-11-24T01:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MDU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MzI0MQ==", "url": "https://github.com/apache/kafka/pull/9631#discussion_r532963241", "bodyText": "@jsancio : Yes, we can keep the logic in the PR. On the leader, the logic for shrinking ISR is checked every 10 secs by default. So, in the common case when completing a reassignment, the reduced ISR by the controller will be propagated to the leader before the leader's ISR shrinking logic kicks in.", "author": "junrao", "createdAt": "2020-11-30T23:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3MDU0Ng=="}], "type": "inlineReview"}, {"oid": "21449ce80b5f09d7facd6bc9ac91619564e31f37", "url": "https://github.com/apache/kafka/commit/21449ce80b5f09d7facd6bc9ac91619564e31f37", "message": "Merge remote-tracking branch 'upstream/trunk' into KAFKA-9672-isr-greater-replicas", "committedDate": "2021-02-19T15:51:32Z", "type": "commit"}]}