{"pr_number": 9531, "pr_title": "KAFKA-10661; Add new resigned state for graceful shutdown/initialization", "pr_createdAt": "2020-10-29T19:49:31Z", "pr_url": "https://github.com/apache/kafka/pull/9531", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0NTEyNQ==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r514945125", "bodyText": "If the cluster resigns from candidateState, it will also send EndQuorumEpochRequest to all voters?", "author": "dengziming", "createdAt": "2020-10-30T08:43:41Z", "path": "raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java", "diffHunk": "@@ -1543,9 +1516,40 @@ private long maybeAppendBatches(\n         return timeUnitFlush;\n     }\n \n+    private long pollResigned(long currentTimeMs) throws IOException {\n+        GracefulShutdown shutdown = this.shutdown.get();\n+        ResignedState state = quorum.resignedStateOrThrow();\n+\n+        long endQuorumBackoffMs = maybeSendRequests(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI2OTMwMA==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r515269300", "bodyText": "Yeah, that is why the EndQuorumEpoch specifies both a leaderId and a replicaId. The idea is that this allows a voter who had voted for the candidate to start a new election more quickly. Admittedly, I am not sure how valuable this optimization is in practice. We could consider simplifying the protocol so that it is only sent by leaders.", "author": "hachikuji", "createdAt": "2020-10-30T17:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0NTEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI2MTUzNw==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r515261537", "bodyText": "If we are shutting down, why we still want to care about election at all?", "author": "guozhangwang", "createdAt": "2020-10-30T17:29:31Z", "path": "raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java", "diffHunk": "@@ -1543,9 +1516,40 @@ private long maybeAppendBatches(\n         return timeUnitFlush;\n     }\n \n+    private long pollResigned(long currentTimeMs) throws IOException {\n+        GracefulShutdown shutdown = this.shutdown.get();\n+        ResignedState state = quorum.resignedStateOrThrow();\n+\n+        long endQuorumBackoffMs = maybeSendRequests(\n+            currentTimeMs,\n+            state.unackedVoters(),\n+            () -> buildEndQuorumEpochRequest(state.preferredSuccessors())\n+        );\n+\n+        final long stateTimeoutMs;\n+        if (shutdown != null) {\n+            // If we are shutting down, then we will remain in the resigned state\n+            // until either the shutdown expires or an election bumps the epoch", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3MjM5Ng==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r515272396", "bodyText": "This node can stick around long enough to help another leader get elected.", "author": "hachikuji", "createdAt": "2020-10-30T17:41:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI2MTUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1ODM0NA==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r515458344", "bodyText": "should this be Math.min(shutdown.remainingTimeMs(), minRequestBackoffMs, state.remainingElectionTimeMs(currentTimeMs))", "author": "dengziming", "createdAt": "2020-10-31T05:25:03Z", "path": "raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java", "diffHunk": "@@ -1560,9 +1558,34 @@ private long pollLeader(long currentTimeMs) {\n         return Math.min(timeUntilFlush, timeUntilSend);\n     }\n \n+    private long maybeSendVoteRequests(\n+        CandidateState state,\n+        long currentTimeMs\n+    ) {\n+        // Continue sending Vote requests as long as we still have a chance to win the election\n+        if (!state.isVoteRejected()) {\n+            return maybeSendRequests(\n+                currentTimeMs,\n+                state.unrecordedVoters(),\n+                this::buildVoteRequest\n+            );\n+        }\n+        return Long.MAX_VALUE;\n+    }\n+\n     private long pollCandidate(long currentTimeMs) throws IOException {\n         CandidateState state = quorum.candidateStateOrThrow();\n-        if (state.isBackingOff()) {\n+        GracefulShutdown shutdown = this.shutdown.get();\n+\n+        if (shutdown != null) {\n+            // If we happen to shutdown while we are a candidate, we will continue\n+            // with the current election until one of the following conditions is met:\n+            //  1) we are elected as leader (which allows us to resign)\n+            //  2) another leader is elected\n+            //  3) the shutdown timer expires\n+            long minRequestBackoffMs = maybeSendVoteRequests(state, currentTimeMs);\n+            return Math.min(shutdown.remainingTimeMs(), minRequestBackoffMs);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5ODU2OA==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r516198568", "bodyText": "The intent is to ignore the election timeout in order to prevent a shutting down broker from becoming a candidate. Does that make sense?", "author": "hachikuji", "createdAt": "2020-11-02T19:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1ODM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4NTQxNQ==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r516385415", "bodyText": "Understand, The candidate will try to complete only the current election when shutting down, so just ignore the election timeout.", "author": "dengziming", "createdAt": "2020-11-03T01:36:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1ODM0NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTk1OA==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r519549958", "bodyText": "Why the behavior of pollFollowerAsVoter and pollVoted are different when shutting down? Could the former case still help in casting and completing a vote as well?", "author": "guozhangwang", "createdAt": "2020-11-09T04:44:18Z", "path": "raft/src/main/java/org/apache/kafka/raft/KafkaRaftClient.java", "diffHunk": "@@ -1601,7 +1618,12 @@ private long pollFollower(long currentTimeMs) throws IOException {\n     }\n \n     private long pollFollowerAsVoter(FollowerState state, long currentTimeMs) throws IOException {\n-        if (state.hasFetchTimeoutExpired(currentTimeMs)) {\n+        GracefulShutdown shutdown = this.shutdown.get();\n+        if (shutdown != null) {\n+            // If we are a follower, then we can shutdown immediately. We want to\n+            // skip the transition to candidate in any case.\n+            return 0;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk2OTIwOA==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r519969208", "bodyText": "If we are a follower, then there is no election in progress to help with.", "author": "hachikuji", "createdAt": "2020-11-09T16:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTM5NA==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r519551394", "bodyText": "Makes me thinking: if we have an even number sized quorum (say 2N), and the leader is resigning. Then before the leader shutdown we need N+1 votes, while after the leader shutdown, the quorum size shrink to 2N-1 and we would only need N votes. So if the resigning leader gives it a vote to a candidate and then shutdown, while the candidates thinks they only need N votes, would that potentially result in two candidates claiming victory --- somehow this sounds quite close to the real world :P --- each with N votes while one of them has the vote from the resigned leader?", "author": "guozhangwang", "createdAt": "2020-11-09T04:50:50Z", "path": "raft/src/main/java/org/apache/kafka/raft/QuorumState.java", "diffHunk": "@@ -21,18 +21,21 @@\n import org.slf4j.Logger;\n \n import java.io.IOException;\n+import java.util.Collections;\n import java.util.HashSet;\n+import java.util.List;\n import java.util.Optional;\n import java.util.OptionalInt;\n import java.util.Random;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n /**\n- * This class is responsible for managing the current state of this node and ensuring only\n- * valid state transitions.\n+ * This class is responsible for managing the current state of this node and ensuring\n+ * only valid state transitions. Below we define the possible state transitions and\n+ * how they are triggered:\n  *\n- * Unattached =>\n+ * Unattached|Resigned =>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk2NTAwOA==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r519965008", "bodyText": "Hmm.. The quorum size does not change because a leader resigns. If there are 2N nodes in the cluster, then we always need N + 1 votes, so I don't think this case is possible.", "author": "hachikuji", "createdAt": "2020-11-09T16:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk2ODE0NQ==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r519968145", "bodyText": "In the future, when we have reassignment, we will still have to protect every quorum change with a majority of the current nodes. The proposal we had previously only allowed single-node changes, which meant that any majority was a majority before and after the state was applied.", "author": "hachikuji", "createdAt": "2020-11-09T16:56:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyMDAyOQ==", "url": "https://github.com/apache/kafka/pull/9531#discussion_r520020029", "bodyText": "Okay now I remembered what we discussed before.\nWhat I was wondering is, say with quorum size 6, we would need 4 votes to elect leader; if the current leader shutdown and before it is restarted, the quorum size is 5 so logically we only need 3 votes --- but as long as we require that during this transition we still require 4 votes even with 5 alive quorum members we are fine.", "author": "guozhangwang", "createdAt": "2020-11-09T18:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTM5NA=="}], "type": "inlineReview"}, {"oid": "579169d7ae9c6c128b13c269dc7af148775cfca3", "url": "https://github.com/apache/kafka/commit/579169d7ae9c6c128b13c269dc7af148775cfca3", "message": "KAFKA-10661; Add new resigned state for graceful shutdown/initialization", "committedDate": "2020-11-09T17:26:52Z", "type": "commit"}, {"oid": "40d11d182db914310b25c85085fe088f466bc56a", "url": "https://github.com/apache/kafka/commit/40d11d182db914310b25c85085fe088f466bc56a", "message": "Use resigned state only for leaders", "committedDate": "2020-11-09T17:26:52Z", "type": "commit"}, {"oid": "95ceb1a8d35cb2692b98eab9637ca203a6f06828", "url": "https://github.com/apache/kafka/commit/95ceb1a8d35cb2692b98eab9637ca203a6f06828", "message": "Fix compilation error in `RequestQuotaTest`", "committedDate": "2020-11-09T17:26:52Z", "type": "commit"}, {"oid": "631ba91121a26b0171ab490c92991e628ce3658c", "url": "https://github.com/apache/kafka/commit/631ba91121a26b0171ab490c92991e628ce3658c", "message": "Remove unused variable in `KafkaNetworkChannelTest`", "committedDate": "2020-11-09T17:26:52Z", "type": "commit"}, {"oid": "631ba91121a26b0171ab490c92991e628ce3658c", "url": "https://github.com/apache/kafka/commit/631ba91121a26b0171ab490c92991e628ce3658c", "message": "Remove unused variable in `KafkaNetworkChannelTest`", "committedDate": "2020-11-09T17:26:52Z", "type": "forcePushed"}]}