{"pr_number": 9629, "pr_title": "KAFKA-10754: fix flaky tests by waiting kafka streams be in running state before assert", "pr_createdAt": "2020-11-20T07:44:52Z", "pr_url": "https://github.com/apache/kafka/pull/9629", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5NTQ3NQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r527495475", "bodyText": "forgot to put the kafkaStreams1 into the try resource block here", "author": "showuon", "createdAt": "2020-11-20T07:45:32Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -145,48 +142,12 @@ public void shouldShutdownClient() throws Exception {\n \n     @Test\n     public void shouldShutdownApplication() throws Exception {\n-        final Topology topology = builder.build();\n-\n-        try (final KafkaStreams kafkaStreams = new KafkaStreams(topology, properties)) {\n-            final KafkaStreams kafkaStreams1 = new KafkaStreams(topology, properties);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5NTk4NQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r527495985", "bodyText": "The start is async, and we didn't wait for it.", "author": "showuon", "createdAt": "2020-11-20T07:46:44Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -145,48 +142,12 @@ public void shouldShutdownClient() throws Exception {\n \n     @Test\n     public void shouldShutdownApplication() throws Exception {\n-        final Topology topology = builder.build();\n-\n-        try (final KafkaStreams kafkaStreams = new KafkaStreams(topology, properties)) {\n-            final KafkaStreams kafkaStreams1 = new KafkaStreams(topology, properties);\n-            final CountDownLatch latch = new CountDownLatch(1);\n-            kafkaStreams.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n-            kafkaStreams1.setUncaughtExceptionHandler((t, e) -> fail(\"should not hit old handler\"));\n-            kafkaStreams.setUncaughtExceptionHandler(exception -> SHUTDOWN_APPLICATION);\n-            kafkaStreams1.setUncaughtExceptionHandler(exception -> SHUTDOWN_APPLICATION);\n-\n-            kafkaStreams.start();\n-            kafkaStreams1.start();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcxOTU5OQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r527719599", "bodyText": "delete unused latch", "author": "showuon", "createdAt": "2020-11-20T14:16:08Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -110,83 +110,45 @@ public void teardown() throws IOException {\n     }\n \n     @Test\n-    public void shouldShutdownThreadUsingOldHandler() throws Exception {\n+    public void shouldShutdownThreadUsingOldHandler() throws InterruptedException {\n         try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n-            final CountDownLatch latch = new CountDownLatch(1);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyMDU4Mg==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r527720582", "bodyText": "We should throw a specific kind of exception, not an Exception.", "author": "showuon", "createdAt": "2020-11-20T14:17:03Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/IntegrationTestUtils.java", "diffHunk": "@@ -903,16 +903,19 @@ public static void startApplicationAndWaitUntilRunning(final List<KafkaStreams>\n     }\n \n     /**\n-     * Waits for the given {@link KafkaStreams} instances to all be in a {@link State#RUNNING}\n-     * state. Prefer {@link #startApplicationAndWaitUntilRunning(List, Duration)} when possible\n+     * Waits for the given {@link KafkaStreams} instances to all be in a specific {@link State}.\n+     * Prefer {@link #startApplicationAndWaitUntilRunning(List, Duration)} when possible\n      * because this method uses polling, which can be more error prone and slightly slower.\n      *\n      * @param streamsList the list of streams instances to run.\n-     * @param timeout the time to wait for the streams to all be in {@link State#RUNNING} state.\n+     * @param state the expected state that all the streams to be in within timeout\n+     * @param timeout the time to wait for the streams to all be in the specific state.\n+     *\n+     * @throws InterruptedException if the streams doesn't change to the expected state in time.\n      */\n     public static void waitForApplicationState(final List<KafkaStreams> streamsList,\n                                                final State state,\n-                                               final Duration timeout) throws Exception {\n+                                               final Duration timeout) throws InterruptedException {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "url": "https://github.com/apache/kafka/commit/0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "message": "KAFKA-10754: fix flaky tests by waiting kafka streams be in running state before assert", "committedDate": "2020-11-20T14:45:22Z", "type": "commit"}, {"oid": "0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "url": "https://github.com/apache/kafka/commit/0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "message": "KAFKA-10754: fix flaky tests by waiting kafka streams be in running state before assert", "committedDate": "2020-11-20T14:45:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0MTk0OA==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r527741948", "bodyText": "We should wait for the uncaughtExceptionHandler got called before waiting for the streams state change.", "author": "showuon", "createdAt": "2020-11-20T14:49:19Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -110,83 +110,45 @@ public void teardown() throws IOException {\n     }\n \n     @Test\n-    public void shouldShutdownThreadUsingOldHandler() throws Exception {\n+    public void shouldShutdownThreadUsingOldHandler() throws InterruptedException {\n         try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n-            final CountDownLatch latch = new CountDownLatch(1);\n             final AtomicBoolean flag = new AtomicBoolean(false);\n             kafkaStreams.setUncaughtExceptionHandler((t, e) -> flag.set(true));\n \n             StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n-\n             produceMessages(0L, inputTopic, \"A\");\n-            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, Duration.ofSeconds(15));\n \n             TestUtils.waitForCondition(flag::get, \"Handler was called\");\n+            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, DEFAULT_DURATION);", "originalCommit": "0e1c0c110c1f4f9eb42bea62f9129ae3a7083c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5MzUyMw==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528993523", "bodyText": "The order is not really that important here, either way works", "author": "wcarlson5", "createdAt": "2020-11-23T21:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0MTk0OA=="}], "type": "inlineReview"}, {"oid": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "url": "https://github.com/apache/kafka/commit/e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "message": "KAFKA-10754: fix shouldShutdownThreadUsingOldHandler by using only 1 stream thread", "committedDate": "2020-11-21T07:14:24Z", "type": "commit"}, {"oid": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "url": "https://github.com/apache/kafka/commit/e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "message": "KAFKA-10754: fix shouldShutdownThreadUsingOldHandler by using only 1 stream thread", "committedDate": "2020-11-21T07:14:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MDk1Mw==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528940953", "bodyText": "I think this was actually correct as it was (and ditto for the above). One alternative suggestion:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Set the handler invoked when an {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG} internal thread\n          \n          \n            \n                 * Set the handler invoked when an internal {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG stream thread}", "author": "ableegoldman", "createdAt": "2020-11-23T19:21:42Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -379,13 +379,12 @@ public void setUncaughtExceptionHandler(final Thread.UncaughtExceptionHandler un\n     }\n \n     /**\n-     * Set the handler invoked when an {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG internal thread}\n+     * Set the handler invoked when an {@link StreamsConfig#NUM_STREAM_THREADS_CONFIG} internal thread", "originalCommit": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE4MjU4MA==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r529182580", "bodyText": "Updated. Thanks.", "author": "showuon", "createdAt": "2020-11-24T03:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MDk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MjQwMQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528942401", "bodyText": "Hey @wcarlson5 , can you take a look at this? If we change the default number of threads to 1 will we be reducing test coverage or not testing the correct thing anymore?\nFWIW I think for tests where the number of threads doesn't matter, we should default to 1. But I'm not sure which tests do/do not rely on using multiple stream threads", "author": "ableegoldman", "createdAt": "2020-11-23T19:24:27Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -97,7 +97,7 @@ public void setup() {\n                 mkEntry(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, CLUSTER.bootstrapServers()),\n                 mkEntry(StreamsConfig.APPLICATION_ID_CONFIG, appId),\n                 mkEntry(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath()),\n-                mkEntry(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 2),\n+                mkEntry(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 1),", "originalCommit": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5Mjg4OQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528992889", "bodyText": "Yes, Both the old handler test and the close client should have 2 threads. We need to ensure that after a rebalance the old handler has attempted the process the record twice and the client shutdown only once. We can not be sure of that with only one thread.", "author": "wcarlson5", "createdAt": "2020-11-23T21:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MjQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MzM4OQ==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528943389", "bodyText": "@wcarlson5 for example, this test probably should have multiple threads, right?", "author": "ableegoldman", "createdAt": "2020-11-23T19:26:00Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/StreamsUncaughtExceptionHandlerIntegrationTest.java", "diffHunk": "@@ -110,83 +110,45 @@ public void teardown() throws IOException {\n     }\n \n     @Test\n-    public void shouldShutdownThreadUsingOldHandler() throws Exception {\n+    public void shouldShutdownThreadUsingOldHandler() throws InterruptedException {\n         try (final KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties)) {\n-            final CountDownLatch latch = new CountDownLatch(1);\n             final AtomicBoolean flag = new AtomicBoolean(false);\n             kafkaStreams.setUncaughtExceptionHandler((t, e) -> flag.set(true));\n \n             StreamsTestUtils.startKafkaStreamsAndWaitForRunningState(kafkaStreams);\n-\n             produceMessages(0L, inputTopic, \"A\");\n-            waitForApplicationState(Collections.singletonList(kafkaStreams), KafkaStreams.State.ERROR, Duration.ofSeconds(15));\n \n             TestUtils.waitForCondition(flag::get, \"Handler was called\");\n-            assertThat(processorValueCollector.size(), equalTo(2));", "originalCommit": "e6d39f6dc15a198a5a58d34d239a1021eeaf43b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk5Mjk4Ng==", "url": "https://github.com/apache/kafka/pull/9629#discussion_r528992986", "bodyText": "as above", "author": "wcarlson5", "createdAt": "2020-11-23T21:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0MzM4OQ=="}], "type": "inlineReview"}, {"oid": "2b6d0a2d285b5b7fc0a9a8474712870f6f7a767e", "url": "https://github.com/apache/kafka/commit/2b6d0a2d285b5b7fc0a9a8474712870f6f7a767e", "message": "KAFKA-10754: revert to set the default thread number as 2, and make the test more reliable", "committedDate": "2020-11-24T04:26:39Z", "type": "commit"}]}