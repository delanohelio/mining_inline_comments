{"pr_number": 8502, "pr_title": "KAFKA-9066: Retain metrics for failed tasks", "pr_createdAt": "2020-04-16T20:25:29Z", "pr_url": "https://github.com/apache/kafka/pull/8502", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzMjk0NA==", "url": "https://github.com/apache/kafka/pull/8502#discussion_r410432944", "bodyText": "I am not sure I understand the need for WorkerTask and WorkerSource/SinkTask to implement different methods. Usually, this would be done by the subclasses overriding the parent class implementation and making sure to call the parent implementation somewhere with super.xxx(). Am I missing some requirement here that necessitates the separate methods?", "author": "ncliang", "createdAt": "2020-04-17T19:41:46Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerTask.java", "diffHunk": "@@ -144,15 +144,25 @@ public boolean awaitStop(long timeoutMs) {\n         }\n     }\n \n+    /**\n+     * Remove all metrics published by this task.\n+     */\n+    public void removeMetrics() {\n+        try {\n+            removeAdditionalMetrics();\n+        } finally {\n+            taskMetricsGroup.close();\n+        }\n+    }\n+\n     protected abstract void execute();\n \n     protected abstract void close();\n \n     /**\n-     * Method called when this worker task has been completely closed, and when the subclass should clean up\n-     * all resources.\n+     * Remove any metrics specific to the subclass. Invoked as part of {@link #removeMetrics}.\n      */\n-    protected abstract void releaseResources();\n+    protected abstract void removeAdditionalMetrics();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzODYzMg==", "url": "https://github.com/apache/kafka/pull/8502#discussion_r410438632", "bodyText": "Yeah, I was thinking about this. Not super attached to either approach, just went with the one that reduced code duplication and took shared logic (try to release source/sink-specific metrics, then release generic task metrics even if that failed) and put it in one place, the abstract class.\nI think an alternative might look like this in WorkerTask:\npublic void removeMetrics() {\n    taskMetricsGroup.close();\n}\nand this in WorkerSinkTask (with something similar in WorkerSourceTask):\n@Override\npublic void removeMetrics() {\n    try {\n        sinkTaskMetricsGroup.close();\n    } finally {\n        super.removeMetrics();\n    }\n}\nIf this looks better, or you were thinking of something completely different, LMK.", "author": "C0urante", "createdAt": "2020-04-17T19:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzMjk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ0MTU1OQ==", "url": "https://github.com/apache/kafka/pull/8502#discussion_r410441559", "bodyText": "Yeah, this was exactly what I had in mind. Conceptually, both child and parent classes need to do some stuff for cleanup. Child class does its cleanup and then just delegates to parent implementation to do parent cleanup. Took me a while to realize that the separate methods on the WorkerTask and WorkerSink/SourceTask were doing exactly this. I think following the common idiom would be a bit more readable.", "author": "ncliang", "createdAt": "2020-04-17T20:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzMjk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ0NjkzNA==", "url": "https://github.com/apache/kafka/pull/8502#discussion_r410446934", "bodyText": "Ack, will update :)", "author": "C0urante", "createdAt": "2020-04-17T20:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzMjk0NA=="}], "type": "inlineReview"}, {"oid": "b7e4f190327548ebec08b89c6a8b5618af38b32e", "url": "https://github.com/apache/kafka/commit/b7e4f190327548ebec08b89c6a8b5618af38b32e", "message": "KAFKA-9066: Retain metrics for failed tasks", "committedDate": "2020-05-29T19:03:24Z", "type": "commit"}, {"oid": "d191a225eeaf61b717fff4f976e41685b8c1f037", "url": "https://github.com/apache/kafka/commit/d191a225eeaf61b717fff4f976e41685b8c1f037", "message": "KAFKA-9066: Address review feedback", "committedDate": "2020-05-29T19:03:24Z", "type": "commit"}, {"oid": "23006980861f55f34af20673da14253b134a94b6", "url": "https://github.com/apache/kafka/commit/23006980861f55f34af20673da14253b134a94b6", "message": "KAFKA-9066: Fix unit tests", "committedDate": "2020-05-29T19:22:54Z", "type": "commit"}, {"oid": "23006980861f55f34af20673da14253b134a94b6", "url": "https://github.com/apache/kafka/commit/23006980861f55f34af20673da14253b134a94b6", "message": "KAFKA-9066: Fix unit tests", "committedDate": "2020-05-29T19:22:54Z", "type": "forcePushed"}]}