{"pr_number": 8540, "pr_title": "KAFKA-9127: don't create StreamThreads for global-only topology", "pr_createdAt": "2020-04-23T21:25:30Z", "pr_url": "https://github.com/apache/kafka/pull/8540", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4MjUzNA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414182534", "bodyText": "Can you create a method to getBuilderWithSource() and just call it inline instead of creating a new mutable field for all the tests to rely on?", "author": "vvcephei", "createdAt": "2020-04-23T23:08:17Z", "path": "streams/src/test/java/org/apache/kafka/streams/KafkaStreamsTest.java", "diffHunk": "@@ -161,6 +165,9 @@ public void before() throws Exception {\n         props.put(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getPath());\n         props.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, NUM_THREADS);\n \n+        builder = new StreamsBuilder();\n+        builder.stream(\"source\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMTEwNw==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414201107", "bodyText": "Good call, done", "author": "ableegoldman", "createdAt": "2020-04-23T23:57:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4MjUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDM2OA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414204368", "bodyText": "Do we really need to add this exception? How much work would it be to reduce the complexity of KafkaStreams?", "author": "mjsax", "createdAt": "2020-04-24T00:06:36Z", "path": "checkstyle/suppressions.xml", "diffHunk": "@@ -181,7 +181,7 @@\n               files=\"StreamsPartitionAssignor.java\"/>\n \n     <suppress checks=\"NPathComplexity\"\n-              files=\"(ProcessorStateManager|InternalTopologyBuilder|StreamsPartitionAssignor|StreamThread|TaskManager|AssignorConfiguration).java\"/>\n+              files=\"(AssignorConfiguration|InternalTopologyBuilder|KafkaStreams|ProcessorStateManager|StreamsPartitionAssignor|StreamThread|TaskManager).java\"/>", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxNDg2NA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414214864", "bodyText": "NPathComplexity is a tough one to work around. We'd wind up having to move some blocks of logic to separate helper classes.", "author": "vvcephei", "createdAt": "2020-04-24T00:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNTEwOA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414205108", "bodyText": "I don't think this should be WARN but an INFO. There is nothing \"wrong\" and thus nothing to warn about?", "author": "mjsax", "createdAt": "2020-04-24T00:08:42Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -701,18 +703,33 @@ private KafkaStreams(final InternalTopologyBuilder internalTopologyBuilder,\n                 internalTopologyBuilder,\n                 parseHostInfo(config.getString(StreamsConfig.APPLICATION_SERVER_CONFIG)));\n \n+        final int numStreamThreads;\n+        if (internalTopologyBuilder.hasNoNonGlobalTopology()) {\n+            log.warn(\"Overriding number of StreamThreads to zero for global-only topology\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI3MA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414207270", "bodyText": "Do we really want to do this? I understand that and empty topology does not make sense, and it would be appropriate to log a WARN -- but do we need/want to reject it?\nAlso, should we instead throw an InvalidTopologyException? Furthermore, should we add a similar check to StreamsBuilder.builder() to raise this error even earlier (we would still nee this check though).", "author": "mjsax", "createdAt": "2020-04-24T00:14:46Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -701,18 +703,33 @@ private KafkaStreams(final InternalTopologyBuilder internalTopologyBuilder,\n                 internalTopologyBuilder,\n                 parseHostInfo(config.getString(StreamsConfig.APPLICATION_SERVER_CONFIG)));\n \n+        final int numStreamThreads;\n+        if (internalTopologyBuilder.hasNoNonGlobalTopology()) {\n+            log.warn(\"Overriding number of StreamThreads to zero for global-only topology\");\n+            numStreamThreads = 0;\n+        } else {\n+            numStreamThreads = config.getInt(StreamsConfig.NUM_STREAM_THREADS_CONFIG);\n+        }\n+\n         // create the stream thread, global update thread, and cleanup thread\n-        threads = new StreamThread[config.getInt(StreamsConfig.NUM_STREAM_THREADS_CONFIG)];\n+        threads = new StreamThread[numStreamThreads];\n+\n+        final ProcessorTopology globalTaskTopology = internalTopologyBuilder.buildGlobalStateTopology();\n+        final boolean hasGlobalTopology = globalTaskTopology != null;\n+\n+        if (numStreamThreads == 0 && !hasGlobalTopology) {\n+            log.error(\"Must subscribe to at least one source topic or global table\");\n+            throw new IllegalArgumentException(\"Topology has no stream threads and no global threads\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMjQwNg==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414822406", "bodyText": "I guess I can't personally imagine any reason to ever want an app running with an empty topology, and would prefer to be notified immediately since I presumably did something wrong. But if you feel strongly about allowing this I can demote this to a warning", "author": "ableegoldman", "createdAt": "2020-04-24T19:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMjkyOQ==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414822929", "bodyText": "Also, do we have an InvalidTopologyException or similar exception already? Or were you proposing to add a new type\nedit: Nevermind it's just TopologyException, found it", "author": "ableegoldman", "createdAt": "2020-04-24T19:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzc1NA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414207754", "bodyText": "The change to reject an empty topology make our testing rather \"ugly\"... Do we really need to reject it?", "author": "mjsax", "createdAt": "2020-04-24T00:16:06Z", "path": "streams/src/test/java/org/apache/kafka/streams/KafkaStreamsTest.java", "diffHunk": "@@ -327,15 +331,15 @@ private void prepareStreamThread(final StreamThread thread, final boolean termin\n \n     @Test\n     public void testShouldTransitToNotRunningIfCloseRightAfterCreated() {\n-        final KafkaStreams streams = new KafkaStreams(new StreamsBuilder().build(), props, supplier, time);\n+        final KafkaStreams streams = new KafkaStreams(getBuilderWithSource().build(), props, supplier, time);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMzAxMA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414823010", "bodyText": "Is getBuilderWithSource really that much uglier than new StreamsBuilder? :P", "author": "ableegoldman", "createdAt": "2020-04-24T19:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMjY3OQ==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414832679", "bodyText": "Would a class-level final StreamsBuilder builder = new StreamsBuilder() that we add a source to in the setUp be any. better iyo?", "author": "ableegoldman", "createdAt": "2020-04-24T20:07:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkxNjk1MA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414916950", "bodyText": "I think the suggestion was more along the lines of not throwing an exception while building an empty topology.\nI'm not sure. It seems kind of nice to find out right away that your program will do absolutely nothing. I'm not totally sure you could really run an empty topology. Can you subscribe a Consumer to \"no topics\"?", "author": "vvcephei", "createdAt": "2020-04-24T23:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMjUwNA==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414922504", "bodyText": "I realize he wasn't just complaining about the name, but I was trying to keep that discussion in one thread. But I guess you can only do so much to keep PR chatter oriented in one place", "author": "ableegoldman", "createdAt": "2020-04-24T23:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMzAwNw==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414923007", "bodyText": "But @vvcephei 's last question gets right to the heart of the matter. The answer being \" technically yes, but it will crash if you try to poll for said nothing, so really no\"\nThat's why the test was flaky, and the reason for this PR in the first place (Avoiding group overhead is the name of the ticket, but the reality is it will only happen once before all the StreamThreads die due to polling no topics)", "author": "ableegoldman", "createdAt": "2020-04-24T23:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY4MTAwMQ==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r418681001", "bodyText": "Thanks for clarification.", "author": "mjsax", "createdAt": "2020-05-01T18:44:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNzc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODI4Mw==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414208283", "bodyText": "IMHO, we should always get the exception and assert on the error message (otherwise, it exception might be throw because of. different reason the the test does not test what it is support to test -- we have seen this issue in the past).", "author": "mjsax", "createdAt": "2020-04-24T00:17:40Z", "path": "streams/src/test/java/org/apache/kafka/streams/KafkaStreamsTest.java", "diffHunk": "@@ -883,6 +887,50 @@ public void statefulTopologyShouldCreateStateDirectory() throws Exception {\n         startStreamsAndCheckDirExists(topology, true);\n     }\n \n+    @Test\n+    public void shouldThrowIllegalArgumentExceptionOnEmptyTopology() {\n+        assertThrows(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyNTM4Nw==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414825387", "bodyText": "Ack", "author": "ableegoldman", "createdAt": "2020-04-24T19:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwODI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwOTIyMw==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414209223", "bodyText": "Is the state listener executed on the correct thread (ie, main testing thread?) that thus would really make the test fail? From my current understanding it would be called by the GlobalThread and thus the global thread would die instead (this would lead to a timeout below I guess?)", "author": "mjsax", "createdAt": "2020-04-24T00:20:20Z", "path": "streams/src/test/java/org/apache/kafka/streams/KafkaStreamsTest.java", "diffHunk": "@@ -883,6 +887,50 @@ public void statefulTopologyShouldCreateStateDirectory() throws Exception {\n         startStreamsAndCheckDirExists(topology, true);\n     }\n \n+    @Test\n+    public void shouldThrowIllegalArgumentExceptionOnEmptyTopology() {\n+        assertThrows(\n+            IllegalArgumentException.class,\n+            () -> new KafkaStreams(new StreamsBuilder().build(), props, supplier, time)\n+        );\n+    }\n+\n+    @Test\n+    public void shouldNotCreateStreamThreadsForGlobalOnlyTopology() {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        builder.globalTable(\"anyTopic\");\n+        final KafkaStreams streams = new KafkaStreams(builder.build(), props, supplier, time);\n+\n+        assertThat(streams.threads.length, equalTo(0));\n+    }\n+\n+    @Test\n+    public void shouldNotTransitToErrorStateWithGlobalOnlyTopology() throws InterruptedException {\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        builder.globalTable(\"anyTopic\");\n+        final KafkaStreams streams = new KafkaStreams(builder.build(), props, supplier, time);\n+        streams.setStateListener((newState, oldState) -> {\n+            if (newState.equals(State.ERROR)) {\n+                throw new AssertionError(\"Should not have transitioned to ERROR state with no stream threads\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgxOTc2NQ==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r414819765", "bodyText": "I guess we don't need to throw here, it would just cause KafkaStreams to transition to ERROR and fail below. But I realized this doesn't even do that because we're mocking pretty much everything in this test class including the stream threads. I'll try to look for a better way and place to do this test", "author": "ableegoldman", "createdAt": "2020-04-24T19:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwOTIyMw=="}], "type": "inlineReview"}, {"oid": "d5eecbb98ec5627e7bde875d2bc698e287229425", "url": "https://github.com/apache/kafka/commit/d5eecbb98ec5627e7bde875d2bc698e287229425", "message": "dont create threads, fix up and add tests", "committedDate": "2020-04-27T23:11:08Z", "type": "commit"}, {"oid": "f08afa21e1870bcc0f64628b6e983e3b5f8bf7a7", "url": "https://github.com/apache/kafka/commit/f08afa21e1870bcc0f64628b6e983e3b5f8bf7a7", "message": "remove unnecessary sync", "committedDate": "2020-04-27T23:11:08Z", "type": "commit"}, {"oid": "ec5dee484868a61b065061148b5feb676d3304fa", "url": "https://github.com/apache/kafka/commit/ec5dee484868a61b065061148b5feb676d3304fa", "message": "github suggestion", "committedDate": "2020-04-27T23:11:08Z", "type": "commit"}, {"oid": "365c9872bba5a5470dc216020ffa944bb2f66c4e", "url": "https://github.com/apache/kafka/commit/365c9872bba5a5470dc216020ffa944bb2f66c4e", "message": "fix tests, should stop using find and replace to makes changes already...", "committedDate": "2020-04-27T23:11:09Z", "type": "commit"}, {"oid": "494818e2f6a055049c435e7bcb373dbce184e886", "url": "https://github.com/apache/kafka/commit/494818e2f6a055049c435e7bcb373dbce184e886", "message": "review props", "committedDate": "2020-04-27T23:11:09Z", "type": "commit"}, {"oid": "f542c7a91390fe34b13dc73f9a1f17454a3642db", "url": "https://github.com/apache/kafka/commit/f542c7a91390fe34b13dc73f9a1f17454a3642db", "message": "change exception to TopologyException", "committedDate": "2020-04-27T23:11:09Z", "type": "commit"}, {"oid": "f1702f168b6ebd6581f5993bca96f557887201df", "url": "https://github.com/apache/kafka/commit/f1702f168b6ebd6581f5993bca96f557887201df", "message": "'add' test", "committedDate": "2020-04-27T23:12:15Z", "type": "commit"}, {"oid": "f1702f168b6ebd6581f5993bca96f557887201df", "url": "https://github.com/apache/kafka/commit/f1702f168b6ebd6581f5993bca96f557887201df", "message": "'add' test", "committedDate": "2020-04-27T23:12:15Z", "type": "forcePushed"}, {"oid": "459e38c80dc250613e4b2c18d12ee4915bfcd22b", "url": "https://github.com/apache/kafka/commit/459e38c80dc250613e4b2c18d12ee4915bfcd22b", "message": "add separate integration test", "committedDate": "2020-04-27T23:19:41Z", "type": "commit"}, {"oid": "0d07c5612b1c3e4790239967b8e9f5332b8ad10d", "url": "https://github.com/apache/kafka/commit/0d07c5612b1c3e4790239967b8e9f5332b8ad10d", "message": "remove added excpt", "committedDate": "2020-04-27T23:20:05Z", "type": "commit"}, {"oid": "85ec07e54e251e9c3f4e41fec4213079f4aae755", "url": "https://github.com/apache/kafka/commit/85ec07e54e251e9c3f4e41fec4213079f4aae755", "message": "remove extra lines", "committedDate": "2020-04-27T23:22:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIxNTUxMw==", "url": "https://github.com/apache/kafka/pull/8540#discussion_r416215513", "bodyText": "Copied this over to trunk and verified that it fails consistently", "author": "ableegoldman", "createdAt": "2020-04-27T23:22:38Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/GlobalKTableIntegrationTest.java", "diffHunk": "@@ -265,12 +270,27 @@ public void shouldRestoreGlobalInMemoryKTableOnRestart() throws Exception {\n         kafkaStreams.close();\n \n         startStreams();\n+\n         store = kafkaStreams.store(StoreQueryParameters.fromNameAndType(globalStore, QueryableStoreTypes.keyValueStore()));\n         assertThat(store.approximateNumEntries(), equalTo(4L));\n         timestampedStore = kafkaStreams.store(StoreQueryParameters.fromNameAndType(globalStore, QueryableStoreTypes.timestampedKeyValueStore()));\n         assertThat(timestampedStore.approximateNumEntries(), equalTo(4L));\n     }\n \n+    @Test\n+    public void shouldGetToRunningWithOnlyGlobalTopology() throws Exception {", "originalCommit": "0d07c5612b1c3e4790239967b8e9f5332b8ad10d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "049e3528b83ded730da75e4b888a8256d4955273", "url": "https://github.com/apache/kafka/commit/049e3528b83ded730da75e4b888a8256d4955273", "message": "fix test exception message", "committedDate": "2020-04-28T16:54:36Z", "type": "commit"}]}