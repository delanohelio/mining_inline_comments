{"pr_number": 8339, "pr_title": "KAFKA-9752; New member timeout can leave group rebalance stuck", "pr_createdAt": "2020-03-24T07:21:31Z", "pr_url": "https://github.com/apache/kafka/pull/8339", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4ODIzMw==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397088233", "bodyText": "May be useful to add a comment since this has a slightly unusual usage", "author": "rajinisivaram", "createdAt": "2020-03-24T11:40:18Z", "path": "core/src/main/scala/kafka/coordinator/group/MemberMetadata.scala", "diffHunk": "@@ -66,7 +66,7 @@ private[group] class MemberMetadata(var memberId: String,\n   var assignment: Array[Byte] = Array.empty[Byte]\n   var awaitingJoinCallback: JoinGroupResult => Unit = null\n   var awaitingSyncCallback: SyncGroupResult => Unit = null\n-  var latestHeartbeat: Long = -1\n+  var heartbeatSatisfied: Boolean = false", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMwNzY3OQ==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397307679", "bodyText": "I will add a comment. I struggled to find a simpler way to map heartbeat expiration onto purgatory semantics. This was the best I could come up with, though I agree it is a little unusual.", "author": "hachikuji", "createdAt": "2020-03-24T16:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4ODIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM4MTM5MA==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397381390", "bodyText": "I had a different idea about this, but after second thought I think it's better to just make it hard-explicit, rather than embedding in a less-readable math equation. Now I feel it's better to be unusual than bug-vulnerable.", "author": "guozhangwang", "createdAt": "2020-03-24T18:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4ODIzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4OTc4Nw==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397089787", "bodyText": "Sad to see this go since it was useful when things went wrong. But since it is not used anymore, I guess it must go.", "author": "rajinisivaram", "createdAt": "2020-03-24T11:43:17Z", "path": "core/src/main/scala/kafka/coordinator/group/MemberMetadata.scala", "diffHunk": "@@ -66,7 +66,7 @@ private[group] class MemberMetadata(var memberId: String,\n   var assignment: Array[Byte] = Array.empty[Byte]\n   var awaitingJoinCallback: JoinGroupResult => Unit = null\n   var awaitingSyncCallback: SyncGroupResult => Unit = null\n-  var latestHeartbeat: Long = -1", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI3OTkxNA==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397279914", "bodyText": "I think its current usage was a bit error-prone. However, if it's useful for debugging, we can find a way to keep it. It did help us understand this bug after all. Perhaps we could have a separate field for the last time a request was received?", "author": "hachikuji", "createdAt": "2020-03-24T16:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4OTc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM4Nzk4OA==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397387988", "bodyText": "Hmm, do we still need to rely on isNew here? Could the condition just be heartbeatSatisfied || isAwaitingJoin || isAwaitingSync?", "author": "guozhangwang", "createdAt": "2020-03-24T18:53:42Z", "path": "core/src/main/scala/kafka/coordinator/group/MemberMetadata.scala", "diffHunk": "@@ -85,16 +85,16 @@ private[group] class MemberMetadata(var memberId: String,\n     }\n   }\n \n-  def shouldKeepAlive(deadlineMs: Long): Boolean = {\n+  def hasSatisfiedHeartbeat: Boolean = {\n     if (isNew) {\n-      // New members are expired after the static join timeout\n-      latestHeartbeat + GroupCoordinator.NewMemberJoinTimeoutMs > deadlineMs\n+      // New members can be expired while awaiting join, so we have to check this first", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwOTk4MQ==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397409981", "bodyText": "The awkward thing about the isNew case is that we want the member to fail while isAwaitingJoin is true. This is attempting to handle the case for old versions of the protocol where a client sends JoinGroup with empty memberId and then times out. I was debating how important this logic is, but I seem to recall a case in the past where the group grew very large because new members kept timing out and retrying.", "author": "hachikuji", "createdAt": "2020-03-24T19:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM4Nzk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNjk1MQ==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397506951", "bodyText": "Fair enough; originally I thought we can now just remove this isNew flag now but I think I buy your arguments now.", "author": "guozhangwang", "createdAt": "2020-03-24T22:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM4Nzk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM4ODg4OQ==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397388889", "bodyText": "Not sure if this test covers the original bug, could you elaborate a bit more?", "author": "guozhangwang", "createdAt": "2020-03-24T18:55:16Z", "path": "core/src/test/scala/unit/kafka/coordinator/group/GroupCoordinatorTest.scala", "diffHunk": "@@ -381,6 +381,41 @@ class GroupCoordinatorTest {\n     assertEquals(firstMemberId, group.allMembers.head)\n   }\n \n+  @Test\n+  def testLeaderFailsBeforeSyncGroup(): Unit = {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMDgwMA==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397410800", "bodyText": "Probably need to rename this. I'll add a comment as well. The test fails without the patch because the group is stuck in the PreparingRebalance state and does not make the transition to Empty as expected.", "author": "hachikuji", "createdAt": "2020-03-24T19:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM4ODg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMjIyNw==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397412227", "bodyText": "why to complete Heartbeat here?", "author": "chia7712", "createdAt": "2020-03-24T19:37:07Z", "path": "core/src/main/scala/kafka/coordinator/group/GroupCoordinator.scala", "diffHunk": "@@ -1167,25 +1170,23 @@ class GroupCoordinator(val brokerId: Int,\n         if (group.has(memberId)) {\n           forceComplete()\n         } else false\n-      } else {\n-        if (shouldCompleteNonPendingHeartbeat(group, memberId, heartbeatDeadline)) {\n-          forceComplete()\n-        } else false\n-      }\n+      } else if (shouldCompleteNonPendingHeartbeat(group, memberId)) {\n+        forceComplete()\n+      } else false\n     }\n   }\n \n-  def shouldCompleteNonPendingHeartbeat(group: GroupMetadata, memberId: String, heartbeatDeadline: Long): Boolean = {\n+  def shouldCompleteNonPendingHeartbeat(group: GroupMetadata, memberId: String): Boolean = {\n     if (group.has(memberId)) {\n       val member = group.get(memberId)\n-      member.shouldKeepAlive(heartbeatDeadline) || member.isLeaving\n+      member.hasSatisfiedHeartbeat || member.isLeaving\n     } else {\n-      info(s\"Member id $memberId was not found in ${group.groupId} during heartbeat expiration.\")\n-      false\n+      info(s\"Member id $memberId was not found in ${group.groupId} during heartbeat completion check\")\n+      true", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQyNDA4OQ==", "url": "https://github.com/apache/kafka/pull/8339#discussion_r397424089", "bodyText": "Heartbeat \"completion\" is a really confusing notion in this code. If the delayed heartbeat gets completed, that just means we do not need its expiration any longer. In this case if a member has already been removed from the group, then we do not need to wait for expiration of the delayed heartbeat to remove it.", "author": "hachikuji", "createdAt": "2020-03-24T19:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMjIyNw=="}], "type": "inlineReview"}, {"oid": "edc6f8e1e451054026c5b7339c80e935a365932c", "url": "https://github.com/apache/kafka/commit/edc6f8e1e451054026c5b7339c80e935a365932c", "message": "KAFKA-9752; New member timeout can leave rebalance stuck", "committedDate": "2020-03-24T22:00:55Z", "type": "commit"}, {"oid": "b64ad18e2413bcc0ae18fa134403bc2a594427ea", "url": "https://github.com/apache/kafka/commit/b64ad18e2413bcc0ae18fa134403bc2a594427ea", "message": "Address comments and add another test case", "committedDate": "2020-03-24T22:35:02Z", "type": "commit"}, {"oid": "b64ad18e2413bcc0ae18fa134403bc2a594427ea", "url": "https://github.com/apache/kafka/commit/b64ad18e2413bcc0ae18fa134403bc2a594427ea", "message": "Address comments and add another test case", "committedDate": "2020-03-24T22:35:02Z", "type": "forcePushed"}]}