{"pr_number": 8468, "pr_title": "MINOR: reduce impact of trace logging in replica hot path", "pr_createdAt": "2020-04-12T01:10:28Z", "pr_url": "https://github.com/apache/kafka/pull/8468", "timeline": [{"oid": "b3ca4bafb0ba749a0c995c44d3749480269d26f3", "url": "https://github.com/apache/kafka/commit/b3ca4bafb0ba749a0c995c44d3749480269d26f3", "message": "MINOR: reduce impact of trace logging in replica hot path", "committedDate": "2020-04-06T21:26:54Z", "type": "commit"}, {"oid": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "url": "https://github.com/apache/kafka/commit/58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "message": "Perform trace check once per partition in replica fetcher thread", "committedDate": "2020-04-06T21:27:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDA1Mg==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130052", "bodyText": "I need a way to do this more cleanly. Is it OK to put an isTraceEnabled call into the logger rather than access the underlying directly?", "author": "lbradstreet", "createdAt": "2020-04-12T01:11:20Z", "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -785,7 +785,7 @@ class ReplicaManager(val config: KafkaConfig,\n                                origin: AppendOrigin,\n                                entriesPerPartition: Map[TopicPartition, MemoryRecords],\n                                requiredAcks: Short): Map[TopicPartition, LogAppendResult] = {\n-\n+    val isTraceEnabled = logger.underlying.isTraceEnabled", "originalCommit": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDA5OQ==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130099", "bodyText": "Saves 3 getEffectiveLevel checks.", "author": "lbradstreet", "createdAt": "2020-04-12T01:11:58Z", "path": "core/src/main/scala/kafka/server/ReplicaFetcherThread.scala", "diffHunk": "@@ -149,6 +149,7 @@ class ReplicaFetcherThread(name: String,\n   override def processPartitionData(topicPartition: TopicPartition,\n                                     fetchOffset: Long,\n                                     partitionData: FetchData): Option[LogAppendInfo] = {\n+    val logTrace = isTraceEnabled", "originalCommit": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMDMwNQ==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407130305", "bodyText": "Looking up the trace level outside of the map allows us to save a isTraceEnabled lookup for every partition being produced to.", "author": "lbradstreet", "createdAt": "2020-04-12T01:14:29Z", "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -820,8 +822,10 @@ class ReplicaManager(val config: KafkaConfig,\n           brokerTopicStats.topicStats(topicPartition.topic).messagesInRate.mark(numAppendedMessages)\n           brokerTopicStats.allTopicsStats.messagesInRate.mark(numAppendedMessages)\n \n-          trace(s\"${records.sizeInBytes} written to log $topicPartition beginning at offset \" +\n-            s\"${info.firstOffset.getOrElse(-1)} and ending at offset ${info.lastOffset}\")\n+          if (isTraceEnabled)", "originalCommit": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzMTMyNQ==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407131325", "bodyText": "Looking up the trace level above means we only need to get the effective level once even though read() may be called once for each partition.", "author": "lbradstreet", "createdAt": "2020-04-12T01:28:46Z", "path": "core/src/main/scala/kafka/server/ReplicaManager.scala", "diffHunk": "@@ -978,9 +983,10 @@ class ReplicaManager(val config: KafkaConfig,\n \n       val adjustedMaxBytes = math.min(fetchInfo.maxBytes, limitBytes)\n       try {\n-        trace(s\"Fetching log segment for partition $tp, offset $offset, partition fetch size $partitionFetchSize, \" +\n-          s\"remaining response limit $limitBytes\" +\n-          (if (minOneMessage) s\", ignoring response/partition size limits\" else \"\"))\n+        if (isTraceEnabled)", "originalCommit": "58d7677904fe8fa17ae7e9fbf509c7266dd0da0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69", "url": "https://github.com/apache/kafka/commit/c206dd906d6e5cd0893cdf86bbd1535f42aecb69", "message": "Avoid calling the underlying logger", "committedDate": "2020-04-12T01:29:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjYwMg==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407832602", "bodyText": "I don't think this trace call is worthwhile given the cost. It would be hard to turn it on without being deluged with logs.", "author": "lbradstreet", "createdAt": "2020-04-14T02:43:11Z", "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -83,7 +83,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     lastFetchLeaderLogEndOffset = leaderEndOffset\n     lastFetchTimeMs = followerFetchTimeMs\n     updateLastSentHighWatermark(lastSentHighwatermark)\n-    trace(s\"Updated state of replica to $this\")", "originalCommit": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r407832642", "bodyText": "I don't think this trace call is worthwhile given the cost. It would be hard to turn it on without being deluged with logs..", "author": "lbradstreet", "createdAt": "2020-04-14T02:43:22Z", "path": "core/src/main/scala/kafka/cluster/Replica.scala", "diffHunk": "@@ -96,7 +95,6 @@ class Replica(val brokerId: Int, val topicPartition: TopicPartition) extends Log\n     */\n   private def updateLastSentHighWatermark(highWatermark: Long): Unit = {\n     _lastSentHighWatermark = highWatermark\n-    trace(s\"Updated HW of replica to $highWatermark\")", "originalCommit": "c206dd906d6e5cd0893cdf86bbd1535f42aecb69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzODg1Mw==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r409538853", "bodyText": "@junrao Thoughts? Can we remove these calls?", "author": "ijuma", "createdAt": "2020-04-16T13:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxNjAyOQ==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r409916029", "bodyText": "At minimum I think we could keep the trace I deleted here: #8468 (comment) which should end up logging the lastSentWatermark anyway?", "author": "lbradstreet", "createdAt": "2020-04-16T23:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2NzQ0Mw==", "url": "https://github.com/apache/kafka/pull/8468#discussion_r410367443", "bodyText": "Yes, I agree this may not be that useful. We have other logging like the following in Partition.updateFollowerFetchState() that provides similar traceability.\n        debug(s\"Recorded replica $followerId log end offset (LEO) position \" +\n          s\"${followerFetchOffsetMetadata.messageOffset} and log start offset $followerStartOffset.\")", "author": "junrao", "createdAt": "2020-04-17T17:29:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMjY0Mg=="}], "type": "inlineReview"}]}