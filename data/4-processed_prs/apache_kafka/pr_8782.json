{"pr_number": 8782, "pr_title": "KAFKA-10080; Fix race condition on txn completion which can cause duplicate appends", "pr_createdAt": "2020-06-02T16:54:28Z", "pr_url": "https://github.com/apache/kafka/pull/8782", "timeline": [{"oid": "44d281555a4d7f624fe9e7c6585550bfdb477702", "url": "https://github.com/apache/kafka/commit/44d281555a4d7f624fe9e7c6585550bfdb477702", "message": "KAFKA-10080; Fix race condition on txn completion which can cause duplicate appends", "committedDate": "2020-06-02T16:46:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzODQ2OQ==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434038469", "bodyText": "How about renaming pendingCommitTxn to pendingCompleteTxn", "author": "chia7712", "createdAt": "2020-06-02T17:10:28Z", "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala", "diffHunk": "@@ -215,8 +215,6 @@ class TransactionMarkerChannelManager(config: KafkaConfig,\n   }\n \n   private def writeTxnCompletion(pendingCommitTxn: PendingCompleteTxn): Unit = {", "originalCommit": "44d281555a4d7f624fe9e7c6585550bfdb477702", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d1d5607db8d30bda2fb4c2c689f8d6b8d32c0e8", "url": "https://github.com/apache/kafka/commit/9d1d5607db8d30bda2fb4c2c689f8d6b8d32c0e8", "message": "Rename pendingCommitTxn to pendingCompleteTxn", "committedDate": "2020-06-02T18:32:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA5ODU0NQ==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434098545", "bodyText": "Multiple threads may see the transaction still as pending and attempt completion.", "author": "hachikuji", "createdAt": "2020-06-02T18:39:41Z", "path": "core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerChannelManager.scala", "diffHunk": "@@ -285,15 +280,16 @@ class TransactionMarkerChannelManager(config: KafkaConfig,\n     }\n   }\n \n-  private def maybeWriteTxnCompletion(transactionalId: String): Unit = {\n-    Option(transactionsWithPendingMarkers.get(transactionalId)).foreach { pendingCommitTxn =>", "originalCommit": "9d1d5607db8d30bda2fb4c2c689f8d6b8d32c0e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f", "url": "https://github.com/apache/kafka/commit/c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f", "message": "Fix failing test due to nice mock change", "committedDate": "2020-06-02T19:57:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE1MzIxMA==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434153210", "bodyText": "The change to use mock instead of niceMock led to a failure because of an unexpected append to the log. It seemed like this call was not necessary to test the behavior we were interested in here, so I removed it rather than adding the expected call to append.", "author": "hachikuji", "createdAt": "2020-06-02T20:21:49Z", "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionMarkerChannelManagerTest.scala", "diffHunk": "@@ -221,7 +221,6 @@ class TransactionMarkerChannelManagerTest {\n     EasyMock.replay(metadataCache)\n \n     channelManager.addTxnMarkersToSend(coordinatorEpoch, txnResult, txnMetadata1, txnMetadata1.prepareComplete(time.milliseconds()))\n-    channelManager.addTxnMarkersToSend(coordinatorEpoch, txnResult, txnMetadata2, txnMetadata2.prepareComplete(time.milliseconds()))", "originalCommit": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzI5Nw==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434173297", "bodyText": "Does this test cover concurrent calls to maybeWriteTxnCompletion?", "author": "guozhangwang", "createdAt": "2020-06-02T21:01:36Z", "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionMarkerChannelManagerTest.scala", "diffHunk": "@@ -86,6 +90,70 @@ class TransactionMarkerChannelManagerTest {\n       .anyTimes()\n   }\n \n+  @Test\n+  def shouldOnlyWriteTxnCompletionOnce(): Unit = {", "originalCommit": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIxODMyNg==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434218326", "bodyText": "It does. I was trying to setup this test to fit how we're likely hitting this in practice. In the call to addTxnMarkersToSend, before calling maybeWriteTxnCompletion, we have to acquire the lock. It is possible that the caller fails to acquire the lock before the markers finish getting written and the transaction gets completed in the request completion handler.", "author": "hachikuji", "createdAt": "2020-06-02T22:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1ODk1Mg==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434258952", "bodyText": "Got it, so when the bug still exist this test would probably not fail consistently, but would be flaky, right?", "author": "guozhangwang", "createdAt": "2020-06-03T01:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwNjU1Ng==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434306556", "bodyText": "It fails deterministically without the fix.", "author": "hachikuji", "createdAt": "2020-06-03T04:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzI5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY4ODM2Ng==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434688366", "bodyText": "Ah yes, I missed the txnMetadata2.lock.lock() before starting the scheduler, thanks.", "author": "guozhangwang", "createdAt": "2020-06-03T16:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MzUxNw==", "url": "https://github.com/apache/kafka/pull/8782#discussion_r434173517", "bodyText": "Nice catch. Not sure why they did not fail before :)", "author": "guozhangwang", "createdAt": "2020-06-02T21:02:03Z", "path": "core/src/test/scala/unit/kafka/coordinator/transaction/TransactionMarkerChannelManagerTest.scala", "diffHunk": "@@ -291,7 +358,7 @@ class TransactionMarkerChannelManagerTest {\n \n     val response = new WriteTxnMarkersResponse(createPidErrorMap(Errors.NONE))\n     for (requestAndHandler <- requestAndHandlers) {\n-      requestAndHandler.handler.onComplete(new ClientResponse(new RequestHeader(ApiKeys.PRODUCE, 0, \"client\", 1),\n+      requestAndHandler.handler.onComplete(new ClientResponse(new RequestHeader(ApiKeys.WRITE_TXN_MARKERS, 0, \"client\", 1),", "originalCommit": "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}