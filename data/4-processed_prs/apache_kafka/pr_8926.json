{"pr_number": 8926, "pr_title": "KAFKA-10166: always write checkpoint before closing an (initialized) task", "pr_createdAt": "2020-06-25T01:37:13Z", "pr_url": "https://github.com/apache/kafka/pull/8926", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2MjM2OQ==", "url": "https://github.com/apache/kafka/pull/8926#discussion_r445262369", "bodyText": "This was another \"sort-of bug\": if we hit an exception in handleRevocation we wouldn't finish committing the active tasks, so commitNeeded could still be true. But of course, if we hit an exception earlier, we would have thrown it up to ConsumerCoordinator which would only save the first exception, so this didn't really do anything", "author": "ableegoldman", "createdAt": "2020-06-25T01:43:43Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -242,18 +242,16 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n \n         for (final Task task : tasksToClose) {\n             try {\n-                task.suspend(); // Should be a no-op for active tasks since they're suspended in handleRevocation\n-                if (task.commitNeeded()) {\n-                    if (task.isActive()) {\n-                        log.error(\"Active task {} was revoked and should have already been committed\", task.id());\n-                        throw new IllegalStateException(\"Revoked active task was not committed during handleRevocation\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2Mjc4NA==", "url": "https://github.com/apache/kafka/pull/8926#discussion_r445262784", "bodyText": "We can actually simplify the standby task shutdown a LOT", "author": "ableegoldman", "createdAt": "2020-06-25T01:45:37Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -813,27 +821,6 @@ void shutdown(final boolean clean) {\n                 tasksToCloseDirty.add(task);\n             }\n         }\n-\n-        for (final Task task : tasksToCommit) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNzY1MQ==", "url": "https://github.com/apache/kafka/pull/8926#discussion_r445907651", "bodyText": "Makes sense.", "author": "guozhangwang", "createdAt": "2020-06-26T00:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2Mjc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNzAxOA==", "url": "https://github.com/apache/kafka/pull/8926#discussion_r445907018", "bodyText": "If we are not committing these tasks, should we call their postCommit?", "author": "guozhangwang", "createdAt": "2020-06-26T00:24:27Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -469,21 +465,27 @@ void handleRevocation(final Collection<TopicPartition> revokedPartitions) {\n             throw suspendException;\n         }\n \n+        final Map<TaskId, Map<TopicPartition, OffsetAndMetadata>> consumedOffsetsAndMetadataPerTask = new HashMap<>();\n+        prepareCommitAndAddOffsetsToMap(revokedTasks, consumedOffsetsAndMetadataPerTask);\n+\n         // If using eos-beta, if we must commit any task then we must commit all of them\n         // TODO: when KAFKA-9450 is done this will be less expensive, and we can simplify by always committing everything\n-        if (processingMode ==  EXACTLY_ONCE_BETA && !tasksToCommit.isEmpty()) {\n-            tasksToCommit.addAll(additionalTasksForCommitting);\n-        }\n-\n-        final Map<TaskId, Map<TopicPartition, OffsetAndMetadata>> consumedOffsetsAndMetadataPerTask = new HashMap<>();\n-        for (final Task task : tasksToCommit) {\n-            final Map<TopicPartition, OffsetAndMetadata> committableOffsets = task.prepareCommit();\n-            consumedOffsetsAndMetadataPerTask.put(task.id(), committableOffsets);\n+        if (processingMode ==  EXACTLY_ONCE_BETA && !consumedOffsetsAndMetadataPerTask.isEmpty()) {\n+            prepareCommitAndAddOffsetsToMap(additionalTasksForCommitting, consumedOffsetsAndMetadataPerTask);\n         }\n \n         commitOffsetsOrTransaction(consumedOffsetsAndMetadataPerTask);\n \n-        for (final Task task : tasksToCommit) {\n+        for (final Task task : revokedTasks) {\n+            try {\n+                task.postCommit();\n+            } catch (final RuntimeException e) {\n+                log.error(\"Exception caught while post-committing task \" + task.id(), e);\n+                firstException.compareAndSet(null, e);\n+            }\n+        }\n+\n+        for (final Task task : additionalTasksForCommitting) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8112341e1162b8e4d03afa74c5355a152c0d5d4", "url": "https://github.com/apache/kafka/commit/b8112341e1162b8e4d03afa74c5355a152c0d5d4", "message": "always invoke postCommit", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "251214a0703e0788206c2a8d39f3a7fdd318d4af", "url": "https://github.com/apache/kafka/commit/251214a0703e0788206c2a8d39f3a7fdd318d4af", "message": "always call prepareCommit as well", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "3032052f911b0e3ded98750a206ea77345768c60", "url": "https://github.com/apache/kafka/commit/3032052f911b0e3ded98750a206ea77345768c60", "message": "fix standby shutdown", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "f3c6afd6e636b45c7b6a6b43d93f301cb69f55aa", "url": "https://github.com/apache/kafka/commit/f3c6afd6e636b45c7b6a6b43d93f301cb69f55aa", "message": "dont throw if prepare/postCommitting CREATED", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "13b0ee1df558dea7ec18f9d181ec36ddd456aa95", "url": "https://github.com/apache/kafka/commit/13b0ee1df558dea7ec18f9d181ec36ddd456aa95", "message": "add checkpointNeeded flag", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "7d3a7718e700be4f43f9a3220ff783bc1bc1bb2c", "url": "https://github.com/apache/kafka/commit/7d3a7718e700be4f43f9a3220ff783bc1bc1bb2c", "message": "cleaning up StreamTask tests", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "a24df9d7b3e9638ba35896d044c8959cf21e9f62", "url": "https://github.com/apache/kafka/commit/a24df9d7b3e9638ba35896d044c8959cf21e9f62", "message": "fixing up standby task tests", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "f6715667258e077163d9368c49c07220076b8ccc", "url": "https://github.com/apache/kafka/commit/f6715667258e077163d9368c49c07220076b8ccc", "message": "cleaning up TM tests", "committedDate": "2020-06-26T16:56:10Z", "type": "commit"}, {"oid": "4125b363105af8402294e40e2872a91fd5e3ab31", "url": "https://github.com/apache/kafka/commit/4125b363105af8402294e40e2872a91fd5e3ab31", "message": "fix TTD", "committedDate": "2020-06-26T16:58:30Z", "type": "commit"}, {"oid": "4125b363105af8402294e40e2872a91fd5e3ab31", "url": "https://github.com/apache/kafka/commit/4125b363105af8402294e40e2872a91fd5e3ab31", "message": "fix TTD", "committedDate": "2020-06-26T16:58:30Z", "type": "forcePushed"}]}