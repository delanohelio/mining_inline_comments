{"pr_number": 8232, "pr_title": "KAFKA-9658: Fix removing user quotas", "pr_createdAt": "2020-03-05T18:15:01Z", "pr_url": "https://github.com/apache/kafka/pull/8232", "timeline": [{"oid": "2bda23287e50c3c3b4745234866eb0aaab1ae51b", "url": "https://github.com/apache/kafka/commit/2bda23287e50c3c3b4745234866eb0aaab1ae51b", "message": "KAFKA-9658: Fix removing user quotas", "committedDate": "2020-03-05T07:48:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNjc3OA==", "url": "https://github.com/apache/kafka/pull/8232#discussion_r388506778", "bodyText": "With this change, it seems like we don't need to let this function return null anymore. In all the branches, the final result will be ClientQuotaManagerConfig.UnlimitedQuota or staticConfigClientIdQuota if we could not find another quota. That would let us simplify some of the usages.", "author": "hachikuji", "createdAt": "2020-03-05T19:16:55Z", "path": "core/src/main/scala/kafka/server/ClientQuotaManager.scala", "diffHunk": "@@ -562,13 +562,17 @@ class ClientQuotaManager(private val config: ClientQuotaManagerConfig,\n             // /config/users/<default>/clients/<default>\n             quota = overriddenQuotas.get(DefaultUserClientIdQuotaEntity)\n           }\n+          if (quota == null)\n+            quota = ClientQuotaManagerConfig.UnlimitedQuota", "originalCommit": "2bda23287e50c3c3b4745234866eb0aaab1ae51b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyMDgzNg==", "url": "https://github.com/apache/kafka/pull/8232#discussion_r388520836", "bodyText": "There is also a case where metricTags has no user or client-id keys. Based on the description of quotaLimit method in ClientQuotaCallback, null is a valid return value if no metrics tags in use. @rajinisivaram Do you know what exactly \"if the metric tags are no longer in use\" means in the description. Does it cover the case where metricTags is empty for example or does not have expected tags? My understanding is that it does.\n     * @return the quota limit for the provided metric tags or null if the metric tags are no longer in use\n     */\n    Double quotaLimit(ClientQuotaType quotaType, Map<String, String> metricTags);", "author": "apovzner", "createdAt": "2020-03-05T19:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNjc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU3MzE5MA==", "url": "https://github.com/apache/kafka/pull/8232#discussion_r388573190", "bodyText": "I see. So we cannot avoid checking the return type for null. I guess at least we can clean up this function though.", "author": "hachikuji", "createdAt": "2020-03-05T21:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNjc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYyMDE1OQ==", "url": "https://github.com/apache/kafka/pull/8232#discussion_r388620159", "bodyText": "That's true. I updated the PR such that we assign quota to unlimited quota in that function once (instead of twice, as I initially had).", "author": "apovzner", "createdAt": "2020-03-05T23:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNjc3OA=="}], "type": "inlineReview"}, {"oid": "d80de11e94f26d37c19617a39993d67f75e82bb7", "url": "https://github.com/apache/kafka/commit/d80de11e94f26d37c19617a39993d67f75e82bb7", "message": "do not duplicate unlimited quota assignment", "committedDate": "2020-03-05T22:50:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3MDgzMQ==", "url": "https://github.com/apache/kafka/pull/8232#discussion_r388870831", "bodyText": "Rather than change the default callback, I think it may be better to change the caller updateQuotaMetricConfigs to handle null case better. At the moment, updateQuotaMetricConfigs updates metrics only if quotaCallback.quotaLimit is non-null. This works in most cases because null indicates that those tags are no longer in use and hence we don't need to update them - those metrics will eventually expire.\nThe problem is once we enable any quotas, we always use quota metrics and the tags depend on what quotas were enabled. To be safe, we should update existing metrics regardless of whether the callback returns null. This PR addresses the issue for the default callback. But since this is a valid case for any callback implementation, using ClientQuotaCallback.quotaLimit(that returns a non-null value ) instead of quotaCallback.quotaLimit in updateQuotaMetricConfigs would ensure that we always update existing metrics with any callback.", "author": "rajinisivaram", "createdAt": "2020-03-06T12:16:10Z", "path": "core/src/main/scala/kafka/server/ClientQuotaManager.scala", "diffHunk": "@@ -579,6 +579,8 @@ class ClientQuotaManager(private val config: ClientQuotaManagerConfig,\n           if (quota == null)\n             quota = staticConfigClientIdQuota\n         }\n+        if (quota == null)\n+          quota = ClientQuotaManagerConfig.UnlimitedQuota", "originalCommit": "d80de11e94f26d37c19617a39993d67f75e82bb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA4ODQ3Mw==", "url": "https://github.com/apache/kafka/pull/8232#discussion_r389088473", "bodyText": "This makes sense. Thanks Rajini, will update my PR.", "author": "apovzner", "createdAt": "2020-03-06T19:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3MDgzMQ=="}], "type": "inlineReview"}, {"oid": "4207ea8d2c2378d40e94ca1f302cef7dc6abdf3a", "url": "https://github.com/apache/kafka/commit/4207ea8d2c2378d40e94ca1f302cef7dc6abdf3a", "message": "update quotas in Metrics even when quotaCallback.quotaLimit returns null", "committedDate": "2020-03-06T19:18:40Z", "type": "commit"}]}