{"pr_number": 8403, "pr_title": "KAFKA-9797; Fix TestSecurityRollingUpgrade.test_enable_separate_interbroker_listener", "pr_createdAt": "2020-04-01T11:08:24Z", "pr_url": "https://github.com/apache/kafka/pull/8403", "timeline": [{"oid": "4f223d787543ceaab3f88ebf3b54ff2f9c86c6ef", "url": "https://github.com/apache/kafka/commit/4f223d787543ceaab3f88ebf3b54ff2f9c86c6ef", "message": "KAFKA-9797; Fix TestSecurityRollingUpgrade.test_enable_separate_interbroker_listener", "committedDate": "2020-04-01T10:57:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxMjE3MA==", "url": "https://github.com/apache/kafka/pull/8403#discussion_r401612170", "bodyText": "Can you elaborate why we added the two lines above?", "author": "ijuma", "createdAt": "2020-04-01T13:25:06Z", "path": "tests/kafkatest/tests/core/security_rolling_upgrade_test.py", "diffHunk": "@@ -96,10 +96,15 @@ def roll_in_sasl_mechanism(self, security_protocol, new_sasl_mechanism):\n         self.set_authorizer_and_bounce(security_protocol, security_protocol, KafkaService.SIMPLE_AUTHORIZER)\n \n     def add_separate_broker_listener(self, broker_security_protocol, broker_sasl_mechanism):\n+        # Enable the new internal listener on all brokers first\n+        self.kafka.open_port(self.kafka.INTERBROKER_LISTENER_NAME)\n+        self.kafka.port_mappings[self.kafka.INTERBROKER_LISTENER_NAME].security_protocol = broker_security_protocol\n+        self.kafka.client_sasl_mechanism = broker_sasl_mechanism", "originalCommit": "4f223d787543ceaab3f88ebf3b54ff2f9c86c6ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY4MjY4NA==", "url": "https://github.com/apache/kafka/pull/8403#discussion_r401682684", "bodyText": "The Kafka service used for system test starts up a client listener and an inter-broker listener and doesn't properly support other listeners. The security protocol and SASL mechanism used for the listeners is derived from the security protocol and the mechanism specified for client/inter-broker. The two lines above work around that limitation by overriding the security protocol and SASL mechanism to allow broker to start up a listener before using it as the inter-broker listener. It would be a much larger change to add proper support for additional listeners to the Kafka service, so I just updated this test which fails very frequently at the moment.", "author": "rajinisivaram", "createdAt": "2020-04-01T14:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxMjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyMjA4Nw==", "url": "https://github.com/apache/kafka/pull/8403#discussion_r401722087", "bodyText": "Thanks for the explanation. Makes sense. What is the reason why the test started failing frequently?", "author": "ijuma", "createdAt": "2020-04-01T15:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxMjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc3MzQ1Mg==", "url": "https://github.com/apache/kafka/pull/8403#discussion_r401773452", "bodyText": "Test seems to have been failing since Jan 15th. Not sure if it was more stable before that. Consumer was timing out in the logs I looked at. Will investigate more to see if there is any other issue causing the failures now.", "author": "rajinisivaram", "createdAt": "2020-04-01T17:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxMjE3MA=="}], "type": "inlineReview"}]}