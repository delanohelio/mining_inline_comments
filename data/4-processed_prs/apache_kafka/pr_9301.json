{"pr_number": 9301, "pr_title": "KAFKA-10482: Fix flaky testDynamicListenerConnectionCreationRateQuota", "pr_createdAt": "2020-09-18T02:18:31Z", "pr_url": "https://github.com/apache/kafka/pull/9301", "timeline": [{"oid": "d8686839aee9afa42847241f7f815454250fc3ae", "url": "https://github.com/apache/kafka/commit/d8686839aee9afa42847241f7f815454250fc3ae", "message": "KAFKA-10482: fix initialConnectionCount variable race condition issue", "committedDate": "2020-09-18T02:12:34Z", "type": "commit"}, {"oid": "0b7a0b3e3d4df26812fa554e8ec7344a72453505", "url": "https://github.com/apache/kafka/commit/0b7a0b3e3d4df26812fa554e8ec7344a72453505", "message": "KAFKA-10482: address reviewer's comments to extract the waitConnectionClose method out", "committedDate": "2020-09-18T11:46:05Z", "type": "commit"}, {"oid": "0b7a0b3e3d4df26812fa554e8ec7344a72453505", "url": "https://github.com/apache/kafka/commit/0b7a0b3e3d4df26812fa554e8ec7344a72453505", "message": "KAFKA-10482: address reviewer's comments to extract the waitConnectionClose method out", "committedDate": "2020-09-18T11:46:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNjgyNg==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r490906826", "bodyText": "Shouldn't we put this after waiting for the futures (next line)?", "author": "dajac", "createdAt": "2020-09-18T12:12:47Z", "path": "core/src/test/scala/integration/kafka/network/DynamicConnectionQuotaTest.scala", "diffHunk": "@@ -202,6 +208,7 @@ class DynamicConnectionQuotaTest extends BaseRequestTest {\n     val futures = newListenerNames.map { listener =>\n       executor.submit((() => verifyConnectionRate(3, listenerConnRateLimit, listener)): Runnable)\n     }\n+    waitForConnectionCloseToInitState(initialConnectionCount)", "originalCommit": "0b7a0b3e3d4df26812fa554e8ec7344a72453505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkzOTM4Nw==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r490939387", "bodyText": "Oh, man, thanks for reminding! Fixed. Thanks.", "author": "showuon", "createdAt": "2020-09-18T13:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNjgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNjkxMQ==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r490906911", "bodyText": "Same comment as above.", "author": "dajac", "createdAt": "2020-09-18T12:12:58Z", "path": "core/src/test/scala/integration/kafka/network/DynamicConnectionQuotaTest.scala", "diffHunk": "@@ -215,6 +222,7 @@ class DynamicConnectionQuotaTest extends BaseRequestTest {\n       verifyConnectionRate(18, newPlaintextRateLimit, \"PLAINTEXT\")): Runnable)\n     val externalFuture = executor.submit((() =>\n       verifyConnectionRate(5, listenerConnRateLimit, \"EXTERNAL\")): Runnable)\n+    waitForConnectionCloseToInitState(initialConnectionCount)", "originalCommit": "0b7a0b3e3d4df26812fa554e8ec7344a72453505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkzOTQ2OA==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r490939468", "bodyText": "Fixed. Thanks.", "author": "showuon", "createdAt": "2020-09-18T13:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNjkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNzM5NA==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r490907394", "bodyText": "How about calling this waitForConnectionCount and renaming initialConnectionCount to expectedConnectionCount? That makes the helper more generic.", "author": "dajac", "createdAt": "2020-09-18T12:14:04Z", "path": "core/src/test/scala/integration/kafka/network/DynamicConnectionQuotaTest.scala", "diffHunk": "@@ -317,6 +325,12 @@ class DynamicConnectionQuotaTest extends BaseRequestTest {\n     }\n   }\n \n+  private def waitForConnectionCloseToInitState(initialConnectionCount: Int): Unit = {", "originalCommit": "0b7a0b3e3d4df26812fa554e8ec7344a72453505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkzOTE4MQ==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r490939181", "bodyText": "I'm good. I don't have any preference. Updated. Thanks.", "author": "showuon", "createdAt": "2020-09-18T13:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNzM5NA=="}], "type": "inlineReview"}, {"oid": "22d240571de45b3ea3573c3428a6c17efe862092", "url": "https://github.com/apache/kafka/commit/22d240571de45b3ea3573c3428a6c17efe862092", "message": "KAFKA-10482: address reviewer's comment to refactor the codes", "committedDate": "2020-09-18T13:11:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU0MDE1MA==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r492540150", "bodyText": "This comment is irrelevant now. I would just say that this is the expected connection count after each run.", "author": "dajac", "createdAt": "2020-09-22T07:56:02Z", "path": "core/src/test/scala/integration/kafka/network/DynamicConnectionQuotaTest.scala", "diffHunk": "@@ -179,17 +179,23 @@ class DynamicConnectionQuotaTest extends BaseRequestTest {\n     reconfigureServers(props, perBrokerConfig = true, (KafkaConfig.ListenersProp, newListeners))\n     waitForListener(\"EXTERNAL\")\n \n+    // we need to set the initialConnectionCount earlier and pass to verifyConnectionRate method\n+    // so that the race condition won't occur for the following multi-thread test cases", "originalCommit": "22d240571de45b3ea3573c3428a6c17efe862092", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU0MTM3OA==", "url": "https://github.com/apache/kafka/pull/9301#discussion_r492541378", "bodyText": "nit: I would remove this comment. I think that the method is self-explanatory now.", "author": "dajac", "createdAt": "2020-09-22T07:58:05Z", "path": "core/src/test/scala/integration/kafka/network/DynamicConnectionQuotaTest.scala", "diffHunk": "@@ -317,6 +325,12 @@ class DynamicConnectionQuotaTest extends BaseRequestTest {\n     }\n   }\n \n+  // make sure the connection count state is the same as the expectedConnectionCount", "originalCommit": "22d240571de45b3ea3573c3428a6c17efe862092", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8e2714c6b4d0b73c36893c365998380cfaf724f6", "url": "https://github.com/apache/kafka/commit/8e2714c6b4d0b73c36893c365998380cfaf724f6", "message": "KAFKA-10482: address reviewer's comment to rephrase the comments", "committedDate": "2020-09-22T08:18:51Z", "type": "commit"}]}