{"pr_number": 9601, "pr_title": " KAFKA-10729: Bump remaining RPC's to use tagged fields.", "pr_createdAt": "2020-11-16T19:52:21Z", "pr_url": "https://github.com/apache/kafka/pull/9601", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzNjQ2Mg==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r524636462", "bodyText": "2.7 has been branched. It should be 2.8, right?", "author": "ijuma", "createdAt": "2020-11-16T21:53:37Z", "path": "core/src/main/scala/kafka/api/ApiVersion.scala", "diffHunk": "@@ -424,6 +426,13 @@ case object KAFKA_2_7_IV2 extends DefaultApiVersion {\n   val id: Int = 30\n }\n \n+case object KAFKA_2_7_IV3 extends DefaultApiVersion {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgyMDM4OA==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r524820388", "bodyText": "Thanks, that makes more sense.", "author": "gardnervickers", "createdAt": "2020-11-17T01:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzNjQ2Mg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "fb11509b1843999a53cfe653b6d80200315bdaf9", "url": "https://github.com/apache/kafka/commit/fb11509b1843999a53cfe653b6d80200315bdaf9", "message": "KAFKA-10729: Bump remaining RPC's to use tagged fields.\n\nAs a follow-up from KIP-482, this PR bumps the version for several\nRPC's to enable tagged fields via the flexible versioning mechanism.\n\nAdditionally, a new IBP version `KAFKA_2_7_IV3` is introduced to\nallow replication to take advantage of these new RPC versions for\nOffsetForLeaderEpoch and ListOffset.", "committedDate": "2020-11-17T01:08:53Z", "type": "commit"}, {"oid": "fb11509b1843999a53cfe653b6d80200315bdaf9", "url": "https://github.com/apache/kafka/commit/fb11509b1843999a53cfe653b6d80200315bdaf9", "message": "KAFKA-10729: Bump remaining RPC's to use tagged fields.\n\nAs a follow-up from KIP-482, this PR bumps the version for several\nRPC's to enable tagged fields via the flexible versioning mechanism.\n\nAdditionally, a new IBP version `KAFKA_2_7_IV3` is introduced to\nallow replication to take advantage of these new RPC versions for\nOffsetForLeaderEpoch and ListOffset.", "committedDate": "2020-11-17T01:08:53Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "b836a3d80d0156769a43f0d43d08b9564d0febf5", "url": "https://github.com/apache/kafka/commit/b836a3d80d0156769a43f0d43d08b9564d0febf5", "message": "Revert using flexibleVersions for non-generated RPC's\n\nOffsetForLeaderEpoch and Produce are not yet generated RPCs, but will be once #9401 and #9547 are merged.", "committedDate": "2020-11-18T18:59:22Z", "type": "commit"}, {"oid": "b836a3d80d0156769a43f0d43d08b9564d0febf5", "url": "https://github.com/apache/kafka/commit/b836a3d80d0156769a43f0d43d08b9564d0febf5", "message": "Revert using flexibleVersions for non-generated RPC's\n\nOffsetForLeaderEpoch and Produce are not yet generated RPCs, but will be once #9401 and #9547 are merged.", "committedDate": "2020-11-18T18:59:22Z", "type": "forcePushed"}, {"oid": "27c5b779148132bfb1896e6ce8f2dfeb02f20884", "url": "https://github.com/apache/kafka/commit/27c5b779148132bfb1896e6ce8f2dfeb02f20884", "message": "Merge branch 'trunk' of github.com:apache/kafka into list-offset-flex-versions", "committedDate": "2020-11-19T13:39:50Z", "type": "commit"}, {"oid": "38f27474b831bc3bfb0c8b35ec13ba7aea05551f", "url": "https://github.com/apache/kafka/commit/38f27474b831bc3bfb0c8b35ec13ba7aea05551f", "message": "Revert \"Revert using flexibleVersions for non-generated RPC's\"\n\nThis reverts commit b836a3d80d0156769a43f0d43d08b9564d0febf5.", "committedDate": "2020-11-19T14:35:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA0NTY4OQ==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r527045689", "bodyText": "For what it's worth, WriteTxnMarkers and OffsetsForLeaderEpoch are also inter-broker APIs.", "author": "hachikuji", "createdAt": "2020-11-19T16:57:47Z", "path": "core/src/main/scala/kafka/api/ApiVersion.scala", "diffHunk": "@@ -108,7 +108,9 @@ object ApiVersion {\n     // Bup Fetch protocol for Raft protocol (KIP-595)\n     KAFKA_2_7_IV1,\n     // Introduced AlterIsr (KIP-497)\n-    KAFKA_2_7_IV2\n+    KAFKA_2_7_IV2,\n+    // Flexible versioning on ListOffsets", "originalCommit": "38f27474b831bc3bfb0c8b35ec13ba7aea05551f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0dfa059abdb853f9770db6ceceee77fd64d15a48", "url": "https://github.com/apache/kafka/commit/0dfa059abdb853f9770db6ceceee77fd64d15a48", "message": "- Use KAFKA_2_8_IV0 for ListOffsets, WriteTxnMarkers and OffsetsForLeaderEpoch.\n\n- Allow using RecordBatch v2 for ProduceRequestV9.", "committedDate": "2020-11-20T19:06:50Z", "type": "commit"}, {"oid": "ccc6345b0326b3e72e11978b9e930bfc6d10f61e", "url": "https://github.com/apache/kafka/commit/ccc6345b0326b3e72e11978b9e930bfc6d10f61e", "message": "Fix the EdgeCaseRequestTest to take into account flexible versions.", "committedDate": "2020-11-20T21:14:51Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI0OTMxMQ==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r532249311", "bodyText": "This is to fix testThrottlingNotEnabledForConnectionToOlderBroker. The test forces ApiVersionsResponse to version 5, but relied on the fact that nothing really changed between version 5 and version 8 for PRODUCE responses. With flex versions we need to ensure the response matches the ApiVersions response", "author": "gardnervickers", "createdAt": "2020-11-29T18:45:02Z", "path": "clients/src/test/java/org/apache/kafka/clients/NetworkClientTest.java", "diffHunk": "@@ -613,12 +613,12 @@ private void sendResponse(ResponseHeader respHeader, Struct response) {\n         selector.completeReceive(new NetworkReceive(node.idString(), buffer));\n     }\n \n-    private void sendThrottledProduceResponse(int correlationId, int throttleMs) {\n+    private void sendThrottledProduceResponse(int correlationId, int throttleMs, short version) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI0OTYwMQ==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r532249601", "bodyText": "Having this override seemed a bit error prone, and was causing failures for the NetworkClientTest. I opted to remove it entirely in favor of forcing the caller to specify the response version.", "author": "gardnervickers", "createdAt": "2020-11-29T18:46:57Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/AlterReplicaLogDirsResponse.java", "diffHunk": "@@ -38,10 +38,6 @@\n \n     private final AlterReplicaLogDirsResponseData data;\n \n-    public AlterReplicaLogDirsResponse(Struct struct) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI0OTk0Mw==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r532249943", "bodyText": "Admittedly I'm not sure why we check the version of the last OffsetForLeaderEpoch response is 3 here. I decided to widen the check a bit so this won't break for future versions.", "author": "gardnervickers", "createdAt": "2020-11-29T18:50:08Z", "path": "core/src/test/scala/unit/kafka/server/ReplicaFetcherThreadTest.scala", "diffHunk": "@@ -437,8 +437,8 @@ class ReplicaFetcherThreadTest {\n     thread.doWork()\n     assertEquals(2, mockNetwork.epochFetchCount)\n     assertEquals(1, mockNetwork.fetchCount)\n-    assertEquals(\"OffsetsForLeaderEpochRequest version.\",\n-      3, mockNetwork.lastUsedOffsetForLeaderEpochVersion)\n+    assertTrue(\"OffsetsForLeaderEpochRequest version.\",\n+      mockNetwork.lastUsedOffsetForLeaderEpochVersion >= 3)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcxOTcwOA==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r533719708", "bodyText": "I think this was originally using 1 in order to ensure that we were using a version which included the epoch in the response. Since then it looks like it has been updated blindly every time we've bumped the protocol. I'm ok leaving this as is, but we could probably also get rid of it.", "author": "hachikuji", "createdAt": "2020-12-01T21:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI0OTk0Mw=="}], "type": "inlineReview"}, {"oid": "7a7d5fd5c6f26edbbacecdf5074245a6d7489e30", "url": "https://github.com/apache/kafka/commit/7a7d5fd5c6f26edbbacecdf5074245a6d7489e30", "message": "Fix tests and AlterReplicasLogDirsResponse.\n\n- NetworkClientTest.testThrottlingNotEnabledForConnectionToOlderBroker was relying on the\n  latest PRODUCE version being unchanged from version 5. Fix this by supplying the version\n  when constructing the throttled produce response.\n- Fixed AlterReplicaLogDirsResponse to take the version in the constructor instead of offering\n  an override which assumes that the most recent version is in use. This fixes the NetworkClientTest.\n- Fixed ReplicaFetcherThreadTest.shouldFetchLeaderEpochSecondTimeIfLeaderRepliesWithEpochNotKnownToFollower\n  to check that the lastUsedOffsetForLeaderEpochVersion is >= 3 instead of == 3. It seems this check is mostly\n  in place to ensure that a OffsetForLeaderEpoch response was sent.", "committedDate": "2020-11-29T21:27:17Z", "type": "commit"}, {"oid": "7a7d5fd5c6f26edbbacecdf5074245a6d7489e30", "url": "https://github.com/apache/kafka/commit/7a7d5fd5c6f26edbbacecdf5074245a6d7489e30", "message": "Fix tests and AlterReplicasLogDirsResponse.\n\n- NetworkClientTest.testThrottlingNotEnabledForConnectionToOlderBroker was relying on the\n  latest PRODUCE version being unchanged from version 5. Fix this by supplying the version\n  when constructing the throttled produce response.\n- Fixed AlterReplicaLogDirsResponse to take the version in the constructor instead of offering\n  an override which assumes that the most recent version is in use. This fixes the NetworkClientTest.\n- Fixed ReplicaFetcherThreadTest.shouldFetchLeaderEpochSecondTimeIfLeaderRepliesWithEpochNotKnownToFollower\n  to check that the lastUsedOffsetForLeaderEpochVersion is >= 3 instead of == 3. It seems this check is mostly\n  in place to ensure that a OffsetForLeaderEpoch response was sent.", "committedDate": "2020-11-29T21:27:17Z", "type": "forcePushed"}, {"oid": "6f0ed0421c676368e0238152a58ea2a29ca4fd76", "url": "https://github.com/apache/kafka/commit/6f0ed0421c676368e0238152a58ea2a29ca4fd76", "message": "Merge branch 'trunk' of github.com:apache/kafka into list-offset-flex-versions", "committedDate": "2020-11-30T21:40:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzMjY0Ng==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r533032646", "bodyText": "I wonder if we may as well make this the default case. Not sure we're getting much by forcing ourselves to update this logic after each bump. Maybe the range validation is still useful, but that could be done by using oldestVersion and latestVersion.", "author": "hachikuji", "createdAt": "2020-12-01T02:30:34Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/ProduceRequest.java", "diffHunk": "@@ -286,6 +286,7 @@ public static byte requiredMagicForVersion(short produceRequestVersion) {\n             case 6:\n             case 7:\n             case 8:\n+            case 9:", "originalCommit": "6f0ed0421c676368e0238152a58ea2a29ca4fd76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzMzkyNw==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r533033927", "bodyText": "I think this is probably ok, but it is a little inconsistent with how we handle the versions for other inter-broker RPCs. Since we rely on the IBP, we always set the version explicitly in the caller, which means there is exactly one allowable version for the builder to use. See for example LeaderAndIsrRequest.Builder.", "author": "hachikuji", "createdAt": "2020-12-01T02:35:04Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/WriteTxnMarkersRequest.java", "diffHunk": "@@ -105,8 +105,8 @@ public int hashCode() {\n \n         public final WriteTxnMarkersRequestData data;\n \n-        public Builder(final List<TxnMarkerEntry> markers) {\n-            super(ApiKeys.WRITE_TXN_MARKERS);\n+        public Builder(final List<TxnMarkerEntry> markers, short latestAllowedVersion) {\n+            super(ApiKeys.WRITE_TXN_MARKERS, ApiKeys.WRITE_TXN_MARKERS.oldestVersion(), latestAllowedVersion);", "originalCommit": "6f0ed0421c676368e0238152a58ea2a29ca4fd76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzNDU1Mg==", "url": "https://github.com/apache/kafka/pull/9601#discussion_r533034552", "bodyText": "nit: maybe add a comment that this field is for the number of tagged fields?", "author": "hachikuji", "createdAt": "2020-12-01T02:37:05Z", "path": "core/src/test/scala/unit/kafka/server/EdgeCaseRequestTest.scala", "diffHunk": "@@ -84,19 +85,24 @@ class EdgeCaseRequestTest extends KafkaServerTestHarness {\n   }\n \n   // Custom header serialization so that protocol assumptions are not forced\n-  private def requestHeaderBytes(apiKey: Short, apiVersion: Short, clientId: String = \"\", correlationId: Int = -1): Array[Byte] = {\n+  def requestHeaderBytes(apiKey: Short, apiVersion: Short, clientId: String = \"\", correlationId: Int = -1): Array[Byte] = {\n+    // Check for flex versions, some tests here verify that an invalid apiKey is detected properly, so if -1 is used,\n+    // assume the request is not using flex versions.\n+    val flexVersion = if (apiKey >= 0) ApiKeys.forId(apiKey).requestHeaderVersion(apiVersion) >= 2 else false\n     val size = {\n       2 /* apiKey */ +\n         2 /* version id */ +\n         4 /* correlation id */ +\n-        Type.NULLABLE_STRING.sizeOf(clientId) /* client id */\n+        Type.NULLABLE_STRING.sizeOf(clientId)  /* client id */ +\n+        (if (flexVersion) ByteUtils.sizeOfUnsignedVarint(0) else 0)", "originalCommit": "6f0ed0421c676368e0238152a58ea2a29ca4fd76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1f539abf2a49efe8e9f6b45da5ca0d2f6d478393", "url": "https://github.com/apache/kafka/commit/1f539abf2a49efe8e9f6b45da5ca0d2f6d478393", "message": "Address PR comments:\n- Make the most recent record batch version the default case when selecting a\n  record batch version. Check that the version is within the existing version bounds.\n- Force a specific version in the WriteTxnMarkersRequest constructor to match other\n  requests which utilize the IBP like LeaderAndISR.", "committedDate": "2020-12-01T17:42:48Z", "type": "commit"}, {"oid": "fb9fbe898ab08315c6e328c215c72da868badab4", "url": "https://github.com/apache/kafka/commit/fb9fbe898ab08315c6e328c215c72da868badab4", "message": "Use LIST_OFFSET.lastestVersion() instead of hardcoding the latest version in\nthe RequestResponseTest", "committedDate": "2020-12-01T20:27:21Z", "type": "commit"}]}