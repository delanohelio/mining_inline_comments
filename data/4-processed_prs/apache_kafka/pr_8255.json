{"pr_number": 8255, "pr_title": "KAFKA-9686 MockConsumer#endOffsets should be idempotent", "pr_createdAt": "2020-03-09T11:36:28Z", "pr_url": "https://github.com/apache/kafka/pull/8255", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTEyMA==", "url": "https://github.com/apache/kafka/pull/8255#discussion_r389865120", "bodyText": "The code seems intentionally written to store a sequence of end offsets so that each call advances the end offset. If we do not need that capability, then perhaps we can change the type of endOffsets and simplify the usage.\ncc @bbejeck Looks like you added this logic. Do you know if we rely on it?", "author": "hachikuji", "createdAt": "2020-03-09T18:00:18Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/MockConsumer.java", "diffHunk": "@@ -520,10 +520,8 @@ private void resetOffsetPosition(TopicPartition tp) {\n     }\n \n     private Long getEndOffset(List<Long> offsets) {\n-        if (offsets == null || offsets.isEmpty()) {\n-            return null;\n-        }\n-        return offsets.size() > 1 ? offsets.remove(0) : offsets.get(0);\n+        if (offsets == null || offsets.isEmpty()) return null;\n+        else return offsets.get(offsets.size() - 1);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3MjI1Ng==", "url": "https://github.com/apache/kafka/pull/8255#discussion_r390072256", "bodyText": "I agree with @hachikuji 's observation. This test broke when #8220 retired the innerUpdateEndOffsets and replaced the two public methods addEndOffsets and updateEndOffsets that were both using innerUpdateEndOffsets with a single updateEndOffsets. However the version that was kept was actually what the unused addEndOffsets was doing (appending to the end offsets) and not what updateEndOffsets described as an overwrite of the value in endOffsets.\nThus, probably the issue should be fixed in updateEndOffsets to keep meaning overwrite. Unless we find a usage for addEndOffsets, in which case we might need some more adjustments too. Of course, if we keep only updateEndOffsets that overwrites the value of the map, we might as well simplify getEndOffset. I haven't tracked when and why addEndOffsets was stopped being used.", "author": "kkonstantine", "createdAt": "2020-03-10T03:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDY4NQ==", "url": "https://github.com/apache/kafka/pull/8255#discussion_r390090685", "bodyText": "@hachikuji @kkonstantine thanks for reviews.\nWill address your comment :)", "author": "chia7712", "createdAt": "2020-03-10T04:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTEyMA=="}], "type": "inlineReview"}, {"oid": "e74b24c59623255a8fa8cd566ca421294c046f9d", "url": "https://github.com/apache/kafka/commit/e74b24c59623255a8fa8cd566ca421294c046f9d", "message": "KAFKA-9686 MockConsumer#endOffsets should be idempotent", "committedDate": "2020-03-10T05:16:32Z", "type": "commit"}, {"oid": "e74b24c59623255a8fa8cd566ca421294c046f9d", "url": "https://github.com/apache/kafka/commit/e74b24c59623255a8fa8cd566ca421294c046f9d", "message": "KAFKA-9686 MockConsumer#endOffsets should be idempotent", "committedDate": "2020-03-10T05:16:32Z", "type": "forcePushed"}]}