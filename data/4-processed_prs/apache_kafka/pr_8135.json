{"pr_number": 8135, "pr_title": "KAFKA-9570: Define SSL configs in all worker config classes, not just distributed", "pr_createdAt": "2020-02-18T21:30:21Z", "pr_url": "https://github.com/apache/kafka/pull/8135", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODQ0OA==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r381008448", "bodyText": "Is SASL support significantly different and only needed in distributed mode?", "author": "ncliang", "createdAt": "2020-02-19T00:07:02Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedConfig.java", "diffHunk": "@@ -257,7 +257,6 @@\n                     CommonClientConfigs.DEFAULT_SECURITY_PROTOCOL,\n                     ConfigDef.Importance.MEDIUM,\n                     CommonClientConfigs.SECURITY_PROTOCOL_DOC)\n-            .withClientSslSupport()\n             .withClientSaslSupport()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAyMzk3OQ==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r381023979", "bodyText": "Good question. SASL support is different in that it's only useful for connecting to Kafka, as opposed to SSL, which can also be used for performing authentication at the REST API level. But both types of worker should support all SASL-related configs since they both do connect to Kafka.\nHowever, as far as I can tell, the lack of definition for SASL-related configs in the StandaloneConfig class isn't causing any bugs at the moment, so in order to be conservative with the changes here I opted to just move the SSL-related configs into the parent config class.\nI think there's a lot of configs that are defined in the DistributedConfig class that would make more sense in the WorkerConfig class, and possibly some configs in the WorkerConfig class that are really only relevant for distributed mode (rest.advertised.* seems strange, given that standalone workers don't have any other workers to advertise their URLs to...). We can address all of that here if there are other issues caused by them, but if it's more of a stylistic thing and it's alright with you, I think a follow-up ticket for cleaning up where we define these configs might be a better way to handle the non-urgent work and get in this somewhat-more-urgent fix now. WDYT?", "author": "C0urante", "createdAt": "2020-02-19T01:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5ODY3Mg==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r381098672", "bodyText": "I think that makes sense.", "author": "ncliang", "createdAt": "2020-02-19T06:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5OTQzOQ==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r384099439", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            put(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG, \"/tmp/foad\");\n          \n          \n            \n                            put(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG, \"/tmp/foo\");", "author": "rhauch", "createdAt": "2020-02-25T20:10:39Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/standalone/StandaloneConfigTest.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.connect.runtime.standalone;\n+\n+import org.apache.kafka.common.config.SslConfigs;\n+import org.apache.kafka.common.config.types.Password;\n+import org.apache.kafka.connect.runtime.WorkerConfig;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class StandaloneConfigTest {\n+\n+    private static final String HTTPS_LISTENER_PREFIX = \"listeners.https.\";\n+\n+    @Test\n+    public void testRestServerPrefixedSslConfigs() {\n+        Map<String, String> httpsListenerProps = new HashMap<String, String>() {\n+            {\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEY_PASSWORD_CONFIG, \"ssl_key_password\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG, \"ssl_keystore\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG, \"ssk_keystore_password\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG, \"ssl_truststore\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG, \"ssl_truststore_password\");\n+            }\n+        };\n+\n+        Set<String> passwordConfigs = Stream.of(\n+            SslConfigs.SSL_KEY_PASSWORD_CONFIG,\n+            SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG,\n+            SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG\n+        ).map(key -> HTTPS_LISTENER_PREFIX + key)\n+            .collect(Collectors.toSet());\n+\n+        Map<String, Object> expectedListenerProps = httpsListenerProps.entrySet().stream()\n+            .collect(Collectors.toMap(\n+                entry -> entry.getKey().substring(HTTPS_LISTENER_PREFIX.length()),\n+                entry -> passwordConfigs.contains(entry.getKey())\n+                        ? new Password(entry.getValue())\n+                        : entry.getValue()\n+            ));\n+\n+        Map<String, String> props = new HashMap<String, String>() {\n+            {\n+                // Base props required for standalone mode\n+                put(WorkerConfig.KEY_CONVERTER_CLASS_CONFIG, \"org.apache.kafka.connect.json.JsonConverter\");\n+                put(WorkerConfig.VALUE_CONVERTER_CLASS_CONFIG, \"org.apache.kafka.connect.json.JsonConverter\");\n+                put(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG, \"/tmp/foad\");", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEwNTEzOQ==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r384105139", "bodyText": "Did you mean for the value to be ssk_...?", "author": "rhauch", "createdAt": "2020-02-25T20:22:10Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/standalone/StandaloneConfigTest.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.connect.runtime.standalone;\n+\n+import org.apache.kafka.common.config.SslConfigs;\n+import org.apache.kafka.common.config.types.Password;\n+import org.apache.kafka.connect.runtime.WorkerConfig;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class StandaloneConfigTest {\n+\n+    private static final String HTTPS_LISTENER_PREFIX = \"listeners.https.\";\n+\n+    @Test\n+    public void testRestServerPrefixedSslConfigs() {\n+        Map<String, String> httpsListenerProps = new HashMap<String, String>() {\n+            {\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEY_PASSWORD_CONFIG, \"ssl_key_password\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG, \"ssl_keystore\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG, \"ssk_keystore_password\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg2MDYwNg==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r387860606", "bodyText": "Oops, nope. Will fix.", "author": "C0urante", "createdAt": "2020-03-04T18:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEwNTEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExNjAzMg==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r384116032", "bodyText": "Wouldn't it be simpler and easier to understand the differences between the tests by pulling out the common objects? The whole class would then be something like:\n    private static final String HTTPS_LISTENER_PREFIX = \"listeners.https.\";\n\n    private static final Map<String, Object> EXPECTED;\n    static {\n        Map<String, Object> settings = new HashMap<>();\n        settings.put(SslConfigs.SSL_KEY_PASSWORD_CONFIG, \"ssl_key_password\");\n        settings.put(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG, \"ssl_keystore\");\n        settings.put(SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG, new Password(\"ssl_keystore_password\"));\n        settings.put(SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG, \"ssl_truststore\");\n        settings.put(SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG, new Password(\"ssl_truststore_password\"));\n        EXPECTED = Collections.unmodifiableMap(settings);\n    }\n\n    private static final Map<String, String> STANDALONE;\n    static {\n        Map<String, String> settings = new HashMap<>();\n        settings.put(WorkerConfig.KEY_CONVERTER_CLASS_CONFIG, \"org.apache.kafka.connect.json.JsonConverter\");\n        settings.put(WorkerConfig.VALUE_CONVERTER_CLASS_CONFIG, \"org.apache.kafka.connect.json.JsonConverter\");\n        settings.put(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG, \"/tmp/foad\");\n        STANDALONE = Collections.unmodifiableMap(settings);\n    }\n\n    private static Map<String, String> withStringValues(Map<String, ?> inputs, String prefix) {\n        return inputs.entrySet().stream()\n                     .collect(Collectors.toMap(\n                              entry -> prefix + entry.getKey(),\n                              entry -> literalValue(entry.getValue())\n                      ));\n    }\n\n    private static String literalValue(Object value) {\n        return value instanceof Password ? ((Password)value).value() : value.toString();\n    }\n\n    @Test\n    public void testRestServerPrefixedSslConfigs() {\n        Map<String, String> props = new HashMap<>(STANDALONE);\n        props.putAll(withStringValues(EXPECTED, HTTPS_LISTENER_PREFIX));\n\n        StandaloneConfig config = new StandaloneConfig(props);\n        assertEquals(EXPECTED, config.valuesWithPrefixAllOrNothing(HTTPS_LISTENER_PREFIX));\n    }\n\n    @Test\n    public void testRestServerNonPrefixedSslConfigs() {\n        Map<String, String> props = new HashMap<>(STANDALONE);\n        props.putAll(withStringValues(EXPECTED, \"\"));\n\n        StandaloneConfig config = new StandaloneConfig(props);\n        Map<String, Object> actualProps = config.valuesWithPrefixAllOrNothing(HTTPS_LISTENER_PREFIX)\n                                                .entrySet().stream()\n                                                .filter(entry -> EXPECTED.containsKey(entry.getKey()))\n                                                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n        assertEquals(EXPECTED, actualProps);\n    }", "author": "rhauch", "createdAt": "2020-02-25T20:45:36Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/standalone/StandaloneConfigTest.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.connect.runtime.standalone;\n+\n+import org.apache.kafka.common.config.SslConfigs;\n+import org.apache.kafka.common.config.types.Password;\n+import org.apache.kafka.connect.runtime.WorkerConfig;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class StandaloneConfigTest {\n+\n+    private static final String HTTPS_LISTENER_PREFIX = \"listeners.https.\";\n+\n+    @Test\n+    public void testRestServerPrefixedSslConfigs() {\n+        Map<String, String> httpsListenerProps = new HashMap<String, String>() {\n+            {\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEY_PASSWORD_CONFIG, \"ssl_key_password\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG, \"ssl_keystore\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG, \"ssk_keystore_password\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG, \"ssl_truststore\");\n+                put(HTTPS_LISTENER_PREFIX + SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG, \"ssl_truststore_password\");\n+            }\n+        };\n+\n+        Set<String> passwordConfigs = Stream.of(\n+            SslConfigs.SSL_KEY_PASSWORD_CONFIG,\n+            SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG,\n+            SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG\n+        ).map(key -> HTTPS_LISTENER_PREFIX + key)\n+            .collect(Collectors.toSet());\n+\n+        Map<String, Object> expectedListenerProps = httpsListenerProps.entrySet().stream()\n+            .collect(Collectors.toMap(\n+                entry -> entry.getKey().substring(HTTPS_LISTENER_PREFIX.length()),\n+                entry -> passwordConfigs.contains(entry.getKey())\n+                        ? new Password(entry.getValue())\n+                        : entry.getValue()\n+            ));\n+\n+        Map<String, String> props = new HashMap<String, String>() {\n+            {\n+                // Base props required for standalone mode\n+                put(WorkerConfig.KEY_CONVERTER_CLASS_CONFIG, \"org.apache.kafka.connect.json.JsonConverter\");\n+                put(WorkerConfig.VALUE_CONVERTER_CLASS_CONFIG, \"org.apache.kafka.connect.json.JsonConverter\");\n+                put(StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG, \"/tmp/foad\");\n+\n+                // Custom props for test\n+                putAll(httpsListenerProps);\n+            }\n+        };", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MDgyNQ==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r387880825", "bodyText": "I like a lot of this and will incorporate it. I'd rather not declare constants like STANDALONE and EXPECTED just because they seem pretty specific to these two tests and may not be applicable to other tests that get added to this class, but pretty much everything else (especially the handling of Password-type configs) is great.", "author": "C0urante", "createdAt": "2020-03-04T19:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExNjAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MzcxMA==", "url": "https://github.com/apache/kafka/pull/8135#discussion_r387883710", "bodyText": "Actually, it looks like the ConfigDef class already has some logic to convert parsed types (including Passwords) into strings: \n  \n    \n      kafka/clients/src/main/java/org/apache/kafka/common/config/ConfigDef.java\n    \n    \n        Lines 761 to 783\n      in\n      f35e649\n    \n    \n    \n    \n\n        \n          \n               /** \n        \n\n        \n          \n                * Converts a map of config (key, value) pairs to a map of strings where each value \n        \n\n        \n          \n                * is converted to a string. This method should be used with care since it stores \n        \n\n        \n          \n                * actual password values to String. Values from this map should never be used in log entries. \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               public static  Map<String, String> convertToStringMapWithPasswordValues(Map<String, ?> configs) { \n        \n\n        \n          \n                   Map<String, String> result = new HashMap<>(); \n        \n\n        \n          \n                   for (Map.Entry<String, ?> entry : configs.entrySet()) { \n        \n\n        \n          \n                       Object value = entry.getValue(); \n        \n\n        \n          \n                       String strValue; \n        \n\n        \n          \n                       if (value instanceof Password) \n        \n\n        \n          \n                           strValue = ((Password) value).value(); \n        \n\n        \n          \n                       else if (value instanceof List) \n        \n\n        \n          \n                           strValue = convertToString(value, Type.LIST); \n        \n\n        \n          \n                       else if (value instanceof Class) \n        \n\n        \n          \n                           strValue = convertToString(value, Type.CLASS); \n        \n\n        \n          \n                       else \n        \n\n        \n          \n                           strValue = convertToString(value, null); \n        \n\n        \n          \n                       if (strValue != null) \n        \n\n        \n          \n                           result.put(entry.getKey(), strValue); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n                   return result; \n        \n\n        \n          \n               } \n        \n    \n  \n\n\nSo we can even just use that and remove the literalValue method", "author": "C0urante", "createdAt": "2020-03-04T19:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExNjAzMg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "937650798ddc65fdef0c1fc3c087ad151e4ce561", "url": "https://github.com/apache/kafka/commit/937650798ddc65fdef0c1fc3c087ad151e4ce561", "message": "KAFKA-9570: Define SSL configs in all worker config classes, not just distributed", "committedDate": "2020-05-25T19:38:38Z", "type": "commit"}, {"oid": "27c978d78f95b40fc324be662ddad6adffe9c435", "url": "https://github.com/apache/kafka/commit/27c978d78f95b40fc324be662ddad6adffe9c435", "message": "KAFKA-9570: Fix test filename\n\nCo-Authored-By: Randall Hauch <rhauch@gmail.com>", "committedDate": "2020-05-25T19:38:38Z", "type": "commit"}, {"oid": "cf679d3622d2ee45441810be1122234a4dd3c008", "url": "https://github.com/apache/kafka/commit/cf679d3622d2ee45441810be1122234a4dd3c008", "message": "KAFKA-9570: Refactor unit test", "committedDate": "2020-05-25T19:38:39Z", "type": "commit"}, {"oid": "cf679d3622d2ee45441810be1122234a4dd3c008", "url": "https://github.com/apache/kafka/commit/cf679d3622d2ee45441810be1122234a4dd3c008", "message": "KAFKA-9570: Refactor unit test", "committedDate": "2020-05-25T19:38:39Z", "type": "forcePushed"}]}