{"pr_number": 8083, "pr_title": "KIP-546 (1/2): Implements describeClientQuotas() and alterClientQuotas().", "pr_createdAt": "2020-02-10T22:26:13Z", "pr_url": "https://github.com/apache/kafka/pull/8083", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2MDAyOA==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390460028", "bodyText": "Can we use Optional<String> for this?  Using magic string values feels messy, and will leak into the API", "author": "cmccabe", "createdAt": "2020-03-10T16:49:12Z", "path": "clients/src/main/java/org/apache/kafka/common/quota/QuotaFilter.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.kafka.common.quota;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Describes a quota entity filter.\n+ */\n+public class QuotaFilter {\n+\n+    // Matches all entities with the entity type specified.\n+    private static final String MATCH_SPECIFIED = \"\";\n+\n+    private final String entityType;\n+    private final String match;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3OTQxMA==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390679410", "bodyText": "Done.", "author": "bdbyrne", "createdAt": "2020-03-11T00:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2MDAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MzQ2MQ==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390483461", "bodyText": "I'd really rather not see the double equals used with strings.  I know Scala has special semantics for this, but it always looks wrong to people familiar with Java.  Maybe test isEmpty instead?", "author": "cmccabe", "createdAt": "2020-03-10T17:23:31Z", "path": "core/src/main/scala/kafka/server/AdminManager.scala", "diffHunk": "@@ -700,4 +702,176 @@ class AdminManager(val config: KafkaConfig,\n     val readOnly = !DynamicBrokerConfig.AllDynamicConfigs.contains(name)\n     new DescribeConfigsResponse.ConfigEntry(name, valueAsString, source, isSensitive, readOnly, synonyms.asJava)\n   }\n+\n+  private def entityToSanitizedUserClientId(entity: QuotaEntity): (Option[String], Option[String]) = {\n+    if (entity.entries.isEmpty)\n+      throw new InvalidRequestException(\"Invalid empty quota entity\")\n+\n+    var user: Option[String] = None\n+    var clientId: Option[String] = None\n+    entity.entries().asScala.foreach { case (entityType, entityName) =>\n+      val sanitizedEntityName = Some(Sanitizer.sanitize(entityName))\n+      entityType match {\n+        case QuotaEntity.USER => user = sanitizedEntityName\n+        case QuotaEntity.CLIENT_ID => clientId = sanitizedEntityName\n+        case _ => throw new InvalidRequestException(s\"Unhandled quota entity type: ${entityType}\")\n+      }\n+      if (entityName == \"\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3OTc5Ng==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390679796", "bodyText": "Done.", "author": "bdbyrne", "createdAt": "2020-03-11T00:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MzQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NDU0Mg==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390484542", "bodyText": "If it's not supported, it shouldn't silently return incorrect data.  It should throw an UnsupportedVersionException", "author": "cmccabe", "createdAt": "2020-03-10T17:25:21Z", "path": "core/src/main/scala/kafka/server/AdminManager.scala", "diffHunk": "@@ -700,4 +702,176 @@ class AdminManager(val config: KafkaConfig,\n     val readOnly = !DynamicBrokerConfig.AllDynamicConfigs.contains(name)\n     new DescribeConfigsResponse.ConfigEntry(name, valueAsString, source, isSensitive, readOnly, synonyms.asJava)\n   }\n+\n+  private def entityToSanitizedUserClientId(entity: QuotaEntity): (Option[String], Option[String]) = {\n+    if (entity.entries.isEmpty)\n+      throw new InvalidRequestException(\"Invalid empty quota entity\")\n+\n+    var user: Option[String] = None\n+    var clientId: Option[String] = None\n+    entity.entries().asScala.foreach { case (entityType, entityName) =>\n+      val sanitizedEntityName = Some(Sanitizer.sanitize(entityName))\n+      entityType match {\n+        case QuotaEntity.USER => user = sanitizedEntityName\n+        case QuotaEntity.CLIENT_ID => clientId = sanitizedEntityName\n+        case _ => throw new InvalidRequestException(s\"Unhandled quota entity type: ${entityType}\")\n+      }\n+      if (entityName == \"\")\n+        throw new InvalidRequestException(s\"Empty ${entityType} not supported\")\n+    }\n+    (user, clientId)\n+  }\n+\n+  private def userClientIdToEntity(user: Option[String], clientId: Option[String]): QuotaEntity = {\n+    new QuotaEntity((user.map(u => QuotaEntity.USER -> u) ++ clientId.map(c => QuotaEntity.CLIENT_ID -> c)).toMap.asJava)\n+  }\n+\n+  def describeClientQuotas(filters: Seq[QuotaFilter], includeUnspecifiedTypes: Boolean): Map[QuotaEntity, Map[String, Double]] = {\n+    var userFilter: Option[QuotaFilter] = None\n+    var clientIdFilter: Option[QuotaFilter] = None\n+    var otherFilter: Boolean = false\n+    filters.foreach { filter =>\n+      filter.entityType() match {\n+        case QuotaEntity.USER =>\n+          if (userFilter.isDefined)\n+            throw new InvalidRequestException(s\"Duplicate user filter entity type\");\n+          userFilter = Some(filter)\n+        case QuotaEntity.CLIENT_ID =>\n+          if (clientIdFilter.isDefined)\n+            throw new InvalidRequestException(s\"Duplicate client filter entity type\");\n+          clientIdFilter = Some(filter)\n+        case \"\" =>\n+          throw new InvalidRequestException(s\"Unexpected empty filter entity type\")\n+        case _ =>\n+          // Supplying other entity types is not yet supported.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY4MDE0MA==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390680140", "bodyText": "Done.", "author": "bdbyrne", "createdAt": "2020-03-11T00:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NDU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NjI0NQ==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390486245", "bodyText": "Need to update this JavaDoc parameter to match the new name of the function parameter.", "author": "cmccabe", "createdAt": "2020-03-10T17:27:48Z", "path": "clients/src/main/java/org/apache/kafka/common/quota/QuotaFilter.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.kafka.common.quota;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Describes a quota entity filter.\n+ */\n+public class QuotaFilter {\n+\n+    // Matches all entities with the entity type specified.\n+    private static final String MATCH_SPECIFIED = \"\";\n+\n+    private final String entityType;\n+    private final String match;\n+\n+    /**\n+     * A filter to be applied.\n+     *\n+     * @param entityType the entity type the filter applies to\n+     * @param match the string that's matched exactly\n+     */\n+    private QuotaFilter(String entityType, String match) {\n+        this.entityType = Objects.requireNonNull(entityType);\n+        this.match = Objects.requireNonNull(match);\n+    }\n+\n+    /**\n+     * Constructs and returns a quota filter that matches the provided entity\n+     * name for the entity type exactly.\n+     *\n+     * @param entityType the entity type the filter applies to\n+     * @param match the string that's matched exactly", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3OTU4MA==", "url": "https://github.com/apache/kafka/pull/8083#discussion_r390679580", "bodyText": "Done.", "author": "bdbyrne", "createdAt": "2020-03-11T00:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NjI0NQ=="}], "type": "inlineReview"}, {"oid": "ca6508233725aa718c5342f2c2adbc9ebacece72", "url": "https://github.com/apache/kafka/commit/ca6508233725aa718c5342f2c2adbc9ebacece72", "message": "KIP-546 (1/2): Implements describeClientQuotas() and alterClientQuotas().\n\nImplements describeClientQuotas() and alterClientQuotas() to match current\nfunctionality, i.e. extensible entity types and other new quotas features\nlike resolving quotas is not yet supported.\n\nThis is the minimal functionality necessary for KIP-500, and converts the\nConfigCommand to use the client quotas APIs.", "committedDate": "2020-03-11T18:58:22Z", "type": "commit"}, {"oid": "be1836987e449bcbcaa3e0af83f9d1a1f3309c14", "url": "https://github.com/apache/kafka/commit/be1836987e449bcbcaa3e0af83f9d1a1f3309c14", "message": "(minor function renaming)", "committedDate": "2020-03-11T18:58:22Z", "type": "commit"}, {"oid": "4db7d0c81e3253135ad37a7a9b4918b4dfde26af", "url": "https://github.com/apache/kafka/commit/4db7d0c81e3253135ad37a7a9b4918b4dfde26af", "message": "(address review comments)", "committedDate": "2020-03-11T18:58:22Z", "type": "commit"}, {"oid": "4a5c7e3eb73be700455ecdb52e126caac03c51f7", "url": "https://github.com/apache/kafka/commit/4a5c7e3eb73be700455ecdb52e126caac03c51f7", "message": "(address review comments, tests still need updating)", "committedDate": "2020-03-11T18:58:22Z", "type": "commit"}, {"oid": "717d937c474cd9ec157f36e3c17c0db771238dc9", "url": "https://github.com/apache/kafka/commit/717d937c474cd9ec157f36e3c17c0db771238dc9", "message": "(remove includeUnspecified, matchSpecified -> matchSome, update tests)", "committedDate": "2020-03-11T18:59:21Z", "type": "commit"}, {"oid": "717d937c474cd9ec157f36e3c17c0db771238dc9", "url": "https://github.com/apache/kafka/commit/717d937c474cd9ec157f36e3c17c0db771238dc9", "message": "(remove includeUnspecified, matchSpecified -> matchSome, update tests)", "committedDate": "2020-03-11T18:59:21Z", "type": "forcePushed"}, {"oid": "5fb5904d862a544d2c6bb718d4584f8723ec0ce4", "url": "https://github.com/apache/kafka/commit/5fb5904d862a544d2c6bb718d4584f8723ec0ce4", "message": "(update filter API)", "committedDate": "2020-03-14T00:23:58Z", "type": "commit"}]}