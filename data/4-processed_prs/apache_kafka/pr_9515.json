{"pr_number": 9515, "pr_title": "KAFKA-10651: read  offsets directly from checkpoint for uninitialized tasks", "pr_createdAt": "2020-10-28T00:44:51Z", "pr_url": "https://github.com/apache/kafka/pull/9515", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzExNDk3Mg==", "url": "https://github.com/apache/kafka/pull/9515#discussion_r513114972", "bodyText": "Nothing really changed here, but we use to just leave tasks in CREATED and call them \"restoring\" so I had to fix this up so they really were RESTORING", "author": "ableegoldman", "createdAt": "2020-10-28T00:47:31Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/TaskManagerTest.java", "diffHunk": "@@ -2479,7 +2502,7 @@ public void shouldTransmitProducerMetrics() {\n             allTasks.put(task.id(), (StateMachineTask) task);\n         }\n         for (final Task task : restoringTasks) {\n-            assertThat(task.state(), not(Task.State.RUNNING));", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MDkzNQ==", "url": "https://github.com/apache/kafka/pull/9515#discussion_r513290935", "bodyText": "Are there also other task states, we need to consider here except CREATED? What about CLOSED or SUSPENDED?", "author": "cadonna", "createdAt": "2020-10-28T09:22:41Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -671,7 +672,7 @@ void handleLostAll() {\n         // just have an empty changelogOffsets map.\n         for (final TaskId id : union(HashSet::new, lockedTaskDirectories, tasks.keySet())) {\n             final Task task = tasks.get(id);\n-            if (task != null) {\n+            if (task != null && task.state() != State.CREATED) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY2NDM3OQ==", "url": "https://github.com/apache/kafka/pull/9515#discussion_r513664379", "bodyText": "Ahh, good catch: the task returns changelog offsets ultimately from the ProcessorStateManager's stores map, which is cleared during close. So we should fall through to the checkpoint file for CLOSED tasks as well (technically there's currently no way for a CLOSED task to be in the TaskManager's tasks map when the member sends a JoinGroup, since we remove it from the tasks immediately upon close, but that may not always be the case so better safe than sorry.\nFor SUSPENDED we should still rely on the task's. changelog offsets since it doesn't do the checkpoint or clearing out of stores during suspend. (Actually very little happens in suspend at the moment)", "author": "ableegoldman", "createdAt": "2020-10-28T18:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5MDkzNQ=="}], "type": "inlineReview"}, {"oid": "8f21ab961475a4942033241808cad6702469dfe4", "url": "https://github.com/apache/kafka/commit/8f21ab961475a4942033241808cad6702469dfe4", "message": "read  offsets directly from checkpoint for uninitialized tasks, add test", "committedDate": "2020-10-30T02:43:13Z", "type": "commit"}, {"oid": "8921f1805f67f9cc345a750fac404ebbee1b370a", "url": "https://github.com/apache/kafka/commit/8921f1805f67f9cc345a750fac404ebbee1b370a", "message": "skip based on task state, refactor tests", "committedDate": "2020-10-30T02:43:13Z", "type": "commit"}, {"oid": "0f98b1714e66d6cc6625538b0c529a68903be1a7", "url": "https://github.com/apache/kafka/commit/0f98b1714e66d6cc6625538b0c529a68903be1a7", "message": "checkstyle", "committedDate": "2020-10-30T02:43:13Z", "type": "commit"}, {"oid": "863be2c009811812d212fd15c6ffd4d2fdc4fe95", "url": "https://github.com/apache/kafka/commit/863be2c009811812d212fd15c6ffd4d2fdc4fe95", "message": "read from checkpoint when CLOSED", "committedDate": "2020-10-30T02:43:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzNDg5Ng==", "url": "https://github.com/apache/kafka/pull/9515#discussion_r515134896", "bodyText": "A unit test for the CLOSED case is missing.", "author": "cadonna", "createdAt": "2020-10-30T14:23:52Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -671,7 +672,8 @@ void handleLostAll() {\n         // just have an empty changelogOffsets map.\n         for (final TaskId id : union(HashSet::new, lockedTaskDirectories, tasks.keySet())) {\n             final Task task = tasks.get(id);\n-            if (task != null) {\n+            // Closed and uninitialized tasks don't have any offsets so we should read directly from the checkpoint\n+            if (task != null && task.state() != State.CREATED && task.state() != State.CLOSED) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06f4430a6c3299c83fe043f3010273e6f20da78f", "url": "https://github.com/apache/kafka/commit/06f4430a6c3299c83fe043f3010273e6f20da78f", "message": "add unit test for CLOSED", "committedDate": "2020-10-30T17:04:20Z", "type": "commit"}, {"oid": "06f4430a6c3299c83fe043f3010273e6f20da78f", "url": "https://github.com/apache/kafka/commit/06f4430a6c3299c83fe043f3010273e6f20da78f", "message": "add unit test for CLOSED", "committedDate": "2020-10-30T17:04:20Z", "type": "forcePushed"}]}