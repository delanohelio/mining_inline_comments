{"pr_number": 9347, "pr_title": "KAFKA-10531: Check for negative values to Thread.sleep call", "pr_createdAt": "2020-09-28T21:13:49Z", "pr_url": "https://github.com/apache/kafka/pull/9347", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIzODM4NA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496238384", "bodyText": "nit: typo in Wati", "author": "splett2", "createdAt": "2020-09-28T21:18:30Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/util/KafkaBasedLogTest.java", "diffHunk": "@@ -536,6 +536,22 @@ public void onCompletion(RecordMetadata metadata, Exception exception) {\n         PowerMock.verifyAll();\n     }\n \n+    /**\n+     * Check if the waitForTopicCreate method doesn't throw if time moves backward, and works\n+     * correctly if it increases.\n+     */\n+    @Test\n+    public void testWatiForTopicCreate() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI3MTE5NA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496271194", "bodyText": "Fixed (actually removed the test)", "author": "soondenana", "createdAt": "2020-09-28T22:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIzODM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0MDQ1Mw==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496240453", "bodyText": "Why don't we use a monotonic timer?", "author": "ijuma", "createdAt": "2020-09-28T21:22:50Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -163,6 +163,18 @@ public void start() {\n         log.info(\"Started KafkaBasedLog for topic \" + topic);\n     }\n \n+    /**\n+     * Sleep for some time so that topic used for this KafkaBasedLog gets created. Note that\n+     * {@code System.currentTimeMillis()} is not monotonic, so check for that condition.", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2Mzk2NQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496263965", "bodyText": "Wanted to make least amount of change. I can update the code to use monotonic 'nanoTime` instead (nanoseconds in Time interface). We will also need to convert that to milli before passing to sleep (unless we want to add nano to those interfaces too, like Utils.sleep)", "author": "soondenana", "createdAt": "2020-09-28T22:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0MDQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2NzE3NQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496267175", "bodyText": "In fact I don't like this loop altogether. Going to rewrite it so that it doesn't use these constructs.", "author": "soondenana", "createdAt": "2020-09-28T22:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0MDQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI3MDU4MQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496270581", "bodyText": "You can use hiResClockMs so that you get the value in ms.", "author": "ijuma", "createdAt": "2020-09-28T22:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0MDQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI3MjI0Mw==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496272243", "bodyText": "In fact we don't need value from clock to sleep, only need it to find elapsed time and timeout. I have decoupled these two, and also fixed a minor issue where it was sleeping first time even if topic was present.\nPlease take a look.", "author": "soondenana", "createdAt": "2020-09-28T22:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0MDQ1Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI3MDg2MA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496270860", "bodyText": "Time has a sleep method too btw.", "author": "ijuma", "createdAt": "2020-09-28T22:28:24Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -133,11 +134,14 @@ public void start() {\n         List<TopicPartition> partitions = new ArrayList<>();\n \n         // We expect that the topics will have been created either manually by the user or automatically by the herder\n-        List<PartitionInfo> partitionInfos = null;\n-        long started = time.milliseconds();\n-        while (partitionInfos == null && time.milliseconds() - started < CREATE_TOPIC_TIMEOUT_MS) {\n+        List<PartitionInfo> partitionInfos = consumer.partitionsFor(topic);\n+        long started = time.nanoseconds();\n+        long maxSleepMs = 1_000;\n+        long sleepMs = 10;\n+        while (partitionInfos == null && time.nanoseconds() - started < CREATE_TOPIC_TIMEOUT_NS) {\n+            Utils.sleep(sleepMs);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI3NTM4MQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496275381", "bodyText": "Updated.", "author": "soondenana", "createdAt": "2020-09-28T22:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI3MDg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkwNDgxMg==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496904812", "bodyText": "Why not using partitionsFor(String topic, Duration timeout)  (https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/KafkaConsumer.java#L1944) to replace while loop?", "author": "chia7712", "createdAt": "2020-09-29T17:12:07Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -133,11 +133,14 @@ public void start() {\n         List<TopicPartition> partitions = new ArrayList<>();\n \n         // We expect that the topics will have been created either manually by the user or automatically by the herder\n-        List<PartitionInfo> partitionInfos = null;\n-        long started = time.milliseconds();\n-        while (partitionInfos == null && time.milliseconds() - started < CREATE_TOPIC_TIMEOUT_MS) {\n+        List<PartitionInfo> partitionInfos = consumer.partitionsFor(topic);\n+        long started = time.nanoseconds();\n+        long maxSleepMs = 1_000;\n+        long sleepMs = 10;\n+        while (partitionInfos == null && time.nanoseconds() - started < CREATE_TOPIC_TIMEOUT_NS) {\n+            time.sleep(sleepMs);\n+            sleepMs = Math.min(2 * sleepMs, maxSleepMs);\n             partitionInfos = consumer.partitionsFor(topic);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk4MzcyMQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r496983721", "bodyText": "I think the semantics needed here is different. The timeout in partitionsFor is the max amount of time the api can block waiting for response before it fails with TimeoutException. However, the api can return within timeout with empty results as newly created topics data has not been propagated yet. We then have to retry again until partitionsFor returns the partition data (upto a max time).", "author": "soondenana", "createdAt": "2020-09-29T19:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkwNDgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAxNzM5NQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r497017395", "bodyText": "It seems to me the behavior of timeout is not consistent in consumer methods. The timeout used by other methods (for example:  position, offsetsForTimes, beginningOffsets and endOffsets) is to await the result of specify partitions. It means consumer will send a request again if the timer is not expired and the specify partition has no metadata (i.e topics data has not been propagated yet). Maybe partitionsFor should be fixed for consistent behavior.", "author": "chia7712", "createdAt": "2020-09-29T20:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkwNDgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAzNDQzNQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r497034435", "bodyText": "Not sure about this, no result for \"partitionInfos\" is a valid result. There is no point in automatic retrying. While for other apis that retry automatically, they do it if they get an invalid result back. If null was a valid result for them, they shouldn't retry either.", "author": "soondenana", "createdAt": "2020-09-29T20:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkwNDgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIyOTIwOA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r497229208", "bodyText": "@soondenana Thanks for responses. This patch LGTM. What I want to discuss is unrelated to this patch.\n\nthey do it if they get an invalid result back. If null was a valid result for them, they shouldn't retry either.\n\nIf the topic is not exist (or not been propagated yet), partitionFor can return null. By contrast, beginningOffsets (and other methods) throws TimeoutException. In order to make consistent behavior, beginningOffsets (and other methods) should let the topic (or partition) be absent in the returned Map. WDYT?", "author": "chia7712", "createdAt": "2020-09-30T03:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkwNDgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyMzU5OQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499023599", "bodyText": "We are often using this pattern in other places for time-related constants:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final long CREATE_TOPIC_TIMEOUT_NS = TimeUnit.NANOSECONDS.convert(30, TimeUnit.SECONDS);\n          \n          \n            \n                private static final long CREATE_TOPIC_TIMEOUT_NS = TimeUnit.SECONDS.toNanos(30);", "author": "rhauch", "createdAt": "2020-10-02T19:58:49Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -70,7 +70,7 @@\n  */\n public class KafkaBasedLog<K, V> {\n     private static final Logger log = LoggerFactory.getLogger(KafkaBasedLog.class);\n-    private static final long CREATE_TOPIC_TIMEOUT_MS = 30000;\n+    private static final long CREATE_TOPIC_TIMEOUT_NS = TimeUnit.NANOSECONDS.convert(30, TimeUnit.SECONDS);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzMzExMQ==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499033111", "bodyText": "Fixed.", "author": "soondenana", "createdAt": "2020-10-02T20:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyMzU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNDE4Mg==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499024182", "bodyText": "Let's define a constant above:\nprivate static final long MAX_SLEEP_MS = TimeUnit.SECONDS.toMillis(1);\n\nand then we can replace maxSleepMs with MAX_SLEEP_MS.", "author": "rhauch", "createdAt": "2020-10-02T20:00:12Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java", "diffHunk": "@@ -133,11 +133,14 @@ public void start() {\n         List<TopicPartition> partitions = new ArrayList<>();\n \n         // We expect that the topics will have been created either manually by the user or automatically by the herder\n-        List<PartitionInfo> partitionInfos = null;\n-        long started = time.milliseconds();\n-        while (partitionInfos == null && time.milliseconds() - started < CREATE_TOPIC_TIMEOUT_MS) {\n+        List<PartitionInfo> partitionInfos = consumer.partitionsFor(topic);\n+        long started = time.nanoseconds();\n+        long maxSleepMs = 1_000;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzMzIzMA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499033230", "bodyText": "Updated.", "author": "soondenana", "createdAt": "2020-10-02T20:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNDE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA3MTk5OA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499071998", "bodyText": "Won't this hide bugs?", "author": "ijuma", "createdAt": "2020-10-02T22:15:51Z", "path": "clients/src/main/java/org/apache/kafka/common/utils/Utils.java", "diffHunk": "@@ -331,6 +331,11 @@ public static ByteBuffer wrapNullable(byte[] array) {\n      */\n     public static void sleep(long ms) {\n         try {\n+            if (ms <= 0) {\n+                // No need to sleep\n+                log.debug(\"Skipping sleep as asked to sleep for {} msec\", ms);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA3NjMxOA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499076318", "bodyText": "Yes. I have seen things done both ways i.e. behave reasonably in face of weird args vs throw exception. Time.sleep combines both approaches, throws for values < 0 but skips if sleep = 0 and goes to sleep for values > 0.\nIts a judgement call, we can delegate to JDK and remove this check.", "author": "soondenana", "createdAt": "2020-10-02T22:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA3MTk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA3OTYwNA==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499079604", "bodyText": "Overflow is not uncommon when using things like Long.MaxValue for timeouts, so assuming negative is not a bug seems dangerous.", "author": "ijuma", "createdAt": "2020-10-02T22:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA3MTk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4MDM3Ng==", "url": "https://github.com/apache/kafka/pull/9347#discussion_r499080376", "bodyText": "Ok, I see the point. Overflow can be caused by time arithmetic too. Reverted the change.", "author": "soondenana", "createdAt": "2020-10-02T22:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA3MTk5OA=="}], "type": "inlineReview"}, {"oid": "aede8a672f23b28ab31080847a4012a2c263b49d", "url": "https://github.com/apache/kafka/commit/aede8a672f23b28ab31080847a4012a2c263b49d", "message": "KAFKA-10531: Check for negative values to Thread.sleep call\n\nSystem.currentTimeMillis() is not monotonic, so using that to calculate\ntime to sleep can result in negative values. That will throw\nIllegalArgumentException.\n\nThis change checks for that and sleeps for a second (to avoid tight\nloop) if the value returned is negative.", "committedDate": "2020-10-05T05:57:40Z", "type": "commit"}, {"oid": "d69c6fb8c2685ab0f104468f3ad0ec4806e3f15e", "url": "https://github.com/apache/kafka/commit/d69c6fb8c2685ab0f104468f3ad0ec4806e3f15e", "message": "Don't use milliseconds to calculate elapsed time", "committedDate": "2020-10-05T05:57:40Z", "type": "commit"}, {"oid": "67ffa9cbec7defe4ba3f6b4ee52be6750a31a261", "url": "https://github.com/apache/kafka/commit/67ffa9cbec7defe4ba3f6b4ee52be6750a31a261", "message": "Use time.sleep instead of Utils.sleep", "committedDate": "2020-10-05T05:57:40Z", "type": "commit"}, {"oid": "fc816b73b0ba9cd224103ef68d14b7400a52be4b", "url": "https://github.com/apache/kafka/commit/fc816b73b0ba9cd224103ef68d14b7400a52be4b", "message": "Set initial sleep value to be 100 msec", "committedDate": "2020-10-05T05:57:40Z", "type": "commit"}, {"oid": "91ed268ceca92fa225d3d8402bba39f454a77400", "url": "https://github.com/apache/kafka/commit/91ed268ceca92fa225d3d8402bba39f454a77400", "message": "Use TimeUnit.SECONDS.toXXX pattern", "committedDate": "2020-10-05T05:57:40Z", "type": "commit"}, {"oid": "1a4aafe8577a42c8a68446d3daedff749473d559", "url": "https://github.com/apache/kafka/commit/1a4aafe8577a42c8a68446d3daedff749473d559", "message": "Don't sleep if negative sleep is provided", "committedDate": "2020-10-05T05:57:40Z", "type": "commit"}, {"oid": "4054146c69b14a92c53066830f8f732bf446bac4", "url": "https://github.com/apache/kafka/commit/4054146c69b14a92c53066830f8f732bf446bac4", "message": "Revert skip sleep change", "committedDate": "2020-10-05T05:57:40Z", "type": "commit"}, {"oid": "4054146c69b14a92c53066830f8f732bf446bac4", "url": "https://github.com/apache/kafka/commit/4054146c69b14a92c53066830f8f732bf446bac4", "message": "Revert skip sleep change", "committedDate": "2020-10-05T05:57:40Z", "type": "forcePushed"}]}