{"pr_number": 8820, "pr_title": "KAFKA-10097: Internalize checkpoint data", "pr_createdAt": "2020-06-06T00:27:07Z", "pr_url": "https://github.com/apache/kafka/pull/8820", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxNTg5OQ==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436215899", "bodyText": "Maybe easier to make this writeCheckpointIfNeeded:\n    private void writeCheckpointIfNeeded() {\n        if (checkpointNeeded) {\n            stateMgr.checkpoint(checkpoint);\n            checkpointNeeded = false;\n        }\n    }\n\nFor this case, the caller does not need to check the checkpointNeeded flag?", "author": "mjsax", "createdAt": "2020-06-06T00:34:01Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -562,32 +561,41 @@ public void closeAndRecycleState() {\n                 if (clean) {\n                     stateMgr.flush();\n                     recordCollector.flush();\n-                    checkpoint = checkpointableOffsets();\n+\n+                    scheduleCheckpoint(checkpointableOffsets());\n                 } else {\n-                    checkpoint = null; // `null` indicates to not write a checkpoint\n                     executeAndMaybeSwallow(false, stateMgr::flush, \"state manager flush\", log);\n                 }\n \n                 break;\n \n             case RESTORING:\n                 executeAndMaybeSwallow(clean, stateMgr::flush, \"state manager flush\", log);\n-                checkpoint = Collections.emptyMap();\n+                scheduleCheckpoint(emptyMap());\n \n                 break;\n \n             case SUSPENDED:\n             case CLOSED:\n                 // not need to checkpoint, since when suspending we've already committed the state\n-                checkpoint = null; // `null` indicates to not write a checkpoint\n-\n                 break;\n \n             default:\n                 throw new IllegalStateException(\"Unknown state \" + state() + \" while prepare closing active task \" + id);\n         }\n+    }\n \n-        return checkpoint;\n+    private void scheduleCheckpoint(final Map<TopicPartition, Long> checkpoint) {\n+        this.checkpoint = checkpoint;\n+        this.checkpointNeeded = true;\n+    }\n+\n+    private void writeCheckpoint() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxOTE3OA==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436219178", "bodyText": "Sounds good", "author": "abbccdda", "createdAt": "2020-06-06T00:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxNTg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxNjY3MQ==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436216671", "bodyText": "Do we need to set checkpointNeeded = false here?", "author": "mjsax", "createdAt": "2020-06-06T00:37:32Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -562,32 +561,41 @@ public void closeAndRecycleState() {\n                 if (clean) {\n                     stateMgr.flush();\n                     recordCollector.flush();\n-                    checkpoint = checkpointableOffsets();\n+\n+                    scheduleCheckpoint(checkpointableOffsets());\n                 } else {\n-                    checkpoint = null; // `null` indicates to not write a checkpoint", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIxNjgyMA==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436216820", "bodyText": "As above?", "author": "mjsax", "createdAt": "2020-06-06T00:37:52Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -562,32 +561,41 @@ public void closeAndRecycleState() {\n                 if (clean) {\n                     stateMgr.flush();\n                     recordCollector.flush();\n-                    checkpoint = checkpointableOffsets();\n+\n+                    scheduleCheckpoint(checkpointableOffsets());\n                 } else {\n-                    checkpoint = null; // `null` indicates to not write a checkpoint\n                     executeAndMaybeSwallow(false, stateMgr::flush, \"state manager flush\", log);\n                 }\n \n                 break;\n \n             case RESTORING:\n                 executeAndMaybeSwallow(clean, stateMgr::flush, \"state manager flush\", log);\n-                checkpoint = Collections.emptyMap();\n+                scheduleCheckpoint(emptyMap());\n \n                 break;\n \n             case SUSPENDED:\n             case CLOSED:\n                 // not need to checkpoint, since when suspending we've already committed the state\n-                checkpoint = null; // `null` indicates to not write a checkpoint", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b25a3af632cfd9ac4489ec1b692b46a9cdd73b9", "url": "https://github.com/apache/kafka/commit/5b25a3af632cfd9ac4489ec1b692b46a9cdd73b9", "message": "internalize checkpoint", "committedDate": "2020-06-06T00:48:06Z", "type": "commit"}, {"oid": "5b25a3af632cfd9ac4489ec1b692b46a9cdd73b9", "url": "https://github.com/apache/kafka/commit/5b25a3af632cfd9ac4489ec1b692b46a9cdd73b9", "message": "internalize checkpoint", "committedDate": "2020-06-06T00:48:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMDc2OQ==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436220769", "bodyText": "I think we could just reset any checkpoint at the beginning, so that we only do checkpointing if this call thinks so. @mjsax", "author": "abbccdda", "createdAt": "2020-06-06T00:49:47Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -546,14 +547,14 @@ public void closeAndRecycleState() {\n      *                 otherwise, just close open resources\n      * @throws TaskMigratedException if the task producer got fenced (EOS)\n      */\n-    private Map<TopicPartition, Long> prepareClose(final boolean clean) {\n-        final Map<TopicPartition, Long> checkpoint;\n+    private void prepareClose(final boolean clean) {\n+        // Reset any previously scheduled checkpoint.", "originalCommit": "5b25a3af632cfd9ac4489ec1b692b46a9cdd73b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMjk1Ng==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436222956", "bodyText": "That should work.", "author": "mjsax", "createdAt": "2020-06-06T01:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMDc2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMzAyNw==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436223027", "bodyText": "A if (clean) should be sufficient now", "author": "mjsax", "createdAt": "2020-06-06T01:10:42Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -598,9 +606,9 @@ public void closeAndRecycleState() {\n      *  3. finally release the state manager lock\n      * </pre>\n      */\n-    private void close(final boolean clean, final Map<TopicPartition, Long> checkpoint) {\n-        if (clean && checkpoint != null) {\n-            executeAndMaybeSwallow(clean, () -> stateMgr.checkpoint(checkpoint), \"state manager checkpoint\", log);\n+    private void close(final boolean clean) {\n+        if (clean && checkpointNeeded) {", "originalCommit": "5b25a3af632cfd9ac4489ec1b692b46a9cdd73b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyOTM0OQ==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436229349", "bodyText": "Make sense", "author": "abbccdda", "createdAt": "2020-06-06T02:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMzAyNw=="}], "type": "inlineReview"}, {"oid": "6b7bcd100f349698b658a1e4ad5b7735b847d977", "url": "https://github.com/apache/kafka/commit/6b7bcd100f349698b658a1e4ad5b7735b847d977", "message": "minor change", "committedDate": "2020-06-06T02:26:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyOTgyMg==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436229822", "bodyText": "Do we need two parameters here? Could we still just use one Map<TopicPartition, Long> checkpoint, and then in writeCheckpointIfNeed if it is not null write it and then set it to null.", "author": "guozhangwang", "createdAt": "2020-06-06T02:33:22Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -107,6 +107,9 @@\n     private boolean commitNeeded = false;\n     private boolean commitRequested = false;\n \n+    private boolean checkpointNeeded = false;", "originalCommit": "6b7bcd100f349698b658a1e4ad5b7735b847d977", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzMzM4Mg==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436233382", "bodyText": "I actually had a similar thought, but I am torn though. Using two variables required to keep them \"in sync\" was is not great. However, using null is less explicit... Thus overall I am fine either way as both seems to provide the overall same good/bad ratio.", "author": "mjsax", "createdAt": "2020-06-06T03:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyOTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzNzQyNg==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436237426", "bodyText": "A third option is Optional<Map<TopicPartition, Long>> which explicitly states the checkpoint  is null. However, I think the benefit here is minimal, as checkpointNeeded sounds like a better state variable, than relying on the struct itself.", "author": "abbccdda", "createdAt": "2020-06-06T04:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyOTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzODgwNA==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436238804", "bodyText": "Actually I'm not too concerned of relying on null to indicate no need to checkpoint, what I originally pointed out is that we are unnecessarily accumulating and then distributing checkpoints between task manager and task, which is already resolved in your PR. So I'd suggest we still just use a single nullable Map.", "author": "guozhangwang", "createdAt": "2020-06-06T05:07:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyOTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3ODQ3Mw==", "url": "https://github.com/apache/kafka/pull/8820#discussion_r436278473", "bodyText": "Cool", "author": "abbccdda", "createdAt": "2020-06-06T15:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyOTgyMg=="}], "type": "inlineReview"}, {"oid": "bc9c9dacb0254f78b628d845f1c3e2d8e91fb2e0", "url": "https://github.com/apache/kafka/commit/bc9c9dacb0254f78b628d845f1c3e2d8e91fb2e0", "message": "only checkpoint struct", "committedDate": "2020-06-06T15:46:46Z", "type": "commit"}]}