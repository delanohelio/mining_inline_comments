{"pr_number": 8981, "pr_title": "KAFKA-10235 Fix flaky transactions_test.py", "pr_createdAt": "2020-07-05T17:47:51Z", "pr_url": "https://github.com/apache/kafka/pull/8981", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyOTUyNA==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r450429524", "bodyText": "transaction_timeout => transaction_cleanup_interval?", "author": "junrao", "createdAt": "2020-07-06T19:17:48Z", "path": "tests/kafkatest/services/kafka/kafka.py", "diffHunk": "@@ -101,7 +101,7 @@ def __init__(self, context, num_nodes, zk, security_protocol=SecurityConfig.PLAI\n                  jmx_attributes=None, zk_connect_timeout=5000, zk_session_timeout=6000, server_prop_overides=None, zk_chroot=None,\n                  zk_client_secure=False,\n                  listener_security_config=ListenerSecurityConfig(), per_node_server_prop_overrides=None,\n-                 extra_kafka_opts=\"\", tls_version=None):\n+                 extra_kafka_opts=\"\", tls_version=None, transaction_timeout=10000):", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyOTY1Mg==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r450429652", "bodyText": "This is reducing the transaction cleanup interval.", "author": "junrao", "createdAt": "2020-07-06T19:18:01Z", "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -53,7 +53,11 @@ def __init__(self, test_context):\n         self.zk = ZookeeperService(test_context, num_nodes=1)\n         self.kafka = KafkaService(test_context,\n                                   num_nodes=self.num_brokers,\n-                                  zk=self.zk)\n+                                  zk=self.zk,\n+                                  # Reducing timeout of transaction can quickly cleanup the unstable offsets.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQzMDYwNA==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r450430604", "bodyText": "The default transaction.abort.timed.out.transaction.cleanup.interval.ms is 10 secs. In the jira, the consumer seems to have failed without making progress for 30 secs. So, will reducing this timeout help?", "author": "junrao", "createdAt": "2020-07-06T19:20:03Z", "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -53,7 +53,11 @@ def __init__(self, test_context):\n         self.zk = ZookeeperService(test_context, num_nodes=1)\n         self.kafka = KafkaService(test_context,\n                                   num_nodes=self.num_brokers,\n-                                  zk=self.zk)\n+                                  zk=self.zk,\n+                                  # Reducing timeout of transaction can quickly cleanup the unstable offsets.\n+                                  # IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable\n+                                  # offsets which obstructs TransactionalMessageCopier from receiving position of group.\n+                                  transaction_timeout=2000)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYwMTE2MA==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r450601160", "bodyText": "@junrao thanks for your great reviews!!! This approach is not correct. The \"number\" which should be reduced is \"transaction timeout\" rather than \"cleanup interval\".", "author": "chia7712", "createdAt": "2020-07-07T04:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQzMDYwNA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2NzA4Ng==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451167086", "bodyText": "broker => broken", "author": "junrao", "createdAt": "2020-07-07T21:57:07Z", "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -47,7 +47,10 @@ def __init__(self, test_context):\n         self.num_output_partitions = 3\n         self.num_seed_messages = 100000\n         self.transaction_size = 750\n-        self.transaction_timeout = 40000\n+        # This is reducing the transaction cleanup interval.\n+        # IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTM3NA==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451179374", "bodyText": "Hmm, still not sure about this. In a hard bounce, the broker failure will be detected after ZK session expiration, with a default of 18 sec. After that, new leaders will be elected and the client should recover. So, the transactional producer should be unblocked after 18 secs, even with a 40 sec transaction_timeout?", "author": "junrao", "createdAt": "2020-07-07T22:27:57Z", "path": "tests/kafkatest/tests/core/transactions_test.py", "diffHunk": "@@ -47,7 +47,10 @@ def __init__(self, test_context):\n         self.num_output_partitions = 3\n         self.num_seed_messages = 100000\n         self.transaction_size = 750\n-        self.transaction_timeout = 40000\n+        # This is reducing the transaction cleanup interval.\n+        # IN hard_bounce mode, transaction is broke ungracefully. Hence, it produces unstable\n+        # offsets which obstructs TransactionalMessageCopier from receiving position of group.\n+        self.transaction_timeout = 5000", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxOTIwMQ==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451219201", "bodyText": "the broker failure will be detected after ZK session expiration\n\nIt is unrelate to broker. The root cause is client (TransactionMessageCopier) is ungracefully closed in hard_bounce mode. The transactional message sent by client is not correctly completed so there are pending transaction (unstable offset) stored by broker. When the client is restarting, it fails to get offsets of partition due to unstable offset (TransactionMessageCopier needs to get position of partition to calculate remaining messages after restarting).\nThe timeout of transaction is higher than the timeout of verification so this test fails if any transaction is not correctly abort.", "author": "chia7712", "createdAt": "2020-07-08T00:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNDkwOA==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451224908", "bodyText": "@chia7712 : Thanks for the reply. That makes sense. Perhaps we can adjust the comment to make it clear that the hard bounce is for the client.", "author": "junrao", "createdAt": "2020-07-08T01:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg5ODczMQ==", "url": "https://github.com/apache/kafka/pull/8981#discussion_r451898731", "bodyText": "we can adjust the comment to make it clear that the hard bounce is for the client.\n\ndone", "author": "chia7712", "createdAt": "2020-07-09T00:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTM3NA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "3377dc3d121d1e51666498c8ac0db58368077548", "url": "https://github.com/apache/kafka/commit/3377dc3d121d1e51666498c8ac0db58368077548", "message": "KAFKA-10235 Fix flaky transactions_test.py", "committedDate": "2020-07-09T00:24:47Z", "type": "commit"}, {"oid": "695662390f7f1888d6eb355288822d3c1fceef96", "url": "https://github.com/apache/kafka/commit/695662390f7f1888d6eb355288822d3c1fceef96", "message": "KAFKA-10235 reduce the transaction timeout", "committedDate": "2020-07-09T00:24:55Z", "type": "commit"}, {"oid": "63cd6b3c3dcb608c28ff6716ccbbef1cb95add13", "url": "https://github.com/apache/kafka/commit/63cd6b3c3dcb608c28ff6716ccbbef1cb95add13", "message": "KAFKA-10235 fix typo", "committedDate": "2020-07-09T00:24:55Z", "type": "commit"}, {"oid": "aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "url": "https://github.com/apache/kafka/commit/aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "message": "add comment", "committedDate": "2020-07-09T00:32:14Z", "type": "commit"}, {"oid": "aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "url": "https://github.com/apache/kafka/commit/aa66df9ee3a3e51219a94f1c2af7dca567cabd7c", "message": "add comment", "committedDate": "2020-07-09T00:32:14Z", "type": "forcePushed"}, {"oid": "0d062a540895df76a9f88f4b138167952bd12a21", "url": "https://github.com/apache/kafka/commit/0d062a540895df76a9f88f4b138167952bd12a21", "message": "remove useless stuff", "committedDate": "2020-07-09T00:33:59Z", "type": "commit"}, {"oid": "6df6979ff5fe7197c4718a9becb72ed579c297b2", "url": "https://github.com/apache/kafka/commit/6df6979ff5fe7197c4718a9becb72ed579c297b2", "message": "remove useless stuff", "committedDate": "2020-07-09T00:34:28Z", "type": "commit"}]}