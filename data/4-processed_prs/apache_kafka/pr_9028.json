{"pr_number": 9028, "pr_title": "KAFKA-10035: Safer conversion of consumer timeout parameters", "pr_createdAt": "2020-07-15T16:09:43Z", "pr_url": "https://github.com/apache/kafka/pull/9028", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxNjM2NA==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r455916364", "bodyText": "Hah, this was pretty janky. Good catch", "author": "ableegoldman", "createdAt": "2020-07-16T16:29:20Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/AbstractResetIntegrationTest.java", "diffHunk": "@@ -151,7 +151,7 @@ private void prepareConfigs() {\n         streamsConfig.put(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG, 100);\n         streamsConfig.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, 100);\n         streamsConfig.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, \"earliest\");\n-        streamsConfig.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, \"\" + STREAMS_CONSUMER_TIMEOUT);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA2ODcyNw==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456068727", "bodyText": "thanks!", "author": "serjchebotarev", "createdAt": "2020-07-16T20:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxNjM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r455927296", "bodyText": "Why are none of these tests...actually tests? Can you also fix this, ie add @Test annotations to all the tests here?\nI think you can then simplify the two tests that extend this abstract test class (ResetIntegrationTest and ResetIntegrationWithSslTest) and just remove all the tests that just call super.testXXX -- they should automatically run all of the tests in this class", "author": "ableegoldman", "createdAt": "2020-07-16T16:47:21Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/AbstractResetIntegrationTest.java", "diffHunk": "@@ -265,7 +265,7 @@ public void shouldNotAllowToResetWhenIntermediateTopicAbsent() throws Exception\n     public void testResetWhenLongSessionTimeoutConfiguredWithForceOption() throws Exception {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA2NzQ4MA==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456067480", "bodyText": "Tried on this, partially it went good, but several tests fail under ResetIntegrationWithSslTest, namely:\n\nshouldNotAllowToResetWhileStreamsIsRunning\nshouldNotAllowToResetWhenInputTopicAbsent\nshouldNotAllowToResetWhenIntermediateTopicAbsent\n\nFrom output of shouldNotAllowToResetWhileStreamsIsRunning there are some log lines that mention SSL handshake failure:\n...\n    [2020-07-16 23:00:20,764] INFO stream-thread [reset-with-ssl-integration-test-not-reset-during-runtime-6971acc7-e471-4973-a652-5a09b7dce10d-StreamThread-1] State transition from PARTITIONS_ASSIGNED to RUNNING (org.apache.kafka.streams.processor.internals.StreamThread:220)\n    [2020-07-16 23:00:20,766] INFO stream-client [reset-with-ssl-integration-test-not-reset-during-runtime-6971acc7-e471-4973-a652-5a09b7dce10d] State transition from REBALANCING to RUNNING (org.apache.kafka.streams.KafkaStreams:283)\n    [2020-07-16 23:00:20,771] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n    [2020-07-16 23:00:21,067] INFO [Consumer clientId=reset-with-ssl-integration-test-not-reset-during-runtime-6971acc7-e471-4973-a652-5a09b7dce10d-StreamThread-1-consumer, groupId=reset-with-ssl-integration-test-not-reset-during-runtime] Found no committed offset for partition inputTopic-0 (org.apache.kafka.clients.consumer.internals.ConsumerCoordinator:1349)\n    [2020-07-16 23:00:21,093] INFO [Consumer clientId=reset-with-ssl-integration-test-not-reset-during-runtime-6971acc7-e471-4973-a652-5a09b7dce10d-StreamThread-1-consumer, groupId=reset-with-ssl-integration-test-not-reset-during-runtime] Resetting offset for partition inputTopic-0 to offset 0. (org.apache.kafka.clients.consumer.internals.SubscriptionState:397)\n    [2020-07-16 23:00:21,174] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n    [2020-07-16 23:00:21,548] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n    [2020-07-16 23:00:21,798] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n    [2020-07-16 23:00:22,028] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n    [2020-07-16 23:00:22,329] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n    [2020-07-16 23:00:22,556] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n    [2020-07-16 23:00:22,793] INFO [SocketServer brokerId=0] Failed authentication with /127.0.0.1 (SSL handshake failed) (org.apache.kafka.common.network.Selector:616)\n\norg.apache.kafka.streams.integration.ResetIntegrationWithSslTest > shouldNotAllowToResetWhileStreamsIsRunning SKIPPED\n\n> Task :streams:test FAILED\n:streams:test (Thread[Execution worker for ':',5,main]) completed. Took 14.586 secs.\n\nFAILURE: Build failed with an exception.\n\nWas not able to dig deeper into what could be the reason for this. For now just left these three tests in the base class without @Test annotation and calling them as before in ResetIntegrationTest only.", "author": "serjchebotarev", "createdAt": "2020-07-16T20:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEwMTA5Ng==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456101096", "bodyText": "Thanks for looking into this! It definitely doesn't sound good that some of these tests don't pass with SSL. Maybe there's just some additional setup that's needed for these tests? \ud83e\udd14\nAnyways, we don't need to solve all that in this PR. We can revisit the issue once this is merged", "author": "ableegoldman", "createdAt": "2020-07-16T21:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwODEyNA==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456608124", "bodyText": "Well, actually, we don't want to run all test 2x. The Ssl test only executes 3 test (on purpose) as the other tests would be repetitive and don't add value. -- Given that we alway try to keep test execution time short, we can save about 1 minute if we avoid running the tests twice? Thoughts?", "author": "mjsax", "createdAt": "2020-07-17T18:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwOTc4NQ==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456609785", "bodyText": "...then why extend this abstract class at all? Or rather, why have all these tests in the abstract class and not just in the non-SSL test class?", "author": "ableegoldman", "createdAt": "2020-07-17T18:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMTgwNQ==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456611805", "bodyText": "Not exactly sure. Guess it was just a random decision to do it this way.", "author": "mjsax", "createdAt": "2020-07-17T18:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNTE4OQ==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456615189", "bodyText": "Okay, maybe I gave the wrong advise here and instead of consolidating the two classes we should have separated them.\nWDYT about just moving all but the three tests that we want to run with SSL out of AbstractResetIntegrationTest and into ResetIntegrationTest instead?", "author": "ableegoldman", "createdAt": "2020-07-17T18:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjQ5NA==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456616494", "bodyText": "Works for me.", "author": "mjsax", "createdAt": "2020-07-17T18:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MTA0Ng==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r456791046", "bodyText": "Done. Moved tests to derived class.\nAlso in the last commit (8218891):\n\nRefactored how testId gets set. Instead of class-level variable it is set via getTestId() method which was declared as abstract in AbstractResetIntegrationTest (now it cannot be forgotten to be set in derived classes).\nRemoved appID instance variable (removed instance-level state).", "author": "serjchebotarev", "createdAt": "2020-07-18T13:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNzI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc1NjAzMQ==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r457756031", "bodyText": "A new safeUniqueTestName method was added to IntegrationTestUtils recently, can we port this class over to using that instead of hard-coding a semi-descriptive suffix to the appId in each test?", "author": "ableegoldman", "createdAt": "2020-07-20T23:55:22Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/ResetIntegrationTest.java", "diffHunk": "@@ -68,52 +92,224 @@ public void after() throws Exception {\n     }\n \n     @Test\n-    public void testReprocessingFromScratchAfterResetWithoutIntermediateUserTopic() throws Exception {\n-        super.testReprocessingFromScratchAfterResetWithoutIntermediateUserTopic();\n+    public void shouldNotAllowToResetWhileStreamsIsRunning() {\n+        final String appID = getTestId() + \"-not-reset-during-runtime\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2NDIyMw==", "url": "https://github.com/apache/kafka/pull/9028#discussion_r458064223", "bodyText": "Done! \ud83d\ude04", "author": "serjchebotarev", "createdAt": "2020-07-21T12:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc1NjAzMQ=="}], "type": "inlineReview"}, {"oid": "5f23dd5b2fb2ef9dc51f0dc80df1ac80c2d622c3", "url": "https://github.com/apache/kafka/commit/5f23dd5b2fb2ef9dc51f0dc80df1ac80c2d622c3", "message": "Safer conversion of consumer timeout params", "committedDate": "2020-07-22T09:00:26Z", "type": "commit"}, {"oid": "6b5c1b3bc7b3497fc6682283861aa4d9f15d7257", "url": "https://github.com/apache/kafka/commit/6b5c1b3bc7b3497fc6682283861aa4d9f15d7257", "message": "Move some of @Test annotations to base class", "committedDate": "2020-07-22T09:00:26Z", "type": "commit"}, {"oid": "2b83a7d7b8f47baa504a95e822adc222e8f0f1a3", "url": "https://github.com/apache/kafka/commit/2b83a7d7b8f47baa504a95e822adc222e8f0f1a3", "message": "Move parameterized test to base class", "committedDate": "2020-07-22T09:00:26Z", "type": "commit"}, {"oid": "dcca1af575d3992b92cefa07be3c0ee8ce68bb43", "url": "https://github.com/apache/kafka/commit/dcca1af575d3992b92cefa07be3c0ee8ce68bb43", "message": "Move non-SSL tests to derived class", "committedDate": "2020-07-22T09:01:37Z", "type": "commit"}, {"oid": "eca1b16200e8d089267ec3c9ec0120c3e96f23f3", "url": "https://github.com/apache/kafka/commit/eca1b16200e8d089267ec3c9ec0120c3e96f23f3", "message": "getTestId() instead of class variable\n\nAlso removed instance-level `appID` variable.", "committedDate": "2020-07-22T09:01:37Z", "type": "commit"}, {"oid": "0e06f15bbeb5aea027d369795f7dbd0fc139b660", "url": "https://github.com/apache/kafka/commit/0e06f15bbeb5aea027d369795f7dbd0fc139b660", "message": "Use safeUniqueTestName() to generate test IDs", "committedDate": "2020-07-22T09:01:37Z", "type": "commit"}, {"oid": "0e06f15bbeb5aea027d369795f7dbd0fc139b660", "url": "https://github.com/apache/kafka/commit/0e06f15bbeb5aea027d369795f7dbd0fc139b660", "message": "Use safeUniqueTestName() to generate test IDs", "committedDate": "2020-07-22T09:01:37Z", "type": "forcePushed"}]}