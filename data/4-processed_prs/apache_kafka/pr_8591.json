{"pr_number": 8591, "pr_title": "KAFKA-6342: Move workaround for JSON parsing of non-escaped strings", "pr_createdAt": "2020-04-30T13:33:18Z", "pr_url": "https://github.com/apache/kafka/pull/8591", "timeline": [{"oid": "e7c4346d82725c6fb6f732bf0ba042924fe6cef6", "url": "https://github.com/apache/kafka/commit/e7c4346d82725c6fb6f732bf0ba042924fe6cef6", "message": "Initial Commit", "committedDate": "2020-04-03T10:37:23Z", "type": "commit"}, {"oid": "5b48c95f319f18e69dd1c741851695b5d483b9ef", "url": "https://github.com/apache/kafka/commit/5b48c95f319f18e69dd1c741851695b5d483b9ef", "message": "Fixed the applicability of new method based on trunk", "committedDate": "2020-04-03T10:50:58Z", "type": "commit"}, {"oid": "752d8315b44a38c6907c062e292871e23ebc432d", "url": "https://github.com/apache/kafka/commit/752d8315b44a38c6907c062e292871e23ebc432d", "message": "Merge branch 'trunk'", "committedDate": "2020-04-03T10:50:58Z", "type": "commit"}, {"oid": "1e941b9e801974b1201026bfeba4509342946cea", "url": "https://github.com/apache/kafka/commit/1e941b9e801974b1201026bfeba4509342946cea", "message": "Rebased and applied review comments", "committedDate": "2020-04-03T10:54:52Z", "type": "commit"}, {"oid": "a14e6cb0dbeb736e1018ee141832153a34e47bc4", "url": "https://github.com/apache/kafka/commit/a14e6cb0dbeb736e1018ee141832153a34e47bc4", "message": "Rebased and applied review comments", "committedDate": "2020-04-03T10:56:17Z", "type": "commit"}, {"oid": "ae659d171d2378dd7932062344ef316695cd1d20", "url": "https://github.com/apache/kafka/commit/ae659d171d2378dd7932062344ef316695cd1d20", "message": "Changed the AclJson to have the incorrect format for principals", "committedDate": "2020-04-03T10:56:18Z", "type": "commit"}, {"oid": "1c308a8a8fd9786699448bcec94c324730598283", "url": "https://github.com/apache/kafka/commit/1c308a8a8fd9786699448bcec94c324730598283", "message": "Applied the review comments", "committedDate": "2020-04-03T10:56:19Z", "type": "commit"}, {"oid": "438d010f53963bfb6a364466ac28e0e59a013895", "url": "https://github.com/apache/kafka/commit/438d010f53963bfb6a364466ac28e0e59a013895", "message": "Rebase changes + fixing test", "committedDate": "2020-04-30T13:26:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNTUzMA==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418035530", "bodyText": "Nit: e -> _.", "author": "ijuma", "createdAt": "2020-04-30T14:04:54Z", "path": "core/src/main/scala/kafka/security/authorizer/AclEntry.scala", "diffHunk": "@@ -92,6 +95,23 @@ object AclEntry {\n     }.getOrElse(Set.empty)\n   }\n \n+  /**\n+   * Parse a JSON string into a JsonValue if possible. `None` is returned if `input` is not valid JSON. This method is currently used\n+   * to read the already stored invalid ACLs JSON which was persisted using older versions of Kafka (prior to Kafka 1.1.0). KAFKA-6319\n+   */\n+  private def parseBytesWithAclFallback(input: Array[Byte]): Option[JsonValue] = {\n+    // Before 1.0.1, Json#encode did not escape backslash or any other special characters. SSL principals\n+    // stored in ACLs may contain backslash as an escape char, making the JSON generated in earlier versions invalid.\n+    // Escape backslash and retry to handle these strings which may have been persisted in ZK.\n+    // Note that this does not handle all special characters (e.g. non-escaped double quotes are not supported)\n+    Json.tryParseBytes(input) match {\n+      case Left(e) =>", "originalCommit": "438d010f53963bfb6a364466ac28e0e59a013895", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fec67e0b523c6b7070b4083afb9ae29478afd36b", "url": "https://github.com/apache/kafka/commit/fec67e0b523c6b7070b4083afb9ae29478afd36b", "message": "Address review comments", "committedDate": "2020-04-30T15:14:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MTAwNg==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418741006", "bodyText": "Need to revert this. It is causing the build to fail.", "author": "hachikuji", "createdAt": "2020-05-01T21:14:53Z", "path": "core/src/test/scala/unit/kafka/security/authorizer/AclEntryTest.scala", "diffHunk": "@@ -23,27 +23,28 @@ import org.apache.kafka.common.acl.AclOperation.READ\n import org.apache.kafka.common.acl.AclPermissionType.{ALLOW, DENY}\n import org.apache.kafka.common.security.auth.KafkaPrincipal\n import org.junit.{Assert, Test}\n-import org.scalatestplus.junit.JUnitSuite\n \n-import scala.jdk.CollectionConverters._\n+import scala.collection.JavaConverters._", "originalCommit": "fec67e0b523c6b7070b4083afb9ae29478afd36b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418743515", "bodyText": "I'm probably missing something obvious, but I found the following callers of this function: DeleteRecordsCommand, LeaderElectionCommand, PreferredReplicaLeaderElectionCommand, and ReassignPartitionsCommand. As far as I can tell, none of these uses involve the parsing of ACLs. Did we lose this compatibility handling at some point or is there some magic invocation?", "author": "hachikuji", "createdAt": "2020-05-01T21:21:53Z", "path": "core/src/main/scala/kafka/utils/Json.scala", "diffHunk": "@@ -35,16 +35,7 @@ object Json {\n    */\n   def parseFull(input: String): Option[JsonValue] =", "originalCommit": "fec67e0b523c6b7070b4083afb9ae29478afd36b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2NjE0MQ==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418766141", "bodyText": "The compatibility fix was only required for ACLs, but we added it here to keep the fix small for backporting. The idea was to move to the appropriate place soon after, but it got stuck for a while. Do you have some concerns?", "author": "ijuma", "createdAt": "2020-05-01T22:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODQ3MA==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418778470", "bodyText": "Discussed this offline with @hachikuji. I had misunderstood his point. It looks like the compatibility code has not been used since 1.1.0:\n9b44c3e#diff-81f2ec590f4e047be7e3a7e5267cbc9aR60", "author": "ijuma", "createdAt": "2020-05-01T23:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc3ODYwMw==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r418778603", "bodyText": "Maybe we should just drop this code.", "author": "ijuma", "createdAt": "2020-05-01T23:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0MDU2Nw==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r420040567", "bodyText": "I looks like parseFull is used in a couple of places as Json mentioned but I can perhaps just delegate this to parseBytes like this below and can continue using that in the mentioned callers.\ndef parseFull(input: String): Option[JsonValue] = parseBytes(input.getBytes(Charset.defaultCharset()))\n\nOr shall I just get rid of this code and use parseBytes everywhere?", "author": "viktorsomogyi", "createdAt": "2020-05-05T11:32:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyNDg1Ng==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r420124856", "bodyText": "This code is fine as it is. We are suggesting that we don't need parseBytesWithAclFallback in AclEntry.", "author": "ijuma", "createdAt": "2020-05-05T13:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1Mzk5Mw==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r420753993", "bodyText": "Ok, then I misunderstood it too. :)\nHowever isn't it possible that this issue resurfaces again if we remove this? I suspect the user who raised it may still use 1.0 where it got fixed and when they upgrade they'd run into this again. Or am I missing something else too?", "author": "viktorsomogyi", "createdAt": "2020-05-06T12:33:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgwMjk3OQ==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r420802979", "bodyText": "@viktorsomogyi I think the argument is that if no-one complained since 1.1 which was released more than 2 years ago, then maybe this issue is very rare.", "author": "ijuma", "createdAt": "2020-05-06T13:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3ODk5Mw==", "url": "https://github.com/apache/kafka/pull/8591#discussion_r420878993", "bodyText": "Ok, that's fair. I've uploaded the changes.", "author": "viktorsomogyi", "createdAt": "2020-05-06T15:23:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MzUxNQ=="}], "type": "inlineReview"}, {"oid": "755634fc3db7e704fad6534a3a3e7705de29c4d3", "url": "https://github.com/apache/kafka/commit/755634fc3db7e704fad6534a3a3e7705de29c4d3", "message": "Use jdk.CollectionConverters", "committedDate": "2020-05-05T11:33:02Z", "type": "commit"}, {"oid": "b9c70ff061b5a7a3780001407864cb4e823fc002", "url": "https://github.com/apache/kafka/commit/b9c70ff061b5a7a3780001407864cb4e823fc002", "message": "Get rid of parseBytesWithAclFallback", "committedDate": "2020-05-06T13:38:02Z", "type": "commit"}, {"oid": "bdfa380fad992d4f6840344b28c57bb4a80bd5de", "url": "https://github.com/apache/kafka/commit/bdfa380fad992d4f6840344b28c57bb4a80bd5de", "message": "Optimize imports", "committedDate": "2020-05-06T14:41:18Z", "type": "commit"}, {"oid": "802e255683ee1f33df9935f7914f5eda2a6c1d52", "url": "https://github.com/apache/kafka/commit/802e255683ee1f33df9935f7914f5eda2a6c1d52", "message": "Revert AclEntry import changes", "committedDate": "2020-05-06T15:24:11Z", "type": "commit"}]}