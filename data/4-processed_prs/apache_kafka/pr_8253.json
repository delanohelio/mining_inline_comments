{"pr_number": 8253, "pr_title": "KAFKA-9656: Return COORDINATOR_NOT_AVAILABLE for older producer clients", "pr_createdAt": "2020-03-08T05:57:53Z", "pr_url": "https://github.com/apache/kafka/pull/8253", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg0NDM3NQ==", "url": "https://github.com/apache/kafka/pull/8253#discussion_r393844375", "bodyText": "nit: I think it's ok to KAFKA-7296 to explain this check, but do we need to mention KAFKA-9656 as well?", "author": "hachikuji", "createdAt": "2020-03-17T17:21:25Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,25 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // For KAFKA-9656, we need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk4MTYxNA==", "url": "https://github.com/apache/kafka/pull/8253#discussion_r393981614", "bodyText": "I don't think we need", "author": "abbccdda", "createdAt": "2020-03-17T21:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg0NDM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg0NTk3OA==", "url": "https://github.com/apache/kafka/pull/8253#discussion_r393845978", "bodyText": "Just doublechecking, but does this cover any client version prior to 2.0? I think it would be good to mention this in the comment.", "author": "hachikuji", "createdAt": "2020-03-17T17:24:05Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,25 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // For KAFKA-9656, we need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE\n+        // for older producer client which could potentially fail due to a later bug fix in KAFKA-7296.\n+        if (txnOffsetCommitRequest.version < 2) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwODk4MA==", "url": "https://github.com/apache/kafka/pull/8253#discussion_r394008980", "bodyText": "typo: \"on onwards\"", "author": "hachikuji", "createdAt": "2020-03-17T22:32:17Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,28 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // We need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE\n+        // for older producer client from 0.11 to prior 2.0, which could potentially crash due\n+        // to unexpected loading error. This bug is fixed later by KAFKA-7296 in version 2.0.\n+        // Clients using txn commit protocol >= 2 (version 2.3 and on onwards)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwOTM2Mw==", "url": "https://github.com/apache/kafka/pull/8253#discussion_r394009363", "bodyText": "nit: you probably mean 2.0.1? We could probably leave this out since the jira has the details.", "author": "hachikuji", "createdAt": "2020-03-17T22:32:50Z", "path": "core/src/main/scala/kafka/server/KafkaApis.scala", "diffHunk": "@@ -2164,14 +2164,28 @@ class KafkaApis(val requestChannel: RequestChannel,\n \n       // the callback for sending an offset commit response\n       def sendResponseCallback(authorizedTopicErrors: Map[TopicPartition, Errors]): Unit = {\n-        val combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n+        var combinedCommitStatus = authorizedTopicErrors ++ unauthorizedTopicErrors ++ nonExistingTopicErrors\n         if (isDebugEnabled)\n           combinedCommitStatus.foreach { case (topicPartition, error) =>\n             if (error != Errors.NONE) {\n               debug(s\"TxnOffsetCommit with correlation id ${header.correlationId} from client ${header.clientId} \" +\n                 s\"on partition $topicPartition failed due to ${error.exceptionName}\")\n             }\n           }\n+\n+        // We need to replace COORDINATOR_LOAD_IN_PROGRESS with COORDINATOR_NOT_AVAILABLE\n+        // for older producer client from 0.11 to prior 2.0, which could potentially crash due\n+        // to unexpected loading error. This bug is fixed later by KAFKA-7296 in version 2.0.", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbeac813ce1938c8f0834e2a23c6e3139b8c45d6", "url": "https://github.com/apache/kafka/commit/dbeac813ce1938c8f0834e2a23c6e3139b8c45d6", "message": "for old", "committedDate": "2020-03-18T06:02:45Z", "type": "commit"}, {"oid": "1953c6c3ab13e4325f0f05bd89ddbd07c1d96443", "url": "https://github.com/apache/kafka/commit/1953c6c3ab13e4325f0f05bd89ddbd07c1d96443", "message": "unit test", "committedDate": "2020-03-18T06:02:45Z", "type": "commit"}, {"oid": "12414cd7c2730b865d9272945a37dcc73a79dfd1", "url": "https://github.com/apache/kafka/commit/12414cd7c2730b865d9272945a37dcc73a79dfd1", "message": "fix comment", "committedDate": "2020-03-18T06:02:45Z", "type": "commit"}, {"oid": "3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "url": "https://github.com/apache/kafka/commit/3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "message": "fix small comments", "committedDate": "2020-03-18T06:02:45Z", "type": "commit"}, {"oid": "3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "url": "https://github.com/apache/kafka/commit/3a213332e3d2cd8412e3ce81e81d7348d17f86f9", "message": "fix small comments", "committedDate": "2020-03-18T06:02:45Z", "type": "forcePushed"}]}