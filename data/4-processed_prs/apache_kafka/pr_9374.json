{"pr_number": 9374, "pr_title": "MINOR: Fix NPE in KafkaAdminClient.describeUserScramCredentials", "pr_createdAt": "2020-10-05T15:29:54Z", "pr_url": "https://github.com/apache/kafka/pull/9374", "timeline": [{"oid": "2d769ba80365f6aedef35fe3e5872d1a97389381", "url": "https://github.com/apache/kafka/commit/2d769ba80365f6aedef35fe3e5872d1a97389381", "message": "MINOR: Fix NPE in KafkaAdminClient.describeUserScramCredentials\n\nThis bug was detected as part of #9370 and @rondagostino and I decided that this should be fixed right away and not until the other PR eventually gets merged (or not). I am not only properly handling `null` everywhere but also rewrote the function to be more readable (and more efficient, but I think this is not important here). I extended the existing test to go through all possible permutations of the users argument to make sure that we never get an NPE.", "committedDate": "2020-10-05T15:28:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY4Nzg0OA==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r499687848", "bodyText": "users.stream() is the NPE source", "author": "Fleshgrinder", "createdAt": "2020-10-05T15:32:20Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -4166,10 +4167,22 @@ public DescribeUserScramCredentialsResult describeUserScramCredentials(List<Stri\n         Call call = new Call(\"describeUserScramCredentials\", calcDeadlineMs(now, options.timeoutMs()),\n                 new LeastLoadedNodeProvider()) {\n             @Override\n-            public DescribeUserScramCredentialsRequest.Builder createRequest(int timeoutMs) {\n-                return new DescribeUserScramCredentialsRequest.Builder(\n-                        new DescribeUserScramCredentialsRequestData().setUsers(users.stream().map(user ->", "originalCommit": "2d769ba80365f6aedef35fe3e5872d1a97389381", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NjczMA==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511746730", "bodyText": "nit: I suggest to continue using the stream api here. It keeps the code smaller.", "author": "dajac", "createdAt": "2020-10-26T06:49:27Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -4166,10 +4167,22 @@ public DescribeUserScramCredentialsResult describeUserScramCredentials(List<Stri\n         Call call = new Call(\"describeUserScramCredentials\", calcDeadlineMs(now, options.timeoutMs()),\n                 new LeastLoadedNodeProvider()) {\n             @Override\n-            public DescribeUserScramCredentialsRequest.Builder createRequest(int timeoutMs) {\n-                return new DescribeUserScramCredentialsRequest.Builder(\n-                        new DescribeUserScramCredentialsRequestData().setUsers(users.stream().map(user ->\n-                                new DescribeUserScramCredentialsRequestData.UserName().setName(user)).collect(Collectors.toList())));\n+            public DescribeUserScramCredentialsRequest.Builder createRequest(final int timeoutMs) {\n+                final DescribeUserScramCredentialsRequestData requestData = new DescribeUserScramCredentialsRequestData();\n+\n+                if (users != null && !users.isEmpty()) {\n+                    final List<UserName> userNames = new ArrayList<>(users.size());\n+\n+                    for (final String user : users) {\n+                        if (user != null) {\n+                            userNames.add(new UserName().setName(user));\n+                        }\n+                    }\n+\n+                    requestData.setUsers(userNames);", "originalCommit": "2d769ba80365f6aedef35fe3e5872d1a97389381", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc3NDc1NQ==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511774755", "bodyText": "Not really, if we keep all checks in place it will only be a little shorter but definitely less efficient:\nfinal DescribeUserScramCredentialsRequestData requestData = new DescribeUserScramCredentialsRequestData();\n\nif (users != null && !users.isEmpty()) {\n    requestData.setUsers(users.stream()\n        .filter(Objects::nonNull)\n        .map(it -> new UserName().setName(it))\n        .collect(Collectors.toList())\n    );\n}\n\nreturn new DescribeUserScramCredentialsRequest.Builder(requestData);", "author": "Fleshgrinder", "createdAt": "2020-10-26T08:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NjczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwNDUwMg==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511804502", "bodyText": "We tend to use the steam api for such small transformations but I don't feel strong about this.", "author": "dajac", "createdAt": "2020-10-26T09:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NjczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgxMDUxNw==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511810517", "bodyText": "I have no feelings regarding this either, for me Java is always just clunky no matter which API you use. A normal loop is just faster, that's all I can say, but I doubt that it matters at all.", "author": "Fleshgrinder", "createdAt": "2020-10-26T09:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NjczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MTA4Nw==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511751087", "bodyText": "Would it make sense to extract these into separate unit tests? testDescribeUserScramCredentials could receive users as a argument such that we could reuse the code logic.", "author": "dajac", "createdAt": "2020-10-26T07:03:50Z", "path": "clients/src/test/java/org/apache/kafka/clients/admin/KafkaAdminClientTest.java", "diffHunk": "@@ -4505,50 +4505,57 @@ public void testDescribeUserScramCredentials() throws Exception {\n             user0CredentialInfo1.setIterations(user0Iterations1);\n \n             final String user1Name = \"user1\";\n-            ScramMechanism user1ScramMechanism = ScramMechanism.SCRAM_SHA_256;\n-            int user1Iterations = 4096;\n+            final ScramMechanism user1ScramMechanism = ScramMechanism.SCRAM_SHA_256;\n+            final int user1Iterations = 4096;\n \n             final CredentialInfo user1CredentialInfo = new CredentialInfo();\n             user1CredentialInfo.setMechanism(user1ScramMechanism.type());\n             user1CredentialInfo.setIterations(user1Iterations);\n \n-            DescribeUserScramCredentialsResponseData responseData = new DescribeUserScramCredentialsResponseData();\n+            final DescribeUserScramCredentialsResponseData responseData = new DescribeUserScramCredentialsResponseData();\n             responseData.setResults(Arrays.asList(\n                     new DescribeUserScramCredentialsResponseData.DescribeUserScramCredentialsResult()\n                             .setUser(user0Name)\n                             .setCredentialInfos(Arrays.asList(user0CredentialInfo0, user0CredentialInfo1)),\n                     new DescribeUserScramCredentialsResponseData.DescribeUserScramCredentialsResult()\n                             .setUser(user1Name)\n-                            .setCredentialInfos(Arrays.asList(user1CredentialInfo))));\n-\n-            env.kafkaClient().prepareResponse(new DescribeUserScramCredentialsResponse(responseData));\n-\n-            List<String> usersRequestedList = asList(user0Name, user1Name);\n-            Set<String> usersRequestedSet = usersRequestedList.stream().collect(Collectors.toSet());\n-            DescribeUserScramCredentialsResult result = env.adminClient().describeUserScramCredentials(usersRequestedList);\n-            Map<String, UserScramCredentialsDescription> descriptionResults = result.all().get();\n-            KafkaFuture<UserScramCredentialsDescription> user0DescriptionFuture = result.description(user0Name);\n-            KafkaFuture<UserScramCredentialsDescription> user1DescriptionFuture = result.description(user1Name);\n-            Set<String> usersDescribedFromUsersSet = result.users().get().stream().collect(Collectors.toSet());\n-            assertEquals(usersRequestedSet, usersDescribedFromUsersSet);\n-            Set<String> usersDescribedFromMapKeySet = descriptionResults.keySet();\n-            assertEquals(usersRequestedSet, usersDescribedFromMapKeySet);\n-\n-            UserScramCredentialsDescription userScramCredentialsDescription0 = descriptionResults.get(user0Name);\n-            assertEquals(user0Name, userScramCredentialsDescription0.name());\n-            assertEquals(2, userScramCredentialsDescription0.credentialInfos().size());\n-            assertEquals(user0ScramMechanism0, userScramCredentialsDescription0.credentialInfos().get(0).mechanism());\n-            assertEquals(user0Iterations0, userScramCredentialsDescription0.credentialInfos().get(0).iterations());\n-            assertEquals(user0ScramMechanism1, userScramCredentialsDescription0.credentialInfos().get(1).mechanism());\n-            assertEquals(user0Iterations1, userScramCredentialsDescription0.credentialInfos().get(1).iterations());\n-            assertEquals(userScramCredentialsDescription0, user0DescriptionFuture.get());\n-\n-            UserScramCredentialsDescription userScramCredentialsDescription1 = descriptionResults.get(user1Name);\n-            assertEquals(user1Name, userScramCredentialsDescription1.name());\n-            assertEquals(1, userScramCredentialsDescription1.credentialInfos().size());\n-            assertEquals(user1ScramMechanism, userScramCredentialsDescription1.credentialInfos().get(0).mechanism());\n-            assertEquals(user1Iterations, userScramCredentialsDescription1.credentialInfos().get(0).iterations());\n-            assertEquals(userScramCredentialsDescription1, user1DescriptionFuture.get());\n+                            .setCredentialInfos(singletonList(user1CredentialInfo))));\n+            final DescribeUserScramCredentialsResponse response = new DescribeUserScramCredentialsResponse(responseData);\n+\n+            final Set<String> usersRequestedSet = new HashSet<>();\n+            usersRequestedSet.add(user0Name);\n+            usersRequestedSet.add(user1Name);\n+\n+            for (final List<String> users : asList(null, new ArrayList<String>(), asList(user0Name, null, user1Name))) {", "originalCommit": "2d769ba80365f6aedef35fe3e5872d1a97389381", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc3MTY4Nw==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511771687", "bodyText": "We could but I do not see where we could reuse it, YAGNI?", "author": "Fleshgrinder", "createdAt": "2020-10-26T07:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MTA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwMDM2MA==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511800360", "bodyText": "Sorry, I was not clear. It would be great if we could define separate unit tests for the different cases that we want to test. In case of failure, we would know directly which one of the cases has failed. This is why I suggested to pass an argument users as an argument to testDescribeUserScramCredentials.", "author": "dajac", "createdAt": "2020-10-26T08:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MTA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwNjI1MQ==", "url": "https://github.com/apache/kafka/pull/9374#discussion_r511806251", "bodyText": "We can rewrite it to a test factory, this way we can keep it in one function and reuse the initialization logic but will have n different tests being executed so that it is clear which one failed.", "author": "Fleshgrinder", "createdAt": "2020-10-26T09:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MTA4Nw=="}], "type": "inlineReview"}]}