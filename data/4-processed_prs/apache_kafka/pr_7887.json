{"pr_number": 7887, "pr_title": "KAFKA-9360: Fix heartbeat and checkpoint emission can not turn off", "pr_createdAt": "2020-01-02T23:13:53Z", "pr_url": "https://github.com/apache/kafka/pull/7887", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTUwOQ==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371329509", "bodyText": "Should we check for !config.enabled() here too?", "author": "mimaison", "createdAt": "2020-01-27T16:04:15Z", "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorHeartbeatConnector.java", "diffHunk": "@@ -50,6 +50,10 @@ public void stop() {\n \n     @Override\n     public List<Map<String, String>> taskConfigs(int maxTasks) {\n+        // if emitting heartbeat is disabled\n+        if (config.emitHeartbeatsInterval().isNegative()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0OTIwOA==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371349208", "bodyText": "No, we want to emit heartbeats even if A->B.enabled=false (see my earlier comment). Basically, we want heartbeats to be sent even if replication is disabled, unless heartbeats are explicitly disabled with emit.heartbeats.enabled = false.", "author": "ryannedolan", "createdAt": "2020-01-27T16:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MDA1NA==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371370054", "bodyText": "Gotcha, maybe worth adding that the explanation to the comment", "author": "mimaison", "createdAt": "2020-01-27T17:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxODU4Mw==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371418583", "bodyText": "Great, I will add the the explanation to the comment in the next update", "author": "ning2008wisc", "createdAt": "2020-01-27T18:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMDQ0OA==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371430448", "bodyText": "if isNegative() is not highly recommended, what about this change? Should we still check isNegative() or return the interval as Duration.ofMillis(Long.MAX_VALUE) ?", "author": "ning2008wisc", "createdAt": "2020-01-27T19:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzNDM4MA==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371334380", "bodyText": "It feels like allowing intervals to be negative interval to disable connectors is not a great pattern. Instead preventing the interval to be negative and relying solely on enabled() would have been a better alternative.", "author": "mimaison", "createdAt": "2020-01-27T16:12:07Z", "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorCheckpointConnector.java", "diffHunk": "@@ -88,7 +88,8 @@ public void stop() {\n     // divide consumer groups among tasks\n     @Override\n     public List<Map<String, String>> taskConfigs(int maxTasks) {\n-        if (!config.enabled() || knownConsumerGroups.isEmpty()) {\n+        if (!config.enabled() || knownConsumerGroups.isEmpty()\n+                || config.emitCheckpointsInterval().isNegative()) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyODg2OQ==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371428869", "bodyText": "@ryannedolan , as @mimaison suggested, if emit.checkpoints.enabled = false, do you think if it is a better alternative to return Long.MAX_VALUE, rather than negative?\n    Duration emitCheckpointsInterval() {\n        if (getBoolean(EMIT_CHECKPOINTS_ENABLED)) {\n            return Duration.ofSeconds(getLong(EMIT_CHECKPOINTS_INTERVAL_SECONDS));\n        } else {\n            // negative interval to disable\n            return Duration.ofMillis(Long.MAX_VALUE);\n        }\n    }", "author": "ning2008wisc", "createdAt": "2020-01-27T19:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzNDM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ0MTA2MA==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371441060", "bodyText": "All the interval configs (sync topics acls, sync topic configs, refresh topics, ...) use negative values to indicate that the Scheduler should not run the corresponding task. I suppose we could have used an Optional or something instead. If we drop the negatives here, we should do so with all the other tasks. Mox nix to me.", "author": "ryannedolan", "createdAt": "2020-01-27T19:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzNDM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ0MzU0NQ==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371443545", "bodyText": "It's not ideal but yes we don't want to change the current behaviour here. Let's keep the negative values.", "author": "mimaison", "createdAt": "2020-01-27T19:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzNDM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNDYzNg==", "url": "https://github.com/apache/kafka/pull/7887#discussion_r371504636", "bodyText": "great, thanks for all of your inputs. Then I suppose the only change in the next update is to adding the explanation to the comment on why we use isNegative()to disable theheartbeatandcheckpoint` emissions.", "author": "ning2008wisc", "createdAt": "2020-01-27T21:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzNDM4MA=="}], "type": "inlineReview"}, {"oid": "3e2420881f688624315748f54499806950056861", "url": "https://github.com/apache/kafka/commit/3e2420881f688624315748f54499806950056861", "message": "Fix heartbeat and checkpoint emission can not turn off\n\n`emit.heartbeats.enabled` and `emit.checkpoints.enabled` are supposed to\nbe the knobs to control if the heartbeat message or checkpoint message\nwill be sent or not to the topics respectively. In our experiments,\nsetting them to false will not suspend the activity in their SourceTasks,\ne.g. MirrorHeartbeatTask, MirrorCheckpointTask.\n\nThe observations are, when setting those knobs to false, huge volume of\n`SourceRecord` are being sent without interval, causing significantly high\nCPU usage and GC time  of MirrorMaker 2 instance and congesting the single\npartition of the heartbeat topic and checkpoint topic.\n\nThe proposed fix in the following PR is to (1) explicitly check if `interval`\nis set to negative (e.g. -1), when the `emit.heartbeats.enabled` or\n`emit.checkpoints.enabled` is off. (2) if `interval` is indeed set to negative,\nno task is created.", "committedDate": "2020-01-29T22:17:34Z", "type": "commit"}]}